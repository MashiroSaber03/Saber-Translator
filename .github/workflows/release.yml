# ============================================================================
# Saber-Translator è‡ªåŠ¨æ„å»ºä¸å‘å¸ƒå·¥ä½œæµ
# ============================================================================
# è§¦å‘æ–¹å¼:
#   1. æ¨é€ç‰ˆæœ¬æ ‡ç­¾: git tag v3.4.0 && git push origin v3.4.0
#   2. æ‰‹åŠ¨è§¦å‘: GitHub Actions é¡µé¢ -> Run workflow
#
# æµç¨‹:
#   1. å¹¶è¡Œæ„å»º CPU å’Œ GPU ç‰ˆæœ¬
#   2. ä» models-storage Release ä¸‹è½½æ¨¡å‹æ–‡ä»¶
#   3. ä½¿ç”¨ PyInstaller æ‰“åŒ…
#   4. ZIP åˆ†å·å‹ç¼©ï¼ˆæœ€é«˜å‹ç¼©ç‡ï¼‰
#   5. åˆ›å»º Draft Releaseï¼Œç­‰å¾…æ‰‹åŠ¨ç¼–è¾‘æ›´æ–°æ—¥å¿—åå‘å¸ƒ
# ============================================================================

name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (ä¸å¸¦vå‰ç¼€ï¼Œå¦‚ 3.4.0)'
        required: true
        default: '3.4.0'

env:
  MODELS_RELEASE_TAG: models-storage
  PYTHON_VERSION: '3.11'

jobs:
  # ============================================================================
  # æ„å»º Job - CPU å’Œ GPU å¹¶è¡Œæ„å»º
  # ============================================================================
  build:
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - variant: cpu
            requirements: requirements-cpu.txt
          - variant: gpu
            requirements: requirements-gpu.txt

    steps:
      # --------------------------------------------------
      # 1. æ£€å‡ºä»£ç 
      # --------------------------------------------------
      - name: Checkout code
        uses: actions/checkout@v4

      # --------------------------------------------------
      # 2. ä» models-storage Release ä¸‹è½½æ¨¡å‹æ–‡ä»¶
      # --------------------------------------------------
      - name: Download models from storage release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          Write-Host "ğŸ“¦ Downloading models from release: ${{ env.MODELS_RELEASE_TAG }}"
          gh release download ${{ env.MODELS_RELEASE_TAG }} --pattern "models.*" --dir .
          
          Write-Host "ğŸ“‹ Downloaded files:"
          Get-ChildItem -Filter "models.*" | Format-Table Name, @{N='SizeMB';E={[math]::Round($_.Length/1MB, 2)}}

      # --------------------------------------------------
      # 3. è§£å‹æ¨¡å‹æ–‡ä»¶
      # --------------------------------------------------
      - name: Extract models
        run: |
          Write-Host "ğŸ“‚ Extracting models..."
          
          # ä½¿ç”¨ 7z è§£å‹åˆ†å·å‹ç¼©ï¼ˆè‡ªåŠ¨å¤„ç† .z01 + .zipï¼‰
          7z x models.zip -omodels/ -y
          
          Write-Host "âœ… Models extracted. Directory contents:"
          Get-ChildItem -Path models/ | Select-Object Name, @{N='SizeMB';E={[math]::Round($_.Length/1MB, 2)}}

      # --------------------------------------------------
      # 4. è®¾ç½® Python ç¯å¢ƒ
      # --------------------------------------------------
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      # --------------------------------------------------
      # 5. å®‰è£…ä¾èµ– (CPU å’Œ GPU æµç¨‹ä¸åŒ)
      # --------------------------------------------------
      - name: Install dependencies (CPU)
        if: matrix.variant == 'cpu'
        run: |
          Write-Host "ğŸ”§ Installing CPU dependencies..."
          python -m pip install --upgrade pip
          pip install -r ${{ matrix.requirements }}

      - name: Install dependencies (GPU)
        if: matrix.variant == 'gpu'
        run: |
          Write-Host "ğŸ”§ Installing GPU dependencies..."
          python -m pip install --upgrade pip
          
          # æ­¥éª¤1: å®‰è£…æ‰€æœ‰ä¾èµ–ï¼ˆä¼šè‡ªåŠ¨è£… CPU ç‰ˆ torchï¼‰
          pip install -r ${{ matrix.requirements }}
          
          # æ­¥éª¤2: å¸è½½ CPU ç‰ˆ PyTorch
          Write-Host "ğŸ”„ Replacing CPU PyTorch with CUDA version..."
          pip uninstall torch torchvision torchaudio -y
          
          # æ­¥éª¤3: å®‰è£… CUDA 13.0 ç‰ˆ PyTorch
          pip install torch torchvision --index-url https://download.pytorch.org/whl/cu130

      # --------------------------------------------------
      # 6. ä½¿ç”¨ PyInstaller æ‰“åŒ…
      # --------------------------------------------------
      - name: Build with PyInstaller
        run: |
          Write-Host "ğŸ—ï¸ Building with PyInstaller..."
          pyinstaller app.spec --noconfirm
          
          Write-Host "âœ… Build completed. Output directory:"
          Get-ChildItem -Path dist/ | Select-Object Name

      # --------------------------------------------------
      # 7. è·å–ç‰ˆæœ¬å·
      # --------------------------------------------------
      - name: Get version
        id: version
        run: |
          if ("${{ github.event_name }}" -eq "workflow_dispatch") {
            $version = "${{ github.event.inputs.version }}"
          } else {
            # ä» tag ä¸­æå–ç‰ˆæœ¬å· (å»æ‰ v å‰ç¼€)
            $version = "${{ github.ref_name }}" -replace '^v', ''
          }
          echo "VERSION=$version" >> $env:GITHUB_OUTPUT
          Write-Host "ğŸ“Œ Version: $version"

      # --------------------------------------------------
      # 8. ZIP åˆ†å·å‹ç¼©ï¼ˆæœ€é«˜å‹ç¼©ç‡ï¼‰
      # --------------------------------------------------
      - name: Package with ZIP split (ultra compression)
        run: |
          $version = "${{ steps.version.outputs.VERSION }}"
          $variant = "${{ matrix.variant }}"
          $outputName = "Saber-Translator-$version-$variant"
          
          Write-Host "ğŸ“¦ Compressing with maximum compression..."
          Write-Host "   Output: $outputName.zip (split at 1900MB)"
          
          # è¿›å…¥ dist ç›®å½•ï¼Œå‹ç¼© Saber-Translator æ–‡ä»¶å¤¹å†…å®¹
          Push-Location dist
          
          # ä½¿ç”¨ 7z åˆ›å»º ZIP åˆ†å·å‹ç¼©
          # -tzip: ZIP æ ¼å¼
          # -mx=9: æœ€é«˜å‹ç¼©çº§åˆ«
          # -mfb=258: æœ€å¤§ FastBytes (ZIP æœ€å¤§æ”¯æŒ 258)
          # -mpass=15: æœ€å¤§å‹ç¼©è½®æ•°
          # -v1900m: æ¯å· 1900MB (ç¡®ä¿ < 2GB é™åˆ¶)
          7z a -tzip -mx=9 -mfb=258 -mpass=15 -v1900m "../$outputName.zip" "Saber-Translator/*"
          
          Pop-Location
          
          Write-Host "âœ… Compression completed. Generated files:"
          Get-ChildItem "$outputName.*" | Format-Table Name, @{N='SizeMB';E={[math]::Round($_.Length/1MB, 2)}}

      # --------------------------------------------------
      # 9. é‡å‘½ååˆ†å·æ–‡ä»¶ï¼ˆ.zip.001 -> .z01 ç­‰ï¼‰
      # --------------------------------------------------
      - name: Rename split archives
        run: |
          $version = "${{ steps.version.outputs.VERSION }}"
          $variant = "${{ matrix.variant }}"
          $baseName = "Saber-Translator-$version-$variant"
          
          Write-Host "ğŸ“ Renaming split archives..."
          
          # è·å–æ‰€æœ‰åˆ†å·æ–‡ä»¶
          $files = Get-ChildItem "$baseName.zip.*" | Sort-Object Name
          
          foreach ($file in $files) {
            # æå–ç¼–å· (.zip.001 -> 001)
            if ($file.Name -match '\.zip\.(\d+)$') {
              $num = [int]$Matches[1]
              
              if ($num -eq $files.Count) {
                # æœ€åä¸€ä¸ªåˆ†å·å‘½åä¸º .zip
                $newName = "$baseName.zip"
              } else {
                # å…¶ä»–åˆ†å·å‘½åä¸º .z01, .z02, ...
                $newName = "$baseName.z{0:D2}" -f $num
              }
              
              Rename-Item $file.FullName $newName
              Write-Host "   $($file.Name) -> $newName"
            }
          }
          
          Write-Host "âœ… Renamed files:"
          Get-ChildItem "$baseName.*" | Where-Object { $_.Extension -match '\.(zip|z\d+)$' } | Format-Table Name, @{N='SizeMB';E={[math]::Round($_.Length/1MB, 2)}}

      # --------------------------------------------------
      # 10. ä¸Šä¼ æ„å»ºäº§ç‰©
      # --------------------------------------------------
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.variant }}
          path: |
            Saber-Translator-*.z*
            Saber-Translator-*.zip
          retention-days: 3

      # --------------------------------------------------
      # 11. ä¸Šä¼ æ¨¡å‹æ–‡ä»¶ï¼ˆä»…åœ¨å…¶ä¸­ä¸€ä¸ªå˜ä½“ä¸­ä¸Šä¼ ï¼Œé¿å…é‡å¤ï¼‰
      # --------------------------------------------------
      - name: Upload models artifacts
        if: matrix.variant == 'cpu'
        uses: actions/upload-artifact@v4
        with:
          name: models
          path: |
            models.z01
            models.zip
          retention-days: 3

  # ============================================================================
  # å‘å¸ƒ Job - åˆ›å»º Draft Release
  # ============================================================================
  release:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # --------------------------------------------------
      # 1. ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
      # --------------------------------------------------
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/
          merge-multiple: false

      # --------------------------------------------------
      # 2. æ•´ç†æ–‡ä»¶
      # --------------------------------------------------
      - name: Organize files
        run: |
          echo "ğŸ“ Organizing release files..."
          mkdir -p release-files
          
          # ç§»åŠ¨æ‰€æœ‰å‹ç¼©åŒ…åˆ° release-files ç›®å½•
          find artifacts/ -name "*.zip" -o -name "*.z[0-9]*" | while read f; do
            cp "$f" release-files/
          done
          
          echo "ğŸ“‹ Files to be released:"
          ls -lh release-files/

      # --------------------------------------------------
      # 3. è·å–ç‰ˆæœ¬å·
      # --------------------------------------------------
      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${{ github.ref_name }}"
            VERSION="${VERSION#v}"  # å»æ‰ v å‰ç¼€
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“Œ Version: $VERSION"

      # --------------------------------------------------
      # 4. åˆ›å»º Draft Release
      # --------------------------------------------------
      - name: Create Draft Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event_name == 'workflow_dispatch' && format('v{0}', github.event.inputs.version) || github.ref_name }}
          name: v${{ steps.version.outputs.VERSION }}
          body: |
            ## Saber-Translator v${{ steps.version.outputs.VERSION }}
            
            > âš ï¸ **è¿™æ˜¯ä¸€ä¸ªè‰ç¨¿ Releaseï¼Œè¯·ç¼–è¾‘æ›´æ–°æ—¥å¿—åå†å‘å¸ƒã€‚**
            
            ### æ›´æ–°æ—¥å¿—
            
            <!-- è¯·åœ¨æ­¤å¤„å¡«å†™æ›´æ–°æ—¥å¿— -->
            
            ---
            
            ### ä¸‹è½½è¯´æ˜
            
            ğŸ“¦ **æ™®é€šç”¨æˆ·ï¼ˆå¼€ç®±å³ç”¨ï¼‰ï¼š**
            - CPU ç‰ˆæœ¬ï¼šä¸‹è½½æ‰€æœ‰ `Saber-Translator-${{ steps.version.outputs.VERSION }}-cpu.*` æ–‡ä»¶
            - GPU ç‰ˆæœ¬ï¼šä¸‹è½½æ‰€æœ‰ `Saber-Translator-${{ steps.version.outputs.VERSION }}-gpu.*` æ–‡ä»¶
            - å°†æ‰€æœ‰åˆ†å·æ”¾åœ¨åŒä¸€ç›®å½•ï¼Œè§£å‹ `.zip` æ–‡ä»¶å³å¯
            
            ğŸ”§ **æºç éƒ¨ç½²ç”¨æˆ·ï¼š**
            - ä¸‹è½½ `models.z01` å’Œ `models.zip`
            - è§£å‹åˆ°é¡¹ç›®æ ¹ç›®å½•çš„ `models/` æ–‡ä»¶å¤¹
            
            > é‡‡ç”¨åˆ†å·å‹ç¼©çš„æ–¹å¼ï¼Œéœ€è¦ä¸‹è½½å¯¹åº”ç‰ˆæœ¬çš„å¤šä¸ªå‹ç¼©æ–‡ä»¶ï¼Œå°†å…¶æ”¾åœ¨åŒä¸€ä¸ªç›®å½•ä¸‹è§£å‹
          files: release-files/*
          draft: true
          prerelease: ${{ contains(github.ref_name, 'beta') || contains(github.ref_name, 'alpha') || contains(github.ref_name, 'rc') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # --------------------------------------------------
      # 5. è¾“å‡ºç»“æœ
      # --------------------------------------------------
      - name: Summary
        run: |
          echo "ğŸ‰ Draft Release created successfully!"
          echo ""
          echo "ğŸ“ Next steps:"
          echo "   1. Go to GitHub Releases page"
          echo "   2. Edit the draft release"
          echo "   3. Write your changelog"
          echo "   4. Click 'Publish release'"
          echo ""
          echo "ğŸ”— https://github.com/${{ github.repository }}/releases"
