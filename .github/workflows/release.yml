# ============================================================================
# Saber-Translator è‡ªåŠ¨æ„å»ºä¸å‘å¸ƒå·¥ä½œæµ
# ============================================================================
# åˆ†æ”¯ç­–ç•¥:
#   - main åˆ†æ”¯: å®Œæ•´åŠŸèƒ½ï¼ˆåŒ…å«ç½‘é¡µå¯¼å…¥ç­‰å¼€å‘åŠŸèƒ½ï¼‰
#   - release åˆ†æ”¯: ç²¾ç®€ç‰ˆï¼ˆåˆ é™¤ç½‘é¡µå¯¼å…¥ï¼Œç”¨äºæ‰“åŒ…å‘å¸ƒï¼‰
#
# è§¦å‘æ–¹å¼:
#   1. åœ¨ release åˆ†æ”¯æ¨é€ç‰ˆæœ¬æ ‡ç­¾:
#      git checkout release
#      git tag v3.3.0
#      git push origin v3.3.0
#   2. æ‰‹åŠ¨è§¦å‘: GitHub Actions é¡µé¢ -> Run workflow -> é€‰æ‹© release åˆ†æ”¯
#
# æµç¨‹:
#   1. å…ˆåˆ›å»º Draft Release
#   2. å¹¶è¡Œæ„å»º CPU å’Œ GPU ç‰ˆæœ¬ï¼Œæ¯ä¸ªç›´æ¥ä¸Šä¼ åˆ° Release
#   3. ç­‰å¾…æ‰‹åŠ¨ç¼–è¾‘æ›´æ–°æ—¥å¿—åå‘å¸ƒ
# ============================================================================

name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (ä¸å¸¦vå‰ç¼€ï¼Œå¦‚ 3.3.0)'
        required: true
        default: '3.3.0'
      branch:
        description: 'è¦æ‰“åŒ…çš„åˆ†æ”¯'
        required: true
        default: 'release'
        type: choice
        options:
          - release
          - main

env:
  MODELS_RELEASE_TAG: models-storage
  PYTHON_VERSION: '3.11'

jobs:
  # ============================================================================
  # å‡†å¤‡ Job - å…ˆåˆ›å»º Draft Release
  # ============================================================================
  prepare:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      version: ${{ steps.version.outputs.VERSION }}
      tag_name: ${{ steps.version.outputs.TAG_NAME }}
    
    steps:
      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
            TAG_NAME="v${VERSION}"
          else
            TAG_NAME="${{ github.ref_name }}"
            VERSION="${TAG_NAME#v}"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "Version: $VERSION, Tag: $TAG_NAME"

      - name: Create Draft Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.TAG_NAME }}
          name: v${{ steps.version.outputs.VERSION }}
          body: |
            ## Saber-Translator v${{ steps.version.outputs.VERSION }}
            
            > âš ï¸ **æ„å»ºä¸­...è¯·ç­‰å¾… CPU å’Œ GPU ç‰ˆæœ¬ä¸Šä¼ å®Œæˆåå†å‘å¸ƒã€‚**
            
            ### æ›´æ–°æ—¥å¿—
            
            <!-- è¯·åœ¨æ­¤å¤„å¡«å†™æ›´æ–°æ—¥å¿— -->
            
            ---
            
            ### ä¸‹è½½è¯´æ˜
            
            ğŸ“¦ **æ™®é€šç”¨æˆ·ï¼ˆå¼€ç®±å³ç”¨ï¼‰ï¼š**
            - CPU ç‰ˆæœ¬ï¼šä¸‹è½½æ‰€æœ‰ `Saber-Translator-${{ steps.version.outputs.VERSION }}-cpu.7z*` æ–‡ä»¶
            - GPU ç‰ˆæœ¬ï¼šä¸‹è½½æ‰€æœ‰ `Saber-Translator-${{ steps.version.outputs.VERSION }}-gpu.7z*` æ–‡ä»¶
            - å°†æ‰€æœ‰åˆ†å·æ”¾åœ¨åŒä¸€ç›®å½•ï¼Œä½¿ç”¨ **7-Zip** æˆ– **Bandzip** è§£å‹ `.7z.001` æ–‡ä»¶å³å¯
            
            ğŸ”§ **æºç éƒ¨ç½²ç”¨æˆ·ï¼š**
            - ä¸‹è½½ `models.z01` å’Œ `models.zip`ï¼Œè§£å‹åˆ°é¡¹ç›®æ ¹ç›®å½•çš„ `models/` æ–‡ä»¶å¤¹
            
            > âš ï¸ é‡‡ç”¨ 7z åˆ†å·å‹ç¼©æ ¼å¼ï¼Œè¯·ä½¿ç”¨ [7-Zip](https://www.7-zip.org/) æˆ– [Bandzip](https://www.bandisoft.com/bandizip/) è§£å‹ï¼ŒWindows å†…ç½®è§£å‹å’Œ WinRAR å¯èƒ½æ— æ³•æ­£ç¡®è¯†åˆ«
          draft: true
          prerelease: ${{ contains(github.ref_name, 'beta') || contains(github.ref_name, 'alpha') || contains(github.ref_name, 'rc') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================================================
  # æ„å»º Job - CPU å’Œ GPU å¹¶è¡Œæ„å»ºï¼Œç›´æ¥ä¸Šä¼ åˆ° Release
  # ============================================================================
  build:
    needs: prepare
    runs-on: windows-latest
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - variant: cpu
            requirements: requirements-cpu.txt
          - variant: gpu
            requirements: requirements-gpu.txt

    steps:
      # --------------------------------------------------
      # 1. æ£€å‡ºä»£ç 
      # --------------------------------------------------
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.branch || github.ref }}

      # --------------------------------------------------
      # 2. ä» models-storage Release ä¸‹è½½æ¨¡å‹æ–‡ä»¶
      # --------------------------------------------------
      - name: Download models from storage release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          Write-Host "Downloading models from release: ${{ env.MODELS_RELEASE_TAG }}"
          gh release download ${{ env.MODELS_RELEASE_TAG }} --pattern "models.*" --dir .
          
          Write-Host "Downloaded files:"
          Get-ChildItem -Filter "models.*" | Format-Table Name, @{N='SizeMB';E={[math]::Round($_.Length/1MB, 2)}}

      # --------------------------------------------------
      # 3. è§£å‹æ¨¡å‹æ–‡ä»¶
      # --------------------------------------------------
      - name: Extract models
        run: |
          Write-Host "Extracting models..."
          7z x models.zip -omodels/ -y
          
          Write-Host "Models extracted. Directory contents:"
          Get-ChildItem -Path models/ | Select-Object Name, @{N='SizeMB';E={[math]::Round($_.Length/1MB, 2)}}

      # --------------------------------------------------
      # 4. æ¸…ç†æ¨¡å‹å‹ç¼©åŒ…ï¼ˆèŠ‚çœç£ç›˜ç©ºé—´ï¼‰
      # --------------------------------------------------
      - name: Clean up model archives
        run: |
          Write-Host "Cleaning up model archives to save disk space..."
          Remove-Item models.z01 -Force -ErrorAction SilentlyContinue
          Remove-Item models.zip -Force -ErrorAction SilentlyContinue

      # --------------------------------------------------
      # 5. è®¾ç½® Python ç¯å¢ƒ
      # --------------------------------------------------
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      # --------------------------------------------------
      # 6. å®‰è£…ä¾èµ– (CPU å’Œ GPU æµç¨‹ä¸åŒ)
      # --------------------------------------------------
      - name: Install dependencies (CPU)
        if: matrix.variant == 'cpu'
        run: |
          Write-Host "Installing CPU dependencies..."
          python -m pip install --upgrade pip
          pip install -r ${{ matrix.requirements }}

      - name: Install dependencies (GPU)
        if: matrix.variant == 'gpu'
        run: |
          Write-Host "Installing GPU dependencies..."
          python -m pip install --upgrade pip
          
          # Step 1: Install all dependencies (will install CPU torch)
          pip install -r ${{ matrix.requirements }}
          
          # Step 2: Uninstall CPU PyTorch
          Write-Host "Replacing CPU PyTorch with CUDA version..."
          pip uninstall torch torchvision torchaudio -y
          
          # Step 3: Install CUDA 13.0 PyTorch
          pip install torch torchvision --index-url https://download.pytorch.org/whl/cu130

      # --------------------------------------------------
      # 7. ä½¿ç”¨ PyInstaller æ‰“åŒ…
      # --------------------------------------------------
      - name: Build with PyInstaller
        run: |
          Write-Host "Building with PyInstaller..."
          pyinstaller app.spec --noconfirm
          
          Write-Host "Build completed. Output directory:"
          Get-ChildItem -Path dist/ | Select-Object Name

      # --------------------------------------------------
      # 8. 7z åˆ†å·å‹ç¼©ï¼ˆæœ€é«˜å‹ç¼©ç‡ï¼‰
      # --------------------------------------------------
      - name: Package with 7z split (ultra compression)
        run: |
          $version = "${{ needs.prepare.outputs.version }}"
          $variant = "${{ matrix.variant }}"
          $outputName = "Saber-Translator-$version-$variant"
          
          Write-Host "Compressing with 7z format... Output: $outputName.7z (split at 1900MB)"
          
          Push-Location dist
          
          # -t7z: 7z native format (better compatibility than ZIP split)
          # -mx=9: Maximum compression level
          # -mfb=258: Maximum FastBytes
          # -v1900m: Split at 1900MB
          7z a -t7z -mx=9 -mfb=258 -v1900m "../$outputName.7z" "Saber-Translator/*"
          
          Pop-Location
          
          Write-Host "Compression completed. Generated files:"
          Get-ChildItem "$outputName.7z*" | Format-Table Name, @{N='SizeMB';E={[math]::Round($_.Length/1MB, 2)}}

      # --------------------------------------------------
      # 9. éªŒè¯å‹ç¼©æ–‡ä»¶
      # --------------------------------------------------
      - name: Verify compressed archives
        run: |
          $version = "${{ needs.prepare.outputs.version }}"
          $variant = "${{ matrix.variant }}"
          $baseName = "Saber-Translator-$version-$variant"
          
          Write-Host "Verifying compressed archives..."
          
          # List all generated 7z split files
          $files = Get-ChildItem "$baseName.7z*" | Sort-Object Name
          
          Write-Host "Generated $($files.Count) archive file(s):"
          $files | Format-Table Name, @{N='SizeMB';E={[math]::Round($_.Length/1MB, 2)}}
          
          # Verify the first split file (7z will check all parts)
          $firstFile = $files | Select-Object -First 1
          Write-Host "Testing archive integrity: $($firstFile.Name)"
          7z t $firstFile.FullName
          
          if ($LASTEXITCODE -eq 0) {
            Write-Host "Archive verification passed!"
          } else {
            Write-Host "Archive verification failed!"
            exit 1
          }

      # --------------------------------------------------
      # 10. ç›´æ¥ä¸Šä¼ åˆ° Releaseï¼ˆä¸é€šè¿‡ artifactsï¼‰
      # --------------------------------------------------
      - name: Upload to Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $version = "${{ needs.prepare.outputs.version }}"
          $variant = "${{ matrix.variant }}"
          $tagName = "${{ needs.prepare.outputs.tag_name }}"
          $baseName = "Saber-Translator-$version-$variant"
          
          Write-Host "Uploading $variant version to Release $tagName..."
          
          # Get all 7z split files
          $files = Get-ChildItem "$baseName.7z*"
          
          foreach ($file in $files) {
            Write-Host "Uploading: $($file.Name) ($([math]::Round($file.Length/1MB, 0)) MB)"
            gh release upload $tagName $file.FullName --clobber
          }
          
          Write-Host "Upload completed for $variant version!"

      # --------------------------------------------------
      # 11. ä¸Šä¼ æ¨¡å‹æ–‡ä»¶åˆ° Releaseï¼ˆä»… CPU æ„å»ºæ‰§è¡Œï¼‰
      # --------------------------------------------------
      - name: Upload models to Release
        if: matrix.variant == 'cpu'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $tagName = "${{ needs.prepare.outputs.tag_name }}"
          
          Write-Host "Downloading models for upload to Release..."
          gh release download ${{ env.MODELS_RELEASE_TAG }} --pattern "models.*" --dir .
          
          Write-Host "Uploading models to Release $tagName..."
          Get-ChildItem "models.*" | ForEach-Object {
            Write-Host "Uploading: $($_.Name) ($([math]::Round($_.Length/1MB, 0)) MB)"
            gh release upload $tagName $_.FullName --clobber
          }
          
          Write-Host "Models upload completed!"

  # ============================================================================
  # å®Œæˆ Job - è¾“å‡ºç»“æœ
  # ============================================================================
  complete:
    needs: [prepare, build]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Summary
        run: |
          echo "=========================================="
          echo "Build and Release Summary"
          echo "=========================================="
          echo ""
          echo "Version: ${{ needs.prepare.outputs.version }}"
          echo "Tag: ${{ needs.prepare.outputs.tag_name }}"
          echo ""
          echo "Next steps:"
          echo "  1. Go to GitHub Releases page"
          echo "  2. Edit the draft release v${{ needs.prepare.outputs.version }}"
          echo "  3. Write your changelog"
          echo "  4. Click 'Publish release'"
          echo ""
          echo "Link: https://github.com/${{ github.repository }}/releases"
