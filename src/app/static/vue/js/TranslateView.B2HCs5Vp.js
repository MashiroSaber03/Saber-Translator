const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["js/system.DqO7MVCQ.js","js/index.D43OkxJW.js","js/vue-vendor.DIYfje1l.js","assets/index.BYanE9pL.css","js/client.Bht704G-.js","js/utils-vendor.B9ygI19o.js","js/session.C_VZSWrV.js"])))=>i.map(i=>d[i]);
import{D as xn,b as mo,c as vo,d as fo,e as _n,f as xt,a as rt,S as Xo,_ as He,g as ze,s as xe,u as ct,h as ds,i as gs,j as ps,k as Go,l as Zo,m as Qo,n as en,B as tn,o as on,p as ms,F as ro,q as nn,r as sn,t as vs,L as an,W as fs}from"./index.D43OkxJW.js";import{d as Jt,r as C,c as Q,a as je,e as A,h as de,f as e,t as oe,i as at,k as B,g as ut,n as Ie,u as me,o as dt,v as ae,x as Ue,l as Se,s as ln,m as St,K as nt,D as H,F as Oe,j as Ye,M as bo,N as bs,L as Cn,w as Ce,B as pt,O as $t,z as we,p as lt,P as go,b as Ot,Q as kt,S as rn,A as Sn,U as hs,T as kn,C as ys}from"./vue-vendor.DIYfje1l.js";import{p as xs,a as _s,b as Cs,c as Ss,d as ks,e as ws,f as $s,h as Ts,i as Is,j as Ps,k as ho,l as wn}from"./system.DqO7MVCQ.js";import{getFontList as $n,uploadFont as Rs,getTextboxPrompts as Ds,getPrompts as Ms,configApi as Ke,getFontListApi as Es}from"./config.CwRcCkM9.js";import{_ as We}from"./CustomSelect.vue_vue_type_style_index_0_lang.BbTiIb--.js";import{apiClient as Xe}from"./client.Bht704G-.js";import{B as Tn}from"./BaseModal.BjsrKUvd.js";import{getBookDetail as Bs}from"./bookshelf.B4ums9uK.js";import"./utils-vendor.B9ygI19o.js";function un(){return{firecrawl:{apiKey:""},agent:{provider:"openai",apiKey:"",customBaseUrl:"",modelName:"gpt-4o-mini",useStream:!1,forceJsonOutput:!0,maxRetries:3,timeout:120},extraction:{prompt:xn,maxIterations:10},download:{concurrency:3,timeout:30,retries:3,delay:100,useReferer:!0},imagePreprocess:{enabled:!1,autoRotate:!0,compression:{enabled:!1,quality:85,maxWidth:0,maxHeight:0},formatConvert:{enabled:!1,targetFormat:"original"}},advanced:{customCookie:"",customHeaders:"",bypassProxy:!1},ui:{showAgentLogs:!0,autoImport:!1}}}function As(n,t){function s(y){n.value.firecrawl.apiKey=y,t()}function o(y){n.value.agent.provider=y,t()}function i(y){n.value.agent.apiKey=y,t()}function r(y){n.value.agent.customBaseUrl=y,t()}function a(y){n.value.agent.modelName=y,t()}function u(y){n.value.agent.useStream=y,t()}function p(y){n.value.agent.forceJsonOutput=y,t()}function k(y){n.value.agent.timeout=y,t()}function f(y){n.value.extraction.prompt=y,t()}function P(y){n.value.extraction.maxIterations=y,t()}function L(){n.value.extraction.prompt=xn,t()}function M(y){n.value.download.concurrency=y,t()}function E(y){n.value.download.timeout=y,t()}function $(y){n.value.download.retries=y,t()}function j(y){n.value.download.delay=y,t()}function K(y){n.value.download.useReferer=y,t()}function U(y){n.value.imagePreprocess.enabled=y,t()}function g(y){n.value.imagePreprocess.autoRotate=y,t()}function d(y){n.value.imagePreprocess.compression.enabled=y,t()}function x(y){n.value.imagePreprocess.compression.quality=y,t()}function _(y){n.value.imagePreprocess.compression.maxWidth=y,t()}function q(y){n.value.imagePreprocess.compression.maxHeight=y,t()}function V(y){n.value.imagePreprocess.formatConvert.enabled=y,t()}function se(y){n.value.imagePreprocess.formatConvert.targetFormat=y,t()}function X(y){n.value.advanced.customCookie=y,t()}function ie(y){n.value.advanced.customHeaders=y,t()}function z(y){n.value.advanced.bypassProxy=y,t()}function R(y){n.value.ui.showAgentLogs=y,t()}function I(y){n.value.ui.autoImport=y,t()}function F(y){n.value={...n.value,...y},t()}return{setFirecrawlApiKey:s,setAgentProvider:o,setAgentApiKey:i,setAgentBaseUrl:r,setAgentModelName:a,setAgentUseStream:u,setAgentForceJson:p,setAgentTimeout:k,setExtractionPrompt:f,setExtractionMaxIterations:P,resetExtractionPrompt:L,setDownloadConcurrency:M,setDownloadTimeout:E,setDownloadRetries:$,setDownloadDelay:j,setDownloadUseReferer:K,setImagePreprocessEnabled:U,setImageAutoRotate:g,setImageCompressionEnabled:d,setImageCompressionQuality:x,setImageMaxWidth:_,setImageMaxHeight:q,setImageFormatConvertEnabled:V,setImageTargetFormat:se,setCustomCookie:X,setCustomHeaders:ie,setBypassProxy:z,setShowAgentLogs:R,setAutoImport:I,updateWebImportSettings:F}}async function yo(n){return Xe.post("/api/re_render_image",n)}async function Ls(n){try{return{success:!0,data:await Xe.post("/api/translate_single_text",n)}}catch(t){return{success:!1,error:t instanceof Error?t.message:"ç¿»è¯‘å¤±è´¥"}}}async function At(n){return Xe.post("/api/hq_translate_batch",n)}async function po(n,t,s){return Xe.post("/api/detect_boxes",{image:n,detector_type:t,...s})}async function In(n,t,s,o){return Xe.post("/api/ocr_single_bubble",{image_data:n,bubble_coords:t,ocr_engine:s,...o})}async function xo(n,t,s){return Xe.post("/api/inpaint_single_bubble",{image_data:n,bubble_coords:t,bubble_angle:s?.bubbleAngle??0,method:s?.method??"lama",lama_model:s?.lamaModel??"lama_mpe",...s?.maskData&&{mask_data:s.maskData}})}const Fs=Object.freeze(Object.defineProperty({__proto__:null,detectBoxes:po,hqTranslateBatch:At,inpaintSingleBubble:xo,ocrSingleBubble:In,reRenderImage:yo,translateSingleText:Ls},Symbol.toStringTag,{value:"Module"}));async function Pn(n,t){return Xe.post(`/api/sessions/meta/${n}`,t)}async function Ht(n,t,s,o){return Xe.post(`/api/sessions/page/${n}/${t}/${s}`,{data:o})}async function Rn(n,t,s){return Xe.post(`/api/sessions/page/${n}/${t}/meta`,s)}async function Dn(n,t,s){return Xe.post(`/api/sessions/save_translated/${n}/${t}`,s)}function jt(n){if(!n||typeof n!="string"||n.startsWith("/api/"))return null;if(n.startsWith("data:")){const t=n.split(",");return t.length>1?t[1]??null:null}return n}async function Us(n,t,s){const o=t.length;let i=0;for(let r=0;r<o;r++){const a=t[r];if(a){s?.onProgress?.(r+1,o);try{const u=jt(a.originalDataURL);u&&await Ht(n,r,"original",u);const p=jt(a.translatedDataURL);p&&await Ht(n,r,"translated",p);const k=jt(a.cleanImageData);k&&await Ht(n,r,"clean",k);const f={fileName:a.fileName,translationStatus:a.translationStatus,translationFailed:a.translationFailed,bubbleStates:a.bubbleStates,isManuallyAnnotated:a.isManuallyAnnotated,relativePath:a.relativePath,folderPath:a.folderPath,fontSize:a.fontSize,autoFontSize:a.autoFontSize,fontFamily:a.fontFamily,layoutDirection:a.layoutDirection,useAutoTextColor:a.useAutoTextColor,textColor:a.textColor,fillColor:a.fillColor,inpaintMethod:a.inpaintMethod,strokeEnabled:a.strokeEnabled,strokeColor:a.strokeColor,strokeWidth:a.strokeWidth};await Rn(n,r,f),i++}catch(u){console.error(`ä¿å­˜ç¬¬ ${r+1} é¡µå¤±è´¥:`,u)}}}return i}const Mn=Object.freeze(Object.defineProperty({__proto__:null,extractBase64:jt,saveAllPagesSequentially:Us,savePageImage:Ht,savePageMeta:Rn,saveSessionMeta:Pn,saveTranslatedPage:Dn},Symbol.toStringTag,{value:"Module"}));async function Os(){return Xe.get("/api/plugins")}async function zs(n){const t=encodeURIComponent(n);return Xe.post(`/api/plugins/${t}/enable`)}async function Ns(n){const t=encodeURIComponent(n);return Xe.post(`/api/plugins/${t}/disable`)}async function Vs(n){const t=encodeURIComponent(n);return Xe.delete(`/api/plugins/${t}`)}async function Ws(n){const t=encodeURIComponent(n);return Xe.get(`/api/plugins/${t}/config_schema`)}async function Ks(n){const t=encodeURIComponent(n);return Xe.get(`/api/plugins/${t}/config`)}async function qs(n,t){const s=encodeURIComponent(n);return Xe.post(`/api/plugins/${s}/config`,t)}async function Hs(){return Xe.get("/api/plugins/default_states")}async function js(n,t){const s=encodeURIComponent(n);return Xe.post(`/api/plugins/${s}/set_default_state`,{enabled:t})}async function Js(){return{states:(await Hs()).default_states}}const Ys=js,Xs=Ws,Gs=Ks,Zs=qs;function Qs(){return`img_${Date.now()}_${Math.random().toString(36).substring(2,9)}`}function cn(n,t,s){return{id:Qs(),fileName:n,originalDataURL:t,translatedDataURL:null,cleanImageData:null,bubbleStates:null,translationStatus:"pending",translationFailed:!1,fontSize:25,autoFontSize:!1,fontFamily:xt,layoutDirection:"auto",textColor:"#000000",fillColor:_n,inpaintMethod:"solid",strokeEnabled:fo,strokeColor:vo,strokeWidth:mo,hasUnsavedChanges:!1,...s}}const et=Jt("image",()=>{const n=C([]),t=C(-1),s=C(!1),o=Q(()=>t.value>=0&&t.value<n.value.length?n.value[t.value]??null:null),i=Q(()=>n.value.length),r=Q(()=>n.value.length>0),a=Q(()=>t.value>0),u=Q(()=>t.value<n.value.length-1),p=Q(()=>n.value.filter(y=>y.translationFailed).length),k=Q(()=>n.value.filter(y=>y.translationStatus==="completed").length),f=Q(()=>n.value.filter(y=>y.translationStatus==="pending").length);function P(y,m,l){const v=cn(y,m,l);return n.value.push(v),n.value.length===1&&(t.value=0),console.log(`å›¾ç‰‡å·²æ·»åŠ : ${y}ï¼Œå½“å‰å…± ${n.value.length} å¼ å›¾ç‰‡`),v}function L(y){const m=y.map(({fileName:v,originalDataURL:D,overrides:S})=>cn(v,D,S)),l=n.value.length===0;return n.value.push(...m),l&&n.value.length>0&&(t.value=0),console.log(`æ‰¹é‡æ·»åŠ äº† ${m.length} å¼ å›¾ç‰‡ï¼Œå½“å‰å…± ${n.value.length} å¼ `),m}function M(y){n.value=y.map(m=>({...m,strokeEnabled:m.strokeEnabled??fo,strokeColor:m.strokeColor||vo,strokeWidth:m.strokeWidth??mo,hasUnsavedChanges:m.hasUnsavedChanges||!1})),n.value.length>0?t.value=Math.min(Math.max(0,t.value),n.value.length-1):t.value=-1,console.log(`å›¾ç‰‡æ•°ç»„å·²è®¾ç½®ï¼Œå…± ${n.value.length} å¼ å›¾ç‰‡`)}function E(y){return y<0||y>=n.value.length?(console.warn(`åˆ é™¤å¤±è´¥: æ— æ•ˆçš„ç´¢å¼• ${y}`),!1):(n.value.splice(y,1),t.value===y?(t.value=Math.min(y,n.value.length-1),n.value.length===0&&(t.value=-1)):t.value>y&&t.value--,console.log(`å›¾ç‰‡å·²åˆ é™¤ï¼Œå½“å‰å…± ${n.value.length} å¼ å›¾ç‰‡`),!0)}function $(){return E(t.value)}function j(){n.value=[],t.value=-1,s.value=!1,console.log("æ‰€æœ‰å›¾ç‰‡å·²æ¸…é™¤")}function K(){const y=o.value?.id||null;if(n.value.sort((m,l)=>m.fileName.localeCompare(l.fileName,void 0,{numeric:!0,sensitivity:"base"})),y){const m=n.value.findIndex(l=>l.id===y);m>=0&&m!==t.value&&(console.log(`å›¾ç‰‡æ’åº: currentImageIndex ä» ${t.value} æ›´æ–°ä¸º ${m}`),t.value=m)}console.log("å›¾ç‰‡å·²æŒ‰æ–‡ä»¶åæ’åº")}function U(y){y>=-1&&y<n.value.length?(t.value=y,console.log(`å½“å‰å›¾ç‰‡ç´¢å¼•å·²è®¾ç½®ä¸º ${y}`)):console.warn(`è®¾ç½®ç´¢å¼•å¤±è´¥: æ— æ•ˆçš„ç´¢å¼• ${y}`)}function g(){return a.value?(t.value--,!0):!1}function d(){return u.value?(t.value++,!0):!1}function x(y){o.value?(Object.assign(o.value,y),console.log("å½“å‰å›¾ç‰‡å±æ€§å·²æ›´æ–°:",Object.keys(y))):console.warn("æ›´æ–°å¤±è´¥: å½“å‰æ²¡æœ‰é€‰ä¸­çš„å›¾ç‰‡")}function _(y,m){if(y>=0&&y<n.value.length){const l=n.value[y];l&&(Object.assign(l,m),console.log(`å›¾ç‰‡ ${y} å±æ€§å·²æ›´æ–°:`,Object.keys(m)))}else console.warn(`æ›´æ–°å¤±è´¥: æ— æ•ˆçš„ç´¢å¼• ${y}`)}function q(y){o.value&&(o.value.bubbleStates=y,o.value.hasUnsavedChanges=!0,console.log(`å½“å‰å›¾ç‰‡æ°”æ³¡çŠ¶æ€å·²æ›´æ–°ï¼Œå…± ${y?.length??0} ä¸ªæ°”æ³¡`))}function V(y){o.value&&(o.value.isManuallyAnnotated=y,o.value.hasUnsavedChanges=!0,console.log(`æ‰‹åŠ¨æ ‡æ³¨æ ‡è®°å·²è®¾ç½®ä¸º: ${y}`))}function se(y,m){o.value?(o.value[y]=m,o.value.hasUnsavedChanges=!0,console.log(`å½“å‰å›¾ç‰‡å±æ€§ ${String(y)} å·²æ›´æ–°`)):console.warn("æ›´æ–°å¤±è´¥: å½“å‰æ²¡æœ‰é€‰ä¸­çš„å›¾ç‰‡")}function X(y,m){o.value&&(o.value.translatedDataURL=y,m&&(o.value.cleanImageData=m),o.value.translationStatus="completed",o.value.translationFailed=!1,o.value.hasUnsavedChanges=!0,console.log("å½“å‰å›¾ç‰‡ç¿»è¯‘ç»“æœå·²æ›´æ–°"))}function ie(y,m,l){if(y>=0&&y<n.value.length){const v=n.value[y];v&&(v.translationStatus=m,v.translationFailed=m==="failed",l&&(v.errorMessage=l),console.log(`å›¾ç‰‡ ${y} ç¿»è¯‘çŠ¶æ€: ${m}`))}}function z(y){o.value&&(o.value.translationStatus="failed",o.value.translationFailed=!0,o.value.errorMessage=y,console.log(`å½“å‰å›¾ç‰‡ç¿»è¯‘å¤±è´¥: ${y}`))}function R(){n.value.forEach(y=>{y.translationStatus="pending",y.translationFailed=!1,y.errorMessage=void 0}),console.log("æ‰€æœ‰å›¾ç‰‡ç¿»è¯‘çŠ¶æ€å·²é‡ç½®")}function I(y){s.value=y,console.log(`æ‰¹é‡ç¿»è¯‘çŠ¶æ€: ${y?"è¿›è¡Œä¸­":"å·²å®Œæˆ"}`)}function F(){return n.value.map((y,m)=>y.translationFailed?m:-1).filter(y=>y!==-1)}return{images:n,currentImageIndex:t,isBatchTranslationInProgress:s,currentImage:o,imageCount:i,hasImages:r,canGoPrevious:a,canGoNext:u,failedImageCount:p,completedImageCount:k,pendingImageCount:f,addImage:P,addImages:L,setImages:M,deleteImage:E,deleteCurrentImage:$,clearImages:j,sortImagesByFileName:K,setCurrentImageIndex:U,goToPrevious:g,goToNext:d,updateCurrentImage:x,updateImageByIndex:_,updateCurrentBubbleStates:q,setManuallyAnnotated:V,updateCurrentImageProperty:se,updateCurrentTranslationResult:X,setTranslationStatus:ie,markCurrentAsFailed:z,resetAllTranslationStatus:R,setBatchTranslationInProgress:I,getFailedImageIndices:F}}),dn=Object.freeze(Object.defineProperty({__proto__:null,useImageStore:et},Symbol.toStringTag,{value:"Module"})),It=Jt("session",()=>{const n=C(null),t=C({bookId:null,chapterId:null,bookTitle:null,chapterTitle:null}),s=C([]),o=C(!1),i=C({current:0,total:0,message:""}),r=C(null),a=C(!1),u=Q(()=>t.value.bookId!==null&&t.value.chapterId!==null),p=Q(()=>t.value.bookId),k=Q(()=>t.value.chapterId);function f(z,R,I=null,F=null){t.value={bookId:z,chapterId:R,bookTitle:I,chapterTitle:F},console.log(`ä¼šè¯ä¸Šä¸‹æ–‡å·²è®¾ç½®: ä¹¦ç±=${z}, ç« èŠ‚=${R}`)}function P(z,R,I,F){f(z,R,I,F)}function L(){t.value={bookId:null,chapterId:null,bookTitle:null,chapterTitle:null},console.log("ä¼šè¯ä¸Šä¸‹æ–‡å·²æ¸…é™¤")}function M(z){const R=z.get("book"),I=z.get("chapter");R&&I&&f(R,I)}function E(z){n.value=z,console.log(`å½“å‰ä¼šè¯åç§°: ${z}`)}function $(){n.value=null}function j(z){s.value=z,console.log(`ä¼šè¯åˆ—è¡¨å·²æ›´æ–°ï¼Œå…± ${z.length} ä¸ªä¼šè¯`)}function K(z){const R=s.value.findIndex(I=>I.name===z.name);R>=0?s.value[R]=z:s.value.unshift(z)}function U(z){const R=s.value.findIndex(I=>I.name===z);R>=0&&s.value.splice(R,1)}function g(z,R){const I=s.value.find(F=>F.name===z);I&&(I.name=R)}function d(z){o.value=z}function x(z){a.value=z}function _(z){r.value=z}function q(){n.value=null,t.value={bookId:null,chapterId:null,bookTitle:null,chapterTitle:null},s.value=[],o.value=!1,a.value=!1,r.value=null,console.log("ä¼šè¯çŠ¶æ€å·²é‡ç½®")}async function V(z){if(!z||typeof z!="string")return null;if(z.startsWith("data:"))return z;if(!z.startsWith("/api/"))return null;try{const R=await fetch(z);if(!R.ok)return null;const I=await R.blob();return new Promise(F=>{const y=new FileReader;y.onloadend=()=>F(y.result),y.onerror=()=>F(null),y.readAsDataURL(I)})}catch(R){return console.error(`è½¬æ¢å›¾ç‰‡ URL å¤±è´¥: ${z}`,R),null}}async function se(z,R){const I=z.length;for(let F=0;F<I;F++){const y=z[F];if(y){if(R&&R(F+1,I),y.originalDataURL&&y.originalDataURL.startsWith("/api/")){const m=await V(y.originalDataURL);m&&(y.originalDataURL=m)}if(y.translatedDataURL&&y.translatedDataURL.startsWith("/api/")){const m=await V(y.translatedDataURL);m&&(y.translatedDataURL=m)}if(y.cleanImageData&&y.cleanImageData.startsWith("/api/")){const m=await V(y.cleanImageData);m&&(y.cleanImageData=m.replace(/^data:image\/\w+;base64,/,""))}}}}async function X(z){d(!0),_(null),i.value={current:0,total:0,message:"æ­£åœ¨åŠ è½½..."};try{const{useImageStore:R}=await rt(async()=>{const{useImageStore:W}=await Promise.resolve().then(()=>dn);return{useImageStore:W}},void 0),{useSettingsStore:I}=await rt(async()=>{const{useSettingsStore:W}=await import("./system.DqO7MVCQ.js").then(Z=>Z.s);return{useSettingsStore:W}},__vite__mapDeps([0,1,2,3,4,5])),{useBubbleStore:F}=await rt(async()=>{const{useBubbleStore:W}=await Promise.resolve().then(()=>ui);return{useBubbleStore:W}},void 0),y=R(),m=I(),l=F(),{loadSessionByPathApi:v}=await rt(async()=>{const{loadSessionByPathApi:W}=await import("./session.C_VZSWrV.js");return{loadSessionByPathApi:W}},__vite__mapDeps([6,4,5])),D=await v(z);if(!D.success||!D.session)throw new Error(D.error||"åŠ è½½ä¼šè¯å¤±è´¥");const S=D.session;if(S.images&&S.images.length>0){const W=S.images.map((c,h)=>({id:`session-${h}-${Date.now()}`,originalDataURL:c.originalDataURL,translatedDataURL:c.translatedDataURL||null,cleanImageData:c.cleanImageData||null,bubbleStates:c.bubbleStates!==void 0&&c.bubbleStates!==null?c.bubbleStates:null,isManuallyAnnotated:!!c.isManuallyAnnotated,relativePath:c.relativePath||void 0,folderPath:c.folderPath||void 0,fileName:c.fileName||`image-${h+1}.png`,translationStatus:c.translationStatus||"pending",translationFailed:!!c.translationFailed,hasUnsavedChanges:!1,fontSize:c.fontSize||24,autoFontSize:c.autoFontSize??!1,fontFamily:c.fontFamily||"Microsoft YaHei",layoutDirection:c.layoutDirection||"auto",useAutoTextColor:c.useAutoTextColor??void 0,textColor:c.textColor||"#000000",fillColor:c.fillColor||"#FFFFFF",inpaintMethod:c.inpaintMethod||"litelama",strokeEnabled:c.strokeEnabled??!1,strokeColor:c.strokeColor||"#FFFFFF",strokeWidth:c.strokeWidth||2}));W.length>0&&(console.log("æ­£åœ¨åŠ è½½å›¾ç‰‡..."),i.value={current:0,total:W.length,message:"æ­£åœ¨åŠ è½½å›¾ç‰‡..."},await se(W,(c,h)=>{const le=c/h*100;i.value={current:c,total:h,message:`åŠ è½½å›¾ç‰‡ ${c}/${h}...`},console.log(`åŠ è½½å›¾ç‰‡ ${c}/${h}... (${le.toFixed(0)}%)`)}),i.value={current:W.length,total:W.length,message:"åŠ è½½å®Œæˆ"},console.log("å›¾ç‰‡åŠ è½½å®Œæˆï¼Œå·²è½¬æ¢ä¸º Base64"),setTimeout(()=>{i.value={current:0,total:0,message:""}},500)),y.setImages(W);let Z=0;typeof S.currentImageIndex=="number"&&(Z=S.currentImageIndex,(Z>=W.length||Z<0)&&(Z=W.length>0?0:-1)),y.setCurrentImageIndex(Z);const Y=W[Z];Y&&Y.bubbleStates&&Y.bubbleStates.length>0?l.setBubbles(Y.bubbleStates,!0):l.clearBubblesLocal(),console.log(`æŒ‰è·¯å¾„åŠ è½½ä¼šè¯æˆåŠŸ: ${z}, å…± ${W.length} å¼ å›¾ç‰‡`)}const w=S.ui_settings;if(w){(w.targetLanguage||w.sourceLanguage)&&m.updateSettings({targetLanguage:w.targetLanguage||void 0,sourceLanguage:w.sourceLanguage||void 0});const W=w.useInpaintingMethod,Y=["solid","lama_mpe","litelama"].includes(W)?W:m.settings.textStyle.inpaintMethod;m.updateTextStyle({fontSize:w.fontSize||m.settings.textStyle.fontSize,autoFontSize:w.autoFontSize??m.settings.textStyle.autoFontSize,fontFamily:w.fontFamily||m.settings.textStyle.fontFamily,layoutDirection:w.layoutDirection||m.settings.textStyle.layoutDirection,textColor:w.textColor||m.settings.textStyle.textColor,fillColor:w.fillColor||m.settings.textStyle.fillColor,inpaintMethod:Y,strokeEnabled:w.strokeEnabled??m.settings.textStyle.strokeEnabled,strokeColor:w.strokeColor||m.settings.textStyle.strokeColor,strokeWidth:w.strokeWidth||m.settings.textStyle.strokeWidth,useAutoTextColor:w.useAutoTextColor??m.settings.textStyle.useAutoTextColor}),console.log("UI è®¾ç½®å·²æ¢å¤")}return E(z),!0}catch(R){const I=R instanceof Error?R.message:"åŠ è½½ä¼šè¯å¤±è´¥";throw _(I),console.error(`æŒ‰è·¯å¾„åŠ è½½ä¼šè¯å¤±è´¥: ${z}`,R),R}finally{d(!1)}}async function ie(z,R){if(!z||!R)return console.log("æœªåœ¨ä¹¦ç±/ç« èŠ‚æ¨¡å¼ï¼Œä¸æ”¯æŒä¿å­˜"),!1;console.log(`ä¿å­˜ç« èŠ‚ä¼šè¯: book=${z}, chapter=${R}`);const{useImageStore:I}=await rt(async()=>{const{useImageStore:S}=await Promise.resolve().then(()=>dn);return{useImageStore:S}},void 0),{useSettingsStore:F}=await rt(async()=>{const{useSettingsStore:S}=await import("./system.DqO7MVCQ.js").then(w=>w.s);return{useSettingsStore:S}},__vite__mapDeps([0,1,2,3,4,5])),y=I(),m=F(),l=Array.isArray(y.images)?y.images:[];if(!l||l.length===0)return console.log("æ²¡æœ‰å›¾ç‰‡æ•°æ®å¯ä¿å­˜"),!1;const v=`bookshelf/${z}/${R}`;x(!0),_(null);const D=l.length;i.value={current:0,total:D,message:`å‡†å¤‡ä¿å­˜ ${D} å¼ å›¾ç‰‡...`};try{l.some(h=>h.originalDataURL&&h.originalDataURL.startsWith("/api/")||h.translatedDataURL&&h.translatedDataURL.startsWith("/api/")||h.cleanImageData&&h.cleanImageData.startsWith("/api/"))&&(console.log("[saveChapterSession] æ£€æµ‹åˆ° /api/ URL æ ¼å¼å›¾ç‰‡ï¼Œå¼€å§‹è½¬æ¢ä¸º Base64..."),i.value={current:0,total:D,message:"è½¬æ¢å›¾ç‰‡æ ¼å¼..."},await se(l,(h,le)=>{i.value={current:0,total:D,message:`è½¬æ¢å›¾ç‰‡ ${h}/${le}...`}}),console.log("[saveChapterSession] å›¾ç‰‡æ ¼å¼è½¬æ¢å®Œæˆ"));const{textStyle:w}=m.settings,W={fontSize:w.fontSize,autoFontSize:w.autoFontSize,fontFamily:w.fontFamily,layoutDirection:w.layoutDirection,textColor:w.textColor,useInpaintingMethod:w.inpaintMethod,fillColor:w.fillColor,strokeEnabled:w.strokeEnabled,strokeColor:w.strokeColor,strokeWidth:w.strokeWidth,useAutoTextColor:w.useAutoTextColor},{saveAllPagesSequentially:Z,saveSessionMeta:Y}=await rt(async()=>{const{saveAllPagesSequentially:h,saveSessionMeta:le}=await Promise.resolve().then(()=>Mn);return{saveAllPagesSequentially:h,saveSessionMeta:le}},void 0),c=await Z(v,l,{onProgress:(h,le)=>{i.value={current:h,total:le,message:`ä¿å­˜å›¾ç‰‡ ${h}/${le}...`}}});i.value={current:D,total:D,message:"å®Œæˆä¿å­˜..."},await Y(v,{ui_settings:W,total_pages:D,currentImageIndex:y.currentImageIndex}),console.log(`ç« èŠ‚ä¿å­˜å®Œæˆ: ${c}/${D} å¼ å›¾ç‰‡`);try{const{apiClient:h}=await rt(async()=>{const{apiClient:le}=await import("./client.Bht704G-.js");return{apiClient:le}},__vite__mapDeps([4,5]));await h.put(`/api/bookshelf/books/${z}/chapters/${R}/image-count`,{count:D})}catch(h){console.warn("æ›´æ–°ç« èŠ‚å›¾ç‰‡æ•°é‡å¤±è´¥ï¼ˆéè‡´å‘½ï¼‰:",h)}return i.value={current:D,total:D,message:"ä¿å­˜å®Œæˆ"},setTimeout(()=>{i.value={current:0,total:0,message:""}},1e3),!0}catch(S){const w=S instanceof Error?S.message:"ä¿å­˜ç« èŠ‚ä¼šè¯å¤±è´¥";return _(w),console.error("ä¿å­˜å¤±è´¥:",S),i.value={current:0,total:0,message:""},!1}finally{x(!1)}}return{currentSessionName:n,context:t,sessionList:s,isLoading:o,isSaving:a,error:r,loadingProgress:i,isBookshelfMode:u,currentBookId:p,currentChapterId:k,setContext:f,clearContext:L,parseContextFromUrl:M,setSessionName:E,clearSessionName:$,setSessionList:j,addToSessionList:K,removeFromSessionList:U,renameInSessionList:g,setLoading:d,setSaving:x,setError:_,imageUrlToBase64:V,saveChapterSession:ie,loadSessionByPath:X,setBookChapterContext:P,reset:q}}),zt={originalText:"",translatedText:"",textboxText:"",coords:[0,0,100,100],polygon:[],fontSize:25,fontFamily:xt,textDirection:"vertical",autoTextDirection:"vertical",textColor:"#000000",fillColor:_n,rotationAngle:0,position:{x:0,y:0},strokeEnabled:fo,strokeColor:vo,strokeWidth:mo,inpaintMethod:"solid",autoFgColor:null,autoBgColor:null,colorConfidence:0};function ea(n){return{...{...zt,...n},coords:n?.coords?[...n.coords]:[...zt.coords],polygon:n?.polygon?n.polygon.map(s=>[...s]):[],position:n?.position?{...zt.position,...n.position}:{...zt.position}}}function ta(n){const[t,s,o,i]=n,r=Math.abs(o-t);return Math.abs(i-s)>r?"vertical":"horizontal"}function Nt(n){return n.map(t=>({...t,coords:[...t.coords],polygon:t.polygon?t.polygon.map(s=>[...s]):[],position:{...t.position},autoFgColor:t.autoFgColor?[...t.autoFgColor]:null,autoBgColor:t.autoBgColor?[...t.autoBgColor]:null}))}function oa(n){if(!n||typeof n!="object")return!1;const t=n;if(!Array.isArray(t.coords)||t.coords.length!==4||!t.coords.every(i=>typeof i=="number"&&!isNaN(i))||typeof t.fontSize!="number"||t.fontSize<=0)return!1;const s=["vertical","horizontal","auto"];if(typeof t.textDirection!="string"||!s.includes(t.textDirection))return!1;const o=["solid","lama_mpe","litelama"];return!(typeof t.inpaintMethod!="string"||!o.includes(t.inpaintMethod))}function na(n){let t=n,s=0,o=0,i=Date.now();const r=()=>t<=0?0:Math.ceil(6e4/t);return{async acquire(){if(t<=0)return;const a=Date.now(),u=r();if(a-i>=6e4&&(i=a,o=0),o>=t){const k=6e4-(a-i);k>0&&await gn(k),i=Date.now(),o=0}const p=a-s;p<u&&await gn(u-p),s=Date.now(),o++},reset(){s=0,o=0,i=Date.now()},getRpm(){return t},setRpm(a){t=a,this.reset()}}}function gn(n){return new Promise(t=>setTimeout(t,n))}function pn(n){const t=n.replace(/\\/g,"/"),s=[],o=/(\d+)/g;let i=0,r;for(;(r=o.exec(t))!==null;){if(r.index>i){const a=t.slice(i,r.index);a&&s.push([!0,a.toLowerCase()])}s.push([!1,parseInt(r[0],10)]),i=o.lastIndex}if(i<t.length){const a=t.slice(i);a&&s.push([!0,a.toLowerCase()])}return s}function sa(n,t){const s=pn(n),o=pn(t),i=Math.min(s.length,o.length);for(let r=0;r<i;r++){const[a,u]=s[r],[p,k]=o[r];if(a!==p)return a?1:-1;if(u<k)return-1;if(u>k)return 1}return s.length-o.length}function aa(n,t=s=>String(s)){return[...n].sort((s,o)=>sa(t(s),t(o)))}const mn="webImportDisclaimerAccepted",_o=Jt("webImport",()=>{const n=C(un()),t=C("idle"),s=C(""),o=C([]),i=C(null),r=C(new Set),a=C({current:0,total:0}),u=C([]),p=C(null),k=C(!1),f=C(!1),P=C(!1),L=Q(()=>t.value==="extracting"),M=Q(()=>t.value==="downloading"),E=Q(()=>L.value||M.value),$=Q(()=>r.value.size),j=Q(()=>a.value.total===0?0:Math.round(a.value.current/a.value.total*100));function K(){try{localStorage.setItem(Xo,JSON.stringify(n.value))}catch(w){console.error("ä¿å­˜ç½‘é¡µå¯¼å…¥è®¾ç½®å¤±è´¥:",w)}}function U(){try{const w=localStorage.getItem(Xo);if(w){const W=JSON.parse(w);n.value=g(un(),W)}}catch(w){console.error("åŠ è½½ç½‘é¡µå¯¼å…¥è®¾ç½®å¤±è´¥:",w)}}function g(w,W){const Z={...w};for(const Y in W)if(Object.prototype.hasOwnProperty.call(W,Y)){const c=W[Y],h=w[Y];c!==null&&typeof c=="object"&&!Array.isArray(c)&&h!==null&&typeof h=="object"&&!Array.isArray(h)?Z[Y]=g(h,c):c!==void 0&&(Z[Y]=c)}return Z}function d(){f.value?k.value=!0:P.value=!0}function x(){f.value=!0,P.value=!1,k.value=!0;try{localStorage.setItem(mn,"true")}catch(w){console.error("ä¿å­˜å…è´£å£°æ˜çŠ¶æ€å¤±è´¥:",w)}}function _(){P.value=!1}function q(){try{const w=localStorage.getItem(mn);f.value=w==="true"}catch(w){console.error("åŠ è½½å…è´£å£°æ˜çŠ¶æ€å¤±è´¥:",w)}}function V(){k.value=!1}function se(){t.value="idle",s.value="",o.value=[],i.value=null,r.value=new Set,a.value={current:0,total:0},u.value=[],p.value=null}function X(w){s.value=w}function ie(w){o.value.push(w)}function z(){o.value=[]}function R(w){i.value&&i.value.pages.length>0?(i.value.comicTitle=w.comicTitle,i.value.chapterTitle=w.chapterTitle,i.value.totalPages=w.totalPages,i.value.sourceUrl=w.sourceUrl,i.value.referer=w.referer,i.value.engine=w.engine,i.value.success=w.success,i.value.error=w.error):(i.value=w,w.success&&w.pages&&(r.value=new Set(w.pages.map(W=>W.pageNumber))))}function I(w){r.value.has(w)?r.value.delete(w):r.value.add(w),r.value=new Set(r.value)}function F(){i.value?.pages&&(r.value.size===i.value.pages.length?r.value=new Set:r.value=new Set(i.value.pages.map(w=>w.pageNumber)))}function y(w){t.value=w}function m(w){p.value=w,w&&(t.value="error")}function l(w,W){a.value={current:w,total:W}}function v(w){u.value=w}function D(w){i.value||(i.value={success:!0,comicTitle:"",chapterTitle:"",pages:[],totalPages:0,sourceUrl:s.value,referer:"",engine:"gallery-dl"}),i.value.pages.push(w),i.value.totalPages=i.value.pages.length,r.value.add(w.pageNumber),r.value=new Set(r.value)}const S=As(n,K);return U(),q(),{settings:n,status:t,url:s,logs:o,extractResult:i,selectedPages:r,downloadProgress:a,downloadedImages:u,error:p,modalVisible:k,disclaimerAccepted:f,disclaimerVisible:P,isExtracting:L,isDownloading:M,isProcessing:E,selectedCount:$,downloadProgressPercent:j,saveToStorage:K,loadFromStorage:U,openModal:d,closeModal:V,resetState:se,setUrl:X,addLog:ie,clearLogs:z,setExtractResult:R,togglePageSelection:I,toggleSelectAll:F,setStatus:y,setError:m,updateDownloadProgress:l,setDownloadedImages:v,addPageIncremental:D,acceptDisclaimer:x,rejectDisclaimer:_,...S}}),la={key:0,class:"translation-progress-bar"},ia={class:"progress-bar-label"},ra={class:"progress-bar"},ua=je({__name:"ProgressBar",props:{visible:{type:Boolean,default:!0},percentage:{},label:{default:"è¿›åº¦"}},setup(n){return(t,s)=>n.visible?(B(),A("div",la,[e("div",ia,oe(n.label),1),e("div",ra,[e("div",{class:"progress",style:at({width:`${n.percentage}%`})},null,4)])])):de("",!0)}}),Co=He(ua,[["__scopeId","data-v-f915cadf"]]),ca={class:"image-upload"},da={class:"error-text"},ga={key:2,class:"loading-overlay"},pa=je({__name:"ImageUpload",emits:["uploadComplete"],setup(n,{expose:t,emit:s}){const o=s,i=et(),r=ze(),a=_o(),u=C(null),p=C(null),k=C(!1),f=C(!1),P=C(""),L=C(0),M=C(""),E=C(!1),$=Q(()=>r.settings.pdfProcessingMethod);function j(){u.value?.click()}function K(){a.openModal()}function U(){p.value?.click()}async function g(m){const l=m.target;if(!l.files||l.files.length===0)return;const D=Array.from(l.files).filter(w=>w.type.startsWith("image/"));if(D.length===0){xe("æ‰€é€‰æ–‡ä»¶å¤¹ä¸­æ²¡æœ‰æ‰¾åˆ°å›¾ç‰‡æ–‡ä»¶","warning"),l.value="";return}const S=aa(D,w=>w.webkitRelativePath);console.log(`ä»æ–‡ä»¶å¤¹å¯¼å…¥ ${S.length} å¼ å›¾ç‰‡`),await d(S),l.value=""}async function d(m){if(m.length!==0){k.value=!0,E.value=!0,L.value=0;try{let l=0;const v=m.length;for(let D=0;D<m.length;D++){const S=m[D];if(!S||!S.type.startsWith("image/"))continue;M.value=S.name;const w=S.webkitRelativePath||"",W=w.includes("/")?w.substring(0,w.lastIndexOf("/")):"";await new Promise((Z,Y)=>{const c=new FileReader;c.onload=h=>{const le=h.target?.result;i.addImage(S.name,le,{relativePath:w,folderPath:W}),Z()},c.onerror=()=>Y(new Error(`è¯»å–å›¾ç‰‡å¤±è´¥: ${S.name}`)),c.readAsDataURL(S)}),l++,L.value=Math.round((D+1)/v*100)}l>0&&(xe(`å·²æ·»åŠ  ${l} å¼ å›¾ç‰‡`,"success"),o("uploadComplete",l))}catch(l){console.error("å¤„ç†æ–‡ä»¶å¤±è´¥:",l);const v=l instanceof Error?l.message:"å¤„ç†æ–‡ä»¶å¤±è´¥";xe(v,"error")}finally{k.value=!1,E.value=!1}}}async function x(m){const l=m.target;!l.files||l.files.length===0||(await se(Array.from(l.files)),l.value="")}async function _(m){m.preventDefault(),f.value=!1,!(!m.dataTransfer?.files||m.dataTransfer.files.length===0)&&await se(Array.from(m.dataTransfer.files))}function q(m){m.preventDefault(),f.value=!0}function V(m){const l=m.currentTarget.getBoundingClientRect(),v=m.clientX,D=m.clientY;(v<l.left||v>l.right||D<l.top||D>l.bottom)&&(f.value=!1)}async function se(m){if(m.length!==0){k.value=!0,P.value="",E.value=!0,L.value=0;try{let l=0;const v=m.length;for(let D=0;D<m.length;D++){const S=m[D];if(!S)continue;M.value=S.name;const w=S.type,W=S.name.toLowerCase();if(w.startsWith("image/"))await X(S),l++;else if(w==="application/pdf"||W.endsWith(".pdf")){const Z=await ie(S);l+=Z}else if(W.endsWith(".mobi")||W.endsWith(".azw")||W.endsWith(".azw3")){const Z=await F(S);l+=Z}else console.warn(`ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹: ${S.name}`),xe(`ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹: ${S.name}`,"warning");L.value=Math.round((D+1)/v*100)}l>0&&(xe(`å·²æ·»åŠ  ${l} å¼ å›¾ç‰‡`,"success"),o("uploadComplete",l))}catch(l){console.error("å¤„ç†æ–‡ä»¶å¤±è´¥:",l);const v=l instanceof Error?l.message:"å¤„ç†æ–‡ä»¶å¤±è´¥ï¼Œè¯·é‡è¯•";P.value=v,xe(v,"error")}finally{k.value=!1,E.value=!1,M.value=""}}}async function X(m){return new Promise((l,v)=>{const D=new FileReader;D.onload=S=>{const w=S.target?.result;i.addImage(m.name,w),l()},D.onerror=()=>v(new Error(`è¯»å–å›¾ç‰‡æ–‡ä»¶å¤±è´¥: ${m.name}`)),D.readAsDataURL(m)})}async function ie(m){return $.value==="frontend"?await R(m):await I(m)}function z(m){return new Promise((l,v)=>{const D=new FileReader;D.onload=()=>l(D.result),D.onerror=v,D.readAsDataURL(m)})}async function R(m){try{const l=await rt(()=>import("./pdf.U7tdldy2.js").then(Z=>Z.p),[]);l.GlobalWorkerOptions.workerSrc=`https://cdnjs.cloudflare.com/ajax/libs/pdf.js/${l.version}/pdf.worker.min.js`;const v=await m.arrayBuffer(),D=await l.getDocument({data:v}).promise,S=D.numPages;console.log(`PDF ${m.name} å…± ${S} é¡µï¼Œå¼€å§‹æœ¬åœ°æ¸²æŸ“...`),xe(`æ­£åœ¨è§£æ PDFï¼Œå…± ${S} é¡µ...`,"info");const w=typeof OffscreenCanvas<"u";w&&console.log("ä½¿ç”¨ OffscreenCanvas åå°æ¸²æŸ“æ¨¡å¼");let W=0;for(let Z=1;Z<=S;Z++){M.value=`${m.name} - ç¬¬ ${Z}/${S} é¡µ`,L.value=Math.round(Z/S*100);try{const Y=await D.getPage(Z),h=Y.getViewport({scale:2});let le;if(w){const G=new OffscreenCanvas(h.width,h.height),ce=G.getContext("2d");await Y.render({canvasContext:ce,viewport:h}).promise;const _e=await G.convertToBlob({type:"image/jpeg",quality:1});le=await z(_e)}else{const G=document.createElement("canvas"),ce=G.getContext("2d");G.width=h.width,G.height=h.height,await Y.render({canvasContext:ce,viewport:h}).promise,le=G.toDataURL("image/jpeg",1)}const T=`${m.name}_é¡µé¢${Z}`;i.addImage(T,le),W++,console.log(`  é¡µé¢ ${Z}/${S} å¤„ç†å®Œæˆ`)}catch(Y){console.warn(`PDF ${m.name} ç¬¬ ${Z} é¡µæ¸²æŸ“å¤±è´¥:`,Y)}}return console.log(`PDF ${m.name} å…¨éƒ¨ ${S} é¡µå¤„ç†å®Œæˆ`),W}catch(l){return console.error("å‰ç«¯ PDF è§£æå¤±è´¥:",l),xe("å‰ç«¯ PDF è§£æå¤±è´¥ï¼Œå°è¯•ä½¿ç”¨åç«¯è§£æ...","warning"),await I(m)}}async function I(m){let v=null;try{xe("æ­£åœ¨ä¸Šä¼  PDF æ–‡ä»¶...","info");const D=await xs(m,5);if(!D.success||!D.session_id)throw new Error(D.error||"PDF è§£æå¯åŠ¨å¤±è´¥");v=D.session_id;const S=D.total_pages||0;console.log(`PDF ${m.name} å…± ${S} é¡µï¼Œå¼€å§‹åç«¯åˆ†æ‰¹è§£æ...`),xe(`æ­£åœ¨è§£æ PDFï¼Œå…± ${S} é¡µ...`,"info");let w=0;for(let W=0;W<S;W+=5){M.value=`${m.name} - å¤„ç†ä¸­ ${Math.min(W+5,S)}/${S} é¡µ`,L.value=S>0?Math.round(W/S*100):0;const Z=await _s(v,W,5);if(!Z.success){console.warn(`æ‰¹æ¬¡ ${W} è·å–å¤±è´¥:`,Z.error);continue}if(Z.images&&Z.images.length>0)for(const Y of Z.images){if(!Y||!Y.data_url)continue;const c=`${m.name}_é¡µé¢${String(Y.page_index+1).padStart(4,"0")}`;i.addImage(c,Y.data_url),w++}console.log(`  å·²åŠ è½½ ${w}/${S} é¡µ`)}return console.log(`PDF ${m.name} å…¨éƒ¨ ${w} é¡µå¤„ç†å®Œæˆ`),w}catch(D){throw console.error("åç«¯ PDF è§£æå¤±è´¥:",D),D}finally{if(v)try{await Cs(v)}catch(D){console.warn("PDF ä¼šè¯æ¸…ç†å¤±è´¥:",D)}}}async function F(m){let l=null;try{xe("æ­£åœ¨ä¸Šä¼ ç”µå­ä¹¦æ–‡ä»¶...","info");const v=await Ss(m,5);if(!v.success||!v.session_id)throw new Error(v.error||"MOBI/AZW è§£æå¯åŠ¨å¤±è´¥");l=v.session_id;const D=v.total_images||0;xe(`æ­£åœ¨è§£æç”µå­ä¹¦ï¼Œå…± ${D} å¼ å›¾ç‰‡...`,"info");let S=0,w=!0;for(;w;){M.value=`${m.name} - å·²å¤„ç† ${S}/${D} å¼ `,L.value=D>0?Math.round(S/D*100):0;const W=await ks(l);if(!W.success)throw new Error(W.error||"MOBI/AZW æ‰¹æ¬¡è§£æå¤±è´¥");if(W.images&&W.images.length>0){for(let Z=0;Z<W.images.length;Z++){const Y=W.images[Z];if(!Y)continue;const c=S+Z+1,h=`${m.name.replace(/\.(mobi|azw|azw3)$/i,"")}_image_${String(c).padStart(3,"0")}.png`,le=Y.startsWith("data:")?Y:`data:image/png;base64,${Y}`;i.addImage(h,le)}S+=W.images.length}w=W.has_more??!1}return S}catch(v){throw console.error("MOBI/AZW è§£æå¤±è´¥:",v),v}finally{if(l)try{await ws(l)}catch(v){console.warn("MOBI/AZW ä¼šè¯æ¸…ç†å¤±è´¥:",v)}}}function y(){P.value=""}return t({triggerFileSelect:j,triggerFolderSelect:U,processFiles:se,clearError:y}),(m,l)=>(B(),A("div",ca,[e("div",{id:"drop-area",class:Ie(["drop-area",{"drag-over":f.value,loading:k.value}]),onDragover:q,onDragleave:V,onDrop:_},[e("div",{class:"drop-content"},[e("p",{class:"drop-text"},[l[0]||(l[0]=me(" æ‹–æ‹½å›¾ç‰‡ã€PDFæˆ–MOBIæ–‡ä»¶åˆ°è¿™é‡Œï¼Œæˆ– ",-1)),e("span",{class:"select-link",onClick:j}," é€‰æ‹©æ–‡ä»¶ "),l[1]||(l[1]=e("span",{class:"separator"}," | ",-1)),e("span",{class:"select-link folder-link",onClick:U}," ğŸ“ é€‰æ‹©æ–‡ä»¶å¤¹ "),l[2]||(l[2]=e("span",{class:"separator"}," | ",-1)),e("span",{class:"select-link web-import-link",onClick:K}," ğŸŒ ä»ç½‘é¡µå¯¼å…¥ ")])]),e("input",{ref_key:"fileInputRef",ref:u,type:"file",id:"imageUpload",accept:"image/*,application/pdf,.mobi,.azw,.azw3",multiple:"",class:"file-input",onChange:x},null,544),e("input",{ref_key:"folderInputRef",ref:p,type:"file",webkitdirectory:"",class:"file-input",onChange:g},null,544)],34),E.value?(B(),ut(Co,{key:0,visible:!0,percentage:L.value,label:M.value||"å¤„ç†ä¸­..."},null,8,["percentage","label"])):de("",!0),P.value?(B(),A("div",{key:1,class:"error-message",onClick:y},[l[3]||(l[3]=e("span",{class:"error-icon"},"âš ï¸",-1)),e("span",da,oe(P.value),1),l[4]||(l[4]=e("span",{class:"error-close"},"Ã—",-1))])):de("",!0),k.value&&!E.value?(B(),A("div",ga,[...l[5]||(l[5]=[e("div",{class:"spinner"},null,-1),e("span",{class:"loading-text"},"å¤„ç†ä¸­...",-1)])])):de("",!0)]))}}),ma=He(pa,[["__scopeId","data-v-5ff3dc04"]]),va={id:"settings-sidebar",class:"settings-sidebar"},fa={class:"card settings-card"},ba={id:"font-settings",class:"settings-card collapsible-panel"},ha={class:"toggle-icon"},ya={class:"collapsible-content"},xa={class:"settings-form"},_a={class:"form-group"},Ca=["value","disabled","title"],Sa={class:"auto-fontSize-option",title:"å‹¾é€‰åï¼Œé¦–æ¬¡ç¿»è¯‘æ—¶è‡ªåŠ¨ä¸ºæ¯ä¸ªæ°”æ³¡è®¡ç®—åˆé€‚çš„å­—å·"},ka=["checked"],wa={class:"form-group"},$a={class:"form-group"},Ta={class:"form-group"},Ia={class:"color-with-auto"},Pa={class:"auto-color-toggle",title:"ç¿»è¯‘æ—¶è‡ªåŠ¨ä½¿ç”¨è¯†åˆ«åˆ°çš„æ–‡å­—é¢œè‰²"},Ra=["checked"],Da=["value","disabled"],Ma={key:0,class:"auto-color-hint"},Ea={class:"form-group"},Ba={class:"checkbox-label"},Aa=["checked"],La={key:0,id:"strokeOptions",class:"stroke-options"},Fa={class:"form-group"},Ua=["value"],Oa={class:"form-group"},za=["value"],Na={class:"form-group"},Va={key:0,id:"solidColorOptions",class:"form-group"},Wa=["value"],Ka={class:"apply-settings-group"},qa=["disabled"],Ha={key:0,class:"apply-options-dropdown"},ja={class:"apply-option"},Ja=["checked"],Ya={class:"apply-option"},Xa={class:"apply-option"},Ga={class:"apply-option"},Za={class:"apply-option"},Qa={class:"apply-option"},el={class:"apply-option"},tl={class:"apply-option"},ol={class:"apply-option"},nl={id:"page-range-settings",class:"settings-card collapsible-panel"},sl={class:"toggle-icon"},al={class:"collapsible-content"},ll={class:"settings-form page-range-form"},il={class:"range-header-row"},rl={class:"range-toggle-compact"},ul=["disabled"],cl={class:"total-count"},dl={class:"page-range-inputs-compact"},gl=["value","max"],pl=["value","max"],ml={key:0,class:"range-error-compact"},vl={class:"action-buttons"},fl=["disabled"],bl=["disabled","title"],hl=["disabled","title"],yl=["disabled","title"],xl=["disabled"],_l=["disabled","title"],Cl=["disabled"],Sl=["disabled"],kl={class:"navigation-buttons"},wl=["disabled"],$l=["disabled"],Tl=je({__name:"SettingsSidebar",emits:["translateCurrent","translateAll","translateRange","hqTranslate","hqTranslateRange","proofread","proofreadRange","removeText","removeAllText","removeTextRange","deleteCurrent","clearAll","cleanTemp","openPlugins","openSettings","previous","next","applyToAll","textStyleChanged","autoFontSizeChanged"],setup(n,{emit:t}){const s=t,o=et(),i=ze(),r=C(!0),a=C(!1),u=C({fontSize:!0,fontFamily:!0,layoutDirection:!0,textColor:!0,fillColor:!0,strokeEnabled:!0,strokeColor:!0,strokeWidth:!0}),p=C(!1),k=C(!1),f=C(1),P=C(1),L=[{label:"è‡ªåŠ¨ (æ ¹æ®æ£€æµ‹)",value:"auto"},{label:"ç«–å‘æ’ç‰ˆ",value:"vertical"},{label:"æ¨ªå‘æ’ç‰ˆ",value:"horizontal"}],M=[{label:"çº¯è‰²å¡«å……",value:"solid"},{label:"LAMAä¿®å¤ (é€Ÿåº¦ä¼˜åŒ–)",value:"lama_mpe"},{label:"LAMAä¿®å¤ (é€šç”¨)",value:"litelama"}],E=Q(()=>o.currentImage),$=Q(()=>o.hasImages),j=Q(()=>o.images.length),K=Q(()=>f.value>=1&&P.value<=j.value&&f.value<=P.value),U=Q(()=>$.value&&!o.isBatchTranslationInProgress),g=Q(()=>o.canGoPrevious),d=Q(()=>o.canGoNext),x=Q(()=>i.textStyle),_=C([]),q=[xt,"fonts/msyh.ttc","fonts/simhei.ttf","fonts/simsun.ttc"],V=C(null),se=Q(()=>{const te=_.value.map(b=>({label:F(b),value:b}));return te.push({label:"è‡ªå®šä¹‰å­—ä½“...",value:"custom-font"}),te});dt(async()=>{await X();const te=x.value.fontFamily;te&&!_.value.includes(te)&&(_.value=[te,..._.value])});async function X(){try{const te=await $n();if(te.fonts&&Array.isArray(te.fonts)&&te.fonts.length>0){const b=te.fonts[0];if(typeof b=="object"&&"path"in b){const J=te.fonts.map(ve=>typeof ve=="object"?ve.path:ve);_.value=J}else _.value=te.fonts}else _.value=[...q]}catch(te){console.error("åŠ è½½å­—ä½“åˆ—è¡¨å¤±è´¥:",te),_.value=[...q]}}function ie(){r.value=!r.value}function z(te){const b=parseInt(te.target.value);isNaN(b)||(i.updateTextStyle({fontSize:b}),s("textStyleChanged","fontSize",b))}function R(te){const b=te.target.checked;i.updateTextStyle({autoFontSize:b}),console.log(`è‡ªåŠ¨å­—å·è®¾ç½®å˜æ›´: ${b}`),s("autoFontSizeChanged",b)}async function I(te){const b=te.target,J=b.files?.[0];if(!J)return;const ve=[".ttf",".ttc",".otf"],fe=J.name.toLowerCase();if(!ve.some(ne=>fe.endsWith(ne))){xe("è¯·é€‰æ‹© .ttfã€.ttc æˆ– .otf æ ¼å¼çš„å­—ä½“æ–‡ä»¶","error"),b.value="";return}try{const ne=await Rs(J);ne.success&&ne.fontPath?(await X(),i.updateTextStyle({fontFamily:ne.fontPath}),xe("å­—ä½“ä¸Šä¼ æˆåŠŸ","success")):xe(ne.error||"å­—ä½“ä¸Šä¼ å¤±è´¥","error")}catch(ne){console.error("å­—ä½“ä¸Šä¼ å¤±è´¥:",ne),xe("å­—ä½“ä¸Šä¼ å¤±è´¥","error")}finally{b.value=""}}function F(te){const b={"fonts/STXINGKA.TTF":"åæ–‡è¡Œæ¥·","fonts/STXINWEI.TTF":"åæ–‡æ–°é­","fonts/STZHONGS.TTF":"åæ–‡ä¸­å®‹","fonts/STKAITI.TTF":"æ¥·ä½“","fonts/STLITI.TTF":"éš¶ä¹¦","fonts/æ€æºé»‘ä½“SourceHanSansK-Bold.TTF":"æ€æºé»‘ä½“","fonts/STSONG.TTF":"åæ–‡å®‹ä½“","fonts/msyh.ttc":"å¾®è½¯é›…é»‘","fonts/msyhbd.ttc":"å¾®è½¯é›…é»‘ç²—ä½“","fonts/SIMYOU.TTF":"å¹¼åœ†","fonts/STFANGSO.TTF":"ä»¿å®‹","fonts/STHUPO.TTF":"åæ–‡ç¥ç€","fonts/STXIHEI.TTF":"åæ–‡ç»†é»‘","fonts/simkai.ttf":"ä¸­æ˜“æ¥·ä½“","fonts/simfang.ttf":"ä¸­æ˜“ä»¿å®‹","fonts/simhei.ttf":"ä¸­æ˜“é»‘ä½“","fonts/SIMLI.TTF":"ä¸­æ˜“éš¶ä¹¦","fonts/simsun.ttc":"å®‹ä½“"};if(b[te])return b[te];const J=te.split("/").pop()||te;for(const[ve,fe]of Object.entries(b))if((ve.split("/").pop()||"").toLowerCase()===J.toLowerCase())return fe;return J.replace(/\.(ttf|ttc|otf)$/i,"")}function y(te){const b=String(te);if(b==="custom-font"){V.value?.click();return}i.updateTextStyle({fontFamily:b}),s("textStyleChanged","fontFamily",b)}function m(te){const b=String(te);i.updateTextStyle({layoutDirection:b}),s("textStyleChanged","layoutDirection",b)}function l(te){const b=String(te);i.updateTextStyle({inpaintMethod:b})}function v(te){const b=te.target.value;i.updateTextStyle({textColor:b}),s("textStyleChanged","textColor",b)}function D(te){const b=te.target.checked;i.updateTextStyle({useAutoTextColor:b})}function S(te){const b=te.target.checked;i.updateTextStyle({strokeEnabled:b}),s("textStyleChanged","strokeEnabled",b)}function w(te){const b=te.target.value;i.updateTextStyle({strokeColor:b}),s("textStyleChanged","strokeColor",b)}function W(te){const b=parseInt(te.target.value);isNaN(b)||(i.updateTextStyle({strokeWidth:b}),s("textStyleChanged","strokeWidth",b))}function Z(te){const b=te.target.value;i.updateTextStyle({fillColor:b}),s("textStyleChanged","fillColor",b)}function Y(){a.value=!a.value}function c(){const b=!Object.values(u.value).every(J=>J);u.value={fontSize:b,fontFamily:b,layoutDirection:b,textColor:b,fillColor:b,strokeEnabled:b,strokeColor:b,strokeWidth:b}}function h(){s("applyToAll",{...u.value}),a.value=!1}function le(te){te.target.closest(".apply-settings-group")||(a.value=!1)}function T(){p.value=!p.value,p.value&&j.value>0&&(f.value=1,P.value=j.value)}function G(te){const b=parseInt(te.target.value);isNaN(b)||(f.value=Math.max(1,Math.min(b,j.value)),f.value>P.value&&(P.value=f.value))}function ce(te){const b=parseInt(te.target.value);isNaN(b)||(P.value=Math.max(1,Math.min(b,j.value)),P.value<f.value&&(f.value=P.value))}function _e(){k.value&&K.value?s("translateRange",f.value,P.value):s("translateAll")}function De(){k.value&&K.value?s("hqTranslateRange",f.value,P.value):s("hqTranslate")}function $e(){k.value&&K.value?s("proofreadRange",f.value,P.value):s("proofread")}function he(){k.value&&K.value?s("removeTextRange",f.value,P.value):s("removeAllText")}return typeof window<"u"&&window.addEventListener("click",le),(te,b)=>(B(),A("aside",va,[e("div",fa,[b[43]||(b[43]=e("h2",null,"ç¿»è¯‘è®¾ç½®",-1)),e("div",ba,[e("h3",{class:"collapsible-header",onClick:ie},[b[17]||(b[17]=me(" æ–‡å­—è®¾ç½® ",-1)),e("span",ha,oe(r.value?"â–¼":"â–¶"),1)]),ae(e("div",ya,[e("div",xa,[e("div",_a,[b[19]||(b[19]=e("label",{for:"fontSize"},"å­—å·å¤§å°:",-1)),e("input",{type:"number",id:"fontSize",value:x.value.fontSize,min:"10",max:"100",disabled:x.value.autoFontSize,class:Ie({"disabled-input":x.value.autoFontSize}),title:x.value.autoFontSize?"å·²å¯ç”¨è‡ªåŠ¨å­—å·ï¼Œé¦–æ¬¡ç¿»è¯‘æ—¶å°†è‡ªåŠ¨è®¡ç®—":"",onInput:z},null,42,Ca),e("span",Sa,[e("input",{type:"checkbox",id:"autoFontSize",checked:x.value.autoFontSize,onChange:R},null,40,ka),b[18]||(b[18]=e("label",{for:"autoFontSize"},"è‡ªåŠ¨è®¡ç®—åˆå§‹å­—å·",-1))])]),e("div",wa,[b[20]||(b[20]=e("label",{for:"fontFamily"},"æ–‡æœ¬å­—ä½“:",-1)),Se(We,{"model-value":x.value.fontFamily,options:se.value,onChange:y},null,8,["model-value","options"]),e("input",{ref_key:"fontUploadInput",ref:V,type:"file",id:"fontUpload",accept:".ttf,.ttc,.otf",style:{display:"none"},onChange:I},null,544)]),e("div",$a,[b[21]||(b[21]=e("label",{for:"layoutDirection"},"æ’ç‰ˆè®¾ç½®:",-1)),Se(We,{"model-value":x.value.layoutDirection,options:L,onChange:m},null,8,["model-value"])]),e("div",Ta,[b[23]||(b[23]=e("label",{for:"textColor"},"æ–‡å­—é¢œè‰²:",-1)),e("div",Ia,[e("label",Pa,[e("input",{type:"checkbox",checked:x.value.useAutoTextColor,onChange:D},null,40,Ra),b[22]||(b[22]=e("span",null,"è‡ªåŠ¨",-1))]),e("input",{type:"color",id:"textColor",value:x.value.textColor,disabled:x.value.useAutoTextColor,onInput:v},null,40,Da)]),x.value.useAutoTextColor?(B(),A("div",Ma," ğŸ’¡ ç¿»è¯‘æ—¶å°†è‡ªåŠ¨ä½¿ç”¨è¯†åˆ«åˆ°çš„æ–‡å­—é¢œè‰² ")):de("",!0)]),e("div",Ea,[e("span",Ba,[e("input",{type:"checkbox",id:"strokeEnabled",checked:x.value.strokeEnabled,onChange:S},null,40,Aa),b[24]||(b[24]=e("label",{for:"strokeEnabled"},"å¯ç”¨æ–‡æœ¬æè¾¹:",-1))])]),Se(ln,{name:"stroke-slide"},{default:St(()=>[x.value.strokeEnabled?(B(),A("div",La,[e("div",Fa,[b[25]||(b[25]=e("label",{for:"strokeColor"},"æè¾¹é¢œè‰²:",-1)),e("input",{type:"color",id:"strokeColor",value:x.value.strokeColor,onInput:w},null,40,Ua)]),e("div",Oa,[b[26]||(b[26]=e("label",{for:"strokeWidth"},"æè¾¹å®½åº¦ (px):",-1)),e("input",{type:"number",id:"strokeWidth",value:x.value.strokeWidth,min:"0",max:"10",style:{width:"60px",padding:"5px"},onInput:W},null,40,za),b[27]||(b[27]=e("div",{class:"input-hint"},"0 è¡¨ç¤ºæ— æè¾¹ã€‚",-1))])])):de("",!0)]),_:1}),e("div",Na,[b[28]||(b[28]=e("label",{for:"useInpainting"},"æ°”æ³¡å¡«å……æ–¹å¼:",-1)),Se(We,{"model-value":x.value.inpaintMethod,options:M,onChange:l},null,8,["model-value"])]),Se(ln,{name:"slide-fade"},{default:St(()=>[x.value.inpaintMethod==="solid"?(B(),A("div",Va,[b[29]||(b[29]=e("label",{for:"fillColor"},"å¡«å……é¢œè‰²:",-1)),e("input",{type:"color",id:"fillColor",value:x.value.fillColor,onInput:Z},null,40,Wa)])):de("",!0)]),_:1})]),e("div",Ka,[e("button",{type:"button",class:"settings-button",disabled:!$.value,onClick:h}," åº”ç”¨åˆ°å…¨éƒ¨ ",8,qa),e("button",{type:"button",class:"settings-gear-btn",title:"é€‰æ‹©è¦åº”ç”¨çš„å‚æ•°",onClick:Y}," âš™ï¸ "),a.value?(B(),A("div",Ha,[e("div",ja,[e("input",{type:"checkbox",id:"apply_selectAll",checked:Object.values(u.value).every(J=>J),onChange:c},null,40,Ja),b[30]||(b[30]=e("label",{for:"apply_selectAll"},"å…¨é€‰",-1))]),b[39]||(b[39]=e("hr",null,null,-1)),e("div",Ya,[ae(e("input",{type:"checkbox",id:"apply_fontSize","onUpdate:modelValue":b[0]||(b[0]=J=>u.value.fontSize=J)},null,512),[[nt,u.value.fontSize]]),b[31]||(b[31]=e("label",{for:"apply_fontSize"},"å­—å·",-1))]),e("div",Xa,[ae(e("input",{type:"checkbox",id:"apply_fontFamily","onUpdate:modelValue":b[1]||(b[1]=J=>u.value.fontFamily=J)},null,512),[[nt,u.value.fontFamily]]),b[32]||(b[32]=e("label",{for:"apply_fontFamily"},"å­—ä½“",-1))]),e("div",Ga,[ae(e("input",{type:"checkbox",id:"apply_layoutDirection","onUpdate:modelValue":b[2]||(b[2]=J=>u.value.layoutDirection=J)},null,512),[[nt,u.value.layoutDirection]]),b[33]||(b[33]=e("label",{for:"apply_layoutDirection"},"æ’ç‰ˆæ–¹å‘",-1))]),e("div",Za,[ae(e("input",{type:"checkbox",id:"apply_textColor","onUpdate:modelValue":b[3]||(b[3]=J=>u.value.textColor=J)},null,512),[[nt,u.value.textColor]]),b[34]||(b[34]=e("label",{for:"apply_textColor"},"æ–‡å­—é¢œè‰²",-1))]),e("div",Qa,[ae(e("input",{type:"checkbox",id:"apply_fillColor","onUpdate:modelValue":b[4]||(b[4]=J=>u.value.fillColor=J)},null,512),[[nt,u.value.fillColor]]),b[35]||(b[35]=e("label",{for:"apply_fillColor"},"å¡«å……é¢œè‰²",-1))]),e("div",el,[ae(e("input",{type:"checkbox",id:"apply_strokeEnabled","onUpdate:modelValue":b[5]||(b[5]=J=>u.value.strokeEnabled=J)},null,512),[[nt,u.value.strokeEnabled]]),b[36]||(b[36]=e("label",{for:"apply_strokeEnabled"},"æè¾¹å¼€å…³",-1))]),e("div",tl,[ae(e("input",{type:"checkbox",id:"apply_strokeColor","onUpdate:modelValue":b[6]||(b[6]=J=>u.value.strokeColor=J)},null,512),[[nt,u.value.strokeColor]]),b[37]||(b[37]=e("label",{for:"apply_strokeColor"},"æè¾¹é¢œè‰²",-1))]),e("div",ol,[ae(e("input",{type:"checkbox",id:"apply_strokeWidth","onUpdate:modelValue":b[7]||(b[7]=J=>u.value.strokeWidth=J)},null,512),[[nt,u.value.strokeWidth]]),b[38]||(b[38]=e("label",{for:"apply_strokeWidth"},"æè¾¹å®½åº¦",-1))])])):de("",!0)])],512),[[Ue,r.value]])]),e("div",nl,[e("h3",{class:"collapsible-header",onClick:T},[b[40]||(b[40]=me(" æŒ‡å®šèŒƒå›´ ",-1)),e("span",sl,oe(p.value?"â–¼":"â–¶"),1)]),ae(e("div",al,[e("div",ll,[e("div",il,[e("label",rl,[ae(e("input",{type:"checkbox","onUpdate:modelValue":b[8]||(b[8]=J=>k.value=J),disabled:j.value===0},null,8,ul),[[nt,k.value]]),b[41]||(b[41]=e("span",null,"å¯ç”¨",-1))]),e("span",cl,"å…± "+oe(j.value)+" å¼ ",1)]),ae(e("div",dl,[e("input",{type:"number",id:"pageRangeStart",value:f.value,min:"1",max:j.value,onInput:G,placeholder:"èµ·å§‹"},null,40,gl),b[42]||(b[42]=e("span",{class:"range-sep"},"~",-1)),e("input",{type:"number",id:"pageRangeEnd",value:P.value,min:"1",max:j.value,onInput:ce,placeholder:"ç»“æŸ"},null,40,pl)],512),[[Ue,k.value]]),k.value&&!K.value&&j.value>0?(B(),A("div",ml," èŒƒå›´æ— æ•ˆ ")):de("",!0)])],512),[[Ue,p.value]])]),e("div",vl,[e("button",{id:"translateButton",disabled:!U.value,onClick:b[9]||(b[9]=J=>s("translateCurrent"))}," ç¿»è¯‘å½“å‰å›¾ç‰‡ ",8,fl),e("button",{id:"translateAllButton",disabled:!U.value||k.value&&!K.value,title:k.value?`ç¿»è¯‘ç¬¬ ${f.value}-${P.value} é¡µ`:"ç¿»è¯‘æ‰€æœ‰å›¾ç‰‡",onClick:_e},oe(k.value?`ç¿»è¯‘ ${f.value}-${P.value} é¡µ`:"ç¿»è¯‘æ‰€æœ‰å›¾ç‰‡"),9,bl),e("button",{id:"startHqTranslationBtn",class:"settings-button purple-button",disabled:!U.value||k.value&&!K.value,title:k.value?`é«˜è´¨é‡ç¿»è¯‘ç¬¬ ${f.value}-${P.value} é¡µ`:"ä½¿ç”¨é«˜è´¨é‡ç¿»è¯‘æ¨¡å¼ï¼ˆéœ€åœ¨è®¾ç½®ä¸­é…ç½®ï¼‰",onClick:De},oe(k.value?`é«˜è´¨é‡ç¿»è¯‘ ${f.value}-${P.value}`:"é«˜è´¨é‡ç¿»è¯‘"),9,hl),e("button",{id:"proofreadButton",disabled:!U.value||k.value&&!K.value,title:k.value?`AIæ ¡å¯¹ç¬¬ ${f.value}-${P.value} é¡µ`:"AIæ ¡å¯¹",onClick:$e},oe(k.value?`AIæ ¡å¯¹ ${f.value}-${P.value}`:"AIæ ¡å¯¹"),9,yl),e("button",{id:"removeTextOnlyButton",disabled:!E.value,title:"æ¶ˆé™¤å›¾ç‰‡ä¸­çš„æ°”æ³¡æ–‡å­—ï¼Œæ— éœ€å¡«å†™ç¿»è¯‘æœåŠ¡å•†å’ŒAPI Key",onClick:b[10]||(b[10]=J=>s("removeText"))}," ä»…æ¶ˆé™¤æ–‡å­— ",8,xl),e("button",{id:"removeAllTextButton",disabled:!$.value||k.value&&!K.value,title:k.value?`æ¶ˆé™¤ç¬¬ ${f.value}-${P.value} é¡µçš„æ–‡å­—`:"æ¶ˆé™¤æ‰€æœ‰å›¾ç‰‡ä¸­çš„æ°”æ³¡æ–‡å­—",onClick:he},oe(k.value?`æ¶ˆé™¤ ${f.value}-${P.value} é¡µæ–‡å­—`:"æ¶ˆé™¤æ‰€æœ‰å›¾ç‰‡æ–‡å­—"),9,_l),e("button",{id:"deleteCurrentImageButton",class:"settings-button red-button",disabled:!E.value,onClick:b[11]||(b[11]=J=>s("deleteCurrent"))}," åˆ é™¤å½“å‰å›¾ç‰‡ ",8,Cl),e("button",{id:"clearAllImagesButton",class:"settings-button red-button",disabled:!$.value,onClick:b[12]||(b[12]=J=>s("clearAll"))}," æ¸…é™¤æ‰€æœ‰å›¾ç‰‡ ",8,Sl),e("button",{id:"cleanDebugFilesButton",class:"settings-button orange-button",onClick:b[13]||(b[13]=J=>s("cleanTemp"))}," æ¸…ç†ä¸´æ—¶æ–‡ä»¶ "),e("button",{id:"managePluginsButton",class:"settings-button blue-button",onClick:b[14]||(b[14]=J=>s("openPlugins"))}," æ’ä»¶ç®¡ç† ")]),e("div",kl,[e("button",{id:"prevImageButton",disabled:!g.value,onClick:b[15]||(b[15]=J=>s("previous"))}," ä¸Šä¸€å¼  ",8,wl),e("button",{id:"nextImageButton",disabled:!d.value,onClick:b[16]||(b[16]=J=>s("next"))}," ä¸‹ä¸€å¼  ",8,$l)])])]))}}),Il=He(Tl,[["__scopeId","data-v-418fd3c5"]]);function Lt(n){if(n.textDirection==="vertical"||n.textDirection==="horizontal")return n.textDirection;if(n.autoTextDirection==="vertical"||n.autoTextDirection==="horizontal")return n.autoTextDirection;if(n.coords){const[t,s,o,i]=n.coords;return i-s>o-t?"vertical":"horizontal"}return"vertical"}function Pl(){const n=et(),t=ze(),s=ct(),o=C(!1),i=C(0),r=C(""),a=C(!1),u=C(0),p=C(""),k=Q(()=>n.hasImages),f=Q(()=>n.hasImages),P=Q(()=>n.hasImages);function L(){const g=n.images;if(g.length===0){s.warning("æ²¡æœ‰å¯å¯¼å‡ºçš„å›¾ç‰‡æ–‡æœ¬");return}const d=[];for(let ie=0;ie<g.length;ie++){const z=g[ie];if(!z)continue;const R=z.bubbleStates||[],I={imageIndex:ie,bubbles:[]};for(let F=0;F<R.length;F++){const y=R[F];if(!y)continue;const m=y.originalText||"",l=y.translatedText||y.textboxText||"";let v="vertical";y.textDirection&&y.textDirection!=="auto"?v=y.textDirection:y.autoTextDirection&&(v=y.autoTextDirection),I.bubbles.push({bubbleIndex:F,original:m,translated:l,textDirection:v})}d.push(I)}const x=JSON.stringify(d,null,2),_=new Blob([x],{type:"application/json"}),q=URL.createObjectURL(_),V=document.createElement("a");V.href=q;const X=new Date().toISOString().replace(/[-:T]/g,"").slice(0,15);V.download=`translations_${X}.json`,document.body.appendChild(V),V.click(),document.body.removeChild(V),URL.revokeObjectURL(q),s.success("æ–‡æœ¬å¯¼å‡ºæˆåŠŸï¼")}function M(){const g=n.images;if(g.length===0)return null;const d=[];for(let x=0;x<g.length;x++){const _=g[x];if(!_)continue;const q=_.bubbleStates||[],V={imageIndex:x,bubbles:[]};for(let se=0;se<q.length;se++){const X=q[se];if(!X)continue;const ie=X.originalText||"",z=X.translatedText||X.textboxText||"";let R="vertical";X.textDirection&&X.textDirection!=="auto"?R=X.textDirection:X.autoTextDirection&&(R=X.autoTextDirection),V.bubbles.push({bubbleIndex:se,original:ie,translated:z,textDirection:R})}d.push(V)}return d}async function E(g){if(!g){s.warning("æœªé€‰æ‹©æ–‡ä»¶");return}a.value=!0,u.value=0,p.value="å‡†å¤‡å¯¼å…¥æ–‡æœ¬...",s.info("æ­£åœ¨å¯¼å…¥æ–‡æœ¬...",0);try{const d=await $(g);u.value=10,p.value="è§£æ JSON æ•°æ®...";const x=JSON.parse(d);if(!Array.isArray(x))throw new Error("å¯¼å…¥çš„ JSON æ ¼å¼ä¸æ­£ç¡®ï¼Œåº”ä¸ºæ•°ç»„");let _=0,q=0;const V=t.settings.textStyle,se=V.autoFontSize?"auto":V.fontSize,X=V.fontFamily,ie=V.textColor,z=V.fillColor;u.value=20,p.value="å¼€å§‹æ›´æ–°å›¾ç‰‡...";const R=x.length;let I=0;const F=[];for(const l of x){I++;const v=20+I/R*60;u.value=v,p.value=`å¤„ç†å›¾ç‰‡ ${I}/${R}`;const D=l.imageIndex;if(D<0||D>=n.images.length){console.warn(`è·³è¿‡æ— æ•ˆçš„å›¾ç‰‡ç´¢å¼•: ${D}`);continue}const S=n.images[D];if(!S)continue;let w=!1;S.bubbleStates||(S.bubbleStates=[]),S.bubbleTexts||(S.bubbleTexts=[]),S.originalTexts||(S.originalTexts=[]);for(const W of l.bubbles){const Z=W.bubbleIndex,Y=W.original,c=W.translated,h=W.textDirection,le=h==="vertical"||h==="horizontal"?h:"vertical";for(;S.bubbleTexts.length<=Z;)S.bubbleTexts.push("");for(;S.originalTexts.length<=Z;)S.originalTexts.push("");for(Y&&(S.originalTexts[Z]=Y),c&&(S.bubbleTexts[Z]=c);S.bubbleStates.length<=Z;)S.bubbleStates.push(j(se,X,ie,z));const T=S.bubbleStates[Z];T&&(Y&&(T.originalText=Y),c&&(T.translatedText=c,T.textboxText=c),T.textDirection=le,w=!0,q++)}w&&S.bubbleStates&&(S.bubbleTexts=S.bubbleStates.map(W=>W.translatedText||"")),w&&(_++,S.hasUnsavedChanges=!0,S.translatedDataURL&&S.bubbleStates&&S.bubbleStates.length>0&&F.push(D))}if(F.length>0){u.value=80,p.value="å¼€å§‹æ¸²æŸ“å›¾ç‰‡...",s.info("æ­£åœ¨æ¸²æŸ“å›¾ç‰‡ï¼Œè¯·ç¨å€™...",0);const l=t.settings.textStyle,v=l.layoutDirection,D=v==="auto";for(let S=0;S<F.length;S++){const w=F[S];if(w===void 0)continue;const W=n.images[w];if(!(!W||!W.bubbleStates)){u.value=80+S/F.length*20,p.value=`æ¸²æŸ“å›¾ç‰‡ ${S+1}/${F.length}`;try{let Z="";if(W.cleanImageData?Z=W.cleanImageData.includes("base64,")?W.cleanImageData.split("base64,")[1]||"":W.cleanImageData:W.originalDataURL&&(Z=W.originalDataURL.includes("base64,")?W.originalDataURL.split("base64,")[1]||"":W.originalDataURL,console.log(`importText: å›¾ç‰‡ ${w} ä½¿ç”¨åŸå›¾ä½œä¸ºèƒŒæ™¯ï¼ˆå…œåº•ï¼‰`)),!Z){console.log(`importText: å›¾ç‰‡ ${w} æ²¡æœ‰å¯ç”¨çš„èƒŒæ™¯å›¾ï¼Œè·³è¿‡`);continue}const Y=W.bubbleStates.map(h=>({translatedText:h.translatedText||"",coords:h.coords,fontSize:h.fontSize||l.fontSize,fontFamily:h.fontFamily||l.fontFamily,textDirection:Lt(h),textColor:h.textColor||l.textColor,rotationAngle:h.rotationAngle||0,position:h.position||{x:0,y:0},strokeEnabled:h.strokeEnabled??l.strokeEnabled,strokeColor:h.strokeColor||l.strokeColor,strokeWidth:h.strokeWidth??l.strokeWidth})),c=await yo({clean_image:Z,bubble_texts:Y.map(h=>h.translatedText),bubble_coords:Y.map(h=>h.coords),fontSize:l.fontSize,fontFamily:l.fontFamily,textDirection:D?"vertical":v,textColor:l.textColor,bubble_states:Y,use_individual_styles:!0,use_inpainting:!1,use_lama:!1,is_font_style_change:!0,strokeEnabled:l.strokeEnabled,strokeColor:l.strokeColor,strokeWidth:l.strokeWidth});c.rendered_image&&(n.updateImageByIndex(w,{translatedDataURL:`data:image/png;base64,${c.rendered_image}`,hasUnsavedChanges:!0}),console.log(`importText: å›¾ç‰‡ ${w} æ¸²æŸ“æˆåŠŸ`))}catch(Z){console.error(`importText: é‡æ¸²æŸ“å›¾ç‰‡ ${w} å¤±è´¥:`,Z)}}}}u.value=100,p.value="å¯¼å…¥å®Œæˆ";const y=F.length,m=y>0?`å¯¼å…¥æˆåŠŸï¼æ›´æ–°äº† ${_} å¼ å›¾ç‰‡ä¸­çš„ ${q} ä¸ªæ°”æ³¡æ–‡æœ¬ï¼Œé‡æ¸²æŸ“äº† ${y} å¼ å›¾ç‰‡`:`å¯¼å…¥æˆåŠŸï¼æ›´æ–°äº† ${_} å¼ å›¾ç‰‡ä¸­çš„ ${q} ä¸ªæ°”æ³¡æ–‡æœ¬`;s.success(m)}catch(d){console.error("å¯¼å…¥æ–‡æœ¬å‡ºé”™:",d),s.error(`å¯¼å…¥å¤±è´¥: ${d instanceof Error?d.message:String(d)}`)}finally{a.value=!1,setTimeout(()=>{u.value=0,p.value=""},2e3)}}function $(g){return new Promise((d,x)=>{const _=new FileReader;_.onload=q=>{q.target?.result?d(q.target.result):x(new Error("è¯»å–æ–‡ä»¶å¤±è´¥"))},_.onerror=()=>x(new Error("è¯»å–æ–‡ä»¶æ—¶å‡ºé”™")),_.readAsText(g)})}function j(g,d,x,_){const q=t.settings.textStyle;return{coords:[0,0,100,100],polygon:[],originalText:"",translatedText:"",textboxText:"",fontSize:typeof g=="number"?g:25,fontFamily:d,textDirection:"vertical",autoTextDirection:"vertical",textColor:x,fillColor:_,rotationAngle:0,position:{x:0,y:0},strokeEnabled:q.strokeEnabled,strokeColor:q.strokeColor,strokeWidth:q.strokeWidth,inpaintMethod:q.inpaintMethod}}function K(){const g=n.currentImage;if(!g){s.warning("æ²¡æœ‰å¯ä¸‹è½½çš„å›¾ç‰‡");return}const d=g.translatedDataURL||g.originalDataURL;if(!d){s.warning("æ²¡æœ‰å¯ä¸‹è½½çš„å›¾ç‰‡");return}o.value=!0;try{const x=d.split(",")[1];if(!x)throw new Error("æ— æ•ˆçš„å›¾ç‰‡æ•°æ®");const _=atob(x),q=[];for(let R=0;R<_.length;R+=512){const I=_.slice(R,R+512),F=new Array(I.length);for(let m=0;m<I.length;m++)F[m]=I.charCodeAt(m);const y=new Uint8Array(F);q.push(y.buffer)}const V=new Blob(q,{type:"image/png"}),se=URL.createObjectURL(V),X=document.createElement("a");X.href=se;let ie=g.fileName||`image_${n.currentImageIndex}.png`;ie=`${g.translatedDataURL?"translated":"original"}_${ie.replace(/\.[^/.]+$/,"")}.png`,X.download=ie,document.body.appendChild(X),X.click(),document.body.removeChild(X),URL.revokeObjectURL(se),s.success(`ä¸‹è½½æˆåŠŸ: ${ie}`)}catch(x){console.error("ä¸‹è½½å›¾ç‰‡æ—¶å‡ºé”™:",x),s.error("ä¸‹è½½å¤±è´¥")}finally{o.value=!1}}async function U(g="zip"){const d=n.images;if(d.length===0){s.warning("æ²¡æœ‰å¯ä¸‹è½½çš„å›¾ç‰‡");return}o.value=!0,i.value=0,r.value="å‡†å¤‡ä¸‹è½½...",s.info("ä¸‹è½½ä¸­...å¤„ç†å¯èƒ½éœ€è¦ä¸€å®šæ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…...",0);try{const x=[];let _=0,q=0;i.value=5,r.value="æ£€æŸ¥å›¾ç‰‡æ•°æ®...";for(let m=0;m<d.length;m++){const l=d[m];l&&(l.translatedDataURL?(x.push({index:m,type:"translated"}),_++):l.originalDataURL&&(x.push({index:m,type:"original"}),q++))}if(x.length===0){s.warning("æ²¡æœ‰å¯ä¸‹è½½çš„å›¾ç‰‡");return}i.value=10,r.value="åˆ›å»ºä¸‹è½½ä¼šè¯...";const V=await $s(x.length);if(!V.success||!V.session_id)throw new Error(V.error||"åˆ›å»ºä¼šè¯å¤±è´¥");const se=V.session_id,X=x.length;let ie=0,z=0;for(let m=0;m<x.length;m++){const l=x[m];if(!l)continue;const v=d[l.index];if(!v)continue;const D=l.type==="translated"?v.translatedDataURL:v.originalDataURL;if(!D)continue;const S=10+m/X*70;i.value=S,r.value=`ä¸Šä¼ å›¾ç‰‡ ${m+1}/${X}...`;try{const w=await Ts(se,D,m);w.success?ie++:(console.error(`ä¸Šä¼ å›¾ç‰‡ ${m} å¤±è´¥:`,w.error),z++)}catch(w){console.error(`ä¸Šä¼ å›¾ç‰‡ ${m} å‡ºé”™:`,w),z++}}if(ie===0)throw new Error("æ‰€æœ‰å›¾ç‰‡ä¸Šä¼ å¤±è´¥");i.value=85,r.value="æ‰“åŒ…æ–‡ä»¶...";const R=await Is(se,g);if(!R.success||!R.file_id)throw new Error(R.error||"æ‰“åŒ…å¤±è´¥");i.value=95,r.value="å‡†å¤‡ä¸‹è½½...";const I=Ps(R.file_id,g),F=document.createElement("a");F.href=I,document.body.appendChild(F),F.click(),document.body.removeChild(F),i.value=100,r.value="ä¸‹è½½å·²å¼€å§‹";let y=`å·²æˆåŠŸå¤„ç† ${ie} å¼ å›¾ç‰‡`;z>0&&(y+=`ï¼ˆ${z} å¼ å¤±è´¥ï¼‰`),_>0&&q>0?y+=`ï¼ˆ${_} å¼ ç¿»è¯‘å›¾ç‰‡å’Œ ${q} å¼ åŸå§‹å›¾ç‰‡ï¼‰`:_>0?y+="ï¼ˆå…¨éƒ¨ä¸ºç¿»è¯‘åå›¾ç‰‡ï¼‰":q>0&&(y+="ï¼ˆå…¨éƒ¨ä¸ºåŸå§‹å›¾ç‰‡ï¼‰"),y+="ï¼Œä¸‹è½½å³å°†å¼€å§‹",s.success(y),setTimeout(async()=>{try{const m=await ho();console.log("ä¸´æ—¶æ–‡ä»¶æ¸…ç†ç»“æœ:",m)}catch(m){console.error("æ¸…ç†ä¸´æ—¶æ–‡ä»¶å¤±è´¥:",m)}},6e4)}catch(x){console.error("ä¸‹è½½æ‰€æœ‰å›¾ç‰‡æ—¶å‡ºé”™:",x),s.error(`ä¸‹è½½å¤±è´¥: ${x instanceof Error?x.message:String(x)}`)}finally{o.value=!1,setTimeout(()=>{i.value=0,r.value=""},2e3)}}return{isDownloading:o,downloadProgress:i,downloadProgressText:r,isImporting:a,importProgress:u,importProgressText:p,canExportText:k,canImportText:f,canDownload:P,exportText:L,exportTextToJson:M,importText:E,downloadCurrentImage:K,downloadAllImages:U}}const Rl={key:0,class:"result-section card result-card"},Dl={class:"image-controls"},Ml={class:"image-size-control"},El=["value"],Bl={id:"imageSizeValue"},Al={class:"content-container"},Ll={class:"image-container"},Fl=["src"],Ul={id:"detectedTextInfo",class:"text-info"},Ol={id:"detectedTextList"},zl={class:"original-text"},Nl={class:"download-section"},Vl={class:"download-buttons"},Wl=["disabled"],Kl={class:"download-all-container"},ql=["disabled"],Hl={class:"download-format-selector"},jl=["disabled"],Jl=["disabled"],Yl={key:1,class:"empty-state-section"},uo=60,Xl=je({__name:"ImageResultDisplay",props:{isEditMode:{type:Boolean,default:!1}},emits:["toggle-edit-mode","retry-failed"],setup(n,{emit:t}){const s=[{label:"ZIPå‹ç¼©åŒ…",value:"zip"},{label:"PDFæ–‡æ¡£",value:"pdf"},{label:"CBZæ¼«ç”»",value:"cbz"}],o=t,i=et(),r=ze(),a=Pl(),u=C(100),p=Q({get:()=>$.value?.showOriginal??!1,set:S=>{$.value&&i.updateCurrentImage({showOriginal:S})}}),k=C("zip"),f=C(null),P=Q(()=>a.isDownloading.value),L=Q(()=>a.downloadProgressText.value),M=Q(()=>a.downloadProgress.value),E=Q(()=>i.hasImages),$=Q(()=>i.currentImage),j=Q(()=>!!$.value?.translatedDataURL),K=Q(()=>!!($.value?.translatedDataURL||$.value?.originalDataURL)),U=Q(()=>$.value?p.value||!$.value.translatedDataURL?$.value.originalDataURL:$.value.translatedDataURL:""),g=Q(()=>i.failedImageCount>0),d=Q(()=>({width:`${u.value}%`})),x=Q(()=>r.settings.useTextboxPrompt),_=Q(()=>{if(!$.value)return[];if($.value.bubbleStates&&$.value.bubbleStates.length>0)return $.value.bubbleStates.map(W=>({original:W.originalText||"",translated:x.value?W.textboxText||W.translatedText||"":W.translatedText||""}));const S=$.value.originalTexts||[],w=x.value?$.value.textboxTexts||$.value.bubbleTexts||[]:$.value.bubbleTexts||[];return S.length===0?[]:S.map((W,Z)=>({original:W||"",translated:w[Z]||""}))}),q=Q(()=>_.value.length>0);function V(S){if(!S||S.length<=uo)return S;let w="",W="";for(let Z=0;Z<S.length;Z++)if(W+=S[Z],W.length>=uo){let Y=-1;for(let c=W.length-1;c>=0;c--){const h=W[c];if(h&&["ã€‚","ï¼","ï¼Ÿ",".","!","?","ï¼›",";","ï¼Œ",","].includes(h)){Y=c+1;break}}Y>uo*.6?(w+=W.substring(0,Y)+`
`,W=W.substring(Y)):(w+=W+`
`,W="")}return W&&(w+=W),w}function se(S){return V((S||"").trim())}function X(S){const w=(S||"").trim();return V(w)}function ie(S){return(S||"").includes("ç¿»è¯‘å¤±è´¥")}function z(){p.value=!p.value}function R(){o("toggle-edit-mode")}function I(S){const w=S.target;u.value=parseInt(w.value,10)}function F(){o("retry-failed")}function y(){a.downloadCurrentImage()}function m(){a.downloadAllImages(k.value)}function l(){a.exportText()}function v(){f.value?.click()}async function D(S){const w=S.target,W=w.files?.[0];W&&(await a.importText(W),w.value="")}return(S,w)=>$.value?(B(),A("section",Rl,[e("div",Dl,[j.value?(B(),A("button",{key:0,id:"toggleImageButton",class:"control-btn",onClick:z},oe(p.value?"æŸ¥çœ‹ç¿»è¯‘å›¾":"æŸ¥çœ‹åŸå›¾"),1)):de("",!0),e("button",{id:"toggleEditModeButton",class:Ie(["control-btn",{active:n.isEditMode}]),onClick:R},oe(n.isEditMode?"é€€å‡ºç¼–è¾‘":"åˆ‡æ¢ç¼–è¾‘æ¨¡å¼"),3),e("div",Ml,[w[1]||(w[1]=e("label",{for:"imageSize"},"å›¾ç‰‡å¤§å°:",-1)),e("input",{type:"range",id:"imageSize",min:"50",max:"200",value:u.value,class:"slider range-slider",onInput:I},null,40,El),e("span",Bl,oe(u.value)+"%",1)]),g.value?(B(),A("button",{key:1,id:"retranslateFailedButton",class:"retry-failed-btn",onClick:F,title:"é‡æ–°ç¿»è¯‘æ‰€æœ‰å¤±è´¥çš„å›¾ç‰‡"}," é‡æ–°ç¿»è¯‘å¤±è´¥å›¾ç‰‡ ("+oe(H(i).failedImageCount)+") ",1)):de("",!0)]),e("div",Al,[e("div",Ll,[e("img",{id:"translatedImageDisplay",src:U.value,alt:"ç¿»è¯‘åå›¾ç‰‡",style:at(d.value)},null,12,Fl)])]),e("div",Ul,[w[6]||(w[6]=e("h3",null,"æ£€æµ‹åˆ°çš„æ–‡æœ¬ï¼ˆåŸæ–‡ â†’ è¯‘æ–‡ï¼‰",-1)),e("pre",Ol,[q.value?(B(!0),A(Oe,{key:0},Ye(_.value,(W,Z)=>(B(),A("span",{key:Z,class:"text-item"},[e("span",zl,oe(se(W.original)),1),w[2]||(w[2]=me(`
`,-1)),e("span",{class:Ie(["translated-text",{"translation-error":ie(W.translated)}])},oe(X(W.translated)),3),w[3]||(w[3]=me(`
`,-1)),w[4]||(w[4]=e("span",{class:"separator"},"â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€",-1)),w[5]||(w[5]=me(`

`,-1))]))),128)):(B(),A(Oe,{key:1},[me("æœªæ£€æµ‹åˆ°æ–‡æœ¬æˆ–å°šæœªç¿»è¯‘")],64))])]),e("div",Nl,[P.value?(B(),ut(Co,{key:0,visible:!0,percentage:M.value,label:L.value||"ä¸‹è½½ä¸­ï¼Œè¯·ç¨å€™..."},null,8,["percentage","label"])):de("",!0),e("div",Vl,[e("button",{id:"downloadButton",class:"download-btn primary",disabled:!K.value,onClick:y}," ä¸‹è½½å½“å‰å›¾ç‰‡ ",8,Wl),e("div",Kl,[e("button",{id:"downloadAllImagesButton",class:"download-btn primary",disabled:!E.value,onClick:m}," ä¸‹è½½æ‰€æœ‰å›¾ç‰‡ ",8,ql),e("div",Hl,[Se(We,{modelValue:k.value,"onUpdate:modelValue":w[0]||(w[0]=W=>k.value=W),options:s},null,8,["modelValue"])])]),e("button",{id:"exportTextButton",class:"download-btn success",disabled:!E.value,onClick:l}," å¯¼å‡ºæ–‡æœ¬ ",8,jl),e("button",{id:"importTextButton",class:"download-btn success",disabled:!E.value,onClick:v}," å¯¼å…¥æ–‡æœ¬ ",8,Jl),e("input",{type:"file",ref_key:"importFileInput",ref:f,id:"importTextFileInput",style:{display:"none"},accept:".json",onChange:D},null,544)])])])):(B(),A("section",Yl))}}),Gl=He(Xl,[["__scopeId","data-v-a26b9c58"]]),Zl={class:"guide-content"},Ql={class:"guide-footer"},ei={class:"dont-show-option"},Vt="saber_translator_dismiss_setup_reminder",ti=je({__name:"FirstTimeGuide",emits:["openSettings"],setup(n,{expose:t,emit:s}){const o=s,i=C(!1),r=C(!1);dt(()=>{localStorage.getItem(Vt)!=="true"&&(i.value=!0)});function a(){r.value&&localStorage.setItem(Vt,"true"),i.value=!1}function u(){localStorage.setItem(Vt,"true"),i.value=!1,o("openSettings")}function p(){localStorage.removeItem(Vt)}return t({resetGuideState:p,showGuide:i}),(k,f)=>(B(),ut(Tn,{"model-value":i.value,title:"æ¬¢è¿ä½¿ç”¨ Saber-Translator",onClose:a},{default:St(()=>[e("div",Zl,[f[3]||(f[3]=e("div",{class:"guide-icon"},"ğŸ‰",-1)),f[4]||(f[4]=e("div",{class:"guide-message"},[e("p",{class:"guide-title"},"é¦–æ¬¡ä½¿ç”¨æé†’"),e("p",{class:"guide-text"}," åœ¨å¼€å§‹ç¿»è¯‘ä¹‹å‰ï¼Œè¯·å…ˆé…ç½®ç¿»è¯‘æœåŠ¡ã€‚ "),e("p",{class:"guide-text"},[me(" ç‚¹å‡»å³ä¸Šè§’çš„ "),e("span",{class:"highlight"},"âš™ï¸ è®¾ç½®"),me(" æŒ‰é’®ï¼Œé…ç½®ä»¥ä¸‹å†…å®¹ï¼š ")]),e("ul",{class:"guide-list"},[e("li",null,"é€‰æ‹© OCR å¼•æ“ï¼ˆæ–‡å­—è¯†åˆ«ï¼‰"),e("li",null,"é…ç½®ç¿»è¯‘æœåŠ¡å•†å’Œ API Key"),e("li",null,"ï¼ˆå¯é€‰ï¼‰é…ç½®é«˜è´¨é‡ç¿»è¯‘å’Œ AI æ ¡å¯¹")])],-1)),e("div",{class:"guide-actions"},[e("button",{class:"guide-btn primary",onClick:u},[...f[1]||(f[1]=[e("span",{class:"btn-icon"},"âš™ï¸",-1),me(" ç«‹å³é…ç½® ",-1)])]),e("button",{class:"guide-btn secondary",onClick:a}," ç¨åé…ç½® ")]),e("div",Ql,[e("label",ei,[ae(e("input",{type:"checkbox","onUpdate:modelValue":f[0]||(f[0]=P=>r.value=P)},null,512),[[nt,r.value]]),f[2]||(f[2]=e("span",null,"ä¸å†æ˜¾ç¤ºæ­¤æé†’",-1))])])])]),_:1},8,["model-value"]))}}),oi=He(ti,[["__scopeId","data-v-eda18e4a"]]),co="saber_translator_dismiss_setup_reminder",ni=["siliconflow","deepseek","volcano","caiyun","baidu_translate","youdao_translate","gemini","custom_openai"],si={manga_ocr:"MangaOCR",paddle_ocr:"PaddleOCR",baidu_ocr:"ç™¾åº¦OCR",ai_vision:"AIè§†è§‰OCR"},ai=["ollama","sakura"],li=["custom_openai"],ii=["custom_openai"],ri={siliconflow:"SiliconFlow",deepseek:"DeepSeek",volcano:"ç«å±±å¼•æ“",caiyun:"å½©äº‘å°è¯‘",baidu_translate:"ç™¾åº¦ç¿»è¯‘",youdao_translate:"æœ‰é“ç¿»è¯‘",gemini:"Google Gemini",custom_openai:"è‡ªå®šä¹‰ OpenAI",ollama:"Ollama",sakura:"Sakura"};function En(){const n=ze(),t=ct(),s=C(!1),o=C(!1),i=Q(()=>{try{return localStorage.getItem(co)==="true"}catch{return!1}});function r(_){return ri[_]||_}function a(_){return ni.includes(_)}function u(_){return ai.includes(_)}function p(_){return li.includes(_)}function k(_){return ii.includes(_)}function f(_){return si[_]||_}function P(){const _=n.settings,q=_.ocrEngine,V=_.baiduOcr,se=_.aiVisionOcr,X=[];return q?(q==="baidu_ocr"&&((!V?.apiKey||V.apiKey.trim()==="")&&X.push("ç™¾åº¦OCR çš„ API Key"),(!V?.secretKey||V.secretKey.trim()==="")&&X.push("ç™¾åº¦OCR çš„ Secret Key")),q==="ai_vision"&&(se?.provider||X.push("AIè§†è§‰OCR çš„æœåŠ¡å•†"),(!se?.apiKey||se.apiKey.trim()==="")&&X.push("AIè§†è§‰OCR çš„ API Key"),(!se?.modelName||se.modelName.trim()==="")&&X.push("AIè§†è§‰OCR çš„æ¨¡å‹åç§°"),se?.provider==="custom"&&(!se?.customBaseUrl||se.customBaseUrl.trim()==="")&&X.push("AIè§†è§‰OCR çš„è‡ªå®šä¹‰ Base URL")),X.length>0?{valid:!1,message:`è¯·å…ˆåœ¨é¡¶éƒ¨ âš™ï¸ è®¾ç½®èœå•ä¸­å¡«å†™ ${X[0]}`,missingItems:X}:{valid:!0,message:""}):{valid:!1,message:"è¯·å…ˆåœ¨é¡¶éƒ¨ âš™ï¸ è®¾ç½®èœå•ä¸­é€‰æ‹© OCR å¼•æ“",missingItems:["OCR å¼•æ“"]}}function L(){const{translation:_}=n.settings,{provider:q,apiKey:V,modelName:se,customBaseUrl:X}=_,ie=[];return q?(a(q)&&(!V||V.trim()==="")&&ie.push(`${r(q)} çš„ API Key`),(!se||se.trim()==="")&&(u(q)||a(q))&&ie.push(`${r(q)} çš„æ¨¡å‹åç§°`),p(q)&&(!X||X.trim()==="")&&ie.push("è‡ªå®šä¹‰ OpenAI æœåŠ¡çš„ Base URL"),ie.length>0?{valid:!1,message:`è¯·å…ˆåœ¨é¡¶éƒ¨ âš™ï¸ è®¾ç½®èœå•ä¸­å¡«å†™ ${ie[0]}`,missingItems:ie}:{valid:!0,message:""}):{valid:!1,message:"è¯·å…ˆåœ¨é¡¶éƒ¨ âš™ï¸ è®¾ç½®èœå•ä¸­é€‰æ‹©ç¿»è¯‘æœåŠ¡å•†",missingItems:["ç¿»è¯‘æœåŠ¡å•†"]}}function M(){const{hqTranslation:_}=n.settings,{provider:q,apiKey:V,modelName:se,customBaseUrl:X}=_,ie=[];return q?((!V||V.trim()==="")&&ie.push("é«˜è´¨é‡ç¿»è¯‘çš„ API Key"),(!se||se.trim()==="")&&ie.push("é«˜è´¨é‡ç¿»è¯‘çš„æ¨¡å‹åç§°"),k(q)&&(!X||X.trim()==="")&&ie.push("é«˜è´¨é‡ç¿»è¯‘çš„ Base URL"),ie.length>0?{valid:!1,message:`è¯·å…ˆåœ¨é¡¶éƒ¨ âš™ï¸ è®¾ç½®èœå•ä¸­å¡«å†™ ${ie[0]}`,missingItems:ie}:{valid:!0,message:""}):{valid:!1,message:"è¯·å…ˆåœ¨é¡¶éƒ¨ âš™ï¸ è®¾ç½®èœå•ä¸­é€‰æ‹©é«˜è´¨é‡ç¿»è¯‘çš„æœåŠ¡å•†",missingItems:["é«˜è´¨é‡ç¿»è¯‘æœåŠ¡å•†"]}}function E(_){const q=_||n.settings.proofreading.rounds,V=[];if(!q||q.length===0)return{valid:!1,message:"è¯·å…ˆåœ¨é¡¶éƒ¨ âš™ï¸ è®¾ç½®èœå•ä¸­æ·»åŠ è‡³å°‘ä¸€ä¸ªæ ¡å¯¹è½®æ¬¡",missingItems:["æ ¡å¯¹è½®æ¬¡"]};for(let se=0;se<q.length;se++){const X=q[se];if(!X)continue;const ie=X.name||`è½®æ¬¡${se+1}`;if(X.provider||V.push(`æ ¡å¯¹ ${ie} çš„æœåŠ¡å•†`),(!X.apiKey||X.apiKey.trim()==="")&&V.push(`æ ¡å¯¹ ${ie} çš„ API Key`),(!X.modelName||X.modelName.trim()==="")&&V.push(`æ ¡å¯¹ ${ie} çš„æ¨¡å‹åç§°`),V.length>0)return{valid:!1,message:`è¯·å…ˆåœ¨é¡¶éƒ¨ âš™ï¸ è®¾ç½®èœå•ä¸­ä¸º ${V[0]}`,missingItems:V}}return{valid:!0,message:""}}function $(_="normal",q={}){let V;switch(_){case"normal":V=L();break;case"hq":V=M();break;case"proofread":V=E(q.proofreadingRounds);break;case"ocr":V=P();break;default:V=L()}return V.valid?!0:(t.error(V.message),K(),!1)}function j(){const _=P();if(!_.valid)return t.error(_.message),K(),!1;const q=L();return q.valid?!0:(t.error(q.message),K(),!1)}function K(){const _=document.getElementById("openSettingsBtn");_&&(o.value=!0,_.style.animation="settingsBtnPulse 0.5s ease-in-out 3",_.style.boxShadow="0 0 10px var(--primary-color, #4a90d9)",setTimeout(()=>{_.style.animation="",_.style.boxShadow="",o.value=!1},3e3))}function U(){if(i.value){console.log("ç”¨æˆ·å·²é€‰æ‹©ä¸å†æ˜¾ç¤ºè®¾ç½®æé†’");return}s.value=!0}function g(_=!1){if(_)try{localStorage.setItem(co,"true"),console.log("ç”¨æˆ·é€‰æ‹©æ°¸ä¹…å…³é—­è®¾ç½®æé†’")}catch(q){console.error("ä¿å­˜è®¾ç½®æé†’çŠ¶æ€å¤±è´¥:",q)}s.value=!1}function d(){try{localStorage.removeItem(co),console.log("è®¾ç½®æé†’çŠ¶æ€å·²é‡ç½®")}catch(_){console.error("é‡ç½®è®¾ç½®æé†’çŠ¶æ€å¤±è´¥:",_)}}function x(){setTimeout(()=>{U()},500)}return{showSetupReminder:s,isSettingsButtonHighlighted:o,isSetupReminderDismissed:i,validateOcrConfig:P,validateTranslationConfig:L,validateHqTranslationConfig:M,validateProofreadingConfig:E,validateBeforeTranslation:$,validateFullTranslationConfig:j,highlightSettingsButton:K,checkAndShowSetupReminder:U,closeSetupReminder:g,resetSetupReminderDismiss:d,initValidation:x,getProviderDisplayName:r,getOcrEngineDisplayName:f,requiresApiKey:a,isLocalProvider:u,requiresBaseUrl:p}}const gt=Jt("bubble",()=>{const n=C([]),t=C(-1),s=C([]),o=C([]),i=C(!1),r=C(-1),a=C(0),u=C(0),p=C(0),k=C(0),f=C(!1),P=C(-1),L=C(null),M=C(!1),E=C(-1),$=C(0),j=Q(()=>t.value>=0&&t.value<n.value.length?n.value[t.value]??null:null),K=Q(()=>n.value.length),U=Q(()=>n.value.length>0),g=Q(()=>t.value>=0),d=Q(()=>s.value.length>1),x=Q(()=>s.value.filter(T=>T>=0&&T<n.value.length).map(T=>n.value[T]).filter(T=>T!==void 0));function _(){const G=et().currentImage;G&&(G.bubbleStates=Nt(n.value),G.hasUnsavedChanges=!0,console.log("æ°”æ³¡çŠ¶æ€å·²åŒæ­¥åˆ°å½“å‰å›¾ç‰‡"))}function q(T,G=!1){n.value=T,o.value=Nt(T),F(),console.log(`æ°”æ³¡æ•°ç»„å·²è®¾ç½®ï¼Œå…± ${T.length} ä¸ªæ°”æ³¡`),G||_()}function V(T,G){const ce=ta(T),De=ze().settings.textStyle,$e=De.layoutDirection,he=$e==="vertical"||$e==="horizontal"?$e:ce==="vertical"||ce==="horizontal"?ce:"vertical",te=ea({coords:T,translatedText:"",autoTextDirection:ce,fontSize:De.fontSize,fontFamily:De.fontFamily,textDirection:he,textColor:De.textColor,fillColor:De.fillColor,inpaintMethod:De.inpaintMethod,strokeEnabled:De.strokeEnabled,strokeColor:De.strokeColor,strokeWidth:De.strokeWidth,rotationAngle:0,position:{x:0,y:0},...G});return n.value.push(te),console.log(`å·²æ·»åŠ æ°”æ³¡ï¼Œå½“å‰å…± ${n.value.length} ä¸ª`),_(),te}function se(T){return T<0||T>=n.value.length?(console.warn(`åˆ é™¤å¤±è´¥: æ— æ•ˆçš„ç´¢å¼• ${T}`),!1):(n.value.splice(T,1),t.value===T?t.value=-1:t.value>T&&t.value--,s.value=s.value.filter(G=>G!==T).map(G=>G>T?G-1:G),console.log(`å·²åˆ é™¤æ°”æ³¡ï¼Œå½“å‰å…± ${n.value.length} ä¸ª`),_(),!0)}function X(){if(s.value.length===0&&t.value<0)return;const T=[...new Set([...s.value,t.value])].filter(G=>G>=0).sort((G,ce)=>ce-G);for(const G of T)n.value.splice(G,1);F(),console.log(`å·²åˆ é™¤ ${T.length} ä¸ªæ°”æ³¡`),_()}function ie(){n.value=[],o.value=[],F(),console.log("æ‰€æœ‰æ°”æ³¡å·²æ¸…é™¤"),_()}function z(){n.value=[],o.value=[],F(),console.log("æœ¬åœ°æ°”æ³¡çŠ¶æ€å·²æ¸…é™¤ï¼ˆä¸åŒæ­¥åˆ°imageStoreï¼‰")}function R(T){T>=-1&&T<n.value.length&&(t.value=T,s.value=T>=0?[T]:[],console.log(`å·²é€‰ä¸­æ°”æ³¡ ${T}`))}function I(T){if(T<0||T>=n.value.length)return;const G=s.value.indexOf(T);G>=0?(s.value.splice(G,1),t.value===T&&(t.value=s.value[0]??-1)):(s.value.push(T),t.value=T),console.log(`å¤šé€‰çŠ¶æ€: ${s.value.join(", ")}`)}function F(){t.value=-1,s.value=[]}function y(){t.value>=0?s.value=[t.value]:s.value=[]}function m(){if(n.value.length===0)return!1;const T=t.value<n.value.length-1?t.value+1:0;return R(T),!0}function l(){if(n.value.length===0)return!1;const T=t.value>0?t.value-1:n.value.length-1;return R(T),!0}function v(T,G){if(T<0||T>=n.value.length)return console.warn(`æ›´æ–°å¤±è´¥: æ— æ•ˆçš„ç´¢å¼• ${T}`),!1;const ce=n.value[T];return ce?(Object.assign(ce,G),console.log(`å·²æ›´æ–°æ°”æ³¡ ${T}`),_(),!0):!1}function D(T){return t.value<0?(console.warn("æ›´æ–°å¤±è´¥: æ²¡æœ‰é€‰ä¸­çš„æ°”æ³¡"),!1):v(t.value,T)}function S(T){const G=s.value.length>0?s.value:t.value>=0?[t.value]:[];for(const ce of G){const _e=n.value[ce];_e&&Object.assign(_e,T)}_(),console.log(`å·²æ‰¹é‡æ›´æ–° ${G.length} ä¸ªæ°”æ³¡`)}function w(T){for(let G=0;G<n.value.length;G++){const ce=n.value[G];ce&&Object.assign(ce,T)}_(),console.log(`å·²æ›´æ–°æ‰€æœ‰ ${n.value.length} ä¸ªæ°”æ³¡`)}function W(){if(n.value.length!==o.value.length)return!0;for(let T=0;T<n.value.length;T++){const G=n.value[T],ce=o.value[T];if(!(!G||!ce)&&(G.translatedText!==ce.translatedText||G.textboxText!==ce.textboxText||G.fontSize!==ce.fontSize||G.fontFamily!==ce.fontFamily||G.textDirection!==ce.textDirection||G.textColor!==ce.textColor||G.fillColor!==ce.fillColor||G.rotationAngle!==ce.rotationAngle||G.strokeEnabled!==ce.strokeEnabled||G.strokeColor!==ce.strokeColor||G.strokeWidth!==ce.strokeWidth||G.inpaintMethod!==ce.inpaintMethod||JSON.stringify(G.coords)!==JSON.stringify(ce.coords)))return!0}return!1}function Z(){n.value=Nt(o.value),F(),console.log("æ°”æ³¡çŠ¶æ€å·²é‡ç½®åˆ°åˆå§‹çŠ¶æ€")}function Y(){o.value=Nt(n.value),console.log("å½“å‰çŠ¶æ€å·²ä¿å­˜ä¸ºåˆå§‹çŠ¶æ€")}function c(){return{bubble_coords:n.value.map(T=>T.coords),bubble_texts:n.value.map(T=>T.translatedText),textbox_texts:n.value.map(T=>T.textboxText),font_sizes:n.value.map(T=>T.fontSize),font_families:n.value.map(T=>T.fontFamily),text_directions:n.value.map(T=>T.textDirection==="vertical"||T.textDirection==="horizontal"?T.textDirection==="vertical"?"v":"h":T.autoTextDirection==="vertical"||T.autoTextDirection==="horizontal"?T.autoTextDirection==="vertical"?"v":"h":"v"),text_colors:n.value.map(T=>T.textColor),fill_colors:n.value.map(T=>T.fillColor),rotation_angles:n.value.map(T=>T.rotationAngle),stroke_enabled:n.value.map(T=>T.strokeEnabled),stroke_colors:n.value.map(T=>T.strokeColor),stroke_widths:n.value.map(T=>T.strokeWidth),inpaint_methods:n.value.map(T=>T.inpaintMethod)}}function h(){return JSON.stringify(n.value)}function le(T){try{const G=JSON.parse(T);if(!Array.isArray(G))return console.error("ååºåˆ—åŒ–å¤±è´¥: æ•°æ®ä¸æ˜¯æ•°ç»„"),!1;const ce=[];for(const _e of G)oa(_e)?ce.push(_e):console.warn("è·³è¿‡æ— æ•ˆçš„æ°”æ³¡çŠ¶æ€:",_e);return q(ce),!0}catch(G){return console.error("ååºåˆ—åŒ–å¤±è´¥:",G),!1}}return{bubbles:n,selectedIndex:t,selectedIndices:s,initialStates:o,isDragging:i,draggingIndex:r,dragOffsetX:a,dragOffsetY:u,dragInitialX:p,dragInitialY:k,isResizing:f,resizingIndex:P,resizeCurrentCoords:L,isRotating:M,rotatingIndex:E,rotateCurrentAngle:$,selectedBubble:j,bubbleCount:K,hasBubbles:U,hasSelection:g,isMultiSelect:d,selectedBubbles:x,setBubbles:q,addBubble:V,deleteBubble:se,deleteSelected:X,clearBubbles:ie,clearBubblesLocal:z,selectBubble:R,toggleMultiSelect:I,clearSelection:F,clearMultiSelect:y,selectNext:m,selectPrevious:l,updateBubble:v,updateSelectedBubble:D,updateAllSelected:S,updateAllBubbles:w,hasChanges:W,resetToInitial:Z,saveAsInitial:Y,toApiRequest:c,serialize:h,deserialize:le}}),ui=Object.freeze(Object.defineProperty({__proto__:null,useBubbleStore:gt},Symbol.toStringTag,{value:"Module"}));function ci(){const n=C({current:0,total:0,completed:0,failed:0,isInProgress:!1,label:"",percentage:0});return{progress:n,reporter:{init(s,o){n.value={current:0,total:s,completed:0,failed:0,isInProgress:!0,label:o||"å‡†å¤‡ä¸­...",percentage:0}},update(s,o){n.value.current=s,o!==void 0&&(n.value.label=o),n.value.total>0&&(n.value.percentage=Math.round(s/n.value.total*100))},setPercentage(s,o){n.value.percentage=Math.min(100,Math.max(0,s)),o!==void 0&&(n.value.label=o)},incrementCompleted(){n.value.completed++},incrementFailed(){n.value.failed++},finish(){n.value.isInProgress=!1,n.value.percentage=100},getProgress(){return{...n.value}}}}}async function So(n){return Xe.post("/api/parallel/detect",n)}async function ko(n){return Xe.post("/api/parallel/ocr",n)}async function wo(n){return Xe.post("/api/parallel/color",n)}async function $o(n){return Xe.post("/api/parallel/translate",n)}async function To(n){return Xe.post("/api/parallel/inpaint",n)}async function Io(n){return Xe.post("/api/parallel/render",n)}const di=Object.freeze(Object.defineProperty({__proto__:null,parallelColor:wo,parallelDetect:So,parallelInpaint:To,parallelOcr:ko,parallelRender:Io,parallelTranslate:$o},Symbol.toStringTag,{value:"Module"}));let Tt=null,Ft=!1;function Pt(){const n=It();return ze().settings.autoSaveInBookshelfMode&&n.isBookshelfMode}function Po(){const n=It(),t=n.currentBookId,s=n.currentChapterId;return!t||!s?null:`bookshelf/${t}/${s}`}function Bn(){const n=ze(),{textStyle:t}=n.settings;return{fontSize:t.fontSize,autoFontSize:t.autoFontSize,fontFamily:t.fontFamily,layoutDirection:t.layoutDirection,textColor:t.textColor,useInpaintingMethod:t.inpaintMethod,fillColor:t.fillColor,strokeEnabled:t.strokeEnabled,strokeColor:t.strokeColor,strokeWidth:t.strokeWidth,useAutoTextColor:t.useAutoTextColor}}async function An(n){const t=et();if(!Pt())return console.log("[AutoSave] è‡ªåŠ¨ä¿å­˜æœªå¯ç”¨æˆ–éä¹¦æ¶æ¨¡å¼ï¼Œè·³è¿‡é¢„ä¿å­˜"),!0;const s=Po();if(!s)return console.warn("[AutoSave] ç¼ºå°‘ä¹¦ç±/ç« èŠ‚IDï¼Œè·³è¿‡é¢„ä¿å­˜"),n?.onError?.("ç¼ºå°‘ä¹¦ç±/ç« èŠ‚ID"),!1;const o=t.images,i=o.length;if(i===0)return console.warn("[AutoSave] æ²¡æœ‰å›¾ç‰‡ï¼Œè·³è¿‡é¢„ä¿å­˜"),n?.onError?.("æ²¡æœ‰å›¾ç‰‡"),!1;console.log(`[AutoSave] é¢„ä¿å­˜å¼€å§‹ï¼š${i} é¡µï¼ˆé€é¡µä¿å­˜ï¼‰`),n?.onStart?.(i);try{const{saveAllPagesSequentially:r,saveSessionMeta:a}=await rt(async()=>{const{saveAllPagesSequentially:L,saveSessionMeta:M}=await Promise.resolve().then(()=>Mn);return{saveAllPagesSequentially:L,saveSessionMeta:M}},void 0),u=Bn(),p=await r(s,o,{onProgress:(L,M)=>{n?.onProgress?.(L,M)}});await a(s,{ui_settings:u,total_pages:i,currentImageIndex:t.currentImageIndex});const k=It(),f=k.currentBookId,P=k.currentChapterId;if(f&&P)try{const{apiClient:L}=await rt(async()=>{const{apiClient:M}=await import("./client.Bht704G-.js");return{apiClient:M}},__vite__mapDeps([4,5]));await L.put(`/api/bookshelf/books/${f}/chapters/${P}/image-count`,{count:i}),console.log(`[AutoSave] å·²æ›´æ–°ç« èŠ‚å›¾ç‰‡æ•°é‡ä¸º ${i}`)}catch(L){console.warn("[AutoSave] æ›´æ–°ç« èŠ‚å›¾ç‰‡æ•°é‡å¤±è´¥ï¼ˆéè‡´å‘½ï¼‰:",L)}return Tt=s,Ft=!0,console.log(`[AutoSave] é¢„ä¿å­˜å®Œæˆï¼Œå…±ä¿å­˜ ${p}/${i} é¡µ`),n?.onComplete?.(),!0}catch(r){console.error("[AutoSave] é¢„ä¿å­˜å¤±è´¥:",r);const a=r instanceof Error?r.message:"é¢„ä¿å­˜å¤±è´¥";return n?.onError?.(a),Tt=null,Ft=!1,!1}}async function Ln(n){if(!Pt())return;const t=Tt||Po();if(!t){console.warn("[AutoSave] ä¼šè¯è·¯å¾„ä¸å­˜åœ¨ï¼Œè·³è¿‡ä¿å­˜");return}const s=et(),o=s.images[n];if(!o){console.warn(`[AutoSave] é¡µé¢ ${n} ä¸å­˜åœ¨`);return}try{const i={};o.translatedDataURL?.startsWith("data:")&&(i.translated=o.translatedDataURL),o.cleanImageData&&typeof o.cleanImageData=="string"&&!o.cleanImageData.startsWith("/api/")&&(i.clean=o.cleanImageData.startsWith("data:")?o.cleanImageData:`data:image/png;base64,${o.cleanImageData}`);const r={};for(const u of Object.keys(o))["originalDataURL","translatedDataURL","cleanImageData"].includes(u)||(r[u]=o[u]);i.meta=r;const a=await Dn(t,n,i);if(!a.success)throw new Error(a.error||"ä¿å­˜å¤±è´¥");s.updateImageByIndex(n,{hasUnsavedChanges:!1}),console.log(`[AutoSave] é¡µé¢ ${n+1} å·²ä¿å­˜`)}catch(i){throw console.error(`[AutoSave] ä¿å­˜é¡µé¢ ${n+1} å¤±è´¥:`,i),i}}async function Fn(){if(!Pt())return;const n=Tt||Po();if(!n||!Ft){console.log("[AutoSave] æœªæ‰§è¡Œé¢„ä¿å­˜ï¼Œè·³è¿‡å®Œæˆä¿å­˜");return}console.log("[AutoSave] å®Œæˆä¿å­˜...");const t=et(),s=It(),o=t.images.length;try{await Pn(n,{ui_settings:Bn(),total_pages:o,currentImageIndex:t.currentImageIndex});const i=s.currentBookId,r=s.currentChapterId;if(i&&r)try{const{apiClient:a}=await rt(async()=>{const{apiClient:u}=await import("./client.Bht704G-.js");return{apiClient:u}},__vite__mapDeps([4,5]));await a.put(`/api/bookshelf/books/${i}/chapters/${r}/image-count`,{count:o}),console.log(`[AutoSave] å·²æ›´æ–°ç« èŠ‚å›¾ç‰‡æ•°é‡ä¸º ${o}`)}catch(a){console.warn("[AutoSave] æ›´æ–°ç« èŠ‚å›¾ç‰‡æ•°é‡å¤±è´¥ï¼ˆéè‡´å‘½ï¼‰:",a)}console.log("[AutoSave] ä¼šè¯ä¿å­˜å®Œæˆ")}catch(i){console.error("[AutoSave] å®Œæˆä¿å­˜å¤±è´¥:",i)}finally{Tt=null,Ft=!1}}function Un(){Tt=null,Ft=!1,console.log("[AutoSave] ä¿å­˜çŠ¶æ€å·²é‡ç½®")}const vn={standard:["detection","ocr","color","translate","inpaint","render"],hq:["detection","ocr","color","aiTranslate","inpaint","render"],proofread:["aiTranslate","render"],removeText:["detection","inpaint","render"]},Wt={detection:"æ°”æ³¡æ£€æµ‹",ocr:"æ–‡å­—è¯†åˆ«",color:"é¢œè‰²æå–",translate:"ç¿»è¯‘",aiTranslate:"AIç¿»è¯‘",inpaint:"èƒŒæ™¯ä¿®å¤",render:"æ¸²æŸ“",save:"ä¿å­˜"};function gi(){const n=et(),t=gt(),s=ze(),o=En(),i=ct(),{progress:r,reporter:a}=ci(),u=C(!1),p=C(null);let k=null,f="standard";const P=Q(()=>u.value||n.isBatchTranslationInProgress),L=Q(()=>r.value.percentage||0);function M(){const l=s.settings.translation.rpmLimit;p.value?p.value.setRpm(l):p.value=na(l)}function E(l){const v=l.mode==="hq"?"hq":l.mode==="proofread"?"proofread":l.mode==="removeText"?"ocr":"normal";return o.validateBeforeTranslation(v)}function $(){const{textStyle:l}=s.settings,v=l.layoutDirection;k={fontFamily:l.fontFamily,fontSize:l.fontSize,autoFontSize:l.autoFontSize,autoTextDirection:v==="auto",textDirection:v==="auto"?"vertical":v,layoutDirection:v,fillColor:l.fillColor,textColor:l.textColor,rotationAngle:0,strokeEnabled:l.strokeEnabled,strokeColor:l.strokeColor,strokeWidth:l.strokeWidth,useAutoTextColor:l.useAutoTextColor}}function j(l){return l.includes("base64,")?l.split("base64,")[1]||"":l}function K(l){const v=n.images;if(l.scope==="current"){const D=n.currentImage;return D?[{image:D,index:n.currentImageIndex}]:[]}if(l.scope==="failed")return n.getFailedImageIndices().map(D=>({image:v[D],index:D})).filter(D=>D.image!==void 0);if(l.scope==="range"&&l.pageRange){const D=Math.max(0,l.pageRange.startPage-1),S=Math.min(v.length-1,l.pageRange.endPage-1);return D>S||D>=v.length?[]:v.slice(D,S+1).map((w,W)=>({image:w,index:D+W}))}return v.map((D,S)=>({image:D,index:S}))}async function U(l){const v=s.settings,D=j(l.image.originalDataURL),S=await So({image:D,detector_type:v.textDetector,box_expand_ratio:v.boxExpand.ratio,box_expand_top:v.boxExpand.top,box_expand_bottom:v.boxExpand.bottom,box_expand_left:v.boxExpand.left,box_expand_right:v.boxExpand.right});if(!S.success)throw new Error(S.error||"æ£€æµ‹å¤±è´¥");l.bubbleCoords=S.bubble_coords||[],l.bubbleAngles=S.bubble_angles||[],l.bubblePolygons=S.bubble_polygons||[],l.autoDirections=S.auto_directions||[],l.rawMask=S.raw_mask,l.textlinesPerBubble=S.textlines_per_bubble||[]}async function g(l){if(l.bubbleCoords.length===0){l.originalTexts=[];return}const v=s.settings,D=j(l.image.originalDataURL),S=await ko({image:D,bubble_coords:l.bubbleCoords,source_language:v.sourceLanguage,ocr_engine:v.ocrEngine,baidu_api_key:v.baiduOcr?.apiKey,baidu_secret_key:v.baiduOcr?.secretKey,baidu_version:v.baiduOcr?.version,baidu_ocr_language:v.baiduOcr?.sourceLanguage,ai_vision_provider:v.aiVisionOcr?.provider,ai_vision_api_key:v.aiVisionOcr?.apiKey,ai_vision_model_name:v.aiVisionOcr?.modelName,ai_vision_ocr_prompt:v.aiVisionOcr?.prompt,custom_ai_vision_base_url:v.aiVisionOcr?.customBaseUrl,textlines_per_bubble:l.textlinesPerBubble});if(!S.success)throw new Error(S.error||"OCRå¤±è´¥");l.originalTexts=S.original_texts||[]}async function d(l){if(l.bubbleCoords.length===0){l.colors=[];return}const v=j(l.image.originalDataURL),D=await wo({image:v,bubble_coords:l.bubbleCoords,textlines_per_bubble:l.textlinesPerBubble});if(!D.success)throw new Error(D.error||"é¢œè‰²æå–å¤±è´¥");l.colors=D.colors||[]}async function x(l){if(l.originalTexts.length===0){l.translatedTexts=[],l.textboxTexts=[];return}const v=s.settings,D=await $o({original_texts:l.originalTexts,target_language:v.targetLanguage,source_language:v.sourceLanguage,model_provider:v.translation.provider,model_name:v.translation.modelName,api_key:v.translation.apiKey,custom_base_url:v.translation.customBaseUrl,prompt_content:v.translatePrompt,textbox_prompt_content:v.textboxPrompt,use_textbox_prompt:v.useTextboxPrompt,rpm_limit:v.translation.rpmLimit,max_retries:v.translation.maxRetries,use_json_format:v.translation.isJsonMode});if(!D.success)throw new Error(D.error||"ç¿»è¯‘å¤±è´¥");l.translatedTexts=D.translated_texts||[],l.textboxTexts=D.textbox_texts||[]}async function _(l){const v=s.settings,D=f==="proofread",S=l.map(he=>D?{imageIndex:he.imageIndex,bubbles:(he.image.bubbleStates||[]).map((te,b)=>({bubbleIndex:b,original:te.originalText||"",translated:v.useTextboxPrompt?te.textboxText||te.translatedText||"":te.translatedText||"",textDirection:te.textDirection==="vertical"||te.textDirection==="horizontal"?te.textDirection:te.autoTextDirection==="vertical"||te.autoTextDirection==="horizontal"?te.autoTextDirection:"vertical"}))}:{imageIndex:he.imageIndex,bubbles:he.originalTexts.map((te,b)=>({bubbleIndex:b,original:te,translated:"",textDirection:he.autoDirections[b]||"vertical"}))}),w=l.map(he=>{const te=D&&he.image.translatedDataURL||he.image.originalDataURL;return j(te)}),W=D?v.proofreading.rounds[0]:v.hqTranslation,Z=D?W?.prompt:v.hqTranslation.prompt,Y=D?"ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ¼«ç”»ç¿»è¯‘æ ¡å¯¹åŠ©æ‰‹ï¼Œèƒ½å¤Ÿæ ¹æ®æ¼«ç”»å›¾åƒå†…å®¹æ£€æŸ¥å’Œä¿®æ­£ç¿»è¯‘ã€‚":"ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ¼«ç”»ç¿»è¯‘åŠ©æ‰‹ï¼Œèƒ½å¤Ÿæ ¹æ®æ¼«ç”»å›¾åƒå†…å®¹å’Œä¸Šä¸‹æ–‡æä¾›é«˜è´¨é‡çš„ç¿»è¯‘ã€‚",c=JSON.stringify(S,null,2),h=[{type:"text",text:(Z||"")+`

ä»¥ä¸‹æ˜¯JSONæ•°æ®:
\`\`\`json
`+c+"\n```"}];for(const he of w)h.push({type:"image_url",image_url:{url:`data:image/png;base64,${he}`}});const le=[{role:"system",content:Y},{role:"user",content:h}],T=v.hqTranslation,G=D?W:null,ce=await At({provider:(D?G?.provider:T.provider)||"openai",api_key:(D?G?.apiKey:T.apiKey)||"",model_name:(D?G?.modelName:T.modelName)||"",custom_base_url:D?G?.customBaseUrl:T.customBaseUrl,messages:le,low_reasoning:D?G?.lowReasoning:T.lowReasoning,force_json_output:D?G?.forceJsonOutput:T.forceJsonOutput,no_thinking_method:D?G?.noThinkingMethod:T.noThinkingMethod,use_stream:D?!1:T.useStream,max_retries:D?v.proofreading.maxRetries||2:T.maxRetries||2}),_e=D?G?.forceJsonOutput||!1:T.forceJsonOutput;let $e=X(ce,_e)||S;if(D&&v.proofreading.rounds.length>1)for(let he=1;he<v.proofreading.rounds.length;he++){const te=v.proofreading.rounds[he],b=JSON.stringify($e,null,2),J=[{type:"text",text:te.prompt+`

ä»¥ä¸‹æ˜¯JSONæ•°æ®:
\`\`\`json
`+b+"\n```"}];for(const ne of w)J.push({type:"image_url",image_url:{url:`data:image/png;base64,${ne}`}});const ve=[{role:"system",content:Y},{role:"user",content:J}],fe=await At({provider:te.provider,api_key:te.apiKey,model_name:te.modelName,custom_base_url:te.customBaseUrl,messages:ve,low_reasoning:te.lowReasoning,force_json_output:te.forceJsonOutput,no_thinking_method:te.noThinkingMethod,use_stream:!1,max_retries:te.maxRetries||v.proofreading.maxRetries||2}),O=X(fe,te.forceJsonOutput);O&&($e=O)}for(const he of l){const te=$e?.find(b=>b.imageIndex===he.imageIndex);te?he.translatedTexts=te.bubbles.map(b=>b.translated):he.translatedTexts=[],he.textboxTexts=[]}}async function q(l){if(l.bubbleCoords.length===0){l.cleanImage=j(l.image.originalDataURL);return}const v=s.settings,{textStyle:D,preciseMask:S}=v,w=j(l.image.originalDataURL),W=await To({image:w,bubble_coords:l.bubbleCoords,bubble_polygons:l.bubblePolygons,raw_mask:l.rawMask,method:D.inpaintMethod==="solid"?"solid":"lama",lama_model:D.inpaintMethod==="litelama"?"litelama":"lama_mpe",fill_color:D.fillColor,mask_dilate_size:S.dilateSize,mask_box_expand_ratio:S.boxExpandRatio});if(!W.success)throw new Error(W.error||"èƒŒæ™¯ä¿®å¤å¤±è´¥");l.cleanImage=W.clean_image}async function V(l){if(!l.cleanImage)throw f==="proofread"?new Error("æ­¤å›¾ç‰‡å°šæœªç¿»è¯‘ï¼Œè¯·å…ˆç¿»è¯‘åå†è¿›è¡Œæ ¡å¯¹"):new Error("ç¼ºå°‘å¹²å‡€èƒŒæ™¯å›¾ç‰‡");const{textStyle:v}=s.settings,D=k?.autoTextDirection?"auto":k?.textDirection||v.layoutDirection,S=l.bubbleCoords.map((W,Z)=>{const Y=l.autoDirections[Z]||"vertical",c=Y==="v"?"vertical":Y==="h"?"horizontal":Y==="vertical"||Y==="horizontal"?Y:"vertical",h=D==="vertical"||D==="horizontal"?D:c,le=k?.useAutoTextColor??v.useAutoTextColor;let T=k?.textColor||v.textColor,G=k?.fillColor||v.fillColor;const ce=l.colors[Z];return le&&ce&&(ce.textColor&&(T=ce.textColor),ce.bgColor&&(G=ce.bgColor)),{coords:W,polygon:[],position:{x:0,y:0},rotationAngle:l.bubbleAngles[Z]||0,originalText:l.originalTexts[Z]||"",translatedText:l.translatedTexts[Z]||"",textboxText:l.textboxTexts[Z]||"",textDirection:h,autoTextDirection:c,fontSize:k?.fontSize||v.fontSize,fontFamily:k?.fontFamily||v.fontFamily,autoFontSize:k?.autoFontSize??v.autoFontSize,textColor:T,fillColor:G,strokeEnabled:k?.strokeEnabled??v.strokeEnabled,strokeColor:k?.strokeColor||v.strokeColor,strokeWidth:k?.strokeWidth||v.strokeWidth,inpaintMethod:v.inpaintMethod,autoFgColor:l.colors[Z]?.autoFgColor||null,autoBgColor:l.colors[Z]?.autoBgColor||null}}),w=await Io({clean_image:l.cleanImage,bubble_states:S,fontSize:k?.fontSize||v.fontSize,fontFamily:k?.fontFamily||v.fontFamily,textDirection:k?.textDirection||v.layoutDirection,textColor:k?.textColor||v.textColor,strokeEnabled:k?.strokeEnabled??v.strokeEnabled,strokeColor:k?.strokeColor||v.strokeColor,strokeWidth:k?.strokeWidth||v.strokeWidth,autoFontSize:k?.autoFontSize??v.autoFontSize,use_individual_styles:!0});if(!w.success)throw new Error(w.error||"æ¸²æŸ“å¤±è´¥");l.finalImage=w.final_image,l.bubbleStates=w.bubble_states||S}async function se(l,v){switch(l){case"detection":await U(v);break;case"ocr":await g(v);break;case"color":await d(v);break;case"translate":await x(v);break;case"inpaint":await q(v);break;case"render":await V(v);break;case"save":await Ln(v.imageIndex);break;case"aiTranslate":throw new Error("aiTranslate åº”é€šè¿‡æ‰¹é‡å¤„ç†é€»è¾‘è°ƒç”¨")}}function X(l,v){if(!l.success)return console.error("APIè°ƒç”¨å¤±è´¥:",l.error),null;if(l.results&&l.results.length>0){const S=l.results[0];if(S&&"imageIndex"in S&&"bubbles"in S)return l.results}const D=l.content;if(D)if(v)try{return JSON.parse(D)}catch{return null}else{const S=D.match(/```json\s*([\s\S]*?)\s*```/);if(S?.[1])try{return JSON.parse(S[1])}catch{return null}}return null}function ie(l){const v=l.finalImage?`data:image/png;base64,${l.finalImage}`:l.cleanImage?`data:image/png;base64,${l.cleanImage}`:null;n.updateImageByIndex(l.imageIndex,{translatedDataURL:v,cleanImageData:l.cleanImage||null,bubbleStates:l.bubbleStates,bubbleCoords:l.bubbleCoords,bubbleAngles:l.bubbleAngles,originalTexts:l.originalTexts,textboxTexts:l.textboxTexts,bubbleTexts:l.translatedTexts,translationStatus:"completed",translationFailed:!1,showOriginal:!1,hasUnsavedChanges:!0,layoutDirection:k?.layoutDirection,autoFontSize:k?.autoFontSize??!1,useAutoTextColor:k?.useAutoTextColor??!1}),l.imageIndex===n.currentImageIndex&&l.bubbleStates&&t.setBubbles(l.bubbleStates)}function z(l){return l==="standard"||l==="removeText"}function R(l){const v=s.settings;return l==="hq"?v.hqTranslation.batchSize||5:l==="proofread"?v.proofreading.rounds[0]?.batchSize||5:1}async function I(l,v,D,S){let w=0,W=0;for(let Z=0;Z<l.length;Z++){const Y=l[Z];if(D.scope==="all"&&!n.isBatchTranslationInProgress){console.log("â¹ï¸ æ‰¹é‡ç¿»è¯‘å·²å–æ¶ˆï¼Œåœæ­¢å¤„ç†");break}const c=Math.floor(Z/l.length*90);a.setPercentage(c,`å¤„ç†å›¾ç‰‡ ${Z+1}/${l.length}`),i.info(`å¤„ç†å›¾ç‰‡ ${Z+1}/${l.length}...`),n.setTranslationStatus(Y.imageIndex,"processing");let h=!1;for(let le=0;le<v.length;le++){const T=v[le];if(h)break;p.value&&await p.value.acquire();try{const G=c+Math.floor(le/v.length*(90/l.length));a.setPercentage(G,`å›¾ç‰‡ ${Z+1}: ${Wt[T]}`),await se(T,Y)}catch(G){const ce=G instanceof Error?G.message:"æœªçŸ¥é”™è¯¯";S.push(`å›¾ç‰‡ ${Y.imageIndex+1}: ${T} - ${ce}`),n.setTranslationStatus(Y.imageIndex,"failed",ce),h=!0,W++}}h||(ie(Y),w++,console.log(`âœ… å›¾ç‰‡ ${Z+1}/${l.length} å¤„ç†å®Œæˆ`))}return{completed:w,failed:W}}async function F(l,v,D,S){let w=0,W=0;const Z=R(D.mode),Y=Math.ceil(l.length/Z),c=v.indexOf("aiTranslate"),h=c>=0?v.slice(0,c):v,le=c>=0?v.slice(c+1):[];console.log(`ğŸ“¦ æ‰¹æ¬¡å¤„ç†æ¨¡å¼ï¼šå…± ${l.length} å¼ å›¾ç‰‡ï¼Œæ¯æ‰¹ ${Z} å¼ ï¼Œå…± ${Y} æ‰¹`),console.log(`   AIç¿»è¯‘å‰æ­¥éª¤: [${h.join(" â†’ ")}]`),console.log(`   AIç¿»è¯‘åæ­¥éª¤: [${le.join(" â†’ ")}]`);for(let T=0;T<Y;T++){if(D.scope==="all"&&!n.isBatchTranslationInProgress){console.log("â¹ï¸ æ‰¹é‡ç¿»è¯‘å·²å–æ¶ˆï¼Œåœæ­¢å¤„ç†");break}const G=T*Z,ce=Math.min(G+Z,l.length),_e=l.slice(G,ce),De=Math.floor(T/Y*90);a.setPercentage(De,`å¤„ç†æ‰¹æ¬¡ ${T+1}/${Y}`),i.info(`å¤„ç†æ‰¹æ¬¡ ${T+1}/${Y}ï¼ˆå›¾ç‰‡ ${G+1}-${ce}ï¼‰...`);for(const he of _e)n.setTranslationStatus(he.imageIndex,"processing");const $e=new Set;for(let he=0;he<_e.length;he++){const te=_e[he];for(const b of h){if($e.has(te.imageIndex))break;p.value&&await p.value.acquire();try{const J=De+Math.floor(he/_e.length*30);a.setPercentage(J,`å›¾ç‰‡ ${G+he+1}: ${Wt[b]}`),await se(b,te)}catch(J){const ve=J instanceof Error?J.message:"æœªçŸ¥é”™è¯¯";S.push(`å›¾ç‰‡ ${te.imageIndex+1}: ${b} - ${ve}`),n.setTranslationStatus(te.imageIndex,"failed",ve),$e.add(te.imageIndex)}}}if(c>=0){const he=De+40;a.setPercentage(he,`æ‰¹æ¬¡ ${T+1}: ${Wt.aiTranslate}`);try{const te=_e.filter(b=>!$e.has(b.imageIndex));te.length>0&&await _(te)}catch(te){const b=te instanceof Error?te.message:"æœªçŸ¥é”™è¯¯";S.push(`æ‰¹æ¬¡ ${T+1} AIç¿»è¯‘å¤±è´¥: ${b}`);for(const J of _e)$e.has(J.imageIndex)||(n.setTranslationStatus(J.imageIndex,"failed",b),$e.add(J.imageIndex))}}for(let he=0;he<_e.length;he++){const te=_e[he];if(!$e.has(te.imageIndex)){for(const b of le){if($e.has(te.imageIndex))break;p.value&&await p.value.acquire();try{const J=De+50+Math.floor(he/_e.length*40);a.setPercentage(J,`å›¾ç‰‡ ${G+he+1}: ${Wt[b]}`),await se(b,te)}catch(J){const ve=J instanceof Error?J.message:"æœªçŸ¥é”™è¯¯";S.push(`å›¾ç‰‡ ${te.imageIndex+1}: ${b} - ${ve}`),n.setTranslationStatus(te.imageIndex,"failed",ve),$e.add(te.imageIndex)}}$e.has(te.imageIndex)||(ie(te),w++,console.log(`âœ… å›¾ç‰‡ ${G+he+1} å¤„ç†å®Œæˆ`))}}W+=$e.size,console.log(`âœ… æ‰¹æ¬¡ ${T+1}/${Y} å¤„ç†å®Œæˆ`)}return{completed:w,failed:W}}async function y(l){if(!E(l))return{success:!1,completed:0,failed:0,errors:["é…ç½®éªŒè¯å¤±è´¥"]};if(n.images.length===0)return i.error("è¯·å…ˆä¸Šä¼ å›¾ç‰‡"),{success:!1,completed:0,failed:0,errors:["æ²¡æœ‰å›¾ç‰‡"]};f=l.mode;const D=z(l.mode);u.value=!0,(l.scope==="all"||l.scope==="failed")&&n.setBatchTranslationInProgress(!0),M(),$();const S=K(l),w=[],W=Pt(),Z=[...vn[l.mode]];W&&Z.push("save"),console.log("ğŸš€ é¡ºåºç®¡çº¿å¯åŠ¨"),console.log(`   æ¨¡å¼: ${l.mode}`),console.log(`   å¤„ç†æ–¹å¼: ${D?"é€å¼ å¤„ç†":"æ‰¹æ¬¡å¤„ç†"}`),console.log(`   æ­¥éª¤é“¾: [${Z.join(" â†’ ")}]`),console.log(`   è‡ªåŠ¨ä¿å­˜: ${W?"å¯ç”¨":"ç¦ç”¨"}`);const Y=S.map(({image:c,index:h})=>{const le={imageIndex:h,image:c,bubbleCoords:[],bubbleAngles:[],bubblePolygons:[],autoDirections:[],textlinesPerBubble:[],originalTexts:[],colors:[],translatedTexts:[],textboxTexts:[]};return l.mode==="proofread"&&c.bubbleStates&&c.bubbleStates.length>0&&(le.bubbleCoords=c.bubbleStates.map(T=>T.coords),le.bubbleAngles=c.bubbleStates.map(T=>T.rotationAngle||0),le.autoDirections=c.bubbleStates.map(T=>T.autoTextDirection||T.textDirection||"vertical"),le.originalTexts=c.bubbleStates.map(T=>T.originalText||""),le.translatedTexts=c.bubbleStates.map(T=>T.translatedText||""),le.textboxTexts=c.bubbleStates.map(T=>T.textboxText||""),le.colors=c.bubbleStates.map(T=>({textColor:T.textColor||"",bgColor:T.fillColor||"",autoFgColor:T.autoFgColor||null,autoBgColor:T.autoBgColor||null})),c.cleanImageData&&(le.cleanImage=c.cleanImageData)),le});try{a.init(S.length,`${l.mode} æ¨¡å¼å¯åŠ¨...`),W&&(a.setPercentage(0,"é¢„ä¿å­˜åŸå§‹å›¾ç‰‡..."),await An({onStart:T=>{a.setPercentage(0,`é¢„ä¿å­˜åŸå§‹å›¾ç‰‡ 0/${T}...`)},onProgress:(T,G)=>{const ce=Math.round(T/G*10);a.setPercentage(ce,`é¢„ä¿å­˜åŸå§‹å›¾ç‰‡ ${T}/${G}...`)},onComplete:()=>{a.setPercentage(10,"é¢„ä¿å­˜å®Œæˆï¼Œå¼€å§‹ç¿»è¯‘...")},onError:T=>{a.setPercentage(0,`é¢„ä¿å­˜å¤±è´¥: ${T}`)}})||i.warning("é¢„ä¿å­˜å¤±è´¥ï¼Œç¿»è¯‘å®Œæˆåè¯·æ‰‹åŠ¨ä¿å­˜"));let c;D?c=await I(Y,Z,l,w):c=await F(Y,Z,l,w),a.setPercentage(100,"å®Œæˆï¼");const h={standard:"ç¿»è¯‘",hq:"é«˜è´¨é‡ç¿»è¯‘",proofread:"AIæ ¡å¯¹",removeText:"æ¶ˆé™¤æ–‡å­—"};return i.success(`${h[l.mode]}å®Œæˆï¼`),{success:c.failed===0,completed:c.completed,failed:c.failed,errors:w.length>0?w:void 0}}catch(c){const h=c instanceof Error?c.message:"æ‰§è¡Œå¤±è´¥";return i.error(h),w.push(h),{success:!1,completed:0,failed:S.length,errors:w}}finally{u.value=!1,n.setBatchTranslationInProgress(!1),W&&await Fn();const c=n.currentImageIndex,h=n.images[c];h?.bubbleStates&&h.bubbleStates.length>0&&t.setBubbles(h.bubbleStates),setTimeout(()=>a.finish(),1e3)}}function m(){n.isBatchTranslationInProgress&&(n.setBatchTranslationInProgress(!1),Un(),i.info("æ“ä½œå·²å–æ¶ˆ"))}return{progress:r,isExecuting:u,isTranslating:P,progressPercent:L,execute:y,cancel:m,STEP_CHAIN_CONFIGS:vn}}class pi{currentCount=0;maxCount;waitQueue=[];holders=[];constructor(t=1){this.maxCount=Math.max(1,t)}setSize(t){this.maxCount=Math.max(1,t),this.tryWakeUp()}getSize(){return this.maxCount}async acquire(t){if(this.currentCount<this.maxCount){this.currentCount++,this.holders.push(t);return}return new Promise(s=>{this.waitQueue.push({resolve:s,poolName:t})})}release(t){const s=this.holders.indexOf(t);s>=0&&(this.holders.splice(s,1),this.currentCount--),this.tryWakeUp()}tryWakeUp(){for(;this.currentCount<this.maxCount&&this.waitQueue.length>0;){const t=this.waitQueue.shift();this.currentCount++,this.holders.push(t.poolName),t.resolve()}}async withLock(t,s){await this.acquire(t);try{return await s()}finally{this.release(t)}}getStatus(){return{isLocked:this.currentCount>=this.maxCount,currentCount:this.currentCount,maxCount:this.maxCount,holders:[...this.holders],waitingCount:this.waitQueue.length,waitingPools:this.waitQueue.map(t=>t.poolName)}}isWaiting(t){return this.waitQueue.some(s=>s.poolName===t)}isHolding(t){return this.holders.includes(t)}reset(){this.currentCount=0,this.holders=[];for(const t of this.waitQueue)t.resolve();this.waitQueue=[]}}class Rt{queue=[];currentTask=null;isRunning=!1;isCancelled=!1;completedCount=0;nextPool;name;icon;lock;progressTracker;onTaskComplete;constructor(t,s,o,i,r,a){this.name=t,this.icon=s,this.nextPool=o,this.lock=i,this.progressTracker=r,this.onTaskComplete=a}getName(){return this.name}getIcon(){return this.icon}setNextPool(t){this.nextPool=t}enqueue(t){this.isCancelled||(this.queue.push(t),this.progressTracker.updatePool(this.name,{waiting:this.queue.length}),this.tryProcessNext())}enqueueBatch(t){if(!this.isCancelled){for(const s of t)this.queue.push(s);this.progressTracker.updatePool(this.name,{waiting:this.queue.length}),this.tryProcessNext()}}async tryProcessNext(){if(!(this.isRunning||this.isCancelled||this.queue.length===0)){this.isRunning=!0,this.currentTask=this.queue.shift(),this.progressTracker.updatePool(this.name,{waiting:this.queue.length,isProcessing:!0,currentPage:this.currentTask.imageIndex+1,isWaitingLock:!1});try{let t;this.lock?(this.progressTracker.updatePool(this.name,{isWaitingLock:!0}),t=await this.lock.withLock(this.name,async()=>(this.progressTracker.updatePool(this.name,{isWaitingLock:!1}),await this.process(this.currentTask)))):t=await this.process(this.currentTask),this.completedCount++,this.progressTracker.updatePool(this.name,{completed:this.completedCount}),this.nextPool&&t.status!=="failed"&&t.status!=="buffered"&&this.nextPool.enqueue(t),this.onTaskComplete?.(t)}catch(t){this.currentTask.status="failed",this.currentTask.error=t.message,console.error(`[${this.name}] å¤„ç†ä»»åŠ¡å¤±è´¥:`,t),this.onTaskComplete?.(this.currentTask)}finally{this.currentTask=null,this.isRunning=!1,this.progressTracker.updatePool(this.name,{isProcessing:!1,currentPage:void 0}),this.tryProcessNext()}}}getStatus(){return{name:this.name,icon:this.icon,waiting:this.queue.length,processing:this.isRunning,currentPage:this.currentTask?.imageIndex,completed:this.completedCount,isWaitingLock:this.lock?.isWaiting(this.name)??!1}}cancel(){this.isCancelled=!0,this.queue=[]}reset(){this.isCancelled=!1,this.queue=[],this.currentTask=null,this.isRunning=!1,this.completedCount=0}getCompletedCount(){return this.completedCount}getWaitingCount(){return this.queue.length}isProcessing(){return this.isRunning}}const mi=[{name:"æ£€æµ‹",icon:"ğŸ“"},{name:"OCR",icon:"ğŸ“–"},{name:"é¢œè‰²",icon:"ğŸ¨"},{name:"ç¿»è¯‘",icon:"ğŸŒ"},{name:"ä¿®å¤",icon:"ğŸ–Œï¸"},{name:"æ¸²æŸ“",icon:"âœ¨"}];class vi{poolStatuses=new Map;totalPages=0;startTime=0;progress=bo({pools:[],totalCompleted:0,totalFailed:0,totalPages:0,estimatedTimeRemaining:0});constructor(){this.initPools()}initPools(){for(const t of mi){const s={name:t.name,icon:t.icon,waiting:0,processing:!1,completed:0,isWaitingLock:!1};this.poolStatuses.set(t.name,s)}this.syncToReactive()}init(t){this.totalPages=t,this.startTime=Date.now();for(const s of this.poolStatuses.values())s.waiting=0,s.processing=!1,s.currentPage=void 0,s.completed=0,s.isWaitingLock=!1;this.progress.totalCompleted=0,this.progress.totalFailed=0,this.progress.totalPages=t,this.progress.estimatedTimeRemaining=0,this.syncToReactive()}updatePool(t,s){const o=this.poolStatuses.get(t);o&&(s.waiting!==void 0&&(o.waiting=s.waiting),s.isProcessing!==void 0&&(o.processing=s.isProcessing),s.currentPage!==void 0&&(o.currentPage=s.currentPage),s.completed!==void 0&&(o.completed=s.completed),s.isWaitingLock!==void 0&&(o.isWaitingLock=s.isWaitingLock),this.syncToReactive(),this.updateEstimatedTime())}incrementCompleted(){this.progress.totalCompleted++,this.updateEstimatedTime()}incrementFailed(){this.progress.totalFailed++}updateEstimatedTime(){if(this.progress.totalCompleted===0){this.progress.estimatedTimeRemaining=0;return}const s=(Date.now()-this.startTime)/1e3/this.progress.totalCompleted,o=this.totalPages-this.progress.totalCompleted-this.progress.totalFailed;this.progress.estimatedTimeRemaining=Math.ceil(s*o)}syncToReactive(){this.progress.pools=Array.from(this.poolStatuses.values()).map(t=>({...t}))}getPoolStatus(t){return this.poolStatuses.get(t)}getAllPoolStatuses(){return Array.from(this.poolStatuses.values())}getProgress(){return{...this.progress}}reset(){this.totalPages=0,this.startTime=0,this.initPools()}formatRemainingTime(){const t=this.progress.estimatedTimeRemaining;if(t<=0)return"--";const s=Math.floor(t/60),o=t%60;return s>0?`${s}åˆ†${o}ç§’`:`${o}ç§’`}}class fi{results=new Map;totalExpected=0;completedCount=0;failedCount=0;resolveWaitAll=null;init(t){this.results.clear(),this.totalExpected=t,this.completedCount=0,this.failedCount=0,this.resolveWaitAll=null}add(t){this.results.set(t.imageIndex,t),t.status==="completed"?this.completedCount++:t.status==="failed"&&this.failedCount++,this.completedCount+this.failedCount>=this.totalExpected&&this.resolveWaitAll&&(this.resolveWaitAll({success:this.completedCount,failed:this.failedCount}),this.resolveWaitAll=null)}waitForAll(t){return this.totalExpected=t,this.completedCount+this.failedCount>=t?Promise.resolve({success:this.completedCount,failed:this.failedCount}):new Promise(s=>{this.resolveWaitAll=s})}get(t){return this.results.get(t)}getAll(){return Array.from(this.results.values()).sort((t,s)=>t.imageIndex-s.imageIndex)}getSuccessful(){return this.getAll().filter(t=>t.status==="completed")}getFailed(){return this.getAll().filter(t=>t.status==="failed")}getStats(){return{total:this.totalExpected,completed:this.completedCount,failed:this.failedCount,pending:this.totalExpected-this.completedCount-this.failedCount}}reset(){this.results.clear(),this.totalExpected=0,this.completedCount=0,this.failedCount=0,this.resolveWaitAll=null}}class bi extends Rt{constructor(t,s,o,i){super("æ£€æµ‹","ğŸ“",t,s,o,i)}async process(t){const{imageData:s}=t,i=ze().settings,r=this.extractBase64(s.originalDataURL),a=await So({image:r,detector_type:i.textDetector,box_expand_ratio:i.boxExpand.ratio,box_expand_top:i.boxExpand.top,box_expand_bottom:i.boxExpand.bottom,box_expand_left:i.boxExpand.left,box_expand_right:i.boxExpand.right});if(!a.success)throw new Error(a.error||"æ£€æµ‹å¤±è´¥");return t.detectionResult={bubbleCoords:a.bubble_coords||[],bubbleAngles:a.bubble_angles||[],bubblePolygons:a.bubble_polygons||[],autoDirections:a.auto_directions||[],rawMask:a.raw_mask,textlinesPerBubble:a.textlines_per_bubble||[]},t.status="processing",t}extractBase64(t){return t.includes("base64,")?t.split("base64,")[1]||"":t}}class hi extends Rt{constructor(t,s,o,i){super("OCR","ğŸ“–",t,s,o,i)}async process(t){const{imageData:s,detectionResult:o}=t,r=ze().settings;if(!o||o.bubbleCoords.length===0)return t.ocrResult={originalTexts:[],textlinesPerBubble:[]},t.status="processing",t;const a=this.extractBase64(s.originalDataURL),u=await ko({image:a,bubble_coords:o.bubbleCoords,source_language:r.sourceLanguage,ocr_engine:r.ocrEngine,baidu_api_key:r.baiduOcr?.apiKey,baidu_secret_key:r.baiduOcr?.secretKey,baidu_version:r.baiduOcr?.version,baidu_ocr_language:r.baiduOcr?.sourceLanguage,ai_vision_provider:r.aiVisionOcr?.provider,ai_vision_api_key:r.aiVisionOcr?.apiKey,ai_vision_model_name:r.aiVisionOcr?.modelName,ai_vision_ocr_prompt:r.aiVisionOcr?.prompt,custom_ai_vision_base_url:r.aiVisionOcr?.customBaseUrl,ai_vision_min_image_size:r.aiVisionOcr?.minImageSize??ds,textlines_per_bubble:o.textlinesPerBubble});if(!u.success)throw new Error(u.error||"OCRå¤±è´¥");return t.ocrResult={originalTexts:u.original_texts||[],textlinesPerBubble:u.textlines_per_bubble||[]},t.status="processing",t}extractBase64(t){return t.includes("base64,")?t.split("base64,")[1]||"":t}}class yi extends Rt{constructor(t,s,o,i){super("é¢œè‰²","ğŸ¨",t,s,o,i)}async process(t){const{imageData:s,detectionResult:o,ocrResult:i}=t;if(!o||o.bubbleCoords.length===0)return t.colorResult={colors:[]},t.status="processing",t;const r=this.extractBase64(s.originalDataURL),a=await wo({image:r,bubble_coords:o.bubbleCoords,textlines_per_bubble:i?.textlinesPerBubble||o.textlinesPerBubble});if(!a.success)throw new Error(a.error||"é¢œè‰²æå–å¤±è´¥");return t.colorResult={colors:a.colors||[]},t.status="processing",t}extractBase64(t){return t.includes("base64,")?t.split("base64,")[1]||"":t}}class xi extends Rt{mode="standard";batchBuffer=[];totalTasks=0;processedCount=0;constructor(t,s,o){super("ç¿»è¯‘","ğŸŒ",t,null,s,o)}setMode(t,s,o){this.mode=t,this.totalTasks=s,this.batchBuffer=[],this.processedCount=0,this.nextPool=o}async process(t){switch(this.mode){case"standard":return this.handleStandardTranslate(t);case"hq":return this.handleHqTranslate(t);case"proofread":return this.handleProofread(t);case"removeText":return this.handleRemoveTextOnly(t);default:return t}}async handleStandardTranslate(t){const o=ze().settings;if(!t.ocrResult||t.ocrResult.originalTexts.length===0)return t.translateResult={translatedTexts:[],textboxTexts:[]},t.status="processing",t;const i=await $o({original_texts:t.ocrResult.originalTexts,target_language:o.targetLanguage,source_language:o.sourceLanguage,model_provider:o.translation.provider,model_name:o.translation.modelName,api_key:o.translation.apiKey,custom_base_url:o.translation.customBaseUrl,prompt_content:o.translatePrompt,textbox_prompt_content:o.textboxPrompt,use_textbox_prompt:o.useTextboxPrompt,rpm_limit:o.translation.rpmLimit,max_retries:o.translation.maxRetries,use_json_format:o.translation.isJsonMode});if(!i.success)throw new Error(i.error||"ç¿»è¯‘å¤±è´¥");return t.translateResult={translatedTexts:i.translated_texts||[],textboxTexts:i.textbox_texts||[]},t.status="processing",t}async handleHqTranslate(t){this.batchBuffer.push(t),this.processedCount++;const s=ze(),{hqTranslation:o}=s.settings,i=o.batchSize||3,r=this.processedCount>=this.totalTasks;if(!(this.batchBuffer.length>=i||r))return t.status="buffered",t;const u=[...this.batchBuffer];this.batchBuffer=[];const p=u.map($=>({imageIndex:$.imageIndex,bubbles:($.ocrResult?.originalTexts||[]).map((j,K)=>({bubbleIndex:K,original:j,translated:"",textDirection:$.detectionResult?.autoDirections[K]||"vertical"}))})),k=u.map($=>this.extractBase64($.imageData.originalDataURL)),f=JSON.stringify(p,null,2),P=[{type:"text",text:o.prompt+`

ä»¥ä¸‹æ˜¯JSONæ•°æ®:
\`\`\`json
`+f+"\n```"}];for(const $ of k)P.push({type:"image_url",image_url:{url:`data:image/png;base64,${$}`}});const L=[{role:"system",content:"ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ¼«ç”»ç¿»è¯‘åŠ©æ‰‹ï¼Œèƒ½å¤Ÿæ ¹æ®æ¼«ç”»å›¾åƒå†…å®¹å’Œä¸Šä¸‹æ–‡æä¾›é«˜è´¨é‡çš„ç¿»è¯‘ã€‚"},{role:"user",content:P}],M=await At({provider:o.provider,api_key:o.apiKey,model_name:o.modelName,custom_base_url:o.customBaseUrl,messages:L,low_reasoning:o.lowReasoning,force_json_output:o.forceJsonOutput,no_thinking_method:o.noThinkingMethod,use_stream:o.useStream,max_retries:o.maxRetries||2}),E=this.parseHqResponse(M,o.forceJsonOutput);for(const $ of u){const j=E?.find(K=>K.imageIndex===$.imageIndex);j?$.translateResult={translatedTexts:j.bubbles.map(K=>K.translated),textboxTexts:[]}:$.translateResult={translatedTexts:[],textboxTexts:[]},$.status="processing",this.nextPool&&this.nextPool.enqueue($)}return t}async handleProofread(t){this.batchBuffer.push(t),this.processedCount++;const s=ze(),{proofreading:o,useTextboxPrompt:i}=s.settings,r=o.rounds[0]?.batchSize||3,a=this.processedCount>=this.totalTasks;if(!(this.batchBuffer.length>=r||a))return t.status="buffered",t;const p=[...this.batchBuffer];this.batchBuffer=[];const k=p.map(L=>({imageIndex:L.imageIndex,bubbles:(L.imageData.bubbleStates||[]).map((M,E)=>({bubbleIndex:E,original:M.originalText||"",translated:i?M.textboxText||M.translatedText||"":M.translatedText||"",textDirection:M.textDirection==="vertical"||M.textDirection==="horizontal"?M.textDirection:M.autoTextDirection==="vertical"||M.autoTextDirection==="horizontal"?M.autoTextDirection:"vertical"}))})),f=p.map(L=>{const M=L.imageData.translatedDataURL||L.imageData.originalDataURL;return this.extractBase64(M)});let P=k;for(const L of o.rounds){const M=JSON.stringify(P,null,2),E=[{type:"text",text:L.prompt+`

ä»¥ä¸‹æ˜¯JSONæ•°æ®:
\`\`\`json
`+M+"\n```"}];for(const U of f)E.push({type:"image_url",image_url:{url:`data:image/png;base64,${U}`}});const $=[{role:"system",content:"ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ¼«ç”»ç¿»è¯‘æ ¡å¯¹åŠ©æ‰‹ï¼Œèƒ½å¤Ÿæ ¹æ®æ¼«ç”»å›¾åƒå†…å®¹æ£€æŸ¥å’Œä¿®æ­£ç¿»è¯‘ã€‚"},{role:"user",content:E}],j=await At({provider:L.provider,api_key:L.apiKey,model_name:L.modelName,custom_base_url:L.customBaseUrl,messages:$,low_reasoning:L.lowReasoning,force_json_output:L.forceJsonOutput,no_thinking_method:L.noThinkingMethod,use_stream:!1,max_retries:L.maxRetries||o.maxRetries||2}),K=this.parseHqResponse(j,L.forceJsonOutput);K&&(P=K)}for(const L of p){const M=P.find(E=>E.imageIndex===L.imageIndex);M?L.translateResult={translatedTexts:M.bubbles.map(E=>E.translated),textboxTexts:[]}:L.translateResult={translatedTexts:[],textboxTexts:[]},L.status="processing",this.nextPool&&this.nextPool.enqueue(L)}return t}async handleRemoveTextOnly(t){return t.translateResult={translatedTexts:[],textboxTexts:[]},t.status="processing",t}extractBase64(t){return t.includes("base64,")?t.split("base64,")[1]||"":t}parseHqResponse(t,s){if(!t.success)return console.error("APIè°ƒç”¨å¤±è´¥:",t.error),null;if(t.results&&t.results.length>0){const i=t.results[0];if(i&&"imageIndex"in i&&"bubbles"in i)return t.results}const o=t.content;if(o)if(s)try{return JSON.parse(o)}catch(i){return console.error("è§£æAIå¼ºåˆ¶JSONè¿”å›çš„å†…å®¹å¤±è´¥:",i),null}else{const i=o.match(/```json\s*([\s\S]*?)\s*```/);if(i?.[1])try{return JSON.parse(i[1])}catch(r){return console.error("è§£æAIè¿”å›çš„JSONå¤±è´¥:",r),null}}return null}}class _i extends Rt{constructor(t,s,o,i){super("ä¿®å¤","ğŸ–Œï¸",t,s,o,i)}async process(t){const{imageData:s,detectionResult:o}=t,r=ze().settings;if(!o||o.bubbleCoords.length===0)return t.inpaintResult={cleanImage:this.extractBase64(s.originalDataURL)},t.status="processing",t;const a=this.extractBase64(s.originalDataURL),u=r.textStyle.inpaintMethod,p=u==="lama_mpe"||u==="litelama",k=await To({image:a,bubble_coords:o.bubbleCoords,bubble_polygons:o.bubblePolygons,raw_mask:o.rawMask,method:p?"lama":"solid",lama_model:p?u:void 0,fill_color:r.textStyle.fillColor,mask_dilate_size:r.preciseMask.dilateSize,mask_box_expand_ratio:r.preciseMask.boxExpandRatio});if(!k.success)throw new Error(k.error||"ä¿®å¤å¤±è´¥");return t.inpaintResult={cleanImage:k.clean_image||""},t.status="processing",t}extractBase64(t){return t.includes("base64,")?t.split("base64,")[1]||"":t}}const ft=bo({pools:[{name:"æ£€æµ‹",icon:"ğŸ“",waiting:0,processing:!1,completed:0,isWaitingLock:!1},{name:"OCR",icon:"ğŸ“–",waiting:0,processing:!1,completed:0,isWaitingLock:!1},{name:"é¢œè‰²",icon:"ğŸ¨",waiting:0,processing:!1,completed:0,isWaitingLock:!1},{name:"ç¿»è¯‘",icon:"ğŸŒ",waiting:0,processing:!1,completed:0,isWaitingLock:!1},{name:"ä¿®å¤",icon:"ğŸ–Œï¸",waiting:0,processing:!1,completed:0,isWaitingLock:!1},{name:"æ¸²æŸ“",icon:"âœ¨",waiting:0,processing:!1,completed:0,isWaitingLock:!1}],totalCompleted:0,totalFailed:0,totalPages:0,estimatedTimeRemaining:0,preSave:void 0,save:void 0}),Ci=C(!1);function Ro(){const n=et(),t=ze(),s=bs(null),o=Q(()=>t.settings.parallel),i=Q(()=>o.value?.enabled??!1),r=Ci,a=Q(()=>ft);function u(){const L=t.settings;return L.proofreading?.enabled&&L.proofreading.rounds.length>0?"proofread":["gemini","openai","claude","deepseek"].includes(L.hqTranslation?.provider||"")&&L.hqTranslation?.apiKey?"hq":"standard"}function p(){if(!s.value)return;const L=s.value.progress;L&&(ft.pools=L.pools.map(M=>({...M})),ft.totalCompleted=L.totalCompleted,ft.totalFailed=L.totalFailed,ft.totalPages=L.totalPages,ft.estimatedTimeRemaining=L.estimatedTimeRemaining)}async function k(L,M,E=0){if(r.value)return{success:0,failed:0,errors:["ç¿»è¯‘æ­£åœ¨è¿›è¡Œä¸­"]};const $=M??n.images;if($.length===0)return{success:0,failed:0,errors:["æ²¡æœ‰å›¾ç‰‡"]};r.value=!0,ft.totalPages=$.length,ft.totalCompleted=0,ft.totalFailed=0;const j=setInterval(p,200);try{s.value=wi({enabled:!0,deepLearningLockSize:o.value?.deepLearningLockSize??1});const K=L??u();console.log(`ğŸš€ å¼€å§‹å¹¶è¡Œç¿»è¯‘ï¼Œæ¨¡å¼: ${K}ï¼Œå›¾ç‰‡æ•°: ${$.length}ï¼Œèµ·å§‹ç´¢å¼•: ${E}`);const U=await s.value.execute($,K,E);return p(),console.log(`âœ… å¹¶è¡Œç¿»è¯‘å®Œæˆï¼ŒæˆåŠŸ: ${U.success}ï¼Œå¤±è´¥: ${U.failed}`),U}catch(K){return console.error("å¹¶è¡Œç¿»è¯‘å‡ºé”™:",K),{success:0,failed:$.length,errors:[K.message]}}finally{clearInterval(j),r.value=!1}}function f(){s.value&&s.value.cancel(),r.value=!1}function P(){s.value=null,r.value=!1}return{isEnabled:i,isRunning:r,progress:a,executeParallel:k,cancel:f,reset:P,determineMode:u}}class Si extends Rt{resultCollector;constructor(t,s,o){super("æ¸²æŸ“","âœ¨",null,null,t,o),this.resultCollector=s}async process(t){const s=et(),o=gt(),i=ze(),r=this.buildBubbleStates(t,i);if(r.length===0){const p=t.inpaintResult?.cleanImage||t.imageData.cleanImageData||this.extractBase64(t.imageData.originalDataURL);return t.renderResult={finalImage:p,bubbleStates:[]},t.status="completed",this.updateImageToUI(t,s,o,i),this.resultCollector.add(t),t}const a=t.inpaintResult?.cleanImage||t.imageData.cleanImageData||this.extractBase64(t.imageData.translatedDataURL||t.imageData.originalDataURL),u=await Io({clean_image:a,bubble_states:r,fontSize:i.settings.textStyle.fontSize,fontFamily:i.settings.textStyle.fontFamily,textDirection:i.settings.textStyle.layoutDirection,textColor:i.settings.textStyle.textColor,strokeEnabled:i.settings.textStyle.strokeEnabled,strokeColor:i.settings.textStyle.strokeColor,strokeWidth:i.settings.textStyle.strokeWidth,autoFontSize:i.settings.textStyle.autoFontSize,use_individual_styles:!0});if(!u.success)throw new Error(u.error||"æ¸²æŸ“å¤±è´¥");return t.renderResult={finalImage:u.final_image||"",bubbleStates:u.bubble_states||r},t.status="completed",this.updateImageToUI(t,s,o,i),this.resultCollector.add(t),t}updateImageToUI(t,s,o,i){const r=t.imageIndex,a=(t.detectionResult?.bubbleCoords||[]).map(u=>u.length>=4?[u[0],u[1],u[2],u[3]]:[0,0,0,0]);s.updateImageByIndex(r,{translatedDataURL:`data:image/png;base64,${t.renderResult.finalImage}`,cleanImageData:t.inpaintResult?.cleanImage||null,bubbleStates:t.renderResult.bubbleStates,bubbleCoords:a,bubbleAngles:t.detectionResult?.bubbleAngles||[],originalTexts:t.ocrResult?.originalTexts||[],bubbleTexts:t.translateResult?.translatedTexts||[],textboxTexts:t.translateResult?.textboxTexts||[],translationStatus:"completed",translationFailed:!1,showOriginal:!1,hasUnsavedChanges:!0,layoutDirection:i.settings.textStyle.layoutDirection,autoFontSize:i.settings.textStyle.autoFontSize,useAutoTextColor:i.settings.textStyle.useAutoTextColor}),r===s.currentImageIndex&&t.renderResult?.bubbleStates&&o.setBubbles(t.renderResult.bubbleStates),this.progressTracker.incrementCompleted(),Pt()&&Ln(r).catch(u=>{console.error(`[RenderPool] è‡ªåŠ¨ä¿å­˜å›¾ç‰‡ ${r+1} å¤±è´¥:`,u)}).finally(()=>{const{progress:u}=Ro(),p=u.value;p.save&&(p.save.completed=(p.save.completed||0)+1)}),console.log(`âœ… å›¾ç‰‡ ${r+1} æ¸²æŸ“å®Œæˆ`)}buildBubbleStates(t,s){if(!t.detectionResult&&t.imageData.bubbleStates&&t.imageData.bubbleStates.length>0){const P=t.translateResult?.translatedTexts||[];return t.imageData.bubbleStates.map((L,M)=>({...L,translatedText:P[M]||L.translatedText||""}))}if(t.detectionResult&&!t.translateResult)return console.log(`[æ¸²æŸ“æ± ] å›¾ç‰‡ ${t.imageIndex+1}: æ£€æµ‹åˆ°æ¶ˆé™¤æ–‡å­—æ¨¡å¼ï¼ˆæ— ç¿»è¯‘ç»“æœï¼‰ï¼Œè·³è¿‡æ¸²æŸ“`),[];const o=t.detectionResult?.bubbleCoords||[],i=t.translateResult?.translatedTexts||[],r=t.ocrResult?.originalTexts||[],a=t.colorResult?.colors||[],u=t.detectionResult?.bubbleAngles||[],p=t.detectionResult?.autoDirections||[],k=t.detectionResult?.bubblePolygons||[],f=s.settings;return o.map((P,L)=>{const M=p[L],E=M==="v"?"vertical":M==="h"?"horizontal":"vertical",$=f.textStyle.layoutDirection,j=$==="vertical"||$==="horizontal"?$:E;let K=f.textStyle.textColor,U=f.textStyle.fillColor;const g=a[L];return f.textStyle.useAutoTextColor&&g&&(g.textColor&&(K=g.textColor),g.bgColor&&(U=g.bgColor)),{originalText:r[L]||"",translatedText:i[L]||"",textboxText:"",coords:P.length>=4?[P[0],P[1],P[2],P[3]]:[0,0,0,0],polygon:k[L]||[],fontSize:f.textStyle.fontSize,fontFamily:f.textStyle.fontFamily,textDirection:j,autoTextDirection:E,textColor:K,fillColor:U,rotationAngle:u[L]||0,position:{x:0,y:0},strokeEnabled:f.textStyle.strokeEnabled,strokeColor:f.textStyle.strokeColor,strokeWidth:f.textStyle.strokeWidth,inpaintMethod:f.textStyle.inpaintMethod,autoFgColor:g?.autoFgColor||null,autoBgColor:g?.autoBgColor||null}})}extractBase64(t){return t.includes("base64,")?t.split("base64,")[1]||"":t}}const fn={standard:["detection","ocr","color","translate","inpaint","render"],hq:["detection","ocr","color","translate","inpaint","render"],proofread:["translate","render"],removeText:["detection","inpaint","render"]};class ki{lock;progressTracker;resultCollector;detectionPool;ocrPool;colorPool;translatePool;inpaintPool;renderPool;isCancelled=!1;config;constructor(t){this.config=t,this.lock=new pi(t.deepLearningLockSize),this.progressTracker=new vi,this.resultCollector=new fi,this.renderPool=new Si(this.progressTracker,this.resultCollector),this.inpaintPool=new _i(this.renderPool,this.lock,this.progressTracker),this.translatePool=new xi(this.inpaintPool,this.progressTracker),this.colorPool=new yi(this.translatePool,this.lock,this.progressTracker),this.ocrPool=new hi(this.colorPool,this.lock,this.progressTracker),this.detectionPool=new bi(this.ocrPool,this.lock,this.progressTracker)}updateConfig(t){t.deepLearningLockSize!==void 0&&(this.lock.setSize(t.deepLearningLockSize),this.config.deepLearningLockSize=t.deepLearningLockSize),t.enabled!==void 0&&(this.config.enabled=t.enabled)}async execute(t,s,o=0){this.reset(),this.progressTracker.init(t.length),this.resultCollector.init(t.length),this.setupPoolChain(s,t.length);const i=t.map((u,p)=>({id:`task-${o+p}`,imageIndex:o+p,imageData:u,status:"pending"})),r=this.getEntryPool(s);for(const u of i)r.enqueue(u);const a=await this.resultCollector.waitForAll(t.length);return{success:a.success,failed:a.failed,errors:this.resultCollector.getFailed().map(u=>u.error||"æœªçŸ¥é”™è¯¯")}}setupPoolChain(t,s){const o=fn[t],i=this.getPoolMap();for(let p=0;p<o.length-1;p++){const k=o[p],f=o[p+1],P=i[k],L=i[f];P&&L&&P.setNextPool(L)}const r=o[o.length-1],a=i[r];a&&a.setNextPool(null);const u=o.indexOf("translate");if(u>=0&&u<o.length-1){const p=o[u+1];this.translatePool.setMode(t,s,i[p]||null)}else u===o.length-1&&this.translatePool.setMode(t,s,null)}getPoolMap(){return{detection:this.detectionPool,ocr:this.ocrPool,color:this.colorPool,translate:this.translatePool,inpaint:this.inpaintPool,render:this.renderPool}}getEntryPool(t){const o=fn[t][0];return this.getPoolMap()[o]||this.detectionPool}cancel(){this.isCancelled=!0,this.detectionPool.cancel(),this.ocrPool.cancel(),this.colorPool.cancel(),this.translatePool.cancel(),this.inpaintPool.cancel(),this.renderPool.cancel(),this.lock.reset()}reset(){this.isCancelled=!1,this.detectionPool.reset(),this.ocrPool.reset(),this.colorPool.reset(),this.translatePool.reset(),this.inpaintPool.reset(),this.renderPool.reset(),this.resultCollector.reset(),this.progressTracker.reset()}get progress(){return this.progressTracker.progress}getProgressTracker(){return this.progressTracker}getLockStatus(){return this.lock.getStatus()}get cancelled(){return this.isCancelled}}function wi(n){return new ki(n)}function $i(){const n=et(),t=ze(),s=ct(),o=gi(),i=Ro(),r=Q(()=>o.isTranslating.value||n.isBatchTranslationInProgress),a=Q(()=>o.progressPercent.value);async function u(f){if(n.images.length===0)return s.error("è¯·å…ˆä¸Šä¼ å›¾ç‰‡"),{success:!1,completed:0,failed:0,errors:["æ²¡æœ‰å›¾ç‰‡"]};const P=t.settings.parallel,L=f.scope==="all"||f.scope==="range";return P?.enabled&&L?(console.log(`ğŸš€ ä½¿ç”¨å¹¶è¡Œç®¡çº¿ï¼Œæ¨¡å¼: ${f.mode}, èŒƒå›´: ${f.scope}`),p(f)):(console.log(`ğŸš€ ä½¿ç”¨é¡ºåºç®¡çº¿ï¼Œæ¨¡å¼: ${f.mode}`),o.execute(f))}async function p(f){let P=n.images,L=0;if(f.scope==="range"&&f.pageRange){L=Math.max(0,f.pageRange.startPage-1);const E=Math.min(n.images.length-1,f.pageRange.endPage-1);if(L<=E&&L<n.images.length)P=n.images.slice(L,E+1),console.log(`ğŸ¯ å¹¶è¡Œç¿»è¯‘èŒƒå›´: ç¬¬ ${f.pageRange.startPage} è‡³ ${f.pageRange.endPage} é¡µï¼Œå…± ${P.length} å¼ ï¼Œèµ·å§‹ç´¢å¼• ${L}`);else return s.error("æ— æ•ˆçš„é¡µé¢èŒƒå›´"),{success:!1,completed:0,failed:0,errors:["æ— æ•ˆçš„é¡µé¢èŒƒå›´"]}}const M=Pt();try{if(i.progress.value.totalPages=P.length,i.progress.value.totalCompleted=0,i.progress.value.totalFailed=0,M&&(console.log("[ParallelPipeline] æ‰§è¡Œé¢„ä¿å­˜..."),s.info("å¼€å§‹é¢„ä¿å­˜åŸå§‹å›¾ç‰‡..."),!await An({onStart:K=>{const U=i.progress.value;U.preSave={isRunning:!0,current:0,total:K}},onProgress:(K,U)=>{const g=i.progress.value;g.preSave&&(g.preSave.current=K,g.preSave.total=U)},onComplete:()=>{const K=i.progress.value;K.preSave&&(K.preSave.isRunning=!1),s.success("é¢„ä¿å­˜å®Œæˆï¼Œå¼€å§‹ç¿»è¯‘...")},onError:K=>{const U=i.progress.value;U.preSave=void 0,s.warning(`é¢„ä¿å­˜å¤±è´¥ï¼š${K}ï¼Œç¿»è¯‘å®Œæˆåè¯·æ‰‹åŠ¨ä¿å­˜`)}}))){const K=i.progress.value;K.preSave=void 0}const E=f.mode;if(console.log(`ğŸš€ å¯åŠ¨å¹¶è¡Œç¿»è¯‘æ¨¡å¼: ${E}`),console.log(`   å›¾ç‰‡æ•°é‡: ${P.length}`),console.log(`   èµ·å§‹ç´¢å¼•: ${L}`),console.log(`   è‡ªåŠ¨ä¿å­˜: ${M?"å¯ç”¨":"ç¦ç”¨"}`),M){const j=i.progress.value;j.save={completed:0,total:P.length}}const $=await i.executeParallel(E,P,L);return $.success>0&&$.failed===0?s.success(`å¹¶è¡Œç¿»è¯‘å®Œæˆï¼ŒæˆåŠŸå¤„ç† ${$.success} å¼ å›¾ç‰‡`):$.success>0&&$.failed>0?s.warning(`å¹¶è¡Œç¿»è¯‘å®Œæˆï¼ŒæˆåŠŸ ${$.success} å¼ ï¼Œå¤±è´¥ ${$.failed} å¼ `):s.error("å¹¶è¡Œç¿»è¯‘å¤±è´¥"),{success:$.failed===0,completed:$.success,failed:$.failed,errors:$.errors}}catch(E){const $=E instanceof Error?E.message:"å¹¶è¡Œç¿»è¯‘å‡ºé”™";return s.error($),{success:!1,completed:0,failed:P.length,errors:[$]}}finally{const E=i.progress.value;E.preSave=void 0,E.save=void 0,M&&(console.log("[ParallelPipeline] å®Œæˆä¿å­˜..."),await Fn())}}function k(){o.cancel(),i.cancel(),Un()}return{progress:o.progress,isExecuting:o.isExecuting,isTranslating:r,progressPercent:a,execute:u,cancel:k,STEP_CHAIN_CONFIGS:o.STEP_CHAIN_CONFIGS}}function bn(n="current",t){return{mode:"standard",scope:n,pageRange:t?.pageRange}}function Ti(n="all",t){return{mode:"hq",scope:n,pageRange:t?.pageRange,batchOptions:{batchSize:t?.batchSize??3,maxRetries:t?.maxRetries??2,rpmLimit:t?.rpmLimit??10,sessionResetFrequency:t?.sessionResetFrequency??5}}}function Ii(n="all",t){return{mode:"proofread",scope:n,pageRange:t?.pageRange,batchOptions:{batchSize:t?.batchSize??3,maxRetries:t?.maxRetries??2,rpmLimit:t?.rpmLimit??10,sessionResetFrequency:t?.sessionResetFrequency??5}}}function Pi(n="current",t){return{mode:"removeText",scope:n,pageRange:t?.pageRange}}function Ri(n){if(n.length===0)return{startPage:1,endPage:0};const t=[...n].sort((i,r)=>i-r),s=t[0],o=t[t.length-1];return{startPage:(s??0)+1,endPage:(o??0)+1}}function bt(n,t){const s=[];for(let o=n;o<t;o++)s.push(o);return s}function Do(){const n=et(),t=gt(),s=ct(),o=$i(),i=o.progress,r=o.isExecuting,a=o.isTranslating,u=o.progressPercent,p=Q(()=>o.isExecuting.value),k=Q(()=>o.isExecuting.value);async function f(V,se){if(V.length===0)return s.error("æ²¡æœ‰æŒ‡å®šè¦ç¿»è¯‘çš„é¡µé¢"),{success:!1,completed:0,failed:0,errors:["æ²¡æœ‰æŒ‡å®šè¦ç¿»è¯‘çš„é¡µé¢"]};const X=n.images.length;if(X===0)return s.error("è¯·å…ˆä¸Šä¼ å›¾ç‰‡"),{success:!1,completed:0,failed:0,errors:["è¯·å…ˆä¸Šä¼ å›¾ç‰‡"]};for(const F of V)if(F<0||F>=X)return s.error(`æ— æ•ˆçš„é¡µé¢ç´¢å¼•: ${F}`),{success:!1,completed:0,failed:0,errors:[`æ— æ•ˆçš„é¡µé¢ç´¢å¼•: ${F}`]};const ie=V.length===1,z=V.length===X;let R;if(ie){const F=n.currentImageIndex,y=V[0];y!==void 0&&n.setCurrentImageIndex(y),R=P(se,"current");const m=await o.execute(R);return n.setCurrentImageIndex(F),{success:m.success,completed:m.completed,failed:m.failed,errors:m.errors??[]}}else if(z)R=P(se,"all");else{const F=Ri(V);R=P(se,"range",F)}const I=await o.execute(R);return{success:I.success,completed:I.completed,failed:I.failed,errors:I.errors??[]}}function P(V,se,X){switch(V){case"standard":return bn(se,X?{pageRange:X}:void 0);case"hq":return Ti(se,X?{pageRange:X}:void 0);case"proofread":return Ii(se,X?{pageRange:X}:void 0);case"removeText":return Pi(se,X?{pageRange:X}:void 0);default:return bn(se,X?{pageRange:X}:void 0)}}async function L(){return(await f([n.currentImageIndex],"standard")).success}async function M(V){return(await f([V],"standard")).success}async function E(){return(await f(bt(0,n.images.length),"standard")).success}async function $(V){const se=bt(V.startPage-1,V.endPage);return(await f(se,"standard")).success}function j(){o.cancel()}async function K(){return(await f([n.currentImageIndex],"removeText")).success}async function U(){return(await f(bt(0,n.images.length),"removeText")).success}async function g(V){const se=bt(V.startPage-1,V.endPage);return(await f(se,"removeText")).success}async function d(){const V=n.getFailedImageIndices();return V.length===0?(s.info("æ²¡æœ‰å¤±è´¥çš„å›¾ç‰‡éœ€è¦é‡æ–°ç¿»è¯‘"),!0):(await f(V,"standard")).success}async function x(V){const se=V?bt(V.startPage-1,V.endPage):bt(0,n.images.length);return(await f(se,"hq")).success}async function _(V){const se=V?bt(V.startPage-1,V.endPage):bt(0,n.images.length);return(await f(se,"proofread")).success}async function q(){if(!n.currentImage)return s.error("è¯·å…ˆä¸Šä¼ å›¾ç‰‡"),!1;const se=t.bubbles;return!se||se.length===0?(s.error("å½“å‰å›¾ç‰‡æ²¡æœ‰æ°”æ³¡æ¡†ï¼Œè¯·å…ˆæ£€æµ‹æˆ–æ‰‹åŠ¨æ·»åŠ "),!1):(n.setManuallyAnnotated(!0),L())}return{progress:i,isTranslatingSingle:r,isHqTranslating:p,isProofreading:k,isTranslating:a,progressPercent:u,translatePages:f,range:bt,translateCurrentImage:L,translateImageByIndex:M,translateAllImages:E,translateImageRange:$,cancelBatchTranslation:j,removeTextOnly:K,removeAllTexts:U,removeTextRange:g,retryFailedImages:d,executeHqTranslation:x,executeProofreading:_,translateWithCurrentBubbles:q}}function Di(){const n=gt(),t=et(),s=C(!1);function o(){if(!s.value)return;const i=t.currentImage;n.bubbleCount>0?t.updateCurrentBubbleStates([...n.bubbles]):i&&Array.isArray(i.bubbleStates)&&i.bubbleStates.length>0&&(t.updateCurrentBubbleStates([]),console.log("é€€å‡ºç¼–è¾‘æ¨¡å¼ï¼ˆæ— é‡æ¸²æŸ“ï¼‰ï¼Œç”¨æˆ·å·²åˆ é™¤æ‰€æœ‰æ°”æ³¡")),s.value=!1,n.clearSelection(),console.log("å·²é€€å‡ºç¼–è¾‘æ¨¡å¼ï¼ˆæ— é‡æ¸²æŸ“ï¼‰")}return{isActive:s,exitEditModeWithoutRender:o}}function Mi(){const n=Cn(),t=ze(),s=et(),o=It(),i=gt(),r=Di(),a=C(!1),u=C(!1),p=C(null),k=C([]),f=C([]),P=C([]),L=C(null),M=C(null),E=C(null),$=C(null),j=C(!1);async function K(z=!1){if(!z&&(a.value||u.value)){console.log("[TranslateInit] å·²ç»åˆå§‹åŒ–ï¼Œä»…é‡æ–°åŠ è½½ä¸Šä¸‹æ–‡"),await _();return}console.log("[TranslateInit] å¼€å§‹åˆå§‹åŒ–åº”ç”¨..."),a.value=!0,p.value=null;try{await U(),await g(),await d(),await x(),await _(),console.log("[TranslateInit] åº”ç”¨åˆå§‹åŒ–å®Œæˆ"),u.value=!0}catch(R){console.error("[TranslateInit] åº”ç”¨åˆå§‹åŒ–å¤±è´¥:",R),p.value=R instanceof Error?R.message:"åˆå§‹åŒ–å¤±è´¥"}finally{a.value=!1}}async function U(){console.log("[TranslateInit] åˆå§‹åŒ–è®¾ç½®..."),t.initSettings();try{const z=await t.loadFromBackend();console.log(z?"[TranslateInit] å·²ä»åç«¯åŠ è½½è®¾ç½®":"[TranslateInit] åç«¯æ— è®¾ç½®ï¼Œä½¿ç”¨ localStorage æ•°æ®")}catch(z){console.warn("[TranslateInit] ä»åç«¯åŠ è½½è®¾ç½®å¤±è´¥ï¼Œä½¿ç”¨ localStorage æ•°æ®:",z)}console.log("[TranslateInit] è®¾ç½®åˆå§‹åŒ–å®Œæˆ")}async function g(){console.log("[TranslateInit] åˆå§‹åŒ–å­—ä½“åˆ—è¡¨...");try{const z=await $n();z.fonts&&z.fonts.length>0?(k.value=z.fonts,console.log(`[TranslateInit] å·²åŠ è½½ ${z.fonts.length} ä¸ªå­—ä½“`)):z.error?console.warn("[TranslateInit] è·å–å­—ä½“åˆ—è¡¨å¤±è´¥:",z.error):console.warn("[TranslateInit] å­—ä½“åˆ—è¡¨ä¸ºç©º")}catch(z){console.error("[TranslateInit] è·å–å­—ä½“åˆ—è¡¨å¤±è´¥:",z)}}async function d(){console.log("[TranslateInit] åˆå§‹åŒ–ç¿»è¯‘æç¤ºè¯è®¾ç½®...");try{const z=await Ms();z.prompt_names!==void 0?(f.value=z.prompt_names||[],!t.settings.translatePrompt&&z.default_prompt_content&&t.setTranslatePrompt(z.default_prompt_content),console.log(`[TranslateInit] å·²åŠ è½½ ${f.value.length} ä¸ªç¿»è¯‘æç¤ºè¯`)):z.error&&console.warn("[TranslateInit] è·å–ç¿»è¯‘æç¤ºè¯å¤±è´¥:",z.error)}catch(z){console.error("[TranslateInit] è·å–ç¿»è¯‘æç¤ºè¯å¤±è´¥:",z)}}async function x(){console.log("[TranslateInit] åˆå§‹åŒ–æ–‡æœ¬æ¡†æç¤ºè¯è®¾ç½®...");try{const z=await Ds();z.prompt_names!==void 0?(P.value=z.prompt_names||[],!t.settings.textboxPrompt&&z.default_prompt_content&&t.setTextboxPrompt(z.default_prompt_content),console.log(`[TranslateInit] å·²åŠ è½½ ${P.value.length} ä¸ªæ–‡æœ¬æ¡†æç¤ºè¯`)):z.error&&console.warn("[TranslateInit] è·å–æ–‡æœ¬æ¡†æç¤ºè¯å¤±è´¥:",z.error)}catch(z){console.error("[TranslateInit] è·å–æ–‡æœ¬æ¡†æç¤ºè¯å¤±è´¥:",z)}}async function _(){const z=n.query.book,R=n.query.chapter;if(!z||!R){console.log("[TranslateInit] æœªæŒ‡å®šä¹¦ç±/ç« èŠ‚å‚æ•°ï¼Œä½¿ç”¨ç‹¬ç«‹æ¨¡å¼"),j.value=!1,L.value=null,M.value=null,E.value=null,$.value=null,o.clearContext();return}console.log(`[TranslateInit] æ£€æµ‹åˆ°ä¹¦ç±/ç« èŠ‚å‚æ•°: book=${z}, chapter=${R}`),j.value=!0,L.value=z,M.value=R;try{const I=await Bs(z);if(!I.success||!I.book){console.warn("[TranslateInit] ä¹¦ç±ä¸å­˜åœ¨:",z),xe("ä¹¦ç±ä¸å­˜åœ¨","warning");return}const F=I.book,y=F.chapters?.find(m=>m.id===R);if(!y){console.warn("[TranslateInit] ç« èŠ‚ä¸å­˜åœ¨:",R),xe("ç« èŠ‚ä¸å­˜åœ¨","warning");return}if(E.value=F.title,$.value=y.title,o.setBookChapterContext(z,R,F.title,y.title),typeof document<"u"&&(document.title=`${y.title} - ${F.title} - Saber-Translator`),y.session_path){console.log(`[TranslateInit] å°è¯•åŠ è½½ç« èŠ‚ä¼šè¯: ${y.session_path}`);try{await o.loadSessionByPath(y.session_path),xe(`å·²åŠ è½½ç« èŠ‚: ${y.title}`,"success")}catch{console.log("[TranslateInit] ç« èŠ‚ä¼šè¯æ•°æ®ä¸å­˜åœ¨æˆ–åŠ è½½å¤±è´¥ï¼Œå°†åˆ›å»ºæ–°ä¼šè¯")}}}catch(I){console.error("[TranslateInit] åŠ è½½ä¹¦ç±/ç« èŠ‚ä¿¡æ¯å¤±è´¥:",I),xe("åŠ è½½ä¹¦ç±ä¿¡æ¯å¤±è´¥","error")}}function q(z){if(z<0||z>=s.imageCount){console.warn(`[TranslateInit] æ— æ•ˆçš„å›¾ç‰‡ç´¢å¼•: ${z}`);return}window._isChangingFromSwitchImage=!0,r.isActive.value&&r.exitEditModeWithoutRender(),s.currentImage&&i.bubbles.length>0&&s.updateCurrentImageProperty("bubbleStates",i.bubbles),s.setCurrentImageIndex(z);const I=s.currentImage;if(!I){console.warn("[TranslateInit] åˆ‡æ¢åˆ°çš„å›¾ç‰‡ä¸å­˜åœ¨"),window._isChangingFromSwitchImage=!1;return}console.log(`[TranslateInit] åˆ‡æ¢åˆ°å›¾ç‰‡: ${z}, ${I.fileName}`),I.bubbleStates&&I.bubbleStates.length>0?i.setBubbles(I.bubbleStates,!0):i.clearBubblesLocal(),V(I),setTimeout(()=>{window._isChangingFromSwitchImage=!1,console.log("[TranslateInit] å·²é‡ç½®åˆ‡æ¢å›¾ç‰‡æ“ä½œæ ‡è®°")},100)}function V(z){if(!z)return;const R=z.bubbleStates?.[0];R&&t.updateTextStyle({fontSize:R.fontSize||t.settings.textStyle.fontSize,fontFamily:R.fontFamily||t.settings.textStyle.fontFamily,layoutDirection:z.layoutDirection||t.settings.textStyle.layoutDirection,textColor:R.textColor||t.settings.textStyle.textColor,fillColor:R.fillColor||t.settings.textStyle.fillColor,strokeEnabled:R.strokeEnabled??t.settings.textStyle.strokeEnabled,strokeColor:R.strokeColor||t.settings.textStyle.strokeColor,strokeWidth:R.strokeWidth||t.settings.textStyle.strokeWidth,inpaintMethod:R.inpaintMethod||t.settings.textStyle.inpaintMethod,autoFontSize:z.autoFontSize??t.settings.textStyle.autoFontSize,useAutoTextColor:z.useAutoTextColor??t.settings.textStyle.useAutoTextColor})}function se(){s.canGoPrevious&&q(s.currentImageIndex-1)}function X(){s.canGoNext&&q(s.currentImageIndex+1)}function ie(){dt(async()=>{await K()})}return{isInitializing:a,isInitialized:u,initError:p,fontList:k,promptNames:f,textboxPromptNames:P,currentBookId:L,currentChapterId:M,currentBookTitle:E,currentChapterTitle:$,isBookshelfMode:j,initializeApp:K,initializeSettings:U,initializeFontList:g,initializePromptSettings:d,initializeTextboxPromptSettings:x,initializeBookChapterContext:_,switchImage:q,goToPrevious:se,goToNext:X,loadImageSettingsToStore:V,editMode:r,setupAutoInit:ie}}const Ei={key:0,id:"translationProgressBar",class:"translation-progress-bar"},Bi={class:"parallel-header"},Ai={class:"header-title"},Li={key:0,class:"presave-section"},Fi={class:"presave-label"},Ui={class:"presave-progress-bar"},Oi={class:"pools-list"},zi={class:"pool-label"},Ni={class:"pool-icon"},Vi={class:"pool-name"},Wi={class:"pool-progress-bar"},Ki={class:"pool-stats"},qi={class:"completed-count"},Hi={class:"total-count"},ji={key:0,class:"waiting-badge"},Ji={key:1,class:"lock-indicator",title:"ç­‰å¾…æ·±åº¦å­¦ä¹ é”"},Yi={key:0,class:"pool-row save-row"},Xi={class:"pool-progress-bar"},Gi={class:"pool-stats"},Zi={class:"completed-count"},Qi={class:"total-count"},er={class:"overall-section"},tr={class:"overall-label"},or={key:0,class:"failed-text"},nr={class:"overall-progress-bar"},sr={class:"progress-bar-label"},ar={key:0,class:"failed-count"},lr={class:"progress-bar"},ir=je({__name:"TranslationProgress",props:{progress:{}},setup(n){const t=n,s=et(),o=ze(),i=Do(),r=Ro(),a=Q(()=>{const d=r.progress.value?.preSave?.isRunning;return o.settings.parallel?.enabled&&(r.isRunning.value||d)}),u=Q(()=>r.progress.value),p=Q(()=>{const d=u.value;return!d||d.totalPages===0?0:Math.round(d.totalCompleted/d.totalPages*100)});function k(d){const x=u.value?.totalPages||0;return x===0?0:Math.round(d.completed/x*100)}function f(){const d=u.value?.totalPages||0;return d===0?0:Math.max(3,Math.round(1/d*100))}function P(){const d=u.value?.preSave;return!d||d.total===0?0:Math.round(d.current/d.total*100)}function L(){const d=u.value?.save;return!d||d.total===0?0:Math.round(d.completed/d.total*100)}const M=Q(()=>t.progress||i.progress.value),E=Q(()=>M.value.isInProgress||s.isBatchTranslationInProgress||a.value),$=Q(()=>M.value.current),j=Q(()=>M.value.total),K=Q(()=>M.value.failed),U=Q(()=>M.value.percentage!==void 0?M.value.percentage:j.value===0?0:Math.round($.value/j.value*100)),g=Q(()=>M.value.label?M.value.label:`ç¿»è¯‘ä¸­ï¼š${$.value} / ${j.value}`);return(d,x)=>E.value?(B(),A("div",Ei,[a.value&&u.value?(B(),A(Oe,{key:0},[e("div",Bi,[e("span",Ai,"ğŸš€ å¹¶è¡Œç¿»è¯‘ä¸­ï¼š"+oe(u.value.totalCompleted)+"/"+oe(u.value.totalPages),1)]),u.value.preSave?.isRunning?(B(),A("div",Li,[e("div",Fi," ğŸ“¥ é¢„ä¿å­˜åŸå§‹å›¾ç‰‡ï¼š"+oe(u.value.preSave.current)+"/"+oe(u.value.preSave.total),1),e("div",Ui,[e("div",{class:"presave-progress-fill",style:at({width:P()+"%"})},null,4)])])):de("",!0),e("div",Oi,[(B(!0),A(Oe,null,Ye(u.value.pools,_=>(B(),A("div",{key:_.name,class:Ie(["pool-row",{"pool-processing":_.processing,"pool-waiting-lock":_.isWaitingLock}])},[e("div",zi,[e("span",Ni,oe(_.icon),1),e("span",Vi,oe(_.name),1)]),e("div",Wi,[e("div",{class:"progress-completed",style:at({width:k(_)+"%"})},null,4),_.processing?(B(),A("div",{key:0,class:"progress-processing",style:at({left:k(_)+"%",width:f()+"%"})},null,4)):de("",!0)]),e("div",Ki,[e("span",qi,oe(_.completed),1),e("span",Hi,"/ "+oe(u.value.totalPages),1),_.waiting>0?(B(),A("span",ji,"+"+oe(_.waiting),1)):de("",!0),_.isWaitingLock?(B(),A("span",Ji,"ğŸ”’")):de("",!0)])],2))),128)),u.value.save?(B(),A("div",Yi,[x[0]||(x[0]=e("div",{class:"pool-label"},[e("span",{class:"pool-icon"},"ğŸ’¾"),e("span",{class:"pool-name"},"ä¿å­˜")],-1)),e("div",Xi,[e("div",{class:"progress-completed save-progress",style:at({width:L()+"%"})},null,4)]),e("div",Gi,[e("span",Zi,oe(u.value.save.completed),1),e("span",Qi,"/ "+oe(u.value.save.total),1)])])):de("",!0)]),x[1]||(x[1]=e("div",{class:"divider"},null,-1)),e("div",er,[e("div",tr,[me(" æ€»è¿›åº¦ï¼š"+oe(p.value)+"% ",1),u.value.totalFailed>0?(B(),A("span",or," ï¼ˆ"+oe(u.value.totalFailed)+" å¤±è´¥ï¼‰ ",1)):de("",!0)]),e("div",nr,[e("div",{class:"overall-progress-fill progress-stripe",style:at({width:p.value+"%"})},null,4)])])],64)):(B(),A(Oe,{key:1},[e("div",sr,[me(oe(g.value)+" ",1),K.value>0?(B(),A("span",ar,"ï¼ˆ"+oe(K.value)+" å¼ å¤±è´¥ï¼‰",1)):de("",!0)]),e("div",lr,[e("div",{class:"progress progress-stripe",style:at({width:`${U.value}%`})},null,4)])],64))])):de("",!0)}}),rr=He(ir,[["__scopeId","data-v-532ece5f"]]),ur=je({__name:"SponsorModal",emits:["close"],setup(n,{emit:t}){const s=t;return(o,i)=>(B(),ut(Tn,{title:"æ”¯æŒä½œè€…",onClose:i[1]||(i[1]=r=>s("close"))},{footer:St(()=>[e("button",{type:"button",class:"btn btn-primary",onClick:i[0]||(i[0]=r=>s("close"))},"å…³é—­")]),default:St(()=>[i[2]||(i[2]=e("div",{class:"sponsor-content"},[e("p",{class:"sponsor-message"}," å¦‚æœè¿™ä¸ªé¡¹ç›®å¯¹ä½ æœ‰å¸®åŠ©ï¼Œæ¬¢è¿è¯·ä½œè€…å–æ¯å’–å•¡ â˜• "),e("div",{class:"qr-codes"},[e("div",{class:"qr-item"},[e("div",{class:"qr-image"},[e("img",{src:"/pic/wechat_qrcode.png",alt:"å¾®ä¿¡æ”¯ä»˜"})]),e("span",{class:"qr-label"},"å¾®ä¿¡æ”¯ä»˜")]),e("div",{class:"qr-item"},[e("div",{class:"qr-image"},[e("img",{src:"/pic/alipay_qrcode.png",alt:"æ”¯ä»˜å®"})]),e("span",{class:"qr-label"},"æ”¯ä»˜å®")])]),e("p",{class:"sponsor-thanks"},"æ„Ÿè°¢æ‚¨çš„æ”¯æŒï¼ğŸ™")],-1))]),_:1}))}}),cr=He(ur,[["__scopeId","data-v-02b6948e"]]);function dr(n){const t=C(""),s=Q(()=>n.value.some(M=>M.folderPath)),o=Q(()=>{if(!s.value)return null;const M={name:"æ ¹ç›®å½•",path:"",images:[],subfolders:[]},E=new Map;E.set("",M);for(const $ of n.value){const j=$.folderPath||"";if(j&&!E.has(j)){const K=j.split("/");let U="";for(const g of K){const d=U;if(U=U?`${U}/${g}`:g,!E.has(U)){const x={name:g,path:U,images:[],subfolders:[]};E.set(U,x),E.has(d)&&E.get(d).subfolders.push(x)}}}E.has(j)&&E.get(j).images.push($)}return M}),i=Q(()=>{if(!t.value)return[{name:"æ ¹ç›®å½•",path:""}];const M=t.value.split("/"),E=[{name:"æ ¹ç›®å½•",path:""}];let $="";for(const j of M)$=$?`${$}/${j}`:j,E.push({name:j,path:$});return E}),r=Q(()=>{if(!o.value)return null;if(!t.value)return o.value;const M=(E,$)=>{if(E.path===$)return E;for(const j of E.subfolders){const K=M(j,$);if(K)return K}return null};return M(o.value,t.value)}),a=Q(()=>r.value?.subfolders||[]),u=Q(()=>r.value?.images||[]);function p(M){t.value=M}function k(){if(!t.value)return;const M=t.value.lastIndexOf("/");t.value=M>0?t.value.substring(0,M):""}function f(M){t.value=M}function P(M){let E=M.images.length;for(const $ of M.subfolders)E+=P($);return E}function L(){t.value=""}return{currentFolderPath:t,useTreeMode:s,folderTree:o,breadcrumbs:i,currentFolder:r,currentSubfolders:a,currentImages:u,enterFolder:p,goUp:k,navigateTo:f,getFolderImageCount:P,resetToRoot:L}}const gr={id:"thumbnail-sidebar",class:"thumbnail-sidebar"},pr={class:"card thumbnail-card"},mr={class:"breadcrumb-nav"},vr=["onClick"],fr={key:0,class:"breadcrumb-sep"},br=["onClick"],hr={class:"folder-info"},yr=["title"],xr={class:"folder-count"},_r=["title","onClick"],Cr=["src","alt"],Sr={class:"page-number-indicator"},kr={key:1,class:"translated-indicator"},wr={key:2,class:"translation-failed-indicator"},$r={key:3,class:"labeled-indicator"},Tr={key:4,class:"thumbnail-processing-indicator"},Ir={key:0,class:"empty-folder"},Pr=["title","data-index","onClick"],Rr=["src","alt"],Dr={class:"page-number-indicator"},Mr={key:1,class:"translated-indicator"},Er={key:2,class:"translation-failed-indicator"},Br={key:3,class:"labeled-indicator"},Ar={key:4,class:"thumbnail-processing-indicator"},Lr={key:2,class:"empty-state"},Fr=je({__name:"ThumbnailSidebar",emits:["select"],setup(n,{emit:t}){const s=t,o=et(),i=C(null),r=C([]),a=Q(()=>o.images),u=Q(()=>o.currentImageIndex),p=Q(()=>o.hasImages),{useTreeMode:k,breadcrumbs:f,currentSubfolders:P,currentImages:L,currentFolderPath:M,enterFolder:E,goUp:$,navigateTo:j,getFolderImageCount:K,folderTree:U,resetToRoot:g}=dr(a);Ce(()=>a.value.length,(R,I)=>{(R===0||I===0&&R>0)&&g()});function d(R){return a.value.findIndex(I=>I.id===R.id)}function x(R){return R.translationFailed?"failed":R.isManuallyAnnotated?"labeled":R.translationStatus==="processing"?"processing":null}function _(R){return R.translationStatus==="completed"}function q(R){s("select",R)}function V(R){E(R.path)}function se(R){j(R)}function X(){pt(()=>{const R=r.value[u.value];if(R&&i.value){const I=i.value,F=R.offsetTop-I.clientHeight/2+R.clientHeight/2;I.scrollTo({top:Math.max(0,F),behavior:"smooth"})}})}function ie(R,I){r.value[I]=R}function z(R){return R.translationFailed?"ç¿»è¯‘å¤±è´¥ï¼Œç‚¹å‡»å¯é‡è¯•":R.isManuallyAnnotated?"åŒ…å«æ‰‹åŠ¨æ ‡æ³¨":R.translationStatus==="completed"?"å·²å®Œæˆç¿»è¯‘":R.fileName||""}return Ce(u,()=>{X()}),dt(()=>{p.value&&X()}),(R,I)=>(B(),A("aside",gr,[e("div",pr,[I[5]||(I[5]=e("h2",null,"å›¾ç‰‡æ¦‚è§ˆ",-1)),p.value&&H(k)&&H(U)?(B(),A(Oe,{key:0},[e("div",mr,[(B(!0),A(Oe,null,Ye(H(f),(F,y)=>(B(),A(Oe,{key:F.path},[e("span",{class:Ie(["breadcrumb-item",{active:y===H(f).length-1}]),onClick:m=>y<H(f).length-1&&se(F.path)},oe(y===0?"ğŸ“":"")+oe(F.name),11,vr),y<H(f).length-1?(B(),A("span",fr,"/")):de("",!0)],64))),128))]),H(M)?(B(),A("div",{key:0,class:"folder-back-btn",onClick:I[0]||(I[0]=(...F)=>H($)&&H($)(...F))},[...I[1]||(I[1]=[e("span",{class:"back-icon"},"â¬…ï¸",-1),e("span",null,"è¿”å›ä¸Šçº§",-1)])])):de("",!0),e("div",{ref_key:"containerRef",ref:i,class:"folder-content-list"},[(B(!0),A(Oe,null,Ye(H(P),F=>(B(),A("div",{key:F.path,class:"folder-item",onClick:y=>V(F)},[I[2]||(I[2]=e("span",{class:"folder-icon"},"ğŸ“",-1)),e("div",hr,[e("span",{class:"folder-name",title:F.name},oe(F.name),9,yr),e("span",xr,"("+oe(H(K)(F))+")",1)])],8,br))),128)),(B(!0),A(Oe,null,Ye(H(L),F=>(B(),A("div",{key:F.id,ref_for:!0,ref:y=>ie(y,d(F)),class:Ie(["thumbnail-item",{active:d(F)===u.value}]),title:z(F),onClick:y=>q(d(F))},[F.originalDataURL?(B(),A("img",{key:0,src:F.originalDataURL,alt:F.fileName,class:"thumbnail-image"},null,8,Cr)):de("",!0),e("span",Sr,oe(d(F)+1),1),_(F)?(B(),A("span",kr,"âœ“")):de("",!0),x(F)==="failed"?(B(),A("span",wr,"!")):x(F)==="labeled"?(B(),A("span",$r,"âœï¸")):de("",!0),x(F)==="processing"?(B(),A("div",Tr,"âŸ³")):de("",!0)],10,_r))),128)),H(P).length===0&&H(L).length===0?(B(),A("div",Ir,[...I[3]||(I[3]=[e("p",null,"æ­¤æ–‡ä»¶å¤¹ä¸ºç©º",-1)])])):de("",!0)],512)],64)):p.value?(B(),A("ul",{key:1,ref_key:"containerRef",ref:i,id:"thumbnailList",class:"thumbnail-list"},[(B(!0),A(Oe,null,Ye(a.value,(F,y)=>(B(),A("li",{key:F.id,ref_for:!0,ref:m=>ie(m,y),class:Ie(["thumbnail-item",{active:y===u.value}]),title:z(F),"data-index":y,onClick:m=>q(y)},[F.originalDataURL?(B(),A("img",{key:0,src:F.originalDataURL,alt:F.fileName,class:"thumbnail-image"},null,8,Rr)):de("",!0),e("span",Dr,oe(y+1),1),_(F)?(B(),A("span",Mr,"âœ“")):de("",!0),x(F)==="failed"?(B(),A("span",Er,"!")):x(F)==="labeled"?(B(),A("span",Br,"âœï¸")):de("",!0),x(F)==="processing"?(B(),A("div",Ar," âŸ³ ")):de("",!0)],10,Pr))),128))],512)):(B(),A("div",Lr,[...I[4]||(I[4]=[e("p",null,"æš‚æ— å›¾ç‰‡",-1)])]))])]))}}),Ur=He(Fr,[["__scopeId","data-v-4c1f4f1b"]]),Or={class:"saved-prompts-picker"},zr={class:"prompts-chips-container"},Nr={key:0,class:"empty-hint"},Vr={key:1,class:"empty-hint"},Wr=["title","onClick"],Kr=je({__name:"SavedPromptsPicker",props:{promptType:{}},emits:["select"],setup(n,{expose:t,emit:s}){const o=n,i=s,r=C([]),a=C(!1);async function u(){a.value=!0;try{let k;o.promptType==="textbox"?k=await Ke.getTextboxPrompts():k=await Ke.getPrompts(o.promptType);const f=k.prompt_names||[];r.value=f.map(P=>({name:P}))}catch(k){console.error("åŠ è½½æç¤ºè¯åˆ—è¡¨å¤±è´¥:",k),r.value=[]}finally{a.value=!1}}async function p(k){try{let f;o.promptType==="textbox"?f=await Ke.getTextboxPromptContent(k):f=await Ke.getPromptContent(o.promptType,k),f.prompt_content&&i("select",f.prompt_content,k)}catch(f){console.error("åŠ è½½æç¤ºè¯å†…å®¹å¤±è´¥:",f)}}return Ce(()=>o.promptType,()=>{u()}),dt(()=>{u()}),t({refresh:u}),(k,f)=>(B(),A("div",Or,[f[1]||(f[1]=e("span",{class:"picker-label"},"ğŸ“‘ å¿«é€Ÿé€‰æ‹©:",-1)),e("div",zr,[a.value?(B(),A("span",Nr,"åŠ è½½ä¸­...")):r.value.length===0?(B(),A("span",Vr,"æš‚æ— ä¿å­˜çš„æç¤ºè¯")):(B(!0),A(Oe,{key:2},Ye(r.value,P=>(B(),A("button",{key:P.name,type:"button",class:"prompt-chip",title:P.name,onClick:L=>p(P.name)},[f[0]||(f[0]=e("span",{class:"chip-icon"},"ğŸ“",-1)),me(" "+oe(P.name),1)],8,Wr))),128))])]))}}),Ut=He(Kr,[["__scopeId","data-v-2ebbb8b3"]]),qr={class:"ocr-settings"},Hr={class:"settings-group"},jr={class:"settings-item"},Jr={class:"settings-item"},Yr={class:"input-hint"},Xr={class:"settings-group"},Gr={class:"settings-row"},Zr={class:"settings-item"},Qr={class:"password-input-wrapper"},eu=["type"],tu={key:0,class:"eye-icon"},ou={key:1,class:"eye-off-icon"},nu={class:"settings-item"},su={class:"password-input-wrapper"},au=["type"],lu={key:0,class:"eye-icon"},iu={key:1,class:"eye-off-icon"},ru={class:"settings-row"},uu={class:"settings-item"},cu={class:"settings-item"},du=["disabled"],gu={class:"settings-group"},pu={class:"settings-row"},mu={class:"settings-item"},vu={class:"settings-item"},fu={class:"password-input-wrapper"},bu=["type"],hu={key:0,class:"eye-icon"},yu={key:1,class:"eye-off-icon"},xu={class:"settings-item"},_u={class:"settings-item"},Cu={class:"model-input-with-fetch"},Su=["disabled"],ku={class:"fetch-text"},wu={key:0,class:"model-select-container"},$u={class:"model-count"},Tu={class:"settings-item"},Iu={class:"prompt-format-selector"},Pu={class:"settings-item"},Ru={class:"settings-item"},Du=["disabled"],Mu=je({__name:"OcrSettings",setup(n){const t=[{label:"MangaOCR (æ—¥è¯­ä¸“ç”¨)",value:"manga_ocr"},{label:"PaddleOCR (å¤šè¯­è¨€)",value:"paddle_ocr"},{label:"PaddleOCR-VL",value:"paddleocr_vl"},{label:"ç™¾åº¦OCR",value:"baidu_ocr"},{label:"48px OCR",value:"48px_ocr"},{label:"AIè§†è§‰OCR",value:"ai_vision"}],s=[{label:"æ ‡å‡†ç‰ˆ",value:"standard"},{label:"é«˜ç²¾åº¦ç‰ˆ",value:"high_precision"}],o=[{label:"è‡ªåŠ¨æ£€æµ‹",value:"auto_detect"},{label:"ä¸­è‹±æ–‡æ··åˆ",value:"CHN_ENG"},{label:"è‹±æ–‡",value:"ENG"},{label:"æ—¥è¯­",value:"JAP"},{label:"éŸ©è¯­",value:"KOR"},{label:"æ³•è¯­",value:"FRE"},{label:"å¾·è¯­",value:"GER"},{label:"ä¿„è¯­",value:"RUS"}],i=[{label:"SiliconFlow (ç¡…åŸºæµåŠ¨)",value:"siliconflow"},{label:"ç«å±±å¼•æ“",value:"volcano"},{label:"Google Gemini",value:"gemini"},{label:"è‡ªå®šä¹‰ OpenAI å…¼å®¹æœåŠ¡",value:"custom_openai_vision"}],r=[{label:"æ™®é€šæç¤ºè¯",value:"false"},{label:"JSONæç¤ºè¯",value:"true"}],a=[{label:"ğŸš€ å¸¸ç”¨è¯­è¨€",options:[{label:"æ—¥è¯­",value:"japanese"},{label:"è‹±è¯­",value:"en"},{label:"ç®€ä½“ä¸­æ–‡",value:"chinese"},{label:"ç¹ä½“ä¸­æ–‡",value:"chinese_cht"},{label:"éŸ©è¯­",value:"korean"}]},{label:"ğŸŒ æ‹‰ä¸è¯­ç³»",options:[{label:"æ³•è¯­",value:"french"},{label:"å¾·è¯­",value:"german"},{label:"è¥¿ç­ç‰™è¯­",value:"spanish"},{label:"æ„å¤§åˆ©è¯­",value:"italian"},{label:"è‘¡è„ç‰™è¯­",value:"portuguese"}]},{label:"ğŸŒ å…¶ä»–è¯­ç³»",options:[{label:"ä¿„è¯­",value:"russian"}]}],u=ze(),p=ct(),k=C({apiKey:u.settings.baiduOcr.apiKey,secretKey:u.settings.baiduOcr.secretKey,version:u.settings.baiduOcr.version,sourceLanguage:u.settings.baiduOcr.sourceLanguage}),f=C({apiKey:u.settings.aiVisionOcr.apiKey,modelName:u.settings.aiVisionOcr.modelName,customBaseUrl:u.settings.aiVisionOcr.customBaseUrl,prompt:u.settings.aiVisionOcr.prompt,rpmLimit:u.settings.aiVisionOcr.rpmLimit,minImageSize:u.settings.aiVisionOcr.minImageSize}),P=Q(()=>u.settings);Ce(()=>k.value.apiKey,R=>{u.updateBaiduOcr({apiKey:R})}),Ce(()=>k.value.secretKey,R=>{u.updateBaiduOcr({secretKey:R})}),Ce(()=>k.value.version,R=>{u.updateBaiduOcr({version:R})}),Ce(()=>k.value.sourceLanguage,R=>{u.updateBaiduOcr({sourceLanguage:R})}),Ce(()=>f.value.apiKey,R=>{u.updateAiVisionOcr({apiKey:R})}),Ce(()=>f.value.modelName,R=>{u.updateAiVisionOcr({modelName:R})}),Ce(()=>f.value.customBaseUrl,R=>{u.updateAiVisionOcr({customBaseUrl:R})}),Ce(()=>f.value.prompt,R=>{u.updateAiVisionOcr({prompt:R})}),Ce(()=>f.value.rpmLimit,R=>{u.updateAiVisionOcr({rpmLimit:R})}),Ce(()=>f.value.minImageSize,R=>{u.updateAiVisionOcr({minImageSize:R})});const L=C(!1),M=C(!1),E=C(!1),$=C(!1),j=C(!1),K=C([]),U=Q(()=>{const R=[{label:"-- é€‰æ‹©æ¨¡å‹ --",value:""}];return K.value.forEach(I=>{R.push({label:I,value:I})}),R});function g(){u.saveToStorage()}function d(){u.saveToStorage()}function x(){switch(u.settings.ocrEngine){case"manga_ocr":return"MangaOCR ä¸“ä¸ºæ—¥è¯­æ¼«ç”»ä¼˜åŒ–ï¼Œæºè¯­è¨€è®¾ç½®ä¸å½±å“è¯†åˆ«";case"paddle_ocr":return"PaddleOCR ä¼šæ ¹æ®æºè¯­è¨€åŠ è½½å¯¹åº”çš„è¯†åˆ«æ¨¡å‹";case"paddleocr_vl":return"PaddleOCR-VL åŸºäº VLM å¾®è°ƒï¼Œä¸“ä¸ºæ—¥è¯­æ¼«ç”»ä¼˜åŒ–ï¼Œå‡†ç¡®ç‡é«˜è¾¾ 70%";case"baidu_ocr":return"ç™¾åº¦OCR ä½¿ç”¨ç‹¬ç«‹çš„æºè¯­è¨€è®¾ç½®ï¼ˆè§ä¸‹æ–¹ï¼‰";case"ai_vision":return"AIè§†è§‰OCR é€šè¿‡æç¤ºè¯æŒ‡å®šè¯†åˆ«è¯­è¨€";case"48px_ocr":return"48px OCR æ”¯æŒæ—¥ä¸­è‹±éŸ©ç­‰å¤šè¯­è¨€ï¼Œæºè¯­è¨€è®¾ç½®ä¸å½±å“è¯†åˆ«";default:return"é€‰æ‹©è¦è¯†åˆ«çš„åŸæ–‡è¯­è¨€"}}function _(R){u.setAiVisionOcrProvider(R),K.value=[],q()}function q(){f.value.apiKey=u.settings.aiVisionOcr.apiKey,f.value.modelName=u.settings.aiVisionOcr.modelName,f.value.customBaseUrl=u.settings.aiVisionOcr.customBaseUrl,f.value.prompt=u.settings.aiVisionOcr.prompt,f.value.rpmLimit=u.settings.aiVisionOcr.rpmLimit,f.value.minImageSize=u.settings.aiVisionOcr.minImageSize}function V(){const R=u.settings.aiVisionOcr.isJsonMode?gs:ps;u.updateAiVisionOcr({prompt:R}),f.value.prompt=R}async function se(){const R=k.value.apiKey?.trim(),I=k.value.secretKey?.trim();if(!R||!I){p.warning("è¯·å¡«å†™ç™¾åº¦OCRçš„API Keyå’ŒSecret Key");return}$.value=!0,p.info("æ­£åœ¨æµ‹è¯•ç™¾åº¦OCRè¿æ¥...");try{const F=await Ke.testBaiduOcrConnection(R,I);F.success?p.success(F.message||"ç™¾åº¦OCRè¿æ¥æˆåŠŸ!"):p.error(F.message||F.error||"ç™¾åº¦OCRè¿æ¥å¤±è´¥")}catch(F){const y=F instanceof Error?F.message:"è¿æ¥æµ‹è¯•å¤±è´¥";p.error(y)}finally{$.value=!1}}async function X(){$.value=!0;try{const R=await Ke.testAiVisionOcrConnection({provider:u.settings.aiVisionOcr.provider,apiKey:f.value.apiKey,modelName:f.value.modelName,customBaseUrl:f.value.customBaseUrl,prompt:f.value.prompt});R.success?p.success("AIè§†è§‰OCRè¿æ¥æˆåŠŸ"):p.error(`AIè§†è§‰OCRè¿æ¥å¤±è´¥: ${R.error||"æœªçŸ¥é”™è¯¯"}`)}catch(R){const I=R instanceof Error?R.message:"è¿æ¥æµ‹è¯•å¤±è´¥";p.error(I)}finally{$.value=!1}}async function ie(){const R=u.settings.aiVisionOcr.provider,I=f.value.apiKey?.trim(),F=f.value.customBaseUrl?.trim();if(!I){p.warning("è¯·å…ˆå¡«å†™ API Key");return}if(!["siliconflow","volcano","gemini","custom_openai_vision"].includes(R)){p.warning("å½“å‰æœåŠ¡å•†ä¸æ”¯æŒè‡ªåŠ¨è·å–æ¨¡å‹åˆ—è¡¨");return}if(R==="custom_openai_vision"&&!F){p.warning("è‡ªå®šä¹‰æœåŠ¡éœ€è¦å…ˆå¡«å†™ Base URL");return}j.value=!0;try{const m=await Ke.fetchModels(R,I,F);m.success&&m.models&&m.models.length>0?(K.value=m.models.map(l=>l.id),p.success(`è·å–åˆ° ${m.models.length} ä¸ªæ¨¡å‹`)):p.warning(m.message||"æœªè·å–åˆ°å¯ç”¨æ¨¡å‹")}catch(m){const l=m instanceof Error?m.message:"è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥";p.error(l)}finally{j.value=!1}}function z(R,I){u.updateAiVisionOcr({prompt:R}),f.value.prompt=R,p.success(`å·²åº”ç”¨æç¤ºè¯: ${I}`)}return(R,I)=>(B(),A("div",qr,[e("div",Hr,[I[20]||(I[20]=e("div",{class:"settings-group-title"},"OCRå¼•æ“é€‰æ‹©",-1)),e("div",jr,[I[18]||(I[18]=e("label",{for:"settingsOcrEngine"},"OCRå¼•æ“:",-1)),Se(We,{"model-value":P.value.ocrEngine,options:t,onChange:I[0]||(I[0]=F=>{P.value.ocrEngine=F,g()})},null,8,["model-value"])]),ae(e("div",Jr,[I[19]||(I[19]=e("label",{for:"settingsSourceLanguage"},"æºè¯­è¨€:",-1)),Se(We,{"model-value":P.value.sourceLanguage,groups:a,onChange:I[1]||(I[1]=F=>{P.value.sourceLanguage=F,d()})},null,8,["model-value"]),e("div",Yr,oe(x()),1)],512),[[Ue,P.value.ocrEngine==="paddle_ocr"]])]),ae(e("div",Xr,[I[25]||(I[25]=e("div",{class:"settings-group-title"},"ç™¾åº¦OCR è®¾ç½®",-1)),e("div",Gr,[e("div",Zr,[I[21]||(I[21]=e("label",{for:"settingsBaiduApiKey"},"API Key:",-1)),e("div",Qr,[ae(e("input",{type:L.value?"text":"password",id:"settingsBaiduApiKey","onUpdate:modelValue":I[2]||(I[2]=F=>k.value.apiKey=F),class:"secure-input",placeholder:"è¯·è¾“å…¥ç™¾åº¦OCR API Key",autocomplete:"off"},null,8,eu),[[$t,k.value.apiKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:I[3]||(I[3]=F=>L.value=!L.value)},[L.value?(B(),A("span",ou,"ğŸ‘â€ğŸ—¨")):(B(),A("span",tu,"ğŸ‘"))])])]),e("div",nu,[I[22]||(I[22]=e("label",{for:"settingsBaiduSecretKey"},"Secret Key:",-1)),e("div",su,[ae(e("input",{type:M.value?"text":"password",id:"settingsBaiduSecretKey","onUpdate:modelValue":I[4]||(I[4]=F=>k.value.secretKey=F),class:"secure-input",placeholder:"è¯·è¾“å…¥Secret Key",autocomplete:"off"},null,8,au),[[$t,k.value.secretKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:I[5]||(I[5]=F=>M.value=!M.value)},[M.value?(B(),A("span",iu,"ğŸ‘â€ğŸ—¨")):(B(),A("span",lu,"ğŸ‘"))])])])]),e("div",ru,[e("div",uu,[I[23]||(I[23]=e("label",{for:"settingsBaiduVersion"},"è¯†åˆ«ç‰ˆæœ¬:",-1)),Se(We,{modelValue:k.value.version,"onUpdate:modelValue":I[6]||(I[6]=F=>k.value.version=F),options:s},null,8,["modelValue"])]),e("div",cu,[I[24]||(I[24]=e("label",{for:"settingsBaiduSourceLanguage"},"æºè¯­è¨€:",-1)),Se(We,{modelValue:k.value.sourceLanguage,"onUpdate:modelValue":I[7]||(I[7]=F=>k.value.sourceLanguage=F),options:o},null,8,["modelValue"])])]),e("button",{class:"settings-test-btn",onClick:se,disabled:$.value},oe($.value?"æµ‹è¯•ä¸­...":"ğŸ”— æµ‹è¯•è¿æ¥"),9,du)],512),[[Ue,P.value.ocrEngine==="baidu_ocr"]]),ae(e("div",gu,[I[37]||(I[37]=e("div",{class:"settings-group-title"},"AIè§†è§‰OCR è®¾ç½®",-1)),e("div",pu,[e("div",mu,[I[26]||(I[26]=e("label",{for:"settingsAiVisionProvider"},"æœåŠ¡å•†:",-1)),Se(We,{"model-value":P.value.aiVisionOcr.provider,options:i,onChange:I[8]||(I[8]=F=>_(F))},null,8,["model-value"])]),e("div",vu,[I[27]||(I[27]=e("label",{for:"settingsAiVisionApiKey"},"API Key:",-1)),e("div",fu,[ae(e("input",{type:E.value?"text":"password",id:"settingsAiVisionApiKey","onUpdate:modelValue":I[9]||(I[9]=F=>f.value.apiKey=F),class:"secure-input",placeholder:"è¯·è¾“å…¥API Key",autocomplete:"off"},null,8,bu),[[$t,f.value.apiKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:I[10]||(I[10]=F=>E.value=!E.value)},[E.value?(B(),A("span",yu,"ğŸ‘â€ğŸ—¨")):(B(),A("span",hu,"ğŸ‘"))])])])]),ae(e("div",xu,[I[28]||(I[28]=e("label",{for:"settingsCustomAiVisionBaseUrl"},"Base URL:",-1)),ae(e("input",{type:"text",id:"settingsCustomAiVisionBaseUrl","onUpdate:modelValue":I[11]||(I[11]=F=>f.value.customBaseUrl=F),placeholder:"ä¾‹å¦‚: https://api.example.com/v1"},null,512),[[we,f.value.customBaseUrl]])],512),[[Ue,P.value.aiVisionOcr.provider==="custom_openai_vision"]]),e("div",_u,[I[30]||(I[30]=e("label",{for:"settingsAiVisionModelName"},"æ¨¡å‹åç§°:",-1)),e("div",Cu,[ae(e("input",{type:"text",id:"settingsAiVisionModelName","onUpdate:modelValue":I[12]||(I[12]=F=>f.value.modelName=F),placeholder:"å¦‚: silicon-llava2-34b"},null,512),[[we,f.value.modelName]]),e("button",{type:"button",class:"fetch-models-btn",title:"è·å–å¯ç”¨æ¨¡å‹åˆ—è¡¨",onClick:ie,disabled:j.value},[I[29]||(I[29]=e("span",{class:"fetch-icon"},"ğŸ”",-1)),e("span",ku,oe(j.value?"è·å–ä¸­...":"è·å–æ¨¡å‹"),1)],8,Su)]),K.value.length>0?(B(),A("div",wu,[Se(We,{modelValue:f.value.modelName,"onUpdate:modelValue":I[13]||(I[13]=F=>f.value.modelName=F),options:U.value},null,8,["modelValue","options"]),e("span",$u,"å…± "+oe(K.value.length)+" ä¸ªæ¨¡å‹",1)])):de("",!0)]),e("div",Tu,[I[32]||(I[32]=e("label",{for:"settingsAiVisionOcrPrompt"},"OCRæç¤ºè¯:",-1)),ae(e("textarea",{id:"settingsAiVisionOcrPrompt","onUpdate:modelValue":I[14]||(I[14]=F=>f.value.prompt=F),rows:"3",placeholder:"AIè§†è§‰OCRæç¤ºè¯"},null,512),[[we,f.value.prompt]]),Se(Ut,{"prompt-type":"ai_vision_ocr",onSelect:z}),e("div",Iu,[Se(We,{"model-value":P.value.aiVisionOcr.isJsonMode?"true":"false",options:r,onChange:I[15]||(I[15]=F=>{P.value.aiVisionOcr.isJsonMode=F==="true",V()})},null,8,["model-value"]),I[31]||(I[31]=e("span",{class:"input-hint"},"JSONæ ¼å¼è¾“å‡ºæ›´ç»“æ„åŒ–",-1))])]),e("div",Pu,[I[33]||(I[33]=e("label",{for:"settingsRpmAiVisionOcr"},"RPMé™åˆ¶ (æ¯åˆ†é’Ÿè¯·æ±‚æ•°):",-1)),ae(e("input",{type:"number",id:"settingsRpmAiVisionOcr","onUpdate:modelValue":I[16]||(I[16]=F=>f.value.rpmLimit=F),min:"0",step:"1"},null,512),[[we,f.value.rpmLimit,void 0,{number:!0}]]),I[34]||(I[34]=e("div",{class:"input-hint"},"0 è¡¨ç¤ºæ— é™åˆ¶",-1))]),e("div",Ru,[I[35]||(I[35]=e("label",{for:"settingsMinImageSize"},"æœ€å°å›¾ç‰‡å°ºå¯¸ (åƒç´ ):",-1)),ae(e("input",{type:"number",id:"settingsMinImageSize","onUpdate:modelValue":I[17]||(I[17]=F=>f.value.minImageSize=F),min:"0",step:"1"},null,512),[[we,f.value.minImageSize,void 0,{number:!0}]]),I[36]||(I[36]=e("div",{class:"input-hint"},"VLMæ¨¡å‹é€šå¸¸è¦æ±‚å›¾ç‰‡å°ºå¯¸ â‰¥28pxï¼Œè®¾ä¸º0åˆ™ä¸è‡ªåŠ¨æ”¾å¤§å°å›¾",-1))]),e("button",{class:"settings-test-btn",onClick:X,disabled:$.value},oe($.value?"æµ‹è¯•ä¸­...":"ğŸ”— æµ‹è¯•è¿æ¥"),9,Du)],512),[[Ue,P.value.ocrEngine==="ai_vision"]])]))}}),Eu=He(Mu,[["__scopeId","data-v-1a008af8"]]),Bu={class:"translation-settings"},Au={class:"settings-group"},Lu={class:"settings-row"},Fu={class:"settings-item"},Uu={class:"settings-item"},Ou={for:"settingsApiKey"},zu={class:"password-input-wrapper"},Nu=["type","placeholder"],Vu={key:0,class:"eye-icon"},Wu={key:1,class:"eye-off-icon"},Ku={class:"settings-item"},qu={class:"settings-item"},Hu={for:"settingsModelName"},ju={class:"model-input-with-fetch"},Ju=["placeholder"],Yu=["disabled"],Xu={class:"fetch-text"},Gu={key:0,class:"model-select-container"},Zu={class:"model-count"},Qu={class:"settings-item"},ec={class:"local-model-list"},tc={key:0,class:"model-list-container"},oc=["disabled"],nc={key:1,class:"model-hint"},sc={key:1,class:"model-list-container"},ac=["disabled"],lc={key:1,class:"model-hint"},ic={class:"settings-row"},rc={class:"settings-item"},uc={class:"settings-item"},cc={class:"settings-item"},dc=["disabled"],gc={class:"settings-item"},pc=["disabled"],mc={class:"settings-group"},vc={class:"settings-item"},fc={class:"prompt-format-selector"},bc={class:"settings-item"},hc={class:"checkbox-label"},yc={class:"settings-item"},xc=je({__name:"TranslationSettings",setup(n){const t=[{label:"SiliconFlow",value:"siliconflow"},{label:"DeepSeek",value:"deepseek"},{label:"ç«å±±å¼•æ“",value:"volcano"},{label:"å½©äº‘å°è¯‘",value:"caiyun"},{label:"ç™¾åº¦ç¿»è¯‘",value:"baidu_translate"},{label:"æœ‰é“ç¿»è¯‘",value:"youdao_translate"},{label:"Google Gemini",value:"gemini"},{label:"Ollama (æœ¬åœ°)",value:"ollama"},{label:"Sakura (æœ¬åœ°)",value:"sakura"},{label:"è‡ªå®šä¹‰ OpenAI å…¼å®¹æœåŠ¡",value:"custom_openai"}],s=[{label:"æ™®é€šæç¤ºè¯",value:"normal"},{label:"JSONæç¤ºè¯",value:"json"}],o=ze(),i=ct(),r=C({modelProvider:o.settings.translation.provider,apiKey:o.settings.translation.apiKey,modelName:o.settings.translation.modelName,customBaseUrl:o.settings.translation.customBaseUrl,rpmTranslation:o.settings.translation.rpmLimit,translationMaxRetries:o.settings.translation.maxRetries,promptContent:o.settings.translatePrompt,translatePromptMode:o.settings.translation.isJsonMode?"json":"normal",enableTextboxPrompt:o.settings.useTextboxPrompt,textboxPromptContent:o.settings.textboxPrompt}),a=C(!1),u=C(!1),p=C(!1),k=C([]),f=C([]),P=C([]),L=Q(()=>{const m=[{label:"-- é€‰æ‹©æ¨¡å‹ --",value:""}];return k.value.forEach(l=>m.push({label:l,value:l})),m}),M=Q(()=>{const m=[{label:"-- é€‰æ‹©æ¨¡å‹ --",value:""}];return f.value.forEach(l=>m.push({label:l,value:l})),m}),E=Q(()=>{const m=[{label:"-- é€‰æ‹©æ¨¡å‹ --",value:""}];return P.value.forEach(l=>m.push({label:l,value:l})),m}),$=Q(()=>["ollama","sakura"].includes(r.value.modelProvider)),j=Q(()=>!["ollama","sakura","caiyun","baidu_translate","youdao_translate"].includes(r.value.modelProvider)),K=Q(()=>["siliconflow","deepseek","volcano","gemini","custom_openai"].includes(r.value.modelProvider)),U=Q(()=>{switch(r.value.modelProvider){case"baidu_translate":return"App ID";case"youdao_translate":return"App Key";case"caiyun":return"API Token";default:return"API Key"}}),g=Q(()=>{switch(r.value.modelProvider){case"baidu_translate":return"è¯·è¾“å…¥ç™¾åº¦ç¿»è¯‘App ID";case"youdao_translate":return"è¯·è¾“å…¥æœ‰é“ç¿»è¯‘åº”ç”¨ID";case"caiyun":return"è¯·è¾“å…¥å½©äº‘å°è¯‘Token";default:return"è¯·è¾“å…¥API Key"}}),d=Q(()=>{switch(r.value.modelProvider){case"baidu_translate":return"App Key";case"youdao_translate":return"App Secret";case"caiyun":return"æºè¯­è¨€ (å¯é€‰)";default:return"æ¨¡å‹åç§°"}}),x=Q(()=>{switch(r.value.modelProvider){case"baidu_translate":return"è¯·è¾“å…¥ç™¾åº¦ç¿»è¯‘App Key";case"youdao_translate":return"è¯·è¾“å…¥æœ‰é“ç¿»è¯‘åº”ç”¨å¯†é’¥";case"caiyun":return"å¯é€‰: auto/æ—¥è¯­/è‹±è¯­";default:return"è¯·è¾“å…¥æ¨¡å‹åç§°"}});function _(){const m=r.value.modelProvider;o.setTranslationProvider(m),r.value.apiKey=o.settings.translation.apiKey,r.value.modelName=o.settings.translation.modelName,r.value.customBaseUrl=o.settings.translation.customBaseUrl,r.value.rpmTranslation=o.settings.translation.rpmLimit,r.value.translationMaxRetries=o.settings.translation.maxRetries,k.value=[]}function q(){const m=r.value.translatePromptMode==="json";m?r.value.promptContent=Go:r.value.promptContent=Zo,o.updateTranslationService({isJsonMode:m}),o.setTranslatePrompt(r.value.promptContent)}Ce(()=>r.value.apiKey,m=>{o.updateTranslationService({apiKey:m})}),Ce(()=>r.value.modelName,m=>{o.updateTranslationService({modelName:m})}),Ce(()=>r.value.customBaseUrl,m=>{o.updateTranslationService({customBaseUrl:m})}),Ce(()=>r.value.rpmTranslation,m=>{o.updateTranslationService({rpmLimit:m})}),Ce(()=>r.value.translationMaxRetries,m=>{o.updateTranslationService({maxRetries:m})}),Ce(()=>r.value.promptContent,m=>{o.setTranslatePrompt(m)}),Ce(()=>r.value.enableTextboxPrompt,m=>{o.setUseTextboxPrompt(m)}),Ce(()=>r.value.textboxPromptContent,m=>{o.setTextboxPrompt(m)});async function V(){const m=r.value.modelProvider,l=r.value.apiKey?.trim(),v=r.value.customBaseUrl?.trim();if(!l){i.warning("è¯·å…ˆå¡«å†™ API Key");return}if(!["siliconflow","deepseek","volcano","gemini","custom_openai"].includes(m)){i.warning(`${se(m)} ä¸æ”¯æŒè‡ªåŠ¨è·å–æ¨¡å‹åˆ—è¡¨`);return}if(m==="custom_openai"&&!v){i.warning("è‡ªå®šä¹‰æœåŠ¡éœ€è¦å…ˆå¡«å†™ Base URL");return}p.value=!0;try{const S=await Ke.fetchModels(m,l,v);S.success&&S.models&&S.models.length>0?(k.value=S.models.map(w=>w.id),i.success(`è·å–åˆ° ${S.models.length} ä¸ªæ¨¡å‹`)):i.warning(S.message||"æœªè·å–åˆ°å¯ç”¨æ¨¡å‹")}catch(S){const w=S instanceof Error?S.message:"è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥";i.error(w)}finally{p.value=!1}}function se(m){return{siliconflow:"SiliconFlow",deepseek:"DeepSeek",volcano:"ç«å±±å¼•æ“",gemini:"Google Gemini",custom_openai:"è‡ªå®šä¹‰OpenAI",ollama:"Ollama",sakura:"Sakura",caiyun:"å½©äº‘å°è¯‘",baidu_translate:"ç™¾åº¦ç¿»è¯‘",youdao_translate:"æœ‰é“ç¿»è¯‘"}[m]||m}async function X(){p.value=!0;try{const m=await Ke.testOllamaConnection();m.success&&m.models?(f.value=m.models,i.success(`è·å–åˆ° ${m.models.length} ä¸ªOllamaæ¨¡å‹`)):i.error(m.error||"Ollamaè¿æ¥å¤±è´¥")}catch(m){const l=m instanceof Error?m.message:"è·å–Ollamaæ¨¡å‹å¤±è´¥";i.error(l)}finally{p.value=!1}}async function ie(){p.value=!0;try{const m=await Ke.testSakuraConnection();m.success&&m.models?(P.value=m.models,i.success(`è·å–åˆ° ${m.models.length} ä¸ªSakuraæ¨¡å‹`)):i.error(m.error||"Sakuraè¿æ¥å¤±è´¥")}catch(m){const l=m instanceof Error?m.message:"è·å–Sakuraæ¨¡å‹å¤±è´¥";i.error(l)}finally{p.value=!1}}async function z(){u.value=!0;try{let m;r.value.modelProvider==="ollama"?m=await Ke.testOllamaConnection():m=await Ke.testSakuraConnection(),m.success?i.success(`${r.value.modelProvider==="ollama"?"Ollama":"Sakura"} è¿æ¥æˆåŠŸ`):i.error(m.error||"è¿æ¥å¤±è´¥")}catch(m){const l=m instanceof Error?m.message:"è¿æ¥æµ‹è¯•å¤±è´¥";i.error(l)}finally{u.value=!1}}async function R(){const m=r.value.modelProvider,l=r.value.apiKey?.trim(),v=r.value.modelName?.trim(),D=r.value.customBaseUrl?.trim();if(!l){i.warning("è¯·å…ˆå¡«å†™ API Key");return}if(m!=="caiyun"&&!v){i.warning("è¯·å¡«å†™æ¨¡å‹åç§°");return}if(m==="custom_openai"&&!D){i.warning("è‡ªå®šä¹‰æœåŠ¡éœ€è¦å¡«å†™ Base URL");return}u.value=!0,i.info("æ­£åœ¨æµ‹è¯•è¿æ¥...");try{let S;switch(m){case"baidu_translate":S=await Ke.testBaiduTranslateConnection(l,v);break;case"youdao_translate":S=await Ke.testYoudaoTranslateConnection(l,v);break;default:S=await Ke.testAiTranslateConnection({provider:m,apiKey:l,modelName:v,baseUrl:D})}S.success?i.success(S.message||`${se(m)} è¿æ¥æˆåŠŸ!`):i.error(S.message||S.error||"è¿æ¥å¤±è´¥")}catch(S){const w=S instanceof Error?S.message:"è¿æ¥æµ‹è¯•å¤±è´¥";i.error(w)}finally{u.value=!1}}function I(m,l){r.value.promptContent=m,i.success(`å·²åº”ç”¨æç¤ºè¯: ${l}`)}function F(m,l){r.value.textboxPromptContent=m,i.success(`å·²åº”ç”¨æç¤ºè¯: ${l}`)}function y(){r.value.translatePromptMode==="json"?r.value.promptContent=Go:r.value.promptContent=Zo,i.success("å·²é‡ç½®ä¸ºé»˜è®¤æç¤ºè¯")}return(m,l)=>(B(),A("div",Bu,[e("div",Au,[l[21]||(l[21]=e("div",{class:"settings-group-title"},"ç¿»è¯‘æœåŠ¡é…ç½®",-1)),e("div",Lu,[e("div",Fu,[l[14]||(l[14]=e("label",{for:"settingsModelProvider"},"ç¿»è¯‘æœåŠ¡å•†:",-1)),Se(We,{"model-value":r.value.modelProvider,options:t,onChange:l[0]||(l[0]=v=>{r.value.modelProvider=v,_()})},null,8,["model-value"])]),ae(e("div",Uu,[e("label",Ou,oe(U.value)+":",1),e("div",zu,[ae(e("input",{type:a.value?"text":"password",id:"settingsApiKey","onUpdate:modelValue":l[1]||(l[1]=v=>r.value.apiKey=v),class:"secure-input",placeholder:g.value,autocomplete:"off"},null,8,Nu),[[$t,r.value.apiKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:l[2]||(l[2]=v=>a.value=!a.value)},[a.value?(B(),A("span",Wu,"ğŸ‘â€ğŸ—¨")):(B(),A("span",Vu,"ğŸ‘"))])])],512),[[Ue,!$.value]])]),ae(e("div",Ku,[l[15]||(l[15]=e("label",{for:"settingsCustomBaseUrl"},"Base URL:",-1)),ae(e("input",{type:"text",id:"settingsCustomBaseUrl","onUpdate:modelValue":l[3]||(l[3]=v=>r.value.customBaseUrl=v),placeholder:"ä¾‹å¦‚: https://api.example.com/v1"},null,512),[[we,r.value.customBaseUrl]])],512),[[Ue,r.value.modelProvider==="custom_openai"]]),ae(e("div",qu,[e("label",Hu,oe(d.value)+":",1),e("div",ju,[ae(e("input",{type:"text",id:"settingsModelName","onUpdate:modelValue":l[4]||(l[4]=v=>r.value.modelName=v),placeholder:x.value},null,8,Ju),[[we,r.value.modelName]]),ae(e("button",{type:"button",class:"fetch-models-btn",title:"è·å–å¯ç”¨æ¨¡å‹åˆ—è¡¨",onClick:V,disabled:p.value},[l[16]||(l[16]=e("span",{class:"fetch-icon"},"ğŸ”",-1)),e("span",Xu,oe(p.value?"è·å–ä¸­...":"è·å–æ¨¡å‹"),1)],8,Yu),[[Ue,K.value]])]),k.value.length>0?(B(),A("div",Gu,[Se(We,{"model-value":r.value.modelName,options:L.value,onChange:l[5]||(l[5]=v=>{r.value.modelName=v})},null,8,["model-value","options"]),e("span",Zu,"å…± "+oe(k.value.length)+" ä¸ªæ¨¡å‹",1)])):de("",!0)],512),[[Ue,!$.value]]),ae(e("div",Qu,[l[17]||(l[17]=e("label",null,"æœ¬åœ°æ¨¡å‹:",-1)),e("div",ec,[r.value.modelProvider==="ollama"?(B(),A("div",tc,[e("button",{class:"settings-test-btn",onClick:X,disabled:p.value},oe(p.value?"è·å–ä¸­...":"ğŸ”„ åˆ·æ–°æ¨¡å‹åˆ—è¡¨"),9,oc),f.value.length>0?(B(),ut(We,{key:0,"model-value":r.value.modelName,options:M.value,onChange:l[6]||(l[6]=v=>r.value.modelName=v)},null,8,["model-value","options"])):(B(),A("p",nc,"ç‚¹å‡»åˆ·æ–°è·å–å¯ç”¨æ¨¡å‹"))])):r.value.modelProvider==="sakura"?(B(),A("div",sc,[e("button",{class:"settings-test-btn",onClick:ie,disabled:p.value},oe(p.value?"è·å–ä¸­...":"ğŸ”„ åˆ·æ–°æ¨¡å‹åˆ—è¡¨"),9,ac),P.value.length>0?(B(),ut(We,{key:0,"model-value":r.value.modelName,options:E.value,onChange:l[7]||(l[7]=v=>r.value.modelName=v)},null,8,["model-value","options"])):(B(),A("p",lc,"ç‚¹å‡»åˆ·æ–°è·å–å¯ç”¨æ¨¡å‹"))])):de("",!0)])],512),[[Ue,$.value]]),ae(e("div",ic,[e("div",rc,[l[18]||(l[18]=e("label",{for:"settingsRpmTranslation"},"RPMé™åˆ¶:",-1)),ae(e("input",{type:"number",id:"settingsRpmTranslation","onUpdate:modelValue":l[8]||(l[8]=v=>r.value.rpmTranslation=v),min:"0",step:"1"},null,512),[[we,r.value.rpmTranslation,void 0,{number:!0}]]),l[19]||(l[19]=e("div",{class:"input-hint"},"æ¯åˆ†é’Ÿè¯·æ±‚æ•°ï¼Œ0è¡¨ç¤ºæ— é™åˆ¶",-1))]),e("div",uc,[l[20]||(l[20]=e("label",{for:"settingsTranslationMaxRetries"},"é‡è¯•æ¬¡æ•°:",-1)),ae(e("input",{type:"number",id:"settingsTranslationMaxRetries","onUpdate:modelValue":l[9]||(l[9]=v=>r.value.translationMaxRetries=v),min:"0",max:"10",step:"1"},null,512),[[we,r.value.translationMaxRetries,void 0,{number:!0}]])])],512),[[Ue,j.value]]),ae(e("div",cc,[e("button",{class:"settings-test-btn",onClick:z,disabled:u.value},oe(u.value?"æµ‹è¯•ä¸­...":"ğŸ”— æµ‹è¯•è¿æ¥"),9,dc)],512),[[Ue,$.value]]),ae(e("div",gc,[e("button",{class:"settings-test-btn",onClick:R,disabled:u.value},oe(u.value?"æµ‹è¯•ä¸­...":"ğŸ”— æµ‹è¯•è¿æ¥"),9,pc)],512),[[Ue,!$.value]])]),e("div",mc,[l[26]||(l[26]=e("div",{class:"settings-group-title"},"æç¤ºè¯è®¾ç½®",-1)),e("div",vc,[l[23]||(l[23]=e("label",{for:"settingsPromptContent"},"ç¿»è¯‘æç¤ºè¯:",-1)),ae(e("textarea",{id:"settingsPromptContent","onUpdate:modelValue":l[10]||(l[10]=v=>r.value.promptContent=v),rows:"4",placeholder:"ç¿»è¯‘æç¤ºè¯"},null,512),[[we,r.value.promptContent]]),e("div",fc,[Se(We,{"model-value":r.value.translatePromptMode,options:s,onChange:l[11]||(l[11]=v=>{r.value.translatePromptMode=v,q()})},null,8,["model-value"]),l[22]||(l[22]=e("span",{class:"input-hint"},"JSONæ ¼å¼è¾“å‡ºæ›´ç»“æ„åŒ–",-1))]),Se(Ut,{"prompt-type":"translate",onSelect:I}),e("button",{type:"button",class:"reset-btn",onClick:y}," é‡ç½®ä¸ºé»˜è®¤ ")]),e("div",bc,[e("label",hc,[ae(e("input",{type:"checkbox","onUpdate:modelValue":l[12]||(l[12]=v=>r.value.enableTextboxPrompt=v)},null,512),[[nt,r.value.enableTextboxPrompt]]),l[24]||(l[24]=me(" å¯ç”¨æ–‡æœ¬æ¡†æç¤ºè¯ ",-1))])]),ae(e("div",yc,[l[25]||(l[25]=e("label",{for:"settingsTextboxPromptContent"},"æ–‡æœ¬æ¡†æç¤ºè¯:",-1)),ae(e("textarea",{id:"settingsTextboxPromptContent","onUpdate:modelValue":l[13]||(l[13]=v=>r.value.textboxPromptContent=v),rows:"3",placeholder:"æ–‡æœ¬æ¡†æç¤ºè¯"},null,512),[[we,r.value.textboxPromptContent]]),Se(Ut,{"prompt-type":"textbox",onSelect:F})],512),[[Ue,r.value.enableTextboxPrompt]])])]))}}),_c=He(xc,[["__scopeId","data-v-1eaa2d97"]]),Cc={class:"detection-settings"},Sc={class:"settings-group"},kc={class:"settings-item"},wc={class:"settings-group"},$c={class:"settings-item"},Tc={class:"settings-row"},Ic={class:"settings-item"},Pc={class:"settings-item"},Rc={class:"settings-row"},Dc={class:"settings-item"},Mc={class:"settings-item"},Ec={class:"settings-group"},Bc={class:"settings-item"},Ac={class:"checkbox-label"},Lc={class:"settings-row"},Fc={class:"settings-item"},Uc={class:"settings-item"},Oc={class:"settings-group"},zc={class:"settings-item"},Nc={class:"checkbox-label"},Vc=je({__name:"DetectionSettings",setup(n){const t=[{label:"CTD (Comic Text Detector)",value:"ctd"},{label:"YOLO",value:"yolo"},{label:"YOLOv5",value:"yolov5"},{label:"Default (DBNet)",value:"default"}],s=ze(),o=bo({textDetector:s.settings.textDetector,boxExpandRatio:s.settings.boxExpand.ratio,boxExpandTop:s.settings.boxExpand.top,boxExpandBottom:s.settings.boxExpand.bottom,boxExpandLeft:s.settings.boxExpand.left,boxExpandRight:s.settings.boxExpand.right,usePreciseMask:s.settings.preciseMask.enabled,maskDilateSize:s.settings.preciseMask.dilateSize,maskBoxExpandRatio:s.settings.preciseMask.boxExpandRatio,showDetectionDebug:s.settings.showDetectionDebug}),i=Q(()=>["ctd","default"].includes(o.textDetector));Ce(()=>o.textDetector,a=>{s.setTextDetector(a)}),Ce(()=>o.boxExpandRatio,a=>{s.updateBoxExpand({ratio:a})}),Ce(()=>o.boxExpandTop,a=>{s.updateBoxExpand({top:a})}),Ce(()=>o.boxExpandBottom,a=>{s.updateBoxExpand({bottom:a})}),Ce(()=>o.boxExpandLeft,a=>{s.updateBoxExpand({left:a})}),Ce(()=>o.boxExpandRight,a=>{s.updateBoxExpand({right:a})}),Ce(()=>o.usePreciseMask,a=>{s.updatePreciseMask({enabled:a})}),Ce(()=>o.maskDilateSize,a=>{s.updatePreciseMask({dilateSize:a})}),Ce(()=>o.maskBoxExpandRatio,a=>{s.updatePreciseMask({boxExpandRatio:a})}),Ce(()=>o.showDetectionDebug,a=>{s.setShowDetectionDebug(a)});function r(){i.value||(o.usePreciseMask=!1)}return(a,u)=>(B(),A("div",Cc,[e("div",Sc,[u[11]||(u[11]=e("div",{class:"settings-group-title"},"æ–‡å­—æ£€æµ‹å™¨",-1)),e("div",kc,[u[10]||(u[10]=e("label",{for:"settingsTextDetector"},"æ£€æµ‹å™¨ç±»å‹:",-1)),Se(We,{modelValue:o.textDetector,"onUpdate:modelValue":u[0]||(u[0]=p=>o.textDetector=p),options:t,onChange:r},null,8,["modelValue"])])]),e("div",wc,[u[18]||(u[18]=e("div",{class:"settings-group-title"},"æ–‡æœ¬æ¡†æ‰©å±•å‚æ•°",-1)),e("div",$c,[u[12]||(u[12]=e("label",{for:"settingsBoxExpandRatio"},"æ•´ä½“æ‰©å±• (%):",-1)),ae(e("input",{type:"number",id:"settingsBoxExpandRatio","onUpdate:modelValue":u[1]||(u[1]=p=>o.boxExpandRatio=p),min:"0",max:"50",step:"1"},null,512),[[we,o.boxExpandRatio,void 0,{number:!0}]]),u[13]||(u[13]=e("div",{class:"input-hint"},"å‘å››å‘¨å‡åŒ€æ‰©å±•çš„ç™¾åˆ†æ¯” (0-50%)",-1))]),e("div",Tc,[e("div",Ic,[u[14]||(u[14]=e("label",{for:"settingsBoxExpandTop"},"ä¸Šæ–¹æ‰©å±• (%):",-1)),ae(e("input",{type:"number",id:"settingsBoxExpandTop","onUpdate:modelValue":u[2]||(u[2]=p=>o.boxExpandTop=p),min:"0",max:"50",step:"1"},null,512),[[we,o.boxExpandTop,void 0,{number:!0}]])]),e("div",Pc,[u[15]||(u[15]=e("label",{for:"settingsBoxExpandBottom"},"ä¸‹æ–¹æ‰©å±• (%):",-1)),ae(e("input",{type:"number",id:"settingsBoxExpandBottom","onUpdate:modelValue":u[3]||(u[3]=p=>o.boxExpandBottom=p),min:"0",max:"50",step:"1"},null,512),[[we,o.boxExpandBottom,void 0,{number:!0}]])])]),e("div",Rc,[e("div",Dc,[u[16]||(u[16]=e("label",{for:"settingsBoxExpandLeft"},"å·¦ä¾§æ‰©å±• (%):",-1)),ae(e("input",{type:"number",id:"settingsBoxExpandLeft","onUpdate:modelValue":u[4]||(u[4]=p=>o.boxExpandLeft=p),min:"0",max:"50",step:"1"},null,512),[[we,o.boxExpandLeft,void 0,{number:!0}]])]),e("div",Mc,[u[17]||(u[17]=e("label",{for:"settingsBoxExpandRight"},"å³ä¾§æ‰©å±• (%):",-1)),ae(e("input",{type:"number",id:"settingsBoxExpandRight","onUpdate:modelValue":u[5]||(u[5]=p=>o.boxExpandRight=p),min:"0",max:"50",step:"1"},null,512),[[we,o.boxExpandRight,void 0,{number:!0}]])])])]),ae(e("div",Ec,[u[25]||(u[25]=e("div",{class:"settings-group-title"},"ç²¾ç¡®æ–‡å­—æ©è†œ",-1)),e("div",Bc,[e("label",Ac,[ae(e("input",{type:"checkbox","onUpdate:modelValue":u[6]||(u[6]=p=>o.usePreciseMask=p)},null,512),[[nt,o.usePreciseMask]]),u[19]||(u[19]=me(" å¯ç”¨ç²¾ç¡®æ–‡å­—æ©è†œ ",-1))]),u[20]||(u[20]=e("div",{class:"input-hint"},"ä½¿ç”¨æ›´ç²¾ç¡®çš„æ–‡å­—åŒºåŸŸæ©è†œè¿›è¡Œä¿®å¤",-1))]),ae(e("div",Lc,[e("div",Fc,[u[21]||(u[21]=e("label",{for:"settingsMaskDilateSize"},"è†¨èƒ€å¤§å°:",-1)),ae(e("input",{type:"number",id:"settingsMaskDilateSize","onUpdate:modelValue":u[7]||(u[7]=p=>o.maskDilateSize=p),min:"0",step:"1"},null,512),[[we,o.maskDilateSize,void 0,{number:!0}]]),u[22]||(u[22]=e("div",{class:"input-hint"},"æ©è†œè†¨èƒ€åƒç´ æ•°",-1))]),e("div",Uc,[u[23]||(u[23]=e("label",{for:"settingsMaskBoxExpandRatio"},"æ ‡æ³¨æ¡†æ‰©å¤§æ¯”ä¾‹ (%):",-1)),ae(e("input",{type:"number",id:"settingsMaskBoxExpandRatio","onUpdate:modelValue":u[8]||(u[8]=p=>o.maskBoxExpandRatio=p),min:"0",max:"100",step:"1"},null,512),[[we,o.maskBoxExpandRatio,void 0,{number:!0}]]),u[24]||(u[24]=e("div",{class:"input-hint"},"æ ‡æ³¨æ¡†åŒºåŸŸæ‰©å¤§ç™¾åˆ†æ¯”",-1))])],512),[[Ue,o.usePreciseMask]])],512),[[Ue,i.value]]),e("div",Oc,[u[28]||(u[28]=e("div",{class:"settings-group-title"},"è°ƒè¯•é€‰é¡¹",-1)),e("div",zc,[e("label",Nc,[ae(e("input",{type:"checkbox","onUpdate:modelValue":u[9]||(u[9]=p=>o.showDetectionDebug=p)},null,512),[[nt,o.showDetectionDebug]]),u[26]||(u[26]=me(" æ˜¾ç¤ºæ£€æµ‹æ¡†è°ƒè¯•ä¿¡æ¯ ",-1))]),u[27]||(u[27]=e("div",{class:"input-hint"},"åœ¨ç¿»è¯‘ç»“æœä¸­æ˜¾ç¤ºæ°”æ³¡æ£€æµ‹æ¡†ï¼Œç”¨äºè°ƒè¯•",-1))])])]))}}),Wc=He(Vc,[["__scopeId","data-v-c12c43ee"]]),Kc={class:"hq-translation-settings"},qc={class:"settings-group"},Hc={class:"settings-row"},jc={class:"settings-item"},Jc={class:"settings-item"},Yc={class:"password-input-wrapper"},Xc=["type"],Gc={key:0,class:"eye-icon"},Zc={key:1,class:"eye-off-icon"},Qc={class:"settings-item"},ed={class:"settings-item"},td={class:"model-input-with-fetch"},od=["disabled"],nd={class:"fetch-text"},sd={key:0,class:"model-select-container"},ad={class:"model-count"},ld={class:"settings-item"},id=["disabled"],rd={class:"settings-group"},ud={class:"settings-row"},cd={class:"settings-item"},dd={class:"settings-item"},gd={class:"settings-row"},pd={class:"settings-item"},md={class:"settings-item"},vd={class:"settings-group"},fd={class:"settings-row"},bd={class:"settings-item"},hd={class:"checkbox-label"},yd={class:"settings-item"},xd={class:"settings-row"},_d={class:"settings-item"},Cd={class:"checkbox-label"},Sd={class:"settings-item"},kd={class:"checkbox-label"},wd={class:"settings-group"},$d={class:"settings-item"},Td=je({__name:"HqTranslationSettings",setup(n){const t=[{label:"SiliconFlow",value:"siliconflow"},{label:"DeepSeek",value:"deepseek"},{label:"ç«å±±å¼•æ“",value:"volcano"},{label:"Google Gemini",value:"gemini"},{label:"è‡ªå®šä¹‰ OpenAI å…¼å®¹æœåŠ¡",value:"custom_openai"}],s=[{label:"Geminié£æ ¼ (reasoning_effort=low)",value:"gemini"},{label:"ç«å±±å¼•æ“é£æ ¼ (thinking=null)",value:"volcano"}],o=ze(),i=ct(),r=Q(()=>o.settings.hqTranslation),a=C({apiKey:o.settings.hqTranslation.apiKey,modelName:o.settings.hqTranslation.modelName,customBaseUrl:o.settings.hqTranslation.customBaseUrl,batchSize:o.settings.hqTranslation.batchSize,sessionReset:o.settings.hqTranslation.sessionReset,rpmLimit:o.settings.hqTranslation.rpmLimit,maxRetries:o.settings.hqTranslation.maxRetries,lowReasoning:o.settings.hqTranslation.lowReasoning,noThinkingMethod:o.settings.hqTranslation.noThinkingMethod,forceJsonOutput:o.settings.hqTranslation.forceJsonOutput,useStream:o.settings.hqTranslation.useStream,prompt:o.settings.hqTranslation.prompt});Ce(()=>a.value.apiKey,g=>{o.updateHqTranslation({apiKey:g})}),Ce(()=>a.value.modelName,g=>{o.updateHqTranslation({modelName:g})}),Ce(()=>a.value.customBaseUrl,g=>{o.updateHqTranslation({customBaseUrl:g})}),Ce(()=>a.value.batchSize,g=>{o.updateHqTranslation({batchSize:g})}),Ce(()=>a.value.sessionReset,g=>{o.updateHqTranslation({sessionReset:g})}),Ce(()=>a.value.rpmLimit,g=>{o.updateHqTranslation({rpmLimit:g})}),Ce(()=>a.value.maxRetries,g=>{o.updateHqTranslation({maxRetries:g})}),Ce(()=>a.value.lowReasoning,g=>{o.updateHqTranslation({lowReasoning:g})}),Ce(()=>a.value.noThinkingMethod,g=>{o.updateHqTranslation({noThinkingMethod:g})}),Ce(()=>a.value.forceJsonOutput,g=>{o.updateHqTranslation({forceJsonOutput:g})}),Ce(()=>a.value.useStream,g=>{o.updateHqTranslation({useStream:g})}),Ce(()=>a.value.prompt,g=>{o.updateHqTranslation({prompt:g})});const u=C(!1),p=C(!1),k=C([]),f=C(!1),P=Q(()=>{const g=[{label:"-- é€‰æ‹©æ¨¡å‹ --",value:""}];return k.value.forEach(d=>g.push({label:d,value:d})),g});function L(g){o.setHqProvider(g),k.value=[],M()}function M(){const g=o.settings.hqTranslation;a.value.apiKey=g.apiKey,a.value.modelName=g.modelName,a.value.customBaseUrl=g.customBaseUrl,a.value.batchSize=g.batchSize,a.value.sessionReset=g.sessionReset,a.value.rpmLimit=g.rpmLimit,a.value.maxRetries=g.maxRetries,a.value.lowReasoning=g.lowReasoning,a.value.noThinkingMethod=g.noThinkingMethod,a.value.forceJsonOutput=g.forceJsonOutput,a.value.useStream=g.useStream,a.value.prompt=g.prompt}function E(g){return{siliconflow:"SiliconFlow",deepseek:"DeepSeek",volcano:"ç«å±±å¼•æ“",gemini:"Google Gemini",custom_openai:"è‡ªå®šä¹‰OpenAI"}[g]||g}async function $(){const g=r.value.provider,d=a.value.apiKey?.trim(),x=a.value.customBaseUrl?.trim();if(!d){i.warning("è¯·å…ˆå¡«å†™ API Key");return}if(!["siliconflow","deepseek","volcano","gemini","custom_openai"].includes(g)){i.warning(`${E(g)} ä¸æ”¯æŒè‡ªåŠ¨è·å–æ¨¡å‹åˆ—è¡¨`);return}if(g==="custom_openai"&&!x){i.warning("è‡ªå®šä¹‰æœåŠ¡éœ€è¦å…ˆå¡«å†™ Base URL");return}p.value=!0;try{const q=await Ke.fetchModels(g,d,x);q.success&&q.models&&q.models.length>0?(k.value=q.models.map(V=>V.id),i.success(`è·å–åˆ° ${q.models.length} ä¸ªæ¨¡å‹`)):i.warning(q.message||"æœªè·å–åˆ°å¯ç”¨æ¨¡å‹")}catch(q){const V=q instanceof Error?q.message:"è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥";i.error(V)}finally{p.value=!1}}async function j(){const g=r.value.provider,d=a.value.apiKey?.trim(),x=a.value.modelName?.trim(),_=a.value.customBaseUrl?.trim();if(!d){i.warning("è¯·å…ˆå¡«å†™ API Key");return}if(!x){i.warning("è¯·å¡«å†™æ¨¡å‹åç§°");return}if(g==="custom_openai"&&!_){i.warning("è‡ªå®šä¹‰æœåŠ¡éœ€è¦å¡«å†™ Base URL");return}f.value=!0,i.info("æ­£åœ¨æµ‹è¯•è¿æ¥...");try{const q=await Ke.testAiTranslateConnection({provider:g,apiKey:d,modelName:x,baseUrl:_});q.success?i.success(q.message||`${E(g)} è¿æ¥æˆåŠŸ!`):i.error(q.message||q.error||"è¿æ¥å¤±è´¥")}catch(q){const V=q instanceof Error?q.message:"è¿æ¥æµ‹è¯•å¤±è´¥";i.error(V)}finally{f.value=!1}}function K(){o.updateHqTranslation({prompt:Qo}),a.value.prompt=Qo,i.success("å·²é‡ç½®ä¸ºé»˜è®¤æç¤ºè¯")}function U(g,d){o.updateHqTranslation({prompt:g}),a.value.prompt=g,i.success(`å·²åº”ç”¨æç¤ºè¯: ${d}`)}return(g,d)=>(B(),A("div",Kc,[e("div",qc,[d[20]||(d[20]=e("div",{class:"settings-group-title"},"é«˜è´¨é‡ç¿»è¯‘æœåŠ¡é…ç½®",-1)),e("div",Hc,[e("div",jc,[d[15]||(d[15]=e("label",{for:"settingsHqTranslateProvider"},"æœåŠ¡å•†:",-1)),Se(We,{"model-value":r.value.provider,options:t,onChange:d[0]||(d[0]=x=>L(x))},null,8,["model-value"])]),e("div",Jc,[d[16]||(d[16]=e("label",{for:"settingsHqApiKey"},"API Key:",-1)),e("div",Yc,[ae(e("input",{type:u.value?"text":"password",id:"settingsHqApiKey","onUpdate:modelValue":d[1]||(d[1]=x=>a.value.apiKey=x),class:"secure-input",placeholder:"è¯·è¾“å…¥API Key",autocomplete:"off"},null,8,Xc),[[$t,a.value.apiKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:d[2]||(d[2]=x=>u.value=!u.value)},[u.value?(B(),A("span",Zc,"ğŸ‘â€ğŸ—¨")):(B(),A("span",Gc,"ğŸ‘"))])])])]),ae(e("div",Qc,[d[17]||(d[17]=e("label",{for:"settingsHqCustomBaseUrl"},"Base URL:",-1)),ae(e("input",{type:"text",id:"settingsHqCustomBaseUrl","onUpdate:modelValue":d[3]||(d[3]=x=>a.value.customBaseUrl=x),placeholder:"ä¾‹å¦‚: https://api.example.com/v1"},null,512),[[we,a.value.customBaseUrl]])],512),[[Ue,r.value.provider==="custom_openai"]]),e("div",ed,[d[19]||(d[19]=e("label",{for:"settingsHqModelName"},"æ¨¡å‹åç§°:",-1)),e("div",td,[ae(e("input",{type:"text",id:"settingsHqModelName","onUpdate:modelValue":d[4]||(d[4]=x=>a.value.modelName=x),placeholder:"è¯·è¾“å…¥æ¨¡å‹åç§°"},null,512),[[we,a.value.modelName]]),e("button",{type:"button",class:"fetch-models-btn",title:"è·å–å¯ç”¨æ¨¡å‹åˆ—è¡¨",onClick:$,disabled:p.value},[d[18]||(d[18]=e("span",{class:"fetch-icon"},"ğŸ”",-1)),e("span",nd,oe(p.value?"è·å–ä¸­...":"è·å–æ¨¡å‹"),1)],8,od)]),k.value.length>0?(B(),A("div",sd,[Se(We,{modelValue:a.value.modelName,"onUpdate:modelValue":d[5]||(d[5]=x=>a.value.modelName=x),options:P.value},null,8,["modelValue","options"]),e("span",ad,"å…± "+oe(k.value.length)+" ä¸ªæ¨¡å‹",1)])):de("",!0)]),e("div",ld,[e("button",{class:"settings-test-btn",onClick:j,disabled:f.value},oe(f.value?"æµ‹è¯•ä¸­...":"ğŸ”— æµ‹è¯•è¿æ¥"),9,id)])]),e("div",rd,[d[28]||(d[28]=e("div",{class:"settings-group-title"},"æ‰¹å¤„ç†è®¾ç½®",-1)),e("div",ud,[e("div",cd,[d[21]||(d[21]=e("label",{for:"settingsHqBatchSize"},"æ‰¹æ¬¡å¤§å°:",-1)),ae(e("input",{type:"number",id:"settingsHqBatchSize","onUpdate:modelValue":d[6]||(d[6]=x=>a.value.batchSize=x),min:"1",max:"10",step:"1"},null,512),[[we,a.value.batchSize,void 0,{number:!0}]]),d[22]||(d[22]=e("div",{class:"input-hint"},"æ¯æ‰¹å¤„ç†çš„å›¾ç‰‡æ•°é‡ (æ¨è3-5å¼ )",-1))]),e("div",dd,[d[23]||(d[23]=e("label",{for:"settingsHqSessionReset"},"ä¼šè¯é‡ç½®é¢‘ç‡:",-1)),ae(e("input",{type:"number",id:"settingsHqSessionReset","onUpdate:modelValue":d[7]||(d[7]=x=>a.value.sessionReset=x),min:"1",step:"1"},null,512),[[we,a.value.sessionReset,void 0,{number:!0}]]),d[24]||(d[24]=e("div",{class:"input-hint"},"å¤šå°‘æ‰¹æ¬¡åé‡ç½®ä¸Šä¸‹æ–‡",-1))])]),e("div",gd,[e("div",pd,[d[25]||(d[25]=e("label",{for:"settingsHqRpmLimit"},"RPMé™åˆ¶:",-1)),ae(e("input",{type:"number",id:"settingsHqRpmLimit","onUpdate:modelValue":d[8]||(d[8]=x=>a.value.rpmLimit=x),min:"0",step:"1"},null,512),[[we,a.value.rpmLimit,void 0,{number:!0}]]),d[26]||(d[26]=e("div",{class:"input-hint"},"æ¯åˆ†é’Ÿè¯·æ±‚æ•°ï¼Œ0è¡¨ç¤ºæ— é™åˆ¶",-1))]),e("div",md,[d[27]||(d[27]=e("label",{for:"settingsHqMaxRetries"},"é‡è¯•æ¬¡æ•°:",-1)),ae(e("input",{type:"number",id:"settingsHqMaxRetries","onUpdate:modelValue":d[9]||(d[9]=x=>a.value.maxRetries=x),min:"0",max:"10",step:"1"},null,512),[[we,a.value.maxRetries,void 0,{number:!0}]])])])]),e("div",vd,[d[36]||(d[36]=e("div",{class:"settings-group-title"},"é«˜çº§é€‰é¡¹",-1)),e("div",fd,[e("div",bd,[e("label",hd,[ae(e("input",{type:"checkbox","onUpdate:modelValue":d[10]||(d[10]=x=>a.value.lowReasoning=x)},null,512),[[nt,a.value.lowReasoning]]),d[29]||(d[29]=me(" ä½æ¨ç†æ¨¡å¼ ",-1))]),d[30]||(d[30]=e("div",{class:"input-hint"},"å‡å°‘æ¨¡å‹æ¨ç†æ·±åº¦ï¼Œæé«˜é€Ÿåº¦",-1))]),e("div",yd,[d[31]||(d[31]=e("label",{for:"settingsHqNoThinkingMethod"},"å–æ¶ˆæ€è€ƒæ–¹æ³•:",-1)),Se(We,{modelValue:a.value.noThinkingMethod,"onUpdate:modelValue":d[11]||(d[11]=x=>a.value.noThinkingMethod=x),options:s},null,8,["modelValue"])])]),e("div",xd,[e("div",_d,[e("label",Cd,[ae(e("input",{type:"checkbox","onUpdate:modelValue":d[12]||(d[12]=x=>a.value.forceJsonOutput=x)},null,512),[[nt,a.value.forceJsonOutput]]),d[32]||(d[32]=me(" å¼ºåˆ¶JSONè¾“å‡º ",-1))]),d[33]||(d[33]=e("div",{class:"input-hint"},"ä½¿ç”¨ response_format: json_object",-1))]),e("div",Sd,[e("label",kd,[ae(e("input",{type:"checkbox","onUpdate:modelValue":d[13]||(d[13]=x=>a.value.useStream=x)},null,512),[[nt,a.value.useStream]]),d[34]||(d[34]=me(" æµå¼è°ƒç”¨ ",-1))]),d[35]||(d[35]=e("div",{class:"input-hint"},"ä½¿ç”¨æµå¼APIè°ƒç”¨",-1))])])]),e("div",wd,[d[37]||(d[37]=e("div",{class:"settings-group-title"},"é«˜è´¨é‡ç¿»è¯‘æç¤ºè¯",-1)),e("div",$d,[ae(e("textarea",{id:"settingsHqPrompt","onUpdate:modelValue":d[14]||(d[14]=x=>a.value.prompt=x),rows:"6",placeholder:"é«˜è´¨é‡ç¿»è¯‘æç¤ºè¯"},null,512),[[we,a.value.prompt]]),Se(Ut,{"prompt-type":"hq_translate",onSelect:U}),e("button",{class:"btn btn-secondary btn-sm",onClick:K},"é‡ç½®ä¸ºé»˜è®¤")])])]))}}),Id=He(Td,[["__scopeId","data-v-23f4a3f7"]]),Pd={class:"proofreading-settings"},Rd={class:"settings-group"},Dd={class:"settings-item"},Md={class:"checkbox-label"},Ed={class:"settings-item"},Bd={class:"settings-group"},Ad={class:"round-header"},Ld={class:"round-title"},Fd=["onClick","disabled"],Ud={class:"round-content"},Od={class:"settings-item"},zd=["onUpdate:modelValue"],Nd={class:"settings-row"},Vd={class:"settings-item"},Wd={class:"settings-item"},Kd={class:"password-input-wrapper"},qd=["type","onUpdate:modelValue"],Hd=["onClick"],jd={key:0,class:"eye-icon"},Jd={key:1,class:"eye-off-icon"},Yd={class:"settings-item"},Xd=["onUpdate:modelValue"],Gd={class:"settings-item"},Zd={class:"model-input-with-fetch"},Qd=["onUpdate:modelValue"],eg=["onClick","disabled"],tg={class:"fetch-text"},og={key:0,class:"model-select-container"},ng={class:"model-count"},sg={class:"settings-item"},ag=["onClick","disabled"],lg={class:"settings-row"},ig={class:"settings-item"},rg=["onUpdate:modelValue"],ug={class:"settings-item"},cg=["onUpdate:modelValue"],dg={class:"settings-item"},gg=["onUpdate:modelValue"],pg={class:"settings-row"},mg={class:"settings-item"},vg={class:"checkbox-label"},fg=["onUpdate:modelValue"],bg={class:"settings-item"},hg={class:"settings-item"},yg={class:"checkbox-label"},xg=["onUpdate:modelValue"],_g={class:"settings-item"},Cg=["onUpdate:modelValue"],Sg=["onClick"],kg=je({__name:"ProofreadingSettings",setup(n){const t=[{label:"SiliconFlow",value:"siliconflow"},{label:"DeepSeek",value:"deepseek"},{label:"ç«å±±å¼•æ“",value:"volcano"},{label:"Google Gemini",value:"gemini"},{label:"è‡ªå®šä¹‰ OpenAI å…¼å®¹æœåŠ¡",value:"custom_openai"}],s=[{label:"Geminié£æ ¼",value:"gemini"},{label:"ç«å±±å¼•æ“é£æ ¼",value:"volcano"}],o=ze(),i=ct(),r=C({}),a=C({}),u=C({}),p=Q(()=>o.settings.proofreading.rounds),k=Q({get:()=>o.settings.proofreading.maxRetries,set:U=>o.setProofreadingMaxRetries(U)}),f=Q({get:()=>o.settings.proofreading.enabled,set:U=>o.setProofreadingEnabled(U)});Ce(()=>o.settings.proofreading.rounds,()=>{o.saveToStorage()},{deep:!0});function P(U){const g=u.value[U]||[],d=[{label:"-- é€‰æ‹©æ¨¡å‹ --",value:""}];return g.forEach(x=>d.push({label:x,value:x})),d}async function L(U){const g=p.value[U];if(!g)return;const d=g.provider,x=g.apiKey?.trim(),_=g.customBaseUrl?.trim();if(!x){i.warning("è¯·å…ˆå¡«å†™ API Key");return}if(!["siliconflow","deepseek","volcano","gemini","custom_openai"].includes(d)){i.warning("å½“å‰æœåŠ¡å•†ä¸æ”¯æŒè·å–æ¨¡å‹åˆ—è¡¨");return}r.value[U]=!0;try{const V=await Ke.fetchModels(d,x,_);V.success&&V.models&&V.models.length>0?(u.value[U]=V.models.map(se=>se.id),i.success(`è½®æ¬¡ ${U+1}: è·å–åˆ° ${V.models.length} ä¸ªæ¨¡å‹`)):i.warning(V.message||"æœªè·å–åˆ°å¯ç”¨æ¨¡å‹")}catch(V){const se=V instanceof Error?V.message:"è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥";i.error(se)}finally{r.value[U]=!1}}async function M(U){const g=p.value[U];if(!g)return;const d=g.provider,x=g.apiKey?.trim(),_=g.modelName?.trim(),q=g.customBaseUrl?.trim();if(!x){i.warning("è¯·å…ˆå¡«å†™ API Key");return}if(!_){i.warning("è¯·å¡«å†™æ¨¡å‹åç§°");return}a.value[U]=!0,i.info(`æ­£åœ¨æµ‹è¯•è½®æ¬¡ ${U+1} çš„è¿æ¥...`);try{const V=await Ke.testAiTranslateConnection({provider:d,apiKey:x,modelName:_,baseUrl:q});V.success?i.success(V.message||"è¿æ¥æˆåŠŸ!"):i.error(V.message||V.error||"è¿æ¥å¤±è´¥")}catch(V){const se=V instanceof Error?V.message:"è¿æ¥æµ‹è¯•å¤±è´¥";i.error(se)}finally{a.value[U]=!1}}function E(){const U={name:`ç¬¬${p.value.length+1}è½®æ ¡å¯¹`,provider:"siliconflow",apiKey:"",modelName:"",customBaseUrl:"",batchSize:3,sessionReset:20,rpmLimit:7,lowReasoning:!1,noThinkingMethod:"gemini",forceJsonOutput:!0,prompt:en,showApiKey:!1};o.addProofreadingRound(U),i.success("å·²æ·»åŠ æ–°çš„æ ¡å¯¹è½®æ¬¡")}function $(U){if(p.value.length<=1){i.warning("è‡³å°‘éœ€è¦ä¿ç•™ä¸€ä¸ªæ ¡å¯¹è½®æ¬¡");return}o.removeProofreadingRound(U),i.success("å·²åˆ é™¤æ ¡å¯¹è½®æ¬¡")}function j(U){o.updateProofreadingRound(U,{prompt:en}),i.success("å·²é‡ç½®ä¸ºé»˜è®¤æç¤ºè¯")}function K(U,g,d){o.updateProofreadingRound(U,{prompt:g}),i.success(`å·²åº”ç”¨æç¤ºè¯: ${d}`)}return(U,g)=>(B(),A("div",Pd,[e("div",Rd,[g[5]||(g[5]=e("div",{class:"settings-group-title"},"AIæ ¡å¯¹è®¾ç½®",-1)),e("div",Dd,[e("label",Md,[ae(e("input",{type:"checkbox","onUpdate:modelValue":g[0]||(g[0]=d=>f.value=d)},null,512),[[nt,f.value]]),g[2]||(g[2]=me(" å¯ç”¨AIæ ¡å¯¹ ",-1))]),g[3]||(g[3]=e("div",{class:"input-hint"},"ç¿»è¯‘å®Œæˆåè‡ªåŠ¨è¿›è¡ŒAIæ ¡å¯¹",-1))]),e("div",Ed,[g[4]||(g[4]=e("label",{for:"settingsProofreadingMaxRetries"},"å…¨å±€é‡è¯•æ¬¡æ•°:",-1)),ae(e("input",{type:"number",id:"settingsProofreadingMaxRetries","onUpdate:modelValue":g[1]||(g[1]=d=>k.value=d),min:"0",max:"10",step:"1"},null,512),[[we,k.value,void 0,{number:!0}]])])]),ae(e("div",Bd,[e("div",{class:"settings-group-title"},[g[6]||(g[6]=me(" æ ¡å¯¹è½®æ¬¡é…ç½® ",-1)),e("button",{class:"btn btn-secondary btn-sm",onClick:E},"+ æ·»åŠ è½®æ¬¡")]),(B(!0),A(Oe,null,Ye(p.value,(d,x)=>(B(),A("div",{key:x,class:"proofreading-round"},[e("div",Ad,[e("span",Ld,"è½®æ¬¡ "+oe(x+1)+": "+oe(d.name||"æœªå‘½å"),1),e("button",{class:"btn btn-danger btn-sm",onClick:_=>$(x),disabled:p.value.length<=1}," åˆ é™¤ ",8,Fd)]),e("div",Ud,[e("div",Od,[g[7]||(g[7]=e("label",null,"è½®æ¬¡åç§°:",-1)),ae(e("input",{type:"text","onUpdate:modelValue":_=>d.name=_,placeholder:"å¦‚: ç¬¬ä¸€è½®æ ¡å¯¹"},null,8,zd),[[we,d.name]])]),e("div",Nd,[e("div",Vd,[g[8]||(g[8]=e("label",null,"æœåŠ¡å•†:",-1)),Se(We,{modelValue:d.provider,"onUpdate:modelValue":_=>d.provider=_,options:t},null,8,["modelValue","onUpdate:modelValue"])]),e("div",Wd,[g[9]||(g[9]=e("label",null,"API Key:",-1)),e("div",Kd,[ae(e("input",{type:d.showApiKey?"text":"password","onUpdate:modelValue":_=>d.apiKey=_,class:"secure-input",placeholder:"è¯·è¾“å…¥API Key",autocomplete:"off"},null,8,qd),[[$t,d.apiKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:_=>d.showApiKey=!d.showApiKey},[d.showApiKey?(B(),A("span",Jd,"ğŸ‘â€ğŸ—¨")):(B(),A("span",jd,"ğŸ‘"))],8,Hd)])])]),ae(e("div",Yd,[g[10]||(g[10]=e("label",null,"Base URL:",-1)),ae(e("input",{type:"text","onUpdate:modelValue":_=>d.customBaseUrl=_,placeholder:"ä¾‹å¦‚: https://api.example.com/v1"},null,8,Xd),[[we,d.customBaseUrl]])],512),[[Ue,d.provider==="custom_openai"]]),e("div",Gd,[g[12]||(g[12]=e("label",null,"æ¨¡å‹åç§°:",-1)),e("div",Zd,[ae(e("input",{type:"text","onUpdate:modelValue":_=>d.modelName=_,placeholder:"è¯·è¾“å…¥æ¨¡å‹åç§°"},null,8,Qd),[[we,d.modelName]]),e("button",{type:"button",class:"fetch-models-btn",title:"è·å–å¯ç”¨æ¨¡å‹åˆ—è¡¨",onClick:_=>L(x),disabled:r.value[x]},[g[11]||(g[11]=e("span",{class:"fetch-icon"},"ğŸ”",-1)),e("span",tg,oe(r.value[x]?"è·å–ä¸­...":"è·å–æ¨¡å‹"),1)],8,eg)]),u.value[x]&&u.value[x].length>0?(B(),A("div",og,[Se(We,{modelValue:d.modelName,"onUpdate:modelValue":_=>d.modelName=_,options:P(x)},null,8,["modelValue","onUpdate:modelValue","options"]),e("span",ng,"å…± "+oe(u.value[x].length)+" ä¸ªæ¨¡å‹",1)])):de("",!0)]),e("div",sg,[e("button",{class:"settings-test-btn",onClick:_=>M(x),disabled:a.value[x]},oe(a.value[x]?"æµ‹è¯•ä¸­...":"ğŸ”— æµ‹è¯•è¿æ¥"),9,ag)]),e("div",lg,[e("div",ig,[g[13]||(g[13]=e("label",null,"æ‰¹æ¬¡å¤§å°:",-1)),ae(e("input",{type:"number","onUpdate:modelValue":_=>d.batchSize=_,min:"1",max:"10",step:"1"},null,8,rg),[[we,d.batchSize,void 0,{number:!0}]])]),e("div",ug,[g[14]||(g[14]=e("label",null,"ä¼šè¯é‡ç½®é¢‘ç‡:",-1)),ae(e("input",{type:"number","onUpdate:modelValue":_=>d.sessionReset=_,min:"1",step:"1"},null,8,cg),[[we,d.sessionReset,void 0,{number:!0}]])]),e("div",dg,[g[15]||(g[15]=e("label",null,"RPMé™åˆ¶:",-1)),ae(e("input",{type:"number","onUpdate:modelValue":_=>d.rpmLimit=_,min:"0",step:"1"},null,8,gg),[[we,d.rpmLimit,void 0,{number:!0}]])])]),e("div",pg,[e("div",mg,[e("label",vg,[ae(e("input",{type:"checkbox","onUpdate:modelValue":_=>d.lowReasoning=_},null,8,fg),[[nt,d.lowReasoning]]),g[16]||(g[16]=me(" ä½æ¨ç†æ¨¡å¼ ",-1))])]),e("div",bg,[g[17]||(g[17]=e("label",null,"å–æ¶ˆæ€è€ƒæ–¹æ³•:",-1)),Se(We,{modelValue:d.noThinkingMethod,"onUpdate:modelValue":_=>d.noThinkingMethod=_,options:s},null,8,["modelValue","onUpdate:modelValue"])]),e("div",hg,[e("label",yg,[ae(e("input",{type:"checkbox","onUpdate:modelValue":_=>d.forceJsonOutput=_},null,8,xg),[[nt,d.forceJsonOutput]]),g[18]||(g[18]=me(" å¼ºåˆ¶JSONè¾“å‡º ",-1))])])]),e("div",_g,[g[19]||(g[19]=e("label",null,"æ ¡å¯¹æç¤ºè¯:",-1)),ae(e("textarea",{"onUpdate:modelValue":_=>d.prompt=_,rows:"4",placeholder:"æ ¡å¯¹æç¤ºè¯"},null,8,Cg),[[we,d.prompt]]),Se(Ut,{"prompt-type":"proofreading",onSelect:(_,q)=>K(x,_,q)},null,8,["onSelect"]),e("button",{class:"btn btn-secondary btn-sm",onClick:_=>j(x)},"é‡ç½®ä¸ºé»˜è®¤",8,Sg)])])]))),128))],512),[[Ue,f.value]])]))}}),wg=He(kg,[["__scopeId","data-v-663a7972"]]),$g={class:"prompt-library"},Tg={class:"settings-group"},Ig={class:"settings-item"},Pg={key:0,class:"settings-item"},Rg={class:"mode-hint"},Dg={class:"settings-group"},Mg={key:0,class:"loading-hint"},Eg={key:1,class:"empty-hint"},Bg={key:2,class:"prompt-list"},Ag=["onClick"],Lg={class:"prompt-name"},Fg={class:"prompt-actions"},Ug=["onClick"],Og=["onClick","disabled"],zg={class:"settings-group"},Ng={class:"settings-item"},Vg={class:"settings-item"},Wg={class:"prompt-editor-actions"},Kg=["disabled"],qg=je({__name:"PromptLibrary",setup(n){const t=[{label:"ç¿»è¯‘æç¤ºè¯",value:"translate"},{label:"æ–‡æœ¬æ¡†æç¤ºè¯",value:"textbox"},{label:"AIè§†è§‰OCRæç¤ºè¯",value:"ai_vision_ocr"},{label:"é«˜è´¨é‡ç¿»è¯‘æç¤ºè¯",value:"hq_translate"},{label:"æ ¡å¯¹æç¤ºè¯",value:"proofreading"}],s=[{label:"æ™®é€šæ¨¡å¼",value:"false"},{label:"JSONæ ¼å¼æ¨¡å¼",value:"true"}],o=ct(),i=ze(),r=C("translate"),a=C([]),u=C(""),p=C(""),k=C(""),f=C(!1),P=C(!1),L=Q(()=>r.value==="translate"||r.value==="ai_vision_ocr"),M=Q(()=>P.value?"é€‚ç”¨äºéœ€è¦ç»“æ„åŒ–è¾“å‡ºçš„åœºæ™¯":"é€‚ç”¨äºæ™®é€šç¿»è¯‘åœºæ™¯");async function E(){f.value=!0;try{let x;r.value==="textbox"?x=await Ke.getTextboxPrompts():x=await Ke.getPrompts(r.value);const _=x.prompt_names||[];a.value=_.map(q=>({name:q}))}catch(x){const _=x instanceof Error?x.message:"åŠ è½½æç¤ºè¯åˆ—è¡¨å¤±è´¥";o.error(_)}finally{f.value=!1}}async function $(x){u.value=x,p.value=x,await j(x)}async function j(x){try{let _;r.value==="textbox"?_=await Ke.getTextboxPromptContent(x):_=await Ke.getPromptContent(r.value,x),p.value=x,k.value=_.prompt_content||"",u.value=x,o.success("å·²åŠ è½½æç¤ºè¯")}catch(_){const q=_ instanceof Error?_.message:"åŠ è½½æç¤ºè¯å†…å®¹å¤±è´¥";o.error(q)}}async function K(){if(!p.value||!k.value){o.warning("è¯·è¾“å…¥æç¤ºè¯åç§°å’Œå†…å®¹");return}try{r.value==="textbox"?await Ke.saveTextboxPrompt(p.value,k.value):await Ke.savePrompt(r.value,p.value,k.value),o.success("æç¤ºè¯ä¿å­˜æˆåŠŸ"),p.value="",k.value="",await E()}catch(x){const _=x instanceof Error?x.message:"ä¿å­˜æç¤ºè¯å¤±è´¥";o.error(_)}}async function U(x){if(x==="default"){o.warning("é»˜è®¤æç¤ºè¯ä¸èƒ½åˆ é™¤");return}try{r.value==="textbox"?await Ke.deleteTextboxPrompt(x):await Ke.deletePrompt(r.value,x),o.success("æç¤ºè¯åˆ é™¤æˆåŠŸ"),u.value===x&&(u.value="",p.value="",k.value=""),await E()}catch(_){const q=_ instanceof Error?_.message:"åˆ é™¤æç¤ºè¯å¤±è´¥";o.error(q)}}function g(){u.value="",p.value="",k.value="",r.value==="translate"?P.value=i.settings.translation.isJsonMode:r.value==="ai_vision_ocr"?P.value=i.settings.aiVisionOcr.isJsonMode:P.value=!1,E()}function d(){r.value==="translate"?i.updateTranslationService({isJsonMode:P.value}):r.value==="ai_vision_ocr"&&i.updateAiVisionOcr({isJsonMode:P.value}),o.info(`å·²åˆ‡æ¢åˆ°${P.value?"JSONæ ¼å¼":"æ™®é€š"}æ¨¡å¼`)}return dt(()=>{P.value=i.settings.translation.isJsonMode,E()}),(x,_)=>(B(),A("div",$g,[e("div",Tg,[_[6]||(_[6]=e("div",{class:"settings-group-title"},"æç¤ºè¯ç®¡ç†",-1)),e("div",Ig,[_[4]||(_[4]=e("label",{for:"promptType"},"æç¤ºè¯ç±»å‹:",-1)),Se(We,{modelValue:r.value,"onUpdate:modelValue":_[0]||(_[0]=q=>r.value=q),options:t,onChange:g},null,8,["modelValue"])]),L.value?(B(),A("div",Pg,[_[5]||(_[5]=e("label",{for:"promptMode"},"æç¤ºè¯æ¨¡å¼:",-1)),Se(We,{"model-value":P.value?"true":"false",options:s,onChange:_[1]||(_[1]=q=>{P.value=q==="true",d()})},null,8,["model-value"]),e("span",Rg,oe(M.value),1)])):de("",!0)]),e("div",Dg,[_[7]||(_[7]=e("div",{class:"settings-group-title"},"å·²ä¿å­˜çš„æç¤ºè¯",-1)),f.value?(B(),A("div",Mg,"åŠ è½½ä¸­...")):a.value.length===0?(B(),A("div",Eg,"æš‚æ— ä¿å­˜çš„æç¤ºè¯")):(B(),A("div",Bg,[(B(!0),A(Oe,null,Ye(a.value,q=>(B(),A("div",{key:q.name,class:Ie(["prompt-item",{active:u.value===q.name}]),onClick:V=>$(q.name)},[e("span",Lg,oe(q.name),1),e("div",Fg,[e("button",{class:"btn btn-sm",onClick:lt(V=>j(q.name),["stop"]),title:"åŠ è½½åˆ°ç¼–è¾‘å™¨"},"ğŸ“¥",8,Ug),e("button",{class:"btn btn-sm btn-danger",onClick:lt(V=>U(q.name),["stop"]),title:"åˆ é™¤",disabled:q.name==="default"}," ğŸ—‘ï¸ ",8,Og)])],10,Ag))),128))]))]),e("div",zg,[_[10]||(_[10]=e("div",{class:"settings-group-title"},"æç¤ºè¯ç¼–è¾‘",-1)),e("div",Ng,[_[8]||(_[8]=e("label",{for:"promptName"},"æç¤ºè¯åç§°:",-1)),ae(e("input",{type:"text",id:"promptName","onUpdate:modelValue":_[2]||(_[2]=q=>p.value=q),placeholder:"è¯·è¾“å…¥æç¤ºè¯åç§°"},null,512),[[we,p.value]])]),e("div",Vg,[_[9]||(_[9]=e("label",{for:"promptContent"},"æç¤ºè¯å†…å®¹:",-1)),ae(e("textarea",{id:"promptContent","onUpdate:modelValue":_[3]||(_[3]=q=>k.value=q),rows:"8",placeholder:"è¯·è¾“å…¥æç¤ºè¯å†…å®¹"},null,512),[[we,k.value]])]),e("div",Wg,[e("button",{class:"btn btn-primary",onClick:K,disabled:!p.value||!k.value},"ä¿å­˜æç¤ºè¯",8,Kg)])])]))}}),Hg=He(qg,[["__scopeId","data-v-70f0ec19"]]),jg={class:"plugin-manager"},Jg={class:"settings-group"},Yg={key:0,class:"loading-hint"},Xg={key:1,class:"empty-hint"},Gg={key:2,class:"plugin-list"},Zg={class:"plugin-info"},Qg={class:"plugin-header"},ep={class:"plugin-name"},tp={class:"plugin-version"},op={class:"plugin-description"},np={class:"plugin-controls"},sp={class:"switch"},ap=["checked","onChange"],lp=["onClick"],ip=["onClick"],rp={class:"settings-group"},up={class:"plugin-name"},cp={class:"switch"},dp=["checked","onChange"],gp={class:"plugin-config-content"},pp={class:"plugin-config-header"},mp={class:"plugin-config-body"},vp=["for"],fp=["id","onUpdate:modelValue"],bp=["id","onUpdate:modelValue","min","max"],hp=["id","onUpdate:modelValue","placeholder"],yp={key:4,class:"field-description"},xp=je({__name:"PluginManager",setup(n){const t=ct(),s=C([]),o=C({}),i=C(!1),r=C(!1),a=C(null),u=C({}),p=C({});async function k(){i.value=!0;try{const K=await Os();s.value=K.plugins||[]}catch(K){const U=K instanceof Error?K.message:"åŠ è½½æ’ä»¶åˆ—è¡¨å¤±è´¥";t.error(U)}finally{i.value=!1}}async function f(){try{const K=await Js();o.value=K.states||{}}catch(K){console.error("åŠ è½½é»˜è®¤çŠ¶æ€å¤±è´¥:",K)}}async function P(K){try{K.enabled?(await Ns(K.name),K.enabled=!1,t.success(`å·²ç¦ç”¨ ${K.display_name||K.name}`)):(await zs(K.name),K.enabled=!0,t.success(`å·²å¯ç”¨ ${K.display_name||K.name}`))}catch(U){const g=U instanceof Error?U.message:"æ“ä½œå¤±è´¥";t.error(g)}}async function L(K,U){const g=U.target,d=g.checked;try{await Ys(K,d),o.value[K]=d,t.success("é»˜è®¤çŠ¶æ€å·²æ›´æ–°")}catch(x){const _=x instanceof Error?x.message:"è®¾ç½®å¤±è´¥";t.error(_),g.checked=!d}}async function M(K){a.value=K;try{const U=await Xs(K.name);u.value=U.schema||{};const g=await Gs(K.name);p.value=g.config||{},r.value=!0}catch(U){const g=U instanceof Error?U.message:"åŠ è½½é…ç½®å¤±è´¥";t.error(g)}}function E(){r.value=!1,a.value=null,u.value={},p.value={}}async function $(){if(a.value)try{await Zs(a.value.name,p.value),t.success("é…ç½®ä¿å­˜æˆåŠŸ"),E()}catch(K){const U=K instanceof Error?K.message:"ä¿å­˜é…ç½®å¤±è´¥";t.error(U)}}async function j(K){if(confirm(`ç¡®å®šè¦åˆ é™¤æ’ä»¶ "${K.display_name||K.name}" å—ï¼Ÿ`))try{await Vs(K.name),t.success("æ’ä»¶åˆ é™¤æˆåŠŸ"),await k()}catch(U){const g=U instanceof Error?U.message:"åˆ é™¤æ’ä»¶å¤±è´¥";t.error(g)}}return dt(()=>{k(),f()}),(K,U)=>(B(),A("div",jg,[e("div",Jg,[U[1]||(U[1]=e("div",{class:"settings-group-title"},"å·²å®‰è£…æ’ä»¶",-1)),i.value?(B(),A("div",Yg,"åŠ è½½ä¸­...")):s.value.length===0?(B(),A("div",Xg,"æš‚æ— å·²å®‰è£…çš„æ’ä»¶")):(B(),A("div",Gg,[(B(!0),A(Oe,null,Ye(s.value,g=>(B(),A("div",{key:g.name,class:"plugin-item"},[e("div",Zg,[e("div",Qg,[e("span",ep,oe(g.display_name||g.name),1),e("span",tp,"v"+oe(g.version||"1.0.0"),1)]),e("p",op,oe(g.description||"æš‚æ— æè¿°"),1)]),e("div",np,[e("label",sp,[e("input",{type:"checkbox",checked:g.enabled,onChange:d=>P(g)},null,40,ap),U[0]||(U[0]=e("span",{class:"slider"},null,-1))]),g.has_config?(B(),A("button",{key:0,class:"btn btn-sm",onClick:d=>M(g),title:"é…ç½®"},"âš™ï¸",8,lp)):de("",!0),e("button",{class:"btn btn-sm btn-danger",onClick:d=>j(g),title:"åˆ é™¤"},"ğŸ—‘ï¸",8,ip)])]))),128))]))]),e("div",rp,[U[3]||(U[3]=e("div",{class:"settings-group-title"},"é»˜è®¤å¯ç”¨çŠ¶æ€",-1)),U[4]||(U[4]=e("p",{class:"settings-hint"},"è®¾ç½®æ’ä»¶åœ¨æ–°ä¼šè¯ä¸­çš„é»˜è®¤å¯ç”¨çŠ¶æ€",-1)),(B(!0),A(Oe,null,Ye(s.value,g=>(B(),A("div",{key:"default-"+g.name,class:"default-state-item"},[e("span",up,oe(g.display_name||g.name),1),e("label",cp,[e("input",{type:"checkbox",checked:o.value[g.name],onChange:d=>L(g.name,d)},null,40,dp),U[2]||(U[2]=e("span",{class:"slider"},null,-1))])]))),128))]),r.value?(B(),A("div",{key:0,class:"plugin-config-modal",onClick:lt(E,["self"])},[e("div",gp,[e("div",pp,[e("h4",null,oe(a.value?.display_name||a.value?.name)+" é…ç½®",1),e("span",{class:"close-btn",onClick:E},"Ã—")]),e("div",mp,[(B(!0),A(Oe,null,Ye(u.value,(g,d)=>(B(),A("div",{key:d,class:"config-field"},[e("label",{for:"config-"+d},oe(g.label||d)+":",9,vp),g.type==="boolean"?ae((B(),A("input",{key:0,type:"checkbox",id:"config-"+d,"onUpdate:modelValue":x=>p.value[d]=x},null,8,fp)),[[nt,p.value[d]]]):g.type==="select"?(B(),ut(We,{key:1,"model-value":String(p.value[d]??""),options:g.options||[],onChange:x=>{p.value[d]=x}},null,8,["model-value","options","onChange"])):g.type==="number"?ae((B(),A("input",{key:2,type:"number",id:"config-"+d,"onUpdate:modelValue":x=>p.value[d]=x,min:g.min,max:g.max},null,8,bp)),[[we,p.value[d],void 0,{number:!0}]]):ae((B(),A("input",{key:3,type:"text",id:"config-"+d,"onUpdate:modelValue":x=>p.value[d]=x,placeholder:g.placeholder},null,8,hp)),[[we,p.value[d]]]),g.description?(B(),A("p",yp,oe(g.description),1)):de("",!0)]))),128))]),e("div",{class:"plugin-config-footer"},[e("button",{class:"btn btn-secondary",onClick:E},"å–æ¶ˆ"),e("button",{class:"btn btn-primary",onClick:$},"ä¿å­˜")])])])):de("",!0)]))}}),_p=He(xp,[["__scopeId","data-v-a62393a7"]]),Cp={class:"parallel-settings"},Sp={class:"settings-group"},kp={class:"settings-item"},wp={class:"toggle-switch"},$p={class:"number-control"},Tp=["disabled"],Ip=["disabled"],Pp=["disabled"],Rp={key:0,class:"settings-note"},Dp=je({__name:"ParallelSettings",setup(n){const t=ze(),s=Q({get:()=>t.settings.parallel.enabled,set:i=>{t.updateSettings({parallel:{...t.settings.parallel,enabled:i}})}}),o=Q({get:()=>t.settings.parallel.deepLearningLockSize,set:i=>{t.updateSettings({parallel:{...t.settings.parallel,deepLearningLockSize:Math.max(1,Math.min(4,i))}})}});return(i,r)=>(B(),A("div",Cp,[e("div",Sp,[r[10]||(r[10]=e("div",{class:"settings-group-title"},"ğŸš€ å¹¶è¡Œç¿»è¯‘",-1)),e("div",kp,[r[5]||(r[5]=e("label",null,"å¯ç”¨å¹¶è¡Œæ¨¡å¼:",-1)),e("label",wp,[ae(e("input",{type:"checkbox","onUpdate:modelValue":r[0]||(r[0]=a=>s.value=a)},null,512),[[nt,s.value]]),r[4]||(r[4]=e("span",{class:"toggle-slider"},null,-1))]),r[6]||(r[6]=e("div",{class:"input-hint"},"ä½¿ç”¨æµæ°´çº¿å¹¶è¡Œå¤„ç†ï¼Œå¯èƒ½æå‡æ‰¹é‡ç¿»è¯‘é€Ÿåº¦",-1))]),e("div",{class:Ie(["settings-item",{"item-disabled":!s.value}])},[r[7]||(r[7]=e("label",null,"æ·±åº¦å­¦ä¹ å¹¶å‘æ•°:",-1)),e("div",$p,[e("button",{class:"btn btn-sm",onClick:r[1]||(r[1]=a=>o.value=Math.max(1,o.value-1)),disabled:!s.value},"-",8,Tp),ae(e("input",{type:"number","onUpdate:modelValue":r[2]||(r[2]=a=>o.value=a),min:"1",max:"4",disabled:!s.value,class:"number-input"},null,8,Ip),[[we,o.value,void 0,{number:!0}]]),e("button",{class:"btn btn-sm",onClick:r[3]||(r[3]=a=>o.value=Math.min(4,o.value+1)),disabled:!s.value},"+",8,Pp)]),r[8]||(r[8]=e("div",{class:"input-hint"},"æ§åˆ¶æ£€æµ‹/OCR/é¢œè‰²/ä¿®å¤çš„æœ€å¤§å¹¶å‘æ•°ï¼ˆå»ºè®®1-2ï¼‰",-1))],2),s.value?(B(),A("div",Rp,[...r[9]||(r[9]=[e("div",{class:"note-title"},"âš ï¸ æ³¨æ„äº‹é¡¹ï¼š",-1),e("ul",null,[e("li",null,"å¹¶å‘æ•°è®¾ä¸º1æ—¶ä¸ºä¸²è¡Œæ‰§è¡Œï¼Œæœ€ç¨³å®š"),e("li",null,"å¢å¤§å¹¶å‘æ•°å¯èƒ½åŠ é€Ÿå¤„ç†ï¼Œä½†ä¼šå ç”¨æ›´å¤šGPU/CPUèµ„æº"),e("li",null,"å¦‚æœé‡åˆ°æ˜¾å­˜ä¸è¶³ï¼Œè¯·å°†å¹¶å‘æ•°è®¾ä¸º1")],-1)])])):de("",!0)])]))}}),Mp=He(Dp,[["__scopeId","data-v-4a6e42d5"]]),Ep={class:"more-settings"},Bp={class:"settings-group"},Ap={class:"settings-item checkbox-item"},Lp={class:"checkbox-label"},Fp={class:"settings-group"},Up={class:"settings-item"},Op={class:"settings-group"},zp={class:"settings-item"},Np=["disabled"],Vp={key:0,class:"font-count"},Wp={class:"settings-item"},Kp={class:"settings-group"},qp={class:"settings-row"},Hp={class:"settings-item"},jp=["disabled"],Jp={class:"settings-item"},Yp=["disabled"],Xp=je({__name:"MoreSettings",setup(n){const t=[{label:"å‰ç«¯ pdf.js (æ¨è)",value:"frontend"},{label:"åç«¯ PyMuPDF",value:"backend"}],s=ze(),o=ct(),i=C(!1),r=C([]),a=C(!1),u=C(null),p=C({pdfProcessingMethod:s.settings.pdfProcessingMethod||"frontend",autoSaveInBookshelfMode:s.settings.autoSaveInBookshelfMode||!1});Ce(()=>p.value.pdfProcessingMethod,M=>{s.setPdfProcessingMethod(M)}),Ce(()=>p.value.autoSaveInBookshelfMode,M=>{s.setAutoSaveInBookshelfMode(M)});async function k(){i.value=!0;try{const M=await Ke.getFontList();r.value=M.fonts||[],o.success(`è·å–åˆ° ${r.value.length} ä¸ªå­—ä½“`)}catch(M){const E=M instanceof Error?M.message:"è·å–å­—ä½“åˆ—è¡¨å¤±è´¥";o.error(E)}finally{i.value=!1}}async function f(M){const $=M.target.files?.[0];if(!$)return;const j=[".ttf",".ttc",".otf"],K=$.name.toLowerCase().slice($.name.lastIndexOf("."));if(!j.includes(K)){o.error("ä¸æ”¯æŒçš„å­—ä½“æ ¼å¼ï¼Œè¯·ä¸Šä¼  .ttf, .ttc æˆ– .otf æ–‡ä»¶");return}try{const U=await Ke.uploadFont($);U.success?(o.success(`å­—ä½“ "${U.fontPath||$.name}" ä¸Šä¼ æˆåŠŸ`),await k()):o.error(U.error||"å­—ä½“ä¸Šä¼ å¤±è´¥")}catch(U){const g=U instanceof Error?U.message:"å­—ä½“ä¸Šä¼ å¤±è´¥";o.error(g)}finally{u.value&&(u.value.value="")}}async function P(){a.value=!0;try{const M=await wn();M.success?o.success(`å·²æ¸…ç† ${M.deleted_count||0} ä¸ªè°ƒè¯•æ–‡ä»¶`):o.error(M.error||"æ¸…ç†å¤±è´¥")}catch(M){const E=M instanceof Error?M.message:"æ¸…ç†å¤±è´¥";o.error(E)}finally{a.value=!1}}async function L(){a.value=!0;try{const M=await ho();M.success?o.success(`å·²æ¸…ç† ${M.deleted_count||0} ä¸ªä¸´æ—¶æ–‡ä»¶`):o.error(M.error||"æ¸…ç†å¤±è´¥")}catch(M){const E=M instanceof Error?M.message:"æ¸…ç†å¤±è´¥";o.error(E)}finally{a.value=!1}}return(M,E)=>(B(),A("div",Ep,[Se(Mp),e("div",Bp,[E[4]||(E[4]=e("div",{class:"settings-group-title"},"è‡ªåŠ¨ä¿å­˜è®¾ç½®",-1)),e("div",Ap,[e("label",Lp,[ae(e("input",{type:"checkbox","onUpdate:modelValue":E[0]||(E[0]=$=>p.value.autoSaveInBookshelfMode=$)},null,512),[[nt,p.value.autoSaveInBookshelfMode]]),E[2]||(E[2]=e("span",{class:"checkbox-text"},"ä¹¦æ¶æ¨¡å¼è‡ªåŠ¨ä¿å­˜",-1))]),E[3]||(E[3]=e("div",{class:"input-hint"},[me(" å¼€å¯åï¼Œåœ¨ä¹¦æ¶æ¨¡å¼ä¸‹ç¿»è¯‘æ—¶ä¼šè‡ªåŠ¨ä¿å­˜è¿›åº¦ï¼ˆç¿»è¯‘ä¸€å¼ ä¿å­˜ä¸€å¼ ï¼‰ï¼Œé˜²æ­¢æ„å¤–å…³é—­å¯¼è‡´æ•°æ®ä¸¢å¤±ã€‚ "),e("br"),e("span",{class:"hint-note"},"æ³¨æ„ï¼šæ­¤åŠŸèƒ½ä»…åœ¨ä¹¦æ¶æ¨¡å¼ä¸‹ç”Ÿæ•ˆï¼Œå¿«é€Ÿç¿»è¯‘æ¨¡å¼ä¸æ”¯æŒã€‚")],-1))])]),e("div",Fp,[E[7]||(E[7]=e("div",{class:"settings-group-title"},"PDFå¤„ç†è®¾ç½®",-1)),e("div",Up,[E[5]||(E[5]=e("label",{for:"settingsPdfProcessingMethod"},"PDFå¤„ç†æ–¹å¼:",-1)),Se(We,{modelValue:p.value.pdfProcessingMethod,"onUpdate:modelValue":E[1]||(E[1]=$=>p.value.pdfProcessingMethod=$),options:t},null,8,["modelValue"]),E[6]||(E[6]=e("div",{class:"input-hint"},"å‰ç«¯å¤„ç†é€Ÿåº¦æ›´å¿«ï¼Œåç«¯å¤„ç†å…¼å®¹æ€§æ›´å¥½",-1))])]),e("div",Op,[E[11]||(E[11]=e("div",{class:"settings-group-title"},"å­—ä½“è®¾ç½®",-1)),e("div",zp,[E[8]||(E[8]=e("label",null,"ç³»ç»Ÿå­—ä½“åˆ—è¡¨:",-1)),e("button",{class:"btn btn-secondary",onClick:k,disabled:i.value},oe(i.value?"åŠ è½½ä¸­...":"ğŸ”„ åˆ·æ–°å­—ä½“åˆ—è¡¨"),9,Np),r.value.length>0?(B(),A("div",Vp,"å…± "+oe(r.value.length)+" ä¸ªå­—ä½“",1)):de("",!0)]),e("div",Wp,[E[9]||(E[9]=e("label",null,"ä¸Šä¼ è‡ªå®šä¹‰å­—ä½“:",-1)),e("input",{type:"file",accept:".ttf,.ttc,.otf",onChange:f,ref_key:"fontInput",ref:u},null,544),E[10]||(E[10]=e("div",{class:"input-hint"},"æ”¯æŒ .ttf, .ttc, .otf æ ¼å¼",-1))])]),e("div",Kp,[E[14]||(E[14]=e("div",{class:"settings-group-title"},"ç¼“å­˜æ¸…ç†",-1)),e("div",qp,[e("div",Hp,[e("button",{class:"btn btn-secondary",onClick:P,disabled:a.value},oe(a.value?"æ¸…ç†ä¸­...":"ğŸ—‘ï¸ æ¸…ç†è°ƒè¯•æ–‡ä»¶"),9,jp),E[12]||(E[12]=e("div",{class:"input-hint"},"æ¸…ç†è°ƒè¯•è¿‡ç¨‹ä¸­ç”Ÿæˆçš„ä¸´æ—¶æ–‡ä»¶",-1))]),e("div",Jp,[e("button",{class:"btn btn-secondary",onClick:L,disabled:a.value},oe(a.value?"æ¸…ç†ä¸­...":"ğŸ—‘ï¸ æ¸…ç†ä¸´æ—¶æ–‡ä»¶"),9,Yp),E[13]||(E[13]=e("div",{class:"input-hint"},"æ¸…ç†ä¸‹è½½å’Œå¤„ç†è¿‡ç¨‹ä¸­çš„ä¸´æ—¶æ–‡ä»¶",-1))])])]),E[15]||(E[15]=go('<div class="settings-group" data-v-8667f80e><div class="settings-group-title" data-v-8667f80e>å…³äº</div><div class="about-info" data-v-8667f80e><p data-v-8667f80e><strong data-v-8667f80e>Saber-Translator</strong></p><p data-v-8667f80e>AIé©±åŠ¨çš„æ¼«ç”»ç¿»è¯‘å·¥å…·</p><p class="links" data-v-8667f80e><a href="http://www.mashirosaber.top" target="_blank" data-v-8667f80e>ğŸ“– ä½¿ç”¨æ•™ç¨‹</a><a href="https://github.com/MashiroSaber/saber-translator" target="_blank" data-v-8667f80e>ğŸ™ GitHub</a></p><p class="disclaimer" data-v-8667f80e>æœ¬é¡¹ç›®å®Œå…¨å¼€æºå…è´¹ï¼Œè¯·å‹¿ä¸Šå½“å—éª—</p></div></div>',1))]))}}),Gp=He(Xp,[["__scopeId","data-v-8667f80e"]]),Zp={class:"settings-modal-content"},Qp={class:"settings-tabs"},em=["onClick"],tm={class:"settings-tab-content"},om={class:"settings-tab-pane active"},nm={class:"settings-tab-pane"},sm={class:"settings-tab-pane"},am={class:"settings-tab-pane"},lm={class:"settings-tab-pane"},im={class:"settings-tab-pane"},rm={class:"settings-tab-pane"},um={class:"settings-tab-pane"},cm=je({__name:"SettingsModal",props:{modelValue:{type:Boolean},initialTab:{}},emits:["update:modelValue","save"],setup(n,{emit:t}){const s=n,o=t,i=ze(),r=C(s.modelValue),a=C("ocr"),u=[{id:"ocr",label:"OCRè¯†åˆ«"},{id:"translate",label:"ç¿»è¯‘æœåŠ¡"},{id:"detection",label:"æ£€æµ‹è®¾ç½®"},{id:"hq",label:"é«˜è´¨é‡ç¿»è¯‘"},{id:"proofreading",label:"AIæ ¡å¯¹"},{id:"prompt-library",label:"æç¤ºè¯ç®¡ç†"},{id:"plugins",label:"æ’ä»¶ç®¡ç†"},{id:"more",label:"æ›´å¤š"}];Ce(()=>s.modelValue,P=>{r.value=P,P?(document.body.style.overflow="hidden",s.initialTab&&u.some(L=>L.id===s.initialTab)&&(a.value=s.initialTab)):(document.body.style.overflow="",a.value="ocr")});function p(){r.value=!1,o("update:modelValue",!1),document.body.style.overflow=""}async function k(){i.saveToStorage();try{await i.saveToBackend(),console.log("[SettingsModal] è®¾ç½®å·²ä¿å­˜åˆ°åç«¯")}catch(P){console.warn("[SettingsModal] ä¿å­˜åˆ°åç«¯å¤±è´¥ï¼Œä»…ä¿å­˜åˆ° localStorage:",P)}o("save"),p()}function f(P){P.key==="Escape"&&r.value&&p()}return dt(()=>{document.addEventListener("keydown",f)}),Ot(()=>{document.removeEventListener("keydown",f),document.body.style.overflow=""}),(P,L)=>r.value?(B(),A("div",{key:0,class:"settings-modal",onClick:lt(p,["self"])},[e("div",Zp,[e("div",{class:"settings-modal-header"},[L[0]||(L[0]=e("h3",null,"âš™ï¸ è®¾ç½®",-1)),e("span",{class:"settings-modal-close",onClick:p},"Ã—")]),e("div",Qp,[(B(),A(Oe,null,Ye(u,M=>e("button",{key:M.id,class:Ie(["settings-tab",{active:a.value===M.id}]),onClick:E=>a.value=M.id},oe(M.label),11,em)),64))]),e("div",tm,[ae(e("div",om,[Se(Eu)],512),[[Ue,a.value==="ocr"]]),ae(e("div",nm,[Se(_c)],512),[[Ue,a.value==="translate"]]),ae(e("div",sm,[Se(Wc)],512),[[Ue,a.value==="detection"]]),ae(e("div",am,[Se(Id)],512),[[Ue,a.value==="hq"]]),ae(e("div",lm,[Se(wg)],512),[[Ue,a.value==="proofreading"]]),ae(e("div",im,[Se(Hg)],512),[[Ue,a.value==="prompt-library"]]),ae(e("div",rm,[Se(_p)],512),[[Ue,a.value==="plugins"]]),ae(e("div",um,[Se(Gp)],512),[[Ue,a.value==="more"]])]),e("div",{class:"settings-modal-footer"},[e("button",{class:"btn btn-secondary",onClick:p},"å–æ¶ˆ"),e("button",{class:"btn btn-primary",onClick:k},"ä¿å­˜è®¾ç½®")])])])):de("",!0)}}),dm=He(cm,[["__scopeId","data-v-e1ec20ab"]]),gm={minScale:.1,maxScale:5,zoomSpeed:.1};function hn(n={}){const t={...gm,...n},s=C(1),o=C(0),i=C(0),r=C(!1),a=C(0),u=C(0),p=Q(()=>({transform:`translate(${o.value}px, ${i.value}px) scale(${s.value})`}));function k(X,ie,z){const R=Math.min(Math.max(s.value*z,t.minScale),t.maxScale),I=R/s.value;o.value=X-(X-o.value)*I,i.value=ie-(ie-i.value)*I,s.value=R,n.onScaleChange?.(s.value),n.onTransformChange?.(_())}function f(X,ie=800,z=600){k(ie/2,z/2,X)}function P(){f(1.2)}function L(){f(.8)}function M(X,ie=800,z=600){const R=X/s.value;k(ie/2,z/2,R)}function E(X,ie){r.value=!0,a.value=X,u.value=ie}function $(X,ie){if(!r.value)return;const z=X-a.value,R=ie-u.value;o.value+=z,i.value+=R,a.value=X,u.value=ie,n.onTransformChange?.(_())}function j(){r.value=!1}function K(X,ie){o.value+=X,i.value+=ie,n.onTransformChange?.(_())}function U(){s.value=1,o.value=0,i.value=0,n.onScaleChange?.(s.value),n.onTransformChange?.(_())}function g(){U()}function d(){s.value=1,o.value=0,i.value=0}function x(X,ie,z,R){if(!X||!ie)return;const I=z/X,F=R/ie;s.value=Math.min(I,F)*.95,o.value=(z-X*s.value)/2,i.value=(R-ie*s.value)/2,n.onScaleChange?.(s.value),n.onTransformChange?.(_())}function _(){return{scale:s.value,translateX:o.value,translateY:i.value}}function q(X){X.scale!==void 0&&(s.value=X.scale),X.translateX!==void 0&&(o.value=X.translateX),X.translateY!==void 0&&(i.value=X.translateY),n.onTransformChange?.(_())}function V(X){s.value=X.scale,o.value=X.translateX,i.value=X.translateY}function se(X,ie,z){if(!X||X.length<4)return;const[R,I,F,y]=X,m=(R+F)/2,l=(I+y)/2,v=ie/2,D=z/2;o.value=v-m*s.value,i.value=D-l*s.value,n.onTransformChange?.(_())}return{scale:s,translateX:o,translateY:i,isDragging:r,transformStyle:p,zoomAt:k,zoom:f,zoomIn:P,zoomOut:L,setScale:M,startDrag:E,drag:$,endDrag:j,pan:K,reset:U,resetZoom:g,resetTransform:d,fitToScreen:x,getTransform:_,setTransform:q,syncWith:V,scrollToBubble:se}}function pm(n){const t=et(),s=ze(),o=C(null),i=C(ms),r=C(!1),a=C(!1),u=C([]),p=C(0),k=C(0);let f=null,P=null,L=null;const M=Q(()=>o.value!==null),E=Q(()=>o.value==="repair"?{fill:"rgba(76, 175, 80, 0.4)",border:"#4CAF50"}:o.value==="restore"?{fill:"rgba(33, 150, 243, 0.4)",border:"#2196F3"}:{fill:"transparent",border:"transparent"});function $(l){o.value!==l&&(o.value=l,r.value=!0,u.value=[],console.log(`è¿›å…¥${l==="repair"?"ä¿®å¤":"è¿˜åŸ"}ç¬”åˆ·æ¨¡å¼ï¼Œç¬”åˆ·å¤§å°: ${i.value}px`))}function j(){a.value&&q();const l=o.value!==null;o.value=null,r.value=!1,a.value=!1,u.value=[],ie(),l&&console.log("é€€å‡ºç¬”åˆ·æ¨¡å¼")}function K(l){o.value===l?j():$(l)}function U(l){i.value=Math.max(on,Math.min(tn,l))}function g(l){U(i.value+l)}function d(l){if(!M.value)return;l.preventDefault(),l.stopPropagation();const v=l.deltaY>0?-5:5;g(v)}function x(l,v){if(!M.value||l.button!==0)return;l.preventDefault(),l.stopPropagation(),a.value=!0,f=v,u.value=[];const D=V(l,v);D&&(u.value.push(D),X(v),z(D)),console.log("å¼€å§‹ç¬”åˆ·æ¶‚æŠ¹")}function _(l){if(p.value=l.clientX,k.value=l.clientY,!a.value||!M.value)return;const v=V(l,f);v&&(u.value.push(v),z(v))}function q(){if(!a.value)return;a.value=!1;const l=t.currentImage;if(!l||u.value.length===0){ie(),u.value=[];return}const v=se();if(!v){ie(),u.value=[];return}const D=o.value;(async()=>{D==="restore"?await R(l,v):D==="repair"&&await I(l,v),n?.onBrushComplete?.()})(),ie(),u.value=[]}function V(l,v){if(!v)return null;const D=v.querySelector(".image-canvas-wrapper"),S=D?.querySelector("img");if(!S||!S.naturalWidth)return null;const w=D.getBoundingClientRect(),W=window.getComputedStyle(D).transform;let Z=1;W&&W!=="none"&&(Z=new DOMMatrix(W).a);const Y=(l.clientX-w.left)/Z,c=(l.clientY-w.top)/Z,h=S.naturalWidth,le=S.naturalHeight;return Y<0||c<0||Y>h||c>le?null:{x:Y,y:c,scale:Z}}function se(){if(u.value.length===0)return null;const v=u.value[0]?.scale||1,D=i.value/2/v;let S=1/0,w=1/0,W=-1/0,Z=-1/0;for(const Y of u.value)S=Math.min(S,Y.x-D),w=Math.min(w,Y.y-D),W=Math.max(W,Y.x+D),Z=Math.max(Z,Y.y+D);return{x1:Math.max(0,Math.floor(S)),y1:Math.max(0,Math.floor(w)),x2:Math.ceil(W),y2:Math.ceil(Z),path:[...u.value],radius:D}}function X(l){ie();const v=l.querySelector(".image-canvas-wrapper"),D=v?.querySelector("img");if(!D)return;const S=document.createElement("canvas");S.id="brushOverlayCanvas",S.width=D.naturalWidth,S.height=D.naturalHeight,S.style.cssText="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100;",v.appendChild(S),P=S,L=S.getContext("2d")}function ie(){P&&P.parentNode&&P.parentNode.removeChild(P),P=null,L=null}function z(l){if(!L||!l)return;const v=E.value.fill,D=i.value/2/(l.scale||1);L.beginPath(),L.arc(l.x,l.y,D,0,Math.PI*2),L.fillStyle=v,L.fill()}async function R(l,v){if(!l.originalDataURL)return;let D;return l.cleanImageData?D="data:image/png;base64,"+l.cleanImageData:D=l.originalDataURL,new Promise(S=>{const w=new Image,W=new Image;let Z=0;const Y=()=>{if(Z++,Z<2)return;const c=document.createElement("canvas");c.width=w.naturalWidth,c.height=w.naturalHeight;const h=c.getContext("2d");if(!h){S();return}h.drawImage(w,0,0);const le=document.createElement("canvas");le.width=c.width,le.height=c.height;const T=le.getContext("2d");if(!T){S();return}T.fillStyle="white";for(const ce of v.path)T.beginPath(),T.arc(ce.x,ce.y,v.radius,0,Math.PI*2),T.fill();h.globalCompositeOperation="destination-out",h.drawImage(le,0,0),h.globalCompositeOperation="destination-over",h.drawImage(W,0,0),h.globalCompositeOperation="source-over";const G=c.toDataURL("image/png").split(",")[1];t.updateCurrentImage({cleanImageData:G}),console.log("è¿˜åŸç¬”åˆ·åŒºåŸŸå®Œæˆ"),S()};w.onload=Y,w.onerror=()=>S(),W.onload=Y,W.onerror=()=>S(),w.src=D,W.src=l.originalDataURL})}async function I(l,v){const D=n?.getCurrentRepairSettings?.()||{inpaintMethod:"solid",fillColor:"#FFFFFF"},S=D.inpaintMethod;S==="lama_mpe"||S==="litelama"?await F(l,v,S):await y(l,v,D.fillColor)}async function F(l,v,D="lama_mpe"){let S,w;if(l.cleanImageData)S=l.cleanImageData,w="data:image/png;base64,"+l.cleanImageData;else if(l.originalDataURL)S=l.originalDataURL.split(",")[1],w=l.originalDataURL;else{console.error("æ— æ³•è·å–åŸºç¡€å›¾åƒç”¨äº LAMA ä¿®å¤");return}return new Promise(W=>{const Z=new Image;Z.onload=async()=>{const Y=Z.naturalWidth,c=Z.naturalHeight,h=document.createElement("canvas");h.width=Y,h.height=c;const le=h.getContext("2d");if(!le){console.error("æ— æ³•åˆ›å»ºæ©è†œç”»å¸ƒä¸Šä¸‹æ–‡"),W();return}le.fillStyle="black",le.fillRect(0,0,Y,c),le.fillStyle="white";for(const De of v.path)le.beginPath(),le.arc(De.x,De.y,v.radius,0,Math.PI*2),le.fill();const G=h.toDataURL("image/png").split(",")[1],ce=[v.x1,v.y1,v.x2,v.y2],_e=D==="litelama"?"litelama":"lama_mpe";try{xe("LAMA ä¿®å¤ä¸­...","info");const De=await xo(S,ce,{method:"lama",lamaModel:_e,maskData:G});if(De.success&&De.inpainted_image)t.updateCurrentImage({cleanImageData:De.inpainted_image}),console.log("ä¿®å¤ç¬”åˆ·åŒºåŸŸå®Œæˆï¼ˆLAMA ä¿®å¤ï¼Œç²¾ç¡®æ©è†œï¼‰"),xe("LAMA ä¿®å¤å®Œæˆ","success");else throw new Error(De.error||"LAMA ä¿®å¤è¿”å›æ— æ•ˆæ•°æ®")}catch(De){console.error("LAMA ä¿®å¤å¤±è´¥ï¼Œå›é€€åˆ°çº¯è‰²å¡«å……:",De),xe("LAMA ä¿®å¤å¤±è´¥ï¼Œä½¿ç”¨çº¯è‰²å¡«å……","warning");const $e=n?.getCurrentRepairSettings?.();await y(l,v,$e?.fillColor)}W()},Z.onerror=()=>{console.error("åŠ è½½å›¾åƒå¤±è´¥ï¼Œæ— æ³•è¿›è¡Œ LAMA ä¿®å¤"),W()},Z.src=w})}async function y(l,v,D){const S=D||s.settings.textStyle.fillColor||"#FFFFFF";let w;if(l.cleanImageData)w="data:image/png;base64,"+l.cleanImageData;else if(l.originalDataURL)w=l.originalDataURL;else return;return new Promise(W=>{const Z=new Image;Z.onload=()=>{const Y=document.createElement("canvas");Y.width=Z.naturalWidth,Y.height=Z.naturalHeight;const c=Y.getContext("2d");if(!c){W();return}c.drawImage(Z,0,0),c.fillStyle=S;for(const le of v.path)c.beginPath(),c.arc(le.x,le.y,v.radius,0,Math.PI*2),c.fill();const h=Y.toDataURL("image/png").split(",")[1];t.updateCurrentImage({cleanImageData:h}),console.log("ä¿®å¤ç¬”åˆ·åŒºåŸŸå®Œæˆï¼ˆçº¯è‰²å¡«å……ï¼‰"),W()},Z.onerror=()=>W(),Z.src=w})}async function m(){const l=t.currentImage;if(!l)return console.warn("ensureCleanBackground: æ²¡æœ‰å½“å‰å›¾ç‰‡"),!1;if(l.cleanImageData)return console.log("ensureCleanBackground: å·²æœ‰å¹²å‡€èƒŒæ™¯"),!0;const v=n?.getCurrentRepairSettings?.();if((v?.inpaintMethod||s.settings.textStyle.inpaintMethod)!=="solid")return console.log("ensureCleanBackground: éçº¯è‰²å¡«å……æ¨¡å¼ï¼Œè·³è¿‡"),!1;if(!l.bubbleStates||l.bubbleStates.length===0)return console.warn("ensureCleanBackground: æ²¡æœ‰æ°”æ³¡æ•°æ®"),!1;if(!l.translatedDataURL&&!l.originalDataURL)return console.warn("ensureCleanBackground: æ²¡æœ‰å›¾ç‰‡æ•°æ®"),!1;console.log("ensureCleanBackground: å°è¯•ä¸ºçº¯è‰²å¡«å……æ¨¡å¼åˆ›å»ºä¸´æ—¶å¹²å‡€èƒŒæ™¯");const S=l.translatedDataURL||l.originalDataURL,w=v?.fillColor||s.settings.textStyle.fillColor||"#FFFFFF";return new Promise(W=>{const Z=new Image;Z.onload=()=>{try{const Y=document.createElement("canvas");Y.width=Z.naturalWidth,Y.height=Z.naturalHeight;const c=Y.getContext("2d");if(!c){console.error("ensureCleanBackground: æ— æ³•è·å– Canvas ä¸Šä¸‹æ–‡"),W(!1);return}c.drawImage(Z,0,0),c.fillStyle=w;for(const le of l.bubbleStates){const[T,G,ce,_e]=le.coords;c.fillRect(T,G,ce-T+1,_e-G+1)}const h=Y.toDataURL("image/png").split(",")[1];t.updateCurrentImage({cleanImageData:h}),console.log("ensureCleanBackground: æˆåŠŸåˆ›å»ºä¸´æ—¶å¹²å‡€èƒŒæ™¯ï¼ˆçº¯è‰²å¡«å……ï¼‰"),W(!0)}catch(Y){console.error("ensureCleanBackground: Canvas æ“ä½œå¤±è´¥:",Y),W(!1)}},Z.onerror=()=>{console.error("ensureCleanBackground: åŠ è½½å›¾åƒå¤±è´¥"),W(!1)},Z.src=S})}return Ot(()=>{j()}),{brushMode:o,brushSize:i,isBrushKeyDown:r,isBrushPainting:a,mouseX:p,mouseY:k,isActive:M,brushColor:E,BRUSH_MIN_SIZE:on,BRUSH_MAX_SIZE:tn,enterBrushMode:$,exitBrushMode:j,toggleBrushMode:K,setBrushSize:U,adjustBrushSize:g,handleBrushWheel:d,startBrushPainting:x,continueBrushPainting:_,finishBrushPainting:q,getBrushPositionInImage:V,getBrushPathBounds:se,ensureCleanBackground:m}}function mm(n){return[Math.round(n[0]),Math.round(n[1]),Math.round(n[2]),Math.round(n[3])]}function vm(n){const t=gt(),s=et(),o=ze(),{bubbles:i,selectedIndex:r,hasSelection:a}=kt(t),{currentImage:u}=kt(s),p=C(!1),k=C(!1),f=C(null),P=C(0),L=C(0),M=C(!1);function E(c){t.selectBubble(c)}function $(c){t.toggleMultiSelect(c)}function j(){t.clearMultiSelect()}function K(c,h){console.log(`å¼€å§‹æ‹–åŠ¨æ°”æ³¡ #${c+1}`)}function U(c,h){}function g(c,h){t.updateBubble(c,{coords:h}),console.log(`æ°”æ³¡ #${c+1} æ‹–åŠ¨å®Œæˆ:`,h),D()}function d(c,h,le){console.log(`å¼€å§‹è°ƒæ•´æ°”æ³¡ #${c+1} å¤§å°ï¼Œæ‰‹æŸ„: ${h}`)}function x(c){}function _(c,h){t.updateBubble(c,{coords:h}),console.log(`æ°”æ³¡ #${c+1} è°ƒæ•´å¤§å°å®Œæˆ:`,h),D()}function q(c,h){console.log(`å¼€å§‹æ—‹è½¬æ°”æ³¡ #${c+1}`)}function V(c){}function se(c,h){t.updateBubble(c,{rotationAngle:h}),console.log(`æ°”æ³¡ #${c+1} æ—‹è½¬å®Œæˆ: ${h}Â°`),D()}function X(){p.value=!p.value,p.value?console.log("è¿›å…¥ç»˜åˆ¶æ¨¡å¼"):console.log("é€€å‡ºç»˜åˆ¶æ¨¡å¼")}function ie(c){t.addBubble(c),t.selectBubble(t.bubbleCount-1),console.log("å·²æ·»åŠ æ–°æ°”æ³¡:",c),n?.onReRender?.()}function z(c,h){k.value=!0,P.value=c,L.value=h,f.value=[c,h,c,h]}function R(c,h){k.value&&(f.value=[P.value,L.value,c,h])}function I(){if(!k.value||!f.value)return k.value=!1,f.value=null,null;const[c,h,le,T]=f.value,G=10;if(Math.abs(le-c)<G||Math.abs(T-h)<G)return k.value=!1,f.value=null,null;const ce=[Math.min(c,le),Math.min(h,T),Math.max(c,le),Math.max(h,T)];return k.value=!1,f.value=null,ce}function F(){k.value=!1,f.value=null,p.value=!1}function y(){if(!f.value)return{};const[c,h,le,T]=f.value;return{position:"absolute",left:`${Math.min(c,le)}px`,top:`${Math.min(h,T)}px`,width:`${Math.abs(le-c)}px`,height:`${Math.abs(T-h)}px`,border:"2px dashed #00d4ff",background:"rgba(0, 212, 255, 0.1)",pointerEvents:"none",zIndex:"25",boxSizing:"border-box"}}let m=null,l=!1;const v=150;function D(){m&&clearTimeout(m),m=setTimeout(async()=>{if(l){console.log("è·³è¿‡æ¸²æŸ“ï¼Œä¸Šä¸€æ¬¡æ¸²æŸ“ä»åœ¨è¿›è¡Œä¸­");return}console.log("è§¦å‘å»¶è¿Ÿæ¸²æŸ“é¢„è§ˆ"),l=!0;try{n?.onDelayedPreview?await n.onDelayedPreview():n?.onReRender&&await n.onReRender()}catch(c){console.error("å»¶è¿Ÿæ¸²æŸ“é¢„è§ˆå¤±è´¥:",c)}finally{l=!1}},v)}function S(c){t.updateSelectedBubble(c),D()}function w(){a.value&&(t.deleteSelected(),console.log("å·²åˆ é™¤é€‰ä¸­çš„æ°”æ³¡"),n?.onReRender?.())}async function W(){const c=r.value;if(c<0){console.warn("è¯·å…ˆé€‰ä¸­è¦ä¿®å¤çš„æ°”æ³¡æ¡†");return}const h=i.value[c],le=u.value;if(!h||!le?.originalDataURL){console.warn("æ— æ³•ä¿®å¤èƒŒæ™¯ï¼šç¼ºå°‘æ°”æ³¡æˆ–å›¾ç‰‡æ•°æ®");return}const T=h.inpaintMethod||"solid",G=h.fillColor||"#FFFFFF",ce=h.rotationAngle||0;try{console.log(`å¼€å§‹ä¿®å¤æ°”æ³¡ #${c+1} èƒŒæ™¯ï¼Œæ–¹æ³•: ${T}`);let _e;if(le.cleanImageData)_e=le.cleanImageData;else{const $e=le.originalDataURL.match(/^data:image\/[^;]+;base64,(.+)$/);if(_e=$e&&$e[1]?$e[1]:"",!_e){console.error("æ— æ³•è§£æå›¾åƒæ•°æ®");return}}if(T==="lama_mpe"||T==="litelama"){const $e=T==="litelama"?"litelama":"lama_mpe",he=mm(h.coords),te=await xo(_e,he,{bubbleAngle:ce,method:"lama",lamaModel:$e});te.success&&te.inpainted_image?(s.updateCurrentImage({cleanImageData:te.inpainted_image}),console.log(`æ°”æ³¡ #${c+1} LAMAèƒŒæ™¯ä¿®å¤æˆåŠŸ`),D()):(console.error("LAMAä¿®å¤å¤±è´¥:",te.error||"æœªçŸ¥é”™è¯¯"),await Z(h.coords,G,ce),D())}else await Z(h.coords,G,ce),console.log(`æ°”æ³¡ #${c+1} çº¯è‰²å¡«å……ä¿®å¤æˆåŠŸ`),D()}catch(_e){console.error("èƒŒæ™¯ä¿®å¤å‡ºé”™:",_e)}}async function Z(c,h,le=0){const T=u.value;if(!T)return;const[G,ce,_e,De]=c;let $e;if(T.cleanImageData)$e="data:image/png;base64,"+T.cleanImageData;else if(T.originalDataURL)$e=T.originalDataURL;else{console.error("æ— æ³•æ‰¾åˆ°åŸºç¡€å›¾åƒç”¨äºå¡«å……");return}return new Promise(he=>{const te=new Image;te.onload=()=>{const b=document.createElement("canvas");b.width=te.naturalWidth,b.height=te.naturalHeight;const J=b.getContext("2d");if(!J){he();return}if(J.drawImage(te,0,0),J.fillStyle=h,Math.abs(le)<.1)J.fillRect(G,ce,_e-G,De-ce);else{const fe=(G+_e)/2,O=(ce+De)/2,ne=(_e-G)/2,be=(De-ce)/2,ge=le*Math.PI/180,Pe=Math.cos(ge),Ee=Math.sin(ge),Le=[[-ne,-be],[ne,-be],[ne,be],[-ne,be]].map(([Be,ye])=>[fe+Be*Pe-ye*Ee,O+Be*Ee+ye*Pe]);J.beginPath();const ke=Le[0];if(ke){J.moveTo(ke[0],ke[1]);for(let Be=1;Be<Le.length;Be++){const ye=Le[Be];ye&&J.lineTo(ye[0],ye[1])}}J.closePath(),J.fill()}const ve=b.toDataURL("image/png").split(",")[1];s.updateCurrentImage({cleanImageData:ve}),console.log("å·²å¯¹æ°”æ³¡åŒºåŸŸè¿›è¡Œçº¯è‰²å¡«å……:",c,h,"è§’åº¦:",le),he()},te.onerror=()=>{console.error("åŠ è½½åŸºç¡€å›¾åƒå¤±è´¥"),he()},te.src=$e})}async function Y(c){const h=i.value[c],le=u.value;if(!h||!le?.originalDataURL){console.warn("æ— æ³•è¿›è¡Œ OCR è¯†åˆ«ï¼šç¼ºå°‘æ°”æ³¡æˆ–å›¾ç‰‡æ•°æ®");return}try{console.log(`å¼€å§‹ OCR è¯†åˆ«æ°”æ³¡ #${c+1}`);const T=le.originalDataURL.split(",")[1]||"",G=o.settings,ce=await In(T,h.coords,G.ocrEngine||"manga_ocr",{source_language:G.sourceLanguage,baidu_ocr_api_key:G.baiduOcr.apiKey,baidu_ocr_secret_key:G.baiduOcr.secretKey,baidu_version:G.baiduOcr.version,baidu_source_language:G.baiduOcr.sourceLanguage,ai_vision_provider:G.aiVisionOcr.provider,ai_vision_api_key:G.aiVisionOcr.apiKey,ai_vision_model_name:G.aiVisionOcr.modelName,ai_vision_ocr_prompt:G.aiVisionOcr.prompt,custom_ai_vision_base_url:G.aiVisionOcr.customBaseUrl,ai_vision_min_image_size:G.aiVisionOcr.minImageSize});ce.success&&ce.text!==void 0?(t.updateBubble(c,{originalText:ce.text}),console.log(`OCR è¯†åˆ«æˆåŠŸ: "${ce.text}"`)):console.error("OCR è¯†åˆ«å¤±è´¥:",ce.error||"æœªçŸ¥é”™è¯¯")}catch(T){console.error("OCR è¯†åˆ«å‡ºé”™:",T)}}return{isDrawingMode:p,isDrawingBox:k,currentDrawingRect:f,isMiddleButtonDown:M,handleBubbleSelect:E,handleBubbleMultiSelect:$,handleClearMultiSelect:j,handleBubbleDragStart:K,handleBubbleDragging:U,handleBubbleDragEnd:g,handleBubbleResizeStart:d,handleBubbleResizing:x,handleBubbleResizeEnd:_,handleBubbleRotateStart:q,handleBubbleRotating:V,handleBubbleRotateEnd:se,toggleDrawingMode:X,handleDrawBubble:ie,startDrawingBox:z,updateDrawingBox:R,finishDrawingBox:I,cancelDrawing:F,getDrawingRectStyle:y,handleBubbleUpdate:S,deleteSelectedBubbles:w,repairSelectedBubble:W,triggerDelayedPreview:D,handleOcrRecognize:Y}}function fm(n){const t=gt(),s=et(),{bubbles:o}=kt(t),{currentImage:i}=kt(s),r=C(!1),a=C("");let u=null;function p(){const P=i.value;if(!P)return null;if(P.cleanImageData)return P.cleanImageData;if(P.originalDataURL){const L=P.originalDataURL.match(/^data:image\/[^;]+;base64,(.+)$/);if(L&&L[1])return L[1]}return null}async function k(P=!1){if(!i.value)return console.warn("reRenderFullImage: æ²¡æœ‰å½“å‰å›¾ç‰‡"),!1;if(o.value.length===0){console.log("reRenderFullImage: æ²¡æœ‰æ°”æ³¡ï¼Œè·³è¿‡åç«¯æ¸²æŸ“");const $=p();if($){const j=`data:image/png;base64,${$}`;s.updateCurrentImage({translatedDataURL:j}),P||n?.onRenderSuccess?.(j)}return!0}const M=p();if(!M)return console.error("reRenderFullImage: ç¼ºå°‘å›¾åƒæ•°æ®"),a.value="ç¼ºå°‘å›¾åƒæ•°æ®",P||n?.onRenderError?.("ç¼ºå°‘å›¾åƒæ•°æ®"),!1;const E=Symbol("render");u=E,r.value=!0,a.value="",P||n?.onRenderStart?.();try{console.log("reRenderFullImage: å¼€å§‹é‡æ–°æ¸²æŸ“ï¼Œæ°”æ³¡æ•°é‡:",o.value.length);const $=o.value,j=$.map(d=>d.translatedText||""),K=$.map(d=>d.coords.map(x=>Math.round(x))),U=$.map(d=>({translatedText:d.translatedText||"",coords:d.coords,fontSize:Number(d.fontSize)||24,fontFamily:d.fontFamily||xt,textDirection:Lt(d),textColor:d.textColor||"#231816",rotationAngle:Math.round(Number(d.rotationAngle)||0),position:d.position?{x:Math.round(d.position.x||0),y:Math.round(d.position.y||0)}:{x:0,y:0},strokeEnabled:d.strokeEnabled!==void 0?d.strokeEnabled:!0,strokeColor:d.strokeColor||"#FFFFFF",strokeWidth:Number(d.strokeWidth)||3})),g=await yo({clean_image:M,bubble_texts:j,bubble_coords:K,bubble_states:U,fontSize:Number($[0]?.fontSize)||24,fontFamily:$[0]?.fontFamily||xt,textDirection:$[0]?Lt($[0]):"vertical",textColor:$[0]?.textColor||"#231816",strokeEnabled:$[0]?.strokeEnabled!==void 0?$[0].strokeEnabled:!0,strokeColor:$[0]?.strokeColor||"#FFFFFF",strokeWidth:Number($[0]?.strokeWidth)||3,use_individual_styles:!0,use_inpainting:!1,use_lama:!1,is_font_style_change:!0});if(u!==E)return console.log("reRenderFullImage: æ¸²æŸ“ç»“æœå·²è¿‡æœŸï¼Œå¿½ç•¥"),!1;if(g.rendered_image){const d=`data:image/png;base64,${g.rendered_image}`;return s.updateCurrentImage({translatedDataURL:d}),console.log("reRenderFullImage: æ¸²æŸ“æˆåŠŸ"),P||n?.onRenderSuccess?.(d),!0}else{const d=g.error||"æ¸²æŸ“å¤±è´¥";return console.error("reRenderFullImage: æ¸²æŸ“å¤±è´¥ -",d),a.value=d,P||n?.onRenderError?.(d),!1}}catch($){if(u!==E)return!1;const j=$ instanceof Error?$.message:"æ¸²æŸ“è¯·æ±‚å¤±è´¥";return console.error("reRenderFullImage: æ¸²æŸ“å‡ºé”™ -",$),a.value=j,P||n?.onRenderError?.(j),!1}finally{u===E&&(r.value=!1,P||n?.onRenderEnd?.())}}function f(){u=null,r.value=!1}return{isRendering:r,renderError:a,reRenderFullImage:k,cancelRender:f}}const bm=["data-index","data-coords","data-rotation","onClick","onMousedown"],hm={class:"bubble-index"},ym=["data-parent-index","onMousedown"],xm=["data-parent-index","onMousedown"],_m=["data-parent-index","onMousedown"],Cm=["data-parent-index","onMousedown"],Sm=["data-parent-index","onMousedown"],km=["data-parent-index","onMousedown"],wm=["data-parent-index","onMousedown"],$m=["data-parent-index","onMousedown"],Tm=["data-parent-index","onMousedown"],Im=je({__name:"BubbleOverlay",props:{bubbles:{},selectedIndex:{},selectedIndices:{},scale:{},isDrawingMode:{type:Boolean},isBrushMode:{type:Boolean},imageWidth:{},imageHeight:{}},emits:["select","multiSelect","dragStart","dragging","dragEnd","resizeStart","resizing","resizeEnd","rotateStart","rotating","rotateEnd","drawBubble"],setup(n,{emit:t}){const s=gt(),{isDragging:o,draggingIndex:i,dragOffsetX:r,dragOffsetY:a,dragInitialX:u,dragInitialY:p,isResizing:k,resizingIndex:f,resizeCurrentCoords:P,isRotating:L,rotatingIndex:M,rotateCurrentAngle:E}=kt(s),$=n,j=t,K=C(null),U=C(0),g=C(0),d=C(""),x=C(0),_=C(0),q=C(null),V=C(0),se=C(0),X=C(0),ie=C(0),z=C(!1),R=C(0),I=C(0),F=C(null),y=C(!1);function m(b,J){let ve,fe,O,ne,be=b.rotationAngle||0;if(o.value&&i.value===J){const[Le,ke,Be,ye]=b.coords;ve=u.value+r.value,fe=p.value+a.value,O=ve+(Be-Le),ne=fe+(ye-ke)}else k.value&&f.value===J&&P.value?[ve,fe,O,ne]=P.value:L.value&&M.value===J?([ve,fe,O,ne]=b.coords,be=E.value):[ve,fe,O,ne]=b.coords;const ge=O-ve,Pe=ne-fe,Ee={left:`${ve}px`,top:`${fe}px`,width:`${ge}px`,height:`${Pe}px`};return be&&(Ee.transformOrigin="center center",Ee.transform=`rotate(${be}deg)`),Ee}function l(){if(!F.value)return{};const[b,J,ve,fe]=F.value;return{left:`${Math.min(b,ve)}px`,top:`${Math.min(J,fe)}px`,width:`${Math.abs(ve-b)}px`,height:`${Math.abs(fe-J)}px`}}function v(b){if(!K.value)return null;const J=K.value.getBoundingClientRect(),ve=$.scale||1,fe=(b.clientX-J.left)/ve,O=(b.clientY-J.top)/ve;return{x:fe,y:O}}function D(b,J){$.isBrushMode||J.shiftKey||j("select",b)}function S(b){if(!$.isBrushMode){if(b.button===1){b.preventDefault(),y.value=!0,document.body.classList.add("middle-button-drawing"),_e(b);return}b.button===0&&$.isDrawingMode&&_e(b)}}function w(b,J){if(!$.isBrushMode&&J.button===0){if(J.preventDefault(),J.stopPropagation(),J.shiftKey){j("multiSelect",b);return}if(b!==$.selectedIndex){j("select",b);return}W(b,J)}}function W(b,J){document.removeEventListener("mousemove",he),document.removeEventListener("mouseup",te),o.value=!0,i.value=b,U.value=J.clientX,g.value=J.clientY,r.value=0,a.value=0;const ve=$.bubbles[b];ve&&(u.value=ve.coords[0],p.value=ve.coords[1]),j("dragStart",b,J),document.addEventListener("mousemove",he),document.addEventListener("mouseup",te)}function Z(b){const J=$.scale||1,ve=(b.clientX-U.value)/J,fe=(b.clientY-g.value)/J;r.value=ve,a.value=fe}function Y(b){const J=i.value;o.value=!1,i.value=-1,r.value=0,a.value=0;const ve=$.scale||1,fe=(b.clientX-U.value)/ve,O=(b.clientY-g.value)/ve,ne=$.bubbles[J];if(!ne)return;const[be,ge,Pe,Ee]=ne.coords,Le=Pe-be,ke=Ee-ge;let Be=Math.round(u.value+fe),ye=Math.round(p.value+O);const it=$.imageWidth||2e3,Ge=$.imageHeight||2e3,Ze=Math.min(Le,it),st=Math.min(ke,Ge);Be=Math.max(0,Math.min(Be,it-Ze)),ye=Math.max(0,Math.min(ye,Ge-st));const Ae=[Be,ye,Be+Ze,ye+st];j("dragEnd",J,Ae)}function c(b,J,ve){if($.isBrushMode||ve.button!==0)return;ve.preventDefault(),ve.stopPropagation(),document.removeEventListener("mousemove",he),document.removeEventListener("mouseup",te),k.value=!0,f.value=J,d.value=b,x.value=ve.clientX,_.value=ve.clientY;const fe=$.bubbles[J];fe&&(q.value=[...fe.coords],P.value=[...fe.coords]),j("resizeStart",J,b,ve),document.addEventListener("mousemove",he),document.addEventListener("mouseup",te)}function h(b){if(!q.value)return;const J=$.scale||1,ve=(b.clientX-x.value)/J,fe=(b.clientY-_.value)/J;let[O,ne,be,ge]=q.value;const Pe=d.value;Pe.includes("w")&&(O+=ve),Pe.includes("e")&&(be+=ve),Pe.includes("n")&&(ne+=fe),Pe.includes("s")&&(ge+=fe),O>be&&([O,be]=[be,O]),ne>ge&&([ne,ge]=[ge,ne]);const Ee=10;be-O<Ee||ge-ne<Ee||(P.value=[O,ne,be,ge])}function le(b){if(!q.value)return;const J=$.scale||1,ve=(b.clientX-x.value)/J,fe=(b.clientY-_.value)/J;let[O,ne,be,ge]=q.value;const Pe=d.value;Pe.includes("w")&&(O+=ve),Pe.includes("e")&&(be+=ve),Pe.includes("n")&&(ne+=fe),Pe.includes("s")&&(ge+=fe),O>be&&([O,be]=[be,O]),ne>ge&&([ne,ge]=[ge,ne]);const Ee=$.imageWidth||2e3,Le=$.imageHeight||2e3;O=Math.max(0,Math.round(O)),ne=Math.max(0,Math.round(ne)),be=Math.min(Ee,Math.round(be)),ge=Math.min(Le,Math.round(ge));const ke=10;if(be-O<ke||ge-ne<ke){console.warn("è°ƒæ•´åå°ºå¯¸è¿‡å°ï¼Œå·²æ’¤é”€"),k.value=!1,f.value=-1,q.value=null;return}j("resizeEnd",f.value,[O,ne,be,ge]),k.value=!1,f.value=-1,q.value=null,P.value=null}function T(b,J){if($.isBrushMode||J.button!==0)return;J.preventDefault(),J.stopPropagation(),document.removeEventListener("mousemove",he),document.removeEventListener("mouseup",te),L.value=!0,M.value=b;const ve=$.bubbles[b];if(!ve||!K.value)return;const[fe,O,ne,be]=ve.coords,ge=$.scale||1,Pe=K.value.getBoundingClientRect();X.value=Pe.left+(fe+ne)/2*ge,ie.value=Pe.top+(O+be)/2*ge;const Ee=J.clientX-X.value,Le=J.clientY-ie.value;V.value=Math.atan2(Le,Ee)*180/Math.PI,se.value=ve.rotationAngle||0,E.value=ve.rotationAngle||0,j("rotateStart",b,J),document.body.classList.add("rotating-box"),document.addEventListener("mousemove",he),document.addEventListener("mouseup",te),console.log(`å¼€å§‹æ—‹è½¬æ°”æ³¡ #${b+1}ï¼Œåˆå§‹è§’åº¦: ${se.value}Â°`)}function G(b){const J=b.clientX-X.value,ve=b.clientY-ie.value,O=Math.atan2(ve,J)*180/Math.PI-V.value;let ne=se.value+O;for(;ne>180;)ne-=360;for(;ne<-180;)ne+=360;b.shiftKey&&(ne=Math.round(ne/15)*15),E.value=ne}function ce(b){document.body.classList.remove("rotating-box");const J=M.value,ve=E.value;j("rotateEnd",J,ve),L.value=!1,M.value=-1,console.log(`æ°”æ³¡ #${J+1} æ—‹è½¬å®Œæˆï¼Œè§’åº¦: ${ve}Â°`)}function _e(b){const J=v(b);if(!J)return;const ve=$.imageWidth||2e3,fe=$.imageHeight||2e3;J.x<0||J.x>ve||J.y<0||J.y>fe||(z.value=!0,R.value=J.x,I.value=J.y,F.value=[J.x,J.y,J.x,J.y],document.addEventListener("mousemove",he),document.addEventListener("mouseup",te),console.log("å¼€å§‹ç»˜åˆ¶æ–°æ¡†:",J.x.toFixed(1),J.y.toFixed(1)))}function De(b){const J=v(b);!J||!F.value||(F.value=[R.value,I.value,J.x,J.y])}function $e(b){const J=v(b);if(y.value&&(y.value=!1,document.body.classList.remove("middle-button-drawing")),!J||!F.value){z.value=!1,F.value=null;return}const ve=$.imageWidth||2e3,fe=$.imageHeight||2e3,O=Math.max(0,Math.round(Math.min(R.value,J.x))),ne=Math.max(0,Math.round(Math.min(I.value,J.y))),be=Math.min(ve,Math.round(Math.max(R.value,J.x))),ge=Math.min(fe,Math.round(Math.max(I.value,J.y))),Pe=10;if(be-O<Pe||ge-ne<Pe){console.log("ç»˜åˆ¶çš„æ¡†å¤ªå°ï¼Œå·²å¿½ç•¥"),z.value=!1,F.value=null;return}console.log("å®Œæˆç»˜åˆ¶æ–°æ¡†:",[O,ne,be,ge]),j("drawBubble",[O,ne,be,ge]),z.value=!1,F.value=null}function he(b){o.value?Z(b):k.value?h(b):L.value?G(b):z.value&&De(b)}function te(b){document.removeEventListener("mousemove",he),document.removeEventListener("mouseup",te),(b.button===1||y.value)&&(y.value=!1,document.body.classList.remove("middle-button-drawing")),o.value?Y(b):k.value?le(b):L.value?ce():z.value&&$e(b)}return dt(()=>{}),Ot(()=>{document.removeEventListener("mousemove",he),document.removeEventListener("mouseup",te),document.body.classList.remove("middle-button-drawing"),document.body.classList.remove("rotating-box")}),(b,J)=>(B(),A("div",{class:Ie(["bubble-overlay",{"brush-mode":n.isBrushMode}]),style:at({"--scale":n.scale||1}),ref_key:"overlayRef",ref:K,onMousedown:S},[(B(!0),A(Oe,null,Ye(n.bubbles,(ve,fe)=>(B(),A("div",{key:fe,class:Ie(["bubble-highlight-box",{selected:fe===n.selectedIndex,"multi-selected":n.selectedIndices.length>1&&n.selectedIndices.includes(fe)&&fe!==n.selectedIndex}]),style:at(m(ve,fe)),"data-index":fe,"data-coords":JSON.stringify(ve.coords),"data-rotation":ve.rotationAngle||0,onClick:lt(O=>D(fe,O),["stop"]),onMousedown:lt(O=>w(fe,O),["stop"])},[e("span",hm,oe(fe+1),1),fe===n.selectedIndex?(B(),A(Oe,{key:0},[e("div",{class:"resize-handle nw","data-handle":"nw","data-parent-index":fe,onMousedown:lt(O=>c("nw",fe,O),["stop"])},null,40,ym),e("div",{class:"resize-handle n","data-handle":"n","data-parent-index":fe,onMousedown:lt(O=>c("n",fe,O),["stop"])},null,40,xm),e("div",{class:"resize-handle ne","data-handle":"ne","data-parent-index":fe,onMousedown:lt(O=>c("ne",fe,O),["stop"])},null,40,_m),e("div",{class:"resize-handle e","data-handle":"e","data-parent-index":fe,onMousedown:lt(O=>c("e",fe,O),["stop"])},null,40,Cm),e("div",{class:"resize-handle se","data-handle":"se","data-parent-index":fe,onMousedown:lt(O=>c("se",fe,O),["stop"])},null,40,Sm),e("div",{class:"resize-handle s","data-handle":"s","data-parent-index":fe,onMousedown:lt(O=>c("s",fe,O),["stop"])},null,40,km),e("div",{class:"resize-handle sw","data-handle":"sw","data-parent-index":fe,onMousedown:lt(O=>c("sw",fe,O),["stop"])},null,40,wm),e("div",{class:"resize-handle w","data-handle":"w","data-parent-index":fe,onMousedown:lt(O=>c("w",fe,O),["stop"])},null,40,$m),J[0]||(J[0]=e("div",{class:"rotate-line"},null,-1)),e("div",{class:"rotate-handle",title:"æ‹–æ‹½æ—‹è½¬","data-parent-index":fe,onMousedown:lt(O=>T(fe,O),["stop"])},null,40,Tm)],64)):de("",!0)],46,bm))),128)),F.value?(B(),A("div",{key:0,class:"drawing-rect",style:at(l())},null,4)):de("",!0)],38))}}),yn=He(Im,[["__scopeId","data-v-8d9cb1b9"]]),Pm={key:0,class:"kana-keyboard"},Rm={class:"kana-keyboard-header"},Dm={class:"kana-keyboard-tabs"},Mm=["onClick"],Em={class:"kana-keyboard-options"},Bm={class:"kana-mode-select"},Am={class:"kana-target-select"},Lm={class:"kana-table"},Fm={class:"row-label"},Um=["onClick"],Om={class:"kana-hiragana"},zm={class:"kana-katakana"},Nm={class:"kana-table"},Vm={class:"row-label"},Wm=["onClick"],Km={class:"kana-hiragana"},qm={class:"kana-katakana"},Hm={class:"kana-table combo-table"},jm={class:"row-label"},Jm=["onClick"],Ym={class:"kana-hiragana"},Xm={class:"kana-katakana"},Gm={class:"special-chars-grid"},Zm=["onClick"],Qm={key:0,class:"char-label"},ev=je({__name:"JapaneseKeyboard",props:{visible:{type:Boolean,default:!1},defaultTarget:{default:"original"}},emits:["close","insert","delete"],setup(n,{emit:t}){const s=n,o=t,i=C("basic"),r=C("hiragana"),a=C(s.defaultTarget),u=C(null),p=[{label:"åŸæ–‡",value:"original"},{label:"è¯‘æ–‡",value:"translated"}],k=[{id:"basic",label:"åŸºæœ¬"},{id:"dakuten",label:"æµŠ/åŠæµŠéŸ³"},{id:"combo",label:"æ‹—éŸ³"},{id:"special",label:"ç‰¹æ®Š"}],f=[{label:"ã‚è¡Œ",chars:[{h:"ã‚",k:"ã‚¢"},{h:"ã„",k:"ã‚¤"},{h:"ã†",k:"ã‚¦"},{h:"ãˆ",k:"ã‚¨"},{h:"ãŠ",k:"ã‚ª"}]},{label:"ã‹è¡Œ",chars:[{h:"ã‹",k:"ã‚«"},{h:"ã",k:"ã‚­"},{h:"ã",k:"ã‚¯"},{h:"ã‘",k:"ã‚±"},{h:"ã“",k:"ã‚³"}]},{label:"ã•è¡Œ",chars:[{h:"ã•",k:"ã‚µ"},{h:"ã—",k:"ã‚·"},{h:"ã™",k:"ã‚¹"},{h:"ã›",k:"ã‚»"},{h:"ã",k:"ã‚½"}]},{label:"ãŸè¡Œ",chars:[{h:"ãŸ",k:"ã‚¿"},{h:"ã¡",k:"ãƒ"},{h:"ã¤",k:"ãƒ„"},{h:"ã¦",k:"ãƒ†"},{h:"ã¨",k:"ãƒˆ"}]},{label:"ãªè¡Œ",chars:[{h:"ãª",k:"ãƒŠ"},{h:"ã«",k:"ãƒ‹"},{h:"ã¬",k:"ãƒŒ"},{h:"ã­",k:"ãƒ"},{h:"ã®",k:"ãƒ"}]},{label:"ã¯è¡Œ",chars:[{h:"ã¯",k:"ãƒ"},{h:"ã²",k:"ãƒ’"},{h:"ãµ",k:"ãƒ•"},{h:"ã¸",k:"ãƒ˜"},{h:"ã»",k:"ãƒ›"}]},{label:"ã¾è¡Œ",chars:[{h:"ã¾",k:"ãƒ"},{h:"ã¿",k:"ãƒŸ"},{h:"ã‚€",k:"ãƒ "},{h:"ã‚",k:"ãƒ¡"},{h:"ã‚‚",k:"ãƒ¢"}]},{label:"ã‚„è¡Œ",chars:[{h:"ã‚„",k:"ãƒ¤"},null,{h:"ã‚†",k:"ãƒ¦"},null,{h:"ã‚ˆ",k:"ãƒ¨"}]},{label:"ã‚‰è¡Œ",chars:[{h:"ã‚‰",k:"ãƒ©"},{h:"ã‚Š",k:"ãƒª"},{h:"ã‚‹",k:"ãƒ«"},{h:"ã‚Œ",k:"ãƒ¬"},{h:"ã‚",k:"ãƒ­"}]},{label:"ã‚è¡Œ",chars:[{h:"ã‚",k:"ãƒ¯"},null,null,null,{h:"ã‚’",k:"ãƒ²"}]},{label:"ã‚“",chars:[{h:"ã‚“",k:"ãƒ³"},null,null,null,null]}],P=[{label:"ãŒè¡Œ",chars:[{h:"ãŒ",k:"ã‚¬"},{h:"ã",k:"ã‚®"},{h:"ã",k:"ã‚°"},{h:"ã’",k:"ã‚²"},{h:"ã”",k:"ã‚´"}]},{label:"ã–è¡Œ",chars:[{h:"ã–",k:"ã‚¶"},{h:"ã˜",k:"ã‚¸"},{h:"ãš",k:"ã‚º"},{h:"ãœ",k:"ã‚¼"},{h:"ã",k:"ã‚¾"}]},{label:"ã è¡Œ",chars:[{h:"ã ",k:"ãƒ€"},{h:"ã¢",k:"ãƒ‚"},{h:"ã¥",k:"ãƒ…"},{h:"ã§",k:"ãƒ‡"},{h:"ã©",k:"ãƒ‰"}]},{label:"ã°è¡Œ",chars:[{h:"ã°",k:"ãƒ"},{h:"ã³",k:"ãƒ“"},{h:"ã¶",k:"ãƒ–"},{h:"ã¹",k:"ãƒ™"},{h:"ã¼",k:"ãƒœ"}]},{label:"ã±è¡Œ",chars:[{h:"ã±",k:"ãƒ‘"},{h:"ã´",k:"ãƒ”"},{h:"ã·",k:"ãƒ—"},{h:"ãº",k:"ãƒš"},{h:"ã½",k:"ãƒ"}]}],L=[{label:"ãã‚ƒè¡Œ",chars:[{h:"ãã‚ƒ",k:"ã‚­ãƒ£"},{h:"ãã‚…",k:"ã‚­ãƒ¥"},{h:"ãã‚‡",k:"ã‚­ãƒ§"}]},{label:"ã—ã‚ƒè¡Œ",chars:[{h:"ã—ã‚ƒ",k:"ã‚·ãƒ£"},{h:"ã—ã‚…",k:"ã‚·ãƒ¥"},{h:"ã—ã‚‡",k:"ã‚·ãƒ§"}]},{label:"ã¡ã‚ƒè¡Œ",chars:[{h:"ã¡ã‚ƒ",k:"ãƒãƒ£"},{h:"ã¡ã‚…",k:"ãƒãƒ¥"},{h:"ã¡ã‚‡",k:"ãƒãƒ§"}]},{label:"ã«ã‚ƒè¡Œ",chars:[{h:"ã«ã‚ƒ",k:"ãƒ‹ãƒ£"},{h:"ã«ã‚…",k:"ãƒ‹ãƒ¥"},{h:"ã«ã‚‡",k:"ãƒ‹ãƒ§"}]},{label:"ã²ã‚ƒè¡Œ",chars:[{h:"ã²ã‚ƒ",k:"ãƒ’ãƒ£"},{h:"ã²ã‚…",k:"ãƒ’ãƒ¥"},{h:"ã²ã‚‡",k:"ãƒ’ãƒ§"}]},{label:"ã¿ã‚ƒè¡Œ",chars:[{h:"ã¿ã‚ƒ",k:"ãƒŸãƒ£"},{h:"ã¿ã‚…",k:"ãƒŸãƒ¥"},{h:"ã¿ã‚‡",k:"ãƒŸãƒ§"}]},{label:"ã‚Šã‚ƒè¡Œ",chars:[{h:"ã‚Šã‚ƒ",k:"ãƒªãƒ£"},{h:"ã‚Šã‚…",k:"ãƒªãƒ¥"},{h:"ã‚Šã‚‡",k:"ãƒªãƒ§"}]},{label:"ãã‚ƒè¡Œ",chars:[{h:"ãã‚ƒ",k:"ã‚®ãƒ£"},{h:"ãã‚…",k:"ã‚®ãƒ¥"},{h:"ãã‚‡",k:"ã‚®ãƒ§"}]},{label:"ã˜ã‚ƒè¡Œ",chars:[{h:"ã˜ã‚ƒ",k:"ã‚¸ãƒ£"},{h:"ã˜ã‚…",k:"ã‚¸ãƒ¥"},{h:"ã˜ã‚‡",k:"ã‚¸ãƒ§"}]},{label:"ã³ã‚ƒè¡Œ",chars:[{h:"ã³ã‚ƒ",k:"ãƒ“ãƒ£"},{h:"ã³ã‚…",k:"ãƒ“ãƒ¥"},{h:"ã³ã‚‡",k:"ãƒ“ãƒ§"}]},{label:"ã´ã‚ƒè¡Œ",chars:[{h:"ã´ã‚ƒ",k:"ãƒ”ãƒ£"},{h:"ã´ã‚…",k:"ãƒ”ãƒ¥"},{h:"ã´ã‚‡",k:"ãƒ”ãƒ§"}]}],M=[{char:"ã£",label:"ä¿ƒéŸ³"},{char:"ãƒƒ",label:"ä¿ƒéŸ³"},{char:"ãƒ¼",label:"é•¿éŸ³"},{char:"ã€œ",label:"æ³¢æµª"},{char:"ã€‚",label:"å¥å·"},{char:"ã€",label:"é¡¿å·"},{char:"ã€Œ",label:"å¼•å·"},{char:"ã€",label:"å¼•å·"},{char:"ã€",label:"åŒå¼•"},{char:"ã€",label:"åŒå¼•"},{char:"â€¦",label:"çœç•¥"},{char:"ãƒ»",label:"ä¸­ç‚¹"},{char:"ï¼",label:"æ„Ÿå¹"},{char:"ï¼Ÿ",label:"é—®å·"},{char:"â™ª",label:"éŸ³ç¬¦"},{char:"â™¡",label:"å¿ƒå½¢"},{char:"â˜…",label:"æ˜Ÿå½¢"},{char:"â˜†",label:"ç©ºæ˜Ÿ"},{char:"ã",label:"å°ã‚"},{char:"ãƒ",label:"å°ã„"},{char:"ã…",label:"å°ã†"},{char:"ã‡",label:"å°ãˆ"},{char:"ã‰",label:"å°ãŠ"},{char:"ã‚¡",label:"å°ã‚¢"},{char:"ã‚£",label:"å°ã‚¤"},{char:"ã‚¥",label:"å°ã‚¦"},{char:"ã‚§",label:"å°ã‚¨"},{char:"ã‚©",label:"å°ã‚ª"},{char:"ã‚ƒ",label:"å°ã‚„"},{char:"ã‚…",label:"å°ã‚†"},{char:"ã‚‡",label:"å°ã‚ˆ"},{char:"ãƒ£",label:"å°ãƒ¤"},{char:"ãƒ¥",label:"å°ãƒ¦"},{char:"ãƒ§",label:"å°ãƒ¨"}];function E(){o("close")}function $(U){const g=r.value==="hiragana"?U.h:U.k;u.value=U.h,setTimeout(()=>{u.value=null},100),o("insert",g,a.value)}function j(U){u.value=U,setTimeout(()=>{u.value=null},100),o("insert",U,a.value)}function K(){o("delete",a.value)}return(U,g)=>n.visible?(B(),A("div",Pm,[e("div",Rm,[g[3]||(g[3]=e("span",{class:"kana-keyboard-title"},"50éŸ³é”®ç›˜",-1)),e("div",Dm,[(B(),A(Oe,null,Ye(k,d=>e("button",{key:d.id,class:Ie(["kana-tab",{active:i.value===d.id}]),onClick:x=>i.value=d.id},oe(d.label),11,Mm)),64))]),e("button",{class:"kana-keyboard-close",onClick:E},"âœ•")]),e("div",Em,[e("div",Bm,[e("label",null,[ae(e("input",{type:"radio",name:"kanaMode",value:"hiragana","onUpdate:modelValue":g[0]||(g[0]=d=>r.value=d)},null,512),[[rn,r.value]]),g[4]||(g[4]=me(" å¹³å‡å ",-1))]),e("label",null,[ae(e("input",{type:"radio",name:"kanaMode",value:"katakana","onUpdate:modelValue":g[1]||(g[1]=d=>r.value=d)},null,512),[[rn,r.value]]),g[5]||(g[5]=me(" ç‰‡å‡å ",-1))])]),e("div",Am,[g[6]||(g[6]=e("label",null,"è¾“å…¥åˆ°ï¼š",-1)),Se(We,{modelValue:a.value,"onUpdate:modelValue":g[2]||(g[2]=d=>a.value=d),options:p},null,8,["modelValue"])])]),e("div",{class:Ie(["kana-tab-content",{active:i.value==="basic"}])},[e("table",Lm,[g[7]||(g[7]=e("thead",null,[e("tr",null,[e("th"),e("th",null,"ã‚æ®µ"),e("th",null,"ã„æ®µ"),e("th",null,"ã†æ®µ"),e("th",null,"ãˆæ®µ"),e("th",null,"ãŠæ®µ")])],-1)),e("tbody",null,[(B(),A(Oe,null,Ye(f,d=>e("tr",{key:d.label},[e("td",Fm,oe(d.label),1),(B(!0),A(Oe,null,Ye(d.chars,(x,_)=>(B(),A("td",{key:_},[x?(B(),A("button",{key:0,class:Ie(["kana-key",{pressed:u.value===x.h}]),onClick:q=>$(x)},[e("span",Om,oe(x.h),1),e("span",zm,oe(x.k),1)],10,Um)):de("",!0)]))),128))])),64))])])],2),e("div",{class:Ie(["kana-tab-content",{active:i.value==="dakuten"}])},[e("table",Nm,[g[8]||(g[8]=e("thead",null,[e("tr",null,[e("th"),e("th",null,"ã‚æ®µ"),e("th",null,"ã„æ®µ"),e("th",null,"ã†æ®µ"),e("th",null,"ãˆæ®µ"),e("th",null,"ãŠæ®µ")])],-1)),e("tbody",null,[(B(),A(Oe,null,Ye(P,d=>e("tr",{key:d.label},[e("td",Vm,oe(d.label),1),(B(!0),A(Oe,null,Ye(d.chars,(x,_)=>(B(),A("td",{key:_},[x?(B(),A("button",{key:0,class:Ie(["kana-key",{pressed:u.value===x.h}]),onClick:q=>$(x)},[e("span",Km,oe(x.h),1),e("span",qm,oe(x.k),1)],10,Wm)):de("",!0)]))),128))])),64))])])],2),e("div",{class:Ie(["kana-tab-content",{active:i.value==="combo"}])},[e("table",Hm,[g[9]||(g[9]=e("thead",null,[e("tr",null,[e("th"),e("th",null,"ã‚ƒ"),e("th",null,"ã‚…"),e("th",null,"ã‚‡")])],-1)),e("tbody",null,[(B(),A(Oe,null,Ye(L,d=>e("tr",{key:d.label},[e("td",jm,oe(d.label),1),(B(!0),A(Oe,null,Ye(d.chars,(x,_)=>(B(),A("td",{key:_},[x?(B(),A("button",{key:0,class:Ie(["kana-key",{pressed:u.value===x.h}]),onClick:q=>$(x)},[e("span",Ym,oe(x.h),1),e("span",Xm,oe(x.k),1)],10,Jm)):de("",!0)]))),128))])),64))])])],2),e("div",{class:Ie(["kana-tab-content",{active:i.value==="special"}])},[e("div",Gm,[(B(),A(Oe,null,Ye(M,d=>e("button",{key:d.char,class:Ie(["kana-key special-key",{pressed:u.value===d.char}]),onClick:x=>j(d.char)},[me(oe(d.char)+" ",1),d.label?(B(),A("span",Qm,oe(d.label),1)):de("",!0)],10,Zm)),64))])],2),e("div",{class:"kana-keyboard-footer"},[e("button",{class:"kana-backspace",onClick:K},"âŒ« é€€æ ¼")])])):de("",!0)}}),tv=He(ev,[["__scopeId","data-v-ebfc2125"]]),ov={class:"edit-panel-content"},nv={class:"text-column original-text-column text-block"},sv={class:"text-column translated-text-column text-block"},av={class:"style-settings-section text-block"},lv={class:"office-toolbar"},iv={class:"toolbar-row toolbar-row-top"},rv={class:"combo-control font-control"},uv={class:"combo-control size-control"},cv={class:"size-input-wrap"},dv=["min","max","step"],gv={class:"toolbar-row toolbar-row-actions"},pv={class:"toolbar-icon-group","aria-label":"æ’ç‰ˆæ–¹å‘"},mv=["data-active"],vv=["data-active"],fv={class:"toolbar-color-group"},bv={class:"toolbar-color-picker",title:"æ–‡å­—é¢œè‰²"},hv={class:"toolbar-inpaint-group",title:"èƒŒæ™¯ä¿®å¤æ–¹å¼"},yv={class:"toolbar-stroke-cluster"},xv=["data-active"],_v={class:"toolbar-row toolbar-row-bottom"},Cv={class:"toolbar-rotation-group",title:"æ—‹è½¬è§’åº¦"},Sv={class:"toolbar-position-group",title:"ä½ç½®è°ƒæ•´"},kv={class:"toolbar-position-value"},wv={class:"fontsize-presets-panel"},$v={class:"font-size-presets"},Tv=["onClick"],Kt=2,Iv=je({__name:"BubbleEditor",props:{bubble:{},bubbleIndex:{}},emits:["update","reRender","ocrRecognize","reTranslate","applyBubble","resetCurrent"],setup(n,{emit:t}){const s=n,o=t,i=gt(),r={originalText:"",translatedText:"",fontSize:24,fontFamily:xt,textDirection:"vertical",textColor:"#231816",fillColor:"#FFFFFF",strokeEnabled:!0,strokeColor:"#FFFFFF",strokeWidth:3,rotationAngle:0,inpaintMethod:"solid",position:{x:0,y:0}},a=C(""),u=C(""),p=C(24),k=C(xt),f=C("vertical"),P=C("#231816"),L=C("#FFFFFF"),M=C(!0),E=C("#FFFFFF"),$=C(3),j=C(0),K=C("solid"),U=C(0),g=C(0),d=C(null),x=C(null),_=C(null),q=C(null),V=C(null),se=C(!1),X=C("original"),ie=C([{name:"æ€æºé»‘ä½“",path:xt},{name:"åæ–‡æ¥·ä½“",path:"fonts/STKAITI.TTF"},{name:"åæ–‡ç»†é»‘",path:"fonts/STXIHEI.TTF"},{name:"é»‘ä½“",path:"fonts/SIMHEI.TTF"},{name:"å®‹ä½“",path:"fonts/SIMSUN.TTC"}]),z=C([]),R=Q(()=>s.bubble?s.bubble.coords[0]+U.value:0),I=Q(()=>s.bubble?s.bubble.coords[1]+g.value:0),F=Q(()=>{const Ae=[{label:"ç³»ç»Ÿå­—ä½“",options:ie.value.map(N=>({label:N.name,value:N.path}))}];return z.value.length>0&&Ae.push({label:"è‡ªå®šä¹‰å­—ä½“",options:z.value.map(N=>({label:N.name,value:N.path}))}),Ae}),y=[{label:"çº¯è‰²å¡«å……",value:"solid"},{label:"LAMAä¿®å¤(æ¼«ç”»)",value:"lama_mpe"},{label:"LAMAä¿®å¤(é€šç”¨)",value:"litelama"}];function m(Ae){const N=Ae||r;a.value=N.originalText,u.value=N.translatedText,p.value=N.fontSize,k.value=N.fontFamily,f.value=N.textDirection,P.value=N.textColor,L.value=N.fillColor,M.value=N.strokeEnabled,E.value=N.strokeColor,$.value=N.strokeWidth,j.value=N.rotationAngle,K.value=N.inpaintMethod,U.value=N.position?.x||0,g.value=N.position?.y||0}Ce(()=>s.bubble,Ae=>{m(Ae)},{deep:!0,immediate:!0});function l(){o("update",{originalText:a.value})}function v(){o("update",{translatedText:u.value})}function D(){navigator.clipboard.writeText(a.value)}function S(){navigator.clipboard.writeText(u.value)}function w(){o("update",{fontSize:p.value})}function W(Ae){p.value=Ae,o("update",{fontSize:Ae})}function Z(){p.value=Math.min(nn,p.value+ro),o("update",{fontSize:p.value})}function Y(){p.value=Math.max(sn,p.value-ro),o("update",{fontSize:p.value})}function c(){o("update",{fontFamily:k.value})}function h(Ae){f.value=Ae,o("update",{textDirection:Ae})}function le(){_.value?.click()}function T(){o("update",{textColor:P.value})}function G(){q.value?.click()}function ce(){o("update",{fillColor:L.value})}function _e(){V.value?.click()}function De(){o("update",{strokeColor:E.value})}function $e(){M.value=!M.value,o("update",{strokeEnabled:M.value})}function he(){o("update",{strokeWidth:$.value})}function te(){o("update",{inpaintMethod:K.value})}function b(){o("update",{rotationAngle:j.value})}function J(){j.value=Math.max(-180,j.value-5),o("update",{rotationAngle:j.value})}function ve(){j.value=Math.min(180,j.value+5),o("update",{rotationAngle:j.value})}function fe(){j.value=0,o("update",{rotationAngle:0})}function O(){U.value-=Kt,o("update",{position:{x:U.value,y:g.value}})}function ne(){U.value+=Kt,o("update",{position:{x:U.value,y:g.value}})}function be(){g.value-=Kt,o("update",{position:{x:U.value,y:g.value}})}function ge(){g.value+=Kt,o("update",{position:{x:U.value,y:g.value}})}function Pe(){U.value=0,g.value=0,o("update",{position:{x:0,y:0}})}function Ee(){o("applyBubble",s.bubbleIndex)}function Le(){i.updateAllBubbles({fontSize:p.value,fontFamily:k.value,textDirection:f.value,textColor:P.value,fillColor:L.value,strokeEnabled:M.value,strokeColor:E.value,strokeWidth:$.value,inpaintMethod:K.value}),console.log("æ ·å¼å·²åº”ç”¨åˆ°æ‰€æœ‰æ°”æ³¡"),o("reRender")}function ke(){o("resetCurrent",s.bubbleIndex)}function Be(){o("ocrRecognize",s.bubbleIndex)}function ye(){o("reTranslate",s.bubbleIndex)}function it(){se.value=!se.value}function Ge(Ae,N){if(N==="original"){const re=d.value;if(re){const Te=re.selectionStart||a.value.length,Re=re.selectionEnd||a.value.length,tt=a.value;a.value=tt.slice(0,Te)+Ae+tt.slice(Re),pt(()=>{re.selectionStart=re.selectionEnd=Te+Ae.length,re.focus()}),o("update",{originalText:a.value})}}else{const re=x.value;if(re){const Te=re.selectionStart||u.value.length,Re=re.selectionEnd||u.value.length,tt=u.value;u.value=tt.slice(0,Te)+Ae+tt.slice(Re),pt(()=>{re.selectionStart=re.selectionEnd=Te+Ae.length,re.focus()}),o("update",{translatedText:u.value})}}}function Ze(Ae){if(Ae==="original"){const N=d.value;if(N&&a.value.length>0){const re=N.selectionStart||a.value.length,Te=N.selectionEnd||a.value.length,Re=a.value;re===Te&&re>0?(a.value=Re.slice(0,re-1)+Re.slice(Te),pt(()=>{N.selectionStart=N.selectionEnd=re-1,N.focus()})):re!==Te&&(a.value=Re.slice(0,re)+Re.slice(Te),pt(()=>{N.selectionStart=N.selectionEnd=re,N.focus()})),o("update",{originalText:a.value})}}else{const N=x.value;if(N&&u.value.length>0){const re=N.selectionStart||u.value.length,Te=N.selectionEnd||u.value.length,Re=u.value;re===Te&&re>0?(u.value=Re.slice(0,re-1)+Re.slice(Te),pt(()=>{N.selectionStart=N.selectionEnd=re-1,N.focus()})):re!==Te&&(u.value=Re.slice(0,re)+Re.slice(Te),pt(()=>{N.selectionStart=N.selectionEnd=re,N.focus()})),o("update",{translatedText:u.value})}}}async function st(){try{const Ae=await Es();if(Ae.fonts){const N=[],re=[];for(const Te of Ae.fonts){const Re={name:typeof Te=="string"?Te:Te.display_name||Te.file_name||"",path:typeof Te=="string"?Te:Te.path};Re.path.startsWith("fonts/")?N.push(Re):re.push(Re)}N.length>0&&(ie.value=N),z.value=re}}catch(Ae){console.error("åŠ è½½å­—ä½“åˆ—è¡¨å¤±è´¥:",Ae)}}return dt(()=>{st()}),(Ae,N)=>(B(),A("div",ov,[e("div",nv,[e("div",{class:"text-column-header"},[N[13]||(N[13]=e("span",{class:"column-title"},"ğŸ‡¯ğŸ‡µ æ—¥è¯­åŸæ–‡ (OCRç»“æœ)",-1)),e("button",{class:"re-ocr-btn",onClick:Be,title:"é‡æ–°OCRæ­¤æ°”æ³¡"},"ğŸ”„")]),ae(e("textarea",{ref_key:"originalTextInput",ref:d,"onUpdate:modelValue":N[0]||(N[0]=re=>a.value=re),class:"text-editor original-editor",placeholder:"OCRè¯†åˆ«çš„æ—¥è¯­åŸæ–‡...",spellcheck:"false",onInput:l},null,544),[[we,a.value]]),e("div",{class:"text-actions"},[e("button",{class:"copy-btn",onClick:D},"ğŸ“‹ å¤åˆ¶"),e("button",{class:"keyboard-toggle-btn",onClick:it,title:"æ˜¾ç¤º/éšè—50éŸ³é”®ç›˜"}," âŒ¨ï¸ 50éŸ³ ")]),Se(tv,{visible:se.value,"default-target":X.value,onClose:N[1]||(N[1]=re=>se.value=!1),onInsert:Ge,onDelete:Ze},null,8,["visible","default-target"])]),e("div",sv,[e("div",{class:"text-column-header"},[N[14]||(N[14]=e("span",{class:"column-title"},"ğŸ‡¨ğŸ‡³ ä¸­æ–‡è¯‘æ–‡",-1)),e("button",{class:"re-translate-btn",onClick:ye,title:"é‡æ–°ç¿»è¯‘æ­¤æ°”æ³¡"}," ğŸ”„ ")]),ae(e("textarea",{ref_key:"translatedTextInput",ref:x,"onUpdate:modelValue":N[2]||(N[2]=re=>u.value=re),class:"text-editor translated-editor",placeholder:"ç¿»è¯‘åçš„ä¸­æ–‡...",spellcheck:"false",onInput:v},null,544),[[we,u.value]]),e("div",{class:"text-actions"},[e("button",{class:"copy-btn",onClick:S},"ğŸ“‹ å¤åˆ¶"),e("button",{class:"apply-text-btn",onClick:Ee},"âœ“ åº”ç”¨æ–‡æœ¬")])]),e("div",av,[e("div",lv,[e("div",iv,[e("div",rv,[N[15]||(N[15]=e("label",null,"å­—ä½“",-1)),Se(We,{modelValue:k.value,"onUpdate:modelValue":N[3]||(N[3]=re=>k.value=re),groups:F.value,title:"å­—ä½“",onChange:c},null,8,["modelValue","groups"])]),e("div",uv,[N[16]||(N[16]=e("label",null,"å­—å·",-1)),e("div",cv,[ae(e("input",{type:"number","onUpdate:modelValue":N[4]||(N[4]=re=>p.value=re),class:"toolbar-fontsize-input",min:H(sn),max:H(nn),step:H(ro),title:"å­—å·",onChange:w},null,40,dv),[[we,p.value,void 0,{number:!0}]]),e("div",{class:"toolbar-fontsize-btns"},[e("button",{class:"toolbar-fontsize-btn",onClick:Z,title:"å¢å¤§å­—å·"}," A+ "),e("button",{class:"toolbar-fontsize-btn",onClick:Y,title:"å‡å°å­—å·"}," A- ")])])])]),e("div",gv,[e("div",pv,[e("button",{class:"toolbar-btn","data-active":f.value==="vertical",onClick:N[5]||(N[5]=re=>h("vertical")),title:"ç«–å‘æ’ç‰ˆ"},[...N[17]||(N[17]=[e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("path",{d:"M8 2v12M8 2L5 5M8 2l3 3",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])],8,mv),e("button",{class:"toolbar-btn","data-active":f.value==="horizontal",onClick:N[6]||(N[6]=re=>h("horizontal")),title:"æ¨ªå‘æ’ç‰ˆ"},[...N[18]||(N[18]=[e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("path",{d:"M2 8h12M14 8l-3-3M14 8l-3 3",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])],8,vv)]),N[24]||(N[24]=e("div",{class:"toolbar-divider vertical"},null,-1)),e("div",fv,[e("div",bv,[e("button",{class:"toolbar-btn toolbar-color-btn",onClick:le},[N[19]||(N[19]=e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("text",{x:"3",y:"11","font-size":"10","font-weight":"bold",fill:"currentColor"},"A")],-1)),e("span",{class:"color-indicator",style:at({background:P.value})},null,4)]),ae(e("input",{ref_key:"textColorInput",ref:_,type:"color","onUpdate:modelValue":N[7]||(N[7]=re=>P.value=re),class:"hidden-color-input",onInput:T,onChange:T},null,544),[[we,P.value]])])]),N[25]||(N[25]=e("div",{class:"toolbar-divider vertical"},null,-1)),e("div",hv,[Se(We,{modelValue:K.value,"onUpdate:modelValue":N[8]||(N[8]=re=>K.value=re),options:y,onChange:te},null,8,["modelValue"]),e("div",{class:Ie(["toolbar-color-picker toolbar-solid-color-options",{hidden:K.value!=="solid"}])},[e("button",{class:"toolbar-btn toolbar-color-btn",onClick:G},[N[20]||(N[20]=e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("rect",{x:"2",y:"2",width:"12",height:"12",rx:"2",fill:"none",stroke:"currentColor","stroke-width":"1.2"}),e("rect",{x:"4",y:"4",width:"8",height:"8",rx:"1",fill:"currentColor",opacity:"0.3"})],-1)),e("span",{class:"color-indicator",style:at({background:L.value})},null,4)]),ae(e("input",{ref_key:"fillColorInput",ref:q,type:"color","onUpdate:modelValue":N[9]||(N[9]=re=>L.value=re),class:"hidden-color-input",onChange:ce},null,544),[[we,L.value]])],2)]),N[26]||(N[26]=e("div",{class:"toolbar-divider vertical"},null,-1)),e("div",yv,[e("button",{class:"toolbar-btn","data-active":M.value,onClick:$e,title:"æ–‡å­—æè¾¹"},[...N[21]||(N[21]=[e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("text",{x:"3",y:"12","font-size":"11","font-weight":"bold",stroke:"currentColor","stroke-width":"2",fill:"none"}," A "),e("text",{x:"3",y:"12","font-size":"11","font-weight":"bold",fill:"currentColor"},"A")],-1)])],8,xv),e("div",{class:Ie(["toolbar-color-picker toolbar-stroke-options",{hidden:!M.value}]),title:"æè¾¹é¢œè‰²"},[e("button",{class:"toolbar-btn toolbar-color-btn",onClick:_e},[N[22]||(N[22]=e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("circle",{cx:"8",cy:"8",r:"5",fill:"none",stroke:"currentColor","stroke-width":"2"})],-1)),e("span",{class:"color-indicator",style:at({background:E.value})},null,4)]),ae(e("input",{ref_key:"strokeColorInput",ref:V,type:"color","onUpdate:modelValue":N[10]||(N[10]=re=>E.value=re),class:"hidden-color-input",onChange:De},null,544),[[we,E.value]])],2),e("div",{class:Ie(["toolbar-stroke-width toolbar-stroke-options",{hidden:!M.value}]),title:"æè¾¹å®½åº¦"},[ae(e("input",{type:"number","onUpdate:modelValue":N[11]||(N[11]=re=>$.value=re),class:"toolbar-mini-input",min:"0",max:"10",onChange:he},null,544),[[we,$.value,void 0,{number:!0}]]),N[23]||(N[23]=e("span",{class:"toolbar-unit"},"px",-1))],2)])]),e("div",_v,[e("div",Cv,[e("button",{class:"toolbar-btn",onClick:J,title:"é€†æ—¶é’ˆæ—‹è½¬"},[...N[27]||(N[27]=[e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("path",{d:"M2 8a6 6 0 1 1 1.5 4",stroke:"currentColor","stroke-width":"1.5",fill:"none"}),e("path",{d:"M2 5v3.5h3.5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),ae(e("input",{type:"number","onUpdate:modelValue":N[12]||(N[12]=re=>j.value=re),class:"toolbar-mini-input toolbar-rotation-input",min:"-180",max:"180",step:"5",onChange:b},null,544),[[we,j.value,void 0,{number:!0}]]),N[29]||(N[29]=e("span",{class:"toolbar-unit"},"Â°",-1)),e("button",{class:"toolbar-btn",onClick:ve,title:"é¡ºæ—¶é’ˆæ—‹è½¬"},[...N[28]||(N[28]=[e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("path",{d:"M14 8a6 6 0 1 0-1.5 4",stroke:"currentColor","stroke-width":"1.5",fill:"none"}),e("path",{d:"M14 5v3.5h-3.5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),e("button",{class:"toolbar-btn toolbar-small-btn",onClick:fe,title:"é‡ç½®æ—‹è½¬"}," 0 ")]),N[35]||(N[35]=e("div",{class:"toolbar-divider vertical"},null,-1)),e("div",Sv,[e("button",{class:"toolbar-btn",onClick:O,title:"å·¦ç§»"},[...N[30]||(N[30]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("path",{d:"M10 3L5 8l5 5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),e("button",{class:"toolbar-btn",onClick:ne,title:"å³ç§»"},[...N[31]||(N[31]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("path",{d:"M6 3l5 5-5 5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),e("button",{class:"toolbar-btn",onClick:be,title:"ä¸Šç§»"},[...N[32]||(N[32]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("path",{d:"M3 10l5-5 5 5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),e("button",{class:"toolbar-btn",onClick:ge,title:"ä¸‹ç§»"},[...N[33]||(N[33]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("path",{d:"M3 6l5 5 5-5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),e("span",kv,[e("span",null,oe(R.value),1),N[34]||(N[34]=me(",",-1)),e("span",null,oe(I.value),1)]),e("button",{class:"toolbar-btn toolbar-small-btn",onClick:Pe,title:"é‡ç½®ä½ç½®"}," âŒ‚ ")])])]),e("details",wv,[N[36]||(N[36]=e("summary",null,"å­—å·é¢„è®¾",-1)),e("div",$v,[(B(!0),A(Oe,null,Ye(H(vs),re=>(B(),A("button",{key:re,class:Ie(["preset-btn",{active:p.value===re}]),onClick:Te=>W(re)},oe(re),11,Tv))),128))])]),e("div",{class:"edit-action-buttons"},[e("button",{class:"btn-apply",onClick:Ee},"åº”ç”¨"),e("button",{class:"btn-apply-all",onClick:Le},"åº”ç”¨å…¨éƒ¨"),e("button",{class:"btn-reset",onClick:ke},"é‡ç½®")])])]))}}),Pv=He(Iv,[["__scopeId","data-v-edcb1ca9"]]),Rv={class:"edit-toolbar-wrapper"},Dv={class:"edit-toolbar toolbar-row-1"},Mv={class:"image-navigator"},Ev=["disabled"],Bv=["disabled"],Av={class:"bubble-navigator"},Lv=["disabled"],Fv={class:"bubble-indicator"},Uv={id:"currentBubbleNum"},Ov={id:"totalBubbleNum"},zv=["disabled"],Nv={class:"view-controls"},Vv={key:0,viewBox:"0 0 20 20",width:"16",height:"16"},Wv={key:1,viewBox:"0 0 20 20",width:"16",height:"16"},Kv={id:"zoomLevel"},qv={class:"edit-toolbar toolbar-row-2"},Hv={class:"annotation-tools"},jv=["disabled"],Jv=["disabled"],Yv={key:0,class:"brush-size-indicator"},Xv={key:1,class:"brush-mode-hint"},Gv={class:"edit-progress-info"},Zv={class:"edit-progress-text"},Qv={class:"edit-progress-count"},ef={class:"edit-progress-bar"},tf={class:"quick-actions"},of=je({__name:"EditToolbar",props:{currentImageIndex:{},imageCount:{},canGoPrevious:{type:Boolean},canGoNext:{type:Boolean},showThumbnails:{type:Boolean},hasBubbles:{type:Boolean},selectedBubbleIndex:{},bubbleCount:{},layoutMode:{},syncEnabled:{type:Boolean},scale:{},isDrawingMode:{type:Boolean},hasSelection:{type:Boolean},brushMode:{},brushSize:{},mouseX:{},mouseY:{},isProcessing:{type:Boolean},progressText:{},progressCurrent:{},progressTotal:{}},emits:["go-previous-image","go-next-image","toggle-thumbnails","select-previous-bubble","select-next-bubble","toggle-layout","toggle-view-mode","toggle-sync","fit-to-screen","zoom-in","zoom-out","reset-zoom","exit-edit-mode","auto-detect-bubbles","detect-all-images","translate-with-bubbles","toggle-drawing-mode","delete-selected-bubbles","repair-selected-bubble","activate-repair-brush","activate-restore-brush","apply-and-next"],setup(n){const t=n,s=Q(()=>t.progressTotal===0?0:Math.round(t.progressCurrent/t.progressTotal*100)),o=Q(()=>t.progressTotal>0&&t.progressCurrent>=t.progressTotal),i=Q(()=>{const r=t.brushMode==="repair"?{fill:"rgba(76, 175, 80, 0.4)",border:"#4CAF50"}:{fill:"rgba(33, 150, 243, 0.4)",border:"#2196F3"};return{position:"fixed",left:`${t.mouseX}px`,top:`${t.mouseY}px`,width:`${t.brushSize}px`,height:`${t.brushSize}px`,borderRadius:"50%",border:`2px solid ${r.border}`,backgroundColor:r.fill,pointerEvents:"none",zIndex:99999,transform:"translate(-50%, -50%)",display:t.brushMode?"block":"none"}});return(r,a)=>(B(),A("div",Rv,[e("div",Dv,[e("div",Mv,[e("button",{class:"nav-btn",disabled:!n.canGoPrevious,onClick:a[0]||(a[0]=u=>r.$emit("go-previous-image")),title:"ä¸Šä¸€å¼ å›¾ç‰‡ (PageUp)"}," â—€â—€ ",8,Ev),e("span",{class:"image-indicator",onClick:a[1]||(a[1]=u=>r.$emit("toggle-thumbnails")),title:"ç‚¹å‡»å±•å¼€ç¼©ç•¥å›¾"},[a[23]||(a[23]=me(" å›¾ ",-1)),e("span",null,oe(n.currentImageIndex+1),1),a[24]||(a[24]=me(" / ",-1)),e("span",null,oe(n.imageCount),1)]),e("button",{class:"nav-btn",disabled:!n.canGoNext,onClick:a[2]||(a[2]=u=>r.$emit("go-next-image")),title:"ä¸‹ä¸€å¼ å›¾ç‰‡ (PageDown)"}," â–¶â–¶ ",8,Bv),e("button",{class:Ie(["thumb-toggle-btn",{active:n.showThumbnails}]),onClick:a[3]||(a[3]=u=>r.$emit("toggle-thumbnails")),title:"æ˜¾ç¤º/éšè—ç¼©ç•¥å›¾"}," â˜· ",2)]),a[30]||(a[30]=e("div",{class:"toolbar-divider"},null,-1)),e("div",Av,[e("button",{id:"prevBubbleBtn",class:"nav-btn",disabled:!n.hasBubbles||n.selectedBubbleIndex<=0,onClick:a[4]||(a[4]=u=>r.$emit("select-previous-bubble")),title:"ä¸Šä¸€ä¸ªæ°”æ³¡ (â†)"}," â—€ ",8,Lv),e("span",Fv,[a[25]||(a[25]=me(" æ°”æ³¡ ",-1)),e("span",Uv,oe(n.selectedBubbleIndex>=0?n.selectedBubbleIndex+1:0),1),a[26]||(a[26]=me(" / ",-1)),e("span",Ov,oe(n.bubbleCount),1)]),e("button",{id:"nextBubbleBtn",class:"nav-btn",disabled:!n.hasBubbles||n.selectedBubbleIndex>=n.bubbleCount-1,onClick:a[5]||(a[5]=u=>r.$emit("select-next-bubble")),title:"ä¸‹ä¸€ä¸ªæ°”æ³¡ (â†’)"}," â–¶ ",8,zv)]),a[31]||(a[31]=e("div",{class:"toolbar-divider"},null,-1)),e("div",Nv,[e("button",{class:"layout-toggle-btn",onClick:a[6]||(a[6]=u=>r.$emit("toggle-layout")),title:"åˆ‡æ¢å¸ƒå±€ï¼šå·¦å³/ä¸Šä¸‹"},[n.layoutMode==="horizontal"?(B(),A("svg",Vv,[...a[27]||(a[27]=[e("rect",{x:"1",y:"2",width:"8",height:"16",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"},null,-1),e("rect",{x:"11",y:"2",width:"8",height:"16",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"},null,-1)])])):(B(),A("svg",Wv,[...a[28]||(a[28]=[e("rect",{x:"2",y:"1",width:"16",height:"8",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"},null,-1),e("rect",{x:"2",y:"11",width:"16",height:"8",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"},null,-1)])]))]),e("button",{class:"view-mode-btn",onClick:a[7]||(a[7]=u=>r.$emit("toggle-view-mode")),title:"åˆ‡æ¢è§†å›¾æ¨¡å¼"},[...a[29]||(a[29]=[e("span",{class:"dual-icon"},"â§‰",-1)])]),e("button",{class:Ie({active:n.syncEnabled}),onClick:a[8]||(a[8]=u=>r.$emit("toggle-sync")),title:"åŒæ­¥ç¼©æ”¾/æ‹–åŠ¨",style:{"font-size":"12px"}}," ğŸ”— ",2),e("button",{onClick:a[9]||(a[9]=u=>r.$emit("fit-to-screen")),title:"é€‚åº”å±å¹• (åŒå‡»)"},"â›¶"),e("button",{onClick:a[10]||(a[10]=u=>r.$emit("zoom-in")),title:"æ”¾å¤§ (+)"},"+"),e("span",Kv,oe(Math.round(n.scale*100))+"%",1),e("button",{onClick:a[11]||(a[11]=u=>r.$emit("zoom-out")),title:"ç¼©å° (-)"},"âˆ’"),e("button",{onClick:a[12]||(a[12]=u=>r.$emit("reset-zoom")),title:"åŸå§‹å¤§å°"},"1:1")]),a[32]||(a[32]=e("div",{class:"toolbar-spacer"},null,-1)),e("button",{class:"secondary-btn",onClick:a[13]||(a[13]=u=>r.$emit("exit-edit-mode"))},"é€€å‡ºç¼–è¾‘")]),e("div",qv,[e("div",Hv,[e("button",{class:"annotation-btn detect-btn",onClick:a[14]||(a[14]=u=>r.$emit("auto-detect-bubbles")),title:"è‡ªåŠ¨æ£€æµ‹å½“å‰å›¾ç‰‡çš„æ–‡æœ¬æ¡†"},[...a[33]||(a[33]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("circle",{cx:"6",cy:"6",r:"4",fill:"none",stroke:"currentColor","stroke-width":"1.5"}),e("path",{d:"M9 9l4 4",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round"})],-1),e("span",null,"æ£€æµ‹",-1)])]),e("button",{class:"annotation-btn detect-btn",onClick:a[15]||(a[15]=u=>r.$emit("detect-all-images")),title:"æ‰¹é‡æ£€æµ‹æ‰€æœ‰å›¾ç‰‡"},[...a[34]||(a[34]=[go('<svg viewBox="0 0 16 16" width="14" height="14" data-v-b7164359><circle cx="5" cy="5" r="2.5" fill="none" stroke="currentColor" stroke-width="1" data-v-b7164359></circle><path d="M7 7l2 2" stroke="currentColor" stroke-width="1" stroke-linecap="round" data-v-b7164359></path><circle cx="10" cy="10" r="2.5" fill="none" stroke="currentColor" stroke-width="1" data-v-b7164359></circle><path d="M12 12l2 2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" data-v-b7164359></path></svg><span data-v-b7164359>æ‰¹é‡æ£€æµ‹</span>',2)])]),e("button",{class:"annotation-btn primary-action-btn",onClick:a[16]||(a[16]=u=>r.$emit("translate-with-bubbles")),title:"ä½¿ç”¨å½“å‰æ–‡æœ¬æ¡†ç¿»è¯‘æ­¤å›¾ç‰‡"},[...a[35]||(a[35]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("path",{d:"M2 3h5M4.5 3v7M2 6h5",stroke:"currentColor","stroke-width":"1.2",fill:"none"}),e("path",{d:"M9 13l2-7 2 7M9.5 11h3",stroke:"currentColor","stroke-width":"1.2",fill:"none"})],-1),e("span",null,"ç¿»è¯‘",-1)])]),a[41]||(a[41]=e("div",{class:"toolbar-divider"},null,-1)),e("button",{class:Ie(["annotation-btn",{active:n.isDrawingMode}]),onClick:a[17]||(a[17]=u=>r.$emit("toggle-drawing-mode")),title:"æ·»åŠ æ°”æ³¡æ¡†ï¼ˆæˆ–ä¸­é”®æ‹–æ‹½ç»˜åˆ¶ï¼‰"},[...a[36]||(a[36]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("rect",{x:"3",y:"3",width:"10",height:"10",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"}),e("path",{d:"M8 5v6M5 8h6",stroke:"currentColor","stroke-width":"1.5"})],-1),e("span",null,"æ·»åŠ ",-1)])],2),e("button",{class:"annotation-btn",disabled:!n.hasSelection,onClick:a[18]||(a[18]=u=>r.$emit("delete-selected-bubbles")),title:"åˆ é™¤é€‰ä¸­æ°”æ³¡æ¡† (Delete)"},[...a[37]||(a[37]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("rect",{x:"3",y:"3",width:"10",height:"10",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"}),e("path",{d:"M5 8h6",stroke:"currentColor","stroke-width":"1.5"})],-1),e("span",null,"åˆ é™¤",-1)])],8,jv),e("button",{class:"annotation-btn",disabled:!n.hasSelection,onClick:a[19]||(a[19]=u=>r.$emit("repair-selected-bubble")),title:"ä¿®å¤é€‰ä¸­æ°”æ³¡èƒŒæ™¯ (R)"},[...a[38]||(a[38]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("path",{d:"M2 14l3-3m0 0l6-6 3 3-6 6m-3 0l-1 1 1-1z",fill:"none",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round"}),e("path",{d:"M11 5l-1-1 2-2 2 2-2 2-1-1z",fill:"currentColor"})],-1),e("span",null,"ä¿®å¤",-1)])],8,Jv),a[42]||(a[42]=e("div",{class:"toolbar-divider"},null,-1)),e("button",{class:Ie(["annotation-btn brush-btn",{active:n.brushMode==="repair"}]),onClick:a[20]||(a[20]=u=>r.$emit("activate-repair-brush")),title:"ä¿®å¤ç¬”åˆ· (æŒ‰ä½R+å·¦é”®æ‹–æ‹½)"},[...a[39]||(a[39]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("circle",{cx:"8",cy:"8",r:"5",fill:"none",stroke:"currentColor","stroke-width":"1.5"}),e("circle",{cx:"8",cy:"8",r:"2",fill:"currentColor"})],-1),e("span",null,"ä¿®å¤ç¬”åˆ·",-1)])],2),e("button",{class:Ie(["annotation-btn brush-btn",{active:n.brushMode==="restore"}]),onClick:a[21]||(a[21]=u=>r.$emit("activate-restore-brush")),title:"è¿˜åŸç¬”åˆ· (æŒ‰ä½U+å·¦é”®æ‹–æ‹½)"},[...a[40]||(a[40]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("circle",{cx:"8",cy:"8",r:"5",fill:"none",stroke:"currentColor","stroke-width":"1.5"}),e("path",{d:"M5 8h6M8 5v6",stroke:"currentColor","stroke-width":"1",transform:"rotate(45 8 8)"})],-1),e("span",null,"è¿˜åŸç¬”åˆ·",-1)])],2),n.brushMode?(B(),A("span",Yv," ç¬”åˆ·: "+oe(n.brushSize)+"px ",1)):de("",!0),a[43]||(a[43]=go('<div class="help-tooltip-container" data-v-b7164359><button class="help-tooltip-btn" title="å¿«æ·é”®æ“ä½œå¸®åŠ©" data-v-b7164359><svg viewBox="0 0 16 16" width="14" height="14" data-v-b7164359><circle cx="8" cy="8" r="6.5" fill="none" stroke="currentColor" stroke-width="1.2" data-v-b7164359></circle><text x="8" y="11" text-anchor="middle" font-size="9" font-weight="bold" fill="currentColor" data-v-b7164359>?</text></svg><span class="help-btn-text" data-v-b7164359>å¿«æ·é”®</span></button><div class="help-tooltip-popup" data-v-b7164359><div class="help-section" data-v-b7164359><div class="help-title" data-v-b7164359>ğŸ–±ï¸ é¼ æ ‡æ“ä½œ</div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>å·¦é”®ç‚¹å‡»æ°”æ³¡</span><span class="help-desc" data-v-b7164359>é€‰æ‹©æ°”æ³¡</span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>Shift+å·¦é”®ç‚¹å‡»</span><span class="help-desc" data-v-b7164359>å¤šé€‰æ°”æ³¡</span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>å·¦é”®æ‹–æ‹½å››è§’/è¾¹</span><span class="help-desc" data-v-b7164359>è°ƒæ•´å¤§å°</span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>å·¦é”®æ‹–æ‹½æ¡†å†…éƒ¨</span><span class="help-desc" data-v-b7164359>ç§»åŠ¨æ°”æ³¡æ¡†</span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>ä¸­é”®æ‹–æ‹½</span><span class="help-desc" data-v-b7164359>ç»˜åˆ¶æ–°æ°”æ³¡æ¡†</span></div></div><div class="help-section" data-v-b7164359><div class="help-title" data-v-b7164359>âŒ¨ï¸ å¿«æ·é”®</div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>A / D</span><span class="help-desc" data-v-b7164359>åˆ‡æ¢ä¸Š/ä¸‹ä¸€å¼ å›¾ç‰‡</span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>Ctrl+Enter</span><span class="help-desc" data-v-b7164359>åº”ç”¨å¹¶è·³è½¬ä¸‹ä¸€å¼ </span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>Delete / Backspace</span><span class="help-desc" data-v-b7164359>åˆ é™¤é€‰ä¸­æ°”æ³¡</span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>æŒ‰ä½R+å·¦é”®æ‹–æ‹½</span><span class="help-desc" data-v-b7164359>ä¿®å¤ç¬”åˆ·</span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>æŒ‰ä½U+å·¦é”®æ‹–æ‹½</span><span class="help-desc" data-v-b7164359>è¿˜åŸç¬”åˆ·</span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>ç¬”åˆ·æ¨¡å¼ä¸‹æ»šè½®</span><span class="help-desc" data-v-b7164359>è°ƒæ•´ç¬”åˆ·å¤§å°</span></div></div></div></div>',1))]),n.brushMode?(B(),A("div",{key:0,class:"brush-cursor",style:at(i.value)},null,4)):de("",!0),n.brushMode?(B(),A("div",Xv,oe(n.brushMode==="repair"?"ä¿®å¤ç¬”åˆ· (R)":"è¿˜åŸç¬”åˆ· (U)")+" - æ»šè½®è°ƒæ•´å¤§å° ",1)):de("",!0),n.isProcessing?(B(),A("div",{key:2,class:Ie(["edit-progress-container",{completed:o.value}])},[e("div",Gv,[e("span",Zv,oe(n.progressText),1),e("span",Qv,oe(n.progressCurrent)+"/"+oe(n.progressTotal),1)]),e("div",ef,[e("div",{class:Ie(["edit-progress-fill",{animating:!o.value}]),style:at({width:s.value+"%"})},null,6)])],2)):de("",!0),a[44]||(a[44]=e("div",{class:"toolbar-spacer"},null,-1)),e("div",tf,[e("button",{class:"primary-btn",onClick:a[22]||(a[22]=u=>r.$emit("apply-and-next")),title:"åº”ç”¨æ›´æ”¹å¹¶è·³è½¬ä¸‹ä¸€å¼  (Ctrl+Enter)"}," åº”ç”¨å¹¶ä¸‹ä¸€å¼  ")])])]))}}),nf=He(of,[["__scopeId","data-v-b7164359"]]),sf={key:0,class:"edit-thumbnails-panel"},af={class:"thumbnails-scroll"},lf=["onClick"],rf=["src","alt"],uf={class:"thumb-index"},cf=je({__name:"EditThumbnailPanel",props:{visible:{type:Boolean},images:{},currentImageIndex:{}},emits:["switch-to-image"],setup(n){return(t,s)=>n.visible?(B(),A("div",sf,[e("div",af,[(B(!0),A(Oe,null,Ye(n.images,(o,i)=>(B(),A("div",{key:o.id,class:Ie(["edit-thumbnail-item",{active:i===n.currentImageIndex}]),onClick:r=>t.$emit("switch-to-image",i)},[e("img",{src:o.translatedDataURL||o.originalDataURL,alt:`å›¾ç‰‡ ${i+1}`},null,8,rf),e("span",uf,oe(i+1),1)],10,lf))),128))])])):de("",!0)}}),df=He(cf,[["__scopeId","data-v-9d2a43d9"]]),gf=["data-brush-mode"],pf={class:"edit-main-layout"},mf={class:"image-comparison-container"},vf={class:"panel-header"},ff=["src"],bf={class:"panel-header"},hf=["src"],yf=je({__name:"EditWorkspace",props:{isEditModeActive:{type:Boolean}},emits:["exit"],setup(n,{emit:t}){const s=n,o=t,i=et(),r=gt(),{translateWithCurrentBubbles:a}=Do(),{reRenderFullImage:u}=fm({onRenderStart:()=>console.log("å¼€å§‹é‡æ–°æ¸²æŸ“..."),onRenderSuccess:ee=>console.log("æ¸²æŸ“æˆåŠŸ:",ee.substring(0,50)+"..."),onRenderError:ee=>console.error("æ¸²æŸ“å¤±è´¥:",ee)}),{isDrawingMode:p,isDrawingBox:k,currentDrawingRect:f,isMiddleButtonDown:P,handleBubbleSelect:L,handleBubbleMultiSelect:M,handleClearMultiSelect:E,handleBubbleDragStart:$,handleBubbleDragging:j,handleBubbleDragEnd:K,handleBubbleResizeStart:U,handleBubbleResizing:g,handleBubbleResizeEnd:d,handleBubbleRotateStart:x,handleBubbleRotating:_,handleBubbleRotateEnd:q,toggleDrawingMode:V,handleDrawBubble:se,getDrawingRectStyle:X,handleBubbleUpdate:ie,deleteSelectedBubbles:z,repairSelectedBubble:R,handleOcrRecognize:I}=vm({onReRender:()=>u(),onDelayedPreview:()=>u()}),F=C(0),y=C(0),{brushMode:m,brushSize:l,mouseX:v,mouseY:D,isBrushKeyDown:S,toggleBrushMode:w,exitBrushMode:W,startBrushPainting:Z,continueBrushPainting:Y,finishBrushPainting:c,adjustBrushSize:h}=pm({onBrushComplete:()=>u(),getCurrentRepairSettings:()=>({inpaintMethod:Ae.value,fillColor:N.value})}),{images:le,currentImageIndex:T,currentImage:G,imageCount:ce,canGoPrevious:_e,canGoNext:De}=kt(i),{bubbles:$e,selectedIndex:he,selectedIndices:te,selectedBubble:b,bubbleCount:J,hasBubbles:ve,hasSelection:fe}=kt(r),O=Q(()=>Pe.value?.querySelector("img")?.naturalWidth||2e3),ne=Q(()=>Pe.value?.querySelector("img")?.naturalHeight||2e3),be=C(null),ge=C(null),Pe=C(null),Ee=C(null),Le=C(null),ke=C(null),Be=C("dual"),ye=C("horizontal"),it=C(!1),Ge=C(!0),Ze=C(!1),st=C(!1),Ae=C("solid"),N=C("#FFFFFF"),re=C(!1),Te=C("å¤„ç†ä¸­..."),Re=C(0),tt=C(0),qe=hn(),Qe=hn(),ht=Q(()=>Qe.scale.value),ot=Q(()=>Qe.translateX.value),On=Q(()=>Qe.translateY.value),zn=Q(()=>qe.scale.value),_t=C(null),Nn=Q(()=>({transform:`translate(${qe.translateX.value}px, ${qe.translateY.value}px) scale(${qe.scale.value})`})),Vn=Q(()=>({transform:`translate(${Qe.translateX.value}px, ${Qe.translateY.value}px) scale(${Qe.scale.value})`}));function Mo(){Qe.zoomIn(),Ge.value&&qe.setTransform(Qe.getTransform())}function Eo(){Qe.zoomOut(),Ge.value&&qe.setTransform(Qe.getTransform())}function Bo(){Qe.resetZoom(),Ge.value&&qe.setTransform(Qe.getTransform())}const Yt=C(!1),Wn=C(0),Xt=C(!1),Mt=C({x:0,y:0,size:0});function Gt(){m.value&&W(),eo()}function Zt(){r.bubbles.length>0&&r.selectBubble(0)}function Ao(){_e.value&&(Gt(),i.goToPrevious())}function Qt(){De.value&&(Gt(),i.goToNext())}function Kn(ee){ee!==T.value&&ee>=0&&ee<ce.value&&(Gt(),i.setCurrentImageIndex(ee))}function eo(){if(!G.value)return;const ee=Array.isArray(G.value.bubbleStates);$e.value.length>0?(i.updateCurrentBubbleStates([...$e.value]),i.setManuallyAnnotated(!0),console.log("å·²ä¿å­˜æ°”æ³¡çŠ¶æ€åˆ°å½“å‰å›¾ç‰‡ï¼Œæ ‡è®°ä¸ºæ‰‹åŠ¨æ ‡æ³¨")):ee&&(i.updateCurrentBubbleStates([]),i.setManuallyAnnotated(!0),console.log("å·²ä¿å­˜ç©ºæ°”æ³¡çŠ¶æ€åˆ°å½“å‰å›¾ç‰‡ï¼ˆç”¨æˆ·ä¸»åŠ¨æ¸…ç©ºï¼Œæ ‡è®°ä¸ºæ‰‹åŠ¨æ ‡æ³¨ï¼‰"))}function Et(){G.value?.bubbleStates?(r.setBubbles([...G.value.bubbleStates],!0),console.log(`å·²åŠ è½½ ${G.value.bubbleStates.length} ä¸ªæ°”æ³¡çŠ¶æ€`)):r.clearBubblesLocal(),Zt()}function qn(){r.selectPrevious()}function Hn(){r.selectNext()}function jn(){it.value=!it.value}function Jn(){ye.value=ye.value==="horizontal"?"vertical":"horizontal";try{localStorage.setItem(an,ye.value)}catch(ee){console.warn("ä¿å­˜å¸ƒå±€æ¨¡å¼å¤±è´¥:",ee)}setTimeout(()=>{Bt()},300)}function Yn(){const ee=["dual","original","translated"],ue=ee.indexOf(Be.value),pe=ee[(ue+1)%ee.length];pe&&(Be.value=pe)}function Xn(){Ge.value=!Ge.value,console.log("åŒå›¾åŒæ­¥:",Ge.value?"å¼€å¯":"å…³é—­"),Ge.value&&qe.setTransform(Qe.getTransform())}function Bt(){const ee=Ee.value||ge.value,ue=Le.value||Pe.value;if(!ee||!ue)return;const pe=ue.querySelector("img");if(!pe||!pe.naturalWidth)return;const Je=ee.getBoundingClientRect(),Ne=Je.width/pe.naturalWidth,Me=Je.height/pe.naturalHeight,Ve=Math.min(Ne,Me)*.95,Fe=(Je.width-pe.naturalWidth*Ve)/2,yt=(Je.height-pe.naturalHeight*Ve)/2,Ct={scale:Ve,translateX:Fe,translateY:yt};Qe.setTransform(Ct),qe.setTransform(Ct)}function Lo(ee,ue){if(m.value){const Fe=ee.deltaY>0?-5:5;h(Fe);return}const pe=ee.currentTarget.getBoundingClientRect(),Je=ee.clientX-pe.left,Ne=ee.clientY-pe.top,Me=ee.deltaY>0?.9:1.1,Ve=ue==="original"?qe:Qe;Ve.zoomAt(Je,Ne,Me),Ge.value&&(ue==="original"?Qe:qe).setTransform(Ve.getTransform())}function Fo(ee,ue){if(m.value){const pe=ue==="original"?ge.value:Ee.value;pe&&Z(ee,pe);return}if(ee.button===1){P.value=!0,zo(ee,ue),ee.preventDefault();return}if(p.value&&ee.button===0){zo(ee,ue),ee.preventDefault();return}if(ee.button===0){if(ee.target.closest(".bubble-highlight-box"))return;ee.shiftKey||E(),_t.value=ue,(ue==="original"?qe:Qe).startDrag(ee.clientX,ee.clientY),document.addEventListener("mousemove",Uo),document.addEventListener("mouseup",Oo),ee.preventDefault()}}function Uo(ee){if(!_t.value)return;const ue=_t.value==="original"?qe:Qe;ue.drag(ee.clientX,ee.clientY),Ge.value&&(_t.value==="original"?Qe:qe).setTransform(ue.getTransform())}function Oo(){_t.value&&(_t.value==="original"?qe:Qe).endDrag(),_t.value=null,document.removeEventListener("mousemove",Uo),document.removeEventListener("mouseup",Oo)}let to="translated";function zo(ee,ue="translated"){to=ue;const pe=ue==="original"?Pe.value:Le.value,Je=ue==="original"?qe:Qe;if(!pe)return;const Ne=pe.getBoundingClientRect(),Me=(ee.clientX-Ne.left)/Je.scale.value,Ve=(ee.clientY-Ne.top)/Je.scale.value;F.value=Me,y.value=Ve,k.value=!0,f.value=[Me,Ve,Me,Ve],document.addEventListener("mousemove",oo),document.addEventListener("mouseup",no)}function oo(ee){if(!k.value)return;const ue=to==="original"?Pe.value:Le.value,pe=to==="original"?qe:Qe;if(!ue)return;const Je=ue.getBoundingClientRect(),Ne=(ee.clientX-Je.left)/pe.scale.value,Me=(ee.clientY-Je.top)/pe.scale.value;f.value=[Math.min(F.value,Ne),Math.min(y.value,Me),Math.max(F.value,Ne),Math.max(y.value,Me)]}function no(ee){document.removeEventListener("mousemove",oo),document.removeEventListener("mouseup",no);const ue=P.value;if(!k.value||!f.value){k.value=!1,f.value=null,P.value=!1;return}const[pe,Je,Ne,Me]=f.value,Ve=Ne-pe,Fe=Me-Je;Ve>10&&Fe>10&&(r.addBubble(f.value),r.selectBubble(r.bubbleCount-1),console.log("å·²æ·»åŠ æ–°æ°”æ³¡:",f.value)),k.value=!1,f.value=null,P.value=!1,!ue&&p.value&&(p.value=!1)}function No(ee){console.log(`${ee} å›¾ç‰‡åŠ è½½å®Œæˆ`),ht.value===1&&ot.value===0&&On.value===0&&pt(()=>{Bt()})}function Gn(){u()}function Zn(ee){ee.inpaintMethod!==void 0&&(Ae.value=ee.inpaintMethod),ee.fillColor!==void 0&&(N.value=ee.fillColor),he.value>=0&&ie(ee)}function Qn(ee){xe("æ–‡æœ¬å·²åº”ç”¨","success"),u()}function es(ee){const ue=r.initialStates[ee];if(!ue){console.warn(`æ— æ³•é‡ç½®æ°”æ³¡ #${ee+1}ï¼šæ‰¾ä¸åˆ°åˆå§‹çŠ¶æ€`),xe("æ— æ³•é‡ç½®ï¼šæ‰¾ä¸åˆ°åˆå§‹çŠ¶æ€","warning");return}const pe=JSON.parse(JSON.stringify(ue));r.updateBubble(ee,pe),console.log(`æ°”æ³¡ #${ee+1} å·²é‡ç½®åˆ°åˆå§‹çŠ¶æ€`),xe("æ°”æ³¡å·²é‡ç½®","success"),u()}async function ts(ee){const ue=$e.value[ee];if(!ue?.originalText){console.warn("æ— æ³•é‡æ–°ç¿»è¯‘ï¼šç¼ºå°‘æ°”æ³¡æˆ–åŸæ–‡");return}try{console.log(`å¼€å§‹é‡æ–°ç¿»è¯‘æ°”æ³¡ #${ee+1}`);const{translateSingleText:pe}=await rt(async()=>{const{translateSingleText:Ve}=await Promise.resolve().then(()=>Fs);return{translateSingleText:Ve}},void 0),{useSettingsStore:Je}=await rt(async()=>{const{useSettingsStore:Ve}=await import("./system.DqO7MVCQ.js").then(Fe=>Fe.s);return{useSettingsStore:Ve}},__vite__mapDeps([0,1,2,3,4,5])),Ne=Je().settings,Me=await pe({original_text:ue.originalText,model_provider:Ne.translation.provider,api_key:Ne.translation.apiKey,model_name:Ne.translation.modelName,custom_base_url:Ne.translation.customBaseUrl,target_language:Ne.targetLanguage,prompt_content:void 0});Me.success&&Me.data?.translated_text?(r.updateBubble(ee,{translatedText:Me.data.translated_text}),console.log(`ç¿»è¯‘æˆåŠŸ: "${Me.data.translated_text}"`),u()):console.error("ç¿»è¯‘å¤±è´¥:",Me.error||"æœªçŸ¥é”™è¯¯")}catch(pe){console.error("ç¿»è¯‘å‡ºé”™:",pe)}}function Vo(ee,ue){for(ee.bubbleTexts||(ee.bubbleTexts=[]),ee.originalTexts||(ee.originalTexts=[]);ee.bubbleTexts.length<ue;)ee.bubbleTexts.push("");for(;ee.originalTexts.length<ue;)ee.originalTexts.push("")}function Wo(ee,ue,pe){const Je=ee.auto_directions||[];return ee.bubble_coords.map((Ne,Me)=>{const Ve=Ne[0]??0,Fe=Ne[1]??0,yt=Ne[2]??0,Ct=Ne[3]??0;let mt;return Je[Me]?mt=Je[Me]==="v"?"vertical":"horizontal":mt=Ct-Fe>yt-Ve?"vertical":"horizontal",{coords:Ne,originalText:ue.originalTexts?.[Me]||"",translatedText:ue.bubbleTexts?.[Me]||"",textboxText:"",fontSize:pe.fontSize,fontFamily:pe.fontFamily,textDirection:mt,autoTextDirection:mt,textColor:pe.textColor,fillColor:pe.fillColor,strokeEnabled:pe.strokeEnabled,strokeColor:pe.strokeColor,strokeWidth:pe.strokeWidth,rotationAngle:ee.bubble_angles?.[Me]||0,inpaintMethod:pe.inpaintMethod,position:{x:0,y:0},polygon:[]}})}async function os(){const ee=G.value;if(!ee?.originalDataURL){xe("æ²¡æœ‰æœ‰æ•ˆçš„å›¾ç‰‡ç”¨äºæ£€æµ‹","warning");return}try{xe("æ­£åœ¨è‡ªåŠ¨æ£€æµ‹æ–‡æœ¬æ¡†...","info");const pe=ee.originalDataURL.match(/^data:image\/[^;]+;base64,(.+)$/)?.[1]||"";if(!pe){xe("æ— æ³•è§£æå›¾ç‰‡æ•°æ®","error");return}const Je=ze(),{textDetector:Ne,boxExpand:Me,textStyle:Ve}=Je.settings,Fe=await po(pe,Ne,{box_expand_ratio:Me.ratio,box_expand_top:Me.top,box_expand_bottom:Me.bottom,box_expand_left:Me.left,box_expand_right:Me.right});if(Fe.success&&Fe.bubble_coords){i.updateCurrentImage({bubbleCoords:Fe.bubble_coords,bubbleAngles:Fe.bubble_angles||[]}),Vo(ee,Fe.bubble_coords.length);const yt={bubble_coords:Fe.bubble_coords.map(mt=>[...mt]),bubble_angles:Fe.bubble_angles,auto_directions:Fe.auto_directions},Ct=Wo(yt,ee,Ve);r.setBubbles(Ct),Zt(),xe(`è‡ªåŠ¨æ£€æµ‹åˆ° ${Fe.bubble_coords.length} ä¸ªæ–‡æœ¬æ¡†`,"success")}else xe(Fe.error||"æ£€æµ‹å¤±è´¥","error")}catch(ue){console.error("è‡ªåŠ¨æ£€æµ‹å¤±è´¥:",ue),xe("è‡ªåŠ¨æ£€æµ‹å¤±è´¥","error")}}async function ns(){if(le.value.length<=1){xe("è‡³å°‘éœ€è¦ä¸¤å¼ å›¾ç‰‡æ‰èƒ½æ‰§è¡Œæ‰¹é‡æ£€æµ‹","warning");return}if(!confirm("æ­¤æ“ä½œå°†å¯¹æ‰€æœ‰å›¾ç‰‡è¿›è¡Œæ–‡æœ¬æ¡†æ£€æµ‹ï¼Œå¯èƒ½ä¼šè¦†ç›–å·²æœ‰çš„æ£€æµ‹ç»“æœã€‚ç¡®å®šç»§ç»­å—ï¼Ÿ"))return;const ee=ze(),{textDetector:ue,boxExpand:pe,textStyle:Je}=ee.settings,Ne=T.value,Me=le.value.length;re.value=!0,Te.value="æ‰¹é‡æ£€æµ‹ä¸­",tt.value=Me,Re.value=0;try{let Ve=0;for(let Fe=0;Fe<Me;Fe++){const yt=le.value[Fe];if(!yt?.originalDataURL)continue;Re.value=Fe+1;const mt=yt.originalDataURL.match(/^data:image\/[^;]+;base64,(.+)$/)?.[1]||"";if(!mt)continue;const vt=await po(mt,ue,{box_expand_ratio:pe.ratio,box_expand_top:pe.top,box_expand_bottom:pe.bottom,box_expand_left:pe.left,box_expand_right:pe.right});if(vt.success&&vt.bubble_coords){const wt=le.value[Fe];if(wt){wt.bubbleCoords=vt.bubble_coords,wt.bubbleAngles=vt.bubble_angles||[],Vo(wt,vt.bubble_coords.length);const us={bubble_coords:vt.bubble_coords.map(cs=>[...cs]),bubble_angles:vt.bubble_angles,auto_directions:vt.auto_directions};wt.bubbleStates=Wo(us,wt,Je),Ve+=vt.bubble_coords.length,Fe===T.value&&Et()}}}Te.value="æ£€æµ‹å®Œæˆ",Re.value=Me,Ne!==T.value&&i.setCurrentImageIndex(Ne),Et(),xe(`æ‰¹é‡æ£€æµ‹å®Œæˆï¼å…±å¤„ç† ${Me} å¼ å›¾ç‰‡ï¼Œæ£€æµ‹åˆ° ${Ve} ä¸ªæ–‡æœ¬æ¡†`,"success"),setTimeout(()=>{re.value=!1},2e3)}catch(Ve){console.error("æ‰¹é‡æ£€æµ‹å¤±è´¥:",Ve),xe("æ‰¹é‡æ£€æµ‹å¤±è´¥","error"),re.value=!1}}async function ss(){if(!G.value?.originalDataURL){xe("æ²¡æœ‰æœ‰æ•ˆçš„å›¾ç‰‡ç”¨äºç¿»è¯‘","warning");return}if($e.value.length===0){xe("æ²¡æœ‰æ–‡æœ¬æ¡†å¯ç”¨äºç¿»è¯‘ï¼Œè¯·å…ˆæ£€æµ‹æˆ–æ·»åŠ æ–‡æœ¬æ¡†","warning");return}xe("æ­£åœ¨ä½¿ç”¨å½“å‰æ–‡æœ¬æ¡†ç¿»è¯‘...","info");try{await a()&&(xe("ç¿»è¯‘æˆåŠŸï¼","success"),Zt())}catch(ue){console.error("ç¿»è¯‘å¤±è´¥:",ue),xe(`ç¿»è¯‘å¤±è´¥: ${ue instanceof Error?ue.message:"æœªçŸ¥é”™è¯¯"}`,"error")}}function as(){w("repair")}function ls(){w("restore")}function Ko(ee){Y(ee)}function qo(){c()}function is(ee){Yt.value=!0,Wn.value=ye.value==="horizontal"?ee.clientX:ee.clientY,document.body.style.cursor=ye.value==="horizontal"?"col-resize":"row-resize",document.body.style.userSelect="none",document.addEventListener("mousemove",so),document.addEventListener("mouseup",ao),ee.preventDefault()}function so(ee){if(!Yt.value)return;const ue=ge.value?.parentElement?.parentElement;if(!ue)return;const pe=ue.getBoundingClientRect();if(ye.value==="horizontal"){const Je=ee.clientX-pe.left,Ne=pe.width,Me=Math.max(20,Math.min(80,Je/Ne*100)),Ve=ue.querySelector(".original-panel"),Fe=ue.querySelector(".translated-panel");Ve&&Fe&&(Ve.style.flex=`0 0 ${Me}%`,Fe.style.flex=`0 0 ${100-Me}%`)}else{const Je=ee.clientY-pe.top,Ne=pe.height,Me=Math.max(20,Math.min(80,Je/Ne*100)),Ve=ue.querySelector(".original-panel"),Fe=ue.querySelector(".translated-panel");Ve&&Fe&&(Ve.style.flex=`0 0 ${Me}%`,Fe.style.flex=`0 0 ${100-Me}%`)}}function ao(){Yt.value=!1,document.body.style.cursor="",document.body.style.userSelect="",document.removeEventListener("mousemove",so),document.removeEventListener("mouseup",ao)}function rs(ee){Xt.value=!0;const ue=ke.value;ue&&(Mt.value={x:ee.clientX,y:ee.clientY,size:ye.value==="horizontal"?ue.offsetWidth:ue.offsetHeight},document.body.style.cursor=ye.value==="horizontal"?"ew-resize":"ns-resize",document.body.style.userSelect="none",document.addEventListener("mousemove",lo),document.addEventListener("mouseup",io),ee.preventDefault())}function lo(ee){if(!(!Xt.value||!ke.value))if(ye.value==="horizontal"){const ue=Mt.value.x-ee.clientX;let pe=Mt.value.size+ue;pe=Math.max(300,Math.min(window.innerWidth*.6,pe)),ke.value.style.flex=`0 0 ${pe}px`,ke.value.style.minWidth=`${pe}px`}else{const ue=Mt.value.y-ee.clientY;let pe=Mt.value.size+ue;pe=Math.max(200,Math.min(window.innerHeight*.5,pe)),ke.value.style.flex=`0 0 ${pe}px`,ke.value.style.height=`${pe}px`}}function io(){Xt.value=!1,document.body.style.cursor="",document.body.style.userSelect="",document.removeEventListener("mousemove",lo),document.removeEventListener("mouseup",io)}function Ho(ee){const ue=ee.target,pe=ee.key.toLowerCase();if(pe==="r"||pe==="u"||pe==="a"||pe==="d"){if(ue.tagName==="TEXTAREA")return;(ue.tagName==="INPUT"||ue.tagName==="SELECT"||ue.tagName==="BUTTON")&&ue.blur()}else if(ue.tagName==="INPUT"||ue.tagName==="TEXTAREA"||ue.tagName==="SELECT")return;switch(ee.key){case"Escape":Yo();break;case"Delete":case"Backspace":!m.value&&fe.value&&(z(),ee.preventDefault());break;case"a":case"A":m.value||(Ao(),ee.preventDefault());break;case"d":case"D":m.value||(Qt(),ee.preventDefault());break;case"Enter":ee.ctrlKey&&!m.value&&(Jo(),ee.preventDefault());break;case"r":case"R":S.value||(w("repair"),ee.preventDefault());break;case"u":case"U":S.value||(w("restore"),ee.preventDefault());break;case"+":case"=":Mo(),ee.preventDefault();break;case"-":Eo(),ee.preventDefault();break;case"0":Bo(),ee.preventDefault();break}}function jo(ee){(ee.key==="r"||ee.key==="R"||ee.key==="u"||ee.key==="U")&&(W(),ee.preventDefault())}async function Jo(){eo(),await u(),De.value?Qt():xe("å·²æ˜¯æœ€åä¸€å¼ å›¾ç‰‡","info")}function Yo(){eo(),o("exit")}return dt(()=>{try{const ee=localStorage.getItem(an);(ee==="horizontal"||ee==="vertical")&&(ye.value=ee)}catch(ee){console.warn("åŠ è½½å¸ƒå±€æ¨¡å¼å¤±è´¥:",ee)}document.addEventListener("keydown",Ho),document.addEventListener("keyup",jo),document.addEventListener("mousemove",Ko),document.addEventListener("mouseup",qo),s.isEditModeActive&&(Et(),pt(()=>{be.value?.focus()}))}),Ot(()=>{document.removeEventListener("keydown",Ho),document.removeEventListener("keyup",jo),document.removeEventListener("mousemove",Ko),document.removeEventListener("mouseup",qo),document.removeEventListener("mousemove",oo),document.removeEventListener("mouseup",no),document.removeEventListener("mousemove",so),document.removeEventListener("mouseup",ao),document.removeEventListener("mousemove",lo),document.removeEventListener("mouseup",io)}),Ce(()=>s.isEditModeActive,ee=>{ee&&(Et(),pt(()=>{be.value?.focus()}))}),Ce(T,()=>{s.isEditModeActive&&Et()}),Ce(b,ee=>{ee&&(Ae.value=ee.inpaintMethod||"solid",N.value=ee.fillColor||"#FFFFFF")},{immediate:!0}),(ee,ue)=>n.isEditModeActive?(B(),A("div",{key:0,class:Ie(["edit-workspace",[`layout-${ye.value}`,{"drawing-mode":H(p)},{"brush-mode-active":!!H(m)}]]),"data-brush-mode":H(m)||void 0,tabindex:"0",ref_key:"workspaceRef",ref:be},[Se(nf,{"current-image-index":H(T),"image-count":H(ce),"can-go-previous":H(_e),"can-go-next":H(De),"show-thumbnails":it.value,"has-bubbles":H(ve),"selected-bubble-index":H(he),"bubble-count":H(J),"layout-mode":ye.value,"sync-enabled":Ge.value,scale:ht.value,"is-drawing-mode":H(p),"has-selection":H(fe),"brush-mode":H(m),"brush-size":H(l),"mouse-x":H(v),"mouse-y":H(D),"is-processing":re.value,"progress-text":Te.value,"progress-current":Re.value,"progress-total":tt.value,onGoPreviousImage:Ao,onGoNextImage:Qt,onToggleThumbnails:jn,onSelectPreviousBubble:qn,onSelectNextBubble:Hn,onToggleLayout:Jn,onToggleViewMode:Yn,onToggleSync:Xn,onFitToScreen:Bt,onZoomIn:Mo,onZoomOut:Eo,onResetZoom:Bo,onExitEditMode:Yo,onAutoDetectBubbles:os,onDetectAllImages:ns,onTranslateWithBubbles:ss,onToggleDrawingMode:H(V),onDeleteSelectedBubbles:H(z),onRepairSelectedBubble:H(R),onActivateRepairBrush:as,onActivateRestoreBrush:ls,onApplyAndNext:Jo},null,8,["current-image-index","image-count","can-go-previous","can-go-next","show-thumbnails","has-bubbles","selected-bubble-index","bubble-count","layout-mode","sync-enabled","scale","is-drawing-mode","has-selection","brush-mode","brush-size","mouse-x","mouse-y","is-processing","progress-text","progress-current","progress-total","onToggleDrawingMode","onDeleteSelectedBubbles","onRepairSelectedBubble"]),Se(df,{visible:it.value,images:H(le),"current-image-index":H(T),onSwitchToImage:Kn},null,8,["visible","images","current-image-index"]),e("div",pf,[e("div",mf,[ae(e("div",{class:Ie(["image-panel original-panel",{collapsed:Be.value==="translated"||Ze.value}])},[e("div",vf,[ue[8]||(ue[8]=e("span",{class:"panel-title"},"ğŸ“– åŸå›¾ (æ—¥æ–‡)",-1)),e("button",{class:"panel-toggle",onClick:ue[0]||(ue[0]=pe=>Ze.value=!Ze.value),title:"æŠ˜å /å±•å¼€"},oe(Ze.value?"+":"âˆ’"),1)]),e("div",{ref_key:"originalViewportRef",ref:ge,class:"image-viewport",onWheel:ue[2]||(ue[2]=lt(pe=>Lo(pe,"original"),["prevent"])),onMousedown:ue[3]||(ue[3]=pe=>Fo(pe,"original")),onDblclick:Bt},[e("div",{ref_key:"originalWrapperRef",ref:Pe,class:"image-canvas-wrapper",style:at(Nn.value)},[H(G)?.originalDataURL?(B(),A("img",{key:0,src:H(G).originalDataURL,alt:"åŸå›¾",onLoad:ue[1]||(ue[1]=pe=>No("original"))},null,40,ff)):de("",!0),H(G)?.originalDataURL?(B(),ut(yn,{key:1,bubbles:H($e),"selected-index":H(he),"selected-indices":H(te),scale:zn.value,"is-drawing-mode":H(p),"is-brush-mode":!!H(m),"image-width":O.value,"image-height":ne.value,onSelect:H(L),onMultiSelect:H(M),onDragStart:H($),onDragging:H(j),onDragEnd:H(K),onResizeStart:H(U),onResizing:H(g),onResizeEnd:H(d),onRotateStart:H(x),onRotating:H(_),onRotateEnd:H(q),onDrawBubble:H(se)},null,8,["bubbles","selected-index","selected-indices","scale","is-drawing-mode","is-brush-mode","image-width","image-height","onSelect","onMultiSelect","onDragStart","onDragging","onDragEnd","onResizeStart","onResizing","onResizeEnd","onRotateStart","onRotating","onRotateEnd","onDrawBubble"])):de("",!0),H(f)?(B(),A("div",{key:2,class:"drawing-rect-edit",style:at(H(X)())},null,4)):de("",!0)],4)],544)],2),[[Ue,Be.value!=="translated"]]),Be.value==="dual"?(B(),A("div",{key:0,class:Ie(["panel-divider",{"vertical-divider":ye.value==="vertical"}]),onMousedown:is},null,34)):de("",!0),ae(e("div",{class:Ie(["image-panel translated-panel",{collapsed:Be.value==="original"||st.value}])},[e("div",bf,[ue[9]||(ue[9]=e("span",{class:"panel-title"},"ğŸ“ ç¿»è¯‘å›¾ (ä¸­æ–‡)",-1)),e("button",{class:"panel-toggle",onClick:ue[4]||(ue[4]=pe=>st.value=!st.value),title:"æŠ˜å /å±•å¼€"},oe(st.value?"+":"âˆ’"),1)]),e("div",{ref_key:"translatedViewportRef",ref:Ee,class:"image-viewport",onWheel:ue[6]||(ue[6]=lt(pe=>Lo(pe,"translated"),["prevent"])),onMousedown:ue[7]||(ue[7]=pe=>Fo(pe,"translated")),onDblclick:Bt},[e("div",{ref_key:"translatedWrapperRef",ref:Le,class:"image-canvas-wrapper",style:at(Vn.value)},[H(G)?.translatedDataURL||H(G)?.originalDataURL?(B(),A("img",{key:0,src:H(G)?.translatedDataURL||H(G)?.originalDataURL,alt:"ç¿»è¯‘å›¾",onLoad:ue[5]||(ue[5]=pe=>No("translated"))},null,40,hf)):de("",!0),H(G)?.translatedDataURL||H(G)?.originalDataURL?(B(),ut(yn,{key:1,bubbles:H($e),"selected-index":H(he),"selected-indices":H(te),scale:ht.value,"is-drawing-mode":H(p),"is-brush-mode":!!H(m),"image-width":O.value,"image-height":ne.value,onSelect:H(L),onMultiSelect:H(M),onDragStart:H($),onDragging:H(j),onDragEnd:H(K),onResizeStart:H(U),onResizing:H(g),onResizeEnd:H(d),onRotateStart:H(x),onRotating:H(_),onRotateEnd:H(q),onDrawBubble:H(se)},null,8,["bubbles","selected-index","selected-indices","scale","is-drawing-mode","is-brush-mode","image-width","image-height","onSelect","onMultiSelect","onDragStart","onDragging","onDragEnd","onResizeStart","onResizing","onResizeEnd","onRotateStart","onRotating","onRotateEnd","onDrawBubble"])):de("",!0),H(f)?(B(),A("div",{key:2,class:"drawing-rect-edit translated-drawing-rect",style:at(H(X)())},null,4)):de("",!0)],4)],544)],2),[[Ue,Be.value!=="original"]])]),e("div",{ref_key:"editPanelRef",ref:ke,class:"edit-panel-container"},[e("div",{class:"panel-resize-handle vertical",onMousedown:rs}," â‹®â‹®â‹® ",32),Se(Pv,{bubble:H(b),"bubble-index":H(he),onUpdate:Zn,onReRender:Gn,onOcrRecognize:H(I),onReTranslate:ts,onApplyBubble:Qn,onResetCurrent:es},null,8,["bubble","bubble-index","onOcrRecognize"])],512)])],10,gf)):de("",!0)}}),xf=He(yf,[["__scopeId","data-v-7cf83f19"]]),Dt="/api/web-import";async function _f(n){return(await fetch(`${Dt}/check-support?url=${encodeURIComponent(n)}`)).json()}async function Cf(){return(await fetch(`${Dt}/gallery-dl-images`)).json()}async function Sf(n,t,s,o,i,r="auto",a){const u=await fetch(`${Dt}/extract`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:n,config:t,engine:r})});if(!u.ok){const P=await u.json().catch(()=>({error:"è¯·æ±‚å¤±è´¥"}));i(P.error||`HTTP ${u.status}`);return}const p=u.body?.getReader();if(!p){i("æ— æ³•è¯»å–å“åº”æµ");return}const k=new TextDecoder;let f="";try{for(;;){const{done:P,value:L}=await p.read();if(P)break;f+=k.decode(L,{stream:!0});const M=f.split(`
`);f=M.pop()||"";let E="",$="";for(const j of M)if(j.startsWith("event:"))E=j.slice(6).trim();else if(j.startsWith("data:"))$=j.slice(5).trim();else if(j===""&&E&&$){try{const K=JSON.parse($);E==="log"?s(K):E==="page"?a&&a(K):E==="result"?o(K):E==="error"&&i(K.error||"æœªçŸ¥é”™è¯¯")}catch(K){console.error("è§£æ SSE æ•°æ®å¤±è´¥:",K)}E="",$=""}}}finally{p.releaseLock()}}async function kf(n,t,s,o="ai-agent"){const i=await fetch(`${Dt}/download`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({pages:n,sourceUrl:t,config:s,engine:o})});if(!i.ok){const r=await i.json().catch(()=>({error:"è¯·æ±‚å¤±è´¥"}));throw new Error(r.error||`HTTP ${i.status}`)}return i.json()}async function wf(n){return(await fetch(`${Dt}/test-firecrawl`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({apiKey:n})})).json()}async function $f(n,t,s,o){return(await fetch(`${Dt}/test-agent`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({provider:n,apiKey:t,customBaseUrl:s,modelName:o})})).json()}const Tf={class:"modal-container"},If={class:"modal-body"},Pf={class:"url-section"},Rf=["disabled"],Df=["disabled"],Mf=["disabled"],Ef={key:0,class:"loading-spinner"},Bf={key:1},Af={key:0,class:"engine-hint"},Lf={key:0,class:"hint-checking"},Ff={key:1,class:"hint-supported"},Uf={key:2,class:"hint-unsupported"},Of={class:"settings-section"},zf={class:"settings-toggle"},Nf={key:0,class:"settings-content"},Vf={class:"settings-tabs"},Wf={class:"settings-tab-content"},Kf={class:"settings-group"},qf={class:"form-row"},Hf={class:"input-group"},jf=["type","value"],Jf=["disabled"],Yf={class:"settings-group"},Xf={class:"form-row"},Gf=["value"],Zf=["value"],Qf={class:"form-row"},eb={class:"input-group"},tb=["type","value"],ob={key:0,class:"form-row"},nb=["value"],sb={class:"form-row"},ab=["value"],lb={class:"form-row inline"},ib={class:"checkbox-label"},rb=["checked"],ub={class:"checkbox-label"},cb=["checked"],db={class:"form-row"},gb=["disabled"],pb={class:"settings-group"},mb={class:"form-row"},vb=["value"],fb={class:"form-row"},bb=["value"],hb={class:"settings-group"},yb={class:"form-grid"},xb={class:"form-row"},_b=["value"],Cb={class:"form-row"},Sb=["value"],kb={class:"form-row"},wb=["value"],$b={class:"form-row"},Tb=["value"],Ib={class:"form-row"},Pb={class:"checkbox-label"},Rb=["checked"],Db={class:"settings-group"},Mb={class:"form-row inline"},Eb={class:"checkbox-label"},Bb=["checked"],Ab={class:"checkbox-label"},Lb=["checked"],Fb={class:"settings-tab-content"},Ub={class:"settings-group"},Ob={class:"form-row"},zb={class:"checkbox-label"},Nb=["checked"],Vb={class:"form-row"},Wb={class:"checkbox-label"},Kb=["checked"],qb={class:"form-row"},Hb={class:"checkbox-label"},jb=["checked"],Jb={key:0,class:"form-grid"},Yb={class:"form-row"},Xb=["value"],Gb={class:"form-row"},Zb=["value"],Qb={class:"form-row"},eh=["value"],th={class:"form-row"},oh={class:"checkbox-label"},nh=["checked"],sh={key:1,class:"form-row"},ah=["value"],lh={class:"settings-tab-content"},ih={class:"settings-group"},rh={class:"form-row"},uh=["value"],ch={class:"form-row"},dh=["value"],gh={class:"form-row"},ph={class:"checkbox-label"},mh=["checked"],vh={key:1,class:"logs-section"},fh={class:"logs-toggle"},bh={key:0,class:"extracting-hint"},hh={key:0,class:"logs-content"},yh={class:"log-time"},xh={class:"log-message"},_h={key:2,class:"error-section"},Ch={class:"error-message"},Sh={key:3,class:"result-section"},kh={class:"result-header"},wh={class:"result-title"},$h={class:"result-meta"},Th={class:"result-count"},Ih={key:0,class:"result-engine"},Ph={class:"select-control"},Rh={class:"select-all"},Dh=["checked"],Mh={class:"selected-count"},Eh={class:"image-grid"},Bh=["onClick"],Ah={class:"image-checkbox"},Lh=["checked","onChange"],Fh={class:"image-preview"},Uh=["src","alt"],Oh={class:"image-label"},zh={key:4,class:"progress-section"},Nh={class:"progress-label"},Vh={class:"progress-bar"},Wh={class:"modal-footer"},Kh=["disabled"],qh=["disabled"],Hh={key:0,class:"loading-spinner"},jh={key:1},Jh=je({__name:"WebImportModal",setup(n){const t=_o(),s=et(),o=C(""),i=C(!0),r=C("auto"),a=C(!1),u=C(!1),p=C(!1),k=C(!1),f=C("basic"),P=C(!1),L=C(!1),M=C(!1),E=C(!1),$=Q(()=>t.modalVisible),j=Q(()=>t.status),K=Q(()=>t.logs),U=Q(()=>t.extractResult),g=Q(()=>t.selectedPages),d=Q(()=>t.selectedCount),x=Q(()=>t.downloadProgress),_=Q(()=>t.downloadProgressPercent),q=Q(()=>t.error),V=Q(()=>t.isProcessing),se=Q(()=>t.settings.ui.showAgentLogs),X=Q(()=>U.value?.engine||null),ie=Q(()=>{switch(X.value){case"gallery-dl":return"Gallery-DL";case"ai-agent":return"AI Agent";default:return""}}),z=Q(()=>U.value?.pages?d.value===U.value.pages.length:!1);function R(Y){return X.value==="gallery-dl",Y}let I=null;async function F(Y){if(I&&clearTimeout(I),!Y.trim()){a.value=!1,u.value=!1;return}I=setTimeout(async()=>{p.value=!0;try{const c=await _f(Y);a.value=c.available,u.value=c.supported}catch{a.value=!1,u.value=!1}finally{p.value=!1}},500)}function y(){V.value&&!confirm("æ­£åœ¨å¤„ç†ä¸­ï¼Œç¡®å®šè¦å…³é—­å—ï¼Ÿ")||(t.closeModal(),t.resetState(),o.value="")}async function m(){const Y=o.value.trim();if(!Y){alert("è¯·è¾“å…¥ç½‘å€");return}try{new URL(Y)}catch{alert("è¯·è¾“å…¥æœ‰æ•ˆçš„ç½‘å€");return}t.resetState(),t.setUrl(Y),t.setStatus("extracting");try{await Sf(Y,t.settings,c=>{t.addLog(c)},c=>{t.setExtractResult(c),c.success?t.setStatus("extracted"):t.setError(c.error||"æå–å¤±è´¥")},c=>{t.setError(c)},r.value,c=>{t.addPageIncremental(c)})}catch(c){t.setError(c instanceof Error?c.message:"æå–å¤±è´¥")}}function l(Y){t.togglePageSelection(Y)}function v(){t.toggleSelectAll()}async function D(){if(!U.value?.pages||d.value===0){alert("è¯·é€‰æ‹©è¦å¯¼å…¥çš„å›¾ç‰‡");return}const Y=U.value.pages.filter(h=>g.value.has(h.pageNumber));t.setStatus("downloading"),t.updateDownloadProgress(0,Y.length);const c=X.value||"ai-agent";try{if(c==="gallery-dl"){const le=await Cf();if(le.success&&le.images.length>0){let T=0;const G=Math.min(le.images.length,Y.length);for(let ce=0;ce<G;ce++){const _e=le.images[ce];_e&&_e.filename&&_e.data&&(s.addImage(_e.filename,_e.data),T++,t.updateDownloadProgress(T,G))}t.setStatus("completed"),alert(`æˆåŠŸå¯¼å…¥ ${T} å¼ å›¾ç‰‡`),y();return}else throw new Error(le.error||"è·å–å›¾ç‰‡å¤±è´¥")}const h=await kf(Y,U.value.sourceUrl,t.settings,c);if(h.success&&h.images.length>0){t.setDownloadedImages(h.images),t.updateDownloadProgress(h.images.length,Y.length);for(const T of h.images)s.addImage(T.filename,T.dataUrl);t.setStatus("completed");const le=h.failedCount>0?`ï¼Œ${h.failedCount} å¼ å¤±è´¥`:"";alert(`æˆåŠŸå¯¼å…¥ ${h.images.length} å¼ å›¾ç‰‡${le}`),y()}else t.setError(h.error||"ä¸‹è½½å¤±è´¥")}catch(h){t.setError(h instanceof Error?h.message:"ä¸‹è½½å¤±è´¥")}}Ce($,Y=>{Y&&setTimeout(()=>{document.querySelector(".url-input")?.focus()},100)}),Ce(o,Y=>{F(Y)});const S=Q(()=>t.settings.agent.provider==="custom_openai");async function w(){if(!t.settings.firecrawl.apiKey){alert("è¯·è¾“å…¥ Firecrawl API Key");return}P.value=!0;try{const Y=await wf(t.settings.firecrawl.apiKey);Y.success?alert("âœ… Firecrawl è¿æ¥æˆåŠŸ"):alert(`âŒ è¿æ¥å¤±è´¥: ${Y.error}`)}catch(Y){alert(`âŒ è¿æ¥å¤±è´¥: ${Y instanceof Error?Y.message:"æœªçŸ¥é”™è¯¯"}`)}finally{P.value=!1}}async function W(){if(!t.settings.agent.apiKey){alert("è¯·è¾“å…¥ AI Agent API Key");return}L.value=!0;try{const Y=await $f(t.settings.agent.provider,t.settings.agent.apiKey,t.settings.agent.customBaseUrl,t.settings.agent.modelName);Y.success?alert("âœ… AI Agent è¿æ¥æˆåŠŸ"):alert(`âŒ è¿æ¥å¤±è´¥: ${Y.error}`)}catch(Y){alert(`âŒ è¿æ¥å¤±è´¥: ${Y instanceof Error?Y.message:"æœªçŸ¥é”™è¯¯"}`)}finally{L.value=!1}}function Z(){confirm("ç¡®å®šè¦é‡ç½®ä¸ºé»˜è®¤æç¤ºè¯å—ï¼Ÿ")&&t.resetExtractionPrompt()}return(Y,c)=>(B(),ut(kn,{to:"body"},[$.value?(B(),A("div",{key:0,class:"modal-overlay",onClick:lt(y,["self"])},[e("div",Tf,[e("div",{class:"modal-header"},[c[37]||(c[37]=e("h2",{class:"modal-title"},[e("span",{class:"title-icon"},"ğŸŒ"),me(" ä»ç½‘é¡µå¯¼å…¥æ¼«ç”» ")],-1)),e("button",{class:"close-btn",onClick:y,title:"å…³é—­"},"Ã—")]),e("div",If,[e("div",Pf,[ae(e("input",{"onUpdate:modelValue":c[0]||(c[0]=h=>o.value=h),type:"url",class:"url-input",placeholder:"è¾“å…¥æ¼«ç”»ç½‘é¡µ URLï¼Œå¦‚ https://example.com/chapter-1",disabled:V.value,onKeyup:Sn(m,["enter"])},null,40,Rf),[[we,o.value]]),ae(e("select",{"onUpdate:modelValue":c[1]||(c[1]=h=>r.value=h),class:"engine-select",disabled:V.value},[...c[38]||(c[38]=[e("option",{value:"auto"},"è‡ªåŠ¨é€‰æ‹©",-1),e("option",{value:"gallery-dl"},"Gallery-DL",-1),e("option",{value:"ai-agent"},"AI Agent",-1)])],8,Df),[[hs,r.value]]),e("button",{class:"extract-btn",disabled:V.value||!o.value.trim(),onClick:m},[j.value==="extracting"?(B(),A("span",Ef)):(B(),A("span",Bf,"ğŸ”")),me(" "+oe(j.value==="extracting"?"æå–ä¸­...":"å¼€å§‹æå–"),1)],8,Mf)]),o.value.trim()&&!V.value?(B(),A("div",Af,[p.value?(B(),A("span",Lf,"æ£€æŸ¥ä¸­...")):u.value?(B(),A("span",Ff,"âœ“ è¯¥ç½‘ç«™æ”¯æŒ Gallery-DL é«˜é€Ÿä¸‹è½½")):a.value?(B(),A("span",Uf,"è¯¥ç½‘ç«™å°†ä½¿ç”¨ AI Agent æ¨¡å¼")):de("",!0)])):de("",!0),c[80]||(c[80]=e("div",{class:"notice"}," âš ï¸ è¯·ä»…çˆ¬å–æ‚¨æœ‰æƒè®¿é—®çš„å†…å®¹ï¼Œå¹¶éµå®ˆç›®æ ‡ç½‘ç«™çš„ä½¿ç”¨æ¡æ¬¾ã€‚ ",-1)),e("div",Of,[e("div",{class:"settings-header",onClick:c[2]||(c[2]=h=>k.value=!k.value)},[e("span",zf,oe(k.value?"â–¼":"â–¶"),1),c[39]||(c[39]=e("span",{class:"settings-title"},"âš™ï¸ è®¾ç½®",-1)),c[40]||(c[40]=e("span",{class:"settings-hint"},"ç‚¹å‡»å±•å¼€é…ç½®",-1))]),k.value?(B(),A("div",Nf,[e("div",Vf,[e("button",{class:Ie(["settings-tab",{active:f.value==="basic"}]),onClick:c[3]||(c[3]=h=>f.value="basic")}," åŸºæœ¬è®¾ç½® ",2),e("button",{class:Ie(["settings-tab",{active:f.value==="preprocess"}]),onClick:c[4]||(c[4]=h=>f.value="preprocess")}," å›¾ç‰‡é¢„å¤„ç† ",2),e("button",{class:Ie(["settings-tab",{active:f.value==="advanced"}]),onClick:c[5]||(c[5]=h=>f.value="advanced")}," é«˜çº§è®¾ç½® ",2)]),ae(e("div",Wf,[e("div",Kf,[c[42]||(c[42]=e("h4",{class:"group-title"},"Firecrawl é…ç½®",-1)),e("div",qf,[c[41]||(c[41]=e("label",{class:"form-label"},"API Key",-1)),e("div",Hf,[e("input",{type:M.value?"text":"password",class:"form-input",value:H(t).settings.firecrawl.apiKey,onInput:c[6]||(c[6]=h=>H(t).setFirecrawlApiKey(h.target.value)),placeholder:"fc-xxxxxxxxxxxxxxxx"},null,40,jf),e("button",{class:"toggle-btn",onClick:c[7]||(c[7]=h=>M.value=!M.value)},oe(M.value?"ğŸ‘":"ğŸ‘â€ğŸ—¨"),1),e("button",{class:"test-btn",disabled:P.value||!H(t).settings.firecrawl.apiKey,onClick:w},oe(P.value?"æµ‹è¯•ä¸­...":"æµ‹è¯•è¿æ¥"),9,Jf)])])]),e("div",Yf,[c[49]||(c[49]=e("h4",{class:"group-title"},"AI Agent é…ç½®",-1)),e("div",Xf,[c[43]||(c[43]=e("label",{class:"form-label"},"æœåŠ¡å•†",-1)),e("select",{class:"form-select",value:H(t).settings.agent.provider,onChange:c[8]||(c[8]=h=>H(t).setAgentProvider(h.target.value))},[(B(!0),A(Oe,null,Ye(H(fs),h=>(B(),A("option",{key:h.value,value:h.value},oe(h.label),9,Zf))),128))],40,Gf)]),e("div",Qf,[c[44]||(c[44]=e("label",{class:"form-label"},"API Key",-1)),e("div",eb,[e("input",{type:E.value?"text":"password",class:"form-input",value:H(t).settings.agent.apiKey,onInput:c[9]||(c[9]=h=>H(t).setAgentApiKey(h.target.value)),placeholder:"sk-xxxxxxxxxxxxxxxx"},null,40,tb),e("button",{class:"toggle-btn",onClick:c[10]||(c[10]=h=>E.value=!E.value)},oe(E.value?"ğŸ‘":"ğŸ‘â€ğŸ—¨"),1)])]),S.value?(B(),A("div",ob,[c[45]||(c[45]=e("label",{class:"form-label"},"è‡ªå®šä¹‰ API åœ°å€",-1)),e("input",{type:"url",class:"form-input",value:H(t).settings.agent.customBaseUrl,onInput:c[11]||(c[11]=h=>H(t).setAgentBaseUrl(h.target.value)),placeholder:"https://api.example.com/v1"},null,40,nb)])):de("",!0),e("div",sb,[c[46]||(c[46]=e("label",{class:"form-label"},"æ¨¡å‹åç§°",-1)),e("input",{type:"text",class:"form-input",value:H(t).settings.agent.modelName,onInput:c[12]||(c[12]=h=>H(t).setAgentModelName(h.target.value)),placeholder:"gpt-4o-mini"},null,40,ab)]),e("div",lb,[e("label",ib,[e("input",{type:"checkbox",checked:H(t).settings.agent.forceJsonOutput,onChange:c[13]||(c[13]=h=>H(t).setAgentForceJson(h.target.checked))},null,40,rb),c[47]||(c[47]=me(" å¼ºåˆ¶ JSON æ ¼å¼ ",-1))]),e("label",ub,[e("input",{type:"checkbox",checked:H(t).settings.agent.useStream,onChange:c[14]||(c[14]=h=>H(t).setAgentUseStream(h.target.checked))},null,40,cb),c[48]||(c[48]=me(" æµå¼è°ƒç”¨ ",-1))])]),e("div",db,[e("button",{class:"test-btn full",disabled:L.value||!H(t).settings.agent.apiKey,onClick:W},oe(L.value?"æµ‹è¯•ä¸­...":"æµ‹è¯• Agent è¿æ¥"),9,gb)])]),e("div",pb,[e("h4",{class:"group-title"},[c[50]||(c[50]=me(" æå–è®¾ç½® ",-1)),e("button",{class:"reset-btn",onClick:Z},"é‡ç½®ä¸ºé»˜è®¤")]),e("div",mb,[c[51]||(c[51]=e("label",{class:"form-label"},"æå–æç¤ºè¯",-1)),e("textarea",{class:"form-textarea",value:H(t).settings.extraction.prompt,onInput:c[15]||(c[15]=h=>H(t).setExtractionPrompt(h.target.value)),rows:"6",placeholder:"è¾“å…¥æå–æç¤ºè¯..."},null,40,vb)]),e("div",fb,[c[52]||(c[52]=e("label",{class:"form-label"},"æœ€å¤§è¿­ä»£æ¬¡æ•°",-1)),e("input",{type:"number",class:"form-input small",value:H(t).settings.extraction.maxIterations,onInput:c[16]||(c[16]=h=>H(t).setExtractionMaxIterations(Number(h.target.value))),min:"1",max:"20"},null,40,bb)])]),e("div",hb,[c[58]||(c[58]=e("h4",{class:"group-title"},"ä¸‹è½½è®¾ç½®",-1)),e("div",yb,[e("div",xb,[c[53]||(c[53]=e("label",{class:"form-label"},"å¹¶å‘æ•°",-1)),e("input",{type:"number",class:"form-input small",value:H(t).settings.download.concurrency,onInput:c[17]||(c[17]=h=>H(t).setDownloadConcurrency(Number(h.target.value))),min:"1",max:"10"},null,40,_b)]),e("div",Cb,[c[54]||(c[54]=e("label",{class:"form-label"},"è¶…æ—¶ (ç§’)",-1)),e("input",{type:"number",class:"form-input small",value:H(t).settings.download.timeout,onInput:c[18]||(c[18]=h=>H(t).setDownloadTimeout(Number(h.target.value))),min:"5",max:"120"},null,40,Sb)]),e("div",kb,[c[55]||(c[55]=e("label",{class:"form-label"},"é‡è¯•æ¬¡æ•°",-1)),e("input",{type:"number",class:"form-input small",value:H(t).settings.download.retries,onInput:c[19]||(c[19]=h=>H(t).setDownloadRetries(Number(h.target.value))),min:"0",max:"5"},null,40,wb)]),e("div",$b,[c[56]||(c[56]=e("label",{class:"form-label"},"ä¸‹è½½é—´éš” (ms)",-1)),e("input",{type:"number",class:"form-input small",value:H(t).settings.download.delay,onInput:c[20]||(c[20]=h=>H(t).setDownloadDelay(Number(h.target.value))),min:"0",max:"2000",step:"100"},null,40,Tb)])]),e("div",Ib,[e("label",Pb,[e("input",{type:"checkbox",checked:H(t).settings.download.useReferer,onChange:c[21]||(c[21]=h=>H(t).setDownloadUseReferer(h.target.checked))},null,40,Rb),c[57]||(c[57]=me(" è‡ªåŠ¨æ·»åŠ  Referer ",-1))])])]),e("div",Db,[c[61]||(c[61]=e("h4",{class:"group-title"},"ç•Œé¢è®¾ç½®",-1)),e("div",Mb,[e("label",Eb,[e("input",{type:"checkbox",checked:H(t).settings.ui.showAgentLogs,onChange:c[22]||(c[22]=h=>H(t).setShowAgentLogs(h.target.checked))},null,40,Bb),c[59]||(c[59]=me(" æ˜¾ç¤º AI å·¥ä½œæ—¥å¿— ",-1))]),e("label",Ab,[e("input",{type:"checkbox",checked:H(t).settings.ui.autoImport,onChange:c[23]||(c[23]=h=>H(t).setAutoImport(h.target.checked))},null,40,Lb),c[60]||(c[60]=me(" æå–åè‡ªåŠ¨å¯¼å…¥ ",-1))])])])],512),[[Ue,f.value==="basic"]]),ae(e("div",Fb,[e("div",Ub,[e("div",Ob,[e("label",zb,[e("input",{type:"checkbox",checked:H(t).settings.imagePreprocess.enabled,onChange:c[24]||(c[24]=h=>H(t).setImagePreprocessEnabled(h.target.checked))},null,40,Nb),c[62]||(c[62]=me(" å¯ç”¨å›¾ç‰‡é¢„å¤„ç† ",-1))])]),H(t).settings.imagePreprocess.enabled?(B(),A(Oe,{key:0},[e("div",Vb,[e("label",Wb,[e("input",{type:"checkbox",checked:H(t).settings.imagePreprocess.autoRotate,onChange:c[25]||(c[25]=h=>H(t).setImageAutoRotate(h.target.checked))},null,40,Kb),c[63]||(c[63]=me(" æ ¹æ® EXIF è‡ªåŠ¨æ—‹è½¬ ",-1))])]),c[71]||(c[71]=e("h5",{class:"subsection-title"},"å‹ç¼©è®¾ç½®",-1)),e("div",qb,[e("label",Hb,[e("input",{type:"checkbox",checked:H(t).settings.imagePreprocess.compression.enabled,onChange:c[26]||(c[26]=h=>H(t).setImageCompressionEnabled(h.target.checked))},null,40,jb),c[64]||(c[64]=me(" å¯ç”¨å‹ç¼© ",-1))])]),H(t).settings.imagePreprocess.compression.enabled?(B(),A("div",Jb,[e("div",Yb,[c[65]||(c[65]=e("label",{class:"form-label"},"è´¨é‡ (0-100)",-1)),e("input",{type:"number",class:"form-input small",value:H(t).settings.imagePreprocess.compression.quality,onInput:c[27]||(c[27]=h=>H(t).setImageCompressionQuality(Number(h.target.value))),min:"1",max:"100"},null,40,Xb)]),e("div",Gb,[c[66]||(c[66]=e("label",{class:"form-label"},"æœ€å¤§å®½åº¦ (0=ä¸é™)",-1)),e("input",{type:"number",class:"form-input small",value:H(t).settings.imagePreprocess.compression.maxWidth,onInput:c[28]||(c[28]=h=>H(t).setImageMaxWidth(Number(h.target.value))),min:"0"},null,40,Zb)]),e("div",Qb,[c[67]||(c[67]=e("label",{class:"form-label"},"æœ€å¤§é«˜åº¦ (0=ä¸é™)",-1)),e("input",{type:"number",class:"form-input small",value:H(t).settings.imagePreprocess.compression.maxHeight,onInput:c[29]||(c[29]=h=>H(t).setImageMaxHeight(Number(h.target.value))),min:"0"},null,40,eh)])])):de("",!0),c[72]||(c[72]=e("h5",{class:"subsection-title"},"æ ¼å¼è½¬æ¢",-1)),e("div",th,[e("label",oh,[e("input",{type:"checkbox",checked:H(t).settings.imagePreprocess.formatConvert.enabled,onChange:c[30]||(c[30]=h=>H(t).setImageFormatConvertEnabled(h.target.checked))},null,40,nh),c[68]||(c[68]=me(" å¯ç”¨æ ¼å¼è½¬æ¢ ",-1))])]),H(t).settings.imagePreprocess.formatConvert.enabled?(B(),A("div",sh,[c[70]||(c[70]=e("label",{class:"form-label"},"ç›®æ ‡æ ¼å¼",-1)),e("select",{class:"form-select",value:H(t).settings.imagePreprocess.formatConvert.targetFormat,onChange:c[31]||(c[31]=h=>H(t).setImageTargetFormat(h.target.value))},[...c[69]||(c[69]=[e("option",{value:"original"},"ä¿æŒåŸæ ¼å¼",-1),e("option",{value:"jpeg"},"JPEG",-1),e("option",{value:"png"},"PNG",-1),e("option",{value:"webp"},"WebP",-1)])],40,ah)])):de("",!0)],64)):de("",!0)])],512),[[Ue,f.value==="preprocess"]]),ae(e("div",lh,[e("div",ih,[c[76]||(c[76]=e("h4",{class:"group-title"},"è‡ªå®šä¹‰è¯·æ±‚å¤´",-1)),e("div",rh,[c[73]||(c[73]=e("label",{class:"form-label"},"Cookie",-1)),e("input",{type:"text",class:"form-input",value:H(t).settings.advanced.customCookie,onInput:c[32]||(c[32]=h=>H(t).setCustomCookie(h.target.value)),placeholder:"name=value; name2=value2"},null,40,uh)]),e("div",ch,[c[74]||(c[74]=e("label",{class:"form-label"},"Headers (JSON)",-1)),e("textarea",{class:"form-textarea",value:H(t).settings.advanced.customHeaders,onInput:c[33]||(c[33]=h=>H(t).setCustomHeaders(h.target.value)),rows:"3",placeholder:'{"X-Custom-Header": "value"}'},null,40,dh)]),e("div",gh,[e("label",ph,[e("input",{type:"checkbox",checked:H(t).settings.advanced.bypassProxy,onChange:c[34]||(c[34]=h=>H(t).setBypassProxy(h.target.checked))},null,40,mh),c[75]||(c[75]=me(" ç»•è¿‡ç³»ç»Ÿä»£ç† (è¿æ¥æœ¬åœ°æœåŠ¡æ—¶ä½¿ç”¨) ",-1))])])])],512),[[Ue,f.value==="advanced"]])])):de("",!0)]),se.value&&K.value.length>0?(B(),A("div",vh,[e("div",{class:"logs-header",onClick:c[35]||(c[35]=h=>i.value=!i.value)},[e("span",fh,oe(i.value?"â–¼":"â–¶"),1),c[77]||(c[77]=e("span",null,"AI å·¥ä½œæ—¥å¿—",-1)),j.value==="extracting"?(B(),A("span",bh,"(æå–ä¸­...)")):de("",!0)]),i.value?(B(),A("div",hh,[(B(!0),A(Oe,null,Ye(K.value,(h,le)=>(B(),A("div",{key:le,class:Ie(["log-item",`log-${h.type}`])},[e("span",yh,"["+oe(h.timestamp)+"]",1),e("span",xh,oe(h.message),1)],2))),128))])):de("",!0)])):de("",!0),q.value?(B(),A("div",_h,[c[78]||(c[78]=e("span",{class:"error-icon"},"âŒ",-1)),e("span",Ch,oe(q.value),1)])):de("",!0),U.value?.success?(B(),A("div",Sh,[e("div",kh,[e("span",wh," ğŸ“– ã€Š"+oe(U.value.comicTitle)+"ã€‹- "+oe(U.value.chapterTitle),1),e("span",$h,[e("span",Th,"å…± "+oe(U.value.totalPages)+" å¼ ",1),ie.value?(B(),A("span",Ih,"| å¼•æ“: "+oe(ie.value),1)):de("",!0)])]),e("div",Ph,[e("label",Rh,[e("input",{type:"checkbox",checked:z.value,onChange:v},null,40,Dh),c[79]||(c[79]=me(" å…¨é€‰ ",-1))]),e("span",Mh,"å·²é€‰: "+oe(d.value)+" å¼ ",1)]),e("div",Eh,[(B(!0),A(Oe,null,Ye(U.value.pages,h=>(B(),A("div",{key:h.pageNumber,class:Ie(["image-item",{selected:g.value.has(h.pageNumber)}]),onClick:le=>l(h.pageNumber)},[e("div",Ah,[e("input",{type:"checkbox",checked:g.value.has(h.pageNumber),onClick:c[36]||(c[36]=lt(()=>{},["stop"])),onChange:le=>l(h.pageNumber)},null,40,Lh)]),e("div",Fh,[e("img",{src:R(h.imageUrl),alt:`ç¬¬${h.pageNumber}é¡µ`,loading:"lazy"},null,8,Uh)]),e("div",Oh,"ç¬¬ "+oe(h.pageNumber)+" é¡µ",1)],10,Bh))),128))])])):de("",!0),j.value==="downloading"?(B(),A("div",zh,[e("div",Nh," ä¸‹è½½è¿›åº¦: "+oe(x.value.current)+"/"+oe(x.value.total),1),e("div",Vh,[e("div",{class:"progress-fill",style:at({width:`${_.value}%`})},null,4)])])):de("",!0)]),e("div",Wh,[e("button",{class:"cancel-btn",onClick:y,disabled:j.value==="downloading"}," å–æ¶ˆ ",8,Kh),e("button",{class:"import-btn",disabled:!U.value?.success||d.value===0||V.value,onClick:D},[j.value==="downloading"?(B(),A("span",Hh)):(B(),A("span",jh,"ğŸ“¥")),me(" "+oe(j.value==="downloading"?"ä¸‹è½½ä¸­...":"å¯¼å…¥"),1)],8,qh)])])])):de("",!0)]))}}),Yh=He(Jh,[["__scopeId","data-v-78fc5cb0"]]),Xh={class:"disclaimer-container"},Gh={class:"disclaimer-content"},Zh={class:"confirmation-area"},Qh=["placeholder"],ey={key:0,class:"input-error"},ty={class:"disclaimer-footer"},oy=["disabled"],qt="æˆ‘å·²é˜…è¯»å¹¶åŒæ„",ny=je({__name:"WebImportDisclaimer",setup(n){const t=_o(),s=C(""),o=Q(()=>t.disclaimerVisible),i=Q(()=>s.value.trim()===qt);function r(){i.value&&(t.acceptDisclaimer(),s.value="")}function a(){t.rejectDisclaimer(),s.value=""}return(u,p)=>(B(),ut(kn,{to:"body"},[o.value?(B(),A("div",{key:0,class:"disclaimer-overlay",onClick:lt(a,["self"])},[e("div",Xh,[p[3]||(p[3]=e("div",{class:"disclaimer-header"},[e("span",{class:"warning-icon"},"âš ï¸"),e("h2",{class:"disclaimer-title"},"é‡è¦å…è´£å£°æ˜")],-1)),e("div",Gh,[p[2]||(p[2]=e("div",{class:"disclaimer-text"},[e("h3",null,"ğŸ“œ ä½¿ç”¨æ¡æ¬¾ä¸æ³•å¾‹å£°æ˜"),e("div",{class:"section"},[e("h4",null,"1. åŠŸèƒ½è¯´æ˜"),e("p",null,[me(' "ä»ç½‘é¡µå¯¼å…¥"åŠŸèƒ½å…è®¸æ‚¨ä»äº’è”ç½‘ç½‘é¡µä¸­æå–å›¾ç‰‡ã€‚æ­¤åŠŸèƒ½ä»…ä¾›'),e("strong",null,"æŠ€æœ¯ç ”ç©¶ä¸ä¸ªäººå­¦ä¹ "),me("ä¹‹ç›®çš„æä¾›ã€‚ ")])]),e("div",{class:"section"},[e("h4",null,"2. ç”¨æˆ·è´£ä»»"),e("ul",null,[e("li",null,[me("æ‚¨åº”å½“ç¡®ä¿æ‹¥æœ‰"),e("strong",null,"åˆæ³•æƒåˆ©"),me("è®¿é—®å’Œä¸‹è½½ç›®æ ‡å†…å®¹")]),e("li",null,[me("æ‚¨åº”å½“éµå®ˆç›®æ ‡ç½‘ç«™çš„"),e("strong",null,"æœåŠ¡æ¡æ¬¾"),me("å’Œ"),e("strong",null,"ä½¿ç”¨åè®®")]),e("li",null,[me("æ‚¨åº”å½“å°Šé‡å†…å®¹åˆ›ä½œè€…çš„"),e("strong",null,"ç‰ˆæƒ"),me("å’Œ"),e("strong",null,"çŸ¥è¯†äº§æƒ")]),e("li",null,[me("æ‚¨"),e("strong",null,"ä¸å¾—"),me("å°†ä¸‹è½½çš„å†…å®¹ç”¨äºå•†ä¸šç›®çš„æˆ–éæ³•ä¼ æ’­")]),e("li",null,[me("æ‚¨"),e("strong",null,"ä¸å¾—"),me("ä½¿ç”¨æœ¬åŠŸèƒ½ç»•è¿‡ä»˜è´¹å†…å®¹çš„è®¿é—®é™åˆ¶")])])]),e("div",{class:"section"},[e("h4",null,"3. ä½¿ç”¨é™åˆ¶"),e("p",null,[me("æœ¬åŠŸèƒ½"),e("strong",null,"ä¸¥ç¦"),me("ç”¨äºä»¥ä¸‹ç›®çš„ï¼š")]),e("ul",null,[e("li",null,[me("ä¸‹è½½ã€å­˜å‚¨æˆ–ä¼ æ’­"),e("strong",null,"ä¾µæƒå†…å®¹")]),e("li",null,[me("ç»•è¿‡ç½‘ç«™çš„"),e("strong",null,"ä»˜è´¹å¢™"),me("æˆ–"),e("strong",null,"è®¿é—®æ§åˆ¶")]),e("li",null,[me("è¿›è¡Œ"),e("strong",null,"å•†ä¸šç”¨é€”"),me("æˆ–å¤§è§„æ¨¡"),e("strong",null,"æ‰¹é‡çˆ¬å–")]),e("li",null,[me("ä»»ä½•è¿å"),e("strong",null,"å½“åœ°æ³•å¾‹æ³•è§„"),me("çš„æ´»åŠ¨")]),e("li",null,[me("å¯¹ç›®æ ‡ç½‘ç«™é€ æˆ"),e("strong",null,"æœåŠ¡å™¨è´Ÿæ‹…"),me("æˆ–"),e("strong",null,"æ¶æ„æ”»å‡»")])])]),e("div",{class:"section"},[e("h4",null,"4. å…è´£æ¡æ¬¾"),e("p",null,[me(" æœ¬è½¯ä»¶ä½œè€…åŠè´¡çŒ®è€…"),e("strong",null,"ä¸å¯¹æ‚¨ä½¿ç”¨æœ¬åŠŸèƒ½æ‰€å¯¼è‡´çš„ä»»ä½•ç›´æ¥æˆ–é—´æ¥åæœæ‰¿æ‹…è´£ä»»"),me("ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºï¼š ")]),e("ul",null,[e("li",null,"å› ä¾µçŠ¯ç‰ˆæƒè€Œäº§ç”Ÿçš„æ³•å¾‹è´£ä»»"),e("li",null,"å› è¿åæœåŠ¡æ¡æ¬¾è€Œå¯¼è‡´çš„è´¦å·å°ç¦"),e("li",null,"å› æ•°æ®ä¸¢å¤±æˆ–æŸåè€Œé€ æˆçš„æŸå¤±"),e("li",null,"ä»»ä½•å…¶ä»–å› ä½¿ç”¨æœ¬åŠŸèƒ½è€Œäº§ç”Ÿçš„ä¸åˆ©åæœ")])]),e("div",{class:"section warning-section"},[e("h4",null,"5. ç¡®è®¤å£°æ˜"),e("p",null,[me(" ä½¿ç”¨æœ¬åŠŸèƒ½å³è¡¨ç¤ºæ‚¨"),e("strong",null,"å·²é˜…è¯»ã€ç†è§£å¹¶åŒæ„"),me("ä¸Šè¿°æ‰€æœ‰æ¡æ¬¾ï¼Œå¹¶æ‰¿è¯ºï¼š ")]),e("ul",null,[e("li",null,[me("ä»…å°†æœ¬åŠŸèƒ½ç”¨äº"),e("strong",null,"åˆæ³•ã€åˆè§„"),me("çš„ç›®çš„")]),e("li",null,[e("strong",null,"è‡ªè¡Œæ‰¿æ‹…"),me("ä½¿ç”¨æœ¬åŠŸèƒ½æ‰€å¸¦æ¥çš„ä¸€åˆ‡é£é™©å’Œè´£ä»»")]),e("li",null,[me("å¦‚å› ä½¿ç”¨æœ¬åŠŸèƒ½å¯¼è‡´ä»»ä½•äº‰è®®ï¼Œ"),e("strong",null,"ä¸æœ¬è½¯ä»¶ä½œè€…æ— å…³")])])])],-1)),e("div",Zh,[p[1]||(p[1]=e("p",{class:"confirmation-prompt"}," å¦‚æœæ‚¨å·²å®Œæ•´é˜…è¯»å¹¶åŒæ„ä»¥ä¸Šæ¡æ¬¾ï¼Œè¯·åœ¨ä¸‹æ–¹è¾“å…¥æ¡†ä¸­å‡†ç¡®è¾“å…¥ï¼š ",-1)),e("p",{class:"required-text"},[e("code",null,oe(qt))]),ae(e("input",{"onUpdate:modelValue":p[0]||(p[0]=k=>s.value=k),type:"text",class:"confirmation-input",placeholder:`è¯·è¾“å…¥: ${qt}`,onKeyup:Sn(r,["enter"])},null,40,Qh),[[we,s.value]]),s.value&&!i.value?(B(),A("p",ey," è¾“å…¥ä¸æ­£ç¡®ï¼Œè¯·å®Œæ•´è¾“å…¥ã€Œ"+oe(qt)+"ã€ ")):de("",!0)])]),e("div",ty,[e("button",{class:"btn-cancel",onClick:a}," æˆ‘ä¸åŒæ„ï¼Œè¿”å› "),e("button",{class:"btn-confirm",disabled:!i.value,onClick:r}," âœ“ ç¡®è®¤å¹¶ç»§ç»­ ",8,oy)])])])):de("",!0)]))}}),sy=He(ny,[["__scopeId","data-v-3750d090"]]),ay={class:"app-header"},ly={class:"header-content"},iy={class:"logo-container"},ry={class:"header-links"},uy={class:"container"},cy={id:"image-display-area"},dy={id:"upload-section",class:"card upload-card"},gy={class:"upload-actions"},py={key:1,class:"bookshelf-mode-hint"},my=je({__name:"TranslateView",setup(n){const t=Cn(),s=et(),o=ze(),i=It(),r=gt(),{validateBeforeTranslation:a,initValidation:u}=En(),p=Do(),k=Mi(),f=C(!1),P=C(void 0),L=C(!1),M=C(!1),E=Q(()=>s.currentImage),$=Q(()=>s.hasImages),j=Q(()=>s.isBatchTranslationInProgress),K=Q(()=>s.failedImageCount>0),U=Q(()=>!!t.query.book&&!!t.query.chapter),g=Q(()=>t.query.book),d=Q(()=>t.query.chapter),x=Q(()=>k.currentBookTitle.value),_=Q(()=>k.currentChapterTitle.value),q=Q(()=>U.value&&_.value&&x.value?`${_.value} - ${x.value}`:"Saber-Translator");dt(async()=>{s.clearImages(),r.clearBubbles(),await k.initializeApp(),u(),window.addEventListener("keydown",b)}),Ot(()=>{window.removeEventListener("keydown",b)}),Ce(()=>[t.query.book,t.query.chapter],async([O,ne],[be,ge])=>{O&&ne?(s.clearImages(),r.clearBubbles(),await ie()):be&&ge&&!O&&!ne&&(s.clearImages(),r.clearBubbles(),await k.initializeBookChapterContext(),console.log("[TranslateView] ä»ä¹¦æ¶æ¨¡å¼åˆ‡æ¢åˆ°å¿«é€Ÿç¿»è¯‘æ¨¡å¼ï¼Œå·²æ¸…ç©ºæ•°æ®"))}),Ce(q,O=>{typeof document<"u"&&(document.title=O)},{immediate:!0});const V=C(!1);function se(O){O&&o.updateTextStyle({fontSize:O.fontSize,autoFontSize:O.autoFontSize,fontFamily:O.fontFamily,layoutDirection:O.layoutDirection,textColor:O.textColor,fillColor:O.fillColor,strokeEnabled:O.strokeEnabled,strokeColor:O.strokeColor,strokeWidth:O.strokeWidth,inpaintMethod:O.inpaintMethod,useAutoTextColor:O.useAutoTextColor})}function X(O){s.currentImage&&s.updateCurrentImage({fontSize:O.fontSize,autoFontSize:O.autoFontSize,fontFamily:O.fontFamily,layoutDirection:O.layoutDirection,textColor:O.textColor,fillColor:O.fillColor,strokeEnabled:O.strokeEnabled,strokeColor:O.strokeColor,strokeWidth:O.strokeWidth,inpaintMethod:O.inpaintMethod,useAutoTextColor:O.useAutoTextColor})}Ce(()=>s.currentImage,O=>{if(O&&!V.value){V.value=!0;try{se(O),console.log(`[TranslateView] å·²åŒæ­¥å›¾ç‰‡ ${s.currentImageIndex} çš„æ–‡å­—è®¾ç½®åˆ°ä¾§è¾¹æ `)}finally{V.value=!1}}},{immediate:!1}),Ce(()=>o.settings.textStyle,O=>{if(s.currentImage&&!V.value){V.value=!0;try{X(O),console.log(`[TranslateView] å·²å°†ä¾§è¾¹æ è®¾ç½®åŒæ­¥åˆ°å›¾ç‰‡ ${s.currentImageIndex}`)}finally{V.value=!1}}},{deep:!0});async function ie(){if(!(!g.value||!d.value))try{await k.initializeBookChapterContext()}catch(O){console.error("åŠ è½½ç« èŠ‚ä¼šè¯å¤±è´¥:",O),xe("åŠ è½½ç« èŠ‚ä¼šè¯å¤±è´¥","error")}}function z(O){console.log(`ä¸Šä¼ å®Œæˆï¼Œå…± ${O} å¼ å›¾ç‰‡`),s.hasImages&&(s.sortImagesByFileName(),k.switchImage(0))}async function R(O){if(!Object.values(O).some(ge=>ge)){xe("è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè¦åº”ç”¨çš„è®¾ç½®é¡¹","warning");return}if(s.images.length===0){xe("æ²¡æœ‰å¯åº”ç”¨çš„å›¾ç‰‡","warning");return}if(s.images.length<=1){xe("åªæœ‰ä¸€å¼ å›¾ç‰‡ï¼Œæ— éœ€åº”ç”¨åˆ°å…¨éƒ¨","info");return}if(!s.images.some(ge=>ge.bubbleStates&&ge.bubbleStates.length>0)){xe("æ²¡æœ‰å·²ç¿»è¯‘çš„å›¾ç‰‡","warning");return}try{const{textStyle:ge}=o.settings,Pe=ge.layoutDirection==="auto",Ee=ge.useAutoTextColor===!0,Le=ge.autoFontSize===!0,ke={fontSize:ge.fontSize,fontFamily:ge.fontFamily,textDirection:ge.layoutDirection==="auto"?"vertical":ge.layoutDirection,textColor:ge.textColor,fillColor:ge.fillColor,strokeEnabled:ge.strokeEnabled,strokeColor:ge.strokeColor,strokeWidth:ge.strokeWidth},Be=N=>{if(!N||N.length!==3)return null;const[re,Te,Re]=N;return"#"+[re,Te,Re].map(tt=>{const qe=Math.max(0,Math.min(255,Math.round(tt))).toString(16);return qe.length===1?"0"+qe:qe}).join("")},ye=N=>{const re={...N};if(O.fontSize&&!Le&&(re.fontSize=ke.fontSize),O.fontFamily&&(re.fontFamily=ke.fontFamily),O.layoutDirection)if(Pe){const Te=N.autoTextDirection;re.textDirection=Te==="vertical"||Te==="horizontal"?Te:"vertical"}else re.textDirection=ke.textDirection;if(O.textColor)if(Ee&&N.autoFgColor){const Te=Be(N.autoFgColor);re.textColor=Te??ke.textColor}else re.textColor=ke.textColor;if(O.fillColor)if(Ee&&N.autoBgColor){const Te=Be(N.autoBgColor);re.fillColor=Te??ke.fillColor}else re.fillColor=ke.fillColor;return O.strokeEnabled&&(re.strokeEnabled=ke.strokeEnabled),O.strokeColor&&(re.strokeColor=ke.strokeColor),O.strokeWidth&&(re.strokeWidth=ke.strokeWidth),re};let it=0;const Ge=s.images;for(let N=0;N<Ge.length;N++){const re=Ge[N];if(re&&re.bubbleStates&&re.bubbleStates.length>0){const Re={bubbleStates:re.bubbleStates.map(ye)};O.fontSize&&(Re.autoFontSize=Le,Le||(Re.fontSize=ke.fontSize)),O.fontFamily&&(Re.fontFamily=ke.fontFamily),O.layoutDirection&&(Re.layoutDirection=ge.layoutDirection),(O.textColor||O.fillColor)&&(Re.useAutoTextColor=Ee),O.textColor&&(Ee||(Re.textColor=ke.textColor)),O.fillColor&&(Ee||(Re.fillColor=ke.fillColor)),O.strokeEnabled&&(Re.strokeEnabled=ke.strokeEnabled),O.strokeColor&&(Re.strokeColor=ke.strokeColor),O.strokeWidth&&(Re.strokeWidth=ke.strokeWidth),s.updateImageByIndex(N,Re),it++}}if(r.bubbles.length>0){const N=r.bubbles.map(ye);r.setBubbles(N)}const Ze=[];O.fontSize&&Ze.push(Le?"è‡ªåŠ¨å­—å·":"å­—å·"),O.fontFamily&&Ze.push("å­—ä½“"),O.layoutDirection&&Ze.push(Pe?"è‡ªåŠ¨æ’ç‰ˆæ–¹å‘":"æ’ç‰ˆæ–¹å‘"),O.textColor&&Ze.push(Ee?"è‡ªåŠ¨æ–‡å­—é¢œè‰²":"æ–‡å­—é¢œè‰²"),O.fillColor&&Ze.push(Ee?"è‡ªåŠ¨å¡«å……é¢œè‰²":"å¡«å……é¢œè‰²"),O.strokeEnabled&&Ze.push("æè¾¹å¼€å…³"),O.strokeColor&&Ze.push("æè¾¹é¢œè‰²"),O.strokeWidth&&Ze.push("æè¾¹å®½åº¦");const st=[];for(let N=0;N<Ge.length;N++){const re=Ge[N];re&&re.translatedDataURL&&re.bubbleStates&&re.bubbleStates.length>0&&st.push(N)}if(st.length>0){p.progress.value={isInProgress:!0,current:0,total:st.length,completed:0,failed:0,label:`åº”ç”¨è®¾ç½®ä¸­ï¼š0 / ${st.length}`,percentage:0};const{parallelRender:N}=await rt(async()=>{const{parallelRender:Te}=await Promise.resolve().then(()=>di);return{parallelRender:Te}},void 0);let re=0;for(let Te=0;Te<st.length;Te++){const Re=st[Te];if(Re===void 0)continue;const tt=s.images[Re];if(!(!tt||!tt.bubbleStates))try{let qe="";if(tt.cleanImageData?qe=tt.cleanImageData.includes("base64,")?tt.cleanImageData.split("base64,")[1]||"":tt.cleanImageData:tt.originalDataURL&&(qe=tt.originalDataURL.includes("base64,")?tt.originalDataURL.split("base64,")[1]||"":tt.originalDataURL,console.log(`handleApplyToAll: å›¾ç‰‡ ${Re} ä½¿ç”¨åŸå›¾ä½œä¸ºèƒŒæ™¯ï¼ˆå…œåº•ï¼‰`)),!qe){console.log(`handleApplyToAll: å›¾ç‰‡ ${Re} æ²¡æœ‰å¯ç”¨çš„èƒŒæ™¯å›¾ï¼Œè·³è¿‡`),p.progress.value.failed++;continue}const Qe=tt.bubbleStates.map(ot=>({originalText:ot.originalText||"",translatedText:ot.translatedText||"",textboxText:ot.textboxText||"",coords:ot.coords,polygon:ot.polygon,fontSize:ot.fontSize,fontFamily:ot.fontFamily,textDirection:ot.textDirection,autoTextDirection:ot.autoTextDirection,textColor:ot.textColor,fillColor:ot.fillColor,rotationAngle:ot.rotationAngle||0,position:ot.position||{x:0,y:0},strokeEnabled:ot.strokeEnabled,strokeColor:ot.strokeColor,strokeWidth:ot.strokeWidth,inpaintMethod:ot.inpaintMethod,autoFgColor:ot.autoFgColor,autoBgColor:ot.autoBgColor})),ht=await N({clean_image:qe,bubble_states:Qe,fontSize:ge.fontSize,fontFamily:ge.fontFamily,textDirection:ge.layoutDirection==="auto"?"vertical":ge.layoutDirection,textColor:ge.textColor,strokeEnabled:ge.strokeEnabled,strokeColor:ge.strokeColor,strokeWidth:ge.strokeWidth,autoFontSize:O.fontSize&&Le,use_individual_styles:!0});if(ht.success&&ht.final_image){const ot=ht.bubble_states||tt.bubbleStates;s.updateImageByIndex(Re,{translatedDataURL:`data:image/png;base64,${ht.final_image}`,bubbleStates:ot,hasUnsavedChanges:!0}),re++,p.progress.value.current=re,p.progress.value.label=`åº”ç”¨è®¾ç½®ä¸­ï¼š${re} / ${st.length}`,p.progress.value.percentage=Math.round(re/st.length*100)}else p.progress.value.failed++}catch(qe){console.error(`é‡æ¸²æŸ“å›¾ç‰‡ ${Re} å¤±è´¥:`,qe),p.progress.value.failed++}}p.progress.value.isInProgress=!1}const Ae=s.currentImage;if(Ae){V.value=!0;try{se(Ae),console.log("[TranslateView] åº”ç”¨åˆ°å…¨éƒ¨å®Œæˆï¼Œå·²åŒæ­¥å½“å‰å›¾ç‰‡è®¾ç½®åˆ°ä¾§è¾¹æ ")}finally{V.value=!1}}xe(`å·²å°† ${Ze.join("ã€")} åº”ç”¨åˆ° ${it} å¼ å›¾ç‰‡`,"success"),console.log(`[TranslateView] åº”ç”¨è®¾ç½®åˆ°å…¨éƒ¨å®Œæˆï¼Œæ›´æ–°äº† ${it} å¼ å›¾ç‰‡ï¼Œé‡æ¸²æŸ“äº† ${st.length} å¼ `)}catch(ge){console.error("åº”ç”¨è®¾ç½®åˆ°å…¨éƒ¨å¤±è´¥:",ge),xe("åº”ç”¨è®¾ç½®å¤±è´¥","error")}}async function I(){E.value&&a("normal")&&await p.translateCurrentImage()}async function F(){$.value&&a("normal")&&await p.translateAllImages()}async function y(){$.value&&a("hq")&&await p.executeHqTranslation()}async function m(){$.value&&a("proofread")&&await p.executeProofreading()}async function l(){E.value&&await p.removeTextOnly()}async function v(){$.value&&await p.removeAllTexts()}async function D(O,ne){$.value&&a("normal")&&await p.translateImageRange({startPage:O,endPage:ne})}async function S(O,ne){$.value&&a("hq")&&await p.executeHqTranslation({startPage:O,endPage:ne})}async function w(O,ne){$.value&&a("proofread")&&await p.executeProofreading({startPage:O,endPage:ne})}async function W(O,ne){$.value&&await p.removeTextRange({startPage:O,endPage:ne})}function Z(){if(!E.value)return;const O=E.value.fileName||`å›¾ç‰‡ ${s.currentImageIndex+1}`;confirm(`ç¡®å®šè¦åˆ é™¤å½“å‰å›¾ç‰‡ (${O}) å—ï¼Ÿ`)&&(s.deleteCurrentImage(),xe("å›¾ç‰‡å·²åˆ é™¤","success"))}function Y(){$.value&&confirm("ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰å›¾ç‰‡å—ï¼Ÿè¿™å°†ä¸¢å¤±æ‰€æœ‰æœªä¿å­˜çš„è¿›åº¦ã€‚")&&(s.clearImages(),xe("æ‰€æœ‰å›¾ç‰‡å·²æ¸…é™¤","success"))}async function c(){try{const O=await wn(),ne=await ho();if(O.success&&ne.success)xe("ä¸´æ—¶æ–‡ä»¶æ¸…ç†å®Œæˆ","success");else{const be=[];O.success||be.push("è°ƒè¯•æ–‡ä»¶æ¸…ç†å¤±è´¥"),ne.success||be.push("ä¸´æ—¶æ–‡ä»¶æ¸…ç†å¤±è´¥"),xe(be.join("ï¼Œ"),"warning")}}catch{xe("æ¸…ç†ä¸´æ—¶æ–‡ä»¶å¤±è´¥","error")}}function h(){k.goToPrevious()}function le(){k.goToNext()}function T(){M.value=!M.value}async function G(){if(!K.value){xe("æ²¡æœ‰å¤±è´¥çš„å›¾ç‰‡éœ€è¦é‡æ–°ç¿»è¯‘","info");return}a("normal")&&await p.retryFailedImages()}async function ce(){if(!$.value){xe("æ²¡æœ‰å¯ä¿å­˜çš„å†…å®¹","warning");return}if(!(!g.value||!d.value))try{await i.saveChapterSession(g.value,d.value)?xe("ç« èŠ‚è¿›åº¦å·²ä¿å­˜","success"):xe("ä¿å­˜å¤±è´¥","error")}catch(O){console.error("ä¿å­˜ä¼šè¯å¤±è´¥:",O),xe("ä¿å­˜å¤±è´¥: "+(O instanceof Error?O.message:"æœªçŸ¥é”™è¯¯"),"error")}}function _e(O){P.value=O,f.value=!0}function De(){_e("plugins")}function $e(){xe("è®¾ç½®å·²ä¿å­˜","success")}function he(){L.value=!0}function te(){xe("ğŸŒ™ è¯¥åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­ï¼Œæ•¬è¯·æœŸå¾…ï¼","info")}function b(O){const ne=O.target;if(!(ne instanceof HTMLInputElement||ne instanceof HTMLTextAreaElement||ne.getAttribute("contenteditable")==="true"||ne.id==="bubbleTextEditor")&&!M.value&&O.altKey)switch(O.key){case"ArrowLeft":O.preventDefault(),h();break;case"ArrowRight":O.preventDefault(),le();break;case"ArrowUp":if(O.preventDefault(),!o.settings.textStyle.autoFontSize){const ge=o.settings.textStyle.fontSize;o.updateTextStyle({fontSize:ge+1})}break;case"ArrowDown":if(O.preventDefault(),!o.settings.textStyle.autoFontSize){const ge=o.settings.textStyle.fontSize;o.updateTextStyle({fontSize:Math.max(10,ge-1)})}break}}async function J(O){const ne=E.value;if(!ne||!ne.translatedDataURL){console.log(`è‡ªåŠ¨å­—å·è®¾ç½®å˜æ›´: ${O} (ä»…å½±å“ä¸‹æ¬¡ç¿»è¯‘)`);return}const be=ne.bubbleStates;if(!be||!Array.isArray(be)||be.length===0){console.log("å½“å‰å›¾ç‰‡æ²¡æœ‰ bubbleStatesï¼Œè·³è¿‡é‡æ¸²æŸ“");return}if(console.log(`è‡ªåŠ¨å­—å·è®¾ç½®å˜æ›´: ${O}ï¼Œå°†é‡æ–°æ¸²æŸ“...`),O){console.log("è‡ªåŠ¨å­—å·å·²å¼€å¯ï¼Œé‡æ–°è®¡ç®—å­—å·å¹¶æ¸²æŸ“...");try{const{apiClient:ge}=await rt(async()=>{const{apiClient:ye}=await import("./client.Bht704G-.js");return{apiClient:ye}},__vite__mapDeps([4,5]));let Pe="";if(ne.cleanImageData){const ye=ne.cleanImageData;Pe=ye.includes("base64,")?ye.split("base64,")[1]||"":ye}else ne.originalDataURL&&(Pe=ne.originalDataURL.includes("base64,")?ne.originalDataURL.split("base64,")[1]||"":ne.originalDataURL);if(!Pe){console.log("æ²¡æœ‰å¯ç”¨çš„èƒŒæ™¯å›¾ï¼Œè·³è¿‡é‡æ¸²æŸ“");return}const Ee=be.map(ye=>({translatedText:ye.translatedText||"",coords:ye.coords,fontSize:ye.fontSize||o.settings.textStyle.fontSize,fontFamily:ye.fontFamily||o.settings.textStyle.fontFamily,textDirection:Lt(ye),textColor:ye.textColor||o.settings.textStyle.textColor,rotationAngle:ye.rotationAngle||0,position:ye.position||{x:0,y:0},strokeEnabled:ye.strokeEnabled??o.settings.textStyle.strokeEnabled,strokeColor:ye.strokeColor||o.settings.textStyle.strokeColor,strokeWidth:ye.strokeWidth??o.settings.textStyle.strokeWidth})),Le=Ee.map(ye=>ye.translatedText),ke=Ee.map(ye=>ye.coords),Be=await ge.post("/api/re_render_image",{clean_image:Pe,bubble_texts:Le,bubble_coords:ke,fontSize:o.settings.textStyle.fontSize,fontFamily:o.settings.textStyle.fontFamily,textDirection:o.settings.textStyle.layoutDirection==="auto"?"vertical":o.settings.textStyle.layoutDirection,textColor:o.settings.textStyle.textColor,bubble_states:Ee,use_individual_styles:!0,use_inpainting:!1,use_lama:!1,fillColor:null,is_font_style_change:!0,autoFontSize:!0,strokeEnabled:o.settings.textStyle.strokeEnabled,strokeColor:o.settings.textStyle.strokeColor,strokeWidth:o.settings.textStyle.strokeWidth});if(Be.rendered_image){if(Be.bubble_states&&Array.isArray(Be.bubble_states)){const ye=be.map((it,Ge)=>({...it,fontSize:Be.bubble_states[Ge]?.fontSize??it.fontSize}));s.updateCurrentImage({translatedDataURL:`data:image/png;base64,${Be.rendered_image}`,bubbleStates:ye,hasUnsavedChanges:!0}),r.setBubbles(ye)}else s.updateCurrentImage({translatedDataURL:`data:image/png;base64,${Be.rendered_image}`,hasUnsavedChanges:!0});console.log("è‡ªåŠ¨å­—å·æ¸²æŸ“æˆåŠŸ")}else Be.error&&(console.error("è‡ªåŠ¨å­—å·æ¸²æŸ“å¤±è´¥:",Be.error),xe("é‡æ–°æ¸²æŸ“å¤±è´¥: "+Be.error,"error"))}catch(ge){console.error("è‡ªåŠ¨å­—å·æ¸²æŸ“å‡ºé”™:",ge)}}else{const ge=o.settings.textStyle.fontSize;console.log(`è‡ªåŠ¨å­—å·å·²å…³é—­ï¼Œä½¿ç”¨å›ºå®šå­—å· ${ge} æ¸²æŸ“...`);const Pe=be.map(Ee=>({...Ee,fontSize:ge}));s.updateCurrentImage({bubbleStates:Pe}),r.setBubbles(Pe),await ve("fontSize",ge)}}async function ve(O,ne){const be=E.value;if(!be||!be.translatedDataURL||!be.bubbleStates||be.bubbleStates.length===0||!["fontSize","fontFamily","layoutDirection","textColor","strokeEnabled","strokeColor","strokeWidth","fillColor"].includes(O))return;console.log(`å…¨å±€è®¾ç½®å˜æ›´ (${O}=${ne})ï¼Œå‡†å¤‡é‡æ¸²æŸ“...`);const Ee={fontSize:"fontSize",fontFamily:"fontFamily",layoutDirection:"textDirection",textColor:"textColor",strokeEnabled:"strokeEnabled",strokeColor:"strokeColor",strokeWidth:"strokeWidth",fillColor:"fillColor"}[O];if(Ee&&be.bubbleStates)if(O==="layoutDirection")if(ne==="auto"){console.log("æ’ç‰ˆæ–¹å‘è®¾ç½®ä¸º 'auto'ï¼Œä» autoTextDirection æ¢å¤æ¯ä¸ªæ°”æ³¡çš„æ’ç‰ˆæ–¹å‘");const Le=be.bubbleStates.map(ke=>({...ke,textDirection:ke.autoTextDirection==="vertical"||ke.autoTextDirection==="horizontal"?ke.autoTextDirection:"vertical"}));s.updateCurrentImage({bubbleStates:Le}),r.setBubbles(Le)}else{console.log(`æ’ç‰ˆæ–¹å‘è®¾ç½®ä¸º '${ne}'ï¼Œåº”ç”¨åˆ°æ‰€æœ‰æ°”æ³¡`);const Le=be.bubbleStates.map(ke=>({...ke,textDirection:ne}));s.updateCurrentImage({bubbleStates:Le}),r.setBubbles(Le)}else{const Le=be.bubbleStates.map(ke=>({...ke,[Ee]:ne}));s.updateCurrentImage({bubbleStates:Le}),r.setBubbles(Le)}try{const ke=s.currentImage?.bubbleStates||be.bubbleStates||[];if(ke.length===0||!ke[0]?.coords){console.log("æ²¡æœ‰æœ‰æ•ˆçš„æ°”æ³¡åæ ‡ï¼Œè·³è¿‡é‡æ¸²æŸ“");return}const Be=o.settings.textStyle.layoutDirection,ye=ke.map(N=>({translatedText:N.translatedText||"",coords:N.coords,fontSize:N.fontSize||o.settings.textStyle.fontSize,fontFamily:N.fontFamily||o.settings.textStyle.fontFamily,textDirection:Lt(N),textColor:N.textColor||o.settings.textStyle.textColor,rotationAngle:N.rotationAngle||0,position:N.position||{x:0,y:0},strokeEnabled:N.strokeEnabled??o.settings.textStyle.strokeEnabled,strokeColor:N.strokeColor||o.settings.textStyle.strokeColor,strokeWidth:N.strokeWidth??o.settings.textStyle.strokeWidth})),it=ye.map(N=>N.translatedText),Ge=ye.map(N=>N.coords);let Ze="";if(be.cleanImageData){const N=be.cleanImageData;Ze=N.includes("base64,")?N.split("base64,")[1]||"":N}else be.originalDataURL&&(Ze=be.originalDataURL.includes("base64,")?be.originalDataURL.split("base64,")[1]||"":be.originalDataURL,console.log("handleTextStyleChanged: ä½¿ç”¨åŸå›¾ä½œä¸ºèƒŒæ™¯ï¼ˆå…œåº•ï¼‰"));if(!Ze){console.log("æ²¡æœ‰å¯ç”¨çš„èƒŒæ™¯å›¾ï¼Œè·³è¿‡é‡æ¸²æŸ“");return}const{apiClient:st}=await rt(async()=>{const{apiClient:N}=await import("./client.Bht704G-.js");return{apiClient:N}},__vite__mapDeps([4,5])),Ae=await st.post("/api/re_render_image",{clean_image:Ze,bubble_texts:it,bubble_coords:Ge,fontSize:o.settings.textStyle.fontSize,fontFamily:o.settings.textStyle.fontFamily,textDirection:Be==="auto"?"vertical":Be,textColor:o.settings.textStyle.textColor,bubble_states:ye,use_individual_styles:!0,use_inpainting:!1,use_lama:!1,fillColor:null,is_font_style_change:!0,strokeEnabled:o.settings.textStyle.strokeEnabled,strokeColor:o.settings.textStyle.strokeColor,strokeWidth:o.settings.textStyle.strokeWidth});Ae.rendered_image?(s.updateCurrentImage({translatedDataURL:`data:image/png;base64,${Ae.rendered_image}`,hasUnsavedChanges:!0}),console.log("è®¾ç½®å˜æ›´åé‡æ–°æ¸²æŸ“æˆåŠŸ")):Ae.error&&console.error("é‡æ–°æ¸²æŸ“å¤±è´¥:",Ae.error)}catch(Le){console.error("è®¾ç½®å˜æ›´åé‡æ–°æ¸²æŸ“å¤±è´¥:",Le)}}function fe(O){k.switchImage(O)}return(O,ne)=>{const be=ys("router-link");return B(),A("div",{class:Ie(["translate-page",{"edit-mode-active":M.value}])},[e("header",ay,[e("div",ly,[e("div",iy,[Se(be,{to:"/",title:"è¿”å›ä¹¦æ¶"},{default:St(()=>[...ne[3]||(ne[3]=[e("img",{src:"/pic/logo.png",alt:"Saber-Translator Logo",class:"app-logo"},null,-1),e("span",{class:"app-name"},"Saber-Translator",-1)])]),_:1})]),e("div",ry,[Se(be,{to:"/",class:"back-to-shelf",title:"è¿”å›ä¹¦æ¶"},{default:St(()=>[...ne[4]||(ne[4]=[me("ğŸ“š",-1)])]),_:1}),U.value?(B(),A("button",{key:0,class:"save-header-btn",title:"ä¿å­˜è¿›åº¦",onClick:ce}," ğŸ’¾ ")):de("",!0),e("button",{id:"openSettingsBtn",class:"settings-header-btn",title:"æ‰“å¼€è®¾ç½®",onClick:ne[0]||(ne[0]=ge=>_e())},[...ne[5]||(ne[5]=[e("span",{class:"icon"},"âš™ï¸",-1),e("span",null,"è®¾ç½®",-1)])]),ne[8]||(ne[8]=e("a",{href:"http://www.mashirosaber.top",target:"_blank",class:"tutorial-link"},"ä½¿ç”¨æ•™ç¨‹",-1)),e("a",{href:"javascript:void(0)",class:"donate-link",onClick:he},[...ne[6]||(ne[6]=[e("span",null,"â¤ï¸ è¯·ä½œè€…å–å¥¶èŒ¶",-1)])]),ne[9]||(ne[9]=e("a",{href:"https://github.com/MashiroSaber03",target:"_blank",class:"github-link"},[e("img",{src:"/pic/github.jpg",alt:"GitHub",class:"github-icon"})],-1)),e("button",{class:"theme-toggle",title:"åŠŸèƒ½å¼€å‘ä¸­",onClick:te},[...ne[7]||(ne[7]=[e("span",{class:"theme-icon"},"â˜€ï¸",-1)])])])])]),e("div",uy,[Se(Il,{onTranslateCurrent:I,onTranslateAll:F,onTranslateRange:D,onHqTranslate:y,onHqTranslateRange:S,onProofread:m,onProofreadRange:w,onRemoveText:l,onRemoveAllText:v,onRemoveTextRange:W,onRetryFailed:G,onDeleteCurrent:Z,onClearAll:Y,onCleanTemp:c,onOpenPlugins:De,onOpenSettings:_e,onPrevious:h,onNext:le,onApplyToAll:R,onTextStyleChanged:ve,onAutoFontSizeChanged:J}),e("main",cy,[e("section",dy,[e("div",gy,[Se(ma,{ref:"imageUploadRef",onUploadComplete:z},null,512)]),H(i).loadingProgress.total>0?(B(),ut(Co,{key:0,visible:!0,percentage:H(i).loadingProgress.current/H(i).loadingProgress.total*100,label:H(i).loadingProgress.message},null,8,["percentage","label"])):de("",!0),Se(rr,{progress:H(p).progress.value},null,8,["progress"]),j.value&&U.value?(B(),A("div",py,[...ne[10]||(ne[10]=[e("span",{style:{color:"#888","font-size":"0.85em"}}," ï¼ˆä¹¦æ¶æ¨¡å¼ä¸‹é€€å‡ºå‰è¯·ç‚¹å‡»é¡¶éƒ¨ä¿å­˜æŒ‰é’®ï¼‰ ",-1)])])):de("",!0)]),Se(Gl,{ref:"imageResultRef","is-edit-mode":M.value,onToggleEditMode:T,onRetryFailed:G},null,8,["is-edit-mode"])]),$.value&&!M.value?(B(),ut(Ur,{key:0,onSelect:fe})):de("",!0)]),E.value&&M.value?(B(),ut(xf,{key:0,"is-edit-mode-active":M.value,onExit:T},null,8,["is-edit-mode-active"])):de("",!0),Se(oi,{onOpenSettings:_e}),Se(dm,{modelValue:f.value,"onUpdate:modelValue":ne[1]||(ne[1]=ge=>f.value=ge),"initial-tab":P.value,onSave:$e},null,8,["modelValue","initial-tab"]),L.value?(B(),ut(cr,{key:1,onClose:ne[2]||(ne[2]=ge=>L.value=!1)})):de("",!0),Se(sy),Se(Yh)],2)}}}),ky=He(my,[["__scopeId","data-v-626f57c5"]]);export{ky as default};
