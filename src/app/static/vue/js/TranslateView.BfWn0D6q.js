const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["js/system.CnmiUywH.js","js/index.DzZXm8vf.js","js/vue-vendor.Q3dK6xSR.js","assets/index.BYanE9pL.css","js/client.Bht704G-.js","js/utils-vendor.B9ygI19o.js","js/session.C_VZSWrV.js"])))=>i.map(i=>d[i]);
import{D as co,b as go,c as po,d as mn,e as xt,a as rt,_ as je,f as Fe,s as ye,u as ct,g as os,h as ns,i as ss,j as jo,k as Yo,l as Jo,m as Xo,B as Go,n as Zo,o as as,F as ao,p as Qo,q as en,r as ls,L as tn}from"./index.DzZXm8vf.js";import{d as mo,r as C,c as Q,a as Ye,e as U,h as fe,f as e,t as se,i as at,k as A,g as ut,n as Ee,u as Ue,o as dt,v as ne,x as Oe,l as xe,s as on,m as Ct,K as nt,D as re,F as We,j as Qe,M as vo,N as is,L as vn,w as _e,B as pt,O as Tt,z as ke,p as it,P as ro,b as Ut,Q as kt,S as nn,C as rs}from"./vue-vendor.Q3dK6xSR.js";import{p as us,a as cs,b as ds,c as gs,d as ps,e as ms,f as vs,h as fs,i as bs,j as hs,k as fo,l as fn}from"./system.CnmiUywH.js";import{getFontList as bn,uploadFont as ys,getTextboxPrompts as xs,getPrompts as Ss,configApi as qe,getFontListApi as _s}from"./config.CwRcCkM9.js";import{_ as Ne}from"./CustomSelect.vue_vue_type_style_index_0_lang.45-uOCZr.js";import{apiClient as Je}from"./client.Bht704G-.js";import{B as hn}from"./BaseModal.ZlkRfArU.js";import{getBookDetail as Cs}from"./bookshelf.B4ums9uK.js";import"./utils-vendor.B9ygI19o.js";async function bo(s){return Je.post("/api/re_render_image",s)}async function ks(s){try{return{success:!0,data:await Je.post("/api/translate_single_text",s)}}catch(t){return{success:!1,error:t instanceof Error?t.message:"ç¿»è¯‘å¤±è´¥"}}}async function Et(s){return Je.post("/api/hq_translate_batch",s)}async function uo(s,t,n){return Je.post("/api/detect_boxes",{image:s,detector_type:t,...n})}async function yn(s,t,n,o){return Je.post("/api/ocr_single_bubble",{image_data:s,bubble_coords:t,ocr_engine:n,...o})}async function ho(s,t,n){return Je.post("/api/inpaint_single_bubble",{image_data:s,bubble_coords:t,bubble_angle:n?.bubbleAngle??0,method:n?.method??"lama",lama_model:n?.lamaModel??"lama_mpe",...n?.maskData&&{mask_data:n.maskData}})}const ws=Object.freeze(Object.defineProperty({__proto__:null,detectBoxes:uo,hqTranslateBatch:Et,inpaintSingleBubble:ho,ocrSingleBubble:yn,reRenderImage:bo,translateSingleText:ks},Symbol.toStringTag,{value:"Module"}));async function xn(s,t){return Je.post(`/api/sessions/meta/${s}`,t)}async function qt(s,t,n,o){return Je.post(`/api/sessions/page/${s}/${t}/${n}`,{data:o})}async function Sn(s,t,n){return Je.post(`/api/sessions/page/${s}/${t}/meta`,n)}async function _n(s,t,n){return Je.post(`/api/sessions/save_translated/${s}/${t}`,n)}function Kt(s){if(!s||typeof s!="string"||s.startsWith("/api/"))return null;if(s.startsWith("data:")){const t=s.split(",");return t.length>1?t[1]??null:null}return s}async function Ts(s,t,n){const o=t.length;let i=0;for(let r=0;r<o;r++){const a=t[r];if(a){n?.onProgress?.(r+1,o);try{const u=Kt(a.originalDataURL);u&&await qt(s,r,"original",u);const g=Kt(a.translatedDataURL);g&&await qt(s,r,"translated",g);const S=Kt(a.cleanImageData);S&&await qt(s,r,"clean",S);const x={fileName:a.fileName,translationStatus:a.translationStatus,translationFailed:a.translationFailed,bubbleStates:a.bubbleStates,isManuallyAnnotated:a.isManuallyAnnotated,relativePath:a.relativePath,folderPath:a.folderPath,fontSize:a.fontSize,autoFontSize:a.autoFontSize,fontFamily:a.fontFamily,layoutDirection:a.layoutDirection,useAutoTextColor:a.useAutoTextColor,textColor:a.textColor,fillColor:a.fillColor,inpaintMethod:a.inpaintMethod,strokeEnabled:a.strokeEnabled,strokeColor:a.strokeColor,strokeWidth:a.strokeWidth};await Sn(s,r,x),i++}catch(u){console.error(`ä¿å­˜ç¬¬ ${r+1} é¡µå¤±è´¥:`,u)}}}return i}const Cn=Object.freeze(Object.defineProperty({__proto__:null,extractBase64:Kt,saveAllPagesSequentially:Ts,savePageImage:qt,savePageMeta:Sn,saveSessionMeta:xn,saveTranslatedPage:_n},Symbol.toStringTag,{value:"Module"}));async function $s(){return Je.get("/api/plugins")}async function Is(s){const t=encodeURIComponent(s);return Je.post(`/api/plugins/${t}/enable`)}async function Rs(s){const t=encodeURIComponent(s);return Je.post(`/api/plugins/${t}/disable`)}async function Ps(s){const t=encodeURIComponent(s);return Je.delete(`/api/plugins/${t}`)}async function Ds(s){const t=encodeURIComponent(s);return Je.get(`/api/plugins/${t}/config_schema`)}async function Ms(s){const t=encodeURIComponent(s);return Je.get(`/api/plugins/${t}/config`)}async function Bs(s,t){const n=encodeURIComponent(s);return Je.post(`/api/plugins/${n}/config`,t)}async function Es(){return Je.get("/api/plugins/default_states")}async function As(s,t){const n=encodeURIComponent(s);return Je.post(`/api/plugins/${n}/set_default_state`,{enabled:t})}async function Ls(){return{states:(await Es()).default_states}}const Fs=As,Us=Ds,zs=Ms,Os=Bs;function Vs(){return`img_${Date.now()}_${Math.random().toString(36).substring(2,9)}`}function sn(s,t,n){return{id:Vs(),fileName:s,originalDataURL:t,translatedDataURL:null,cleanImageData:null,bubbleStates:null,translationStatus:"pending",translationFailed:!1,fontSize:25,autoFontSize:!1,fontFamily:xt,layoutDirection:"auto",textColor:"#000000",fillColor:mn,inpaintMethod:"solid",strokeEnabled:po,strokeColor:go,strokeWidth:co,hasUnsavedChanges:!1,...n}}const ot=mo("image",()=>{const s=C([]),t=C(-1),n=C(!1),o=Q(()=>t.value>=0&&t.value<s.value.length?s.value[t.value]??null:null),i=Q(()=>s.value.length),r=Q(()=>s.value.length>0),a=Q(()=>t.value>0),u=Q(()=>t.value<s.value.length-1),g=Q(()=>s.value.filter(c=>c.translationFailed).length),S=Q(()=>s.value.filter(c=>c.translationStatus==="completed").length),x=Q(()=>s.value.filter(c=>c.translationStatus==="pending").length);function _(c,m,l){const p=sn(c,m,l);return s.value.push(p),s.value.length===1&&(t.value=0),console.log(`å›¾ç‰‡å·²æ·»åŠ : ${c}ï¼Œå½“å‰å…± ${s.value.length} å¼ å›¾ç‰‡`),p}function D(c){const m=c.map(({fileName:p,originalDataURL:$,overrides:w})=>sn(p,$,w)),l=s.value.length===0;return s.value.push(...m),l&&s.value.length>0&&(t.value=0),console.log(`æ‰¹é‡æ·»åŠ äº† ${m.length} å¼ å›¾ç‰‡ï¼Œå½“å‰å…± ${s.value.length} å¼ `),m}function R(c){s.value=c.map(m=>({...m,strokeEnabled:m.strokeEnabled??po,strokeColor:m.strokeColor||go,strokeWidth:m.strokeWidth??co,hasUnsavedChanges:m.hasUnsavedChanges||!1})),s.value.length>0?t.value=Math.min(Math.max(0,t.value),s.value.length-1):t.value=-1,console.log(`å›¾ç‰‡æ•°ç»„å·²è®¾ç½®ï¼Œå…± ${s.value.length} å¼ å›¾ç‰‡`)}function M(c){return c<0||c>=s.value.length?(console.warn(`åˆ é™¤å¤±è´¥: æ— æ•ˆçš„ç´¢å¼• ${c}`),!1):(s.value.splice(c,1),t.value===c?(t.value=Math.min(c,s.value.length-1),s.value.length===0&&(t.value=-1)):t.value>c&&t.value--,console.log(`å›¾ç‰‡å·²åˆ é™¤ï¼Œå½“å‰å…± ${s.value.length} å¼ å›¾ç‰‡`),!0)}function k(){return M(t.value)}function Y(){s.value=[],t.value=-1,n.value=!1,console.log("æ‰€æœ‰å›¾ç‰‡å·²æ¸…é™¤")}function V(){const c=o.value?.id||null;if(s.value.sort((m,l)=>m.fileName.localeCompare(l.fileName,void 0,{numeric:!0,sensitivity:"base"})),c){const m=s.value.findIndex(l=>l.id===c);m>=0&&m!==t.value&&(console.log(`å›¾ç‰‡æ’åº: currentImageIndex ä» ${t.value} æ›´æ–°ä¸º ${m}`),t.value=m)}console.log("å›¾ç‰‡å·²æŒ‰æ–‡ä»¶åæ’åº")}function L(c){c>=-1&&c<s.value.length?(t.value=c,console.log(`å½“å‰å›¾ç‰‡ç´¢å¼•å·²è®¾ç½®ä¸º ${c}`)):console.warn(`è®¾ç½®ç´¢å¼•å¤±è´¥: æ— æ•ˆçš„ç´¢å¼• ${c}`)}function v(){return a.value?(t.value--,!0):!1}function d(){return u.value?(t.value++,!0):!1}function h(c){o.value?(Object.assign(o.value,c),console.log("å½“å‰å›¾ç‰‡å±æ€§å·²æ›´æ–°:",Object.keys(c))):console.warn("æ›´æ–°å¤±è´¥: å½“å‰æ²¡æœ‰é€‰ä¸­çš„å›¾ç‰‡")}function y(c,m){if(c>=0&&c<s.value.length){const l=s.value[c];l&&(Object.assign(l,m),console.log(`å›¾ç‰‡ ${c} å±æ€§å·²æ›´æ–°:`,Object.keys(m)))}else console.warn(`æ›´æ–°å¤±è´¥: æ— æ•ˆçš„ç´¢å¼• ${c}`)}function z(c){o.value&&(o.value.bubbleStates=c,o.value.hasUnsavedChanges=!0,console.log(`å½“å‰å›¾ç‰‡æ°”æ³¡çŠ¶æ€å·²æ›´æ–°ï¼Œå…± ${c?.length??0} ä¸ªæ°”æ³¡`))}function F(c){o.value&&(o.value.isManuallyAnnotated=c,o.value.hasUnsavedChanges=!0,console.log(`æ‰‹åŠ¨æ ‡æ³¨æ ‡è®°å·²è®¾ç½®ä¸º: ${c}`))}function te(c,m){o.value?(o.value[c]=m,o.value.hasUnsavedChanges=!0,console.log(`å½“å‰å›¾ç‰‡å±æ€§ ${String(c)} å·²æ›´æ–°`)):console.warn("æ›´æ–°å¤±è´¥: å½“å‰æ²¡æœ‰é€‰ä¸­çš„å›¾ç‰‡")}function J(c,m){o.value&&(o.value.translatedDataURL=c,m&&(o.value.cleanImageData=m),o.value.translationStatus="completed",o.value.translationFailed=!1,o.value.hasUnsavedChanges=!0,console.log("å½“å‰å›¾ç‰‡ç¿»è¯‘ç»“æœå·²æ›´æ–°"))}function K(c,m,l){if(c>=0&&c<s.value.length){const p=s.value[c];p&&(p.translationStatus=m,p.translationFailed=m==="failed",l&&(p.errorMessage=l),console.log(`å›¾ç‰‡ ${c} ç¿»è¯‘çŠ¶æ€: ${m}`))}}function Z(c){o.value&&(o.value.translationStatus="failed",o.value.translationFailed=!0,o.value.errorMessage=c,console.log(`å½“å‰å›¾ç‰‡ç¿»è¯‘å¤±è´¥: ${c}`))}function W(){s.value.forEach(c=>{c.translationStatus="pending",c.translationFailed=!1,c.errorMessage=void 0}),console.log("æ‰€æœ‰å›¾ç‰‡ç¿»è¯‘çŠ¶æ€å·²é‡ç½®")}function oe(c){n.value=c,console.log(`æ‰¹é‡ç¿»è¯‘çŠ¶æ€: ${c?"è¿›è¡Œä¸­":"å·²å®Œæˆ"}`)}function b(){return s.value.map((c,m)=>c.translationFailed?m:-1).filter(c=>c!==-1)}return{images:s,currentImageIndex:t,isBatchTranslationInProgress:n,currentImage:o,imageCount:i,hasImages:r,canGoPrevious:a,canGoNext:u,failedImageCount:g,completedImageCount:S,pendingImageCount:x,addImage:_,addImages:D,setImages:R,deleteImage:M,deleteCurrentImage:k,clearImages:Y,sortImagesByFileName:V,setCurrentImageIndex:L,goToPrevious:v,goToNext:d,updateCurrentImage:h,updateImageByIndex:y,updateCurrentBubbleStates:z,setManuallyAnnotated:F,updateCurrentImageProperty:te,updateCurrentTranslationResult:J,setTranslationStatus:K,markCurrentAsFailed:Z,resetAllTranslationStatus:W,setBatchTranslationInProgress:oe,getFailedImageIndices:b}}),an=Object.freeze(Object.defineProperty({__proto__:null,useImageStore:ot},Symbol.toStringTag,{value:"Module"})),It=mo("session",()=>{const s=C(null),t=C({bookId:null,chapterId:null,bookTitle:null,chapterTitle:null}),n=C([]),o=C(!1),i=C({current:0,total:0,message:""}),r=C(null),a=C(!1),u=Q(()=>t.value.bookId!==null&&t.value.chapterId!==null),g=Q(()=>t.value.bookId),S=Q(()=>t.value.chapterId);function x(Z,W,oe=null,b=null){t.value={bookId:Z,chapterId:W,bookTitle:oe,chapterTitle:b},console.log(`ä¼šè¯ä¸Šä¸‹æ–‡å·²è®¾ç½®: ä¹¦ç±=${Z}, ç« èŠ‚=${W}`)}function _(Z,W,oe,b){x(Z,W,oe,b)}function D(){t.value={bookId:null,chapterId:null,bookTitle:null,chapterTitle:null},console.log("ä¼šè¯ä¸Šä¸‹æ–‡å·²æ¸…é™¤")}function R(Z){const W=Z.get("book"),oe=Z.get("chapter");W&&oe&&x(W,oe)}function M(Z){s.value=Z,console.log(`å½“å‰ä¼šè¯åç§°: ${Z}`)}function k(){s.value=null}function Y(Z){n.value=Z,console.log(`ä¼šè¯åˆ—è¡¨å·²æ›´æ–°ï¼Œå…± ${Z.length} ä¸ªä¼šè¯`)}function V(Z){const W=n.value.findIndex(oe=>oe.name===Z.name);W>=0?n.value[W]=Z:n.value.unshift(Z)}function L(Z){const W=n.value.findIndex(oe=>oe.name===Z);W>=0&&n.value.splice(W,1)}function v(Z,W){const oe=n.value.find(b=>b.name===Z);oe&&(oe.name=W)}function d(Z){o.value=Z}function h(Z){a.value=Z}function y(Z){r.value=Z}function z(){s.value=null,t.value={bookId:null,chapterId:null,bookTitle:null,chapterTitle:null},n.value=[],o.value=!1,a.value=!1,r.value=null,console.log("ä¼šè¯çŠ¶æ€å·²é‡ç½®")}async function F(Z){if(!Z||typeof Z!="string")return null;if(Z.startsWith("data:"))return Z;if(!Z.startsWith("/api/"))return null;try{const W=await fetch(Z);if(!W.ok)return null;const oe=await W.blob();return new Promise(b=>{const c=new FileReader;c.onloadend=()=>b(c.result),c.onerror=()=>b(null),c.readAsDataURL(oe)})}catch(W){return console.error(`è½¬æ¢å›¾ç‰‡ URL å¤±è´¥: ${Z}`,W),null}}async function te(Z,W){const oe=Z.length;for(let b=0;b<oe;b++){const c=Z[b];if(c){if(W&&W(b+1,oe),c.originalDataURL&&c.originalDataURL.startsWith("/api/")){const m=await F(c.originalDataURL);m&&(c.originalDataURL=m)}if(c.translatedDataURL&&c.translatedDataURL.startsWith("/api/")){const m=await F(c.translatedDataURL);m&&(c.translatedDataURL=m)}if(c.cleanImageData&&c.cleanImageData.startsWith("/api/")){const m=await F(c.cleanImageData);m&&(c.cleanImageData=m.replace(/^data:image\/\w+;base64,/,""))}}}}async function J(Z){d(!0),y(null),i.value={current:0,total:0,message:"æ­£åœ¨åŠ è½½..."};try{const{useImageStore:W}=await rt(async()=>{const{useImageStore:O}=await Promise.resolve().then(()=>an);return{useImageStore:O}},void 0),{useSettingsStore:oe}=await rt(async()=>{const{useSettingsStore:O}=await import("./system.CnmiUywH.js").then(ee=>ee.s);return{useSettingsStore:O}},__vite__mapDeps([0,1,2,3,4,5])),{useBubbleStore:b}=await rt(async()=>{const{useBubbleStore:O}=await Promise.resolve().then(()=>Gl);return{useBubbleStore:O}},void 0),c=W(),m=oe(),l=b(),{loadSessionByPathApi:p}=await rt(async()=>{const{loadSessionByPathApi:O}=await import("./session.C_VZSWrV.js");return{loadSessionByPathApi:O}},__vite__mapDeps([6,4,5])),$=await p(Z);if(!$.success||!$.session)throw new Error($.error||"åŠ è½½ä¼šè¯å¤±è´¥");const w=$.session;if(w.images&&w.images.length>0){const O=w.images.map((I,q)=>({id:`session-${q}-${Date.now()}`,originalDataURL:I.originalDataURL,translatedDataURL:I.translatedDataURL||null,cleanImageData:I.cleanImageData||null,bubbleStates:I.bubbleStates!==void 0&&I.bubbleStates!==null?I.bubbleStates:null,isManuallyAnnotated:!!I.isManuallyAnnotated,relativePath:I.relativePath||void 0,folderPath:I.folderPath||void 0,fileName:I.fileName||`image-${q+1}.png`,translationStatus:I.translationStatus||"pending",translationFailed:!!I.translationFailed,hasUnsavedChanges:!1,fontSize:I.fontSize||24,autoFontSize:I.autoFontSize??!1,fontFamily:I.fontFamily||"Microsoft YaHei",layoutDirection:I.layoutDirection||"auto",useAutoTextColor:I.useAutoTextColor??void 0,textColor:I.textColor||"#000000",fillColor:I.fillColor||"#FFFFFF",inpaintMethod:I.inpaintMethod||"litelama",strokeEnabled:I.strokeEnabled??!1,strokeColor:I.strokeColor||"#FFFFFF",strokeWidth:I.strokeWidth||2}));O.length>0&&(console.log("æ­£åœ¨åŠ è½½å›¾ç‰‡..."),i.value={current:0,total:O.length,message:"æ­£åœ¨åŠ è½½å›¾ç‰‡..."},await te(O,(I,q)=>{const ae=I/q*100;i.value={current:I,total:q,message:`åŠ è½½å›¾ç‰‡ ${I}/${q}...`},console.log(`åŠ è½½å›¾ç‰‡ ${I}/${q}... (${ae.toFixed(0)}%)`)}),i.value={current:O.length,total:O.length,message:"åŠ è½½å®Œæˆ"},console.log("å›¾ç‰‡åŠ è½½å®Œæˆï¼Œå·²è½¬æ¢ä¸º Base64"),setTimeout(()=>{i.value={current:0,total:0,message:""}},500)),c.setImages(O);let ee=0;typeof w.currentImageIndex=="number"&&(ee=w.currentImageIndex,(ee>=O.length||ee<0)&&(ee=O.length>0?0:-1)),c.setCurrentImageIndex(ee);const le=O[ee];le&&le.bubbleStates&&le.bubbleStates.length>0?l.setBubbles(le.bubbleStates,!0):l.clearBubblesLocal(),console.log(`æŒ‰è·¯å¾„åŠ è½½ä¼šè¯æˆåŠŸ: ${Z}, å…± ${O.length} å¼ å›¾ç‰‡`)}const P=w.ui_settings;if(P){(P.targetLanguage||P.sourceLanguage)&&m.updateSettings({targetLanguage:P.targetLanguage||void 0,sourceLanguage:P.sourceLanguage||void 0});const O=P.useInpaintingMethod,le=["solid","lama_mpe","litelama"].includes(O)?O:m.settings.textStyle.inpaintMethod;m.updateTextStyle({fontSize:P.fontSize||m.settings.textStyle.fontSize,autoFontSize:P.autoFontSize??m.settings.textStyle.autoFontSize,fontFamily:P.fontFamily||m.settings.textStyle.fontFamily,layoutDirection:P.layoutDirection||m.settings.textStyle.layoutDirection,textColor:P.textColor||m.settings.textStyle.textColor,fillColor:P.fillColor||m.settings.textStyle.fillColor,inpaintMethod:le,strokeEnabled:P.strokeEnabled??m.settings.textStyle.strokeEnabled,strokeColor:P.strokeColor||m.settings.textStyle.strokeColor,strokeWidth:P.strokeWidth||m.settings.textStyle.strokeWidth,useAutoTextColor:P.useAutoTextColor??m.settings.textStyle.useAutoTextColor}),console.log("UI è®¾ç½®å·²æ¢å¤")}return M(Z),!0}catch(W){const oe=W instanceof Error?W.message:"åŠ è½½ä¼šè¯å¤±è´¥";throw y(oe),console.error(`æŒ‰è·¯å¾„åŠ è½½ä¼šè¯å¤±è´¥: ${Z}`,W),W}finally{d(!1)}}async function K(Z,W){if(!Z||!W)return console.log("æœªåœ¨ä¹¦ç±/ç« èŠ‚æ¨¡å¼ï¼Œä¸æ”¯æŒä¿å­˜"),!1;console.log(`ä¿å­˜ç« èŠ‚ä¼šè¯: book=${Z}, chapter=${W}`);const{useImageStore:oe}=await rt(async()=>{const{useImageStore:w}=await Promise.resolve().then(()=>an);return{useImageStore:w}},void 0),{useSettingsStore:b}=await rt(async()=>{const{useSettingsStore:w}=await import("./system.CnmiUywH.js").then(P=>P.s);return{useSettingsStore:w}},__vite__mapDeps([0,1,2,3,4,5])),c=oe(),m=b(),l=Array.isArray(c.images)?c.images:[];if(!l||l.length===0)return console.log("æ²¡æœ‰å›¾ç‰‡æ•°æ®å¯ä¿å­˜"),!1;const p=`bookshelf/${Z}/${W}`;h(!0),y(null);const $=l.length;i.value={current:0,total:$,message:`å‡†å¤‡ä¿å­˜ ${$} å¼ å›¾ç‰‡...`};try{l.some(q=>q.originalDataURL&&q.originalDataURL.startsWith("/api/")||q.translatedDataURL&&q.translatedDataURL.startsWith("/api/")||q.cleanImageData&&q.cleanImageData.startsWith("/api/"))&&(console.log("[saveChapterSession] æ£€æµ‹åˆ° /api/ URL æ ¼å¼å›¾ç‰‡ï¼Œå¼€å§‹è½¬æ¢ä¸º Base64..."),i.value={current:0,total:$,message:"è½¬æ¢å›¾ç‰‡æ ¼å¼..."},await te(l,(q,ae)=>{i.value={current:0,total:$,message:`è½¬æ¢å›¾ç‰‡ ${q}/${ae}...`}}),console.log("[saveChapterSession] å›¾ç‰‡æ ¼å¼è½¬æ¢å®Œæˆ"));const{textStyle:P}=m.settings,O={fontSize:P.fontSize,autoFontSize:P.autoFontSize,fontFamily:P.fontFamily,layoutDirection:P.layoutDirection,textColor:P.textColor,useInpaintingMethod:P.inpaintMethod,fillColor:P.fillColor,strokeEnabled:P.strokeEnabled,strokeColor:P.strokeColor,strokeWidth:P.strokeWidth,useAutoTextColor:P.useAutoTextColor},{saveAllPagesSequentially:ee,saveSessionMeta:le}=await rt(async()=>{const{saveAllPagesSequentially:q,saveSessionMeta:ae}=await Promise.resolve().then(()=>Cn);return{saveAllPagesSequentially:q,saveSessionMeta:ae}},void 0),I=await ee(p,l,{onProgress:(q,ae)=>{i.value={current:q,total:ae,message:`ä¿å­˜å›¾ç‰‡ ${q}/${ae}...`}}});i.value={current:$,total:$,message:"å®Œæˆä¿å­˜..."},await le(p,{ui_settings:O,total_pages:$,currentImageIndex:c.currentImageIndex}),console.log(`ç« èŠ‚ä¿å­˜å®Œæˆ: ${I}/${$} å¼ å›¾ç‰‡`);try{const{apiClient:q}=await rt(async()=>{const{apiClient:ae}=await import("./client.Bht704G-.js");return{apiClient:ae}},__vite__mapDeps([4,5]));await q.put(`/api/bookshelf/books/${Z}/chapters/${W}/image-count`,{count:$})}catch(q){console.warn("æ›´æ–°ç« èŠ‚å›¾ç‰‡æ•°é‡å¤±è´¥ï¼ˆéè‡´å‘½ï¼‰:",q)}return i.value={current:$,total:$,message:"ä¿å­˜å®Œæˆ"},setTimeout(()=>{i.value={current:0,total:0,message:""}},1e3),!0}catch(w){const P=w instanceof Error?w.message:"ä¿å­˜ç« èŠ‚ä¼šè¯å¤±è´¥";return y(P),console.error("ä¿å­˜å¤±è´¥:",w),i.value={current:0,total:0,message:""},!1}finally{h(!1)}}return{currentSessionName:s,context:t,sessionList:n,isLoading:o,isSaving:a,error:r,loadingProgress:i,isBookshelfMode:u,currentBookId:g,currentChapterId:S,setContext:x,clearContext:D,parseContextFromUrl:R,setSessionName:M,clearSessionName:k,setSessionList:Y,addToSessionList:V,removeFromSessionList:L,renameInSessionList:v,setLoading:d,setSaving:h,setError:y,imageUrlToBase64:F,saveChapterSession:K,loadSessionByPath:J,setBookChapterContext:_,reset:z}}),zt={originalText:"",translatedText:"",textboxText:"",coords:[0,0,100,100],polygon:[],fontSize:25,fontFamily:xt,textDirection:"vertical",autoTextDirection:"vertical",textColor:"#000000",fillColor:mn,rotationAngle:0,position:{x:0,y:0},strokeEnabled:po,strokeColor:go,strokeWidth:co,inpaintMethod:"solid",autoFgColor:null,autoBgColor:null,colorConfidence:0};function Ns(s){return{...{...zt,...s},coords:s?.coords?[...s.coords]:[...zt.coords],polygon:s?.polygon?s.polygon.map(n=>[...n]):[],position:s?.position?{...zt.position,...s.position}:{...zt.position}}}function Ws(s){const[t,n,o,i]=s,r=Math.abs(o-t);return Math.abs(i-n)>r?"vertical":"horizontal"}function Ot(s){return s.map(t=>({...t,coords:[...t.coords],polygon:t.polygon?t.polygon.map(n=>[...n]):[],position:{...t.position},autoFgColor:t.autoFgColor?[...t.autoFgColor]:null,autoBgColor:t.autoBgColor?[...t.autoBgColor]:null}))}function qs(s){if(!s||typeof s!="object")return!1;const t=s;if(!Array.isArray(t.coords)||t.coords.length!==4||!t.coords.every(i=>typeof i=="number"&&!isNaN(i))||typeof t.fontSize!="number"||t.fontSize<=0)return!1;const n=["vertical","horizontal","auto"];if(typeof t.textDirection!="string"||!n.includes(t.textDirection))return!1;const o=["solid","lama_mpe","litelama"];return!(typeof t.inpaintMethod!="string"||!o.includes(t.inpaintMethod))}function Ks(s){let t=s,n=0,o=0,i=Date.now();const r=()=>t<=0?0:Math.ceil(6e4/t);return{async acquire(){if(t<=0)return;const a=Date.now(),u=r();if(a-i>=6e4&&(i=a,o=0),o>=t){const S=6e4-(a-i);S>0&&await ln(S),i=Date.now(),o=0}const g=a-n;g<u&&await ln(u-g),n=Date.now(),o++},reset(){n=0,o=0,i=Date.now()},getRpm(){return t},setRpm(a){t=a,this.reset()}}}function ln(s){return new Promise(t=>setTimeout(t,s))}function rn(s){const t=s.replace(/\\/g,"/"),n=[],o=/(\d+)/g;let i=0,r;for(;(r=o.exec(t))!==null;){if(r.index>i){const a=t.slice(i,r.index);a&&n.push([!0,a.toLowerCase()])}n.push([!1,parseInt(r[0],10)]),i=o.lastIndex}if(i<t.length){const a=t.slice(i);a&&n.push([!0,a.toLowerCase()])}return n}function Hs(s,t){const n=rn(s),o=rn(t),i=Math.min(n.length,o.length);for(let r=0;r<i;r++){const[a,u]=n[r],[g,S]=o[r];if(a!==g)return a?1:-1;if(u<S)return-1;if(u>S)return 1}return n.length-o.length}function js(s,t=n=>String(n)){return[...s].sort((n,o)=>Hs(t(n),t(o)))}const Ys={key:0,class:"translation-progress-bar"},Js={class:"progress-bar-label"},Xs={class:"progress-bar"},Gs=Ye({__name:"ProgressBar",props:{visible:{type:Boolean,default:!0},percentage:{},label:{default:"è¿›åº¦"}},setup(s){return(t,n)=>s.visible?(A(),U("div",Ys,[e("div",Js,se(s.label),1),e("div",Xs,[e("div",{class:"progress",style:at({width:`${s.percentage}%`})},null,4)])])):fe("",!0)}}),yo=je(Gs,[["__scopeId","data-v-f915cadf"]]),Zs={class:"image-upload"},Qs={class:"error-text"},ea={key:2,class:"loading-overlay"},ta=Ye({__name:"ImageUpload",emits:["uploadComplete"],setup(s,{expose:t,emit:n}){const o=n,i=ot(),r=Fe(),a=C(null),u=C(null),g=C(!1),S=C(!1),x=C(""),_=C(0),D=C(""),R=C(!1),M=Q(()=>r.settings.pdfProcessingMethod);function k(){a.value?.click()}function Y(){u.value?.click()}async function V(b){const c=b.target;if(!c.files||c.files.length===0)return;const l=Array.from(c.files).filter($=>$.type.startsWith("image/"));if(l.length===0){ye("æ‰€é€‰æ–‡ä»¶å¤¹ä¸­æ²¡æœ‰æ‰¾åˆ°å›¾ç‰‡æ–‡ä»¶","warning"),c.value="";return}const p=js(l,$=>$.webkitRelativePath);console.log(`ä»æ–‡ä»¶å¤¹å¯¼å…¥ ${p.length} å¼ å›¾ç‰‡`),await L(p),c.value=""}async function L(b){if(b.length!==0){g.value=!0,R.value=!0,_.value=0;try{let c=0;const m=b.length;for(let l=0;l<b.length;l++){const p=b[l];if(!p||!p.type.startsWith("image/"))continue;D.value=p.name;const $=p.webkitRelativePath||"",w=$.includes("/")?$.substring(0,$.lastIndexOf("/")):"";await new Promise((P,O)=>{const ee=new FileReader;ee.onload=le=>{const I=le.target?.result;i.addImage(p.name,I,{relativePath:$,folderPath:w}),P()},ee.onerror=()=>O(new Error(`è¯»å–å›¾ç‰‡å¤±è´¥: ${p.name}`)),ee.readAsDataURL(p)}),c++,_.value=Math.round((l+1)/m*100)}c>0&&(ye(`å·²æ·»åŠ  ${c} å¼ å›¾ç‰‡`,"success"),o("uploadComplete",c))}catch(c){console.error("å¤„ç†æ–‡ä»¶å¤±è´¥:",c);const m=c instanceof Error?c.message:"å¤„ç†æ–‡ä»¶å¤±è´¥";ye(m,"error")}finally{g.value=!1,R.value=!1}}}async function v(b){const c=b.target;!c.files||c.files.length===0||(await z(Array.from(c.files)),c.value="")}async function d(b){b.preventDefault(),S.value=!1,!(!b.dataTransfer?.files||b.dataTransfer.files.length===0)&&await z(Array.from(b.dataTransfer.files))}function h(b){b.preventDefault(),S.value=!0}function y(b){const c=b.currentTarget.getBoundingClientRect(),m=b.clientX,l=b.clientY;(m<c.left||m>c.right||l<c.top||l>c.bottom)&&(S.value=!1)}async function z(b){if(b.length!==0){g.value=!0,x.value="",R.value=!0,_.value=0;try{let c=0;const m=b.length;for(let l=0;l<b.length;l++){const p=b[l];if(!p)continue;D.value=p.name;const $=p.type,w=p.name.toLowerCase();if($.startsWith("image/"))await F(p),c++;else if($==="application/pdf"||w.endsWith(".pdf")){const P=await te(p);c+=P}else if(w.endsWith(".mobi")||w.endsWith(".azw")||w.endsWith(".azw3")){const P=await W(p);c+=P}else console.warn(`ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹: ${p.name}`),ye(`ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹: ${p.name}`,"warning");_.value=Math.round((l+1)/m*100)}c>0&&(ye(`å·²æ·»åŠ  ${c} å¼ å›¾ç‰‡`,"success"),o("uploadComplete",c))}catch(c){console.error("å¤„ç†æ–‡ä»¶å¤±è´¥:",c);const m=c instanceof Error?c.message:"å¤„ç†æ–‡ä»¶å¤±è´¥ï¼Œè¯·é‡è¯•";x.value=m,ye(m,"error")}finally{g.value=!1,R.value=!1,D.value=""}}}async function F(b){return new Promise((c,m)=>{const l=new FileReader;l.onload=p=>{const $=p.target?.result;i.addImage(b.name,$),c()},l.onerror=()=>m(new Error(`è¯»å–å›¾ç‰‡æ–‡ä»¶å¤±è´¥: ${b.name}`)),l.readAsDataURL(b)})}async function te(b){return M.value==="frontend"?await K(b):await Z(b)}function J(b){return new Promise((c,m)=>{const l=new FileReader;l.onload=()=>c(l.result),l.onerror=m,l.readAsDataURL(b)})}async function K(b){try{const c=await rt(()=>import("./pdf.U7tdldy2.js").then(P=>P.p),[]);c.GlobalWorkerOptions.workerSrc=`https://cdnjs.cloudflare.com/ajax/libs/pdf.js/${c.version}/pdf.worker.min.js`;const m=await b.arrayBuffer(),l=await c.getDocument({data:m}).promise,p=l.numPages;console.log(`PDF ${b.name} å…± ${p} é¡µï¼Œå¼€å§‹æœ¬åœ°æ¸²æŸ“...`),ye(`æ­£åœ¨è§£æ PDFï¼Œå…± ${p} é¡µ...`,"info");const $=typeof OffscreenCanvas<"u";$&&console.log("ä½¿ç”¨ OffscreenCanvas åå°æ¸²æŸ“æ¨¡å¼");let w=0;for(let P=1;P<=p;P++){D.value=`${b.name} - ç¬¬ ${P}/${p} é¡µ`,_.value=Math.round(P/p*100);try{const O=await l.getPage(P),le=O.getViewport({scale:2});let I;if($){const ae=new OffscreenCanvas(le.width,le.height),T=ae.getContext("2d");await O.render({canvasContext:T,viewport:le}).promise;const j=await ae.convertToBlob({type:"image/jpeg",quality:1});I=await J(j)}else{const ae=document.createElement("canvas"),T=ae.getContext("2d");ae.width=le.width,ae.height=le.height,await O.render({canvasContext:T,viewport:le}).promise,I=ae.toDataURL("image/jpeg",1)}const q=`${b.name}_é¡µé¢${P}`;i.addImage(q,I),w++,console.log(`  é¡µé¢ ${P}/${p} å¤„ç†å®Œæˆ`)}catch(O){console.warn(`PDF ${b.name} ç¬¬ ${P} é¡µæ¸²æŸ“å¤±è´¥:`,O)}}return console.log(`PDF ${b.name} å…¨éƒ¨ ${p} é¡µå¤„ç†å®Œæˆ`),w}catch(c){return console.error("å‰ç«¯ PDF è§£æå¤±è´¥:",c),ye("å‰ç«¯ PDF è§£æå¤±è´¥ï¼Œå°è¯•ä½¿ç”¨åç«¯è§£æ...","warning"),await Z(b)}}async function Z(b){let m=null;try{ye("æ­£åœ¨ä¸Šä¼  PDF æ–‡ä»¶...","info");const l=await us(b,5);if(!l.success||!l.session_id)throw new Error(l.error||"PDF è§£æå¯åŠ¨å¤±è´¥");m=l.session_id;const p=l.total_pages||0;console.log(`PDF ${b.name} å…± ${p} é¡µï¼Œå¼€å§‹åç«¯åˆ†æ‰¹è§£æ...`),ye(`æ­£åœ¨è§£æ PDFï¼Œå…± ${p} é¡µ...`,"info");let $=0;for(let w=0;w<p;w+=5){D.value=`${b.name} - å¤„ç†ä¸­ ${Math.min(w+5,p)}/${p} é¡µ`,_.value=p>0?Math.round(w/p*100):0;const P=await cs(m,w,5);if(!P.success){console.warn(`æ‰¹æ¬¡ ${w} è·å–å¤±è´¥:`,P.error);continue}if(P.images&&P.images.length>0)for(const O of P.images){if(!O||!O.data_url)continue;const ee=`${b.name}_é¡µé¢${String(O.page_index+1).padStart(4,"0")}`;i.addImage(ee,O.data_url),$++}console.log(`  å·²åŠ è½½ ${$}/${p} é¡µ`)}return console.log(`PDF ${b.name} å…¨éƒ¨ ${$} é¡µå¤„ç†å®Œæˆ`),$}catch(l){throw console.error("åç«¯ PDF è§£æå¤±è´¥:",l),l}finally{if(m)try{await ds(m)}catch(l){console.warn("PDF ä¼šè¯æ¸…ç†å¤±è´¥:",l)}}}async function W(b){let c=null;try{ye("æ­£åœ¨ä¸Šä¼ ç”µå­ä¹¦æ–‡ä»¶...","info");const m=await gs(b,5);if(!m.success||!m.session_id)throw new Error(m.error||"MOBI/AZW è§£æå¯åŠ¨å¤±è´¥");c=m.session_id;const l=m.total_images||0;ye(`æ­£åœ¨è§£æç”µå­ä¹¦ï¼Œå…± ${l} å¼ å›¾ç‰‡...`,"info");let p=0,$=!0;for(;$;){D.value=`${b.name} - å·²å¤„ç† ${p}/${l} å¼ `,_.value=l>0?Math.round(p/l*100):0;const w=await ps(c);if(!w.success)throw new Error(w.error||"MOBI/AZW æ‰¹æ¬¡è§£æå¤±è´¥");if(w.images&&w.images.length>0){for(let P=0;P<w.images.length;P++){const O=w.images[P];if(!O)continue;const ee=p+P+1,le=`${b.name.replace(/\.(mobi|azw|azw3)$/i,"")}_image_${String(ee).padStart(3,"0")}.png`,I=O.startsWith("data:")?O:`data:image/png;base64,${O}`;i.addImage(le,I)}p+=w.images.length}$=w.has_more??!1}return p}catch(m){throw console.error("MOBI/AZW è§£æå¤±è´¥:",m),m}finally{if(c)try{await ms(c)}catch(m){console.warn("MOBI/AZW ä¼šè¯æ¸…ç†å¤±è´¥:",m)}}}function oe(){x.value=""}return t({triggerFileSelect:k,triggerFolderSelect:Y,processFiles:z,clearError:oe}),(b,c)=>(A(),U("div",Zs,[e("div",{id:"drop-area",class:Ee(["drop-area",{"drag-over":S.value,loading:g.value}]),onDragover:h,onDragleave:y,onDrop:d},[e("div",{class:"drop-content"},[e("p",{class:"drop-text"},[c[0]||(c[0]=Ue(" æ‹–æ‹½å›¾ç‰‡ã€PDFæˆ–MOBIæ–‡ä»¶åˆ°è¿™é‡Œï¼Œæˆ– ",-1)),e("span",{class:"select-link",onClick:k}," é€‰æ‹©æ–‡ä»¶ "),c[1]||(c[1]=e("span",{class:"separator"}," | ",-1)),e("span",{class:"select-link folder-link",onClick:Y}," ğŸ“ é€‰æ‹©æ–‡ä»¶å¤¹ ")])]),e("input",{ref_key:"fileInputRef",ref:a,type:"file",id:"imageUpload",accept:"image/*,application/pdf,.mobi,.azw,.azw3",multiple:"",class:"file-input",onChange:v},null,544),e("input",{ref_key:"folderInputRef",ref:u,type:"file",webkitdirectory:"",class:"file-input",onChange:V},null,544)],34),R.value?(A(),ut(yo,{key:0,visible:!0,percentage:_.value,label:D.value||"å¤„ç†ä¸­..."},null,8,["percentage","label"])):fe("",!0),x.value?(A(),U("div",{key:1,class:"error-message",onClick:oe},[c[2]||(c[2]=e("span",{class:"error-icon"},"âš ï¸",-1)),e("span",Qs,se(x.value),1),c[3]||(c[3]=e("span",{class:"error-close"},"Ã—",-1))])):fe("",!0),g.value&&!R.value?(A(),U("div",ea,[...c[4]||(c[4]=[e("div",{class:"spinner"},null,-1),e("span",{class:"loading-text"},"å¤„ç†ä¸­...",-1)])])):fe("",!0)]))}}),oa=je(ta,[["__scopeId","data-v-42054ac8"]]),na={id:"settings-sidebar",class:"settings-sidebar"},sa={class:"card settings-card"},aa={id:"font-settings",class:"settings-card collapsible-panel"},la={class:"toggle-icon"},ia={class:"collapsible-content"},ra={class:"settings-form"},ua={class:"form-group"},ca=["value","disabled","title"],da={class:"auto-fontSize-option",title:"å‹¾é€‰åï¼Œé¦–æ¬¡ç¿»è¯‘æ—¶è‡ªåŠ¨ä¸ºæ¯ä¸ªæ°”æ³¡è®¡ç®—åˆé€‚çš„å­—å·"},ga=["checked"],pa={class:"form-group"},ma={class:"form-group"},va={class:"form-group"},fa={class:"color-with-auto"},ba={class:"auto-color-toggle",title:"ç¿»è¯‘æ—¶è‡ªåŠ¨ä½¿ç”¨è¯†åˆ«åˆ°çš„æ–‡å­—é¢œè‰²"},ha=["checked"],ya=["value","disabled"],xa={key:0,class:"auto-color-hint"},Sa={class:"form-group"},_a={class:"checkbox-label"},Ca=["checked"],ka={key:0,id:"strokeOptions",class:"stroke-options"},wa={class:"form-group"},Ta=["value"],$a={class:"form-group"},Ia=["value"],Ra={class:"form-group"},Pa={key:0,id:"solidColorOptions",class:"form-group"},Da=["value"],Ma={class:"apply-settings-group"},Ba=["disabled"],Ea={key:0,class:"apply-options-dropdown"},Aa={class:"apply-option"},La=["checked"],Fa={class:"apply-option"},Ua={class:"apply-option"},za={class:"apply-option"},Oa={class:"apply-option"},Va={class:"apply-option"},Na={class:"apply-option"},Wa={class:"apply-option"},qa={class:"apply-option"},Ka={id:"page-range-settings",class:"settings-card collapsible-panel"},Ha={class:"toggle-icon"},ja={class:"collapsible-content"},Ya={class:"settings-form page-range-form"},Ja={class:"range-header-row"},Xa={class:"range-toggle-compact"},Ga=["disabled"],Za={class:"total-count"},Qa={class:"page-range-inputs-compact"},el=["value","max"],tl=["value","max"],ol={key:0,class:"range-error-compact"},nl={class:"action-buttons"},sl=["disabled"],al=["disabled","title"],ll=["disabled","title"],il=["disabled","title"],rl=["disabled"],ul=["disabled","title"],cl=["disabled"],dl=["disabled"],gl={class:"navigation-buttons"},pl=["disabled"],ml=["disabled"],vl=Ye({__name:"SettingsSidebar",emits:["translateCurrent","translateAll","translateRange","hqTranslate","hqTranslateRange","proofread","proofreadRange","removeText","removeAllText","removeTextRange","deleteCurrent","clearAll","cleanTemp","openPlugins","openSettings","previous","next","applyToAll","textStyleChanged","autoFontSizeChanged"],setup(s,{emit:t}){const n=t,o=ot(),i=Fe(),r=C(!0),a=C(!1),u=C({fontSize:!0,fontFamily:!0,layoutDirection:!0,textColor:!0,fillColor:!0,strokeEnabled:!0,strokeColor:!0,strokeWidth:!0}),g=C(!1),S=C(!1),x=C(1),_=C(1),D=[{label:"è‡ªåŠ¨ (æ ¹æ®æ£€æµ‹)",value:"auto"},{label:"ç«–å‘æ’ç‰ˆ",value:"vertical"},{label:"æ¨ªå‘æ’ç‰ˆ",value:"horizontal"}],R=[{label:"çº¯è‰²å¡«å……",value:"solid"},{label:"LAMAä¿®å¤ (é€Ÿåº¦ä¼˜åŒ–)",value:"lama_mpe"},{label:"LAMAä¿®å¤ (é€šç”¨)",value:"litelama"}],M=Q(()=>o.currentImage),k=Q(()=>o.hasImages),Y=Q(()=>o.images.length),V=Q(()=>x.value>=1&&_.value<=Y.value&&x.value<=_.value),L=Q(()=>k.value&&!o.isBatchTranslationInProgress),v=Q(()=>o.canGoPrevious),d=Q(()=>o.canGoNext),h=Q(()=>i.textStyle),y=C([]),z=[xt,"fonts/msyh.ttc","fonts/simhei.ttf","fonts/simsun.ttc"],F=C(null),te=Q(()=>{const X=y.value.map(f=>({label:b(f),value:f}));return X.push({label:"è‡ªå®šä¹‰å­—ä½“...",value:"custom-font"}),X});dt(async()=>{await J();const X=h.value.fontFamily;X&&!y.value.includes(X)&&(y.value=[X,...y.value])});async function J(){try{const X=await bn();if(X.fonts&&Array.isArray(X.fonts)&&X.fonts.length>0){const f=X.fonts[0];if(typeof f=="object"&&"path"in f){const N=X.fonts.map(pe=>typeof pe=="object"?pe.path:pe);y.value=N}else y.value=X.fonts}else y.value=[...z]}catch(X){console.error("åŠ è½½å­—ä½“åˆ—è¡¨å¤±è´¥:",X),y.value=[...z]}}function K(){r.value=!r.value}function Z(X){const f=parseInt(X.target.value);isNaN(f)||(i.updateTextStyle({fontSize:f}),n("textStyleChanged","fontSize",f))}function W(X){const f=X.target.checked;i.updateTextStyle({autoFontSize:f}),console.log(`è‡ªåŠ¨å­—å·è®¾ç½®å˜æ›´: ${f}`),n("autoFontSizeChanged",f)}async function oe(X){const f=X.target,N=f.files?.[0];if(!N)return;const pe=[".ttf",".ttc",".otf"],me=N.name.toLowerCase();if(!pe.some(G=>me.endsWith(G))){ye("è¯·é€‰æ‹© .ttfã€.ttc æˆ– .otf æ ¼å¼çš„å­—ä½“æ–‡ä»¶","error"),f.value="";return}try{const G=await ys(N);G.success&&G.fontPath?(await J(),i.updateTextStyle({fontFamily:G.fontPath}),ye("å­—ä½“ä¸Šä¼ æˆåŠŸ","success")):ye(G.error||"å­—ä½“ä¸Šä¼ å¤±è´¥","error")}catch(G){console.error("å­—ä½“ä¸Šä¼ å¤±è´¥:",G),ye("å­—ä½“ä¸Šä¼ å¤±è´¥","error")}finally{f.value=""}}function b(X){const f={"fonts/STXINGKA.TTF":"åæ–‡è¡Œæ¥·","fonts/STXINWEI.TTF":"åæ–‡æ–°é­","fonts/STZHONGS.TTF":"åæ–‡ä¸­å®‹","fonts/STKAITI.TTF":"æ¥·ä½“","fonts/STLITI.TTF":"éš¶ä¹¦","fonts/æ€æºé»‘ä½“SourceHanSansK-Bold.TTF":"æ€æºé»‘ä½“","fonts/STSONG.TTF":"åæ–‡å®‹ä½“","fonts/msyh.ttc":"å¾®è½¯é›…é»‘","fonts/msyhbd.ttc":"å¾®è½¯é›…é»‘ç²—ä½“","fonts/SIMYOU.TTF":"å¹¼åœ†","fonts/STFANGSO.TTF":"ä»¿å®‹","fonts/STHUPO.TTF":"åæ–‡ç¥ç€","fonts/STXIHEI.TTF":"åæ–‡ç»†é»‘","fonts/simkai.ttf":"ä¸­æ˜“æ¥·ä½“","fonts/simfang.ttf":"ä¸­æ˜“ä»¿å®‹","fonts/simhei.ttf":"ä¸­æ˜“é»‘ä½“","fonts/SIMLI.TTF":"ä¸­æ˜“éš¶ä¹¦","fonts/simsun.ttc":"å®‹ä½“"};if(f[X])return f[X];const N=X.split("/").pop()||X;for(const[pe,me]of Object.entries(f))if((pe.split("/").pop()||"").toLowerCase()===N.toLowerCase())return me;return N.replace(/\.(ttf|ttc|otf)$/i,"")}function c(X){const f=String(X);if(f==="custom-font"){F.value?.click();return}i.updateTextStyle({fontFamily:f}),n("textStyleChanged","fontFamily",f)}function m(X){const f=String(X);i.updateTextStyle({layoutDirection:f}),n("textStyleChanged","layoutDirection",f)}function l(X){const f=String(X);i.updateTextStyle({inpaintMethod:f})}function p(X){const f=X.target.value;i.updateTextStyle({textColor:f}),n("textStyleChanged","textColor",f)}function $(X){const f=X.target.checked;i.updateTextStyle({useAutoTextColor:f})}function w(X){const f=X.target.checked;i.updateTextStyle({strokeEnabled:f}),n("textStyleChanged","strokeEnabled",f)}function P(X){const f=X.target.value;i.updateTextStyle({strokeColor:f}),n("textStyleChanged","strokeColor",f)}function O(X){const f=parseInt(X.target.value);isNaN(f)||(i.updateTextStyle({strokeWidth:f}),n("textStyleChanged","strokeWidth",f))}function ee(X){const f=X.target.value;i.updateTextStyle({fillColor:f}),n("textStyleChanged","fillColor",f)}function le(){a.value=!a.value}function I(){const f=!Object.values(u.value).every(N=>N);u.value={fontSize:f,fontFamily:f,layoutDirection:f,textColor:f,fillColor:f,strokeEnabled:f,strokeColor:f,strokeWidth:f}}function q(){n("applyToAll",{...u.value}),a.value=!1}function ae(X){X.target.closest(".apply-settings-group")||(a.value=!1)}function T(){g.value=!g.value,g.value&&Y.value>0&&(x.value=1,_.value=Y.value)}function j(X){const f=parseInt(X.target.value);isNaN(f)||(x.value=Math.max(1,Math.min(f,Y.value)),x.value>_.value&&(_.value=x.value))}function ge(X){const f=parseInt(X.target.value);isNaN(f)||(_.value=Math.max(1,Math.min(f,Y.value)),_.value<x.value&&(x.value=_.value))}function Se(){S.value&&V.value?n("translateRange",x.value,_.value):n("translateAll")}function Re(){S.value&&V.value?n("hqTranslateRange",x.value,_.value):n("hqTranslate")}function we(){S.value&&V.value?n("proofreadRange",x.value,_.value):n("proofread")}function be(){S.value&&V.value?n("removeTextRange",x.value,_.value):n("removeAllText")}return typeof window<"u"&&window.addEventListener("click",ae),(X,f)=>(A(),U("aside",na,[e("div",sa,[f[43]||(f[43]=e("h2",null,"ç¿»è¯‘è®¾ç½®",-1)),e("div",aa,[e("h3",{class:"collapsible-header",onClick:K},[f[17]||(f[17]=Ue(" æ–‡å­—è®¾ç½® ",-1)),e("span",la,se(r.value?"â–¼":"â–¶"),1)]),ne(e("div",ia,[e("div",ra,[e("div",ua,[f[19]||(f[19]=e("label",{for:"fontSize"},"å­—å·å¤§å°:",-1)),e("input",{type:"number",id:"fontSize",value:h.value.fontSize,min:"10",disabled:h.value.autoFontSize,class:Ee({"disabled-input":h.value.autoFontSize}),title:h.value.autoFontSize?"å·²å¯ç”¨è‡ªåŠ¨å­—å·ï¼Œé¦–æ¬¡ç¿»è¯‘æ—¶å°†è‡ªåŠ¨è®¡ç®—":"",onInput:Z},null,42,ca),e("span",da,[e("input",{type:"checkbox",id:"autoFontSize",checked:h.value.autoFontSize,onChange:W},null,40,ga),f[18]||(f[18]=e("label",{for:"autoFontSize"},"è‡ªåŠ¨è®¡ç®—åˆå§‹å­—å·",-1))])]),e("div",pa,[f[20]||(f[20]=e("label",{for:"fontFamily"},"æ–‡æœ¬å­—ä½“:",-1)),xe(Ne,{"model-value":h.value.fontFamily,options:te.value,onChange:c},null,8,["model-value","options"]),e("input",{ref_key:"fontUploadInput",ref:F,type:"file",id:"fontUpload",accept:".ttf,.ttc,.otf",style:{display:"none"},onChange:oe},null,544)]),e("div",ma,[f[21]||(f[21]=e("label",{for:"layoutDirection"},"æ’ç‰ˆè®¾ç½®:",-1)),xe(Ne,{"model-value":h.value.layoutDirection,options:D,onChange:m},null,8,["model-value"])]),e("div",va,[f[23]||(f[23]=e("label",{for:"textColor"},"æ–‡å­—é¢œè‰²:",-1)),e("div",fa,[e("label",ba,[e("input",{type:"checkbox",checked:h.value.useAutoTextColor,onChange:$},null,40,ha),f[22]||(f[22]=e("span",null,"è‡ªåŠ¨",-1))]),e("input",{type:"color",id:"textColor",value:h.value.textColor,disabled:h.value.useAutoTextColor,onInput:p},null,40,ya)]),h.value.useAutoTextColor?(A(),U("div",xa," ğŸ’¡ ç¿»è¯‘æ—¶å°†è‡ªåŠ¨ä½¿ç”¨è¯†åˆ«åˆ°çš„æ–‡å­—é¢œè‰² ")):fe("",!0)]),e("div",Sa,[e("span",_a,[e("input",{type:"checkbox",id:"strokeEnabled",checked:h.value.strokeEnabled,onChange:w},null,40,Ca),f[24]||(f[24]=e("label",{for:"strokeEnabled"},"å¯ç”¨æ–‡æœ¬æè¾¹:",-1))])]),xe(on,{name:"stroke-slide"},{default:Ct(()=>[h.value.strokeEnabled?(A(),U("div",ka,[e("div",wa,[f[25]||(f[25]=e("label",{for:"strokeColor"},"æè¾¹é¢œè‰²:",-1)),e("input",{type:"color",id:"strokeColor",value:h.value.strokeColor,onInput:P},null,40,Ta)]),e("div",$a,[f[26]||(f[26]=e("label",{for:"strokeWidth"},"æè¾¹å®½åº¦ (px):",-1)),e("input",{type:"number",id:"strokeWidth",value:h.value.strokeWidth,min:"0",max:"10",style:{width:"60px",padding:"5px"},onInput:O},null,40,Ia),f[27]||(f[27]=e("div",{class:"input-hint"},"0 è¡¨ç¤ºæ— æè¾¹ã€‚",-1))])])):fe("",!0)]),_:1}),e("div",Ra,[f[28]||(f[28]=e("label",{for:"useInpainting"},"æ°”æ³¡å¡«å……æ–¹å¼:",-1)),xe(Ne,{"model-value":h.value.inpaintMethod,options:R,onChange:l},null,8,["model-value"])]),xe(on,{name:"slide-fade"},{default:Ct(()=>[h.value.inpaintMethod==="solid"?(A(),U("div",Pa,[f[29]||(f[29]=e("label",{for:"fillColor"},"å¡«å……é¢œè‰²:",-1)),e("input",{type:"color",id:"fillColor",value:h.value.fillColor,onInput:ee},null,40,Da)])):fe("",!0)]),_:1})]),e("div",Ma,[e("button",{type:"button",class:"settings-button",disabled:!k.value,onClick:q}," åº”ç”¨åˆ°å…¨éƒ¨ ",8,Ba),e("button",{type:"button",class:"settings-gear-btn",title:"é€‰æ‹©è¦åº”ç”¨çš„å‚æ•°",onClick:le}," âš™ï¸ "),a.value?(A(),U("div",Ea,[e("div",Aa,[e("input",{type:"checkbox",id:"apply_selectAll",checked:Object.values(u.value).every(N=>N),onChange:I},null,40,La),f[30]||(f[30]=e("label",{for:"apply_selectAll"},"å…¨é€‰",-1))]),f[39]||(f[39]=e("hr",null,null,-1)),e("div",Fa,[ne(e("input",{type:"checkbox",id:"apply_fontSize","onUpdate:modelValue":f[0]||(f[0]=N=>u.value.fontSize=N)},null,512),[[nt,u.value.fontSize]]),f[31]||(f[31]=e("label",{for:"apply_fontSize"},"å­—å·",-1))]),e("div",Ua,[ne(e("input",{type:"checkbox",id:"apply_fontFamily","onUpdate:modelValue":f[1]||(f[1]=N=>u.value.fontFamily=N)},null,512),[[nt,u.value.fontFamily]]),f[32]||(f[32]=e("label",{for:"apply_fontFamily"},"å­—ä½“",-1))]),e("div",za,[ne(e("input",{type:"checkbox",id:"apply_layoutDirection","onUpdate:modelValue":f[2]||(f[2]=N=>u.value.layoutDirection=N)},null,512),[[nt,u.value.layoutDirection]]),f[33]||(f[33]=e("label",{for:"apply_layoutDirection"},"æ’ç‰ˆæ–¹å‘",-1))]),e("div",Oa,[ne(e("input",{type:"checkbox",id:"apply_textColor","onUpdate:modelValue":f[3]||(f[3]=N=>u.value.textColor=N)},null,512),[[nt,u.value.textColor]]),f[34]||(f[34]=e("label",{for:"apply_textColor"},"æ–‡å­—é¢œè‰²",-1))]),e("div",Va,[ne(e("input",{type:"checkbox",id:"apply_fillColor","onUpdate:modelValue":f[4]||(f[4]=N=>u.value.fillColor=N)},null,512),[[nt,u.value.fillColor]]),f[35]||(f[35]=e("label",{for:"apply_fillColor"},"å¡«å……é¢œè‰²",-1))]),e("div",Na,[ne(e("input",{type:"checkbox",id:"apply_strokeEnabled","onUpdate:modelValue":f[5]||(f[5]=N=>u.value.strokeEnabled=N)},null,512),[[nt,u.value.strokeEnabled]]),f[36]||(f[36]=e("label",{for:"apply_strokeEnabled"},"æè¾¹å¼€å…³",-1))]),e("div",Wa,[ne(e("input",{type:"checkbox",id:"apply_strokeColor","onUpdate:modelValue":f[6]||(f[6]=N=>u.value.strokeColor=N)},null,512),[[nt,u.value.strokeColor]]),f[37]||(f[37]=e("label",{for:"apply_strokeColor"},"æè¾¹é¢œè‰²",-1))]),e("div",qa,[ne(e("input",{type:"checkbox",id:"apply_strokeWidth","onUpdate:modelValue":f[7]||(f[7]=N=>u.value.strokeWidth=N)},null,512),[[nt,u.value.strokeWidth]]),f[38]||(f[38]=e("label",{for:"apply_strokeWidth"},"æè¾¹å®½åº¦",-1))])])):fe("",!0)])],512),[[Oe,r.value]])]),e("div",Ka,[e("h3",{class:"collapsible-header",onClick:T},[f[40]||(f[40]=Ue(" æŒ‡å®šèŒƒå›´ ",-1)),e("span",Ha,se(g.value?"â–¼":"â–¶"),1)]),ne(e("div",ja,[e("div",Ya,[e("div",Ja,[e("label",Xa,[ne(e("input",{type:"checkbox","onUpdate:modelValue":f[8]||(f[8]=N=>S.value=N),disabled:Y.value===0},null,8,Ga),[[nt,S.value]]),f[41]||(f[41]=e("span",null,"å¯ç”¨",-1))]),e("span",Za,"å…± "+se(Y.value)+" å¼ ",1)]),ne(e("div",Qa,[e("input",{type:"number",id:"pageRangeStart",value:x.value,min:"1",max:Y.value,onInput:j,placeholder:"èµ·å§‹"},null,40,el),f[42]||(f[42]=e("span",{class:"range-sep"},"~",-1)),e("input",{type:"number",id:"pageRangeEnd",value:_.value,min:"1",max:Y.value,onInput:ge,placeholder:"ç»“æŸ"},null,40,tl)],512),[[Oe,S.value]]),S.value&&!V.value&&Y.value>0?(A(),U("div",ol," èŒƒå›´æ— æ•ˆ ")):fe("",!0)])],512),[[Oe,g.value]])]),e("div",nl,[e("button",{id:"translateButton",disabled:!L.value,onClick:f[9]||(f[9]=N=>n("translateCurrent"))}," ç¿»è¯‘å½“å‰å›¾ç‰‡ ",8,sl),e("button",{id:"translateAllButton",disabled:!L.value||S.value&&!V.value,title:S.value?`ç¿»è¯‘ç¬¬ ${x.value}-${_.value} é¡µ`:"ç¿»è¯‘æ‰€æœ‰å›¾ç‰‡",onClick:Se},se(S.value?`ç¿»è¯‘ ${x.value}-${_.value} é¡µ`:"ç¿»è¯‘æ‰€æœ‰å›¾ç‰‡"),9,al),e("button",{id:"startHqTranslationBtn",class:"settings-button purple-button",disabled:!L.value||S.value&&!V.value,title:S.value?`é«˜è´¨é‡ç¿»è¯‘ç¬¬ ${x.value}-${_.value} é¡µ`:"ä½¿ç”¨é«˜è´¨é‡ç¿»è¯‘æ¨¡å¼ï¼ˆéœ€åœ¨è®¾ç½®ä¸­é…ç½®ï¼‰",onClick:Re},se(S.value?`é«˜è´¨é‡ç¿»è¯‘ ${x.value}-${_.value}`:"é«˜è´¨é‡ç¿»è¯‘"),9,ll),e("button",{id:"proofreadButton",disabled:!L.value||S.value&&!V.value,title:S.value?`AIæ ¡å¯¹ç¬¬ ${x.value}-${_.value} é¡µ`:"AIæ ¡å¯¹",onClick:we},se(S.value?`AIæ ¡å¯¹ ${x.value}-${_.value}`:"AIæ ¡å¯¹"),9,il),e("button",{id:"removeTextOnlyButton",disabled:!M.value,title:"æ¶ˆé™¤å›¾ç‰‡ä¸­çš„æ°”æ³¡æ–‡å­—ï¼Œæ— éœ€å¡«å†™ç¿»è¯‘æœåŠ¡å•†å’ŒAPI Key",onClick:f[10]||(f[10]=N=>n("removeText"))}," ä»…æ¶ˆé™¤æ–‡å­— ",8,rl),e("button",{id:"removeAllTextButton",disabled:!k.value||S.value&&!V.value,title:S.value?`æ¶ˆé™¤ç¬¬ ${x.value}-${_.value} é¡µçš„æ–‡å­—`:"æ¶ˆé™¤æ‰€æœ‰å›¾ç‰‡ä¸­çš„æ°”æ³¡æ–‡å­—",onClick:be},se(S.value?`æ¶ˆé™¤ ${x.value}-${_.value} é¡µæ–‡å­—`:"æ¶ˆé™¤æ‰€æœ‰å›¾ç‰‡æ–‡å­—"),9,ul),e("button",{id:"deleteCurrentImageButton",class:"settings-button red-button",disabled:!M.value,onClick:f[11]||(f[11]=N=>n("deleteCurrent"))}," åˆ é™¤å½“å‰å›¾ç‰‡ ",8,cl),e("button",{id:"clearAllImagesButton",class:"settings-button red-button",disabled:!k.value,onClick:f[12]||(f[12]=N=>n("clearAll"))}," æ¸…é™¤æ‰€æœ‰å›¾ç‰‡ ",8,dl),e("button",{id:"cleanDebugFilesButton",class:"settings-button orange-button",onClick:f[13]||(f[13]=N=>n("cleanTemp"))}," æ¸…ç†ä¸´æ—¶æ–‡ä»¶ "),e("button",{id:"managePluginsButton",class:"settings-button blue-button",onClick:f[14]||(f[14]=N=>n("openPlugins"))}," æ’ä»¶ç®¡ç† ")]),e("div",gl,[e("button",{id:"prevImageButton",disabled:!v.value,onClick:f[15]||(f[15]=N=>n("previous"))}," ä¸Šä¸€å¼  ",8,pl),e("button",{id:"nextImageButton",disabled:!d.value,onClick:f[16]||(f[16]=N=>n("next"))}," ä¸‹ä¸€å¼  ",8,ml)])])]))}}),fl=je(vl,[["__scopeId","data-v-fb2b28e9"]]);function At(s){if(s.textDirection==="vertical"||s.textDirection==="horizontal")return s.textDirection;if(s.autoTextDirection==="vertical"||s.autoTextDirection==="horizontal")return s.autoTextDirection;if(s.coords){const[t,n,o,i]=s.coords;return i-n>o-t?"vertical":"horizontal"}return"vertical"}function bl(){const s=ot(),t=Fe(),n=ct(),o=C(!1),i=C(0),r=C(""),a=C(!1),u=C(0),g=C(""),S=Q(()=>s.hasImages),x=Q(()=>s.hasImages),_=Q(()=>s.hasImages);function D(){const v=s.images;if(v.length===0){n.warning("æ²¡æœ‰å¯å¯¼å‡ºçš„å›¾ç‰‡æ–‡æœ¬");return}const d=[];for(let K=0;K<v.length;K++){const Z=v[K];if(!Z)continue;const W=Z.bubbleStates||[],oe={imageIndex:K,bubbles:[]};for(let b=0;b<W.length;b++){const c=W[b];if(!c)continue;const m=c.originalText||"",l=c.translatedText||c.textboxText||"";let p="vertical";c.textDirection&&c.textDirection!=="auto"?p=c.textDirection:c.autoTextDirection&&(p=c.autoTextDirection),oe.bubbles.push({bubbleIndex:b,original:m,translated:l,textDirection:p})}d.push(oe)}const h=JSON.stringify(d,null,2),y=new Blob([h],{type:"application/json"}),z=URL.createObjectURL(y),F=document.createElement("a");F.href=z;const J=new Date().toISOString().replace(/[-:T]/g,"").slice(0,15);F.download=`translations_${J}.json`,document.body.appendChild(F),F.click(),document.body.removeChild(F),URL.revokeObjectURL(z),n.success("æ–‡æœ¬å¯¼å‡ºæˆåŠŸï¼")}function R(){const v=s.images;if(v.length===0)return null;const d=[];for(let h=0;h<v.length;h++){const y=v[h];if(!y)continue;const z=y.bubbleStates||[],F={imageIndex:h,bubbles:[]};for(let te=0;te<z.length;te++){const J=z[te];if(!J)continue;const K=J.originalText||"",Z=J.translatedText||J.textboxText||"";let W="vertical";J.textDirection&&J.textDirection!=="auto"?W=J.textDirection:J.autoTextDirection&&(W=J.autoTextDirection),F.bubbles.push({bubbleIndex:te,original:K,translated:Z,textDirection:W})}d.push(F)}return d}async function M(v){if(!v){n.warning("æœªé€‰æ‹©æ–‡ä»¶");return}a.value=!0,u.value=0,g.value="å‡†å¤‡å¯¼å…¥æ–‡æœ¬...",n.info("æ­£åœ¨å¯¼å…¥æ–‡æœ¬...",0);try{const d=await k(v);u.value=10,g.value="è§£æ JSON æ•°æ®...";const h=JSON.parse(d);if(!Array.isArray(h))throw new Error("å¯¼å…¥çš„ JSON æ ¼å¼ä¸æ­£ç¡®ï¼Œåº”ä¸ºæ•°ç»„");let y=0,z=0;const F=t.settings.textStyle,te=F.autoFontSize?"auto":F.fontSize,J=F.fontFamily,K=F.textColor,Z=F.fillColor;u.value=20,g.value="å¼€å§‹æ›´æ–°å›¾ç‰‡...";const W=h.length;let oe=0;const b=[];for(const l of h){oe++;const p=20+oe/W*60;u.value=p,g.value=`å¤„ç†å›¾ç‰‡ ${oe}/${W}`;const $=l.imageIndex;if($<0||$>=s.images.length){console.warn(`è·³è¿‡æ— æ•ˆçš„å›¾ç‰‡ç´¢å¼•: ${$}`);continue}const w=s.images[$];if(!w)continue;let P=!1;w.bubbleStates||(w.bubbleStates=[]),w.bubbleTexts||(w.bubbleTexts=[]),w.originalTexts||(w.originalTexts=[]);for(const O of l.bubbles){const ee=O.bubbleIndex,le=O.original,I=O.translated,q=O.textDirection,ae=q==="vertical"||q==="horizontal"?q:"vertical";for(;w.bubbleTexts.length<=ee;)w.bubbleTexts.push("");for(;w.originalTexts.length<=ee;)w.originalTexts.push("");for(le&&(w.originalTexts[ee]=le),I&&(w.bubbleTexts[ee]=I);w.bubbleStates.length<=ee;)w.bubbleStates.push(Y(te,J,K,Z));const T=w.bubbleStates[ee];T&&(le&&(T.originalText=le),I&&(T.translatedText=I,T.textboxText=I),T.textDirection=ae,P=!0,z++)}P&&w.bubbleStates&&(w.bubbleTexts=w.bubbleStates.map(O=>O.translatedText||"")),P&&(y++,w.hasUnsavedChanges=!0,w.translatedDataURL&&w.bubbleStates&&w.bubbleStates.length>0&&b.push($))}if(b.length>0){u.value=80,g.value="å¼€å§‹æ¸²æŸ“å›¾ç‰‡...",n.info("æ­£åœ¨æ¸²æŸ“å›¾ç‰‡ï¼Œè¯·ç¨å€™...",0);const l=t.settings.textStyle,p=l.layoutDirection,$=p==="auto";for(let w=0;w<b.length;w++){const P=b[w];if(P===void 0)continue;const O=s.images[P];if(!(!O||!O.bubbleStates)){u.value=80+w/b.length*20,g.value=`æ¸²æŸ“å›¾ç‰‡ ${w+1}/${b.length}`;try{let ee="";if(O.cleanImageData?ee=O.cleanImageData.includes("base64,")?O.cleanImageData.split("base64,")[1]||"":O.cleanImageData:O.originalDataURL&&(ee=O.originalDataURL.includes("base64,")?O.originalDataURL.split("base64,")[1]||"":O.originalDataURL,console.log(`importText: å›¾ç‰‡ ${P} ä½¿ç”¨åŸå›¾ä½œä¸ºèƒŒæ™¯ï¼ˆå…œåº•ï¼‰`)),!ee){console.log(`importText: å›¾ç‰‡ ${P} æ²¡æœ‰å¯ç”¨çš„èƒŒæ™¯å›¾ï¼Œè·³è¿‡`);continue}const le=O.bubbleStates.map(q=>({translatedText:q.translatedText||"",coords:q.coords,fontSize:q.fontSize||l.fontSize,fontFamily:q.fontFamily||l.fontFamily,textDirection:At(q),textColor:q.textColor||l.textColor,rotationAngle:q.rotationAngle||0,position:q.position||{x:0,y:0},strokeEnabled:q.strokeEnabled??l.strokeEnabled,strokeColor:q.strokeColor||l.strokeColor,strokeWidth:q.strokeWidth??l.strokeWidth})),I=await bo({clean_image:ee,bubble_texts:le.map(q=>q.translatedText),bubble_coords:le.map(q=>q.coords),fontSize:l.fontSize,fontFamily:l.fontFamily,textDirection:$?"vertical":p,textColor:l.textColor,bubble_states:le,use_individual_styles:!0,use_inpainting:!1,use_lama:!1,is_font_style_change:!0,strokeEnabled:l.strokeEnabled,strokeColor:l.strokeColor,strokeWidth:l.strokeWidth});I.rendered_image&&(s.updateImageByIndex(P,{translatedDataURL:`data:image/png;base64,${I.rendered_image}`,hasUnsavedChanges:!0}),console.log(`importText: å›¾ç‰‡ ${P} æ¸²æŸ“æˆåŠŸ`))}catch(ee){console.error(`importText: é‡æ¸²æŸ“å›¾ç‰‡ ${P} å¤±è´¥:`,ee)}}}}u.value=100,g.value="å¯¼å…¥å®Œæˆ";const c=b.length,m=c>0?`å¯¼å…¥æˆåŠŸï¼æ›´æ–°äº† ${y} å¼ å›¾ç‰‡ä¸­çš„ ${z} ä¸ªæ°”æ³¡æ–‡æœ¬ï¼Œé‡æ¸²æŸ“äº† ${c} å¼ å›¾ç‰‡`:`å¯¼å…¥æˆåŠŸï¼æ›´æ–°äº† ${y} å¼ å›¾ç‰‡ä¸­çš„ ${z} ä¸ªæ°”æ³¡æ–‡æœ¬`;n.success(m)}catch(d){console.error("å¯¼å…¥æ–‡æœ¬å‡ºé”™:",d),n.error(`å¯¼å…¥å¤±è´¥: ${d instanceof Error?d.message:String(d)}`)}finally{a.value=!1,setTimeout(()=>{u.value=0,g.value=""},2e3)}}function k(v){return new Promise((d,h)=>{const y=new FileReader;y.onload=z=>{z.target?.result?d(z.target.result):h(new Error("è¯»å–æ–‡ä»¶å¤±è´¥"))},y.onerror=()=>h(new Error("è¯»å–æ–‡ä»¶æ—¶å‡ºé”™")),y.readAsText(v)})}function Y(v,d,h,y){const z=t.settings.textStyle;return{coords:[0,0,100,100],polygon:[],originalText:"",translatedText:"",textboxText:"",fontSize:typeof v=="number"?v:25,fontFamily:d,textDirection:"vertical",autoTextDirection:"vertical",textColor:h,fillColor:y,rotationAngle:0,position:{x:0,y:0},strokeEnabled:z.strokeEnabled,strokeColor:z.strokeColor,strokeWidth:z.strokeWidth,inpaintMethod:z.inpaintMethod}}function V(){const v=s.currentImage;if(!v){n.warning("æ²¡æœ‰å¯ä¸‹è½½çš„å›¾ç‰‡");return}const d=v.translatedDataURL||v.originalDataURL;if(!d){n.warning("æ²¡æœ‰å¯ä¸‹è½½çš„å›¾ç‰‡");return}o.value=!0;try{const h=d.split(",")[1];if(!h)throw new Error("æ— æ•ˆçš„å›¾ç‰‡æ•°æ®");const y=atob(h),z=[];for(let W=0;W<y.length;W+=512){const oe=y.slice(W,W+512),b=new Array(oe.length);for(let m=0;m<oe.length;m++)b[m]=oe.charCodeAt(m);const c=new Uint8Array(b);z.push(c.buffer)}const F=new Blob(z,{type:"image/png"}),te=URL.createObjectURL(F),J=document.createElement("a");J.href=te;let K=v.fileName||`image_${s.currentImageIndex}.png`;K=`${v.translatedDataURL?"translated":"original"}_${K.replace(/\.[^/.]+$/,"")}.png`,J.download=K,document.body.appendChild(J),J.click(),document.body.removeChild(J),URL.revokeObjectURL(te),n.success(`ä¸‹è½½æˆåŠŸ: ${K}`)}catch(h){console.error("ä¸‹è½½å›¾ç‰‡æ—¶å‡ºé”™:",h),n.error("ä¸‹è½½å¤±è´¥")}finally{o.value=!1}}async function L(v="zip"){const d=s.images;if(d.length===0){n.warning("æ²¡æœ‰å¯ä¸‹è½½çš„å›¾ç‰‡");return}o.value=!0,i.value=0,r.value="å‡†å¤‡ä¸‹è½½...",n.info("ä¸‹è½½ä¸­...å¤„ç†å¯èƒ½éœ€è¦ä¸€å®šæ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…...",0);try{const h=[];let y=0,z=0;i.value=5,r.value="æ£€æŸ¥å›¾ç‰‡æ•°æ®...";for(let m=0;m<d.length;m++){const l=d[m];l&&(l.translatedDataURL?(h.push({index:m,type:"translated"}),y++):l.originalDataURL&&(h.push({index:m,type:"original"}),z++))}if(h.length===0){n.warning("æ²¡æœ‰å¯ä¸‹è½½çš„å›¾ç‰‡");return}i.value=10,r.value="åˆ›å»ºä¸‹è½½ä¼šè¯...";const F=await vs(h.length);if(!F.success||!F.session_id)throw new Error(F.error||"åˆ›å»ºä¼šè¯å¤±è´¥");const te=F.session_id,J=h.length;let K=0,Z=0;for(let m=0;m<h.length;m++){const l=h[m];if(!l)continue;const p=d[l.index];if(!p)continue;const $=l.type==="translated"?p.translatedDataURL:p.originalDataURL;if(!$)continue;const w=10+m/J*70;i.value=w,r.value=`ä¸Šä¼ å›¾ç‰‡ ${m+1}/${J}...`;try{const P=await fs(te,$,m);P.success?K++:(console.error(`ä¸Šä¼ å›¾ç‰‡ ${m} å¤±è´¥:`,P.error),Z++)}catch(P){console.error(`ä¸Šä¼ å›¾ç‰‡ ${m} å‡ºé”™:`,P),Z++}}if(K===0)throw new Error("æ‰€æœ‰å›¾ç‰‡ä¸Šä¼ å¤±è´¥");i.value=85,r.value="æ‰“åŒ…æ–‡ä»¶...";const W=await bs(te,v);if(!W.success||!W.file_id)throw new Error(W.error||"æ‰“åŒ…å¤±è´¥");i.value=95,r.value="å‡†å¤‡ä¸‹è½½...";const oe=hs(W.file_id,v),b=document.createElement("a");b.href=oe,document.body.appendChild(b),b.click(),document.body.removeChild(b),i.value=100,r.value="ä¸‹è½½å·²å¼€å§‹";let c=`å·²æˆåŠŸå¤„ç† ${K} å¼ å›¾ç‰‡`;Z>0&&(c+=`ï¼ˆ${Z} å¼ å¤±è´¥ï¼‰`),y>0&&z>0?c+=`ï¼ˆ${y} å¼ ç¿»è¯‘å›¾ç‰‡å’Œ ${z} å¼ åŸå§‹å›¾ç‰‡ï¼‰`:y>0?c+="ï¼ˆå…¨éƒ¨ä¸ºç¿»è¯‘åå›¾ç‰‡ï¼‰":z>0&&(c+="ï¼ˆå…¨éƒ¨ä¸ºåŸå§‹å›¾ç‰‡ï¼‰"),c+="ï¼Œä¸‹è½½å³å°†å¼€å§‹",n.success(c),setTimeout(async()=>{try{const m=await fo();console.log("ä¸´æ—¶æ–‡ä»¶æ¸…ç†ç»“æœ:",m)}catch(m){console.error("æ¸…ç†ä¸´æ—¶æ–‡ä»¶å¤±è´¥:",m)}},6e4)}catch(h){console.error("ä¸‹è½½æ‰€æœ‰å›¾ç‰‡æ—¶å‡ºé”™:",h),n.error(`ä¸‹è½½å¤±è´¥: ${h instanceof Error?h.message:String(h)}`)}finally{o.value=!1,setTimeout(()=>{i.value=0,r.value=""},2e3)}}return{isDownloading:o,downloadProgress:i,downloadProgressText:r,isImporting:a,importProgress:u,importProgressText:g,canExportText:S,canImportText:x,canDownload:_,exportText:D,exportTextToJson:R,importText:M,downloadCurrentImage:V,downloadAllImages:L}}const hl={key:0,class:"result-section card result-card"},yl={class:"image-controls"},xl={class:"image-size-control"},Sl=["value"],_l={id:"imageSizeValue"},Cl={class:"content-container"},kl={class:"image-container"},wl=["src"],Tl={id:"detectedTextInfo",class:"text-info"},$l={id:"detectedTextList"},Il={class:"original-text"},Rl={class:"download-section"},Pl={class:"download-buttons"},Dl=["disabled"],Ml={class:"download-all-container"},Bl=["disabled"],El={class:"download-format-selector"},Al=["disabled"],Ll=["disabled"],Fl={key:1,class:"empty-state-section"},lo=60,Ul=Ye({__name:"ImageResultDisplay",props:{isEditMode:{type:Boolean,default:!1}},emits:["toggle-edit-mode","retry-failed"],setup(s,{emit:t}){const n=[{label:"ZIPå‹ç¼©åŒ…",value:"zip"},{label:"PDFæ–‡æ¡£",value:"pdf"},{label:"CBZæ¼«ç”»",value:"cbz"}],o=t,i=ot(),r=Fe(),a=bl(),u=C(100),g=Q({get:()=>k.value?.showOriginal??!1,set:w=>{k.value&&i.updateCurrentImage({showOriginal:w})}}),S=C("zip"),x=C(null),_=Q(()=>a.isDownloading.value),D=Q(()=>a.downloadProgressText.value),R=Q(()=>a.downloadProgress.value),M=Q(()=>i.hasImages),k=Q(()=>i.currentImage),Y=Q(()=>!!k.value?.translatedDataURL),V=Q(()=>!!(k.value?.translatedDataURL||k.value?.originalDataURL)),L=Q(()=>k.value?g.value||!k.value.translatedDataURL?k.value.originalDataURL:k.value.translatedDataURL:""),v=Q(()=>i.failedImageCount>0),d=Q(()=>({width:`${u.value}%`})),h=Q(()=>r.settings.useTextboxPrompt),y=Q(()=>{if(!k.value)return[];if(k.value.bubbleStates&&k.value.bubbleStates.length>0)return k.value.bubbleStates.map(O=>({original:O.originalText||"",translated:h.value?O.textboxText||O.translatedText||"":O.translatedText||""}));const w=k.value.originalTexts||[],P=h.value?k.value.textboxTexts||k.value.bubbleTexts||[]:k.value.bubbleTexts||[];return w.length===0?[]:w.map((O,ee)=>({original:O||"",translated:P[ee]||""}))}),z=Q(()=>y.value.length>0);function F(w){if(!w||w.length<=lo)return w;let P="",O="";for(let ee=0;ee<w.length;ee++)if(O+=w[ee],O.length>=lo){let le=-1;for(let I=O.length-1;I>=0;I--){const q=O[I];if(q&&["ã€‚","ï¼","ï¼Ÿ",".","!","?","ï¼›",";","ï¼Œ",","].includes(q)){le=I+1;break}}le>lo*.6?(P+=O.substring(0,le)+`
`,O=O.substring(le)):(P+=O+`
`,O="")}return O&&(P+=O),P}function te(w){return F((w||"").trim())}function J(w){const P=(w||"").trim();return F(P)}function K(w){return(w||"").includes("ç¿»è¯‘å¤±è´¥")}function Z(){g.value=!g.value}function W(){o("toggle-edit-mode")}function oe(w){const P=w.target;u.value=parseInt(P.value,10)}function b(){o("retry-failed")}function c(){a.downloadCurrentImage()}function m(){a.downloadAllImages(S.value)}function l(){a.exportText()}function p(){x.value?.click()}async function $(w){const P=w.target,O=P.files?.[0];O&&(await a.importText(O),P.value="")}return(w,P)=>k.value?(A(),U("section",hl,[e("div",yl,[Y.value?(A(),U("button",{key:0,id:"toggleImageButton",class:"control-btn",onClick:Z},se(g.value?"æŸ¥çœ‹ç¿»è¯‘å›¾":"æŸ¥çœ‹åŸå›¾"),1)):fe("",!0),e("button",{id:"toggleEditModeButton",class:Ee(["control-btn",{active:s.isEditMode}]),onClick:W},se(s.isEditMode?"é€€å‡ºç¼–è¾‘":"åˆ‡æ¢ç¼–è¾‘æ¨¡å¼"),3),e("div",xl,[P[1]||(P[1]=e("label",{for:"imageSize"},"å›¾ç‰‡å¤§å°:",-1)),e("input",{type:"range",id:"imageSize",min:"50",max:"200",value:u.value,class:"slider range-slider",onInput:oe},null,40,Sl),e("span",_l,se(u.value)+"%",1)]),v.value?(A(),U("button",{key:1,id:"retranslateFailedButton",class:"retry-failed-btn",onClick:b,title:"é‡æ–°ç¿»è¯‘æ‰€æœ‰å¤±è´¥çš„å›¾ç‰‡"}," é‡æ–°ç¿»è¯‘å¤±è´¥å›¾ç‰‡ ("+se(re(i).failedImageCount)+") ",1)):fe("",!0)]),e("div",Cl,[e("div",kl,[e("img",{id:"translatedImageDisplay",src:L.value,alt:"ç¿»è¯‘åå›¾ç‰‡",style:at(d.value)},null,12,wl)])]),e("div",Tl,[P[6]||(P[6]=e("h3",null,"æ£€æµ‹åˆ°çš„æ–‡æœ¬ï¼ˆåŸæ–‡ â†’ è¯‘æ–‡ï¼‰",-1)),e("pre",$l,[z.value?(A(!0),U(We,{key:0},Qe(y.value,(O,ee)=>(A(),U("span",{key:ee,class:"text-item"},[e("span",Il,se(te(O.original)),1),P[2]||(P[2]=Ue(`
`,-1)),e("span",{class:Ee(["translated-text",{"translation-error":K(O.translated)}])},se(J(O.translated)),3),P[3]||(P[3]=Ue(`
`,-1)),P[4]||(P[4]=e("span",{class:"separator"},"â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€",-1)),P[5]||(P[5]=Ue(`

`,-1))]))),128)):(A(),U(We,{key:1},[Ue("æœªæ£€æµ‹åˆ°æ–‡æœ¬æˆ–å°šæœªç¿»è¯‘")],64))])]),e("div",Rl,[_.value?(A(),ut(yo,{key:0,visible:!0,percentage:R.value,label:D.value||"ä¸‹è½½ä¸­ï¼Œè¯·ç¨å€™..."},null,8,["percentage","label"])):fe("",!0),e("div",Pl,[e("button",{id:"downloadButton",class:"download-btn primary",disabled:!V.value,onClick:c}," ä¸‹è½½å½“å‰å›¾ç‰‡ ",8,Dl),e("div",Ml,[e("button",{id:"downloadAllImagesButton",class:"download-btn primary",disabled:!M.value,onClick:m}," ä¸‹è½½æ‰€æœ‰å›¾ç‰‡ ",8,Bl),e("div",El,[xe(Ne,{modelValue:S.value,"onUpdate:modelValue":P[0]||(P[0]=O=>S.value=O),options:n},null,8,["modelValue"])])]),e("button",{id:"exportTextButton",class:"download-btn success",disabled:!M.value,onClick:l}," å¯¼å‡ºæ–‡æœ¬ ",8,Al),e("button",{id:"importTextButton",class:"download-btn success",disabled:!M.value,onClick:p}," å¯¼å…¥æ–‡æœ¬ ",8,Ll),e("input",{type:"file",ref_key:"importFileInput",ref:x,id:"importTextFileInput",style:{display:"none"},accept:".json",onChange:$},null,544)])])])):(A(),U("section",Fl))}}),zl=je(Ul,[["__scopeId","data-v-a26b9c58"]]),Ol={class:"guide-content"},Vl={class:"guide-footer"},Nl={class:"dont-show-option"},Vt="saber_translator_dismiss_setup_reminder",Wl=Ye({__name:"FirstTimeGuide",emits:["openSettings"],setup(s,{expose:t,emit:n}){const o=n,i=C(!1),r=C(!1);dt(()=>{localStorage.getItem(Vt)!=="true"&&(i.value=!0)});function a(){r.value&&localStorage.setItem(Vt,"true"),i.value=!1}function u(){localStorage.setItem(Vt,"true"),i.value=!1,o("openSettings")}function g(){localStorage.removeItem(Vt)}return t({resetGuideState:g,showGuide:i}),(S,x)=>(A(),ut(hn,{"model-value":i.value,title:"æ¬¢è¿ä½¿ç”¨ Saber-Translator",onClose:a},{default:Ct(()=>[e("div",Ol,[x[3]||(x[3]=e("div",{class:"guide-icon"},"ğŸ‰",-1)),x[4]||(x[4]=e("div",{class:"guide-message"},[e("p",{class:"guide-title"},"é¦–æ¬¡ä½¿ç”¨æé†’"),e("p",{class:"guide-text"}," åœ¨å¼€å§‹ç¿»è¯‘ä¹‹å‰ï¼Œè¯·å…ˆé…ç½®ç¿»è¯‘æœåŠ¡ã€‚ "),e("p",{class:"guide-text"},[Ue(" ç‚¹å‡»å³ä¸Šè§’çš„ "),e("span",{class:"highlight"},"âš™ï¸ è®¾ç½®"),Ue(" æŒ‰é’®ï¼Œé…ç½®ä»¥ä¸‹å†…å®¹ï¼š ")]),e("ul",{class:"guide-list"},[e("li",null,"é€‰æ‹© OCR å¼•æ“ï¼ˆæ–‡å­—è¯†åˆ«ï¼‰"),e("li",null,"é…ç½®ç¿»è¯‘æœåŠ¡å•†å’Œ API Key"),e("li",null,"ï¼ˆå¯é€‰ï¼‰é…ç½®é«˜è´¨é‡ç¿»è¯‘å’Œ AI æ ¡å¯¹")])],-1)),e("div",{class:"guide-actions"},[e("button",{class:"guide-btn primary",onClick:u},[...x[1]||(x[1]=[e("span",{class:"btn-icon"},"âš™ï¸",-1),Ue(" ç«‹å³é…ç½® ",-1)])]),e("button",{class:"guide-btn secondary",onClick:a}," ç¨åé…ç½® ")]),e("div",Vl,[e("label",Nl,[ne(e("input",{type:"checkbox","onUpdate:modelValue":x[0]||(x[0]=_=>r.value=_)},null,512),[[nt,r.value]]),x[2]||(x[2]=e("span",null,"ä¸å†æ˜¾ç¤ºæ­¤æé†’",-1))])])])]),_:1},8,["model-value"]))}}),ql=je(Wl,[["__scopeId","data-v-eda18e4a"]]),io="saber_translator_dismiss_setup_reminder",Kl=["siliconflow","deepseek","volcano","caiyun","baidu_translate","youdao_translate","gemini","custom_openai"],Hl={manga_ocr:"MangaOCR",paddle_ocr:"PaddleOCR",baidu_ocr:"ç™¾åº¦OCR",ai_vision:"AIè§†è§‰OCR"},jl=["ollama","sakura"],Yl=["custom_openai"],Jl=["custom_openai"],Xl={siliconflow:"SiliconFlow",deepseek:"DeepSeek",volcano:"ç«å±±å¼•æ“",caiyun:"å½©äº‘å°è¯‘",baidu_translate:"ç™¾åº¦ç¿»è¯‘",youdao_translate:"æœ‰é“ç¿»è¯‘",gemini:"Google Gemini",custom_openai:"è‡ªå®šä¹‰ OpenAI",ollama:"Ollama",sakura:"Sakura"};function kn(){const s=Fe(),t=ct(),n=C(!1),o=C(!1),i=Q(()=>{try{return localStorage.getItem(io)==="true"}catch{return!1}});function r(y){return Xl[y]||y}function a(y){return Kl.includes(y)}function u(y){return jl.includes(y)}function g(y){return Yl.includes(y)}function S(y){return Jl.includes(y)}function x(y){return Hl[y]||y}function _(){const y=s.settings,z=y.ocrEngine,F=y.baiduOcr,te=y.aiVisionOcr,J=[];return z?(z==="baidu_ocr"&&((!F?.apiKey||F.apiKey.trim()==="")&&J.push("ç™¾åº¦OCR çš„ API Key"),(!F?.secretKey||F.secretKey.trim()==="")&&J.push("ç™¾åº¦OCR çš„ Secret Key")),z==="ai_vision"&&(te?.provider||J.push("AIè§†è§‰OCR çš„æœåŠ¡å•†"),(!te?.apiKey||te.apiKey.trim()==="")&&J.push("AIè§†è§‰OCR çš„ API Key"),(!te?.modelName||te.modelName.trim()==="")&&J.push("AIè§†è§‰OCR çš„æ¨¡å‹åç§°"),te?.provider==="custom"&&(!te?.customBaseUrl||te.customBaseUrl.trim()==="")&&J.push("AIè§†è§‰OCR çš„è‡ªå®šä¹‰ Base URL")),J.length>0?{valid:!1,message:`è¯·å…ˆåœ¨é¡¶éƒ¨ âš™ï¸ è®¾ç½®èœå•ä¸­å¡«å†™ ${J[0]}`,missingItems:J}:{valid:!0,message:""}):{valid:!1,message:"è¯·å…ˆåœ¨é¡¶éƒ¨ âš™ï¸ è®¾ç½®èœå•ä¸­é€‰æ‹© OCR å¼•æ“",missingItems:["OCR å¼•æ“"]}}function D(){const{translation:y}=s.settings,{provider:z,apiKey:F,modelName:te,customBaseUrl:J}=y,K=[];return z?(a(z)&&(!F||F.trim()==="")&&K.push(`${r(z)} çš„ API Key`),(!te||te.trim()==="")&&(u(z)||a(z))&&K.push(`${r(z)} çš„æ¨¡å‹åç§°`),g(z)&&(!J||J.trim()==="")&&K.push("è‡ªå®šä¹‰ OpenAI æœåŠ¡çš„ Base URL"),K.length>0?{valid:!1,message:`è¯·å…ˆåœ¨é¡¶éƒ¨ âš™ï¸ è®¾ç½®èœå•ä¸­å¡«å†™ ${K[0]}`,missingItems:K}:{valid:!0,message:""}):{valid:!1,message:"è¯·å…ˆåœ¨é¡¶éƒ¨ âš™ï¸ è®¾ç½®èœå•ä¸­é€‰æ‹©ç¿»è¯‘æœåŠ¡å•†",missingItems:["ç¿»è¯‘æœåŠ¡å•†"]}}function R(){const{hqTranslation:y}=s.settings,{provider:z,apiKey:F,modelName:te,customBaseUrl:J}=y,K=[];return z?((!F||F.trim()==="")&&K.push("é«˜è´¨é‡ç¿»è¯‘çš„ API Key"),(!te||te.trim()==="")&&K.push("é«˜è´¨é‡ç¿»è¯‘çš„æ¨¡å‹åç§°"),S(z)&&(!J||J.trim()==="")&&K.push("é«˜è´¨é‡ç¿»è¯‘çš„ Base URL"),K.length>0?{valid:!1,message:`è¯·å…ˆåœ¨é¡¶éƒ¨ âš™ï¸ è®¾ç½®èœå•ä¸­å¡«å†™ ${K[0]}`,missingItems:K}:{valid:!0,message:""}):{valid:!1,message:"è¯·å…ˆåœ¨é¡¶éƒ¨ âš™ï¸ è®¾ç½®èœå•ä¸­é€‰æ‹©é«˜è´¨é‡ç¿»è¯‘çš„æœåŠ¡å•†",missingItems:["é«˜è´¨é‡ç¿»è¯‘æœåŠ¡å•†"]}}function M(y){const z=y||s.settings.proofreading.rounds,F=[];if(!z||z.length===0)return{valid:!1,message:"è¯·å…ˆåœ¨é¡¶éƒ¨ âš™ï¸ è®¾ç½®èœå•ä¸­æ·»åŠ è‡³å°‘ä¸€ä¸ªæ ¡å¯¹è½®æ¬¡",missingItems:["æ ¡å¯¹è½®æ¬¡"]};for(let te=0;te<z.length;te++){const J=z[te];if(!J)continue;const K=J.name||`è½®æ¬¡${te+1}`;if(J.provider||F.push(`æ ¡å¯¹ ${K} çš„æœåŠ¡å•†`),(!J.apiKey||J.apiKey.trim()==="")&&F.push(`æ ¡å¯¹ ${K} çš„ API Key`),(!J.modelName||J.modelName.trim()==="")&&F.push(`æ ¡å¯¹ ${K} çš„æ¨¡å‹åç§°`),F.length>0)return{valid:!1,message:`è¯·å…ˆåœ¨é¡¶éƒ¨ âš™ï¸ è®¾ç½®èœå•ä¸­ä¸º ${F[0]}`,missingItems:F}}return{valid:!0,message:""}}function k(y="normal",z={}){let F;switch(y){case"normal":F=D();break;case"hq":F=R();break;case"proofread":F=M(z.proofreadingRounds);break;case"ocr":F=_();break;default:F=D()}return F.valid?!0:(t.error(F.message),V(),!1)}function Y(){const y=_();if(!y.valid)return t.error(y.message),V(),!1;const z=D();return z.valid?!0:(t.error(z.message),V(),!1)}function V(){const y=document.getElementById("openSettingsBtn");y&&(o.value=!0,y.style.animation="settingsBtnPulse 0.5s ease-in-out 3",y.style.boxShadow="0 0 10px var(--primary-color, #4a90d9)",setTimeout(()=>{y.style.animation="",y.style.boxShadow="",o.value=!1},3e3))}function L(){if(i.value){console.log("ç”¨æˆ·å·²é€‰æ‹©ä¸å†æ˜¾ç¤ºè®¾ç½®æé†’");return}n.value=!0}function v(y=!1){if(y)try{localStorage.setItem(io,"true"),console.log("ç”¨æˆ·é€‰æ‹©æ°¸ä¹…å…³é—­è®¾ç½®æé†’")}catch(z){console.error("ä¿å­˜è®¾ç½®æé†’çŠ¶æ€å¤±è´¥:",z)}n.value=!1}function d(){try{localStorage.removeItem(io),console.log("è®¾ç½®æé†’çŠ¶æ€å·²é‡ç½®")}catch(y){console.error("é‡ç½®è®¾ç½®æé†’çŠ¶æ€å¤±è´¥:",y)}}function h(){setTimeout(()=>{L()},500)}return{showSetupReminder:n,isSettingsButtonHighlighted:o,isSetupReminderDismissed:i,validateOcrConfig:_,validateTranslationConfig:D,validateHqTranslationConfig:R,validateProofreadingConfig:M,validateBeforeTranslation:k,validateFullTranslationConfig:Y,highlightSettingsButton:V,checkAndShowSetupReminder:L,closeSetupReminder:v,resetSetupReminderDismiss:d,initValidation:h,getProviderDisplayName:r,getOcrEngineDisplayName:x,requiresApiKey:a,isLocalProvider:u,requiresBaseUrl:g}}const gt=mo("bubble",()=>{const s=C([]),t=C(-1),n=C([]),o=C([]),i=C(!1),r=C(-1),a=C(0),u=C(0),g=C(0),S=C(0),x=C(!1),_=C(-1),D=C(null),R=C(!1),M=C(-1),k=C(0),Y=Q(()=>t.value>=0&&t.value<s.value.length?s.value[t.value]??null:null),V=Q(()=>s.value.length),L=Q(()=>s.value.length>0),v=Q(()=>t.value>=0),d=Q(()=>n.value.length>1),h=Q(()=>n.value.filter(T=>T>=0&&T<s.value.length).map(T=>s.value[T]).filter(T=>T!==void 0));function y(){const j=ot().currentImage;j&&(j.bubbleStates=Ot(s.value),j.hasUnsavedChanges=!0,console.log("æ°”æ³¡çŠ¶æ€å·²åŒæ­¥åˆ°å½“å‰å›¾ç‰‡"))}function z(T,j=!1){s.value=T,o.value=Ot(T),b(),console.log(`æ°”æ³¡æ•°ç»„å·²è®¾ç½®ï¼Œå…± ${T.length} ä¸ªæ°”æ³¡`),j||y()}function F(T,j){const ge=Ws(T),Re=Fe().settings.textStyle,we=Re.layoutDirection,be=we==="vertical"||we==="horizontal"?we:ge==="vertical"||ge==="horizontal"?ge:"vertical",X=Ns({coords:T,translatedText:"",autoTextDirection:ge,fontSize:Re.fontSize,fontFamily:Re.fontFamily,textDirection:be,textColor:Re.textColor,fillColor:Re.fillColor,inpaintMethod:Re.inpaintMethod,strokeEnabled:Re.strokeEnabled,strokeColor:Re.strokeColor,strokeWidth:Re.strokeWidth,rotationAngle:0,position:{x:0,y:0},...j});return s.value.push(X),console.log(`å·²æ·»åŠ æ°”æ³¡ï¼Œå½“å‰å…± ${s.value.length} ä¸ª`),y(),X}function te(T){return T<0||T>=s.value.length?(console.warn(`åˆ é™¤å¤±è´¥: æ— æ•ˆçš„ç´¢å¼• ${T}`),!1):(s.value.splice(T,1),t.value===T?t.value=-1:t.value>T&&t.value--,n.value=n.value.filter(j=>j!==T).map(j=>j>T?j-1:j),console.log(`å·²åˆ é™¤æ°”æ³¡ï¼Œå½“å‰å…± ${s.value.length} ä¸ª`),y(),!0)}function J(){if(n.value.length===0&&t.value<0)return;const T=[...new Set([...n.value,t.value])].filter(j=>j>=0).sort((j,ge)=>ge-j);for(const j of T)s.value.splice(j,1);b(),console.log(`å·²åˆ é™¤ ${T.length} ä¸ªæ°”æ³¡`),y()}function K(){s.value=[],o.value=[],b(),console.log("æ‰€æœ‰æ°”æ³¡å·²æ¸…é™¤"),y()}function Z(){s.value=[],o.value=[],b(),console.log("æœ¬åœ°æ°”æ³¡çŠ¶æ€å·²æ¸…é™¤ï¼ˆä¸åŒæ­¥åˆ°imageStoreï¼‰")}function W(T){T>=-1&&T<s.value.length&&(t.value=T,n.value=T>=0?[T]:[],console.log(`å·²é€‰ä¸­æ°”æ³¡ ${T}`))}function oe(T){if(T<0||T>=s.value.length)return;const j=n.value.indexOf(T);j>=0?(n.value.splice(j,1),t.value===T&&(t.value=n.value[0]??-1)):(n.value.push(T),t.value=T),console.log(`å¤šé€‰çŠ¶æ€: ${n.value.join(", ")}`)}function b(){t.value=-1,n.value=[]}function c(){t.value>=0?n.value=[t.value]:n.value=[]}function m(){if(s.value.length===0)return!1;const T=t.value<s.value.length-1?t.value+1:0;return W(T),!0}function l(){if(s.value.length===0)return!1;const T=t.value>0?t.value-1:s.value.length-1;return W(T),!0}function p(T,j){if(T<0||T>=s.value.length)return console.warn(`æ›´æ–°å¤±è´¥: æ— æ•ˆçš„ç´¢å¼• ${T}`),!1;const ge=s.value[T];return ge?(Object.assign(ge,j),console.log(`å·²æ›´æ–°æ°”æ³¡ ${T}`),y(),!0):!1}function $(T){return t.value<0?(console.warn("æ›´æ–°å¤±è´¥: æ²¡æœ‰é€‰ä¸­çš„æ°”æ³¡"),!1):p(t.value,T)}function w(T){const j=n.value.length>0?n.value:t.value>=0?[t.value]:[];for(const ge of j){const Se=s.value[ge];Se&&Object.assign(Se,T)}y(),console.log(`å·²æ‰¹é‡æ›´æ–° ${j.length} ä¸ªæ°”æ³¡`)}function P(T){for(let j=0;j<s.value.length;j++){const ge=s.value[j];ge&&Object.assign(ge,T)}y(),console.log(`å·²æ›´æ–°æ‰€æœ‰ ${s.value.length} ä¸ªæ°”æ³¡`)}function O(){if(s.value.length!==o.value.length)return!0;for(let T=0;T<s.value.length;T++){const j=s.value[T],ge=o.value[T];if(!(!j||!ge)&&(j.translatedText!==ge.translatedText||j.textboxText!==ge.textboxText||j.fontSize!==ge.fontSize||j.fontFamily!==ge.fontFamily||j.textDirection!==ge.textDirection||j.textColor!==ge.textColor||j.fillColor!==ge.fillColor||j.rotationAngle!==ge.rotationAngle||j.strokeEnabled!==ge.strokeEnabled||j.strokeColor!==ge.strokeColor||j.strokeWidth!==ge.strokeWidth||j.inpaintMethod!==ge.inpaintMethod||JSON.stringify(j.coords)!==JSON.stringify(ge.coords)))return!0}return!1}function ee(){s.value=Ot(o.value),b(),console.log("æ°”æ³¡çŠ¶æ€å·²é‡ç½®åˆ°åˆå§‹çŠ¶æ€")}function le(){o.value=Ot(s.value),console.log("å½“å‰çŠ¶æ€å·²ä¿å­˜ä¸ºåˆå§‹çŠ¶æ€")}function I(){return{bubble_coords:s.value.map(T=>T.coords),bubble_texts:s.value.map(T=>T.translatedText),textbox_texts:s.value.map(T=>T.textboxText),font_sizes:s.value.map(T=>T.fontSize),font_families:s.value.map(T=>T.fontFamily),text_directions:s.value.map(T=>T.textDirection==="vertical"||T.textDirection==="horizontal"?T.textDirection==="vertical"?"v":"h":T.autoTextDirection==="vertical"||T.autoTextDirection==="horizontal"?T.autoTextDirection==="vertical"?"v":"h":"v"),text_colors:s.value.map(T=>T.textColor),fill_colors:s.value.map(T=>T.fillColor),rotation_angles:s.value.map(T=>T.rotationAngle),stroke_enabled:s.value.map(T=>T.strokeEnabled),stroke_colors:s.value.map(T=>T.strokeColor),stroke_widths:s.value.map(T=>T.strokeWidth),inpaint_methods:s.value.map(T=>T.inpaintMethod)}}function q(){return JSON.stringify(s.value)}function ae(T){try{const j=JSON.parse(T);if(!Array.isArray(j))return console.error("ååºåˆ—åŒ–å¤±è´¥: æ•°æ®ä¸æ˜¯æ•°ç»„"),!1;const ge=[];for(const Se of j)qs(Se)?ge.push(Se):console.warn("è·³è¿‡æ— æ•ˆçš„æ°”æ³¡çŠ¶æ€:",Se);return z(ge),!0}catch(j){return console.error("ååºåˆ—åŒ–å¤±è´¥:",j),!1}}return{bubbles:s,selectedIndex:t,selectedIndices:n,initialStates:o,isDragging:i,draggingIndex:r,dragOffsetX:a,dragOffsetY:u,dragInitialX:g,dragInitialY:S,isResizing:x,resizingIndex:_,resizeCurrentCoords:D,isRotating:R,rotatingIndex:M,rotateCurrentAngle:k,selectedBubble:Y,bubbleCount:V,hasBubbles:L,hasSelection:v,isMultiSelect:d,selectedBubbles:h,setBubbles:z,addBubble:F,deleteBubble:te,deleteSelected:J,clearBubbles:K,clearBubblesLocal:Z,selectBubble:W,toggleMultiSelect:oe,clearSelection:b,clearMultiSelect:c,selectNext:m,selectPrevious:l,updateBubble:p,updateSelectedBubble:$,updateAllSelected:w,updateAllBubbles:P,hasChanges:O,resetToInitial:ee,saveAsInitial:le,toApiRequest:I,serialize:q,deserialize:ae}}),Gl=Object.freeze(Object.defineProperty({__proto__:null,useBubbleStore:gt},Symbol.toStringTag,{value:"Module"}));function Zl(){const s=C({current:0,total:0,completed:0,failed:0,isInProgress:!1,label:"",percentage:0});return{progress:s,reporter:{init(n,o){s.value={current:0,total:n,completed:0,failed:0,isInProgress:!0,label:o||"å‡†å¤‡ä¸­...",percentage:0}},update(n,o){s.value.current=n,o!==void 0&&(s.value.label=o),s.value.total>0&&(s.value.percentage=Math.round(n/s.value.total*100))},setPercentage(n,o){s.value.percentage=Math.min(100,Math.max(0,n)),o!==void 0&&(s.value.label=o)},incrementCompleted(){s.value.completed++},incrementFailed(){s.value.failed++},finish(){s.value.isInProgress=!1,s.value.percentage=100},getProgress(){return{...s.value}}}}}async function xo(s){return Je.post("/api/parallel/detect",s)}async function So(s){return Je.post("/api/parallel/ocr",s)}async function _o(s){return Je.post("/api/parallel/color",s)}async function Co(s){return Je.post("/api/parallel/translate",s)}async function ko(s){return Je.post("/api/parallel/inpaint",s)}async function wo(s){return Je.post("/api/parallel/render",s)}const Ql=Object.freeze(Object.defineProperty({__proto__:null,parallelColor:_o,parallelDetect:xo,parallelInpaint:ko,parallelOcr:So,parallelRender:wo,parallelTranslate:Co},Symbol.toStringTag,{value:"Module"}));let $t=null,Lt=!1;function Rt(){const s=It();return Fe().settings.autoSaveInBookshelfMode&&s.isBookshelfMode}function To(){const s=It(),t=s.currentBookId,n=s.currentChapterId;return!t||!n?null:`bookshelf/${t}/${n}`}function wn(){const s=Fe(),{textStyle:t}=s.settings;return{fontSize:t.fontSize,autoFontSize:t.autoFontSize,fontFamily:t.fontFamily,layoutDirection:t.layoutDirection,textColor:t.textColor,useInpaintingMethod:t.inpaintMethod,fillColor:t.fillColor,strokeEnabled:t.strokeEnabled,strokeColor:t.strokeColor,strokeWidth:t.strokeWidth,useAutoTextColor:t.useAutoTextColor}}async function Tn(s){const t=ot();if(!Rt())return console.log("[AutoSave] è‡ªåŠ¨ä¿å­˜æœªå¯ç”¨æˆ–éä¹¦æ¶æ¨¡å¼ï¼Œè·³è¿‡é¢„ä¿å­˜"),!0;const n=To();if(!n)return console.warn("[AutoSave] ç¼ºå°‘ä¹¦ç±/ç« èŠ‚IDï¼Œè·³è¿‡é¢„ä¿å­˜"),s?.onError?.("ç¼ºå°‘ä¹¦ç±/ç« èŠ‚ID"),!1;const o=t.images,i=o.length;if(i===0)return console.warn("[AutoSave] æ²¡æœ‰å›¾ç‰‡ï¼Œè·³è¿‡é¢„ä¿å­˜"),s?.onError?.("æ²¡æœ‰å›¾ç‰‡"),!1;console.log(`[AutoSave] é¢„ä¿å­˜å¼€å§‹ï¼š${i} é¡µï¼ˆé€é¡µä¿å­˜ï¼‰`),s?.onStart?.(i);try{const{saveAllPagesSequentially:r,saveSessionMeta:a}=await rt(async()=>{const{saveAllPagesSequentially:D,saveSessionMeta:R}=await Promise.resolve().then(()=>Cn);return{saveAllPagesSequentially:D,saveSessionMeta:R}},void 0),u=wn(),g=await r(n,o,{onProgress:(D,R)=>{s?.onProgress?.(D,R)}});await a(n,{ui_settings:u,total_pages:i,currentImageIndex:t.currentImageIndex});const S=It(),x=S.currentBookId,_=S.currentChapterId;if(x&&_)try{const{apiClient:D}=await rt(async()=>{const{apiClient:R}=await import("./client.Bht704G-.js");return{apiClient:R}},__vite__mapDeps([4,5]));await D.put(`/api/bookshelf/books/${x}/chapters/${_}/image-count`,{count:i}),console.log(`[AutoSave] å·²æ›´æ–°ç« èŠ‚å›¾ç‰‡æ•°é‡ä¸º ${i}`)}catch(D){console.warn("[AutoSave] æ›´æ–°ç« èŠ‚å›¾ç‰‡æ•°é‡å¤±è´¥ï¼ˆéè‡´å‘½ï¼‰:",D)}return $t=n,Lt=!0,console.log(`[AutoSave] é¢„ä¿å­˜å®Œæˆï¼Œå…±ä¿å­˜ ${g}/${i} é¡µ`),s?.onComplete?.(),!0}catch(r){console.error("[AutoSave] é¢„ä¿å­˜å¤±è´¥:",r);const a=r instanceof Error?r.message:"é¢„ä¿å­˜å¤±è´¥";return s?.onError?.(a),$t=null,Lt=!1,!1}}async function $n(s){if(!Rt())return;const t=$t||To();if(!t){console.warn("[AutoSave] ä¼šè¯è·¯å¾„ä¸å­˜åœ¨ï¼Œè·³è¿‡ä¿å­˜");return}const n=ot(),o=n.images[s];if(!o){console.warn(`[AutoSave] é¡µé¢ ${s} ä¸å­˜åœ¨`);return}try{const i={};o.translatedDataURL?.startsWith("data:")&&(i.translated=o.translatedDataURL),o.cleanImageData&&typeof o.cleanImageData=="string"&&!o.cleanImageData.startsWith("/api/")&&(i.clean=o.cleanImageData.startsWith("data:")?o.cleanImageData:`data:image/png;base64,${o.cleanImageData}`);const r={};for(const u of Object.keys(o))["originalDataURL","translatedDataURL","cleanImageData"].includes(u)||(r[u]=o[u]);i.meta=r;const a=await _n(t,s,i);if(!a.success)throw new Error(a.error||"ä¿å­˜å¤±è´¥");n.updateImageByIndex(s,{hasUnsavedChanges:!1}),console.log(`[AutoSave] é¡µé¢ ${s+1} å·²ä¿å­˜`)}catch(i){throw console.error(`[AutoSave] ä¿å­˜é¡µé¢ ${s+1} å¤±è´¥:`,i),i}}async function In(){if(!Rt())return;const s=$t||To();if(!s||!Lt){console.log("[AutoSave] æœªæ‰§è¡Œé¢„ä¿å­˜ï¼Œè·³è¿‡å®Œæˆä¿å­˜");return}console.log("[AutoSave] å®Œæˆä¿å­˜...");const t=ot(),n=It(),o=t.images.length;try{await xn(s,{ui_settings:wn(),total_pages:o,currentImageIndex:t.currentImageIndex});const i=n.currentBookId,r=n.currentChapterId;if(i&&r)try{const{apiClient:a}=await rt(async()=>{const{apiClient:u}=await import("./client.Bht704G-.js");return{apiClient:u}},__vite__mapDeps([4,5]));await a.put(`/api/bookshelf/books/${i}/chapters/${r}/image-count`,{count:o}),console.log(`[AutoSave] å·²æ›´æ–°ç« èŠ‚å›¾ç‰‡æ•°é‡ä¸º ${o}`)}catch(a){console.warn("[AutoSave] æ›´æ–°ç« èŠ‚å›¾ç‰‡æ•°é‡å¤±è´¥ï¼ˆéè‡´å‘½ï¼‰:",a)}console.log("[AutoSave] ä¼šè¯ä¿å­˜å®Œæˆ")}catch(i){console.error("[AutoSave] å®Œæˆä¿å­˜å¤±è´¥:",i)}finally{$t=null,Lt=!1}}function Rn(){$t=null,Lt=!1,console.log("[AutoSave] ä¿å­˜çŠ¶æ€å·²é‡ç½®")}const un={standard:["detection","ocr","color","translate","inpaint","render"],hq:["detection","ocr","color","aiTranslate","inpaint","render"],proofread:["aiTranslate","render"],removeText:["detection","inpaint","render"]},Nt={detection:"æ°”æ³¡æ£€æµ‹",ocr:"æ–‡å­—è¯†åˆ«",color:"é¢œè‰²æå–",translate:"ç¿»è¯‘",aiTranslate:"AIç¿»è¯‘",inpaint:"èƒŒæ™¯ä¿®å¤",render:"æ¸²æŸ“",save:"ä¿å­˜"};function ei(){const s=ot(),t=gt(),n=Fe(),o=kn(),i=ct(),{progress:r,reporter:a}=Zl(),u=C(!1),g=C(null);let S=null,x="standard";const _=Q(()=>u.value||s.isBatchTranslationInProgress),D=Q(()=>r.value.percentage||0);function R(){const l=n.settings.translation.rpmLimit;g.value?g.value.setRpm(l):g.value=Ks(l)}function M(l){const p=l.mode==="hq"?"hq":l.mode==="proofread"?"proofread":l.mode==="removeText"?"ocr":"normal";return o.validateBeforeTranslation(p)}function k(){const{textStyle:l}=n.settings,p=l.layoutDirection;S={fontFamily:l.fontFamily,fontSize:l.fontSize,autoFontSize:l.autoFontSize,autoTextDirection:p==="auto",textDirection:p==="auto"?"vertical":p,layoutDirection:p,fillColor:l.fillColor,textColor:l.textColor,rotationAngle:0,strokeEnabled:l.strokeEnabled,strokeColor:l.strokeColor,strokeWidth:l.strokeWidth,useAutoTextColor:l.useAutoTextColor,inpaintMethod:l.inpaintMethod}}function Y(l){return l.includes("base64,")?l.split("base64,")[1]||"":l}function V(l){const p=s.images;if(l.scope==="current"){const $=s.currentImage;return $?[{image:$,index:s.currentImageIndex}]:[]}if(l.scope==="failed")return s.getFailedImageIndices().map($=>({image:p[$],index:$})).filter($=>$.image!==void 0);if(l.scope==="range"&&l.pageRange){const $=Math.max(0,l.pageRange.startPage-1),w=Math.min(p.length-1,l.pageRange.endPage-1);return $>w||$>=p.length?[]:p.slice($,w+1).map((P,O)=>({image:P,index:$+O}))}return p.map(($,w)=>({image:$,index:w}))}async function L(l){const p=n.settings,$=Y(l.image.originalDataURL),w=await xo({image:$,detector_type:p.textDetector,box_expand_ratio:p.boxExpand.ratio,box_expand_top:p.boxExpand.top,box_expand_bottom:p.boxExpand.bottom,box_expand_left:p.boxExpand.left,box_expand_right:p.boxExpand.right});if(!w.success)throw new Error(w.error||"æ£€æµ‹å¤±è´¥");l.bubbleCoords=w.bubble_coords||[],l.bubbleAngles=w.bubble_angles||[],l.bubblePolygons=w.bubble_polygons||[],l.autoDirections=w.auto_directions||[],l.rawMask=w.raw_mask,l.textlinesPerBubble=w.textlines_per_bubble||[]}async function v(l){if(l.bubbleCoords.length===0){l.originalTexts=[];return}const p=n.settings,$=Y(l.image.originalDataURL),w=p.ocrEngine==="paddleocr_vl"?p.paddleOcrVl?.sourceLanguage||"japanese":p.sourceLanguage,P=await So({image:$,bubble_coords:l.bubbleCoords,source_language:w,ocr_engine:p.ocrEngine,baidu_api_key:p.baiduOcr?.apiKey,baidu_secret_key:p.baiduOcr?.secretKey,baidu_version:p.baiduOcr?.version,baidu_ocr_language:p.baiduOcr?.sourceLanguage,ai_vision_provider:p.aiVisionOcr?.provider,ai_vision_api_key:p.aiVisionOcr?.apiKey,ai_vision_model_name:p.aiVisionOcr?.modelName,ai_vision_ocr_prompt:p.aiVisionOcr?.prompt,custom_ai_vision_base_url:p.aiVisionOcr?.customBaseUrl,textlines_per_bubble:l.textlinesPerBubble});if(!P.success)throw new Error(P.error||"OCRå¤±è´¥");l.originalTexts=P.original_texts||[]}async function d(l){if(l.bubbleCoords.length===0){l.colors=[];return}const p=Y(l.image.originalDataURL),$=await _o({image:p,bubble_coords:l.bubbleCoords,textlines_per_bubble:l.textlinesPerBubble});if(!$.success)throw new Error($.error||"é¢œè‰²æå–å¤±è´¥");l.colors=$.colors||[]}async function h(l){if(l.originalTexts.length===0){l.translatedTexts=[],l.textboxTexts=[];return}const p=n.settings,$=await Co({original_texts:l.originalTexts,target_language:p.targetLanguage,source_language:p.sourceLanguage,model_provider:p.translation.provider,model_name:p.translation.modelName,api_key:p.translation.apiKey,custom_base_url:p.translation.customBaseUrl,prompt_content:p.translatePrompt,textbox_prompt_content:p.textboxPrompt,use_textbox_prompt:p.useTextboxPrompt,rpm_limit:p.translation.rpmLimit,max_retries:p.translation.maxRetries,use_json_format:p.translation.isJsonMode});if(!$.success)throw new Error($.error||"ç¿»è¯‘å¤±è´¥");l.translatedTexts=$.translated_texts||[],l.textboxTexts=$.textbox_texts||[]}async function y(l){const p=n.settings,$=x==="proofread",w=l.map(be=>$?{imageIndex:be.imageIndex,bubbles:(be.image.bubbleStates||[]).map((X,f)=>({bubbleIndex:f,original:X.originalText||"",translated:p.useTextboxPrompt?X.textboxText||X.translatedText||"":X.translatedText||"",textDirection:X.textDirection==="vertical"||X.textDirection==="horizontal"?X.textDirection:X.autoTextDirection==="vertical"||X.autoTextDirection==="horizontal"?X.autoTextDirection:"vertical"}))}:{imageIndex:be.imageIndex,bubbles:be.originalTexts.map((X,f)=>({bubbleIndex:f,original:X,translated:"",textDirection:be.autoDirections[f]||"vertical"}))}),P=l.map(be=>{const X=$&&be.image.translatedDataURL||be.image.originalDataURL;return Y(X)}),O=$?p.proofreading.rounds[0]:p.hqTranslation,ee=$?O?.prompt:p.hqTranslation.prompt,le=$?"ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ¼«ç”»ç¿»è¯‘æ ¡å¯¹åŠ©æ‰‹ï¼Œèƒ½å¤Ÿæ ¹æ®æ¼«ç”»å›¾åƒå†…å®¹æ£€æŸ¥å’Œä¿®æ­£ç¿»è¯‘ã€‚":"ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ¼«ç”»ç¿»è¯‘åŠ©æ‰‹ï¼Œèƒ½å¤Ÿæ ¹æ®æ¼«ç”»å›¾åƒå†…å®¹å’Œä¸Šä¸‹æ–‡æä¾›é«˜è´¨é‡çš„ç¿»è¯‘ã€‚",I=JSON.stringify(w,null,2),q=[{type:"text",text:(ee||"")+`

ä»¥ä¸‹æ˜¯JSONæ•°æ®:
\`\`\`json
`+I+"\n```"}];for(const be of P)q.push({type:"image_url",image_url:{url:`data:image/png;base64,${be}`}});const ae=[{role:"system",content:le},{role:"user",content:q}],T=p.hqTranslation,j=$?O:null,ge=await Et({provider:($?j?.provider:T.provider)||"openai",api_key:($?j?.apiKey:T.apiKey)||"",model_name:($?j?.modelName:T.modelName)||"",custom_base_url:$?j?.customBaseUrl:T.customBaseUrl,messages:ae,low_reasoning:$?j?.lowReasoning:T.lowReasoning,force_json_output:$?j?.forceJsonOutput:T.forceJsonOutput,no_thinking_method:$?j?.noThinkingMethod:T.noThinkingMethod,use_stream:$?!1:T.useStream,max_retries:$?p.proofreading.maxRetries||2:T.maxRetries||2}),Se=$?j?.forceJsonOutput||!1:T.forceJsonOutput;let we=J(ge,Se)||w;if($&&p.proofreading.rounds.length>1)for(let be=1;be<p.proofreading.rounds.length;be++){const X=p.proofreading.rounds[be],f=JSON.stringify(we,null,2),N=[{type:"text",text:X.prompt+`

ä»¥ä¸‹æ˜¯JSONæ•°æ®:
\`\`\`json
`+f+"\n```"}];for(const G of P)N.push({type:"image_url",image_url:{url:`data:image/png;base64,${G}`}});const pe=[{role:"system",content:le},{role:"user",content:N}],me=await Et({provider:X.provider,api_key:X.apiKey,model_name:X.modelName,custom_base_url:X.customBaseUrl,messages:pe,low_reasoning:X.lowReasoning,force_json_output:X.forceJsonOutput,no_thinking_method:X.noThinkingMethod,use_stream:!1,max_retries:X.maxRetries||p.proofreading.maxRetries||2}),B=J(me,X.forceJsonOutput);B&&(we=B)}for(const be of l){const X=we?.find(f=>f.imageIndex===be.imageIndex);X?be.translatedTexts=X.bubbles.map(f=>f.translated):be.translatedTexts=[],be.textboxTexts=[]}}async function z(l){if(l.bubbleCoords.length===0){l.cleanImage=Y(l.image.originalDataURL);return}const p=n.settings,{textStyle:$,preciseMask:w}=p,P=Y(l.image.originalDataURL),O=await ko({image:P,bubble_coords:l.bubbleCoords,bubble_polygons:l.bubblePolygons,raw_mask:l.rawMask,method:$.inpaintMethod==="solid"?"solid":"lama",lama_model:$.inpaintMethod==="litelama"?"litelama":"lama_mpe",fill_color:$.fillColor,mask_dilate_size:w.dilateSize,mask_box_expand_ratio:w.boxExpandRatio});if(!O.success)throw new Error(O.error||"èƒŒæ™¯ä¿®å¤å¤±è´¥");l.cleanImage=O.clean_image}async function F(l){if(!l.cleanImage)throw x==="proofread"?new Error("æ­¤å›¾ç‰‡å°šæœªç¿»è¯‘ï¼Œè¯·å…ˆç¿»è¯‘åå†è¿›è¡Œæ ¡å¯¹"):new Error("ç¼ºå°‘å¹²å‡€èƒŒæ™¯å›¾ç‰‡");const{textStyle:p}=n.settings,$=S?.autoTextDirection?"auto":S?.textDirection||p.layoutDirection,w=l.bubbleCoords.map((O,ee)=>{const le=l.autoDirections[ee]||"vertical",I=le==="v"?"vertical":le==="h"?"horizontal":le==="vertical"||le==="horizontal"?le:"vertical",q=$==="vertical"||$==="horizontal"?$:I,ae=S?.useAutoTextColor??p.useAutoTextColor;let T=S?.textColor||p.textColor,j=S?.fillColor||p.fillColor;const ge=l.colors[ee];return ae&&ge&&(ge.textColor&&(T=ge.textColor),ge.bgColor&&(j=ge.bgColor)),{coords:O,polygon:[],position:{x:0,y:0},rotationAngle:l.bubbleAngles[ee]||0,originalText:l.originalTexts[ee]||"",translatedText:l.translatedTexts[ee]||"",textboxText:l.textboxTexts[ee]||"",textDirection:q,autoTextDirection:I,fontSize:S?.fontSize||p.fontSize,fontFamily:S?.fontFamily||p.fontFamily,autoFontSize:S?.autoFontSize??p.autoFontSize,textColor:T,fillColor:j,strokeEnabled:S?.strokeEnabled??p.strokeEnabled,strokeColor:S?.strokeColor||p.strokeColor,strokeWidth:S?.strokeWidth||p.strokeWidth,inpaintMethod:S?.inpaintMethod||p.inpaintMethod,autoFgColor:l.colors[ee]?.autoFgColor||null,autoBgColor:l.colors[ee]?.autoBgColor||null}}),P=await wo({clean_image:l.cleanImage,bubble_states:w,fontSize:S?.fontSize||p.fontSize,fontFamily:S?.fontFamily||p.fontFamily,textDirection:S?.textDirection||p.layoutDirection,textColor:S?.textColor||p.textColor,strokeEnabled:S?.strokeEnabled??p.strokeEnabled,strokeColor:S?.strokeColor||p.strokeColor,strokeWidth:S?.strokeWidth||p.strokeWidth,autoFontSize:S?.autoFontSize??p.autoFontSize,use_individual_styles:!0});if(!P.success)throw new Error(P.error||"æ¸²æŸ“å¤±è´¥");l.finalImage=P.final_image,l.bubbleStates=P.bubble_states||w}async function te(l,p){switch(l){case"detection":await L(p);break;case"ocr":await v(p);break;case"color":await d(p);break;case"translate":await h(p);break;case"inpaint":await z(p);break;case"render":await F(p);break;case"save":await $n(p.imageIndex);break;case"aiTranslate":throw new Error("aiTranslate åº”é€šè¿‡æ‰¹é‡å¤„ç†é€»è¾‘è°ƒç”¨")}}function J(l,p){if(!l.success)return console.error("APIè°ƒç”¨å¤±è´¥:",l.error),null;if(l.results&&l.results.length>0){const w=l.results[0];if(w&&"imageIndex"in w&&"bubbles"in w)return l.results}const $=l.content;if($)if(p)try{return JSON.parse($)}catch{return null}else{const w=$.match(/```json\s*([\s\S]*?)\s*```/);if(w?.[1])try{return JSON.parse(w[1])}catch{return null}}return null}function K(l){const p=l.finalImage?`data:image/png;base64,${l.finalImage}`:l.cleanImage?`data:image/png;base64,${l.cleanImage}`:null,{textStyle:$}=n.settings;s.updateImageByIndex(l.imageIndex,{translatedDataURL:p,cleanImageData:l.cleanImage||null,bubbleStates:l.bubbleStates,bubbleCoords:l.bubbleCoords,bubbleAngles:l.bubbleAngles,originalTexts:l.originalTexts,textboxTexts:l.textboxTexts,bubbleTexts:l.translatedTexts,translationStatus:"completed",translationFailed:!1,showOriginal:!1,hasUnsavedChanges:!0,fontSize:S?.fontSize??$.fontSize,autoFontSize:S?.autoFontSize??$.autoFontSize,fontFamily:S?.fontFamily??$.fontFamily,layoutDirection:S?.layoutDirection??$.layoutDirection,textColor:S?.textColor??$.textColor,fillColor:S?.fillColor??$.fillColor,strokeEnabled:S?.strokeEnabled??$.strokeEnabled,strokeColor:S?.strokeColor??$.strokeColor,strokeWidth:S?.strokeWidth??$.strokeWidth,inpaintMethod:S?.inpaintMethod??$.inpaintMethod,useAutoTextColor:S?.useAutoTextColor??$.useAutoTextColor}),l.imageIndex===s.currentImageIndex&&l.bubbleStates&&t.setBubbles(l.bubbleStates)}function Z(l){return l==="standard"||l==="removeText"}function W(l){const p=n.settings;return l==="hq"?p.hqTranslation.batchSize||5:l==="proofread"?p.proofreading.rounds[0]?.batchSize||5:1}async function oe(l,p,$,w){let P=0,O=0;for(let ee=0;ee<l.length;ee++){const le=l[ee];if($.scope==="all"&&!s.isBatchTranslationInProgress){console.log("â¹ï¸ æ‰¹é‡ç¿»è¯‘å·²å–æ¶ˆï¼Œåœæ­¢å¤„ç†");break}const I=Math.floor(ee/l.length*90);a.setPercentage(I,`å¤„ç†å›¾ç‰‡ ${ee+1}/${l.length}`),i.info(`å¤„ç†å›¾ç‰‡ ${ee+1}/${l.length}...`),s.setTranslationStatus(le.imageIndex,"processing");let q=!1;for(let ae=0;ae<p.length;ae++){const T=p[ae];if(q)break;g.value&&await g.value.acquire();try{const j=I+Math.floor(ae/p.length*(90/l.length));a.setPercentage(j,`å›¾ç‰‡ ${ee+1}: ${Nt[T]}`),await te(T,le)}catch(j){const ge=j instanceof Error?j.message:"æœªçŸ¥é”™è¯¯";w.push(`å›¾ç‰‡ ${le.imageIndex+1}: ${T} - ${ge}`),s.setTranslationStatus(le.imageIndex,"failed",ge),q=!0,O++}}q||(K(le),P++,console.log(`âœ… å›¾ç‰‡ ${ee+1}/${l.length} å¤„ç†å®Œæˆ`))}return{completed:P,failed:O}}async function b(l,p,$,w){let P=0,O=0;const ee=W($.mode),le=Math.ceil(l.length/ee),I=p.indexOf("aiTranslate"),q=I>=0?p.slice(0,I):p,ae=I>=0?p.slice(I+1):[];console.log(`ğŸ“¦ æ‰¹æ¬¡å¤„ç†æ¨¡å¼ï¼šå…± ${l.length} å¼ å›¾ç‰‡ï¼Œæ¯æ‰¹ ${ee} å¼ ï¼Œå…± ${le} æ‰¹`),console.log(`   AIç¿»è¯‘å‰æ­¥éª¤: [${q.join(" â†’ ")}]`),console.log(`   AIç¿»è¯‘åæ­¥éª¤: [${ae.join(" â†’ ")}]`);for(let T=0;T<le;T++){if($.scope==="all"&&!s.isBatchTranslationInProgress){console.log("â¹ï¸ æ‰¹é‡ç¿»è¯‘å·²å–æ¶ˆï¼Œåœæ­¢å¤„ç†");break}const j=T*ee,ge=Math.min(j+ee,l.length),Se=l.slice(j,ge),Re=Math.floor(T/le*90);a.setPercentage(Re,`å¤„ç†æ‰¹æ¬¡ ${T+1}/${le}`),i.info(`å¤„ç†æ‰¹æ¬¡ ${T+1}/${le}ï¼ˆå›¾ç‰‡ ${j+1}-${ge}ï¼‰...`);for(const be of Se)s.setTranslationStatus(be.imageIndex,"processing");const we=new Set;for(let be=0;be<Se.length;be++){const X=Se[be];for(const f of q){if(we.has(X.imageIndex))break;g.value&&await g.value.acquire();try{const N=Re+Math.floor(be/Se.length*30);a.setPercentage(N,`å›¾ç‰‡ ${j+be+1}: ${Nt[f]}`),await te(f,X)}catch(N){const pe=N instanceof Error?N.message:"æœªçŸ¥é”™è¯¯";w.push(`å›¾ç‰‡ ${X.imageIndex+1}: ${f} - ${pe}`),s.setTranslationStatus(X.imageIndex,"failed",pe),we.add(X.imageIndex)}}}if(I>=0){const be=Re+40;a.setPercentage(be,`æ‰¹æ¬¡ ${T+1}: ${Nt.aiTranslate}`);try{const X=Se.filter(f=>!we.has(f.imageIndex));X.length>0&&await y(X)}catch(X){const f=X instanceof Error?X.message:"æœªçŸ¥é”™è¯¯";w.push(`æ‰¹æ¬¡ ${T+1} AIç¿»è¯‘å¤±è´¥: ${f}`);for(const N of Se)we.has(N.imageIndex)||(s.setTranslationStatus(N.imageIndex,"failed",f),we.add(N.imageIndex))}}for(let be=0;be<Se.length;be++){const X=Se[be];if(!we.has(X.imageIndex)){for(const f of ae){if(we.has(X.imageIndex))break;g.value&&await g.value.acquire();try{const N=Re+50+Math.floor(be/Se.length*40);a.setPercentage(N,`å›¾ç‰‡ ${j+be+1}: ${Nt[f]}`),await te(f,X)}catch(N){const pe=N instanceof Error?N.message:"æœªçŸ¥é”™è¯¯";w.push(`å›¾ç‰‡ ${X.imageIndex+1}: ${f} - ${pe}`),s.setTranslationStatus(X.imageIndex,"failed",pe),we.add(X.imageIndex)}}we.has(X.imageIndex)||(K(X),P++,console.log(`âœ… å›¾ç‰‡ ${j+be+1} å¤„ç†å®Œæˆ`))}}O+=we.size,console.log(`âœ… æ‰¹æ¬¡ ${T+1}/${le} å¤„ç†å®Œæˆ`)}return{completed:P,failed:O}}async function c(l){if(!M(l))return{success:!1,completed:0,failed:0,errors:["é…ç½®éªŒè¯å¤±è´¥"]};if(s.images.length===0)return i.error("è¯·å…ˆä¸Šä¼ å›¾ç‰‡"),{success:!1,completed:0,failed:0,errors:["æ²¡æœ‰å›¾ç‰‡"]};x=l.mode;const $=Z(l.mode);u.value=!0,(l.scope==="all"||l.scope==="failed")&&s.setBatchTranslationInProgress(!0),R(),k();const w=V(l),P=[],O=Rt(),ee=[...un[l.mode]];O&&ee.push("save"),console.log("ğŸš€ é¡ºåºç®¡çº¿å¯åŠ¨"),console.log(`   æ¨¡å¼: ${l.mode}`),console.log(`   å¤„ç†æ–¹å¼: ${$?"é€å¼ å¤„ç†":"æ‰¹æ¬¡å¤„ç†"}`),console.log(`   æ­¥éª¤é“¾: [${ee.join(" â†’ ")}]`),console.log(`   è‡ªåŠ¨ä¿å­˜: ${O?"å¯ç”¨":"ç¦ç”¨"}`);const le=w.map(({image:I,index:q})=>{const ae={imageIndex:q,image:I,bubbleCoords:[],bubbleAngles:[],bubblePolygons:[],autoDirections:[],textlinesPerBubble:[],originalTexts:[],colors:[],translatedTexts:[],textboxTexts:[]};return l.mode==="proofread"&&I.bubbleStates&&I.bubbleStates.length>0&&(ae.bubbleCoords=I.bubbleStates.map(T=>T.coords),ae.bubbleAngles=I.bubbleStates.map(T=>T.rotationAngle||0),ae.autoDirections=I.bubbleStates.map(T=>T.autoTextDirection||T.textDirection||"vertical"),ae.originalTexts=I.bubbleStates.map(T=>T.originalText||""),ae.translatedTexts=I.bubbleStates.map(T=>T.translatedText||""),ae.textboxTexts=I.bubbleStates.map(T=>T.textboxText||""),ae.colors=I.bubbleStates.map(T=>({textColor:T.textColor||"",bgColor:T.fillColor||"",autoFgColor:T.autoFgColor||null,autoBgColor:T.autoBgColor||null})),I.cleanImageData&&(ae.cleanImage=I.cleanImageData)),ae});try{a.init(w.length,`${l.mode} æ¨¡å¼å¯åŠ¨...`),O&&(a.setPercentage(0,"é¢„ä¿å­˜åŸå§‹å›¾ç‰‡..."),await Tn({onStart:T=>{a.setPercentage(0,`é¢„ä¿å­˜åŸå§‹å›¾ç‰‡ 0/${T}...`)},onProgress:(T,j)=>{const ge=Math.round(T/j*10);a.setPercentage(ge,`é¢„ä¿å­˜åŸå§‹å›¾ç‰‡ ${T}/${j}...`)},onComplete:()=>{a.setPercentage(10,"é¢„ä¿å­˜å®Œæˆï¼Œå¼€å§‹ç¿»è¯‘...")},onError:T=>{a.setPercentage(0,`é¢„ä¿å­˜å¤±è´¥: ${T}`)}})||i.warning("é¢„ä¿å­˜å¤±è´¥ï¼Œç¿»è¯‘å®Œæˆåè¯·æ‰‹åŠ¨ä¿å­˜"));let I;$?I=await oe(le,ee,l,P):I=await b(le,ee,l,P),a.setPercentage(100,"å®Œæˆï¼");const q={standard:"ç¿»è¯‘",hq:"é«˜è´¨é‡ç¿»è¯‘",proofread:"AIæ ¡å¯¹",removeText:"æ¶ˆé™¤æ–‡å­—"};return i.success(`${q[l.mode]}å®Œæˆï¼`),{success:I.failed===0,completed:I.completed,failed:I.failed,errors:P.length>0?P:void 0}}catch(I){const q=I instanceof Error?I.message:"æ‰§è¡Œå¤±è´¥";return i.error(q),P.push(q),{success:!1,completed:0,failed:w.length,errors:P}}finally{u.value=!1,s.setBatchTranslationInProgress(!1),O&&await In();const I=s.currentImageIndex,q=s.images[I];q?.bubbleStates&&q.bubbleStates.length>0&&t.setBubbles(q.bubbleStates),setTimeout(()=>a.finish(),1e3)}}function m(){s.isBatchTranslationInProgress&&(s.setBatchTranslationInProgress(!1),Rn(),i.info("æ“ä½œå·²å–æ¶ˆ"))}return{progress:r,isExecuting:u,isTranslating:_,progressPercent:D,execute:c,cancel:m,STEP_CHAIN_CONFIGS:un}}class ti{currentCount=0;maxCount;waitQueue=[];holders=[];constructor(t=1){this.maxCount=Math.max(1,t)}setSize(t){this.maxCount=Math.max(1,t),this.tryWakeUp()}getSize(){return this.maxCount}async acquire(t){if(this.currentCount<this.maxCount){this.currentCount++,this.holders.push(t);return}return new Promise(n=>{this.waitQueue.push({resolve:n,poolName:t})})}release(t){const n=this.holders.indexOf(t);n>=0&&(this.holders.splice(n,1),this.currentCount--),this.tryWakeUp()}tryWakeUp(){for(;this.currentCount<this.maxCount&&this.waitQueue.length>0;){const t=this.waitQueue.shift();this.currentCount++,this.holders.push(t.poolName),t.resolve()}}async withLock(t,n){await this.acquire(t);try{return await n()}finally{this.release(t)}}getStatus(){return{isLocked:this.currentCount>=this.maxCount,currentCount:this.currentCount,maxCount:this.maxCount,holders:[...this.holders],waitingCount:this.waitQueue.length,waitingPools:this.waitQueue.map(t=>t.poolName)}}isWaiting(t){return this.waitQueue.some(n=>n.poolName===t)}isHolding(t){return this.holders.includes(t)}reset(){this.currentCount=0,this.holders=[];for(const t of this.waitQueue)t.resolve();this.waitQueue=[]}}class Pt{queue=[];currentTask=null;isRunning=!1;isCancelled=!1;completedCount=0;nextPool;name;icon;lock;progressTracker;onTaskComplete;constructor(t,n,o,i,r,a){this.name=t,this.icon=n,this.nextPool=o,this.lock=i,this.progressTracker=r,this.onTaskComplete=a}getName(){return this.name}getIcon(){return this.icon}setNextPool(t){this.nextPool=t}enqueue(t){this.isCancelled||(this.queue.push(t),this.progressTracker.updatePool(this.name,{waiting:this.queue.length}),this.tryProcessNext())}enqueueBatch(t){if(!this.isCancelled){for(const n of t)this.queue.push(n);this.progressTracker.updatePool(this.name,{waiting:this.queue.length}),this.tryProcessNext()}}async tryProcessNext(){if(!(this.isRunning||this.isCancelled||this.queue.length===0)){this.isRunning=!0,this.currentTask=this.queue.shift(),this.progressTracker.updatePool(this.name,{waiting:this.queue.length,isProcessing:!0,currentPage:this.currentTask.imageIndex+1,isWaitingLock:!1});try{let t;this.lock?(this.progressTracker.updatePool(this.name,{isWaitingLock:!0}),t=await this.lock.withLock(this.name,async()=>(this.progressTracker.updatePool(this.name,{isWaitingLock:!1}),await this.process(this.currentTask)))):t=await this.process(this.currentTask),this.completedCount++,this.progressTracker.updatePool(this.name,{completed:this.completedCount}),this.nextPool&&t.status!=="failed"&&t.status!=="buffered"&&this.nextPool.enqueue(t),this.onTaskComplete?.(t)}catch(t){this.currentTask.status="failed",this.currentTask.error=t.message,console.error(`[${this.name}] å¤„ç†ä»»åŠ¡å¤±è´¥:`,t),this.onTaskComplete?.(this.currentTask)}finally{this.currentTask=null,this.isRunning=!1,this.progressTracker.updatePool(this.name,{isProcessing:!1,currentPage:void 0}),this.tryProcessNext()}}}getStatus(){return{name:this.name,icon:this.icon,waiting:this.queue.length,processing:this.isRunning,currentPage:this.currentTask?.imageIndex,completed:this.completedCount,isWaitingLock:this.lock?.isWaiting(this.name)??!1}}cancel(){this.isCancelled=!0,this.queue=[]}reset(){this.isCancelled=!1,this.queue=[],this.currentTask=null,this.isRunning=!1,this.completedCount=0}getCompletedCount(){return this.completedCount}getWaitingCount(){return this.queue.length}isProcessing(){return this.isRunning}}const oi=[{name:"æ£€æµ‹",icon:"ğŸ“"},{name:"OCR",icon:"ğŸ“–"},{name:"é¢œè‰²",icon:"ğŸ¨"},{name:"ç¿»è¯‘",icon:"ğŸŒ"},{name:"ä¿®å¤",icon:"ğŸ–Œï¸"},{name:"æ¸²æŸ“",icon:"âœ¨"}];class ni{poolStatuses=new Map;totalPages=0;startTime=0;progress=vo({pools:[],totalCompleted:0,totalFailed:0,totalPages:0,estimatedTimeRemaining:0});constructor(){this.initPools()}initPools(){for(const t of oi){const n={name:t.name,icon:t.icon,waiting:0,processing:!1,completed:0,isWaitingLock:!1};this.poolStatuses.set(t.name,n)}this.syncToReactive()}init(t){this.totalPages=t,this.startTime=Date.now();for(const n of this.poolStatuses.values())n.waiting=0,n.processing=!1,n.currentPage=void 0,n.completed=0,n.isWaitingLock=!1;this.progress.totalCompleted=0,this.progress.totalFailed=0,this.progress.totalPages=t,this.progress.estimatedTimeRemaining=0,this.syncToReactive()}updatePool(t,n){const o=this.poolStatuses.get(t);o&&(n.waiting!==void 0&&(o.waiting=n.waiting),n.isProcessing!==void 0&&(o.processing=n.isProcessing),n.currentPage!==void 0&&(o.currentPage=n.currentPage),n.completed!==void 0&&(o.completed=n.completed),n.isWaitingLock!==void 0&&(o.isWaitingLock=n.isWaitingLock),this.syncToReactive(),this.updateEstimatedTime())}incrementCompleted(){this.progress.totalCompleted++,this.updateEstimatedTime()}incrementFailed(){this.progress.totalFailed++}updateEstimatedTime(){if(this.progress.totalCompleted===0){this.progress.estimatedTimeRemaining=0;return}const n=(Date.now()-this.startTime)/1e3/this.progress.totalCompleted,o=this.totalPages-this.progress.totalCompleted-this.progress.totalFailed;this.progress.estimatedTimeRemaining=Math.ceil(n*o)}syncToReactive(){this.progress.pools=Array.from(this.poolStatuses.values()).map(t=>({...t}))}getPoolStatus(t){return this.poolStatuses.get(t)}getAllPoolStatuses(){return Array.from(this.poolStatuses.values())}getProgress(){return{...this.progress}}reset(){this.totalPages=0,this.startTime=0,this.initPools()}formatRemainingTime(){const t=this.progress.estimatedTimeRemaining;if(t<=0)return"--";const n=Math.floor(t/60),o=t%60;return n>0?`${n}åˆ†${o}ç§’`:`${o}ç§’`}}class si{results=new Map;totalExpected=0;completedCount=0;failedCount=0;resolveWaitAll=null;init(t){this.results.clear(),this.totalExpected=t,this.completedCount=0,this.failedCount=0,this.resolveWaitAll=null}add(t){this.results.set(t.imageIndex,t),t.status==="completed"?this.completedCount++:t.status==="failed"&&this.failedCount++,this.completedCount+this.failedCount>=this.totalExpected&&this.resolveWaitAll&&(this.resolveWaitAll({success:this.completedCount,failed:this.failedCount}),this.resolveWaitAll=null)}waitForAll(t){return this.totalExpected=t,this.completedCount+this.failedCount>=t?Promise.resolve({success:this.completedCount,failed:this.failedCount}):new Promise(n=>{this.resolveWaitAll=n})}get(t){return this.results.get(t)}getAll(){return Array.from(this.results.values()).sort((t,n)=>t.imageIndex-n.imageIndex)}getSuccessful(){return this.getAll().filter(t=>t.status==="completed")}getFailed(){return this.getAll().filter(t=>t.status==="failed")}getStats(){return{total:this.totalExpected,completed:this.completedCount,failed:this.failedCount,pending:this.totalExpected-this.completedCount-this.failedCount}}reset(){this.results.clear(),this.totalExpected=0,this.completedCount=0,this.failedCount=0,this.resolveWaitAll=null}}class ai extends Pt{constructor(t,n,o,i){super("æ£€æµ‹","ğŸ“",t,n,o,i)}async process(t){const{imageData:n}=t,i=Fe().settings,r=this.extractBase64(n.originalDataURL),a=await xo({image:r,detector_type:i.textDetector,box_expand_ratio:i.boxExpand.ratio,box_expand_top:i.boxExpand.top,box_expand_bottom:i.boxExpand.bottom,box_expand_left:i.boxExpand.left,box_expand_right:i.boxExpand.right});if(!a.success)throw new Error(a.error||"æ£€æµ‹å¤±è´¥");return t.detectionResult={bubbleCoords:a.bubble_coords||[],bubbleAngles:a.bubble_angles||[],bubblePolygons:a.bubble_polygons||[],autoDirections:a.auto_directions||[],rawMask:a.raw_mask,textlinesPerBubble:a.textlines_per_bubble||[]},t.status="processing",t}extractBase64(t){return t.includes("base64,")?t.split("base64,")[1]||"":t}}class li extends Pt{constructor(t,n,o,i){super("OCR","ğŸ“–",t,n,o,i)}async process(t){const{imageData:n,detectionResult:o}=t,r=Fe().settings;if(!o||o.bubbleCoords.length===0)return t.ocrResult={originalTexts:[],textlinesPerBubble:[]},t.status="processing",t;const a=this.extractBase64(n.originalDataURL),u=r.ocrEngine==="paddleocr_vl"?r.paddleOcrVl?.sourceLanguage||"japanese":r.sourceLanguage,g=await So({image:a,bubble_coords:o.bubbleCoords,source_language:u,ocr_engine:r.ocrEngine,baidu_api_key:r.baiduOcr?.apiKey,baidu_secret_key:r.baiduOcr?.secretKey,baidu_version:r.baiduOcr?.version,baidu_ocr_language:r.baiduOcr?.sourceLanguage,ai_vision_provider:r.aiVisionOcr?.provider,ai_vision_api_key:r.aiVisionOcr?.apiKey,ai_vision_model_name:r.aiVisionOcr?.modelName,ai_vision_ocr_prompt:r.aiVisionOcr?.prompt,custom_ai_vision_base_url:r.aiVisionOcr?.customBaseUrl,ai_vision_min_image_size:r.aiVisionOcr?.minImageSize??os,textlines_per_bubble:o.textlinesPerBubble});if(!g.success)throw new Error(g.error||"OCRå¤±è´¥");return t.ocrResult={originalTexts:g.original_texts||[],textlinesPerBubble:g.textlines_per_bubble||[]},t.status="processing",t}extractBase64(t){return t.includes("base64,")?t.split("base64,")[1]||"":t}}class ii extends Pt{constructor(t,n,o,i){super("é¢œè‰²","ğŸ¨",t,n,o,i)}async process(t){const{imageData:n,detectionResult:o,ocrResult:i}=t;if(!o||o.bubbleCoords.length===0)return t.colorResult={colors:[]},t.status="processing",t;const r=this.extractBase64(n.originalDataURL),a=await _o({image:r,bubble_coords:o.bubbleCoords,textlines_per_bubble:i?.textlinesPerBubble||o.textlinesPerBubble});if(!a.success)throw new Error(a.error||"é¢œè‰²æå–å¤±è´¥");return t.colorResult={colors:a.colors||[]},t.status="processing",t}extractBase64(t){return t.includes("base64,")?t.split("base64,")[1]||"":t}}class ri extends Pt{mode="standard";batchBuffer=[];totalTasks=0;processedCount=0;constructor(t,n,o){super("ç¿»è¯‘","ğŸŒ",t,null,n,o)}setMode(t,n,o){this.mode=t,this.totalTasks=n,this.batchBuffer=[],this.processedCount=0,this.nextPool=o}async process(t){switch(this.mode){case"standard":return this.handleStandardTranslate(t);case"hq":return this.handleHqTranslate(t);case"proofread":return this.handleProofread(t);case"removeText":return this.handleRemoveTextOnly(t);default:return t}}async handleStandardTranslate(t){const o=Fe().settings;if(!t.ocrResult||t.ocrResult.originalTexts.length===0)return t.translateResult={translatedTexts:[],textboxTexts:[]},t.status="processing",t;const i=await Co({original_texts:t.ocrResult.originalTexts,target_language:o.targetLanguage,source_language:o.sourceLanguage,model_provider:o.translation.provider,model_name:o.translation.modelName,api_key:o.translation.apiKey,custom_base_url:o.translation.customBaseUrl,prompt_content:o.translatePrompt,textbox_prompt_content:o.textboxPrompt,use_textbox_prompt:o.useTextboxPrompt,rpm_limit:o.translation.rpmLimit,max_retries:o.translation.maxRetries,use_json_format:o.translation.isJsonMode});if(!i.success)throw new Error(i.error||"ç¿»è¯‘å¤±è´¥");return t.translateResult={translatedTexts:i.translated_texts||[],textboxTexts:i.textbox_texts||[]},t.status="processing",t}async handleHqTranslate(t){this.batchBuffer.push(t),this.processedCount++;const n=Fe(),{hqTranslation:o}=n.settings,i=o.batchSize||3,r=this.processedCount>=this.totalTasks;if(!(this.batchBuffer.length>=i||r))return t.status="buffered",t;const u=[...this.batchBuffer];this.batchBuffer=[];const g=u.map(k=>({imageIndex:k.imageIndex,bubbles:(k.ocrResult?.originalTexts||[]).map((Y,V)=>({bubbleIndex:V,original:Y,translated:"",textDirection:k.detectionResult?.autoDirections[V]||"vertical"}))})),S=u.map(k=>this.extractBase64(k.imageData.originalDataURL)),x=JSON.stringify(g,null,2),_=[{type:"text",text:o.prompt+`

ä»¥ä¸‹æ˜¯JSONæ•°æ®:
\`\`\`json
`+x+"\n```"}];for(const k of S)_.push({type:"image_url",image_url:{url:`data:image/png;base64,${k}`}});const D=[{role:"system",content:"ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ¼«ç”»ç¿»è¯‘åŠ©æ‰‹ï¼Œèƒ½å¤Ÿæ ¹æ®æ¼«ç”»å›¾åƒå†…å®¹å’Œä¸Šä¸‹æ–‡æä¾›é«˜è´¨é‡çš„ç¿»è¯‘ã€‚"},{role:"user",content:_}],R=await Et({provider:o.provider,api_key:o.apiKey,model_name:o.modelName,custom_base_url:o.customBaseUrl,messages:D,low_reasoning:o.lowReasoning,force_json_output:o.forceJsonOutput,no_thinking_method:o.noThinkingMethod,use_stream:o.useStream,max_retries:o.maxRetries||2}),M=this.parseHqResponse(R,o.forceJsonOutput);for(const k of u){const Y=M?.find(V=>V.imageIndex===k.imageIndex);Y?k.translateResult={translatedTexts:Y.bubbles.map(V=>V.translated),textboxTexts:[]}:k.translateResult={translatedTexts:[],textboxTexts:[]},k.status="processing",this.nextPool&&this.nextPool.enqueue(k)}return t}async handleProofread(t){this.batchBuffer.push(t),this.processedCount++;const n=Fe(),{proofreading:o,useTextboxPrompt:i}=n.settings,r=o.rounds[0]?.batchSize||3,a=this.processedCount>=this.totalTasks;if(!(this.batchBuffer.length>=r||a))return t.status="buffered",t;const g=[...this.batchBuffer];this.batchBuffer=[];const S=g.map(D=>({imageIndex:D.imageIndex,bubbles:(D.imageData.bubbleStates||[]).map((R,M)=>({bubbleIndex:M,original:R.originalText||"",translated:i?R.textboxText||R.translatedText||"":R.translatedText||"",textDirection:R.textDirection==="vertical"||R.textDirection==="horizontal"?R.textDirection:R.autoTextDirection==="vertical"||R.autoTextDirection==="horizontal"?R.autoTextDirection:"vertical"}))})),x=g.map(D=>{const R=D.imageData.translatedDataURL||D.imageData.originalDataURL;return this.extractBase64(R)});let _=S;for(const D of o.rounds){const R=JSON.stringify(_,null,2),M=[{type:"text",text:D.prompt+`

ä»¥ä¸‹æ˜¯JSONæ•°æ®:
\`\`\`json
`+R+"\n```"}];for(const L of x)M.push({type:"image_url",image_url:{url:`data:image/png;base64,${L}`}});const k=[{role:"system",content:"ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ¼«ç”»ç¿»è¯‘æ ¡å¯¹åŠ©æ‰‹ï¼Œèƒ½å¤Ÿæ ¹æ®æ¼«ç”»å›¾åƒå†…å®¹æ£€æŸ¥å’Œä¿®æ­£ç¿»è¯‘ã€‚"},{role:"user",content:M}],Y=await Et({provider:D.provider,api_key:D.apiKey,model_name:D.modelName,custom_base_url:D.customBaseUrl,messages:k,low_reasoning:D.lowReasoning,force_json_output:D.forceJsonOutput,no_thinking_method:D.noThinkingMethod,use_stream:!1,max_retries:D.maxRetries||o.maxRetries||2}),V=this.parseHqResponse(Y,D.forceJsonOutput);V&&(_=V)}for(const D of g){const R=_.find(M=>M.imageIndex===D.imageIndex);R?D.translateResult={translatedTexts:R.bubbles.map(M=>M.translated),textboxTexts:[]}:D.translateResult={translatedTexts:[],textboxTexts:[]},D.status="processing",this.nextPool&&this.nextPool.enqueue(D)}return t}async handleRemoveTextOnly(t){return t.translateResult={translatedTexts:[],textboxTexts:[]},t.status="processing",t}extractBase64(t){return t.includes("base64,")?t.split("base64,")[1]||"":t}parseHqResponse(t,n){if(!t.success)return console.error("APIè°ƒç”¨å¤±è´¥:",t.error),null;if(t.results&&t.results.length>0){const i=t.results[0];if(i&&"imageIndex"in i&&"bubbles"in i)return t.results}const o=t.content;if(o)if(n)try{return JSON.parse(o)}catch(i){return console.error("è§£æAIå¼ºåˆ¶JSONè¿”å›çš„å†…å®¹å¤±è´¥:",i),null}else{const i=o.match(/```json\s*([\s\S]*?)\s*```/);if(i?.[1])try{return JSON.parse(i[1])}catch(r){return console.error("è§£æAIè¿”å›çš„JSONå¤±è´¥:",r),null}}return null}}class ui extends Pt{constructor(t,n,o,i){super("ä¿®å¤","ğŸ–Œï¸",t,n,o,i)}async process(t){const{imageData:n,detectionResult:o}=t,r=Fe().settings;if(!o||o.bubbleCoords.length===0)return t.inpaintResult={cleanImage:this.extractBase64(n.originalDataURL)},t.status="processing",t;const a=this.extractBase64(n.originalDataURL),u=r.textStyle.inpaintMethod,g=u==="lama_mpe"||u==="litelama",S=await ko({image:a,bubble_coords:o.bubbleCoords,bubble_polygons:o.bubblePolygons,raw_mask:o.rawMask,method:g?"lama":"solid",lama_model:g?u:void 0,fill_color:r.textStyle.fillColor,mask_dilate_size:r.preciseMask.dilateSize,mask_box_expand_ratio:r.preciseMask.boxExpandRatio});if(!S.success)throw new Error(S.error||"ä¿®å¤å¤±è´¥");return t.inpaintResult={cleanImage:S.clean_image||""},t.status="processing",t}extractBase64(t){return t.includes("base64,")?t.split("base64,")[1]||"":t}}const ft=vo({pools:[{name:"æ£€æµ‹",icon:"ğŸ“",waiting:0,processing:!1,completed:0,isWaitingLock:!1},{name:"OCR",icon:"ğŸ“–",waiting:0,processing:!1,completed:0,isWaitingLock:!1},{name:"é¢œè‰²",icon:"ğŸ¨",waiting:0,processing:!1,completed:0,isWaitingLock:!1},{name:"ç¿»è¯‘",icon:"ğŸŒ",waiting:0,processing:!1,completed:0,isWaitingLock:!1},{name:"ä¿®å¤",icon:"ğŸ–Œï¸",waiting:0,processing:!1,completed:0,isWaitingLock:!1},{name:"æ¸²æŸ“",icon:"âœ¨",waiting:0,processing:!1,completed:0,isWaitingLock:!1}],totalCompleted:0,totalFailed:0,totalPages:0,estimatedTimeRemaining:0,preSave:void 0,save:void 0}),ci=C(!1);function $o(){const s=ot(),t=Fe(),n=is(null),o=Q(()=>t.settings.parallel),i=Q(()=>o.value?.enabled??!1),r=ci,a=Q(()=>ft);function u(){const D=t.settings;return D.proofreading?.enabled&&D.proofreading.rounds.length>0?"proofread":["gemini","openai","claude","deepseek"].includes(D.hqTranslation?.provider||"")&&D.hqTranslation?.apiKey?"hq":"standard"}function g(){if(!n.value)return;const D=n.value.progress;D&&(ft.pools=D.pools.map(R=>({...R})),ft.totalCompleted=D.totalCompleted,ft.totalFailed=D.totalFailed,ft.totalPages=D.totalPages,ft.estimatedTimeRemaining=D.estimatedTimeRemaining)}async function S(D,R,M=0){if(r.value)return{success:0,failed:0,errors:["ç¿»è¯‘æ­£åœ¨è¿›è¡Œä¸­"]};const k=R??s.images;if(k.length===0)return{success:0,failed:0,errors:["æ²¡æœ‰å›¾ç‰‡"]};r.value=!0,ft.totalPages=k.length,ft.totalCompleted=0,ft.totalFailed=0;const Y=setInterval(g,200);try{n.value=pi({enabled:!0,deepLearningLockSize:o.value?.deepLearningLockSize??1});const V=D??u();console.log(`ğŸš€ å¼€å§‹å¹¶è¡Œç¿»è¯‘ï¼Œæ¨¡å¼: ${V}ï¼Œå›¾ç‰‡æ•°: ${k.length}ï¼Œèµ·å§‹ç´¢å¼•: ${M}`);const L=await n.value.execute(k,V,M);return g(),console.log(`âœ… å¹¶è¡Œç¿»è¯‘å®Œæˆï¼ŒæˆåŠŸ: ${L.success}ï¼Œå¤±è´¥: ${L.failed}`),L}catch(V){return console.error("å¹¶è¡Œç¿»è¯‘å‡ºé”™:",V),{success:0,failed:k.length,errors:[V.message]}}finally{clearInterval(Y),r.value=!1}}function x(){n.value&&n.value.cancel(),r.value=!1}function _(){n.value=null,r.value=!1}return{isEnabled:i,isRunning:r,progress:a,executeParallel:S,cancel:x,reset:_,determineMode:u}}class di extends Pt{resultCollector;constructor(t,n,o){super("æ¸²æŸ“","âœ¨",null,null,t,o),this.resultCollector=n}async process(t){const n=ot(),o=gt(),i=Fe(),r=this.buildBubbleStates(t,i);if(r.length===0){const g=t.inpaintResult?.cleanImage||t.imageData.cleanImageData||this.extractBase64(t.imageData.originalDataURL);return t.renderResult={finalImage:g,bubbleStates:[]},t.status="completed",this.updateImageToUI(t,n,o,i),this.resultCollector.add(t),t}const a=t.inpaintResult?.cleanImage||t.imageData.cleanImageData||this.extractBase64(t.imageData.translatedDataURL||t.imageData.originalDataURL),u=await wo({clean_image:a,bubble_states:r,fontSize:i.settings.textStyle.fontSize,fontFamily:i.settings.textStyle.fontFamily,textDirection:i.settings.textStyle.layoutDirection,textColor:i.settings.textStyle.textColor,strokeEnabled:i.settings.textStyle.strokeEnabled,strokeColor:i.settings.textStyle.strokeColor,strokeWidth:i.settings.textStyle.strokeWidth,autoFontSize:i.settings.textStyle.autoFontSize,use_individual_styles:!0});if(!u.success)throw new Error(u.error||"æ¸²æŸ“å¤±è´¥");return t.renderResult={finalImage:u.final_image||"",bubbleStates:u.bubble_states||r},t.status="completed",this.updateImageToUI(t,n,o,i),this.resultCollector.add(t),t}updateImageToUI(t,n,o,i){const r=t.imageIndex,a=(t.detectionResult?.bubbleCoords||[]).map(u=>u.length>=4?[u[0],u[1],u[2],u[3]]:[0,0,0,0]);n.updateImageByIndex(r,{translatedDataURL:`data:image/png;base64,${t.renderResult.finalImage}`,cleanImageData:t.inpaintResult?.cleanImage||null,bubbleStates:t.renderResult.bubbleStates,bubbleCoords:a,bubbleAngles:t.detectionResult?.bubbleAngles||[],originalTexts:t.ocrResult?.originalTexts||[],bubbleTexts:t.translateResult?.translatedTexts||[],textboxTexts:t.translateResult?.textboxTexts||[],translationStatus:"completed",translationFailed:!1,showOriginal:!1,hasUnsavedChanges:!0,fontSize:i.settings.textStyle.fontSize,autoFontSize:i.settings.textStyle.autoFontSize,fontFamily:i.settings.textStyle.fontFamily,layoutDirection:i.settings.textStyle.layoutDirection,textColor:i.settings.textStyle.textColor,fillColor:i.settings.textStyle.fillColor,strokeEnabled:i.settings.textStyle.strokeEnabled,strokeColor:i.settings.textStyle.strokeColor,strokeWidth:i.settings.textStyle.strokeWidth,inpaintMethod:i.settings.textStyle.inpaintMethod,useAutoTextColor:i.settings.textStyle.useAutoTextColor}),r===n.currentImageIndex&&t.renderResult?.bubbleStates&&o.setBubbles(t.renderResult.bubbleStates),this.progressTracker.incrementCompleted(),Rt()&&$n(r).catch(u=>{console.error(`[RenderPool] è‡ªåŠ¨ä¿å­˜å›¾ç‰‡ ${r+1} å¤±è´¥:`,u)}).finally(()=>{const{progress:u}=$o(),g=u.value;g.save&&(g.save.completed=(g.save.completed||0)+1)}),console.log(`âœ… å›¾ç‰‡ ${r+1} æ¸²æŸ“å®Œæˆ`)}buildBubbleStates(t,n){if(!t.detectionResult&&t.imageData.bubbleStates&&t.imageData.bubbleStates.length>0){const _=t.translateResult?.translatedTexts||[];return t.imageData.bubbleStates.map((D,R)=>({...D,translatedText:_[R]||D.translatedText||""}))}if(t.detectionResult&&!t.translateResult)return console.log(`[æ¸²æŸ“æ± ] å›¾ç‰‡ ${t.imageIndex+1}: æ£€æµ‹åˆ°æ¶ˆé™¤æ–‡å­—æ¨¡å¼ï¼ˆæ— ç¿»è¯‘ç»“æœï¼‰ï¼Œè·³è¿‡æ¸²æŸ“`),[];const o=t.detectionResult?.bubbleCoords||[],i=t.translateResult?.translatedTexts||[],r=t.ocrResult?.originalTexts||[],a=t.colorResult?.colors||[],u=t.detectionResult?.bubbleAngles||[],g=t.detectionResult?.autoDirections||[],S=t.detectionResult?.bubblePolygons||[],x=n.settings;return o.map((_,D)=>{const R=g[D],M=R==="v"?"vertical":R==="h"?"horizontal":"vertical",k=x.textStyle.layoutDirection,Y=k==="vertical"||k==="horizontal"?k:M;let V=x.textStyle.textColor,L=x.textStyle.fillColor;const v=a[D];return x.textStyle.useAutoTextColor&&v&&(v.textColor&&(V=v.textColor),v.bgColor&&(L=v.bgColor)),{originalText:r[D]||"",translatedText:i[D]||"",textboxText:"",coords:_.length>=4?[_[0],_[1],_[2],_[3]]:[0,0,0,0],polygon:S[D]||[],fontSize:x.textStyle.fontSize,fontFamily:x.textStyle.fontFamily,textDirection:Y,autoTextDirection:M,textColor:V,fillColor:L,rotationAngle:u[D]||0,position:{x:0,y:0},strokeEnabled:x.textStyle.strokeEnabled,strokeColor:x.textStyle.strokeColor,strokeWidth:x.textStyle.strokeWidth,inpaintMethod:x.textStyle.inpaintMethod,autoFgColor:v?.autoFgColor||null,autoBgColor:v?.autoBgColor||null}})}extractBase64(t){return t.includes("base64,")?t.split("base64,")[1]||"":t}}const cn={standard:["detection","ocr","color","translate","inpaint","render"],hq:["detection","ocr","color","translate","inpaint","render"],proofread:["translate","render"],removeText:["detection","inpaint","render"]};class gi{lock;progressTracker;resultCollector;detectionPool;ocrPool;colorPool;translatePool;inpaintPool;renderPool;isCancelled=!1;config;constructor(t){this.config=t,this.lock=new ti(t.deepLearningLockSize),this.progressTracker=new ni,this.resultCollector=new si,this.renderPool=new di(this.progressTracker,this.resultCollector),this.inpaintPool=new ui(this.renderPool,this.lock,this.progressTracker),this.translatePool=new ri(this.inpaintPool,this.progressTracker),this.colorPool=new ii(this.translatePool,this.lock,this.progressTracker),this.ocrPool=new li(this.colorPool,this.lock,this.progressTracker),this.detectionPool=new ai(this.ocrPool,this.lock,this.progressTracker)}updateConfig(t){t.deepLearningLockSize!==void 0&&(this.lock.setSize(t.deepLearningLockSize),this.config.deepLearningLockSize=t.deepLearningLockSize),t.enabled!==void 0&&(this.config.enabled=t.enabled)}async execute(t,n,o=0){this.reset(),this.progressTracker.init(t.length),this.resultCollector.init(t.length),this.setupPoolChain(n,t.length);const i=t.map((u,g)=>({id:`task-${o+g}`,imageIndex:o+g,imageData:u,status:"pending"})),r=this.getEntryPool(n);for(const u of i)r.enqueue(u);const a=await this.resultCollector.waitForAll(t.length);return{success:a.success,failed:a.failed,errors:this.resultCollector.getFailed().map(u=>u.error||"æœªçŸ¥é”™è¯¯")}}setupPoolChain(t,n){const o=cn[t],i=this.getPoolMap();for(let g=0;g<o.length-1;g++){const S=o[g],x=o[g+1],_=i[S],D=i[x];_&&D&&_.setNextPool(D)}const r=o[o.length-1],a=i[r];a&&a.setNextPool(null);const u=o.indexOf("translate");if(u>=0&&u<o.length-1){const g=o[u+1];this.translatePool.setMode(t,n,i[g]||null)}else u===o.length-1&&this.translatePool.setMode(t,n,null)}getPoolMap(){return{detection:this.detectionPool,ocr:this.ocrPool,color:this.colorPool,translate:this.translatePool,inpaint:this.inpaintPool,render:this.renderPool}}getEntryPool(t){const o=cn[t][0];return this.getPoolMap()[o]||this.detectionPool}cancel(){this.isCancelled=!0,this.detectionPool.cancel(),this.ocrPool.cancel(),this.colorPool.cancel(),this.translatePool.cancel(),this.inpaintPool.cancel(),this.renderPool.cancel(),this.lock.reset()}reset(){this.isCancelled=!1,this.detectionPool.reset(),this.ocrPool.reset(),this.colorPool.reset(),this.translatePool.reset(),this.inpaintPool.reset(),this.renderPool.reset(),this.resultCollector.reset(),this.progressTracker.reset()}get progress(){return this.progressTracker.progress}getProgressTracker(){return this.progressTracker}getLockStatus(){return this.lock.getStatus()}get cancelled(){return this.isCancelled}}function pi(s){return new gi(s)}function mi(){const s=ot(),t=Fe(),n=ct(),o=ei(),i=$o(),r=Q(()=>o.isTranslating.value||s.isBatchTranslationInProgress),a=Q(()=>o.progressPercent.value);async function u(x){if(s.images.length===0)return n.error("è¯·å…ˆä¸Šä¼ å›¾ç‰‡"),{success:!1,completed:0,failed:0,errors:["æ²¡æœ‰å›¾ç‰‡"]};const _=t.settings.parallel,D=x.scope==="all"||x.scope==="range";return _?.enabled&&D?(console.log(`ğŸš€ ä½¿ç”¨å¹¶è¡Œç®¡çº¿ï¼Œæ¨¡å¼: ${x.mode}, èŒƒå›´: ${x.scope}`),g(x)):(console.log(`ğŸš€ ä½¿ç”¨é¡ºåºç®¡çº¿ï¼Œæ¨¡å¼: ${x.mode}`),o.execute(x))}async function g(x){let _=s.images,D=0;if(x.scope==="range"&&x.pageRange){D=Math.max(0,x.pageRange.startPage-1);const M=Math.min(s.images.length-1,x.pageRange.endPage-1);if(D<=M&&D<s.images.length)_=s.images.slice(D,M+1),console.log(`ğŸ¯ å¹¶è¡Œç¿»è¯‘èŒƒå›´: ç¬¬ ${x.pageRange.startPage} è‡³ ${x.pageRange.endPage} é¡µï¼Œå…± ${_.length} å¼ ï¼Œèµ·å§‹ç´¢å¼• ${D}`);else return n.error("æ— æ•ˆçš„é¡µé¢èŒƒå›´"),{success:!1,completed:0,failed:0,errors:["æ— æ•ˆçš„é¡µé¢èŒƒå›´"]}}const R=Rt();try{if(i.progress.value.totalPages=_.length,i.progress.value.totalCompleted=0,i.progress.value.totalFailed=0,R&&(console.log("[ParallelPipeline] æ‰§è¡Œé¢„ä¿å­˜..."),n.info("å¼€å§‹é¢„ä¿å­˜åŸå§‹å›¾ç‰‡..."),!await Tn({onStart:V=>{const L=i.progress.value;L.preSave={isRunning:!0,current:0,total:V}},onProgress:(V,L)=>{const v=i.progress.value;v.preSave&&(v.preSave.current=V,v.preSave.total=L)},onComplete:()=>{const V=i.progress.value;V.preSave&&(V.preSave.isRunning=!1),n.success("é¢„ä¿å­˜å®Œæˆï¼Œå¼€å§‹ç¿»è¯‘...")},onError:V=>{const L=i.progress.value;L.preSave=void 0,n.warning(`é¢„ä¿å­˜å¤±è´¥ï¼š${V}ï¼Œç¿»è¯‘å®Œæˆåè¯·æ‰‹åŠ¨ä¿å­˜`)}}))){const V=i.progress.value;V.preSave=void 0}const M=x.mode;if(console.log(`ğŸš€ å¯åŠ¨å¹¶è¡Œç¿»è¯‘æ¨¡å¼: ${M}`),console.log(`   å›¾ç‰‡æ•°é‡: ${_.length}`),console.log(`   èµ·å§‹ç´¢å¼•: ${D}`),console.log(`   è‡ªåŠ¨ä¿å­˜: ${R?"å¯ç”¨":"ç¦ç”¨"}`),R){const Y=i.progress.value;Y.save={completed:0,total:_.length}}const k=await i.executeParallel(M,_,D);return k.success>0&&k.failed===0?n.success(`å¹¶è¡Œç¿»è¯‘å®Œæˆï¼ŒæˆåŠŸå¤„ç† ${k.success} å¼ å›¾ç‰‡`):k.success>0&&k.failed>0?n.warning(`å¹¶è¡Œç¿»è¯‘å®Œæˆï¼ŒæˆåŠŸ ${k.success} å¼ ï¼Œå¤±è´¥ ${k.failed} å¼ `):n.error("å¹¶è¡Œç¿»è¯‘å¤±è´¥"),{success:k.failed===0,completed:k.success,failed:k.failed,errors:k.errors}}catch(M){const k=M instanceof Error?M.message:"å¹¶è¡Œç¿»è¯‘å‡ºé”™";return n.error(k),{success:!1,completed:0,failed:_.length,errors:[k]}}finally{const M=i.progress.value;M.preSave=void 0,M.save=void 0,R&&(console.log("[ParallelPipeline] å®Œæˆä¿å­˜..."),await In())}}function S(){o.cancel(),i.cancel(),Rn()}return{progress:o.progress,isExecuting:o.isExecuting,isTranslating:r,progressPercent:a,execute:u,cancel:S,STEP_CHAIN_CONFIGS:o.STEP_CHAIN_CONFIGS}}function dn(s="current",t){return{mode:"standard",scope:s,pageRange:t?.pageRange}}function vi(s="all",t){return{mode:"hq",scope:s,pageRange:t?.pageRange,batchOptions:{batchSize:t?.batchSize??3,maxRetries:t?.maxRetries??2,rpmLimit:t?.rpmLimit??10,sessionResetFrequency:t?.sessionResetFrequency??5}}}function fi(s="all",t){return{mode:"proofread",scope:s,pageRange:t?.pageRange,batchOptions:{batchSize:t?.batchSize??3,maxRetries:t?.maxRetries??2,rpmLimit:t?.rpmLimit??10,sessionResetFrequency:t?.sessionResetFrequency??5}}}function bi(s="current",t){return{mode:"removeText",scope:s,pageRange:t?.pageRange}}function hi(s){if(s.length===0)return{startPage:1,endPage:0};const t=[...s].sort((i,r)=>i-r),n=t[0],o=t[t.length-1];return{startPage:(n??0)+1,endPage:(o??0)+1}}function bt(s,t){const n=[];for(let o=s;o<t;o++)n.push(o);return n}function Io(){const s=ot(),t=gt(),n=ct(),o=mi(),i=o.progress,r=o.isExecuting,a=o.isTranslating,u=o.progressPercent,g=Q(()=>o.isExecuting.value),S=Q(()=>o.isExecuting.value);async function x(F,te){if(F.length===0)return n.error("æ²¡æœ‰æŒ‡å®šè¦ç¿»è¯‘çš„é¡µé¢"),{success:!1,completed:0,failed:0,errors:["æ²¡æœ‰æŒ‡å®šè¦ç¿»è¯‘çš„é¡µé¢"]};const J=s.images.length;if(J===0)return n.error("è¯·å…ˆä¸Šä¼ å›¾ç‰‡"),{success:!1,completed:0,failed:0,errors:["è¯·å…ˆä¸Šä¼ å›¾ç‰‡"]};for(const b of F)if(b<0||b>=J)return n.error(`æ— æ•ˆçš„é¡µé¢ç´¢å¼•: ${b}`),{success:!1,completed:0,failed:0,errors:[`æ— æ•ˆçš„é¡µé¢ç´¢å¼•: ${b}`]};const K=F.length===1,Z=F.length===J;let W;if(K){const b=s.currentImageIndex,c=F[0];c!==void 0&&s.setCurrentImageIndex(c),W=_(te,"current");const m=await o.execute(W);return s.setCurrentImageIndex(b),{success:m.success,completed:m.completed,failed:m.failed,errors:m.errors??[]}}else if(Z)W=_(te,"all");else{const b=hi(F);W=_(te,"range",b)}const oe=await o.execute(W);return{success:oe.success,completed:oe.completed,failed:oe.failed,errors:oe.errors??[]}}function _(F,te,J){switch(F){case"standard":return dn(te,J?{pageRange:J}:void 0);case"hq":return vi(te,J?{pageRange:J}:void 0);case"proofread":return fi(te,J?{pageRange:J}:void 0);case"removeText":return bi(te,J?{pageRange:J}:void 0);default:return dn(te,J?{pageRange:J}:void 0)}}async function D(){return(await x([s.currentImageIndex],"standard")).success}async function R(F){return(await x([F],"standard")).success}async function M(){return(await x(bt(0,s.images.length),"standard")).success}async function k(F){const te=bt(F.startPage-1,F.endPage);return(await x(te,"standard")).success}function Y(){o.cancel()}async function V(){return(await x([s.currentImageIndex],"removeText")).success}async function L(){return(await x(bt(0,s.images.length),"removeText")).success}async function v(F){const te=bt(F.startPage-1,F.endPage);return(await x(te,"removeText")).success}async function d(){const F=s.getFailedImageIndices();return F.length===0?(n.info("æ²¡æœ‰å¤±è´¥çš„å›¾ç‰‡éœ€è¦é‡æ–°ç¿»è¯‘"),!0):(await x(F,"standard")).success}async function h(F){const te=F?bt(F.startPage-1,F.endPage):bt(0,s.images.length);return(await x(te,"hq")).success}async function y(F){const te=F?bt(F.startPage-1,F.endPage):bt(0,s.images.length);return(await x(te,"proofread")).success}async function z(){if(!s.currentImage)return n.error("è¯·å…ˆä¸Šä¼ å›¾ç‰‡"),!1;const te=t.bubbles;return!te||te.length===0?(n.error("å½“å‰å›¾ç‰‡æ²¡æœ‰æ°”æ³¡æ¡†ï¼Œè¯·å…ˆæ£€æµ‹æˆ–æ‰‹åŠ¨æ·»åŠ "),!1):(s.setManuallyAnnotated(!0),D())}return{progress:i,isTranslatingSingle:r,isHqTranslating:g,isProofreading:S,isTranslating:a,progressPercent:u,translatePages:x,range:bt,translateCurrentImage:D,translateImageByIndex:R,translateAllImages:M,translateImageRange:k,cancelBatchTranslation:Y,removeTextOnly:V,removeAllTexts:L,removeTextRange:v,retryFailedImages:d,executeHqTranslation:h,executeProofreading:y,translateWithCurrentBubbles:z}}function yi(){const s=gt(),t=ot(),n=C(!1);function o(){if(!n.value)return;const i=t.currentImage;s.bubbleCount>0?t.updateCurrentBubbleStates([...s.bubbles]):i&&Array.isArray(i.bubbleStates)&&i.bubbleStates.length>0&&(t.updateCurrentBubbleStates([]),console.log("é€€å‡ºç¼–è¾‘æ¨¡å¼ï¼ˆæ— é‡æ¸²æŸ“ï¼‰ï¼Œç”¨æˆ·å·²åˆ é™¤æ‰€æœ‰æ°”æ³¡")),n.value=!1,s.clearSelection(),console.log("å·²é€€å‡ºç¼–è¾‘æ¨¡å¼ï¼ˆæ— é‡æ¸²æŸ“ï¼‰")}return{isActive:n,exitEditModeWithoutRender:o}}function xi(){const s=vn(),t=Fe(),n=ot(),o=It(),i=gt(),r=yi(),a=C(!1),u=C(!1),g=C(null),S=C([]),x=C([]),_=C([]),D=C(null),R=C(null),M=C(null),k=C(null),Y=C(!1);async function V(K=!1){if(!K&&(a.value||u.value)){console.log("[TranslateInit] å·²ç»åˆå§‹åŒ–ï¼Œä»…é‡æ–°åŠ è½½ä¸Šä¸‹æ–‡"),await y();return}console.log("[TranslateInit] å¼€å§‹åˆå§‹åŒ–åº”ç”¨..."),a.value=!0,g.value=null;try{await L(),await v(),await d(),await h(),await y(),console.log("[TranslateInit] åº”ç”¨åˆå§‹åŒ–å®Œæˆ"),u.value=!0}catch(Z){console.error("[TranslateInit] åº”ç”¨åˆå§‹åŒ–å¤±è´¥:",Z),g.value=Z instanceof Error?Z.message:"åˆå§‹åŒ–å¤±è´¥"}finally{a.value=!1}}async function L(){console.log("[TranslateInit] åˆå§‹åŒ–è®¾ç½®..."),t.initSettings();try{const K=await t.loadFromBackend();console.log(K?"[TranslateInit] å·²ä»åç«¯åŠ è½½è®¾ç½®":"[TranslateInit] åç«¯æ— è®¾ç½®ï¼Œä½¿ç”¨ localStorage æ•°æ®")}catch(K){console.warn("[TranslateInit] ä»åç«¯åŠ è½½è®¾ç½®å¤±è´¥ï¼Œä½¿ç”¨ localStorage æ•°æ®:",K)}console.log("[TranslateInit] è®¾ç½®åˆå§‹åŒ–å®Œæˆ")}async function v(){console.log("[TranslateInit] åˆå§‹åŒ–å­—ä½“åˆ—è¡¨...");try{const K=await bn();K.fonts&&K.fonts.length>0?(S.value=K.fonts,console.log(`[TranslateInit] å·²åŠ è½½ ${K.fonts.length} ä¸ªå­—ä½“`)):K.error?console.warn("[TranslateInit] è·å–å­—ä½“åˆ—è¡¨å¤±è´¥:",K.error):console.warn("[TranslateInit] å­—ä½“åˆ—è¡¨ä¸ºç©º")}catch(K){console.error("[TranslateInit] è·å–å­—ä½“åˆ—è¡¨å¤±è´¥:",K)}}async function d(){console.log("[TranslateInit] åˆå§‹åŒ–ç¿»è¯‘æç¤ºè¯è®¾ç½®...");try{const K=await Ss();K.prompt_names!==void 0?(x.value=K.prompt_names||[],!t.settings.translatePrompt&&K.default_prompt_content&&t.setTranslatePrompt(K.default_prompt_content),console.log(`[TranslateInit] å·²åŠ è½½ ${x.value.length} ä¸ªç¿»è¯‘æç¤ºè¯`)):K.error&&console.warn("[TranslateInit] è·å–ç¿»è¯‘æç¤ºè¯å¤±è´¥:",K.error)}catch(K){console.error("[TranslateInit] è·å–ç¿»è¯‘æç¤ºè¯å¤±è´¥:",K)}}async function h(){console.log("[TranslateInit] åˆå§‹åŒ–æ–‡æœ¬æ¡†æç¤ºè¯è®¾ç½®...");try{const K=await xs();K.prompt_names!==void 0?(_.value=K.prompt_names||[],!t.settings.textboxPrompt&&K.default_prompt_content&&t.setTextboxPrompt(K.default_prompt_content),console.log(`[TranslateInit] å·²åŠ è½½ ${_.value.length} ä¸ªæ–‡æœ¬æ¡†æç¤ºè¯`)):K.error&&console.warn("[TranslateInit] è·å–æ–‡æœ¬æ¡†æç¤ºè¯å¤±è´¥:",K.error)}catch(K){console.error("[TranslateInit] è·å–æ–‡æœ¬æ¡†æç¤ºè¯å¤±è´¥:",K)}}async function y(){const K=s.query.book,Z=s.query.chapter;if(!K||!Z){console.log("[TranslateInit] æœªæŒ‡å®šä¹¦ç±/ç« èŠ‚å‚æ•°ï¼Œä½¿ç”¨ç‹¬ç«‹æ¨¡å¼"),Y.value=!1,D.value=null,R.value=null,M.value=null,k.value=null,o.clearContext();return}console.log(`[TranslateInit] æ£€æµ‹åˆ°ä¹¦ç±/ç« èŠ‚å‚æ•°: book=${K}, chapter=${Z}`),Y.value=!0,D.value=K,R.value=Z;try{const W=await Cs(K);if(!W.success||!W.book){console.warn("[TranslateInit] ä¹¦ç±ä¸å­˜åœ¨:",K),ye("ä¹¦ç±ä¸å­˜åœ¨","warning");return}const oe=W.book,b=oe.chapters?.find(c=>c.id===Z);if(!b){console.warn("[TranslateInit] ç« èŠ‚ä¸å­˜åœ¨:",Z),ye("ç« èŠ‚ä¸å­˜åœ¨","warning");return}if(M.value=oe.title,k.value=b.title,o.setBookChapterContext(K,Z,oe.title,b.title),typeof document<"u"&&(document.title=`${b.title} - ${oe.title} - Saber-Translator`),b.session_path){console.log(`[TranslateInit] å°è¯•åŠ è½½ç« èŠ‚ä¼šè¯: ${b.session_path}`);try{await o.loadSessionByPath(b.session_path),ye(`å·²åŠ è½½ç« èŠ‚: ${b.title}`,"success")}catch{console.log("[TranslateInit] ç« èŠ‚ä¼šè¯æ•°æ®ä¸å­˜åœ¨æˆ–åŠ è½½å¤±è´¥ï¼Œå°†åˆ›å»ºæ–°ä¼šè¯")}}}catch(W){console.error("[TranslateInit] åŠ è½½ä¹¦ç±/ç« èŠ‚ä¿¡æ¯å¤±è´¥:",W),ye("åŠ è½½ä¹¦ç±ä¿¡æ¯å¤±è´¥","error")}}function z(K){if(K<0||K>=n.imageCount){console.warn(`[TranslateInit] æ— æ•ˆçš„å›¾ç‰‡ç´¢å¼•: ${K}`);return}window._isChangingFromSwitchImage=!0,r.isActive.value&&r.exitEditModeWithoutRender(),n.currentImage&&i.bubbles.length>0&&n.updateCurrentImageProperty("bubbleStates",i.bubbles),n.setCurrentImageIndex(K);const W=n.currentImage;if(!W){console.warn("[TranslateInit] åˆ‡æ¢åˆ°çš„å›¾ç‰‡ä¸å­˜åœ¨"),window._isChangingFromSwitchImage=!1;return}console.log(`[TranslateInit] åˆ‡æ¢åˆ°å›¾ç‰‡: ${K}, ${W.fileName}`),W.bubbleStates&&W.bubbleStates.length>0?i.setBubbles(W.bubbleStates,!0):i.clearBubblesLocal(),setTimeout(()=>{window._isChangingFromSwitchImage=!1,console.log("[TranslateInit] å·²é‡ç½®åˆ‡æ¢å›¾ç‰‡æ“ä½œæ ‡è®°")},100)}function F(){n.canGoPrevious&&z(n.currentImageIndex-1)}function te(){n.canGoNext&&z(n.currentImageIndex+1)}function J(){dt(async()=>{await V()})}return{isInitializing:a,isInitialized:u,initError:g,fontList:S,promptNames:x,textboxPromptNames:_,currentBookId:D,currentChapterId:R,currentBookTitle:M,currentChapterTitle:k,isBookshelfMode:Y,initializeApp:V,initializeSettings:L,initializeFontList:v,initializePromptSettings:d,initializeTextboxPromptSettings:h,initializeBookChapterContext:y,switchImage:z,goToPrevious:F,goToNext:te,editMode:r,setupAutoInit:J}}const Si={key:0,id:"translationProgressBar",class:"translation-progress-bar"},_i={class:"parallel-header"},Ci={class:"header-title"},ki={key:0,class:"presave-section"},wi={class:"presave-label"},Ti={class:"presave-progress-bar"},$i={class:"pools-list"},Ii={class:"pool-label"},Ri={class:"pool-icon"},Pi={class:"pool-name"},Di={class:"pool-progress-bar"},Mi={class:"pool-stats"},Bi={class:"completed-count"},Ei={class:"total-count"},Ai={key:0,class:"waiting-badge"},Li={key:1,class:"lock-indicator",title:"ç­‰å¾…æ·±åº¦å­¦ä¹ é”"},Fi={key:0,class:"pool-row save-row"},Ui={class:"pool-progress-bar"},zi={class:"pool-stats"},Oi={class:"completed-count"},Vi={class:"total-count"},Ni={class:"overall-section"},Wi={class:"overall-label"},qi={key:0,class:"failed-text"},Ki={class:"overall-progress-bar"},Hi={class:"progress-bar-label"},ji={key:0,class:"failed-count"},Yi={class:"progress-bar"},Ji=Ye({__name:"TranslationProgress",props:{progress:{}},setup(s){const t=s,n=ot(),o=Fe(),i=Io(),r=$o(),a=Q(()=>{const d=r.progress.value?.preSave?.isRunning;return o.settings.parallel?.enabled&&(r.isRunning.value||d)}),u=Q(()=>r.progress.value),g=Q(()=>{const d=u.value;return!d||d.totalPages===0?0:Math.round(d.totalCompleted/d.totalPages*100)});function S(d){const h=u.value?.totalPages||0;return h===0?0:Math.round(d.completed/h*100)}function x(){const d=u.value?.totalPages||0;return d===0?0:Math.max(3,Math.round(1/d*100))}function _(){const d=u.value?.preSave;return!d||d.total===0?0:Math.round(d.current/d.total*100)}function D(){const d=u.value?.save;return!d||d.total===0?0:Math.round(d.completed/d.total*100)}const R=Q(()=>t.progress||i.progress.value),M=Q(()=>R.value.isInProgress||n.isBatchTranslationInProgress||a.value),k=Q(()=>R.value.current),Y=Q(()=>R.value.total),V=Q(()=>R.value.failed),L=Q(()=>R.value.percentage!==void 0?R.value.percentage:Y.value===0?0:Math.round(k.value/Y.value*100)),v=Q(()=>R.value.label?R.value.label:`ç¿»è¯‘ä¸­ï¼š${k.value} / ${Y.value}`);return(d,h)=>M.value?(A(),U("div",Si,[a.value&&u.value?(A(),U(We,{key:0},[e("div",_i,[e("span",Ci,"ğŸš€ å¹¶è¡Œç¿»è¯‘ä¸­ï¼š"+se(u.value.totalCompleted)+"/"+se(u.value.totalPages),1)]),u.value.preSave?.isRunning?(A(),U("div",ki,[e("div",wi," ğŸ“¥ é¢„ä¿å­˜åŸå§‹å›¾ç‰‡ï¼š"+se(u.value.preSave.current)+"/"+se(u.value.preSave.total),1),e("div",Ti,[e("div",{class:"presave-progress-fill",style:at({width:_()+"%"})},null,4)])])):fe("",!0),e("div",$i,[(A(!0),U(We,null,Qe(u.value.pools,y=>(A(),U("div",{key:y.name,class:Ee(["pool-row",{"pool-processing":y.processing,"pool-waiting-lock":y.isWaitingLock}])},[e("div",Ii,[e("span",Ri,se(y.icon),1),e("span",Pi,se(y.name),1)]),e("div",Di,[e("div",{class:"progress-completed",style:at({width:S(y)+"%"})},null,4),y.processing?(A(),U("div",{key:0,class:"progress-processing",style:at({left:S(y)+"%",width:x()+"%"})},null,4)):fe("",!0)]),e("div",Mi,[e("span",Bi,se(y.completed),1),e("span",Ei,"/ "+se(u.value.totalPages),1),y.waiting>0?(A(),U("span",Ai,"+"+se(y.waiting),1)):fe("",!0),y.isWaitingLock?(A(),U("span",Li,"ğŸ”’")):fe("",!0)])],2))),128)),u.value.save?(A(),U("div",Fi,[h[0]||(h[0]=e("div",{class:"pool-label"},[e("span",{class:"pool-icon"},"ğŸ’¾"),e("span",{class:"pool-name"},"ä¿å­˜")],-1)),e("div",Ui,[e("div",{class:"progress-completed save-progress",style:at({width:D()+"%"})},null,4)]),e("div",zi,[e("span",Oi,se(u.value.save.completed),1),e("span",Vi,"/ "+se(u.value.save.total),1)])])):fe("",!0)]),h[1]||(h[1]=e("div",{class:"divider"},null,-1)),e("div",Ni,[e("div",Wi,[Ue(" æ€»è¿›åº¦ï¼š"+se(g.value)+"% ",1),u.value.totalFailed>0?(A(),U("span",qi," ï¼ˆ"+se(u.value.totalFailed)+" å¤±è´¥ï¼‰ ",1)):fe("",!0)]),e("div",Ki,[e("div",{class:"overall-progress-fill progress-stripe",style:at({width:g.value+"%"})},null,4)])])],64)):(A(),U(We,{key:1},[e("div",Hi,[Ue(se(v.value)+" ",1),V.value>0?(A(),U("span",ji,"ï¼ˆ"+se(V.value)+" å¼ å¤±è´¥ï¼‰",1)):fe("",!0)]),e("div",Yi,[e("div",{class:"progress progress-stripe",style:at({width:`${L.value}%`})},null,4)])],64))])):fe("",!0)}}),Xi=je(Ji,[["__scopeId","data-v-532ece5f"]]),Gi=Ye({__name:"SponsorModal",emits:["close"],setup(s,{emit:t}){const n=t;return(o,i)=>(A(),ut(hn,{title:"æ”¯æŒä½œè€…",onClose:i[1]||(i[1]=r=>n("close"))},{footer:Ct(()=>[e("button",{type:"button",class:"btn btn-primary",onClick:i[0]||(i[0]=r=>n("close"))},"å…³é—­")]),default:Ct(()=>[i[2]||(i[2]=e("div",{class:"sponsor-content"},[e("p",{class:"sponsor-message"}," å¦‚æœè¿™ä¸ªé¡¹ç›®å¯¹ä½ æœ‰å¸®åŠ©ï¼Œæ¬¢è¿è¯·ä½œè€…å–æ¯å’–å•¡ â˜• "),e("div",{class:"qr-codes"},[e("div",{class:"qr-item"},[e("div",{class:"qr-image"},[e("img",{src:"/pic/wechat_qrcode.png",alt:"å¾®ä¿¡æ”¯ä»˜"})]),e("span",{class:"qr-label"},"å¾®ä¿¡æ”¯ä»˜")]),e("div",{class:"qr-item"},[e("div",{class:"qr-image"},[e("img",{src:"/pic/alipay_qrcode.png",alt:"æ”¯ä»˜å®"})]),e("span",{class:"qr-label"},"æ”¯ä»˜å®")])]),e("p",{class:"sponsor-thanks"},"æ„Ÿè°¢æ‚¨çš„æ”¯æŒï¼ğŸ™")],-1))]),_:1}))}}),Zi=je(Gi,[["__scopeId","data-v-02b6948e"]]);function Qi(s){const t=C(""),n=Q(()=>s.value.some(R=>R.folderPath)),o=Q(()=>{if(!n.value)return null;const R={name:"æ ¹ç›®å½•",path:"",images:[],subfolders:[]},M=new Map;M.set("",R);for(const k of s.value){const Y=k.folderPath||"";if(Y&&!M.has(Y)){const V=Y.split("/");let L="";for(const v of V){const d=L;if(L=L?`${L}/${v}`:v,!M.has(L)){const h={name:v,path:L,images:[],subfolders:[]};M.set(L,h),M.has(d)&&M.get(d).subfolders.push(h)}}}M.has(Y)&&M.get(Y).images.push(k)}return R}),i=Q(()=>{if(!t.value)return[{name:"æ ¹ç›®å½•",path:""}];const R=t.value.split("/"),M=[{name:"æ ¹ç›®å½•",path:""}];let k="";for(const Y of R)k=k?`${k}/${Y}`:Y,M.push({name:Y,path:k});return M}),r=Q(()=>{if(!o.value)return null;if(!t.value)return o.value;const R=(M,k)=>{if(M.path===k)return M;for(const Y of M.subfolders){const V=R(Y,k);if(V)return V}return null};return R(o.value,t.value)}),a=Q(()=>r.value?.subfolders||[]),u=Q(()=>r.value?.images||[]);function g(R){t.value=R}function S(){if(!t.value)return;const R=t.value.lastIndexOf("/");t.value=R>0?t.value.substring(0,R):""}function x(R){t.value=R}function _(R){let M=R.images.length;for(const k of R.subfolders)M+=_(k);return M}function D(){t.value=""}return{currentFolderPath:t,useTreeMode:n,folderTree:o,breadcrumbs:i,currentFolder:r,currentSubfolders:a,currentImages:u,enterFolder:g,goUp:S,navigateTo:x,getFolderImageCount:_,resetToRoot:D}}const er={id:"thumbnail-sidebar",class:"thumbnail-sidebar"},tr={class:"card thumbnail-card"},or={class:"breadcrumb-nav"},nr=["onClick"],sr={key:0,class:"breadcrumb-sep"},ar=["onClick"],lr={class:"folder-info"},ir=["title"],rr={class:"folder-count"},ur=["title","onClick"],cr=["src","alt"],dr={class:"page-number-indicator"},gr={key:1,class:"translated-indicator"},pr={key:2,class:"translation-failed-indicator"},mr={key:3,class:"labeled-indicator"},vr={key:4,class:"thumbnail-processing-indicator"},fr={key:0,class:"empty-folder"},br=["title","data-index","onClick"],hr=["src","alt"],yr={class:"page-number-indicator"},xr={key:1,class:"translated-indicator"},Sr={key:2,class:"translation-failed-indicator"},_r={key:3,class:"labeled-indicator"},Cr={key:4,class:"thumbnail-processing-indicator"},kr={key:2,class:"empty-state"},wr=Ye({__name:"ThumbnailSidebar",emits:["select"],setup(s,{emit:t}){const n=t,o=ot(),i=C(null),r=C([]),a=Q(()=>o.images),u=Q(()=>o.currentImageIndex),g=Q(()=>o.hasImages),{useTreeMode:S,breadcrumbs:x,currentSubfolders:_,currentImages:D,currentFolderPath:R,enterFolder:M,goUp:k,navigateTo:Y,getFolderImageCount:V,folderTree:L,resetToRoot:v}=Qi(a);_e(()=>a.value.length,(W,oe)=>{(W===0||oe===0&&W>0)&&v()});function d(W){return a.value.findIndex(oe=>oe.id===W.id)}function h(W){return W.translationFailed?"failed":W.isManuallyAnnotated?"labeled":W.translationStatus==="processing"?"processing":null}function y(W){return W.translationStatus==="completed"}function z(W){n("select",W)}function F(W){M(W.path)}function te(W){Y(W)}function J(){pt(()=>{const W=r.value[u.value];if(W&&i.value){const oe=i.value,b=W.offsetTop-oe.clientHeight/2+W.clientHeight/2;oe.scrollTo({top:Math.max(0,b),behavior:"smooth"})}})}function K(W,oe){r.value[oe]=W}function Z(W){return W.translationFailed?"ç¿»è¯‘å¤±è´¥ï¼Œç‚¹å‡»å¯é‡è¯•":W.isManuallyAnnotated?"åŒ…å«æ‰‹åŠ¨æ ‡æ³¨":W.translationStatus==="completed"?"å·²å®Œæˆç¿»è¯‘":W.fileName||""}return _e(u,()=>{J()}),dt(()=>{g.value&&J()}),(W,oe)=>(A(),U("aside",er,[e("div",tr,[oe[5]||(oe[5]=e("h2",null,"å›¾ç‰‡æ¦‚è§ˆ",-1)),g.value&&re(S)&&re(L)?(A(),U(We,{key:0},[e("div",or,[(A(!0),U(We,null,Qe(re(x),(b,c)=>(A(),U(We,{key:b.path},[e("span",{class:Ee(["breadcrumb-item",{active:c===re(x).length-1}]),onClick:m=>c<re(x).length-1&&te(b.path)},se(c===0?"ğŸ“":"")+se(b.name),11,nr),c<re(x).length-1?(A(),U("span",sr,"/")):fe("",!0)],64))),128))]),re(R)?(A(),U("div",{key:0,class:"folder-back-btn",onClick:oe[0]||(oe[0]=(...b)=>re(k)&&re(k)(...b))},[...oe[1]||(oe[1]=[e("span",{class:"back-icon"},"â¬…ï¸",-1),e("span",null,"è¿”å›ä¸Šçº§",-1)])])):fe("",!0),e("div",{ref_key:"containerRef",ref:i,class:"folder-content-list"},[(A(!0),U(We,null,Qe(re(_),b=>(A(),U("div",{key:b.path,class:"folder-item",onClick:c=>F(b)},[oe[2]||(oe[2]=e("span",{class:"folder-icon"},"ğŸ“",-1)),e("div",lr,[e("span",{class:"folder-name",title:b.name},se(b.name),9,ir),e("span",rr,"("+se(re(V)(b))+")",1)])],8,ar))),128)),(A(!0),U(We,null,Qe(re(D),b=>(A(),U("div",{key:b.id,ref_for:!0,ref:c=>K(c,d(b)),class:Ee(["thumbnail-item",{active:d(b)===u.value}]),title:Z(b),onClick:c=>z(d(b))},[b.originalDataURL?(A(),U("img",{key:0,src:b.originalDataURL,alt:b.fileName,class:"thumbnail-image"},null,8,cr)):fe("",!0),e("span",dr,se(d(b)+1),1),y(b)?(A(),U("span",gr,"âœ“")):fe("",!0),h(b)==="failed"?(A(),U("span",pr,"!")):h(b)==="labeled"?(A(),U("span",mr,"âœï¸")):fe("",!0),h(b)==="processing"?(A(),U("div",vr,"âŸ³")):fe("",!0)],10,ur))),128)),re(_).length===0&&re(D).length===0?(A(),U("div",fr,[...oe[3]||(oe[3]=[e("p",null,"æ­¤æ–‡ä»¶å¤¹ä¸ºç©º",-1)])])):fe("",!0)],512)],64)):g.value?(A(),U("ul",{key:1,ref_key:"containerRef",ref:i,id:"thumbnailList",class:"thumbnail-list"},[(A(!0),U(We,null,Qe(a.value,(b,c)=>(A(),U("li",{key:b.id,ref_for:!0,ref:m=>K(m,c),class:Ee(["thumbnail-item",{active:c===u.value}]),title:Z(b),"data-index":c,onClick:m=>z(c)},[b.originalDataURL?(A(),U("img",{key:0,src:b.originalDataURL,alt:b.fileName,class:"thumbnail-image"},null,8,hr)):fe("",!0),e("span",yr,se(c+1),1),y(b)?(A(),U("span",xr,"âœ“")):fe("",!0),h(b)==="failed"?(A(),U("span",Sr,"!")):h(b)==="labeled"?(A(),U("span",_r,"âœï¸")):fe("",!0),h(b)==="processing"?(A(),U("div",Cr," âŸ³ ")):fe("",!0)],10,br))),128))],512)):(A(),U("div",kr,[...oe[4]||(oe[4]=[e("p",null,"æš‚æ— å›¾ç‰‡",-1)])]))])]))}}),Tr=je(wr,[["__scopeId","data-v-4c1f4f1b"]]),$r={class:"saved-prompts-picker"},Ir={class:"prompts-chips-container"},Rr={key:0,class:"empty-hint"},Pr={key:1,class:"empty-hint"},Dr=["title","onClick"],Mr=Ye({__name:"SavedPromptsPicker",props:{promptType:{}},emits:["select"],setup(s,{expose:t,emit:n}){const o=s,i=n,r=C([]),a=C(!1);async function u(){a.value=!0;try{let S;o.promptType==="textbox"?S=await qe.getTextboxPrompts():S=await qe.getPrompts(o.promptType);const x=S.prompt_names||[];r.value=x.map(_=>({name:_}))}catch(S){console.error("åŠ è½½æç¤ºè¯åˆ—è¡¨å¤±è´¥:",S),r.value=[]}finally{a.value=!1}}async function g(S){try{let x;o.promptType==="textbox"?x=await qe.getTextboxPromptContent(S):x=await qe.getPromptContent(o.promptType,S),x.prompt_content&&i("select",x.prompt_content,S)}catch(x){console.error("åŠ è½½æç¤ºè¯å†…å®¹å¤±è´¥:",x)}}return _e(()=>o.promptType,()=>{u()}),dt(()=>{u()}),t({refresh:u}),(S,x)=>(A(),U("div",$r,[x[1]||(x[1]=e("span",{class:"picker-label"},"ğŸ“‘ å¿«é€Ÿé€‰æ‹©:",-1)),e("div",Ir,[a.value?(A(),U("span",Rr,"åŠ è½½ä¸­...")):r.value.length===0?(A(),U("span",Pr,"æš‚æ— ä¿å­˜çš„æç¤ºè¯")):(A(!0),U(We,{key:2},Qe(r.value,_=>(A(),U("button",{key:_.name,type:"button",class:"prompt-chip",title:_.name,onClick:D=>g(_.name)},[x[0]||(x[0]=e("span",{class:"chip-icon"},"ğŸ“",-1)),Ue(" "+se(_.name),1)],8,Dr))),128))])]))}}),Ft=je(Mr,[["__scopeId","data-v-2ebbb8b3"]]),Br={class:"ocr-settings"},Er={class:"settings-group"},Ar={class:"settings-item"},Lr={class:"settings-item"},Fr={class:"input-hint"},Ur={class:"settings-group"},zr={class:"settings-item"},Or={class:"settings-group"},Vr={class:"settings-row"},Nr={class:"settings-item"},Wr={class:"password-input-wrapper"},qr=["type"],Kr={key:0,class:"eye-icon"},Hr={key:1,class:"eye-off-icon"},jr={class:"settings-item"},Yr={class:"password-input-wrapper"},Jr=["type"],Xr={key:0,class:"eye-icon"},Gr={key:1,class:"eye-off-icon"},Zr={class:"settings-row"},Qr={class:"settings-item"},eu={class:"settings-item"},tu=["disabled"],ou={class:"settings-group"},nu={class:"settings-row"},su={class:"settings-item"},au={class:"settings-item"},lu={class:"password-input-wrapper"},iu=["type"],ru={key:0,class:"eye-icon"},uu={key:1,class:"eye-off-icon"},cu={class:"settings-item"},du={class:"settings-item"},gu={class:"model-input-with-fetch"},pu=["disabled"],mu={class:"fetch-text"},vu={key:0,class:"model-select-container"},fu={class:"model-count"},bu={class:"settings-item"},hu={class:"prompt-format-selector"},yu={class:"settings-item"},xu={class:"settings-item"},Su=["disabled"],_u=Ye({__name:"OcrSettings",setup(s){const t=[{label:"MangaOCR (æ—¥è¯­ä¸“ç”¨)",value:"manga_ocr"},{label:"PaddleOCR (å¤šè¯­è¨€)",value:"paddle_ocr"},{label:"PaddleOCR-VL",value:"paddleocr_vl"},{label:"ç™¾åº¦OCR",value:"baidu_ocr"},{label:"48px OCR",value:"48px_ocr"},{label:"AIè§†è§‰OCR",value:"ai_vision"}],n=[{label:"æ ‡å‡†ç‰ˆ",value:"standard"},{label:"é«˜ç²¾åº¦ç‰ˆ",value:"high_precision"}],o=[{label:"è‡ªåŠ¨æ£€æµ‹",value:"auto_detect"},{label:"ä¸­è‹±æ–‡æ··åˆ",value:"CHN_ENG"},{label:"è‹±æ–‡",value:"ENG"},{label:"æ—¥è¯­",value:"JAP"},{label:"éŸ©è¯­",value:"KOR"},{label:"æ³•è¯­",value:"FRE"},{label:"å¾·è¯­",value:"GER"},{label:"ä¿„è¯­",value:"RUS"}],i=[{label:"SiliconFlow (ç¡…åŸºæµåŠ¨)",value:"siliconflow"},{label:"ç«å±±å¼•æ“",value:"volcano"},{label:"Google Gemini",value:"gemini"},{label:"è‡ªå®šä¹‰ OpenAI å…¼å®¹æœåŠ¡",value:"custom_openai_vision"}],r=[{label:"æ—¥è¯­",value:"japanese"},{label:"ç®€ä½“ä¸­æ–‡",value:"chinese"},{label:"ç¹ä½“ä¸­æ–‡",value:"chinese_cht"},{label:"è‹±è¯­",value:"english"},{label:"éŸ©è¯­",value:"korean"}],a=[{label:"æ™®é€šæç¤ºè¯",value:"false"},{label:"JSONæç¤ºè¯",value:"true"}],u=[{label:"ğŸš€ å¸¸ç”¨è¯­è¨€",options:[{label:"æ—¥è¯­",value:"japanese"},{label:"è‹±è¯­",value:"en"},{label:"ç®€ä½“ä¸­æ–‡",value:"chinese"},{label:"ç¹ä½“ä¸­æ–‡",value:"chinese_cht"},{label:"éŸ©è¯­",value:"korean"}]},{label:"ğŸŒ æ‹‰ä¸è¯­ç³»",options:[{label:"æ³•è¯­",value:"french"},{label:"å¾·è¯­",value:"german"},{label:"è¥¿ç­ç‰™è¯­",value:"spanish"},{label:"æ„å¤§åˆ©è¯­",value:"italian"},{label:"è‘¡è„ç‰™è¯­",value:"portuguese"}]},{label:"ğŸŒ å…¶ä»–è¯­ç³»",options:[{label:"ä¿„è¯­",value:"russian"}]}],g=Fe(),S=ct(),x=C({apiKey:g.settings.baiduOcr.apiKey,secretKey:g.settings.baiduOcr.secretKey,version:g.settings.baiduOcr.version,sourceLanguage:g.settings.baiduOcr.sourceLanguage}),_=C({apiKey:g.settings.aiVisionOcr.apiKey,modelName:g.settings.aiVisionOcr.modelName,customBaseUrl:g.settings.aiVisionOcr.customBaseUrl,prompt:g.settings.aiVisionOcr.prompt,rpmLimit:g.settings.aiVisionOcr.rpmLimit,minImageSize:g.settings.aiVisionOcr.minImageSize}),D=Q(()=>g.settings);_e(()=>x.value.apiKey,b=>{g.updateBaiduOcr({apiKey:b})}),_e(()=>x.value.secretKey,b=>{g.updateBaiduOcr({secretKey:b})}),_e(()=>x.value.version,b=>{g.updateBaiduOcr({version:b})}),_e(()=>x.value.sourceLanguage,b=>{g.updateBaiduOcr({sourceLanguage:b})}),_e(()=>_.value.apiKey,b=>{g.updateAiVisionOcr({apiKey:b})}),_e(()=>_.value.modelName,b=>{g.updateAiVisionOcr({modelName:b})}),_e(()=>_.value.customBaseUrl,b=>{g.updateAiVisionOcr({customBaseUrl:b})}),_e(()=>_.value.prompt,b=>{g.updateAiVisionOcr({prompt:b})}),_e(()=>_.value.rpmLimit,b=>{g.updateAiVisionOcr({rpmLimit:b})}),_e(()=>_.value.minImageSize,b=>{g.updateAiVisionOcr({minImageSize:b})});const R=C(!1),M=C(!1),k=C(!1),Y=C(!1),V=C(!1),L=C([]),v=Q(()=>{const b=[{label:"-- é€‰æ‹©æ¨¡å‹ --",value:""}];return L.value.forEach(c=>{b.push({label:c,value:c})}),b});function d(){g.saveToStorage()}function h(){g.saveToStorage()}function y(b){g.updatePaddleOcrVl({sourceLanguage:b})}function z(){switch(g.settings.ocrEngine){case"manga_ocr":return"MangaOCR ä¸“ä¸ºæ—¥è¯­æ¼«ç”»ä¼˜åŒ–ï¼Œæºè¯­è¨€è®¾ç½®ä¸å½±å“è¯†åˆ«";case"paddle_ocr":return"PaddleOCR ä¼šæ ¹æ®æºè¯­è¨€åŠ è½½å¯¹åº”çš„è¯†åˆ«æ¨¡å‹";case"paddleocr_vl":return"PaddleOCR-VL åŸºäº VLM å¾®è°ƒï¼Œä¸“ä¸ºæ—¥è¯­æ¼«ç”»ä¼˜åŒ–ï¼Œå‡†ç¡®ç‡é«˜è¾¾ 70%";case"baidu_ocr":return"ç™¾åº¦OCR ä½¿ç”¨ç‹¬ç«‹çš„æºè¯­è¨€è®¾ç½®ï¼ˆè§ä¸‹æ–¹ï¼‰";case"ai_vision":return"AIè§†è§‰OCR é€šè¿‡æç¤ºè¯æŒ‡å®šè¯†åˆ«è¯­è¨€";case"48px_ocr":return"48px OCR æ”¯æŒæ—¥ä¸­è‹±éŸ©ç­‰å¤šè¯­è¨€ï¼Œæºè¯­è¨€è®¾ç½®ä¸å½±å“è¯†åˆ«";default:return"é€‰æ‹©è¦è¯†åˆ«çš„åŸæ–‡è¯­è¨€"}}function F(b){g.setAiVisionOcrProvider(b),L.value=[],te()}function te(){_.value.apiKey=g.settings.aiVisionOcr.apiKey,_.value.modelName=g.settings.aiVisionOcr.modelName,_.value.customBaseUrl=g.settings.aiVisionOcr.customBaseUrl,_.value.prompt=g.settings.aiVisionOcr.prompt,_.value.rpmLimit=g.settings.aiVisionOcr.rpmLimit,_.value.minImageSize=g.settings.aiVisionOcr.minImageSize}function J(){const b=g.settings.aiVisionOcr.isJsonMode?ns:ss;g.updateAiVisionOcr({prompt:b}),_.value.prompt=b}async function K(){const b=x.value.apiKey?.trim(),c=x.value.secretKey?.trim();if(!b||!c){S.warning("è¯·å¡«å†™ç™¾åº¦OCRçš„API Keyå’ŒSecret Key");return}Y.value=!0,S.info("æ­£åœ¨æµ‹è¯•ç™¾åº¦OCRè¿æ¥...");try{const m=await qe.testBaiduOcrConnection(b,c);m.success?S.success(m.message||"ç™¾åº¦OCRè¿æ¥æˆåŠŸ!"):S.error(m.message||m.error||"ç™¾åº¦OCRè¿æ¥å¤±è´¥")}catch(m){const l=m instanceof Error?m.message:"è¿æ¥æµ‹è¯•å¤±è´¥";S.error(l)}finally{Y.value=!1}}async function Z(){Y.value=!0;try{const b=await qe.testAiVisionOcrConnection({provider:g.settings.aiVisionOcr.provider,apiKey:_.value.apiKey,modelName:_.value.modelName,customBaseUrl:_.value.customBaseUrl,prompt:_.value.prompt});b.success?S.success("AIè§†è§‰OCRè¿æ¥æˆåŠŸ"):S.error(`AIè§†è§‰OCRè¿æ¥å¤±è´¥: ${b.error||"æœªçŸ¥é”™è¯¯"}`)}catch(b){const c=b instanceof Error?b.message:"è¿æ¥æµ‹è¯•å¤±è´¥";S.error(c)}finally{Y.value=!1}}async function W(){const b=g.settings.aiVisionOcr.provider,c=_.value.apiKey?.trim(),m=_.value.customBaseUrl?.trim();if(!c){S.warning("è¯·å…ˆå¡«å†™ API Key");return}if(!["siliconflow","volcano","gemini","custom_openai_vision"].includes(b)){S.warning("å½“å‰æœåŠ¡å•†ä¸æ”¯æŒè‡ªåŠ¨è·å–æ¨¡å‹åˆ—è¡¨");return}if(b==="custom_openai_vision"&&!m){S.warning("è‡ªå®šä¹‰æœåŠ¡éœ€è¦å…ˆå¡«å†™ Base URL");return}V.value=!0;try{const p=await qe.fetchModels(b,c,m);p.success&&p.models&&p.models.length>0?(L.value=p.models.map($=>$.id),S.success(`è·å–åˆ° ${p.models.length} ä¸ªæ¨¡å‹`)):S.warning(p.message||"æœªè·å–åˆ°å¯ç”¨æ¨¡å‹")}catch(p){const $=p instanceof Error?p.message:"è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥";S.error($)}finally{V.value=!1}}function oe(b,c){g.updateAiVisionOcr({prompt:b}),_.value.prompt=b,S.success(`å·²åº”ç”¨æç¤ºè¯: ${c}`)}return(b,c)=>(A(),U("div",Br,[e("div",Er,[c[21]||(c[21]=e("div",{class:"settings-group-title"},"OCRå¼•æ“é€‰æ‹©",-1)),e("div",Ar,[c[19]||(c[19]=e("label",{for:"settingsOcrEngine"},"OCRå¼•æ“:",-1)),xe(Ne,{"model-value":D.value.ocrEngine,options:t,onChange:c[0]||(c[0]=m=>{D.value.ocrEngine=m,d()})},null,8,["model-value"])]),ne(e("div",Lr,[c[20]||(c[20]=e("label",{for:"settingsSourceLanguage"},"æºè¯­è¨€:",-1)),xe(Ne,{"model-value":D.value.sourceLanguage,groups:u,onChange:c[1]||(c[1]=m=>{D.value.sourceLanguage=m,h()})},null,8,["model-value"]),e("div",Fr,se(z()),1)],512),[[Oe,D.value.ocrEngine==="paddle_ocr"]])]),ne(e("div",Ur,[c[24]||(c[24]=e("div",{class:"settings-group-title"},"PaddleOCR-VL è®¾ç½®",-1)),e("div",zr,[c[22]||(c[22]=e("label",{for:"settingsPaddleOcrVlSourceLanguage"},"æºè¯­è¨€:",-1)),xe(Ne,{"model-value":D.value.paddleOcrVl.sourceLanguage,options:r,onChange:c[2]||(c[2]=m=>y(m))},null,8,["model-value"]),c[23]||(c[23]=e("div",{class:"input-hint"}," é€‰æ‹©å›¾åƒä¸­çš„æºè¯­è¨€ï¼Œç”¨äºä¼˜åŒ– OCR è¯†åˆ«æ•ˆæœ ",-1))])],512),[[Oe,D.value.ocrEngine==="paddleocr_vl"]]),ne(e("div",Or,[c[29]||(c[29]=e("div",{class:"settings-group-title"},"ç™¾åº¦OCR è®¾ç½®",-1)),e("div",Vr,[e("div",Nr,[c[25]||(c[25]=e("label",{for:"settingsBaiduApiKey"},"API Key:",-1)),e("div",Wr,[ne(e("input",{type:R.value?"text":"password",id:"settingsBaiduApiKey","onUpdate:modelValue":c[3]||(c[3]=m=>x.value.apiKey=m),class:"secure-input",placeholder:"è¯·è¾“å…¥ç™¾åº¦OCR API Key",autocomplete:"off"},null,8,qr),[[Tt,x.value.apiKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:c[4]||(c[4]=m=>R.value=!R.value)},[R.value?(A(),U("span",Hr,"ğŸ‘â€ğŸ—¨")):(A(),U("span",Kr,"ğŸ‘"))])])]),e("div",jr,[c[26]||(c[26]=e("label",{for:"settingsBaiduSecretKey"},"Secret Key:",-1)),e("div",Yr,[ne(e("input",{type:M.value?"text":"password",id:"settingsBaiduSecretKey","onUpdate:modelValue":c[5]||(c[5]=m=>x.value.secretKey=m),class:"secure-input",placeholder:"è¯·è¾“å…¥Secret Key",autocomplete:"off"},null,8,Jr),[[Tt,x.value.secretKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:c[6]||(c[6]=m=>M.value=!M.value)},[M.value?(A(),U("span",Gr,"ğŸ‘â€ğŸ—¨")):(A(),U("span",Xr,"ğŸ‘"))])])])]),e("div",Zr,[e("div",Qr,[c[27]||(c[27]=e("label",{for:"settingsBaiduVersion"},"è¯†åˆ«ç‰ˆæœ¬:",-1)),xe(Ne,{modelValue:x.value.version,"onUpdate:modelValue":c[7]||(c[7]=m=>x.value.version=m),options:n},null,8,["modelValue"])]),e("div",eu,[c[28]||(c[28]=e("label",{for:"settingsBaiduSourceLanguage"},"æºè¯­è¨€:",-1)),xe(Ne,{modelValue:x.value.sourceLanguage,"onUpdate:modelValue":c[8]||(c[8]=m=>x.value.sourceLanguage=m),options:o},null,8,["modelValue"])])]),e("button",{class:"settings-test-btn",onClick:K,disabled:Y.value},se(Y.value?"æµ‹è¯•ä¸­...":"ğŸ”— æµ‹è¯•è¿æ¥"),9,tu)],512),[[Oe,D.value.ocrEngine==="baidu_ocr"]]),ne(e("div",ou,[c[41]||(c[41]=e("div",{class:"settings-group-title"},"AIè§†è§‰OCR è®¾ç½®",-1)),e("div",nu,[e("div",su,[c[30]||(c[30]=e("label",{for:"settingsAiVisionProvider"},"æœåŠ¡å•†:",-1)),xe(Ne,{"model-value":D.value.aiVisionOcr.provider,options:i,onChange:c[9]||(c[9]=m=>F(m))},null,8,["model-value"])]),e("div",au,[c[31]||(c[31]=e("label",{for:"settingsAiVisionApiKey"},"API Key:",-1)),e("div",lu,[ne(e("input",{type:k.value?"text":"password",id:"settingsAiVisionApiKey","onUpdate:modelValue":c[10]||(c[10]=m=>_.value.apiKey=m),class:"secure-input",placeholder:"è¯·è¾“å…¥API Key",autocomplete:"off"},null,8,iu),[[Tt,_.value.apiKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:c[11]||(c[11]=m=>k.value=!k.value)},[k.value?(A(),U("span",uu,"ğŸ‘â€ğŸ—¨")):(A(),U("span",ru,"ğŸ‘"))])])])]),ne(e("div",cu,[c[32]||(c[32]=e("label",{for:"settingsCustomAiVisionBaseUrl"},"Base URL:",-1)),ne(e("input",{type:"text",id:"settingsCustomAiVisionBaseUrl","onUpdate:modelValue":c[12]||(c[12]=m=>_.value.customBaseUrl=m),placeholder:"ä¾‹å¦‚: https://api.example.com/v1"},null,512),[[ke,_.value.customBaseUrl]])],512),[[Oe,D.value.aiVisionOcr.provider==="custom_openai_vision"]]),e("div",du,[c[34]||(c[34]=e("label",{for:"settingsAiVisionModelName"},"æ¨¡å‹åç§°:",-1)),e("div",gu,[ne(e("input",{type:"text",id:"settingsAiVisionModelName","onUpdate:modelValue":c[13]||(c[13]=m=>_.value.modelName=m),placeholder:"å¦‚: silicon-llava2-34b"},null,512),[[ke,_.value.modelName]]),e("button",{type:"button",class:"fetch-models-btn",title:"è·å–å¯ç”¨æ¨¡å‹åˆ—è¡¨",onClick:W,disabled:V.value},[c[33]||(c[33]=e("span",{class:"fetch-icon"},"ğŸ”",-1)),e("span",mu,se(V.value?"è·å–ä¸­...":"è·å–æ¨¡å‹"),1)],8,pu)]),L.value.length>0?(A(),U("div",vu,[xe(Ne,{modelValue:_.value.modelName,"onUpdate:modelValue":c[14]||(c[14]=m=>_.value.modelName=m),options:v.value},null,8,["modelValue","options"]),e("span",fu,"å…± "+se(L.value.length)+" ä¸ªæ¨¡å‹",1)])):fe("",!0)]),e("div",bu,[c[36]||(c[36]=e("label",{for:"settingsAiVisionOcrPrompt"},"OCRæç¤ºè¯:",-1)),ne(e("textarea",{id:"settingsAiVisionOcrPrompt","onUpdate:modelValue":c[15]||(c[15]=m=>_.value.prompt=m),rows:"3",placeholder:"AIè§†è§‰OCRæç¤ºè¯"},null,512),[[ke,_.value.prompt]]),xe(Ft,{"prompt-type":"ai_vision_ocr",onSelect:oe}),e("div",hu,[xe(Ne,{"model-value":D.value.aiVisionOcr.isJsonMode?"true":"false",options:a,onChange:c[16]||(c[16]=m=>{D.value.aiVisionOcr.isJsonMode=m==="true",J()})},null,8,["model-value"]),c[35]||(c[35]=e("span",{class:"input-hint"},"JSONæ ¼å¼è¾“å‡ºæ›´ç»“æ„åŒ–",-1))])]),e("div",yu,[c[37]||(c[37]=e("label",{for:"settingsRpmAiVisionOcr"},"RPMé™åˆ¶ (æ¯åˆ†é’Ÿè¯·æ±‚æ•°):",-1)),ne(e("input",{type:"number",id:"settingsRpmAiVisionOcr","onUpdate:modelValue":c[17]||(c[17]=m=>_.value.rpmLimit=m),min:"0",step:"1"},null,512),[[ke,_.value.rpmLimit,void 0,{number:!0}]]),c[38]||(c[38]=e("div",{class:"input-hint"},"0 è¡¨ç¤ºæ— é™åˆ¶",-1))]),e("div",xu,[c[39]||(c[39]=e("label",{for:"settingsMinImageSize"},"æœ€å°å›¾ç‰‡å°ºå¯¸ (åƒç´ ):",-1)),ne(e("input",{type:"number",id:"settingsMinImageSize","onUpdate:modelValue":c[18]||(c[18]=m=>_.value.minImageSize=m),min:"0",step:"1"},null,512),[[ke,_.value.minImageSize,void 0,{number:!0}]]),c[40]||(c[40]=e("div",{class:"input-hint"},"VLMæ¨¡å‹é€šå¸¸è¦æ±‚å›¾ç‰‡å°ºå¯¸ â‰¥28pxï¼Œè®¾ä¸º0åˆ™ä¸è‡ªåŠ¨æ”¾å¤§å°å›¾",-1))]),e("button",{class:"settings-test-btn",onClick:Z,disabled:Y.value},se(Y.value?"æµ‹è¯•ä¸­...":"ğŸ”— æµ‹è¯•è¿æ¥"),9,Su)],512),[[Oe,D.value.ocrEngine==="ai_vision"]])]))}}),Cu=je(_u,[["__scopeId","data-v-60d41103"]]),ku={class:"translation-settings"},wu={class:"settings-group"},Tu={class:"settings-row"},$u={class:"settings-item"},Iu={class:"settings-item"},Ru={for:"settingsApiKey"},Pu={class:"password-input-wrapper"},Du=["type","placeholder"],Mu={key:0,class:"eye-icon"},Bu={key:1,class:"eye-off-icon"},Eu={class:"settings-item"},Au={class:"settings-item"},Lu={for:"settingsModelName"},Fu={class:"model-input-with-fetch"},Uu=["placeholder"],zu=["disabled"],Ou={class:"fetch-text"},Vu={key:0,class:"model-select-container"},Nu={class:"model-count"},Wu={class:"settings-item"},qu={class:"local-model-list"},Ku={key:0,class:"model-list-container"},Hu=["disabled"],ju={key:1,class:"model-hint"},Yu={key:1,class:"model-list-container"},Ju=["disabled"],Xu={key:1,class:"model-hint"},Gu={class:"settings-row"},Zu={class:"settings-item"},Qu={class:"settings-item"},ec={class:"settings-item"},tc=["disabled"],oc={class:"settings-item"},nc=["disabled"],sc={class:"settings-group"},ac={class:"settings-item"},lc={class:"prompt-format-selector"},ic={class:"settings-item"},rc={class:"checkbox-label"},uc={class:"settings-item"},cc=Ye({__name:"TranslationSettings",setup(s){const t=[{label:"SiliconFlow",value:"siliconflow"},{label:"DeepSeek",value:"deepseek"},{label:"ç«å±±å¼•æ“",value:"volcano"},{label:"å½©äº‘å°è¯‘",value:"caiyun"},{label:"ç™¾åº¦ç¿»è¯‘",value:"baidu_translate"},{label:"æœ‰é“ç¿»è¯‘",value:"youdao_translate"},{label:"Google Gemini",value:"gemini"},{label:"Ollama (æœ¬åœ°)",value:"ollama"},{label:"Sakura (æœ¬åœ°)",value:"sakura"},{label:"è‡ªå®šä¹‰ OpenAI å…¼å®¹æœåŠ¡",value:"custom_openai"}],n=[{label:"æ™®é€šæç¤ºè¯",value:"normal"},{label:"JSONæç¤ºè¯",value:"json"}],o=Fe(),i=ct(),r=C({modelProvider:o.settings.translation.provider,apiKey:o.settings.translation.apiKey,modelName:o.settings.translation.modelName,customBaseUrl:o.settings.translation.customBaseUrl,rpmTranslation:o.settings.translation.rpmLimit,translationMaxRetries:o.settings.translation.maxRetries,promptContent:o.settings.translatePrompt,translatePromptMode:o.settings.translation.isJsonMode?"json":"normal",enableTextboxPrompt:o.settings.useTextboxPrompt,textboxPromptContent:o.settings.textboxPrompt}),a=C(!1),u=C(!1),g=C(!1),S=C([]),x=C([]),_=C([]),D=Q(()=>{const m=[{label:"-- é€‰æ‹©æ¨¡å‹ --",value:""}];return S.value.forEach(l=>m.push({label:l,value:l})),m}),R=Q(()=>{const m=[{label:"-- é€‰æ‹©æ¨¡å‹ --",value:""}];return x.value.forEach(l=>m.push({label:l,value:l})),m}),M=Q(()=>{const m=[{label:"-- é€‰æ‹©æ¨¡å‹ --",value:""}];return _.value.forEach(l=>m.push({label:l,value:l})),m}),k=Q(()=>["ollama","sakura"].includes(r.value.modelProvider)),Y=Q(()=>!["ollama","sakura","caiyun","baidu_translate","youdao_translate"].includes(r.value.modelProvider)),V=Q(()=>["siliconflow","deepseek","volcano","gemini","custom_openai"].includes(r.value.modelProvider)),L=Q(()=>{switch(r.value.modelProvider){case"baidu_translate":return"App ID";case"youdao_translate":return"App Key";case"caiyun":return"API Token";default:return"API Key"}}),v=Q(()=>{switch(r.value.modelProvider){case"baidu_translate":return"è¯·è¾“å…¥ç™¾åº¦ç¿»è¯‘App ID";case"youdao_translate":return"è¯·è¾“å…¥æœ‰é“ç¿»è¯‘åº”ç”¨ID";case"caiyun":return"è¯·è¾“å…¥å½©äº‘å°è¯‘Token";default:return"è¯·è¾“å…¥API Key"}}),d=Q(()=>{switch(r.value.modelProvider){case"baidu_translate":return"App Key";case"youdao_translate":return"App Secret";case"caiyun":return"æºè¯­è¨€ (å¯é€‰)";default:return"æ¨¡å‹åç§°"}}),h=Q(()=>{switch(r.value.modelProvider){case"baidu_translate":return"è¯·è¾“å…¥ç™¾åº¦ç¿»è¯‘App Key";case"youdao_translate":return"è¯·è¾“å…¥æœ‰é“ç¿»è¯‘åº”ç”¨å¯†é’¥";case"caiyun":return"å¯é€‰: auto/æ—¥è¯­/è‹±è¯­";default:return"è¯·è¾“å…¥æ¨¡å‹åç§°"}});function y(){const m=r.value.modelProvider;o.setTranslationProvider(m),r.value.apiKey=o.settings.translation.apiKey,r.value.modelName=o.settings.translation.modelName,r.value.customBaseUrl=o.settings.translation.customBaseUrl,r.value.rpmTranslation=o.settings.translation.rpmLimit,r.value.translationMaxRetries=o.settings.translation.maxRetries,S.value=[]}function z(){const m=r.value.translatePromptMode==="json";m?r.value.promptContent=jo:r.value.promptContent=Yo,o.updateTranslationService({isJsonMode:m}),o.setTranslatePrompt(r.value.promptContent)}_e(()=>r.value.apiKey,m=>{o.updateTranslationService({apiKey:m})}),_e(()=>r.value.modelName,m=>{o.updateTranslationService({modelName:m})}),_e(()=>r.value.customBaseUrl,m=>{o.updateTranslationService({customBaseUrl:m})}),_e(()=>r.value.rpmTranslation,m=>{o.updateTranslationService({rpmLimit:m})}),_e(()=>r.value.translationMaxRetries,m=>{o.updateTranslationService({maxRetries:m})}),_e(()=>r.value.promptContent,m=>{o.setTranslatePrompt(m)}),_e(()=>r.value.enableTextboxPrompt,m=>{o.setUseTextboxPrompt(m)}),_e(()=>r.value.textboxPromptContent,m=>{o.setTextboxPrompt(m)});async function F(){const m=r.value.modelProvider,l=r.value.apiKey?.trim(),p=r.value.customBaseUrl?.trim();if(!l){i.warning("è¯·å…ˆå¡«å†™ API Key");return}if(!["siliconflow","deepseek","volcano","gemini","custom_openai"].includes(m)){i.warning(`${te(m)} ä¸æ”¯æŒè‡ªåŠ¨è·å–æ¨¡å‹åˆ—è¡¨`);return}if(m==="custom_openai"&&!p){i.warning("è‡ªå®šä¹‰æœåŠ¡éœ€è¦å…ˆå¡«å†™ Base URL");return}g.value=!0;try{const w=await qe.fetchModels(m,l,p);w.success&&w.models&&w.models.length>0?(S.value=w.models.map(P=>P.id),i.success(`è·å–åˆ° ${w.models.length} ä¸ªæ¨¡å‹`)):i.warning(w.message||"æœªè·å–åˆ°å¯ç”¨æ¨¡å‹")}catch(w){const P=w instanceof Error?w.message:"è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥";i.error(P)}finally{g.value=!1}}function te(m){return{siliconflow:"SiliconFlow",deepseek:"DeepSeek",volcano:"ç«å±±å¼•æ“",gemini:"Google Gemini",custom_openai:"è‡ªå®šä¹‰OpenAI",ollama:"Ollama",sakura:"Sakura",caiyun:"å½©äº‘å°è¯‘",baidu_translate:"ç™¾åº¦ç¿»è¯‘",youdao_translate:"æœ‰é“ç¿»è¯‘"}[m]||m}async function J(){g.value=!0;try{const m=await qe.testOllamaConnection();m.success&&m.models?(x.value=m.models,i.success(`è·å–åˆ° ${m.models.length} ä¸ªOllamaæ¨¡å‹`)):i.error(m.error||"Ollamaè¿æ¥å¤±è´¥")}catch(m){const l=m instanceof Error?m.message:"è·å–Ollamaæ¨¡å‹å¤±è´¥";i.error(l)}finally{g.value=!1}}async function K(){g.value=!0;try{const m=await qe.testSakuraConnection();m.success&&m.models?(_.value=m.models,i.success(`è·å–åˆ° ${m.models.length} ä¸ªSakuraæ¨¡å‹`)):i.error(m.error||"Sakuraè¿æ¥å¤±è´¥")}catch(m){const l=m instanceof Error?m.message:"è·å–Sakuraæ¨¡å‹å¤±è´¥";i.error(l)}finally{g.value=!1}}async function Z(){u.value=!0;try{let m;r.value.modelProvider==="ollama"?m=await qe.testOllamaConnection():m=await qe.testSakuraConnection(),m.success?i.success(`${r.value.modelProvider==="ollama"?"Ollama":"Sakura"} è¿æ¥æˆåŠŸ`):i.error(m.error||"è¿æ¥å¤±è´¥")}catch(m){const l=m instanceof Error?m.message:"è¿æ¥æµ‹è¯•å¤±è´¥";i.error(l)}finally{u.value=!1}}async function W(){const m=r.value.modelProvider,l=r.value.apiKey?.trim(),p=r.value.modelName?.trim(),$=r.value.customBaseUrl?.trim();if(!l){i.warning("è¯·å…ˆå¡«å†™ API Key");return}if(m!=="caiyun"&&!p){i.warning("è¯·å¡«å†™æ¨¡å‹åç§°");return}if(m==="custom_openai"&&!$){i.warning("è‡ªå®šä¹‰æœåŠ¡éœ€è¦å¡«å†™ Base URL");return}u.value=!0,i.info("æ­£åœ¨æµ‹è¯•è¿æ¥...");try{let w;switch(m){case"baidu_translate":w=await qe.testBaiduTranslateConnection(l,p);break;case"youdao_translate":w=await qe.testYoudaoTranslateConnection(l,p);break;default:w=await qe.testAiTranslateConnection({provider:m,apiKey:l,modelName:p,baseUrl:$})}w.success?i.success(w.message||`${te(m)} è¿æ¥æˆåŠŸ!`):i.error(w.message||w.error||"è¿æ¥å¤±è´¥")}catch(w){const P=w instanceof Error?w.message:"è¿æ¥æµ‹è¯•å¤±è´¥";i.error(P)}finally{u.value=!1}}function oe(m,l){r.value.promptContent=m,i.success(`å·²åº”ç”¨æç¤ºè¯: ${l}`)}function b(m,l){r.value.textboxPromptContent=m,i.success(`å·²åº”ç”¨æç¤ºè¯: ${l}`)}function c(){r.value.translatePromptMode==="json"?r.value.promptContent=jo:r.value.promptContent=Yo,i.success("å·²é‡ç½®ä¸ºé»˜è®¤æç¤ºè¯")}return(m,l)=>(A(),U("div",ku,[e("div",wu,[l[21]||(l[21]=e("div",{class:"settings-group-title"},"ç¿»è¯‘æœåŠ¡é…ç½®",-1)),e("div",Tu,[e("div",$u,[l[14]||(l[14]=e("label",{for:"settingsModelProvider"},"ç¿»è¯‘æœåŠ¡å•†:",-1)),xe(Ne,{"model-value":r.value.modelProvider,options:t,onChange:l[0]||(l[0]=p=>{r.value.modelProvider=p,y()})},null,8,["model-value"])]),ne(e("div",Iu,[e("label",Ru,se(L.value)+":",1),e("div",Pu,[ne(e("input",{type:a.value?"text":"password",id:"settingsApiKey","onUpdate:modelValue":l[1]||(l[1]=p=>r.value.apiKey=p),class:"secure-input",placeholder:v.value,autocomplete:"off"},null,8,Du),[[Tt,r.value.apiKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:l[2]||(l[2]=p=>a.value=!a.value)},[a.value?(A(),U("span",Bu,"ğŸ‘â€ğŸ—¨")):(A(),U("span",Mu,"ğŸ‘"))])])],512),[[Oe,!k.value]])]),ne(e("div",Eu,[l[15]||(l[15]=e("label",{for:"settingsCustomBaseUrl"},"Base URL:",-1)),ne(e("input",{type:"text",id:"settingsCustomBaseUrl","onUpdate:modelValue":l[3]||(l[3]=p=>r.value.customBaseUrl=p),placeholder:"ä¾‹å¦‚: https://api.example.com/v1"},null,512),[[ke,r.value.customBaseUrl]])],512),[[Oe,r.value.modelProvider==="custom_openai"]]),ne(e("div",Au,[e("label",Lu,se(d.value)+":",1),e("div",Fu,[ne(e("input",{type:"text",id:"settingsModelName","onUpdate:modelValue":l[4]||(l[4]=p=>r.value.modelName=p),placeholder:h.value},null,8,Uu),[[ke,r.value.modelName]]),ne(e("button",{type:"button",class:"fetch-models-btn",title:"è·å–å¯ç”¨æ¨¡å‹åˆ—è¡¨",onClick:F,disabled:g.value},[l[16]||(l[16]=e("span",{class:"fetch-icon"},"ğŸ”",-1)),e("span",Ou,se(g.value?"è·å–ä¸­...":"è·å–æ¨¡å‹"),1)],8,zu),[[Oe,V.value]])]),S.value.length>0?(A(),U("div",Vu,[xe(Ne,{"model-value":r.value.modelName,options:D.value,onChange:l[5]||(l[5]=p=>{r.value.modelName=p})},null,8,["model-value","options"]),e("span",Nu,"å…± "+se(S.value.length)+" ä¸ªæ¨¡å‹",1)])):fe("",!0)],512),[[Oe,!k.value]]),ne(e("div",Wu,[l[17]||(l[17]=e("label",null,"æœ¬åœ°æ¨¡å‹:",-1)),e("div",qu,[r.value.modelProvider==="ollama"?(A(),U("div",Ku,[e("button",{class:"settings-test-btn",onClick:J,disabled:g.value},se(g.value?"è·å–ä¸­...":"ğŸ”„ åˆ·æ–°æ¨¡å‹åˆ—è¡¨"),9,Hu),x.value.length>0?(A(),ut(Ne,{key:0,"model-value":r.value.modelName,options:R.value,onChange:l[6]||(l[6]=p=>r.value.modelName=p)},null,8,["model-value","options"])):(A(),U("p",ju,"ç‚¹å‡»åˆ·æ–°è·å–å¯ç”¨æ¨¡å‹"))])):r.value.modelProvider==="sakura"?(A(),U("div",Yu,[e("button",{class:"settings-test-btn",onClick:K,disabled:g.value},se(g.value?"è·å–ä¸­...":"ğŸ”„ åˆ·æ–°æ¨¡å‹åˆ—è¡¨"),9,Ju),_.value.length>0?(A(),ut(Ne,{key:0,"model-value":r.value.modelName,options:M.value,onChange:l[7]||(l[7]=p=>r.value.modelName=p)},null,8,["model-value","options"])):(A(),U("p",Xu,"ç‚¹å‡»åˆ·æ–°è·å–å¯ç”¨æ¨¡å‹"))])):fe("",!0)])],512),[[Oe,k.value]]),ne(e("div",Gu,[e("div",Zu,[l[18]||(l[18]=e("label",{for:"settingsRpmTranslation"},"RPMé™åˆ¶:",-1)),ne(e("input",{type:"number",id:"settingsRpmTranslation","onUpdate:modelValue":l[8]||(l[8]=p=>r.value.rpmTranslation=p),min:"0",step:"1"},null,512),[[ke,r.value.rpmTranslation,void 0,{number:!0}]]),l[19]||(l[19]=e("div",{class:"input-hint"},"æ¯åˆ†é’Ÿè¯·æ±‚æ•°ï¼Œ0è¡¨ç¤ºæ— é™åˆ¶",-1))]),e("div",Qu,[l[20]||(l[20]=e("label",{for:"settingsTranslationMaxRetries"},"é‡è¯•æ¬¡æ•°:",-1)),ne(e("input",{type:"number",id:"settingsTranslationMaxRetries","onUpdate:modelValue":l[9]||(l[9]=p=>r.value.translationMaxRetries=p),min:"0",max:"10",step:"1"},null,512),[[ke,r.value.translationMaxRetries,void 0,{number:!0}]])])],512),[[Oe,Y.value]]),ne(e("div",ec,[e("button",{class:"settings-test-btn",onClick:Z,disabled:u.value},se(u.value?"æµ‹è¯•ä¸­...":"ğŸ”— æµ‹è¯•è¿æ¥"),9,tc)],512),[[Oe,k.value]]),ne(e("div",oc,[e("button",{class:"settings-test-btn",onClick:W,disabled:u.value},se(u.value?"æµ‹è¯•ä¸­...":"ğŸ”— æµ‹è¯•è¿æ¥"),9,nc)],512),[[Oe,!k.value]])]),e("div",sc,[l[26]||(l[26]=e("div",{class:"settings-group-title"},"æç¤ºè¯è®¾ç½®",-1)),e("div",ac,[l[23]||(l[23]=e("label",{for:"settingsPromptContent"},"ç¿»è¯‘æç¤ºè¯:",-1)),ne(e("textarea",{id:"settingsPromptContent","onUpdate:modelValue":l[10]||(l[10]=p=>r.value.promptContent=p),rows:"4",placeholder:"ç¿»è¯‘æç¤ºè¯"},null,512),[[ke,r.value.promptContent]]),e("div",lc,[xe(Ne,{"model-value":r.value.translatePromptMode,options:n,onChange:l[11]||(l[11]=p=>{r.value.translatePromptMode=p,z()})},null,8,["model-value"]),l[22]||(l[22]=e("span",{class:"input-hint"},"JSONæ ¼å¼è¾“å‡ºæ›´ç»“æ„åŒ–",-1))]),xe(Ft,{"prompt-type":"translate",onSelect:oe}),e("button",{type:"button",class:"reset-btn",onClick:c}," é‡ç½®ä¸ºé»˜è®¤ ")]),e("div",ic,[e("label",rc,[ne(e("input",{type:"checkbox","onUpdate:modelValue":l[12]||(l[12]=p=>r.value.enableTextboxPrompt=p)},null,512),[[nt,r.value.enableTextboxPrompt]]),l[24]||(l[24]=Ue(" å¯ç”¨æ–‡æœ¬æ¡†æç¤ºè¯ ",-1))])]),ne(e("div",uc,[l[25]||(l[25]=e("label",{for:"settingsTextboxPromptContent"},"æ–‡æœ¬æ¡†æç¤ºè¯:",-1)),ne(e("textarea",{id:"settingsTextboxPromptContent","onUpdate:modelValue":l[13]||(l[13]=p=>r.value.textboxPromptContent=p),rows:"3",placeholder:"æ–‡æœ¬æ¡†æç¤ºè¯"},null,512),[[ke,r.value.textboxPromptContent]]),xe(Ft,{"prompt-type":"textbox",onSelect:b})],512),[[Oe,r.value.enableTextboxPrompt]])])]))}}),dc=je(cc,[["__scopeId","data-v-1eaa2d97"]]),gc={class:"detection-settings"},pc={class:"settings-group"},mc={class:"settings-item"},vc={class:"settings-group"},fc={class:"settings-item"},bc={class:"settings-row"},hc={class:"settings-item"},yc={class:"settings-item"},xc={class:"settings-row"},Sc={class:"settings-item"},_c={class:"settings-item"},Cc={class:"settings-group"},kc={class:"settings-item"},wc={class:"checkbox-label"},Tc={class:"settings-row"},$c={class:"settings-item"},Ic={class:"settings-item"},Rc={class:"settings-group"},Pc={class:"settings-item"},Dc={class:"checkbox-label"},Mc=Ye({__name:"DetectionSettings",setup(s){const t=[{label:"CTD (Comic Text Detector)",value:"ctd"},{label:"YOLO",value:"yolo"},{label:"YOLOv5",value:"yolov5"},{label:"Default (DBNet)",value:"default"}],n=Fe(),o=vo({textDetector:n.settings.textDetector,boxExpandRatio:n.settings.boxExpand.ratio,boxExpandTop:n.settings.boxExpand.top,boxExpandBottom:n.settings.boxExpand.bottom,boxExpandLeft:n.settings.boxExpand.left,boxExpandRight:n.settings.boxExpand.right,usePreciseMask:n.settings.preciseMask.enabled,maskDilateSize:n.settings.preciseMask.dilateSize,maskBoxExpandRatio:n.settings.preciseMask.boxExpandRatio,showDetectionDebug:n.settings.showDetectionDebug}),i=Q(()=>["ctd","default"].includes(o.textDetector));_e(()=>o.textDetector,a=>{n.setTextDetector(a)}),_e(()=>o.boxExpandRatio,a=>{n.updateBoxExpand({ratio:a})}),_e(()=>o.boxExpandTop,a=>{n.updateBoxExpand({top:a})}),_e(()=>o.boxExpandBottom,a=>{n.updateBoxExpand({bottom:a})}),_e(()=>o.boxExpandLeft,a=>{n.updateBoxExpand({left:a})}),_e(()=>o.boxExpandRight,a=>{n.updateBoxExpand({right:a})}),_e(()=>o.usePreciseMask,a=>{n.updatePreciseMask({enabled:a})}),_e(()=>o.maskDilateSize,a=>{n.updatePreciseMask({dilateSize:a})}),_e(()=>o.maskBoxExpandRatio,a=>{n.updatePreciseMask({boxExpandRatio:a})}),_e(()=>o.showDetectionDebug,a=>{n.setShowDetectionDebug(a)});function r(){i.value||(o.usePreciseMask=!1)}return(a,u)=>(A(),U("div",gc,[e("div",pc,[u[11]||(u[11]=e("div",{class:"settings-group-title"},"æ–‡å­—æ£€æµ‹å™¨",-1)),e("div",mc,[u[10]||(u[10]=e("label",{for:"settingsTextDetector"},"æ£€æµ‹å™¨ç±»å‹:",-1)),xe(Ne,{modelValue:o.textDetector,"onUpdate:modelValue":u[0]||(u[0]=g=>o.textDetector=g),options:t,onChange:r},null,8,["modelValue"])])]),e("div",vc,[u[18]||(u[18]=e("div",{class:"settings-group-title"},"æ–‡æœ¬æ¡†æ‰©å±•å‚æ•°",-1)),e("div",fc,[u[12]||(u[12]=e("label",{for:"settingsBoxExpandRatio"},"æ•´ä½“æ‰©å±• (%):",-1)),ne(e("input",{type:"number",id:"settingsBoxExpandRatio","onUpdate:modelValue":u[1]||(u[1]=g=>o.boxExpandRatio=g),min:"0",max:"50",step:"1"},null,512),[[ke,o.boxExpandRatio,void 0,{number:!0}]]),u[13]||(u[13]=e("div",{class:"input-hint"},"å‘å››å‘¨å‡åŒ€æ‰©å±•çš„ç™¾åˆ†æ¯” (0-50%)",-1))]),e("div",bc,[e("div",hc,[u[14]||(u[14]=e("label",{for:"settingsBoxExpandTop"},"ä¸Šæ–¹æ‰©å±• (%):",-1)),ne(e("input",{type:"number",id:"settingsBoxExpandTop","onUpdate:modelValue":u[2]||(u[2]=g=>o.boxExpandTop=g),min:"0",max:"50",step:"1"},null,512),[[ke,o.boxExpandTop,void 0,{number:!0}]])]),e("div",yc,[u[15]||(u[15]=e("label",{for:"settingsBoxExpandBottom"},"ä¸‹æ–¹æ‰©å±• (%):",-1)),ne(e("input",{type:"number",id:"settingsBoxExpandBottom","onUpdate:modelValue":u[3]||(u[3]=g=>o.boxExpandBottom=g),min:"0",max:"50",step:"1"},null,512),[[ke,o.boxExpandBottom,void 0,{number:!0}]])])]),e("div",xc,[e("div",Sc,[u[16]||(u[16]=e("label",{for:"settingsBoxExpandLeft"},"å·¦ä¾§æ‰©å±• (%):",-1)),ne(e("input",{type:"number",id:"settingsBoxExpandLeft","onUpdate:modelValue":u[4]||(u[4]=g=>o.boxExpandLeft=g),min:"0",max:"50",step:"1"},null,512),[[ke,o.boxExpandLeft,void 0,{number:!0}]])]),e("div",_c,[u[17]||(u[17]=e("label",{for:"settingsBoxExpandRight"},"å³ä¾§æ‰©å±• (%):",-1)),ne(e("input",{type:"number",id:"settingsBoxExpandRight","onUpdate:modelValue":u[5]||(u[5]=g=>o.boxExpandRight=g),min:"0",max:"50",step:"1"},null,512),[[ke,o.boxExpandRight,void 0,{number:!0}]])])])]),ne(e("div",Cc,[u[25]||(u[25]=e("div",{class:"settings-group-title"},"ç²¾ç¡®æ–‡å­—æ©è†œ",-1)),e("div",kc,[e("label",wc,[ne(e("input",{type:"checkbox","onUpdate:modelValue":u[6]||(u[6]=g=>o.usePreciseMask=g)},null,512),[[nt,o.usePreciseMask]]),u[19]||(u[19]=Ue(" å¯ç”¨ç²¾ç¡®æ–‡å­—æ©è†œ ",-1))]),u[20]||(u[20]=e("div",{class:"input-hint"},"ä½¿ç”¨æ›´ç²¾ç¡®çš„æ–‡å­—åŒºåŸŸæ©è†œè¿›è¡Œä¿®å¤",-1))]),ne(e("div",Tc,[e("div",$c,[u[21]||(u[21]=e("label",{for:"settingsMaskDilateSize"},"è†¨èƒ€å¤§å°:",-1)),ne(e("input",{type:"number",id:"settingsMaskDilateSize","onUpdate:modelValue":u[7]||(u[7]=g=>o.maskDilateSize=g),min:"0",step:"1"},null,512),[[ke,o.maskDilateSize,void 0,{number:!0}]]),u[22]||(u[22]=e("div",{class:"input-hint"},"æ©è†œè†¨èƒ€åƒç´ æ•°",-1))]),e("div",Ic,[u[23]||(u[23]=e("label",{for:"settingsMaskBoxExpandRatio"},"æ ‡æ³¨æ¡†æ‰©å¤§æ¯”ä¾‹ (%):",-1)),ne(e("input",{type:"number",id:"settingsMaskBoxExpandRatio","onUpdate:modelValue":u[8]||(u[8]=g=>o.maskBoxExpandRatio=g),min:"0",max:"100",step:"1"},null,512),[[ke,o.maskBoxExpandRatio,void 0,{number:!0}]]),u[24]||(u[24]=e("div",{class:"input-hint"},"æ ‡æ³¨æ¡†åŒºåŸŸæ‰©å¤§ç™¾åˆ†æ¯”",-1))])],512),[[Oe,o.usePreciseMask]])],512),[[Oe,i.value]]),e("div",Rc,[u[28]||(u[28]=e("div",{class:"settings-group-title"},"è°ƒè¯•é€‰é¡¹",-1)),e("div",Pc,[e("label",Dc,[ne(e("input",{type:"checkbox","onUpdate:modelValue":u[9]||(u[9]=g=>o.showDetectionDebug=g)},null,512),[[nt,o.showDetectionDebug]]),u[26]||(u[26]=Ue(" æ˜¾ç¤ºæ£€æµ‹æ¡†è°ƒè¯•ä¿¡æ¯ ",-1))]),u[27]||(u[27]=e("div",{class:"input-hint"},"åœ¨ç¿»è¯‘ç»“æœä¸­æ˜¾ç¤ºæ°”æ³¡æ£€æµ‹æ¡†ï¼Œç”¨äºè°ƒè¯•",-1))])])]))}}),Bc=je(Mc,[["__scopeId","data-v-c12c43ee"]]),Ec={class:"hq-translation-settings"},Ac={class:"settings-group"},Lc={class:"settings-row"},Fc={class:"settings-item"},Uc={class:"settings-item"},zc={class:"password-input-wrapper"},Oc=["type"],Vc={key:0,class:"eye-icon"},Nc={key:1,class:"eye-off-icon"},Wc={class:"settings-item"},qc={class:"settings-item"},Kc={class:"model-input-with-fetch"},Hc=["disabled"],jc={class:"fetch-text"},Yc={key:0,class:"model-select-container"},Jc={class:"model-count"},Xc={class:"settings-item"},Gc=["disabled"],Zc={class:"settings-group"},Qc={class:"settings-row"},ed={class:"settings-item"},td={class:"settings-item"},od={class:"settings-row"},nd={class:"settings-item"},sd={class:"settings-item"},ad={class:"settings-group"},ld={class:"settings-row"},id={class:"settings-item"},rd={class:"checkbox-label"},ud={class:"settings-item"},cd={class:"settings-row"},dd={class:"settings-item"},gd={class:"checkbox-label"},pd={class:"settings-item"},md={class:"checkbox-label"},vd={class:"settings-group"},fd={class:"settings-item"},bd=Ye({__name:"HqTranslationSettings",setup(s){const t=[{label:"SiliconFlow",value:"siliconflow"},{label:"DeepSeek",value:"deepseek"},{label:"ç«å±±å¼•æ“",value:"volcano"},{label:"Google Gemini",value:"gemini"},{label:"è‡ªå®šä¹‰ OpenAI å…¼å®¹æœåŠ¡",value:"custom_openai"}],n=[{label:"Geminié£æ ¼ (reasoning_effort=low)",value:"gemini"},{label:"ç«å±±å¼•æ“é£æ ¼ (thinking=null)",value:"volcano"}],o=Fe(),i=ct(),r=Q(()=>o.settings.hqTranslation),a=C({apiKey:o.settings.hqTranslation.apiKey,modelName:o.settings.hqTranslation.modelName,customBaseUrl:o.settings.hqTranslation.customBaseUrl,batchSize:o.settings.hqTranslation.batchSize,sessionReset:o.settings.hqTranslation.sessionReset,rpmLimit:o.settings.hqTranslation.rpmLimit,maxRetries:o.settings.hqTranslation.maxRetries,lowReasoning:o.settings.hqTranslation.lowReasoning,noThinkingMethod:o.settings.hqTranslation.noThinkingMethod,forceJsonOutput:o.settings.hqTranslation.forceJsonOutput,useStream:o.settings.hqTranslation.useStream,prompt:o.settings.hqTranslation.prompt});_e(()=>a.value.apiKey,v=>{o.updateHqTranslation({apiKey:v})}),_e(()=>a.value.modelName,v=>{o.updateHqTranslation({modelName:v})}),_e(()=>a.value.customBaseUrl,v=>{o.updateHqTranslation({customBaseUrl:v})}),_e(()=>a.value.batchSize,v=>{o.updateHqTranslation({batchSize:v})}),_e(()=>a.value.sessionReset,v=>{o.updateHqTranslation({sessionReset:v})}),_e(()=>a.value.rpmLimit,v=>{o.updateHqTranslation({rpmLimit:v})}),_e(()=>a.value.maxRetries,v=>{o.updateHqTranslation({maxRetries:v})}),_e(()=>a.value.lowReasoning,v=>{o.updateHqTranslation({lowReasoning:v})}),_e(()=>a.value.noThinkingMethod,v=>{o.updateHqTranslation({noThinkingMethod:v})}),_e(()=>a.value.forceJsonOutput,v=>{o.updateHqTranslation({forceJsonOutput:v})}),_e(()=>a.value.useStream,v=>{o.updateHqTranslation({useStream:v})}),_e(()=>a.value.prompt,v=>{o.updateHqTranslation({prompt:v})});const u=C(!1),g=C(!1),S=C([]),x=C(!1),_=Q(()=>{const v=[{label:"-- é€‰æ‹©æ¨¡å‹ --",value:""}];return S.value.forEach(d=>v.push({label:d,value:d})),v});function D(v){o.setHqProvider(v),S.value=[],R()}function R(){const v=o.settings.hqTranslation;a.value.apiKey=v.apiKey,a.value.modelName=v.modelName,a.value.customBaseUrl=v.customBaseUrl,a.value.batchSize=v.batchSize,a.value.sessionReset=v.sessionReset,a.value.rpmLimit=v.rpmLimit,a.value.maxRetries=v.maxRetries,a.value.lowReasoning=v.lowReasoning,a.value.noThinkingMethod=v.noThinkingMethod,a.value.forceJsonOutput=v.forceJsonOutput,a.value.useStream=v.useStream,a.value.prompt=v.prompt}function M(v){return{siliconflow:"SiliconFlow",deepseek:"DeepSeek",volcano:"ç«å±±å¼•æ“",gemini:"Google Gemini",custom_openai:"è‡ªå®šä¹‰OpenAI"}[v]||v}async function k(){const v=r.value.provider,d=a.value.apiKey?.trim(),h=a.value.customBaseUrl?.trim();if(!d){i.warning("è¯·å…ˆå¡«å†™ API Key");return}if(!["siliconflow","deepseek","volcano","gemini","custom_openai"].includes(v)){i.warning(`${M(v)} ä¸æ”¯æŒè‡ªåŠ¨è·å–æ¨¡å‹åˆ—è¡¨`);return}if(v==="custom_openai"&&!h){i.warning("è‡ªå®šä¹‰æœåŠ¡éœ€è¦å…ˆå¡«å†™ Base URL");return}g.value=!0;try{const z=await qe.fetchModels(v,d,h);z.success&&z.models&&z.models.length>0?(S.value=z.models.map(F=>F.id),i.success(`è·å–åˆ° ${z.models.length} ä¸ªæ¨¡å‹`)):i.warning(z.message||"æœªè·å–åˆ°å¯ç”¨æ¨¡å‹")}catch(z){const F=z instanceof Error?z.message:"è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥";i.error(F)}finally{g.value=!1}}async function Y(){const v=r.value.provider,d=a.value.apiKey?.trim(),h=a.value.modelName?.trim(),y=a.value.customBaseUrl?.trim();if(!d){i.warning("è¯·å…ˆå¡«å†™ API Key");return}if(!h){i.warning("è¯·å¡«å†™æ¨¡å‹åç§°");return}if(v==="custom_openai"&&!y){i.warning("è‡ªå®šä¹‰æœåŠ¡éœ€è¦å¡«å†™ Base URL");return}x.value=!0,i.info("æ­£åœ¨æµ‹è¯•è¿æ¥...");try{const z=await qe.testAiTranslateConnection({provider:v,apiKey:d,modelName:h,baseUrl:y});z.success?i.success(z.message||`${M(v)} è¿æ¥æˆåŠŸ!`):i.error(z.message||z.error||"è¿æ¥å¤±è´¥")}catch(z){const F=z instanceof Error?z.message:"è¿æ¥æµ‹è¯•å¤±è´¥";i.error(F)}finally{x.value=!1}}function V(){o.updateHqTranslation({prompt:Jo}),a.value.prompt=Jo,i.success("å·²é‡ç½®ä¸ºé»˜è®¤æç¤ºè¯")}function L(v,d){o.updateHqTranslation({prompt:v}),a.value.prompt=v,i.success(`å·²åº”ç”¨æç¤ºè¯: ${d}`)}return(v,d)=>(A(),U("div",Ec,[e("div",Ac,[d[20]||(d[20]=e("div",{class:"settings-group-title"},"é«˜è´¨é‡ç¿»è¯‘æœåŠ¡é…ç½®",-1)),e("div",Lc,[e("div",Fc,[d[15]||(d[15]=e("label",{for:"settingsHqTranslateProvider"},"æœåŠ¡å•†:",-1)),xe(Ne,{"model-value":r.value.provider,options:t,onChange:d[0]||(d[0]=h=>D(h))},null,8,["model-value"])]),e("div",Uc,[d[16]||(d[16]=e("label",{for:"settingsHqApiKey"},"API Key:",-1)),e("div",zc,[ne(e("input",{type:u.value?"text":"password",id:"settingsHqApiKey","onUpdate:modelValue":d[1]||(d[1]=h=>a.value.apiKey=h),class:"secure-input",placeholder:"è¯·è¾“å…¥API Key",autocomplete:"off"},null,8,Oc),[[Tt,a.value.apiKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:d[2]||(d[2]=h=>u.value=!u.value)},[u.value?(A(),U("span",Nc,"ğŸ‘â€ğŸ—¨")):(A(),U("span",Vc,"ğŸ‘"))])])])]),ne(e("div",Wc,[d[17]||(d[17]=e("label",{for:"settingsHqCustomBaseUrl"},"Base URL:",-1)),ne(e("input",{type:"text",id:"settingsHqCustomBaseUrl","onUpdate:modelValue":d[3]||(d[3]=h=>a.value.customBaseUrl=h),placeholder:"ä¾‹å¦‚: https://api.example.com/v1"},null,512),[[ke,a.value.customBaseUrl]])],512),[[Oe,r.value.provider==="custom_openai"]]),e("div",qc,[d[19]||(d[19]=e("label",{for:"settingsHqModelName"},"æ¨¡å‹åç§°:",-1)),e("div",Kc,[ne(e("input",{type:"text",id:"settingsHqModelName","onUpdate:modelValue":d[4]||(d[4]=h=>a.value.modelName=h),placeholder:"è¯·è¾“å…¥æ¨¡å‹åç§°"},null,512),[[ke,a.value.modelName]]),e("button",{type:"button",class:"fetch-models-btn",title:"è·å–å¯ç”¨æ¨¡å‹åˆ—è¡¨",onClick:k,disabled:g.value},[d[18]||(d[18]=e("span",{class:"fetch-icon"},"ğŸ”",-1)),e("span",jc,se(g.value?"è·å–ä¸­...":"è·å–æ¨¡å‹"),1)],8,Hc)]),S.value.length>0?(A(),U("div",Yc,[xe(Ne,{modelValue:a.value.modelName,"onUpdate:modelValue":d[5]||(d[5]=h=>a.value.modelName=h),options:_.value},null,8,["modelValue","options"]),e("span",Jc,"å…± "+se(S.value.length)+" ä¸ªæ¨¡å‹",1)])):fe("",!0)]),e("div",Xc,[e("button",{class:"settings-test-btn",onClick:Y,disabled:x.value},se(x.value?"æµ‹è¯•ä¸­...":"ğŸ”— æµ‹è¯•è¿æ¥"),9,Gc)])]),e("div",Zc,[d[28]||(d[28]=e("div",{class:"settings-group-title"},"æ‰¹å¤„ç†è®¾ç½®",-1)),e("div",Qc,[e("div",ed,[d[21]||(d[21]=e("label",{for:"settingsHqBatchSize"},"æ‰¹æ¬¡å¤§å°:",-1)),ne(e("input",{type:"number",id:"settingsHqBatchSize","onUpdate:modelValue":d[6]||(d[6]=h=>a.value.batchSize=h),min:"1",max:"10",step:"1"},null,512),[[ke,a.value.batchSize,void 0,{number:!0}]]),d[22]||(d[22]=e("div",{class:"input-hint"},"æ¯æ‰¹å¤„ç†çš„å›¾ç‰‡æ•°é‡ (æ¨è3-5å¼ )",-1))]),e("div",td,[d[23]||(d[23]=e("label",{for:"settingsHqSessionReset"},"ä¼šè¯é‡ç½®é¢‘ç‡:",-1)),ne(e("input",{type:"number",id:"settingsHqSessionReset","onUpdate:modelValue":d[7]||(d[7]=h=>a.value.sessionReset=h),min:"1",step:"1"},null,512),[[ke,a.value.sessionReset,void 0,{number:!0}]]),d[24]||(d[24]=e("div",{class:"input-hint"},"å¤šå°‘æ‰¹æ¬¡åé‡ç½®ä¸Šä¸‹æ–‡",-1))])]),e("div",od,[e("div",nd,[d[25]||(d[25]=e("label",{for:"settingsHqRpmLimit"},"RPMé™åˆ¶:",-1)),ne(e("input",{type:"number",id:"settingsHqRpmLimit","onUpdate:modelValue":d[8]||(d[8]=h=>a.value.rpmLimit=h),min:"0",step:"1"},null,512),[[ke,a.value.rpmLimit,void 0,{number:!0}]]),d[26]||(d[26]=e("div",{class:"input-hint"},"æ¯åˆ†é’Ÿè¯·æ±‚æ•°ï¼Œ0è¡¨ç¤ºæ— é™åˆ¶",-1))]),e("div",sd,[d[27]||(d[27]=e("label",{for:"settingsHqMaxRetries"},"é‡è¯•æ¬¡æ•°:",-1)),ne(e("input",{type:"number",id:"settingsHqMaxRetries","onUpdate:modelValue":d[9]||(d[9]=h=>a.value.maxRetries=h),min:"0",max:"10",step:"1"},null,512),[[ke,a.value.maxRetries,void 0,{number:!0}]])])])]),e("div",ad,[d[36]||(d[36]=e("div",{class:"settings-group-title"},"é«˜çº§é€‰é¡¹",-1)),e("div",ld,[e("div",id,[e("label",rd,[ne(e("input",{type:"checkbox","onUpdate:modelValue":d[10]||(d[10]=h=>a.value.lowReasoning=h)},null,512),[[nt,a.value.lowReasoning]]),d[29]||(d[29]=Ue(" ä½æ¨ç†æ¨¡å¼ ",-1))]),d[30]||(d[30]=e("div",{class:"input-hint"},"å‡å°‘æ¨¡å‹æ¨ç†æ·±åº¦ï¼Œæé«˜é€Ÿåº¦",-1))]),e("div",ud,[d[31]||(d[31]=e("label",{for:"settingsHqNoThinkingMethod"},"å–æ¶ˆæ€è€ƒæ–¹æ³•:",-1)),xe(Ne,{modelValue:a.value.noThinkingMethod,"onUpdate:modelValue":d[11]||(d[11]=h=>a.value.noThinkingMethod=h),options:n},null,8,["modelValue"])])]),e("div",cd,[e("div",dd,[e("label",gd,[ne(e("input",{type:"checkbox","onUpdate:modelValue":d[12]||(d[12]=h=>a.value.forceJsonOutput=h)},null,512),[[nt,a.value.forceJsonOutput]]),d[32]||(d[32]=Ue(" å¼ºåˆ¶JSONè¾“å‡º ",-1))]),d[33]||(d[33]=e("div",{class:"input-hint"},"ä½¿ç”¨ response_format: json_object",-1))]),e("div",pd,[e("label",md,[ne(e("input",{type:"checkbox","onUpdate:modelValue":d[13]||(d[13]=h=>a.value.useStream=h)},null,512),[[nt,a.value.useStream]]),d[34]||(d[34]=Ue(" æµå¼è°ƒç”¨ ",-1))]),d[35]||(d[35]=e("div",{class:"input-hint"},"ä½¿ç”¨æµå¼APIè°ƒç”¨",-1))])])]),e("div",vd,[d[37]||(d[37]=e("div",{class:"settings-group-title"},"é«˜è´¨é‡ç¿»è¯‘æç¤ºè¯",-1)),e("div",fd,[ne(e("textarea",{id:"settingsHqPrompt","onUpdate:modelValue":d[14]||(d[14]=h=>a.value.prompt=h),rows:"6",placeholder:"é«˜è´¨é‡ç¿»è¯‘æç¤ºè¯"},null,512),[[ke,a.value.prompt]]),xe(Ft,{"prompt-type":"hq_translate",onSelect:L}),e("button",{class:"btn btn-secondary btn-sm",onClick:V},"é‡ç½®ä¸ºé»˜è®¤")])])]))}}),hd=je(bd,[["__scopeId","data-v-23f4a3f7"]]),yd={class:"proofreading-settings"},xd={class:"settings-group"},Sd={class:"settings-item"},_d={class:"checkbox-label"},Cd={class:"settings-item"},kd={class:"settings-group"},wd={class:"round-header"},Td={class:"round-title"},$d=["onClick","disabled"],Id={class:"round-content"},Rd={class:"settings-item"},Pd=["onUpdate:modelValue"],Dd={class:"settings-row"},Md={class:"settings-item"},Bd={class:"settings-item"},Ed={class:"password-input-wrapper"},Ad=["type","onUpdate:modelValue"],Ld=["onClick"],Fd={key:0,class:"eye-icon"},Ud={key:1,class:"eye-off-icon"},zd={class:"settings-item"},Od=["onUpdate:modelValue"],Vd={class:"settings-item"},Nd={class:"model-input-with-fetch"},Wd=["onUpdate:modelValue"],qd=["onClick","disabled"],Kd={class:"fetch-text"},Hd={key:0,class:"model-select-container"},jd={class:"model-count"},Yd={class:"settings-item"},Jd=["onClick","disabled"],Xd={class:"settings-row"},Gd={class:"settings-item"},Zd=["onUpdate:modelValue"],Qd={class:"settings-item"},eg=["onUpdate:modelValue"],tg={class:"settings-item"},og=["onUpdate:modelValue"],ng={class:"settings-row"},sg={class:"settings-item"},ag={class:"checkbox-label"},lg=["onUpdate:modelValue"],ig={class:"settings-item"},rg={class:"settings-item"},ug={class:"checkbox-label"},cg=["onUpdate:modelValue"],dg={class:"settings-item"},gg=["onUpdate:modelValue"],pg=["onClick"],mg=Ye({__name:"ProofreadingSettings",setup(s){const t=[{label:"SiliconFlow",value:"siliconflow"},{label:"DeepSeek",value:"deepseek"},{label:"ç«å±±å¼•æ“",value:"volcano"},{label:"Google Gemini",value:"gemini"},{label:"è‡ªå®šä¹‰ OpenAI å…¼å®¹æœåŠ¡",value:"custom_openai"}],n=[{label:"Geminié£æ ¼",value:"gemini"},{label:"ç«å±±å¼•æ“é£æ ¼",value:"volcano"}],o=Fe(),i=ct(),r=C({}),a=C({}),u=C({}),g=Q(()=>o.settings.proofreading.rounds),S=Q({get:()=>o.settings.proofreading.maxRetries,set:L=>o.setProofreadingMaxRetries(L)}),x=Q({get:()=>o.settings.proofreading.enabled,set:L=>o.setProofreadingEnabled(L)});_e(()=>o.settings.proofreading.rounds,()=>{o.saveToStorage()},{deep:!0});function _(L){const v=u.value[L]||[],d=[{label:"-- é€‰æ‹©æ¨¡å‹ --",value:""}];return v.forEach(h=>d.push({label:h,value:h})),d}async function D(L){const v=g.value[L];if(!v)return;const d=v.provider,h=v.apiKey?.trim(),y=v.customBaseUrl?.trim();if(!h){i.warning("è¯·å…ˆå¡«å†™ API Key");return}if(!["siliconflow","deepseek","volcano","gemini","custom_openai"].includes(d)){i.warning("å½“å‰æœåŠ¡å•†ä¸æ”¯æŒè·å–æ¨¡å‹åˆ—è¡¨");return}r.value[L]=!0;try{const F=await qe.fetchModels(d,h,y);F.success&&F.models&&F.models.length>0?(u.value[L]=F.models.map(te=>te.id),i.success(`è½®æ¬¡ ${L+1}: è·å–åˆ° ${F.models.length} ä¸ªæ¨¡å‹`)):i.warning(F.message||"æœªè·å–åˆ°å¯ç”¨æ¨¡å‹")}catch(F){const te=F instanceof Error?F.message:"è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥";i.error(te)}finally{r.value[L]=!1}}async function R(L){const v=g.value[L];if(!v)return;const d=v.provider,h=v.apiKey?.trim(),y=v.modelName?.trim(),z=v.customBaseUrl?.trim();if(!h){i.warning("è¯·å…ˆå¡«å†™ API Key");return}if(!y){i.warning("è¯·å¡«å†™æ¨¡å‹åç§°");return}a.value[L]=!0,i.info(`æ­£åœ¨æµ‹è¯•è½®æ¬¡ ${L+1} çš„è¿æ¥...`);try{const F=await qe.testAiTranslateConnection({provider:d,apiKey:h,modelName:y,baseUrl:z});F.success?i.success(F.message||"è¿æ¥æˆåŠŸ!"):i.error(F.message||F.error||"è¿æ¥å¤±è´¥")}catch(F){const te=F instanceof Error?F.message:"è¿æ¥æµ‹è¯•å¤±è´¥";i.error(te)}finally{a.value[L]=!1}}function M(){const L={name:`ç¬¬${g.value.length+1}è½®æ ¡å¯¹`,provider:"siliconflow",apiKey:"",modelName:"",customBaseUrl:"",batchSize:3,sessionReset:20,rpmLimit:7,lowReasoning:!1,noThinkingMethod:"gemini",forceJsonOutput:!0,prompt:Xo,showApiKey:!1};o.addProofreadingRound(L),i.success("å·²æ·»åŠ æ–°çš„æ ¡å¯¹è½®æ¬¡")}function k(L){if(g.value.length<=1){i.warning("è‡³å°‘éœ€è¦ä¿ç•™ä¸€ä¸ªæ ¡å¯¹è½®æ¬¡");return}o.removeProofreadingRound(L),i.success("å·²åˆ é™¤æ ¡å¯¹è½®æ¬¡")}function Y(L){o.updateProofreadingRound(L,{prompt:Xo}),i.success("å·²é‡ç½®ä¸ºé»˜è®¤æç¤ºè¯")}function V(L,v,d){o.updateProofreadingRound(L,{prompt:v}),i.success(`å·²åº”ç”¨æç¤ºè¯: ${d}`)}return(L,v)=>(A(),U("div",yd,[e("div",xd,[v[5]||(v[5]=e("div",{class:"settings-group-title"},"AIæ ¡å¯¹è®¾ç½®",-1)),e("div",Sd,[e("label",_d,[ne(e("input",{type:"checkbox","onUpdate:modelValue":v[0]||(v[0]=d=>x.value=d)},null,512),[[nt,x.value]]),v[2]||(v[2]=Ue(" å¯ç”¨AIæ ¡å¯¹ ",-1))]),v[3]||(v[3]=e("div",{class:"input-hint"},"ç¿»è¯‘å®Œæˆåè‡ªåŠ¨è¿›è¡ŒAIæ ¡å¯¹",-1))]),e("div",Cd,[v[4]||(v[4]=e("label",{for:"settingsProofreadingMaxRetries"},"å…¨å±€é‡è¯•æ¬¡æ•°:",-1)),ne(e("input",{type:"number",id:"settingsProofreadingMaxRetries","onUpdate:modelValue":v[1]||(v[1]=d=>S.value=d),min:"0",max:"10",step:"1"},null,512),[[ke,S.value,void 0,{number:!0}]])])]),ne(e("div",kd,[e("div",{class:"settings-group-title"},[v[6]||(v[6]=Ue(" æ ¡å¯¹è½®æ¬¡é…ç½® ",-1)),e("button",{class:"btn btn-secondary btn-sm",onClick:M},"+ æ·»åŠ è½®æ¬¡")]),(A(!0),U(We,null,Qe(g.value,(d,h)=>(A(),U("div",{key:h,class:"proofreading-round"},[e("div",wd,[e("span",Td,"è½®æ¬¡ "+se(h+1)+": "+se(d.name||"æœªå‘½å"),1),e("button",{class:"btn btn-danger btn-sm",onClick:y=>k(h),disabled:g.value.length<=1}," åˆ é™¤ ",8,$d)]),e("div",Id,[e("div",Rd,[v[7]||(v[7]=e("label",null,"è½®æ¬¡åç§°:",-1)),ne(e("input",{type:"text","onUpdate:modelValue":y=>d.name=y,placeholder:"å¦‚: ç¬¬ä¸€è½®æ ¡å¯¹"},null,8,Pd),[[ke,d.name]])]),e("div",Dd,[e("div",Md,[v[8]||(v[8]=e("label",null,"æœåŠ¡å•†:",-1)),xe(Ne,{modelValue:d.provider,"onUpdate:modelValue":y=>d.provider=y,options:t},null,8,["modelValue","onUpdate:modelValue"])]),e("div",Bd,[v[9]||(v[9]=e("label",null,"API Key:",-1)),e("div",Ed,[ne(e("input",{type:d.showApiKey?"text":"password","onUpdate:modelValue":y=>d.apiKey=y,class:"secure-input",placeholder:"è¯·è¾“å…¥API Key",autocomplete:"off"},null,8,Ad),[[Tt,d.apiKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:y=>d.showApiKey=!d.showApiKey},[d.showApiKey?(A(),U("span",Ud,"ğŸ‘â€ğŸ—¨")):(A(),U("span",Fd,"ğŸ‘"))],8,Ld)])])]),ne(e("div",zd,[v[10]||(v[10]=e("label",null,"Base URL:",-1)),ne(e("input",{type:"text","onUpdate:modelValue":y=>d.customBaseUrl=y,placeholder:"ä¾‹å¦‚: https://api.example.com/v1"},null,8,Od),[[ke,d.customBaseUrl]])],512),[[Oe,d.provider==="custom_openai"]]),e("div",Vd,[v[12]||(v[12]=e("label",null,"æ¨¡å‹åç§°:",-1)),e("div",Nd,[ne(e("input",{type:"text","onUpdate:modelValue":y=>d.modelName=y,placeholder:"è¯·è¾“å…¥æ¨¡å‹åç§°"},null,8,Wd),[[ke,d.modelName]]),e("button",{type:"button",class:"fetch-models-btn",title:"è·å–å¯ç”¨æ¨¡å‹åˆ—è¡¨",onClick:y=>D(h),disabled:r.value[h]},[v[11]||(v[11]=e("span",{class:"fetch-icon"},"ğŸ”",-1)),e("span",Kd,se(r.value[h]?"è·å–ä¸­...":"è·å–æ¨¡å‹"),1)],8,qd)]),u.value[h]&&u.value[h].length>0?(A(),U("div",Hd,[xe(Ne,{modelValue:d.modelName,"onUpdate:modelValue":y=>d.modelName=y,options:_(h)},null,8,["modelValue","onUpdate:modelValue","options"]),e("span",jd,"å…± "+se(u.value[h].length)+" ä¸ªæ¨¡å‹",1)])):fe("",!0)]),e("div",Yd,[e("button",{class:"settings-test-btn",onClick:y=>R(h),disabled:a.value[h]},se(a.value[h]?"æµ‹è¯•ä¸­...":"ğŸ”— æµ‹è¯•è¿æ¥"),9,Jd)]),e("div",Xd,[e("div",Gd,[v[13]||(v[13]=e("label",null,"æ‰¹æ¬¡å¤§å°:",-1)),ne(e("input",{type:"number","onUpdate:modelValue":y=>d.batchSize=y,min:"1",max:"10",step:"1"},null,8,Zd),[[ke,d.batchSize,void 0,{number:!0}]])]),e("div",Qd,[v[14]||(v[14]=e("label",null,"ä¼šè¯é‡ç½®é¢‘ç‡:",-1)),ne(e("input",{type:"number","onUpdate:modelValue":y=>d.sessionReset=y,min:"1",step:"1"},null,8,eg),[[ke,d.sessionReset,void 0,{number:!0}]])]),e("div",tg,[v[15]||(v[15]=e("label",null,"RPMé™åˆ¶:",-1)),ne(e("input",{type:"number","onUpdate:modelValue":y=>d.rpmLimit=y,min:"0",step:"1"},null,8,og),[[ke,d.rpmLimit,void 0,{number:!0}]])])]),e("div",ng,[e("div",sg,[e("label",ag,[ne(e("input",{type:"checkbox","onUpdate:modelValue":y=>d.lowReasoning=y},null,8,lg),[[nt,d.lowReasoning]]),v[16]||(v[16]=Ue(" ä½æ¨ç†æ¨¡å¼ ",-1))])]),e("div",ig,[v[17]||(v[17]=e("label",null,"å–æ¶ˆæ€è€ƒæ–¹æ³•:",-1)),xe(Ne,{modelValue:d.noThinkingMethod,"onUpdate:modelValue":y=>d.noThinkingMethod=y,options:n},null,8,["modelValue","onUpdate:modelValue"])]),e("div",rg,[e("label",ug,[ne(e("input",{type:"checkbox","onUpdate:modelValue":y=>d.forceJsonOutput=y},null,8,cg),[[nt,d.forceJsonOutput]]),v[18]||(v[18]=Ue(" å¼ºåˆ¶JSONè¾“å‡º ",-1))])])]),e("div",dg,[v[19]||(v[19]=e("label",null,"æ ¡å¯¹æç¤ºè¯:",-1)),ne(e("textarea",{"onUpdate:modelValue":y=>d.prompt=y,rows:"4",placeholder:"æ ¡å¯¹æç¤ºè¯"},null,8,gg),[[ke,d.prompt]]),xe(Ft,{"prompt-type":"proofreading",onSelect:(y,z)=>V(h,y,z)},null,8,["onSelect"]),e("button",{class:"btn btn-secondary btn-sm",onClick:y=>Y(h)},"é‡ç½®ä¸ºé»˜è®¤",8,pg)])])]))),128))],512),[[Oe,x.value]])]))}}),vg=je(mg,[["__scopeId","data-v-663a7972"]]),fg={class:"prompt-library"},bg={class:"settings-group"},hg={class:"settings-item"},yg={key:0,class:"settings-item"},xg={class:"mode-hint"},Sg={class:"settings-group"},_g={key:0,class:"loading-hint"},Cg={key:1,class:"empty-hint"},kg={key:2,class:"prompt-list"},wg=["onClick"],Tg={class:"prompt-name"},$g={class:"prompt-actions"},Ig=["onClick"],Rg=["onClick","disabled"],Pg={class:"settings-group"},Dg={class:"settings-item"},Mg={class:"settings-item"},Bg={class:"prompt-editor-actions"},Eg=["disabled"],Ag=Ye({__name:"PromptLibrary",setup(s){const t=[{label:"ç¿»è¯‘æç¤ºè¯",value:"translate"},{label:"æ–‡æœ¬æ¡†æç¤ºè¯",value:"textbox"},{label:"AIè§†è§‰OCRæç¤ºè¯",value:"ai_vision_ocr"},{label:"é«˜è´¨é‡ç¿»è¯‘æç¤ºè¯",value:"hq_translate"},{label:"æ ¡å¯¹æç¤ºè¯",value:"proofreading"}],n=[{label:"æ™®é€šæ¨¡å¼",value:"false"},{label:"JSONæ ¼å¼æ¨¡å¼",value:"true"}],o=ct(),i=Fe(),r=C("translate"),a=C([]),u=C(""),g=C(""),S=C(""),x=C(!1),_=C(!1),D=Q(()=>r.value==="translate"||r.value==="ai_vision_ocr"),R=Q(()=>_.value?"é€‚ç”¨äºéœ€è¦ç»“æ„åŒ–è¾“å‡ºçš„åœºæ™¯":"é€‚ç”¨äºæ™®é€šç¿»è¯‘åœºæ™¯");async function M(){x.value=!0;try{let h;r.value==="textbox"?h=await qe.getTextboxPrompts():h=await qe.getPrompts(r.value);const y=h.prompt_names||[];a.value=y.map(z=>({name:z}))}catch(h){const y=h instanceof Error?h.message:"åŠ è½½æç¤ºè¯åˆ—è¡¨å¤±è´¥";o.error(y)}finally{x.value=!1}}async function k(h){u.value=h,g.value=h,await Y(h)}async function Y(h){try{let y;r.value==="textbox"?y=await qe.getTextboxPromptContent(h):y=await qe.getPromptContent(r.value,h),g.value=h,S.value=y.prompt_content||"",u.value=h,o.success("å·²åŠ è½½æç¤ºè¯")}catch(y){const z=y instanceof Error?y.message:"åŠ è½½æç¤ºè¯å†…å®¹å¤±è´¥";o.error(z)}}async function V(){if(!g.value||!S.value){o.warning("è¯·è¾“å…¥æç¤ºè¯åç§°å’Œå†…å®¹");return}try{r.value==="textbox"?await qe.saveTextboxPrompt(g.value,S.value):await qe.savePrompt(r.value,g.value,S.value),o.success("æç¤ºè¯ä¿å­˜æˆåŠŸ"),g.value="",S.value="",await M()}catch(h){const y=h instanceof Error?h.message:"ä¿å­˜æç¤ºè¯å¤±è´¥";o.error(y)}}async function L(h){if(h==="default"){o.warning("é»˜è®¤æç¤ºè¯ä¸èƒ½åˆ é™¤");return}try{r.value==="textbox"?await qe.deleteTextboxPrompt(h):await qe.deletePrompt(r.value,h),o.success("æç¤ºè¯åˆ é™¤æˆåŠŸ"),u.value===h&&(u.value="",g.value="",S.value=""),await M()}catch(y){const z=y instanceof Error?y.message:"åˆ é™¤æç¤ºè¯å¤±è´¥";o.error(z)}}function v(){u.value="",g.value="",S.value="",r.value==="translate"?_.value=i.settings.translation.isJsonMode:r.value==="ai_vision_ocr"?_.value=i.settings.aiVisionOcr.isJsonMode:_.value=!1,M()}function d(){r.value==="translate"?i.updateTranslationService({isJsonMode:_.value}):r.value==="ai_vision_ocr"&&i.updateAiVisionOcr({isJsonMode:_.value}),o.info(`å·²åˆ‡æ¢åˆ°${_.value?"JSONæ ¼å¼":"æ™®é€š"}æ¨¡å¼`)}return dt(()=>{_.value=i.settings.translation.isJsonMode,M()}),(h,y)=>(A(),U("div",fg,[e("div",bg,[y[6]||(y[6]=e("div",{class:"settings-group-title"},"æç¤ºè¯ç®¡ç†",-1)),e("div",hg,[y[4]||(y[4]=e("label",{for:"promptType"},"æç¤ºè¯ç±»å‹:",-1)),xe(Ne,{modelValue:r.value,"onUpdate:modelValue":y[0]||(y[0]=z=>r.value=z),options:t,onChange:v},null,8,["modelValue"])]),D.value?(A(),U("div",yg,[y[5]||(y[5]=e("label",{for:"promptMode"},"æç¤ºè¯æ¨¡å¼:",-1)),xe(Ne,{"model-value":_.value?"true":"false",options:n,onChange:y[1]||(y[1]=z=>{_.value=z==="true",d()})},null,8,["model-value"]),e("span",xg,se(R.value),1)])):fe("",!0)]),e("div",Sg,[y[7]||(y[7]=e("div",{class:"settings-group-title"},"å·²ä¿å­˜çš„æç¤ºè¯",-1)),x.value?(A(),U("div",_g,"åŠ è½½ä¸­...")):a.value.length===0?(A(),U("div",Cg,"æš‚æ— ä¿å­˜çš„æç¤ºè¯")):(A(),U("div",kg,[(A(!0),U(We,null,Qe(a.value,z=>(A(),U("div",{key:z.name,class:Ee(["prompt-item",{active:u.value===z.name}]),onClick:F=>k(z.name)},[e("span",Tg,se(z.name),1),e("div",$g,[e("button",{class:"btn btn-sm",onClick:it(F=>Y(z.name),["stop"]),title:"åŠ è½½åˆ°ç¼–è¾‘å™¨"},"ğŸ“¥",8,Ig),e("button",{class:"btn btn-sm btn-danger",onClick:it(F=>L(z.name),["stop"]),title:"åˆ é™¤",disabled:z.name==="default"}," ğŸ—‘ï¸ ",8,Rg)])],10,wg))),128))]))]),e("div",Pg,[y[10]||(y[10]=e("div",{class:"settings-group-title"},"æç¤ºè¯ç¼–è¾‘",-1)),e("div",Dg,[y[8]||(y[8]=e("label",{for:"promptName"},"æç¤ºè¯åç§°:",-1)),ne(e("input",{type:"text",id:"promptName","onUpdate:modelValue":y[2]||(y[2]=z=>g.value=z),placeholder:"è¯·è¾“å…¥æç¤ºè¯åç§°"},null,512),[[ke,g.value]])]),e("div",Mg,[y[9]||(y[9]=e("label",{for:"promptContent"},"æç¤ºè¯å†…å®¹:",-1)),ne(e("textarea",{id:"promptContent","onUpdate:modelValue":y[3]||(y[3]=z=>S.value=z),rows:"8",placeholder:"è¯·è¾“å…¥æç¤ºè¯å†…å®¹"},null,512),[[ke,S.value]])]),e("div",Bg,[e("button",{class:"btn btn-primary",onClick:V,disabled:!g.value||!S.value},"ä¿å­˜æç¤ºè¯",8,Eg)])])]))}}),Lg=je(Ag,[["__scopeId","data-v-70f0ec19"]]),Fg={class:"plugin-manager"},Ug={class:"settings-group"},zg={key:0,class:"loading-hint"},Og={key:1,class:"empty-hint"},Vg={key:2,class:"plugin-list"},Ng={class:"plugin-info"},Wg={class:"plugin-header"},qg={class:"plugin-name"},Kg={class:"plugin-version"},Hg={class:"plugin-description"},jg={class:"plugin-controls"},Yg={class:"switch"},Jg=["checked","onChange"],Xg=["onClick"],Gg=["onClick"],Zg={class:"settings-group"},Qg={class:"plugin-name"},ep={class:"switch"},tp=["checked","onChange"],op={class:"plugin-config-content"},np={class:"plugin-config-header"},sp={class:"plugin-config-body"},ap=["for"],lp=["id","onUpdate:modelValue"],ip=["id","onUpdate:modelValue","min","max"],rp=["id","onUpdate:modelValue","placeholder"],up={key:4,class:"field-description"},cp=Ye({__name:"PluginManager",setup(s){const t=ct(),n=C([]),o=C({}),i=C(!1),r=C(!1),a=C(null),u=C({}),g=C({});async function S(){i.value=!0;try{const V=await $s();n.value=V.plugins||[]}catch(V){const L=V instanceof Error?V.message:"åŠ è½½æ’ä»¶åˆ—è¡¨å¤±è´¥";t.error(L)}finally{i.value=!1}}async function x(){try{const V=await Ls();o.value=V.states||{}}catch(V){console.error("åŠ è½½é»˜è®¤çŠ¶æ€å¤±è´¥:",V)}}async function _(V){try{V.enabled?(await Rs(V.name),V.enabled=!1,t.success(`å·²ç¦ç”¨ ${V.display_name||V.name}`)):(await Is(V.name),V.enabled=!0,t.success(`å·²å¯ç”¨ ${V.display_name||V.name}`))}catch(L){const v=L instanceof Error?L.message:"æ“ä½œå¤±è´¥";t.error(v)}}async function D(V,L){const v=L.target,d=v.checked;try{await Fs(V,d),o.value[V]=d,t.success("é»˜è®¤çŠ¶æ€å·²æ›´æ–°")}catch(h){const y=h instanceof Error?h.message:"è®¾ç½®å¤±è´¥";t.error(y),v.checked=!d}}async function R(V){a.value=V;try{const L=await Us(V.name);u.value=L.schema||{};const v=await zs(V.name);g.value=v.config||{},r.value=!0}catch(L){const v=L instanceof Error?L.message:"åŠ è½½é…ç½®å¤±è´¥";t.error(v)}}function M(){r.value=!1,a.value=null,u.value={},g.value={}}async function k(){if(a.value)try{await Os(a.value.name,g.value),t.success("é…ç½®ä¿å­˜æˆåŠŸ"),M()}catch(V){const L=V instanceof Error?V.message:"ä¿å­˜é…ç½®å¤±è´¥";t.error(L)}}async function Y(V){if(confirm(`ç¡®å®šè¦åˆ é™¤æ’ä»¶ "${V.display_name||V.name}" å—ï¼Ÿ`))try{await Ps(V.name),t.success("æ’ä»¶åˆ é™¤æˆåŠŸ"),await S()}catch(L){const v=L instanceof Error?L.message:"åˆ é™¤æ’ä»¶å¤±è´¥";t.error(v)}}return dt(()=>{S(),x()}),(V,L)=>(A(),U("div",Fg,[e("div",Ug,[L[1]||(L[1]=e("div",{class:"settings-group-title"},"å·²å®‰è£…æ’ä»¶",-1)),i.value?(A(),U("div",zg,"åŠ è½½ä¸­...")):n.value.length===0?(A(),U("div",Og,"æš‚æ— å·²å®‰è£…çš„æ’ä»¶")):(A(),U("div",Vg,[(A(!0),U(We,null,Qe(n.value,v=>(A(),U("div",{key:v.name,class:"plugin-item"},[e("div",Ng,[e("div",Wg,[e("span",qg,se(v.display_name||v.name),1),e("span",Kg,"v"+se(v.version||"1.0.0"),1)]),e("p",Hg,se(v.description||"æš‚æ— æè¿°"),1)]),e("div",jg,[e("label",Yg,[e("input",{type:"checkbox",checked:v.enabled,onChange:d=>_(v)},null,40,Jg),L[0]||(L[0]=e("span",{class:"slider"},null,-1))]),v.has_config?(A(),U("button",{key:0,class:"btn btn-sm",onClick:d=>R(v),title:"é…ç½®"},"âš™ï¸",8,Xg)):fe("",!0),e("button",{class:"btn btn-sm btn-danger",onClick:d=>Y(v),title:"åˆ é™¤"},"ğŸ—‘ï¸",8,Gg)])]))),128))]))]),e("div",Zg,[L[3]||(L[3]=e("div",{class:"settings-group-title"},"é»˜è®¤å¯ç”¨çŠ¶æ€",-1)),L[4]||(L[4]=e("p",{class:"settings-hint"},"è®¾ç½®æ’ä»¶åœ¨æ–°ä¼šè¯ä¸­çš„é»˜è®¤å¯ç”¨çŠ¶æ€",-1)),(A(!0),U(We,null,Qe(n.value,v=>(A(),U("div",{key:"default-"+v.name,class:"default-state-item"},[e("span",Qg,se(v.display_name||v.name),1),e("label",ep,[e("input",{type:"checkbox",checked:o.value[v.name],onChange:d=>D(v.name,d)},null,40,tp),L[2]||(L[2]=e("span",{class:"slider"},null,-1))])]))),128))]),r.value?(A(),U("div",{key:0,class:"plugin-config-modal",onClick:it(M,["self"])},[e("div",op,[e("div",np,[e("h4",null,se(a.value?.display_name||a.value?.name)+" é…ç½®",1),e("span",{class:"close-btn",onClick:M},"Ã—")]),e("div",sp,[(A(!0),U(We,null,Qe(u.value,(v,d)=>(A(),U("div",{key:d,class:"config-field"},[e("label",{for:"config-"+d},se(v.label||d)+":",9,ap),v.type==="boolean"?ne((A(),U("input",{key:0,type:"checkbox",id:"config-"+d,"onUpdate:modelValue":h=>g.value[d]=h},null,8,lp)),[[nt,g.value[d]]]):v.type==="select"?(A(),ut(Ne,{key:1,"model-value":String(g.value[d]??""),options:v.options||[],onChange:h=>{g.value[d]=h}},null,8,["model-value","options","onChange"])):v.type==="number"?ne((A(),U("input",{key:2,type:"number",id:"config-"+d,"onUpdate:modelValue":h=>g.value[d]=h,min:v.min,max:v.max},null,8,ip)),[[ke,g.value[d],void 0,{number:!0}]]):ne((A(),U("input",{key:3,type:"text",id:"config-"+d,"onUpdate:modelValue":h=>g.value[d]=h,placeholder:v.placeholder},null,8,rp)),[[ke,g.value[d]]]),v.description?(A(),U("p",up,se(v.description),1)):fe("",!0)]))),128))]),e("div",{class:"plugin-config-footer"},[e("button",{class:"btn btn-secondary",onClick:M},"å–æ¶ˆ"),e("button",{class:"btn btn-primary",onClick:k},"ä¿å­˜")])])])):fe("",!0)]))}}),dp=je(cp,[["__scopeId","data-v-a62393a7"]]),gp={class:"parallel-settings"},pp={class:"settings-group"},mp={class:"settings-item"},vp={class:"toggle-switch"},fp={class:"number-control"},bp=["disabled"],hp=["disabled"],yp=["disabled"],xp={key:0,class:"settings-note"},Sp=Ye({__name:"ParallelSettings",setup(s){const t=Fe(),n=Q({get:()=>t.settings.parallel.enabled,set:i=>{t.updateSettings({parallel:{...t.settings.parallel,enabled:i}})}}),o=Q({get:()=>t.settings.parallel.deepLearningLockSize,set:i=>{t.updateSettings({parallel:{...t.settings.parallel,deepLearningLockSize:Math.max(1,Math.min(4,i))}})}});return(i,r)=>(A(),U("div",gp,[e("div",pp,[r[10]||(r[10]=e("div",{class:"settings-group-title"},"ğŸš€ å¹¶è¡Œç¿»è¯‘",-1)),e("div",mp,[r[5]||(r[5]=e("label",null,"å¯ç”¨å¹¶è¡Œæ¨¡å¼:",-1)),e("label",vp,[ne(e("input",{type:"checkbox","onUpdate:modelValue":r[0]||(r[0]=a=>n.value=a)},null,512),[[nt,n.value]]),r[4]||(r[4]=e("span",{class:"toggle-slider"},null,-1))]),r[6]||(r[6]=e("div",{class:"input-hint"},"ä½¿ç”¨æµæ°´çº¿å¹¶è¡Œå¤„ç†ï¼Œå¯èƒ½æå‡æ‰¹é‡ç¿»è¯‘é€Ÿåº¦",-1))]),e("div",{class:Ee(["settings-item",{"item-disabled":!n.value}])},[r[7]||(r[7]=e("label",null,"æ·±åº¦å­¦ä¹ å¹¶å‘æ•°:",-1)),e("div",fp,[e("button",{class:"btn btn-sm",onClick:r[1]||(r[1]=a=>o.value=Math.max(1,o.value-1)),disabled:!n.value},"-",8,bp),ne(e("input",{type:"number","onUpdate:modelValue":r[2]||(r[2]=a=>o.value=a),min:"1",max:"4",disabled:!n.value,class:"number-input"},null,8,hp),[[ke,o.value,void 0,{number:!0}]]),e("button",{class:"btn btn-sm",onClick:r[3]||(r[3]=a=>o.value=Math.min(4,o.value+1)),disabled:!n.value},"+",8,yp)]),r[8]||(r[8]=e("div",{class:"input-hint"},"æ§åˆ¶æ£€æµ‹/OCR/é¢œè‰²/ä¿®å¤çš„æœ€å¤§å¹¶å‘æ•°ï¼ˆå»ºè®®1-2ï¼‰",-1))],2),n.value?(A(),U("div",xp,[...r[9]||(r[9]=[e("div",{class:"note-title"},"âš ï¸ æ³¨æ„äº‹é¡¹ï¼š",-1),e("ul",null,[e("li",null,"å¹¶å‘æ•°è®¾ä¸º1æ—¶ä¸ºä¸²è¡Œæ‰§è¡Œï¼Œæœ€ç¨³å®š"),e("li",null,"å¢å¤§å¹¶å‘æ•°å¯èƒ½åŠ é€Ÿå¤„ç†ï¼Œä½†ä¼šå ç”¨æ›´å¤šGPU/CPUèµ„æº"),e("li",null,"å¦‚æœé‡åˆ°æ˜¾å­˜ä¸è¶³ï¼Œè¯·å°†å¹¶å‘æ•°è®¾ä¸º1")],-1)])])):fe("",!0)])]))}}),_p=je(Sp,[["__scopeId","data-v-4a6e42d5"]]),Cp={class:"more-settings"},kp={class:"settings-group"},wp={class:"settings-item checkbox-item"},Tp={class:"checkbox-label"},$p={class:"settings-group"},Ip={class:"settings-item"},Rp={class:"settings-group"},Pp={class:"settings-item"},Dp=["disabled"],Mp={key:0,class:"font-count"},Bp={class:"settings-item"},Ep={class:"settings-group"},Ap={class:"settings-row"},Lp={class:"settings-item"},Fp=["disabled"],Up={class:"settings-item"},zp=["disabled"],Op=Ye({__name:"MoreSettings",setup(s){const t=[{label:"å‰ç«¯ pdf.js (æ¨è)",value:"frontend"},{label:"åç«¯ PyMuPDF",value:"backend"}],n=Fe(),o=ct(),i=C(!1),r=C([]),a=C(!1),u=C(null),g=C({pdfProcessingMethod:n.settings.pdfProcessingMethod||"frontend",autoSaveInBookshelfMode:n.settings.autoSaveInBookshelfMode||!1});_e(()=>g.value.pdfProcessingMethod,R=>{n.setPdfProcessingMethod(R)}),_e(()=>g.value.autoSaveInBookshelfMode,R=>{n.setAutoSaveInBookshelfMode(R)});async function S(){i.value=!0;try{const R=await qe.getFontList();r.value=R.fonts||[],o.success(`è·å–åˆ° ${r.value.length} ä¸ªå­—ä½“`)}catch(R){const M=R instanceof Error?R.message:"è·å–å­—ä½“åˆ—è¡¨å¤±è´¥";o.error(M)}finally{i.value=!1}}async function x(R){const k=R.target.files?.[0];if(!k)return;const Y=[".ttf",".ttc",".otf"],V=k.name.toLowerCase().slice(k.name.lastIndexOf("."));if(!Y.includes(V)){o.error("ä¸æ”¯æŒçš„å­—ä½“æ ¼å¼ï¼Œè¯·ä¸Šä¼  .ttf, .ttc æˆ– .otf æ–‡ä»¶");return}try{const L=await qe.uploadFont(k);L.success?(o.success(`å­—ä½“ "${L.fontPath||k.name}" ä¸Šä¼ æˆåŠŸ`),await S()):o.error(L.error||"å­—ä½“ä¸Šä¼ å¤±è´¥")}catch(L){const v=L instanceof Error?L.message:"å­—ä½“ä¸Šä¼ å¤±è´¥";o.error(v)}finally{u.value&&(u.value.value="")}}async function _(){a.value=!0;try{const R=await fn();R.success?o.success(`å·²æ¸…ç† ${R.deleted_count||0} ä¸ªè°ƒè¯•æ–‡ä»¶`):o.error(R.error||"æ¸…ç†å¤±è´¥")}catch(R){const M=R instanceof Error?R.message:"æ¸…ç†å¤±è´¥";o.error(M)}finally{a.value=!1}}async function D(){a.value=!0;try{const R=await fo();R.success?o.success(`å·²æ¸…ç† ${R.deleted_count||0} ä¸ªä¸´æ—¶æ–‡ä»¶`):o.error(R.error||"æ¸…ç†å¤±è´¥")}catch(R){const M=R instanceof Error?R.message:"æ¸…ç†å¤±è´¥";o.error(M)}finally{a.value=!1}}return(R,M)=>(A(),U("div",Cp,[xe(_p),e("div",kp,[M[4]||(M[4]=e("div",{class:"settings-group-title"},"è‡ªåŠ¨ä¿å­˜è®¾ç½®",-1)),e("div",wp,[e("label",Tp,[ne(e("input",{type:"checkbox","onUpdate:modelValue":M[0]||(M[0]=k=>g.value.autoSaveInBookshelfMode=k)},null,512),[[nt,g.value.autoSaveInBookshelfMode]]),M[2]||(M[2]=e("span",{class:"checkbox-text"},"ä¹¦æ¶æ¨¡å¼è‡ªåŠ¨ä¿å­˜",-1))]),M[3]||(M[3]=e("div",{class:"input-hint"},[Ue(" å¼€å¯åï¼Œåœ¨ä¹¦æ¶æ¨¡å¼ä¸‹ç¿»è¯‘æ—¶ä¼šè‡ªåŠ¨ä¿å­˜è¿›åº¦ï¼ˆç¿»è¯‘ä¸€å¼ ä¿å­˜ä¸€å¼ ï¼‰ï¼Œé˜²æ­¢æ„å¤–å…³é—­å¯¼è‡´æ•°æ®ä¸¢å¤±ã€‚ "),e("br"),e("span",{class:"hint-note"},"æ³¨æ„ï¼šæ­¤åŠŸèƒ½ä»…åœ¨ä¹¦æ¶æ¨¡å¼ä¸‹ç”Ÿæ•ˆï¼Œå¿«é€Ÿç¿»è¯‘æ¨¡å¼ä¸æ”¯æŒã€‚")],-1))])]),e("div",$p,[M[7]||(M[7]=e("div",{class:"settings-group-title"},"PDFå¤„ç†è®¾ç½®",-1)),e("div",Ip,[M[5]||(M[5]=e("label",{for:"settingsPdfProcessingMethod"},"PDFå¤„ç†æ–¹å¼:",-1)),xe(Ne,{modelValue:g.value.pdfProcessingMethod,"onUpdate:modelValue":M[1]||(M[1]=k=>g.value.pdfProcessingMethod=k),options:t},null,8,["modelValue"]),M[6]||(M[6]=e("div",{class:"input-hint"},"å‰ç«¯å¤„ç†é€Ÿåº¦æ›´å¿«ï¼Œåç«¯å¤„ç†å…¼å®¹æ€§æ›´å¥½",-1))])]),e("div",Rp,[M[11]||(M[11]=e("div",{class:"settings-group-title"},"å­—ä½“è®¾ç½®",-1)),e("div",Pp,[M[8]||(M[8]=e("label",null,"ç³»ç»Ÿå­—ä½“åˆ—è¡¨:",-1)),e("button",{class:"btn btn-secondary",onClick:S,disabled:i.value},se(i.value?"åŠ è½½ä¸­...":"ğŸ”„ åˆ·æ–°å­—ä½“åˆ—è¡¨"),9,Dp),r.value.length>0?(A(),U("div",Mp,"å…± "+se(r.value.length)+" ä¸ªå­—ä½“",1)):fe("",!0)]),e("div",Bp,[M[9]||(M[9]=e("label",null,"ä¸Šä¼ è‡ªå®šä¹‰å­—ä½“:",-1)),e("input",{type:"file",accept:".ttf,.ttc,.otf",onChange:x,ref_key:"fontInput",ref:u},null,544),M[10]||(M[10]=e("div",{class:"input-hint"},"æ”¯æŒ .ttf, .ttc, .otf æ ¼å¼",-1))])]),e("div",Ep,[M[14]||(M[14]=e("div",{class:"settings-group-title"},"ç¼“å­˜æ¸…ç†",-1)),e("div",Ap,[e("div",Lp,[e("button",{class:"btn btn-secondary",onClick:_,disabled:a.value},se(a.value?"æ¸…ç†ä¸­...":"ğŸ—‘ï¸ æ¸…ç†è°ƒè¯•æ–‡ä»¶"),9,Fp),M[12]||(M[12]=e("div",{class:"input-hint"},"æ¸…ç†è°ƒè¯•è¿‡ç¨‹ä¸­ç”Ÿæˆçš„ä¸´æ—¶æ–‡ä»¶",-1))]),e("div",Up,[e("button",{class:"btn btn-secondary",onClick:D,disabled:a.value},se(a.value?"æ¸…ç†ä¸­...":"ğŸ—‘ï¸ æ¸…ç†ä¸´æ—¶æ–‡ä»¶"),9,zp),M[13]||(M[13]=e("div",{class:"input-hint"},"æ¸…ç†ä¸‹è½½å’Œå¤„ç†è¿‡ç¨‹ä¸­çš„ä¸´æ—¶æ–‡ä»¶",-1))])])]),M[15]||(M[15]=ro('<div class="settings-group" data-v-8667f80e><div class="settings-group-title" data-v-8667f80e>å…³äº</div><div class="about-info" data-v-8667f80e><p data-v-8667f80e><strong data-v-8667f80e>Saber-Translator</strong></p><p data-v-8667f80e>AIé©±åŠ¨çš„æ¼«ç”»ç¿»è¯‘å·¥å…·</p><p class="links" data-v-8667f80e><a href="http://www.mashirosaber.top" target="_blank" data-v-8667f80e>ğŸ“– ä½¿ç”¨æ•™ç¨‹</a><a href="https://github.com/MashiroSaber/saber-translator" target="_blank" data-v-8667f80e>ğŸ™ GitHub</a></p><p class="disclaimer" data-v-8667f80e>æœ¬é¡¹ç›®å®Œå…¨å¼€æºå…è´¹ï¼Œè¯·å‹¿ä¸Šå½“å—éª—</p></div></div>',1))]))}}),Vp=je(Op,[["__scopeId","data-v-8667f80e"]]),Np={class:"settings-modal-content"},Wp={class:"settings-tabs"},qp=["onClick"],Kp={class:"settings-tab-content"},Hp={class:"settings-tab-pane active"},jp={class:"settings-tab-pane"},Yp={class:"settings-tab-pane"},Jp={class:"settings-tab-pane"},Xp={class:"settings-tab-pane"},Gp={class:"settings-tab-pane"},Zp={class:"settings-tab-pane"},Qp={class:"settings-tab-pane"},em=Ye({__name:"SettingsModal",props:{modelValue:{type:Boolean},initialTab:{}},emits:["update:modelValue","save"],setup(s,{emit:t}){const n=s,o=t,i=Fe(),r=C(n.modelValue),a=C("ocr"),u=[{id:"ocr",label:"OCRè¯†åˆ«"},{id:"translate",label:"ç¿»è¯‘æœåŠ¡"},{id:"detection",label:"æ£€æµ‹è®¾ç½®"},{id:"hq",label:"é«˜è´¨é‡ç¿»è¯‘"},{id:"proofreading",label:"AIæ ¡å¯¹"},{id:"prompt-library",label:"æç¤ºè¯ç®¡ç†"},{id:"plugins",label:"æ’ä»¶ç®¡ç†"},{id:"more",label:"æ›´å¤š"}];_e(()=>n.modelValue,_=>{r.value=_,_?(document.body.style.overflow="hidden",n.initialTab&&u.some(D=>D.id===n.initialTab)&&(a.value=n.initialTab)):(document.body.style.overflow="",a.value="ocr")});function g(){r.value=!1,o("update:modelValue",!1),document.body.style.overflow=""}async function S(){i.saveToStorage();try{await i.saveToBackend(),console.log("[SettingsModal] è®¾ç½®å·²ä¿å­˜åˆ°åç«¯")}catch(_){console.warn("[SettingsModal] ä¿å­˜åˆ°åç«¯å¤±è´¥ï¼Œä»…ä¿å­˜åˆ° localStorage:",_)}o("save"),g()}function x(_){_.key==="Escape"&&r.value&&g()}return dt(()=>{document.addEventListener("keydown",x)}),Ut(()=>{document.removeEventListener("keydown",x),document.body.style.overflow=""}),(_,D)=>r.value?(A(),U("div",{key:0,class:"settings-modal",onClick:it(g,["self"])},[e("div",Np,[e("div",{class:"settings-modal-header"},[D[0]||(D[0]=e("h3",null,"âš™ï¸ è®¾ç½®",-1)),e("span",{class:"settings-modal-close",onClick:g},"Ã—")]),e("div",Wp,[(A(),U(We,null,Qe(u,R=>e("button",{key:R.id,class:Ee(["settings-tab",{active:a.value===R.id}]),onClick:M=>a.value=R.id},se(R.label),11,qp)),64))]),e("div",Kp,[ne(e("div",Hp,[xe(Cu)],512),[[Oe,a.value==="ocr"]]),ne(e("div",jp,[xe(dc)],512),[[Oe,a.value==="translate"]]),ne(e("div",Yp,[xe(Bc)],512),[[Oe,a.value==="detection"]]),ne(e("div",Jp,[xe(hd)],512),[[Oe,a.value==="hq"]]),ne(e("div",Xp,[xe(vg)],512),[[Oe,a.value==="proofreading"]]),ne(e("div",Gp,[xe(Lg)],512),[[Oe,a.value==="prompt-library"]]),ne(e("div",Zp,[xe(dp)],512),[[Oe,a.value==="plugins"]]),ne(e("div",Qp,[xe(Vp)],512),[[Oe,a.value==="more"]])]),e("div",{class:"settings-modal-footer"},[e("button",{class:"btn btn-secondary",onClick:g},"å–æ¶ˆ"),e("button",{class:"btn btn-primary",onClick:S},"ä¿å­˜è®¾ç½®")])])])):fe("",!0)}}),tm=je(em,[["__scopeId","data-v-e1ec20ab"]]),om={minScale:.1,maxScale:5,zoomSpeed:.1};function gn(s={}){const t={...om,...s},n=C(1),o=C(0),i=C(0),r=C(!1),a=C(0),u=C(0),g=Q(()=>({transform:`translate(${o.value}px, ${i.value}px) scale(${n.value})`}));function S(J,K,Z){const W=Math.min(Math.max(n.value*Z,t.minScale),t.maxScale),oe=W/n.value;o.value=J-(J-o.value)*oe,i.value=K-(K-i.value)*oe,n.value=W,s.onScaleChange?.(n.value),s.onTransformChange?.(y())}function x(J,K=800,Z=600){S(K/2,Z/2,J)}function _(){x(1.2)}function D(){x(.8)}function R(J,K=800,Z=600){const W=J/n.value;S(K/2,Z/2,W)}function M(J,K){r.value=!0,a.value=J,u.value=K}function k(J,K){if(!r.value)return;const Z=J-a.value,W=K-u.value;o.value+=Z,i.value+=W,a.value=J,u.value=K,s.onTransformChange?.(y())}function Y(){r.value=!1}function V(J,K){o.value+=J,i.value+=K,s.onTransformChange?.(y())}function L(){n.value=1,o.value=0,i.value=0,s.onScaleChange?.(n.value),s.onTransformChange?.(y())}function v(){L()}function d(){n.value=1,o.value=0,i.value=0}function h(J,K,Z,W){if(!J||!K)return;const oe=Z/J,b=W/K;n.value=Math.min(oe,b)*.95,o.value=(Z-J*n.value)/2,i.value=(W-K*n.value)/2,s.onScaleChange?.(n.value),s.onTransformChange?.(y())}function y(){return{scale:n.value,translateX:o.value,translateY:i.value}}function z(J){J.scale!==void 0&&(n.value=J.scale),J.translateX!==void 0&&(o.value=J.translateX),J.translateY!==void 0&&(i.value=J.translateY),s.onTransformChange?.(y())}function F(J){n.value=J.scale,o.value=J.translateX,i.value=J.translateY}function te(J,K,Z){if(!J||J.length<4)return;const[W,oe,b,c]=J,m=(W+b)/2,l=(oe+c)/2,p=K/2,$=Z/2;o.value=p-m*n.value,i.value=$-l*n.value,s.onTransformChange?.(y())}return{scale:n,translateX:o,translateY:i,isDragging:r,transformStyle:g,zoomAt:S,zoom:x,zoomIn:_,zoomOut:D,setScale:R,startDrag:M,drag:k,endDrag:Y,pan:V,reset:L,resetZoom:v,resetTransform:d,fitToScreen:h,getTransform:y,setTransform:z,syncWith:F,scrollToBubble:te}}function nm(s){const t=ot(),n=Fe(),o=C(null),i=C(as),r=C(!1),a=C(!1),u=C([]),g=C(0),S=C(0);let x=null,_=null,D=null;const R=Q(()=>o.value!==null),M=Q(()=>o.value==="repair"?{fill:"rgba(76, 175, 80, 0.4)",border:"#4CAF50"}:o.value==="restore"?{fill:"rgba(33, 150, 243, 0.4)",border:"#2196F3"}:{fill:"transparent",border:"transparent"});function k(l){o.value!==l&&(o.value=l,r.value=!0,u.value=[],console.log(`è¿›å…¥${l==="repair"?"ä¿®å¤":"è¿˜åŸ"}ç¬”åˆ·æ¨¡å¼ï¼Œç¬”åˆ·å¤§å°: ${i.value}px`))}function Y(){a.value&&z();const l=o.value!==null;o.value=null,r.value=!1,a.value=!1,u.value=[],K(),l&&console.log("é€€å‡ºç¬”åˆ·æ¨¡å¼")}function V(l){o.value===l?Y():k(l)}function L(l){i.value=Math.max(Zo,Math.min(Go,l))}function v(l){L(i.value+l)}function d(l){if(!R.value)return;l.preventDefault(),l.stopPropagation();const p=l.deltaY>0?-5:5;v(p)}function h(l,p){if(!R.value||l.button!==0)return;l.preventDefault(),l.stopPropagation(),a.value=!0,x=p,u.value=[];const $=F(l,p);$&&(u.value.push($),J(p),Z($)),console.log("å¼€å§‹ç¬”åˆ·æ¶‚æŠ¹")}function y(l){if(g.value=l.clientX,S.value=l.clientY,!a.value||!R.value)return;const p=F(l,x);p&&(u.value.push(p),Z(p))}function z(){if(!a.value)return;a.value=!1;const l=t.currentImage;if(!l||u.value.length===0){K(),u.value=[];return}const p=te();if(!p){K(),u.value=[];return}const $=o.value;(async()=>{$==="restore"?await W(l,p):$==="repair"&&await oe(l,p),s?.onBrushComplete?.()})(),K(),u.value=[]}function F(l,p){if(!p)return null;const $=p.querySelector(".image-canvas-wrapper"),w=$?.querySelector("img");if(!w||!w.naturalWidth)return null;const P=$.getBoundingClientRect(),O=window.getComputedStyle($).transform;let ee=1;O&&O!=="none"&&(ee=new DOMMatrix(O).a);const le=(l.clientX-P.left)/ee,I=(l.clientY-P.top)/ee,q=w.naturalWidth,ae=w.naturalHeight;return le<0||I<0||le>q||I>ae?null:{x:le,y:I,scale:ee}}function te(){if(u.value.length===0)return null;const p=u.value[0]?.scale||1,$=i.value/2/p;let w=1/0,P=1/0,O=-1/0,ee=-1/0;for(const le of u.value)w=Math.min(w,le.x-$),P=Math.min(P,le.y-$),O=Math.max(O,le.x+$),ee=Math.max(ee,le.y+$);return{x1:Math.max(0,Math.floor(w)),y1:Math.max(0,Math.floor(P)),x2:Math.ceil(O),y2:Math.ceil(ee),path:[...u.value],radius:$}}function J(l){K();const p=l.querySelector(".image-canvas-wrapper"),$=p?.querySelector("img");if(!$)return;const w=document.createElement("canvas");w.id="brushOverlayCanvas",w.width=$.naturalWidth,w.height=$.naturalHeight,w.style.cssText="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100;",p.appendChild(w),_=w,D=w.getContext("2d")}function K(){_&&_.parentNode&&_.parentNode.removeChild(_),_=null,D=null}function Z(l){if(!D||!l)return;const p=M.value.fill,$=i.value/2/(l.scale||1);D.beginPath(),D.arc(l.x,l.y,$,0,Math.PI*2),D.fillStyle=p,D.fill()}async function W(l,p){if(!l.originalDataURL)return;let $;return l.cleanImageData?$="data:image/png;base64,"+l.cleanImageData:$=l.originalDataURL,new Promise(w=>{const P=new Image,O=new Image;let ee=0;const le=()=>{if(ee++,ee<2)return;const I=document.createElement("canvas");I.width=P.naturalWidth,I.height=P.naturalHeight;const q=I.getContext("2d");if(!q){w();return}q.drawImage(P,0,0);const ae=document.createElement("canvas");ae.width=I.width,ae.height=I.height;const T=ae.getContext("2d");if(!T){w();return}T.fillStyle="white";for(const ge of p.path)T.beginPath(),T.arc(ge.x,ge.y,p.radius,0,Math.PI*2),T.fill();q.globalCompositeOperation="destination-out",q.drawImage(ae,0,0),q.globalCompositeOperation="destination-over",q.drawImage(O,0,0),q.globalCompositeOperation="source-over";const j=I.toDataURL("image/png").split(",")[1];t.updateCurrentImage({cleanImageData:j}),console.log("è¿˜åŸç¬”åˆ·åŒºåŸŸå®Œæˆ"),w()};P.onload=le,P.onerror=()=>w(),O.onload=le,O.onerror=()=>w(),P.src=$,O.src=l.originalDataURL})}async function oe(l,p){const $=s?.getCurrentRepairSettings?.()||{inpaintMethod:"solid",fillColor:"#FFFFFF"},w=$.inpaintMethod;w==="lama_mpe"||w==="litelama"?await b(l,p,w):await c(l,p,$.fillColor)}async function b(l,p,$="lama_mpe"){let w,P;if(l.cleanImageData)w=l.cleanImageData,P="data:image/png;base64,"+l.cleanImageData;else if(l.originalDataURL)w=l.originalDataURL.split(",")[1],P=l.originalDataURL;else{console.error("æ— æ³•è·å–åŸºç¡€å›¾åƒç”¨äº LAMA ä¿®å¤");return}return new Promise(O=>{const ee=new Image;ee.onload=async()=>{const le=ee.naturalWidth,I=ee.naturalHeight,q=document.createElement("canvas");q.width=le,q.height=I;const ae=q.getContext("2d");if(!ae){console.error("æ— æ³•åˆ›å»ºæ©è†œç”»å¸ƒä¸Šä¸‹æ–‡"),O();return}ae.fillStyle="black",ae.fillRect(0,0,le,I),ae.fillStyle="white";for(const Re of p.path)ae.beginPath(),ae.arc(Re.x,Re.y,p.radius,0,Math.PI*2),ae.fill();const j=q.toDataURL("image/png").split(",")[1],ge=[p.x1,p.y1,p.x2,p.y2],Se=$==="litelama"?"litelama":"lama_mpe";try{ye("LAMA ä¿®å¤ä¸­...","info");const Re=await ho(w,ge,{method:"lama",lamaModel:Se,maskData:j});if(Re.success&&Re.inpainted_image)t.updateCurrentImage({cleanImageData:Re.inpainted_image}),console.log("ä¿®å¤ç¬”åˆ·åŒºåŸŸå®Œæˆï¼ˆLAMA ä¿®å¤ï¼Œç²¾ç¡®æ©è†œï¼‰"),ye("LAMA ä¿®å¤å®Œæˆ","success");else throw new Error(Re.error||"LAMA ä¿®å¤è¿”å›æ— æ•ˆæ•°æ®")}catch(Re){console.error("LAMA ä¿®å¤å¤±è´¥ï¼Œå›é€€åˆ°çº¯è‰²å¡«å……:",Re),ye("LAMA ä¿®å¤å¤±è´¥ï¼Œä½¿ç”¨çº¯è‰²å¡«å……","warning");const we=s?.getCurrentRepairSettings?.();await c(l,p,we?.fillColor)}O()},ee.onerror=()=>{console.error("åŠ è½½å›¾åƒå¤±è´¥ï¼Œæ— æ³•è¿›è¡Œ LAMA ä¿®å¤"),O()},ee.src=P})}async function c(l,p,$){const w=$||n.settings.textStyle.fillColor||"#FFFFFF";let P;if(l.cleanImageData)P="data:image/png;base64,"+l.cleanImageData;else if(l.originalDataURL)P=l.originalDataURL;else return;return new Promise(O=>{const ee=new Image;ee.onload=()=>{const le=document.createElement("canvas");le.width=ee.naturalWidth,le.height=ee.naturalHeight;const I=le.getContext("2d");if(!I){O();return}I.drawImage(ee,0,0),I.fillStyle=w;for(const ae of p.path)I.beginPath(),I.arc(ae.x,ae.y,p.radius,0,Math.PI*2),I.fill();const q=le.toDataURL("image/png").split(",")[1];t.updateCurrentImage({cleanImageData:q}),console.log("ä¿®å¤ç¬”åˆ·åŒºåŸŸå®Œæˆï¼ˆçº¯è‰²å¡«å……ï¼‰"),O()},ee.onerror=()=>O(),ee.src=P})}async function m(){const l=t.currentImage;if(!l)return console.warn("ensureCleanBackground: æ²¡æœ‰å½“å‰å›¾ç‰‡"),!1;if(l.cleanImageData)return console.log("ensureCleanBackground: å·²æœ‰å¹²å‡€èƒŒæ™¯"),!0;const p=s?.getCurrentRepairSettings?.();if((p?.inpaintMethod||n.settings.textStyle.inpaintMethod)!=="solid")return console.log("ensureCleanBackground: éçº¯è‰²å¡«å……æ¨¡å¼ï¼Œè·³è¿‡"),!1;if(!l.bubbleStates||l.bubbleStates.length===0)return console.warn("ensureCleanBackground: æ²¡æœ‰æ°”æ³¡æ•°æ®"),!1;if(!l.translatedDataURL&&!l.originalDataURL)return console.warn("ensureCleanBackground: æ²¡æœ‰å›¾ç‰‡æ•°æ®"),!1;console.log("ensureCleanBackground: å°è¯•ä¸ºçº¯è‰²å¡«å……æ¨¡å¼åˆ›å»ºä¸´æ—¶å¹²å‡€èƒŒæ™¯");const w=l.translatedDataURL||l.originalDataURL,P=p?.fillColor||n.settings.textStyle.fillColor||"#FFFFFF";return new Promise(O=>{const ee=new Image;ee.onload=()=>{try{const le=document.createElement("canvas");le.width=ee.naturalWidth,le.height=ee.naturalHeight;const I=le.getContext("2d");if(!I){console.error("ensureCleanBackground: æ— æ³•è·å– Canvas ä¸Šä¸‹æ–‡"),O(!1);return}I.drawImage(ee,0,0),I.fillStyle=P;for(const ae of l.bubbleStates){const[T,j,ge,Se]=ae.coords;I.fillRect(T,j,ge-T+1,Se-j+1)}const q=le.toDataURL("image/png").split(",")[1];t.updateCurrentImage({cleanImageData:q}),console.log("ensureCleanBackground: æˆåŠŸåˆ›å»ºä¸´æ—¶å¹²å‡€èƒŒæ™¯ï¼ˆçº¯è‰²å¡«å……ï¼‰"),O(!0)}catch(le){console.error("ensureCleanBackground: Canvas æ“ä½œå¤±è´¥:",le),O(!1)}},ee.onerror=()=>{console.error("ensureCleanBackground: åŠ è½½å›¾åƒå¤±è´¥"),O(!1)},ee.src=w})}return Ut(()=>{Y()}),{brushMode:o,brushSize:i,isBrushKeyDown:r,isBrushPainting:a,mouseX:g,mouseY:S,isActive:R,brushColor:M,BRUSH_MIN_SIZE:Zo,BRUSH_MAX_SIZE:Go,enterBrushMode:k,exitBrushMode:Y,toggleBrushMode:V,setBrushSize:L,adjustBrushSize:v,handleBrushWheel:d,startBrushPainting:h,continueBrushPainting:y,finishBrushPainting:z,getBrushPositionInImage:F,getBrushPathBounds:te,ensureCleanBackground:m}}function sm(s){return[Math.round(s[0]),Math.round(s[1]),Math.round(s[2]),Math.round(s[3])]}function am(s){const t=gt(),n=ot(),o=Fe(),{bubbles:i,selectedIndex:r,hasSelection:a}=kt(t),{currentImage:u}=kt(n),g=C(!1),S=C(!1),x=C(null),_=C(0),D=C(0),R=C(!1);function M(I){t.selectBubble(I)}function k(I){t.toggleMultiSelect(I)}function Y(){t.clearMultiSelect()}function V(I,q){console.log(`å¼€å§‹æ‹–åŠ¨æ°”æ³¡ #${I+1}`)}function L(I,q){}function v(I,q){t.updateBubble(I,{coords:q}),console.log(`æ°”æ³¡ #${I+1} æ‹–åŠ¨å®Œæˆ:`,q),$()}function d(I,q,ae){console.log(`å¼€å§‹è°ƒæ•´æ°”æ³¡ #${I+1} å¤§å°ï¼Œæ‰‹æŸ„: ${q}`)}function h(I){}function y(I,q){t.updateBubble(I,{coords:q}),console.log(`æ°”æ³¡ #${I+1} è°ƒæ•´å¤§å°å®Œæˆ:`,q),$()}function z(I,q){console.log(`å¼€å§‹æ—‹è½¬æ°”æ³¡ #${I+1}`)}function F(I){}function te(I,q){t.updateBubble(I,{rotationAngle:q}),console.log(`æ°”æ³¡ #${I+1} æ—‹è½¬å®Œæˆ: ${q}Â°`),$()}function J(){g.value=!g.value,g.value?console.log("è¿›å…¥ç»˜åˆ¶æ¨¡å¼"):console.log("é€€å‡ºç»˜åˆ¶æ¨¡å¼")}function K(I){t.addBubble(I),t.selectBubble(t.bubbleCount-1),console.log("å·²æ·»åŠ æ–°æ°”æ³¡:",I),s?.onReRender?.()}function Z(I,q){S.value=!0,_.value=I,D.value=q,x.value=[I,q,I,q]}function W(I,q){S.value&&(x.value=[_.value,D.value,I,q])}function oe(){if(!S.value||!x.value)return S.value=!1,x.value=null,null;const[I,q,ae,T]=x.value,j=10;if(Math.abs(ae-I)<j||Math.abs(T-q)<j)return S.value=!1,x.value=null,null;const ge=[Math.min(I,ae),Math.min(q,T),Math.max(I,ae),Math.max(q,T)];return S.value=!1,x.value=null,ge}function b(){S.value=!1,x.value=null,g.value=!1}function c(){if(!x.value)return{};const[I,q,ae,T]=x.value;return{position:"absolute",left:`${Math.min(I,ae)}px`,top:`${Math.min(q,T)}px`,width:`${Math.abs(ae-I)}px`,height:`${Math.abs(T-q)}px`,border:"2px dashed #00d4ff",background:"rgba(0, 212, 255, 0.1)",pointerEvents:"none",zIndex:"25",boxSizing:"border-box"}}let m=null,l=!1;const p=150;function $(){m&&clearTimeout(m),m=setTimeout(async()=>{if(l){console.log("è·³è¿‡æ¸²æŸ“ï¼Œä¸Šä¸€æ¬¡æ¸²æŸ“ä»åœ¨è¿›è¡Œä¸­");return}console.log("è§¦å‘å»¶è¿Ÿæ¸²æŸ“é¢„è§ˆ"),l=!0;try{s?.onDelayedPreview?await s.onDelayedPreview():s?.onReRender&&await s.onReRender()}catch(I){console.error("å»¶è¿Ÿæ¸²æŸ“é¢„è§ˆå¤±è´¥:",I)}finally{l=!1}},p)}function w(I){t.updateSelectedBubble(I),$()}function P(){a.value&&(t.deleteSelected(),console.log("å·²åˆ é™¤é€‰ä¸­çš„æ°”æ³¡"),s?.onReRender?.())}async function O(){const I=r.value;if(I<0){console.warn("è¯·å…ˆé€‰ä¸­è¦ä¿®å¤çš„æ°”æ³¡æ¡†");return}const q=i.value[I],ae=u.value;if(!q||!ae?.originalDataURL){console.warn("æ— æ³•ä¿®å¤èƒŒæ™¯ï¼šç¼ºå°‘æ°”æ³¡æˆ–å›¾ç‰‡æ•°æ®");return}const T=q.inpaintMethod||"solid",j=q.fillColor||"#FFFFFF",ge=q.rotationAngle||0;try{console.log(`å¼€å§‹ä¿®å¤æ°”æ³¡ #${I+1} èƒŒæ™¯ï¼Œæ–¹æ³•: ${T}`);let Se;if(ae.cleanImageData)Se=ae.cleanImageData;else{const we=ae.originalDataURL.match(/^data:image\/[^;]+;base64,(.+)$/);if(Se=we&&we[1]?we[1]:"",!Se){console.error("æ— æ³•è§£æå›¾åƒæ•°æ®");return}}if(T==="lama_mpe"||T==="litelama"){const we=T==="litelama"?"litelama":"lama_mpe",be=sm(q.coords),X=await ho(Se,be,{bubbleAngle:ge,method:"lama",lamaModel:we});X.success&&X.inpainted_image?(n.updateCurrentImage({cleanImageData:X.inpainted_image}),console.log(`æ°”æ³¡ #${I+1} LAMAèƒŒæ™¯ä¿®å¤æˆåŠŸ`),$()):(console.error("LAMAä¿®å¤å¤±è´¥:",X.error||"æœªçŸ¥é”™è¯¯"),await ee(q.coords,j,ge),$())}else await ee(q.coords,j,ge),console.log(`æ°”æ³¡ #${I+1} çº¯è‰²å¡«å……ä¿®å¤æˆåŠŸ`),$()}catch(Se){console.error("èƒŒæ™¯ä¿®å¤å‡ºé”™:",Se)}}async function ee(I,q,ae=0){const T=u.value;if(!T)return;const[j,ge,Se,Re]=I;let we;if(T.cleanImageData)we="data:image/png;base64,"+T.cleanImageData;else if(T.originalDataURL)we=T.originalDataURL;else{console.error("æ— æ³•æ‰¾åˆ°åŸºç¡€å›¾åƒç”¨äºå¡«å……");return}return new Promise(be=>{const X=new Image;X.onload=()=>{const f=document.createElement("canvas");f.width=X.naturalWidth,f.height=X.naturalHeight;const N=f.getContext("2d");if(!N){be();return}if(N.drawImage(X,0,0),N.fillStyle=q,Math.abs(ae)<.1)N.fillRect(j,ge,Se-j,Re-ge);else{const me=(j+Se)/2,B=(ge+Re)/2,G=(Se-j)/2,ve=(Re-ge)/2,ce=ae*Math.PI/180,$e=Math.cos(ce),De=Math.sin(ce),Ae=[[-G,-ve],[G,-ve],[G,ve],[-G,ve]].map(([Me,he])=>[me+Me*$e-he*De,B+Me*De+he*$e]);N.beginPath();const Ce=Ae[0];if(Ce){N.moveTo(Ce[0],Ce[1]);for(let Me=1;Me<Ae.length;Me++){const he=Ae[Me];he&&N.lineTo(he[0],he[1])}}N.closePath(),N.fill()}const pe=f.toDataURL("image/png").split(",")[1];n.updateCurrentImage({cleanImageData:pe}),console.log("å·²å¯¹æ°”æ³¡åŒºåŸŸè¿›è¡Œçº¯è‰²å¡«å……:",I,q,"è§’åº¦:",ae),be()},X.onerror=()=>{console.error("åŠ è½½åŸºç¡€å›¾åƒå¤±è´¥"),be()},X.src=we})}async function le(I){const q=i.value[I],ae=u.value;if(!q||!ae?.originalDataURL){console.warn("æ— æ³•è¿›è¡Œ OCR è¯†åˆ«ï¼šç¼ºå°‘æ°”æ³¡æˆ–å›¾ç‰‡æ•°æ®");return}try{console.log(`å¼€å§‹ OCR è¯†åˆ«æ°”æ³¡ #${I+1}`);const T=ae.originalDataURL.split(",")[1]||"",j=o.settings,ge=j.ocrEngine==="paddleocr_vl"?j.paddleOcrVl?.sourceLanguage||"japanese":j.sourceLanguage,Se=await yn(T,q.coords,j.ocrEngine||"manga_ocr",{source_language:ge,baidu_ocr_api_key:j.baiduOcr.apiKey,baidu_ocr_secret_key:j.baiduOcr.secretKey,baidu_version:j.baiduOcr.version,baidu_source_language:j.baiduOcr.sourceLanguage,ai_vision_provider:j.aiVisionOcr.provider,ai_vision_api_key:j.aiVisionOcr.apiKey,ai_vision_model_name:j.aiVisionOcr.modelName,ai_vision_ocr_prompt:j.aiVisionOcr.prompt,custom_ai_vision_base_url:j.aiVisionOcr.customBaseUrl,ai_vision_min_image_size:j.aiVisionOcr.minImageSize});Se.success&&Se.text!==void 0?(t.updateBubble(I,{originalText:Se.text}),console.log(`OCR è¯†åˆ«æˆåŠŸ: "${Se.text}"`)):console.error("OCR è¯†åˆ«å¤±è´¥:",Se.error||"æœªçŸ¥é”™è¯¯")}catch(T){console.error("OCR è¯†åˆ«å‡ºé”™:",T)}}return{isDrawingMode:g,isDrawingBox:S,currentDrawingRect:x,isMiddleButtonDown:R,handleBubbleSelect:M,handleBubbleMultiSelect:k,handleClearMultiSelect:Y,handleBubbleDragStart:V,handleBubbleDragging:L,handleBubbleDragEnd:v,handleBubbleResizeStart:d,handleBubbleResizing:h,handleBubbleResizeEnd:y,handleBubbleRotateStart:z,handleBubbleRotating:F,handleBubbleRotateEnd:te,toggleDrawingMode:J,handleDrawBubble:K,startDrawingBox:Z,updateDrawingBox:W,finishDrawingBox:oe,cancelDrawing:b,getDrawingRectStyle:c,handleBubbleUpdate:w,deleteSelectedBubbles:P,repairSelectedBubble:O,triggerDelayedPreview:$,handleOcrRecognize:le}}function lm(s){const t=gt(),n=ot(),{bubbles:o}=kt(t),{currentImage:i}=kt(n),r=C(!1),a=C("");let u=null;function g(){const _=i.value;if(!_)return null;if(_.cleanImageData)return _.cleanImageData;if(_.originalDataURL){const D=_.originalDataURL.match(/^data:image\/[^;]+;base64,(.+)$/);if(D&&D[1])return D[1]}return null}async function S(_=!1){if(!i.value)return console.warn("reRenderFullImage: æ²¡æœ‰å½“å‰å›¾ç‰‡"),!1;if(o.value.length===0){console.log("reRenderFullImage: æ²¡æœ‰æ°”æ³¡ï¼Œè·³è¿‡åç«¯æ¸²æŸ“");const k=g();if(k){const Y=`data:image/png;base64,${k}`;n.updateCurrentImage({translatedDataURL:Y}),_||s?.onRenderSuccess?.(Y)}return!0}const R=g();if(!R)return console.error("reRenderFullImage: ç¼ºå°‘å›¾åƒæ•°æ®"),a.value="ç¼ºå°‘å›¾åƒæ•°æ®",_||s?.onRenderError?.("ç¼ºå°‘å›¾åƒæ•°æ®"),!1;const M=Symbol("render");u=M,r.value=!0,a.value="",_||s?.onRenderStart?.();try{console.log("reRenderFullImage: å¼€å§‹é‡æ–°æ¸²æŸ“ï¼Œæ°”æ³¡æ•°é‡:",o.value.length);const k=o.value,Y=k.map(d=>d.translatedText||""),V=k.map(d=>d.coords.map(h=>Math.round(h))),L=k.map(d=>({translatedText:d.translatedText||"",coords:d.coords,fontSize:Number(d.fontSize)||24,fontFamily:d.fontFamily||xt,textDirection:At(d),textColor:d.textColor||"#231816",rotationAngle:Math.round(Number(d.rotationAngle)||0),position:d.position?{x:Math.round(d.position.x||0),y:Math.round(d.position.y||0)}:{x:0,y:0},strokeEnabled:d.strokeEnabled!==void 0?d.strokeEnabled:!0,strokeColor:d.strokeColor||"#FFFFFF",strokeWidth:Number(d.strokeWidth)||3})),v=await bo({clean_image:R,bubble_texts:Y,bubble_coords:V,bubble_states:L,fontSize:Number(k[0]?.fontSize)||24,fontFamily:k[0]?.fontFamily||xt,textDirection:k[0]?At(k[0]):"vertical",textColor:k[0]?.textColor||"#231816",strokeEnabled:k[0]?.strokeEnabled!==void 0?k[0].strokeEnabled:!0,strokeColor:k[0]?.strokeColor||"#FFFFFF",strokeWidth:Number(k[0]?.strokeWidth)||3,use_individual_styles:!0,use_inpainting:!1,use_lama:!1,is_font_style_change:!0});if(u!==M)return console.log("reRenderFullImage: æ¸²æŸ“ç»“æœå·²è¿‡æœŸï¼Œå¿½ç•¥"),!1;if(v.rendered_image){const d=`data:image/png;base64,${v.rendered_image}`;return n.updateCurrentImage({translatedDataURL:d}),console.log("reRenderFullImage: æ¸²æŸ“æˆåŠŸ"),_||s?.onRenderSuccess?.(d),!0}else{const d=v.error||"æ¸²æŸ“å¤±è´¥";return console.error("reRenderFullImage: æ¸²æŸ“å¤±è´¥ -",d),a.value=d,_||s?.onRenderError?.(d),!1}}catch(k){if(u!==M)return!1;const Y=k instanceof Error?k.message:"æ¸²æŸ“è¯·æ±‚å¤±è´¥";return console.error("reRenderFullImage: æ¸²æŸ“å‡ºé”™ -",k),a.value=Y,_||s?.onRenderError?.(Y),!1}finally{u===M&&(r.value=!1,_||s?.onRenderEnd?.())}}function x(){u=null,r.value=!1}return{isRendering:r,renderError:a,reRenderFullImage:S,cancelRender:x}}const im=["data-index","data-coords","data-rotation","onClick","onMousedown"],rm={class:"bubble-index"},um=["data-parent-index","onMousedown"],cm=["data-parent-index","onMousedown"],dm=["data-parent-index","onMousedown"],gm=["data-parent-index","onMousedown"],pm=["data-parent-index","onMousedown"],mm=["data-parent-index","onMousedown"],vm=["data-parent-index","onMousedown"],fm=["data-parent-index","onMousedown"],bm=["data-parent-index","onMousedown"],hm=Ye({__name:"BubbleOverlay",props:{bubbles:{},selectedIndex:{},selectedIndices:{},scale:{},isDrawingMode:{type:Boolean},isBrushMode:{type:Boolean},imageWidth:{},imageHeight:{}},emits:["select","multiSelect","dragStart","dragging","dragEnd","resizeStart","resizing","resizeEnd","rotateStart","rotating","rotateEnd","drawBubble"],setup(s,{emit:t}){const n=gt(),{isDragging:o,draggingIndex:i,dragOffsetX:r,dragOffsetY:a,dragInitialX:u,dragInitialY:g,isResizing:S,resizingIndex:x,resizeCurrentCoords:_,isRotating:D,rotatingIndex:R,rotateCurrentAngle:M}=kt(n),k=s,Y=t,V=C(null),L=C(0),v=C(0),d=C(""),h=C(0),y=C(0),z=C(null),F=C(0),te=C(0),J=C(0),K=C(0),Z=C(!1),W=C(0),oe=C(0),b=C(null),c=C(!1);function m(f,N){let pe,me,B,G,ve=f.rotationAngle||0;if(o.value&&i.value===N){const[Ae,Ce,Me,he]=f.coords;pe=u.value+r.value,me=g.value+a.value,B=pe+(Me-Ae),G=me+(he-Ce)}else S.value&&x.value===N&&_.value?[pe,me,B,G]=_.value:D.value&&R.value===N?([pe,me,B,G]=f.coords,ve=M.value):[pe,me,B,G]=f.coords;const ce=B-pe,$e=G-me,De={left:`${pe}px`,top:`${me}px`,width:`${ce}px`,height:`${$e}px`};return ve&&(De.transformOrigin="center center",De.transform=`rotate(${ve}deg)`),De}function l(){if(!b.value)return{};const[f,N,pe,me]=b.value;return{left:`${Math.min(f,pe)}px`,top:`${Math.min(N,me)}px`,width:`${Math.abs(pe-f)}px`,height:`${Math.abs(me-N)}px`}}function p(f){if(!V.value)return null;const N=V.value.getBoundingClientRect(),pe=k.scale||1,me=(f.clientX-N.left)/pe,B=(f.clientY-N.top)/pe;return{x:me,y:B}}function $(f,N){k.isBrushMode||N.shiftKey||Y("select",f)}function w(f){if(!k.isBrushMode){if(f.button===1){f.preventDefault(),c.value=!0,document.body.classList.add("middle-button-drawing"),Se(f);return}f.button===0&&k.isDrawingMode&&Se(f)}}function P(f,N){if(!k.isBrushMode&&N.button===0){if(N.preventDefault(),N.stopPropagation(),N.shiftKey){Y("multiSelect",f);return}if(f!==k.selectedIndex){Y("select",f);return}O(f,N)}}function O(f,N){document.removeEventListener("mousemove",be),document.removeEventListener("mouseup",X),o.value=!0,i.value=f,L.value=N.clientX,v.value=N.clientY,r.value=0,a.value=0;const pe=k.bubbles[f];pe&&(u.value=pe.coords[0],g.value=pe.coords[1]),Y("dragStart",f,N),document.addEventListener("mousemove",be),document.addEventListener("mouseup",X)}function ee(f){const N=k.scale||1,pe=(f.clientX-L.value)/N,me=(f.clientY-v.value)/N;r.value=pe,a.value=me}function le(f){const N=i.value;o.value=!1,i.value=-1,r.value=0,a.value=0;const pe=k.scale||1,me=(f.clientX-L.value)/pe,B=(f.clientY-v.value)/pe,G=k.bubbles[N];if(!G)return;const[ve,ce,$e,De]=G.coords,Ae=$e-ve,Ce=De-ce;let Me=Math.round(u.value+me),he=Math.round(g.value+B);const lt=k.imageWidth||2e3,Xe=k.imageHeight||2e3,Ge=Math.min(Ae,lt),st=Math.min(Ce,Xe);Me=Math.max(0,Math.min(Me,lt-Ge)),he=Math.max(0,Math.min(he,Xe-st));const Be=[Me,he,Me+Ge,he+st];Y("dragEnd",N,Be)}function I(f,N,pe){if(k.isBrushMode||pe.button!==0)return;pe.preventDefault(),pe.stopPropagation(),document.removeEventListener("mousemove",be),document.removeEventListener("mouseup",X),S.value=!0,x.value=N,d.value=f,h.value=pe.clientX,y.value=pe.clientY;const me=k.bubbles[N];me&&(z.value=[...me.coords],_.value=[...me.coords]),Y("resizeStart",N,f,pe),document.addEventListener("mousemove",be),document.addEventListener("mouseup",X)}function q(f){if(!z.value)return;const N=k.scale||1,pe=(f.clientX-h.value)/N,me=(f.clientY-y.value)/N;let[B,G,ve,ce]=z.value;const $e=d.value;$e.includes("w")&&(B+=pe),$e.includes("e")&&(ve+=pe),$e.includes("n")&&(G+=me),$e.includes("s")&&(ce+=me),B>ve&&([B,ve]=[ve,B]),G>ce&&([G,ce]=[ce,G]);const De=10;ve-B<De||ce-G<De||(_.value=[B,G,ve,ce])}function ae(f){if(!z.value)return;const N=k.scale||1,pe=(f.clientX-h.value)/N,me=(f.clientY-y.value)/N;let[B,G,ve,ce]=z.value;const $e=d.value;$e.includes("w")&&(B+=pe),$e.includes("e")&&(ve+=pe),$e.includes("n")&&(G+=me),$e.includes("s")&&(ce+=me),B>ve&&([B,ve]=[ve,B]),G>ce&&([G,ce]=[ce,G]);const De=k.imageWidth||2e3,Ae=k.imageHeight||2e3;B=Math.max(0,Math.round(B)),G=Math.max(0,Math.round(G)),ve=Math.min(De,Math.round(ve)),ce=Math.min(Ae,Math.round(ce));const Ce=10;if(ve-B<Ce||ce-G<Ce){console.warn("è°ƒæ•´åå°ºå¯¸è¿‡å°ï¼Œå·²æ’¤é”€"),S.value=!1,x.value=-1,z.value=null;return}Y("resizeEnd",x.value,[B,G,ve,ce]),S.value=!1,x.value=-1,z.value=null,_.value=null}function T(f,N){if(k.isBrushMode||N.button!==0)return;N.preventDefault(),N.stopPropagation(),document.removeEventListener("mousemove",be),document.removeEventListener("mouseup",X),D.value=!0,R.value=f;const pe=k.bubbles[f];if(!pe||!V.value)return;const[me,B,G,ve]=pe.coords,ce=k.scale||1,$e=V.value.getBoundingClientRect();J.value=$e.left+(me+G)/2*ce,K.value=$e.top+(B+ve)/2*ce;const De=N.clientX-J.value,Ae=N.clientY-K.value;F.value=Math.atan2(Ae,De)*180/Math.PI,te.value=pe.rotationAngle||0,M.value=pe.rotationAngle||0,Y("rotateStart",f,N),document.body.classList.add("rotating-box"),document.addEventListener("mousemove",be),document.addEventListener("mouseup",X),console.log(`å¼€å§‹æ—‹è½¬æ°”æ³¡ #${f+1}ï¼Œåˆå§‹è§’åº¦: ${te.value}Â°`)}function j(f){const N=f.clientX-J.value,pe=f.clientY-K.value,B=Math.atan2(pe,N)*180/Math.PI-F.value;let G=te.value+B;for(;G>180;)G-=360;for(;G<-180;)G+=360;f.shiftKey&&(G=Math.round(G/15)*15),M.value=G}function ge(f){document.body.classList.remove("rotating-box");const N=R.value,pe=M.value;Y("rotateEnd",N,pe),D.value=!1,R.value=-1,console.log(`æ°”æ³¡ #${N+1} æ—‹è½¬å®Œæˆï¼Œè§’åº¦: ${pe}Â°`)}function Se(f){const N=p(f);if(!N)return;const pe=k.imageWidth||2e3,me=k.imageHeight||2e3;N.x<0||N.x>pe||N.y<0||N.y>me||(Z.value=!0,W.value=N.x,oe.value=N.y,b.value=[N.x,N.y,N.x,N.y],document.addEventListener("mousemove",be),document.addEventListener("mouseup",X),console.log("å¼€å§‹ç»˜åˆ¶æ–°æ¡†:",N.x.toFixed(1),N.y.toFixed(1)))}function Re(f){const N=p(f);!N||!b.value||(b.value=[W.value,oe.value,N.x,N.y])}function we(f){const N=p(f);if(c.value&&(c.value=!1,document.body.classList.remove("middle-button-drawing")),!N||!b.value){Z.value=!1,b.value=null;return}const pe=k.imageWidth||2e3,me=k.imageHeight||2e3,B=Math.max(0,Math.round(Math.min(W.value,N.x))),G=Math.max(0,Math.round(Math.min(oe.value,N.y))),ve=Math.min(pe,Math.round(Math.max(W.value,N.x))),ce=Math.min(me,Math.round(Math.max(oe.value,N.y))),$e=10;if(ve-B<$e||ce-G<$e){console.log("ç»˜åˆ¶çš„æ¡†å¤ªå°ï¼Œå·²å¿½ç•¥"),Z.value=!1,b.value=null;return}console.log("å®Œæˆç»˜åˆ¶æ–°æ¡†:",[B,G,ve,ce]),Y("drawBubble",[B,G,ve,ce]),Z.value=!1,b.value=null}function be(f){o.value?ee(f):S.value?q(f):D.value?j(f):Z.value&&Re(f)}function X(f){document.removeEventListener("mousemove",be),document.removeEventListener("mouseup",X),(f.button===1||c.value)&&(c.value=!1,document.body.classList.remove("middle-button-drawing")),o.value?le(f):S.value?ae(f):D.value?ge():Z.value&&we(f)}return dt(()=>{}),Ut(()=>{document.removeEventListener("mousemove",be),document.removeEventListener("mouseup",X),document.body.classList.remove("middle-button-drawing"),document.body.classList.remove("rotating-box")}),(f,N)=>(A(),U("div",{class:Ee(["bubble-overlay",{"brush-mode":s.isBrushMode}]),style:at({"--scale":s.scale||1}),ref_key:"overlayRef",ref:V,onMousedown:w},[(A(!0),U(We,null,Qe(s.bubbles,(pe,me)=>(A(),U("div",{key:me,class:Ee(["bubble-highlight-box",{selected:me===s.selectedIndex,"multi-selected":s.selectedIndices.length>1&&s.selectedIndices.includes(me)&&me!==s.selectedIndex}]),style:at(m(pe,me)),"data-index":me,"data-coords":JSON.stringify(pe.coords),"data-rotation":pe.rotationAngle||0,onClick:it(B=>$(me,B),["stop"]),onMousedown:it(B=>P(me,B),["stop"])},[e("span",rm,se(me+1),1),me===s.selectedIndex?(A(),U(We,{key:0},[e("div",{class:"resize-handle nw","data-handle":"nw","data-parent-index":me,onMousedown:it(B=>I("nw",me,B),["stop"])},null,40,um),e("div",{class:"resize-handle n","data-handle":"n","data-parent-index":me,onMousedown:it(B=>I("n",me,B),["stop"])},null,40,cm),e("div",{class:"resize-handle ne","data-handle":"ne","data-parent-index":me,onMousedown:it(B=>I("ne",me,B),["stop"])},null,40,dm),e("div",{class:"resize-handle e","data-handle":"e","data-parent-index":me,onMousedown:it(B=>I("e",me,B),["stop"])},null,40,gm),e("div",{class:"resize-handle se","data-handle":"se","data-parent-index":me,onMousedown:it(B=>I("se",me,B),["stop"])},null,40,pm),e("div",{class:"resize-handle s","data-handle":"s","data-parent-index":me,onMousedown:it(B=>I("s",me,B),["stop"])},null,40,mm),e("div",{class:"resize-handle sw","data-handle":"sw","data-parent-index":me,onMousedown:it(B=>I("sw",me,B),["stop"])},null,40,vm),e("div",{class:"resize-handle w","data-handle":"w","data-parent-index":me,onMousedown:it(B=>I("w",me,B),["stop"])},null,40,fm),N[0]||(N[0]=e("div",{class:"rotate-line"},null,-1)),e("div",{class:"rotate-handle",title:"æ‹–æ‹½æ—‹è½¬","data-parent-index":me,onMousedown:it(B=>T(me,B),["stop"])},null,40,bm)],64)):fe("",!0)],46,im))),128)),b.value?(A(),U("div",{key:0,class:"drawing-rect",style:at(l())},null,4)):fe("",!0)],38))}}),pn=je(hm,[["__scopeId","data-v-8d9cb1b9"]]),ym={key:0,class:"kana-keyboard"},xm={class:"kana-keyboard-header"},Sm={class:"kana-keyboard-tabs"},_m=["onClick"],Cm={class:"kana-keyboard-options"},km={class:"kana-mode-select"},wm={class:"kana-target-select"},Tm={class:"kana-table"},$m={class:"row-label"},Im=["onClick"],Rm={class:"kana-hiragana"},Pm={class:"kana-katakana"},Dm={class:"kana-table"},Mm={class:"row-label"},Bm=["onClick"],Em={class:"kana-hiragana"},Am={class:"kana-katakana"},Lm={class:"kana-table combo-table"},Fm={class:"row-label"},Um=["onClick"],zm={class:"kana-hiragana"},Om={class:"kana-katakana"},Vm={class:"special-chars-grid"},Nm=["onClick"],Wm={key:0,class:"char-label"},qm=Ye({__name:"JapaneseKeyboard",props:{visible:{type:Boolean,default:!1},defaultTarget:{default:"original"}},emits:["close","insert","delete"],setup(s,{emit:t}){const n=s,o=t,i=C("basic"),r=C("hiragana"),a=C(n.defaultTarget),u=C(null),g=[{label:"åŸæ–‡",value:"original"},{label:"è¯‘æ–‡",value:"translated"}],S=[{id:"basic",label:"åŸºæœ¬"},{id:"dakuten",label:"æµŠ/åŠæµŠéŸ³"},{id:"combo",label:"æ‹—éŸ³"},{id:"special",label:"ç‰¹æ®Š"}],x=[{label:"ã‚è¡Œ",chars:[{h:"ã‚",k:"ã‚¢"},{h:"ã„",k:"ã‚¤"},{h:"ã†",k:"ã‚¦"},{h:"ãˆ",k:"ã‚¨"},{h:"ãŠ",k:"ã‚ª"}]},{label:"ã‹è¡Œ",chars:[{h:"ã‹",k:"ã‚«"},{h:"ã",k:"ã‚­"},{h:"ã",k:"ã‚¯"},{h:"ã‘",k:"ã‚±"},{h:"ã“",k:"ã‚³"}]},{label:"ã•è¡Œ",chars:[{h:"ã•",k:"ã‚µ"},{h:"ã—",k:"ã‚·"},{h:"ã™",k:"ã‚¹"},{h:"ã›",k:"ã‚»"},{h:"ã",k:"ã‚½"}]},{label:"ãŸè¡Œ",chars:[{h:"ãŸ",k:"ã‚¿"},{h:"ã¡",k:"ãƒ"},{h:"ã¤",k:"ãƒ„"},{h:"ã¦",k:"ãƒ†"},{h:"ã¨",k:"ãƒˆ"}]},{label:"ãªè¡Œ",chars:[{h:"ãª",k:"ãƒŠ"},{h:"ã«",k:"ãƒ‹"},{h:"ã¬",k:"ãƒŒ"},{h:"ã­",k:"ãƒ"},{h:"ã®",k:"ãƒ"}]},{label:"ã¯è¡Œ",chars:[{h:"ã¯",k:"ãƒ"},{h:"ã²",k:"ãƒ’"},{h:"ãµ",k:"ãƒ•"},{h:"ã¸",k:"ãƒ˜"},{h:"ã»",k:"ãƒ›"}]},{label:"ã¾è¡Œ",chars:[{h:"ã¾",k:"ãƒ"},{h:"ã¿",k:"ãƒŸ"},{h:"ã‚€",k:"ãƒ "},{h:"ã‚",k:"ãƒ¡"},{h:"ã‚‚",k:"ãƒ¢"}]},{label:"ã‚„è¡Œ",chars:[{h:"ã‚„",k:"ãƒ¤"},null,{h:"ã‚†",k:"ãƒ¦"},null,{h:"ã‚ˆ",k:"ãƒ¨"}]},{label:"ã‚‰è¡Œ",chars:[{h:"ã‚‰",k:"ãƒ©"},{h:"ã‚Š",k:"ãƒª"},{h:"ã‚‹",k:"ãƒ«"},{h:"ã‚Œ",k:"ãƒ¬"},{h:"ã‚",k:"ãƒ­"}]},{label:"ã‚è¡Œ",chars:[{h:"ã‚",k:"ãƒ¯"},null,null,null,{h:"ã‚’",k:"ãƒ²"}]},{label:"ã‚“",chars:[{h:"ã‚“",k:"ãƒ³"},null,null,null,null]}],_=[{label:"ãŒè¡Œ",chars:[{h:"ãŒ",k:"ã‚¬"},{h:"ã",k:"ã‚®"},{h:"ã",k:"ã‚°"},{h:"ã’",k:"ã‚²"},{h:"ã”",k:"ã‚´"}]},{label:"ã–è¡Œ",chars:[{h:"ã–",k:"ã‚¶"},{h:"ã˜",k:"ã‚¸"},{h:"ãš",k:"ã‚º"},{h:"ãœ",k:"ã‚¼"},{h:"ã",k:"ã‚¾"}]},{label:"ã è¡Œ",chars:[{h:"ã ",k:"ãƒ€"},{h:"ã¢",k:"ãƒ‚"},{h:"ã¥",k:"ãƒ…"},{h:"ã§",k:"ãƒ‡"},{h:"ã©",k:"ãƒ‰"}]},{label:"ã°è¡Œ",chars:[{h:"ã°",k:"ãƒ"},{h:"ã³",k:"ãƒ“"},{h:"ã¶",k:"ãƒ–"},{h:"ã¹",k:"ãƒ™"},{h:"ã¼",k:"ãƒœ"}]},{label:"ã±è¡Œ",chars:[{h:"ã±",k:"ãƒ‘"},{h:"ã´",k:"ãƒ”"},{h:"ã·",k:"ãƒ—"},{h:"ãº",k:"ãƒš"},{h:"ã½",k:"ãƒ"}]}],D=[{label:"ãã‚ƒè¡Œ",chars:[{h:"ãã‚ƒ",k:"ã‚­ãƒ£"},{h:"ãã‚…",k:"ã‚­ãƒ¥"},{h:"ãã‚‡",k:"ã‚­ãƒ§"}]},{label:"ã—ã‚ƒè¡Œ",chars:[{h:"ã—ã‚ƒ",k:"ã‚·ãƒ£"},{h:"ã—ã‚…",k:"ã‚·ãƒ¥"},{h:"ã—ã‚‡",k:"ã‚·ãƒ§"}]},{label:"ã¡ã‚ƒè¡Œ",chars:[{h:"ã¡ã‚ƒ",k:"ãƒãƒ£"},{h:"ã¡ã‚…",k:"ãƒãƒ¥"},{h:"ã¡ã‚‡",k:"ãƒãƒ§"}]},{label:"ã«ã‚ƒè¡Œ",chars:[{h:"ã«ã‚ƒ",k:"ãƒ‹ãƒ£"},{h:"ã«ã‚…",k:"ãƒ‹ãƒ¥"},{h:"ã«ã‚‡",k:"ãƒ‹ãƒ§"}]},{label:"ã²ã‚ƒè¡Œ",chars:[{h:"ã²ã‚ƒ",k:"ãƒ’ãƒ£"},{h:"ã²ã‚…",k:"ãƒ’ãƒ¥"},{h:"ã²ã‚‡",k:"ãƒ’ãƒ§"}]},{label:"ã¿ã‚ƒè¡Œ",chars:[{h:"ã¿ã‚ƒ",k:"ãƒŸãƒ£"},{h:"ã¿ã‚…",k:"ãƒŸãƒ¥"},{h:"ã¿ã‚‡",k:"ãƒŸãƒ§"}]},{label:"ã‚Šã‚ƒè¡Œ",chars:[{h:"ã‚Šã‚ƒ",k:"ãƒªãƒ£"},{h:"ã‚Šã‚…",k:"ãƒªãƒ¥"},{h:"ã‚Šã‚‡",k:"ãƒªãƒ§"}]},{label:"ãã‚ƒè¡Œ",chars:[{h:"ãã‚ƒ",k:"ã‚®ãƒ£"},{h:"ãã‚…",k:"ã‚®ãƒ¥"},{h:"ãã‚‡",k:"ã‚®ãƒ§"}]},{label:"ã˜ã‚ƒè¡Œ",chars:[{h:"ã˜ã‚ƒ",k:"ã‚¸ãƒ£"},{h:"ã˜ã‚…",k:"ã‚¸ãƒ¥"},{h:"ã˜ã‚‡",k:"ã‚¸ãƒ§"}]},{label:"ã³ã‚ƒè¡Œ",chars:[{h:"ã³ã‚ƒ",k:"ãƒ“ãƒ£"},{h:"ã³ã‚…",k:"ãƒ“ãƒ¥"},{h:"ã³ã‚‡",k:"ãƒ“ãƒ§"}]},{label:"ã´ã‚ƒè¡Œ",chars:[{h:"ã´ã‚ƒ",k:"ãƒ”ãƒ£"},{h:"ã´ã‚…",k:"ãƒ”ãƒ¥"},{h:"ã´ã‚‡",k:"ãƒ”ãƒ§"}]}],R=[{char:"ã£",label:"ä¿ƒéŸ³"},{char:"ãƒƒ",label:"ä¿ƒéŸ³"},{char:"ãƒ¼",label:"é•¿éŸ³"},{char:"ã€œ",label:"æ³¢æµª"},{char:"ã€‚",label:"å¥å·"},{char:"ã€",label:"é¡¿å·"},{char:"ã€Œ",label:"å¼•å·"},{char:"ã€",label:"å¼•å·"},{char:"ã€",label:"åŒå¼•"},{char:"ã€",label:"åŒå¼•"},{char:"â€¦",label:"çœç•¥"},{char:"ãƒ»",label:"ä¸­ç‚¹"},{char:"ï¼",label:"æ„Ÿå¹"},{char:"ï¼Ÿ",label:"é—®å·"},{char:"â™ª",label:"éŸ³ç¬¦"},{char:"â™¡",label:"å¿ƒå½¢"},{char:"â˜…",label:"æ˜Ÿå½¢"},{char:"â˜†",label:"ç©ºæ˜Ÿ"},{char:"ã",label:"å°ã‚"},{char:"ãƒ",label:"å°ã„"},{char:"ã…",label:"å°ã†"},{char:"ã‡",label:"å°ãˆ"},{char:"ã‰",label:"å°ãŠ"},{char:"ã‚¡",label:"å°ã‚¢"},{char:"ã‚£",label:"å°ã‚¤"},{char:"ã‚¥",label:"å°ã‚¦"},{char:"ã‚§",label:"å°ã‚¨"},{char:"ã‚©",label:"å°ã‚ª"},{char:"ã‚ƒ",label:"å°ã‚„"},{char:"ã‚…",label:"å°ã‚†"},{char:"ã‚‡",label:"å°ã‚ˆ"},{char:"ãƒ£",label:"å°ãƒ¤"},{char:"ãƒ¥",label:"å°ãƒ¦"},{char:"ãƒ§",label:"å°ãƒ¨"}];function M(){o("close")}function k(L){const v=r.value==="hiragana"?L.h:L.k;u.value=L.h,setTimeout(()=>{u.value=null},100),o("insert",v,a.value)}function Y(L){u.value=L,setTimeout(()=>{u.value=null},100),o("insert",L,a.value)}function V(){o("delete",a.value)}return(L,v)=>s.visible?(A(),U("div",ym,[e("div",xm,[v[3]||(v[3]=e("span",{class:"kana-keyboard-title"},"50éŸ³é”®ç›˜",-1)),e("div",Sm,[(A(),U(We,null,Qe(S,d=>e("button",{key:d.id,class:Ee(["kana-tab",{active:i.value===d.id}]),onClick:h=>i.value=d.id},se(d.label),11,_m)),64))]),e("button",{class:"kana-keyboard-close",onClick:M},"âœ•")]),e("div",Cm,[e("div",km,[e("label",null,[ne(e("input",{type:"radio",name:"kanaMode",value:"hiragana","onUpdate:modelValue":v[0]||(v[0]=d=>r.value=d)},null,512),[[nn,r.value]]),v[4]||(v[4]=Ue(" å¹³å‡å ",-1))]),e("label",null,[ne(e("input",{type:"radio",name:"kanaMode",value:"katakana","onUpdate:modelValue":v[1]||(v[1]=d=>r.value=d)},null,512),[[nn,r.value]]),v[5]||(v[5]=Ue(" ç‰‡å‡å ",-1))])]),e("div",wm,[v[6]||(v[6]=e("label",null,"è¾“å…¥åˆ°ï¼š",-1)),xe(Ne,{modelValue:a.value,"onUpdate:modelValue":v[2]||(v[2]=d=>a.value=d),options:g},null,8,["modelValue"])])]),e("div",{class:Ee(["kana-tab-content",{active:i.value==="basic"}])},[e("table",Tm,[v[7]||(v[7]=e("thead",null,[e("tr",null,[e("th"),e("th",null,"ã‚æ®µ"),e("th",null,"ã„æ®µ"),e("th",null,"ã†æ®µ"),e("th",null,"ãˆæ®µ"),e("th",null,"ãŠæ®µ")])],-1)),e("tbody",null,[(A(),U(We,null,Qe(x,d=>e("tr",{key:d.label},[e("td",$m,se(d.label),1),(A(!0),U(We,null,Qe(d.chars,(h,y)=>(A(),U("td",{key:y},[h?(A(),U("button",{key:0,class:Ee(["kana-key",{pressed:u.value===h.h}]),onClick:z=>k(h)},[e("span",Rm,se(h.h),1),e("span",Pm,se(h.k),1)],10,Im)):fe("",!0)]))),128))])),64))])])],2),e("div",{class:Ee(["kana-tab-content",{active:i.value==="dakuten"}])},[e("table",Dm,[v[8]||(v[8]=e("thead",null,[e("tr",null,[e("th"),e("th",null,"ã‚æ®µ"),e("th",null,"ã„æ®µ"),e("th",null,"ã†æ®µ"),e("th",null,"ãˆæ®µ"),e("th",null,"ãŠæ®µ")])],-1)),e("tbody",null,[(A(),U(We,null,Qe(_,d=>e("tr",{key:d.label},[e("td",Mm,se(d.label),1),(A(!0),U(We,null,Qe(d.chars,(h,y)=>(A(),U("td",{key:y},[h?(A(),U("button",{key:0,class:Ee(["kana-key",{pressed:u.value===h.h}]),onClick:z=>k(h)},[e("span",Em,se(h.h),1),e("span",Am,se(h.k),1)],10,Bm)):fe("",!0)]))),128))])),64))])])],2),e("div",{class:Ee(["kana-tab-content",{active:i.value==="combo"}])},[e("table",Lm,[v[9]||(v[9]=e("thead",null,[e("tr",null,[e("th"),e("th",null,"ã‚ƒ"),e("th",null,"ã‚…"),e("th",null,"ã‚‡")])],-1)),e("tbody",null,[(A(),U(We,null,Qe(D,d=>e("tr",{key:d.label},[e("td",Fm,se(d.label),1),(A(!0),U(We,null,Qe(d.chars,(h,y)=>(A(),U("td",{key:y},[h?(A(),U("button",{key:0,class:Ee(["kana-key",{pressed:u.value===h.h}]),onClick:z=>k(h)},[e("span",zm,se(h.h),1),e("span",Om,se(h.k),1)],10,Um)):fe("",!0)]))),128))])),64))])])],2),e("div",{class:Ee(["kana-tab-content",{active:i.value==="special"}])},[e("div",Vm,[(A(),U(We,null,Qe(R,d=>e("button",{key:d.char,class:Ee(["kana-key special-key",{pressed:u.value===d.char}]),onClick:h=>Y(d.char)},[Ue(se(d.char)+" ",1),d.label?(A(),U("span",Wm,se(d.label),1)):fe("",!0)],10,Nm)),64))])],2),e("div",{class:"kana-keyboard-footer"},[e("button",{class:"kana-backspace",onClick:V},"âŒ« é€€æ ¼")])])):fe("",!0)}}),Km=je(qm,[["__scopeId","data-v-ebfc2125"]]),Hm={class:"edit-panel-content"},jm={class:"text-column original-text-column text-block"},Ym={class:"text-column translated-text-column text-block"},Jm={class:"style-settings-section text-block"},Xm={class:"office-toolbar"},Gm={class:"toolbar-row toolbar-row-top"},Zm={class:"combo-control font-control"},Qm={class:"combo-control size-control"},ev={class:"size-input-wrap"},tv=["min","max","step"],ov={class:"toolbar-row toolbar-row-actions"},nv={class:"toolbar-icon-group","aria-label":"æ’ç‰ˆæ–¹å‘"},sv=["data-active"],av=["data-active"],lv={class:"toolbar-color-group"},iv={class:"toolbar-color-picker",title:"æ–‡å­—é¢œè‰²"},rv={class:"toolbar-inpaint-group",title:"èƒŒæ™¯ä¿®å¤æ–¹å¼"},uv={class:"toolbar-stroke-cluster"},cv=["data-active"],dv={class:"toolbar-row toolbar-row-bottom"},gv={class:"toolbar-rotation-group",title:"æ—‹è½¬è§’åº¦"},pv={class:"toolbar-position-group",title:"ä½ç½®è°ƒæ•´"},mv={class:"toolbar-position-value"},vv={class:"fontsize-presets-panel"},fv={class:"font-size-presets"},bv=["onClick"],Wt=2,hv=Ye({__name:"BubbleEditor",props:{bubble:{},bubbleIndex:{}},emits:["update","reRender","ocrRecognize","reTranslate","applyBubble","resetCurrent"],setup(s,{emit:t}){const n=s,o=t,i=gt(),r={originalText:"",translatedText:"",fontSize:24,fontFamily:xt,textDirection:"vertical",textColor:"#231816",fillColor:"#FFFFFF",strokeEnabled:!0,strokeColor:"#FFFFFF",strokeWidth:3,rotationAngle:0,inpaintMethod:"solid",position:{x:0,y:0}},a=C(""),u=C(""),g=C(24),S=C(xt),x=C("vertical"),_=C("#231816"),D=C("#FFFFFF"),R=C(!0),M=C("#FFFFFF"),k=C(3),Y=C(0),V=C("solid"),L=C(0),v=C(0),d=C(null),h=C(null),y=C(null),z=C(null),F=C(null),te=C(!1),J=C("original"),K=C([{name:"æ€æºé»‘ä½“",path:xt},{name:"åæ–‡æ¥·ä½“",path:"fonts/STKAITI.TTF"},{name:"åæ–‡ç»†é»‘",path:"fonts/STXIHEI.TTF"},{name:"é»‘ä½“",path:"fonts/SIMHEI.TTF"},{name:"å®‹ä½“",path:"fonts/SIMSUN.TTC"}]),Z=C([]),W=Q(()=>n.bubble?n.bubble.coords[0]+L.value:0),oe=Q(()=>n.bubble?n.bubble.coords[1]+v.value:0),b=Q(()=>{const Be=[{label:"ç³»ç»Ÿå­—ä½“",options:K.value.map(E=>({label:E.name,value:E.path}))}];return Z.value.length>0&&Be.push({label:"è‡ªå®šä¹‰å­—ä½“",options:Z.value.map(E=>({label:E.name,value:E.path}))}),Be}),c=[{label:"çº¯è‰²å¡«å……",value:"solid"},{label:"LAMAä¿®å¤(æ¼«ç”»)",value:"lama_mpe"},{label:"LAMAä¿®å¤(é€šç”¨)",value:"litelama"}];function m(Be){const E=Be||r;a.value=E.originalText,u.value=E.translatedText,g.value=E.fontSize,S.value=E.fontFamily,x.value=E.textDirection,_.value=E.textColor,D.value=E.fillColor,R.value=E.strokeEnabled,M.value=E.strokeColor,k.value=E.strokeWidth,Y.value=E.rotationAngle,V.value=E.inpaintMethod,L.value=E.position?.x||0,v.value=E.position?.y||0}_e(()=>n.bubble,Be=>{m(Be)},{deep:!0,immediate:!0});function l(){o("update",{originalText:a.value})}function p(){o("update",{translatedText:u.value})}function $(){navigator.clipboard.writeText(a.value)}function w(){navigator.clipboard.writeText(u.value)}function P(){o("update",{fontSize:g.value})}function O(Be){g.value=Be,o("update",{fontSize:Be})}function ee(){g.value=Math.min(Qo,g.value+ao),o("update",{fontSize:g.value})}function le(){g.value=Math.max(en,g.value-ao),o("update",{fontSize:g.value})}function I(){o("update",{fontFamily:S.value})}function q(Be){x.value=Be,o("update",{textDirection:Be})}function ae(){y.value?.click()}function T(){o("update",{textColor:_.value})}function j(){z.value?.click()}function ge(){o("update",{fillColor:D.value})}function Se(){F.value?.click()}function Re(){o("update",{strokeColor:M.value})}function we(){R.value=!R.value,o("update",{strokeEnabled:R.value})}function be(){o("update",{strokeWidth:k.value})}function X(){o("update",{inpaintMethod:V.value})}function f(){o("update",{rotationAngle:Y.value})}function N(){Y.value=Math.max(-180,Y.value-5),o("update",{rotationAngle:Y.value})}function pe(){Y.value=Math.min(180,Y.value+5),o("update",{rotationAngle:Y.value})}function me(){Y.value=0,o("update",{rotationAngle:0})}function B(){L.value-=Wt,o("update",{position:{x:L.value,y:v.value}})}function G(){L.value+=Wt,o("update",{position:{x:L.value,y:v.value}})}function ve(){v.value-=Wt,o("update",{position:{x:L.value,y:v.value}})}function ce(){v.value+=Wt,o("update",{position:{x:L.value,y:v.value}})}function $e(){L.value=0,v.value=0,o("update",{position:{x:0,y:0}})}function De(){o("applyBubble",n.bubbleIndex)}function Ae(){i.updateAllBubbles({fontSize:g.value,fontFamily:S.value,textDirection:x.value,textColor:_.value,fillColor:D.value,strokeEnabled:R.value,strokeColor:M.value,strokeWidth:k.value,inpaintMethod:V.value}),console.log("æ ·å¼å·²åº”ç”¨åˆ°æ‰€æœ‰æ°”æ³¡"),o("reRender")}function Ce(){o("resetCurrent",n.bubbleIndex)}function Me(){o("ocrRecognize",n.bubbleIndex)}function he(){o("reTranslate",n.bubbleIndex)}function lt(){te.value=!te.value}function Xe(Be,E){if(E==="original"){const ie=d.value;if(ie){const Te=ie.selectionStart||a.value.length,Ie=ie.selectionEnd||a.value.length,et=a.value;a.value=et.slice(0,Te)+Be+et.slice(Ie),pt(()=>{ie.selectionStart=ie.selectionEnd=Te+Be.length,ie.focus()}),o("update",{originalText:a.value})}}else{const ie=h.value;if(ie){const Te=ie.selectionStart||u.value.length,Ie=ie.selectionEnd||u.value.length,et=u.value;u.value=et.slice(0,Te)+Be+et.slice(Ie),pt(()=>{ie.selectionStart=ie.selectionEnd=Te+Be.length,ie.focus()}),o("update",{translatedText:u.value})}}}function Ge(Be){if(Be==="original"){const E=d.value;if(E&&a.value.length>0){const ie=E.selectionStart||a.value.length,Te=E.selectionEnd||a.value.length,Ie=a.value;ie===Te&&ie>0?(a.value=Ie.slice(0,ie-1)+Ie.slice(Te),pt(()=>{E.selectionStart=E.selectionEnd=ie-1,E.focus()})):ie!==Te&&(a.value=Ie.slice(0,ie)+Ie.slice(Te),pt(()=>{E.selectionStart=E.selectionEnd=ie,E.focus()})),o("update",{originalText:a.value})}}else{const E=h.value;if(E&&u.value.length>0){const ie=E.selectionStart||u.value.length,Te=E.selectionEnd||u.value.length,Ie=u.value;ie===Te&&ie>0?(u.value=Ie.slice(0,ie-1)+Ie.slice(Te),pt(()=>{E.selectionStart=E.selectionEnd=ie-1,E.focus()})):ie!==Te&&(u.value=Ie.slice(0,ie)+Ie.slice(Te),pt(()=>{E.selectionStart=E.selectionEnd=ie,E.focus()})),o("update",{translatedText:u.value})}}}async function st(){try{const Be=await _s();if(Be.fonts){const E=[],ie=[];for(const Te of Be.fonts){const Ie={name:typeof Te=="string"?Te:Te.display_name||Te.file_name||"",path:typeof Te=="string"?Te:Te.path};Ie.path.startsWith("fonts/")?E.push(Ie):ie.push(Ie)}E.length>0&&(K.value=E),Z.value=ie}}catch(Be){console.error("åŠ è½½å­—ä½“åˆ—è¡¨å¤±è´¥:",Be)}}return dt(()=>{st()}),(Be,E)=>(A(),U("div",Hm,[e("div",jm,[e("div",{class:"text-column-header"},[E[13]||(E[13]=e("span",{class:"column-title"},"ğŸ‡¯ğŸ‡µ æ—¥è¯­åŸæ–‡ (OCRç»“æœ)",-1)),e("button",{class:"re-ocr-btn",onClick:Me,title:"é‡æ–°OCRæ­¤æ°”æ³¡"},"ğŸ”„")]),ne(e("textarea",{ref_key:"originalTextInput",ref:d,"onUpdate:modelValue":E[0]||(E[0]=ie=>a.value=ie),class:"text-editor original-editor",placeholder:"OCRè¯†åˆ«çš„æ—¥è¯­åŸæ–‡...",spellcheck:"false",onInput:l},null,544),[[ke,a.value]]),e("div",{class:"text-actions"},[e("button",{class:"copy-btn",onClick:$},"ğŸ“‹ å¤åˆ¶"),e("button",{class:"keyboard-toggle-btn",onClick:lt,title:"æ˜¾ç¤º/éšè—50éŸ³é”®ç›˜"}," âŒ¨ï¸ 50éŸ³ ")]),xe(Km,{visible:te.value,"default-target":J.value,onClose:E[1]||(E[1]=ie=>te.value=!1),onInsert:Xe,onDelete:Ge},null,8,["visible","default-target"])]),e("div",Ym,[e("div",{class:"text-column-header"},[E[14]||(E[14]=e("span",{class:"column-title"},"ğŸ‡¨ğŸ‡³ ä¸­æ–‡è¯‘æ–‡",-1)),e("button",{class:"re-translate-btn",onClick:he,title:"é‡æ–°ç¿»è¯‘æ­¤æ°”æ³¡"}," ğŸ”„ ")]),ne(e("textarea",{ref_key:"translatedTextInput",ref:h,"onUpdate:modelValue":E[2]||(E[2]=ie=>u.value=ie),class:"text-editor translated-editor",placeholder:"ç¿»è¯‘åçš„ä¸­æ–‡...",spellcheck:"false",onInput:p},null,544),[[ke,u.value]]),e("div",{class:"text-actions"},[e("button",{class:"copy-btn",onClick:w},"ğŸ“‹ å¤åˆ¶"),e("button",{class:"apply-text-btn",onClick:De},"âœ“ åº”ç”¨æ–‡æœ¬")])]),e("div",Jm,[e("div",Xm,[e("div",Gm,[e("div",Zm,[E[15]||(E[15]=e("label",null,"å­—ä½“",-1)),xe(Ne,{modelValue:S.value,"onUpdate:modelValue":E[3]||(E[3]=ie=>S.value=ie),groups:b.value,title:"å­—ä½“",onChange:I},null,8,["modelValue","groups"])]),e("div",Qm,[E[16]||(E[16]=e("label",null,"å­—å·",-1)),e("div",ev,[ne(e("input",{type:"number","onUpdate:modelValue":E[4]||(E[4]=ie=>g.value=ie),class:"toolbar-fontsize-input",min:re(en),max:re(Qo),step:re(ao),title:"å­—å·",onChange:P},null,40,tv),[[ke,g.value,void 0,{number:!0}]]),e("div",{class:"toolbar-fontsize-btns"},[e("button",{class:"toolbar-fontsize-btn",onClick:ee,title:"å¢å¤§å­—å·"}," A+ "),e("button",{class:"toolbar-fontsize-btn",onClick:le,title:"å‡å°å­—å·"}," A- ")])])])]),e("div",ov,[e("div",nv,[e("button",{class:"toolbar-btn","data-active":x.value==="vertical",onClick:E[5]||(E[5]=ie=>q("vertical")),title:"ç«–å‘æ’ç‰ˆ"},[...E[17]||(E[17]=[e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("path",{d:"M8 2v12M8 2L5 5M8 2l3 3",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])],8,sv),e("button",{class:"toolbar-btn","data-active":x.value==="horizontal",onClick:E[6]||(E[6]=ie=>q("horizontal")),title:"æ¨ªå‘æ’ç‰ˆ"},[...E[18]||(E[18]=[e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("path",{d:"M2 8h12M14 8l-3-3M14 8l-3 3",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])],8,av)]),E[24]||(E[24]=e("div",{class:"toolbar-divider vertical"},null,-1)),e("div",lv,[e("div",iv,[e("button",{class:"toolbar-btn toolbar-color-btn",onClick:ae},[E[19]||(E[19]=e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("text",{x:"3",y:"11","font-size":"10","font-weight":"bold",fill:"currentColor"},"A")],-1)),e("span",{class:"color-indicator",style:at({background:_.value})},null,4)]),ne(e("input",{ref_key:"textColorInput",ref:y,type:"color","onUpdate:modelValue":E[7]||(E[7]=ie=>_.value=ie),class:"hidden-color-input",onInput:T,onChange:T},null,544),[[ke,_.value]])])]),E[25]||(E[25]=e("div",{class:"toolbar-divider vertical"},null,-1)),e("div",rv,[xe(Ne,{modelValue:V.value,"onUpdate:modelValue":E[8]||(E[8]=ie=>V.value=ie),options:c,onChange:X},null,8,["modelValue"]),e("div",{class:Ee(["toolbar-color-picker toolbar-solid-color-options",{hidden:V.value!=="solid"}])},[e("button",{class:"toolbar-btn toolbar-color-btn",onClick:j},[E[20]||(E[20]=e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("rect",{x:"2",y:"2",width:"12",height:"12",rx:"2",fill:"none",stroke:"currentColor","stroke-width":"1.2"}),e("rect",{x:"4",y:"4",width:"8",height:"8",rx:"1",fill:"currentColor",opacity:"0.3"})],-1)),e("span",{class:"color-indicator",style:at({background:D.value})},null,4)]),ne(e("input",{ref_key:"fillColorInput",ref:z,type:"color","onUpdate:modelValue":E[9]||(E[9]=ie=>D.value=ie),class:"hidden-color-input",onChange:ge},null,544),[[ke,D.value]])],2)]),E[26]||(E[26]=e("div",{class:"toolbar-divider vertical"},null,-1)),e("div",uv,[e("button",{class:"toolbar-btn","data-active":R.value,onClick:we,title:"æ–‡å­—æè¾¹"},[...E[21]||(E[21]=[e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("text",{x:"3",y:"12","font-size":"11","font-weight":"bold",stroke:"currentColor","stroke-width":"2",fill:"none"}," A "),e("text",{x:"3",y:"12","font-size":"11","font-weight":"bold",fill:"currentColor"},"A")],-1)])],8,cv),e("div",{class:Ee(["toolbar-color-picker toolbar-stroke-options",{hidden:!R.value}]),title:"æè¾¹é¢œè‰²"},[e("button",{class:"toolbar-btn toolbar-color-btn",onClick:Se},[E[22]||(E[22]=e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("circle",{cx:"8",cy:"8",r:"5",fill:"none",stroke:"currentColor","stroke-width":"2"})],-1)),e("span",{class:"color-indicator",style:at({background:M.value})},null,4)]),ne(e("input",{ref_key:"strokeColorInput",ref:F,type:"color","onUpdate:modelValue":E[10]||(E[10]=ie=>M.value=ie),class:"hidden-color-input",onChange:Re},null,544),[[ke,M.value]])],2),e("div",{class:Ee(["toolbar-stroke-width toolbar-stroke-options",{hidden:!R.value}]),title:"æè¾¹å®½åº¦"},[ne(e("input",{type:"number","onUpdate:modelValue":E[11]||(E[11]=ie=>k.value=ie),class:"toolbar-mini-input",min:"0",max:"10",onChange:be},null,544),[[ke,k.value,void 0,{number:!0}]]),E[23]||(E[23]=e("span",{class:"toolbar-unit"},"px",-1))],2)])]),e("div",dv,[e("div",gv,[e("button",{class:"toolbar-btn",onClick:N,title:"é€†æ—¶é’ˆæ—‹è½¬"},[...E[27]||(E[27]=[e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("path",{d:"M2 8a6 6 0 1 1 1.5 4",stroke:"currentColor","stroke-width":"1.5",fill:"none"}),e("path",{d:"M2 5v3.5h3.5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),ne(e("input",{type:"number","onUpdate:modelValue":E[12]||(E[12]=ie=>Y.value=ie),class:"toolbar-mini-input toolbar-rotation-input",min:"-180",max:"180",step:"5",onChange:f},null,544),[[ke,Y.value,void 0,{number:!0}]]),E[29]||(E[29]=e("span",{class:"toolbar-unit"},"Â°",-1)),e("button",{class:"toolbar-btn",onClick:pe,title:"é¡ºæ—¶é’ˆæ—‹è½¬"},[...E[28]||(E[28]=[e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("path",{d:"M14 8a6 6 0 1 0-1.5 4",stroke:"currentColor","stroke-width":"1.5",fill:"none"}),e("path",{d:"M14 5v3.5h-3.5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),e("button",{class:"toolbar-btn toolbar-small-btn",onClick:me,title:"é‡ç½®æ—‹è½¬"}," 0 ")]),E[35]||(E[35]=e("div",{class:"toolbar-divider vertical"},null,-1)),e("div",pv,[e("button",{class:"toolbar-btn",onClick:B,title:"å·¦ç§»"},[...E[30]||(E[30]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("path",{d:"M10 3L5 8l5 5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),e("button",{class:"toolbar-btn",onClick:G,title:"å³ç§»"},[...E[31]||(E[31]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("path",{d:"M6 3l5 5-5 5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),e("button",{class:"toolbar-btn",onClick:ve,title:"ä¸Šç§»"},[...E[32]||(E[32]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("path",{d:"M3 10l5-5 5 5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),e("button",{class:"toolbar-btn",onClick:ce,title:"ä¸‹ç§»"},[...E[33]||(E[33]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("path",{d:"M3 6l5 5 5-5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),e("span",mv,[e("span",null,se(W.value),1),E[34]||(E[34]=Ue(",",-1)),e("span",null,se(oe.value),1)]),e("button",{class:"toolbar-btn toolbar-small-btn",onClick:$e,title:"é‡ç½®ä½ç½®"}," âŒ‚ ")])])]),e("details",vv,[E[36]||(E[36]=e("summary",null,"å­—å·é¢„è®¾",-1)),e("div",fv,[(A(!0),U(We,null,Qe(re(ls),ie=>(A(),U("button",{key:ie,class:Ee(["preset-btn",{active:g.value===ie}]),onClick:Te=>O(ie)},se(ie),11,bv))),128))])]),e("div",{class:"edit-action-buttons"},[e("button",{class:"btn-apply",onClick:De},"åº”ç”¨"),e("button",{class:"btn-apply-all",onClick:Ae},"åº”ç”¨å…¨éƒ¨"),e("button",{class:"btn-reset",onClick:Ce},"é‡ç½®")])])]))}}),yv=je(hv,[["__scopeId","data-v-edcb1ca9"]]),xv={class:"edit-toolbar-wrapper"},Sv={class:"edit-toolbar toolbar-row-1"},_v={class:"image-navigator"},Cv=["disabled"],kv=["disabled"],wv={class:"bubble-navigator"},Tv=["disabled"],$v={class:"bubble-indicator"},Iv={id:"currentBubbleNum"},Rv={id:"totalBubbleNum"},Pv=["disabled"],Dv={class:"view-controls"},Mv={key:0,viewBox:"0 0 20 20",width:"16",height:"16"},Bv={key:1,viewBox:"0 0 20 20",width:"16",height:"16"},Ev={id:"zoomLevel"},Av={class:"edit-toolbar toolbar-row-2"},Lv={class:"annotation-tools"},Fv=["disabled"],Uv=["disabled"],zv={key:0,class:"brush-size-indicator"},Ov={key:1,class:"brush-mode-hint"},Vv={class:"edit-progress-info"},Nv={class:"edit-progress-text"},Wv={class:"edit-progress-count"},qv={class:"edit-progress-bar"},Kv={class:"quick-actions"},Hv=Ye({__name:"EditToolbar",props:{currentImageIndex:{},imageCount:{},canGoPrevious:{type:Boolean},canGoNext:{type:Boolean},showThumbnails:{type:Boolean},hasBubbles:{type:Boolean},selectedBubbleIndex:{},bubbleCount:{},layoutMode:{},syncEnabled:{type:Boolean},scale:{},isDrawingMode:{type:Boolean},hasSelection:{type:Boolean},brushMode:{},brushSize:{},mouseX:{},mouseY:{},isProcessing:{type:Boolean},progressText:{},progressCurrent:{},progressTotal:{}},emits:["go-previous-image","go-next-image","toggle-thumbnails","select-previous-bubble","select-next-bubble","toggle-layout","toggle-view-mode","toggle-sync","fit-to-screen","zoom-in","zoom-out","reset-zoom","exit-edit-mode","auto-detect-bubbles","detect-all-images","translate-with-bubbles","toggle-drawing-mode","delete-selected-bubbles","repair-selected-bubble","activate-repair-brush","activate-restore-brush","apply-and-next"],setup(s){const t=s,n=Q(()=>t.progressTotal===0?0:Math.round(t.progressCurrent/t.progressTotal*100)),o=Q(()=>t.progressTotal>0&&t.progressCurrent>=t.progressTotal),i=Q(()=>{const r=t.brushMode==="repair"?{fill:"rgba(76, 175, 80, 0.4)",border:"#4CAF50"}:{fill:"rgba(33, 150, 243, 0.4)",border:"#2196F3"};return{position:"fixed",left:`${t.mouseX}px`,top:`${t.mouseY}px`,width:`${t.brushSize}px`,height:`${t.brushSize}px`,borderRadius:"50%",border:`2px solid ${r.border}`,backgroundColor:r.fill,pointerEvents:"none",zIndex:99999,transform:"translate(-50%, -50%)",display:t.brushMode?"block":"none"}});return(r,a)=>(A(),U("div",xv,[e("div",Sv,[e("div",_v,[e("button",{class:"nav-btn",disabled:!s.canGoPrevious,onClick:a[0]||(a[0]=u=>r.$emit("go-previous-image")),title:"ä¸Šä¸€å¼ å›¾ç‰‡ (PageUp)"}," â—€â—€ ",8,Cv),e("span",{class:"image-indicator",onClick:a[1]||(a[1]=u=>r.$emit("toggle-thumbnails")),title:"ç‚¹å‡»å±•å¼€ç¼©ç•¥å›¾"},[a[23]||(a[23]=Ue(" å›¾ ",-1)),e("span",null,se(s.currentImageIndex+1),1),a[24]||(a[24]=Ue(" / ",-1)),e("span",null,se(s.imageCount),1)]),e("button",{class:"nav-btn",disabled:!s.canGoNext,onClick:a[2]||(a[2]=u=>r.$emit("go-next-image")),title:"ä¸‹ä¸€å¼ å›¾ç‰‡ (PageDown)"}," â–¶â–¶ ",8,kv),e("button",{class:Ee(["thumb-toggle-btn",{active:s.showThumbnails}]),onClick:a[3]||(a[3]=u=>r.$emit("toggle-thumbnails")),title:"æ˜¾ç¤º/éšè—ç¼©ç•¥å›¾"}," â˜· ",2)]),a[30]||(a[30]=e("div",{class:"toolbar-divider"},null,-1)),e("div",wv,[e("button",{id:"prevBubbleBtn",class:"nav-btn",disabled:!s.hasBubbles||s.selectedBubbleIndex<=0,onClick:a[4]||(a[4]=u=>r.$emit("select-previous-bubble")),title:"ä¸Šä¸€ä¸ªæ°”æ³¡ (â†)"}," â—€ ",8,Tv),e("span",$v,[a[25]||(a[25]=Ue(" æ°”æ³¡ ",-1)),e("span",Iv,se(s.selectedBubbleIndex>=0?s.selectedBubbleIndex+1:0),1),a[26]||(a[26]=Ue(" / ",-1)),e("span",Rv,se(s.bubbleCount),1)]),e("button",{id:"nextBubbleBtn",class:"nav-btn",disabled:!s.hasBubbles||s.selectedBubbleIndex>=s.bubbleCount-1,onClick:a[5]||(a[5]=u=>r.$emit("select-next-bubble")),title:"ä¸‹ä¸€ä¸ªæ°”æ³¡ (â†’)"}," â–¶ ",8,Pv)]),a[31]||(a[31]=e("div",{class:"toolbar-divider"},null,-1)),e("div",Dv,[e("button",{class:"layout-toggle-btn",onClick:a[6]||(a[6]=u=>r.$emit("toggle-layout")),title:"åˆ‡æ¢å¸ƒå±€ï¼šå·¦å³/ä¸Šä¸‹"},[s.layoutMode==="horizontal"?(A(),U("svg",Mv,[...a[27]||(a[27]=[e("rect",{x:"1",y:"2",width:"8",height:"16",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"},null,-1),e("rect",{x:"11",y:"2",width:"8",height:"16",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"},null,-1)])])):(A(),U("svg",Bv,[...a[28]||(a[28]=[e("rect",{x:"2",y:"1",width:"16",height:"8",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"},null,-1),e("rect",{x:"2",y:"11",width:"16",height:"8",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"},null,-1)])]))]),e("button",{class:"view-mode-btn",onClick:a[7]||(a[7]=u=>r.$emit("toggle-view-mode")),title:"åˆ‡æ¢è§†å›¾æ¨¡å¼"},[...a[29]||(a[29]=[e("span",{class:"dual-icon"},"â§‰",-1)])]),e("button",{class:Ee({active:s.syncEnabled}),onClick:a[8]||(a[8]=u=>r.$emit("toggle-sync")),title:"åŒæ­¥ç¼©æ”¾/æ‹–åŠ¨",style:{"font-size":"12px"}}," ğŸ”— ",2),e("button",{onClick:a[9]||(a[9]=u=>r.$emit("fit-to-screen")),title:"é€‚åº”å±å¹• (åŒå‡»)"},"â›¶"),e("button",{onClick:a[10]||(a[10]=u=>r.$emit("zoom-in")),title:"æ”¾å¤§ (+)"},"+"),e("span",Ev,se(Math.round(s.scale*100))+"%",1),e("button",{onClick:a[11]||(a[11]=u=>r.$emit("zoom-out")),title:"ç¼©å° (-)"},"âˆ’"),e("button",{onClick:a[12]||(a[12]=u=>r.$emit("reset-zoom")),title:"åŸå§‹å¤§å°"},"1:1")]),a[32]||(a[32]=e("div",{class:"toolbar-spacer"},null,-1)),e("button",{class:"secondary-btn",onClick:a[13]||(a[13]=u=>r.$emit("exit-edit-mode"))},"é€€å‡ºç¼–è¾‘")]),e("div",Av,[e("div",Lv,[e("button",{class:"annotation-btn detect-btn",onClick:a[14]||(a[14]=u=>r.$emit("auto-detect-bubbles")),title:"è‡ªåŠ¨æ£€æµ‹å½“å‰å›¾ç‰‡çš„æ–‡æœ¬æ¡†"},[...a[33]||(a[33]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("circle",{cx:"6",cy:"6",r:"4",fill:"none",stroke:"currentColor","stroke-width":"1.5"}),e("path",{d:"M9 9l4 4",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round"})],-1),e("span",null,"æ£€æµ‹",-1)])]),e("button",{class:"annotation-btn detect-btn",onClick:a[15]||(a[15]=u=>r.$emit("detect-all-images")),title:"æ‰¹é‡æ£€æµ‹æ‰€æœ‰å›¾ç‰‡"},[...a[34]||(a[34]=[ro('<svg viewBox="0 0 16 16" width="14" height="14" data-v-b7164359><circle cx="5" cy="5" r="2.5" fill="none" stroke="currentColor" stroke-width="1" data-v-b7164359></circle><path d="M7 7l2 2" stroke="currentColor" stroke-width="1" stroke-linecap="round" data-v-b7164359></path><circle cx="10" cy="10" r="2.5" fill="none" stroke="currentColor" stroke-width="1" data-v-b7164359></circle><path d="M12 12l2 2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" data-v-b7164359></path></svg><span data-v-b7164359>æ‰¹é‡æ£€æµ‹</span>',2)])]),e("button",{class:"annotation-btn primary-action-btn",onClick:a[16]||(a[16]=u=>r.$emit("translate-with-bubbles")),title:"ä½¿ç”¨å½“å‰æ–‡æœ¬æ¡†ç¿»è¯‘æ­¤å›¾ç‰‡"},[...a[35]||(a[35]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("path",{d:"M2 3h5M4.5 3v7M2 6h5",stroke:"currentColor","stroke-width":"1.2",fill:"none"}),e("path",{d:"M9 13l2-7 2 7M9.5 11h3",stroke:"currentColor","stroke-width":"1.2",fill:"none"})],-1),e("span",null,"ç¿»è¯‘",-1)])]),a[41]||(a[41]=e("div",{class:"toolbar-divider"},null,-1)),e("button",{class:Ee(["annotation-btn",{active:s.isDrawingMode}]),onClick:a[17]||(a[17]=u=>r.$emit("toggle-drawing-mode")),title:"æ·»åŠ æ°”æ³¡æ¡†ï¼ˆæˆ–ä¸­é”®æ‹–æ‹½ç»˜åˆ¶ï¼‰"},[...a[36]||(a[36]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("rect",{x:"3",y:"3",width:"10",height:"10",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"}),e("path",{d:"M8 5v6M5 8h6",stroke:"currentColor","stroke-width":"1.5"})],-1),e("span",null,"æ·»åŠ ",-1)])],2),e("button",{class:"annotation-btn",disabled:!s.hasSelection,onClick:a[18]||(a[18]=u=>r.$emit("delete-selected-bubbles")),title:"åˆ é™¤é€‰ä¸­æ°”æ³¡æ¡† (Delete)"},[...a[37]||(a[37]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("rect",{x:"3",y:"3",width:"10",height:"10",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"}),e("path",{d:"M5 8h6",stroke:"currentColor","stroke-width":"1.5"})],-1),e("span",null,"åˆ é™¤",-1)])],8,Fv),e("button",{class:"annotation-btn",disabled:!s.hasSelection,onClick:a[19]||(a[19]=u=>r.$emit("repair-selected-bubble")),title:"ä¿®å¤é€‰ä¸­æ°”æ³¡èƒŒæ™¯ (R)"},[...a[38]||(a[38]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("path",{d:"M2 14l3-3m0 0l6-6 3 3-6 6m-3 0l-1 1 1-1z",fill:"none",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round"}),e("path",{d:"M11 5l-1-1 2-2 2 2-2 2-1-1z",fill:"currentColor"})],-1),e("span",null,"ä¿®å¤",-1)])],8,Uv),a[42]||(a[42]=e("div",{class:"toolbar-divider"},null,-1)),e("button",{class:Ee(["annotation-btn brush-btn",{active:s.brushMode==="repair"}]),onClick:a[20]||(a[20]=u=>r.$emit("activate-repair-brush")),title:"ä¿®å¤ç¬”åˆ· (æŒ‰ä½R+å·¦é”®æ‹–æ‹½)"},[...a[39]||(a[39]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("circle",{cx:"8",cy:"8",r:"5",fill:"none",stroke:"currentColor","stroke-width":"1.5"}),e("circle",{cx:"8",cy:"8",r:"2",fill:"currentColor"})],-1),e("span",null,"ä¿®å¤ç¬”åˆ·",-1)])],2),e("button",{class:Ee(["annotation-btn brush-btn",{active:s.brushMode==="restore"}]),onClick:a[21]||(a[21]=u=>r.$emit("activate-restore-brush")),title:"è¿˜åŸç¬”åˆ· (æŒ‰ä½U+å·¦é”®æ‹–æ‹½)"},[...a[40]||(a[40]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("circle",{cx:"8",cy:"8",r:"5",fill:"none",stroke:"currentColor","stroke-width":"1.5"}),e("path",{d:"M5 8h6M8 5v6",stroke:"currentColor","stroke-width":"1",transform:"rotate(45 8 8)"})],-1),e("span",null,"è¿˜åŸç¬”åˆ·",-1)])],2),s.brushMode?(A(),U("span",zv," ç¬”åˆ·: "+se(s.brushSize)+"px ",1)):fe("",!0),a[43]||(a[43]=ro('<div class="help-tooltip-container" data-v-b7164359><button class="help-tooltip-btn" title="å¿«æ·é”®æ“ä½œå¸®åŠ©" data-v-b7164359><svg viewBox="0 0 16 16" width="14" height="14" data-v-b7164359><circle cx="8" cy="8" r="6.5" fill="none" stroke="currentColor" stroke-width="1.2" data-v-b7164359></circle><text x="8" y="11" text-anchor="middle" font-size="9" font-weight="bold" fill="currentColor" data-v-b7164359>?</text></svg><span class="help-btn-text" data-v-b7164359>å¿«æ·é”®</span></button><div class="help-tooltip-popup" data-v-b7164359><div class="help-section" data-v-b7164359><div class="help-title" data-v-b7164359>ğŸ–±ï¸ é¼ æ ‡æ“ä½œ</div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>å·¦é”®ç‚¹å‡»æ°”æ³¡</span><span class="help-desc" data-v-b7164359>é€‰æ‹©æ°”æ³¡</span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>Shift+å·¦é”®ç‚¹å‡»</span><span class="help-desc" data-v-b7164359>å¤šé€‰æ°”æ³¡</span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>å·¦é”®æ‹–æ‹½å››è§’/è¾¹</span><span class="help-desc" data-v-b7164359>è°ƒæ•´å¤§å°</span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>å·¦é”®æ‹–æ‹½æ¡†å†…éƒ¨</span><span class="help-desc" data-v-b7164359>ç§»åŠ¨æ°”æ³¡æ¡†</span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>ä¸­é”®æ‹–æ‹½</span><span class="help-desc" data-v-b7164359>ç»˜åˆ¶æ–°æ°”æ³¡æ¡†</span></div></div><div class="help-section" data-v-b7164359><div class="help-title" data-v-b7164359>âŒ¨ï¸ å¿«æ·é”®</div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>A / D</span><span class="help-desc" data-v-b7164359>åˆ‡æ¢ä¸Š/ä¸‹ä¸€å¼ å›¾ç‰‡</span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>Ctrl+Enter</span><span class="help-desc" data-v-b7164359>åº”ç”¨å¹¶è·³è½¬ä¸‹ä¸€å¼ </span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>Delete / Backspace</span><span class="help-desc" data-v-b7164359>åˆ é™¤é€‰ä¸­æ°”æ³¡</span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>æŒ‰ä½R+å·¦é”®æ‹–æ‹½</span><span class="help-desc" data-v-b7164359>ä¿®å¤ç¬”åˆ·</span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>æŒ‰ä½U+å·¦é”®æ‹–æ‹½</span><span class="help-desc" data-v-b7164359>è¿˜åŸç¬”åˆ·</span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>ç¬”åˆ·æ¨¡å¼ä¸‹æ»šè½®</span><span class="help-desc" data-v-b7164359>è°ƒæ•´ç¬”åˆ·å¤§å°</span></div></div></div></div>',1))]),s.brushMode?(A(),U("div",{key:0,class:"brush-cursor",style:at(i.value)},null,4)):fe("",!0),s.brushMode?(A(),U("div",Ov,se(s.brushMode==="repair"?"ä¿®å¤ç¬”åˆ· (R)":"è¿˜åŸç¬”åˆ· (U)")+" - æ»šè½®è°ƒæ•´å¤§å° ",1)):fe("",!0),s.isProcessing?(A(),U("div",{key:2,class:Ee(["edit-progress-container",{completed:o.value}])},[e("div",Vv,[e("span",Nv,se(s.progressText),1),e("span",Wv,se(s.progressCurrent)+"/"+se(s.progressTotal),1)]),e("div",qv,[e("div",{class:Ee(["edit-progress-fill",{animating:!o.value}]),style:at({width:n.value+"%"})},null,6)])],2)):fe("",!0),a[44]||(a[44]=e("div",{class:"toolbar-spacer"},null,-1)),e("div",Kv,[e("button",{class:"primary-btn",onClick:a[22]||(a[22]=u=>r.$emit("apply-and-next")),title:"åº”ç”¨æ›´æ”¹å¹¶è·³è½¬ä¸‹ä¸€å¼  (Ctrl+Enter)"}," åº”ç”¨å¹¶ä¸‹ä¸€å¼  ")])])]))}}),jv=je(Hv,[["__scopeId","data-v-b7164359"]]),Yv={key:0,class:"edit-thumbnails-panel"},Jv={class:"thumbnails-scroll"},Xv=["onClick"],Gv=["src","alt"],Zv={class:"thumb-index"},Qv=Ye({__name:"EditThumbnailPanel",props:{visible:{type:Boolean},images:{},currentImageIndex:{}},emits:["switch-to-image"],setup(s){return(t,n)=>s.visible?(A(),U("div",Yv,[e("div",Jv,[(A(!0),U(We,null,Qe(s.images,(o,i)=>(A(),U("div",{key:o.id,class:Ee(["edit-thumbnail-item",{active:i===s.currentImageIndex}]),onClick:r=>t.$emit("switch-to-image",i)},[e("img",{src:o.translatedDataURL||o.originalDataURL,alt:`å›¾ç‰‡ ${i+1}`},null,8,Gv),e("span",Zv,se(i+1),1)],10,Xv))),128))])])):fe("",!0)}}),ef=je(Qv,[["__scopeId","data-v-9d2a43d9"]]),tf=["data-brush-mode"],of={class:"edit-main-layout"},nf={class:"image-comparison-container"},sf={class:"panel-header"},af=["src"],lf={class:"panel-header"},rf=["src"],uf=Ye({__name:"EditWorkspace",props:{isEditModeActive:{type:Boolean}},emits:["exit"],setup(s,{emit:t}){const n=s,o=t,i=ot(),r=gt(),{translateWithCurrentBubbles:a}=Io(),{reRenderFullImage:u}=lm({onRenderStart:()=>console.log("å¼€å§‹é‡æ–°æ¸²æŸ“..."),onRenderSuccess:H=>console.log("æ¸²æŸ“æˆåŠŸ:",H.substring(0,50)+"..."),onRenderError:H=>console.error("æ¸²æŸ“å¤±è´¥:",H)}),{isDrawingMode:g,isDrawingBox:S,currentDrawingRect:x,isMiddleButtonDown:_,handleBubbleSelect:D,handleBubbleMultiSelect:R,handleClearMultiSelect:M,handleBubbleDragStart:k,handleBubbleDragging:Y,handleBubbleDragEnd:V,handleBubbleResizeStart:L,handleBubbleResizing:v,handleBubbleResizeEnd:d,handleBubbleRotateStart:h,handleBubbleRotating:y,handleBubbleRotateEnd:z,toggleDrawingMode:F,handleDrawBubble:te,getDrawingRectStyle:J,handleBubbleUpdate:K,deleteSelectedBubbles:Z,repairSelectedBubble:W,handleOcrRecognize:oe}=am({onReRender:()=>u(),onDelayedPreview:()=>u()}),b=C(0),c=C(0),{brushMode:m,brushSize:l,mouseX:p,mouseY:$,isBrushKeyDown:w,toggleBrushMode:P,exitBrushMode:O,startBrushPainting:ee,continueBrushPainting:le,finishBrushPainting:I,adjustBrushSize:q}=nm({onBrushComplete:()=>u(),getCurrentRepairSettings:()=>({inpaintMethod:Be.value,fillColor:E.value})}),{images:ae,currentImageIndex:T,currentImage:j,imageCount:ge,canGoPrevious:Se,canGoNext:Re}=kt(i),{bubbles:we,selectedIndex:be,selectedIndices:X,selectedBubble:f,bubbleCount:N,hasBubbles:pe,hasSelection:me}=kt(r),B=Q(()=>$e.value?.querySelector("img")?.naturalWidth||2e3),G=Q(()=>$e.value?.querySelector("img")?.naturalHeight||2e3),ve=C(null),ce=C(null),$e=C(null),De=C(null),Ae=C(null),Ce=C(null),Me=C("dual"),he=C("horizontal"),lt=C(!1),Xe=C(!0),Ge=C(!1),st=C(!1),Be=C("solid"),E=C("#FFFFFF"),ie=C(!1),Te=C("å¤„ç†ä¸­..."),Ie=C(0),et=C(0),Ke=gn(),Ze=gn(),ht=Q(()=>Ze.scale.value),tt=Q(()=>Ze.translateX.value),Pn=Q(()=>Ze.translateY.value),Dn=Q(()=>Ke.scale.value),St=C(null),Mn=Q(()=>({transform:`translate(${Ke.translateX.value}px, ${Ke.translateY.value}px) scale(${Ke.scale.value})`})),Bn=Q(()=>({transform:`translate(${Ze.translateX.value}px, ${Ze.translateY.value}px) scale(${Ze.scale.value})`}));function Ro(){Ze.zoomIn(),Xe.value&&Ke.setTransform(Ze.getTransform())}function Po(){Ze.zoomOut(),Xe.value&&Ke.setTransform(Ze.getTransform())}function Do(){Ze.resetZoom(),Xe.value&&Ke.setTransform(Ze.getTransform())}const Ht=C(!1),En=C(0),jt=C(!1),Dt=C({x:0,y:0,size:0});function Yt(){m.value&&O(),Gt()}function Jt(){r.bubbles.length>0&&r.selectBubble(0)}function Mo(){Se.value&&(Yt(),i.goToPrevious())}function Xt(){Re.value&&(Yt(),i.goToNext())}function An(H){H!==T.value&&H>=0&&H<ge.value&&(Yt(),i.setCurrentImageIndex(H))}function Gt(){if(!j.value)return;const H=Array.isArray(j.value.bubbleStates);we.value.length>0?(i.updateCurrentBubbleStates([...we.value]),i.setManuallyAnnotated(!0),console.log("å·²ä¿å­˜æ°”æ³¡çŠ¶æ€åˆ°å½“å‰å›¾ç‰‡ï¼Œæ ‡è®°ä¸ºæ‰‹åŠ¨æ ‡æ³¨")):H&&(i.updateCurrentBubbleStates([]),i.setManuallyAnnotated(!0),console.log("å·²ä¿å­˜ç©ºæ°”æ³¡çŠ¶æ€åˆ°å½“å‰å›¾ç‰‡ï¼ˆç”¨æˆ·ä¸»åŠ¨æ¸…ç©ºï¼Œæ ‡è®°ä¸ºæ‰‹åŠ¨æ ‡æ³¨ï¼‰"))}function Mt(){j.value?.bubbleStates?(r.setBubbles([...j.value.bubbleStates],!0),console.log(`å·²åŠ è½½ ${j.value.bubbleStates.length} ä¸ªæ°”æ³¡çŠ¶æ€`)):r.clearBubblesLocal(),Jt()}function Ln(){r.selectPrevious()}function Fn(){r.selectNext()}function Un(){lt.value=!lt.value}function zn(){he.value=he.value==="horizontal"?"vertical":"horizontal";try{localStorage.setItem(tn,he.value)}catch(H){console.warn("ä¿å­˜å¸ƒå±€æ¨¡å¼å¤±è´¥:",H)}setTimeout(()=>{Bt()},300)}function On(){const H=["dual","original","translated"],ue=H.indexOf(Me.value),de=H[(ue+1)%H.length];de&&(Me.value=de)}function Vn(){Xe.value=!Xe.value,console.log("åŒå›¾åŒæ­¥:",Xe.value?"å¼€å¯":"å…³é—­"),Xe.value&&Ke.setTransform(Ze.getTransform())}function Bt(){const H=De.value||ce.value,ue=Ae.value||$e.value;if(!H||!ue)return;const de=ue.querySelector("img");if(!de||!de.naturalWidth)return;const He=H.getBoundingClientRect(),ze=He.width/de.naturalWidth,Pe=He.height/de.naturalHeight,Ve=Math.min(ze,Pe)*.95,Le=(He.width-de.naturalWidth*Ve)/2,yt=(He.height-de.naturalHeight*Ve)/2,_t={scale:Ve,translateX:Le,translateY:yt};Ze.setTransform(_t),Ke.setTransform(_t)}function Bo(H,ue){if(m.value){const Le=H.deltaY>0?-5:5;q(Le);return}const de=H.currentTarget.getBoundingClientRect(),He=H.clientX-de.left,ze=H.clientY-de.top,Pe=H.deltaY>0?.9:1.1,Ve=ue==="original"?Ke:Ze;Ve.zoomAt(He,ze,Pe),Xe.value&&(ue==="original"?Ze:Ke).setTransform(Ve.getTransform())}function Eo(H,ue){if(m.value){const de=ue==="original"?ce.value:De.value;de&&ee(H,de);return}if(H.button===1){_.value=!0,Fo(H,ue),H.preventDefault();return}if(g.value&&H.button===0){Fo(H,ue),H.preventDefault();return}if(H.button===0){if(H.target.closest(".bubble-highlight-box"))return;H.shiftKey||M(),St.value=ue,(ue==="original"?Ke:Ze).startDrag(H.clientX,H.clientY),document.addEventListener("mousemove",Ao),document.addEventListener("mouseup",Lo),H.preventDefault()}}function Ao(H){if(!St.value)return;const ue=St.value==="original"?Ke:Ze;ue.drag(H.clientX,H.clientY),Xe.value&&(St.value==="original"?Ze:Ke).setTransform(ue.getTransform())}function Lo(){St.value&&(St.value==="original"?Ke:Ze).endDrag(),St.value=null,document.removeEventListener("mousemove",Ao),document.removeEventListener("mouseup",Lo)}let Zt="translated";function Fo(H,ue="translated"){Zt=ue;const de=ue==="original"?$e.value:Ae.value,He=ue==="original"?Ke:Ze;if(!de)return;const ze=de.getBoundingClientRect(),Pe=(H.clientX-ze.left)/He.scale.value,Ve=(H.clientY-ze.top)/He.scale.value;b.value=Pe,c.value=Ve,S.value=!0,x.value=[Pe,Ve,Pe,Ve],document.addEventListener("mousemove",Qt),document.addEventListener("mouseup",eo)}function Qt(H){if(!S.value)return;const ue=Zt==="original"?$e.value:Ae.value,de=Zt==="original"?Ke:Ze;if(!ue)return;const He=ue.getBoundingClientRect(),ze=(H.clientX-He.left)/de.scale.value,Pe=(H.clientY-He.top)/de.scale.value;x.value=[Math.min(b.value,ze),Math.min(c.value,Pe),Math.max(b.value,ze),Math.max(c.value,Pe)]}function eo(H){document.removeEventListener("mousemove",Qt),document.removeEventListener("mouseup",eo);const ue=_.value;if(!S.value||!x.value){S.value=!1,x.value=null,_.value=!1;return}const[de,He,ze,Pe]=x.value,Ve=ze-de,Le=Pe-He;Ve>10&&Le>10&&(r.addBubble(x.value),r.selectBubble(r.bubbleCount-1),console.log("å·²æ·»åŠ æ–°æ°”æ³¡:",x.value)),S.value=!1,x.value=null,_.value=!1,!ue&&g.value&&(g.value=!1)}function Uo(H){console.log(`${H} å›¾ç‰‡åŠ è½½å®Œæˆ`),ht.value===1&&tt.value===0&&Pn.value===0&&pt(()=>{Bt()})}function Nn(){u()}function Wn(H){H.inpaintMethod!==void 0&&(Be.value=H.inpaintMethod),H.fillColor!==void 0&&(E.value=H.fillColor),be.value>=0&&K(H)}function qn(H){ye("æ–‡æœ¬å·²åº”ç”¨","success"),u()}function Kn(H){const ue=r.initialStates[H];if(!ue){console.warn(`æ— æ³•é‡ç½®æ°”æ³¡ #${H+1}ï¼šæ‰¾ä¸åˆ°åˆå§‹çŠ¶æ€`),ye("æ— æ³•é‡ç½®ï¼šæ‰¾ä¸åˆ°åˆå§‹çŠ¶æ€","warning");return}const de=JSON.parse(JSON.stringify(ue));r.updateBubble(H,de),console.log(`æ°”æ³¡ #${H+1} å·²é‡ç½®åˆ°åˆå§‹çŠ¶æ€`),ye("æ°”æ³¡å·²é‡ç½®","success"),u()}async function Hn(H){const ue=we.value[H];if(!ue?.originalText){console.warn("æ— æ³•é‡æ–°ç¿»è¯‘ï¼šç¼ºå°‘æ°”æ³¡æˆ–åŸæ–‡");return}try{console.log(`å¼€å§‹é‡æ–°ç¿»è¯‘æ°”æ³¡ #${H+1}`);const{translateSingleText:de}=await rt(async()=>{const{translateSingleText:Ve}=await Promise.resolve().then(()=>ws);return{translateSingleText:Ve}},void 0),{useSettingsStore:He}=await rt(async()=>{const{useSettingsStore:Ve}=await import("./system.CnmiUywH.js").then(Le=>Le.s);return{useSettingsStore:Ve}},__vite__mapDeps([0,1,2,3,4,5])),ze=He().settings,Pe=await de({original_text:ue.originalText,model_provider:ze.translation.provider,api_key:ze.translation.apiKey,model_name:ze.translation.modelName,custom_base_url:ze.translation.customBaseUrl,target_language:ze.targetLanguage,prompt_content:void 0});Pe.success&&Pe.data?.translated_text?(r.updateBubble(H,{translatedText:Pe.data.translated_text}),console.log(`ç¿»è¯‘æˆåŠŸ: "${Pe.data.translated_text}"`),u()):console.error("ç¿»è¯‘å¤±è´¥:",Pe.error||"æœªçŸ¥é”™è¯¯")}catch(de){console.error("ç¿»è¯‘å‡ºé”™:",de)}}function zo(H,ue){for(H.bubbleTexts||(H.bubbleTexts=[]),H.originalTexts||(H.originalTexts=[]);H.bubbleTexts.length<ue;)H.bubbleTexts.push("");for(;H.originalTexts.length<ue;)H.originalTexts.push("")}function Oo(H,ue,de){const He=H.auto_directions||[];return H.bubble_coords.map((ze,Pe)=>{const Ve=ze[0]??0,Le=ze[1]??0,yt=ze[2]??0,_t=ze[3]??0;let mt;return He[Pe]?mt=He[Pe]==="v"?"vertical":"horizontal":mt=_t-Le>yt-Ve?"vertical":"horizontal",{coords:ze,originalText:ue.originalTexts?.[Pe]||"",translatedText:ue.bubbleTexts?.[Pe]||"",textboxText:"",fontSize:de.fontSize,fontFamily:de.fontFamily,textDirection:mt,autoTextDirection:mt,textColor:de.textColor,fillColor:de.fillColor,strokeEnabled:de.strokeEnabled,strokeColor:de.strokeColor,strokeWidth:de.strokeWidth,rotationAngle:H.bubble_angles?.[Pe]||0,inpaintMethod:de.inpaintMethod,position:{x:0,y:0},polygon:[]}})}async function jn(){const H=j.value;if(!H?.originalDataURL){ye("æ²¡æœ‰æœ‰æ•ˆçš„å›¾ç‰‡ç”¨äºæ£€æµ‹","warning");return}try{ye("æ­£åœ¨è‡ªåŠ¨æ£€æµ‹æ–‡æœ¬æ¡†...","info");const de=H.originalDataURL.match(/^data:image\/[^;]+;base64,(.+)$/)?.[1]||"";if(!de){ye("æ— æ³•è§£æå›¾ç‰‡æ•°æ®","error");return}const He=Fe(),{textDetector:ze,boxExpand:Pe,textStyle:Ve}=He.settings,Le=await uo(de,ze,{box_expand_ratio:Pe.ratio,box_expand_top:Pe.top,box_expand_bottom:Pe.bottom,box_expand_left:Pe.left,box_expand_right:Pe.right});if(Le.success&&Le.bubble_coords){i.updateCurrentImage({bubbleCoords:Le.bubble_coords,bubbleAngles:Le.bubble_angles||[]}),zo(H,Le.bubble_coords.length);const yt={bubble_coords:Le.bubble_coords.map(mt=>[...mt]),bubble_angles:Le.bubble_angles,auto_directions:Le.auto_directions},_t=Oo(yt,H,Ve);r.setBubbles(_t),Jt(),ye(`è‡ªåŠ¨æ£€æµ‹åˆ° ${Le.bubble_coords.length} ä¸ªæ–‡æœ¬æ¡†`,"success")}else ye(Le.error||"æ£€æµ‹å¤±è´¥","error")}catch(ue){console.error("è‡ªåŠ¨æ£€æµ‹å¤±è´¥:",ue),ye("è‡ªåŠ¨æ£€æµ‹å¤±è´¥","error")}}async function Yn(){if(ae.value.length<=1){ye("è‡³å°‘éœ€è¦ä¸¤å¼ å›¾ç‰‡æ‰èƒ½æ‰§è¡Œæ‰¹é‡æ£€æµ‹","warning");return}if(!confirm("æ­¤æ“ä½œå°†å¯¹æ‰€æœ‰å›¾ç‰‡è¿›è¡Œæ–‡æœ¬æ¡†æ£€æµ‹ï¼Œå¯èƒ½ä¼šè¦†ç›–å·²æœ‰çš„æ£€æµ‹ç»“æœã€‚ç¡®å®šç»§ç»­å—ï¼Ÿ"))return;const H=Fe(),{textDetector:ue,boxExpand:de,textStyle:He}=H.settings,ze=T.value,Pe=ae.value.length;ie.value=!0,Te.value="æ‰¹é‡æ£€æµ‹ä¸­",et.value=Pe,Ie.value=0;try{let Ve=0;for(let Le=0;Le<Pe;Le++){const yt=ae.value[Le];if(!yt?.originalDataURL)continue;Ie.value=Le+1;const mt=yt.originalDataURL.match(/^data:image\/[^;]+;base64,(.+)$/)?.[1]||"";if(!mt)continue;const vt=await uo(mt,ue,{box_expand_ratio:de.ratio,box_expand_top:de.top,box_expand_bottom:de.bottom,box_expand_left:de.left,box_expand_right:de.right});if(vt.success&&vt.bubble_coords){const wt=ae.value[Le];if(wt){wt.bubbleCoords=vt.bubble_coords,wt.bubbleAngles=vt.bubble_angles||[],zo(wt,vt.bubble_coords.length);const es={bubble_coords:vt.bubble_coords.map(ts=>[...ts]),bubble_angles:vt.bubble_angles,auto_directions:vt.auto_directions};wt.bubbleStates=Oo(es,wt,He),Ve+=vt.bubble_coords.length,Le===T.value&&Mt()}}}Te.value="æ£€æµ‹å®Œæˆ",Ie.value=Pe,ze!==T.value&&i.setCurrentImageIndex(ze),Mt(),ye(`æ‰¹é‡æ£€æµ‹å®Œæˆï¼å…±å¤„ç† ${Pe} å¼ å›¾ç‰‡ï¼Œæ£€æµ‹åˆ° ${Ve} ä¸ªæ–‡æœ¬æ¡†`,"success"),setTimeout(()=>{ie.value=!1},2e3)}catch(Ve){console.error("æ‰¹é‡æ£€æµ‹å¤±è´¥:",Ve),ye("æ‰¹é‡æ£€æµ‹å¤±è´¥","error"),ie.value=!1}}async function Jn(){if(!j.value?.originalDataURL){ye("æ²¡æœ‰æœ‰æ•ˆçš„å›¾ç‰‡ç”¨äºç¿»è¯‘","warning");return}if(we.value.length===0){ye("æ²¡æœ‰æ–‡æœ¬æ¡†å¯ç”¨äºç¿»è¯‘ï¼Œè¯·å…ˆæ£€æµ‹æˆ–æ·»åŠ æ–‡æœ¬æ¡†","warning");return}ye("æ­£åœ¨ä½¿ç”¨å½“å‰æ–‡æœ¬æ¡†ç¿»è¯‘...","info");try{await a()&&(ye("ç¿»è¯‘æˆåŠŸï¼","success"),Jt())}catch(ue){console.error("ç¿»è¯‘å¤±è´¥:",ue),ye(`ç¿»è¯‘å¤±è´¥: ${ue instanceof Error?ue.message:"æœªçŸ¥é”™è¯¯"}`,"error")}}function Xn(){P("repair")}function Gn(){P("restore")}function Vo(H){le(H)}function No(){I()}function Zn(H){Ht.value=!0,En.value=he.value==="horizontal"?H.clientX:H.clientY,document.body.style.cursor=he.value==="horizontal"?"col-resize":"row-resize",document.body.style.userSelect="none",document.addEventListener("mousemove",to),document.addEventListener("mouseup",oo),H.preventDefault()}function to(H){if(!Ht.value)return;const ue=ce.value?.parentElement?.parentElement;if(!ue)return;const de=ue.getBoundingClientRect();if(he.value==="horizontal"){const He=H.clientX-de.left,ze=de.width,Pe=Math.max(20,Math.min(80,He/ze*100)),Ve=ue.querySelector(".original-panel"),Le=ue.querySelector(".translated-panel");Ve&&Le&&(Ve.style.flex=`0 0 ${Pe}%`,Le.style.flex=`0 0 ${100-Pe}%`)}else{const He=H.clientY-de.top,ze=de.height,Pe=Math.max(20,Math.min(80,He/ze*100)),Ve=ue.querySelector(".original-panel"),Le=ue.querySelector(".translated-panel");Ve&&Le&&(Ve.style.flex=`0 0 ${Pe}%`,Le.style.flex=`0 0 ${100-Pe}%`)}}function oo(){Ht.value=!1,document.body.style.cursor="",document.body.style.userSelect="",document.removeEventListener("mousemove",to),document.removeEventListener("mouseup",oo)}function Qn(H){jt.value=!0;const ue=Ce.value;ue&&(Dt.value={x:H.clientX,y:H.clientY,size:he.value==="horizontal"?ue.offsetWidth:ue.offsetHeight},document.body.style.cursor=he.value==="horizontal"?"ew-resize":"ns-resize",document.body.style.userSelect="none",document.addEventListener("mousemove",no),document.addEventListener("mouseup",so),H.preventDefault())}function no(H){if(!(!jt.value||!Ce.value))if(he.value==="horizontal"){const ue=Dt.value.x-H.clientX;let de=Dt.value.size+ue;de=Math.max(300,Math.min(window.innerWidth*.6,de)),Ce.value.style.flex=`0 0 ${de}px`,Ce.value.style.minWidth=`${de}px`}else{const ue=Dt.value.y-H.clientY;let de=Dt.value.size+ue;de=Math.max(200,Math.min(window.innerHeight*.5,de)),Ce.value.style.flex=`0 0 ${de}px`,Ce.value.style.height=`${de}px`}}function so(){jt.value=!1,document.body.style.cursor="",document.body.style.userSelect="",document.removeEventListener("mousemove",no),document.removeEventListener("mouseup",so)}function Wo(H){const ue=H.target,de=H.key.toLowerCase();if(de==="r"||de==="u"||de==="a"||de==="d"){if(ue.tagName==="TEXTAREA")return;(ue.tagName==="INPUT"||ue.tagName==="SELECT"||ue.tagName==="BUTTON")&&ue.blur()}else if(ue.tagName==="INPUT"||ue.tagName==="TEXTAREA"||ue.tagName==="SELECT")return;switch(H.key){case"Escape":Ho();break;case"Delete":case"Backspace":!m.value&&me.value&&(Z(),H.preventDefault());break;case"a":case"A":m.value||(Mo(),H.preventDefault());break;case"d":case"D":m.value||(Xt(),H.preventDefault());break;case"Enter":H.ctrlKey&&!m.value&&(Ko(),H.preventDefault());break;case"r":case"R":w.value||(P("repair"),H.preventDefault());break;case"u":case"U":w.value||(P("restore"),H.preventDefault());break;case"+":case"=":Ro(),H.preventDefault();break;case"-":Po(),H.preventDefault();break;case"0":Do(),H.preventDefault();break}}function qo(H){(H.key==="r"||H.key==="R"||H.key==="u"||H.key==="U")&&(O(),H.preventDefault())}async function Ko(){Gt(),await u(),Re.value?Xt():ye("å·²æ˜¯æœ€åä¸€å¼ å›¾ç‰‡","info")}function Ho(){Gt(),o("exit")}return dt(()=>{try{const H=localStorage.getItem(tn);(H==="horizontal"||H==="vertical")&&(he.value=H)}catch(H){console.warn("åŠ è½½å¸ƒå±€æ¨¡å¼å¤±è´¥:",H)}document.addEventListener("keydown",Wo),document.addEventListener("keyup",qo),document.addEventListener("mousemove",Vo),document.addEventListener("mouseup",No),n.isEditModeActive&&(Mt(),pt(()=>{ve.value?.focus()}))}),Ut(()=>{document.removeEventListener("keydown",Wo),document.removeEventListener("keyup",qo),document.removeEventListener("mousemove",Vo),document.removeEventListener("mouseup",No),document.removeEventListener("mousemove",Qt),document.removeEventListener("mouseup",eo),document.removeEventListener("mousemove",to),document.removeEventListener("mouseup",oo),document.removeEventListener("mousemove",no),document.removeEventListener("mouseup",so)}),_e(()=>n.isEditModeActive,H=>{H&&(Mt(),pt(()=>{ve.value?.focus()}))}),_e(T,()=>{n.isEditModeActive&&Mt()}),_e(f,H=>{H&&(Be.value=H.inpaintMethod||"solid",E.value=H.fillColor||"#FFFFFF")},{immediate:!0}),(H,ue)=>s.isEditModeActive?(A(),U("div",{key:0,class:Ee(["edit-workspace",[`layout-${he.value}`,{"drawing-mode":re(g)},{"brush-mode-active":!!re(m)}]]),"data-brush-mode":re(m)||void 0,tabindex:"0",ref_key:"workspaceRef",ref:ve},[xe(jv,{"current-image-index":re(T),"image-count":re(ge),"can-go-previous":re(Se),"can-go-next":re(Re),"show-thumbnails":lt.value,"has-bubbles":re(pe),"selected-bubble-index":re(be),"bubble-count":re(N),"layout-mode":he.value,"sync-enabled":Xe.value,scale:ht.value,"is-drawing-mode":re(g),"has-selection":re(me),"brush-mode":re(m),"brush-size":re(l),"mouse-x":re(p),"mouse-y":re($),"is-processing":ie.value,"progress-text":Te.value,"progress-current":Ie.value,"progress-total":et.value,onGoPreviousImage:Mo,onGoNextImage:Xt,onToggleThumbnails:Un,onSelectPreviousBubble:Ln,onSelectNextBubble:Fn,onToggleLayout:zn,onToggleViewMode:On,onToggleSync:Vn,onFitToScreen:Bt,onZoomIn:Ro,onZoomOut:Po,onResetZoom:Do,onExitEditMode:Ho,onAutoDetectBubbles:jn,onDetectAllImages:Yn,onTranslateWithBubbles:Jn,onToggleDrawingMode:re(F),onDeleteSelectedBubbles:re(Z),onRepairSelectedBubble:re(W),onActivateRepairBrush:Xn,onActivateRestoreBrush:Gn,onApplyAndNext:Ko},null,8,["current-image-index","image-count","can-go-previous","can-go-next","show-thumbnails","has-bubbles","selected-bubble-index","bubble-count","layout-mode","sync-enabled","scale","is-drawing-mode","has-selection","brush-mode","brush-size","mouse-x","mouse-y","is-processing","progress-text","progress-current","progress-total","onToggleDrawingMode","onDeleteSelectedBubbles","onRepairSelectedBubble"]),xe(ef,{visible:lt.value,images:re(ae),"current-image-index":re(T),onSwitchToImage:An},null,8,["visible","images","current-image-index"]),e("div",of,[e("div",nf,[ne(e("div",{class:Ee(["image-panel original-panel",{collapsed:Me.value==="translated"||Ge.value}])},[e("div",sf,[ue[8]||(ue[8]=e("span",{class:"panel-title"},"ğŸ“– åŸå›¾ (æ—¥æ–‡)",-1)),e("button",{class:"panel-toggle",onClick:ue[0]||(ue[0]=de=>Ge.value=!Ge.value),title:"æŠ˜å /å±•å¼€"},se(Ge.value?"+":"âˆ’"),1)]),e("div",{ref_key:"originalViewportRef",ref:ce,class:"image-viewport",onWheel:ue[2]||(ue[2]=it(de=>Bo(de,"original"),["prevent"])),onMousedown:ue[3]||(ue[3]=de=>Eo(de,"original")),onDblclick:Bt},[e("div",{ref_key:"originalWrapperRef",ref:$e,class:"image-canvas-wrapper",style:at(Mn.value)},[re(j)?.originalDataURL?(A(),U("img",{key:0,src:re(j).originalDataURL,alt:"åŸå›¾",onLoad:ue[1]||(ue[1]=de=>Uo("original"))},null,40,af)):fe("",!0),re(j)?.originalDataURL?(A(),ut(pn,{key:1,bubbles:re(we),"selected-index":re(be),"selected-indices":re(X),scale:Dn.value,"is-drawing-mode":re(g),"is-brush-mode":!!re(m),"image-width":B.value,"image-height":G.value,onSelect:re(D),onMultiSelect:re(R),onDragStart:re(k),onDragging:re(Y),onDragEnd:re(V),onResizeStart:re(L),onResizing:re(v),onResizeEnd:re(d),onRotateStart:re(h),onRotating:re(y),onRotateEnd:re(z),onDrawBubble:re(te)},null,8,["bubbles","selected-index","selected-indices","scale","is-drawing-mode","is-brush-mode","image-width","image-height","onSelect","onMultiSelect","onDragStart","onDragging","onDragEnd","onResizeStart","onResizing","onResizeEnd","onRotateStart","onRotating","onRotateEnd","onDrawBubble"])):fe("",!0),re(x)?(A(),U("div",{key:2,class:"drawing-rect-edit",style:at(re(J)())},null,4)):fe("",!0)],4)],544)],2),[[Oe,Me.value!=="translated"]]),Me.value==="dual"?(A(),U("div",{key:0,class:Ee(["panel-divider",{"vertical-divider":he.value==="vertical"}]),onMousedown:Zn},null,34)):fe("",!0),ne(e("div",{class:Ee(["image-panel translated-panel",{collapsed:Me.value==="original"||st.value}])},[e("div",lf,[ue[9]||(ue[9]=e("span",{class:"panel-title"},"ğŸ“ ç¿»è¯‘å›¾ (ä¸­æ–‡)",-1)),e("button",{class:"panel-toggle",onClick:ue[4]||(ue[4]=de=>st.value=!st.value),title:"æŠ˜å /å±•å¼€"},se(st.value?"+":"âˆ’"),1)]),e("div",{ref_key:"translatedViewportRef",ref:De,class:"image-viewport",onWheel:ue[6]||(ue[6]=it(de=>Bo(de,"translated"),["prevent"])),onMousedown:ue[7]||(ue[7]=de=>Eo(de,"translated")),onDblclick:Bt},[e("div",{ref_key:"translatedWrapperRef",ref:Ae,class:"image-canvas-wrapper",style:at(Bn.value)},[re(j)?.translatedDataURL||re(j)?.originalDataURL?(A(),U("img",{key:0,src:re(j)?.translatedDataURL||re(j)?.originalDataURL,alt:"ç¿»è¯‘å›¾",onLoad:ue[5]||(ue[5]=de=>Uo("translated"))},null,40,rf)):fe("",!0),re(j)?.translatedDataURL||re(j)?.originalDataURL?(A(),ut(pn,{key:1,bubbles:re(we),"selected-index":re(be),"selected-indices":re(X),scale:ht.value,"is-drawing-mode":re(g),"is-brush-mode":!!re(m),"image-width":B.value,"image-height":G.value,onSelect:re(D),onMultiSelect:re(R),onDragStart:re(k),onDragging:re(Y),onDragEnd:re(V),onResizeStart:re(L),onResizing:re(v),onResizeEnd:re(d),onRotateStart:re(h),onRotating:re(y),onRotateEnd:re(z),onDrawBubble:re(te)},null,8,["bubbles","selected-index","selected-indices","scale","is-drawing-mode","is-brush-mode","image-width","image-height","onSelect","onMultiSelect","onDragStart","onDragging","onDragEnd","onResizeStart","onResizing","onResizeEnd","onRotateStart","onRotating","onRotateEnd","onDrawBubble"])):fe("",!0),re(x)?(A(),U("div",{key:2,class:"drawing-rect-edit translated-drawing-rect",style:at(re(J)())},null,4)):fe("",!0)],4)],544)],2),[[Oe,Me.value!=="original"]])]),e("div",{ref_key:"editPanelRef",ref:Ce,class:"edit-panel-container"},[e("div",{class:"panel-resize-handle vertical",onMousedown:Qn}," â‹®â‹®â‹® ",32),xe(yv,{bubble:re(f),"bubble-index":re(be),onUpdate:Wn,onReRender:Nn,onOcrRecognize:re(oe),onReTranslate:Hn,onApplyBubble:qn,onResetCurrent:Kn},null,8,["bubble","bubble-index","onOcrRecognize"])],512)])],10,tf)):fe("",!0)}}),cf=je(uf,[["__scopeId","data-v-7cf83f19"]]),df={class:"app-header"},gf={class:"header-content"},pf={class:"logo-container"},mf={class:"header-links"},vf={class:"container"},ff={id:"image-display-area"},bf={id:"upload-section",class:"card upload-card"},hf={class:"upload-actions"},yf={key:1,class:"bookshelf-mode-hint"},xf=Ye({__name:"TranslateView",setup(s){const t=vn(),n=ot(),o=Fe(),i=It(),r=gt(),{validateBeforeTranslation:a,initValidation:u}=kn(),g=Io(),S=xi(),x=C(!1),_=C(void 0),D=C(!1),R=C(!1),M=Q(()=>n.currentImage),k=Q(()=>n.hasImages),Y=Q(()=>n.isBatchTranslationInProgress),V=Q(()=>n.failedImageCount>0),L=Q(()=>!!t.query.book&&!!t.query.chapter),v=Q(()=>t.query.book),d=Q(()=>t.query.chapter),h=Q(()=>S.currentBookTitle.value),y=Q(()=>S.currentChapterTitle.value),z=Q(()=>L.value&&y.value&&h.value?`${y.value} - ${h.value}`:"Saber-Translator");dt(async()=>{n.clearImages(),r.clearBubbles(),await S.initializeApp(),u(),window.addEventListener("keydown",f)}),Ut(()=>{window.removeEventListener("keydown",f)}),_e(()=>[t.query.book,t.query.chapter],async([B,G],[ve,ce])=>{B&&G?(n.clearImages(),r.clearBubbles(),await K()):ve&&ce&&!B&&!G&&(n.clearImages(),r.clearBubbles(),await S.initializeBookChapterContext(),console.log("[TranslateView] ä»ä¹¦æ¶æ¨¡å¼åˆ‡æ¢åˆ°å¿«é€Ÿç¿»è¯‘æ¨¡å¼ï¼Œå·²æ¸…ç©ºæ•°æ®"))}),_e(z,B=>{typeof document<"u"&&(document.title=B)},{immediate:!0});const F=C(!1);function te(B){if(!B)return;const G=o.settings.textStyle;o.updateTextStyle({fontSize:B.fontSize??G.fontSize,autoFontSize:B.autoFontSize??G.autoFontSize,fontFamily:B.fontFamily??G.fontFamily,layoutDirection:B.layoutDirection??G.layoutDirection,textColor:B.textColor??G.textColor,fillColor:B.fillColor??G.fillColor,strokeEnabled:B.strokeEnabled??G.strokeEnabled,strokeColor:B.strokeColor??G.strokeColor,strokeWidth:B.strokeWidth??G.strokeWidth,inpaintMethod:B.inpaintMethod??G.inpaintMethod,useAutoTextColor:B.useAutoTextColor??G.useAutoTextColor})}function J(B){n.currentImage&&n.updateCurrentImage({fontSize:B.fontSize,autoFontSize:B.autoFontSize,fontFamily:B.fontFamily,layoutDirection:B.layoutDirection,textColor:B.textColor,fillColor:B.fillColor,strokeEnabled:B.strokeEnabled,strokeColor:B.strokeColor,strokeWidth:B.strokeWidth,inpaintMethod:B.inpaintMethod,useAutoTextColor:B.useAutoTextColor})}_e(()=>n.currentImage,B=>{if(B&&!F.value){F.value=!0;try{te(B),console.log(`[TranslateView] å·²åŒæ­¥å›¾ç‰‡ ${n.currentImageIndex} çš„æ–‡å­—è®¾ç½®åˆ°ä¾§è¾¹æ `)}finally{F.value=!1}}},{immediate:!1}),_e(()=>o.settings.textStyle,B=>{if(n.currentImage&&!F.value){F.value=!0;try{J(B),console.log(`[TranslateView] å·²å°†ä¾§è¾¹æ è®¾ç½®åŒæ­¥åˆ°å›¾ç‰‡ ${n.currentImageIndex}`)}finally{F.value=!1}}},{deep:!0});async function K(){if(!(!v.value||!d.value))try{await S.initializeBookChapterContext()}catch(B){console.error("åŠ è½½ç« èŠ‚ä¼šè¯å¤±è´¥:",B),ye("åŠ è½½ç« èŠ‚ä¼šè¯å¤±è´¥","error")}}function Z(B){console.log(`ä¸Šä¼ å®Œæˆï¼Œå…± ${B} å¼ å›¾ç‰‡`),n.hasImages&&(n.sortImagesByFileName(),S.switchImage(0))}async function W(B){if(!Object.values(B).some(ce=>ce)){ye("è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè¦åº”ç”¨çš„è®¾ç½®é¡¹","warning");return}if(n.images.length===0){ye("æ²¡æœ‰å¯åº”ç”¨çš„å›¾ç‰‡","warning");return}if(n.images.length<=1){ye("åªæœ‰ä¸€å¼ å›¾ç‰‡ï¼Œæ— éœ€åº”ç”¨åˆ°å…¨éƒ¨","info");return}if(!n.images.some(ce=>ce.bubbleStates&&ce.bubbleStates.length>0)){ye("æ²¡æœ‰å·²ç¿»è¯‘çš„å›¾ç‰‡","warning");return}try{const{textStyle:ce}=o.settings,$e=ce.layoutDirection==="auto",De=ce.useAutoTextColor===!0,Ae=ce.autoFontSize===!0,Ce={fontSize:ce.fontSize,fontFamily:ce.fontFamily,textDirection:ce.layoutDirection==="auto"?"vertical":ce.layoutDirection,textColor:ce.textColor,fillColor:ce.fillColor,strokeEnabled:ce.strokeEnabled,strokeColor:ce.strokeColor,strokeWidth:ce.strokeWidth},Me=E=>{if(!E||E.length!==3)return null;const[ie,Te,Ie]=E;return"#"+[ie,Te,Ie].map(et=>{const Ke=Math.max(0,Math.min(255,Math.round(et))).toString(16);return Ke.length===1?"0"+Ke:Ke}).join("")},he=E=>{const ie={...E};if(B.fontSize&&!Ae&&(ie.fontSize=Ce.fontSize),B.fontFamily&&(ie.fontFamily=Ce.fontFamily),B.layoutDirection)if($e){const Te=E.autoTextDirection;ie.textDirection=Te==="vertical"||Te==="horizontal"?Te:"vertical"}else ie.textDirection=Ce.textDirection;if(B.textColor)if(De&&E.autoFgColor){const Te=Me(E.autoFgColor);ie.textColor=Te??Ce.textColor}else ie.textColor=Ce.textColor;if(B.fillColor)if(De&&E.autoBgColor){const Te=Me(E.autoBgColor);ie.fillColor=Te??Ce.fillColor}else ie.fillColor=Ce.fillColor;return B.strokeEnabled&&(ie.strokeEnabled=Ce.strokeEnabled),B.strokeColor&&(ie.strokeColor=Ce.strokeColor),B.strokeWidth&&(ie.strokeWidth=Ce.strokeWidth),ie};let lt=0;const Xe=n.images;for(let E=0;E<Xe.length;E++){const ie=Xe[E];if(ie&&ie.bubbleStates&&ie.bubbleStates.length>0){const Ie={bubbleStates:ie.bubbleStates.map(he)};B.fontSize&&(Ie.autoFontSize=Ae,Ae||(Ie.fontSize=Ce.fontSize)),B.fontFamily&&(Ie.fontFamily=Ce.fontFamily),B.layoutDirection&&(Ie.layoutDirection=ce.layoutDirection),(B.textColor||B.fillColor)&&(Ie.useAutoTextColor=De),B.textColor&&(De||(Ie.textColor=Ce.textColor)),B.fillColor&&(De||(Ie.fillColor=Ce.fillColor)),B.strokeEnabled&&(Ie.strokeEnabled=Ce.strokeEnabled),B.strokeColor&&(Ie.strokeColor=Ce.strokeColor),B.strokeWidth&&(Ie.strokeWidth=Ce.strokeWidth),n.updateImageByIndex(E,Ie),lt++}}if(r.bubbles.length>0){const E=r.bubbles.map(he);r.setBubbles(E)}const Ge=[];B.fontSize&&Ge.push(Ae?"è‡ªåŠ¨å­—å·":"å­—å·"),B.fontFamily&&Ge.push("å­—ä½“"),B.layoutDirection&&Ge.push($e?"è‡ªåŠ¨æ’ç‰ˆæ–¹å‘":"æ’ç‰ˆæ–¹å‘"),B.textColor&&Ge.push(De?"è‡ªåŠ¨æ–‡å­—é¢œè‰²":"æ–‡å­—é¢œè‰²"),B.fillColor&&Ge.push(De?"è‡ªåŠ¨å¡«å……é¢œè‰²":"å¡«å……é¢œè‰²"),B.strokeEnabled&&Ge.push("æè¾¹å¼€å…³"),B.strokeColor&&Ge.push("æè¾¹é¢œè‰²"),B.strokeWidth&&Ge.push("æè¾¹å®½åº¦");const st=[];for(let E=0;E<Xe.length;E++){const ie=Xe[E];ie&&ie.translatedDataURL&&ie.bubbleStates&&ie.bubbleStates.length>0&&st.push(E)}if(st.length>0){g.progress.value={isInProgress:!0,current:0,total:st.length,completed:0,failed:0,label:`åº”ç”¨è®¾ç½®ä¸­ï¼š0 / ${st.length}`,percentage:0};const{parallelRender:E}=await rt(async()=>{const{parallelRender:Te}=await Promise.resolve().then(()=>Ql);return{parallelRender:Te}},void 0);let ie=0;for(let Te=0;Te<st.length;Te++){const Ie=st[Te];if(Ie===void 0)continue;const et=n.images[Ie];if(!(!et||!et.bubbleStates))try{let Ke="";if(et.cleanImageData?Ke=et.cleanImageData.includes("base64,")?et.cleanImageData.split("base64,")[1]||"":et.cleanImageData:et.originalDataURL&&(Ke=et.originalDataURL.includes("base64,")?et.originalDataURL.split("base64,")[1]||"":et.originalDataURL,console.log(`handleApplyToAll: å›¾ç‰‡ ${Ie} ä½¿ç”¨åŸå›¾ä½œä¸ºèƒŒæ™¯ï¼ˆå…œåº•ï¼‰`)),!Ke){console.log(`handleApplyToAll: å›¾ç‰‡ ${Ie} æ²¡æœ‰å¯ç”¨çš„èƒŒæ™¯å›¾ï¼Œè·³è¿‡`),g.progress.value.failed++;continue}const Ze=et.bubbleStates.map(tt=>({originalText:tt.originalText||"",translatedText:tt.translatedText||"",textboxText:tt.textboxText||"",coords:tt.coords,polygon:tt.polygon,fontSize:tt.fontSize,fontFamily:tt.fontFamily,textDirection:tt.textDirection,autoTextDirection:tt.autoTextDirection,textColor:tt.textColor,fillColor:tt.fillColor,rotationAngle:tt.rotationAngle||0,position:tt.position||{x:0,y:0},strokeEnabled:tt.strokeEnabled,strokeColor:tt.strokeColor,strokeWidth:tt.strokeWidth,inpaintMethod:tt.inpaintMethod,autoFgColor:tt.autoFgColor,autoBgColor:tt.autoBgColor})),ht=await E({clean_image:Ke,bubble_states:Ze,fontSize:ce.fontSize,fontFamily:ce.fontFamily,textDirection:ce.layoutDirection==="auto"?"vertical":ce.layoutDirection,textColor:ce.textColor,strokeEnabled:ce.strokeEnabled,strokeColor:ce.strokeColor,strokeWidth:ce.strokeWidth,autoFontSize:B.fontSize&&Ae,use_individual_styles:!0});if(ht.success&&ht.final_image){const tt=ht.bubble_states||et.bubbleStates;n.updateImageByIndex(Ie,{translatedDataURL:`data:image/png;base64,${ht.final_image}`,bubbleStates:tt,hasUnsavedChanges:!0}),ie++,g.progress.value.current=ie,g.progress.value.label=`åº”ç”¨è®¾ç½®ä¸­ï¼š${ie} / ${st.length}`,g.progress.value.percentage=Math.round(ie/st.length*100)}else g.progress.value.failed++}catch(Ke){console.error(`é‡æ¸²æŸ“å›¾ç‰‡ ${Ie} å¤±è´¥:`,Ke),g.progress.value.failed++}}g.progress.value.isInProgress=!1}const Be=n.currentImage;if(Be){F.value=!0;try{te(Be),console.log("[TranslateView] åº”ç”¨åˆ°å…¨éƒ¨å®Œæˆï¼Œå·²åŒæ­¥å½“å‰å›¾ç‰‡è®¾ç½®åˆ°ä¾§è¾¹æ ")}finally{F.value=!1}}ye(`å·²å°† ${Ge.join("ã€")} åº”ç”¨åˆ° ${lt} å¼ å›¾ç‰‡`,"success"),console.log(`[TranslateView] åº”ç”¨è®¾ç½®åˆ°å…¨éƒ¨å®Œæˆï¼Œæ›´æ–°äº† ${lt} å¼ å›¾ç‰‡ï¼Œé‡æ¸²æŸ“äº† ${st.length} å¼ `)}catch(ce){console.error("åº”ç”¨è®¾ç½®åˆ°å…¨éƒ¨å¤±è´¥:",ce),ye("åº”ç”¨è®¾ç½®å¤±è´¥","error")}}async function oe(){M.value&&a("normal")&&await g.translateCurrentImage()}async function b(){k.value&&a("normal")&&await g.translateAllImages()}async function c(){k.value&&a("hq")&&await g.executeHqTranslation()}async function m(){k.value&&a("proofread")&&await g.executeProofreading()}async function l(){M.value&&await g.removeTextOnly()}async function p(){k.value&&await g.removeAllTexts()}async function $(B,G){k.value&&a("normal")&&await g.translateImageRange({startPage:B,endPage:G})}async function w(B,G){k.value&&a("hq")&&await g.executeHqTranslation({startPage:B,endPage:G})}async function P(B,G){k.value&&a("proofread")&&await g.executeProofreading({startPage:B,endPage:G})}async function O(B,G){k.value&&await g.removeTextRange({startPage:B,endPage:G})}function ee(){if(!M.value)return;const B=M.value.fileName||`å›¾ç‰‡ ${n.currentImageIndex+1}`;confirm(`ç¡®å®šè¦åˆ é™¤å½“å‰å›¾ç‰‡ (${B}) å—ï¼Ÿ`)&&(n.deleteCurrentImage(),ye("å›¾ç‰‡å·²åˆ é™¤","success"))}function le(){k.value&&confirm("ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰å›¾ç‰‡å—ï¼Ÿè¿™å°†ä¸¢å¤±æ‰€æœ‰æœªä¿å­˜çš„è¿›åº¦ã€‚")&&(n.clearImages(),ye("æ‰€æœ‰å›¾ç‰‡å·²æ¸…é™¤","success"))}async function I(){try{const B=await fn(),G=await fo();if(B.success&&G.success)ye("ä¸´æ—¶æ–‡ä»¶æ¸…ç†å®Œæˆ","success");else{const ve=[];B.success||ve.push("è°ƒè¯•æ–‡ä»¶æ¸…ç†å¤±è´¥"),G.success||ve.push("ä¸´æ—¶æ–‡ä»¶æ¸…ç†å¤±è´¥"),ye(ve.join("ï¼Œ"),"warning")}}catch{ye("æ¸…ç†ä¸´æ—¶æ–‡ä»¶å¤±è´¥","error")}}function q(){S.goToPrevious()}function ae(){S.goToNext()}function T(){R.value=!R.value}async function j(){if(!V.value){ye("æ²¡æœ‰å¤±è´¥çš„å›¾ç‰‡éœ€è¦é‡æ–°ç¿»è¯‘","info");return}a("normal")&&await g.retryFailedImages()}async function ge(){if(!k.value){ye("æ²¡æœ‰å¯ä¿å­˜çš„å†…å®¹","warning");return}if(!(!v.value||!d.value))try{await i.saveChapterSession(v.value,d.value)?ye("ç« èŠ‚è¿›åº¦å·²ä¿å­˜","success"):ye("ä¿å­˜å¤±è´¥","error")}catch(B){console.error("ä¿å­˜ä¼šè¯å¤±è´¥:",B),ye("ä¿å­˜å¤±è´¥: "+(B instanceof Error?B.message:"æœªçŸ¥é”™è¯¯"),"error")}}function Se(B){_.value=B,x.value=!0}function Re(){Se("plugins")}function we(){ye("è®¾ç½®å·²ä¿å­˜","success")}function be(){D.value=!0}function X(){ye("ğŸŒ™ è¯¥åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­ï¼Œæ•¬è¯·æœŸå¾…ï¼","info")}function f(B){const G=B.target;if(!(G instanceof HTMLInputElement||G instanceof HTMLTextAreaElement||G.getAttribute("contenteditable")==="true"||G.id==="bubbleTextEditor")&&!R.value&&B.altKey)switch(B.key){case"ArrowLeft":B.preventDefault(),q();break;case"ArrowRight":B.preventDefault(),ae();break;case"ArrowUp":if(B.preventDefault(),!o.settings.textStyle.autoFontSize){const ce=o.settings.textStyle.fontSize;o.updateTextStyle({fontSize:ce+1})}break;case"ArrowDown":if(B.preventDefault(),!o.settings.textStyle.autoFontSize){const ce=o.settings.textStyle.fontSize;o.updateTextStyle({fontSize:Math.max(10,ce-1)})}break}}async function N(B){const G=M.value;if(!G||!G.translatedDataURL){console.log(`è‡ªåŠ¨å­—å·è®¾ç½®å˜æ›´: ${B} (ä»…å½±å“ä¸‹æ¬¡ç¿»è¯‘)`);return}const ve=G.bubbleStates;if(!ve||!Array.isArray(ve)||ve.length===0){console.log("å½“å‰å›¾ç‰‡æ²¡æœ‰ bubbleStatesï¼Œè·³è¿‡é‡æ¸²æŸ“");return}if(console.log(`è‡ªåŠ¨å­—å·è®¾ç½®å˜æ›´: ${B}ï¼Œå°†é‡æ–°æ¸²æŸ“...`),B){console.log("è‡ªåŠ¨å­—å·å·²å¼€å¯ï¼Œé‡æ–°è®¡ç®—å­—å·å¹¶æ¸²æŸ“...");try{const{apiClient:ce}=await rt(async()=>{const{apiClient:he}=await import("./client.Bht704G-.js");return{apiClient:he}},__vite__mapDeps([4,5]));let $e="";if(G.cleanImageData){const he=G.cleanImageData;$e=he.includes("base64,")?he.split("base64,")[1]||"":he}else G.originalDataURL&&($e=G.originalDataURL.includes("base64,")?G.originalDataURL.split("base64,")[1]||"":G.originalDataURL);if(!$e){console.log("æ²¡æœ‰å¯ç”¨çš„èƒŒæ™¯å›¾ï¼Œè·³è¿‡é‡æ¸²æŸ“");return}const De=ve.map(he=>({translatedText:he.translatedText||"",coords:he.coords,fontSize:he.fontSize||o.settings.textStyle.fontSize,fontFamily:he.fontFamily||o.settings.textStyle.fontFamily,textDirection:At(he),textColor:he.textColor||o.settings.textStyle.textColor,rotationAngle:he.rotationAngle||0,position:he.position||{x:0,y:0},strokeEnabled:he.strokeEnabled??o.settings.textStyle.strokeEnabled,strokeColor:he.strokeColor||o.settings.textStyle.strokeColor,strokeWidth:he.strokeWidth??o.settings.textStyle.strokeWidth})),Ae=De.map(he=>he.translatedText),Ce=De.map(he=>he.coords),Me=await ce.post("/api/re_render_image",{clean_image:$e,bubble_texts:Ae,bubble_coords:Ce,fontSize:o.settings.textStyle.fontSize,fontFamily:o.settings.textStyle.fontFamily,textDirection:o.settings.textStyle.layoutDirection==="auto"?"vertical":o.settings.textStyle.layoutDirection,textColor:o.settings.textStyle.textColor,bubble_states:De,use_individual_styles:!0,use_inpainting:!1,use_lama:!1,fillColor:null,is_font_style_change:!0,autoFontSize:!0,strokeEnabled:o.settings.textStyle.strokeEnabled,strokeColor:o.settings.textStyle.strokeColor,strokeWidth:o.settings.textStyle.strokeWidth});if(Me.rendered_image){if(Me.bubble_states&&Array.isArray(Me.bubble_states)){const he=ve.map((lt,Xe)=>({...lt,fontSize:Me.bubble_states[Xe]?.fontSize??lt.fontSize}));n.updateCurrentImage({translatedDataURL:`data:image/png;base64,${Me.rendered_image}`,bubbleStates:he,hasUnsavedChanges:!0}),r.setBubbles(he)}else n.updateCurrentImage({translatedDataURL:`data:image/png;base64,${Me.rendered_image}`,hasUnsavedChanges:!0});console.log("è‡ªåŠ¨å­—å·æ¸²æŸ“æˆåŠŸ")}else Me.error&&(console.error("è‡ªåŠ¨å­—å·æ¸²æŸ“å¤±è´¥:",Me.error),ye("é‡æ–°æ¸²æŸ“å¤±è´¥: "+Me.error,"error"))}catch(ce){console.error("è‡ªåŠ¨å­—å·æ¸²æŸ“å‡ºé”™:",ce)}}else{const ce=o.settings.textStyle.fontSize;console.log(`è‡ªåŠ¨å­—å·å·²å…³é—­ï¼Œä½¿ç”¨å›ºå®šå­—å· ${ce} æ¸²æŸ“...`);const $e=ve.map(De=>({...De,fontSize:ce}));n.updateCurrentImage({bubbleStates:$e}),r.setBubbles($e),await pe("fontSize",ce)}}async function pe(B,G){const ve=M.value;if(!ve||!ve.translatedDataURL||!ve.bubbleStates||ve.bubbleStates.length===0||!["fontSize","fontFamily","layoutDirection","textColor","strokeEnabled","strokeColor","strokeWidth","fillColor"].includes(B))return;console.log(`å…¨å±€è®¾ç½®å˜æ›´ (${B}=${G})ï¼Œå‡†å¤‡é‡æ¸²æŸ“...`);const De={fontSize:"fontSize",fontFamily:"fontFamily",layoutDirection:"textDirection",textColor:"textColor",strokeEnabled:"strokeEnabled",strokeColor:"strokeColor",strokeWidth:"strokeWidth",fillColor:"fillColor"}[B];if(De&&ve.bubbleStates)if(B==="layoutDirection")if(G==="auto"){console.log("æ’ç‰ˆæ–¹å‘è®¾ç½®ä¸º 'auto'ï¼Œä» autoTextDirection æ¢å¤æ¯ä¸ªæ°”æ³¡çš„æ’ç‰ˆæ–¹å‘");const Ae=ve.bubbleStates.map(Ce=>({...Ce,textDirection:Ce.autoTextDirection==="vertical"||Ce.autoTextDirection==="horizontal"?Ce.autoTextDirection:"vertical"}));n.updateCurrentImage({bubbleStates:Ae}),r.setBubbles(Ae)}else{console.log(`æ’ç‰ˆæ–¹å‘è®¾ç½®ä¸º '${G}'ï¼Œåº”ç”¨åˆ°æ‰€æœ‰æ°”æ³¡`);const Ae=ve.bubbleStates.map(Ce=>({...Ce,textDirection:G}));n.updateCurrentImage({bubbleStates:Ae}),r.setBubbles(Ae)}else{const Ae=ve.bubbleStates.map(Ce=>({...Ce,[De]:G}));n.updateCurrentImage({bubbleStates:Ae}),r.setBubbles(Ae)}try{const Ce=n.currentImage?.bubbleStates||ve.bubbleStates||[];if(Ce.length===0||!Ce[0]?.coords){console.log("æ²¡æœ‰æœ‰æ•ˆçš„æ°”æ³¡åæ ‡ï¼Œè·³è¿‡é‡æ¸²æŸ“");return}const Me=o.settings.textStyle.layoutDirection,he=Ce.map(E=>({translatedText:E.translatedText||"",coords:E.coords,fontSize:E.fontSize||o.settings.textStyle.fontSize,fontFamily:E.fontFamily||o.settings.textStyle.fontFamily,textDirection:At(E),textColor:E.textColor||o.settings.textStyle.textColor,rotationAngle:E.rotationAngle||0,position:E.position||{x:0,y:0},strokeEnabled:E.strokeEnabled??o.settings.textStyle.strokeEnabled,strokeColor:E.strokeColor||o.settings.textStyle.strokeColor,strokeWidth:E.strokeWidth??o.settings.textStyle.strokeWidth})),lt=he.map(E=>E.translatedText),Xe=he.map(E=>E.coords);let Ge="";if(ve.cleanImageData){const E=ve.cleanImageData;Ge=E.includes("base64,")?E.split("base64,")[1]||"":E}else ve.originalDataURL&&(Ge=ve.originalDataURL.includes("base64,")?ve.originalDataURL.split("base64,")[1]||"":ve.originalDataURL,console.log("handleTextStyleChanged: ä½¿ç”¨åŸå›¾ä½œä¸ºèƒŒæ™¯ï¼ˆå…œåº•ï¼‰"));if(!Ge){console.log("æ²¡æœ‰å¯ç”¨çš„èƒŒæ™¯å›¾ï¼Œè·³è¿‡é‡æ¸²æŸ“");return}const{apiClient:st}=await rt(async()=>{const{apiClient:E}=await import("./client.Bht704G-.js");return{apiClient:E}},__vite__mapDeps([4,5])),Be=await st.post("/api/re_render_image",{clean_image:Ge,bubble_texts:lt,bubble_coords:Xe,fontSize:o.settings.textStyle.fontSize,fontFamily:o.settings.textStyle.fontFamily,textDirection:Me==="auto"?"vertical":Me,textColor:o.settings.textStyle.textColor,bubble_states:he,use_individual_styles:!0,use_inpainting:!1,use_lama:!1,fillColor:null,is_font_style_change:!0,strokeEnabled:o.settings.textStyle.strokeEnabled,strokeColor:o.settings.textStyle.strokeColor,strokeWidth:o.settings.textStyle.strokeWidth});Be.rendered_image?(n.updateCurrentImage({translatedDataURL:`data:image/png;base64,${Be.rendered_image}`,hasUnsavedChanges:!0}),console.log("è®¾ç½®å˜æ›´åé‡æ–°æ¸²æŸ“æˆåŠŸ")):Be.error&&console.error("é‡æ–°æ¸²æŸ“å¤±è´¥:",Be.error)}catch(Ae){console.error("è®¾ç½®å˜æ›´åé‡æ–°æ¸²æŸ“å¤±è´¥:",Ae)}}function me(B){S.switchImage(B)}return(B,G)=>{const ve=rs("router-link");return A(),U("div",{class:Ee(["translate-page",{"edit-mode-active":R.value}])},[e("header",df,[e("div",gf,[e("div",pf,[xe(ve,{to:"/",title:"è¿”å›ä¹¦æ¶"},{default:Ct(()=>[...G[3]||(G[3]=[e("img",{src:"/pic/logo.png",alt:"Saber-Translator Logo",class:"app-logo"},null,-1),e("span",{class:"app-name"},"Saber-Translator",-1)])]),_:1})]),e("div",mf,[xe(ve,{to:"/",class:"back-to-shelf",title:"è¿”å›ä¹¦æ¶"},{default:Ct(()=>[...G[4]||(G[4]=[Ue("ğŸ“š",-1)])]),_:1}),L.value?(A(),U("button",{key:0,class:"save-header-btn",title:"ä¿å­˜è¿›åº¦",onClick:ge}," ğŸ’¾ ")):fe("",!0),e("button",{id:"openSettingsBtn",class:"settings-header-btn",title:"æ‰“å¼€è®¾ç½®",onClick:G[0]||(G[0]=ce=>Se())},[...G[5]||(G[5]=[e("span",{class:"icon"},"âš™ï¸",-1),e("span",null,"è®¾ç½®",-1)])]),G[8]||(G[8]=e("a",{href:"http://www.mashirosaber.top",target:"_blank",class:"tutorial-link"},"ä½¿ç”¨æ•™ç¨‹",-1)),e("a",{href:"javascript:void(0)",class:"donate-link",onClick:be},[...G[6]||(G[6]=[e("span",null,"â¤ï¸ è¯·ä½œè€…å–å¥¶èŒ¶",-1)])]),G[9]||(G[9]=e("a",{href:"https://github.com/MashiroSaber03",target:"_blank",class:"github-link"},[e("img",{src:"/pic/github.jpg",alt:"GitHub",class:"github-icon"})],-1)),e("button",{class:"theme-toggle",title:"åŠŸèƒ½å¼€å‘ä¸­",onClick:X},[...G[7]||(G[7]=[e("span",{class:"theme-icon"},"â˜€ï¸",-1)])])])])]),e("div",vf,[xe(fl,{onTranslateCurrent:oe,onTranslateAll:b,onTranslateRange:$,onHqTranslate:c,onHqTranslateRange:w,onProofread:m,onProofreadRange:P,onRemoveText:l,onRemoveAllText:p,onRemoveTextRange:O,onRetryFailed:j,onDeleteCurrent:ee,onClearAll:le,onCleanTemp:I,onOpenPlugins:Re,onOpenSettings:Se,onPrevious:q,onNext:ae,onApplyToAll:W,onTextStyleChanged:pe,onAutoFontSizeChanged:N}),e("main",ff,[e("section",bf,[e("div",hf,[xe(oa,{ref:"imageUploadRef",onUploadComplete:Z},null,512)]),re(i).loadingProgress.total>0?(A(),ut(yo,{key:0,visible:!0,percentage:re(i).loadingProgress.current/re(i).loadingProgress.total*100,label:re(i).loadingProgress.message},null,8,["percentage","label"])):fe("",!0),xe(Xi,{progress:re(g).progress.value},null,8,["progress"]),Y.value&&L.value?(A(),U("div",yf,[...G[10]||(G[10]=[e("span",{style:{color:"#888","font-size":"0.85em"}}," ï¼ˆä¹¦æ¶æ¨¡å¼ä¸‹é€€å‡ºå‰è¯·ç‚¹å‡»é¡¶éƒ¨ä¿å­˜æŒ‰é’®ï¼‰ ",-1)])])):fe("",!0)]),xe(zl,{ref:"imageResultRef","is-edit-mode":R.value,onToggleEditMode:T,onRetryFailed:j},null,8,["is-edit-mode"])]),k.value&&!R.value?(A(),ut(Tr,{key:0,onSelect:me})):fe("",!0)]),M.value&&R.value?(A(),ut(cf,{key:0,"is-edit-mode-active":R.value,onExit:T},null,8,["is-edit-mode-active"])):fe("",!0),xe(ql,{onOpenSettings:Se}),xe(tm,{modelValue:x.value,"onUpdate:modelValue":G[1]||(G[1]=ce=>x.value=ce),"initial-tab":_.value,onSave:we},null,8,["modelValue","initial-tab"]),D.value?(A(),ut(Zi,{key:1,onClose:G[2]||(G[2]=ce=>D.value=!1)})):fe("",!0)],2)}}}),Pf=je(xf,[["__scopeId","data-v-7288f41e"]]);export{Pf as default};
