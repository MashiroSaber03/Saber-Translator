const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["js/system.D6wMibzp.js","js/index.DRtDO-Yj.js","js/vue-vendor.nHHJLq3r.js","assets/index.BYanE9pL.css","js/client.Bht704G-.js","js/utils-vendor.B9ygI19o.js","js/session.Kpy-QhBa.js"])))=>i.map(i=>d[i]);
import{D as nn,b as so,c as ao,d as lo,e as sn,a as lt,S as Po,_ as He,f as Ve,s as fe,u as ct,g as Wn,h as qn,i as Bo,j as Ao,k as Fo,l as Lo,B as Uo,m as Oo,n as Hn,F as Gt,o as zo,p as No,q as Jn,L as Vo,W as jn}from"./index.DRtDO-Yj.js";import{d as Ft,r as S,c as Y,a as Je,e as L,h as ge,f as e,t as le,i as nt,k as D,g as st,n as Me,u as Se,o as ut,v as se,x as Ae,l as he,s as Ko,m as ht,K as et,D as H,F as qe,j as Ye,L as an,w as ye,B as dt,M as kt,z as Ce,N as Yn,p as Qe,O as eo,b as Dt,P as yt,Q as Wo,A as Xn,S as Gn,T as Zn,C as Qn}from"./vue-vendor.nHHJLq3r.js";import{p as es,a as ts,b as os,c as ns,d as ss,e as as,f as ls,h as is,i as rs,j as us,k as io,l as ln}from"./system.D6wMibzp.js";import{getFontList as rn,uploadFont as cs,getTextboxPrompts as ds,getPrompts as gs,configApi as Ne,getFontListApi as ps}from"./config.CwRcCkM9.js";import{_ as Oe}from"./CustomSelect.vue_vue_type_style_index_0_lang.DGaYiHlK.js";import{apiClient as ot}from"./client.Bht704G-.js";import{B as un}from"./BaseModal.BvJ-HwWM.js";import{getBookDetail as ms}from"./bookshelf.B4ums9uK.js";import"./utils-vendor.B9ygI19o.js";function qo(){return{firecrawl:{apiKey:""},agent:{provider:"openai",apiKey:"",customBaseUrl:"",modelName:"gpt-4o-mini",useStream:!1,forceJsonOutput:!0,maxRetries:3,timeout:120},extraction:{prompt:nn,maxIterations:10},download:{concurrency:3,timeout:30,retries:3,delay:100,useReferer:!0},imagePreprocess:{enabled:!1,autoRotate:!0,compression:{enabled:!1,quality:85,maxWidth:0,maxHeight:0},formatConvert:{enabled:!1,targetFormat:"original"}},advanced:{customCookie:"",customHeaders:"",bypassProxy:!1},ui:{showAgentLogs:!0,autoImport:!1}}}function vs(n,t){function l(f){n.value.firecrawl.apiKey=f,t()}function o(f){n.value.agent.provider=f,t()}function a(f){n.value.agent.apiKey=f,t()}function r(f){n.value.agent.customBaseUrl=f,t()}function s(f){n.value.agent.modelName=f,t()}function i(f){n.value.agent.useStream=f,t()}function h(f){n.value.agent.forceJsonOutput=f,t()}function _(f){n.value.agent.timeout=f,t()}function v(f){n.value.extraction.prompt=f,t()}function $(f){n.value.extraction.maxIterations=f,t()}function W(){n.value.extraction.prompt=nn,t()}function z(f){n.value.download.concurrency=f,t()}function N(f){n.value.download.timeout=f,t()}function w(f){n.value.download.retries=f,t()}function A(f){n.value.download.delay=f,t()}function U(f){n.value.download.useReferer=f,t()}function R(f){n.value.imagePreprocess.enabled=f,t()}function g(f){n.value.imagePreprocess.autoRotate=f,t()}function c(f){n.value.imagePreprocess.compression.enabled=f,t()}function p(f){n.value.imagePreprocess.compression.quality=f,t()}function b(f){n.value.imagePreprocess.compression.maxWidth=f,t()}function T(f){n.value.imagePreprocess.compression.maxHeight=f,t()}function O(f){n.value.imagePreprocess.formatConvert.enabled=f,t()}function Q(f){n.value.imagePreprocess.formatConvert.targetFormat=f,t()}function V(f){n.value.advanced.customCookie=f,t()}function G(f){n.value.advanced.customHeaders=f,t()}function j(f){n.value.advanced.bypassProxy=f,t()}function k(f){n.value.ui.showAgentLogs=f,t()}function y(f){n.value.ui.autoImport=f,t()}function I(f){n.value={...n.value,...f},t()}return{setFirecrawlApiKey:l,setAgentProvider:o,setAgentApiKey:a,setAgentBaseUrl:r,setAgentModelName:s,setAgentUseStream:i,setAgentForceJson:h,setAgentTimeout:_,setExtractionPrompt:v,setExtractionMaxIterations:$,resetExtractionPrompt:W,setDownloadConcurrency:z,setDownloadTimeout:N,setDownloadRetries:w,setDownloadDelay:A,setDownloadUseReferer:U,setImagePreprocessEnabled:R,setImageAutoRotate:g,setImageCompressionEnabled:c,setImageCompressionQuality:p,setImageMaxWidth:b,setImageMaxHeight:T,setImageFormatConvertEnabled:O,setImageTargetFormat:Q,setCustomCookie:V,setCustomHeaders:G,setBypassProxy:j,setShowAgentLogs:k,setAutoImport:y,updateWebImportSettings:I}}async function cn(n){return ot.post("/api/translate_image",n)}async function ro(n){return ot.post("/api/re_render_image",n)}async function bs(n){try{return{success:!0,data:await ot.post("/api/translate_single_text",n)}}catch(t){return{success:!1,error:t instanceof Error?t.message:"ç¿»è¯‘å¤±è´¥"}}}async function uo(n){return ot.post("/api/hq_translate_batch",n)}async function to(n,t,l){return ot.post("/api/detect_boxes",{image:n,detector_type:t,...l})}async function dn(n,t,l,o){return ot.post("/api/ocr_single_bubble",{image_data:n,bubble_coords:t,ocr_engine:l,...o})}async function co(n,t,l){return ot.post("/api/inpaint_single_bubble",{image_data:n,bubble_coords:t,bubble_angle:l?.bubbleAngle??0,method:l?.method??"lama",lama_model:l?.lamaModel??"lama_mpe",...l?.maskData&&{mask_data:l.maskData}})}const fs=Object.freeze(Object.defineProperty({__proto__:null,detectBoxes:to,hqTranslateBatch:uo,inpaintSingleBubble:co,ocrSingleBubble:dn,reRenderImage:ro,translateImage:cn,translateSingleText:bs},Symbol.toStringTag,{value:"Module"}));async function hs(){return ot.get("/api/plugins")}async function ys(n){const t=encodeURIComponent(n);return ot.post(`/api/plugins/${t}/enable`)}async function xs(n){const t=encodeURIComponent(n);return ot.post(`/api/plugins/${t}/disable`)}async function ks(n){const t=encodeURIComponent(n);return ot.delete(`/api/plugins/${t}`)}async function _s(n){const t=encodeURIComponent(n);return ot.get(`/api/plugins/${t}/config_schema`)}async function Ss(n){const t=encodeURIComponent(n);return ot.get(`/api/plugins/${t}/config`)}async function Cs(n,t){const l=encodeURIComponent(n);return ot.post(`/api/plugins/${l}/config`,t)}async function ws(){return ot.get("/api/plugins/default_states")}async function $s(n,t){const l=encodeURIComponent(n);return ot.post(`/api/plugins/${l}/set_default_state`,{enabled:t})}async function Is(){return{states:(await ws()).default_states}}const Ts=$s,Ds=_s,Rs=Ss,Ms=Cs;function Es(){return`img_${Date.now()}_${Math.random().toString(36).substring(2,9)}`}function Ho(n,t,l){return{id:Es(),fileName:n,originalDataURL:t,translatedDataURL:null,cleanImageData:null,bubbleStates:null,translationStatus:"pending",translationFailed:!1,fontSize:25,autoFontSize:!0,fontFamily:"fonts/STSONG.TTF",layoutDirection:"vertical",textColor:"#000000",fillColor:sn,inpaintMethod:"solid",strokeEnabled:lo,strokeColor:ao,strokeWidth:so,hasUnsavedChanges:!1,...l}}const je=Ft("image",()=>{const n=S([]),t=S(-1),l=S(!1),o=Y(()=>t.value>=0&&t.value<n.value.length?n.value[t.value]??null:null),a=Y(()=>n.value.length),r=Y(()=>n.value.length>0),s=Y(()=>t.value>0),i=Y(()=>t.value<n.value.length-1),h=Y(()=>n.value.filter(f=>f.translationFailed).length),_=Y(()=>n.value.filter(f=>f.translationStatus==="completed").length),v=Y(()=>n.value.filter(f=>f.translationStatus==="pending").length);function $(f,d,m){const E=Ho(f,d,m);return n.value.push(E),n.value.length===1&&(t.value=0),console.log(`å›¾ç‰‡å·²æ·»åŠ : ${f}ï¼Œå½“å‰å…± ${n.value.length} å¼ å›¾ç‰‡`),E}function W(f){const d=f.map(({fileName:E,originalDataURL:te,overrides:M})=>Ho(E,te,M)),m=n.value.length===0;return n.value.push(...d),m&&n.value.length>0&&(t.value=0),console.log(`æ‰¹é‡æ·»åŠ äº† ${d.length} å¼ å›¾ç‰‡ï¼Œå½“å‰å…± ${n.value.length} å¼ `),d}function z(f){n.value=f.map(d=>({...d,strokeEnabled:d.strokeEnabled??lo,strokeColor:d.strokeColor||ao,strokeWidth:d.strokeWidth??so,hasUnsavedChanges:d.hasUnsavedChanges||!1})),n.value.length>0?t.value=Math.min(Math.max(0,t.value),n.value.length-1):t.value=-1,console.log(`å›¾ç‰‡æ•°ç»„å·²è®¾ç½®ï¼Œå…± ${n.value.length} å¼ å›¾ç‰‡`)}function N(f){return f<0||f>=n.value.length?(console.warn(`åˆ é™¤å¤±è´¥: æ— æ•ˆçš„ç´¢å¼• ${f}`),!1):(n.value.splice(f,1),t.value===f?(t.value=Math.min(f,n.value.length-1),n.value.length===0&&(t.value=-1)):t.value>f&&t.value--,console.log(`å›¾ç‰‡å·²åˆ é™¤ï¼Œå½“å‰å…± ${n.value.length} å¼ å›¾ç‰‡`),!0)}function w(){return N(t.value)}function A(){n.value=[],t.value=-1,l.value=!1,console.log("æ‰€æœ‰å›¾ç‰‡å·²æ¸…é™¤")}function U(){const f=o.value?.id||null;if(n.value.sort((d,m)=>d.fileName.localeCompare(m.fileName,void 0,{numeric:!0,sensitivity:"base"})),f){const d=n.value.findIndex(m=>m.id===f);d>=0&&d!==t.value&&(console.log(`å›¾ç‰‡æ’åº: currentImageIndex ä» ${t.value} æ›´æ–°ä¸º ${d}`),t.value=d)}console.log("å›¾ç‰‡å·²æŒ‰æ–‡ä»¶åæ’åº")}function R(f){f>=-1&&f<n.value.length?(t.value=f,console.log(`å½“å‰å›¾ç‰‡ç´¢å¼•å·²è®¾ç½®ä¸º ${f}`)):console.warn(`è®¾ç½®ç´¢å¼•å¤±è´¥: æ— æ•ˆçš„ç´¢å¼• ${f}`)}function g(){return s.value?(t.value--,!0):!1}function c(){return i.value?(t.value++,!0):!1}function p(f){o.value?(Object.assign(o.value,f),console.log("å½“å‰å›¾ç‰‡å±æ€§å·²æ›´æ–°:",Object.keys(f))):console.warn("æ›´æ–°å¤±è´¥: å½“å‰æ²¡æœ‰é€‰ä¸­çš„å›¾ç‰‡")}function b(f,d){if(f>=0&&f<n.value.length){const m=n.value[f];m&&(Object.assign(m,d),console.log(`å›¾ç‰‡ ${f} å±æ€§å·²æ›´æ–°:`,Object.keys(d)))}else console.warn(`æ›´æ–°å¤±è´¥: æ— æ•ˆçš„ç´¢å¼• ${f}`)}function T(f){o.value&&(o.value.bubbleStates=f,o.value.hasUnsavedChanges=!0,console.log(`å½“å‰å›¾ç‰‡æ°”æ³¡çŠ¶æ€å·²æ›´æ–°ï¼Œå…± ${f?.length??0} ä¸ªæ°”æ³¡`))}function O(f){o.value&&(o.value.isManuallyAnnotated=f,o.value.hasUnsavedChanges=!0,console.log(`æ‰‹åŠ¨æ ‡æ³¨æ ‡è®°å·²è®¾ç½®ä¸º: ${f}`))}function Q(f,d){o.value?(o.value[f]=d,o.value.hasUnsavedChanges=!0,console.log(`å½“å‰å›¾ç‰‡å±æ€§ ${String(f)} å·²æ›´æ–°`)):console.warn("æ›´æ–°å¤±è´¥: å½“å‰æ²¡æœ‰é€‰ä¸­çš„å›¾ç‰‡")}function V(f,d){o.value&&(o.value.translatedDataURL=f,d&&(o.value.cleanImageData=d),o.value.translationStatus="completed",o.value.translationFailed=!1,o.value.hasUnsavedChanges=!0,console.log("å½“å‰å›¾ç‰‡ç¿»è¯‘ç»“æœå·²æ›´æ–°"))}function G(f,d,m){if(f>=0&&f<n.value.length){const E=n.value[f];E&&(E.translationStatus=d,E.translationFailed=d==="failed",m&&(E.errorMessage=m),console.log(`å›¾ç‰‡ ${f} ç¿»è¯‘çŠ¶æ€: ${d}`))}}function j(f){o.value&&(o.value.translationStatus="failed",o.value.translationFailed=!0,o.value.errorMessage=f,console.log(`å½“å‰å›¾ç‰‡ç¿»è¯‘å¤±è´¥: ${f}`))}function k(){n.value.forEach(f=>{f.translationStatus="pending",f.translationFailed=!1,f.errorMessage=void 0}),console.log("æ‰€æœ‰å›¾ç‰‡ç¿»è¯‘çŠ¶æ€å·²é‡ç½®")}function y(f){l.value=f,console.log(`æ‰¹é‡ç¿»è¯‘çŠ¶æ€: ${f?"è¿›è¡Œä¸­":"å·²å®Œæˆ"}`)}function I(){return n.value.map((f,d)=>f.translationFailed?d:-1).filter(f=>f!==-1)}return{images:n,currentImageIndex:t,isBatchTranslationInProgress:l,currentImage:o,imageCount:a,hasImages:r,canGoPrevious:s,canGoNext:i,failedImageCount:h,completedImageCount:_,pendingImageCount:v,addImage:$,addImages:W,setImages:z,deleteImage:N,deleteCurrentImage:w,clearImages:A,sortImagesByFileName:U,setCurrentImageIndex:R,goToPrevious:g,goToNext:c,updateCurrentImage:p,updateImageByIndex:b,updateCurrentBubbleStates:T,setManuallyAnnotated:O,updateCurrentImageProperty:Q,updateCurrentTranslationResult:V,setTranslationStatus:G,markCurrentAsFailed:j,resetAllTranslationStatus:k,setBatchTranslationInProgress:y,getFailedImageIndices:I}}),Jo=Object.freeze(Object.defineProperty({__proto__:null,useImageStore:je},Symbol.toStringTag,{value:"Module"})),gn=Ft("session",()=>{const n=S(null),t=S({bookId:null,chapterId:null,bookTitle:null,chapterTitle:null}),l=S([]),o=S(!1),a=S({current:0,total:0,message:""}),r=S(null),s=S(!1),i=Y(()=>t.value.bookId!==null&&t.value.chapterId!==null),h=Y(()=>t.value.bookId),_=Y(()=>t.value.chapterId);function v(k,y,I=null,f=null){t.value={bookId:k,chapterId:y,bookTitle:I,chapterTitle:f},console.log(`ä¼šè¯ä¸Šä¸‹æ–‡å·²è®¾ç½®: ä¹¦ç±=${k}, ç« èŠ‚=${y}`)}function $(k,y,I,f){v(k,y,I,f)}function W(){t.value={bookId:null,chapterId:null,bookTitle:null,chapterTitle:null},console.log("ä¼šè¯ä¸Šä¸‹æ–‡å·²æ¸…é™¤")}function z(k){const y=k.get("book"),I=k.get("chapter");y&&I&&v(y,I)}function N(k){n.value=k,console.log(`å½“å‰ä¼šè¯åç§°: ${k}`)}function w(){n.value=null}function A(k){l.value=k,console.log(`ä¼šè¯åˆ—è¡¨å·²æ›´æ–°ï¼Œå…± ${k.length} ä¸ªä¼šè¯`)}function U(k){const y=l.value.findIndex(I=>I.name===k.name);y>=0?l.value[y]=k:l.value.unshift(k)}function R(k){const y=l.value.findIndex(I=>I.name===k);y>=0&&l.value.splice(y,1)}function g(k,y){const I=l.value.find(f=>f.name===k);I&&(I.name=y)}function c(k){o.value=k}function p(k){s.value=k}function b(k){r.value=k}function T(k,y,I,f){return{name:k,version:"2.0",savedAt:new Date().toISOString(),imageCount:y.length,ui_settings:f,images:y.map(d=>({originalDataURL:d.originalDataURL,translatedDataURL:d.translatedDataURL||void 0,cleanImageData:d.cleanImageData||void 0,bubbleStates:d.bubbleStates||void 0,isManuallyAnnotated:d.isManuallyAnnotated||void 0,fileName:d.fileName,fontSize:d.fontSize,autoFontSize:d.autoFontSize,fontFamily:d.fontFamily,layoutDirection:d.layoutDirection,textColor:d.textColor,fillColor:d.fillColor,inpaintMethod:d.inpaintMethod,strokeEnabled:d.strokeEnabled,strokeColor:d.strokeColor,strokeWidth:d.strokeWidth,translationStatus:d.translationStatus,translationFailed:d.translationFailed})),currentImageIndex:I}}function O(){n.value=null,t.value={bookId:null,chapterId:null,bookTitle:null,chapterTitle:null},l.value=[],o.value=!1,s.value=!1,r.value=null,console.log("ä¼šè¯çŠ¶æ€å·²é‡ç½®")}async function Q(k){if(!k||typeof k!="string")return null;if(k.startsWith("data:"))return k;if(!k.startsWith("/api/"))return null;try{const y=await fetch(k);if(!y.ok)return null;const I=await y.blob();return new Promise(f=>{const d=new FileReader;d.onloadend=()=>f(d.result),d.onerror=()=>f(null),d.readAsDataURL(I)})}catch(y){return console.error(`è½¬æ¢å›¾ç‰‡ URL å¤±è´¥: ${k}`,y),null}}async function V(k,y){const I=k.length;for(let f=0;f<I;f++){const d=k[f];if(d){if(y&&y(f+1,I),d.originalDataURL&&d.originalDataURL.startsWith("/api/")){const m=await Q(d.originalDataURL);m&&(d.originalDataURL=m)}if(d.translatedDataURL&&d.translatedDataURL.startsWith("/api/")){const m=await Q(d.translatedDataURL);m&&(d.translatedDataURL=m)}if(d.cleanImageData&&d.cleanImageData.startsWith("/api/")){const m=await Q(d.cleanImageData);m&&(d.cleanImageData=m.replace(/^data:image\/\w+;base64,/,""))}}}}async function G(k){c(!0),b(null),a.value={current:0,total:0,message:"æ­£åœ¨åŠ è½½..."};try{const{useImageStore:y}=await lt(async()=>{const{useImageStore:x}=await Promise.resolve().then(()=>Jo);return{useImageStore:x}},void 0),{useSettingsStore:I}=await lt(async()=>{const{useSettingsStore:x}=await import("./system.D6wMibzp.js").then(K=>K.s);return{useSettingsStore:x}},__vite__mapDeps([0,1,2,3,4,5])),{useBubbleStore:f}=await lt(async()=>{const{useBubbleStore:x}=await Promise.resolve().then(()=>$l);return{useBubbleStore:x}},void 0),d=y(),m=I(),E=f(),{loadSessionByPathApi:te}=await lt(async()=>{const{loadSessionByPathApi:x}=await import("./session.Kpy-QhBa.js");return{loadSessionByPathApi:x}},__vite__mapDeps([6,4,5])),M=await te(k);if(!M.success||!M.session)throw new Error(M.error||"åŠ è½½ä¼šè¯å¤±è´¥");const Z=M.session;if(Z.images&&Z.images.length>0){const x=Z.images.map((C,ue)=>({id:`session-${ue}-${Date.now()}`,originalDataURL:C.originalDataURL,translatedDataURL:C.translatedDataURL||null,cleanImageData:C.cleanImageData||null,bubbleStates:C.bubbleStates!==void 0&&C.bubbleStates!==null?C.bubbleStates:null,isManuallyAnnotated:!!C.isManuallyAnnotated,fileName:C.fileName||`image-${ue+1}.png`,translationStatus:C.translationStatus||"pending",translationFailed:!!C.translationFailed,hasUnsavedChanges:!1,fontSize:C.fontSize||24,autoFontSize:C.autoFontSize??!0,fontFamily:C.fontFamily||"Microsoft YaHei",layoutDirection:C.layoutDirection||"vertical",textColor:C.textColor||"#000000",fillColor:C.fillColor||"#FFFFFF",inpaintMethod:C.inpaintMethod||"litelama",strokeEnabled:C.strokeEnabled??!1,strokeColor:C.strokeColor||"#FFFFFF",strokeWidth:C.strokeWidth||2}));x.length>0&&(console.log("æ­£åœ¨åŠ è½½å›¾ç‰‡..."),a.value={current:0,total:x.length,message:"æ­£åœ¨åŠ è½½å›¾ç‰‡..."},await V(x,(C,ue)=>{const P=C/ue*100;a.value={current:C,total:ue,message:`åŠ è½½å›¾ç‰‡ ${C}/${ue}...`},console.log(`åŠ è½½å›¾ç‰‡ ${C}/${ue}... (${P.toFixed(0)}%)`)}),a.value={current:x.length,total:x.length,message:"åŠ è½½å®Œæˆ"},console.log("å›¾ç‰‡åŠ è½½å®Œæˆï¼Œå·²è½¬æ¢ä¸º Base64"),setTimeout(()=>{a.value={current:0,total:0,message:""}},500)),d.setImages(x);let K=0;typeof Z.currentImageIndex=="number"&&(K=Z.currentImageIndex,(K>=x.length||K<0)&&(K=x.length>0?0:-1)),d.setCurrentImageIndex(K);const u=x[K];u&&u.bubbleStates&&u.bubbleStates.length>0?E.setBubbles(u.bubbleStates,!0):E.clearBubblesLocal(),console.log(`æŒ‰è·¯å¾„åŠ è½½ä¼šè¯æˆåŠŸ: ${k}, å…± ${x.length} å¼ å›¾ç‰‡`)}const B=Z.ui_settings;if(B){(B.targetLanguage||B.sourceLanguage)&&m.updateSettings({targetLanguage:B.targetLanguage||void 0,sourceLanguage:B.sourceLanguage||void 0});const x=B.useInpaintingMethod,u=["solid","lama_mpe","litelama"].includes(x)?x:m.settings.textStyle.inpaintMethod;m.updateTextStyle({fontSize:B.fontSize||m.settings.textStyle.fontSize,autoFontSize:B.autoFontSize??m.settings.textStyle.autoFontSize,fontFamily:B.fontFamily||m.settings.textStyle.fontFamily,layoutDirection:B.layoutDirection||m.settings.textStyle.layoutDirection,textColor:B.textColor||m.settings.textStyle.textColor,fillColor:B.fillColor||m.settings.textStyle.fillColor,inpaintMethod:u,strokeEnabled:B.strokeEnabled??m.settings.textStyle.strokeEnabled,strokeColor:B.strokeColor||m.settings.textStyle.strokeColor,strokeWidth:B.strokeWidth||m.settings.textStyle.strokeWidth}),console.log("UI è®¾ç½®å·²æ¢å¤")}return N(k),!0}catch(y){const I=y instanceof Error?y.message:"åŠ è½½ä¼šè¯å¤±è´¥";throw b(I),console.error(`æŒ‰è·¯å¾„åŠ è½½ä¼šè¯å¤±è´¥: ${k}`,y),y}finally{c(!1)}}async function j(k,y){if(!k||!y)return console.log("æœªåœ¨ä¹¦ç±/ç« èŠ‚æ¨¡å¼ï¼Œä¸æ”¯æŒä¿å­˜"),!1;console.log(`ä¿å­˜ç« èŠ‚ä¼šè¯ï¼ˆåˆ†æ‰¹ï¼‰: book=${k}, chapter=${y}`);const{useImageStore:I}=await lt(async()=>{const{useImageStore:M}=await Promise.resolve().then(()=>Jo);return{useImageStore:M}},void 0),{useSettingsStore:f}=await lt(async()=>{const{useSettingsStore:M}=await import("./system.D6wMibzp.js").then(Z=>Z.s);return{useSettingsStore:M}},__vite__mapDeps([0,1,2,3,4,5])),d=I(),m=f(),E=Array.isArray(d.images)?d.images:[];if(!E||E.length===0)return console.log("æ²¡æœ‰å›¾ç‰‡æ•°æ®å¯ä¿å­˜"),!1;const te=`bookshelf/${k}/${y}`;p(!0),b(null),a.value={current:0,total:100,message:"å‡†å¤‡ä¿å­˜..."};try{const{batchSaveStartApi:M,batchSaveImageApi:Z,batchSaveCompleteApi:B}=await lt(async()=>{const{batchSaveStartApi:F,batchSaveImageApi:oe,batchSaveCompleteApi:ee}=await import("./session.Kpy-QhBa.js");return{batchSaveStartApi:F,batchSaveImageApi:oe,batchSaveCompleteApi:ee}},__vite__mapDeps([6,4,5])),x=E.length;E.some(F=>F.originalDataURL&&F.originalDataURL.startsWith("/api/")||F.translatedDataURL&&F.translatedDataURL.startsWith("/api/")||F.cleanImageData&&F.cleanImageData.startsWith("/api/"))&&(console.log("[saveChapterSession] æ£€æµ‹åˆ° /api/ URL æ ¼å¼å›¾ç‰‡ï¼Œå¼€å§‹è½¬æ¢ä¸º Base64..."),a.value={current:2,total:100,message:"è½¬æ¢å›¾ç‰‡æ ¼å¼..."},await V(E,(F,oe)=>{const ee=2+F/oe*3;a.value={current:Math.round(ee),total:100,message:`è½¬æ¢å›¾ç‰‡ ${F}/${oe}...`}}),console.log("[saveChapterSession] å›¾ç‰‡æ ¼å¼è½¬æ¢å®Œæˆ")),a.value={current:5,total:100,message:"æ”¶é›†å…ƒæ•°æ®..."};const{textStyle:u,targetLanguage:C,sourceLanguage:ue}=m.settings,P={targetLanguage:C,sourceLanguage:ue,fontSize:u.fontSize,autoFontSize:u.autoFontSize,fontFamily:u.fontFamily,layoutDirection:u.layoutDirection,textColor:u.textColor,useInpaintingMethod:u.inpaintMethod,fillColor:u.fillColor,strokeEnabled:u.strokeEnabled,strokeColor:u.strokeColor,strokeWidth:u.strokeWidth},ne=E.map(F=>{const oe={};for(const ee of Object.keys(F))ee!=="originalDataURL"&&ee!=="translatedDataURL"&&ee!=="cleanImageData"&&(oe[ee]=F[ee]);return oe.hasOriginalData=!!F.originalDataURL,oe.hasTranslatedData=!!F.translatedDataURL,oe.hasCleanData=!!F.cleanImageData,oe}),de={ui_settings:P,images_meta:ne,currentImageIndex:d.currentImageIndex};a.value={current:10,total:100,message:"åˆå§‹åŒ–ä¿å­˜..."};const we=await M(te,de);if(!we.success)throw new Error(we.error||"åˆå§‹åŒ–ä¿å­˜å¤±è´¥");const Te=we.session_folder;if(!Te)throw new Error("æœªè·å–åˆ°ä¼šè¯æ–‡ä»¶å¤¹è·¯å¾„");console.log(`ä¼šè¯æ–‡ä»¶å¤¹: ${Te}`);let Fe=0,Ee=0;const ae=F=>!!F&&typeof F=="string"&&F.startsWith("data:");for(let F=0;F<x;F++){const oe=E[F];if(!oe)continue;const ee=10+F/x*80;if(a.value={current:Math.round(ee),total:100,message:`ä¿å­˜å›¾ç‰‡ ${F+1}/${x}...`},ae(oe.originalDataURL))try{const re=await Z(Te,F,"original",oe.originalDataURL);re.success||(console.error(`ä¿å­˜å›¾ç‰‡ ${F} original å¤±è´¥:`,re.error),Ee++)}catch(re){console.error(`ä¿å­˜å›¾ç‰‡ ${F} original å‡ºé”™:`,re),Ee++}if(ae(oe.translatedDataURL))try{const re=await Z(Te,F,"translated",oe.translatedDataURL);re.success||(console.error(`ä¿å­˜å›¾ç‰‡ ${F} translated å¤±è´¥:`,re.error),Ee++)}catch(re){console.error(`ä¿å­˜å›¾ç‰‡ ${F} translated å‡ºé”™:`,re),Ee++}if(oe.cleanImageData&&typeof oe.cleanImageData=="string"&&!oe.cleanImageData.startsWith("/api/"))try{const re=await Z(Te,F,"clean",oe.cleanImageData);re.success||(console.error(`ä¿å­˜å›¾ç‰‡ ${F} clean å¤±è´¥:`,re.error),Ee++)}catch(re){console.error(`ä¿å­˜å›¾ç‰‡ ${F} clean å‡ºé”™:`,re),Ee++}Fe++}a.value={current:95,total:100,message:"å®Œæˆä¿å­˜..."};const J=await B(Te,ne);if(!J.success)throw new Error(J.error||"å®Œæˆä¿å­˜å¤±è´¥");return a.value={current:100,total:100,message:"ä¿å­˜å®Œæˆ"},console.log(`åˆ†æ‰¹ä¿å­˜å®Œæˆ: ${Fe} å¼ å›¾ç‰‡, ${Ee} ä¸ªå¤±è´¥`),setTimeout(()=>{a.value={current:0,total:0,message:""}},1e3),!0}catch(M){const Z=M instanceof Error?M.message:"ä¿å­˜ç« èŠ‚ä¼šè¯å¤±è´¥";return b(Z),console.error("åˆ†æ‰¹ä¿å­˜å¤±è´¥:",M),a.value={current:0,total:0,message:""},!1}finally{p(!1)}}return{currentSessionName:n,context:t,sessionList:l,isLoading:o,isSaving:s,error:r,loadingProgress:a,isBookshelfMode:i,currentBookId:h,currentChapterId:_,setContext:v,clearContext:W,parseContextFromUrl:z,setSessionName:N,clearSessionName:w,setSessionList:A,addToSessionList:U,removeFromSessionList:R,renameInSessionList:g,setLoading:c,setSaving:p,setError:b,createSessionData:T,imageUrlToBase64:Q,saveChapterSession:j,loadSessionByPath:G,setBookChapterContext:$,reset:O}}),pn=Ft("webImport",()=>{const n=S(qo()),t=S("idle"),l=S(""),o=S([]),a=S(null),r=S(new Set),s=S({current:0,total:0}),i=S([]),h=S(null),_=S(!1),v=Y(()=>t.value==="extracting"),$=Y(()=>t.value==="downloading"),W=Y(()=>v.value||$.value),z=Y(()=>r.value.size),N=Y(()=>s.value.total===0?0:Math.round(s.value.current/s.value.total*100));function w(){try{localStorage.setItem(Po,JSON.stringify(n.value))}catch(d){console.error("ä¿å­˜ç½‘é¡µå¯¼å…¥è®¾ç½®å¤±è´¥:",d)}}function A(){try{const d=localStorage.getItem(Po);if(d){const m=JSON.parse(d);n.value=U(qo(),m)}}catch(d){console.error("åŠ è½½ç½‘é¡µå¯¼å…¥è®¾ç½®å¤±è´¥:",d)}}function U(d,m){const E={...d};for(const te in m)if(Object.prototype.hasOwnProperty.call(m,te)){const M=m[te],Z=d[te];M!==null&&typeof M=="object"&&!Array.isArray(M)&&Z!==null&&typeof Z=="object"&&!Array.isArray(Z)?E[te]=U(Z,M):M!==void 0&&(E[te]=M)}return E}function R(){_.value=!0}function g(){_.value=!1}function c(){t.value="idle",l.value="",o.value=[],a.value=null,r.value=new Set,s.value={current:0,total:0},i.value=[],h.value=null}function p(d){l.value=d}function b(d){o.value.push(d)}function T(){o.value=[]}function O(d){a.value&&a.value.pages.length>0?(a.value.comicTitle=d.comicTitle,a.value.chapterTitle=d.chapterTitle,a.value.totalPages=d.totalPages,a.value.sourceUrl=d.sourceUrl,a.value.referer=d.referer,a.value.engine=d.engine,a.value.success=d.success,a.value.error=d.error):(a.value=d,d.success&&d.pages&&(r.value=new Set(d.pages.map(m=>m.pageNumber))))}function Q(d){r.value.has(d)?r.value.delete(d):r.value.add(d),r.value=new Set(r.value)}function V(){a.value?.pages&&(r.value.size===a.value.pages.length?r.value=new Set:r.value=new Set(a.value.pages.map(d=>d.pageNumber)))}function G(d){t.value=d}function j(d){h.value=d,d&&(t.value="error")}function k(d,m){s.value={current:d,total:m}}function y(d){i.value=d}function I(d){a.value||(a.value={success:!0,comicTitle:"",chapterTitle:"",pages:[],totalPages:0,sourceUrl:l.value,referer:"",engine:"gallery-dl"}),a.value.pages.push(d),a.value.totalPages=a.value.pages.length,r.value.add(d.pageNumber),r.value=new Set(r.value)}const f=vs(n,w);return A(),{settings:n,status:t,url:l,logs:o,extractResult:a,selectedPages:r,downloadProgress:s,downloadedImages:i,error:h,modalVisible:_,isExtracting:v,isDownloading:$,isProcessing:W,selectedCount:z,downloadProgressPercent:N,saveToStorage:w,loadFromStorage:A,openModal:R,closeModal:g,resetState:c,setUrl:p,addLog:b,clearLogs:T,setExtractResult:O,togglePageSelection:Q,toggleSelectAll:V,setStatus:G,setError:j,updateDownloadProgress:k,setDownloadedImages:y,addPageIncremental:I,...f}}),Ps={key:0,class:"translation-progress-bar"},Bs={class:"progress-bar-label"},As={class:"progress-bar"},Fs=Je({__name:"ProgressBar",props:{visible:{type:Boolean,default:!0},percentage:{},label:{default:"è¿›åº¦"}},setup(n){return(t,l)=>n.visible?(D(),L("div",Ps,[e("div",Bs,le(n.label),1),e("div",As,[e("div",{class:"progress",style:nt({width:`${n.percentage}%`})},null,4)])])):ge("",!0)}}),go=He(Fs,[["__scopeId","data-v-f915cadf"]]),Ls={class:"image-upload"},Us={class:"error-text"},Os={key:2,class:"loading-overlay"},zs=Je({__name:"ImageUpload",emits:["uploadComplete"],setup(n,{expose:t,emit:l}){const o=l,a=je(),r=Ve(),s=pn(),i=S(null),h=S(!1),_=S(!1),v=S(""),$=S(0),W=S(""),z=S(!1),N=Y(()=>r.settings.pdfProcessingMethod);function w(){i.value?.click()}function A(){s.openModal()}async function U(k){const y=k.target;!y.files||y.files.length===0||(await p(Array.from(y.files)),y.value="")}async function R(k){k.preventDefault(),_.value=!1,!(!k.dataTransfer?.files||k.dataTransfer.files.length===0)&&await p(Array.from(k.dataTransfer.files))}function g(k){k.preventDefault(),_.value=!0}function c(k){const y=k.currentTarget.getBoundingClientRect(),I=k.clientX,f=k.clientY;(I<y.left||I>y.right||f<y.top||f>y.bottom)&&(_.value=!1)}async function p(k){if(k.length!==0){h.value=!0,v.value="",z.value=!0,$.value=0;try{let y=0;const I=k.length;for(let f=0;f<k.length;f++){const d=k[f];if(!d)continue;W.value=d.name;const m=d.type,E=d.name.toLowerCase();if(m.startsWith("image/"))await b(d),y++;else if(m==="application/pdf"||E.endsWith(".pdf")){const te=await T(d);y+=te}else if(E.endsWith(".mobi")||E.endsWith(".azw")||E.endsWith(".azw3")){const te=await G(d);y+=te}else console.warn(`ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹: ${d.name}`),fe(`ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹: ${d.name}`,"warning");$.value=Math.round((f+1)/I*100)}y>0&&(fe(`å·²æ·»åŠ  ${y} å¼ å›¾ç‰‡`,"success"),o("uploadComplete",y))}catch(y){console.error("å¤„ç†æ–‡ä»¶å¤±è´¥:",y);const I=y instanceof Error?y.message:"å¤„ç†æ–‡ä»¶å¤±è´¥ï¼Œè¯·é‡è¯•";v.value=I,fe(I,"error")}finally{h.value=!1,z.value=!1,W.value=""}}}async function b(k){return new Promise((y,I)=>{const f=new FileReader;f.onload=d=>{const m=d.target?.result;a.addImage(k.name,m),y()},f.onerror=()=>I(new Error(`è¯»å–å›¾ç‰‡æ–‡ä»¶å¤±è´¥: ${k.name}`)),f.readAsDataURL(k)})}async function T(k){return N.value==="frontend"?await Q(k):await V(k)}function O(k){return new Promise((y,I)=>{const f=new FileReader;f.onload=()=>y(f.result),f.onerror=I,f.readAsDataURL(k)})}async function Q(k){try{const y=await lt(()=>import("./pdf.U7tdldy2.js").then(te=>te.p),[]);y.GlobalWorkerOptions.workerSrc=`https://cdnjs.cloudflare.com/ajax/libs/pdf.js/${y.version}/pdf.worker.min.js`;const I=await k.arrayBuffer(),f=await y.getDocument({data:I}).promise,d=f.numPages;console.log(`PDF ${k.name} å…± ${d} é¡µï¼Œå¼€å§‹æœ¬åœ°æ¸²æŸ“...`),fe(`æ­£åœ¨è§£æ PDFï¼Œå…± ${d} é¡µ...`,"info");const m=typeof OffscreenCanvas<"u";m&&console.log("ä½¿ç”¨ OffscreenCanvas åå°æ¸²æŸ“æ¨¡å¼");let E=0;for(let te=1;te<=d;te++){W.value=`${k.name} - ç¬¬ ${te}/${d} é¡µ`,$.value=Math.round(te/d*100);try{const M=await f.getPage(te),B=M.getViewport({scale:2});let x;if(m){const u=new OffscreenCanvas(B.width,B.height),C=u.getContext("2d");await M.render({canvasContext:C,viewport:B}).promise;const ue=await u.convertToBlob({type:"image/jpeg",quality:1});x=await O(ue)}else{const u=document.createElement("canvas"),C=u.getContext("2d");u.width=B.width,u.height=B.height,await M.render({canvasContext:C,viewport:B}).promise,x=u.toDataURL("image/jpeg",1)}const K=`${k.name}_é¡µé¢${te}`;a.addImage(K,x),E++,console.log(`  é¡µé¢ ${te}/${d} å¤„ç†å®Œæˆ`)}catch(M){console.warn(`PDF ${k.name} ç¬¬ ${te} é¡µæ¸²æŸ“å¤±è´¥:`,M)}}return console.log(`PDF ${k.name} å…¨éƒ¨ ${d} é¡µå¤„ç†å®Œæˆ`),E}catch(y){return console.error("å‰ç«¯ PDF è§£æå¤±è´¥:",y),fe("å‰ç«¯ PDF è§£æå¤±è´¥ï¼Œå°è¯•ä½¿ç”¨åç«¯è§£æ...","warning"),await V(k)}}async function V(k){let I=null;try{fe("æ­£åœ¨ä¸Šä¼  PDF æ–‡ä»¶...","info");const f=await es(k,5);if(!f.success||!f.session_id)throw new Error(f.error||"PDF è§£æå¯åŠ¨å¤±è´¥");I=f.session_id;const d=f.total_pages||0;console.log(`PDF ${k.name} å…± ${d} é¡µï¼Œå¼€å§‹åç«¯åˆ†æ‰¹è§£æ...`),fe(`æ­£åœ¨è§£æ PDFï¼Œå…± ${d} é¡µ...`,"info");let m=0;for(let E=0;E<d;E+=5){W.value=`${k.name} - å¤„ç†ä¸­ ${Math.min(E+5,d)}/${d} é¡µ`,$.value=d>0?Math.round(E/d*100):0;const te=await ts(I,E,5);if(!te.success){console.warn(`æ‰¹æ¬¡ ${E} è·å–å¤±è´¥:`,te.error);continue}if(te.images&&te.images.length>0)for(const M of te.images){if(!M||!M.data_url)continue;const Z=`${k.name}_é¡µé¢${String(M.page_index+1).padStart(4,"0")}`;a.addImage(Z,M.data_url),m++}console.log(`  å·²åŠ è½½ ${m}/${d} é¡µ`)}return console.log(`PDF ${k.name} å…¨éƒ¨ ${m} é¡µå¤„ç†å®Œæˆ`),m}catch(f){throw console.error("åç«¯ PDF è§£æå¤±è´¥:",f),f}finally{if(I)try{await os(I)}catch(f){console.warn("PDF ä¼šè¯æ¸…ç†å¤±è´¥:",f)}}}async function G(k){let y=null;try{fe("æ­£åœ¨ä¸Šä¼ ç”µå­ä¹¦æ–‡ä»¶...","info");const I=await ns(k,5);if(!I.success||!I.session_id)throw new Error(I.error||"MOBI/AZW è§£æå¯åŠ¨å¤±è´¥");y=I.session_id;const f=I.total_images||0;fe(`æ­£åœ¨è§£æç”µå­ä¹¦ï¼Œå…± ${f} å¼ å›¾ç‰‡...`,"info");let d=0,m=!0;for(;m;){W.value=`${k.name} - å·²å¤„ç† ${d}/${f} å¼ `,$.value=f>0?Math.round(d/f*100):0;const E=await ss(y);if(!E.success)throw new Error(E.error||"MOBI/AZW æ‰¹æ¬¡è§£æå¤±è´¥");if(E.images&&E.images.length>0){for(let te=0;te<E.images.length;te++){const M=E.images[te];if(!M)continue;const Z=d+te+1,B=`${k.name.replace(/\.(mobi|azw|azw3)$/i,"")}_image_${String(Z).padStart(3,"0")}.png`,x=M.startsWith("data:")?M:`data:image/png;base64,${M}`;a.addImage(B,x)}d+=E.images.length}m=E.has_more??!1}return d}catch(I){throw console.error("MOBI/AZW è§£æå¤±è´¥:",I),I}finally{if(y)try{await as(y)}catch(I){console.warn("MOBI/AZW ä¼šè¯æ¸…ç†å¤±è´¥:",I)}}}function j(){v.value=""}return t({triggerFileSelect:w,processFiles:p,clearError:j}),(k,y)=>(D(),L("div",Ls,[e("div",{id:"drop-area",class:Me(["drop-area",{"drag-over":_.value,loading:h.value}]),onDragover:g,onDragleave:c,onDrop:R},[e("div",{class:"drop-content"},[e("p",{class:"drop-text"},[y[0]||(y[0]=Se(" æ‹–æ‹½å›¾ç‰‡ã€PDFæˆ–MOBIæ–‡ä»¶åˆ°è¿™é‡Œï¼Œæˆ– ",-1)),e("span",{class:"select-link",onClick:w}," ç‚¹å‡»é€‰æ‹©æ–‡ä»¶ "),y[1]||(y[1]=e("span",{class:"separator"}," | ",-1)),e("span",{class:"select-link web-import-link",onClick:A}," ğŸŒ ä»ç½‘é¡µå¯¼å…¥ ")])]),e("input",{ref_key:"fileInputRef",ref:i,type:"file",id:"imageUpload",accept:"image/*,application/pdf,.mobi,.azw,.azw3",multiple:"",class:"file-input",onChange:U},null,544)],34),z.value?(D(),st(go,{key:0,visible:!0,percentage:$.value,label:W.value||"å¤„ç†ä¸­..."},null,8,["percentage","label"])):ge("",!0),v.value?(D(),L("div",{key:1,class:"error-message",onClick:j},[y[2]||(y[2]=e("span",{class:"error-icon"},"âš ï¸",-1)),e("span",Us,le(v.value),1),y[3]||(y[3]=e("span",{class:"error-close"},"Ã—",-1))])):ge("",!0),h.value&&!z.value?(D(),L("div",Os,[...y[4]||(y[4]=[e("div",{class:"spinner"},null,-1),e("span",{class:"loading-text"},"å¤„ç†ä¸­...",-1)])])):ge("",!0)]))}}),Ns=He(zs,[["__scopeId","data-v-ffdddfae"]]),Vs={id:"settings-sidebar",class:"settings-sidebar"},Ks={class:"card settings-card"},Ws={id:"font-settings",class:"settings-card collapsible-panel"},qs={class:"toggle-icon"},Hs={class:"collapsible-content"},Js={class:"settings-form"},js={class:"form-group"},Ys=["value","disabled","title"],Xs={class:"auto-fontSize-option",title:"å‹¾é€‰åï¼Œé¦–æ¬¡ç¿»è¯‘æ—¶è‡ªåŠ¨ä¸ºæ¯ä¸ªæ°”æ³¡è®¡ç®—åˆé€‚çš„å­—å·"},Gs=["checked"],Zs={class:"form-group"},Qs={class:"form-group"},ea={class:"form-group"},ta={class:"color-with-auto"},oa={class:"auto-color-toggle",title:"ç¿»è¯‘æ—¶è‡ªåŠ¨ä½¿ç”¨è¯†åˆ«åˆ°çš„æ–‡å­—é¢œè‰²"},na=["checked"],sa=["value","disabled"],aa={key:0,class:"auto-color-hint"},la={class:"form-group"},ia={class:"checkbox-label"},ra=["checked"],ua={key:0,id:"strokeOptions",class:"stroke-options"},ca={class:"form-group"},da=["value"],ga={class:"form-group"},pa=["value"],ma={class:"form-group"},va={key:0,id:"solidColorOptions",class:"form-group"},ba=["value"],fa={class:"apply-settings-group"},ha=["disabled"],ya={key:0,class:"apply-options-dropdown"},xa={class:"apply-option"},ka=["checked"],_a={class:"apply-option"},Sa={class:"apply-option"},Ca={class:"apply-option"},wa={class:"apply-option"},$a={class:"apply-option"},Ia={class:"apply-option"},Ta={class:"apply-option"},Da={class:"apply-option"},Ra={class:"action-buttons"},Ma=["disabled"],Ea=["disabled"],Pa=["disabled"],Ba=["disabled"],Aa=["disabled"],Fa=["disabled"],La=["disabled"],Ua=["disabled"],Oa={class:"navigation-buttons"},za=["disabled"],Na=["disabled"],Va=Je({__name:"SettingsSidebar",emits:["translateCurrent","translateAll","hqTranslate","proofread","removeText","removeAllText","deleteCurrent","clearAll","cleanTemp","openPlugins","openSettings","previous","next","applyToAll","textStyleChanged","autoFontSizeChanged"],setup(n,{emit:t}){const l=t,o=je(),a=Ve(),r=S(!0),s=S(!1),i=S({fontSize:!0,fontFamily:!0,layoutDirection:!0,textColor:!0,fillColor:!0,strokeEnabled:!0,strokeColor:!0,strokeWidth:!0}),h=[{label:"è‡ªåŠ¨ (æ ¹æ®æ£€æµ‹)",value:"auto"},{label:"ç«–å‘æ’ç‰ˆ",value:"vertical"},{label:"æ¨ªå‘æ’ç‰ˆ",value:"horizontal"}],_=[{label:"çº¯è‰²å¡«å……",value:"solid"},{label:"LAMAä¿®å¤ (é€Ÿåº¦ä¼˜åŒ–)",value:"lama_mpe"},{label:"LAMAä¿®å¤ (é€šç”¨)",value:"litelama"}],v=Y(()=>o.currentImage),$=Y(()=>o.hasImages),W=Y(()=>$.value&&!o.isBatchTranslationInProgress),z=Y(()=>o.canGoPrevious),N=Y(()=>o.canGoNext),w=Y(()=>a.textStyle),A=S([]),U=["fonts/STSONG.TTF","fonts/msyh.ttc","fonts/simhei.ttf","fonts/simsun.ttc"],R=S(null),g=Y(()=>{const B=A.value.map(x=>({label:Q(x),value:x}));return B.push({label:"è‡ªå®šä¹‰å­—ä½“...",value:"custom-font"}),B});ut(async()=>{await c();const B=w.value.fontFamily;B&&!A.value.includes(B)&&(A.value=[B,...A.value])});async function c(){try{const B=await rn();if(B.fonts&&Array.isArray(B.fonts)&&B.fonts.length>0){const x=B.fonts[0];if(typeof x=="object"&&"path"in x){const K=B.fonts.map(u=>typeof u=="object"?u.path:u);A.value=K}else A.value=B.fonts}else A.value=[...U]}catch(B){console.error("åŠ è½½å­—ä½“åˆ—è¡¨å¤±è´¥:",B),A.value=[...U]}}function p(){r.value=!r.value}function b(B){const x=parseInt(B.target.value);isNaN(x)||(a.updateTextStyle({fontSize:x}),l("textStyleChanged","fontSize",x))}function T(B){const x=B.target.checked;a.updateTextStyle({autoFontSize:x}),console.log(`è‡ªåŠ¨å­—å·è®¾ç½®å˜æ›´: ${x}`),l("autoFontSizeChanged",x)}async function O(B){const x=B.target,K=x.files?.[0];if(!K)return;const u=[".ttf",".ttc",".otf"],C=K.name.toLowerCase();if(!u.some(P=>C.endsWith(P))){fe("è¯·é€‰æ‹© .ttfã€.ttc æˆ– .otf æ ¼å¼çš„å­—ä½“æ–‡ä»¶","error"),x.value="";return}try{const P=await cs(K);P.success&&P.fontPath?(await c(),a.updateTextStyle({fontFamily:P.fontPath}),fe("å­—ä½“ä¸Šä¼ æˆåŠŸ","success")):fe(P.error||"å­—ä½“ä¸Šä¼ å¤±è´¥","error")}catch(P){console.error("å­—ä½“ä¸Šä¼ å¤±è´¥:",P),fe("å­—ä½“ä¸Šä¼ å¤±è´¥","error")}finally{x.value=""}}function Q(B){const x={"fonts/STXINGKA.TTF":"åæ–‡è¡Œæ¥·","fonts/STXINWEI.TTF":"åæ–‡æ–°é­","fonts/STZHONGS.TTF":"åæ–‡ä¸­å®‹","fonts/STKAITI.TTF":"æ¥·ä½“","fonts/STLITI.TTF":"éš¶ä¹¦","fonts/STSONG.TTF":"åæ–‡å®‹ä½“","fonts/msyh.ttc":"å¾®è½¯é›…é»‘","fonts/msyhbd.ttc":"å¾®è½¯é›…é»‘ç²—ä½“","fonts/SIMYOU.TTF":"å¹¼åœ†","fonts/STFANGSO.TTF":"ä»¿å®‹","fonts/STHUPO.TTF":"åæ–‡ç¥ç€","fonts/STXIHEI.TTF":"åæ–‡ç»†é»‘","fonts/simkai.ttf":"ä¸­æ˜“æ¥·ä½“","fonts/simfang.ttf":"ä¸­æ˜“ä»¿å®‹","fonts/simhei.ttf":"ä¸­æ˜“é»‘ä½“","fonts/SIMLI.TTF":"ä¸­æ˜“éš¶ä¹¦","fonts/simsun.ttc":"å®‹ä½“"};if(x[B])return x[B];const K=B.split("/").pop()||B;for(const[u,C]of Object.entries(x))if((u.split("/").pop()||"").toLowerCase()===K.toLowerCase())return C;return K.replace(/\.(ttf|ttc|otf)$/i,"")}function V(B){const x=String(B);if(x==="custom-font"){R.value?.click();return}a.updateTextStyle({fontFamily:x}),l("textStyleChanged","fontFamily",x)}function G(B){const x=String(B);a.updateTextStyle({layoutDirection:x}),l("textStyleChanged","layoutDirection",x)}function j(B){const x=String(B);a.updateTextStyle({inpaintMethod:x})}function k(B){const x=B.target.value;a.updateTextStyle({textColor:x}),l("textStyleChanged","textColor",x)}function y(B){const x=B.target.checked;a.updateTextStyle({useAutoTextColor:x})}function I(B){const x=B.target.checked;a.updateTextStyle({strokeEnabled:x}),l("textStyleChanged","strokeEnabled",x)}function f(B){const x=B.target.value;a.updateTextStyle({strokeColor:x}),l("textStyleChanged","strokeColor",x)}function d(B){const x=parseInt(B.target.value);isNaN(x)||(a.updateTextStyle({strokeWidth:x}),l("textStyleChanged","strokeWidth",x))}function m(B){const x=B.target.value;a.updateTextStyle({fillColor:x}),l("textStyleChanged","fillColor",x)}function E(){s.value=!s.value}function te(){const x=!Object.values(i.value).every(K=>K);i.value={fontSize:x,fontFamily:x,layoutDirection:x,textColor:x,fillColor:x,strokeEnabled:x,strokeColor:x,strokeWidth:x}}function M(){l("applyToAll",{...i.value}),s.value=!1}function Z(B){B.target.closest(".apply-settings-group")||(s.value=!1)}return typeof window<"u"&&window.addEventListener("click",Z),(B,x)=>(D(),L("aside",Vs,[e("div",Ks,[x[43]||(x[43]=e("h2",null,"ç¿»è¯‘è®¾ç½®",-1)),e("div",Ws,[e("h3",{class:"collapsible-header",onClick:p},[x[20]||(x[20]=Se(" æ–‡å­—è®¾ç½® ",-1)),e("span",qs,le(r.value?"â–¼":"â–¶"),1)]),se(e("div",Hs,[e("div",Js,[e("div",js,[x[22]||(x[22]=e("label",{for:"fontSize"},"å­—å·å¤§å°:",-1)),e("input",{type:"number",id:"fontSize",value:w.value.fontSize,min:"10",max:"100",disabled:w.value.autoFontSize,class:Me({"disabled-input":w.value.autoFontSize}),title:w.value.autoFontSize?"å·²å¯ç”¨è‡ªåŠ¨å­—å·ï¼Œé¦–æ¬¡ç¿»è¯‘æ—¶å°†è‡ªåŠ¨è®¡ç®—":"",onInput:b},null,42,Ys),e("span",Xs,[e("input",{type:"checkbox",id:"autoFontSize",checked:w.value.autoFontSize,onChange:T},null,40,Gs),x[21]||(x[21]=e("label",{for:"autoFontSize"},"è‡ªåŠ¨è®¡ç®—åˆå§‹å­—å·",-1))])]),e("div",Zs,[x[23]||(x[23]=e("label",{for:"fontFamily"},"æ–‡æœ¬å­—ä½“:",-1)),he(Oe,{"model-value":w.value.fontFamily,options:g.value,onChange:V},null,8,["model-value","options"]),e("input",{ref_key:"fontUploadInput",ref:R,type:"file",id:"fontUpload",accept:".ttf,.ttc,.otf",style:{display:"none"},onChange:O},null,544)]),e("div",Qs,[x[24]||(x[24]=e("label",{for:"layoutDirection"},"æ’ç‰ˆè®¾ç½®:",-1)),he(Oe,{"model-value":w.value.layoutDirection,options:h,onChange:G},null,8,["model-value"])]),e("div",ea,[x[26]||(x[26]=e("label",{for:"textColor"},"æ–‡å­—é¢œè‰²:",-1)),e("div",ta,[e("label",oa,[e("input",{type:"checkbox",checked:w.value.useAutoTextColor,onChange:y},null,40,na),x[25]||(x[25]=e("span",null,"è‡ªåŠ¨",-1))]),e("input",{type:"color",id:"textColor",value:w.value.textColor,disabled:w.value.useAutoTextColor,onInput:k},null,40,sa)]),w.value.useAutoTextColor?(D(),L("div",aa," ğŸ’¡ ç¿»è¯‘æ—¶å°†è‡ªåŠ¨ä½¿ç”¨è¯†åˆ«åˆ°çš„æ–‡å­—é¢œè‰² ")):ge("",!0)]),e("div",la,[e("span",ia,[e("input",{type:"checkbox",id:"strokeEnabled",checked:w.value.strokeEnabled,onChange:I},null,40,ra),x[27]||(x[27]=e("label",{for:"strokeEnabled"},"å¯ç”¨æ–‡æœ¬æè¾¹:",-1))])]),he(Ko,{name:"stroke-slide"},{default:ht(()=>[w.value.strokeEnabled?(D(),L("div",ua,[e("div",ca,[x[28]||(x[28]=e("label",{for:"strokeColor"},"æè¾¹é¢œè‰²:",-1)),e("input",{type:"color",id:"strokeColor",value:w.value.strokeColor,onInput:f},null,40,da)]),e("div",ga,[x[29]||(x[29]=e("label",{for:"strokeWidth"},"æè¾¹å®½åº¦ (px):",-1)),e("input",{type:"number",id:"strokeWidth",value:w.value.strokeWidth,min:"0",max:"10",style:{width:"60px",padding:"5px"},onInput:d},null,40,pa),x[30]||(x[30]=e("div",{class:"input-hint"},"0 è¡¨ç¤ºæ— æè¾¹ã€‚",-1))])])):ge("",!0)]),_:1}),e("div",ma,[x[31]||(x[31]=e("label",{for:"useInpainting"},"æ°”æ³¡å¡«å……æ–¹å¼:",-1)),he(Oe,{"model-value":w.value.inpaintMethod,options:_,onChange:j},null,8,["model-value"])]),he(Ko,{name:"slide-fade"},{default:ht(()=>[w.value.inpaintMethod==="solid"?(D(),L("div",va,[x[32]||(x[32]=e("label",{for:"fillColor"},"å¡«å……é¢œè‰²:",-1)),e("input",{type:"color",id:"fillColor",value:w.value.fillColor,onInput:m},null,40,ba)])):ge("",!0)]),_:1})]),e("div",fa,[e("button",{type:"button",class:"settings-button",disabled:!$.value,onClick:M}," åº”ç”¨åˆ°å…¨éƒ¨ ",8,ha),e("button",{type:"button",class:"settings-gear-btn",title:"é€‰æ‹©è¦åº”ç”¨çš„å‚æ•°",onClick:E}," âš™ï¸ "),s.value?(D(),L("div",ya,[e("div",xa,[e("input",{type:"checkbox",id:"apply_selectAll",checked:Object.values(i.value).every(K=>K),onChange:te},null,40,ka),x[33]||(x[33]=e("label",{for:"apply_selectAll"},"å…¨é€‰",-1))]),x[42]||(x[42]=e("hr",null,null,-1)),e("div",_a,[se(e("input",{type:"checkbox",id:"apply_fontSize","onUpdate:modelValue":x[0]||(x[0]=K=>i.value.fontSize=K)},null,512),[[et,i.value.fontSize]]),x[34]||(x[34]=e("label",{for:"apply_fontSize"},"å­—å·",-1))]),e("div",Sa,[se(e("input",{type:"checkbox",id:"apply_fontFamily","onUpdate:modelValue":x[1]||(x[1]=K=>i.value.fontFamily=K)},null,512),[[et,i.value.fontFamily]]),x[35]||(x[35]=e("label",{for:"apply_fontFamily"},"å­—ä½“",-1))]),e("div",Ca,[se(e("input",{type:"checkbox",id:"apply_layoutDirection","onUpdate:modelValue":x[2]||(x[2]=K=>i.value.layoutDirection=K)},null,512),[[et,i.value.layoutDirection]]),x[36]||(x[36]=e("label",{for:"apply_layoutDirection"},"æ’ç‰ˆæ–¹å‘",-1))]),e("div",wa,[se(e("input",{type:"checkbox",id:"apply_textColor","onUpdate:modelValue":x[3]||(x[3]=K=>i.value.textColor=K)},null,512),[[et,i.value.textColor]]),x[37]||(x[37]=e("label",{for:"apply_textColor"},"æ–‡å­—é¢œè‰²",-1))]),e("div",$a,[se(e("input",{type:"checkbox",id:"apply_fillColor","onUpdate:modelValue":x[4]||(x[4]=K=>i.value.fillColor=K)},null,512),[[et,i.value.fillColor]]),x[38]||(x[38]=e("label",{for:"apply_fillColor"},"å¡«å……é¢œè‰²",-1))]),e("div",Ia,[se(e("input",{type:"checkbox",id:"apply_strokeEnabled","onUpdate:modelValue":x[5]||(x[5]=K=>i.value.strokeEnabled=K)},null,512),[[et,i.value.strokeEnabled]]),x[39]||(x[39]=e("label",{for:"apply_strokeEnabled"},"æè¾¹å¼€å…³",-1))]),e("div",Ta,[se(e("input",{type:"checkbox",id:"apply_strokeColor","onUpdate:modelValue":x[6]||(x[6]=K=>i.value.strokeColor=K)},null,512),[[et,i.value.strokeColor]]),x[40]||(x[40]=e("label",{for:"apply_strokeColor"},"æè¾¹é¢œè‰²",-1))]),e("div",Da,[se(e("input",{type:"checkbox",id:"apply_strokeWidth","onUpdate:modelValue":x[7]||(x[7]=K=>i.value.strokeWidth=K)},null,512),[[et,i.value.strokeWidth]]),x[41]||(x[41]=e("label",{for:"apply_strokeWidth"},"æè¾¹å®½åº¦",-1))])])):ge("",!0)])],512),[[Ae,r.value]])]),e("div",Ra,[e("button",{id:"translateButton",disabled:!W.value,onClick:x[8]||(x[8]=K=>l("translateCurrent"))}," ç¿»è¯‘å½“å‰å›¾ç‰‡ ",8,Ma),e("button",{id:"translateAllButton",disabled:!W.value,onClick:x[9]||(x[9]=K=>l("translateAll"))}," ç¿»è¯‘æ‰€æœ‰å›¾ç‰‡ ",8,Ea),e("button",{id:"startHqTranslationBtn",class:"settings-button purple-button",disabled:!W.value,title:"ä½¿ç”¨é«˜è´¨é‡ç¿»è¯‘æ¨¡å¼ï¼ˆéœ€åœ¨è®¾ç½®ä¸­é…ç½®ï¼‰",onClick:x[10]||(x[10]=K=>l("hqTranslate"))}," é«˜è´¨é‡ç¿»è¯‘ ",8,Pa),e("button",{id:"proofreadButton",disabled:!W.value,onClick:x[11]||(x[11]=K=>l("proofread"))}," AIæ ¡å¯¹ ",8,Ba),e("button",{id:"removeTextOnlyButton",disabled:!v.value,title:"æ¶ˆé™¤å›¾ç‰‡ä¸­çš„æ°”æ³¡æ–‡å­—ï¼Œæ— éœ€å¡«å†™ç¿»è¯‘æœåŠ¡å•†å’ŒAPI Key",onClick:x[12]||(x[12]=K=>l("removeText"))}," ä»…æ¶ˆé™¤æ–‡å­— ",8,Aa),e("button",{id:"removeAllTextButton",disabled:!$.value,title:"æ¶ˆé™¤æ‰€æœ‰å›¾ç‰‡ä¸­çš„æ°”æ³¡æ–‡å­—ï¼Œæ— éœ€å¡«å†™ç¿»è¯‘æœåŠ¡å•†å’ŒAPI Key",onClick:x[13]||(x[13]=K=>l("removeAllText"))}," æ¶ˆé™¤æ‰€æœ‰å›¾ç‰‡æ–‡å­— ",8,Fa),e("button",{id:"deleteCurrentImageButton",class:"settings-button red-button",disabled:!v.value,onClick:x[14]||(x[14]=K=>l("deleteCurrent"))}," åˆ é™¤å½“å‰å›¾ç‰‡ ",8,La),e("button",{id:"clearAllImagesButton",class:"settings-button red-button",disabled:!$.value,onClick:x[15]||(x[15]=K=>l("clearAll"))}," æ¸…é™¤æ‰€æœ‰å›¾ç‰‡ ",8,Ua),e("button",{id:"cleanDebugFilesButton",class:"settings-button orange-button",onClick:x[16]||(x[16]=K=>l("cleanTemp"))}," æ¸…ç†ä¸´æ—¶æ–‡ä»¶ "),e("button",{id:"managePluginsButton",class:"settings-button blue-button",onClick:x[17]||(x[17]=K=>l("openPlugins"))}," æ’ä»¶ç®¡ç† ")]),e("div",Oa,[e("button",{id:"prevImageButton",disabled:!z.value,onClick:x[18]||(x[18]=K=>l("previous"))}," ä¸Šä¸€å¼  ",8,za),e("button",{id:"nextImageButton",disabled:!N.value,onClick:x[19]||(x[19]=K=>l("next"))}," ä¸‹ä¸€å¼  ",8,Na)])])]))}}),Ka=He(Va,[["__scopeId","data-v-df51db99"]]);function _t(n){if(n.textDirection&&n.textDirection!=="auto")return n.textDirection;if(n.autoTextDirection&&n.autoTextDirection!=="auto")return n.autoTextDirection;if(n.coords){const[t,l,o,a]=n.coords;return a-l>o-t?"vertical":"horizontal"}return"vertical"}function Wa(){const n=je(),t=Ve(),l=ct(),o=S(!1),a=S(0),r=S(""),s=S(!1),i=S(0),h=S(""),_=Y(()=>n.hasImages),v=Y(()=>n.hasImages),$=Y(()=>n.hasImages);function W(){const g=n.images;if(g.length===0){l.warning("æ²¡æœ‰å¯å¯¼å‡ºçš„å›¾ç‰‡æ–‡æœ¬");return}const c=[];for(let G=0;G<g.length;G++){const j=g[G];if(!j)continue;const k=j.bubbleStates||[],y={imageIndex:G,bubbles:[]};for(let I=0;I<k.length;I++){const f=k[I];if(!f)continue;const d=f.originalText||"",m=f.translatedText||f.textboxText||"";let E="vertical";f.textDirection&&f.textDirection!=="auto"?E=f.textDirection:f.autoTextDirection&&(E=f.autoTextDirection),y.bubbles.push({bubbleIndex:I,original:d,translated:m,textDirection:E})}c.push(y)}const p=JSON.stringify(c,null,2),b=new Blob([p],{type:"application/json"}),T=URL.createObjectURL(b),O=document.createElement("a");O.href=T;const V=new Date().toISOString().replace(/[-:T]/g,"").slice(0,15);O.download=`translations_${V}.json`,document.body.appendChild(O),O.click(),document.body.removeChild(O),URL.revokeObjectURL(T),l.success("æ–‡æœ¬å¯¼å‡ºæˆåŠŸï¼")}function z(){const g=n.images;if(g.length===0)return null;const c=[];for(let p=0;p<g.length;p++){const b=g[p];if(!b)continue;const T=b.bubbleStates||[],O={imageIndex:p,bubbles:[]};for(let Q=0;Q<T.length;Q++){const V=T[Q];if(!V)continue;const G=V.originalText||"",j=V.translatedText||V.textboxText||"";let k="vertical";V.textDirection&&V.textDirection!=="auto"?k=V.textDirection:V.autoTextDirection&&(k=V.autoTextDirection),O.bubbles.push({bubbleIndex:Q,original:G,translated:j,textDirection:k})}c.push(O)}return c}async function N(g){if(!g){l.warning("æœªé€‰æ‹©æ–‡ä»¶");return}s.value=!0,i.value=0,h.value="å‡†å¤‡å¯¼å…¥æ–‡æœ¬...",l.info("æ­£åœ¨å¯¼å…¥æ–‡æœ¬...",0);try{const c=await w(g);i.value=10,h.value="è§£æ JSON æ•°æ®...";const p=JSON.parse(c);if(!Array.isArray(p))throw new Error("å¯¼å…¥çš„ JSON æ ¼å¼ä¸æ­£ç¡®ï¼Œåº”ä¸ºæ•°ç»„");let b=0,T=0;const O=t.settings.textStyle,Q=O.autoFontSize?"auto":O.fontSize,V=O.fontFamily,G=O.textColor,j=O.fillColor;i.value=20,h.value="å¼€å§‹æ›´æ–°å›¾ç‰‡...";const k=p.length;let y=0;const I=[];for(const m of p){y++;const E=20+y/k*60;i.value=E,h.value=`å¤„ç†å›¾ç‰‡ ${y}/${k}`;const te=m.imageIndex;if(te<0||te>=n.images.length){console.warn(`è·³è¿‡æ— æ•ˆçš„å›¾ç‰‡ç´¢å¼•: ${te}`);continue}const M=n.images[te];if(!M)continue;let Z=!1;M.bubbleStates||(M.bubbleStates=[]),M.bubbleTexts||(M.bubbleTexts=[]),M.originalTexts||(M.originalTexts=[]);for(const B of m.bubbles){const x=B.bubbleIndex,K=B.original,u=B.translated,C=B.textDirection,ue=C==="vertical"||C==="horizontal"?C:"vertical";for(;M.bubbleTexts.length<=x;)M.bubbleTexts.push("");for(;M.originalTexts.length<=x;)M.originalTexts.push("");for(K&&(M.originalTexts[x]=K),u&&(M.bubbleTexts[x]=u);M.bubbleStates.length<=x;)M.bubbleStates.push(A(Q,V,G,j));const P=M.bubbleStates[x];P&&(K&&(P.originalText=K),u&&(P.translatedText=u,P.textboxText=u),P.textDirection=ue,Z=!0,T++)}Z&&M.bubbleStates&&(M.bubbleTexts=M.bubbleStates.map(B=>B.translatedText||"")),Z&&(b++,M.hasUnsavedChanges=!0,M.translatedDataURL&&M.bubbleStates&&M.bubbleStates.length>0&&I.push(te))}if(I.length>0){i.value=80,h.value="å¼€å§‹æ¸²æŸ“å›¾ç‰‡...",l.info("æ­£åœ¨æ¸²æŸ“å›¾ç‰‡ï¼Œè¯·ç¨å€™...",0);const m=t.settings.textStyle,E=m.layoutDirection,te=E==="auto";for(let M=0;M<I.length;M++){const Z=I[M];if(Z===void 0)continue;const B=n.images[Z];if(!(!B||!B.bubbleStates)){i.value=80+M/I.length*20,h.value=`æ¸²æŸ“å›¾ç‰‡ ${M+1}/${I.length}`;try{let x="";if(B.cleanImageData?x=B.cleanImageData.includes("base64,")?B.cleanImageData.split("base64,")[1]||"":B.cleanImageData:B.originalDataURL&&(x=B.originalDataURL.includes("base64,")?B.originalDataURL.split("base64,")[1]||"":B.originalDataURL,console.log(`importText: å›¾ç‰‡ ${Z} ä½¿ç”¨åŸå›¾ä½œä¸ºèƒŒæ™¯ï¼ˆå…œåº•ï¼‰`)),!x){console.log(`importText: å›¾ç‰‡ ${Z} æ²¡æœ‰å¯ç”¨çš„èƒŒæ™¯å›¾ï¼Œè·³è¿‡`);continue}const K=B.bubbleStates.map(C=>({translatedText:C.translatedText||"",coords:C.coords,fontSize:C.fontSize||m.fontSize,fontFamily:C.fontFamily||m.fontFamily,textDirection:_t(C),textColor:C.textColor||m.textColor,rotationAngle:C.rotationAngle||0,position:C.position||{x:0,y:0},strokeEnabled:C.strokeEnabled??m.strokeEnabled,strokeColor:C.strokeColor||m.strokeColor,strokeWidth:C.strokeWidth??m.strokeWidth})),u=await ro({clean_image:x,bubble_texts:K.map(C=>C.translatedText),bubble_coords:K.map(C=>C.coords),fontSize:m.fontSize,fontFamily:m.fontFamily,textDirection:te?"vertical":E,textColor:m.textColor,bubble_states:K,use_individual_styles:!0,use_inpainting:!1,use_lama:!1,is_font_style_change:!0,strokeEnabled:m.strokeEnabled,strokeColor:m.strokeColor,strokeWidth:m.strokeWidth});u.rendered_image&&(n.updateImageByIndex(Z,{translatedDataURL:`data:image/png;base64,${u.rendered_image}`,hasUnsavedChanges:!0}),console.log(`importText: å›¾ç‰‡ ${Z} æ¸²æŸ“æˆåŠŸ`))}catch(x){console.error(`importText: é‡æ¸²æŸ“å›¾ç‰‡ ${Z} å¤±è´¥:`,x)}}}}i.value=100,h.value="å¯¼å…¥å®Œæˆ";const f=I.length,d=f>0?`å¯¼å…¥æˆåŠŸï¼æ›´æ–°äº† ${b} å¼ å›¾ç‰‡ä¸­çš„ ${T} ä¸ªæ°”æ³¡æ–‡æœ¬ï¼Œé‡æ¸²æŸ“äº† ${f} å¼ å›¾ç‰‡`:`å¯¼å…¥æˆåŠŸï¼æ›´æ–°äº† ${b} å¼ å›¾ç‰‡ä¸­çš„ ${T} ä¸ªæ°”æ³¡æ–‡æœ¬`;l.success(d)}catch(c){console.error("å¯¼å…¥æ–‡æœ¬å‡ºé”™:",c),l.error(`å¯¼å…¥å¤±è´¥: ${c instanceof Error?c.message:String(c)}`)}finally{s.value=!1,setTimeout(()=>{i.value=0,h.value=""},2e3)}}function w(g){return new Promise((c,p)=>{const b=new FileReader;b.onload=T=>{T.target?.result?c(T.target.result):p(new Error("è¯»å–æ–‡ä»¶å¤±è´¥"))},b.onerror=()=>p(new Error("è¯»å–æ–‡ä»¶æ—¶å‡ºé”™")),b.readAsText(g)})}function A(g,c,p,b){const T=t.settings.textStyle;return{coords:[0,0,100,100],polygon:[],originalText:"",translatedText:"",textboxText:"",fontSize:typeof g=="number"?g:25,fontFamily:c,textDirection:"vertical",autoTextDirection:"vertical",textColor:p,fillColor:b,rotationAngle:0,position:{x:0,y:0},strokeEnabled:T.strokeEnabled,strokeColor:T.strokeColor,strokeWidth:T.strokeWidth,inpaintMethod:T.inpaintMethod}}function U(){const g=n.currentImage;if(!g){l.warning("æ²¡æœ‰å¯ä¸‹è½½çš„å›¾ç‰‡");return}const c=g.translatedDataURL||g.originalDataURL;if(!c){l.warning("æ²¡æœ‰å¯ä¸‹è½½çš„å›¾ç‰‡");return}o.value=!0;try{const p=c.split(",")[1];if(!p)throw new Error("æ— æ•ˆçš„å›¾ç‰‡æ•°æ®");const b=atob(p),T=[];for(let k=0;k<b.length;k+=512){const y=b.slice(k,k+512),I=new Array(y.length);for(let d=0;d<y.length;d++)I[d]=y.charCodeAt(d);const f=new Uint8Array(I);T.push(f.buffer)}const O=new Blob(T,{type:"image/png"}),Q=URL.createObjectURL(O),V=document.createElement("a");V.href=Q;let G=g.fileName||`image_${n.currentImageIndex}.png`;G=`${g.translatedDataURL?"translated":"original"}_${G.replace(/\.[^/.]+$/,"")}.png`,V.download=G,document.body.appendChild(V),V.click(),document.body.removeChild(V),URL.revokeObjectURL(Q),l.success(`ä¸‹è½½æˆåŠŸ: ${G}`)}catch(p){console.error("ä¸‹è½½å›¾ç‰‡æ—¶å‡ºé”™:",p),l.error("ä¸‹è½½å¤±è´¥")}finally{o.value=!1}}async function R(g="zip"){const c=n.images;if(c.length===0){l.warning("æ²¡æœ‰å¯ä¸‹è½½çš„å›¾ç‰‡");return}o.value=!0,a.value=0,r.value="å‡†å¤‡ä¸‹è½½...",l.info("ä¸‹è½½ä¸­...å¤„ç†å¯èƒ½éœ€è¦ä¸€å®šæ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…...",0);try{const p=[];let b=0,T=0;a.value=5,r.value="æ£€æŸ¥å›¾ç‰‡æ•°æ®...";for(let d=0;d<c.length;d++){const m=c[d];m&&(m.translatedDataURL?(p.push({index:d,type:"translated"}),b++):m.originalDataURL&&(p.push({index:d,type:"original"}),T++))}if(p.length===0){l.warning("æ²¡æœ‰å¯ä¸‹è½½çš„å›¾ç‰‡");return}a.value=10,r.value="åˆ›å»ºä¸‹è½½ä¼šè¯...";const O=await ls(p.length);if(!O.success||!O.session_id)throw new Error(O.error||"åˆ›å»ºä¼šè¯å¤±è´¥");const Q=O.session_id,V=p.length;let G=0,j=0;for(let d=0;d<p.length;d++){const m=p[d];if(!m)continue;const E=c[m.index];if(!E)continue;const te=m.type==="translated"?E.translatedDataURL:E.originalDataURL;if(!te)continue;const M=10+d/V*70;a.value=M,r.value=`ä¸Šä¼ å›¾ç‰‡ ${d+1}/${V}...`;try{const Z=await is(Q,te,d);Z.success?G++:(console.error(`ä¸Šä¼ å›¾ç‰‡ ${d} å¤±è´¥:`,Z.error),j++)}catch(Z){console.error(`ä¸Šä¼ å›¾ç‰‡ ${d} å‡ºé”™:`,Z),j++}}if(G===0)throw new Error("æ‰€æœ‰å›¾ç‰‡ä¸Šä¼ å¤±è´¥");a.value=85,r.value="æ‰“åŒ…æ–‡ä»¶...";const k=await rs(Q,g);if(!k.success||!k.file_id)throw new Error(k.error||"æ‰“åŒ…å¤±è´¥");a.value=95,r.value="å‡†å¤‡ä¸‹è½½...";const y=us(k.file_id,g),I=document.createElement("a");I.href=y,document.body.appendChild(I),I.click(),document.body.removeChild(I),a.value=100,r.value="ä¸‹è½½å·²å¼€å§‹";let f=`å·²æˆåŠŸå¤„ç† ${G} å¼ å›¾ç‰‡`;j>0&&(f+=`ï¼ˆ${j} å¼ å¤±è´¥ï¼‰`),b>0&&T>0?f+=`ï¼ˆ${b} å¼ ç¿»è¯‘å›¾ç‰‡å’Œ ${T} å¼ åŸå§‹å›¾ç‰‡ï¼‰`:b>0?f+="ï¼ˆå…¨éƒ¨ä¸ºç¿»è¯‘åå›¾ç‰‡ï¼‰":T>0&&(f+="ï¼ˆå…¨éƒ¨ä¸ºåŸå§‹å›¾ç‰‡ï¼‰"),f+="ï¼Œä¸‹è½½å³å°†å¼€å§‹",l.success(f),setTimeout(async()=>{try{const d=await io();console.log("ä¸´æ—¶æ–‡ä»¶æ¸…ç†ç»“æœ:",d)}catch(d){console.error("æ¸…ç†ä¸´æ—¶æ–‡ä»¶å¤±è´¥:",d)}},6e4)}catch(p){console.error("ä¸‹è½½æ‰€æœ‰å›¾ç‰‡æ—¶å‡ºé”™:",p),l.error(`ä¸‹è½½å¤±è´¥: ${p instanceof Error?p.message:String(p)}`)}finally{o.value=!1,setTimeout(()=>{a.value=0,r.value=""},2e3)}}return{isDownloading:o,downloadProgress:a,downloadProgressText:r,isImporting:s,importProgress:i,importProgressText:h,canExportText:_,canImportText:v,canDownload:$,exportText:W,exportTextToJson:z,importText:N,downloadCurrentImage:U,downloadAllImages:R}}const qa={key:0,class:"result-section card result-card"},Ha={class:"image-controls"},Ja={class:"image-size-control"},ja=["value"],Ya={id:"imageSizeValue"},Xa={class:"content-container"},Ga={class:"image-container"},Za=["src"],Qa={id:"detectedTextInfo",class:"text-info"},el={id:"detectedTextList"},tl={class:"original-text"},ol={class:"download-section"},nl={class:"download-buttons"},sl=["disabled"],al={class:"download-all-container"},ll=["disabled"],il={class:"download-format-selector"},rl=["disabled"],ul=["disabled"],cl={key:1,class:"empty-state-section"},Zt=60,dl=Je({__name:"ImageResultDisplay",props:{isEditMode:{type:Boolean,default:!1}},emits:["toggle-edit-mode","retry-failed"],setup(n,{emit:t}){const l=[{label:"ZIPå‹ç¼©åŒ…",value:"zip"},{label:"PDFæ–‡æ¡£",value:"pdf"},{label:"CBZæ¼«ç”»",value:"cbz"}],o=t,a=je(),r=Ve(),s=Wa(),i=S(100),h=Y({get:()=>w.value?.showOriginal??!1,set:M=>{w.value&&a.updateCurrentImage({showOriginal:M})}}),_=S("zip"),v=S(null),$=Y(()=>s.isDownloading.value),W=Y(()=>s.downloadProgressText.value),z=Y(()=>s.downloadProgress.value),N=Y(()=>a.hasImages),w=Y(()=>a.currentImage),A=Y(()=>!!w.value?.translatedDataURL),U=Y(()=>!!(w.value?.translatedDataURL||w.value?.originalDataURL)),R=Y(()=>w.value?h.value||!w.value.translatedDataURL?w.value.originalDataURL:w.value.translatedDataURL:""),g=Y(()=>a.failedImageCount>0),c=Y(()=>({width:`${i.value}%`})),p=Y(()=>r.settings.useTextboxPrompt),b=Y(()=>{if(!w.value)return[];if(w.value.bubbleStates&&w.value.bubbleStates.length>0)return w.value.bubbleStates.map(B=>({original:B.originalText||"",translated:p.value?B.textboxText||B.translatedText||"":B.translatedText||""}));const M=w.value.originalTexts||[],Z=p.value?w.value.textboxTexts||w.value.bubbleTexts||[]:w.value.bubbleTexts||[];return M.length===0?[]:M.map((B,x)=>({original:B||"",translated:Z[x]||""}))}),T=Y(()=>b.value.length>0);function O(M){if(!M||M.length<=Zt)return M;let Z="",B="";for(let x=0;x<M.length;x++)if(B+=M[x],B.length>=Zt){let K=-1;for(let u=B.length-1;u>=0;u--){const C=B[u];if(C&&["ã€‚","ï¼","ï¼Ÿ",".","!","?","ï¼›",";","ï¼Œ",","].includes(C)){K=u+1;break}}K>Zt*.6?(Z+=B.substring(0,K)+`
`,B=B.substring(K)):(Z+=B+`
`,B="")}return B&&(Z+=B),Z}function Q(M){return O((M||"").trim())}function V(M){const Z=(M||"").trim();return O(Z)}function G(M){return(M||"").includes("ç¿»è¯‘å¤±è´¥")}function j(){h.value=!h.value}function k(){o("toggle-edit-mode")}function y(M){const Z=M.target;i.value=parseInt(Z.value,10)}function I(){o("retry-failed")}function f(){s.downloadCurrentImage()}function d(){s.downloadAllImages(_.value)}function m(){s.exportText()}function E(){v.value?.click()}async function te(M){const Z=M.target,B=Z.files?.[0];B&&(await s.importText(B),Z.value="")}return(M,Z)=>w.value?(D(),L("section",qa,[e("div",Ha,[A.value?(D(),L("button",{key:0,id:"toggleImageButton",class:"control-btn",onClick:j},le(h.value?"æŸ¥çœ‹ç¿»è¯‘å›¾":"æŸ¥çœ‹åŸå›¾"),1)):ge("",!0),e("button",{id:"toggleEditModeButton",class:Me(["control-btn",{active:n.isEditMode}]),onClick:k},le(n.isEditMode?"é€€å‡ºç¼–è¾‘":"åˆ‡æ¢ç¼–è¾‘æ¨¡å¼"),3),e("div",Ja,[Z[1]||(Z[1]=e("label",{for:"imageSize"},"å›¾ç‰‡å¤§å°:",-1)),e("input",{type:"range",id:"imageSize",min:"50",max:"200",value:i.value,class:"slider range-slider",onInput:y},null,40,ja),e("span",Ya,le(i.value)+"%",1)]),g.value?(D(),L("button",{key:1,id:"retranslateFailedButton",class:"retry-failed-btn",onClick:I,title:"é‡æ–°ç¿»è¯‘æ‰€æœ‰å¤±è´¥çš„å›¾ç‰‡"}," é‡æ–°ç¿»è¯‘å¤±è´¥å›¾ç‰‡ ("+le(H(a).failedImageCount)+") ",1)):ge("",!0)]),e("div",Xa,[e("div",Ga,[e("img",{id:"translatedImageDisplay",src:R.value,alt:"ç¿»è¯‘åå›¾ç‰‡",style:nt(c.value)},null,12,Za)])]),e("div",Qa,[Z[6]||(Z[6]=e("h3",null,"æ£€æµ‹åˆ°çš„æ–‡æœ¬ï¼ˆåŸæ–‡ â†’ è¯‘æ–‡ï¼‰",-1)),e("pre",el,[T.value?(D(!0),L(qe,{key:0},Ye(b.value,(B,x)=>(D(),L("span",{key:x,class:"text-item"},[e("span",tl,le(Q(B.original)),1),Z[2]||(Z[2]=Se(`
`,-1)),e("span",{class:Me(["translated-text",{"translation-error":G(B.translated)}])},le(V(B.translated)),3),Z[3]||(Z[3]=Se(`
`,-1)),Z[4]||(Z[4]=e("span",{class:"separator"},"â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€",-1)),Z[5]||(Z[5]=Se(`

`,-1))]))),128)):(D(),L(qe,{key:1},[Se("æœªæ£€æµ‹åˆ°æ–‡æœ¬æˆ–å°šæœªç¿»è¯‘")],64))])]),e("div",ol,[$.value?(D(),st(go,{key:0,visible:!0,percentage:z.value,label:W.value||"ä¸‹è½½ä¸­ï¼Œè¯·ç¨å€™..."},null,8,["percentage","label"])):ge("",!0),e("div",nl,[e("button",{id:"downloadButton",class:"download-btn primary",disabled:!U.value,onClick:f}," ä¸‹è½½å½“å‰å›¾ç‰‡ ",8,sl),e("div",al,[e("button",{id:"downloadAllImagesButton",class:"download-btn primary",disabled:!N.value,onClick:d}," ä¸‹è½½æ‰€æœ‰å›¾ç‰‡ ",8,ll),e("div",il,[he(Oe,{modelValue:_.value,"onUpdate:modelValue":Z[0]||(Z[0]=B=>_.value=B),options:l},null,8,["modelValue"])])]),e("button",{id:"exportTextButton",class:"download-btn success",disabled:!N.value,onClick:m}," å¯¼å‡ºæ–‡æœ¬ ",8,rl),e("button",{id:"importTextButton",class:"download-btn success",disabled:!N.value,onClick:E}," å¯¼å…¥æ–‡æœ¬ ",8,ul),e("input",{type:"file",ref_key:"importFileInput",ref:v,id:"importTextFileInput",style:{display:"none"},accept:".json",onChange:te},null,544)])])])):(D(),L("section",cl))}}),gl=He(dl,[["__scopeId","data-v-a26b9c58"]]),pl={class:"guide-content"},ml={class:"guide-footer"},vl={class:"dont-show-option"},Rt="saber_translator_dismiss_setup_reminder",bl=Je({__name:"FirstTimeGuide",emits:["openSettings"],setup(n,{expose:t,emit:l}){const o=l,a=S(!1),r=S(!1);ut(()=>{localStorage.getItem(Rt)!=="true"&&(a.value=!0)});function s(){r.value&&localStorage.setItem(Rt,"true"),a.value=!1}function i(){localStorage.setItem(Rt,"true"),a.value=!1,o("openSettings")}function h(){localStorage.removeItem(Rt)}return t({resetGuideState:h,showGuide:a}),(_,v)=>(D(),st(un,{"model-value":a.value,title:"æ¬¢è¿ä½¿ç”¨ Saber-Translator",onClose:s},{default:ht(()=>[e("div",pl,[v[3]||(v[3]=e("div",{class:"guide-icon"},"ğŸ‰",-1)),v[4]||(v[4]=e("div",{class:"guide-message"},[e("p",{class:"guide-title"},"é¦–æ¬¡ä½¿ç”¨æé†’"),e("p",{class:"guide-text"}," åœ¨å¼€å§‹ç¿»è¯‘ä¹‹å‰ï¼Œè¯·å…ˆé…ç½®ç¿»è¯‘æœåŠ¡ã€‚ "),e("p",{class:"guide-text"},[Se(" ç‚¹å‡»å³ä¸Šè§’çš„ "),e("span",{class:"highlight"},"âš™ï¸ è®¾ç½®"),Se(" æŒ‰é’®ï¼Œé…ç½®ä»¥ä¸‹å†…å®¹ï¼š ")]),e("ul",{class:"guide-list"},[e("li",null,"é€‰æ‹© OCR å¼•æ“ï¼ˆæ–‡å­—è¯†åˆ«ï¼‰"),e("li",null,"é…ç½®ç¿»è¯‘æœåŠ¡å•†å’Œ API Key"),e("li",null,"ï¼ˆå¯é€‰ï¼‰é…ç½®é«˜è´¨é‡ç¿»è¯‘å’Œ AI æ ¡å¯¹")])],-1)),e("div",{class:"guide-actions"},[e("button",{class:"guide-btn primary",onClick:i},[...v[1]||(v[1]=[e("span",{class:"btn-icon"},"âš™ï¸",-1),Se(" ç«‹å³é…ç½® ",-1)])]),e("button",{class:"guide-btn secondary",onClick:s}," ç¨åé…ç½® ")]),e("div",ml,[e("label",vl,[se(e("input",{type:"checkbox","onUpdate:modelValue":v[0]||(v[0]=$=>r.value=$)},null,512),[[et,r.value]]),v[2]||(v[2]=e("span",null,"ä¸å†æ˜¾ç¤ºæ­¤æé†’",-1))])])])]),_:1},8,["model-value"]))}}),fl=He(bl,[["__scopeId","data-v-eda18e4a"]]),Qt="saber_translator_dismiss_setup_reminder",hl=["siliconflow","deepseek","volcano","caiyun","baidu_translate","youdao_translate","gemini","custom_openai"],yl={manga_ocr:"MangaOCR",paddle_ocr:"PaddleOCR",baidu_ocr:"ç™¾åº¦OCR",ai_vision:"AIè§†è§‰OCR"},xl=["ollama","sakura"],kl=["custom_openai"],_l=["custom_openai"],Sl={siliconflow:"SiliconFlow",deepseek:"DeepSeek",volcano:"ç«å±±å¼•æ“",caiyun:"å½©äº‘å°è¯‘",baidu_translate:"ç™¾åº¦ç¿»è¯‘",youdao_translate:"æœ‰é“ç¿»è¯‘",gemini:"Google Gemini",custom_openai:"è‡ªå®šä¹‰ OpenAI",ollama:"Ollama",sakura:"Sakura"};function mn(){const n=Ve(),t=ct(),l=S(!1),o=S(!1),a=Y(()=>{try{return localStorage.getItem(Qt)==="true"}catch{return!1}});function r(b){return Sl[b]||b}function s(b){return hl.includes(b)}function i(b){return xl.includes(b)}function h(b){return kl.includes(b)}function _(b){return _l.includes(b)}function v(b){return yl[b]||b}function $(){const b=n.settings,T=b.ocrEngine,O=b.baiduOcr,Q=b.aiVisionOcr,V=[];return T?(T==="baidu_ocr"&&((!O?.apiKey||O.apiKey.trim()==="")&&V.push("ç™¾åº¦OCR çš„ API Key"),(!O?.secretKey||O.secretKey.trim()==="")&&V.push("ç™¾åº¦OCR çš„ Secret Key")),T==="ai_vision"&&(Q?.provider||V.push("AIè§†è§‰OCR çš„æœåŠ¡å•†"),(!Q?.apiKey||Q.apiKey.trim()==="")&&V.push("AIè§†è§‰OCR çš„ API Key"),(!Q?.modelName||Q.modelName.trim()==="")&&V.push("AIè§†è§‰OCR çš„æ¨¡å‹åç§°"),Q?.provider==="custom"&&(!Q?.customBaseUrl||Q.customBaseUrl.trim()==="")&&V.push("AIè§†è§‰OCR çš„è‡ªå®šä¹‰ Base URL")),V.length>0?{valid:!1,message:`è¯·å…ˆåœ¨é¡¶éƒ¨ âš™ï¸ è®¾ç½®èœå•ä¸­å¡«å†™ ${V[0]}`,missingItems:V}:{valid:!0,message:""}):{valid:!1,message:"è¯·å…ˆåœ¨é¡¶éƒ¨ âš™ï¸ è®¾ç½®èœå•ä¸­é€‰æ‹© OCR å¼•æ“",missingItems:["OCR å¼•æ“"]}}function W(){const{translation:b}=n.settings,{provider:T,apiKey:O,modelName:Q,customBaseUrl:V}=b,G=[];return T?(s(T)&&(!O||O.trim()==="")&&G.push(`${r(T)} çš„ API Key`),(!Q||Q.trim()==="")&&(i(T)||s(T))&&G.push(`${r(T)} çš„æ¨¡å‹åç§°`),h(T)&&(!V||V.trim()==="")&&G.push("è‡ªå®šä¹‰ OpenAI æœåŠ¡çš„ Base URL"),G.length>0?{valid:!1,message:`è¯·å…ˆåœ¨é¡¶éƒ¨ âš™ï¸ è®¾ç½®èœå•ä¸­å¡«å†™ ${G[0]}`,missingItems:G}:{valid:!0,message:""}):{valid:!1,message:"è¯·å…ˆåœ¨é¡¶éƒ¨ âš™ï¸ è®¾ç½®èœå•ä¸­é€‰æ‹©ç¿»è¯‘æœåŠ¡å•†",missingItems:["ç¿»è¯‘æœåŠ¡å•†"]}}function z(){const{hqTranslation:b}=n.settings,{provider:T,apiKey:O,modelName:Q,customBaseUrl:V}=b,G=[];return T?((!O||O.trim()==="")&&G.push("é«˜è´¨é‡ç¿»è¯‘çš„ API Key"),(!Q||Q.trim()==="")&&G.push("é«˜è´¨é‡ç¿»è¯‘çš„æ¨¡å‹åç§°"),_(T)&&(!V||V.trim()==="")&&G.push("é«˜è´¨é‡ç¿»è¯‘çš„ Base URL"),G.length>0?{valid:!1,message:`è¯·å…ˆåœ¨é¡¶éƒ¨ âš™ï¸ è®¾ç½®èœå•ä¸­å¡«å†™ ${G[0]}`,missingItems:G}:{valid:!0,message:""}):{valid:!1,message:"è¯·å…ˆåœ¨é¡¶éƒ¨ âš™ï¸ è®¾ç½®èœå•ä¸­é€‰æ‹©é«˜è´¨é‡ç¿»è¯‘çš„æœåŠ¡å•†",missingItems:["é«˜è´¨é‡ç¿»è¯‘æœåŠ¡å•†"]}}function N(b){const T=b||n.settings.proofreading.rounds,O=[];if(!T||T.length===0)return{valid:!1,message:"è¯·å…ˆåœ¨é¡¶éƒ¨ âš™ï¸ è®¾ç½®èœå•ä¸­æ·»åŠ è‡³å°‘ä¸€ä¸ªæ ¡å¯¹è½®æ¬¡",missingItems:["æ ¡å¯¹è½®æ¬¡"]};for(let Q=0;Q<T.length;Q++){const V=T[Q];if(!V)continue;const G=V.name||`è½®æ¬¡${Q+1}`;if(V.provider||O.push(`æ ¡å¯¹ ${G} çš„æœåŠ¡å•†`),(!V.apiKey||V.apiKey.trim()==="")&&O.push(`æ ¡å¯¹ ${G} çš„ API Key`),(!V.modelName||V.modelName.trim()==="")&&O.push(`æ ¡å¯¹ ${G} çš„æ¨¡å‹åç§°`),O.length>0)return{valid:!1,message:`è¯·å…ˆåœ¨é¡¶éƒ¨ âš™ï¸ è®¾ç½®èœå•ä¸­ä¸º ${O[0]}`,missingItems:O}}return{valid:!0,message:""}}function w(b="normal",T={}){let O;switch(b){case"normal":O=W();break;case"hq":O=z();break;case"proofread":O=N(T.proofreadingRounds);break;case"ocr":O=$();break;default:O=W()}return O.valid?!0:(t.error(O.message),U(),!1)}function A(){const b=$();if(!b.valid)return t.error(b.message),U(),!1;const T=W();return T.valid?!0:(t.error(T.message),U(),!1)}function U(){const b=document.getElementById("openSettingsBtn");b&&(o.value=!0,b.style.animation="settingsBtnPulse 0.5s ease-in-out 3",b.style.boxShadow="0 0 10px var(--primary-color, #4a90d9)",setTimeout(()=>{b.style.animation="",b.style.boxShadow="",o.value=!1},3e3))}function R(){if(a.value){console.log("ç”¨æˆ·å·²é€‰æ‹©ä¸å†æ˜¾ç¤ºè®¾ç½®æé†’");return}l.value=!0}function g(b=!1){if(b)try{localStorage.setItem(Qt,"true"),console.log("ç”¨æˆ·é€‰æ‹©æ°¸ä¹…å…³é—­è®¾ç½®æé†’")}catch(T){console.error("ä¿å­˜è®¾ç½®æé†’çŠ¶æ€å¤±è´¥:",T)}l.value=!1}function c(){try{localStorage.removeItem(Qt),console.log("è®¾ç½®æé†’çŠ¶æ€å·²é‡ç½®")}catch(b){console.error("é‡ç½®è®¾ç½®æé†’çŠ¶æ€å¤±è´¥:",b)}}function p(){setTimeout(()=>{R()},500)}return{showSetupReminder:l,isSettingsButtonHighlighted:o,isSetupReminderDismissed:a,validateOcrConfig:$,validateTranslationConfig:W,validateHqTranslationConfig:z,validateProofreadingConfig:N,validateBeforeTranslation:w,validateFullTranslationConfig:A,highlightSettingsButton:U,checkAndShowSetupReminder:R,closeSetupReminder:g,resetSetupReminderDismiss:c,initValidation:p,getProviderDisplayName:r,getOcrEngineDisplayName:v,requiresApiKey:s,isLocalProvider:i,requiresBaseUrl:h}}const Mt={originalText:"",translatedText:"",textboxText:"",coords:[0,0,100,100],polygon:[],fontSize:25,fontFamily:"fonts/STSONG.TTF",textDirection:"auto",autoTextDirection:"vertical",textColor:"#000000",fillColor:sn,rotationAngle:0,position:{x:0,y:0},strokeEnabled:lo,strokeColor:ao,strokeWidth:so,inpaintMethod:"solid",autoFgColor:null,autoBgColor:null,colorConfidence:0};function oo(n){return{...{...Mt,...n},coords:n?.coords?[...n.coords]:[...Mt.coords],polygon:n?.polygon?n.polygon.map(l=>[...l]):[],position:n?.position?{...Mt.position,...n.position}:{...Mt.position}}}function vn(n){const[t,l,o,a]=n,r=Math.abs(o-t);return Math.abs(a-l)>r?"vertical":"horizontal"}function Cl(n,t){const{bubble_coords:l=[],bubble_states:o=[],original_texts:a=[],bubble_texts:r=[],textbox_texts:s=[],bubble_angles:i=[],auto_directions:h=[]}=n;return o.length>0?o.map((_,v)=>({...oo(t),..._,coords:_.coords||l[v]||[0,0,100,100]})):l.map((_,v)=>{let $;return h[v]?$=h[v]==="v"?"vertical":"horizontal":$=vn(_),oo({coords:_,originalText:a[v]||"",translatedText:r[v]||"",textboxText:s[v]||"",rotationAngle:i[v]||0,autoTextDirection:$,...t})})}function Et(n){return n.map(t=>({...t,coords:[...t.coords],polygon:t.polygon?t.polygon.map(l=>[...l]):[],position:{...t.position},autoFgColor:t.autoFgColor?[...t.autoFgColor]:null,autoBgColor:t.autoBgColor?[...t.autoBgColor]:null}))}function wl(n){if(!n||typeof n!="object")return!1;const t=n;if(!Array.isArray(t.coords)||t.coords.length!==4||!t.coords.every(a=>typeof a=="number"&&!isNaN(a))||typeof t.fontSize!="number"||t.fontSize<=0)return!1;const l=["vertical","horizontal","auto"];if(typeof t.textDirection!="string"||!l.includes(t.textDirection))return!1;const o=["solid","lama_mpe","litelama"];return!(typeof t.inpaintMethod!="string"||!o.includes(t.inpaintMethod))}const it=Ft("bubble",()=>{const n=S([]),t=S(-1),l=S([]),o=S([]),a=S(!1),r=S(-1),s=S(0),i=S(0),h=S(0),_=S(0),v=S(!1),$=S(-1),W=S(null),z=S(!1),N=S(-1),w=S(0),A=Y(()=>t.value>=0&&t.value<n.value.length?n.value[t.value]??null:null),U=Y(()=>n.value.length),R=Y(()=>n.value.length>0),g=Y(()=>t.value>=0),c=Y(()=>l.value.length>1),p=Y(()=>l.value.filter(P=>P>=0&&P<n.value.length).map(P=>n.value[P]).filter(P=>P!==void 0));function b(){const ne=je().currentImage;ne&&(ne.bubbleStates=Et(n.value),ne.hasUnsavedChanges=!0,console.log("æ°”æ³¡çŠ¶æ€å·²åŒæ­¥åˆ°å½“å‰å›¾ç‰‡"))}function T(P,ne=!1){n.value=P,o.value=Et(P),I(),console.log(`æ°”æ³¡æ•°ç»„å·²è®¾ç½®ï¼Œå…± ${P.length} ä¸ªæ°”æ³¡`),ne||b()}function O(P,ne){const de=vn(P),Te=Ve().settings.textStyle,Fe=Te.layoutDirection,Ee=Fe==="auto"?"vertical":Fe||"vertical",ae=oo({coords:P,translatedText:"",autoTextDirection:de,fontSize:Te.fontSize,fontFamily:Te.fontFamily,textDirection:Ee,textColor:Te.textColor,fillColor:Te.fillColor,inpaintMethod:Te.inpaintMethod,strokeEnabled:Te.strokeEnabled,strokeColor:Te.strokeColor,strokeWidth:Te.strokeWidth,rotationAngle:0,position:{x:0,y:0},...ne});return n.value.push(ae),console.log(`å·²æ·»åŠ æ°”æ³¡ï¼Œå½“å‰å…± ${n.value.length} ä¸ª`),b(),ae}function Q(P){return P<0||P>=n.value.length?(console.warn(`åˆ é™¤å¤±è´¥: æ— æ•ˆçš„ç´¢å¼• ${P}`),!1):(n.value.splice(P,1),t.value===P?t.value=-1:t.value>P&&t.value--,l.value=l.value.filter(ne=>ne!==P).map(ne=>ne>P?ne-1:ne),console.log(`å·²åˆ é™¤æ°”æ³¡ï¼Œå½“å‰å…± ${n.value.length} ä¸ª`),b(),!0)}function V(){if(l.value.length===0&&t.value<0)return;const P=[...new Set([...l.value,t.value])].filter(ne=>ne>=0).sort((ne,de)=>de-ne);for(const ne of P)n.value.splice(ne,1);I(),console.log(`å·²åˆ é™¤ ${P.length} ä¸ªæ°”æ³¡`),b()}function G(){n.value=[],o.value=[],I(),console.log("æ‰€æœ‰æ°”æ³¡å·²æ¸…é™¤"),b()}function j(){n.value=[],o.value=[],I(),console.log("æœ¬åœ°æ°”æ³¡çŠ¶æ€å·²æ¸…é™¤ï¼ˆä¸åŒæ­¥åˆ°imageStoreï¼‰")}function k(P){P>=-1&&P<n.value.length&&(t.value=P,l.value=P>=0?[P]:[],console.log(`å·²é€‰ä¸­æ°”æ³¡ ${P}`))}function y(P){if(P<0||P>=n.value.length)return;const ne=l.value.indexOf(P);ne>=0?(l.value.splice(ne,1),t.value===P&&(t.value=l.value[0]??-1)):(l.value.push(P),t.value=P),console.log(`å¤šé€‰çŠ¶æ€: ${l.value.join(", ")}`)}function I(){t.value=-1,l.value=[]}function f(){t.value>=0?l.value=[t.value]:l.value=[]}function d(){if(n.value.length===0)return!1;const P=t.value<n.value.length-1?t.value+1:0;return k(P),!0}function m(){if(n.value.length===0)return!1;const P=t.value>0?t.value-1:n.value.length-1;return k(P),!0}function E(P,ne){if(P<0||P>=n.value.length)return console.warn(`æ›´æ–°å¤±è´¥: æ— æ•ˆçš„ç´¢å¼• ${P}`),!1;const de=n.value[P];return de?(Object.assign(de,ne),console.log(`å·²æ›´æ–°æ°”æ³¡ ${P}`),b(),!0):!1}function te(P){return t.value<0?(console.warn("æ›´æ–°å¤±è´¥: æ²¡æœ‰é€‰ä¸­çš„æ°”æ³¡"),!1):E(t.value,P)}function M(P){const ne=l.value.length>0?l.value:t.value>=0?[t.value]:[];for(const de of ne){const we=n.value[de];we&&Object.assign(we,P)}b(),console.log(`å·²æ‰¹é‡æ›´æ–° ${ne.length} ä¸ªæ°”æ³¡`)}function Z(P){for(let ne=0;ne<n.value.length;ne++){const de=n.value[ne];de&&Object.assign(de,P)}b(),console.log(`å·²æ›´æ–°æ‰€æœ‰ ${n.value.length} ä¸ªæ°”æ³¡`)}function B(){if(n.value.length!==o.value.length)return!0;for(let P=0;P<n.value.length;P++){const ne=n.value[P],de=o.value[P];if(!(!ne||!de)&&(ne.translatedText!==de.translatedText||ne.textboxText!==de.textboxText||ne.fontSize!==de.fontSize||ne.fontFamily!==de.fontFamily||ne.textDirection!==de.textDirection||ne.textColor!==de.textColor||ne.fillColor!==de.fillColor||ne.rotationAngle!==de.rotationAngle||ne.strokeEnabled!==de.strokeEnabled||ne.strokeColor!==de.strokeColor||ne.strokeWidth!==de.strokeWidth||ne.inpaintMethod!==de.inpaintMethod||JSON.stringify(ne.coords)!==JSON.stringify(de.coords)))return!0}return!1}function x(){n.value=Et(o.value),I(),console.log("æ°”æ³¡çŠ¶æ€å·²é‡ç½®åˆ°åˆå§‹çŠ¶æ€")}function K(){o.value=Et(n.value),console.log("å½“å‰çŠ¶æ€å·²ä¿å­˜ä¸ºåˆå§‹çŠ¶æ€")}function u(){return{bubble_coords:n.value.map(P=>P.coords),bubble_texts:n.value.map(P=>P.translatedText),textbox_texts:n.value.map(P=>P.textboxText),font_sizes:n.value.map(P=>P.fontSize),font_families:n.value.map(P=>P.fontFamily),text_directions:n.value.map(P=>P.textDirection==="auto"?P.autoTextDirection==="vertical"?"v":"h":P.textDirection==="vertical"?"v":"h"),text_colors:n.value.map(P=>P.textColor),fill_colors:n.value.map(P=>P.fillColor),rotation_angles:n.value.map(P=>P.rotationAngle),stroke_enabled:n.value.map(P=>P.strokeEnabled),stroke_colors:n.value.map(P=>P.strokeColor),stroke_widths:n.value.map(P=>P.strokeWidth),inpaint_methods:n.value.map(P=>P.inpaintMethod)}}function C(){return JSON.stringify(n.value)}function ue(P){try{const ne=JSON.parse(P);if(!Array.isArray(ne))return console.error("ååºåˆ—åŒ–å¤±è´¥: æ•°æ®ä¸æ˜¯æ•°ç»„"),!1;const de=[];for(const we of ne)wl(we)?de.push(we):console.warn("è·³è¿‡æ— æ•ˆçš„æ°”æ³¡çŠ¶æ€:",we);return T(de),!0}catch(ne){return console.error("ååºåˆ—åŒ–å¤±è´¥:",ne),!1}}return{bubbles:n,selectedIndex:t,selectedIndices:l,initialStates:o,isDragging:a,draggingIndex:r,dragOffsetX:s,dragOffsetY:i,dragInitialX:h,dragInitialY:_,isResizing:v,resizingIndex:$,resizeCurrentCoords:W,isRotating:z,rotatingIndex:N,rotateCurrentAngle:w,selectedBubble:A,bubbleCount:U,hasBubbles:R,hasSelection:g,isMultiSelect:c,selectedBubbles:p,setBubbles:T,addBubble:O,deleteBubble:Q,deleteSelected:V,clearBubbles:G,clearBubblesLocal:j,selectBubble:k,toggleMultiSelect:y,clearSelection:I,clearMultiSelect:f,selectNext:d,selectPrevious:m,updateBubble:E,updateSelectedBubble:te,updateAllSelected:M,updateAllBubbles:Z,hasChanges:B,resetToInitial:x,saveAsInitial:K,toApiRequest:u,serialize:C,deserialize:ue}}),$l=Object.freeze(Object.defineProperty({__proto__:null,useBubbleStore:it},Symbol.toStringTag,{value:"Module"}));function Il(){const n=S({current:0,total:0,completed:0,failed:0,isInProgress:!1,label:"",percentage:0});return{progress:n,reporter:{init(l,o){n.value={current:0,total:l,completed:0,failed:0,isInProgress:!0,label:o||"å‡†å¤‡ä¸­...",percentage:0}},update(l,o){n.value.current=l,o!==void 0&&(n.value.label=o),n.value.total>0&&(n.value.percentage=Math.round(l/n.value.total*100))},setPercentage(l,o){n.value.percentage=Math.min(100,Math.max(0,l)),o!==void 0&&(n.value.label=o)},incrementCompleted(){n.value.completed++},incrementFailed(){n.value.failed++},finish(){n.value.isInProgress=!1,n.value.percentage=100},getProgress(){return{...n.value}}}}}function po(n){let t=n,l=0,o=0,a=Date.now();const r=()=>t<=0?0:Math.ceil(6e4/t);return{async acquire(){if(t<=0)return;const s=Date.now(),i=r();if(s-a>=6e4&&(a=s,o=0),o>=t){const _=6e4-(s-a);_>0&&await jo(_),a=Date.now(),o=0}const h=s-l;h<i&&await jo(i-h),l=Date.now(),o++},reset(){l=0,o=0,a=Date.now()},getRpm(){return t},setRpm(s){t=s,this.reset()}}}function jo(n){return new Promise(t=>setTimeout(t,n))}function At(n){return n.includes(",")&&n.split(",")[1]||n}function Tl(n){if(n.isManuallyAnnotated){const t=n.bubbleStates||[];return{coords:t.map(l=>l.coords),angles:t.map(l=>l.rotationAngle||0),isEmpty:t.length===0,isManual:!0}}return Array.isArray(n.bubbleStates)&&n.bubbleStates.length>0?{coords:n.bubbleStates.map(t=>t.coords),angles:n.bubbleStates.map(t=>t.rotationAngle||0),isEmpty:!1,isManual:!1}:Array.isArray(n.bubbleCoords)&&n.bubbleCoords.length>0?{coords:n.bubbleCoords,angles:n.bubbleAngles,isEmpty:!1,isManual:!1}:null}function Dl(n,t={}){const l=Ve(),{settings:o}=l,{textStyle:a,translation:r,baiduOcr:s,aiVisionOcr:i,boxExpand:h,preciseMask:_}=o,v={image:At(n),ocr_engine:o.ocrEngine,source_language:o.sourceLanguage,model_provider:r.provider,api_key:r.apiKey,model_name:r.modelName,custom_base_url:r.customBaseUrl,target_language:o.targetLanguage,prompt_content:o.translatePrompt,textbox_prompt_content:o.textboxPrompt,use_textbox_prompt:o.useTextboxPrompt,rpm_limit_translation:r.rpmLimit,max_retries:r.maxRetries,use_json_format_translation:r.isJsonMode,detector_type:o.textDetector,box_expand_ratio:h.ratio,box_expand_top:h.top,box_expand_bottom:h.bottom,box_expand_left:h.left,box_expand_right:h.right,usePreciseMask:_.enabled,maskDilateSize:_.dilateSize,maskBoxExpandRatio:_.boxExpandRatio,fontSize:a.fontSize,autoFontSize:a.autoFontSize,fontFamily:a.fontFamily,textDirection:a.layoutDirection==="auto"?"vertical":a.layoutDirection,autoTextDirection:a.layoutDirection==="auto",textColor:a.textColor,fillColor:a.fillColor,strokeEnabled:a.strokeEnabled,strokeColor:a.strokeColor,strokeWidth:a.strokeWidth,useAutoTextColor:a.useAutoTextColor??!0,use_inpainting:!1,use_lama:a.inpaintMethod==="lama_mpe"||a.inpaintMethod==="litelama",lamaModel:a.inpaintMethod==="litelama"?"litelama":"lama_mpe",showDetectionDebug:o.showDetectionDebug,remove_only:t.removeTextOnly,skip_translation:t.removeTextOnly},$=W=>W.map(z=>[Math.round(z[0]),Math.round(z[1]),Math.round(z[2]),Math.round(z[3])]);return t.existingBubbleStates&&t.existingBubbleStates.length>0?(v.bubble_coords=$(t.existingBubbleStates.map(W=>W.coords)),v.bubble_angles=t.existingBubbleStates.map(W=>W.rotationAngle||0)):t.existingBubbleCoords&&(v.bubble_coords=$(t.existingBubbleCoords),v.bubble_angles=t.existingBubbleAngles),o.ocrEngine==="baidu_ocr"&&(v.baidu_api_key=s.apiKey,v.baidu_secret_key=s.secretKey,v.baidu_version=s.version,v.baidu_ocr_language=s.sourceLanguage),o.ocrEngine==="ai_vision"&&(v.ai_vision_provider=i.provider,v.ai_vision_api_key=i.apiKey,v.ai_vision_model_name=i.modelName,v.ai_vision_ocr_prompt=i.prompt,v.rpm_limit_ai_vision_ocr=i.rpmLimit,v.custom_ai_vision_base_url=i.customBaseUrl,v.use_json_format_ai_vision_ocr=i.isJsonMode),v}function Rl(n){const t=Ve(),{textStyle:l}=t.settings;if(!n.bubble_coords||n.bubble_coords.length===0)return null;const o={bubble_coords:n.bubble_coords,bubble_states:n.bubble_states,original_texts:n.original_texts,bubble_texts:n.bubble_texts,textbox_texts:n.textbox_texts,bubble_angles:n.bubble_angles,auto_directions:n.auto_directions},a={fontSize:l.fontSize,fontFamily:l.fontFamily,textDirection:l.layoutDirection==="auto"?"vertical":l.layoutDirection,textColor:l.textColor,fillColor:l.fillColor,strokeEnabled:l.strokeEnabled,strokeColor:l.strokeColor,strokeWidth:l.strokeWidth,inpaintMethod:l.inpaintMethod};return Cl(o,a)}function St(){return"session_"+Date.now()+"_"+Math.random().toString(36).substring(2,9)}function bn(n,t,l){return n.filter(o=>o.imageIndex>=t&&o.imageIndex<l)}function no(n){if(!n||n.length===0)return[];const t=[];for(const l of n){if(!l){console.warn("mergeJsonResults: è·³è¿‡ç©ºçš„æ‰¹æ¬¡ç»“æœ");continue}const o=Array.isArray(l)?l:[l];for(const a of o)a&&typeof a=="object"&&"imageIndex"in a?t.push(a):console.warn("mergeJsonResults: è·³è¿‡æ— æ•ˆçš„å›¾ç‰‡æ•°æ®",a)}return t.sort((l,o)=>l.imageIndex-o.imageIndex),t}const Ml={name:"prepare",type:"prepare",async execute(n,t){const{imageIndex:l,image:o,progress:a}=n,r=je(),s=it(),i=t?.skipTranslation??!1;r.setTranslationStatus(l,"processing");try{const h=Tl(o);if(h?.isEmpty)return console.log(`å‡†å¤‡æ­¥éª¤[${l}]: æ–‡æœ¬æ¡†å·²è¢«ç”¨æˆ·æ¸…ç©ºï¼Œè·³è¿‡`),r.setTranslationStatus(l,"pending"),{success:!0,bubbleCoords:[],originalTexts:[],bubbleStates:[]};const _=Dl(o.originalDataURL,{removeTextOnly:i,existingBubbleCoords:h?.coords,existingBubbleAngles:h?.angles,useExistingBubbles:!!h}),v=await cn(_);if(v.error||!v.translated_image)return r.setTranslationStatus(l,"failed",v.error||"å¤„ç†å¤±è´¥"),{success:!1,error:v.error||"å¤„ç†å¤±è´¥"};const $=Rl(v),W=`data:image/png;base64,${v.translated_image}`;return r.updateImageByIndex(l,{translatedDataURL:W,cleanImageData:v.clean_image||null,bubbleStates:$,bubbleCoords:v.bubble_coords,bubbleAngles:v.bubble_angles||[],originalTexts:v.original_texts,textboxTexts:v.textbox_texts||[],bubbleTexts:$?.map(z=>z.translatedText||"")||[],translationStatus:"completed",translationFailed:!1,showOriginal:!1,hasUnsavedChanges:!0}),l===r.currentImageIndex&&$&&s.setBubbles($),a.incrementCompleted(),{success:!0,translatedImage:v.translated_image,cleanImage:v.clean_image,bubbleCoords:v.bubble_coords,bubbleAngles:v.bubble_angles,originalTexts:v.original_texts,bubbleTexts:v.bubble_texts,textboxTexts:v.textbox_texts,bubbleStates:$||void 0}}catch(h){const _=h instanceof Error?h.message:"å¤„ç†å¤±è´¥";return r.setTranslationStatus(l,"failed",_),a.incrementFailed(),{success:!1,error:_}}}};function Yo(){return Ml}function El(){const t=je().images;if(t.length===0)return null;const l=[];for(let o=0;o<t.length;o++){const a=t[o];if(!a)continue;const r=a.originalTexts||[],s={imageIndex:o,bubbles:[]};for(let i=0;i<r.length;i++){const h=r[i]||"";let _="vertical";const v=a.bubbleStates?.[i];v?.textDirection&&v.textDirection!=="auto"?_=v.textDirection:v?.autoTextDirection&&v.autoTextDirection!=="auto"?_=v.autoTextDirection:a.userLayoutDirection&&a.userLayoutDirection!=="auto"&&(_=a.userLayoutDirection),s.bubbles.push({bubbleIndex:i,original:h,translated:"",textDirection:_})}l.push(s)}return l}function Pl(){return je().images.map(t=>At(t.originalDataURL))}async function Bl(n,t,l){const o=Ve(),{hqTranslation:a}=o.settings,r=JSON.stringify(t,null,2),s=[{type:"text",text:a.prompt+`

ä»¥ä¸‹æ˜¯JSONæ•°æ®:
\`\`\`json
`+r+"\n```"}];for(const _ of n)s.push({type:"image_url",image_url:{url:`data:image/png;base64,${_}`}});const i=[{role:"system",content:"ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ¼«ç”»ç¿»è¯‘åŠ©æ‰‹ï¼Œèƒ½å¤Ÿæ ¹æ®æ¼«ç”»å›¾åƒå†…å®¹å’Œä¸Šä¸‹æ–‡æä¾›é«˜è´¨é‡çš„ç¿»è¯‘ã€‚"},{role:"user",content:s}],h={provider:a.provider,api_key:a.apiKey,model_name:a.modelName,custom_base_url:a.customBaseUrl,messages:i,low_reasoning:a.lowReasoning,force_json_output:a.forceJsonOutput,no_thinking_method:a.noThinkingMethod,use_stream:a.useStream};try{console.log(`å¤šæ¨¡æ€ç¿»è¯‘: é€šè¿‡åç«¯ä»£ç†è°ƒç”¨ ${a.provider} API...`);const _=await uo(h);if(!_.success)throw new Error(_.error||"API è°ƒç”¨å¤±è´¥");if(_.results&&_.results.length>0){const $=_.results[0];if($&&"imageIndex"in $&&"bubbles"in $)return _.results}const v=_.content;if(v)if(a.forceJsonOutput)try{return JSON.parse(v)}catch($){throw console.error("è§£æAIå¼ºåˆ¶JSONè¿”å›çš„å†…å®¹å¤±è´¥:",$),new Error("è§£æAIè¿”å›çš„JSONç»“æœå¤±è´¥")}else{const $=v.match(/```json\s*([\s\S]*?)\s*```/);if($?.[1])try{return JSON.parse($[1])}catch(W){throw console.error("è§£æAIè¿”å›çš„JSONå¤±è´¥:",W),new Error("è§£æAIè¿”å›çš„ç¿»è¯‘ç»“æœå¤±è´¥")}}return null}catch(_){throw console.error("è°ƒç”¨å¤šæ¨¡æ€AIç¿»è¯‘å¤±è´¥:",_),_}}async function Al(n){const t=Ve(),{hqTranslation:l}=t.settings,{progress:o}=n,a=El();if(!a)return{success:!1,error:"å¯¼å‡ºæ–‡æœ¬å¤±è´¥"};const r=Pl(),s=n.config.batchOptions?.batchSize||l.batchSize||3,i=n.config.batchOptions?.maxRetries??l.maxRetries??2,h=n.config.batchOptions?.rpmLimit||l.rpmLimit||0,_=n.config.batchOptions?.sessionResetFrequency||l.sessionReset||5,v=r.length,$=Math.ceil(v/s),W=h>0?po(h):null,z=[];let N=0,w=St();for(let U=0;U<$;U++){const R=Math.round(50+U/$*40);o.setPercentage(R,`ç¿»è¯‘æ‰¹æ¬¡ ${U+1}/${$}`),N>=_&&(console.log("é‡ç½®ä¼šè¯ä¸Šä¸‹æ–‡"),w=St(),N=0);const g=U*s,c=Math.min(g+s,v),p=r.slice(g,c),b=bn(a,g,c);let T=0,O=!1;for(;T<=i&&!O;)try{W&&await W.acquire();const Q=await Bl(p,b,w);if(Q)z.push(Q),O=!0,N++;else{if(T++,T>i)break;await new Promise(V=>setTimeout(V,1e3))}}catch(Q){T++,T<=i?(console.log(`æ‰¹æ¬¡ ${U+1} ç¿»è¯‘å¤±è´¥ï¼Œç¬¬ ${T}/${i} æ¬¡é‡è¯•...`),await new Promise(V=>setTimeout(V,1e3))):console.error(`æ‰¹æ¬¡ ${U+1} ç¿»è¯‘æœ€ç»ˆå¤±è´¥:`,Q)}}const A=no(z);return{success:A.length>0,translationData:A}}function Fl(){const n=je(),t=Ve(),l=n.images,o=t.settings.useTextboxPrompt;if(l.length===0)return null;const a=[];for(let r=0;r<l.length;r++){const s=l[r];if(!s)continue;const i=s.bubbleStates||[],h={imageIndex:r,bubbles:[]};for(let _=0;_<i.length;_++){const v=i[_];if(!v)continue;const $=v.originalText||"",W=o?v.textboxText||v.translatedText||"":v.translatedText||"";let z="vertical";v.textDirection&&v.textDirection!=="auto"?z=v.textDirection:v.autoTextDirection&&v.autoTextDirection!=="auto"&&(z=v.autoTextDirection),h.bubbles.push({bubbleIndex:_,original:$,translated:W,textDirection:z})}a.push(h)}return a}function Ll(){return je().images.map(t=>t.translatedDataURL?At(t.translatedDataURL):At(t.originalDataURL))}async function Ul(n,t,l,o){const a=JSON.stringify(t,null,2),s=[{type:"text",text:l.prompt+`

ä»¥ä¸‹æ˜¯JSONæ•°æ®:
\`\`\`json
`+a+"\n```"}];for(const _ of n)s.push({type:"image_url",image_url:{url:`data:image/png;base64,${_}`}});const i=[{role:"system",content:"ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ¼«ç”»ç¿»è¯‘æ ¡å¯¹åŠ©æ‰‹ï¼Œèƒ½å¤Ÿæ ¹æ®æ¼«ç”»å›¾åƒå†…å®¹æ£€æŸ¥å’Œä¿®æ­£ç¿»è¯‘ã€‚"},{role:"user",content:s}],h={provider:l.provider,api_key:l.apiKey,model_name:l.modelName,custom_base_url:l.customBaseUrl,messages:i,low_reasoning:l.lowReasoning,force_json_output:l.forceJsonOutput,no_thinking_method:l.noThinkingMethod,use_stream:!1};try{console.log(`AIæ ¡å¯¹(${l.name}): é€šè¿‡åç«¯ä»£ç†è°ƒç”¨ ${l.provider} API...`);const _=await uo(h);if(!_.success)throw new Error(_.error||"API è°ƒç”¨å¤±è´¥");if(_.results&&_.results.length>0){const $=_.results[0];if($&&"imageIndex"in $&&"bubbles"in $)return _.results}const v=_.content;if(v)if(l.forceJsonOutput)try{return JSON.parse(v)}catch($){throw console.error("è§£æAIæ ¡å¯¹JSONè¿”å›çš„å†…å®¹å¤±è´¥:",$),new Error("è§£æAIè¿”å›çš„JSONç»“æœå¤±è´¥")}else{const $=v.match(/```json\s*([\s\S]*?)\s*```/);if($?.[1])try{return JSON.parse($[1])}catch(W){throw console.error("è§£æAIæ ¡å¯¹è¿”å›çš„JSONå¤±è´¥:",W),new Error("è§£æAIè¿”å›çš„æ ¡å¯¹ç»“æœå¤±è´¥")}}return null}catch(_){throw console.error("è°ƒç”¨AIæ ¡å¯¹å¤±è´¥:",_),_}}async function Ol(n){const t=Ve(),{proofreading:l}=t.settings,{progress:o}=n;if(!l.rounds||l.rounds.length===0)return{success:!1,error:"è¯·å…ˆé…ç½®æ ¡å¯¹è½®æ¬¡"};const a=Fl();if(!a)return{success:!1,error:"å¯¼å‡ºæ ¡å¯¹æ–‡æœ¬å¤±è´¥"};const r=Ll(),s=r.length,i=[],h=l.maxRetries??2;for(let v=0;v<l.rounds.length;v++){const $=l.rounds[v];if(!$)continue;const W=$.name||`ç¬¬${v+1}è½®æ ¡å¯¹`,z=$.batchSize||3,N=$.rpmLimit||0,w=$.sessionReset||5,A=Math.ceil(s/z),U=N>0?po(N):null,R=v===0?a:no(i);let g=0,c=St();for(let p=0;p<A;p++){const b=v/l.rounds.length*90,T=p/A*(90/l.rounds.length),O=Math.round(5+b+T);o.setPercentage(O,`${W} ${p+1}/${A}`),g>=w&&(console.log("é‡ç½®ä¼šè¯ä¸Šä¸‹æ–‡"),c=St(),g=0);const Q=p*z,V=Math.min(Q+z,s),G=r.slice(Q,V),j=bn(R,Q,V);let k=0,y=!1;for(;k<=h&&!y;)try{U&&await U.acquire();const I=await Ul(G,j,$,c);if(I)i.push(I),y=!0,g++;else{if(k++,k>h)break;await new Promise(f=>setTimeout(f,1e3))}}catch(I){k++,k<=h?(console.log(`${W}æ‰¹æ¬¡ ${p+1} å¤±è´¥ï¼Œç¬¬ ${k}/${h} æ¬¡é‡è¯•...`),await new Promise(f=>setTimeout(f,1e3))):console.error(`${W}æ‰¹æ¬¡ ${p+1} æœ€ç»ˆå¤±è´¥:`,I)}}}const _=no(i);return{success:_.length>0,translationData:_}}async function Xo(n,t){const l=je(),o=Ve(),a=l.images,r=t?.fontSize||o.settings.textStyle.fontSize,s=t?.fontFamily||o.settings.textStyle.fontFamily,i=t?.textDirection||o.settings.textStyle.layoutDirection,h=i==="auto"?"vertical":i,_=t?.textColor||o.settings.textStyle.textColor,v=t?.fillColor||o.settings.textStyle.fillColor,$=t?.strokeEnabled??o.settings.textStyle.strokeEnabled,W=t?.strokeColor||o.settings.textStyle.strokeColor,z=t?.strokeWidth??o.settings.textStyle.strokeWidth;for(const N of n){const w=N.imageIndex;if(w<0||w>=a.length){console.warn(`è·³è¿‡æ— æ•ˆçš„å›¾ç‰‡ç´¢å¼•: ${w}`);continue}const A=a[w];if(!A)continue;let U=!1;const R=A.bubbleTexts||[],g=A.bubbleCoords||[];for(const c of N.bubbles||[]){const p=c.bubbleIndex;if(p<0||p>=g.length){console.warn(`å›¾ç‰‡ ${w}: è·³è¿‡æ— æ•ˆçš„æ°”æ³¡ç´¢å¼• ${p}`);continue}const b=c.translated;let T=c.textDirection;T==="auto"&&(T=h),R[p]=b;const O=T==="vertical"||T==="horizontal"?T:h;if(!A.bubbleStates||!Array.isArray(A.bubbleStates)||A.bubbleStates.length!==g.length){const Q=A.bubbleAngles||[],V=[];for(let G=0;G<g.length;G++){const j=G===p?O:h,k=g[G];let y=j;const I=A.bubbleStates?.[G];if(I?.autoTextDirection&&I.autoTextDirection!=="auto")y=I.autoTextDirection;else if(k&&k.length>=4){const[f,d,m,E]=k;y=E-d>m-f?"vertical":"horizontal"}V.push({translatedText:R[G]||"",originalText:A.originalTexts?.[G]||"",textboxText:"",coords:k,polygon:[],fontSize:r,fontFamily:s,textDirection:j,autoTextDirection:y,position:{x:0,y:0},textColor:_,rotationAngle:Q[G]||0,fillColor:v,strokeEnabled:$,strokeColor:W,strokeWidth:z,inpaintMethod:o.settings.textStyle.inpaintMethod})}A.bubbleStates=V}else A.bubbleStates[p]&&(A.bubbleStates[p].translatedText=b,T&&T!=="auto"&&(A.bubbleStates[p].textDirection=O));U=!0}if(U&&A.bubbleStates){const c=A.bubbleStates.map(p=>p.translatedText||"");l.updateImageByIndex(w,{bubbleStates:A.bubbleStates,bubbleTexts:c,hasUnsavedChanges:!0})}}}async function zl(n,t){const l=je(),o=Ve(),a=it(),r=l.images[n];if(!r||!r.bubbleStates||!r.cleanImageData)return{success:!1,error:"å›¾ç‰‡æ•°æ®ä¸å®Œæ•´ï¼Œæ— æ³•æ¸²æŸ“"};const{textStyle:s}=o.settings,i=t?.fontSize||s.fontSize,h=t?.autoFontSize??s.autoFontSize,_=t?.fontFamily||s.fontFamily,v=t?.textDirection||s.layoutDirection,$=v==="auto"?"vertical":v,W=t?.textColor||s.textColor,z=t?.strokeEnabled??s.strokeEnabled,N=t?.strokeColor||s.strokeColor,w=t?.strokeWidth??s.strokeWidth,A=r.bubbleCoords||[],U=r.bubbleStates.map(R=>R.translatedText||"");try{const R=r.bubbleStates.map(p=>({translatedText:p.translatedText||"",coords:p.coords,fontSize:p.fontSize||i,fontFamily:p.fontFamily||_,textDirection:p.textDirection||$,textColor:p.textColor||W,rotationAngle:p.rotationAngle||0,position:p.position||{x:0,y:0},strokeEnabled:p.strokeEnabled??z,strokeColor:p.strokeColor||N,strokeWidth:p.strokeWidth??w}));let g=r.cleanImageData;g.includes("base64,")&&(g=g.split("base64,")[1]||"");const c=await ot.post("/api/re_render_image",{clean_image:g,bubble_texts:U,bubble_coords:A,fontSize:h?"auto":i,autoFontSize:h,fontFamily:_,textDirection:$,textColor:W,bubble_states:R,use_individual_styles:!0,use_inpainting:!1,use_lama:!1,fillColor:null,is_font_style_change:!1,strokeEnabled:z,strokeColor:N,strokeWidth:w});return c.rendered_image?(l.updateImageByIndex(n,{translatedDataURL:`data:image/png;base64,${c.rendered_image}`,bubbleStates:r.bubbleStates,bubbleTexts:U,hasUnsavedChanges:!0}),n===l.currentImageIndex&&a.setBubbles(r.bubbleStates),{success:!0,renderedImage:c.rendered_image,bubbleStates:r.bubbleStates}):{success:!1,error:c.error||"æ¸²æŸ“å¤±è´¥"}}catch(R){const g=R instanceof Error?R.message:"æ¸²æŸ“å¤±è´¥";return console.error(`æ¸²æŸ“å›¾ç‰‡ ${n} å¤±è´¥:`,R),{success:!1,error:g}}}async function Go(n,t,l){const a=je().images,r=n.map(h=>h.imageIndex).filter(h=>{const _=a[h];return _&&_.cleanImageData&&_.bubbleStates&&_.bubbleStates.length>0});let s=0,i=0;for(let h=0;h<r.length;h++){const _=r[h];if(_===void 0)continue;l&&l(h+1,r.length),(await zl(_,t)).success?s++:i++}return{success:s,failed:i}}function Nl(){const n=je(),t=it(),l=Ve(),o=mn(),a=ct(),{progress:r,reporter:s}=Il(),i=S(!1),h=S(null);let _=null;const v=Y(()=>i.value||n.isBatchTranslationInProgress),$=Y(()=>r.value.percentage||0);function W(){const p=l.settings.translation.rpmLimit;h.value?h.value.setRpm(p):h.value=po(p)}function z(p){const b=p.mode==="hq"?"hq":p.mode==="proofread"?"proofread":p.mode==="removeText"?"ocr":"normal";return o.validateBeforeTranslation(b)}function N(){const{textStyle:p}=l.settings,b=p.layoutDirection;_={fontFamily:p.fontFamily,fontSize:p.fontSize,autoFontSize:p.autoFontSize,autoTextDirection:b==="auto",textDirection:b==="auto"?"vertical":b,fillColor:p.fillColor,textColor:p.textColor,rotationAngle:0,strokeEnabled:p.strokeEnabled,strokeColor:p.strokeColor,strokeWidth:p.strokeWidth},console.log("ç®¡çº¿: ä¿å­˜å½“å‰æ ·å¼è®¾ç½®",_)}function w(p){const b=n.images;if(p.scope==="current"){const T=n.currentImage;return T?[{image:T,index:n.currentImageIndex}]:[]}return p.scope==="failed"?n.getFailedImageIndices().map(O=>({image:b[O],index:O})).filter(O=>O.image!==void 0):b.map((T,O)=>({image:T,index:O}))}async function A(p){const b=w(p);if(b.length===0)return a.warning("æ²¡æœ‰å¯å¤„ç†çš„å›¾ç‰‡"),{success:!1,completed:0,failed:0,errors:["æ²¡æœ‰å¯å¤„ç†çš„å›¾ç‰‡"]};const T=p.mode==="removeText",O=T?"æ¶ˆé™¤æ–‡å­—":"ç¿»è¯‘";s.init(b.length,`${O}: 0/${b.length}`),W();const Q=[];let V=0,G=0;const j=Yo(),k={skipTranslation:T};for(let y=0;y<b.length;y++){const{image:I,index:f}=b[y]||{image:void 0,index:-1};if(!I||f<0)continue;if(p.scope==="all"&&!n.isBatchTranslationInProgress){console.log("ç®¡çº¿: æ‰¹é‡æ“ä½œå·²å–æ¶ˆ");break}s.update(y+1,`${O}: ${y+1}/${b.length}`),h.value&&await h.value.acquire();const d={imageIndex:f,image:I,config:p,progress:s},m=await j.execute(d,k);m.success?V++:(G++,m.error&&Q.push(`å›¾ç‰‡ ${f}: ${m.error}`))}return{success:G===0,completed:V,failed:G,errors:Q.length>0?Q:void 0}}async function U(p){const b=n.images;if(b.length===0)return a.warning("è¯·å…ˆæ·»åŠ å›¾ç‰‡"),{success:!1,completed:0,failed:0,errors:["æ²¡æœ‰å›¾ç‰‡"]};N(),s.init(b.length,"é«˜è´¨é‡ç¿»è¯‘: å‡†å¤‡ä¸­..."),W();const T=[];try{a.info("æ­¥éª¤ 1/4: æ¶ˆé™¤æ‰€æœ‰å›¾ç‰‡æ–‡å­—..."),s.setPercentage(0,"æ¶ˆé™¤æ–‡å­—: 0/"+b.length);let O=0;const Q=Yo();for(let I=0;I<b.length;I++){const f=b[I];if(!f)continue;s.setPercentage(Math.floor(I/b.length*25),`æ¶ˆé™¤æ–‡å­—: ${I+1}/${b.length}`),h.value&&await h.value.acquire();const d={imageIndex:I,image:f,config:p,progress:s},m=await Q.execute(d,{skipTranslation:!0});m.success||(O++,m.error&&T.push(`å›¾ç‰‡ ${I} æ¶ˆé™¤æ–‡å­—å¤±è´¥: ${m.error}`))}O>0&&a.warning(`æ¶ˆé™¤æ–‡å­—å®Œæˆï¼Œä½†æœ‰ ${O} å¼ å›¾ç‰‡å¤±è´¥`),s.setPercentage(25,"æ¶ˆé™¤æ–‡å­—å®Œæˆ"),a.info("æ­¥éª¤ 2/4: å¯¼å‡ºæ–‡æœ¬æ•°æ®..."),s.setPercentage(30,"å¯¼å‡ºæ–‡æœ¬æ•°æ®..."),a.info("æ­¥éª¤ 3/4: å‘é€åˆ° AI è¿›è¡Œç¿»è¯‘..."),s.setPercentage(40,"å‡†å¤‡æ‰¹é‡ç¿»è¯‘...");const V={images:b,config:p,progress:s,sessionId:St()},G=await Al(V);if(!G.success||!G.translationData)throw new Error(G.error||"AI ç¿»è¯‘å¤±è´¥");a.info("æ­¥éª¤ 4/4: å¯¼å…¥ç¿»è¯‘ç»“æœå¹¶æ¸²æŸ“..."),s.setPercentage(90,"å¯¼å…¥ç¿»è¯‘ç»“æœ..."),await Xo(G.translationData,_||void 0),s.setPercentage(95,"æ¸²æŸ“å›¾ç‰‡...");const j=await Go(G.translationData,_||void 0,(I,f)=>{const d=95+Math.floor(I/f*5);s.setPercentage(d,`æ¸²æŸ“å›¾ç‰‡ ${I}/${f}`)});s.setPercentage(100,"ç¿»è¯‘å®Œæˆï¼"),a.success("é«˜è´¨é‡ç¿»è¯‘å®Œæˆï¼");const k=n.currentImageIndex,y=n.images[k];return y?.bubbleStates&&t.setBubbles(y.bubbleStates),{success:!0,completed:j.success,failed:j.failed+O,errors:T.length>0?T:void 0}}catch(O){const Q=O instanceof Error?O.message:"é«˜è´¨é‡ç¿»è¯‘å¤±è´¥";return a.error(Q),T.push(Q),{success:!1,completed:0,failed:b.length,errors:T}}}async function R(p){const b=n.images;if(b.length===0)return a.warning("è¯·å…ˆæ·»åŠ å›¾ç‰‡"),{success:!1,completed:0,failed:0,errors:["æ²¡æœ‰å›¾ç‰‡"]};if(!b.some(Q=>Q.bubbleStates&&Q.bubbleStates.length>0))return a.warning("è¯·å…ˆç¿»è¯‘å›¾ç‰‡"),{success:!1,completed:0,failed:0,errors:["æ²¡æœ‰ç¿»è¯‘ç»“æœ"]};N(),s.init(b.length,"AI æ ¡å¯¹: å‡†å¤‡ä¸­..."),W();const O=[];try{a.info("æ­¥éª¤ 1/2: å‘é€åˆ° AI è¿›è¡Œæ ¡å¯¹..."),s.setPercentage(10,"å‡†å¤‡æ ¡å¯¹æ•°æ®...");const Q={images:b,config:p,progress:s,sessionId:St()},V=await Ol(Q);if(!V.success||!V.translationData)throw new Error(V.error||"AI æ ¡å¯¹å¤±è´¥");a.info("æ­¥éª¤ 2/2: å¯¼å…¥æ ¡å¯¹ç»“æœå¹¶æ¸²æŸ“..."),s.setPercentage(90,"å¯¼å…¥æ ¡å¯¹ç»“æœ..."),await Xo(V.translationData,_||void 0),s.setPercentage(95,"æ¸²æŸ“å›¾ç‰‡...");const G=await Go(V.translationData,_||void 0,(y,I)=>{const f=95+Math.floor(y/I*5);s.setPercentage(f,`æ¸²æŸ“å›¾ç‰‡ ${y}/${I}`)});s.setPercentage(100,"æ ¡å¯¹å®Œæˆï¼"),a.success("AI æ ¡å¯¹å®Œæˆï¼");const j=n.currentImageIndex,k=n.images[j];return k?.bubbleStates&&t.setBubbles(k.bubbleStates),{success:!0,completed:G.success,failed:G.failed,errors:O.length>0?O:void 0}}catch(Q){const V=Q instanceof Error?Q.message:"AI æ ¡å¯¹å¤±è´¥";return a.error(V),O.push(V),{success:!1,completed:0,failed:b.length,errors:O}}}async function g(p){if(!z(p))return{success:!1,completed:0,failed:0,errors:["é…ç½®éªŒè¯å¤±è´¥"]};if(n.images.length===0)return a.error("è¯·å…ˆä¸Šä¼ å›¾ç‰‡"),{success:!1,completed:0,failed:0,errors:["æ²¡æœ‰å›¾ç‰‡"]};i.value=!0,(p.scope==="all"||p.scope==="failed")&&n.setBatchTranslationInProgress(!0);try{let b;switch(p.mode){case"hq":b=await U(p);break;case"proofread":b=await R(p);break;case"standard":case"removeText":default:b=await A(p);break}return b.success?p.mode==="removeText"?a.success(p.scope==="all"?"æ‰€æœ‰å›¾ç‰‡æ–‡å­—æ¶ˆé™¤å®Œæˆ":"æ–‡å­—æ¶ˆé™¤å®Œæˆ"):p.mode!=="hq"&&p.mode!=="proofread"&&a.success(p.scope==="all"?"æ‰€æœ‰å›¾ç‰‡ç¿»è¯‘å®Œæˆ":"ç¿»è¯‘æˆåŠŸï¼"):b.failed>0&&b.completed>0&&a.warning(`å®Œæˆ ${b.completed} å¼ ï¼Œå¤±è´¥ ${b.failed} å¼ `),b}finally{i.value=!1,n.setBatchTranslationInProgress(!1);const b=n.currentImageIndex;if(b>=0&&b<n.images.length){const T=n.images[b];T?.bubbleStates&&T.bubbleStates.length>0&&t.setBubbles(T.bubbleStates),n.setCurrentImageIndex(b)}setTimeout(()=>{s.finish()},1e3)}}function c(){n.isBatchTranslationInProgress&&(n.setBatchTranslationInProgress(!1),a.info("æ“ä½œå·²å–æ¶ˆ"))}return{progress:r,isExecuting:i,isTranslating:v,progressPercent:$,execute:g,cancel:c}}const Vl={mode:"standard",scope:"current",steps:[{type:"prepare",enabled:!0,options:{skipTranslation:!1}}]};function Pt(n="current"){return{...Vl,scope:n}}const Zo={mode:"hq",scope:"all",steps:[{type:"prepare",enabled:!0,options:{skipTranslation:!0}},{type:"translate",enabled:!0,options:{method:"multimodal"}},{type:"render",enabled:!0,options:{useIndividualStyles:!0}}],batchOptions:{batchSize:3,maxRetries:2,rpmLimit:10,sessionResetFrequency:5}};function Kl(n){return{...Zo,batchOptions:{...Zo.batchOptions,...n}}}const Qo={mode:"proofread",scope:"all",steps:[{type:"translate",enabled:!0,options:{method:"proofread"}},{type:"render",enabled:!0,options:{useIndividualStyles:!0}}],batchOptions:{batchSize:3,maxRetries:2,rpmLimit:10,sessionResetFrequency:5}};function Wl(n){return{...Qo,batchOptions:{...Qo.batchOptions,...n}}}const ql={mode:"removeText",scope:"current",steps:[{type:"prepare",enabled:!0,options:{skipTranslation:!0,skipRender:!0}}]};function en(n="current"){return{...ql,scope:n}}function mo(){const n=je(),t=it(),l=ct(),o=Nl(),a=o.progress,r=o.isExecuting,s=o.isTranslating,i=o.progressPercent,h=Y(()=>o.isExecuting.value),_=Y(()=>o.isExecuting.value);async function v(){return(await o.execute(Pt("current"))).success}async function $(c){const p=n.currentImageIndex;n.setCurrentImageIndex(c);const b=await o.execute(Pt("current"));return n.setCurrentImageIndex(p),b.success}async function W(){return(await o.execute(Pt("all"))).success}function z(){o.cancel()}async function N(){return(await o.execute(en("current"))).success}async function w(){return(await o.execute(en("all"))).success}async function A(){return n.getFailedImageIndices().length===0?(l.info("æ²¡æœ‰å¤±è´¥çš„å›¾ç‰‡éœ€è¦é‡æ–°ç¿»è¯‘"),!0):(await o.execute(Pt("failed"))).success}async function U(){return(await o.execute(Kl())).success}async function R(){return(await o.execute(Wl())).success}async function g(){if(!n.currentImage)return l.error("è¯·å…ˆä¸Šä¼ å›¾ç‰‡"),!1;const p=t.bubbles;return!p||p.length===0?(l.error("å½“å‰å›¾ç‰‡æ²¡æœ‰æ°”æ³¡æ¡†ï¼Œè¯·å…ˆæ£€æµ‹æˆ–æ‰‹åŠ¨æ·»åŠ "),!1):(n.setManuallyAnnotated(!0),v())}return{progress:a,isTranslatingSingle:r,isHqTranslating:h,isProofreading:_,isTranslating:s,progressPercent:i,translateCurrentImage:v,translateImageByIndex:$,translateAllImages:W,cancelBatchTranslation:z,removeTextOnly:N,removeAllTexts:w,retryFailedImages:A,executeHqTranslation:U,executeProofreading:R,translateWithCurrentBubbles:g}}function Hl(){const n=it(),t=je(),l=S(!1);function o(){if(!l.value)return;const a=t.currentImage;n.bubbleCount>0?t.updateCurrentBubbleStates([...n.bubbles]):a&&Array.isArray(a.bubbleStates)&&a.bubbleStates.length>0&&(t.updateCurrentBubbleStates([]),console.log("é€€å‡ºç¼–è¾‘æ¨¡å¼ï¼ˆæ— é‡æ¸²æŸ“ï¼‰ï¼Œç”¨æˆ·å·²åˆ é™¤æ‰€æœ‰æ°”æ³¡")),l.value=!1,n.clearSelection(),console.log("å·²é€€å‡ºç¼–è¾‘æ¨¡å¼ï¼ˆæ— é‡æ¸²æŸ“ï¼‰")}return{isActive:l,exitEditModeWithoutRender:o}}function Jl(){const n=an(),t=Ve(),l=je(),o=gn(),a=it(),r=Hl(),s=S(!1),i=S(!1),h=S(null),_=S([]),v=S([]),$=S([]),W=S(null),z=S(null),N=S(null),w=S(null),A=S(!1);async function U(j=!1){if(!j&&(s.value||i.value)){console.log("[TranslateInit] å·²ç»åˆå§‹åŒ–ï¼Œä»…é‡æ–°åŠ è½½ä¸Šä¸‹æ–‡"),await b();return}console.log("[TranslateInit] å¼€å§‹åˆå§‹åŒ–åº”ç”¨..."),s.value=!0,h.value=null;try{await R(),await g(),await c(),await p(),await b(),console.log("[TranslateInit] åº”ç”¨åˆå§‹åŒ–å®Œæˆ"),i.value=!0}catch(k){console.error("[TranslateInit] åº”ç”¨åˆå§‹åŒ–å¤±è´¥:",k),h.value=k instanceof Error?k.message:"åˆå§‹åŒ–å¤±è´¥"}finally{s.value=!1}}async function R(){console.log("[TranslateInit] åˆå§‹åŒ–è®¾ç½®..."),t.initSettings();try{const j=await t.loadFromBackend();console.log(j?"[TranslateInit] å·²ä»åç«¯åŠ è½½è®¾ç½®":"[TranslateInit] åç«¯æ— è®¾ç½®ï¼Œä½¿ç”¨ localStorage æ•°æ®")}catch(j){console.warn("[TranslateInit] ä»åç«¯åŠ è½½è®¾ç½®å¤±è´¥ï¼Œä½¿ç”¨ localStorage æ•°æ®:",j)}console.log("[TranslateInit] è®¾ç½®åˆå§‹åŒ–å®Œæˆ")}async function g(){console.log("[TranslateInit] åˆå§‹åŒ–å­—ä½“åˆ—è¡¨...");try{const j=await rn();j.fonts&&j.fonts.length>0?(_.value=j.fonts,console.log(`[TranslateInit] å·²åŠ è½½ ${j.fonts.length} ä¸ªå­—ä½“`)):j.error?console.warn("[TranslateInit] è·å–å­—ä½“åˆ—è¡¨å¤±è´¥:",j.error):console.warn("[TranslateInit] å­—ä½“åˆ—è¡¨ä¸ºç©º")}catch(j){console.error("[TranslateInit] è·å–å­—ä½“åˆ—è¡¨å¤±è´¥:",j)}}async function c(){console.log("[TranslateInit] åˆå§‹åŒ–ç¿»è¯‘æç¤ºè¯è®¾ç½®...");try{const j=await gs();j.prompt_names!==void 0?(v.value=j.prompt_names||[],!t.settings.translatePrompt&&j.default_prompt_content&&t.setTranslatePrompt(j.default_prompt_content),console.log(`[TranslateInit] å·²åŠ è½½ ${v.value.length} ä¸ªç¿»è¯‘æç¤ºè¯`)):j.error&&console.warn("[TranslateInit] è·å–ç¿»è¯‘æç¤ºè¯å¤±è´¥:",j.error)}catch(j){console.error("[TranslateInit] è·å–ç¿»è¯‘æç¤ºè¯å¤±è´¥:",j)}}async function p(){console.log("[TranslateInit] åˆå§‹åŒ–æ–‡æœ¬æ¡†æç¤ºè¯è®¾ç½®...");try{const j=await ds();j.prompt_names!==void 0?($.value=j.prompt_names||[],!t.settings.textboxPrompt&&j.default_prompt_content&&t.setTextboxPrompt(j.default_prompt_content),console.log(`[TranslateInit] å·²åŠ è½½ ${$.value.length} ä¸ªæ–‡æœ¬æ¡†æç¤ºè¯`)):j.error&&console.warn("[TranslateInit] è·å–æ–‡æœ¬æ¡†æç¤ºè¯å¤±è´¥:",j.error)}catch(j){console.error("[TranslateInit] è·å–æ–‡æœ¬æ¡†æç¤ºè¯å¤±è´¥:",j)}}async function b(){const j=n.query.book,k=n.query.chapter;if(!j||!k){console.log("[TranslateInit] æœªæŒ‡å®šä¹¦ç±/ç« èŠ‚å‚æ•°ï¼Œä½¿ç”¨ç‹¬ç«‹æ¨¡å¼"),A.value=!1,W.value=null,z.value=null,N.value=null,w.value=null,o.clearContext();return}console.log(`[TranslateInit] æ£€æµ‹åˆ°ä¹¦ç±/ç« èŠ‚å‚æ•°: book=${j}, chapter=${k}`),A.value=!0,W.value=j,z.value=k;try{const y=await ms(j);if(!y.success||!y.book){console.warn("[TranslateInit] ä¹¦ç±ä¸å­˜åœ¨:",j),fe("ä¹¦ç±ä¸å­˜åœ¨","warning");return}const I=y.book,f=I.chapters?.find(d=>d.id===k);if(!f){console.warn("[TranslateInit] ç« èŠ‚ä¸å­˜åœ¨:",k),fe("ç« èŠ‚ä¸å­˜åœ¨","warning");return}if(N.value=I.title,w.value=f.title,o.setBookChapterContext(j,k,I.title,f.title),typeof document<"u"&&(document.title=`${f.title} - ${I.title} - Saber-Translator`),f.session_path){console.log(`[TranslateInit] å°è¯•åŠ è½½ç« èŠ‚ä¼šè¯: ${f.session_path}`);try{await o.loadSessionByPath(f.session_path),fe(`å·²åŠ è½½ç« èŠ‚: ${f.title}`,"success")}catch{console.log("[TranslateInit] ç« èŠ‚ä¼šè¯æ•°æ®ä¸å­˜åœ¨æˆ–åŠ è½½å¤±è´¥ï¼Œå°†åˆ›å»ºæ–°ä¼šè¯")}}}catch(y){console.error("[TranslateInit] åŠ è½½ä¹¦ç±/ç« èŠ‚ä¿¡æ¯å¤±è´¥:",y),fe("åŠ è½½ä¹¦ç±ä¿¡æ¯å¤±è´¥","error")}}function T(j){if(j<0||j>=l.imageCount){console.warn(`[TranslateInit] æ— æ•ˆçš„å›¾ç‰‡ç´¢å¼•: ${j}`);return}window._isChangingFromSwitchImage=!0,r.isActive.value&&r.exitEditModeWithoutRender(),l.currentImage&&a.bubbles.length>0&&l.updateCurrentImageProperty("bubbleStates",a.bubbles),l.setCurrentImageIndex(j);const y=l.currentImage;if(!y){console.warn("[TranslateInit] åˆ‡æ¢åˆ°çš„å›¾ç‰‡ä¸å­˜åœ¨"),window._isChangingFromSwitchImage=!1;return}console.log(`[TranslateInit] åˆ‡æ¢åˆ°å›¾ç‰‡: ${j}, ${y.fileName}`),y.bubbleStates&&y.bubbleStates.length>0?a.setBubbles(y.bubbleStates,!0):a.clearBubblesLocal(),O(y),setTimeout(()=>{window._isChangingFromSwitchImage=!1,console.log("[TranslateInit] å·²é‡ç½®åˆ‡æ¢å›¾ç‰‡æ“ä½œæ ‡è®°")},100)}function O(j){if(!j)return;const k=j.bubbleStates?.[0];k&&t.updateTextStyle({fontSize:k.fontSize||t.settings.textStyle.fontSize,fontFamily:k.fontFamily||t.settings.textStyle.fontFamily,layoutDirection:j.userLayoutDirection||k.textDirection||t.settings.textStyle.layoutDirection,textColor:k.textColor||t.settings.textStyle.textColor,fillColor:k.fillColor||t.settings.textStyle.fillColor,strokeEnabled:k.strokeEnabled??t.settings.textStyle.strokeEnabled,strokeColor:k.strokeColor||t.settings.textStyle.strokeColor,strokeWidth:k.strokeWidth||t.settings.textStyle.strokeWidth,inpaintMethod:k.inpaintMethod||t.settings.textStyle.inpaintMethod,autoFontSize:j.autoFontSize??t.settings.textStyle.autoFontSize})}function Q(){l.canGoPrevious&&T(l.currentImageIndex-1)}function V(){l.canGoNext&&T(l.currentImageIndex+1)}function G(){ut(async()=>{await U()})}return{isInitializing:s,isInitialized:i,initError:h,fontList:_,promptNames:v,textboxPromptNames:$,currentBookId:W,currentChapterId:z,currentBookTitle:N,currentChapterTitle:w,isBookshelfMode:A,initializeApp:U,initializeSettings:R,initializeFontList:g,initializePromptSettings:c,initializeTextboxPromptSettings:p,initializeBookChapterContext:b,switchImage:T,goToPrevious:Q,goToNext:V,loadImageSettingsToStore:O,editMode:r,setupAutoInit:G}}const jl={key:0,id:"translationProgressBar",class:"translation-progress-bar"},Yl={class:"progress-bar-label"},Xl={key:0,class:"failed-count"},Gl={class:"progress-bar"},Zl=Je({__name:"TranslationProgress",props:{progress:{}},setup(n){const t=n,l=je(),o=mo(),a=Y(()=>t.progress||o.progress.value),r=Y(()=>a.value.isInProgress||l.isBatchTranslationInProgress),s=Y(()=>a.value.current),i=Y(()=>a.value.total),h=Y(()=>a.value.failed),_=Y(()=>a.value.percentage!==void 0?a.value.percentage:i.value===0?0:Math.round(s.value/i.value*100)),v=Y(()=>a.value.label?a.value.label:`ç¿»è¯‘ä¸­ï¼š${s.value} / ${i.value}`);return($,W)=>r.value?(D(),L("div",jl,[e("div",Yl,[Se(le(v.value)+" ",1),h.value>0?(D(),L("span",Xl,"ï¼ˆ"+le(h.value)+" å¼ å¤±è´¥ï¼‰",1)):ge("",!0)]),e("div",Gl,[e("div",{class:"progress",style:nt({width:`${_.value}%`})},null,4)])])):ge("",!0)}}),Ql=He(Zl,[["__scopeId","data-v-7eaa1903"]]),ei=Je({__name:"SponsorModal",emits:["close"],setup(n,{emit:t}){const l=t;return(o,a)=>(D(),st(un,{title:"æ”¯æŒä½œè€…",onClose:a[1]||(a[1]=r=>l("close"))},{footer:ht(()=>[e("button",{type:"button",class:"btn btn-primary",onClick:a[0]||(a[0]=r=>l("close"))},"å…³é—­")]),default:ht(()=>[a[2]||(a[2]=e("div",{class:"sponsor-content"},[e("p",{class:"sponsor-message"}," å¦‚æœè¿™ä¸ªé¡¹ç›®å¯¹ä½ æœ‰å¸®åŠ©ï¼Œæ¬¢è¿è¯·ä½œè€…å–æ¯å’–å•¡ â˜• "),e("div",{class:"qr-codes"},[e("div",{class:"qr-item"},[e("div",{class:"qr-image"},[e("img",{src:"/pic/wechat_qrcode.png",alt:"å¾®ä¿¡æ”¯ä»˜"})]),e("span",{class:"qr-label"},"å¾®ä¿¡æ”¯ä»˜")]),e("div",{class:"qr-item"},[e("div",{class:"qr-image"},[e("img",{src:"/pic/alipay_qrcode.png",alt:"æ”¯ä»˜å®"})]),e("span",{class:"qr-label"},"æ”¯ä»˜å®")])]),e("p",{class:"sponsor-thanks"},"æ„Ÿè°¢æ‚¨çš„æ”¯æŒï¼ğŸ™")],-1))]),_:1}))}}),ti=He(ei,[["__scopeId","data-v-02b6948e"]]),oi={id:"thumbnail-sidebar",class:"thumbnail-sidebar"},ni={class:"card thumbnail-card"},si=["title","data-index","onClick"],ai=["src","alt"],li={key:1,class:"translation-failed-indicator"},ii={key:2,class:"labeled-indicator"},ri={key:3,class:"thumbnail-processing-indicator"},ui={key:1,class:"empty-state"},ci=Je({__name:"ThumbnailSidebar",emits:["select"],setup(n,{emit:t}){const l=t,o=je(),a=S(null),r=S([]),s=Y(()=>o.images),i=Y(()=>o.currentImageIndex),h=Y(()=>o.hasImages);function _(w){l("select",w)}function v(){dt(()=>{const w=r.value[i.value];if(w&&a.value){const A=a.value,U=w.offsetTop-A.clientHeight/2+w.clientHeight/2;A.scrollTo({top:Math.max(0,U),behavior:"smooth"})}})}function $(w,A){r.value[A]=w}function W(w){return w.translationFailed?"failed":w.isManuallyAnnotated?"labeled":w.translationStatus==="processing"?"processing":null}function z(w){const A=[];return w.translationFailed&&A.push("translation-failed"),w.isManuallyAnnotated&&A.push("has-manual-labels"),A}function N(w){return w.translationFailed?"ç¿»è¯‘å¤±è´¥ï¼Œç‚¹å‡»å¯é‡è¯•":w.isManuallyAnnotated?"åŒ…å«æ‰‹åŠ¨æ ‡æ³¨":w.fileName||""}return ye(i,()=>{v()}),ut(()=>{h.value&&v()}),(w,A)=>(D(),L("aside",oi,[e("div",ni,[A[1]||(A[1]=e("h2",null,"å›¾ç‰‡æ¦‚è§ˆ",-1)),h.value?(D(),L("ul",{key:0,ref_key:"containerRef",ref:a,id:"thumbnailList",class:"thumbnail-list"},[(D(!0),L(qe,null,Ye(s.value,(U,R)=>(D(),L("li",{key:U.id,ref_for:!0,ref:g=>$(g,R),class:Me(["thumbnail-item",[{active:R===i.value},...z(U)]]),title:N(U),"data-index":R,onClick:g=>_(R)},[U.originalDataURL?(D(),L("img",{key:0,src:U.originalDataURL,alt:U.fileName,class:"thumbnail-image"},null,8,ai)):ge("",!0),W(U)==="failed"?(D(),L("span",li,"!")):W(U)==="labeled"?(D(),L("span",ii,"âœï¸")):ge("",!0),W(U)==="processing"?(D(),L("div",ri,"âŸ³")):ge("",!0)],10,si))),128))],512)):(D(),L("div",ui,[...A[0]||(A[0]=[e("p",null,"æš‚æ— å›¾ç‰‡",-1)])]))])]))}}),di=He(ci,[["__scopeId","data-v-899e5674"]]),gi={class:"saved-prompts-picker"},pi={class:"prompts-chips-container"},mi={key:0,class:"empty-hint"},vi={key:1,class:"empty-hint"},bi=["title","onClick"],fi=Je({__name:"SavedPromptsPicker",props:{promptType:{}},emits:["select"],setup(n,{expose:t,emit:l}){const o=n,a=l,r=S([]),s=S(!1);async function i(){s.value=!0;try{let _;o.promptType==="textbox"?_=await Ne.getTextboxPrompts():_=await Ne.getPrompts(o.promptType);const v=_.prompt_names||[];r.value=v.map($=>({name:$}))}catch(_){console.error("åŠ è½½æç¤ºè¯åˆ—è¡¨å¤±è´¥:",_),r.value=[]}finally{s.value=!1}}async function h(_){try{let v;o.promptType==="textbox"?v=await Ne.getTextboxPromptContent(_):v=await Ne.getPromptContent(o.promptType,_),v.prompt_content&&a("select",v.prompt_content,_)}catch(v){console.error("åŠ è½½æç¤ºè¯å†…å®¹å¤±è´¥:",v)}}return ye(()=>o.promptType,()=>{i()}),ut(()=>{i()}),t({refresh:i}),(_,v)=>(D(),L("div",gi,[v[1]||(v[1]=e("span",{class:"picker-label"},"ğŸ“‘ å¿«é€Ÿé€‰æ‹©:",-1)),e("div",pi,[s.value?(D(),L("span",mi,"åŠ è½½ä¸­...")):r.value.length===0?(D(),L("span",vi,"æš‚æ— ä¿å­˜çš„æç¤ºè¯")):(D(!0),L(qe,{key:2},Ye(r.value,$=>(D(),L("button",{key:$.name,type:"button",class:"prompt-chip",title:$.name,onClick:W=>h($.name)},[v[0]||(v[0]=e("span",{class:"chip-icon"},"ğŸ“",-1)),Se(" "+le($.name),1)],8,bi))),128))])]))}}),Tt=He(fi,[["__scopeId","data-v-2ebbb8b3"]]),hi={class:"ocr-settings"},yi={class:"settings-group"},xi={class:"settings-item"},ki={class:"settings-item"},_i={class:"input-hint"},Si={class:"settings-group"},Ci={class:"settings-row"},wi={class:"settings-item"},$i={class:"password-input-wrapper"},Ii=["type"],Ti={key:0,class:"eye-icon"},Di={key:1,class:"eye-off-icon"},Ri={class:"settings-item"},Mi={class:"password-input-wrapper"},Ei=["type"],Pi={key:0,class:"eye-icon"},Bi={key:1,class:"eye-off-icon"},Ai={class:"settings-row"},Fi={class:"settings-item"},Li={class:"settings-item"},Ui=["disabled"],Oi={class:"settings-group"},zi={class:"settings-row"},Ni={class:"settings-item"},Vi={class:"settings-item"},Ki={class:"password-input-wrapper"},Wi=["type"],qi={key:0,class:"eye-icon"},Hi={key:1,class:"eye-off-icon"},Ji={class:"settings-item"},ji={class:"settings-item"},Yi={class:"model-input-with-fetch"},Xi=["disabled"],Gi={class:"fetch-text"},Zi={key:0,class:"model-select-container"},Qi={class:"model-count"},er={class:"settings-item"},tr={class:"prompt-format-selector"},or={class:"settings-item"},nr=["disabled"],sr=Je({__name:"OcrSettings",setup(n){const t=[{label:"MangaOCR (æ—¥è¯­ä¸“ç”¨)",value:"manga_ocr"},{label:"PaddleOCR (å¤šè¯­è¨€)",value:"paddle_ocr"},{label:"ç™¾åº¦OCR",value:"baidu_ocr"},{label:"48px OCR",value:"48px_ocr"},{label:"AIè§†è§‰OCR",value:"ai_vision"}],l=[{label:"æ ‡å‡†ç‰ˆ",value:"standard"},{label:"é«˜ç²¾åº¦ç‰ˆ",value:"high_precision"}],o=[{label:"è‡ªåŠ¨æ£€æµ‹",value:"auto_detect"},{label:"ä¸­è‹±æ–‡æ··åˆ",value:"CHN_ENG"},{label:"è‹±æ–‡",value:"ENG"},{label:"æ—¥è¯­",value:"JAP"},{label:"éŸ©è¯­",value:"KOR"},{label:"æ³•è¯­",value:"FRE"},{label:"å¾·è¯­",value:"GER"},{label:"ä¿„è¯­",value:"RUS"}],a=[{label:"SiliconFlow (ç¡…åŸºæµåŠ¨)",value:"siliconflow"},{label:"ç«å±±å¼•æ“",value:"volcano"},{label:"Google Gemini",value:"gemini"},{label:"è‡ªå®šä¹‰ OpenAI å…¼å®¹æœåŠ¡",value:"custom_openai_vision"}],r=[{label:"æ™®é€šæç¤ºè¯",value:"false"},{label:"JSONæç¤ºè¯",value:"true"}],s=[{label:"ğŸš€ å¸¸ç”¨è¯­è¨€",options:[{label:"æ—¥è¯­",value:"japanese"},{label:"è‹±è¯­",value:"en"},{label:"ç®€ä½“ä¸­æ–‡",value:"chinese"},{label:"ç¹ä½“ä¸­æ–‡",value:"chinese_cht"},{label:"éŸ©è¯­",value:"korean"}]},{label:"ğŸŒ æ‹‰ä¸è¯­ç³»",options:[{label:"æ³•è¯­",value:"french"},{label:"å¾·è¯­",value:"german"},{label:"è¥¿ç­ç‰™è¯­",value:"spanish"},{label:"æ„å¤§åˆ©è¯­",value:"italian"},{label:"è‘¡è„ç‰™è¯­",value:"portuguese"}]},{label:"ğŸŒ å…¶ä»–è¯­ç³»",options:[{label:"ä¿„è¯­",value:"russian"}]}],i=Ve(),h=ct(),_=S({apiKey:i.settings.baiduOcr.apiKey,secretKey:i.settings.baiduOcr.secretKey,version:i.settings.baiduOcr.version,sourceLanguage:i.settings.baiduOcr.sourceLanguage}),v=S({apiKey:i.settings.aiVisionOcr.apiKey,modelName:i.settings.aiVisionOcr.modelName,customBaseUrl:i.settings.aiVisionOcr.customBaseUrl,prompt:i.settings.aiVisionOcr.prompt,rpmLimit:i.settings.aiVisionOcr.rpmLimit}),$=Y(()=>i.settings);ye(()=>_.value.apiKey,k=>{i.updateBaiduOcr({apiKey:k})}),ye(()=>_.value.secretKey,k=>{i.updateBaiduOcr({secretKey:k})}),ye(()=>_.value.version,k=>{i.updateBaiduOcr({version:k})}),ye(()=>_.value.sourceLanguage,k=>{i.updateBaiduOcr({sourceLanguage:k})}),ye(()=>v.value.apiKey,k=>{i.updateAiVisionOcr({apiKey:k})}),ye(()=>v.value.modelName,k=>{i.updateAiVisionOcr({modelName:k})}),ye(()=>v.value.customBaseUrl,k=>{i.updateAiVisionOcr({customBaseUrl:k})}),ye(()=>v.value.prompt,k=>{i.updateAiVisionOcr({prompt:k})}),ye(()=>v.value.rpmLimit,k=>{i.updateAiVisionOcr({rpmLimit:k})});const W=S(!1),z=S(!1),N=S(!1),w=S(!1),A=S(!1),U=S([]),R=Y(()=>{const k=[{label:"-- é€‰æ‹©æ¨¡å‹ --",value:""}];return U.value.forEach(y=>{k.push({label:y,value:y})}),k});function g(){i.saveToStorage()}function c(){i.saveToStorage()}function p(){switch(i.settings.ocrEngine){case"manga_ocr":return"MangaOCR ä¸“ä¸ºæ—¥è¯­æ¼«ç”»ä¼˜åŒ–ï¼Œæºè¯­è¨€è®¾ç½®ä¸å½±å“è¯†åˆ«";case"paddle_ocr":return"PaddleOCR ä¼šæ ¹æ®æºè¯­è¨€åŠ è½½å¯¹åº”çš„è¯†åˆ«æ¨¡å‹";case"baidu_ocr":return"ç™¾åº¦OCR ä½¿ç”¨ç‹¬ç«‹çš„æºè¯­è¨€è®¾ç½®ï¼ˆè§ä¸‹æ–¹ï¼‰";case"ai_vision":return"AIè§†è§‰OCR é€šè¿‡æç¤ºè¯æŒ‡å®šè¯†åˆ«è¯­è¨€";case"48px_ocr":return"48px OCR æ”¯æŒæ—¥ä¸­è‹±éŸ©ç­‰å¤šè¯­è¨€ï¼Œæºè¯­è¨€è®¾ç½®ä¸å½±å“è¯†åˆ«";default:return"é€‰æ‹©è¦è¯†åˆ«çš„åŸæ–‡è¯­è¨€"}}function b(k){i.setAiVisionOcrProvider(k),U.value=[],T()}function T(){v.value.apiKey=i.settings.aiVisionOcr.apiKey,v.value.modelName=i.settings.aiVisionOcr.modelName,v.value.customBaseUrl=i.settings.aiVisionOcr.customBaseUrl,v.value.prompt=i.settings.aiVisionOcr.prompt,v.value.rpmLimit=i.settings.aiVisionOcr.rpmLimit}function O(){const k=i.settings.aiVisionOcr.isJsonMode?Wn:qn;i.updateAiVisionOcr({prompt:k}),v.value.prompt=k}async function Q(){const k=_.value.apiKey?.trim(),y=_.value.secretKey?.trim();if(!k||!y){h.warning("è¯·å¡«å†™ç™¾åº¦OCRçš„API Keyå’ŒSecret Key");return}w.value=!0,h.info("æ­£åœ¨æµ‹è¯•ç™¾åº¦OCRè¿æ¥...");try{const I=await Ne.testBaiduOcrConnection(k,y);I.success?h.success(I.message||"ç™¾åº¦OCRè¿æ¥æˆåŠŸ!"):h.error(I.message||I.error||"ç™¾åº¦OCRè¿æ¥å¤±è´¥")}catch(I){const f=I instanceof Error?I.message:"è¿æ¥æµ‹è¯•å¤±è´¥";h.error(f)}finally{w.value=!1}}async function V(){w.value=!0;try{const k=await Ne.testAiVisionOcrConnection({provider:i.settings.aiVisionOcr.provider,apiKey:v.value.apiKey,modelName:v.value.modelName,customBaseUrl:v.value.customBaseUrl,prompt:v.value.prompt});k.success?h.success("AIè§†è§‰OCRè¿æ¥æˆåŠŸ"):h.error(`AIè§†è§‰OCRè¿æ¥å¤±è´¥: ${k.error||"æœªçŸ¥é”™è¯¯"}`)}catch(k){const y=k instanceof Error?k.message:"è¿æ¥æµ‹è¯•å¤±è´¥";h.error(y)}finally{w.value=!1}}async function G(){const k=i.settings.aiVisionOcr.provider,y=v.value.apiKey?.trim(),I=v.value.customBaseUrl?.trim();if(!y){h.warning("è¯·å…ˆå¡«å†™ API Key");return}if(!["siliconflow","volcano","gemini","custom_openai_vision"].includes(k)){h.warning("å½“å‰æœåŠ¡å•†ä¸æ”¯æŒè‡ªåŠ¨è·å–æ¨¡å‹åˆ—è¡¨");return}if(k==="custom_openai_vision"&&!I){h.warning("è‡ªå®šä¹‰æœåŠ¡éœ€è¦å…ˆå¡«å†™ Base URL");return}A.value=!0;try{const d=await Ne.fetchModels(k,y,I);d.success&&d.models&&d.models.length>0?(U.value=d.models.map(m=>m.id),h.success(`è·å–åˆ° ${d.models.length} ä¸ªæ¨¡å‹`)):h.warning(d.message||"æœªè·å–åˆ°å¯ç”¨æ¨¡å‹")}catch(d){const m=d instanceof Error?d.message:"è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥";h.error(m)}finally{A.value=!1}}function j(k,y){i.updateAiVisionOcr({prompt:k}),v.value.prompt=k,h.success(`å·²åº”ç”¨æç¤ºè¯: ${y}`)}return(k,y)=>(D(),L("div",hi,[e("div",yi,[y[19]||(y[19]=e("div",{class:"settings-group-title"},"OCRå¼•æ“é€‰æ‹©",-1)),e("div",xi,[y[17]||(y[17]=e("label",{for:"settingsOcrEngine"},"OCRå¼•æ“:",-1)),he(Oe,{"model-value":$.value.ocrEngine,options:t,onChange:y[0]||(y[0]=I=>{$.value.ocrEngine=I,g()})},null,8,["model-value"])]),se(e("div",ki,[y[18]||(y[18]=e("label",{for:"settingsSourceLanguage"},"æºè¯­è¨€:",-1)),he(Oe,{"model-value":$.value.sourceLanguage,groups:s,onChange:y[1]||(y[1]=I=>{$.value.sourceLanguage=I,c()})},null,8,["model-value"]),e("div",_i,le(p()),1)],512),[[Ae,$.value.ocrEngine==="paddle_ocr"]])]),se(e("div",Si,[y[24]||(y[24]=e("div",{class:"settings-group-title"},"ç™¾åº¦OCR è®¾ç½®",-1)),e("div",Ci,[e("div",wi,[y[20]||(y[20]=e("label",{for:"settingsBaiduApiKey"},"API Key:",-1)),e("div",$i,[se(e("input",{type:W.value?"text":"password",id:"settingsBaiduApiKey","onUpdate:modelValue":y[2]||(y[2]=I=>_.value.apiKey=I),class:"secure-input",placeholder:"è¯·è¾“å…¥ç™¾åº¦OCR API Key",autocomplete:"off"},null,8,Ii),[[kt,_.value.apiKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:y[3]||(y[3]=I=>W.value=!W.value)},[W.value?(D(),L("span",Di,"ğŸ‘â€ğŸ—¨")):(D(),L("span",Ti,"ğŸ‘"))])])]),e("div",Ri,[y[21]||(y[21]=e("label",{for:"settingsBaiduSecretKey"},"Secret Key:",-1)),e("div",Mi,[se(e("input",{type:z.value?"text":"password",id:"settingsBaiduSecretKey","onUpdate:modelValue":y[4]||(y[4]=I=>_.value.secretKey=I),class:"secure-input",placeholder:"è¯·è¾“å…¥Secret Key",autocomplete:"off"},null,8,Ei),[[kt,_.value.secretKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:y[5]||(y[5]=I=>z.value=!z.value)},[z.value?(D(),L("span",Bi,"ğŸ‘â€ğŸ—¨")):(D(),L("span",Pi,"ğŸ‘"))])])])]),e("div",Ai,[e("div",Fi,[y[22]||(y[22]=e("label",{for:"settingsBaiduVersion"},"è¯†åˆ«ç‰ˆæœ¬:",-1)),he(Oe,{modelValue:_.value.version,"onUpdate:modelValue":y[6]||(y[6]=I=>_.value.version=I),options:l},null,8,["modelValue"])]),e("div",Li,[y[23]||(y[23]=e("label",{for:"settingsBaiduSourceLanguage"},"æºè¯­è¨€:",-1)),he(Oe,{modelValue:_.value.sourceLanguage,"onUpdate:modelValue":y[7]||(y[7]=I=>_.value.sourceLanguage=I),options:o},null,8,["modelValue"])])]),e("button",{class:"settings-test-btn",onClick:Q,disabled:w.value},le(w.value?"æµ‹è¯•ä¸­...":"ğŸ”— æµ‹è¯•è¿æ¥"),9,Ui)],512),[[Ae,$.value.ocrEngine==="baidu_ocr"]]),se(e("div",Oi,[y[34]||(y[34]=e("div",{class:"settings-group-title"},"AIè§†è§‰OCR è®¾ç½®",-1)),e("div",zi,[e("div",Ni,[y[25]||(y[25]=e("label",{for:"settingsAiVisionProvider"},"æœåŠ¡å•†:",-1)),he(Oe,{"model-value":$.value.aiVisionOcr.provider,options:a,onChange:y[8]||(y[8]=I=>b(I))},null,8,["model-value"])]),e("div",Vi,[y[26]||(y[26]=e("label",{for:"settingsAiVisionApiKey"},"API Key:",-1)),e("div",Ki,[se(e("input",{type:N.value?"text":"password",id:"settingsAiVisionApiKey","onUpdate:modelValue":y[9]||(y[9]=I=>v.value.apiKey=I),class:"secure-input",placeholder:"è¯·è¾“å…¥API Key",autocomplete:"off"},null,8,Wi),[[kt,v.value.apiKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:y[10]||(y[10]=I=>N.value=!N.value)},[N.value?(D(),L("span",Hi,"ğŸ‘â€ğŸ—¨")):(D(),L("span",qi,"ğŸ‘"))])])])]),se(e("div",Ji,[y[27]||(y[27]=e("label",{for:"settingsCustomAiVisionBaseUrl"},"Base URL:",-1)),se(e("input",{type:"text",id:"settingsCustomAiVisionBaseUrl","onUpdate:modelValue":y[11]||(y[11]=I=>v.value.customBaseUrl=I),placeholder:"ä¾‹å¦‚: https://api.example.com/v1"},null,512),[[Ce,v.value.customBaseUrl]])],512),[[Ae,$.value.aiVisionOcr.provider==="custom_openai_vision"]]),e("div",ji,[y[29]||(y[29]=e("label",{for:"settingsAiVisionModelName"},"æ¨¡å‹åç§°:",-1)),e("div",Yi,[se(e("input",{type:"text",id:"settingsAiVisionModelName","onUpdate:modelValue":y[12]||(y[12]=I=>v.value.modelName=I),placeholder:"å¦‚: silicon-llava2-34b"},null,512),[[Ce,v.value.modelName]]),e("button",{type:"button",class:"fetch-models-btn",title:"è·å–å¯ç”¨æ¨¡å‹åˆ—è¡¨",onClick:G,disabled:A.value},[y[28]||(y[28]=e("span",{class:"fetch-icon"},"ğŸ”",-1)),e("span",Gi,le(A.value?"è·å–ä¸­...":"è·å–æ¨¡å‹"),1)],8,Xi)]),U.value.length>0?(D(),L("div",Zi,[he(Oe,{modelValue:v.value.modelName,"onUpdate:modelValue":y[13]||(y[13]=I=>v.value.modelName=I),options:R.value},null,8,["modelValue","options"]),e("span",Qi,"å…± "+le(U.value.length)+" ä¸ªæ¨¡å‹",1)])):ge("",!0)]),e("div",er,[y[31]||(y[31]=e("label",{for:"settingsAiVisionOcrPrompt"},"OCRæç¤ºè¯:",-1)),se(e("textarea",{id:"settingsAiVisionOcrPrompt","onUpdate:modelValue":y[14]||(y[14]=I=>v.value.prompt=I),rows:"3",placeholder:"AIè§†è§‰OCRæç¤ºè¯"},null,512),[[Ce,v.value.prompt]]),he(Tt,{"prompt-type":"ai_vision_ocr",onSelect:j}),e("div",tr,[he(Oe,{"model-value":$.value.aiVisionOcr.isJsonMode?"true":"false",options:r,onChange:y[15]||(y[15]=I=>{$.value.aiVisionOcr.isJsonMode=I==="true",O()})},null,8,["model-value"]),y[30]||(y[30]=e("span",{class:"input-hint"},"JSONæ ¼å¼è¾“å‡ºæ›´ç»“æ„åŒ–",-1))])]),e("div",or,[y[32]||(y[32]=e("label",{for:"settingsRpmAiVisionOcr"},"RPMé™åˆ¶ (æ¯åˆ†é’Ÿè¯·æ±‚æ•°):",-1)),se(e("input",{type:"number",id:"settingsRpmAiVisionOcr","onUpdate:modelValue":y[16]||(y[16]=I=>v.value.rpmLimit=I),min:"0",step:"1"},null,512),[[Ce,v.value.rpmLimit,void 0,{number:!0}]]),y[33]||(y[33]=e("div",{class:"input-hint"},"0 è¡¨ç¤ºæ— é™åˆ¶",-1))]),e("button",{class:"settings-test-btn",onClick:V,disabled:w.value},le(w.value?"æµ‹è¯•ä¸­...":"ğŸ”— æµ‹è¯•è¿æ¥"),9,nr)],512),[[Ae,$.value.ocrEngine==="ai_vision"]])]))}}),ar=He(sr,[["__scopeId","data-v-38c660c4"]]),lr={class:"translation-settings"},ir={class:"settings-group"},rr={class:"settings-row"},ur={class:"settings-item"},cr={class:"settings-item"},dr={for:"settingsApiKey"},gr={class:"password-input-wrapper"},pr=["type","placeholder"],mr={key:0,class:"eye-icon"},vr={key:1,class:"eye-off-icon"},br={class:"settings-item"},fr={class:"settings-item"},hr={for:"settingsModelName"},yr={class:"model-input-with-fetch"},xr=["placeholder"],kr=["disabled"],_r={class:"fetch-text"},Sr={key:0,class:"model-select-container"},Cr={class:"model-count"},wr={class:"settings-item"},$r={class:"local-model-list"},Ir={key:0,class:"model-list-container"},Tr=["disabled"],Dr={key:1,class:"model-hint"},Rr={key:1,class:"model-list-container"},Mr=["disabled"],Er={key:1,class:"model-hint"},Pr={class:"settings-row"},Br={class:"settings-item"},Ar={class:"settings-item"},Fr={class:"settings-item"},Lr=["disabled"],Ur={class:"settings-item"},Or=["disabled"],zr={class:"settings-group"},Nr={class:"settings-item"},Vr={class:"prompt-format-selector"},Kr={class:"settings-item"},Wr={class:"checkbox-label"},qr={class:"settings-item"},Hr=Je({__name:"TranslationSettings",setup(n){const t=[{label:"SiliconFlow",value:"siliconflow"},{label:"DeepSeek",value:"deepseek"},{label:"ç«å±±å¼•æ“",value:"volcano"},{label:"å½©äº‘å°è¯‘",value:"caiyun"},{label:"ç™¾åº¦ç¿»è¯‘",value:"baidu_translate"},{label:"æœ‰é“ç¿»è¯‘",value:"youdao_translate"},{label:"Google Gemini",value:"gemini"},{label:"Ollama (æœ¬åœ°)",value:"ollama"},{label:"Sakura (æœ¬åœ°)",value:"sakura"},{label:"è‡ªå®šä¹‰ OpenAI å…¼å®¹æœåŠ¡",value:"custom_openai"}],l=[{label:"æ™®é€šæç¤ºè¯",value:"normal"},{label:"JSONæç¤ºè¯",value:"json"}],o=Ve(),a=ct(),r=S({modelProvider:o.settings.translation.provider,apiKey:o.settings.translation.apiKey,modelName:o.settings.translation.modelName,customBaseUrl:o.settings.translation.customBaseUrl,rpmTranslation:o.settings.translation.rpmLimit,translationMaxRetries:o.settings.translation.maxRetries,promptContent:o.settings.translatePrompt,translatePromptMode:o.settings.translation.isJsonMode?"json":"normal",enableTextboxPrompt:o.settings.useTextboxPrompt,textboxPromptContent:o.settings.textboxPrompt}),s=S(!1),i=S(!1),h=S(!1),_=S([]),v=S([]),$=S([]),W=Y(()=>{const d=[{label:"-- é€‰æ‹©æ¨¡å‹ --",value:""}];return _.value.forEach(m=>d.push({label:m,value:m})),d}),z=Y(()=>{const d=[{label:"-- é€‰æ‹©æ¨¡å‹ --",value:""}];return v.value.forEach(m=>d.push({label:m,value:m})),d}),N=Y(()=>{const d=[{label:"-- é€‰æ‹©æ¨¡å‹ --",value:""}];return $.value.forEach(m=>d.push({label:m,value:m})),d}),w=Y(()=>["ollama","sakura"].includes(r.value.modelProvider)),A=Y(()=>!["ollama","sakura","caiyun","baidu_translate","youdao_translate"].includes(r.value.modelProvider)),U=Y(()=>["siliconflow","deepseek","volcano","gemini","custom_openai"].includes(r.value.modelProvider)),R=Y(()=>{switch(r.value.modelProvider){case"baidu_translate":return"App ID";case"youdao_translate":return"App Key";case"caiyun":return"API Token";default:return"API Key"}}),g=Y(()=>{switch(r.value.modelProvider){case"baidu_translate":return"è¯·è¾“å…¥ç™¾åº¦ç¿»è¯‘App ID";case"youdao_translate":return"è¯·è¾“å…¥æœ‰é“ç¿»è¯‘åº”ç”¨ID";case"caiyun":return"è¯·è¾“å…¥å½©äº‘å°è¯‘Token";default:return"è¯·è¾“å…¥API Key"}}),c=Y(()=>{switch(r.value.modelProvider){case"baidu_translate":return"App Key";case"youdao_translate":return"App Secret";case"caiyun":return"æºè¯­è¨€ (å¯é€‰)";default:return"æ¨¡å‹åç§°"}}),p=Y(()=>{switch(r.value.modelProvider){case"baidu_translate":return"è¯·è¾“å…¥ç™¾åº¦ç¿»è¯‘App Key";case"youdao_translate":return"è¯·è¾“å…¥æœ‰é“ç¿»è¯‘åº”ç”¨å¯†é’¥";case"caiyun":return"å¯é€‰: auto/æ—¥è¯­/è‹±è¯­";default:return"è¯·è¾“å…¥æ¨¡å‹åç§°"}});function b(){const d=r.value.modelProvider;o.setTranslationProvider(d),r.value.apiKey=o.settings.translation.apiKey,r.value.modelName=o.settings.translation.modelName,r.value.customBaseUrl=o.settings.translation.customBaseUrl,r.value.rpmTranslation=o.settings.translation.rpmLimit,r.value.translationMaxRetries=o.settings.translation.maxRetries,_.value=[]}function T(){const d=r.value.translatePromptMode==="json";d?r.value.promptContent=Bo:r.value.promptContent=Ao,o.updateTranslationService({isJsonMode:d}),o.setTranslatePrompt(r.value.promptContent)}ye(()=>r.value.apiKey,d=>{o.updateTranslationService({apiKey:d})}),ye(()=>r.value.modelName,d=>{o.updateTranslationService({modelName:d})}),ye(()=>r.value.customBaseUrl,d=>{o.updateTranslationService({customBaseUrl:d})}),ye(()=>r.value.rpmTranslation,d=>{o.updateTranslationService({rpmLimit:d})}),ye(()=>r.value.translationMaxRetries,d=>{o.updateTranslationService({maxRetries:d})}),ye(()=>r.value.promptContent,d=>{o.setTranslatePrompt(d)}),ye(()=>r.value.enableTextboxPrompt,d=>{o.setUseTextboxPrompt(d)}),ye(()=>r.value.textboxPromptContent,d=>{o.setTextboxPrompt(d)});async function O(){const d=r.value.modelProvider,m=r.value.apiKey?.trim(),E=r.value.customBaseUrl?.trim();if(!m){a.warning("è¯·å…ˆå¡«å†™ API Key");return}if(!["siliconflow","deepseek","volcano","gemini","custom_openai"].includes(d)){a.warning(`${Q(d)} ä¸æ”¯æŒè‡ªåŠ¨è·å–æ¨¡å‹åˆ—è¡¨`);return}if(d==="custom_openai"&&!E){a.warning("è‡ªå®šä¹‰æœåŠ¡éœ€è¦å…ˆå¡«å†™ Base URL");return}h.value=!0;try{const M=await Ne.fetchModels(d,m,E);M.success&&M.models&&M.models.length>0?(_.value=M.models.map(Z=>Z.id),a.success(`è·å–åˆ° ${M.models.length} ä¸ªæ¨¡å‹`)):a.warning(M.message||"æœªè·å–åˆ°å¯ç”¨æ¨¡å‹")}catch(M){const Z=M instanceof Error?M.message:"è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥";a.error(Z)}finally{h.value=!1}}function Q(d){return{siliconflow:"SiliconFlow",deepseek:"DeepSeek",volcano:"ç«å±±å¼•æ“",gemini:"Google Gemini",custom_openai:"è‡ªå®šä¹‰OpenAI",ollama:"Ollama",sakura:"Sakura",caiyun:"å½©äº‘å°è¯‘",baidu_translate:"ç™¾åº¦ç¿»è¯‘",youdao_translate:"æœ‰é“ç¿»è¯‘"}[d]||d}async function V(){h.value=!0;try{const d=await Ne.testOllamaConnection();d.success&&d.models?(v.value=d.models,a.success(`è·å–åˆ° ${d.models.length} ä¸ªOllamaæ¨¡å‹`)):a.error(d.error||"Ollamaè¿æ¥å¤±è´¥")}catch(d){const m=d instanceof Error?d.message:"è·å–Ollamaæ¨¡å‹å¤±è´¥";a.error(m)}finally{h.value=!1}}async function G(){h.value=!0;try{const d=await Ne.testSakuraConnection();d.success&&d.models?($.value=d.models,a.success(`è·å–åˆ° ${d.models.length} ä¸ªSakuraæ¨¡å‹`)):a.error(d.error||"Sakuraè¿æ¥å¤±è´¥")}catch(d){const m=d instanceof Error?d.message:"è·å–Sakuraæ¨¡å‹å¤±è´¥";a.error(m)}finally{h.value=!1}}async function j(){i.value=!0;try{let d;r.value.modelProvider==="ollama"?d=await Ne.testOllamaConnection():d=await Ne.testSakuraConnection(),d.success?a.success(`${r.value.modelProvider==="ollama"?"Ollama":"Sakura"} è¿æ¥æˆåŠŸ`):a.error(d.error||"è¿æ¥å¤±è´¥")}catch(d){const m=d instanceof Error?d.message:"è¿æ¥æµ‹è¯•å¤±è´¥";a.error(m)}finally{i.value=!1}}async function k(){const d=r.value.modelProvider,m=r.value.apiKey?.trim(),E=r.value.modelName?.trim(),te=r.value.customBaseUrl?.trim();if(!m){a.warning("è¯·å…ˆå¡«å†™ API Key");return}if(d!=="caiyun"&&!E){a.warning("è¯·å¡«å†™æ¨¡å‹åç§°");return}if(d==="custom_openai"&&!te){a.warning("è‡ªå®šä¹‰æœåŠ¡éœ€è¦å¡«å†™ Base URL");return}i.value=!0,a.info("æ­£åœ¨æµ‹è¯•è¿æ¥...");try{let M;switch(d){case"baidu_translate":M=await Ne.testBaiduTranslateConnection(m,E);break;case"youdao_translate":M=await Ne.testYoudaoTranslateConnection(m,E);break;default:M=await Ne.testAiTranslateConnection({provider:d,apiKey:m,modelName:E,baseUrl:te})}M.success?a.success(M.message||`${Q(d)} è¿æ¥æˆåŠŸ!`):a.error(M.message||M.error||"è¿æ¥å¤±è´¥")}catch(M){const Z=M instanceof Error?M.message:"è¿æ¥æµ‹è¯•å¤±è´¥";a.error(Z)}finally{i.value=!1}}function y(d,m){r.value.promptContent=d,a.success(`å·²åº”ç”¨æç¤ºè¯: ${m}`)}function I(d,m){r.value.textboxPromptContent=d,a.success(`å·²åº”ç”¨æç¤ºè¯: ${m}`)}function f(){r.value.translatePromptMode==="json"?r.value.promptContent=Bo:r.value.promptContent=Ao,a.success("å·²é‡ç½®ä¸ºé»˜è®¤æç¤ºè¯")}return(d,m)=>(D(),L("div",lr,[e("div",ir,[m[21]||(m[21]=e("div",{class:"settings-group-title"},"ç¿»è¯‘æœåŠ¡é…ç½®",-1)),e("div",rr,[e("div",ur,[m[14]||(m[14]=e("label",{for:"settingsModelProvider"},"ç¿»è¯‘æœåŠ¡å•†:",-1)),he(Oe,{"model-value":r.value.modelProvider,options:t,onChange:m[0]||(m[0]=E=>{r.value.modelProvider=E,b()})},null,8,["model-value"])]),se(e("div",cr,[e("label",dr,le(R.value)+":",1),e("div",gr,[se(e("input",{type:s.value?"text":"password",id:"settingsApiKey","onUpdate:modelValue":m[1]||(m[1]=E=>r.value.apiKey=E),class:"secure-input",placeholder:g.value,autocomplete:"off"},null,8,pr),[[kt,r.value.apiKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:m[2]||(m[2]=E=>s.value=!s.value)},[s.value?(D(),L("span",vr,"ğŸ‘â€ğŸ—¨")):(D(),L("span",mr,"ğŸ‘"))])])],512),[[Ae,!w.value]])]),se(e("div",br,[m[15]||(m[15]=e("label",{for:"settingsCustomBaseUrl"},"Base URL:",-1)),se(e("input",{type:"text",id:"settingsCustomBaseUrl","onUpdate:modelValue":m[3]||(m[3]=E=>r.value.customBaseUrl=E),placeholder:"ä¾‹å¦‚: https://api.example.com/v1"},null,512),[[Ce,r.value.customBaseUrl]])],512),[[Ae,r.value.modelProvider==="custom_openai"]]),se(e("div",fr,[e("label",hr,le(c.value)+":",1),e("div",yr,[se(e("input",{type:"text",id:"settingsModelName","onUpdate:modelValue":m[4]||(m[4]=E=>r.value.modelName=E),placeholder:p.value},null,8,xr),[[Ce,r.value.modelName]]),se(e("button",{type:"button",class:"fetch-models-btn",title:"è·å–å¯ç”¨æ¨¡å‹åˆ—è¡¨",onClick:O,disabled:h.value},[m[16]||(m[16]=e("span",{class:"fetch-icon"},"ğŸ”",-1)),e("span",_r,le(h.value?"è·å–ä¸­...":"è·å–æ¨¡å‹"),1)],8,kr),[[Ae,U.value]])]),_.value.length>0?(D(),L("div",Sr,[he(Oe,{"model-value":r.value.modelName,options:W.value,onChange:m[5]||(m[5]=E=>{r.value.modelName=E})},null,8,["model-value","options"]),e("span",Cr,"å…± "+le(_.value.length)+" ä¸ªæ¨¡å‹",1)])):ge("",!0)],512),[[Ae,!w.value]]),se(e("div",wr,[m[17]||(m[17]=e("label",null,"æœ¬åœ°æ¨¡å‹:",-1)),e("div",$r,[r.value.modelProvider==="ollama"?(D(),L("div",Ir,[e("button",{class:"settings-test-btn",onClick:V,disabled:h.value},le(h.value?"è·å–ä¸­...":"ğŸ”„ åˆ·æ–°æ¨¡å‹åˆ—è¡¨"),9,Tr),v.value.length>0?(D(),st(Oe,{key:0,"model-value":r.value.modelName,options:z.value,onChange:m[6]||(m[6]=E=>r.value.modelName=E)},null,8,["model-value","options"])):(D(),L("p",Dr,"ç‚¹å‡»åˆ·æ–°è·å–å¯ç”¨æ¨¡å‹"))])):r.value.modelProvider==="sakura"?(D(),L("div",Rr,[e("button",{class:"settings-test-btn",onClick:G,disabled:h.value},le(h.value?"è·å–ä¸­...":"ğŸ”„ åˆ·æ–°æ¨¡å‹åˆ—è¡¨"),9,Mr),$.value.length>0?(D(),st(Oe,{key:0,"model-value":r.value.modelName,options:N.value,onChange:m[7]||(m[7]=E=>r.value.modelName=E)},null,8,["model-value","options"])):(D(),L("p",Er,"ç‚¹å‡»åˆ·æ–°è·å–å¯ç”¨æ¨¡å‹"))])):ge("",!0)])],512),[[Ae,w.value]]),se(e("div",Pr,[e("div",Br,[m[18]||(m[18]=e("label",{for:"settingsRpmTranslation"},"RPMé™åˆ¶:",-1)),se(e("input",{type:"number",id:"settingsRpmTranslation","onUpdate:modelValue":m[8]||(m[8]=E=>r.value.rpmTranslation=E),min:"0",step:"1"},null,512),[[Ce,r.value.rpmTranslation,void 0,{number:!0}]]),m[19]||(m[19]=e("div",{class:"input-hint"},"æ¯åˆ†é’Ÿè¯·æ±‚æ•°ï¼Œ0è¡¨ç¤ºæ— é™åˆ¶",-1))]),e("div",Ar,[m[20]||(m[20]=e("label",{for:"settingsTranslationMaxRetries"},"é‡è¯•æ¬¡æ•°:",-1)),se(e("input",{type:"number",id:"settingsTranslationMaxRetries","onUpdate:modelValue":m[9]||(m[9]=E=>r.value.translationMaxRetries=E),min:"0",max:"10",step:"1"},null,512),[[Ce,r.value.translationMaxRetries,void 0,{number:!0}]])])],512),[[Ae,A.value]]),se(e("div",Fr,[e("button",{class:"settings-test-btn",onClick:j,disabled:i.value},le(i.value?"æµ‹è¯•ä¸­...":"ğŸ”— æµ‹è¯•è¿æ¥"),9,Lr)],512),[[Ae,w.value]]),se(e("div",Ur,[e("button",{class:"settings-test-btn",onClick:k,disabled:i.value},le(i.value?"æµ‹è¯•ä¸­...":"ğŸ”— æµ‹è¯•è¿æ¥"),9,Or)],512),[[Ae,!w.value]])]),e("div",zr,[m[26]||(m[26]=e("div",{class:"settings-group-title"},"æç¤ºè¯è®¾ç½®",-1)),e("div",Nr,[m[23]||(m[23]=e("label",{for:"settingsPromptContent"},"ç¿»è¯‘æç¤ºè¯:",-1)),se(e("textarea",{id:"settingsPromptContent","onUpdate:modelValue":m[10]||(m[10]=E=>r.value.promptContent=E),rows:"4",placeholder:"ç¿»è¯‘æç¤ºè¯"},null,512),[[Ce,r.value.promptContent]]),e("div",Vr,[he(Oe,{"model-value":r.value.translatePromptMode,options:l,onChange:m[11]||(m[11]=E=>{r.value.translatePromptMode=E,T()})},null,8,["model-value"]),m[22]||(m[22]=e("span",{class:"input-hint"},"JSONæ ¼å¼è¾“å‡ºæ›´ç»“æ„åŒ–",-1))]),he(Tt,{"prompt-type":"translate",onSelect:y}),e("button",{type:"button",class:"reset-btn",onClick:f}," é‡ç½®ä¸ºé»˜è®¤ ")]),e("div",Kr,[e("label",Wr,[se(e("input",{type:"checkbox","onUpdate:modelValue":m[12]||(m[12]=E=>r.value.enableTextboxPrompt=E)},null,512),[[et,r.value.enableTextboxPrompt]]),m[24]||(m[24]=Se(" å¯ç”¨æ–‡æœ¬æ¡†æç¤ºè¯ ",-1))])]),se(e("div",qr,[m[25]||(m[25]=e("label",{for:"settingsTextboxPromptContent"},"æ–‡æœ¬æ¡†æç¤ºè¯:",-1)),se(e("textarea",{id:"settingsTextboxPromptContent","onUpdate:modelValue":m[13]||(m[13]=E=>r.value.textboxPromptContent=E),rows:"3",placeholder:"æ–‡æœ¬æ¡†æç¤ºè¯"},null,512),[[Ce,r.value.textboxPromptContent]]),he(Tt,{"prompt-type":"textbox",onSelect:I})],512),[[Ae,r.value.enableTextboxPrompt]])])]))}}),Jr=He(Hr,[["__scopeId","data-v-1eaa2d97"]]),jr={class:"detection-settings"},Yr={class:"settings-group"},Xr={class:"settings-item"},Gr={class:"settings-group"},Zr={class:"settings-item"},Qr={class:"settings-row"},eu={class:"settings-item"},tu={class:"settings-item"},ou={class:"settings-row"},nu={class:"settings-item"},su={class:"settings-item"},au={class:"settings-group"},lu={class:"settings-item"},iu={class:"checkbox-label"},ru={class:"settings-row"},uu={class:"settings-item"},cu={class:"settings-item"},du={class:"settings-group"},gu={class:"settings-item"},pu={class:"checkbox-label"},mu=Je({__name:"DetectionSettings",setup(n){const t=[{label:"CTD (Comic Text Detector)",value:"ctd"},{label:"YOLO",value:"yolo"},{label:"YOLOv5",value:"yolov5"},{label:"Default (DBNet)",value:"default"}],l=Ve(),o=Yn({textDetector:l.settings.textDetector,boxExpandRatio:l.settings.boxExpand.ratio,boxExpandTop:l.settings.boxExpand.top,boxExpandBottom:l.settings.boxExpand.bottom,boxExpandLeft:l.settings.boxExpand.left,boxExpandRight:l.settings.boxExpand.right,usePreciseMask:l.settings.preciseMask.enabled,maskDilateSize:l.settings.preciseMask.dilateSize,maskBoxExpandRatio:l.settings.preciseMask.boxExpandRatio,showDetectionDebug:l.settings.showDetectionDebug}),a=Y(()=>["ctd","default"].includes(o.textDetector));ye(()=>o.textDetector,s=>{l.setTextDetector(s)}),ye(()=>o.boxExpandRatio,s=>{l.updateBoxExpand({ratio:s})}),ye(()=>o.boxExpandTop,s=>{l.updateBoxExpand({top:s})}),ye(()=>o.boxExpandBottom,s=>{l.updateBoxExpand({bottom:s})}),ye(()=>o.boxExpandLeft,s=>{l.updateBoxExpand({left:s})}),ye(()=>o.boxExpandRight,s=>{l.updateBoxExpand({right:s})}),ye(()=>o.usePreciseMask,s=>{l.updatePreciseMask({enabled:s})}),ye(()=>o.maskDilateSize,s=>{l.updatePreciseMask({dilateSize:s})}),ye(()=>o.maskBoxExpandRatio,s=>{l.updatePreciseMask({boxExpandRatio:s})}),ye(()=>o.showDetectionDebug,s=>{l.setShowDetectionDebug(s)});function r(){a.value||(o.usePreciseMask=!1)}return(s,i)=>(D(),L("div",jr,[e("div",Yr,[i[11]||(i[11]=e("div",{class:"settings-group-title"},"æ–‡å­—æ£€æµ‹å™¨",-1)),e("div",Xr,[i[10]||(i[10]=e("label",{for:"settingsTextDetector"},"æ£€æµ‹å™¨ç±»å‹:",-1)),he(Oe,{modelValue:o.textDetector,"onUpdate:modelValue":i[0]||(i[0]=h=>o.textDetector=h),options:t,onChange:r},null,8,["modelValue"])])]),e("div",Gr,[i[18]||(i[18]=e("div",{class:"settings-group-title"},"æ–‡æœ¬æ¡†æ‰©å±•å‚æ•°",-1)),e("div",Zr,[i[12]||(i[12]=e("label",{for:"settingsBoxExpandRatio"},"æ•´ä½“æ‰©å±• (%):",-1)),se(e("input",{type:"number",id:"settingsBoxExpandRatio","onUpdate:modelValue":i[1]||(i[1]=h=>o.boxExpandRatio=h),min:"0",max:"50",step:"1"},null,512),[[Ce,o.boxExpandRatio,void 0,{number:!0}]]),i[13]||(i[13]=e("div",{class:"input-hint"},"å‘å››å‘¨å‡åŒ€æ‰©å±•çš„ç™¾åˆ†æ¯” (0-50%)",-1))]),e("div",Qr,[e("div",eu,[i[14]||(i[14]=e("label",{for:"settingsBoxExpandTop"},"ä¸Šæ–¹æ‰©å±• (%):",-1)),se(e("input",{type:"number",id:"settingsBoxExpandTop","onUpdate:modelValue":i[2]||(i[2]=h=>o.boxExpandTop=h),min:"0",max:"50",step:"1"},null,512),[[Ce,o.boxExpandTop,void 0,{number:!0}]])]),e("div",tu,[i[15]||(i[15]=e("label",{for:"settingsBoxExpandBottom"},"ä¸‹æ–¹æ‰©å±• (%):",-1)),se(e("input",{type:"number",id:"settingsBoxExpandBottom","onUpdate:modelValue":i[3]||(i[3]=h=>o.boxExpandBottom=h),min:"0",max:"50",step:"1"},null,512),[[Ce,o.boxExpandBottom,void 0,{number:!0}]])])]),e("div",ou,[e("div",nu,[i[16]||(i[16]=e("label",{for:"settingsBoxExpandLeft"},"å·¦ä¾§æ‰©å±• (%):",-1)),se(e("input",{type:"number",id:"settingsBoxExpandLeft","onUpdate:modelValue":i[4]||(i[4]=h=>o.boxExpandLeft=h),min:"0",max:"50",step:"1"},null,512),[[Ce,o.boxExpandLeft,void 0,{number:!0}]])]),e("div",su,[i[17]||(i[17]=e("label",{for:"settingsBoxExpandRight"},"å³ä¾§æ‰©å±• (%):",-1)),se(e("input",{type:"number",id:"settingsBoxExpandRight","onUpdate:modelValue":i[5]||(i[5]=h=>o.boxExpandRight=h),min:"0",max:"50",step:"1"},null,512),[[Ce,o.boxExpandRight,void 0,{number:!0}]])])])]),se(e("div",au,[i[25]||(i[25]=e("div",{class:"settings-group-title"},"ç²¾ç¡®æ–‡å­—æ©è†œ",-1)),e("div",lu,[e("label",iu,[se(e("input",{type:"checkbox","onUpdate:modelValue":i[6]||(i[6]=h=>o.usePreciseMask=h)},null,512),[[et,o.usePreciseMask]]),i[19]||(i[19]=Se(" å¯ç”¨ç²¾ç¡®æ–‡å­—æ©è†œ ",-1))]),i[20]||(i[20]=e("div",{class:"input-hint"},"ä½¿ç”¨æ›´ç²¾ç¡®çš„æ–‡å­—åŒºåŸŸæ©è†œè¿›è¡Œä¿®å¤",-1))]),se(e("div",ru,[e("div",uu,[i[21]||(i[21]=e("label",{for:"settingsMaskDilateSize"},"è†¨èƒ€å¤§å°:",-1)),se(e("input",{type:"number",id:"settingsMaskDilateSize","onUpdate:modelValue":i[7]||(i[7]=h=>o.maskDilateSize=h),min:"0",step:"1"},null,512),[[Ce,o.maskDilateSize,void 0,{number:!0}]]),i[22]||(i[22]=e("div",{class:"input-hint"},"æ©è†œè†¨èƒ€åƒç´ æ•°",-1))]),e("div",cu,[i[23]||(i[23]=e("label",{for:"settingsMaskBoxExpandRatio"},"æ ‡æ³¨æ¡†æ‰©å¤§æ¯”ä¾‹ (%):",-1)),se(e("input",{type:"number",id:"settingsMaskBoxExpandRatio","onUpdate:modelValue":i[8]||(i[8]=h=>o.maskBoxExpandRatio=h),min:"0",max:"100",step:"1"},null,512),[[Ce,o.maskBoxExpandRatio,void 0,{number:!0}]]),i[24]||(i[24]=e("div",{class:"input-hint"},"æ ‡æ³¨æ¡†åŒºåŸŸæ‰©å¤§ç™¾åˆ†æ¯”",-1))])],512),[[Ae,o.usePreciseMask]])],512),[[Ae,a.value]]),e("div",du,[i[28]||(i[28]=e("div",{class:"settings-group-title"},"è°ƒè¯•é€‰é¡¹",-1)),e("div",gu,[e("label",pu,[se(e("input",{type:"checkbox","onUpdate:modelValue":i[9]||(i[9]=h=>o.showDetectionDebug=h)},null,512),[[et,o.showDetectionDebug]]),i[26]||(i[26]=Se(" æ˜¾ç¤ºæ£€æµ‹æ¡†è°ƒè¯•ä¿¡æ¯ ",-1))]),i[27]||(i[27]=e("div",{class:"input-hint"},"åœ¨ç¿»è¯‘ç»“æœä¸­æ˜¾ç¤ºæ°”æ³¡æ£€æµ‹æ¡†ï¼Œç”¨äºè°ƒè¯•",-1))])])]))}}),vu=He(mu,[["__scopeId","data-v-c12c43ee"]]),bu={class:"hq-translation-settings"},fu={class:"settings-group"},hu={class:"settings-row"},yu={class:"settings-item"},xu={class:"settings-item"},ku={class:"password-input-wrapper"},_u=["type"],Su={key:0,class:"eye-icon"},Cu={key:1,class:"eye-off-icon"},wu={class:"settings-item"},$u={class:"settings-item"},Iu={class:"model-input-with-fetch"},Tu=["disabled"],Du={class:"fetch-text"},Ru={key:0,class:"model-select-container"},Mu={class:"model-count"},Eu={class:"settings-item"},Pu=["disabled"],Bu={class:"settings-group"},Au={class:"settings-row"},Fu={class:"settings-item"},Lu={class:"settings-item"},Uu={class:"settings-row"},Ou={class:"settings-item"},zu={class:"settings-item"},Nu={class:"settings-group"},Vu={class:"settings-row"},Ku={class:"settings-item"},Wu={class:"checkbox-label"},qu={class:"settings-item"},Hu={class:"settings-row"},Ju={class:"settings-item"},ju={class:"checkbox-label"},Yu={class:"settings-item"},Xu={class:"checkbox-label"},Gu={class:"settings-group"},Zu={class:"settings-item"},Qu=Je({__name:"HqTranslationSettings",setup(n){const t=[{label:"SiliconFlow",value:"siliconflow"},{label:"DeepSeek",value:"deepseek"},{label:"ç«å±±å¼•æ“",value:"volcano"},{label:"Google Gemini",value:"gemini"},{label:"è‡ªå®šä¹‰ OpenAI å…¼å®¹æœåŠ¡",value:"custom_openai"}],l=[{label:"Geminié£æ ¼ (reasoning_effort=low)",value:"gemini"},{label:"ç«å±±å¼•æ“é£æ ¼ (thinking=null)",value:"volcano"}],o=Ve(),a=ct(),r=Y(()=>o.settings.hqTranslation),s=S({apiKey:o.settings.hqTranslation.apiKey,modelName:o.settings.hqTranslation.modelName,customBaseUrl:o.settings.hqTranslation.customBaseUrl,batchSize:o.settings.hqTranslation.batchSize,sessionReset:o.settings.hqTranslation.sessionReset,rpmLimit:o.settings.hqTranslation.rpmLimit,maxRetries:o.settings.hqTranslation.maxRetries,lowReasoning:o.settings.hqTranslation.lowReasoning,noThinkingMethod:o.settings.hqTranslation.noThinkingMethod,forceJsonOutput:o.settings.hqTranslation.forceJsonOutput,useStream:o.settings.hqTranslation.useStream,prompt:o.settings.hqTranslation.prompt});ye(()=>s.value.apiKey,g=>{o.updateHqTranslation({apiKey:g})}),ye(()=>s.value.modelName,g=>{o.updateHqTranslation({modelName:g})}),ye(()=>s.value.customBaseUrl,g=>{o.updateHqTranslation({customBaseUrl:g})}),ye(()=>s.value.batchSize,g=>{o.updateHqTranslation({batchSize:g})}),ye(()=>s.value.sessionReset,g=>{o.updateHqTranslation({sessionReset:g})}),ye(()=>s.value.rpmLimit,g=>{o.updateHqTranslation({rpmLimit:g})}),ye(()=>s.value.maxRetries,g=>{o.updateHqTranslation({maxRetries:g})}),ye(()=>s.value.lowReasoning,g=>{o.updateHqTranslation({lowReasoning:g})}),ye(()=>s.value.noThinkingMethod,g=>{o.updateHqTranslation({noThinkingMethod:g})}),ye(()=>s.value.forceJsonOutput,g=>{o.updateHqTranslation({forceJsonOutput:g})}),ye(()=>s.value.useStream,g=>{o.updateHqTranslation({useStream:g})}),ye(()=>s.value.prompt,g=>{o.updateHqTranslation({prompt:g})});const i=S(!1),h=S(!1),_=S([]),v=S(!1),$=Y(()=>{const g=[{label:"-- é€‰æ‹©æ¨¡å‹ --",value:""}];return _.value.forEach(c=>g.push({label:c,value:c})),g});function W(g){o.setHqProvider(g),_.value=[],z()}function z(){const g=o.settings.hqTranslation;s.value.apiKey=g.apiKey,s.value.modelName=g.modelName,s.value.customBaseUrl=g.customBaseUrl,s.value.batchSize=g.batchSize,s.value.sessionReset=g.sessionReset,s.value.rpmLimit=g.rpmLimit,s.value.maxRetries=g.maxRetries,s.value.lowReasoning=g.lowReasoning,s.value.noThinkingMethod=g.noThinkingMethod,s.value.forceJsonOutput=g.forceJsonOutput,s.value.useStream=g.useStream,s.value.prompt=g.prompt}function N(g){return{siliconflow:"SiliconFlow",deepseek:"DeepSeek",volcano:"ç«å±±å¼•æ“",gemini:"Google Gemini",custom_openai:"è‡ªå®šä¹‰OpenAI"}[g]||g}async function w(){const g=r.value.provider,c=s.value.apiKey?.trim(),p=s.value.customBaseUrl?.trim();if(!c){a.warning("è¯·å…ˆå¡«å†™ API Key");return}if(!["siliconflow","deepseek","volcano","gemini","custom_openai"].includes(g)){a.warning(`${N(g)} ä¸æ”¯æŒè‡ªåŠ¨è·å–æ¨¡å‹åˆ—è¡¨`);return}if(g==="custom_openai"&&!p){a.warning("è‡ªå®šä¹‰æœåŠ¡éœ€è¦å…ˆå¡«å†™ Base URL");return}h.value=!0;try{const T=await Ne.fetchModels(g,c,p);T.success&&T.models&&T.models.length>0?(_.value=T.models.map(O=>O.id),a.success(`è·å–åˆ° ${T.models.length} ä¸ªæ¨¡å‹`)):a.warning(T.message||"æœªè·å–åˆ°å¯ç”¨æ¨¡å‹")}catch(T){const O=T instanceof Error?T.message:"è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥";a.error(O)}finally{h.value=!1}}async function A(){const g=r.value.provider,c=s.value.apiKey?.trim(),p=s.value.modelName?.trim(),b=s.value.customBaseUrl?.trim();if(!c){a.warning("è¯·å…ˆå¡«å†™ API Key");return}if(!p){a.warning("è¯·å¡«å†™æ¨¡å‹åç§°");return}if(g==="custom_openai"&&!b){a.warning("è‡ªå®šä¹‰æœåŠ¡éœ€è¦å¡«å†™ Base URL");return}v.value=!0,a.info("æ­£åœ¨æµ‹è¯•è¿æ¥...");try{const T=await Ne.testAiTranslateConnection({provider:g,apiKey:c,modelName:p,baseUrl:b});T.success?a.success(T.message||`${N(g)} è¿æ¥æˆåŠŸ!`):a.error(T.message||T.error||"è¿æ¥å¤±è´¥")}catch(T){const O=T instanceof Error?T.message:"è¿æ¥æµ‹è¯•å¤±è´¥";a.error(O)}finally{v.value=!1}}function U(){o.updateHqTranslation({prompt:Fo}),s.value.prompt=Fo,a.success("å·²é‡ç½®ä¸ºé»˜è®¤æç¤ºè¯")}function R(g,c){o.updateHqTranslation({prompt:g}),s.value.prompt=g,a.success(`å·²åº”ç”¨æç¤ºè¯: ${c}`)}return(g,c)=>(D(),L("div",bu,[e("div",fu,[c[20]||(c[20]=e("div",{class:"settings-group-title"},"é«˜è´¨é‡ç¿»è¯‘æœåŠ¡é…ç½®",-1)),e("div",hu,[e("div",yu,[c[15]||(c[15]=e("label",{for:"settingsHqTranslateProvider"},"æœåŠ¡å•†:",-1)),he(Oe,{"model-value":r.value.provider,options:t,onChange:c[0]||(c[0]=p=>W(p))},null,8,["model-value"])]),e("div",xu,[c[16]||(c[16]=e("label",{for:"settingsHqApiKey"},"API Key:",-1)),e("div",ku,[se(e("input",{type:i.value?"text":"password",id:"settingsHqApiKey","onUpdate:modelValue":c[1]||(c[1]=p=>s.value.apiKey=p),class:"secure-input",placeholder:"è¯·è¾“å…¥API Key",autocomplete:"off"},null,8,_u),[[kt,s.value.apiKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:c[2]||(c[2]=p=>i.value=!i.value)},[i.value?(D(),L("span",Cu,"ğŸ‘â€ğŸ—¨")):(D(),L("span",Su,"ğŸ‘"))])])])]),se(e("div",wu,[c[17]||(c[17]=e("label",{for:"settingsHqCustomBaseUrl"},"Base URL:",-1)),se(e("input",{type:"text",id:"settingsHqCustomBaseUrl","onUpdate:modelValue":c[3]||(c[3]=p=>s.value.customBaseUrl=p),placeholder:"ä¾‹å¦‚: https://api.example.com/v1"},null,512),[[Ce,s.value.customBaseUrl]])],512),[[Ae,r.value.provider==="custom_openai"]]),e("div",$u,[c[19]||(c[19]=e("label",{for:"settingsHqModelName"},"æ¨¡å‹åç§°:",-1)),e("div",Iu,[se(e("input",{type:"text",id:"settingsHqModelName","onUpdate:modelValue":c[4]||(c[4]=p=>s.value.modelName=p),placeholder:"è¯·è¾“å…¥æ¨¡å‹åç§°"},null,512),[[Ce,s.value.modelName]]),e("button",{type:"button",class:"fetch-models-btn",title:"è·å–å¯ç”¨æ¨¡å‹åˆ—è¡¨",onClick:w,disabled:h.value},[c[18]||(c[18]=e("span",{class:"fetch-icon"},"ğŸ”",-1)),e("span",Du,le(h.value?"è·å–ä¸­...":"è·å–æ¨¡å‹"),1)],8,Tu)]),_.value.length>0?(D(),L("div",Ru,[he(Oe,{modelValue:s.value.modelName,"onUpdate:modelValue":c[5]||(c[5]=p=>s.value.modelName=p),options:$.value},null,8,["modelValue","options"]),e("span",Mu,"å…± "+le(_.value.length)+" ä¸ªæ¨¡å‹",1)])):ge("",!0)]),e("div",Eu,[e("button",{class:"settings-test-btn",onClick:A,disabled:v.value},le(v.value?"æµ‹è¯•ä¸­...":"ğŸ”— æµ‹è¯•è¿æ¥"),9,Pu)])]),e("div",Bu,[c[28]||(c[28]=e("div",{class:"settings-group-title"},"æ‰¹å¤„ç†è®¾ç½®",-1)),e("div",Au,[e("div",Fu,[c[21]||(c[21]=e("label",{for:"settingsHqBatchSize"},"æ‰¹æ¬¡å¤§å°:",-1)),se(e("input",{type:"number",id:"settingsHqBatchSize","onUpdate:modelValue":c[6]||(c[6]=p=>s.value.batchSize=p),min:"1",max:"10",step:"1"},null,512),[[Ce,s.value.batchSize,void 0,{number:!0}]]),c[22]||(c[22]=e("div",{class:"input-hint"},"æ¯æ‰¹å¤„ç†çš„å›¾ç‰‡æ•°é‡ (æ¨è3-5å¼ )",-1))]),e("div",Lu,[c[23]||(c[23]=e("label",{for:"settingsHqSessionReset"},"ä¼šè¯é‡ç½®é¢‘ç‡:",-1)),se(e("input",{type:"number",id:"settingsHqSessionReset","onUpdate:modelValue":c[7]||(c[7]=p=>s.value.sessionReset=p),min:"1",step:"1"},null,512),[[Ce,s.value.sessionReset,void 0,{number:!0}]]),c[24]||(c[24]=e("div",{class:"input-hint"},"å¤šå°‘æ‰¹æ¬¡åé‡ç½®ä¸Šä¸‹æ–‡",-1))])]),e("div",Uu,[e("div",Ou,[c[25]||(c[25]=e("label",{for:"settingsHqRpmLimit"},"RPMé™åˆ¶:",-1)),se(e("input",{type:"number",id:"settingsHqRpmLimit","onUpdate:modelValue":c[8]||(c[8]=p=>s.value.rpmLimit=p),min:"0",step:"1"},null,512),[[Ce,s.value.rpmLimit,void 0,{number:!0}]]),c[26]||(c[26]=e("div",{class:"input-hint"},"æ¯åˆ†é’Ÿè¯·æ±‚æ•°ï¼Œ0è¡¨ç¤ºæ— é™åˆ¶",-1))]),e("div",zu,[c[27]||(c[27]=e("label",{for:"settingsHqMaxRetries"},"é‡è¯•æ¬¡æ•°:",-1)),se(e("input",{type:"number",id:"settingsHqMaxRetries","onUpdate:modelValue":c[9]||(c[9]=p=>s.value.maxRetries=p),min:"0",max:"10",step:"1"},null,512),[[Ce,s.value.maxRetries,void 0,{number:!0}]])])])]),e("div",Nu,[c[36]||(c[36]=e("div",{class:"settings-group-title"},"é«˜çº§é€‰é¡¹",-1)),e("div",Vu,[e("div",Ku,[e("label",Wu,[se(e("input",{type:"checkbox","onUpdate:modelValue":c[10]||(c[10]=p=>s.value.lowReasoning=p)},null,512),[[et,s.value.lowReasoning]]),c[29]||(c[29]=Se(" ä½æ¨ç†æ¨¡å¼ ",-1))]),c[30]||(c[30]=e("div",{class:"input-hint"},"å‡å°‘æ¨¡å‹æ¨ç†æ·±åº¦ï¼Œæé«˜é€Ÿåº¦",-1))]),e("div",qu,[c[31]||(c[31]=e("label",{for:"settingsHqNoThinkingMethod"},"å–æ¶ˆæ€è€ƒæ–¹æ³•:",-1)),he(Oe,{modelValue:s.value.noThinkingMethod,"onUpdate:modelValue":c[11]||(c[11]=p=>s.value.noThinkingMethod=p),options:l},null,8,["modelValue"])])]),e("div",Hu,[e("div",Ju,[e("label",ju,[se(e("input",{type:"checkbox","onUpdate:modelValue":c[12]||(c[12]=p=>s.value.forceJsonOutput=p)},null,512),[[et,s.value.forceJsonOutput]]),c[32]||(c[32]=Se(" å¼ºåˆ¶JSONè¾“å‡º ",-1))]),c[33]||(c[33]=e("div",{class:"input-hint"},"ä½¿ç”¨ response_format: json_object",-1))]),e("div",Yu,[e("label",Xu,[se(e("input",{type:"checkbox","onUpdate:modelValue":c[13]||(c[13]=p=>s.value.useStream=p)},null,512),[[et,s.value.useStream]]),c[34]||(c[34]=Se(" æµå¼è°ƒç”¨ ",-1))]),c[35]||(c[35]=e("div",{class:"input-hint"},"ä½¿ç”¨æµå¼APIè°ƒç”¨",-1))])])]),e("div",Gu,[c[37]||(c[37]=e("div",{class:"settings-group-title"},"é«˜è´¨é‡ç¿»è¯‘æç¤ºè¯",-1)),e("div",Zu,[se(e("textarea",{id:"settingsHqPrompt","onUpdate:modelValue":c[14]||(c[14]=p=>s.value.prompt=p),rows:"6",placeholder:"é«˜è´¨é‡ç¿»è¯‘æç¤ºè¯"},null,512),[[Ce,s.value.prompt]]),he(Tt,{"prompt-type":"hq_translate",onSelect:R}),e("button",{class:"btn btn-secondary btn-sm",onClick:U},"é‡ç½®ä¸ºé»˜è®¤")])])]))}}),ec=He(Qu,[["__scopeId","data-v-23f4a3f7"]]),tc={class:"proofreading-settings"},oc={class:"settings-group"},nc={class:"settings-item"},sc={class:"checkbox-label"},ac={class:"settings-item"},lc={class:"settings-group"},ic={class:"round-header"},rc={class:"round-title"},uc=["onClick","disabled"],cc={class:"round-content"},dc={class:"settings-item"},gc=["onUpdate:modelValue"],pc={class:"settings-row"},mc={class:"settings-item"},vc={class:"settings-item"},bc={class:"password-input-wrapper"},fc=["type","onUpdate:modelValue"],hc=["onClick"],yc={key:0,class:"eye-icon"},xc={key:1,class:"eye-off-icon"},kc={class:"settings-item"},_c=["onUpdate:modelValue"],Sc={class:"settings-item"},Cc={class:"model-input-with-fetch"},wc=["onUpdate:modelValue"],$c=["onClick","disabled"],Ic={class:"fetch-text"},Tc={key:0,class:"model-select-container"},Dc={class:"model-count"},Rc={class:"settings-item"},Mc=["onClick","disabled"],Ec={class:"settings-row"},Pc={class:"settings-item"},Bc=["onUpdate:modelValue"],Ac={class:"settings-item"},Fc=["onUpdate:modelValue"],Lc={class:"settings-item"},Uc=["onUpdate:modelValue"],Oc={class:"settings-row"},zc={class:"settings-item"},Nc={class:"checkbox-label"},Vc=["onUpdate:modelValue"],Kc={class:"settings-item"},Wc={class:"settings-item"},qc={class:"checkbox-label"},Hc=["onUpdate:modelValue"],Jc={class:"settings-item"},jc=["onUpdate:modelValue"],Yc=["onClick"],Xc=Je({__name:"ProofreadingSettings",setup(n){const t=[{label:"SiliconFlow",value:"siliconflow"},{label:"DeepSeek",value:"deepseek"},{label:"ç«å±±å¼•æ“",value:"volcano"},{label:"Google Gemini",value:"gemini"},{label:"è‡ªå®šä¹‰ OpenAI å…¼å®¹æœåŠ¡",value:"custom_openai"}],l=[{label:"Geminié£æ ¼",value:"gemini"},{label:"ç«å±±å¼•æ“é£æ ¼",value:"volcano"}],o=Ve(),a=ct(),r=S({}),s=S({}),i=S({}),h=Y(()=>o.settings.proofreading.rounds),_=Y({get:()=>o.settings.proofreading.maxRetries,set:R=>o.setProofreadingMaxRetries(R)}),v=Y({get:()=>o.settings.proofreading.enabled,set:R=>o.setProofreadingEnabled(R)});ye(()=>o.settings.proofreading.rounds,()=>{o.saveToStorage()},{deep:!0});function $(R){const g=i.value[R]||[],c=[{label:"-- é€‰æ‹©æ¨¡å‹ --",value:""}];return g.forEach(p=>c.push({label:p,value:p})),c}async function W(R){const g=h.value[R];if(!g)return;const c=g.provider,p=g.apiKey?.trim(),b=g.customBaseUrl?.trim();if(!p){a.warning("è¯·å…ˆå¡«å†™ API Key");return}if(!["siliconflow","deepseek","volcano","gemini","custom_openai"].includes(c)){a.warning("å½“å‰æœåŠ¡å•†ä¸æ”¯æŒè·å–æ¨¡å‹åˆ—è¡¨");return}r.value[R]=!0;try{const O=await Ne.fetchModels(c,p,b);O.success&&O.models&&O.models.length>0?(i.value[R]=O.models.map(Q=>Q.id),a.success(`è½®æ¬¡ ${R+1}: è·å–åˆ° ${O.models.length} ä¸ªæ¨¡å‹`)):a.warning(O.message||"æœªè·å–åˆ°å¯ç”¨æ¨¡å‹")}catch(O){const Q=O instanceof Error?O.message:"è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥";a.error(Q)}finally{r.value[R]=!1}}async function z(R){const g=h.value[R];if(!g)return;const c=g.provider,p=g.apiKey?.trim(),b=g.modelName?.trim(),T=g.customBaseUrl?.trim();if(!p){a.warning("è¯·å…ˆå¡«å†™ API Key");return}if(!b){a.warning("è¯·å¡«å†™æ¨¡å‹åç§°");return}s.value[R]=!0,a.info(`æ­£åœ¨æµ‹è¯•è½®æ¬¡ ${R+1} çš„è¿æ¥...`);try{const O=await Ne.testAiTranslateConnection({provider:c,apiKey:p,modelName:b,baseUrl:T});O.success?a.success(O.message||"è¿æ¥æˆåŠŸ!"):a.error(O.message||O.error||"è¿æ¥å¤±è´¥")}catch(O){const Q=O instanceof Error?O.message:"è¿æ¥æµ‹è¯•å¤±è´¥";a.error(Q)}finally{s.value[R]=!1}}function N(){const R={name:`ç¬¬${h.value.length+1}è½®æ ¡å¯¹`,provider:"siliconflow",apiKey:"",modelName:"",customBaseUrl:"",batchSize:3,sessionReset:20,rpmLimit:7,lowReasoning:!1,noThinkingMethod:"gemini",forceJsonOutput:!0,prompt:Lo,showApiKey:!1};o.addProofreadingRound(R),a.success("å·²æ·»åŠ æ–°çš„æ ¡å¯¹è½®æ¬¡")}function w(R){if(h.value.length<=1){a.warning("è‡³å°‘éœ€è¦ä¿ç•™ä¸€ä¸ªæ ¡å¯¹è½®æ¬¡");return}o.removeProofreadingRound(R),a.success("å·²åˆ é™¤æ ¡å¯¹è½®æ¬¡")}function A(R){o.updateProofreadingRound(R,{prompt:Lo}),a.success("å·²é‡ç½®ä¸ºé»˜è®¤æç¤ºè¯")}function U(R,g,c){o.updateProofreadingRound(R,{prompt:g}),a.success(`å·²åº”ç”¨æç¤ºè¯: ${c}`)}return(R,g)=>(D(),L("div",tc,[e("div",oc,[g[5]||(g[5]=e("div",{class:"settings-group-title"},"AIæ ¡å¯¹è®¾ç½®",-1)),e("div",nc,[e("label",sc,[se(e("input",{type:"checkbox","onUpdate:modelValue":g[0]||(g[0]=c=>v.value=c)},null,512),[[et,v.value]]),g[2]||(g[2]=Se(" å¯ç”¨AIæ ¡å¯¹ ",-1))]),g[3]||(g[3]=e("div",{class:"input-hint"},"ç¿»è¯‘å®Œæˆåè‡ªåŠ¨è¿›è¡ŒAIæ ¡å¯¹",-1))]),e("div",ac,[g[4]||(g[4]=e("label",{for:"settingsProofreadingMaxRetries"},"å…¨å±€é‡è¯•æ¬¡æ•°:",-1)),se(e("input",{type:"number",id:"settingsProofreadingMaxRetries","onUpdate:modelValue":g[1]||(g[1]=c=>_.value=c),min:"0",max:"10",step:"1"},null,512),[[Ce,_.value,void 0,{number:!0}]])])]),se(e("div",lc,[e("div",{class:"settings-group-title"},[g[6]||(g[6]=Se(" æ ¡å¯¹è½®æ¬¡é…ç½® ",-1)),e("button",{class:"btn btn-secondary btn-sm",onClick:N},"+ æ·»åŠ è½®æ¬¡")]),(D(!0),L(qe,null,Ye(h.value,(c,p)=>(D(),L("div",{key:p,class:"proofreading-round"},[e("div",ic,[e("span",rc,"è½®æ¬¡ "+le(p+1)+": "+le(c.name||"æœªå‘½å"),1),e("button",{class:"btn btn-danger btn-sm",onClick:b=>w(p),disabled:h.value.length<=1}," åˆ é™¤ ",8,uc)]),e("div",cc,[e("div",dc,[g[7]||(g[7]=e("label",null,"è½®æ¬¡åç§°:",-1)),se(e("input",{type:"text","onUpdate:modelValue":b=>c.name=b,placeholder:"å¦‚: ç¬¬ä¸€è½®æ ¡å¯¹"},null,8,gc),[[Ce,c.name]])]),e("div",pc,[e("div",mc,[g[8]||(g[8]=e("label",null,"æœåŠ¡å•†:",-1)),he(Oe,{modelValue:c.provider,"onUpdate:modelValue":b=>c.provider=b,options:t},null,8,["modelValue","onUpdate:modelValue"])]),e("div",vc,[g[9]||(g[9]=e("label",null,"API Key:",-1)),e("div",bc,[se(e("input",{type:c.showApiKey?"text":"password","onUpdate:modelValue":b=>c.apiKey=b,class:"secure-input",placeholder:"è¯·è¾“å…¥API Key",autocomplete:"off"},null,8,fc),[[kt,c.apiKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:b=>c.showApiKey=!c.showApiKey},[c.showApiKey?(D(),L("span",xc,"ğŸ‘â€ğŸ—¨")):(D(),L("span",yc,"ğŸ‘"))],8,hc)])])]),se(e("div",kc,[g[10]||(g[10]=e("label",null,"Base URL:",-1)),se(e("input",{type:"text","onUpdate:modelValue":b=>c.customBaseUrl=b,placeholder:"ä¾‹å¦‚: https://api.example.com/v1"},null,8,_c),[[Ce,c.customBaseUrl]])],512),[[Ae,c.provider==="custom_openai"]]),e("div",Sc,[g[12]||(g[12]=e("label",null,"æ¨¡å‹åç§°:",-1)),e("div",Cc,[se(e("input",{type:"text","onUpdate:modelValue":b=>c.modelName=b,placeholder:"è¯·è¾“å…¥æ¨¡å‹åç§°"},null,8,wc),[[Ce,c.modelName]]),e("button",{type:"button",class:"fetch-models-btn",title:"è·å–å¯ç”¨æ¨¡å‹åˆ—è¡¨",onClick:b=>W(p),disabled:r.value[p]},[g[11]||(g[11]=e("span",{class:"fetch-icon"},"ğŸ”",-1)),e("span",Ic,le(r.value[p]?"è·å–ä¸­...":"è·å–æ¨¡å‹"),1)],8,$c)]),i.value[p]&&i.value[p].length>0?(D(),L("div",Tc,[he(Oe,{modelValue:c.modelName,"onUpdate:modelValue":b=>c.modelName=b,options:$(p)},null,8,["modelValue","onUpdate:modelValue","options"]),e("span",Dc,"å…± "+le(i.value[p].length)+" ä¸ªæ¨¡å‹",1)])):ge("",!0)]),e("div",Rc,[e("button",{class:"settings-test-btn",onClick:b=>z(p),disabled:s.value[p]},le(s.value[p]?"æµ‹è¯•ä¸­...":"ğŸ”— æµ‹è¯•è¿æ¥"),9,Mc)]),e("div",Ec,[e("div",Pc,[g[13]||(g[13]=e("label",null,"æ‰¹æ¬¡å¤§å°:",-1)),se(e("input",{type:"number","onUpdate:modelValue":b=>c.batchSize=b,min:"1",max:"10",step:"1"},null,8,Bc),[[Ce,c.batchSize,void 0,{number:!0}]])]),e("div",Ac,[g[14]||(g[14]=e("label",null,"ä¼šè¯é‡ç½®é¢‘ç‡:",-1)),se(e("input",{type:"number","onUpdate:modelValue":b=>c.sessionReset=b,min:"1",step:"1"},null,8,Fc),[[Ce,c.sessionReset,void 0,{number:!0}]])]),e("div",Lc,[g[15]||(g[15]=e("label",null,"RPMé™åˆ¶:",-1)),se(e("input",{type:"number","onUpdate:modelValue":b=>c.rpmLimit=b,min:"0",step:"1"},null,8,Uc),[[Ce,c.rpmLimit,void 0,{number:!0}]])])]),e("div",Oc,[e("div",zc,[e("label",Nc,[se(e("input",{type:"checkbox","onUpdate:modelValue":b=>c.lowReasoning=b},null,8,Vc),[[et,c.lowReasoning]]),g[16]||(g[16]=Se(" ä½æ¨ç†æ¨¡å¼ ",-1))])]),e("div",Kc,[g[17]||(g[17]=e("label",null,"å–æ¶ˆæ€è€ƒæ–¹æ³•:",-1)),he(Oe,{modelValue:c.noThinkingMethod,"onUpdate:modelValue":b=>c.noThinkingMethod=b,options:l},null,8,["modelValue","onUpdate:modelValue"])]),e("div",Wc,[e("label",qc,[se(e("input",{type:"checkbox","onUpdate:modelValue":b=>c.forceJsonOutput=b},null,8,Hc),[[et,c.forceJsonOutput]]),g[18]||(g[18]=Se(" å¼ºåˆ¶JSONè¾“å‡º ",-1))])])]),e("div",Jc,[g[19]||(g[19]=e("label",null,"æ ¡å¯¹æç¤ºè¯:",-1)),se(e("textarea",{"onUpdate:modelValue":b=>c.prompt=b,rows:"4",placeholder:"æ ¡å¯¹æç¤ºè¯"},null,8,jc),[[Ce,c.prompt]]),he(Tt,{"prompt-type":"proofreading",onSelect:(b,T)=>U(p,b,T)},null,8,["onSelect"]),e("button",{class:"btn btn-secondary btn-sm",onClick:b=>A(p)},"é‡ç½®ä¸ºé»˜è®¤",8,Yc)])])]))),128))],512),[[Ae,v.value]])]))}}),Gc=He(Xc,[["__scopeId","data-v-663a7972"]]),Zc={class:"prompt-library"},Qc={class:"settings-group"},ed={class:"settings-item"},td={key:0,class:"settings-item"},od={class:"mode-hint"},nd={class:"settings-group"},sd={key:0,class:"loading-hint"},ad={key:1,class:"empty-hint"},ld={key:2,class:"prompt-list"},id=["onClick"],rd={class:"prompt-name"},ud={class:"prompt-actions"},cd=["onClick"],dd=["onClick","disabled"],gd={class:"settings-group"},pd={class:"settings-item"},md={class:"settings-item"},vd={class:"prompt-editor-actions"},bd=["disabled"],fd=Je({__name:"PromptLibrary",setup(n){const t=[{label:"ç¿»è¯‘æç¤ºè¯",value:"translate"},{label:"æ–‡æœ¬æ¡†æç¤ºè¯",value:"textbox"},{label:"AIè§†è§‰OCRæç¤ºè¯",value:"ai_vision_ocr"},{label:"é«˜è´¨é‡ç¿»è¯‘æç¤ºè¯",value:"hq_translate"},{label:"æ ¡å¯¹æç¤ºè¯",value:"proofreading"}],l=[{label:"æ™®é€šæ¨¡å¼",value:"false"},{label:"JSONæ ¼å¼æ¨¡å¼",value:"true"}],o=ct(),a=Ve(),r=S("translate"),s=S([]),i=S(""),h=S(""),_=S(""),v=S(!1),$=S(!1),W=Y(()=>r.value==="translate"||r.value==="ai_vision_ocr"),z=Y(()=>$.value?"é€‚ç”¨äºéœ€è¦ç»“æ„åŒ–è¾“å‡ºçš„åœºæ™¯":"é€‚ç”¨äºæ™®é€šç¿»è¯‘åœºæ™¯");async function N(){v.value=!0;try{let p;r.value==="textbox"?p=await Ne.getTextboxPrompts():p=await Ne.getPrompts(r.value);const b=p.prompt_names||[];s.value=b.map(T=>({name:T}))}catch(p){const b=p instanceof Error?p.message:"åŠ è½½æç¤ºè¯åˆ—è¡¨å¤±è´¥";o.error(b)}finally{v.value=!1}}async function w(p){i.value=p,h.value=p,await A(p)}async function A(p){try{let b;r.value==="textbox"?b=await Ne.getTextboxPromptContent(p):b=await Ne.getPromptContent(r.value,p),h.value=p,_.value=b.prompt_content||"",i.value=p,o.success("å·²åŠ è½½æç¤ºè¯")}catch(b){const T=b instanceof Error?b.message:"åŠ è½½æç¤ºè¯å†…å®¹å¤±è´¥";o.error(T)}}async function U(){if(!h.value||!_.value){o.warning("è¯·è¾“å…¥æç¤ºè¯åç§°å’Œå†…å®¹");return}try{r.value==="textbox"?await Ne.saveTextboxPrompt(h.value,_.value):await Ne.savePrompt(r.value,h.value,_.value),o.success("æç¤ºè¯ä¿å­˜æˆåŠŸ"),h.value="",_.value="",await N()}catch(p){const b=p instanceof Error?p.message:"ä¿å­˜æç¤ºè¯å¤±è´¥";o.error(b)}}async function R(p){if(p==="default"){o.warning("é»˜è®¤æç¤ºè¯ä¸èƒ½åˆ é™¤");return}try{r.value==="textbox"?await Ne.deleteTextboxPrompt(p):await Ne.deletePrompt(r.value,p),o.success("æç¤ºè¯åˆ é™¤æˆåŠŸ"),i.value===p&&(i.value="",h.value="",_.value=""),await N()}catch(b){const T=b instanceof Error?b.message:"åˆ é™¤æç¤ºè¯å¤±è´¥";o.error(T)}}function g(){i.value="",h.value="",_.value="",r.value==="translate"?$.value=a.settings.translation.isJsonMode:r.value==="ai_vision_ocr"?$.value=a.settings.aiVisionOcr.isJsonMode:$.value=!1,N()}function c(){r.value==="translate"?a.updateTranslationService({isJsonMode:$.value}):r.value==="ai_vision_ocr"&&a.updateAiVisionOcr({isJsonMode:$.value}),o.info(`å·²åˆ‡æ¢åˆ°${$.value?"JSONæ ¼å¼":"æ™®é€š"}æ¨¡å¼`)}return ut(()=>{$.value=a.settings.translation.isJsonMode,N()}),(p,b)=>(D(),L("div",Zc,[e("div",Qc,[b[6]||(b[6]=e("div",{class:"settings-group-title"},"æç¤ºè¯ç®¡ç†",-1)),e("div",ed,[b[4]||(b[4]=e("label",{for:"promptType"},"æç¤ºè¯ç±»å‹:",-1)),he(Oe,{modelValue:r.value,"onUpdate:modelValue":b[0]||(b[0]=T=>r.value=T),options:t,onChange:g},null,8,["modelValue"])]),W.value?(D(),L("div",td,[b[5]||(b[5]=e("label",{for:"promptMode"},"æç¤ºè¯æ¨¡å¼:",-1)),he(Oe,{"model-value":$.value?"true":"false",options:l,onChange:b[1]||(b[1]=T=>{$.value=T==="true",c()})},null,8,["model-value"]),e("span",od,le(z.value),1)])):ge("",!0)]),e("div",nd,[b[7]||(b[7]=e("div",{class:"settings-group-title"},"å·²ä¿å­˜çš„æç¤ºè¯",-1)),v.value?(D(),L("div",sd,"åŠ è½½ä¸­...")):s.value.length===0?(D(),L("div",ad,"æš‚æ— ä¿å­˜çš„æç¤ºè¯")):(D(),L("div",ld,[(D(!0),L(qe,null,Ye(s.value,T=>(D(),L("div",{key:T.name,class:Me(["prompt-item",{active:i.value===T.name}]),onClick:O=>w(T.name)},[e("span",rd,le(T.name),1),e("div",ud,[e("button",{class:"btn btn-sm",onClick:Qe(O=>A(T.name),["stop"]),title:"åŠ è½½åˆ°ç¼–è¾‘å™¨"},"ğŸ“¥",8,cd),e("button",{class:"btn btn-sm btn-danger",onClick:Qe(O=>R(T.name),["stop"]),title:"åˆ é™¤",disabled:T.name==="default"}," ğŸ—‘ï¸ ",8,dd)])],10,id))),128))]))]),e("div",gd,[b[10]||(b[10]=e("div",{class:"settings-group-title"},"æç¤ºè¯ç¼–è¾‘",-1)),e("div",pd,[b[8]||(b[8]=e("label",{for:"promptName"},"æç¤ºè¯åç§°:",-1)),se(e("input",{type:"text",id:"promptName","onUpdate:modelValue":b[2]||(b[2]=T=>h.value=T),placeholder:"è¯·è¾“å…¥æç¤ºè¯åç§°"},null,512),[[Ce,h.value]])]),e("div",md,[b[9]||(b[9]=e("label",{for:"promptContent"},"æç¤ºè¯å†…å®¹:",-1)),se(e("textarea",{id:"promptContent","onUpdate:modelValue":b[3]||(b[3]=T=>_.value=T),rows:"8",placeholder:"è¯·è¾“å…¥æç¤ºè¯å†…å®¹"},null,512),[[Ce,_.value]])]),e("div",vd,[e("button",{class:"btn btn-primary",onClick:U,disabled:!h.value||!_.value},"ä¿å­˜æç¤ºè¯",8,bd)])])]))}}),hd=He(fd,[["__scopeId","data-v-70f0ec19"]]),yd={class:"plugin-manager"},xd={class:"settings-group"},kd={key:0,class:"loading-hint"},_d={key:1,class:"empty-hint"},Sd={key:2,class:"plugin-list"},Cd={class:"plugin-info"},wd={class:"plugin-header"},$d={class:"plugin-name"},Id={class:"plugin-version"},Td={class:"plugin-description"},Dd={class:"plugin-controls"},Rd={class:"switch"},Md=["checked","onChange"],Ed=["onClick"],Pd=["onClick"],Bd={class:"settings-group"},Ad={class:"plugin-name"},Fd={class:"switch"},Ld=["checked","onChange"],Ud={class:"plugin-config-content"},Od={class:"plugin-config-header"},zd={class:"plugin-config-body"},Nd=["for"],Vd=["id","onUpdate:modelValue"],Kd=["id","onUpdate:modelValue","min","max"],Wd=["id","onUpdate:modelValue","placeholder"],qd={key:4,class:"field-description"},Hd=Je({__name:"PluginManager",setup(n){const t=ct(),l=S([]),o=S({}),a=S(!1),r=S(!1),s=S(null),i=S({}),h=S({});async function _(){a.value=!0;try{const U=await hs();l.value=U.plugins||[]}catch(U){const R=U instanceof Error?U.message:"åŠ è½½æ’ä»¶åˆ—è¡¨å¤±è´¥";t.error(R)}finally{a.value=!1}}async function v(){try{const U=await Is();o.value=U.states||{}}catch(U){console.error("åŠ è½½é»˜è®¤çŠ¶æ€å¤±è´¥:",U)}}async function $(U){try{U.enabled?(await xs(U.name),U.enabled=!1,t.success(`å·²ç¦ç”¨ ${U.display_name||U.name}`)):(await ys(U.name),U.enabled=!0,t.success(`å·²å¯ç”¨ ${U.display_name||U.name}`))}catch(R){const g=R instanceof Error?R.message:"æ“ä½œå¤±è´¥";t.error(g)}}async function W(U,R){const g=R.target,c=g.checked;try{await Ts(U,c),o.value[U]=c,t.success("é»˜è®¤çŠ¶æ€å·²æ›´æ–°")}catch(p){const b=p instanceof Error?p.message:"è®¾ç½®å¤±è´¥";t.error(b),g.checked=!c}}async function z(U){s.value=U;try{const R=await Ds(U.name);i.value=R.schema||{};const g=await Rs(U.name);h.value=g.config||{},r.value=!0}catch(R){const g=R instanceof Error?R.message:"åŠ è½½é…ç½®å¤±è´¥";t.error(g)}}function N(){r.value=!1,s.value=null,i.value={},h.value={}}async function w(){if(s.value)try{await Ms(s.value.name,h.value),t.success("é…ç½®ä¿å­˜æˆåŠŸ"),N()}catch(U){const R=U instanceof Error?U.message:"ä¿å­˜é…ç½®å¤±è´¥";t.error(R)}}async function A(U){if(confirm(`ç¡®å®šè¦åˆ é™¤æ’ä»¶ "${U.display_name||U.name}" å—ï¼Ÿ`))try{await ks(U.name),t.success("æ’ä»¶åˆ é™¤æˆåŠŸ"),await _()}catch(R){const g=R instanceof Error?R.message:"åˆ é™¤æ’ä»¶å¤±è´¥";t.error(g)}}return ut(()=>{_(),v()}),(U,R)=>(D(),L("div",yd,[e("div",xd,[R[1]||(R[1]=e("div",{class:"settings-group-title"},"å·²å®‰è£…æ’ä»¶",-1)),a.value?(D(),L("div",kd,"åŠ è½½ä¸­...")):l.value.length===0?(D(),L("div",_d,"æš‚æ— å·²å®‰è£…çš„æ’ä»¶")):(D(),L("div",Sd,[(D(!0),L(qe,null,Ye(l.value,g=>(D(),L("div",{key:g.name,class:"plugin-item"},[e("div",Cd,[e("div",wd,[e("span",$d,le(g.display_name||g.name),1),e("span",Id,"v"+le(g.version||"1.0.0"),1)]),e("p",Td,le(g.description||"æš‚æ— æè¿°"),1)]),e("div",Dd,[e("label",Rd,[e("input",{type:"checkbox",checked:g.enabled,onChange:c=>$(g)},null,40,Md),R[0]||(R[0]=e("span",{class:"slider"},null,-1))]),g.has_config?(D(),L("button",{key:0,class:"btn btn-sm",onClick:c=>z(g),title:"é…ç½®"},"âš™ï¸",8,Ed)):ge("",!0),e("button",{class:"btn btn-sm btn-danger",onClick:c=>A(g),title:"åˆ é™¤"},"ğŸ—‘ï¸",8,Pd)])]))),128))]))]),e("div",Bd,[R[3]||(R[3]=e("div",{class:"settings-group-title"},"é»˜è®¤å¯ç”¨çŠ¶æ€",-1)),R[4]||(R[4]=e("p",{class:"settings-hint"},"è®¾ç½®æ’ä»¶åœ¨æ–°ä¼šè¯ä¸­çš„é»˜è®¤å¯ç”¨çŠ¶æ€",-1)),(D(!0),L(qe,null,Ye(l.value,g=>(D(),L("div",{key:"default-"+g.name,class:"default-state-item"},[e("span",Ad,le(g.display_name||g.name),1),e("label",Fd,[e("input",{type:"checkbox",checked:o.value[g.name],onChange:c=>W(g.name,c)},null,40,Ld),R[2]||(R[2]=e("span",{class:"slider"},null,-1))])]))),128))]),r.value?(D(),L("div",{key:0,class:"plugin-config-modal",onClick:Qe(N,["self"])},[e("div",Ud,[e("div",Od,[e("h4",null,le(s.value?.display_name||s.value?.name)+" é…ç½®",1),e("span",{class:"close-btn",onClick:N},"Ã—")]),e("div",zd,[(D(!0),L(qe,null,Ye(i.value,(g,c)=>(D(),L("div",{key:c,class:"config-field"},[e("label",{for:"config-"+c},le(g.label||c)+":",9,Nd),g.type==="boolean"?se((D(),L("input",{key:0,type:"checkbox",id:"config-"+c,"onUpdate:modelValue":p=>h.value[c]=p},null,8,Vd)),[[et,h.value[c]]]):g.type==="select"?(D(),st(Oe,{key:1,"model-value":String(h.value[c]??""),options:g.options||[],onChange:p=>{h.value[c]=p}},null,8,["model-value","options","onChange"])):g.type==="number"?se((D(),L("input",{key:2,type:"number",id:"config-"+c,"onUpdate:modelValue":p=>h.value[c]=p,min:g.min,max:g.max},null,8,Kd)),[[Ce,h.value[c],void 0,{number:!0}]]):se((D(),L("input",{key:3,type:"text",id:"config-"+c,"onUpdate:modelValue":p=>h.value[c]=p,placeholder:g.placeholder},null,8,Wd)),[[Ce,h.value[c]]]),g.description?(D(),L("p",qd,le(g.description),1)):ge("",!0)]))),128))]),e("div",{class:"plugin-config-footer"},[e("button",{class:"btn btn-secondary",onClick:N},"å–æ¶ˆ"),e("button",{class:"btn btn-primary",onClick:w},"ä¿å­˜")])])])):ge("",!0)]))}}),Jd=He(Hd,[["__scopeId","data-v-a62393a7"]]),jd={class:"more-settings"},Yd={class:"settings-group"},Xd={class:"settings-item"},Gd={class:"settings-group"},Zd={class:"settings-item"},Qd=["disabled"],eg={key:0,class:"font-count"},tg={class:"settings-item"},og={class:"settings-group"},ng={class:"settings-row"},sg={class:"settings-item"},ag=["disabled"],lg={class:"settings-item"},ig=["disabled"],rg=Je({__name:"MoreSettings",setup(n){const t=[{label:"å‰ç«¯ pdf.js (æ¨è)",value:"frontend"},{label:"åç«¯ PyMuPDF",value:"backend"}],l=Ve(),o=ct(),a=S(!1),r=S([]),s=S(!1),i=S(null),h=S({pdfProcessingMethod:l.settings.pdfProcessingMethod||"frontend"});ye(()=>h.value.pdfProcessingMethod,z=>{l.setPdfProcessingMethod(z)});async function _(){a.value=!0;try{const z=await Ne.getFontList();r.value=z.fonts||[],o.success(`è·å–åˆ° ${r.value.length} ä¸ªå­—ä½“`)}catch(z){const N=z instanceof Error?z.message:"è·å–å­—ä½“åˆ—è¡¨å¤±è´¥";o.error(N)}finally{a.value=!1}}async function v(z){const w=z.target.files?.[0];if(!w)return;const A=[".ttf",".ttc",".otf"],U=w.name.toLowerCase().slice(w.name.lastIndexOf("."));if(!A.includes(U)){o.error("ä¸æ”¯æŒçš„å­—ä½“æ ¼å¼ï¼Œè¯·ä¸Šä¼  .ttf, .ttc æˆ– .otf æ–‡ä»¶");return}try{const R=await Ne.uploadFont(w);R.success?(o.success(`å­—ä½“ "${R.fontPath||w.name}" ä¸Šä¼ æˆåŠŸ`),await _()):o.error(R.error||"å­—ä½“ä¸Šä¼ å¤±è´¥")}catch(R){const g=R instanceof Error?R.message:"å­—ä½“ä¸Šä¼ å¤±è´¥";o.error(g)}finally{i.value&&(i.value.value="")}}async function $(){s.value=!0;try{const z=await ln();z.success?o.success(`å·²æ¸…ç† ${z.deleted_count||0} ä¸ªè°ƒè¯•æ–‡ä»¶`):o.error(z.error||"æ¸…ç†å¤±è´¥")}catch(z){const N=z instanceof Error?z.message:"æ¸…ç†å¤±è´¥";o.error(N)}finally{s.value=!1}}async function W(){s.value=!0;try{const z=await io();z.success?o.success(`å·²æ¸…ç† ${z.deleted_count||0} ä¸ªä¸´æ—¶æ–‡ä»¶`):o.error(z.error||"æ¸…ç†å¤±è´¥")}catch(z){const N=z instanceof Error?z.message:"æ¸…ç†å¤±è´¥";o.error(N)}finally{s.value=!1}}return(z,N)=>(D(),L("div",jd,[e("div",Yd,[N[3]||(N[3]=e("div",{class:"settings-group-title"},"PDFå¤„ç†è®¾ç½®",-1)),e("div",Xd,[N[1]||(N[1]=e("label",{for:"settingsPdfProcessingMethod"},"PDFå¤„ç†æ–¹å¼:",-1)),he(Oe,{modelValue:h.value.pdfProcessingMethod,"onUpdate:modelValue":N[0]||(N[0]=w=>h.value.pdfProcessingMethod=w),options:t},null,8,["modelValue"]),N[2]||(N[2]=e("div",{class:"input-hint"},"å‰ç«¯å¤„ç†é€Ÿåº¦æ›´å¿«ï¼Œåç«¯å¤„ç†å…¼å®¹æ€§æ›´å¥½",-1))])]),e("div",Gd,[N[7]||(N[7]=e("div",{class:"settings-group-title"},"å­—ä½“è®¾ç½®",-1)),e("div",Zd,[N[4]||(N[4]=e("label",null,"ç³»ç»Ÿå­—ä½“åˆ—è¡¨:",-1)),e("button",{class:"btn btn-secondary",onClick:_,disabled:a.value},le(a.value?"åŠ è½½ä¸­...":"ğŸ”„ åˆ·æ–°å­—ä½“åˆ—è¡¨"),9,Qd),r.value.length>0?(D(),L("div",eg,"å…± "+le(r.value.length)+" ä¸ªå­—ä½“",1)):ge("",!0)]),e("div",tg,[N[5]||(N[5]=e("label",null,"ä¸Šä¼ è‡ªå®šä¹‰å­—ä½“:",-1)),e("input",{type:"file",accept:".ttf,.ttc,.otf",onChange:v,ref_key:"fontInput",ref:i},null,544),N[6]||(N[6]=e("div",{class:"input-hint"},"æ”¯æŒ .ttf, .ttc, .otf æ ¼å¼",-1))])]),e("div",og,[N[10]||(N[10]=e("div",{class:"settings-group-title"},"ç¼“å­˜æ¸…ç†",-1)),e("div",ng,[e("div",sg,[e("button",{class:"btn btn-secondary",onClick:$,disabled:s.value},le(s.value?"æ¸…ç†ä¸­...":"ğŸ—‘ï¸ æ¸…ç†è°ƒè¯•æ–‡ä»¶"),9,ag),N[8]||(N[8]=e("div",{class:"input-hint"},"æ¸…ç†è°ƒè¯•è¿‡ç¨‹ä¸­ç”Ÿæˆçš„ä¸´æ—¶æ–‡ä»¶",-1))]),e("div",lg,[e("button",{class:"btn btn-secondary",onClick:W,disabled:s.value},le(s.value?"æ¸…ç†ä¸­...":"ğŸ—‘ï¸ æ¸…ç†ä¸´æ—¶æ–‡ä»¶"),9,ig),N[9]||(N[9]=e("div",{class:"input-hint"},"æ¸…ç†ä¸‹è½½å’Œå¤„ç†è¿‡ç¨‹ä¸­çš„ä¸´æ—¶æ–‡ä»¶",-1))])])]),N[11]||(N[11]=eo('<div class="settings-group" data-v-136fb3b8><div class="settings-group-title" data-v-136fb3b8>å…³äº</div><div class="about-info" data-v-136fb3b8><p data-v-136fb3b8><strong data-v-136fb3b8>Saber-Translator</strong></p><p data-v-136fb3b8>AIé©±åŠ¨çš„æ¼«ç”»ç¿»è¯‘å·¥å…·</p><p class="links" data-v-136fb3b8><a href="http://www.mashirosaber.top" target="_blank" data-v-136fb3b8>ğŸ“– ä½¿ç”¨æ•™ç¨‹</a><a href="https://github.com/MashiroSaber/saber-translator" target="_blank" data-v-136fb3b8>ğŸ™ GitHub</a></p><p class="disclaimer" data-v-136fb3b8>æœ¬é¡¹ç›®å®Œå…¨å¼€æºå…è´¹ï¼Œè¯·å‹¿ä¸Šå½“å—éª—</p></div></div>',1))]))}}),ug=He(rg,[["__scopeId","data-v-136fb3b8"]]),cg={class:"settings-modal-content"},dg={class:"settings-tabs"},gg=["onClick"],pg={class:"settings-tab-content"},mg={class:"settings-tab-pane active"},vg={class:"settings-tab-pane"},bg={class:"settings-tab-pane"},fg={class:"settings-tab-pane"},hg={class:"settings-tab-pane"},yg={class:"settings-tab-pane"},xg={class:"settings-tab-pane"},kg={class:"settings-tab-pane"},_g=Je({__name:"SettingsModal",props:{modelValue:{type:Boolean},initialTab:{}},emits:["update:modelValue","save"],setup(n,{emit:t}){const l=n,o=t,a=Ve(),r=S(l.modelValue),s=S("ocr"),i=[{id:"ocr",label:"OCRè¯†åˆ«"},{id:"translate",label:"ç¿»è¯‘æœåŠ¡"},{id:"detection",label:"æ£€æµ‹è®¾ç½®"},{id:"hq",label:"é«˜è´¨é‡ç¿»è¯‘"},{id:"proofreading",label:"AIæ ¡å¯¹"},{id:"prompt-library",label:"æç¤ºè¯ç®¡ç†"},{id:"plugins",label:"æ’ä»¶ç®¡ç†"},{id:"more",label:"æ›´å¤š"}];ye(()=>l.modelValue,$=>{r.value=$,$?(document.body.style.overflow="hidden",l.initialTab&&i.some(W=>W.id===l.initialTab)&&(s.value=l.initialTab)):(document.body.style.overflow="",s.value="ocr")});function h(){r.value=!1,o("update:modelValue",!1),document.body.style.overflow=""}async function _(){a.saveToStorage();try{await a.saveToBackend(),console.log("[SettingsModal] è®¾ç½®å·²ä¿å­˜åˆ°åç«¯")}catch($){console.warn("[SettingsModal] ä¿å­˜åˆ°åç«¯å¤±è´¥ï¼Œä»…ä¿å­˜åˆ° localStorage:",$)}o("save"),h()}function v($){$.key==="Escape"&&r.value&&h()}return ut(()=>{document.addEventListener("keydown",v)}),Dt(()=>{document.removeEventListener("keydown",v),document.body.style.overflow=""}),($,W)=>r.value?(D(),L("div",{key:0,class:"settings-modal",onClick:Qe(h,["self"])},[e("div",cg,[e("div",{class:"settings-modal-header"},[W[0]||(W[0]=e("h3",null,"âš™ï¸ è®¾ç½®",-1)),e("span",{class:"settings-modal-close",onClick:h},"Ã—")]),e("div",dg,[(D(),L(qe,null,Ye(i,z=>e("button",{key:z.id,class:Me(["settings-tab",{active:s.value===z.id}]),onClick:N=>s.value=z.id},le(z.label),11,gg)),64))]),e("div",pg,[se(e("div",mg,[he(ar)],512),[[Ae,s.value==="ocr"]]),se(e("div",vg,[he(Jr)],512),[[Ae,s.value==="translate"]]),se(e("div",bg,[he(vu)],512),[[Ae,s.value==="detection"]]),se(e("div",fg,[he(ec)],512),[[Ae,s.value==="hq"]]),se(e("div",hg,[he(Gc)],512),[[Ae,s.value==="proofreading"]]),se(e("div",yg,[he(hd)],512),[[Ae,s.value==="prompt-library"]]),se(e("div",xg,[he(Jd)],512),[[Ae,s.value==="plugins"]]),se(e("div",kg,[he(ug)],512),[[Ae,s.value==="more"]])]),e("div",{class:"settings-modal-footer"},[e("button",{class:"btn btn-secondary",onClick:h},"å–æ¶ˆ"),e("button",{class:"btn btn-primary",onClick:_},"ä¿å­˜è®¾ç½®")])])])):ge("",!0)}}),Sg=He(_g,[["__scopeId","data-v-e1ec20ab"]]),Cg={minScale:.1,maxScale:5,zoomSpeed:.1};function tn(n={}){const t={...Cg,...n},l=S(1),o=S(0),a=S(0),r=S(!1),s=S(0),i=S(0),h=Y(()=>({transform:`translate(${o.value}px, ${a.value}px) scale(${l.value})`}));function _(V,G,j){const k=Math.min(Math.max(l.value*j,t.minScale),t.maxScale),y=k/l.value;o.value=V-(V-o.value)*y,a.value=G-(G-a.value)*y,l.value=k,n.onScaleChange?.(l.value),n.onTransformChange?.(b())}function v(V,G=800,j=600){_(G/2,j/2,V)}function $(){v(1.2)}function W(){v(.8)}function z(V,G=800,j=600){const k=V/l.value;_(G/2,j/2,k)}function N(V,G){r.value=!0,s.value=V,i.value=G}function w(V,G){if(!r.value)return;const j=V-s.value,k=G-i.value;o.value+=j,a.value+=k,s.value=V,i.value=G,n.onTransformChange?.(b())}function A(){r.value=!1}function U(V,G){o.value+=V,a.value+=G,n.onTransformChange?.(b())}function R(){l.value=1,o.value=0,a.value=0,n.onScaleChange?.(l.value),n.onTransformChange?.(b())}function g(){R()}function c(){l.value=1,o.value=0,a.value=0}function p(V,G,j,k){if(!V||!G)return;const y=j/V,I=k/G;l.value=Math.min(y,I)*.95,o.value=(j-V*l.value)/2,a.value=(k-G*l.value)/2,n.onScaleChange?.(l.value),n.onTransformChange?.(b())}function b(){return{scale:l.value,translateX:o.value,translateY:a.value}}function T(V){V.scale!==void 0&&(l.value=V.scale),V.translateX!==void 0&&(o.value=V.translateX),V.translateY!==void 0&&(a.value=V.translateY),n.onTransformChange?.(b())}function O(V){l.value=V.scale,o.value=V.translateX,a.value=V.translateY}function Q(V,G,j){if(!V||V.length<4)return;const[k,y,I,f]=V,d=(k+I)/2,m=(y+f)/2,E=G/2,te=j/2;o.value=E-d*l.value,a.value=te-m*l.value,n.onTransformChange?.(b())}return{scale:l,translateX:o,translateY:a,isDragging:r,transformStyle:h,zoomAt:_,zoom:v,zoomIn:$,zoomOut:W,setScale:z,startDrag:N,drag:w,endDrag:A,pan:U,reset:R,resetZoom:g,resetTransform:c,fitToScreen:p,getTransform:b,setTransform:T,syncWith:O,scrollToBubble:Q}}function wg(n){const t=je(),l=Ve(),o=S(null),a=S(Hn),r=S(!1),s=S(!1),i=S([]),h=S(0),_=S(0);let v=null,$=null,W=null;const z=Y(()=>o.value!==null),N=Y(()=>o.value==="repair"?{fill:"rgba(76, 175, 80, 0.4)",border:"#4CAF50"}:o.value==="restore"?{fill:"rgba(33, 150, 243, 0.4)",border:"#2196F3"}:{fill:"transparent",border:"transparent"});function w(m){o.value!==m&&(o.value=m,r.value=!0,i.value=[],console.log(`è¿›å…¥${m==="repair"?"ä¿®å¤":"è¿˜åŸ"}ç¬”åˆ·æ¨¡å¼ï¼Œç¬”åˆ·å¤§å°: ${a.value}px`))}function A(){s.value&&T();const m=o.value!==null;o.value=null,r.value=!1,s.value=!1,i.value=[],G(),m&&console.log("é€€å‡ºç¬”åˆ·æ¨¡å¼")}function U(m){o.value===m?A():w(m)}function R(m){a.value=Math.max(Oo,Math.min(Uo,m))}function g(m){R(a.value+m)}function c(m){if(!z.value)return;m.preventDefault(),m.stopPropagation();const E=m.deltaY>0?-5:5;g(E)}function p(m,E){if(!z.value||m.button!==0)return;m.preventDefault(),m.stopPropagation(),s.value=!0,v=E,i.value=[];const te=O(m,E);te&&(i.value.push(te),V(E),j(te)),console.log("å¼€å§‹ç¬”åˆ·æ¶‚æŠ¹")}function b(m){if(h.value=m.clientX,_.value=m.clientY,!s.value||!z.value)return;const E=O(m,v);E&&(i.value.push(E),j(E))}function T(){if(!s.value)return;s.value=!1;const m=t.currentImage;if(!m||i.value.length===0){G(),i.value=[];return}const E=Q();if(!E){G(),i.value=[];return}const te=o.value;(async()=>{te==="restore"?await k(m,E):te==="repair"&&await y(m,E),n?.onBrushComplete?.()})(),G(),i.value=[]}function O(m,E){if(!E)return null;const te=E.querySelector(".image-canvas-wrapper"),M=te?.querySelector("img");if(!M||!M.naturalWidth)return null;const Z=te.getBoundingClientRect(),B=window.getComputedStyle(te).transform;let x=1;B&&B!=="none"&&(x=new DOMMatrix(B).a);const K=(m.clientX-Z.left)/x,u=(m.clientY-Z.top)/x,C=M.naturalWidth,ue=M.naturalHeight;return K<0||u<0||K>C||u>ue?null:{x:K,y:u,scale:x}}function Q(){if(i.value.length===0)return null;const E=i.value[0]?.scale||1,te=a.value/2/E;let M=1/0,Z=1/0,B=-1/0,x=-1/0;for(const K of i.value)M=Math.min(M,K.x-te),Z=Math.min(Z,K.y-te),B=Math.max(B,K.x+te),x=Math.max(x,K.y+te);return{x1:Math.max(0,Math.floor(M)),y1:Math.max(0,Math.floor(Z)),x2:Math.ceil(B),y2:Math.ceil(x),path:[...i.value],radius:te}}function V(m){G();const E=m.querySelector(".image-canvas-wrapper"),te=E?.querySelector("img");if(!te)return;const M=document.createElement("canvas");M.id="brushOverlayCanvas",M.width=te.naturalWidth,M.height=te.naturalHeight,M.style.cssText="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100;",E.appendChild(M),$=M,W=M.getContext("2d")}function G(){$&&$.parentNode&&$.parentNode.removeChild($),$=null,W=null}function j(m){if(!W||!m)return;const E=N.value.fill,te=a.value/2/(m.scale||1);W.beginPath(),W.arc(m.x,m.y,te,0,Math.PI*2),W.fillStyle=E,W.fill()}async function k(m,E){if(!m.originalDataURL)return;let te;return m.cleanImageData?te="data:image/png;base64,"+m.cleanImageData:te=m.originalDataURL,new Promise(M=>{const Z=new Image,B=new Image;let x=0;const K=()=>{if(x++,x<2)return;const u=document.createElement("canvas");u.width=Z.naturalWidth,u.height=Z.naturalHeight;const C=u.getContext("2d");if(!C){M();return}C.drawImage(Z,0,0);const ue=document.createElement("canvas");ue.width=u.width,ue.height=u.height;const P=ue.getContext("2d");if(!P){M();return}P.fillStyle="white";for(const de of E.path)P.beginPath(),P.arc(de.x,de.y,E.radius,0,Math.PI*2),P.fill();C.globalCompositeOperation="destination-out",C.drawImage(ue,0,0),C.globalCompositeOperation="destination-over",C.drawImage(B,0,0),C.globalCompositeOperation="source-over";const ne=u.toDataURL("image/png").split(",")[1];t.updateCurrentImage({cleanImageData:ne}),console.log("è¿˜åŸç¬”åˆ·åŒºåŸŸå®Œæˆ"),M()};Z.onload=K,Z.onerror=()=>M(),B.onload=K,B.onerror=()=>M(),Z.src=te,B.src=m.originalDataURL})}async function y(m,E){const te=n?.getCurrentRepairSettings?.()||{inpaintMethod:"solid",fillColor:"#FFFFFF"},M=te.inpaintMethod;M==="lama_mpe"||M==="litelama"?await I(m,E,M):await f(m,E,te.fillColor)}async function I(m,E,te="lama_mpe"){let M,Z;if(m.cleanImageData)M=m.cleanImageData,Z="data:image/png;base64,"+m.cleanImageData;else if(m.originalDataURL)M=m.originalDataURL.split(",")[1],Z=m.originalDataURL;else{console.error("æ— æ³•è·å–åŸºç¡€å›¾åƒç”¨äº LAMA ä¿®å¤");return}return new Promise(B=>{const x=new Image;x.onload=async()=>{const K=x.naturalWidth,u=x.naturalHeight,C=document.createElement("canvas");C.width=K,C.height=u;const ue=C.getContext("2d");if(!ue){console.error("æ— æ³•åˆ›å»ºæ©è†œç”»å¸ƒä¸Šä¸‹æ–‡"),B();return}ue.fillStyle="black",ue.fillRect(0,0,K,u),ue.fillStyle="white";for(const Te of E.path)ue.beginPath(),ue.arc(Te.x,Te.y,E.radius,0,Math.PI*2),ue.fill();const ne=C.toDataURL("image/png").split(",")[1],de=[E.x1,E.y1,E.x2,E.y2],we=te==="litelama"?"litelama":"lama_mpe";try{fe("LAMA ä¿®å¤ä¸­...","info");const Te=await co(M,de,{method:"lama",lamaModel:we,maskData:ne});if(Te.success&&Te.inpainted_image)t.updateCurrentImage({cleanImageData:Te.inpainted_image}),console.log("ä¿®å¤ç¬”åˆ·åŒºåŸŸå®Œæˆï¼ˆLAMA ä¿®å¤ï¼Œç²¾ç¡®æ©è†œï¼‰"),fe("LAMA ä¿®å¤å®Œæˆ","success");else throw new Error(Te.error||"LAMA ä¿®å¤è¿”å›æ— æ•ˆæ•°æ®")}catch(Te){console.error("LAMA ä¿®å¤å¤±è´¥ï¼Œå›é€€åˆ°çº¯è‰²å¡«å……:",Te),fe("LAMA ä¿®å¤å¤±è´¥ï¼Œä½¿ç”¨çº¯è‰²å¡«å……","warning");const Fe=n?.getCurrentRepairSettings?.();await f(m,E,Fe?.fillColor)}B()},x.onerror=()=>{console.error("åŠ è½½å›¾åƒå¤±è´¥ï¼Œæ— æ³•è¿›è¡Œ LAMA ä¿®å¤"),B()},x.src=Z})}async function f(m,E,te){const M=te||l.settings.textStyle.fillColor||"#FFFFFF";let Z;if(m.cleanImageData)Z="data:image/png;base64,"+m.cleanImageData;else if(m.originalDataURL)Z=m.originalDataURL;else return;return new Promise(B=>{const x=new Image;x.onload=()=>{const K=document.createElement("canvas");K.width=x.naturalWidth,K.height=x.naturalHeight;const u=K.getContext("2d");if(!u){B();return}u.drawImage(x,0,0),u.fillStyle=M;for(const ue of E.path)u.beginPath(),u.arc(ue.x,ue.y,E.radius,0,Math.PI*2),u.fill();const C=K.toDataURL("image/png").split(",")[1];t.updateCurrentImage({cleanImageData:C}),console.log("ä¿®å¤ç¬”åˆ·åŒºåŸŸå®Œæˆï¼ˆçº¯è‰²å¡«å……ï¼‰"),B()},x.onerror=()=>B(),x.src=Z})}async function d(){const m=t.currentImage;if(!m)return console.warn("ensureCleanBackground: æ²¡æœ‰å½“å‰å›¾ç‰‡"),!1;if(m.cleanImageData)return console.log("ensureCleanBackground: å·²æœ‰å¹²å‡€èƒŒæ™¯"),!0;const E=n?.getCurrentRepairSettings?.();if((E?.inpaintMethod||l.settings.textStyle.inpaintMethod)!=="solid")return console.log("ensureCleanBackground: éçº¯è‰²å¡«å……æ¨¡å¼ï¼Œè·³è¿‡"),!1;if(!m.bubbleStates||m.bubbleStates.length===0)return console.warn("ensureCleanBackground: æ²¡æœ‰æ°”æ³¡æ•°æ®"),!1;if(!m.translatedDataURL&&!m.originalDataURL)return console.warn("ensureCleanBackground: æ²¡æœ‰å›¾ç‰‡æ•°æ®"),!1;console.log("ensureCleanBackground: å°è¯•ä¸ºçº¯è‰²å¡«å……æ¨¡å¼åˆ›å»ºä¸´æ—¶å¹²å‡€èƒŒæ™¯");const M=m.translatedDataURL||m.originalDataURL,Z=E?.fillColor||l.settings.textStyle.fillColor||"#FFFFFF";return new Promise(B=>{const x=new Image;x.onload=()=>{try{const K=document.createElement("canvas");K.width=x.naturalWidth,K.height=x.naturalHeight;const u=K.getContext("2d");if(!u){console.error("ensureCleanBackground: æ— æ³•è·å– Canvas ä¸Šä¸‹æ–‡"),B(!1);return}u.drawImage(x,0,0),u.fillStyle=Z;for(const ue of m.bubbleStates){const[P,ne,de,we]=ue.coords;u.fillRect(P,ne,de-P+1,we-ne+1)}const C=K.toDataURL("image/png").split(",")[1];t.updateCurrentImage({cleanImageData:C}),console.log("ensureCleanBackground: æˆåŠŸåˆ›å»ºä¸´æ—¶å¹²å‡€èƒŒæ™¯ï¼ˆçº¯è‰²å¡«å……ï¼‰"),B(!0)}catch(K){console.error("ensureCleanBackground: Canvas æ“ä½œå¤±è´¥:",K),B(!1)}},x.onerror=()=>{console.error("ensureCleanBackground: åŠ è½½å›¾åƒå¤±è´¥"),B(!1)},x.src=M})}return Dt(()=>{A()}),{brushMode:o,brushSize:a,isBrushKeyDown:r,isBrushPainting:s,mouseX:h,mouseY:_,isActive:z,brushColor:N,BRUSH_MIN_SIZE:Oo,BRUSH_MAX_SIZE:Uo,enterBrushMode:w,exitBrushMode:A,toggleBrushMode:U,setBrushSize:R,adjustBrushSize:g,handleBrushWheel:c,startBrushPainting:p,continueBrushPainting:b,finishBrushPainting:T,getBrushPositionInImage:O,getBrushPathBounds:Q,ensureCleanBackground:d}}function $g(n){return[Math.round(n[0]),Math.round(n[1]),Math.round(n[2]),Math.round(n[3])]}function Ig(n){const t=it(),l=je(),o=Ve(),{bubbles:a,selectedIndex:r,hasSelection:s}=yt(t),{currentImage:i}=yt(l),h=S(!1),_=S(!1),v=S(null),$=S(0),W=S(0),z=S(!1);function N(u){t.selectBubble(u)}function w(u){t.toggleMultiSelect(u)}function A(){t.clearMultiSelect()}function U(u,C){console.log(`å¼€å§‹æ‹–åŠ¨æ°”æ³¡ #${u+1}`)}function R(u,C){}function g(u,C){t.updateBubble(u,{coords:C}),console.log(`æ°”æ³¡ #${u+1} æ‹–åŠ¨å®Œæˆ:`,C),te()}function c(u,C,ue){console.log(`å¼€å§‹è°ƒæ•´æ°”æ³¡ #${u+1} å¤§å°ï¼Œæ‰‹æŸ„: ${C}`)}function p(u){}function b(u,C){t.updateBubble(u,{coords:C}),console.log(`æ°”æ³¡ #${u+1} è°ƒæ•´å¤§å°å®Œæˆ:`,C),te()}function T(u,C){console.log(`å¼€å§‹æ—‹è½¬æ°”æ³¡ #${u+1}`)}function O(u){}function Q(u,C){t.updateBubble(u,{rotationAngle:C}),console.log(`æ°”æ³¡ #${u+1} æ—‹è½¬å®Œæˆ: ${C}Â°`),te()}function V(){h.value=!h.value,h.value?console.log("è¿›å…¥ç»˜åˆ¶æ¨¡å¼"):console.log("é€€å‡ºç»˜åˆ¶æ¨¡å¼")}function G(u){t.addBubble(u),t.selectBubble(t.bubbleCount-1),console.log("å·²æ·»åŠ æ–°æ°”æ³¡:",u),n?.onReRender?.()}function j(u,C){_.value=!0,$.value=u,W.value=C,v.value=[u,C,u,C]}function k(u,C){_.value&&(v.value=[$.value,W.value,u,C])}function y(){if(!_.value||!v.value)return _.value=!1,v.value=null,null;const[u,C,ue,P]=v.value,ne=10;if(Math.abs(ue-u)<ne||Math.abs(P-C)<ne)return _.value=!1,v.value=null,null;const de=[Math.min(u,ue),Math.min(C,P),Math.max(u,ue),Math.max(C,P)];return _.value=!1,v.value=null,de}function I(){_.value=!1,v.value=null,h.value=!1}function f(){if(!v.value)return{};const[u,C,ue,P]=v.value;return{position:"absolute",left:`${Math.min(u,ue)}px`,top:`${Math.min(C,P)}px`,width:`${Math.abs(ue-u)}px`,height:`${Math.abs(P-C)}px`,border:"2px dashed #00d4ff",background:"rgba(0, 212, 255, 0.1)",pointerEvents:"none",zIndex:"25",boxSizing:"border-box"}}let d=null,m=!1;const E=150;function te(){d&&clearTimeout(d),d=setTimeout(async()=>{if(m){console.log("è·³è¿‡æ¸²æŸ“ï¼Œä¸Šä¸€æ¬¡æ¸²æŸ“ä»åœ¨è¿›è¡Œä¸­");return}console.log("è§¦å‘å»¶è¿Ÿæ¸²æŸ“é¢„è§ˆ"),m=!0;try{n?.onDelayedPreview?await n.onDelayedPreview():n?.onReRender&&await n.onReRender()}catch(u){console.error("å»¶è¿Ÿæ¸²æŸ“é¢„è§ˆå¤±è´¥:",u)}finally{m=!1}},E)}function M(u){t.updateSelectedBubble(u),te()}function Z(){s.value&&(t.deleteSelected(),console.log("å·²åˆ é™¤é€‰ä¸­çš„æ°”æ³¡"),n?.onReRender?.())}async function B(){const u=r.value;if(u<0){console.warn("è¯·å…ˆé€‰ä¸­è¦ä¿®å¤çš„æ°”æ³¡æ¡†");return}const C=a.value[u],ue=i.value;if(!C||!ue?.originalDataURL){console.warn("æ— æ³•ä¿®å¤èƒŒæ™¯ï¼šç¼ºå°‘æ°”æ³¡æˆ–å›¾ç‰‡æ•°æ®");return}const P=C.inpaintMethod||"solid",ne=C.fillColor||"#FFFFFF",de=C.rotationAngle||0;try{console.log(`å¼€å§‹ä¿®å¤æ°”æ³¡ #${u+1} èƒŒæ™¯ï¼Œæ–¹æ³•: ${P}`);let we;if(ue.cleanImageData)we=ue.cleanImageData;else{const Fe=ue.originalDataURL.match(/^data:image\/[^;]+;base64,(.+)$/);if(we=Fe&&Fe[1]?Fe[1]:"",!we){console.error("æ— æ³•è§£æå›¾åƒæ•°æ®");return}}if(P==="lama_mpe"||P==="litelama"){const Fe=P==="litelama"?"litelama":"lama_mpe",Ee=$g(C.coords),ae=await co(we,Ee,{bubbleAngle:de,method:"lama",lamaModel:Fe});ae.success&&ae.inpainted_image?(l.updateCurrentImage({cleanImageData:ae.inpainted_image}),console.log(`æ°”æ³¡ #${u+1} LAMAèƒŒæ™¯ä¿®å¤æˆåŠŸ`),te()):(console.error("LAMAä¿®å¤å¤±è´¥:",ae.error||"æœªçŸ¥é”™è¯¯"),await x(C.coords,ne,de),te())}else await x(C.coords,ne,de),console.log(`æ°”æ³¡ #${u+1} çº¯è‰²å¡«å……ä¿®å¤æˆåŠŸ`),te()}catch(we){console.error("èƒŒæ™¯ä¿®å¤å‡ºé”™:",we)}}async function x(u,C,ue=0){const P=i.value;if(!P)return;const[ne,de,we,Te]=u;let Fe;if(P.cleanImageData)Fe="data:image/png;base64,"+P.cleanImageData;else if(P.originalDataURL)Fe=P.originalDataURL;else{console.error("æ— æ³•æ‰¾åˆ°åŸºç¡€å›¾åƒç”¨äºå¡«å……");return}return new Promise(Ee=>{const ae=new Image;ae.onload=()=>{const J=document.createElement("canvas");J.width=ae.naturalWidth,J.height=ae.naturalHeight;const F=J.getContext("2d");if(!F){Ee();return}if(F.drawImage(ae,0,0),F.fillStyle=C,Math.abs(ue)<.1)F.fillRect(ne,de,we-ne,Te-de);else{const ee=(ne+we)/2,re=(de+Te)/2,ve=(we-ne)/2,xe=(Te-de)/2,be=ue*Math.PI/180,pe=Math.cos(be),$e=Math.sin(be),_e=[[-ve,-xe],[ve,-xe],[ve,xe],[-ve,xe]].map(([Le,De])=>[ee+Le*pe-De*$e,re+Le*$e+De*pe]);F.beginPath();const ze=_e[0];if(ze){F.moveTo(ze[0],ze[1]);for(let Le=1;Le<_e.length;Le++){const De=_e[Le];De&&F.lineTo(De[0],De[1])}}F.closePath(),F.fill()}const oe=J.toDataURL("image/png").split(",")[1];l.updateCurrentImage({cleanImageData:oe}),console.log("å·²å¯¹æ°”æ³¡åŒºåŸŸè¿›è¡Œçº¯è‰²å¡«å……:",u,C,"è§’åº¦:",ue),Ee()},ae.onerror=()=>{console.error("åŠ è½½åŸºç¡€å›¾åƒå¤±è´¥"),Ee()},ae.src=Fe})}async function K(u){const C=a.value[u],ue=i.value;if(!C||!ue?.originalDataURL){console.warn("æ— æ³•è¿›è¡Œ OCR è¯†åˆ«ï¼šç¼ºå°‘æ°”æ³¡æˆ–å›¾ç‰‡æ•°æ®");return}try{console.log(`å¼€å§‹ OCR è¯†åˆ«æ°”æ³¡ #${u+1}`);const P=ue.originalDataURL.split(",")[1]||"",ne=o.settings,de=await dn(P,C.coords,ne.ocrEngine||"manga_ocr",{source_language:ne.sourceLanguage,baidu_ocr_api_key:ne.baiduOcr.apiKey,baidu_ocr_secret_key:ne.baiduOcr.secretKey,baidu_version:ne.baiduOcr.version,baidu_source_language:ne.baiduOcr.sourceLanguage,ai_vision_provider:ne.aiVisionOcr.provider,ai_vision_api_key:ne.aiVisionOcr.apiKey,ai_vision_model_name:ne.aiVisionOcr.modelName,ai_vision_ocr_prompt:ne.aiVisionOcr.prompt,custom_ai_vision_base_url:ne.aiVisionOcr.customBaseUrl});de.success&&de.text!==void 0?(t.updateBubble(u,{originalText:de.text}),console.log(`OCR è¯†åˆ«æˆåŠŸ: "${de.text}"`)):console.error("OCR è¯†åˆ«å¤±è´¥:",de.error||"æœªçŸ¥é”™è¯¯")}catch(P){console.error("OCR è¯†åˆ«å‡ºé”™:",P)}}return{isDrawingMode:h,isDrawingBox:_,currentDrawingRect:v,isMiddleButtonDown:z,handleBubbleSelect:N,handleBubbleMultiSelect:w,handleClearMultiSelect:A,handleBubbleDragStart:U,handleBubbleDragging:R,handleBubbleDragEnd:g,handleBubbleResizeStart:c,handleBubbleResizing:p,handleBubbleResizeEnd:b,handleBubbleRotateStart:T,handleBubbleRotating:O,handleBubbleRotateEnd:Q,toggleDrawingMode:V,handleDrawBubble:G,startDrawingBox:j,updateDrawingBox:k,finishDrawingBox:y,cancelDrawing:I,getDrawingRectStyle:f,handleBubbleUpdate:M,deleteSelectedBubbles:Z,repairSelectedBubble:B,triggerDelayedPreview:te,handleOcrRecognize:K}}function Tg(n){const t=it(),l=je(),{bubbles:o}=yt(t),{currentImage:a}=yt(l),r=S(!1),s=S("");let i=null;function h(){const $=a.value;if(!$)return null;if($.cleanImageData)return $.cleanImageData;if($.originalDataURL){const W=$.originalDataURL.match(/^data:image\/[^;]+;base64,(.+)$/);if(W&&W[1])return W[1]}return null}async function _($=!1){if(!a.value)return console.warn("reRenderFullImage: æ²¡æœ‰å½“å‰å›¾ç‰‡"),!1;if(o.value.length===0){console.log("reRenderFullImage: æ²¡æœ‰æ°”æ³¡ï¼Œè·³è¿‡åç«¯æ¸²æŸ“");const w=h();if(w){const A=`data:image/png;base64,${w}`;l.updateCurrentImage({translatedDataURL:A}),$||n?.onRenderSuccess?.(A)}return!0}const z=h();if(!z)return console.error("reRenderFullImage: ç¼ºå°‘å›¾åƒæ•°æ®"),s.value="ç¼ºå°‘å›¾åƒæ•°æ®",$||n?.onRenderError?.("ç¼ºå°‘å›¾åƒæ•°æ®"),!1;const N=Symbol("render");i=N,r.value=!0,s.value="",$||n?.onRenderStart?.();try{console.log("reRenderFullImage: å¼€å§‹é‡æ–°æ¸²æŸ“ï¼Œæ°”æ³¡æ•°é‡:",o.value.length);const w=o.value,A=w.map(c=>c.translatedText||""),U=w.map(c=>c.coords.map(p=>Math.round(p))),R=w.map(c=>({translatedText:c.translatedText||"",coords:c.coords,fontSize:Number(c.fontSize)||24,fontFamily:c.fontFamily||"fonts/STSONG.TTF",textDirection:_t(c),textColor:c.textColor||"#231816",rotationAngle:Math.round(Number(c.rotationAngle)||0),position:c.position?{x:Math.round(c.position.x||0),y:Math.round(c.position.y||0)}:{x:0,y:0},strokeEnabled:c.strokeEnabled!==void 0?c.strokeEnabled:!0,strokeColor:c.strokeColor||"#FFFFFF",strokeWidth:Number(c.strokeWidth)||3})),g=await ro({clean_image:z,bubble_texts:A,bubble_coords:U,bubble_states:R,fontSize:Number(w[0]?.fontSize)||24,fontFamily:w[0]?.fontFamily||"fonts/STSONG.TTF",textDirection:w[0]?_t(w[0]):"vertical",textColor:w[0]?.textColor||"#231816",strokeEnabled:w[0]?.strokeEnabled!==void 0?w[0].strokeEnabled:!0,strokeColor:w[0]?.strokeColor||"#FFFFFF",strokeWidth:Number(w[0]?.strokeWidth)||3,use_individual_styles:!0,use_inpainting:!1,use_lama:!1,is_font_style_change:!0});if(i!==N)return console.log("reRenderFullImage: æ¸²æŸ“ç»“æœå·²è¿‡æœŸï¼Œå¿½ç•¥"),!1;if(g.rendered_image){const c=`data:image/png;base64,${g.rendered_image}`;return l.updateCurrentImage({translatedDataURL:c}),console.log("reRenderFullImage: æ¸²æŸ“æˆåŠŸ"),$||n?.onRenderSuccess?.(c),!0}else{const c=g.error||"æ¸²æŸ“å¤±è´¥";return console.error("reRenderFullImage: æ¸²æŸ“å¤±è´¥ -",c),s.value=c,$||n?.onRenderError?.(c),!1}}catch(w){if(i!==N)return!1;const A=w instanceof Error?w.message:"æ¸²æŸ“è¯·æ±‚å¤±è´¥";return console.error("reRenderFullImage: æ¸²æŸ“å‡ºé”™ -",w),s.value=A,$||n?.onRenderError?.(A),!1}finally{i===N&&(r.value=!1,$||n?.onRenderEnd?.())}}function v(){i=null,r.value=!1}return{isRendering:r,renderError:s,reRenderFullImage:_,cancelRender:v}}const Dg=["data-index","data-coords","data-rotation","onClick","onMousedown"],Rg={class:"bubble-index"},Mg=["data-parent-index","onMousedown"],Eg=["data-parent-index","onMousedown"],Pg=["data-parent-index","onMousedown"],Bg=["data-parent-index","onMousedown"],Ag=["data-parent-index","onMousedown"],Fg=["data-parent-index","onMousedown"],Lg=["data-parent-index","onMousedown"],Ug=["data-parent-index","onMousedown"],Og=["data-parent-index","onMousedown"],zg=Je({__name:"BubbleOverlay",props:{bubbles:{},selectedIndex:{},selectedIndices:{},scale:{},isDrawingMode:{type:Boolean},isBrushMode:{type:Boolean},imageWidth:{},imageHeight:{}},emits:["select","multiSelect","dragStart","dragging","dragEnd","resizeStart","resizing","resizeEnd","rotateStart","rotating","rotateEnd","drawBubble"],setup(n,{emit:t}){const l=it(),{isDragging:o,draggingIndex:a,dragOffsetX:r,dragOffsetY:s,dragInitialX:i,dragInitialY:h,isResizing:_,resizingIndex:v,resizeCurrentCoords:$,isRotating:W,rotatingIndex:z,rotateCurrentAngle:N}=yt(l),w=n,A=t,U=S(null),R=S(0),g=S(0),c=S(""),p=S(0),b=S(0),T=S(null),O=S(0),Q=S(0),V=S(0),G=S(0),j=S(!1),k=S(0),y=S(0),I=S(null),f=S(!1);function d(J,F){let oe,ee,re,ve,xe=J.rotationAngle||0;if(o.value&&a.value===F){const[_e,ze,Le,De]=J.coords;oe=i.value+r.value,ee=h.value+s.value,re=oe+(Le-_e),ve=ee+(De-ze)}else _.value&&v.value===F&&$.value?[oe,ee,re,ve]=$.value:W.value&&z.value===F?([oe,ee,re,ve]=J.coords,xe=N.value):[oe,ee,re,ve]=J.coords;const be=re-oe,pe=ve-ee,$e={left:`${oe}px`,top:`${ee}px`,width:`${be}px`,height:`${pe}px`};return xe&&($e.transformOrigin="center center",$e.transform=`rotate(${xe}deg)`),$e}function m(){if(!I.value)return{};const[J,F,oe,ee]=I.value;return{left:`${Math.min(J,oe)}px`,top:`${Math.min(F,ee)}px`,width:`${Math.abs(oe-J)}px`,height:`${Math.abs(ee-F)}px`}}function E(J){if(!U.value)return null;const F=U.value.getBoundingClientRect(),oe=w.scale||1,ee=(J.clientX-F.left)/oe,re=(J.clientY-F.top)/oe;return{x:ee,y:re}}function te(J,F){w.isBrushMode||F.shiftKey||A("select",J)}function M(J){if(!w.isBrushMode){if(J.button===1){J.preventDefault(),f.value=!0,document.body.classList.add("middle-button-drawing"),we(J);return}J.button===0&&w.isDrawingMode&&we(J)}}function Z(J,F){if(!w.isBrushMode&&F.button===0){if(F.preventDefault(),F.stopPropagation(),F.shiftKey){A("multiSelect",J);return}if(J!==w.selectedIndex){A("select",J);return}B(J,F)}}function B(J,F){document.removeEventListener("mousemove",Ee),document.removeEventListener("mouseup",ae),o.value=!0,a.value=J,R.value=F.clientX,g.value=F.clientY,r.value=0,s.value=0;const oe=w.bubbles[J];oe&&(i.value=oe.coords[0],h.value=oe.coords[1]),A("dragStart",J,F),document.addEventListener("mousemove",Ee),document.addEventListener("mouseup",ae)}function x(J){const F=w.scale||1,oe=(J.clientX-R.value)/F,ee=(J.clientY-g.value)/F;r.value=oe,s.value=ee}function K(J){const F=a.value;o.value=!1,a.value=-1,r.value=0,s.value=0;const oe=w.scale||1,ee=(J.clientX-R.value)/oe,re=(J.clientY-g.value)/oe,ve=w.bubbles[F];if(!ve)return;const[xe,be,pe,$e]=ve.coords,_e=pe-xe,ze=$e-be;let Le=Math.round(i.value+ee),De=Math.round(h.value+re);const Ie=w.imageWidth||2e3,Xe=w.imageHeight||2e3,at=Math.min(_e,Ie),rt=Math.min(ze,Xe);Le=Math.max(0,Math.min(Le,Ie-at)),De=Math.max(0,Math.min(De,Xe-rt));const ke=[Le,De,Le+at,De+rt];A("dragEnd",F,ke)}function u(J,F,oe){if(w.isBrushMode||oe.button!==0)return;oe.preventDefault(),oe.stopPropagation(),document.removeEventListener("mousemove",Ee),document.removeEventListener("mouseup",ae),_.value=!0,v.value=F,c.value=J,p.value=oe.clientX,b.value=oe.clientY;const ee=w.bubbles[F];ee&&(T.value=[...ee.coords],$.value=[...ee.coords]),A("resizeStart",F,J,oe),document.addEventListener("mousemove",Ee),document.addEventListener("mouseup",ae)}function C(J){if(!T.value)return;const F=w.scale||1,oe=(J.clientX-p.value)/F,ee=(J.clientY-b.value)/F;let[re,ve,xe,be]=T.value;const pe=c.value;pe.includes("w")&&(re+=oe),pe.includes("e")&&(xe+=oe),pe.includes("n")&&(ve+=ee),pe.includes("s")&&(be+=ee),re>xe&&([re,xe]=[xe,re]),ve>be&&([ve,be]=[be,ve]);const $e=10;xe-re<$e||be-ve<$e||($.value=[re,ve,xe,be])}function ue(J){if(!T.value)return;const F=w.scale||1,oe=(J.clientX-p.value)/F,ee=(J.clientY-b.value)/F;let[re,ve,xe,be]=T.value;const pe=c.value;pe.includes("w")&&(re+=oe),pe.includes("e")&&(xe+=oe),pe.includes("n")&&(ve+=ee),pe.includes("s")&&(be+=ee),re>xe&&([re,xe]=[xe,re]),ve>be&&([ve,be]=[be,ve]);const $e=w.imageWidth||2e3,_e=w.imageHeight||2e3;re=Math.max(0,Math.round(re)),ve=Math.max(0,Math.round(ve)),xe=Math.min($e,Math.round(xe)),be=Math.min(_e,Math.round(be));const ze=10;if(xe-re<ze||be-ve<ze){console.warn("è°ƒæ•´åå°ºå¯¸è¿‡å°ï¼Œå·²æ’¤é”€"),_.value=!1,v.value=-1,T.value=null;return}A("resizeEnd",v.value,[re,ve,xe,be]),_.value=!1,v.value=-1,T.value=null,$.value=null}function P(J,F){if(w.isBrushMode||F.button!==0)return;F.preventDefault(),F.stopPropagation(),document.removeEventListener("mousemove",Ee),document.removeEventListener("mouseup",ae),W.value=!0,z.value=J;const oe=w.bubbles[J];if(!oe||!U.value)return;const[ee,re,ve,xe]=oe.coords,be=w.scale||1,pe=U.value.getBoundingClientRect();V.value=pe.left+(ee+ve)/2*be,G.value=pe.top+(re+xe)/2*be;const $e=F.clientX-V.value,_e=F.clientY-G.value;O.value=Math.atan2(_e,$e)*180/Math.PI,Q.value=oe.rotationAngle||0,N.value=oe.rotationAngle||0,A("rotateStart",J,F),document.body.classList.add("rotating-box"),document.addEventListener("mousemove",Ee),document.addEventListener("mouseup",ae),console.log(`å¼€å§‹æ—‹è½¬æ°”æ³¡ #${J+1}ï¼Œåˆå§‹è§’åº¦: ${Q.value}Â°`)}function ne(J){const F=J.clientX-V.value,oe=J.clientY-G.value,re=Math.atan2(oe,F)*180/Math.PI-O.value;let ve=Q.value+re;for(;ve>180;)ve-=360;for(;ve<-180;)ve+=360;J.shiftKey&&(ve=Math.round(ve/15)*15),N.value=ve}function de(J){document.body.classList.remove("rotating-box");const F=z.value,oe=N.value;A("rotateEnd",F,oe),W.value=!1,z.value=-1,console.log(`æ°”æ³¡ #${F+1} æ—‹è½¬å®Œæˆï¼Œè§’åº¦: ${oe}Â°`)}function we(J){const F=E(J);if(!F)return;const oe=w.imageWidth||2e3,ee=w.imageHeight||2e3;F.x<0||F.x>oe||F.y<0||F.y>ee||(j.value=!0,k.value=F.x,y.value=F.y,I.value=[F.x,F.y,F.x,F.y],document.addEventListener("mousemove",Ee),document.addEventListener("mouseup",ae),console.log("å¼€å§‹ç»˜åˆ¶æ–°æ¡†:",F.x.toFixed(1),F.y.toFixed(1)))}function Te(J){const F=E(J);!F||!I.value||(I.value=[k.value,y.value,F.x,F.y])}function Fe(J){const F=E(J);if(f.value&&(f.value=!1,document.body.classList.remove("middle-button-drawing")),!F||!I.value){j.value=!1,I.value=null;return}const oe=w.imageWidth||2e3,ee=w.imageHeight||2e3,re=Math.max(0,Math.round(Math.min(k.value,F.x))),ve=Math.max(0,Math.round(Math.min(y.value,F.y))),xe=Math.min(oe,Math.round(Math.max(k.value,F.x))),be=Math.min(ee,Math.round(Math.max(y.value,F.y))),pe=10;if(xe-re<pe||be-ve<pe){console.log("ç»˜åˆ¶çš„æ¡†å¤ªå°ï¼Œå·²å¿½ç•¥"),j.value=!1,I.value=null;return}console.log("å®Œæˆç»˜åˆ¶æ–°æ¡†:",[re,ve,xe,be]),A("drawBubble",[re,ve,xe,be]),j.value=!1,I.value=null}function Ee(J){o.value?x(J):_.value?C(J):W.value?ne(J):j.value&&Te(J)}function ae(J){document.removeEventListener("mousemove",Ee),document.removeEventListener("mouseup",ae),(J.button===1||f.value)&&(f.value=!1,document.body.classList.remove("middle-button-drawing")),o.value?K(J):_.value?ue(J):W.value?de():j.value&&Fe(J)}return ut(()=>{}),Dt(()=>{document.removeEventListener("mousemove",Ee),document.removeEventListener("mouseup",ae),document.body.classList.remove("middle-button-drawing"),document.body.classList.remove("rotating-box")}),(J,F)=>(D(),L("div",{class:Me(["bubble-overlay",{"brush-mode":n.isBrushMode}]),ref_key:"overlayRef",ref:U,onMousedown:M},[(D(!0),L(qe,null,Ye(n.bubbles,(oe,ee)=>(D(),L("div",{key:ee,class:Me(["bubble-highlight-box",{selected:ee===n.selectedIndex,"multi-selected":n.selectedIndices.length>1&&n.selectedIndices.includes(ee)&&ee!==n.selectedIndex}]),style:nt(d(oe,ee)),"data-index":ee,"data-coords":JSON.stringify(oe.coords),"data-rotation":oe.rotationAngle||0,onClick:Qe(re=>te(ee,re),["stop"]),onMousedown:Qe(re=>Z(ee,re),["stop"])},[e("span",Rg,le(ee+1),1),ee===n.selectedIndex?(D(),L(qe,{key:0},[e("div",{class:"resize-handle nw","data-handle":"nw","data-parent-index":ee,onMousedown:Qe(re=>u("nw",ee,re),["stop"])},null,40,Mg),e("div",{class:"resize-handle n","data-handle":"n","data-parent-index":ee,onMousedown:Qe(re=>u("n",ee,re),["stop"])},null,40,Eg),e("div",{class:"resize-handle ne","data-handle":"ne","data-parent-index":ee,onMousedown:Qe(re=>u("ne",ee,re),["stop"])},null,40,Pg),e("div",{class:"resize-handle e","data-handle":"e","data-parent-index":ee,onMousedown:Qe(re=>u("e",ee,re),["stop"])},null,40,Bg),e("div",{class:"resize-handle se","data-handle":"se","data-parent-index":ee,onMousedown:Qe(re=>u("se",ee,re),["stop"])},null,40,Ag),e("div",{class:"resize-handle s","data-handle":"s","data-parent-index":ee,onMousedown:Qe(re=>u("s",ee,re),["stop"])},null,40,Fg),e("div",{class:"resize-handle sw","data-handle":"sw","data-parent-index":ee,onMousedown:Qe(re=>u("sw",ee,re),["stop"])},null,40,Lg),e("div",{class:"resize-handle w","data-handle":"w","data-parent-index":ee,onMousedown:Qe(re=>u("w",ee,re),["stop"])},null,40,Ug),F[0]||(F[0]=e("div",{class:"rotate-line"},null,-1)),e("div",{class:"rotate-handle",title:"æ‹–æ‹½æ—‹è½¬","data-parent-index":ee,onMousedown:Qe(re=>P(ee,re),["stop"])},null,40,Og)],64)):ge("",!0)],46,Dg))),128)),I.value?(D(),L("div",{key:0,class:"drawing-rect",style:nt(m())},null,4)):ge("",!0)],34))}}),on=He(zg,[["__scopeId","data-v-a3e510ac"]]),Ng={key:0,class:"kana-keyboard"},Vg={class:"kana-keyboard-header"},Kg={class:"kana-keyboard-tabs"},Wg=["onClick"],qg={class:"kana-keyboard-options"},Hg={class:"kana-mode-select"},Jg={class:"kana-target-select"},jg={class:"kana-table"},Yg={class:"row-label"},Xg=["onClick"],Gg={class:"kana-hiragana"},Zg={class:"kana-katakana"},Qg={class:"kana-table"},ep={class:"row-label"},tp=["onClick"],op={class:"kana-hiragana"},np={class:"kana-katakana"},sp={class:"kana-table combo-table"},ap={class:"row-label"},lp=["onClick"],ip={class:"kana-hiragana"},rp={class:"kana-katakana"},up={class:"special-chars-grid"},cp=["onClick"],dp={key:0,class:"char-label"},gp=Je({__name:"JapaneseKeyboard",props:{visible:{type:Boolean,default:!1},defaultTarget:{default:"original"}},emits:["close","insert","delete"],setup(n,{emit:t}){const l=n,o=t,a=S("basic"),r=S("hiragana"),s=S(l.defaultTarget),i=S(null),h=[{label:"åŸæ–‡",value:"original"},{label:"è¯‘æ–‡",value:"translated"}],_=[{id:"basic",label:"åŸºæœ¬"},{id:"dakuten",label:"æµŠ/åŠæµŠéŸ³"},{id:"combo",label:"æ‹—éŸ³"},{id:"special",label:"ç‰¹æ®Š"}],v=[{label:"ã‚è¡Œ",chars:[{h:"ã‚",k:"ã‚¢"},{h:"ã„",k:"ã‚¤"},{h:"ã†",k:"ã‚¦"},{h:"ãˆ",k:"ã‚¨"},{h:"ãŠ",k:"ã‚ª"}]},{label:"ã‹è¡Œ",chars:[{h:"ã‹",k:"ã‚«"},{h:"ã",k:"ã‚­"},{h:"ã",k:"ã‚¯"},{h:"ã‘",k:"ã‚±"},{h:"ã“",k:"ã‚³"}]},{label:"ã•è¡Œ",chars:[{h:"ã•",k:"ã‚µ"},{h:"ã—",k:"ã‚·"},{h:"ã™",k:"ã‚¹"},{h:"ã›",k:"ã‚»"},{h:"ã",k:"ã‚½"}]},{label:"ãŸè¡Œ",chars:[{h:"ãŸ",k:"ã‚¿"},{h:"ã¡",k:"ãƒ"},{h:"ã¤",k:"ãƒ„"},{h:"ã¦",k:"ãƒ†"},{h:"ã¨",k:"ãƒˆ"}]},{label:"ãªè¡Œ",chars:[{h:"ãª",k:"ãƒŠ"},{h:"ã«",k:"ãƒ‹"},{h:"ã¬",k:"ãƒŒ"},{h:"ã­",k:"ãƒ"},{h:"ã®",k:"ãƒ"}]},{label:"ã¯è¡Œ",chars:[{h:"ã¯",k:"ãƒ"},{h:"ã²",k:"ãƒ’"},{h:"ãµ",k:"ãƒ•"},{h:"ã¸",k:"ãƒ˜"},{h:"ã»",k:"ãƒ›"}]},{label:"ã¾è¡Œ",chars:[{h:"ã¾",k:"ãƒ"},{h:"ã¿",k:"ãƒŸ"},{h:"ã‚€",k:"ãƒ "},{h:"ã‚",k:"ãƒ¡"},{h:"ã‚‚",k:"ãƒ¢"}]},{label:"ã‚„è¡Œ",chars:[{h:"ã‚„",k:"ãƒ¤"},null,{h:"ã‚†",k:"ãƒ¦"},null,{h:"ã‚ˆ",k:"ãƒ¨"}]},{label:"ã‚‰è¡Œ",chars:[{h:"ã‚‰",k:"ãƒ©"},{h:"ã‚Š",k:"ãƒª"},{h:"ã‚‹",k:"ãƒ«"},{h:"ã‚Œ",k:"ãƒ¬"},{h:"ã‚",k:"ãƒ­"}]},{label:"ã‚è¡Œ",chars:[{h:"ã‚",k:"ãƒ¯"},null,null,null,{h:"ã‚’",k:"ãƒ²"}]},{label:"ã‚“",chars:[{h:"ã‚“",k:"ãƒ³"},null,null,null,null]}],$=[{label:"ãŒè¡Œ",chars:[{h:"ãŒ",k:"ã‚¬"},{h:"ã",k:"ã‚®"},{h:"ã",k:"ã‚°"},{h:"ã’",k:"ã‚²"},{h:"ã”",k:"ã‚´"}]},{label:"ã–è¡Œ",chars:[{h:"ã–",k:"ã‚¶"},{h:"ã˜",k:"ã‚¸"},{h:"ãš",k:"ã‚º"},{h:"ãœ",k:"ã‚¼"},{h:"ã",k:"ã‚¾"}]},{label:"ã è¡Œ",chars:[{h:"ã ",k:"ãƒ€"},{h:"ã¢",k:"ãƒ‚"},{h:"ã¥",k:"ãƒ…"},{h:"ã§",k:"ãƒ‡"},{h:"ã©",k:"ãƒ‰"}]},{label:"ã°è¡Œ",chars:[{h:"ã°",k:"ãƒ"},{h:"ã³",k:"ãƒ“"},{h:"ã¶",k:"ãƒ–"},{h:"ã¹",k:"ãƒ™"},{h:"ã¼",k:"ãƒœ"}]},{label:"ã±è¡Œ",chars:[{h:"ã±",k:"ãƒ‘"},{h:"ã´",k:"ãƒ”"},{h:"ã·",k:"ãƒ—"},{h:"ãº",k:"ãƒš"},{h:"ã½",k:"ãƒ"}]}],W=[{label:"ãã‚ƒè¡Œ",chars:[{h:"ãã‚ƒ",k:"ã‚­ãƒ£"},{h:"ãã‚…",k:"ã‚­ãƒ¥"},{h:"ãã‚‡",k:"ã‚­ãƒ§"}]},{label:"ã—ã‚ƒè¡Œ",chars:[{h:"ã—ã‚ƒ",k:"ã‚·ãƒ£"},{h:"ã—ã‚…",k:"ã‚·ãƒ¥"},{h:"ã—ã‚‡",k:"ã‚·ãƒ§"}]},{label:"ã¡ã‚ƒè¡Œ",chars:[{h:"ã¡ã‚ƒ",k:"ãƒãƒ£"},{h:"ã¡ã‚…",k:"ãƒãƒ¥"},{h:"ã¡ã‚‡",k:"ãƒãƒ§"}]},{label:"ã«ã‚ƒè¡Œ",chars:[{h:"ã«ã‚ƒ",k:"ãƒ‹ãƒ£"},{h:"ã«ã‚…",k:"ãƒ‹ãƒ¥"},{h:"ã«ã‚‡",k:"ãƒ‹ãƒ§"}]},{label:"ã²ã‚ƒè¡Œ",chars:[{h:"ã²ã‚ƒ",k:"ãƒ’ãƒ£"},{h:"ã²ã‚…",k:"ãƒ’ãƒ¥"},{h:"ã²ã‚‡",k:"ãƒ’ãƒ§"}]},{label:"ã¿ã‚ƒè¡Œ",chars:[{h:"ã¿ã‚ƒ",k:"ãƒŸãƒ£"},{h:"ã¿ã‚…",k:"ãƒŸãƒ¥"},{h:"ã¿ã‚‡",k:"ãƒŸãƒ§"}]},{label:"ã‚Šã‚ƒè¡Œ",chars:[{h:"ã‚Šã‚ƒ",k:"ãƒªãƒ£"},{h:"ã‚Šã‚…",k:"ãƒªãƒ¥"},{h:"ã‚Šã‚‡",k:"ãƒªãƒ§"}]},{label:"ãã‚ƒè¡Œ",chars:[{h:"ãã‚ƒ",k:"ã‚®ãƒ£"},{h:"ãã‚…",k:"ã‚®ãƒ¥"},{h:"ãã‚‡",k:"ã‚®ãƒ§"}]},{label:"ã˜ã‚ƒè¡Œ",chars:[{h:"ã˜ã‚ƒ",k:"ã‚¸ãƒ£"},{h:"ã˜ã‚…",k:"ã‚¸ãƒ¥"},{h:"ã˜ã‚‡",k:"ã‚¸ãƒ§"}]},{label:"ã³ã‚ƒè¡Œ",chars:[{h:"ã³ã‚ƒ",k:"ãƒ“ãƒ£"},{h:"ã³ã‚…",k:"ãƒ“ãƒ¥"},{h:"ã³ã‚‡",k:"ãƒ“ãƒ§"}]},{label:"ã´ã‚ƒè¡Œ",chars:[{h:"ã´ã‚ƒ",k:"ãƒ”ãƒ£"},{h:"ã´ã‚…",k:"ãƒ”ãƒ¥"},{h:"ã´ã‚‡",k:"ãƒ”ãƒ§"}]}],z=[{char:"ã£",label:"ä¿ƒéŸ³"},{char:"ãƒƒ",label:"ä¿ƒéŸ³"},{char:"ãƒ¼",label:"é•¿éŸ³"},{char:"ã€œ",label:"æ³¢æµª"},{char:"ã€‚",label:"å¥å·"},{char:"ã€",label:"é¡¿å·"},{char:"ã€Œ",label:"å¼•å·"},{char:"ã€",label:"å¼•å·"},{char:"ã€",label:"åŒå¼•"},{char:"ã€",label:"åŒå¼•"},{char:"â€¦",label:"çœç•¥"},{char:"ãƒ»",label:"ä¸­ç‚¹"},{char:"ï¼",label:"æ„Ÿå¹"},{char:"ï¼Ÿ",label:"é—®å·"},{char:"â™ª",label:"éŸ³ç¬¦"},{char:"â™¡",label:"å¿ƒå½¢"},{char:"â˜…",label:"æ˜Ÿå½¢"},{char:"â˜†",label:"ç©ºæ˜Ÿ"},{char:"ã",label:"å°ã‚"},{char:"ãƒ",label:"å°ã„"},{char:"ã…",label:"å°ã†"},{char:"ã‡",label:"å°ãˆ"},{char:"ã‰",label:"å°ãŠ"},{char:"ã‚¡",label:"å°ã‚¢"},{char:"ã‚£",label:"å°ã‚¤"},{char:"ã‚¥",label:"å°ã‚¦"},{char:"ã‚§",label:"å°ã‚¨"},{char:"ã‚©",label:"å°ã‚ª"},{char:"ã‚ƒ",label:"å°ã‚„"},{char:"ã‚…",label:"å°ã‚†"},{char:"ã‚‡",label:"å°ã‚ˆ"},{char:"ãƒ£",label:"å°ãƒ¤"},{char:"ãƒ¥",label:"å°ãƒ¦"},{char:"ãƒ§",label:"å°ãƒ¨"}];function N(){o("close")}function w(R){const g=r.value==="hiragana"?R.h:R.k;i.value=R.h,setTimeout(()=>{i.value=null},100),o("insert",g,s.value)}function A(R){i.value=R,setTimeout(()=>{i.value=null},100),o("insert",R,s.value)}function U(){o("delete",s.value)}return(R,g)=>n.visible?(D(),L("div",Ng,[e("div",Vg,[g[3]||(g[3]=e("span",{class:"kana-keyboard-title"},"50éŸ³é”®ç›˜",-1)),e("div",Kg,[(D(),L(qe,null,Ye(_,c=>e("button",{key:c.id,class:Me(["kana-tab",{active:a.value===c.id}]),onClick:p=>a.value=c.id},le(c.label),11,Wg)),64))]),e("button",{class:"kana-keyboard-close",onClick:N},"âœ•")]),e("div",qg,[e("div",Hg,[e("label",null,[se(e("input",{type:"radio",name:"kanaMode",value:"hiragana","onUpdate:modelValue":g[0]||(g[0]=c=>r.value=c)},null,512),[[Wo,r.value]]),g[4]||(g[4]=Se(" å¹³å‡å ",-1))]),e("label",null,[se(e("input",{type:"radio",name:"kanaMode",value:"katakana","onUpdate:modelValue":g[1]||(g[1]=c=>r.value=c)},null,512),[[Wo,r.value]]),g[5]||(g[5]=Se(" ç‰‡å‡å ",-1))])]),e("div",Jg,[g[6]||(g[6]=e("label",null,"è¾“å…¥åˆ°ï¼š",-1)),he(Oe,{modelValue:s.value,"onUpdate:modelValue":g[2]||(g[2]=c=>s.value=c),options:h},null,8,["modelValue"])])]),e("div",{class:Me(["kana-tab-content",{active:a.value==="basic"}])},[e("table",jg,[g[7]||(g[7]=e("thead",null,[e("tr",null,[e("th"),e("th",null,"ã‚æ®µ"),e("th",null,"ã„æ®µ"),e("th",null,"ã†æ®µ"),e("th",null,"ãˆæ®µ"),e("th",null,"ãŠæ®µ")])],-1)),e("tbody",null,[(D(),L(qe,null,Ye(v,c=>e("tr",{key:c.label},[e("td",Yg,le(c.label),1),(D(!0),L(qe,null,Ye(c.chars,(p,b)=>(D(),L("td",{key:b},[p?(D(),L("button",{key:0,class:Me(["kana-key",{pressed:i.value===p.h}]),onClick:T=>w(p)},[e("span",Gg,le(p.h),1),e("span",Zg,le(p.k),1)],10,Xg)):ge("",!0)]))),128))])),64))])])],2),e("div",{class:Me(["kana-tab-content",{active:a.value==="dakuten"}])},[e("table",Qg,[g[8]||(g[8]=e("thead",null,[e("tr",null,[e("th"),e("th",null,"ã‚æ®µ"),e("th",null,"ã„æ®µ"),e("th",null,"ã†æ®µ"),e("th",null,"ãˆæ®µ"),e("th",null,"ãŠæ®µ")])],-1)),e("tbody",null,[(D(),L(qe,null,Ye($,c=>e("tr",{key:c.label},[e("td",ep,le(c.label),1),(D(!0),L(qe,null,Ye(c.chars,(p,b)=>(D(),L("td",{key:b},[p?(D(),L("button",{key:0,class:Me(["kana-key",{pressed:i.value===p.h}]),onClick:T=>w(p)},[e("span",op,le(p.h),1),e("span",np,le(p.k),1)],10,tp)):ge("",!0)]))),128))])),64))])])],2),e("div",{class:Me(["kana-tab-content",{active:a.value==="combo"}])},[e("table",sp,[g[9]||(g[9]=e("thead",null,[e("tr",null,[e("th"),e("th",null,"ã‚ƒ"),e("th",null,"ã‚…"),e("th",null,"ã‚‡")])],-1)),e("tbody",null,[(D(),L(qe,null,Ye(W,c=>e("tr",{key:c.label},[e("td",ap,le(c.label),1),(D(!0),L(qe,null,Ye(c.chars,(p,b)=>(D(),L("td",{key:b},[p?(D(),L("button",{key:0,class:Me(["kana-key",{pressed:i.value===p.h}]),onClick:T=>w(p)},[e("span",ip,le(p.h),1),e("span",rp,le(p.k),1)],10,lp)):ge("",!0)]))),128))])),64))])])],2),e("div",{class:Me(["kana-tab-content",{active:a.value==="special"}])},[e("div",up,[(D(),L(qe,null,Ye(z,c=>e("button",{key:c.char,class:Me(["kana-key special-key",{pressed:i.value===c.char}]),onClick:p=>A(c.char)},[Se(le(c.char)+" ",1),c.label?(D(),L("span",dp,le(c.label),1)):ge("",!0)],10,cp)),64))])],2),e("div",{class:"kana-keyboard-footer"},[e("button",{class:"kana-backspace",onClick:U},"âŒ« é€€æ ¼")])])):ge("",!0)}}),pp=He(gp,[["__scopeId","data-v-ebfc2125"]]),mp={class:"edit-panel-content"},vp={class:"text-column original-text-column text-block"},bp={class:"text-column translated-text-column text-block"},fp={class:"style-settings-section text-block"},hp={class:"office-toolbar"},yp={class:"toolbar-row toolbar-row-top"},xp={class:"combo-control font-control"},kp={class:"combo-control size-control"},_p={class:"size-input-wrap"},Sp=["min","max","step"],Cp={class:"toolbar-row toolbar-row-actions"},wp={class:"toolbar-icon-group","aria-label":"æ’ç‰ˆæ–¹å‘"},$p=["data-active"],Ip=["data-active"],Tp={class:"toolbar-color-group"},Dp={class:"toolbar-color-picker",title:"æ–‡å­—é¢œè‰²"},Rp={class:"toolbar-inpaint-group",title:"èƒŒæ™¯ä¿®å¤æ–¹å¼"},Mp={class:"toolbar-stroke-cluster"},Ep=["data-active"],Pp={class:"toolbar-row toolbar-row-bottom"},Bp={class:"toolbar-rotation-group",title:"æ—‹è½¬è§’åº¦"},Ap={class:"toolbar-position-group",title:"ä½ç½®è°ƒæ•´"},Fp={class:"toolbar-position-value"},Lp={class:"fontsize-presets-panel"},Up={class:"font-size-presets"},Op=["onClick"],Bt=2,zp=Je({__name:"BubbleEditor",props:{bubble:{},bubbleIndex:{}},emits:["update","reRender","ocrRecognize","reTranslate","applyBubble","resetCurrent"],setup(n,{emit:t}){const l=n,o=t,a=it(),r={originalText:"",translatedText:"",fontSize:24,fontFamily:"fonts/STSONG.TTF",textDirection:"auto",textColor:"#231816",fillColor:"#FFFFFF",strokeEnabled:!0,strokeColor:"#FFFFFF",strokeWidth:3,rotationAngle:0,inpaintMethod:"solid",position:{x:0,y:0}},s=S(""),i=S(""),h=S(24),_=S("fonts/STSONG.TTF"),v=S("auto"),$=S("#231816"),W=S("#FFFFFF"),z=S(!0),N=S("#FFFFFF"),w=S(3),A=S(0),U=S("solid"),R=S(0),g=S(0),c=S(null),p=S(null),b=S(null),T=S(null),O=S(null),Q=S(!1),V=S("original"),G=S([{name:"åæ–‡å®‹ä½“",path:"fonts/STSONG.TTF"},{name:"åæ–‡æ¥·ä½“",path:"fonts/STKAITI.TTF"},{name:"åæ–‡ç»†é»‘",path:"fonts/STXIHEI.TTF"},{name:"é»‘ä½“",path:"fonts/SIMHEI.TTF"},{name:"å®‹ä½“",path:"fonts/SIMSUN.TTC"}]),j=S([]),k=Y(()=>l.bubble?l.bubble.coords[0]+R.value:0),y=Y(()=>l.bubble?l.bubble.coords[1]+g.value:0),I=Y(()=>{const ke=[{label:"ç³»ç»Ÿå­—ä½“",options:G.value.map(X=>({label:X.name,value:X.path}))}];return j.value.length>0&&ke.push({label:"è‡ªå®šä¹‰å­—ä½“",options:j.value.map(X=>({label:X.name,value:X.path}))}),ke}),f=[{label:"çº¯è‰²å¡«å……",value:"solid"},{label:"LAMAä¿®å¤(æ¼«ç”»)",value:"lama_mpe"},{label:"LAMAä¿®å¤(é€šç”¨)",value:"litelama"}];function d(ke){const X=ke||r;s.value=X.originalText,i.value=X.translatedText,h.value=X.fontSize,_.value=X.fontFamily,v.value=X.textDirection,$.value=X.textColor,W.value=X.fillColor,z.value=X.strokeEnabled,N.value=X.strokeColor,w.value=X.strokeWidth,A.value=X.rotationAngle,U.value=X.inpaintMethod,R.value=X.position?.x||0,g.value=X.position?.y||0}ye(()=>l.bubble,ke=>{d(ke)},{deep:!0,immediate:!0});function m(){o("update",{originalText:s.value})}function E(){o("update",{translatedText:i.value})}function te(){navigator.clipboard.writeText(s.value)}function M(){navigator.clipboard.writeText(i.value)}function Z(){o("update",{fontSize:h.value})}function B(ke){h.value=ke,o("update",{fontSize:ke})}function x(){h.value=Math.min(zo,h.value+Gt),o("update",{fontSize:h.value})}function K(){h.value=Math.max(No,h.value-Gt),o("update",{fontSize:h.value})}function u(){o("update",{fontFamily:_.value})}function C(ke){v.value=ke,o("update",{textDirection:ke})}function ue(){b.value?.click()}function P(){o("update",{textColor:$.value})}function ne(){T.value?.click()}function de(){o("update",{fillColor:W.value})}function we(){O.value?.click()}function Te(){o("update",{strokeColor:N.value})}function Fe(){z.value=!z.value,o("update",{strokeEnabled:z.value})}function Ee(){o("update",{strokeWidth:w.value})}function ae(){o("update",{inpaintMethod:U.value})}function J(){o("update",{rotationAngle:A.value})}function F(){A.value=Math.max(-180,A.value-5),o("update",{rotationAngle:A.value})}function oe(){A.value=Math.min(180,A.value+5),o("update",{rotationAngle:A.value})}function ee(){A.value=0,o("update",{rotationAngle:0})}function re(){R.value-=Bt,o("update",{position:{x:R.value,y:g.value}})}function ve(){R.value+=Bt,o("update",{position:{x:R.value,y:g.value}})}function xe(){g.value-=Bt,o("update",{position:{x:R.value,y:g.value}})}function be(){g.value+=Bt,o("update",{position:{x:R.value,y:g.value}})}function pe(){R.value=0,g.value=0,o("update",{position:{x:0,y:0}})}function $e(){o("applyBubble",l.bubbleIndex)}function _e(){a.updateAllBubbles({fontSize:h.value,fontFamily:_.value,textDirection:v.value,textColor:$.value,fillColor:W.value,strokeEnabled:z.value,strokeColor:N.value,strokeWidth:w.value,inpaintMethod:U.value}),console.log("æ ·å¼å·²åº”ç”¨åˆ°æ‰€æœ‰æ°”æ³¡"),o("reRender")}function ze(){o("resetCurrent",l.bubbleIndex)}function Le(){o("ocrRecognize",l.bubbleIndex)}function De(){o("reTranslate",l.bubbleIndex)}function Ie(){Q.value=!Q.value}function Xe(ke,X){if(X==="original"){const me=c.value;if(me){const Ke=me.selectionStart||s.value.length,Ge=me.selectionEnd||s.value.length,mt=s.value;s.value=mt.slice(0,Ke)+ke+mt.slice(Ge),dt(()=>{me.selectionStart=me.selectionEnd=Ke+ke.length,me.focus()}),o("update",{originalText:s.value})}}else{const me=p.value;if(me){const Ke=me.selectionStart||i.value.length,Ge=me.selectionEnd||i.value.length,mt=i.value;i.value=mt.slice(0,Ke)+ke+mt.slice(Ge),dt(()=>{me.selectionStart=me.selectionEnd=Ke+ke.length,me.focus()}),o("update",{translatedText:i.value})}}}function at(ke){if(ke==="original"){const X=c.value;if(X&&s.value.length>0){const me=X.selectionStart||s.value.length,Ke=X.selectionEnd||s.value.length,Ge=s.value;me===Ke&&me>0?(s.value=Ge.slice(0,me-1)+Ge.slice(Ke),dt(()=>{X.selectionStart=X.selectionEnd=me-1,X.focus()})):me!==Ke&&(s.value=Ge.slice(0,me)+Ge.slice(Ke),dt(()=>{X.selectionStart=X.selectionEnd=me,X.focus()})),o("update",{originalText:s.value})}}else{const X=p.value;if(X&&i.value.length>0){const me=X.selectionStart||i.value.length,Ke=X.selectionEnd||i.value.length,Ge=i.value;me===Ke&&me>0?(i.value=Ge.slice(0,me-1)+Ge.slice(Ke),dt(()=>{X.selectionStart=X.selectionEnd=me-1,X.focus()})):me!==Ke&&(i.value=Ge.slice(0,me)+Ge.slice(Ke),dt(()=>{X.selectionStart=X.selectionEnd=me,X.focus()})),o("update",{translatedText:i.value})}}}async function rt(){try{const ke=await ps();if(ke.fonts){const X=[],me=[];for(const Ke of ke.fonts){const Ge={name:typeof Ke=="string"?Ke:Ke.display_name||Ke.file_name||"",path:typeof Ke=="string"?Ke:Ke.path};Ge.path.startsWith("fonts/")?X.push(Ge):me.push(Ge)}X.length>0&&(G.value=X),j.value=me}}catch(ke){console.error("åŠ è½½å­—ä½“åˆ—è¡¨å¤±è´¥:",ke)}}return ut(()=>{rt()}),(ke,X)=>(D(),L("div",mp,[e("div",vp,[e("div",{class:"text-column-header"},[X[13]||(X[13]=e("span",{class:"column-title"},"ğŸ‡¯ğŸ‡µ æ—¥è¯­åŸæ–‡ (OCRç»“æœ)",-1)),e("button",{class:"re-ocr-btn",onClick:Le,title:"é‡æ–°OCRæ­¤æ°”æ³¡"},"ğŸ”„")]),se(e("textarea",{ref_key:"originalTextInput",ref:c,"onUpdate:modelValue":X[0]||(X[0]=me=>s.value=me),class:"text-editor original-editor",placeholder:"OCRè¯†åˆ«çš„æ—¥è¯­åŸæ–‡...",spellcheck:"false",onInput:m},null,544),[[Ce,s.value]]),e("div",{class:"text-actions"},[e("button",{class:"copy-btn",onClick:te},"ğŸ“‹ å¤åˆ¶"),e("button",{class:"keyboard-toggle-btn",onClick:Ie,title:"æ˜¾ç¤º/éšè—50éŸ³é”®ç›˜"}," âŒ¨ï¸ 50éŸ³ ")]),he(pp,{visible:Q.value,"default-target":V.value,onClose:X[1]||(X[1]=me=>Q.value=!1),onInsert:Xe,onDelete:at},null,8,["visible","default-target"])]),e("div",bp,[e("div",{class:"text-column-header"},[X[14]||(X[14]=e("span",{class:"column-title"},"ğŸ‡¨ğŸ‡³ ä¸­æ–‡è¯‘æ–‡",-1)),e("button",{class:"re-translate-btn",onClick:De,title:"é‡æ–°ç¿»è¯‘æ­¤æ°”æ³¡"}," ğŸ”„ ")]),se(e("textarea",{ref_key:"translatedTextInput",ref:p,"onUpdate:modelValue":X[2]||(X[2]=me=>i.value=me),class:"text-editor translated-editor",placeholder:"ç¿»è¯‘åçš„ä¸­æ–‡...",spellcheck:"false",onInput:E},null,544),[[Ce,i.value]]),e("div",{class:"text-actions"},[e("button",{class:"copy-btn",onClick:M},"ğŸ“‹ å¤åˆ¶"),e("button",{class:"apply-text-btn",onClick:$e},"âœ“ åº”ç”¨æ–‡æœ¬")])]),e("div",fp,[e("div",hp,[e("div",yp,[e("div",xp,[X[15]||(X[15]=e("label",null,"å­—ä½“",-1)),he(Oe,{modelValue:_.value,"onUpdate:modelValue":X[3]||(X[3]=me=>_.value=me),groups:I.value,title:"å­—ä½“",onChange:u},null,8,["modelValue","groups"])]),e("div",kp,[X[16]||(X[16]=e("label",null,"å­—å·",-1)),e("div",_p,[se(e("input",{type:"number","onUpdate:modelValue":X[4]||(X[4]=me=>h.value=me),class:"toolbar-fontsize-input",min:H(No),max:H(zo),step:H(Gt),title:"å­—å·",onChange:Z},null,40,Sp),[[Ce,h.value,void 0,{number:!0}]]),e("div",{class:"toolbar-fontsize-btns"},[e("button",{class:"toolbar-fontsize-btn",onClick:x,title:"å¢å¤§å­—å·"}," A+ "),e("button",{class:"toolbar-fontsize-btn",onClick:K,title:"å‡å°å­—å·"}," A- ")])])])]),e("div",Cp,[e("div",wp,[e("button",{class:"toolbar-btn","data-active":v.value==="vertical",onClick:X[5]||(X[5]=me=>C("vertical")),title:"ç«–å‘æ’ç‰ˆ"},[...X[17]||(X[17]=[e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("path",{d:"M8 2v12M8 2L5 5M8 2l3 3",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])],8,$p),e("button",{class:"toolbar-btn","data-active":v.value==="horizontal",onClick:X[6]||(X[6]=me=>C("horizontal")),title:"æ¨ªå‘æ’ç‰ˆ"},[...X[18]||(X[18]=[e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("path",{d:"M2 8h12M14 8l-3-3M14 8l-3 3",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])],8,Ip)]),X[24]||(X[24]=e("div",{class:"toolbar-divider vertical"},null,-1)),e("div",Tp,[e("div",Dp,[e("button",{class:"toolbar-btn toolbar-color-btn",onClick:ue},[X[19]||(X[19]=e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("text",{x:"3",y:"11","font-size":"10","font-weight":"bold",fill:"currentColor"},"A")],-1)),e("span",{class:"color-indicator",style:nt({background:$.value})},null,4)]),se(e("input",{ref_key:"textColorInput",ref:b,type:"color","onUpdate:modelValue":X[7]||(X[7]=me=>$.value=me),class:"hidden-color-input",onInput:P,onChange:P},null,544),[[Ce,$.value]])])]),X[25]||(X[25]=e("div",{class:"toolbar-divider vertical"},null,-1)),e("div",Rp,[he(Oe,{modelValue:U.value,"onUpdate:modelValue":X[8]||(X[8]=me=>U.value=me),options:f,onChange:ae},null,8,["modelValue"]),e("div",{class:Me(["toolbar-color-picker toolbar-solid-color-options",{hidden:U.value!=="solid"}])},[e("button",{class:"toolbar-btn toolbar-color-btn",onClick:ne},[X[20]||(X[20]=e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("rect",{x:"2",y:"2",width:"12",height:"12",rx:"2",fill:"none",stroke:"currentColor","stroke-width":"1.2"}),e("rect",{x:"4",y:"4",width:"8",height:"8",rx:"1",fill:"currentColor",opacity:"0.3"})],-1)),e("span",{class:"color-indicator",style:nt({background:W.value})},null,4)]),se(e("input",{ref_key:"fillColorInput",ref:T,type:"color","onUpdate:modelValue":X[9]||(X[9]=me=>W.value=me),class:"hidden-color-input",onChange:de},null,544),[[Ce,W.value]])],2)]),X[26]||(X[26]=e("div",{class:"toolbar-divider vertical"},null,-1)),e("div",Mp,[e("button",{class:"toolbar-btn","data-active":z.value,onClick:Fe,title:"æ–‡å­—æè¾¹"},[...X[21]||(X[21]=[e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("text",{x:"3",y:"12","font-size":"11","font-weight":"bold",stroke:"currentColor","stroke-width":"2",fill:"none"}," A "),e("text",{x:"3",y:"12","font-size":"11","font-weight":"bold",fill:"currentColor"},"A")],-1)])],8,Ep),e("div",{class:Me(["toolbar-color-picker toolbar-stroke-options",{hidden:!z.value}]),title:"æè¾¹é¢œè‰²"},[e("button",{class:"toolbar-btn toolbar-color-btn",onClick:we},[X[22]||(X[22]=e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("circle",{cx:"8",cy:"8",r:"5",fill:"none",stroke:"currentColor","stroke-width":"2"})],-1)),e("span",{class:"color-indicator",style:nt({background:N.value})},null,4)]),se(e("input",{ref_key:"strokeColorInput",ref:O,type:"color","onUpdate:modelValue":X[10]||(X[10]=me=>N.value=me),class:"hidden-color-input",onChange:Te},null,544),[[Ce,N.value]])],2),e("div",{class:Me(["toolbar-stroke-width toolbar-stroke-options",{hidden:!z.value}]),title:"æè¾¹å®½åº¦"},[se(e("input",{type:"number","onUpdate:modelValue":X[11]||(X[11]=me=>w.value=me),class:"toolbar-mini-input",min:"0",max:"10",onChange:Ee},null,544),[[Ce,w.value,void 0,{number:!0}]]),X[23]||(X[23]=e("span",{class:"toolbar-unit"},"px",-1))],2)])]),e("div",Pp,[e("div",Bp,[e("button",{class:"toolbar-btn",onClick:F,title:"é€†æ—¶é’ˆæ—‹è½¬"},[...X[27]||(X[27]=[e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("path",{d:"M2 8a6 6 0 1 1 1.5 4",stroke:"currentColor","stroke-width":"1.5",fill:"none"}),e("path",{d:"M2 5v3.5h3.5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),se(e("input",{type:"number","onUpdate:modelValue":X[12]||(X[12]=me=>A.value=me),class:"toolbar-mini-input toolbar-rotation-input",min:"-180",max:"180",step:"5",onChange:J},null,544),[[Ce,A.value,void 0,{number:!0}]]),X[29]||(X[29]=e("span",{class:"toolbar-unit"},"Â°",-1)),e("button",{class:"toolbar-btn",onClick:oe,title:"é¡ºæ—¶é’ˆæ—‹è½¬"},[...X[28]||(X[28]=[e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("path",{d:"M14 8a6 6 0 1 0-1.5 4",stroke:"currentColor","stroke-width":"1.5",fill:"none"}),e("path",{d:"M14 5v3.5h-3.5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),e("button",{class:"toolbar-btn toolbar-small-btn",onClick:ee,title:"é‡ç½®æ—‹è½¬"}," 0 ")]),X[35]||(X[35]=e("div",{class:"toolbar-divider vertical"},null,-1)),e("div",Ap,[e("button",{class:"toolbar-btn",onClick:re,title:"å·¦ç§»"},[...X[30]||(X[30]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("path",{d:"M10 3L5 8l5 5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),e("button",{class:"toolbar-btn",onClick:ve,title:"å³ç§»"},[...X[31]||(X[31]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("path",{d:"M6 3l5 5-5 5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),e("button",{class:"toolbar-btn",onClick:xe,title:"ä¸Šç§»"},[...X[32]||(X[32]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("path",{d:"M3 10l5-5 5 5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),e("button",{class:"toolbar-btn",onClick:be,title:"ä¸‹ç§»"},[...X[33]||(X[33]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("path",{d:"M3 6l5 5 5-5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),e("span",Fp,[e("span",null,le(k.value),1),X[34]||(X[34]=Se(",",-1)),e("span",null,le(y.value),1)]),e("button",{class:"toolbar-btn toolbar-small-btn",onClick:pe,title:"é‡ç½®ä½ç½®"}," âŒ‚ ")])])]),e("details",Lp,[X[36]||(X[36]=e("summary",null,"å­—å·é¢„è®¾",-1)),e("div",Up,[(D(!0),L(qe,null,Ye(H(Jn),me=>(D(),L("button",{key:me,class:Me(["preset-btn",{active:h.value===me}]),onClick:Ke=>B(me)},le(me),11,Op))),128))])]),e("div",{class:"edit-action-buttons"},[e("button",{class:"btn-apply",onClick:$e},"åº”ç”¨"),e("button",{class:"btn-apply-all",onClick:_e},"åº”ç”¨å…¨éƒ¨"),e("button",{class:"btn-reset",onClick:ze},"é‡ç½®")])])]))}}),Np=He(zp,[["__scopeId","data-v-ea49fb5e"]]),Vp={class:"edit-toolbar-wrapper"},Kp={class:"edit-toolbar toolbar-row-1"},Wp={class:"image-navigator"},qp=["disabled"],Hp=["disabled"],Jp={class:"bubble-navigator"},jp=["disabled"],Yp={class:"bubble-indicator"},Xp={id:"currentBubbleNum"},Gp={id:"totalBubbleNum"},Zp=["disabled"],Qp={class:"view-controls"},em={key:0,viewBox:"0 0 20 20",width:"16",height:"16"},tm={key:1,viewBox:"0 0 20 20",width:"16",height:"16"},om={id:"zoomLevel"},nm={class:"edit-toolbar toolbar-row-2"},sm={class:"annotation-tools"},am=["disabled"],lm=["disabled"],im={key:0,class:"brush-size-indicator"},rm={key:1,class:"brush-mode-hint"},um={class:"edit-progress-info"},cm={class:"edit-progress-text"},dm={class:"edit-progress-count"},gm={class:"edit-progress-bar"},pm={class:"quick-actions"},mm=Je({__name:"EditToolbar",props:{currentImageIndex:{},imageCount:{},canGoPrevious:{type:Boolean},canGoNext:{type:Boolean},showThumbnails:{type:Boolean},hasBubbles:{type:Boolean},selectedBubbleIndex:{},bubbleCount:{},layoutMode:{},syncEnabled:{type:Boolean},scale:{},isDrawingMode:{type:Boolean},hasSelection:{type:Boolean},brushMode:{},brushSize:{},mouseX:{},mouseY:{},isProcessing:{type:Boolean},progressText:{},progressCurrent:{},progressTotal:{}},emits:["go-previous-image","go-next-image","toggle-thumbnails","select-previous-bubble","select-next-bubble","toggle-layout","toggle-view-mode","toggle-sync","fit-to-screen","zoom-in","zoom-out","reset-zoom","exit-edit-mode","auto-detect-bubbles","detect-all-images","translate-with-bubbles","toggle-drawing-mode","delete-selected-bubbles","repair-selected-bubble","activate-repair-brush","activate-restore-brush","apply-and-next"],setup(n){const t=n,l=Y(()=>t.progressTotal===0?0:Math.round(t.progressCurrent/t.progressTotal*100)),o=Y(()=>t.progressTotal>0&&t.progressCurrent>=t.progressTotal),a=Y(()=>{const r=t.brushMode==="repair"?{fill:"rgba(76, 175, 80, 0.4)",border:"#4CAF50"}:{fill:"rgba(33, 150, 243, 0.4)",border:"#2196F3"};return{position:"fixed",left:`${t.mouseX}px`,top:`${t.mouseY}px`,width:`${t.brushSize}px`,height:`${t.brushSize}px`,borderRadius:"50%",border:`2px solid ${r.border}`,backgroundColor:r.fill,pointerEvents:"none",zIndex:99999,transform:"translate(-50%, -50%)",display:t.brushMode?"block":"none"}});return(r,s)=>(D(),L("div",Vp,[e("div",Kp,[e("div",Wp,[e("button",{class:"nav-btn",disabled:!n.canGoPrevious,onClick:s[0]||(s[0]=i=>r.$emit("go-previous-image")),title:"ä¸Šä¸€å¼ å›¾ç‰‡ (PageUp)"}," â—€â—€ ",8,qp),e("span",{class:"image-indicator",onClick:s[1]||(s[1]=i=>r.$emit("toggle-thumbnails")),title:"ç‚¹å‡»å±•å¼€ç¼©ç•¥å›¾"},[s[23]||(s[23]=Se(" å›¾ ",-1)),e("span",null,le(n.currentImageIndex+1),1),s[24]||(s[24]=Se(" / ",-1)),e("span",null,le(n.imageCount),1)]),e("button",{class:"nav-btn",disabled:!n.canGoNext,onClick:s[2]||(s[2]=i=>r.$emit("go-next-image")),title:"ä¸‹ä¸€å¼ å›¾ç‰‡ (PageDown)"}," â–¶â–¶ ",8,Hp),e("button",{class:Me(["thumb-toggle-btn",{active:n.showThumbnails}]),onClick:s[3]||(s[3]=i=>r.$emit("toggle-thumbnails")),title:"æ˜¾ç¤º/éšè—ç¼©ç•¥å›¾"}," â˜· ",2)]),s[30]||(s[30]=e("div",{class:"toolbar-divider"},null,-1)),e("div",Jp,[e("button",{id:"prevBubbleBtn",class:"nav-btn",disabled:!n.hasBubbles||n.selectedBubbleIndex<=0,onClick:s[4]||(s[4]=i=>r.$emit("select-previous-bubble")),title:"ä¸Šä¸€ä¸ªæ°”æ³¡ (â†)"}," â—€ ",8,jp),e("span",Yp,[s[25]||(s[25]=Se(" æ°”æ³¡ ",-1)),e("span",Xp,le(n.selectedBubbleIndex>=0?n.selectedBubbleIndex+1:0),1),s[26]||(s[26]=Se(" / ",-1)),e("span",Gp,le(n.bubbleCount),1)]),e("button",{id:"nextBubbleBtn",class:"nav-btn",disabled:!n.hasBubbles||n.selectedBubbleIndex>=n.bubbleCount-1,onClick:s[5]||(s[5]=i=>r.$emit("select-next-bubble")),title:"ä¸‹ä¸€ä¸ªæ°”æ³¡ (â†’)"}," â–¶ ",8,Zp)]),s[31]||(s[31]=e("div",{class:"toolbar-divider"},null,-1)),e("div",Qp,[e("button",{class:"layout-toggle-btn",onClick:s[6]||(s[6]=i=>r.$emit("toggle-layout")),title:"åˆ‡æ¢å¸ƒå±€ï¼šå·¦å³/ä¸Šä¸‹"},[n.layoutMode==="horizontal"?(D(),L("svg",em,[...s[27]||(s[27]=[e("rect",{x:"1",y:"2",width:"8",height:"16",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"},null,-1),e("rect",{x:"11",y:"2",width:"8",height:"16",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"},null,-1)])])):(D(),L("svg",tm,[...s[28]||(s[28]=[e("rect",{x:"2",y:"1",width:"16",height:"8",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"},null,-1),e("rect",{x:"2",y:"11",width:"16",height:"8",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"},null,-1)])]))]),e("button",{class:"view-mode-btn",onClick:s[7]||(s[7]=i=>r.$emit("toggle-view-mode")),title:"åˆ‡æ¢è§†å›¾æ¨¡å¼"},[...s[29]||(s[29]=[e("span",{class:"dual-icon"},"â§‰",-1)])]),e("button",{class:Me({active:n.syncEnabled}),onClick:s[8]||(s[8]=i=>r.$emit("toggle-sync")),title:"åŒæ­¥ç¼©æ”¾/æ‹–åŠ¨",style:{"font-size":"12px"}}," ğŸ”— ",2),e("button",{onClick:s[9]||(s[9]=i=>r.$emit("fit-to-screen")),title:"é€‚åº”å±å¹• (åŒå‡»)"},"â›¶"),e("button",{onClick:s[10]||(s[10]=i=>r.$emit("zoom-in")),title:"æ”¾å¤§ (+)"},"+"),e("span",om,le(Math.round(n.scale*100))+"%",1),e("button",{onClick:s[11]||(s[11]=i=>r.$emit("zoom-out")),title:"ç¼©å° (-)"},"âˆ’"),e("button",{onClick:s[12]||(s[12]=i=>r.$emit("reset-zoom")),title:"åŸå§‹å¤§å°"},"1:1")]),s[32]||(s[32]=e("div",{class:"toolbar-spacer"},null,-1)),e("button",{class:"secondary-btn",onClick:s[13]||(s[13]=i=>r.$emit("exit-edit-mode"))},"é€€å‡ºç¼–è¾‘")]),e("div",nm,[e("div",sm,[e("button",{class:"annotation-btn detect-btn",onClick:s[14]||(s[14]=i=>r.$emit("auto-detect-bubbles")),title:"è‡ªåŠ¨æ£€æµ‹å½“å‰å›¾ç‰‡çš„æ–‡æœ¬æ¡†"},[...s[33]||(s[33]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("circle",{cx:"6",cy:"6",r:"4",fill:"none",stroke:"currentColor","stroke-width":"1.5"}),e("path",{d:"M9 9l4 4",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round"})],-1),e("span",null,"æ£€æµ‹",-1)])]),e("button",{class:"annotation-btn detect-btn",onClick:s[15]||(s[15]=i=>r.$emit("detect-all-images")),title:"æ‰¹é‡æ£€æµ‹æ‰€æœ‰å›¾ç‰‡"},[...s[34]||(s[34]=[eo('<svg viewBox="0 0 16 16" width="14" height="14" data-v-b7164359><circle cx="5" cy="5" r="2.5" fill="none" stroke="currentColor" stroke-width="1" data-v-b7164359></circle><path d="M7 7l2 2" stroke="currentColor" stroke-width="1" stroke-linecap="round" data-v-b7164359></path><circle cx="10" cy="10" r="2.5" fill="none" stroke="currentColor" stroke-width="1" data-v-b7164359></circle><path d="M12 12l2 2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" data-v-b7164359></path></svg><span data-v-b7164359>æ‰¹é‡æ£€æµ‹</span>',2)])]),e("button",{class:"annotation-btn primary-action-btn",onClick:s[16]||(s[16]=i=>r.$emit("translate-with-bubbles")),title:"ä½¿ç”¨å½“å‰æ–‡æœ¬æ¡†ç¿»è¯‘æ­¤å›¾ç‰‡"},[...s[35]||(s[35]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("path",{d:"M2 3h5M4.5 3v7M2 6h5",stroke:"currentColor","stroke-width":"1.2",fill:"none"}),e("path",{d:"M9 13l2-7 2 7M9.5 11h3",stroke:"currentColor","stroke-width":"1.2",fill:"none"})],-1),e("span",null,"ç¿»è¯‘",-1)])]),s[41]||(s[41]=e("div",{class:"toolbar-divider"},null,-1)),e("button",{class:Me(["annotation-btn",{active:n.isDrawingMode}]),onClick:s[17]||(s[17]=i=>r.$emit("toggle-drawing-mode")),title:"æ·»åŠ æ°”æ³¡æ¡†ï¼ˆæˆ–ä¸­é”®æ‹–æ‹½ç»˜åˆ¶ï¼‰"},[...s[36]||(s[36]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("rect",{x:"3",y:"3",width:"10",height:"10",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"}),e("path",{d:"M8 5v6M5 8h6",stroke:"currentColor","stroke-width":"1.5"})],-1),e("span",null,"æ·»åŠ ",-1)])],2),e("button",{class:"annotation-btn",disabled:!n.hasSelection,onClick:s[18]||(s[18]=i=>r.$emit("delete-selected-bubbles")),title:"åˆ é™¤é€‰ä¸­æ°”æ³¡æ¡† (Delete)"},[...s[37]||(s[37]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("rect",{x:"3",y:"3",width:"10",height:"10",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"}),e("path",{d:"M5 8h6",stroke:"currentColor","stroke-width":"1.5"})],-1),e("span",null,"åˆ é™¤",-1)])],8,am),e("button",{class:"annotation-btn",disabled:!n.hasSelection,onClick:s[19]||(s[19]=i=>r.$emit("repair-selected-bubble")),title:"ä¿®å¤é€‰ä¸­æ°”æ³¡èƒŒæ™¯ (R)"},[...s[38]||(s[38]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("path",{d:"M2 14l3-3m0 0l6-6 3 3-6 6m-3 0l-1 1 1-1z",fill:"none",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round"}),e("path",{d:"M11 5l-1-1 2-2 2 2-2 2-1-1z",fill:"currentColor"})],-1),e("span",null,"ä¿®å¤",-1)])],8,lm),s[42]||(s[42]=e("div",{class:"toolbar-divider"},null,-1)),e("button",{class:Me(["annotation-btn brush-btn",{active:n.brushMode==="repair"}]),onClick:s[20]||(s[20]=i=>r.$emit("activate-repair-brush")),title:"ä¿®å¤ç¬”åˆ· (æŒ‰ä½R+å·¦é”®æ‹–æ‹½)"},[...s[39]||(s[39]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("circle",{cx:"8",cy:"8",r:"5",fill:"none",stroke:"currentColor","stroke-width":"1.5"}),e("circle",{cx:"8",cy:"8",r:"2",fill:"currentColor"})],-1),e("span",null,"ä¿®å¤ç¬”åˆ·",-1)])],2),e("button",{class:Me(["annotation-btn brush-btn",{active:n.brushMode==="restore"}]),onClick:s[21]||(s[21]=i=>r.$emit("activate-restore-brush")),title:"è¿˜åŸç¬”åˆ· (æŒ‰ä½U+å·¦é”®æ‹–æ‹½)"},[...s[40]||(s[40]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("circle",{cx:"8",cy:"8",r:"5",fill:"none",stroke:"currentColor","stroke-width":"1.5"}),e("path",{d:"M5 8h6M8 5v6",stroke:"currentColor","stroke-width":"1",transform:"rotate(45 8 8)"})],-1),e("span",null,"è¿˜åŸç¬”åˆ·",-1)])],2),n.brushMode?(D(),L("span",im," ç¬”åˆ·: "+le(n.brushSize)+"px ",1)):ge("",!0),s[43]||(s[43]=eo('<div class="help-tooltip-container" data-v-b7164359><button class="help-tooltip-btn" title="å¿«æ·é”®æ“ä½œå¸®åŠ©" data-v-b7164359><svg viewBox="0 0 16 16" width="14" height="14" data-v-b7164359><circle cx="8" cy="8" r="6.5" fill="none" stroke="currentColor" stroke-width="1.2" data-v-b7164359></circle><text x="8" y="11" text-anchor="middle" font-size="9" font-weight="bold" fill="currentColor" data-v-b7164359>?</text></svg><span class="help-btn-text" data-v-b7164359>å¿«æ·é”®</span></button><div class="help-tooltip-popup" data-v-b7164359><div class="help-section" data-v-b7164359><div class="help-title" data-v-b7164359>ğŸ–±ï¸ é¼ æ ‡æ“ä½œ</div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>å·¦é”®ç‚¹å‡»æ°”æ³¡</span><span class="help-desc" data-v-b7164359>é€‰æ‹©æ°”æ³¡</span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>Shift+å·¦é”®ç‚¹å‡»</span><span class="help-desc" data-v-b7164359>å¤šé€‰æ°”æ³¡</span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>å·¦é”®æ‹–æ‹½å››è§’/è¾¹</span><span class="help-desc" data-v-b7164359>è°ƒæ•´å¤§å°</span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>å·¦é”®æ‹–æ‹½æ¡†å†…éƒ¨</span><span class="help-desc" data-v-b7164359>ç§»åŠ¨æ°”æ³¡æ¡†</span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>ä¸­é”®æ‹–æ‹½</span><span class="help-desc" data-v-b7164359>ç»˜åˆ¶æ–°æ°”æ³¡æ¡†</span></div></div><div class="help-section" data-v-b7164359><div class="help-title" data-v-b7164359>âŒ¨ï¸ å¿«æ·é”®</div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>A / D</span><span class="help-desc" data-v-b7164359>åˆ‡æ¢ä¸Š/ä¸‹ä¸€å¼ å›¾ç‰‡</span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>Ctrl+Enter</span><span class="help-desc" data-v-b7164359>åº”ç”¨å¹¶è·³è½¬ä¸‹ä¸€å¼ </span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>Delete / Backspace</span><span class="help-desc" data-v-b7164359>åˆ é™¤é€‰ä¸­æ°”æ³¡</span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>æŒ‰ä½R+å·¦é”®æ‹–æ‹½</span><span class="help-desc" data-v-b7164359>ä¿®å¤ç¬”åˆ·</span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>æŒ‰ä½U+å·¦é”®æ‹–æ‹½</span><span class="help-desc" data-v-b7164359>è¿˜åŸç¬”åˆ·</span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>ç¬”åˆ·æ¨¡å¼ä¸‹æ»šè½®</span><span class="help-desc" data-v-b7164359>è°ƒæ•´ç¬”åˆ·å¤§å°</span></div></div></div></div>',1))]),n.brushMode?(D(),L("div",{key:0,class:"brush-cursor",style:nt(a.value)},null,4)):ge("",!0),n.brushMode?(D(),L("div",rm,le(n.brushMode==="repair"?"ä¿®å¤ç¬”åˆ· (R)":"è¿˜åŸç¬”åˆ· (U)")+" - æ»šè½®è°ƒæ•´å¤§å° ",1)):ge("",!0),n.isProcessing?(D(),L("div",{key:2,class:Me(["edit-progress-container",{completed:o.value}])},[e("div",um,[e("span",cm,le(n.progressText),1),e("span",dm,le(n.progressCurrent)+"/"+le(n.progressTotal),1)]),e("div",gm,[e("div",{class:Me(["edit-progress-fill",{animating:!o.value}]),style:nt({width:l.value+"%"})},null,6)])],2)):ge("",!0),s[44]||(s[44]=e("div",{class:"toolbar-spacer"},null,-1)),e("div",pm,[e("button",{class:"primary-btn",onClick:s[22]||(s[22]=i=>r.$emit("apply-and-next")),title:"åº”ç”¨æ›´æ”¹å¹¶è·³è½¬ä¸‹ä¸€å¼  (Ctrl+Enter)"}," åº”ç”¨å¹¶ä¸‹ä¸€å¼  ")])])]))}}),vm=He(mm,[["__scopeId","data-v-b7164359"]]),bm={key:0,class:"edit-thumbnails-panel"},fm={class:"thumbnails-scroll"},hm=["onClick"],ym=["src","alt"],xm={class:"thumb-index"},km=Je({__name:"EditThumbnailPanel",props:{visible:{type:Boolean},images:{},currentImageIndex:{}},emits:["switch-to-image"],setup(n){return(t,l)=>n.visible?(D(),L("div",bm,[e("div",fm,[(D(!0),L(qe,null,Ye(n.images,(o,a)=>(D(),L("div",{key:o.id,class:Me(["edit-thumbnail-item",{active:a===n.currentImageIndex}]),onClick:r=>t.$emit("switch-to-image",a)},[e("img",{src:o.translatedDataURL||o.originalDataURL,alt:`å›¾ç‰‡ ${a+1}`},null,8,ym),e("span",xm,le(a+1),1)],10,hm))),128))])])):ge("",!0)}}),_m=He(km,[["__scopeId","data-v-9d2a43d9"]]),Sm={class:"edit-main-layout"},Cm={class:"image-comparison-container"},wm={class:"panel-header"},$m=["src"],Im={class:"panel-header"},Tm=["src"],Dm=Je({__name:"EditWorkspace",props:{isEditModeActive:{type:Boolean}},emits:["exit"],setup(n,{emit:t}){const l=n,o=t,a=je(),r=it(),{translateWithCurrentBubbles:s}=mo(),{reRenderFullImage:i}=Tg({onRenderStart:()=>console.log("å¼€å§‹é‡æ–°æ¸²æŸ“..."),onRenderSuccess:q=>console.log("æ¸²æŸ“æˆåŠŸ:",q.substring(0,50)+"..."),onRenderError:q=>console.error("æ¸²æŸ“å¤±è´¥:",q)}),{isDrawingMode:h,isDrawingBox:_,currentDrawingRect:v,isMiddleButtonDown:$,handleBubbleSelect:W,handleBubbleMultiSelect:z,handleClearMultiSelect:N,handleBubbleDragStart:w,handleBubbleDragging:A,handleBubbleDragEnd:U,handleBubbleResizeStart:R,handleBubbleResizing:g,handleBubbleResizeEnd:c,handleBubbleRotateStart:p,handleBubbleRotating:b,handleBubbleRotateEnd:T,toggleDrawingMode:O,handleDrawBubble:Q,getDrawingRectStyle:V,handleBubbleUpdate:G,deleteSelectedBubbles:j,repairSelectedBubble:k,handleOcrRecognize:y}=Ig({onReRender:()=>i(),onDelayedPreview:()=>i()}),I=S(0),f=S(0),{brushMode:d,brushSize:m,mouseX:E,mouseY:te,isBrushKeyDown:M,toggleBrushMode:Z,exitBrushMode:B,startBrushPainting:x,continueBrushPainting:K,finishBrushPainting:u,adjustBrushSize:C}=wg({onBrushComplete:()=>i(),getCurrentRepairSettings:()=>({inpaintMethod:ke.value,fillColor:X.value})}),{images:ue,currentImageIndex:P,currentImage:ne,imageCount:de,canGoPrevious:we,canGoNext:Te}=yt(a),{bubbles:Fe,selectedIndex:Ee,selectedIndices:ae,selectedBubble:J,bubbleCount:F,hasBubbles:oe,hasSelection:ee}=yt(r),re=Y(()=>pe.value?.querySelector("img")?.naturalWidth||2e3),ve=Y(()=>pe.value?.querySelector("img")?.naturalHeight||2e3),xe=S(null),be=S(null),pe=S(null),$e=S(null),_e=S(null),ze=S(null),Le=S("dual"),De=S("horizontal"),Ie=S(!1),Xe=S(!0),at=S(!1),rt=S(!1),ke=S("solid"),X=S("#FFFFFF"),me=S(!1),Ke=S("å¤„ç†ä¸­..."),Ge=S(0),mt=S(0),tt=tn(),Ze=tn(),Lt=Y(()=>Ze.scale.value),fn=Y(()=>Ze.translateX.value),hn=Y(()=>Ze.translateY.value),yn=Y(()=>tt.scale.value),bt=S(null),xn=Y(()=>({transform:`translate(${tt.translateX.value}px, ${tt.translateY.value}px) scale(${tt.scale.value})`})),kn=Y(()=>({transform:`translate(${Ze.translateX.value}px, ${Ze.translateY.value}px) scale(${Ze.scale.value})`}));function vo(){Ze.zoomIn(),Xe.value&&tt.setTransform(Ze.getTransform())}function bo(){Ze.zoomOut(),Xe.value&&tt.setTransform(Ze.getTransform())}function fo(){Ze.resetZoom(),Xe.value&&tt.setTransform(Ze.getTransform())}const Ut=S(!1),_n=S(0),Ot=S(!1),wt=S({x:0,y:0,size:0});function zt(){d.value&&B(),Kt()}function Nt(){r.bubbles.length>0&&r.selectBubble(0)}function ho(){we.value&&(zt(),a.goToPrevious())}function Vt(){Te.value&&(zt(),a.goToNext())}function Sn(q){q!==P.value&&q>=0&&q<de.value&&(zt(),a.setCurrentImageIndex(q))}function Kt(){if(!ne.value)return;const q=Array.isArray(ne.value.bubbleStates);Fe.value.length>0?(a.updateCurrentBubbleStates([...Fe.value]),a.setManuallyAnnotated(!0),console.log("å·²ä¿å­˜æ°”æ³¡çŠ¶æ€åˆ°å½“å‰å›¾ç‰‡ï¼Œæ ‡è®°ä¸ºæ‰‹åŠ¨æ ‡æ³¨")):q&&(a.updateCurrentBubbleStates([]),a.setManuallyAnnotated(!0),console.log("å·²ä¿å­˜ç©ºæ°”æ³¡çŠ¶æ€åˆ°å½“å‰å›¾ç‰‡ï¼ˆç”¨æˆ·ä¸»åŠ¨æ¸…ç©ºï¼Œæ ‡è®°ä¸ºæ‰‹åŠ¨æ ‡æ³¨ï¼‰"))}function $t(){ne.value?.bubbleStates?(r.setBubbles([...ne.value.bubbleStates],!0),console.log(`å·²åŠ è½½ ${ne.value.bubbleStates.length} ä¸ªæ°”æ³¡çŠ¶æ€`)):r.clearBubblesLocal(),Nt()}function Cn(){r.selectPrevious()}function wn(){r.selectNext()}function $n(){Ie.value=!Ie.value}function In(){De.value=De.value==="horizontal"?"vertical":"horizontal";try{localStorage.setItem(Vo,De.value)}catch(q){console.warn("ä¿å­˜å¸ƒå±€æ¨¡å¼å¤±è´¥:",q)}setTimeout(()=>{It()},300)}function Tn(){const q=["dual","original","translated"],ie=q.indexOf(Le.value),ce=q[(ie+1)%q.length];ce&&(Le.value=ce)}function Dn(){Xe.value=!Xe.value,console.log("åŒå›¾åŒæ­¥:",Xe.value?"å¼€å¯":"å…³é—­"),Xe.value&&tt.setTransform(Ze.getTransform())}function It(){const q=$e.value||be.value,ie=_e.value||pe.value;if(!q||!ie)return;const ce=ie.querySelector("img");if(!ce||!ce.naturalWidth)return;const We=q.getBoundingClientRect(),Be=We.width/ce.naturalWidth,Re=We.height/ce.naturalHeight,Ue=Math.min(Be,Re)*.95,Pe=(We.width-ce.naturalWidth*Ue)/2,vt=(We.height-ce.naturalHeight*Ue)/2,ft={scale:Ue,translateX:Pe,translateY:vt};Ze.setTransform(ft),tt.setTransform(ft)}function yo(q,ie){if(d.value){const Pe=q.deltaY>0?-5:5;C(Pe);return}const ce=q.currentTarget.getBoundingClientRect(),We=q.clientX-ce.left,Be=q.clientY-ce.top,Re=q.deltaY>0?.9:1.1,Ue=ie==="original"?tt:Ze;Ue.zoomAt(We,Be,Re),Xe.value&&(ie==="original"?Ze:tt).setTransform(Ue.getTransform())}function xo(q,ie){if(d.value){const ce=ie==="original"?be.value:$e.value;ce&&x(q,ce);return}if(q.button===1){$.value=!0,So(q,ie),q.preventDefault();return}if(h.value&&q.button===0){So(q,ie),q.preventDefault();return}if(q.button===0){if(q.target.closest(".bubble-highlight-box"))return;q.shiftKey||N(),bt.value=ie,(ie==="original"?tt:Ze).startDrag(q.clientX,q.clientY),document.addEventListener("mousemove",ko),document.addEventListener("mouseup",_o),q.preventDefault()}}function ko(q){if(!bt.value)return;const ie=bt.value==="original"?tt:Ze;ie.drag(q.clientX,q.clientY),Xe.value&&(bt.value==="original"?Ze:tt).setTransform(ie.getTransform())}function _o(){bt.value&&(bt.value==="original"?tt:Ze).endDrag(),bt.value=null,document.removeEventListener("mousemove",ko),document.removeEventListener("mouseup",_o)}let Wt="translated";function So(q,ie="translated"){Wt=ie;const ce=ie==="original"?pe.value:_e.value,We=ie==="original"?tt:Ze;if(!ce)return;const Be=ce.getBoundingClientRect(),Re=(q.clientX-Be.left)/We.scale.value,Ue=(q.clientY-Be.top)/We.scale.value;I.value=Re,f.value=Ue,_.value=!0,v.value=[Re,Ue,Re,Ue],document.addEventListener("mousemove",qt),document.addEventListener("mouseup",Ht)}function qt(q){if(!_.value)return;const ie=Wt==="original"?pe.value:_e.value,ce=Wt==="original"?tt:Ze;if(!ie)return;const We=ie.getBoundingClientRect(),Be=(q.clientX-We.left)/ce.scale.value,Re=(q.clientY-We.top)/ce.scale.value;v.value=[Math.min(I.value,Be),Math.min(f.value,Re),Math.max(I.value,Be),Math.max(f.value,Re)]}function Ht(q){document.removeEventListener("mousemove",qt),document.removeEventListener("mouseup",Ht);const ie=$.value;if(!_.value||!v.value){_.value=!1,v.value=null,$.value=!1;return}const[ce,We,Be,Re]=v.value,Ue=Be-ce,Pe=Re-We;Ue>10&&Pe>10&&(r.addBubble(v.value),r.selectBubble(r.bubbleCount-1),console.log("å·²æ·»åŠ æ–°æ°”æ³¡:",v.value)),_.value=!1,v.value=null,$.value=!1,!ie&&h.value&&(h.value=!1)}function Co(q){console.log(`${q} å›¾ç‰‡åŠ è½½å®Œæˆ`),Lt.value===1&&fn.value===0&&hn.value===0&&dt(()=>{It()})}function Rn(){i()}function Mn(q){q.inpaintMethod!==void 0&&(ke.value=q.inpaintMethod),q.fillColor!==void 0&&(X.value=q.fillColor),Ee.value>=0&&G(q)}function En(q){fe("æ–‡æœ¬å·²åº”ç”¨","success"),i()}function Pn(q){const ie=r.initialStates[q];if(!ie){console.warn(`æ— æ³•é‡ç½®æ°”æ³¡ #${q+1}ï¼šæ‰¾ä¸åˆ°åˆå§‹çŠ¶æ€`),fe("æ— æ³•é‡ç½®ï¼šæ‰¾ä¸åˆ°åˆå§‹çŠ¶æ€","warning");return}const ce=JSON.parse(JSON.stringify(ie));r.updateBubble(q,ce),console.log(`æ°”æ³¡ #${q+1} å·²é‡ç½®åˆ°åˆå§‹çŠ¶æ€`),fe("æ°”æ³¡å·²é‡ç½®","success"),i()}async function Bn(q){const ie=Fe.value[q];if(!ie?.originalText){console.warn("æ— æ³•é‡æ–°ç¿»è¯‘ï¼šç¼ºå°‘æ°”æ³¡æˆ–åŸæ–‡");return}try{console.log(`å¼€å§‹é‡æ–°ç¿»è¯‘æ°”æ³¡ #${q+1}`);const{translateSingleText:ce}=await lt(async()=>{const{translateSingleText:Ue}=await Promise.resolve().then(()=>fs);return{translateSingleText:Ue}},void 0),{useSettingsStore:We}=await lt(async()=>{const{useSettingsStore:Ue}=await import("./system.D6wMibzp.js").then(Pe=>Pe.s);return{useSettingsStore:Ue}},__vite__mapDeps([0,1,2,3,4,5])),Be=We().settings,Re=await ce({original_text:ie.originalText,model_provider:Be.translation.provider,api_key:Be.translation.apiKey,model_name:Be.translation.modelName,custom_base_url:Be.translation.customBaseUrl,target_language:Be.targetLanguage,prompt_content:Be.translatePrompt});Re.success&&Re.data?.translated_text?(r.updateBubble(q,{translatedText:Re.data.translated_text}),console.log(`ç¿»è¯‘æˆåŠŸ: "${Re.data.translated_text}"`),i()):console.error("ç¿»è¯‘å¤±è´¥:",Re.error||"æœªçŸ¥é”™è¯¯")}catch(ce){console.error("ç¿»è¯‘å‡ºé”™:",ce)}}function wo(q,ie){for(q.bubbleTexts||(q.bubbleTexts=[]),q.originalTexts||(q.originalTexts=[]);q.bubbleTexts.length<ie;)q.bubbleTexts.push("");for(;q.originalTexts.length<ie;)q.originalTexts.push("")}function $o(q,ie,ce){const We=q.auto_directions||[];return q.bubble_coords.map((Be,Re)=>{const Ue=Be[0]??0,Pe=Be[1]??0,vt=Be[2]??0,ft=Be[3]??0;let gt;return We[Re]?gt=We[Re]==="v"?"vertical":"horizontal":gt=ft-Pe>vt-Ue?"vertical":"horizontal",{coords:Be,originalText:ie.originalTexts?.[Re]||"",translatedText:ie.bubbleTexts?.[Re]||"",textboxText:"",fontSize:ce.fontSize,fontFamily:ce.fontFamily,textDirection:gt,autoTextDirection:gt,textColor:ce.textColor,fillColor:ce.fillColor,strokeEnabled:ce.strokeEnabled,strokeColor:ce.strokeColor,strokeWidth:ce.strokeWidth,rotationAngle:q.bubble_angles?.[Re]||0,inpaintMethod:ce.inpaintMethod,position:{x:0,y:0},polygon:[]}})}async function An(){const q=ne.value;if(!q?.originalDataURL){fe("æ²¡æœ‰æœ‰æ•ˆçš„å›¾ç‰‡ç”¨äºæ£€æµ‹","warning");return}try{fe("æ­£åœ¨è‡ªåŠ¨æ£€æµ‹æ–‡æœ¬æ¡†...","info");const ce=q.originalDataURL.match(/^data:image\/[^;]+;base64,(.+)$/)?.[1]||"";if(!ce){fe("æ— æ³•è§£æå›¾ç‰‡æ•°æ®","error");return}const We=Ve(),{textDetector:Be,boxExpand:Re,textStyle:Ue}=We.settings,Pe=await to(ce,Be,{box_expand_ratio:Re.ratio,box_expand_top:Re.top,box_expand_bottom:Re.bottom,box_expand_left:Re.left,box_expand_right:Re.right});if(Pe.success&&Pe.bubble_coords){a.updateCurrentImage({bubbleCoords:Pe.bubble_coords,bubbleAngles:Pe.bubble_angles||[]}),wo(q,Pe.bubble_coords.length);const vt={bubble_coords:Pe.bubble_coords.map(gt=>[...gt]),bubble_angles:Pe.bubble_angles,auto_directions:Pe.auto_directions},ft=$o(vt,q,Ue);r.setBubbles(ft),Nt(),fe(`è‡ªåŠ¨æ£€æµ‹åˆ° ${Pe.bubble_coords.length} ä¸ªæ–‡æœ¬æ¡†`,"success")}else fe(Pe.error||"æ£€æµ‹å¤±è´¥","error")}catch(ie){console.error("è‡ªåŠ¨æ£€æµ‹å¤±è´¥:",ie),fe("è‡ªåŠ¨æ£€æµ‹å¤±è´¥","error")}}async function Fn(){if(ue.value.length<=1){fe("è‡³å°‘éœ€è¦ä¸¤å¼ å›¾ç‰‡æ‰èƒ½æ‰§è¡Œæ‰¹é‡æ£€æµ‹","warning");return}if(!confirm("æ­¤æ“ä½œå°†å¯¹æ‰€æœ‰å›¾ç‰‡è¿›è¡Œæ–‡æœ¬æ¡†æ£€æµ‹ï¼Œå¯èƒ½ä¼šè¦†ç›–å·²æœ‰çš„æ£€æµ‹ç»“æœã€‚ç¡®å®šç»§ç»­å—ï¼Ÿ"))return;const q=Ve(),{textDetector:ie,boxExpand:ce,textStyle:We}=q.settings,Be=P.value,Re=ue.value.length;me.value=!0,Ke.value="æ‰¹é‡æ£€æµ‹ä¸­",mt.value=Re,Ge.value=0;try{let Ue=0;for(let Pe=0;Pe<Re;Pe++){const vt=ue.value[Pe];if(!vt?.originalDataURL)continue;Ge.value=Pe+1;const gt=vt.originalDataURL.match(/^data:image\/[^;]+;base64,(.+)$/)?.[1]||"";if(!gt)continue;const pt=await to(gt,ie,{box_expand_ratio:ce.ratio,box_expand_top:ce.top,box_expand_bottom:ce.bottom,box_expand_left:ce.left,box_expand_right:ce.right});if(pt.success&&pt.bubble_coords){const xt=ue.value[Pe];if(xt){xt.bubbleCoords=pt.bubble_coords,xt.bubbleAngles=pt.bubble_angles||[],wo(xt,pt.bubble_coords.length);const Vn={bubble_coords:pt.bubble_coords.map(Kn=>[...Kn]),bubble_angles:pt.bubble_angles,auto_directions:pt.auto_directions};xt.bubbleStates=$o(Vn,xt,We),Ue+=pt.bubble_coords.length,Pe===P.value&&$t()}}}Ke.value="æ£€æµ‹å®Œæˆ",Ge.value=Re,Be!==P.value&&a.setCurrentImageIndex(Be),$t(),fe(`æ‰¹é‡æ£€æµ‹å®Œæˆï¼å…±å¤„ç† ${Re} å¼ å›¾ç‰‡ï¼Œæ£€æµ‹åˆ° ${Ue} ä¸ªæ–‡æœ¬æ¡†`,"success"),setTimeout(()=>{me.value=!1},2e3)}catch(Ue){console.error("æ‰¹é‡æ£€æµ‹å¤±è´¥:",Ue),fe("æ‰¹é‡æ£€æµ‹å¤±è´¥","error"),me.value=!1}}async function Ln(){if(!ne.value?.originalDataURL){fe("æ²¡æœ‰æœ‰æ•ˆçš„å›¾ç‰‡ç”¨äºç¿»è¯‘","warning");return}if(Fe.value.length===0){fe("æ²¡æœ‰æ–‡æœ¬æ¡†å¯ç”¨äºç¿»è¯‘ï¼Œè¯·å…ˆæ£€æµ‹æˆ–æ·»åŠ æ–‡æœ¬æ¡†","warning");return}fe("æ­£åœ¨ä½¿ç”¨å½“å‰æ–‡æœ¬æ¡†ç¿»è¯‘...","info");try{await s()&&(fe("ç¿»è¯‘æˆåŠŸï¼","success"),Nt())}catch(ie){console.error("ç¿»è¯‘å¤±è´¥:",ie),fe(`ç¿»è¯‘å¤±è´¥: ${ie instanceof Error?ie.message:"æœªçŸ¥é”™è¯¯"}`,"error")}}function Un(){Z("repair")}function On(){Z("restore")}function Io(q){K(q)}function To(){u()}function zn(q){Ut.value=!0,_n.value=De.value==="horizontal"?q.clientX:q.clientY,document.body.style.cursor=De.value==="horizontal"?"col-resize":"row-resize",document.body.style.userSelect="none",document.addEventListener("mousemove",Jt),document.addEventListener("mouseup",jt),q.preventDefault()}function Jt(q){if(!Ut.value)return;const ie=be.value?.parentElement?.parentElement;if(!ie)return;const ce=ie.getBoundingClientRect();if(De.value==="horizontal"){const We=q.clientX-ce.left,Be=ce.width,Re=Math.max(20,Math.min(80,We/Be*100)),Ue=ie.querySelector(".original-panel"),Pe=ie.querySelector(".translated-panel");Ue&&Pe&&(Ue.style.flex=`0 0 ${Re}%`,Pe.style.flex=`0 0 ${100-Re}%`)}else{const We=q.clientY-ce.top,Be=ce.height,Re=Math.max(20,Math.min(80,We/Be*100)),Ue=ie.querySelector(".original-panel"),Pe=ie.querySelector(".translated-panel");Ue&&Pe&&(Ue.style.flex=`0 0 ${Re}%`,Pe.style.flex=`0 0 ${100-Re}%`)}}function jt(){Ut.value=!1,document.body.style.cursor="",document.body.style.userSelect="",document.removeEventListener("mousemove",Jt),document.removeEventListener("mouseup",jt)}function Nn(q){Ot.value=!0;const ie=ze.value;ie&&(wt.value={x:q.clientX,y:q.clientY,size:De.value==="horizontal"?ie.offsetWidth:ie.offsetHeight},document.body.style.cursor=De.value==="horizontal"?"ew-resize":"ns-resize",document.body.style.userSelect="none",document.addEventListener("mousemove",Yt),document.addEventListener("mouseup",Xt),q.preventDefault())}function Yt(q){if(!(!Ot.value||!ze.value))if(De.value==="horizontal"){const ie=wt.value.x-q.clientX;let ce=wt.value.size+ie;ce=Math.max(300,Math.min(window.innerWidth*.6,ce)),ze.value.style.flex=`0 0 ${ce}px`,ze.value.style.minWidth=`${ce}px`}else{const ie=wt.value.y-q.clientY;let ce=wt.value.size+ie;ce=Math.max(200,Math.min(window.innerHeight*.5,ce)),ze.value.style.flex=`0 0 ${ce}px`,ze.value.style.height=`${ce}px`}}function Xt(){Ot.value=!1,document.body.style.cursor="",document.body.style.userSelect="",document.removeEventListener("mousemove",Yt),document.removeEventListener("mouseup",Xt)}function Do(q){const ie=q.target,ce=q.key.toLowerCase();if(ce==="r"||ce==="u"||ce==="a"||ce==="d"){if(ie.tagName==="TEXTAREA")return;(ie.tagName==="INPUT"||ie.tagName==="SELECT"||ie.tagName==="BUTTON")&&ie.blur()}else if(ie.tagName==="INPUT"||ie.tagName==="TEXTAREA"||ie.tagName==="SELECT")return;switch(q.key){case"Escape":Eo();break;case"Delete":case"Backspace":!d.value&&ee.value&&(j(),q.preventDefault());break;case"a":case"A":d.value||(ho(),q.preventDefault());break;case"d":case"D":d.value||(Vt(),q.preventDefault());break;case"Enter":q.ctrlKey&&!d.value&&(Mo(),q.preventDefault());break;case"r":case"R":M.value||(Z("repair"),q.preventDefault());break;case"u":case"U":M.value||(Z("restore"),q.preventDefault());break;case"+":case"=":vo(),q.preventDefault();break;case"-":bo(),q.preventDefault();break;case"0":fo(),q.preventDefault();break}}function Ro(q){(q.key==="r"||q.key==="R"||q.key==="u"||q.key==="U")&&(B(),q.preventDefault())}async function Mo(){Kt(),await i(),Te.value?Vt():fe("å·²æ˜¯æœ€åä¸€å¼ å›¾ç‰‡","info")}function Eo(){Kt(),o("exit")}return ut(()=>{try{const q=localStorage.getItem(Vo);(q==="horizontal"||q==="vertical")&&(De.value=q)}catch(q){console.warn("åŠ è½½å¸ƒå±€æ¨¡å¼å¤±è´¥:",q)}document.addEventListener("keydown",Do),document.addEventListener("keyup",Ro),document.addEventListener("mousemove",Io),document.addEventListener("mouseup",To),l.isEditModeActive&&($t(),dt(()=>{xe.value?.focus()}))}),Dt(()=>{document.removeEventListener("keydown",Do),document.removeEventListener("keyup",Ro),document.removeEventListener("mousemove",Io),document.removeEventListener("mouseup",To),document.removeEventListener("mousemove",qt),document.removeEventListener("mouseup",Ht),document.removeEventListener("mousemove",Jt),document.removeEventListener("mouseup",jt),document.removeEventListener("mousemove",Yt),document.removeEventListener("mouseup",Xt)}),ye(()=>l.isEditModeActive,q=>{q&&($t(),dt(()=>{xe.value?.focus()}))}),ye(P,()=>{l.isEditModeActive&&$t()}),ye(J,q=>{q&&(ke.value=q.inpaintMethod||"solid",X.value=q.fillColor||"#FFFFFF")},{immediate:!0}),(q,ie)=>n.isEditModeActive?(D(),L("div",{key:0,class:Me(["edit-workspace",[`layout-${De.value}`,{"drawing-mode":H(h)}]]),tabindex:"0",ref_key:"workspaceRef",ref:xe},[he(vm,{"current-image-index":H(P),"image-count":H(de),"can-go-previous":H(we),"can-go-next":H(Te),"show-thumbnails":Ie.value,"has-bubbles":H(oe),"selected-bubble-index":H(Ee),"bubble-count":H(F),"layout-mode":De.value,"sync-enabled":Xe.value,scale:Lt.value,"is-drawing-mode":H(h),"has-selection":H(ee),"brush-mode":H(d),"brush-size":H(m),"mouse-x":H(E),"mouse-y":H(te),"is-processing":me.value,"progress-text":Ke.value,"progress-current":Ge.value,"progress-total":mt.value,onGoPreviousImage:ho,onGoNextImage:Vt,onToggleThumbnails:$n,onSelectPreviousBubble:Cn,onSelectNextBubble:wn,onToggleLayout:In,onToggleViewMode:Tn,onToggleSync:Dn,onFitToScreen:It,onZoomIn:vo,onZoomOut:bo,onResetZoom:fo,onExitEditMode:Eo,onAutoDetectBubbles:An,onDetectAllImages:Fn,onTranslateWithBubbles:Ln,onToggleDrawingMode:H(O),onDeleteSelectedBubbles:H(j),onRepairSelectedBubble:H(k),onActivateRepairBrush:Un,onActivateRestoreBrush:On,onApplyAndNext:Mo},null,8,["current-image-index","image-count","can-go-previous","can-go-next","show-thumbnails","has-bubbles","selected-bubble-index","bubble-count","layout-mode","sync-enabled","scale","is-drawing-mode","has-selection","brush-mode","brush-size","mouse-x","mouse-y","is-processing","progress-text","progress-current","progress-total","onToggleDrawingMode","onDeleteSelectedBubbles","onRepairSelectedBubble"]),he(_m,{visible:Ie.value,images:H(ue),"current-image-index":H(P),onSwitchToImage:Sn},null,8,["visible","images","current-image-index"]),e("div",Sm,[e("div",Cm,[se(e("div",{class:Me(["image-panel original-panel",{collapsed:Le.value==="translated"||at.value}])},[e("div",wm,[ie[8]||(ie[8]=e("span",{class:"panel-title"},"ğŸ“– åŸå›¾ (æ—¥æ–‡)",-1)),e("button",{class:"panel-toggle",onClick:ie[0]||(ie[0]=ce=>at.value=!at.value),title:"æŠ˜å /å±•å¼€"},le(at.value?"+":"âˆ’"),1)]),e("div",{ref_key:"originalViewportRef",ref:be,class:"image-viewport",onWheel:ie[2]||(ie[2]=Qe(ce=>yo(ce,"original"),["prevent"])),onMousedown:ie[3]||(ie[3]=ce=>xo(ce,"original")),onDblclick:It},[e("div",{ref_key:"originalWrapperRef",ref:pe,class:"image-canvas-wrapper",style:nt(xn.value)},[H(ne)?.originalDataURL?(D(),L("img",{key:0,src:H(ne).originalDataURL,alt:"åŸå›¾",onLoad:ie[1]||(ie[1]=ce=>Co("original"))},null,40,$m)):ge("",!0),H(ne)?.originalDataURL?(D(),st(on,{key:1,bubbles:H(Fe),"selected-index":H(Ee),"selected-indices":H(ae),scale:yn.value,"is-drawing-mode":H(h),"is-brush-mode":!!H(d),"image-width":re.value,"image-height":ve.value,onSelect:H(W),onMultiSelect:H(z),onDragStart:H(w),onDragging:H(A),onDragEnd:H(U),onResizeStart:H(R),onResizing:H(g),onResizeEnd:H(c),onRotateStart:H(p),onRotating:H(b),onRotateEnd:H(T),onDrawBubble:H(Q)},null,8,["bubbles","selected-index","selected-indices","scale","is-drawing-mode","is-brush-mode","image-width","image-height","onSelect","onMultiSelect","onDragStart","onDragging","onDragEnd","onResizeStart","onResizing","onResizeEnd","onRotateStart","onRotating","onRotateEnd","onDrawBubble"])):ge("",!0),H(v)?(D(),L("div",{key:2,class:"drawing-rect-edit",style:nt(H(V)())},null,4)):ge("",!0)],4)],544)],2),[[Ae,Le.value!=="translated"]]),Le.value==="dual"?(D(),L("div",{key:0,class:Me(["panel-divider",{"vertical-divider":De.value==="vertical"}]),onMousedown:zn},null,34)):ge("",!0),se(e("div",{class:Me(["image-panel translated-panel",{collapsed:Le.value==="original"||rt.value}])},[e("div",Im,[ie[9]||(ie[9]=e("span",{class:"panel-title"},"ğŸ“ ç¿»è¯‘å›¾ (ä¸­æ–‡)",-1)),e("button",{class:"panel-toggle",onClick:ie[4]||(ie[4]=ce=>rt.value=!rt.value),title:"æŠ˜å /å±•å¼€"},le(rt.value?"+":"âˆ’"),1)]),e("div",{ref_key:"translatedViewportRef",ref:$e,class:"image-viewport",onWheel:ie[6]||(ie[6]=Qe(ce=>yo(ce,"translated"),["prevent"])),onMousedown:ie[7]||(ie[7]=ce=>xo(ce,"translated")),onDblclick:It},[e("div",{ref_key:"translatedWrapperRef",ref:_e,class:"image-canvas-wrapper",style:nt(kn.value)},[H(ne)?.translatedDataURL||H(ne)?.originalDataURL?(D(),L("img",{key:0,src:H(ne)?.translatedDataURL||H(ne)?.originalDataURL,alt:"ç¿»è¯‘å›¾",onLoad:ie[5]||(ie[5]=ce=>Co("translated"))},null,40,Tm)):ge("",!0),H(ne)?.translatedDataURL||H(ne)?.originalDataURL?(D(),st(on,{key:1,bubbles:H(Fe),"selected-index":H(Ee),"selected-indices":H(ae),scale:Lt.value,"is-drawing-mode":H(h),"is-brush-mode":!!H(d),"image-width":re.value,"image-height":ve.value,onSelect:H(W),onMultiSelect:H(z),onDragStart:H(w),onDragging:H(A),onDragEnd:H(U),onResizeStart:H(R),onResizing:H(g),onResizeEnd:H(c),onRotateStart:H(p),onRotating:H(b),onRotateEnd:H(T),onDrawBubble:H(Q)},null,8,["bubbles","selected-index","selected-indices","scale","is-drawing-mode","is-brush-mode","image-width","image-height","onSelect","onMultiSelect","onDragStart","onDragging","onDragEnd","onResizeStart","onResizing","onResizeEnd","onRotateStart","onRotating","onRotateEnd","onDrawBubble"])):ge("",!0),H(v)?(D(),L("div",{key:2,class:"drawing-rect-edit translated-drawing-rect",style:nt(H(V)())},null,4)):ge("",!0)],4)],544)],2),[[Ae,Le.value!=="original"]])]),e("div",{ref_key:"editPanelRef",ref:ze,class:"edit-panel-container"},[e("div",{class:"panel-resize-handle vertical",onMousedown:Nn}," â‹®â‹®â‹® ",32),he(Np,{bubble:H(J),"bubble-index":H(Ee),onUpdate:Mn,onReRender:Rn,onOcrRecognize:H(y),onReTranslate:Bn,onApplyBubble:En,onResetCurrent:Pn},null,8,["bubble","bubble-index","onOcrRecognize"])],512)])],2)):ge("",!0)}}),Rm=He(Dm,[["__scopeId","data-v-593a2a42"]]),Ct="/api/web-import";async function Mm(n){return(await fetch(`${Ct}/check-support?url=${encodeURIComponent(n)}`)).json()}async function Em(){return(await fetch(`${Ct}/gallery-dl-images`)).json()}async function Pm(n,t,l,o,a,r="auto",s){const i=await fetch(`${Ct}/extract`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:n,config:t,engine:r})});if(!i.ok){const $=await i.json().catch(()=>({error:"è¯·æ±‚å¤±è´¥"}));a($.error||`HTTP ${i.status}`);return}const h=i.body?.getReader();if(!h){a("æ— æ³•è¯»å–å“åº”æµ");return}const _=new TextDecoder;let v="";try{for(;;){const{done:$,value:W}=await h.read();if($)break;v+=_.decode(W,{stream:!0});const z=v.split(`
`);v=z.pop()||"";let N="",w="";for(const A of z)if(A.startsWith("event:"))N=A.slice(6).trim();else if(A.startsWith("data:"))w=A.slice(5).trim();else if(A===""&&N&&w){try{const U=JSON.parse(w);N==="log"?l(U):N==="page"?s&&s(U):N==="result"?o(U):N==="error"&&a(U.error||"æœªçŸ¥é”™è¯¯")}catch(U){console.error("è§£æ SSE æ•°æ®å¤±è´¥:",U)}N="",w=""}}}finally{h.releaseLock()}}async function Bm(n,t,l,o="ai-agent"){const a=await fetch(`${Ct}/download`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({pages:n,sourceUrl:t,config:l,engine:o})});if(!a.ok){const r=await a.json().catch(()=>({error:"è¯·æ±‚å¤±è´¥"}));throw new Error(r.error||`HTTP ${a.status}`)}return a.json()}async function Am(n){return(await fetch(`${Ct}/test-firecrawl`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({apiKey:n})})).json()}async function Fm(n,t,l,o){return(await fetch(`${Ct}/test-agent`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({provider:n,apiKey:t,customBaseUrl:l,modelName:o})})).json()}const Lm={class:"modal-container"},Um={class:"modal-body"},Om={class:"url-section"},zm=["disabled"],Nm=["disabled"],Vm=["disabled"],Km={key:0,class:"loading-spinner"},Wm={key:1},qm={key:0,class:"engine-hint"},Hm={key:0,class:"hint-checking"},Jm={key:1,class:"hint-supported"},jm={key:2,class:"hint-unsupported"},Ym={class:"settings-section"},Xm={class:"settings-toggle"},Gm={key:0,class:"settings-content"},Zm={class:"settings-tabs"},Qm={class:"settings-tab-content"},ev={class:"settings-group"},tv={class:"form-row"},ov={class:"input-group"},nv=["type","value"],sv=["disabled"],av={class:"settings-group"},lv={class:"form-row"},iv=["value"],rv=["value"],uv={class:"form-row"},cv={class:"input-group"},dv=["type","value"],gv={key:0,class:"form-row"},pv=["value"],mv={class:"form-row"},vv=["value"],bv={class:"form-row inline"},fv={class:"checkbox-label"},hv=["checked"],yv={class:"checkbox-label"},xv=["checked"],kv={class:"form-row"},_v=["disabled"],Sv={class:"settings-group"},Cv={class:"form-row"},wv=["value"],$v={class:"form-row"},Iv=["value"],Tv={class:"settings-group"},Dv={class:"form-grid"},Rv={class:"form-row"},Mv=["value"],Ev={class:"form-row"},Pv=["value"],Bv={class:"form-row"},Av=["value"],Fv={class:"form-row"},Lv=["value"],Uv={class:"form-row"},Ov={class:"checkbox-label"},zv=["checked"],Nv={class:"settings-group"},Vv={class:"form-row inline"},Kv={class:"checkbox-label"},Wv=["checked"],qv={class:"checkbox-label"},Hv=["checked"],Jv={class:"settings-tab-content"},jv={class:"settings-group"},Yv={class:"form-row"},Xv={class:"checkbox-label"},Gv=["checked"],Zv={class:"form-row"},Qv={class:"checkbox-label"},eb=["checked"],tb={class:"form-row"},ob={class:"checkbox-label"},nb=["checked"],sb={key:0,class:"form-grid"},ab={class:"form-row"},lb=["value"],ib={class:"form-row"},rb=["value"],ub={class:"form-row"},cb=["value"],db={class:"form-row"},gb={class:"checkbox-label"},pb=["checked"],mb={key:1,class:"form-row"},vb=["value"],bb={class:"settings-tab-content"},fb={class:"settings-group"},hb={class:"form-row"},yb=["value"],xb={class:"form-row"},kb=["value"],_b={class:"form-row"},Sb={class:"checkbox-label"},Cb=["checked"],wb={key:1,class:"logs-section"},$b={class:"logs-toggle"},Ib={key:0,class:"extracting-hint"},Tb={key:0,class:"logs-content"},Db={class:"log-time"},Rb={class:"log-message"},Mb={key:2,class:"error-section"},Eb={class:"error-message"},Pb={key:3,class:"result-section"},Bb={class:"result-header"},Ab={class:"result-title"},Fb={class:"result-meta"},Lb={class:"result-count"},Ub={key:0,class:"result-engine"},Ob={class:"select-control"},zb={class:"select-all"},Nb=["checked"],Vb={class:"selected-count"},Kb={class:"image-grid"},Wb=["onClick"],qb={class:"image-checkbox"},Hb=["checked","onChange"],Jb={class:"image-preview"},jb=["src","alt"],Yb={class:"image-label"},Xb={key:4,class:"progress-section"},Gb={class:"progress-label"},Zb={class:"progress-bar"},Qb={class:"modal-footer"},ef=["disabled"],tf=["disabled"],of={key:0,class:"loading-spinner"},nf={key:1},sf=Je({__name:"WebImportModal",setup(n){const t=pn(),l=je(),o=S(""),a=S(!0),r=S("auto"),s=S(!1),i=S(!1),h=S(!1),_=S(!1),v=S("basic"),$=S(!1),W=S(!1),z=S(!1),N=S(!1),w=Y(()=>t.modalVisible),A=Y(()=>t.status),U=Y(()=>t.logs),R=Y(()=>t.extractResult),g=Y(()=>t.selectedPages),c=Y(()=>t.selectedCount),p=Y(()=>t.downloadProgress),b=Y(()=>t.downloadProgressPercent),T=Y(()=>t.error),O=Y(()=>t.isProcessing),Q=Y(()=>t.settings.ui.showAgentLogs),V=Y(()=>R.value?.engine||null),G=Y(()=>{switch(V.value){case"gallery-dl":return"Gallery-DL";case"ai-agent":return"AI Agent";default:return""}}),j=Y(()=>R.value?.pages?c.value===R.value.pages.length:!1);function k(K){return V.value==="gallery-dl",K}let y=null;async function I(K){if(y&&clearTimeout(y),!K.trim()){s.value=!1,i.value=!1;return}y=setTimeout(async()=>{h.value=!0;try{const u=await Mm(K);s.value=u.available,i.value=u.supported}catch{s.value=!1,i.value=!1}finally{h.value=!1}},500)}function f(){O.value&&!confirm("æ­£åœ¨å¤„ç†ä¸­ï¼Œç¡®å®šè¦å…³é—­å—ï¼Ÿ")||(t.closeModal(),t.resetState(),o.value="")}async function d(){const K=o.value.trim();if(!K){alert("è¯·è¾“å…¥ç½‘å€");return}try{new URL(K)}catch{alert("è¯·è¾“å…¥æœ‰æ•ˆçš„ç½‘å€");return}t.resetState(),t.setUrl(K),t.setStatus("extracting");try{await Pm(K,t.settings,u=>{t.addLog(u)},u=>{t.setExtractResult(u),u.success?t.setStatus("extracted"):t.setError(u.error||"æå–å¤±è´¥")},u=>{t.setError(u)},r.value,u=>{t.addPageIncremental(u)})}catch(u){t.setError(u instanceof Error?u.message:"æå–å¤±è´¥")}}function m(K){t.togglePageSelection(K)}function E(){t.toggleSelectAll()}async function te(){if(!R.value?.pages||c.value===0){alert("è¯·é€‰æ‹©è¦å¯¼å…¥çš„å›¾ç‰‡");return}const K=R.value.pages.filter(C=>g.value.has(C.pageNumber));t.setStatus("downloading"),t.updateDownloadProgress(0,K.length);const u=V.value||"ai-agent";try{if(u==="gallery-dl"){const ue=await Em();if(ue.success&&ue.images.length>0){let P=0;const ne=Math.min(ue.images.length,K.length);for(let de=0;de<ne;de++){const we=ue.images[de];we&&we.filename&&we.data&&(l.addImage(we.filename,we.data),P++,t.updateDownloadProgress(P,ne))}t.setStatus("completed"),alert(`æˆåŠŸå¯¼å…¥ ${P} å¼ å›¾ç‰‡`),f();return}else throw new Error(ue.error||"è·å–å›¾ç‰‡å¤±è´¥")}const C=await Bm(K,R.value.sourceUrl,t.settings,u);if(C.success&&C.images.length>0){t.setDownloadedImages(C.images),t.updateDownloadProgress(C.images.length,K.length);for(const P of C.images)l.addImage(P.filename,P.dataUrl);t.setStatus("completed");const ue=C.failedCount>0?`ï¼Œ${C.failedCount} å¼ å¤±è´¥`:"";alert(`æˆåŠŸå¯¼å…¥ ${C.images.length} å¼ å›¾ç‰‡${ue}`),f()}else t.setError(C.error||"ä¸‹è½½å¤±è´¥")}catch(C){t.setError(C instanceof Error?C.message:"ä¸‹è½½å¤±è´¥")}}ye(w,K=>{K&&setTimeout(()=>{document.querySelector(".url-input")?.focus()},100)}),ye(o,K=>{I(K)});const M=Y(()=>t.settings.agent.provider==="custom_openai");async function Z(){if(!t.settings.firecrawl.apiKey){alert("è¯·è¾“å…¥ Firecrawl API Key");return}$.value=!0;try{const K=await Am(t.settings.firecrawl.apiKey);K.success?alert("âœ… Firecrawl è¿æ¥æˆåŠŸ"):alert(`âŒ è¿æ¥å¤±è´¥: ${K.error}`)}catch(K){alert(`âŒ è¿æ¥å¤±è´¥: ${K instanceof Error?K.message:"æœªçŸ¥é”™è¯¯"}`)}finally{$.value=!1}}async function B(){if(!t.settings.agent.apiKey){alert("è¯·è¾“å…¥ AI Agent API Key");return}W.value=!0;try{const K=await Fm(t.settings.agent.provider,t.settings.agent.apiKey,t.settings.agent.customBaseUrl,t.settings.agent.modelName);K.success?alert("âœ… AI Agent è¿æ¥æˆåŠŸ"):alert(`âŒ è¿æ¥å¤±è´¥: ${K.error}`)}catch(K){alert(`âŒ è¿æ¥å¤±è´¥: ${K instanceof Error?K.message:"æœªçŸ¥é”™è¯¯"}`)}finally{W.value=!1}}function x(){confirm("ç¡®å®šè¦é‡ç½®ä¸ºé»˜è®¤æç¤ºè¯å—ï¼Ÿ")&&t.resetExtractionPrompt()}return(K,u)=>(D(),st(Zn,{to:"body"},[w.value?(D(),L("div",{key:0,class:"modal-overlay",onClick:Qe(f,["self"])},[e("div",Lm,[e("div",{class:"modal-header"},[u[37]||(u[37]=e("h2",{class:"modal-title"},[e("span",{class:"title-icon"},"ğŸŒ"),Se(" ä»ç½‘é¡µå¯¼å…¥æ¼«ç”» ")],-1)),e("button",{class:"close-btn",onClick:f,title:"å…³é—­"},"Ã—")]),e("div",Um,[e("div",Om,[se(e("input",{"onUpdate:modelValue":u[0]||(u[0]=C=>o.value=C),type:"url",class:"url-input",placeholder:"è¾“å…¥æ¼«ç”»ç½‘é¡µ URLï¼Œå¦‚ https://example.com/chapter-1",disabled:O.value,onKeyup:Xn(d,["enter"])},null,40,zm),[[Ce,o.value]]),se(e("select",{"onUpdate:modelValue":u[1]||(u[1]=C=>r.value=C),class:"engine-select",disabled:O.value},[...u[38]||(u[38]=[e("option",{value:"auto"},"è‡ªåŠ¨é€‰æ‹©",-1),e("option",{value:"gallery-dl"},"Gallery-DL",-1),e("option",{value:"ai-agent"},"AI Agent",-1)])],8,Nm),[[Gn,r.value]]),e("button",{class:"extract-btn",disabled:O.value||!o.value.trim(),onClick:d},[A.value==="extracting"?(D(),L("span",Km)):(D(),L("span",Wm,"ğŸ”")),Se(" "+le(A.value==="extracting"?"æå–ä¸­...":"å¼€å§‹æå–"),1)],8,Vm)]),o.value.trim()&&!O.value?(D(),L("div",qm,[h.value?(D(),L("span",Hm,"æ£€æŸ¥ä¸­...")):i.value?(D(),L("span",Jm,"âœ“ è¯¥ç½‘ç«™æ”¯æŒ Gallery-DL é«˜é€Ÿä¸‹è½½")):s.value?(D(),L("span",jm,"è¯¥ç½‘ç«™å°†ä½¿ç”¨ AI Agent æ¨¡å¼")):ge("",!0)])):ge("",!0),u[80]||(u[80]=e("div",{class:"notice"}," âš ï¸ è¯·ä»…çˆ¬å–æ‚¨æœ‰æƒè®¿é—®çš„å†…å®¹ï¼Œå¹¶éµå®ˆç›®æ ‡ç½‘ç«™çš„ä½¿ç”¨æ¡æ¬¾ã€‚ ",-1)),e("div",Ym,[e("div",{class:"settings-header",onClick:u[2]||(u[2]=C=>_.value=!_.value)},[e("span",Xm,le(_.value?"â–¼":"â–¶"),1),u[39]||(u[39]=e("span",{class:"settings-title"},"âš™ï¸ è®¾ç½®",-1)),u[40]||(u[40]=e("span",{class:"settings-hint"},"ç‚¹å‡»å±•å¼€é…ç½®",-1))]),_.value?(D(),L("div",Gm,[e("div",Zm,[e("button",{class:Me(["settings-tab",{active:v.value==="basic"}]),onClick:u[3]||(u[3]=C=>v.value="basic")}," åŸºæœ¬è®¾ç½® ",2),e("button",{class:Me(["settings-tab",{active:v.value==="preprocess"}]),onClick:u[4]||(u[4]=C=>v.value="preprocess")}," å›¾ç‰‡é¢„å¤„ç† ",2),e("button",{class:Me(["settings-tab",{active:v.value==="advanced"}]),onClick:u[5]||(u[5]=C=>v.value="advanced")}," é«˜çº§è®¾ç½® ",2)]),se(e("div",Qm,[e("div",ev,[u[42]||(u[42]=e("h4",{class:"group-title"},"Firecrawl é…ç½®",-1)),e("div",tv,[u[41]||(u[41]=e("label",{class:"form-label"},"API Key",-1)),e("div",ov,[e("input",{type:z.value?"text":"password",class:"form-input",value:H(t).settings.firecrawl.apiKey,onInput:u[6]||(u[6]=C=>H(t).setFirecrawlApiKey(C.target.value)),placeholder:"fc-xxxxxxxxxxxxxxxx"},null,40,nv),e("button",{class:"toggle-btn",onClick:u[7]||(u[7]=C=>z.value=!z.value)},le(z.value?"ğŸ‘":"ğŸ‘â€ğŸ—¨"),1),e("button",{class:"test-btn",disabled:$.value||!H(t).settings.firecrawl.apiKey,onClick:Z},le($.value?"æµ‹è¯•ä¸­...":"æµ‹è¯•è¿æ¥"),9,sv)])])]),e("div",av,[u[49]||(u[49]=e("h4",{class:"group-title"},"AI Agent é…ç½®",-1)),e("div",lv,[u[43]||(u[43]=e("label",{class:"form-label"},"æœåŠ¡å•†",-1)),e("select",{class:"form-select",value:H(t).settings.agent.provider,onChange:u[8]||(u[8]=C=>H(t).setAgentProvider(C.target.value))},[(D(!0),L(qe,null,Ye(H(jn),C=>(D(),L("option",{key:C.value,value:C.value},le(C.label),9,rv))),128))],40,iv)]),e("div",uv,[u[44]||(u[44]=e("label",{class:"form-label"},"API Key",-1)),e("div",cv,[e("input",{type:N.value?"text":"password",class:"form-input",value:H(t).settings.agent.apiKey,onInput:u[9]||(u[9]=C=>H(t).setAgentApiKey(C.target.value)),placeholder:"sk-xxxxxxxxxxxxxxxx"},null,40,dv),e("button",{class:"toggle-btn",onClick:u[10]||(u[10]=C=>N.value=!N.value)},le(N.value?"ğŸ‘":"ğŸ‘â€ğŸ—¨"),1)])]),M.value?(D(),L("div",gv,[u[45]||(u[45]=e("label",{class:"form-label"},"è‡ªå®šä¹‰ API åœ°å€",-1)),e("input",{type:"url",class:"form-input",value:H(t).settings.agent.customBaseUrl,onInput:u[11]||(u[11]=C=>H(t).setAgentBaseUrl(C.target.value)),placeholder:"https://api.example.com/v1"},null,40,pv)])):ge("",!0),e("div",mv,[u[46]||(u[46]=e("label",{class:"form-label"},"æ¨¡å‹åç§°",-1)),e("input",{type:"text",class:"form-input",value:H(t).settings.agent.modelName,onInput:u[12]||(u[12]=C=>H(t).setAgentModelName(C.target.value)),placeholder:"gpt-4o-mini"},null,40,vv)]),e("div",bv,[e("label",fv,[e("input",{type:"checkbox",checked:H(t).settings.agent.forceJsonOutput,onChange:u[13]||(u[13]=C=>H(t).setAgentForceJson(C.target.checked))},null,40,hv),u[47]||(u[47]=Se(" å¼ºåˆ¶ JSON æ ¼å¼ ",-1))]),e("label",yv,[e("input",{type:"checkbox",checked:H(t).settings.agent.useStream,onChange:u[14]||(u[14]=C=>H(t).setAgentUseStream(C.target.checked))},null,40,xv),u[48]||(u[48]=Se(" æµå¼è°ƒç”¨ ",-1))])]),e("div",kv,[e("button",{class:"test-btn full",disabled:W.value||!H(t).settings.agent.apiKey,onClick:B},le(W.value?"æµ‹è¯•ä¸­...":"æµ‹è¯• Agent è¿æ¥"),9,_v)])]),e("div",Sv,[e("h4",{class:"group-title"},[u[50]||(u[50]=Se(" æå–è®¾ç½® ",-1)),e("button",{class:"reset-btn",onClick:x},"é‡ç½®ä¸ºé»˜è®¤")]),e("div",Cv,[u[51]||(u[51]=e("label",{class:"form-label"},"æå–æç¤ºè¯",-1)),e("textarea",{class:"form-textarea",value:H(t).settings.extraction.prompt,onInput:u[15]||(u[15]=C=>H(t).setExtractionPrompt(C.target.value)),rows:"6",placeholder:"è¾“å…¥æå–æç¤ºè¯..."},null,40,wv)]),e("div",$v,[u[52]||(u[52]=e("label",{class:"form-label"},"æœ€å¤§è¿­ä»£æ¬¡æ•°",-1)),e("input",{type:"number",class:"form-input small",value:H(t).settings.extraction.maxIterations,onInput:u[16]||(u[16]=C=>H(t).setExtractionMaxIterations(Number(C.target.value))),min:"1",max:"20"},null,40,Iv)])]),e("div",Tv,[u[58]||(u[58]=e("h4",{class:"group-title"},"ä¸‹è½½è®¾ç½®",-1)),e("div",Dv,[e("div",Rv,[u[53]||(u[53]=e("label",{class:"form-label"},"å¹¶å‘æ•°",-1)),e("input",{type:"number",class:"form-input small",value:H(t).settings.download.concurrency,onInput:u[17]||(u[17]=C=>H(t).setDownloadConcurrency(Number(C.target.value))),min:"1",max:"10"},null,40,Mv)]),e("div",Ev,[u[54]||(u[54]=e("label",{class:"form-label"},"è¶…æ—¶ (ç§’)",-1)),e("input",{type:"number",class:"form-input small",value:H(t).settings.download.timeout,onInput:u[18]||(u[18]=C=>H(t).setDownloadTimeout(Number(C.target.value))),min:"5",max:"120"},null,40,Pv)]),e("div",Bv,[u[55]||(u[55]=e("label",{class:"form-label"},"é‡è¯•æ¬¡æ•°",-1)),e("input",{type:"number",class:"form-input small",value:H(t).settings.download.retries,onInput:u[19]||(u[19]=C=>H(t).setDownloadRetries(Number(C.target.value))),min:"0",max:"5"},null,40,Av)]),e("div",Fv,[u[56]||(u[56]=e("label",{class:"form-label"},"ä¸‹è½½é—´éš” (ms)",-1)),e("input",{type:"number",class:"form-input small",value:H(t).settings.download.delay,onInput:u[20]||(u[20]=C=>H(t).setDownloadDelay(Number(C.target.value))),min:"0",max:"2000",step:"100"},null,40,Lv)])]),e("div",Uv,[e("label",Ov,[e("input",{type:"checkbox",checked:H(t).settings.download.useReferer,onChange:u[21]||(u[21]=C=>H(t).setDownloadUseReferer(C.target.checked))},null,40,zv),u[57]||(u[57]=Se(" è‡ªåŠ¨æ·»åŠ  Referer ",-1))])])]),e("div",Nv,[u[61]||(u[61]=e("h4",{class:"group-title"},"ç•Œé¢è®¾ç½®",-1)),e("div",Vv,[e("label",Kv,[e("input",{type:"checkbox",checked:H(t).settings.ui.showAgentLogs,onChange:u[22]||(u[22]=C=>H(t).setShowAgentLogs(C.target.checked))},null,40,Wv),u[59]||(u[59]=Se(" æ˜¾ç¤º AI å·¥ä½œæ—¥å¿— ",-1))]),e("label",qv,[e("input",{type:"checkbox",checked:H(t).settings.ui.autoImport,onChange:u[23]||(u[23]=C=>H(t).setAutoImport(C.target.checked))},null,40,Hv),u[60]||(u[60]=Se(" æå–åè‡ªåŠ¨å¯¼å…¥ ",-1))])])])],512),[[Ae,v.value==="basic"]]),se(e("div",Jv,[e("div",jv,[e("div",Yv,[e("label",Xv,[e("input",{type:"checkbox",checked:H(t).settings.imagePreprocess.enabled,onChange:u[24]||(u[24]=C=>H(t).setImagePreprocessEnabled(C.target.checked))},null,40,Gv),u[62]||(u[62]=Se(" å¯ç”¨å›¾ç‰‡é¢„å¤„ç† ",-1))])]),H(t).settings.imagePreprocess.enabled?(D(),L(qe,{key:0},[e("div",Zv,[e("label",Qv,[e("input",{type:"checkbox",checked:H(t).settings.imagePreprocess.autoRotate,onChange:u[25]||(u[25]=C=>H(t).setImageAutoRotate(C.target.checked))},null,40,eb),u[63]||(u[63]=Se(" æ ¹æ® EXIF è‡ªåŠ¨æ—‹è½¬ ",-1))])]),u[71]||(u[71]=e("h5",{class:"subsection-title"},"å‹ç¼©è®¾ç½®",-1)),e("div",tb,[e("label",ob,[e("input",{type:"checkbox",checked:H(t).settings.imagePreprocess.compression.enabled,onChange:u[26]||(u[26]=C=>H(t).setImageCompressionEnabled(C.target.checked))},null,40,nb),u[64]||(u[64]=Se(" å¯ç”¨å‹ç¼© ",-1))])]),H(t).settings.imagePreprocess.compression.enabled?(D(),L("div",sb,[e("div",ab,[u[65]||(u[65]=e("label",{class:"form-label"},"è´¨é‡ (0-100)",-1)),e("input",{type:"number",class:"form-input small",value:H(t).settings.imagePreprocess.compression.quality,onInput:u[27]||(u[27]=C=>H(t).setImageCompressionQuality(Number(C.target.value))),min:"1",max:"100"},null,40,lb)]),e("div",ib,[u[66]||(u[66]=e("label",{class:"form-label"},"æœ€å¤§å®½åº¦ (0=ä¸é™)",-1)),e("input",{type:"number",class:"form-input small",value:H(t).settings.imagePreprocess.compression.maxWidth,onInput:u[28]||(u[28]=C=>H(t).setImageMaxWidth(Number(C.target.value))),min:"0"},null,40,rb)]),e("div",ub,[u[67]||(u[67]=e("label",{class:"form-label"},"æœ€å¤§é«˜åº¦ (0=ä¸é™)",-1)),e("input",{type:"number",class:"form-input small",value:H(t).settings.imagePreprocess.compression.maxHeight,onInput:u[29]||(u[29]=C=>H(t).setImageMaxHeight(Number(C.target.value))),min:"0"},null,40,cb)])])):ge("",!0),u[72]||(u[72]=e("h5",{class:"subsection-title"},"æ ¼å¼è½¬æ¢",-1)),e("div",db,[e("label",gb,[e("input",{type:"checkbox",checked:H(t).settings.imagePreprocess.formatConvert.enabled,onChange:u[30]||(u[30]=C=>H(t).setImageFormatConvertEnabled(C.target.checked))},null,40,pb),u[68]||(u[68]=Se(" å¯ç”¨æ ¼å¼è½¬æ¢ ",-1))])]),H(t).settings.imagePreprocess.formatConvert.enabled?(D(),L("div",mb,[u[70]||(u[70]=e("label",{class:"form-label"},"ç›®æ ‡æ ¼å¼",-1)),e("select",{class:"form-select",value:H(t).settings.imagePreprocess.formatConvert.targetFormat,onChange:u[31]||(u[31]=C=>H(t).setImageTargetFormat(C.target.value))},[...u[69]||(u[69]=[e("option",{value:"original"},"ä¿æŒåŸæ ¼å¼",-1),e("option",{value:"jpeg"},"JPEG",-1),e("option",{value:"png"},"PNG",-1),e("option",{value:"webp"},"WebP",-1)])],40,vb)])):ge("",!0)],64)):ge("",!0)])],512),[[Ae,v.value==="preprocess"]]),se(e("div",bb,[e("div",fb,[u[76]||(u[76]=e("h4",{class:"group-title"},"è‡ªå®šä¹‰è¯·æ±‚å¤´",-1)),e("div",hb,[u[73]||(u[73]=e("label",{class:"form-label"},"Cookie",-1)),e("input",{type:"text",class:"form-input",value:H(t).settings.advanced.customCookie,onInput:u[32]||(u[32]=C=>H(t).setCustomCookie(C.target.value)),placeholder:"name=value; name2=value2"},null,40,yb)]),e("div",xb,[u[74]||(u[74]=e("label",{class:"form-label"},"Headers (JSON)",-1)),e("textarea",{class:"form-textarea",value:H(t).settings.advanced.customHeaders,onInput:u[33]||(u[33]=C=>H(t).setCustomHeaders(C.target.value)),rows:"3",placeholder:'{"X-Custom-Header": "value"}'},null,40,kb)]),e("div",_b,[e("label",Sb,[e("input",{type:"checkbox",checked:H(t).settings.advanced.bypassProxy,onChange:u[34]||(u[34]=C=>H(t).setBypassProxy(C.target.checked))},null,40,Cb),u[75]||(u[75]=Se(" ç»•è¿‡ç³»ç»Ÿä»£ç† (è¿æ¥æœ¬åœ°æœåŠ¡æ—¶ä½¿ç”¨) ",-1))])])])],512),[[Ae,v.value==="advanced"]])])):ge("",!0)]),Q.value&&U.value.length>0?(D(),L("div",wb,[e("div",{class:"logs-header",onClick:u[35]||(u[35]=C=>a.value=!a.value)},[e("span",$b,le(a.value?"â–¼":"â–¶"),1),u[77]||(u[77]=e("span",null,"AI å·¥ä½œæ—¥å¿—",-1)),A.value==="extracting"?(D(),L("span",Ib,"(æå–ä¸­...)")):ge("",!0)]),a.value?(D(),L("div",Tb,[(D(!0),L(qe,null,Ye(U.value,(C,ue)=>(D(),L("div",{key:ue,class:Me(["log-item",`log-${C.type}`])},[e("span",Db,"["+le(C.timestamp)+"]",1),e("span",Rb,le(C.message),1)],2))),128))])):ge("",!0)])):ge("",!0),T.value?(D(),L("div",Mb,[u[78]||(u[78]=e("span",{class:"error-icon"},"âŒ",-1)),e("span",Eb,le(T.value),1)])):ge("",!0),R.value?.success?(D(),L("div",Pb,[e("div",Bb,[e("span",Ab," ğŸ“– ã€Š"+le(R.value.comicTitle)+"ã€‹- "+le(R.value.chapterTitle),1),e("span",Fb,[e("span",Lb,"å…± "+le(R.value.totalPages)+" å¼ ",1),G.value?(D(),L("span",Ub,"| å¼•æ“: "+le(G.value),1)):ge("",!0)])]),e("div",Ob,[e("label",zb,[e("input",{type:"checkbox",checked:j.value,onChange:E},null,40,Nb),u[79]||(u[79]=Se(" å…¨é€‰ ",-1))]),e("span",Vb,"å·²é€‰: "+le(c.value)+" å¼ ",1)]),e("div",Kb,[(D(!0),L(qe,null,Ye(R.value.pages,C=>(D(),L("div",{key:C.pageNumber,class:Me(["image-item",{selected:g.value.has(C.pageNumber)}]),onClick:ue=>m(C.pageNumber)},[e("div",qb,[e("input",{type:"checkbox",checked:g.value.has(C.pageNumber),onClick:u[36]||(u[36]=Qe(()=>{},["stop"])),onChange:ue=>m(C.pageNumber)},null,40,Hb)]),e("div",Jb,[e("img",{src:k(C.imageUrl),alt:`ç¬¬${C.pageNumber}é¡µ`,loading:"lazy"},null,8,jb)]),e("div",Yb,"ç¬¬ "+le(C.pageNumber)+" é¡µ",1)],10,Wb))),128))])])):ge("",!0),A.value==="downloading"?(D(),L("div",Xb,[e("div",Gb," ä¸‹è½½è¿›åº¦: "+le(p.value.current)+"/"+le(p.value.total),1),e("div",Zb,[e("div",{class:"progress-fill",style:nt({width:`${b.value}%`})},null,4)])])):ge("",!0)]),e("div",Qb,[e("button",{class:"cancel-btn",onClick:f,disabled:A.value==="downloading"}," å–æ¶ˆ ",8,ef),e("button",{class:"import-btn",disabled:!R.value?.success||c.value===0||O.value,onClick:te},[A.value==="downloading"?(D(),L("span",of)):(D(),L("span",nf,"ğŸ“¥")),Se(" "+le(A.value==="downloading"?"ä¸‹è½½ä¸­...":"å¯¼å…¥"),1)],8,tf)])])])):ge("",!0)]))}}),af=He(sf,[["__scopeId","data-v-78fc5cb0"]]),lf={class:"app-header"},rf={class:"header-content"},uf={class:"logo-container"},cf={class:"header-links"},df={class:"container"},gf={id:"image-display-area"},pf={id:"upload-section",class:"card upload-card"},mf={class:"upload-actions"},vf={key:1,class:"bookshelf-mode-hint"},bf=Je({__name:"TranslateView",setup(n){const t=an(),l=je(),o=Ve(),a=gn(),r=it(),{validateBeforeTranslation:s,initValidation:i}=mn(),h=mo(),_=Jl(),v=S(!1),$=S(void 0),W=S(!1),z=S(!1),N=S(null),w=S(null),A=Y(()=>l.currentImage),U=Y(()=>l.hasImages);Y(()=>l.imageCount),Y(()=>l.currentImageIndex+1),Y(()=>U.value&&!l.isBatchTranslationInProgress),Y(()=>l.canGoPrevious),Y(()=>l.canGoNext);const R=Y(()=>l.isBatchTranslationInProgress);Y(()=>{if(!R.value)return 0;const ae=l.completedImageCount,J=l.imageCount;return J>0?Math.round(ae/J*100):0}),Y(()=>`${l.completedImageCount}/${l.imageCount}`);const g=Y(()=>l.failedImageCount>0),c=Y(()=>!!t.query.book&&!!t.query.chapter),p=Y(()=>t.query.book),b=Y(()=>t.query.chapter),T=Y(()=>_.currentBookTitle.value),O=Y(()=>_.currentChapterTitle.value),Q=Y(()=>c.value&&O.value&&T.value?`${O.value} - ${T.value}`:"Saber-Translator");ut(async()=>{l.clearImages(),r.clearBubbles(),await _.initializeApp(),i(),window.addEventListener("keydown",we)}),Dt(()=>{window.removeEventListener("keydown",we)}),ye(()=>[t.query.book,t.query.chapter],async([ae,J],[F,oe])=>{ae&&J?(l.clearImages(),r.clearBubbles(),await V()):F&&oe&&!ae&&!J&&(l.clearImages(),r.clearBubbles(),await _.initializeBookChapterContext(),console.log("[TranslateView] ä»ä¹¦æ¶æ¨¡å¼åˆ‡æ¢åˆ°å¿«é€Ÿç¿»è¯‘æ¨¡å¼ï¼Œå·²æ¸…ç©ºæ•°æ®"))}),ye(Q,ae=>{typeof document<"u"&&(document.title=ae)},{immediate:!0});async function V(){if(!(!p.value||!b.value))try{await _.initializeBookChapterContext()}catch(ae){console.error("åŠ è½½ç« èŠ‚ä¼šè¯å¤±è´¥:",ae),fe("åŠ è½½ç« èŠ‚ä¼šè¯å¤±è´¥","error")}}function G(ae){console.log(`ä¸Šä¼ å®Œæˆï¼Œå…± ${ae} å¼ å›¾ç‰‡`),l.hasImages&&(l.sortImagesByFileName(),_.switchImage(0))}async function j(ae){const J=A.value;if(!J||!J.bubbleStates||J.bubbleStates.length===0){fe("è¯·å…ˆé€‰æ‹©ä¸€å¼ å·²ç¿»è¯‘çš„å›¾ç‰‡","warning");return}if(l.images.length<=1){fe("åªæœ‰ä¸€å¼ å›¾ç‰‡ï¼Œæ— éœ€åº”ç”¨åˆ°å…¨éƒ¨","info");return}if(!Object.values(ae).some(oe=>oe)){fe("è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè¦åº”ç”¨çš„è®¾ç½®é¡¹","warning");return}try{const oe=J.bubbleStates[0],ee={};ae.fontSize&&(ee.fontSize=oe.fontSize),ae.fontFamily&&(ee.fontFamily=oe.fontFamily),ae.layoutDirection&&(ee.textDirection=oe.textDirection==="auto"?"vertical":oe.textDirection),ae.textColor&&(ee.textColor=oe.textColor),ae.fillColor&&(ee.fillColor=oe.fillColor),ae.strokeEnabled&&(ee.strokeEnabled=oe.strokeEnabled),ae.strokeColor&&(ee.strokeColor=oe.strokeColor),ae.strokeWidth&&(ee.strokeWidth=oe.strokeWidth);const re=$e=>{const _e={...$e};return ae.fontSize&&ee.fontSize!==void 0&&(_e.fontSize=ee.fontSize),ae.fontFamily&&ee.fontFamily!==void 0&&(_e.fontFamily=ee.fontFamily),ae.layoutDirection&&ee.textDirection!==void 0&&(_e.textDirection=ee.textDirection),ae.textColor&&ee.textColor!==void 0&&(_e.textColor=ee.textColor),ae.fillColor&&ee.fillColor!==void 0&&(_e.fillColor=ee.fillColor),ae.strokeEnabled&&ee.strokeEnabled!==void 0&&(_e.strokeEnabled=ee.strokeEnabled),ae.strokeColor&&ee.strokeColor!==void 0&&(_e.strokeColor=ee.strokeColor),ae.strokeWidth&&ee.strokeWidth!==void 0&&(_e.strokeWidth=ee.strokeWidth),_e};let ve=0;const xe=l.images;for(let $e=0;$e<xe.length;$e++){const _e=xe[$e];if(_e&&_e.bubbleStates&&_e.bubbleStates.length>0){const ze=_e.bubbleStates.map(re);l.updateImageByIndex($e,{bubbleStates:ze}),ve++}}if(r.bubbles.length>0){const $e=r.bubbles.map(re);r.setBubbles($e)}const be=[];ae.fontSize&&be.push("å­—å·"),ae.fontFamily&&be.push("å­—ä½“"),ae.layoutDirection&&be.push("æ’ç‰ˆæ–¹å‘"),ae.textColor&&be.push("æ–‡å­—é¢œè‰²"),ae.fillColor&&be.push("å¡«å……é¢œè‰²"),ae.strokeEnabled&&be.push("æè¾¹å¼€å…³"),ae.strokeColor&&be.push("æè¾¹é¢œè‰²"),ae.strokeWidth&&be.push("æè¾¹å®½åº¦");const pe=[];for(let $e=0;$e<xe.length;$e++){const _e=xe[$e];_e&&_e.translatedDataURL&&_e.bubbleStates&&_e.bubbleStates.length>0&&pe.push($e)}if(pe.length>0){const{apiClient:$e}=await lt(async()=>{const{apiClient:Le}=await import("./client.Bht704G-.js");return{apiClient:Le}},__vite__mapDeps([4,5])),_e=o.settings.textStyle.layoutDirection,ze=_e==="auto";for(let Le=0;Le<pe.length;Le++){const De=pe[Le];if(De===void 0)continue;const Ie=l.images[De];if(!(!Ie||!Ie.bubbleStates))try{let Xe="";if(Ie.cleanImageData?Xe=Ie.cleanImageData.includes("base64,")?Ie.cleanImageData.split("base64,")[1]||"":Ie.cleanImageData:Ie.originalDataURL&&(Xe=Ie.originalDataURL.includes("base64,")?Ie.originalDataURL.split("base64,")[1]||"":Ie.originalDataURL,console.log(`handleApplyToAll: å›¾ç‰‡ ${De} ä½¿ç”¨åŸå›¾ä½œä¸ºèƒŒæ™¯ï¼ˆå…œåº•ï¼‰`)),!Xe){console.log(`handleApplyToAll: å›¾ç‰‡ ${De} æ²¡æœ‰å¯ç”¨çš„èƒŒæ™¯å›¾ï¼Œè·³è¿‡`);continue}const at=Ie.bubbleStates.map(ke=>({translatedText:ke.translatedText||"",coords:ke.coords,fontSize:ke.fontSize||o.settings.textStyle.fontSize,fontFamily:ke.fontFamily||o.settings.textStyle.fontFamily,textDirection:_t(ke),textColor:ke.textColor||o.settings.textStyle.textColor,rotationAngle:ke.rotationAngle||0,position:ke.position||{x:0,y:0},strokeEnabled:ke.strokeEnabled??o.settings.textStyle.strokeEnabled,strokeColor:ke.strokeColor||o.settings.textStyle.strokeColor,strokeWidth:ke.strokeWidth??o.settings.textStyle.strokeWidth})),rt=await $e.post("/api/re_render_image",{clean_image:Xe,bubble_texts:at.map(ke=>ke.translatedText),bubble_coords:at.map(ke=>ke.coords),fontSize:o.settings.textStyle.fontSize,fontFamily:o.settings.textStyle.fontFamily,textDirection:ze?"vertical":_e,textColor:o.settings.textStyle.textColor,bubble_states:at,use_individual_styles:!0,use_inpainting:!1,use_lama:!1,fillColor:null,is_font_style_change:!0,strokeEnabled:o.settings.textStyle.strokeEnabled,strokeColor:o.settings.textStyle.strokeColor,strokeWidth:o.settings.textStyle.strokeWidth});rt.rendered_image&&l.updateImageByIndex(De,{translatedDataURL:`data:image/png;base64,${rt.rendered_image}`,hasUnsavedChanges:!0})}catch(Xe){console.error(`é‡æ¸²æŸ“å›¾ç‰‡ ${De} å¤±è´¥:`,Xe)}}}fe(`å·²å°† ${be.join("ã€")} åº”ç”¨åˆ° ${ve} å¼ å›¾ç‰‡`,"success"),console.log(`[TranslateView] åº”ç”¨è®¾ç½®åˆ°å…¨éƒ¨å®Œæˆï¼Œæ›´æ–°äº† ${ve} å¼ å›¾ç‰‡ï¼Œé‡æ¸²æŸ“äº† ${pe.length} å¼ `)}catch(oe){console.error("åº”ç”¨è®¾ç½®åˆ°å…¨éƒ¨å¤±è´¥:",oe),fe("åº”ç”¨è®¾ç½®å¤±è´¥","error")}}async function k(){A.value&&s("normal")&&await h.translateCurrentImage()}async function y(){U.value&&s("normal")&&await h.translateAllImages()}async function I(){U.value&&s("hq")&&await h.executeHqTranslation()}async function f(){U.value&&s("proofread")&&await h.executeProofreading()}async function d(){A.value&&await h.removeTextOnly()}async function m(){U.value&&await h.removeAllTexts()}function E(){if(!A.value)return;const ae=A.value.fileName||`å›¾ç‰‡ ${l.currentImageIndex+1}`;confirm(`ç¡®å®šè¦åˆ é™¤å½“å‰å›¾ç‰‡ (${ae}) å—ï¼Ÿ`)&&(l.deleteCurrentImage(),fe("å›¾ç‰‡å·²åˆ é™¤","success"))}function te(){U.value&&confirm("ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰å›¾ç‰‡å—ï¼Ÿè¿™å°†ä¸¢å¤±æ‰€æœ‰æœªä¿å­˜çš„è¿›åº¦ã€‚")&&(l.clearImages(),fe("æ‰€æœ‰å›¾ç‰‡å·²æ¸…é™¤","success"))}async function M(){try{const ae=await ln(),J=await io();if(ae.success&&J.success)fe("ä¸´æ—¶æ–‡ä»¶æ¸…ç†å®Œæˆ","success");else{const F=[];ae.success||F.push("è°ƒè¯•æ–‡ä»¶æ¸…ç†å¤±è´¥"),J.success||F.push("ä¸´æ—¶æ–‡ä»¶æ¸…ç†å¤±è´¥"),fe(F.join("ï¼Œ"),"warning")}}catch{fe("æ¸…ç†ä¸´æ—¶æ–‡ä»¶å¤±è´¥","error")}}function Z(){_.goToPrevious()}function B(){_.goToNext()}function x(){z.value=!z.value}async function K(){if(!g.value){fe("æ²¡æœ‰å¤±è´¥çš„å›¾ç‰‡éœ€è¦é‡æ–°ç¿»è¯‘","info");return}s("normal")&&await h.retryFailedImages()}async function u(){if(!U.value){fe("æ²¡æœ‰å¯ä¿å­˜çš„å†…å®¹","warning");return}if(!(!p.value||!b.value))try{await a.saveChapterSession(p.value,b.value)?fe("ç« èŠ‚è¿›åº¦å·²ä¿å­˜","success"):fe("ä¿å­˜å¤±è´¥","error")}catch(ae){console.error("ä¿å­˜ä¼šè¯å¤±è´¥:",ae),fe("ä¿å­˜å¤±è´¥: "+(ae instanceof Error?ae.message:"æœªçŸ¥é”™è¯¯"),"error")}}function C(ae){$.value=ae,v.value=!0}function ue(){C("plugins")}function P(){fe("è®¾ç½®å·²ä¿å­˜","success")}function ne(){W.value=!0}function de(){fe("ğŸŒ™ è¯¥åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­ï¼Œæ•¬è¯·æœŸå¾…ï¼","info")}function we(ae){const J=ae.target;if(!(J instanceof HTMLInputElement||J instanceof HTMLTextAreaElement||J.getAttribute("contenteditable")==="true"||J.id==="bubbleTextEditor")&&!z.value&&ae.altKey)switch(ae.key){case"ArrowLeft":ae.preventDefault(),Z();break;case"ArrowRight":ae.preventDefault(),B();break;case"ArrowUp":if(ae.preventDefault(),!o.settings.textStyle.autoFontSize){const oe=o.settings.textStyle.fontSize;o.updateTextStyle({fontSize:oe+1})}break;case"ArrowDown":if(ae.preventDefault(),!o.settings.textStyle.autoFontSize){const oe=o.settings.textStyle.fontSize;o.updateTextStyle({fontSize:Math.max(10,oe-1)})}break}}async function Te(ae){const J=A.value;if(!J||!J.translatedDataURL){console.log(`è‡ªåŠ¨å­—å·è®¾ç½®å˜æ›´: ${ae} (ä»…å½±å“ä¸‹æ¬¡ç¿»è¯‘)`);return}const F=J.bubbleStates;if(!F||!Array.isArray(F)||F.length===0){console.log("å½“å‰å›¾ç‰‡æ²¡æœ‰ bubbleStatesï¼Œè·³è¿‡é‡æ¸²æŸ“");return}if(console.log(`è‡ªåŠ¨å­—å·è®¾ç½®å˜æ›´: ${ae}ï¼Œå°†é‡æ–°æ¸²æŸ“...`),ae){console.log("è‡ªåŠ¨å­—å·å·²å¼€å¯ï¼Œé‡æ–°è®¡ç®—å­—å·å¹¶æ¸²æŸ“...");try{const{apiClient:oe}=await lt(async()=>{const{apiClient:pe}=await import("./client.Bht704G-.js");return{apiClient:pe}},__vite__mapDeps([4,5]));let ee="";if(J.cleanImageData){const pe=J.cleanImageData;ee=pe.includes("base64,")?pe.split("base64,")[1]||"":pe}else J.originalDataURL&&(ee=J.originalDataURL.includes("base64,")?J.originalDataURL.split("base64,")[1]||"":J.originalDataURL);if(!ee){console.log("æ²¡æœ‰å¯ç”¨çš„èƒŒæ™¯å›¾ï¼Œè·³è¿‡é‡æ¸²æŸ“");return}const re=F.map(pe=>({translatedText:pe.translatedText||"",coords:pe.coords,fontSize:pe.fontSize||o.settings.textStyle.fontSize,fontFamily:pe.fontFamily||o.settings.textStyle.fontFamily,textDirection:_t(pe),textColor:pe.textColor||o.settings.textStyle.textColor,rotationAngle:pe.rotationAngle||0,position:pe.position||{x:0,y:0},strokeEnabled:pe.strokeEnabled??o.settings.textStyle.strokeEnabled,strokeColor:pe.strokeColor||o.settings.textStyle.strokeColor,strokeWidth:pe.strokeWidth??o.settings.textStyle.strokeWidth})),ve=re.map(pe=>pe.translatedText),xe=re.map(pe=>pe.coords),be=await oe.post("/api/re_render_image",{clean_image:ee,bubble_texts:ve,bubble_coords:xe,fontSize:o.settings.textStyle.fontSize,fontFamily:o.settings.textStyle.fontFamily,textDirection:o.settings.textStyle.layoutDirection==="auto"?"vertical":o.settings.textStyle.layoutDirection,textColor:o.settings.textStyle.textColor,bubble_states:re,use_individual_styles:!0,use_inpainting:!1,use_lama:!1,fillColor:null,is_font_style_change:!0,autoFontSize:!0,strokeEnabled:o.settings.textStyle.strokeEnabled,strokeColor:o.settings.textStyle.strokeColor,strokeWidth:o.settings.textStyle.strokeWidth});if(be.rendered_image){if(be.bubble_states&&Array.isArray(be.bubble_states)){const pe=F.map(($e,_e)=>({...$e,fontSize:be.bubble_states[_e]?.fontSize??$e.fontSize}));l.updateCurrentImage({translatedDataURL:`data:image/png;base64,${be.rendered_image}`,bubbleStates:pe,hasUnsavedChanges:!0}),r.setBubbles(pe)}else l.updateCurrentImage({translatedDataURL:`data:image/png;base64,${be.rendered_image}`,hasUnsavedChanges:!0});console.log("è‡ªåŠ¨å­—å·æ¸²æŸ“æˆåŠŸ")}else be.error&&(console.error("è‡ªåŠ¨å­—å·æ¸²æŸ“å¤±è´¥:",be.error),fe("é‡æ–°æ¸²æŸ“å¤±è´¥: "+be.error,"error"))}catch(oe){console.error("è‡ªåŠ¨å­—å·æ¸²æŸ“å‡ºé”™:",oe)}}else{const oe=o.settings.textStyle.fontSize;console.log(`è‡ªåŠ¨å­—å·å·²å…³é—­ï¼Œä½¿ç”¨å›ºå®šå­—å· ${oe} æ¸²æŸ“...`);const ee=F.map(re=>({...re,fontSize:oe}));l.updateCurrentImage({bubbleStates:ee}),r.setBubbles(ee),await Fe("fontSize",oe)}}async function Fe(ae,J){const F=A.value;if(!F||!F.translatedDataURL||!F.bubbleStates||F.bubbleStates.length===0||!["fontSize","fontFamily","layoutDirection","textColor","strokeEnabled","strokeColor","strokeWidth","fillColor"].includes(ae))return;console.log(`å…¨å±€è®¾ç½®å˜æ›´ (${ae}=${J})ï¼Œå‡†å¤‡é‡æ¸²æŸ“...`);const re={fontSize:"fontSize",fontFamily:"fontFamily",layoutDirection:"textDirection",textColor:"textColor",strokeEnabled:"strokeEnabled",strokeColor:"strokeColor",strokeWidth:"strokeWidth",fillColor:"fillColor"}[ae];if(re&&F.bubbleStates)if(ae==="layoutDirection"&&J==="auto")console.log("æ’ç‰ˆæ–¹å‘è®¾ç½®ä¸º 'auto'ï¼Œä¸ä¿®æ”¹æ°”æ³¡çš„ textDirectionï¼Œä½¿ç”¨ autoTextDirection æ¸²æŸ“");else{const ve=F.bubbleStates.map(xe=>({...xe,[re]:J}));l.updateCurrentImage({bubbleStates:ve}),r.setBubbles(ve)}try{const xe=l.currentImage?.bubbleStates||F.bubbleStates||[];if(xe.length===0||!xe[0]?.coords){console.log("æ²¡æœ‰æœ‰æ•ˆçš„æ°”æ³¡åæ ‡ï¼Œè·³è¿‡é‡æ¸²æŸ“");return}const be=o.settings.textStyle.layoutDirection,pe=xe.map(Ie=>({translatedText:Ie.translatedText||"",coords:Ie.coords,fontSize:Ie.fontSize||o.settings.textStyle.fontSize,fontFamily:Ie.fontFamily||o.settings.textStyle.fontFamily,textDirection:_t(Ie),textColor:Ie.textColor||o.settings.textStyle.textColor,rotationAngle:Ie.rotationAngle||0,position:Ie.position||{x:0,y:0},strokeEnabled:Ie.strokeEnabled??o.settings.textStyle.strokeEnabled,strokeColor:Ie.strokeColor||o.settings.textStyle.strokeColor,strokeWidth:Ie.strokeWidth??o.settings.textStyle.strokeWidth})),$e=pe.map(Ie=>Ie.translatedText),_e=pe.map(Ie=>Ie.coords);let ze="";if(F.cleanImageData){const Ie=F.cleanImageData;ze=Ie.includes("base64,")?Ie.split("base64,")[1]||"":Ie}else F.originalDataURL&&(ze=F.originalDataURL.includes("base64,")?F.originalDataURL.split("base64,")[1]||"":F.originalDataURL,console.log("handleTextStyleChanged: ä½¿ç”¨åŸå›¾ä½œä¸ºèƒŒæ™¯ï¼ˆå…œåº•ï¼‰"));if(!ze){console.log("æ²¡æœ‰å¯ç”¨çš„èƒŒæ™¯å›¾ï¼Œè·³è¿‡é‡æ¸²æŸ“");return}const{apiClient:Le}=await lt(async()=>{const{apiClient:Ie}=await import("./client.Bht704G-.js");return{apiClient:Ie}},__vite__mapDeps([4,5])),De=await Le.post("/api/re_render_image",{clean_image:ze,bubble_texts:$e,bubble_coords:_e,fontSize:o.settings.textStyle.fontSize,fontFamily:o.settings.textStyle.fontFamily,textDirection:be==="auto"?"vertical":be,textColor:o.settings.textStyle.textColor,bubble_states:pe,use_individual_styles:!0,use_inpainting:!1,use_lama:!1,fillColor:null,is_font_style_change:!0,strokeEnabled:o.settings.textStyle.strokeEnabled,strokeColor:o.settings.textStyle.strokeColor,strokeWidth:o.settings.textStyle.strokeWidth});De.rendered_image?(l.updateCurrentImage({translatedDataURL:`data:image/png;base64,${De.rendered_image}`,hasUnsavedChanges:!0}),console.log("è®¾ç½®å˜æ›´åé‡æ–°æ¸²æŸ“æˆåŠŸ")):De.error&&console.error("é‡æ–°æ¸²æŸ“å¤±è´¥:",De.error)}catch(ve){console.error("è®¾ç½®å˜æ›´åé‡æ–°æ¸²æŸ“å¤±è´¥:",ve)}}function Ee(ae){_.switchImage(ae)}return(ae,J)=>{const F=Qn("router-link");return D(),L("div",{class:Me(["translate-page",{"edit-mode-active":z.value}])},[e("header",lf,[e("div",rf,[e("div",uf,[he(F,{to:"/",title:"è¿”å›ä¹¦æ¶"},{default:ht(()=>[...J[3]||(J[3]=[e("img",{src:"/pic/logo.png",alt:"Saber-Translator Logo",class:"app-logo"},null,-1),e("span",{class:"app-name"},"Saber-Translator",-1)])]),_:1})]),e("div",cf,[he(F,{to:"/",class:"back-to-shelf",title:"è¿”å›ä¹¦æ¶"},{default:ht(()=>[...J[4]||(J[4]=[Se("ğŸ“š",-1)])]),_:1}),c.value?(D(),L("button",{key:0,class:"save-header-btn",title:"ä¿å­˜è¿›åº¦",onClick:u}," ğŸ’¾ ")):ge("",!0),e("button",{id:"openSettingsBtn",class:"settings-header-btn",title:"æ‰“å¼€è®¾ç½®",onClick:J[0]||(J[0]=oe=>C())},[...J[5]||(J[5]=[e("span",{class:"icon"},"âš™ï¸",-1),e("span",null,"è®¾ç½®",-1)])]),J[8]||(J[8]=e("a",{href:"http://www.mashirosaber.top",target:"_blank",class:"tutorial-link"},"ä½¿ç”¨æ•™ç¨‹",-1)),e("a",{href:"javascript:void(0)",class:"donate-link",onClick:ne},[...J[6]||(J[6]=[e("span",null,"â¤ï¸ è¯·ä½œè€…å–å¥¶èŒ¶",-1)])]),J[9]||(J[9]=e("a",{href:"https://github.com/MashiroSaber03",target:"_blank",class:"github-link"},[e("img",{src:"/pic/github.jpg",alt:"GitHub",class:"github-icon"})],-1)),e("button",{class:"theme-toggle",title:"åŠŸèƒ½å¼€å‘ä¸­",onClick:de},[...J[7]||(J[7]=[e("span",{class:"theme-icon"},"â˜€ï¸",-1)])])])])]),e("div",df,[he(Ka,{onTranslateCurrent:k,onTranslateAll:y,onHqTranslate:I,onProofread:f,onRemoveText:d,onRemoveAllText:m,onRetryFailed:K,onDeleteCurrent:E,onClearAll:te,onCleanTemp:M,onOpenPlugins:ue,onOpenSettings:C,onPrevious:Z,onNext:B,onApplyToAll:j,onTextStyleChanged:Fe,onAutoFontSizeChanged:Te}),e("main",gf,[e("section",pf,[e("div",mf,[he(Ns,{ref_key:"imageUploadRef",ref:N,onUploadComplete:G},null,512)]),H(a).loadingProgress.total>0?(D(),st(go,{key:0,visible:!0,percentage:H(a).loadingProgress.current/H(a).loadingProgress.total*100,label:H(a).loadingProgress.message},null,8,["percentage","label"])):ge("",!0),he(Ql,{progress:H(h).progress.value},null,8,["progress"]),R.value&&c.value?(D(),L("div",vf,[...J[10]||(J[10]=[e("span",{style:{color:"#888","font-size":"0.85em"}}," ï¼ˆä¹¦æ¶æ¨¡å¼ä¸‹é€€å‡ºå‰è¯·ç‚¹å‡»é¡¶éƒ¨ä¿å­˜æŒ‰é’®ï¼‰ ",-1)])])):ge("",!0)]),he(gl,{ref_key:"imageResultRef",ref:w,"is-edit-mode":z.value,onToggleEditMode:x,onRetryFailed:K},null,8,["is-edit-mode"])]),U.value&&!z.value?(D(),st(di,{key:0,onSelect:Ee})):ge("",!0)]),A.value&&z.value?(D(),st(Rm,{key:0,"is-edit-mode-active":z.value,onExit:x},null,8,["is-edit-mode-active"])):ge("",!0),he(fl,{onOpenSettings:C}),he(Sg,{modelValue:v.value,"onUpdate:modelValue":J[1]||(J[1]=oe=>v.value=oe),"initial-tab":$.value,onSave:P},null,8,["modelValue","initial-tab"]),W.value?(D(),st(ti,{key:1,onClose:J[2]||(J[2]=oe=>W.value=!1)})):ge("",!0),he(af)],2)}}}),$f=He(bf,[["__scopeId","data-v-518dd956"]]);export{$f as default};
