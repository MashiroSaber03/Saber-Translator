const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["js/index.71kVCBu7.js","js/vue-vendor.BU3zOQRA.js","assets/index.BYanE9pL.css","js/session.Kpy-QhBa.js","js/client.Bht704G-.js","js/utils-vendor.B9ygI19o.js"])))=>i.map(i=>d[i]);
import{D as on,b as an,c as sn,d as Hn,a as lt,_ as je,u as Qe,s as we,e as dt,f as To,g as Io,h as Do,i as Ro,j as Mn,k as Bn,B as En,l as Pn,m as Mo,F as Xt,n as An,o as Fn,p as Bo,L as Ln}from"./index.71kVCBu7.js";import{d as ln,r as y,c as oe,a as Ge,i as J,v as Te,e,t as xe,x as it,h as V,b as rt,n as Le,B as Ke,l as ut,y as ue,G as qe,f as Ie,H as Un,w as _t,I as tt,u as he,F as Ze,j as et,J as Jn,K as Re,D as ct,L as St,z as Ee,M as Eo,k as nt,N as Qt,o as It,O as yt,P as On,E as Po}from"./vue-vendor.BU3zOQRA.js";import{p as Ao,a as Fo,b as Lo,c as Uo,d as Oo,e as zo,f as Vo,h as No,i as Wo,j as Ko,k as rn,l as Yn}from"./system.CmjDD-4C.js";import{getFontList as Xn,uploadFont as qo,getTextboxPrompts as Ho,getPrompts as Jo,configApi as He,getFontListApi as Yo}from"./config.CwRcCkM9.js";import{_ as We}from"./CustomSelect.vue_vue_type_style_index_0_lang.qSOIWfjV.js";import{apiClient as at}from"./client.Bht704G-.js";import{B as jn}from"./BaseModal._UcugYoc.js";import{getBookDetail as Xo}from"./bookshelf.CDzdK045.js";import"./utils-vendor.B9ygI19o.js";async function Et(n){return at.post("/api/translate_image",n)}async function un(n){return at.post("/api/re_render_image",n)}async function jo(n){try{return{success:!0,data:await at.post("/api/translate_single_text",n)}}catch(r){return{success:!1,error:r instanceof Error?r.message:"翻译失败"}}}async function en(n){return at.post("/api/hq_translate_batch",n)}async function tn(n,r,u){return at.post("/api/detect_boxes",{image:n,detector_type:r,...u})}async function Gn(n,r,u,o){return at.post("/api/ocr_single_bubble",{image_data:n,bubble_coords:r,ocr_engine:u,...o})}async function cn(n,r,u){return at.post("/api/inpaint_single_bubble",{image_data:n,bubble_coords:r,bubble_angle:u?.bubbleAngle??0,method:u?.method??"lama",lama_model:u?.lamaModel??"lama_mpe",...u?.maskData&&{mask_data:u.maskData}})}const Go=Object.freeze(Object.defineProperty({__proto__:null,detectBoxes:tn,hqTranslateBatch:en,inpaintSingleBubble:cn,ocrSingleBubble:Gn,reRenderImage:un,translateImage:Et,translateSingleText:jo},Symbol.toStringTag,{value:"Module"}));async function Zo(){return at.get("/api/plugins")}async function Qo(n){const r=encodeURIComponent(n);return at.post(`/api/plugins/${r}/enable`)}async function ea(n){const r=encodeURIComponent(n);return at.post(`/api/plugins/${r}/disable`)}async function ta(n){const r=encodeURIComponent(n);return at.delete(`/api/plugins/${r}`)}async function na(n){const r=encodeURIComponent(n);return at.get(`/api/plugins/${r}/config_schema`)}async function oa(n){const r=encodeURIComponent(n);return at.get(`/api/plugins/${r}/config`)}async function aa(n,r){const u=encodeURIComponent(n);return at.post(`/api/plugins/${u}/config`,r)}async function sa(){return at.get("/api/plugins/default_states")}async function la(n,r){const u=encodeURIComponent(n);return at.post(`/api/plugins/${u}/set_default_state`,{enabled:r})}async function ia(){return{states:(await sa()).default_states}}const ra=la,ua=na,ca=oa,da=aa;function ga(){return`img_${Date.now()}_${Math.random().toString(36).substring(2,9)}`}function zn(n,r,u){return{id:ga(),fileName:n,originalDataURL:r,translatedDataURL:null,cleanImageData:null,bubbleStates:null,translationStatus:"pending",translationFailed:!1,fontSize:25,autoFontSize:!0,fontFamily:"fonts/STSONG.TTF",layoutDirection:"vertical",textColor:"#000000",fillColor:Hn,inpaintMethod:"solid",strokeEnabled:sn,strokeColor:an,strokeWidth:on,hasUnsavedChanges:!1,...u}}const st=ln("image",()=>{const n=y([]),r=y(-1),u=y(!1),o=y(!1),a=y(null),i=oe(()=>r.value>=0&&r.value<n.value.length?n.value[r.value]??null:null),t=oe(()=>n.value.length),s=oe(()=>n.value.length>0),k=oe(()=>r.value>0),A=oe(()=>r.value<n.value.length-1),$=oe(()=>n.value.filter(m=>m.translationFailed).length),N=oe(()=>n.value.filter(m=>m.translationStatus==="completed").length),ae=oe(()=>n.value.filter(m=>m.translationStatus==="pending").length);function le(m,C,c){const U=zn(m,C,c);return n.value.push(U),n.value.length===1&&(r.value=0),console.log(`图片已添加: ${m}，当前共 ${n.value.length} 张图片`),U}function Z(m){const C=m.map(({fileName:U,originalDataURL:fe,overrides:K})=>zn(U,fe,K)),c=n.value.length===0;return n.value.push(...C),c&&n.value.length>0&&(r.value=0),console.log(`批量添加了 ${C.length} 张图片，当前共 ${n.value.length} 张`),C}function w(m){n.value=m.map(C=>({...C,strokeEnabled:C.strokeEnabled??sn,strokeColor:C.strokeColor||an,strokeWidth:C.strokeWidth??on,hasUnsavedChanges:C.hasUnsavedChanges||!1})),n.value.length>0?r.value=Math.min(Math.max(0,r.value),n.value.length-1):r.value=-1,console.log(`图片数组已设置，共 ${n.value.length} 张图片`)}function Q(m){return m<0||m>=n.value.length?(console.warn(`删除失败: 无效的索引 ${m}`),!1):(n.value.splice(m,1),r.value===m?(r.value=Math.min(m,n.value.length-1),n.value.length===0&&(r.value=-1)):r.value>m&&r.value--,console.log(`图片已删除，当前共 ${n.value.length} 张图片`),!0)}function j(){return Q(r.value)}function H(){n.value=[],r.value=-1,u.value=!1,o.value=!1,a.value=null,console.log("所有图片已清除")}function d(){const m=i.value?.id||null;if(n.value.sort((C,c)=>C.fileName.localeCompare(c.fileName,void 0,{numeric:!0,sensitivity:"base"})),m){const C=n.value.findIndex(c=>c.id===m);C>=0&&C!==r.value&&(console.log(`图片排序: currentImageIndex 从 ${r.value} 更新为 ${C}`),r.value=C)}console.log("图片已按文件名排序")}function l(m){m>=-1&&m<n.value.length?(r.value=m,console.log(`当前图片索引已设置为 ${m}`)):console.warn(`设置索引失败: 无效的索引 ${m}`)}function _(){return k.value?(r.value--,!0):!1}function x(){return A.value?(r.value++,!0):!1}function z(m){i.value?(Object.assign(i.value,m),console.log("当前图片属性已更新:",Object.keys(m))):console.warn("更新失败: 当前没有选中的图片")}function ee(m,C){if(m>=0&&m<n.value.length){const c=n.value[m];c&&(Object.assign(c,C),console.log(`图片 ${m} 属性已更新:`,Object.keys(C)))}else console.warn(`更新失败: 无效的索引 ${m}`)}function be(m){i.value&&(i.value.bubbleStates=m,i.value.hasUnsavedChanges=!0,console.log(`当前图片气泡状态已更新，共 ${m?.length??0} 个气泡`))}function G(m){i.value&&(i.value.isManuallyAnnotated=m,i.value.hasUnsavedChanges=!0,console.log(`手动标注标记已设置为: ${m}`))}function F(m,C){i.value?(i.value[m]=C,i.value.hasUnsavedChanges=!0,console.log(`当前图片属性 ${String(m)} 已更新`)):console.warn("更新失败: 当前没有选中的图片")}function B(m,C){i.value&&(i.value.translatedDataURL=m,C&&(i.value.cleanImageData=C),i.value.translationStatus="completed",i.value.translationFailed=!1,i.value.hasUnsavedChanges=!0,console.log("当前图片翻译结果已更新"))}function S(m,C,c){if(m>=0&&m<n.value.length){const U=n.value[m];U&&(U.translationStatus=C,U.translationFailed=C==="failed",c&&(U.errorMessage=c),console.log(`图片 ${m} 翻译状态: ${C}`))}}function v(m){i.value&&(i.value.translationStatus="failed",i.value.translationFailed=!0,i.value.errorMessage=m,console.log(`当前图片翻译失败: ${m}`))}function I(){n.value.forEach(m=>{m.translationStatus="pending",m.translationFailed=!1,m.errorMessage=void 0}),console.log("所有图片翻译状态已重置")}function T(m){u.value=m,m||(o.value=!1,a.value=null),console.log(`批量翻译状态: ${m?"进行中":"已完成"}`)}function p(m){o.value=m,console.log(`批量翻译暂停状态: ${m?"已暂停":"继续中"}`)}function f(m){a.value=m}function te(){if(o.value&&a.value){o.value=!1;const m=a.value;a.value=null,m(),console.log("批量翻译已继续")}}function se(){return n.value.map((m,C)=>m.translationFailed?C:-1).filter(m=>m!==-1)}return{images:n,currentImageIndex:r,isBatchTranslationInProgress:u,isBatchTranslationPaused:o,batchTranslationResumeCallback:a,currentImage:i,imageCount:t,hasImages:s,canGoPrevious:k,canGoNext:A,failedImageCount:$,completedImageCount:N,pendingImageCount:ae,addImage:le,addImages:Z,setImages:w,deleteImage:Q,deleteCurrentImage:j,clearImages:H,sortImagesByFileName:d,setCurrentImageIndex:l,goToPrevious:_,goToNext:x,updateCurrentImage:z,updateImageByIndex:ee,updateCurrentBubbleStates:be,setManuallyAnnotated:G,updateCurrentImageProperty:F,updateCurrentTranslationResult:B,setTranslationStatus:S,markCurrentAsFailed:v,resetAllTranslationStatus:I,setBatchTranslationInProgress:T,setBatchTranslationPaused:p,setBatchTranslationResumeCallback:f,resumeBatchTranslation:te,getFailedImageIndices:se}}),Vn=Object.freeze(Object.defineProperty({__proto__:null,useImageStore:st},Symbol.toStringTag,{value:"Module"})),Zn=ln("session",()=>{const n=y(null),r=y({bookId:null,chapterId:null,bookTitle:null,chapterTitle:null}),u=y([]),o=y(!1),a=y({current:0,total:0,message:""}),i=y(null),t=y(!1),s=oe(()=>r.value.bookId!==null&&r.value.chapterId!==null),k=oe(()=>r.value.bookId),A=oe(()=>r.value.chapterId);function $(S,v,I=null,T=null){r.value={bookId:S,chapterId:v,bookTitle:I,chapterTitle:T},console.log(`会话上下文已设置: 书籍=${S}, 章节=${v}`)}function N(S,v,I,T){$(S,v,I,T)}function ae(){r.value={bookId:null,chapterId:null,bookTitle:null,chapterTitle:null},console.log("会话上下文已清除")}function le(S){const v=S.get("book"),I=S.get("chapter");v&&I&&$(v,I)}function Z(S){n.value=S,console.log(`当前会话名称: ${S}`)}function w(){n.value=null}function Q(S){u.value=S,console.log(`会话列表已更新，共 ${S.length} 个会话`)}function j(S){const v=u.value.findIndex(I=>I.name===S.name);v>=0?u.value[v]=S:u.value.unshift(S)}function H(S){const v=u.value.findIndex(I=>I.name===S);v>=0&&u.value.splice(v,1)}function d(S,v){const I=u.value.find(T=>T.name===S);I&&(I.name=v)}function l(S){o.value=S}function _(S){t.value=S}function x(S){i.value=S}function z(S,v,I,T){return{name:S,version:"2.0",savedAt:new Date().toISOString(),imageCount:v.length,ui_settings:T,images:v.map(p=>({originalDataURL:p.originalDataURL,translatedDataURL:p.translatedDataURL||void 0,cleanImageData:p.cleanImageData||void 0,bubbleStates:p.bubbleStates||void 0,isManuallyAnnotated:p.isManuallyAnnotated||void 0,fileName:p.fileName,fontSize:p.fontSize,autoFontSize:p.autoFontSize,fontFamily:p.fontFamily,layoutDirection:p.layoutDirection,textColor:p.textColor,fillColor:p.fillColor,inpaintMethod:p.inpaintMethod,strokeEnabled:p.strokeEnabled,strokeColor:p.strokeColor,strokeWidth:p.strokeWidth,translationStatus:p.translationStatus,translationFailed:p.translationFailed})),currentImageIndex:I}}function ee(){n.value=null,r.value={bookId:null,chapterId:null,bookTitle:null,chapterTitle:null},u.value=[],o.value=!1,t.value=!1,i.value=null,console.log("会话状态已重置")}async function be(S){if(!S||typeof S!="string")return null;if(S.startsWith("data:"))return S;if(!S.startsWith("/api/"))return null;try{const v=await fetch(S);if(!v.ok)return null;const I=await v.blob();return new Promise(T=>{const p=new FileReader;p.onloadend=()=>T(p.result),p.onerror=()=>T(null),p.readAsDataURL(I)})}catch(v){return console.error(`转换图片 URL 失败: ${S}`,v),null}}async function G(S,v){const I=S.length;for(let T=0;T<I;T++){const p=S[T];if(p){if(v&&v(T+1,I),p.originalDataURL&&p.originalDataURL.startsWith("/api/")){const f=await be(p.originalDataURL);f&&(p.originalDataURL=f)}if(p.translatedDataURL&&p.translatedDataURL.startsWith("/api/")){const f=await be(p.translatedDataURL);f&&(p.translatedDataURL=f)}if(p.cleanImageData&&p.cleanImageData.startsWith("/api/")){const f=await be(p.cleanImageData);f&&(p.cleanImageData=f.replace(/^data:image\/\w+;base64,/,""))}}}}async function F(S){l(!0),x(null),a.value={current:0,total:0,message:"正在加载..."};try{const{useImageStore:v}=await lt(async()=>{const{useImageStore:U}=await Promise.resolve().then(()=>Vn);return{useImageStore:U}},void 0),{useSettingsStore:I}=await lt(async()=>{const{useSettingsStore:U}=await import("./index.71kVCBu7.js").then(fe=>fe.q);return{useSettingsStore:U}},__vite__mapDeps([0,1,2])),{useBubbleStore:T}=await lt(async()=>{const{useBubbleStore:U}=await Promise.resolve().then(()=>tl);return{useBubbleStore:U}},void 0),p=v(),f=I(),te=T(),{loadSessionByPathApi:se}=await lt(async()=>{const{loadSessionByPathApi:U}=await import("./session.Kpy-QhBa.js");return{loadSessionByPathApi:U}},__vite__mapDeps([3,4,5])),m=await se(S);if(!m.success||!m.session)throw new Error(m.error||"加载会话失败");const C=m.session;if(C.images&&C.images.length>0){const U=C.images.map((Y,Se)=>({id:`session-${Se}-${Date.now()}`,originalDataURL:Y.originalDataURL,translatedDataURL:Y.translatedDataURL||null,cleanImageData:Y.cleanImageData||null,bubbleStates:Y.bubbleStates!==void 0&&Y.bubbleStates!==null?Y.bubbleStates:null,isManuallyAnnotated:!!Y.isManuallyAnnotated,fileName:Y.fileName||`image-${Se+1}.png`,translationStatus:Y.translationStatus||"pending",translationFailed:!!Y.translationFailed,hasUnsavedChanges:!1,fontSize:Y.fontSize||24,autoFontSize:Y.autoFontSize??!0,fontFamily:Y.fontFamily||"Microsoft YaHei",layoutDirection:Y.layoutDirection||"vertical",textColor:Y.textColor||"#000000",fillColor:Y.fillColor||"#FFFFFF",inpaintMethod:Y.inpaintMethod||"litelama",strokeEnabled:Y.strokeEnabled??!1,strokeColor:Y.strokeColor||"#FFFFFF",strokeWidth:Y.strokeWidth||2}));U.length>0&&(console.log("正在加载图片..."),a.value={current:0,total:U.length,message:"正在加载图片..."},await G(U,(Y,Se)=>{const g=Y/Se*100;a.value={current:Y,total:Se,message:`加载图片 ${Y}/${Se}...`},console.log(`加载图片 ${Y}/${Se}... (${g.toFixed(0)}%)`)}),a.value={current:U.length,total:U.length,message:"加载完成"},console.log("图片加载完成，已转换为 Base64"),setTimeout(()=>{a.value={current:0,total:0,message:""}},500)),p.setImages(U);let fe=0;typeof C.currentImageIndex=="number"&&(fe=C.currentImageIndex,(fe>=U.length||fe<0)&&(fe=U.length>0?0:-1)),p.setCurrentImageIndex(fe);const K=U[fe];K&&K.bubbleStates&&K.bubbleStates.length>0?te.setBubbles(K.bubbleStates,!0):te.clearBubblesLocal(),console.log(`按路径加载会话成功: ${S}, 共 ${U.length} 张图片`)}const c=C.ui_settings;if(c){(c.targetLanguage||c.sourceLanguage)&&f.updateSettings({targetLanguage:c.targetLanguage||void 0,sourceLanguage:c.sourceLanguage||void 0});const U=c.useInpaintingMethod,K=["solid","lama_mpe","litelama"].includes(U)?U:f.settings.textStyle.inpaintMethod;f.updateTextStyle({fontSize:c.fontSize||f.settings.textStyle.fontSize,autoFontSize:c.autoFontSize??f.settings.textStyle.autoFontSize,fontFamily:c.fontFamily||f.settings.textStyle.fontFamily,layoutDirection:c.layoutDirection||f.settings.textStyle.layoutDirection,textColor:c.textColor||f.settings.textStyle.textColor,fillColor:c.fillColor||f.settings.textStyle.fillColor,inpaintMethod:K,strokeEnabled:c.strokeEnabled??f.settings.textStyle.strokeEnabled,strokeColor:c.strokeColor||f.settings.textStyle.strokeColor,strokeWidth:c.strokeWidth||f.settings.textStyle.strokeWidth}),console.log("UI 设置已恢复")}return Z(S),!0}catch(v){const I=v instanceof Error?v.message:"加载会话失败";throw x(I),console.error(`按路径加载会话失败: ${S}`,v),v}finally{l(!1)}}async function B(S,v){if(!S||!v)return console.log("未在书籍/章节模式，不支持保存"),!1;console.log(`保存章节会话（分批）: book=${S}, chapter=${v}`);const{useImageStore:I}=await lt(async()=>{const{useImageStore:m}=await Promise.resolve().then(()=>Vn);return{useImageStore:m}},void 0),{useSettingsStore:T}=await lt(async()=>{const{useSettingsStore:m}=await import("./index.71kVCBu7.js").then(C=>C.q);return{useSettingsStore:m}},__vite__mapDeps([0,1,2])),p=I(),f=T(),te=Array.isArray(p.images)?p.images:[];if(!te||te.length===0)return console.log("没有图片数据可保存"),!1;const se=`bookshelf/${S}/${v}`;_(!0),x(null),a.value={current:0,total:100,message:"准备保存..."};try{const{batchSaveStartApi:m,batchSaveImageApi:C,batchSaveCompleteApi:c}=await lt(async()=>{const{batchSaveStartApi:h,batchSaveImageApi:L,batchSaveCompleteApi:X}=await import("./session.Kpy-QhBa.js");return{batchSaveStartApi:h,batchSaveImageApi:L,batchSaveCompleteApi:X}},__vite__mapDeps([3,4,5])),U=te.length;te.some(h=>h.originalDataURL&&h.originalDataURL.startsWith("/api/")||h.translatedDataURL&&h.translatedDataURL.startsWith("/api/")||h.cleanImageData&&h.cleanImageData.startsWith("/api/"))&&(console.log("[saveChapterSession] 检测到 /api/ URL 格式图片，开始转换为 Base64..."),a.value={current:2,total:100,message:"转换图片格式..."},await G(te,(h,L)=>{const X=2+h/L*3;a.value={current:Math.round(X),total:100,message:`转换图片 ${h}/${L}...`}}),console.log("[saveChapterSession] 图片格式转换完成")),a.value={current:5,total:100,message:"收集元数据..."};const{textStyle:K,targetLanguage:Y,sourceLanguage:Se}=f.settings,g={targetLanguage:Y,sourceLanguage:Se,fontSize:K.fontSize,autoFontSize:K.autoFontSize,fontFamily:K.fontFamily,layoutDirection:K.layoutDirection,textColor:K.textColor,useInpaintingMethod:K.inpaintMethod,fillColor:K.fillColor,strokeEnabled:K.strokeEnabled,strokeColor:K.strokeColor,strokeWidth:K.strokeWidth},b=te.map(h=>{const L={};for(const X of Object.keys(h))X!=="originalDataURL"&&X!=="translatedDataURL"&&X!=="cleanImageData"&&(L[X]=h[X]);return L.hasOriginalData=!!h.originalDataURL,L.hasTranslatedData=!!h.translatedDataURL,L.hasCleanData=!!h.cleanImageData,L}),M={ui_settings:g,images_meta:b,currentImageIndex:p.currentImageIndex};a.value={current:10,total:100,message:"初始化保存..."};const D=await m(se,M);if(!D.success)throw new Error(D.error||"初始化保存失败");const O=D.session_folder;if(!O)throw new Error("未获取到会话文件夹路径");console.log(`会话文件夹: ${O}`);let re=0,E=0;const P=h=>!!h&&typeof h=="string"&&h.startsWith("data:");for(let h=0;h<U;h++){const L=te[h];if(!L)continue;const X=10+h/U*80;if(a.value={current:Math.round(X),total:100,message:`保存图片 ${h+1}/${U}...`},P(L.originalDataURL))try{const ne=await C(O,h,"original",L.originalDataURL);ne.success||(console.error(`保存图片 ${h} original 失败:`,ne.error),E++)}catch(ne){console.error(`保存图片 ${h} original 出错:`,ne),E++}if(P(L.translatedDataURL))try{const ne=await C(O,h,"translated",L.translatedDataURL);ne.success||(console.error(`保存图片 ${h} translated 失败:`,ne.error),E++)}catch(ne){console.error(`保存图片 ${h} translated 出错:`,ne),E++}if(L.cleanImageData&&typeof L.cleanImageData=="string"&&!L.cleanImageData.startsWith("/api/"))try{const ne=await C(O,h,"clean",L.cleanImageData);ne.success||(console.error(`保存图片 ${h} clean 失败:`,ne.error),E++)}catch(ne){console.error(`保存图片 ${h} clean 出错:`,ne),E++}re++}a.value={current:95,total:100,message:"完成保存..."};const R=await c(O,b);if(!R.success)throw new Error(R.error||"完成保存失败");return a.value={current:100,total:100,message:"保存完成"},console.log(`分批保存完成: ${re} 张图片, ${E} 个失败`),setTimeout(()=>{a.value={current:0,total:0,message:""}},1e3),!0}catch(m){const C=m instanceof Error?m.message:"保存章节会话失败";return x(C),console.error("分批保存失败:",m),a.value={current:0,total:0,message:""},!1}finally{_(!1)}}return{currentSessionName:n,context:r,sessionList:u,isLoading:o,isSaving:t,error:i,loadingProgress:a,isBookshelfMode:s,currentBookId:k,currentChapterId:A,setContext:$,clearContext:ae,parseContextFromUrl:le,setSessionName:Z,clearSessionName:w,setSessionList:Q,addToSessionList:j,removeFromSessionList:H,renameInSessionList:d,setLoading:l,setSaving:_,setError:x,createSessionData:z,imageUrlToBase64:be,saveChapterSession:B,loadSessionByPath:F,setBookChapterContext:N,reset:ee}}),pa={key:0,class:"translation-progress-bar"},ba={class:"progress-bar-label"},va={class:"progress-bar"},ma=Ge({__name:"ProgressBar",props:{visible:{type:Boolean,default:!0},percentage:{},label:{default:"进度"}},setup(n){return(r,u)=>n.visible?(V(),J("div",pa,[e("div",ba,xe(n.label),1),e("div",va,[e("div",{class:"progress",style:it({width:`${n.percentage}%`})},null,4)])])):Te("",!0)}}),dn=je(ma,[["__scopeId","data-v-f915cadf"]]),fa={class:"image-upload"},ha={class:"error-text"},ya={key:2,class:"loading-overlay"},xa=Ge({__name:"ImageUpload",emits:["uploadComplete"],setup(n,{expose:r,emit:u}){const o=u,a=st(),i=Qe(),t=y(null),s=y(!1),k=y(!1),A=y(""),$=y(0),N=y(""),ae=y(!1),le=oe(()=>i.settings.pdfProcessingMethod);function Z(){t.value?.click()}async function w(F){const B=F.target;!B.files||B.files.length===0||(await d(Array.from(B.files)),B.value="")}async function Q(F){F.preventDefault(),k.value=!1,!(!F.dataTransfer?.files||F.dataTransfer.files.length===0)&&await d(Array.from(F.dataTransfer.files))}function j(F){F.preventDefault(),k.value=!0}function H(F){const B=F.currentTarget.getBoundingClientRect(),S=F.clientX,v=F.clientY;(S<B.left||S>B.right||v<B.top||v>B.bottom)&&(k.value=!1)}async function d(F){if(F.length!==0){s.value=!0,A.value="",ae.value=!0,$.value=0;try{let B=0;const S=F.length;for(let v=0;v<F.length;v++){const I=F[v];if(!I)continue;N.value=I.name;const T=I.type,p=I.name.toLowerCase();if(T.startsWith("image/"))await l(I),B++;else if(T==="application/pdf"||p.endsWith(".pdf")){const f=await _(I);B+=f}else if(p.endsWith(".mobi")||p.endsWith(".azw")||p.endsWith(".azw3")){const f=await be(I);B+=f}else console.warn(`不支持的文件类型: ${I.name}`),we(`不支持的文件类型: ${I.name}`,"warning");$.value=Math.round((v+1)/S*100)}B>0&&(we(`已添加 ${B} 张图片`,"success"),o("uploadComplete",B))}catch(B){console.error("处理文件失败:",B);const S=B instanceof Error?B.message:"处理文件失败，请重试";A.value=S,we(S,"error")}finally{s.value=!1,ae.value=!1,N.value=""}}}async function l(F){return new Promise((B,S)=>{const v=new FileReader;v.onload=I=>{const T=I.target?.result;a.addImage(F.name,T),B()},v.onerror=()=>S(new Error(`读取图片文件失败: ${F.name}`)),v.readAsDataURL(F)})}async function _(F){return le.value==="frontend"?await z(F):await ee(F)}function x(F){return new Promise((B,S)=>{const v=new FileReader;v.onload=()=>B(v.result),v.onerror=S,v.readAsDataURL(F)})}async function z(F){try{const B=await lt(()=>import("./pdf.U7tdldy2.js").then(f=>f.p),[]);B.GlobalWorkerOptions.workerSrc=`https://cdnjs.cloudflare.com/ajax/libs/pdf.js/${B.version}/pdf.worker.min.js`;const S=await F.arrayBuffer(),v=await B.getDocument({data:S}).promise,I=v.numPages;console.log(`PDF ${F.name} 共 ${I} 页，开始本地渲染...`),we(`正在解析 PDF，共 ${I} 页...`,"info");const T=typeof OffscreenCanvas<"u";T&&console.log("使用 OffscreenCanvas 后台渲染模式");let p=0;for(let f=1;f<=I;f++){N.value=`${F.name} - 第 ${f}/${I} 页`,$.value=Math.round(f/I*100);try{const te=await v.getPage(f),m=te.getViewport({scale:2});let C;if(T){const U=new OffscreenCanvas(m.width,m.height),fe=U.getContext("2d");await te.render({canvasContext:fe,viewport:m}).promise;const K=await U.convertToBlob({type:"image/jpeg",quality:1});C=await x(K)}else{const U=document.createElement("canvas"),fe=U.getContext("2d");U.width=m.width,U.height=m.height,await te.render({canvasContext:fe,viewport:m}).promise,C=U.toDataURL("image/jpeg",1)}const c=`${F.name}_页面${f}`;a.addImage(c,C),p++,console.log(`  页面 ${f}/${I} 处理完成`)}catch(te){console.warn(`PDF ${F.name} 第 ${f} 页渲染失败:`,te)}}return console.log(`PDF ${F.name} 全部 ${I} 页处理完成`),p}catch(B){return console.error("前端 PDF 解析失败:",B),we("前端 PDF 解析失败，尝试使用后端解析...","warning"),await ee(F)}}async function ee(F){let S=null;try{we("正在上传 PDF 文件...","info");const v=await Ao(F,5);if(!v.success||!v.session_id)throw new Error(v.error||"PDF 解析启动失败");S=v.session_id;const I=v.total_pages||0;console.log(`PDF ${F.name} 共 ${I} 页，开始后端分批解析...`),we(`正在解析 PDF，共 ${I} 页...`,"info");let T=0;for(let p=0;p<I;p+=5){N.value=`${F.name} - 处理中 ${Math.min(p+5,I)}/${I} 页`,$.value=I>0?Math.round(p/I*100):0;const f=await Fo(S,p,5);if(!f.success){console.warn(`批次 ${p} 获取失败:`,f.error);continue}if(f.images&&f.images.length>0)for(const te of f.images){if(!te||!te.data_url)continue;const se=`${F.name}_页面${String(te.page_index+1).padStart(4,"0")}`;a.addImage(se,te.data_url),T++}console.log(`  已加载 ${T}/${I} 页`)}return console.log(`PDF ${F.name} 全部 ${T} 页处理完成`),T}catch(v){throw console.error("后端 PDF 解析失败:",v),v}finally{if(S)try{await Lo(S)}catch(v){console.warn("PDF 会话清理失败:",v)}}}async function be(F){let B=null;try{we("正在上传电子书文件...","info");const S=await Uo(F,5);if(!S.success||!S.session_id)throw new Error(S.error||"MOBI/AZW 解析启动失败");B=S.session_id;const v=S.total_images||0;we(`正在解析电子书，共 ${v} 张图片...`,"info");let I=0,T=!0;for(;T;){N.value=`${F.name} - 已处理 ${I}/${v} 张`,$.value=v>0?Math.round(I/v*100):0;const p=await Oo(B);if(!p.success)throw new Error(p.error||"MOBI/AZW 批次解析失败");if(p.images&&p.images.length>0){for(let f=0;f<p.images.length;f++){const te=p.images[f];if(!te)continue;const se=I+f+1,m=`${F.name.replace(/\.(mobi|azw|azw3)$/i,"")}_image_${String(se).padStart(3,"0")}.png`,C=te.startsWith("data:")?te:`data:image/png;base64,${te}`;a.addImage(m,C)}I+=p.images.length}T=p.has_more??!1}return I}catch(S){throw console.error("MOBI/AZW 解析失败:",S),S}finally{if(B)try{await zo(B)}catch(S){console.warn("MOBI/AZW 会话清理失败:",S)}}}function G(){A.value=""}return r({triggerFileSelect:Z,processFiles:d,clearError:G}),(F,B)=>(V(),J("div",fa,[e("div",{id:"drop-area",class:Le(["drop-area",{"drag-over":k.value,loading:s.value}]),onDragover:j,onDragleave:H,onDrop:Q},[e("div",{class:"drop-content"},[e("p",{class:"drop-text"},[B[0]||(B[0]=Ke(" 拖拽图片、PDF或MOBI文件到这里，或 ",-1)),e("span",{class:"select-link",onClick:Z}," 点击选择文件 ")])]),e("input",{ref_key:"fileInputRef",ref:t,type:"file",id:"imageUpload",accept:"image/*,application/pdf,.mobi,.azw,.azw3",multiple:"",class:"file-input",onChange:w},null,544)],34),ae.value?(V(),rt(dn,{key:0,visible:!0,percentage:$.value,label:N.value||"处理中..."},null,8,["percentage","label"])):Te("",!0),A.value?(V(),J("div",{key:1,class:"error-message",onClick:G},[B[1]||(B[1]=e("span",{class:"error-icon"},"⚠️",-1)),e("span",ha,xe(A.value),1),B[2]||(B[2]=e("span",{class:"error-close"},"×",-1))])):Te("",!0),s.value&&!ae.value?(V(),J("div",ya,[...B[3]||(B[3]=[e("div",{class:"spinner"},null,-1),e("span",{class:"loading-text"},"处理中...",-1)])])):Te("",!0)]))}}),Sa=je(xa,[["__scopeId","data-v-37201604"]]),ka={id:"settings-sidebar",class:"settings-sidebar"},_a={class:"card settings-card"},Ca={id:"font-settings",class:"settings-card collapsible-panel"},wa={class:"toggle-icon"},$a={class:"collapsible-content"},Ta={class:"settings-form"},Ia={class:"form-group"},Da=["value","disabled","title"],Ra={class:"auto-fontSize-option",title:"勾选后，首次翻译时自动为每个气泡计算合适的字号"},Ma=["checked"],Ba={class:"form-group"},Ea={class:"form-group"},Pa={class:"form-group"},Aa=["value"],Fa={class:"form-group"},La={class:"checkbox-label"},Ua=["checked"],Oa={key:0,id:"strokeOptions",class:"stroke-options"},za={class:"form-group"},Va=["value"],Na={class:"form-group"},Wa=["value"],Ka={class:"form-group"},qa={key:0,id:"solidColorOptions",class:"form-group"},Ha=["value"],Ja={class:"apply-settings-group"},Ya=["disabled"],Xa={key:0,class:"apply-options-dropdown"},ja={class:"apply-option"},Ga=["checked"],Za={class:"apply-option"},Qa={class:"apply-option"},es={class:"apply-option"},ts={class:"apply-option"},ns={class:"apply-option"},os={class:"apply-option"},as={class:"apply-option"},ss={class:"apply-option"},ls={class:"action-buttons"},is=["disabled"],rs=["disabled"],us=["disabled"],cs=["disabled"],ds=["disabled"],gs=["disabled"],ps=["disabled"],bs=["disabled"],vs={class:"navigation-buttons"},ms=["disabled"],fs=["disabled"],hs=Ge({__name:"SettingsSidebar",emits:["translateCurrent","translateAll","hqTranslate","proofread","removeText","removeAllText","deleteCurrent","clearAll","cleanTemp","openPlugins","openSettings","previous","next","applyToAll","textStyleChanged","autoFontSizeChanged"],setup(n,{emit:r}){const u=r,o=st(),a=Qe(),i=y(!0),t=y(!1),s=y({fontSize:!0,fontFamily:!0,layoutDirection:!0,textColor:!0,fillColor:!0,strokeEnabled:!0,strokeColor:!0,strokeWidth:!0}),k=[{label:"自动 (根据检测)",value:"auto"},{label:"竖向排版",value:"vertical"},{label:"横向排版",value:"horizontal"}],A=[{label:"纯色填充",value:"solid"},{label:"LAMA修复 (速度优化)",value:"lama_mpe"},{label:"LAMA修复 (通用)",value:"litelama"}],$=oe(()=>o.currentImage),N=oe(()=>o.hasImages),ae=oe(()=>N.value&&!o.isBatchTranslationInProgress),le=oe(()=>o.canGoPrevious),Z=oe(()=>o.canGoNext),w=oe(()=>a.textStyle),Q=y([]),j=["fonts/STSONG.TTF","fonts/msyh.ttc","fonts/simhei.ttf","fonts/simsun.ttc"],H=y(null),d=oe(()=>{const C=Q.value.map(c=>({label:be(c),value:c}));return C.push({label:"自定义字体...",value:"custom-font"}),C});ut(async()=>{await l();const C=w.value.fontFamily;C&&!Q.value.includes(C)&&(Q.value=[C,...Q.value])});async function l(){try{const C=await Xn();if(C.fonts&&Array.isArray(C.fonts)&&C.fonts.length>0){const c=C.fonts[0];if(typeof c=="object"&&"path"in c){const U=C.fonts.map(fe=>typeof fe=="object"?fe.path:fe);Q.value=U}else Q.value=C.fonts}else Q.value=[...j]}catch(C){console.error("加载字体列表失败:",C),Q.value=[...j]}}function _(){i.value=!i.value}function x(C){const c=parseInt(C.target.value);isNaN(c)||(a.updateTextStyle({fontSize:c}),u("textStyleChanged","fontSize",c))}function z(C){const c=C.target.checked;a.updateTextStyle({autoFontSize:c}),console.log(`自动字号设置变更: ${c}`),u("autoFontSizeChanged",c)}async function ee(C){const c=C.target,U=c.files?.[0];if(!U)return;const fe=[".ttf",".ttc",".otf"],K=U.name.toLowerCase();if(!fe.some(Se=>K.endsWith(Se))){we("请选择 .ttf、.ttc 或 .otf 格式的字体文件","error"),c.value="";return}try{const Se=await qo(U);Se.success&&Se.fontPath?(await l(),a.updateTextStyle({fontFamily:Se.fontPath}),we("字体上传成功","success")):we(Se.error||"字体上传失败","error")}catch(Se){console.error("字体上传失败:",Se),we("字体上传失败","error")}finally{c.value=""}}function be(C){const c={"fonts/STXINGKA.TTF":"华文行楷","fonts/STXINWEI.TTF":"华文新魏","fonts/STZHONGS.TTF":"华文中宋","fonts/STKAITI.TTF":"楷体","fonts/STLITI.TTF":"隶书","fonts/STSONG.TTF":"华文宋体","fonts/msyh.ttc":"微软雅黑","fonts/msyhbd.ttc":"微软雅黑粗体","fonts/SIMYOU.TTF":"幼圆","fonts/STFANGSO.TTF":"仿宋","fonts/STHUPO.TTF":"华文琥珀","fonts/STXIHEI.TTF":"华文细黑","fonts/simkai.ttf":"中易楷体","fonts/simfang.ttf":"中易仿宋","fonts/simhei.ttf":"中易黑体","fonts/SIMLI.TTF":"中易隶书","fonts/simsun.ttc":"宋体"};if(c[C])return c[C];const U=C.split("/").pop()||C;for(const[fe,K]of Object.entries(c))if((fe.split("/").pop()||"").toLowerCase()===U.toLowerCase())return K;return U.replace(/\.(ttf|ttc|otf)$/i,"")}function G(C){const c=String(C);if(c==="custom-font"){H.value?.click();return}a.updateTextStyle({fontFamily:c}),u("textStyleChanged","fontFamily",c)}function F(C){const c=String(C);a.updateTextStyle({layoutDirection:c}),u("textStyleChanged","layoutDirection",c)}function B(C){const c=String(C);a.updateTextStyle({inpaintMethod:c})}function S(C){const c=C.target.value;a.updateTextStyle({textColor:c}),u("textStyleChanged","textColor",c)}function v(C){const c=C.target.checked;a.updateTextStyle({strokeEnabled:c}),u("textStyleChanged","strokeEnabled",c)}function I(C){const c=C.target.value;a.updateTextStyle({strokeColor:c}),u("textStyleChanged","strokeColor",c)}function T(C){const c=parseInt(C.target.value);isNaN(c)||(a.updateTextStyle({strokeWidth:c}),u("textStyleChanged","strokeWidth",c))}function p(C){const c=C.target.value;a.updateTextStyle({fillColor:c}),u("textStyleChanged","fillColor",c)}function f(){t.value=!t.value}function te(){const c=!Object.values(s.value).every(U=>U);s.value={fontSize:c,fontFamily:c,layoutDirection:c,textColor:c,fillColor:c,strokeEnabled:c,strokeColor:c,strokeWidth:c}}function se(){u("applyToAll",{...s.value}),t.value=!1}function m(C){C.target.closest(".apply-settings-group")||(t.value=!1)}return typeof window<"u"&&window.addEventListener("click",m),(C,c)=>(V(),J("aside",ka,[e("div",_a,[c[42]||(c[42]=e("h2",null,"翻译设置",-1)),e("div",Ca,[e("h3",{class:"collapsible-header",onClick:_},[c[20]||(c[20]=Ke(" 文字设置 ",-1)),e("span",wa,xe(i.value?"▼":"▶"),1)]),ue(e("div",$a,[e("div",Ta,[e("div",Ia,[c[22]||(c[22]=e("label",{for:"fontSize"},"字号大小:",-1)),e("input",{type:"number",id:"fontSize",value:w.value.fontSize,min:"10",max:"100",disabled:w.value.autoFontSize,class:Le({"disabled-input":w.value.autoFontSize}),title:w.value.autoFontSize?"已启用自动字号，首次翻译时将自动计算":"",onInput:x},null,42,Da),e("span",Ra,[e("input",{type:"checkbox",id:"autoFontSize",checked:w.value.autoFontSize,onChange:z},null,40,Ma),c[21]||(c[21]=e("label",{for:"autoFontSize"},"自动计算初始字号",-1))])]),e("div",Ba,[c[23]||(c[23]=e("label",{for:"fontFamily"},"文本字体:",-1)),Ie(We,{"model-value":w.value.fontFamily,options:d.value,onChange:G},null,8,["model-value","options"]),e("input",{ref_key:"fontUploadInput",ref:H,type:"file",id:"fontUpload",accept:".ttf,.ttc,.otf",style:{display:"none"},onChange:ee},null,544)]),e("div",Ea,[c[24]||(c[24]=e("label",{for:"layoutDirection"},"排版设置:",-1)),Ie(We,{"model-value":w.value.layoutDirection,options:k,onChange:F},null,8,["model-value"])]),e("div",Pa,[c[25]||(c[25]=e("label",{for:"textColor"},"文字颜色:",-1)),e("input",{type:"color",id:"textColor",value:w.value.textColor,onInput:S},null,40,Aa)]),e("div",Fa,[e("span",La,[e("input",{type:"checkbox",id:"strokeEnabled",checked:w.value.strokeEnabled,onChange:v},null,40,Ua),c[26]||(c[26]=e("label",{for:"strokeEnabled"},"启用文本描边:",-1))])]),Ie(Un,{name:"stroke-slide"},{default:_t(()=>[w.value.strokeEnabled?(V(),J("div",Oa,[e("div",za,[c[27]||(c[27]=e("label",{for:"strokeColor"},"描边颜色:",-1)),e("input",{type:"color",id:"strokeColor",value:w.value.strokeColor,onInput:I},null,40,Va)]),e("div",Na,[c[28]||(c[28]=e("label",{for:"strokeWidth"},"描边宽度 (px):",-1)),e("input",{type:"number",id:"strokeWidth",value:w.value.strokeWidth,min:"0",max:"10",style:{width:"60px",padding:"5px"},onInput:T},null,40,Wa),c[29]||(c[29]=e("div",{class:"input-hint"},"0 表示无描边。",-1))])])):Te("",!0)]),_:1}),e("div",Ka,[c[30]||(c[30]=e("label",{for:"useInpainting"},"气泡填充方式:",-1)),Ie(We,{"model-value":w.value.inpaintMethod,options:A,onChange:B},null,8,["model-value"])]),Ie(Un,{name:"slide-fade"},{default:_t(()=>[w.value.inpaintMethod==="solid"?(V(),J("div",qa,[c[31]||(c[31]=e("label",{for:"fillColor"},"填充颜色:",-1)),e("input",{type:"color",id:"fillColor",value:w.value.fillColor,onInput:p},null,40,Ha)])):Te("",!0)]),_:1})]),e("div",Ja,[e("button",{type:"button",class:"settings-button",disabled:!N.value,onClick:se}," 应用到全部 ",8,Ya),e("button",{type:"button",class:"settings-gear-btn",title:"选择要应用的参数",onClick:f}," ⚙️ "),t.value?(V(),J("div",Xa,[e("div",ja,[e("input",{type:"checkbox",id:"apply_selectAll",checked:Object.values(s.value).every(U=>U),onChange:te},null,40,Ga),c[32]||(c[32]=e("label",{for:"apply_selectAll"},"全选",-1))]),c[41]||(c[41]=e("hr",null,null,-1)),e("div",Za,[ue(e("input",{type:"checkbox",id:"apply_fontSize","onUpdate:modelValue":c[0]||(c[0]=U=>s.value.fontSize=U)},null,512),[[tt,s.value.fontSize]]),c[33]||(c[33]=e("label",{for:"apply_fontSize"},"字号",-1))]),e("div",Qa,[ue(e("input",{type:"checkbox",id:"apply_fontFamily","onUpdate:modelValue":c[1]||(c[1]=U=>s.value.fontFamily=U)},null,512),[[tt,s.value.fontFamily]]),c[34]||(c[34]=e("label",{for:"apply_fontFamily"},"字体",-1))]),e("div",es,[ue(e("input",{type:"checkbox",id:"apply_layoutDirection","onUpdate:modelValue":c[2]||(c[2]=U=>s.value.layoutDirection=U)},null,512),[[tt,s.value.layoutDirection]]),c[35]||(c[35]=e("label",{for:"apply_layoutDirection"},"排版方向",-1))]),e("div",ts,[ue(e("input",{type:"checkbox",id:"apply_textColor","onUpdate:modelValue":c[3]||(c[3]=U=>s.value.textColor=U)},null,512),[[tt,s.value.textColor]]),c[36]||(c[36]=e("label",{for:"apply_textColor"},"文字颜色",-1))]),e("div",ns,[ue(e("input",{type:"checkbox",id:"apply_fillColor","onUpdate:modelValue":c[4]||(c[4]=U=>s.value.fillColor=U)},null,512),[[tt,s.value.fillColor]]),c[37]||(c[37]=e("label",{for:"apply_fillColor"},"填充颜色",-1))]),e("div",os,[ue(e("input",{type:"checkbox",id:"apply_strokeEnabled","onUpdate:modelValue":c[5]||(c[5]=U=>s.value.strokeEnabled=U)},null,512),[[tt,s.value.strokeEnabled]]),c[38]||(c[38]=e("label",{for:"apply_strokeEnabled"},"描边开关",-1))]),e("div",as,[ue(e("input",{type:"checkbox",id:"apply_strokeColor","onUpdate:modelValue":c[6]||(c[6]=U=>s.value.strokeColor=U)},null,512),[[tt,s.value.strokeColor]]),c[39]||(c[39]=e("label",{for:"apply_strokeColor"},"描边颜色",-1))]),e("div",ss,[ue(e("input",{type:"checkbox",id:"apply_strokeWidth","onUpdate:modelValue":c[7]||(c[7]=U=>s.value.strokeWidth=U)},null,512),[[tt,s.value.strokeWidth]]),c[40]||(c[40]=e("label",{for:"apply_strokeWidth"},"描边宽度",-1))])])):Te("",!0)])],512),[[qe,i.value]])]),e("div",ls,[e("button",{id:"translateButton",disabled:!ae.value,onClick:c[8]||(c[8]=U=>u("translateCurrent"))}," 翻译当前图片 ",8,is),e("button",{id:"translateAllButton",disabled:!ae.value,onClick:c[9]||(c[9]=U=>u("translateAll"))}," 翻译所有图片 ",8,rs),e("button",{id:"startHqTranslationBtn",class:"settings-button purple-button",disabled:!ae.value,title:"使用高质量翻译模式（需在设置中配置）",onClick:c[10]||(c[10]=U=>u("hqTranslate"))}," 高质量翻译 ",8,us),e("button",{id:"proofreadButton",disabled:!ae.value,onClick:c[11]||(c[11]=U=>u("proofread"))}," AI校对 ",8,cs),e("button",{id:"removeTextOnlyButton",disabled:!$.value,title:"消除图片中的气泡文字，无需填写翻译服务商和API Key",onClick:c[12]||(c[12]=U=>u("removeText"))}," 仅消除文字 ",8,ds),e("button",{id:"removeAllTextButton",disabled:!N.value,title:"消除所有图片中的气泡文字，无需填写翻译服务商和API Key",onClick:c[13]||(c[13]=U=>u("removeAllText"))}," 消除所有图片文字 ",8,gs),e("button",{id:"deleteCurrentImageButton",class:"settings-button red-button",disabled:!$.value,onClick:c[14]||(c[14]=U=>u("deleteCurrent"))}," 删除当前图片 ",8,ps),e("button",{id:"clearAllImagesButton",class:"settings-button red-button",disabled:!N.value,onClick:c[15]||(c[15]=U=>u("clearAll"))}," 清除所有图片 ",8,bs),e("button",{id:"cleanDebugFilesButton",class:"settings-button orange-button",onClick:c[16]||(c[16]=U=>u("cleanTemp"))}," 清理临时文件 "),e("button",{id:"managePluginsButton",class:"settings-button blue-button",onClick:c[17]||(c[17]=U=>u("openPlugins"))}," 插件管理 ")]),e("div",vs,[e("button",{id:"prevImageButton",disabled:!le.value,onClick:c[18]||(c[18]=U=>u("previous"))}," 上一张 ",8,ms),e("button",{id:"nextImageButton",disabled:!Z.value,onClick:c[19]||(c[19]=U=>u("next"))}," 下一张 ",8,fs)])])]))}}),ys=je(hs,[["__scopeId","data-v-2dcef39a"]]);function kt(n){if(n.textDirection&&n.textDirection!=="auto")return n.textDirection;if(n.autoTextDirection&&n.autoTextDirection!=="auto")return n.autoTextDirection;if(n.coords){const[r,u,o,a]=n.coords;return a-u>o-r?"vertical":"horizontal"}return"vertical"}function xs(){const n=st(),r=Qe(),u=dt(),o=y(!1),a=y(0),i=y(""),t=y(!1),s=y(0),k=y(""),A=oe(()=>n.hasImages),$=oe(()=>n.hasImages),N=oe(()=>n.hasImages);function ae(){const d=n.images;if(d.length===0){u.warning("没有可导出的图片文本");return}const l=[];for(let F=0;F<d.length;F++){const B=d[F];if(!B)continue;const S=B.bubbleStates||[],v={imageIndex:F,bubbles:[]};for(let I=0;I<S.length;I++){const T=S[I];if(!T)continue;const p=T.originalText||"",f=T.translatedText||T.textboxText||"";let te="vertical";T.textDirection&&T.textDirection!=="auto"?te=T.textDirection:T.autoTextDirection&&(te=T.autoTextDirection),v.bubbles.push({bubbleIndex:I,original:p,translated:f,textDirection:te})}l.push(v)}const _=JSON.stringify(l,null,2),x=new Blob([_],{type:"application/json"}),z=URL.createObjectURL(x),ee=document.createElement("a");ee.href=z;const G=new Date().toISOString().replace(/[-:T]/g,"").slice(0,15);ee.download=`translations_${G}.json`,document.body.appendChild(ee),ee.click(),document.body.removeChild(ee),URL.revokeObjectURL(z),u.success("文本导出成功！")}function le(){const d=n.images;if(d.length===0)return null;const l=[];for(let _=0;_<d.length;_++){const x=d[_];if(!x)continue;const z=x.bubbleStates||[],ee={imageIndex:_,bubbles:[]};for(let be=0;be<z.length;be++){const G=z[be];if(!G)continue;const F=G.originalText||"",B=G.translatedText||G.textboxText||"";let S="vertical";G.textDirection&&G.textDirection!=="auto"?S=G.textDirection:G.autoTextDirection&&(S=G.autoTextDirection),ee.bubbles.push({bubbleIndex:be,original:F,translated:B,textDirection:S})}l.push(ee)}return l}async function Z(d){if(!d){u.warning("未选择文件");return}t.value=!0,s.value=0,k.value="准备导入文本...",u.info("正在导入文本...",0);try{const l=await w(d);s.value=10,k.value="解析 JSON 数据...";const _=JSON.parse(l);if(!Array.isArray(_))throw new Error("导入的 JSON 格式不正确，应为数组");let x=0,z=0;const ee=r.settings.textStyle,be=ee.autoFontSize?"auto":ee.fontSize,G=ee.fontFamily,F=ee.textColor,B=ee.fillColor;s.value=20,k.value="开始更新图片...";const S=_.length;let v=0;const I=[];for(const f of _){v++;const te=20+v/S*60;s.value=te,k.value=`处理图片 ${v}/${S}`;const se=f.imageIndex;if(se<0||se>=n.images.length){console.warn(`跳过无效的图片索引: ${se}`);continue}const m=n.images[se];if(!m)continue;let C=!1;m.bubbleStates||(m.bubbleStates=[]),m.bubbleTexts||(m.bubbleTexts=[]),m.originalTexts||(m.originalTexts=[]);for(const c of f.bubbles){const U=c.bubbleIndex,fe=c.original,K=c.translated,Y=c.textDirection,Se=Y==="vertical"||Y==="horizontal"?Y:"vertical";for(;m.bubbleTexts.length<=U;)m.bubbleTexts.push("");for(;m.originalTexts.length<=U;)m.originalTexts.push("");for(fe&&(m.originalTexts[U]=fe),K&&(m.bubbleTexts[U]=K);m.bubbleStates.length<=U;)m.bubbleStates.push(Q(be,G,F,B));const g=m.bubbleStates[U];g&&(fe&&(g.originalText=fe),K&&(g.translatedText=K,g.textboxText=K),g.textDirection=Se,C=!0,z++)}C&&m.bubbleStates&&(m.bubbleTexts=m.bubbleStates.map(c=>c.translatedText||"")),C&&(x++,m.hasUnsavedChanges=!0,m.translatedDataURL&&m.bubbleStates&&m.bubbleStates.length>0&&I.push(se))}if(I.length>0){s.value=80,k.value="开始渲染图片...",u.info("正在渲染图片，请稍候...",0);const f=r.settings.textStyle,te=f.layoutDirection,se=te==="auto";for(let m=0;m<I.length;m++){const C=I[m];if(C===void 0)continue;const c=n.images[C];if(!(!c||!c.bubbleStates)){s.value=80+m/I.length*20,k.value=`渲染图片 ${m+1}/${I.length}`;try{let U="";if(c.cleanImageData?U=c.cleanImageData.includes("base64,")?c.cleanImageData.split("base64,")[1]||"":c.cleanImageData:c.originalDataURL&&(U=c.originalDataURL.includes("base64,")?c.originalDataURL.split("base64,")[1]||"":c.originalDataURL,console.log(`importText: 图片 ${C} 使用原图作为背景（兜底）`)),!U){console.log(`importText: 图片 ${C} 没有可用的背景图，跳过`);continue}const fe=c.bubbleStates.map(Y=>({translatedText:Y.translatedText||"",coords:Y.coords,fontSize:Y.fontSize||f.fontSize,fontFamily:Y.fontFamily||f.fontFamily,textDirection:kt(Y),textColor:Y.textColor||f.textColor,rotationAngle:Y.rotationAngle||0,position:Y.position||{x:0,y:0},strokeEnabled:Y.strokeEnabled??f.strokeEnabled,strokeColor:Y.strokeColor||f.strokeColor,strokeWidth:Y.strokeWidth??f.strokeWidth})),K=await un({clean_image:U,bubble_texts:fe.map(Y=>Y.translatedText),bubble_coords:fe.map(Y=>Y.coords),fontSize:f.fontSize,fontFamily:f.fontFamily,textDirection:se?"vertical":te,textColor:f.textColor,bubble_states:fe,use_individual_styles:!0,use_inpainting:!1,use_lama:!1,is_font_style_change:!0,strokeEnabled:f.strokeEnabled,strokeColor:f.strokeColor,strokeWidth:f.strokeWidth});K.rendered_image&&(n.updateImageByIndex(C,{translatedDataURL:`data:image/png;base64,${K.rendered_image}`,hasUnsavedChanges:!0}),console.log(`importText: 图片 ${C} 渲染成功`))}catch(U){console.error(`importText: 重渲染图片 ${C} 失败:`,U)}}}}s.value=100,k.value="导入完成";const T=I.length,p=T>0?`导入成功！更新了 ${x} 张图片中的 ${z} 个气泡文本，重渲染了 ${T} 张图片`:`导入成功！更新了 ${x} 张图片中的 ${z} 个气泡文本`;u.success(p)}catch(l){console.error("导入文本出错:",l),u.error(`导入失败: ${l instanceof Error?l.message:String(l)}`)}finally{t.value=!1,setTimeout(()=>{s.value=0,k.value=""},2e3)}}function w(d){return new Promise((l,_)=>{const x=new FileReader;x.onload=z=>{z.target?.result?l(z.target.result):_(new Error("读取文件失败"))},x.onerror=()=>_(new Error("读取文件时出错")),x.readAsText(d)})}function Q(d,l,_,x){const z=r.settings.textStyle;return{coords:[0,0,100,100],polygon:[],originalText:"",translatedText:"",textboxText:"",fontSize:typeof d=="number"?d:25,fontFamily:l,textDirection:"vertical",autoTextDirection:"vertical",textColor:_,fillColor:x,rotationAngle:0,position:{x:0,y:0},strokeEnabled:z.strokeEnabled,strokeColor:z.strokeColor,strokeWidth:z.strokeWidth,inpaintMethod:z.inpaintMethod}}function j(){const d=n.currentImage;if(!d){u.warning("没有可下载的图片");return}const l=d.translatedDataURL||d.originalDataURL;if(!l){u.warning("没有可下载的图片");return}o.value=!0;try{const _=l.split(",")[1];if(!_)throw new Error("无效的图片数据");const x=atob(_),z=[];for(let S=0;S<x.length;S+=512){const v=x.slice(S,S+512),I=new Array(v.length);for(let p=0;p<v.length;p++)I[p]=v.charCodeAt(p);const T=new Uint8Array(I);z.push(T.buffer)}const ee=new Blob(z,{type:"image/png"}),be=URL.createObjectURL(ee),G=document.createElement("a");G.href=be;let F=d.fileName||`image_${n.currentImageIndex}.png`;F=`${d.translatedDataURL?"translated":"original"}_${F.replace(/\.[^/.]+$/,"")}.png`,G.download=F,document.body.appendChild(G),G.click(),document.body.removeChild(G),URL.revokeObjectURL(be),u.success(`下载成功: ${F}`)}catch(_){console.error("下载图片时出错:",_),u.error("下载失败")}finally{o.value=!1}}async function H(d="zip"){const l=n.images;if(l.length===0){u.warning("没有可下载的图片");return}o.value=!0,a.value=0,i.value="准备下载...",u.info("下载中...处理可能需要一定时间，请耐心等待...",0);try{const _=[];let x=0,z=0;a.value=5,i.value="检查图片数据...";for(let p=0;p<l.length;p++){const f=l[p];f&&(f.translatedDataURL?(_.push({index:p,type:"translated"}),x++):f.originalDataURL&&(_.push({index:p,type:"original"}),z++))}if(_.length===0){u.warning("没有可下载的图片");return}a.value=10,i.value="创建下载会话...";const ee=await Vo(_.length);if(!ee.success||!ee.session_id)throw new Error(ee.error||"创建会话失败");const be=ee.session_id,G=_.length;let F=0,B=0;for(let p=0;p<_.length;p++){const f=_[p];if(!f)continue;const te=l[f.index];if(!te)continue;const se=f.type==="translated"?te.translatedDataURL:te.originalDataURL;if(!se)continue;const m=10+p/G*70;a.value=m,i.value=`上传图片 ${p+1}/${G}...`;try{const C=await No(be,se,p);C.success?F++:(console.error(`上传图片 ${p} 失败:`,C.error),B++)}catch(C){console.error(`上传图片 ${p} 出错:`,C),B++}}if(F===0)throw new Error("所有图片上传失败");a.value=85,i.value="打包文件...";const S=await Wo(be,d);if(!S.success||!S.file_id)throw new Error(S.error||"打包失败");a.value=95,i.value="准备下载...";const v=Ko(S.file_id,d),I=document.createElement("a");I.href=v,document.body.appendChild(I),I.click(),document.body.removeChild(I),a.value=100,i.value="下载已开始";let T=`已成功处理 ${F} 张图片`;B>0&&(T+=`（${B} 张失败）`),x>0&&z>0?T+=`（${x} 张翻译图片和 ${z} 张原始图片）`:x>0?T+="（全部为翻译后图片）":z>0&&(T+="（全部为原始图片）"),T+="，下载即将开始",u.success(T),setTimeout(async()=>{try{const p=await rn();console.log("临时文件清理结果:",p)}catch(p){console.error("清理临时文件失败:",p)}},6e4)}catch(_){console.error("下载所有图片时出错:",_),u.error(`下载失败: ${_ instanceof Error?_.message:String(_)}`)}finally{o.value=!1,setTimeout(()=>{a.value=0,i.value=""},2e3)}}return{isDownloading:o,downloadProgress:a,downloadProgressText:i,isImporting:t,importProgress:s,importProgressText:k,canExportText:A,canImportText:$,canDownload:N,exportText:ae,exportTextToJson:le,importText:Z,downloadCurrentImage:j,downloadAllImages:H}}const Ss={key:0,class:"result-section card result-card"},ks={class:"image-controls"},_s={class:"image-size-control"},Cs=["value"],ws={id:"imageSizeValue"},$s={class:"content-container"},Ts={class:"image-container"},Is=["src"],Ds={id:"detectedTextInfo",class:"text-info"},Rs={id:"detectedTextList"},Ms={class:"original-text"},Bs={class:"download-section"},Es={class:"download-buttons"},Ps=["disabled"],As={class:"download-all-container"},Fs=["disabled"],Ls={class:"download-format-selector"},Us=["disabled"],Os=["disabled"],zs={key:1,class:"empty-state-section"},jt=60,Vs=Ge({__name:"ImageResultDisplay",props:{isEditMode:{type:Boolean,default:!1}},emits:["toggle-edit-mode","retry-failed"],setup(n,{emit:r}){const u=[{label:"ZIP压缩包",value:"zip"},{label:"PDF文档",value:"pdf"},{label:"CBZ漫画",value:"cbz"}],o=r,a=st(),i=Qe(),t=xs(),s=y(100),k=oe({get:()=>w.value?.showOriginal??!1,set:m=>{w.value&&a.updateCurrentImage({showOriginal:m})}}),A=y("zip"),$=y(null),N=oe(()=>t.isDownloading.value),ae=oe(()=>t.downloadProgressText.value),le=oe(()=>t.downloadProgress.value),Z=oe(()=>a.hasImages),w=oe(()=>a.currentImage),Q=oe(()=>!!w.value?.translatedDataURL),j=oe(()=>!!(w.value?.translatedDataURL||w.value?.originalDataURL)),H=oe(()=>w.value?k.value||!w.value.translatedDataURL?w.value.originalDataURL:w.value.translatedDataURL:""),d=oe(()=>a.failedImageCount>0),l=oe(()=>({width:`${s.value}%`})),_=oe(()=>i.settings.useTextboxPrompt),x=oe(()=>{if(!w.value)return[];if(w.value.bubbleStates&&w.value.bubbleStates.length>0)return w.value.bubbleStates.map(c=>({original:c.originalText||"",translated:_.value?c.textboxText||c.translatedText||"":c.translatedText||""}));const m=w.value.originalTexts||[],C=_.value?w.value.textboxTexts||w.value.bubbleTexts||[]:w.value.bubbleTexts||[];return m.length===0?[]:m.map((c,U)=>({original:c||"",translated:C[U]||""}))}),z=oe(()=>x.value.length>0);function ee(m){if(!m||m.length<=jt)return m;let C="",c="";for(let U=0;U<m.length;U++)if(c+=m[U],c.length>=jt){let fe=-1;for(let K=c.length-1;K>=0;K--){const Y=c[K];if(Y&&["。","！","？",".","!","?","；",";","，",","].includes(Y)){fe=K+1;break}}fe>jt*.6?(C+=c.substring(0,fe)+`
`,c=c.substring(fe)):(C+=c+`
`,c="")}return c&&(C+=c),C}function be(m){return ee((m||"").trim())}function G(m){const C=(m||"").trim();return ee(C)}function F(m){return(m||"").includes("翻译失败")}function B(){k.value=!k.value}function S(){o("toggle-edit-mode")}function v(m){const C=m.target;s.value=parseInt(C.value,10)}function I(){o("retry-failed")}function T(){t.downloadCurrentImage()}function p(){t.downloadAllImages(A.value)}function f(){t.exportText()}function te(){$.value?.click()}async function se(m){const C=m.target,c=C.files?.[0];c&&(await t.importText(c),C.value="")}return(m,C)=>w.value?(V(),J("section",Ss,[e("div",ks,[Q.value?(V(),J("button",{key:0,id:"toggleImageButton",class:"control-btn",onClick:B},xe(k.value?"查看翻译图":"查看原图"),1)):Te("",!0),e("button",{id:"toggleEditModeButton",class:Le(["control-btn",{active:n.isEditMode}]),onClick:S},xe(n.isEditMode?"退出编辑":"切换编辑模式"),3),e("div",_s,[C[1]||(C[1]=e("label",{for:"imageSize"},"图片大小:",-1)),e("input",{type:"range",id:"imageSize",min:"50",max:"200",value:s.value,class:"slider range-slider",onInput:v},null,40,Cs),e("span",ws,xe(s.value)+"%",1)]),d.value?(V(),J("button",{key:1,id:"retranslateFailedButton",class:"retry-failed-btn",onClick:I,title:"重新翻译所有失败的图片"}," 重新翻译失败图片 ("+xe(he(a).failedImageCount)+") ",1)):Te("",!0)]),e("div",$s,[e("div",Ts,[e("img",{id:"translatedImageDisplay",src:H.value,alt:"翻译后图片",style:it(l.value)},null,12,Is)])]),e("div",Ds,[C[6]||(C[6]=e("h3",null,"检测到的文本（原文 → 译文）",-1)),e("pre",Rs,[z.value?(V(!0),J(Ze,{key:0},et(x.value,(c,U)=>(V(),J("span",{key:U,class:"text-item"},[e("span",Ms,xe(be(c.original)),1),C[2]||(C[2]=Ke(`
`,-1)),e("span",{class:Le(["translated-text",{"translation-error":F(c.translated)}])},xe(G(c.translated)),3),C[3]||(C[3]=Ke(`
`,-1)),C[4]||(C[4]=e("span",{class:"separator"},"──────────────────────────",-1)),C[5]||(C[5]=Ke(`

`,-1))]))),128)):(V(),J(Ze,{key:1},[Ke("未检测到文本或尚未翻译")],64))])]),e("div",Bs,[N.value?(V(),rt(dn,{key:0,visible:!0,percentage:le.value,label:ae.value||"下载中，请稍候..."},null,8,["percentage","label"])):Te("",!0),e("div",Es,[e("button",{id:"downloadButton",class:"download-btn primary",disabled:!j.value,onClick:T}," 下载当前图片 ",8,Ps),e("div",As,[e("button",{id:"downloadAllImagesButton",class:"download-btn primary",disabled:!Z.value,onClick:p}," 下载所有图片 ",8,Fs),e("div",Ls,[Ie(We,{modelValue:A.value,"onUpdate:modelValue":C[0]||(C[0]=c=>A.value=c),options:u},null,8,["modelValue"])])]),e("button",{id:"exportTextButton",class:"download-btn success",disabled:!Z.value,onClick:f}," 导出文本 ",8,Us),e("button",{id:"importTextButton",class:"download-btn success",disabled:!Z.value,onClick:te}," 导入文本 ",8,Os),e("input",{type:"file",ref_key:"importFileInput",ref:$,id:"importTextFileInput",style:{display:"none"},accept:".json",onChange:se},null,544)])])])):(V(),J("section",zs))}}),Ns=je(Vs,[["__scopeId","data-v-a26b9c58"]]),Ws={class:"guide-content"},Ks={class:"guide-footer"},qs={class:"dont-show-option"},Dt="saber_translator_dismiss_setup_reminder",Hs=Ge({__name:"FirstTimeGuide",emits:["openSettings"],setup(n,{expose:r,emit:u}){const o=u,a=y(!1),i=y(!1);ut(()=>{localStorage.getItem(Dt)!=="true"&&(a.value=!0)});function t(){i.value&&localStorage.setItem(Dt,"true"),a.value=!1}function s(){localStorage.setItem(Dt,"true"),a.value=!1,o("openSettings")}function k(){localStorage.removeItem(Dt)}return r({resetGuideState:k,showGuide:a}),(A,$)=>(V(),rt(jn,{"model-value":a.value,title:"欢迎使用 Saber-Translator",onClose:t},{default:_t(()=>[e("div",Ws,[$[3]||($[3]=e("div",{class:"guide-icon"},"🎉",-1)),$[4]||($[4]=e("div",{class:"guide-message"},[e("p",{class:"guide-title"},"首次使用提醒"),e("p",{class:"guide-text"}," 在开始翻译之前，请先配置翻译服务。 "),e("p",{class:"guide-text"},[Ke(" 点击右上角的 "),e("span",{class:"highlight"},"⚙️ 设置"),Ke(" 按钮，配置以下内容： ")]),e("ul",{class:"guide-list"},[e("li",null,"选择 OCR 引擎（文字识别）"),e("li",null,"配置翻译服务商和 API Key"),e("li",null,"（可选）配置高质量翻译和 AI 校对")])],-1)),e("div",{class:"guide-actions"},[e("button",{class:"guide-btn primary",onClick:s},[...$[1]||($[1]=[e("span",{class:"btn-icon"},"⚙️",-1),Ke(" 立即配置 ",-1)])]),e("button",{class:"guide-btn secondary",onClick:t}," 稍后配置 ")]),e("div",Ks,[e("label",qs,[ue(e("input",{type:"checkbox","onUpdate:modelValue":$[0]||($[0]=N=>i.value=N)},null,512),[[tt,i.value]]),$[2]||($[2]=e("span",null,"不再显示此提醒",-1))])])])]),_:1},8,["model-value"]))}}),Js=je(Hs,[["__scopeId","data-v-eda18e4a"]]),Gt="saber_translator_dismiss_setup_reminder",Ys=["siliconflow","deepseek","volcano","caiyun","baidu_translate","youdao_translate","gemini","custom_openai"],Xs={manga_ocr:"MangaOCR",paddle_ocr:"PaddleOCR",baidu_ocr:"百度OCR",ai_vision:"AI视觉OCR"},js=["ollama","sakura"],Gs=["custom_openai"],Zs=["custom_openai"],Qs={siliconflow:"SiliconFlow",deepseek:"DeepSeek",volcano:"火山引擎",caiyun:"彩云小译",baidu_translate:"百度翻译",youdao_translate:"有道翻译",gemini:"Google Gemini",custom_openai:"自定义 OpenAI",ollama:"Ollama",sakura:"Sakura"};function Qn(){const n=Qe(),r=dt(),u=y(!1),o=y(!1),a=oe(()=>{try{return localStorage.getItem(Gt)==="true"}catch{return!1}});function i(x){return Qs[x]||x}function t(x){return Ys.includes(x)}function s(x){return js.includes(x)}function k(x){return Gs.includes(x)}function A(x){return Zs.includes(x)}function $(x){return Xs[x]||x}function N(){const x=n.settings,z=x.ocrEngine,ee=x.baiduOcr,be=x.aiVisionOcr,G=[];return z?(z==="baidu_ocr"&&((!ee?.apiKey||ee.apiKey.trim()==="")&&G.push("百度OCR 的 API Key"),(!ee?.secretKey||ee.secretKey.trim()==="")&&G.push("百度OCR 的 Secret Key")),z==="ai_vision"&&(be?.provider||G.push("AI视觉OCR 的服务商"),(!be?.apiKey||be.apiKey.trim()==="")&&G.push("AI视觉OCR 的 API Key"),(!be?.modelName||be.modelName.trim()==="")&&G.push("AI视觉OCR 的模型名称"),be?.provider==="custom"&&(!be?.customBaseUrl||be.customBaseUrl.trim()==="")&&G.push("AI视觉OCR 的自定义 Base URL")),G.length>0?{valid:!1,message:`请先在顶部 ⚙️ 设置菜单中填写 ${G[0]}`,missingItems:G}:{valid:!0,message:""}):{valid:!1,message:"请先在顶部 ⚙️ 设置菜单中选择 OCR 引擎",missingItems:["OCR 引擎"]}}function ae(){const{translation:x}=n.settings,{provider:z,apiKey:ee,modelName:be,customBaseUrl:G}=x,F=[];return z?(t(z)&&(!ee||ee.trim()==="")&&F.push(`${i(z)} 的 API Key`),(!be||be.trim()==="")&&(s(z)||t(z))&&F.push(`${i(z)} 的模型名称`),k(z)&&(!G||G.trim()==="")&&F.push("自定义 OpenAI 服务的 Base URL"),F.length>0?{valid:!1,message:`请先在顶部 ⚙️ 设置菜单中填写 ${F[0]}`,missingItems:F}:{valid:!0,message:""}):{valid:!1,message:"请先在顶部 ⚙️ 设置菜单中选择翻译服务商",missingItems:["翻译服务商"]}}function le(){const{hqTranslation:x}=n.settings,{provider:z,apiKey:ee,modelName:be,customBaseUrl:G}=x,F=[];return z?((!ee||ee.trim()==="")&&F.push("高质量翻译的 API Key"),(!be||be.trim()==="")&&F.push("高质量翻译的模型名称"),A(z)&&(!G||G.trim()==="")&&F.push("高质量翻译的 Base URL"),F.length>0?{valid:!1,message:`请先在顶部 ⚙️ 设置菜单中填写 ${F[0]}`,missingItems:F}:{valid:!0,message:""}):{valid:!1,message:"请先在顶部 ⚙️ 设置菜单中选择高质量翻译的服务商",missingItems:["高质量翻译服务商"]}}function Z(x){const z=x||n.settings.proofreading.rounds,ee=[];if(!z||z.length===0)return{valid:!1,message:"请先在顶部 ⚙️ 设置菜单中添加至少一个校对轮次",missingItems:["校对轮次"]};for(let be=0;be<z.length;be++){const G=z[be];if(!G)continue;const F=G.name||`轮次${be+1}`;if(G.provider||ee.push(`校对 ${F} 的服务商`),(!G.apiKey||G.apiKey.trim()==="")&&ee.push(`校对 ${F} 的 API Key`),(!G.modelName||G.modelName.trim()==="")&&ee.push(`校对 ${F} 的模型名称`),ee.length>0)return{valid:!1,message:`请先在顶部 ⚙️ 设置菜单中为 ${ee[0]}`,missingItems:ee}}return{valid:!0,message:""}}function w(x="normal",z={}){let ee;switch(x){case"normal":ee=ae();break;case"hq":ee=le();break;case"proofread":ee=Z(z.proofreadingRounds);break;case"ocr":ee=N();break;default:ee=ae()}return ee.valid?!0:(r.error(ee.message),j(),!1)}function Q(){const x=N();if(!x.valid)return r.error(x.message),j(),!1;const z=ae();return z.valid?!0:(r.error(z.message),j(),!1)}function j(){const x=document.getElementById("openSettingsBtn");x&&(o.value=!0,x.style.animation="settingsBtnPulse 0.5s ease-in-out 3",x.style.boxShadow="0 0 10px var(--primary-color, #4a90d9)",setTimeout(()=>{x.style.animation="",x.style.boxShadow="",o.value=!1},3e3))}function H(){if(a.value){console.log("用户已选择不再显示设置提醒");return}u.value=!0}function d(x=!1){if(x)try{localStorage.setItem(Gt,"true"),console.log("用户选择永久关闭设置提醒")}catch(z){console.error("保存设置提醒状态失败:",z)}u.value=!1}function l(){try{localStorage.removeItem(Gt),console.log("设置提醒状态已重置")}catch(x){console.error("重置设置提醒状态失败:",x)}}function _(){setTimeout(()=>{H()},500)}return{showSetupReminder:u,isSettingsButtonHighlighted:o,isSetupReminderDismissed:a,validateOcrConfig:N,validateTranslationConfig:ae,validateHqTranslationConfig:le,validateProofreadingConfig:Z,validateBeforeTranslation:w,validateFullTranslationConfig:Q,highlightSettingsButton:j,checkAndShowSetupReminder:H,closeSetupReminder:d,resetSetupReminderDismiss:l,initValidation:_,getProviderDisplayName:i,getOcrEngineDisplayName:$,requiresApiKey:t,isLocalProvider:s,requiresBaseUrl:k}}const Rt={originalText:"",translatedText:"",textboxText:"",coords:[0,0,100,100],polygon:[],fontSize:25,fontFamily:"fonts/STSONG.TTF",textDirection:"auto",autoTextDirection:"vertical",textColor:"#000000",fillColor:Hn,rotationAngle:0,position:{x:0,y:0},strokeEnabled:sn,strokeColor:an,strokeWidth:on,inpaintMethod:"solid"};function nn(n){return{...{...Rt,...n},coords:n?.coords?[...n.coords]:[...Rt.coords],polygon:n?.polygon?n.polygon.map(u=>[...u]):[],position:n?.position?{...Rt.position,...n.position}:{...Rt.position}}}function eo(n){const[r,u,o,a]=n,i=Math.abs(o-r);return Math.abs(a-u)>i?"vertical":"horizontal"}function Nn(n,r){const{bubble_coords:u=[],bubble_states:o=[],original_texts:a=[],bubble_texts:i=[],textbox_texts:t=[],bubble_angles:s=[],auto_directions:k=[]}=n;return o.length>0?o.map((A,$)=>({...nn(r),...A,coords:A.coords||u[$]||[0,0,100,100]})):u.map((A,$)=>{let N;return k[$]?N=k[$]==="v"?"vertical":"horizontal":N=eo(A),nn({coords:A,originalText:a[$]||"",translatedText:i[$]||"",textboxText:t[$]||"",rotationAngle:s[$]||0,autoTextDirection:N,...r})})}function Mt(n){return n.map(r=>({...r,coords:[...r.coords],polygon:r.polygon?r.polygon.map(u=>[...u]):[],position:{...r.position}}))}function el(n){if(!n||typeof n!="object")return!1;const r=n;if(!Array.isArray(r.coords)||r.coords.length!==4||!r.coords.every(a=>typeof a=="number"&&!isNaN(a))||typeof r.fontSize!="number"||r.fontSize<=0)return!1;const u=["vertical","horizontal","auto"];if(typeof r.textDirection!="string"||!u.includes(r.textDirection))return!1;const o=["solid","lama_mpe","litelama"];return!(typeof r.inpaintMethod!="string"||!o.includes(r.inpaintMethod))}const gt=ln("bubble",()=>{const n=y([]),r=y(-1),u=y([]),o=y([]),a=y(!1),i=y(-1),t=y(0),s=y(0),k=y(0),A=y(0),$=y(!1),N=y(-1),ae=y(null),le=y(!1),Z=y(-1),w=y(0),Q=oe(()=>r.value>=0&&r.value<n.value.length?n.value[r.value]??null:null),j=oe(()=>n.value.length),H=oe(()=>n.value.length>0),d=oe(()=>r.value>=0),l=oe(()=>u.value.length>1),_=oe(()=>u.value.filter(g=>g>=0&&g<n.value.length).map(g=>n.value[g]).filter(g=>g!==void 0));function x(){const b=st().currentImage;b&&(b.bubbleStates=Mt(n.value),b.hasUnsavedChanges=!0,console.log("气泡状态已同步到当前图片"))}function z(g,b=!1){n.value=g,o.value=Mt(g),I(),console.log(`气泡数组已设置，共 ${g.length} 个气泡`),b||x()}function ee(g,b){const M=eo(g),O=Qe().settings.textStyle,re=O.layoutDirection,E=re==="auto"?"vertical":re||"vertical",P=nn({coords:g,translatedText:"",autoTextDirection:M,fontSize:O.fontSize,fontFamily:O.fontFamily,textDirection:E,textColor:O.textColor,fillColor:O.fillColor,inpaintMethod:O.inpaintMethod,strokeEnabled:O.strokeEnabled,strokeColor:O.strokeColor,strokeWidth:O.strokeWidth,rotationAngle:0,position:{x:0,y:0},...b});return n.value.push(P),console.log(`已添加气泡，当前共 ${n.value.length} 个`),x(),P}function be(g){return g<0||g>=n.value.length?(console.warn(`删除失败: 无效的索引 ${g}`),!1):(n.value.splice(g,1),r.value===g?r.value=-1:r.value>g&&r.value--,u.value=u.value.filter(b=>b!==g).map(b=>b>g?b-1:b),console.log(`已删除气泡，当前共 ${n.value.length} 个`),x(),!0)}function G(){if(u.value.length===0&&r.value<0)return;const g=[...new Set([...u.value,r.value])].filter(b=>b>=0).sort((b,M)=>M-b);for(const b of g)n.value.splice(b,1);I(),console.log(`已删除 ${g.length} 个气泡`),x()}function F(){n.value=[],o.value=[],I(),console.log("所有气泡已清除"),x()}function B(){n.value=[],o.value=[],I(),console.log("本地气泡状态已清除（不同步到imageStore）")}function S(g){g>=-1&&g<n.value.length&&(r.value=g,u.value=g>=0?[g]:[],console.log(`已选中气泡 ${g}`))}function v(g){if(g<0||g>=n.value.length)return;const b=u.value.indexOf(g);b>=0?(u.value.splice(b,1),r.value===g&&(r.value=u.value[0]??-1)):(u.value.push(g),r.value=g),console.log(`多选状态: ${u.value.join(", ")}`)}function I(){r.value=-1,u.value=[]}function T(){r.value>=0?u.value=[r.value]:u.value=[]}function p(){if(n.value.length===0)return!1;const g=r.value<n.value.length-1?r.value+1:0;return S(g),!0}function f(){if(n.value.length===0)return!1;const g=r.value>0?r.value-1:n.value.length-1;return S(g),!0}function te(g,b){if(g<0||g>=n.value.length)return console.warn(`更新失败: 无效的索引 ${g}`),!1;const M=n.value[g];return M?(Object.assign(M,b),console.log(`已更新气泡 ${g}`),x(),!0):!1}function se(g){return r.value<0?(console.warn("更新失败: 没有选中的气泡"),!1):te(r.value,g)}function m(g){const b=u.value.length>0?u.value:r.value>=0?[r.value]:[];for(const M of b){const D=n.value[M];D&&Object.assign(D,g)}x(),console.log(`已批量更新 ${b.length} 个气泡`)}function C(g){for(let b=0;b<n.value.length;b++){const M=n.value[b];M&&Object.assign(M,g)}x(),console.log(`已更新所有 ${n.value.length} 个气泡`)}function c(){if(n.value.length!==o.value.length)return!0;for(let g=0;g<n.value.length;g++){const b=n.value[g],M=o.value[g];if(!(!b||!M)&&(b.translatedText!==M.translatedText||b.textboxText!==M.textboxText||b.fontSize!==M.fontSize||b.fontFamily!==M.fontFamily||b.textDirection!==M.textDirection||b.textColor!==M.textColor||b.fillColor!==M.fillColor||b.rotationAngle!==M.rotationAngle||b.strokeEnabled!==M.strokeEnabled||b.strokeColor!==M.strokeColor||b.strokeWidth!==M.strokeWidth||b.inpaintMethod!==M.inpaintMethod||JSON.stringify(b.coords)!==JSON.stringify(M.coords)))return!0}return!1}function U(){n.value=Mt(o.value),I(),console.log("气泡状态已重置到初始状态")}function fe(){o.value=Mt(n.value),console.log("当前状态已保存为初始状态")}function K(){return{bubble_coords:n.value.map(g=>g.coords),bubble_texts:n.value.map(g=>g.translatedText),textbox_texts:n.value.map(g=>g.textboxText),font_sizes:n.value.map(g=>g.fontSize),font_families:n.value.map(g=>g.fontFamily),text_directions:n.value.map(g=>g.textDirection==="auto"?g.autoTextDirection==="vertical"?"v":"h":g.textDirection==="vertical"?"v":"h"),text_colors:n.value.map(g=>g.textColor),fill_colors:n.value.map(g=>g.fillColor),rotation_angles:n.value.map(g=>g.rotationAngle),stroke_enabled:n.value.map(g=>g.strokeEnabled),stroke_colors:n.value.map(g=>g.strokeColor),stroke_widths:n.value.map(g=>g.strokeWidth),inpaint_methods:n.value.map(g=>g.inpaintMethod)}}function Y(){return JSON.stringify(n.value)}function Se(g){try{const b=JSON.parse(g);if(!Array.isArray(b))return console.error("反序列化失败: 数据不是数组"),!1;const M=[];for(const D of b)el(D)?M.push(D):console.warn("跳过无效的气泡状态:",D);return z(M),!0}catch(b){return console.error("反序列化失败:",b),!1}}return{bubbles:n,selectedIndex:r,selectedIndices:u,initialStates:o,isDragging:a,draggingIndex:i,dragOffsetX:t,dragOffsetY:s,dragInitialX:k,dragInitialY:A,isResizing:$,resizingIndex:N,resizeCurrentCoords:ae,isRotating:le,rotatingIndex:Z,rotateCurrentAngle:w,selectedBubble:Q,bubbleCount:j,hasBubbles:H,hasSelection:d,isMultiSelect:l,selectedBubbles:_,setBubbles:z,addBubble:ee,deleteBubble:be,deleteSelected:G,clearBubbles:F,clearBubblesLocal:B,selectBubble:S,toggleMultiSelect:v,clearSelection:I,clearMultiSelect:T,selectNext:p,selectPrevious:f,updateBubble:te,updateSelectedBubble:se,updateAllSelected:m,updateAllBubbles:C,hasChanges:c,resetToInitial:U,saveAsInitial:fe,toApiRequest:K,serialize:Y,deserialize:Se}}),tl=Object.freeze(Object.defineProperty({__proto__:null,useBubbleStore:gt},Symbol.toStringTag,{value:"Module"}));function Zt(n){let r=n,u=0,o=0,a=Date.now();const i=()=>r<=0?0:Math.ceil(6e4/r);return{async acquire(){if(r<=0)return;const t=Date.now(),s=i();if(t-a>=6e4&&(a=t,o=0),o>=r){const A=6e4-(t-a);A>0&&await Wn(A),a=Date.now(),o=0}const k=t-u;k<s&&await Wn(s-k),u=Date.now(),o++},reset(){u=0,o=0,a=Date.now()},getRpm(){return r},setRpm(t){r=t,this.reset()}}}function Wn(n){return new Promise(r=>setTimeout(r,n))}function gn(){const n=st(),r=Qe(),u=gt(),o=Qn(),a=dt(),i=y(null),t=y({current:0,total:0,completed:0,failed:0,isInProgress:!1,isPaused:!1}),s=y(!1),k=y(!1),A=y(!1),$=oe(()=>s.value||n.isBatchTranslationInProgress||k.value||A.value),N=oe(()=>t.value.total===0?0:Math.round(t.value.completed/t.value.total*100));function ae(){const g=r.settings.translation.rpmLimit;i.value?i.value.setRpm(g):i.value=Zt(g)}function le(g){return g.includes(",")&&g.split(",")[1]||g}function Z(g){if(g.isManuallyAnnotated){const b=g.bubbleStates||[];return{coords:b.map(M=>M.coords),angles:b.map(M=>M.rotationAngle||0),isEmpty:b.length===0,isManual:!0}}return Array.isArray(g.bubbleStates)&&g.bubbleStates.length>0?{coords:g.bubbleStates.map(b=>b.coords),angles:g.bubbleStates.map(b=>b.rotationAngle||0),isEmpty:!1,isManual:!1}:Array.isArray(g.bubbleCoords)&&g.bubbleCoords.length>0?{coords:g.bubbleCoords,angles:g.bubbleAngles,isEmpty:!1,isManual:!1}:null}function w(g,b={}){const{settings:M}=r,{textStyle:D,translation:O,baiduOcr:re,aiVisionOcr:E,boxExpand:P,preciseMask:R}=M,h={image:le(g),ocr_engine:M.ocrEngine,source_language:M.sourceLanguage,model_provider:O.provider,api_key:O.apiKey,model_name:O.modelName,custom_base_url:O.customBaseUrl,target_language:M.targetLanguage,prompt_content:M.translatePrompt,textbox_prompt_content:M.textboxPrompt,use_textbox_prompt:M.useTextboxPrompt,rpm_limit_translation:O.rpmLimit,max_retries:O.maxRetries,use_json_format_translation:O.isJsonMode,detector_type:M.textDetector,box_expand_ratio:P.ratio,box_expand_top:P.top,box_expand_bottom:P.bottom,box_expand_left:P.left,box_expand_right:P.right,usePreciseMask:R.enabled,maskDilateSize:R.dilateSize,maskBoxExpandRatio:R.boxExpandRatio,fontSize:D.fontSize,autoFontSize:D.autoFontSize,fontFamily:D.fontFamily,textDirection:D.layoutDirection==="auto"?"vertical":D.layoutDirection,autoTextDirection:D.layoutDirection==="auto",textColor:D.textColor,fillColor:D.fillColor,strokeEnabled:D.strokeEnabled,strokeColor:D.strokeColor,strokeWidth:D.strokeWidth,use_inpainting:!1,use_lama:D.inpaintMethod==="lama_mpe"||D.inpaintMethod==="litelama",lamaModel:D.inpaintMethod==="litelama"?"litelama":"lama_mpe",showDetectionDebug:M.showDetectionDebug,remove_only:b.removeTextOnly,skip_translation:b.removeTextOnly},L=X=>X.map(ne=>[Math.round(ne[0]),Math.round(ne[1]),Math.round(ne[2]),Math.round(ne[3])]);return b.existingBubbleStates&&b.existingBubbleStates.length>0?(h.bubble_coords=L(b.existingBubbleStates.map(X=>X.coords)),h.bubble_angles=b.existingBubbleStates.map(X=>X.rotationAngle||0)):b.existingBubbleCoords&&(h.bubble_coords=L(b.existingBubbleCoords),h.bubble_angles=b.existingBubbleAngles),M.ocrEngine==="baidu_ocr"&&(h.baidu_api_key=re.apiKey,h.baidu_secret_key=re.secretKey,h.baidu_version=re.version,h.baidu_ocr_language=re.sourceLanguage),M.ocrEngine==="ai_vision"&&(h.ai_vision_provider=E.provider,h.ai_vision_api_key=E.apiKey,h.ai_vision_model_name=E.modelName,h.ai_vision_ocr_prompt=E.prompt,h.rpm_limit_ai_vision_ocr=E.rpmLimit,h.custom_ai_vision_base_url=E.customBaseUrl,h.use_json_format_ai_vision_ocr=E.isJsonMode),h}function Q(g,b,M={}){if(b.error||!b.translated_image){n.setTranslationStatus(g,"failed",b.error||"翻译失败");return}const{settings:D}=r,{textStyle:O}=D;let re=null;if(b.bubble_coords&&b.bubble_coords.length>0){const R={bubble_coords:b.bubble_coords,bubble_states:b.bubble_states,original_texts:b.original_texts,bubble_texts:b.bubble_texts,textbox_texts:b.textbox_texts,bubble_angles:b.bubble_angles,auto_directions:b.auto_directions},h={fontSize:O.fontSize,fontFamily:O.fontFamily,textDirection:O.layoutDirection==="auto"?"vertical":O.layoutDirection,textColor:O.textColor,fillColor:O.fillColor,strokeEnabled:O.strokeEnabled,strokeColor:O.strokeColor,strokeWidth:O.strokeWidth,inpaintMethod:O.inpaintMethod};re=Nn(R,h)}const E=b.translated_image?`data:image/png;base64,${b.translated_image}`:null,P=r.settings.textStyle.layoutDirection;n.updateImageByIndex(g,{translatedDataURL:E,cleanImageData:b.clean_image||null,bubbleStates:re,bubbleCoords:b.bubble_coords,bubbleAngles:b.bubble_angles||[],originalTexts:b.original_texts,textboxTexts:b.textbox_texts||[],bubbleTexts:re?.map(R=>R.translatedText||"")||[],userLayoutDirection:P,translationStatus:"completed",translationFailed:!1,hasUnsavedChanges:!0}),g===n.currentImageIndex&&re&&u.setBubbles(re)}async function j(g={}){if(g.removeTextOnly){if(!o.validateBeforeTranslation("ocr"))return!1}else if(!o.validateBeforeTranslation("normal"))return!1;const b=n.currentImage;if(!b)return a.error("请先上传图片"),!1;s.value=!0,n.setTranslationStatus(n.currentImageIndex,"processing");const M=a.showGeneralMessage("翻译中...","info",!1,0);try{ae(),i.value&&await i.value.acquire();const D={...g};if(!D.existingBubbleCoords&&!D.existingBubbleStates){const E=Z(b);if(E)if(E.isEmpty)console.log("翻译当前图片: 文本框已被用户清空，将跳过翻译"),a.info("该图片无文本框，跳过翻译",3e3),D.existingBubbleCoords=[],D.existingBubbleAngles=[],D.useExistingBubbles=!0;else{D.existingBubbleCoords=E.coords,D.existingBubbleAngles=E.angles,D.useExistingBubbles=!0;const P=E.isManual?"手动标注框":"已有的文本框";console.log(`翻译当前图片: 使用 ${E.coords.length} 个${P}`),a.info(E.isManual?"检测到手动标注框，将优先使用...":"使用已有的文本框进行翻译...",3e3)}}const O=w(b.originalDataURL,D),re=await Et(O);return a.clearGeneralMessageById(M),Q(n.currentImageIndex,re,g),re.translated_image&&!re.error?(a.success("翻译成功！"),!0):(a.error(re.error||"翻译失败"),!1)}catch(D){a.clearGeneralMessageById(M);const O=D instanceof Error?D.message:"翻译请求失败";return n.markCurrentAsFailed(O),a.error(O),!1}finally{s.value=!1}}async function H(g,b={}){const M=n.images[g];if(!M)return console.error(`图片索引 ${g} 不存在`),!1;n.setTranslationStatus(g,"processing");try{i.value&&await i.value.acquire();const D={...b};if(!D.existingBubbleCoords&&!D.existingBubbleStates){const E=Z(M);if(E)if(E.isEmpty)console.log(`批量翻译图片 ${g}: 文本框已被用户清空，跳过此图片的翻译`),D.existingBubbleCoords=[],D.existingBubbleAngles=[],D.useExistingBubbles=!0;else{D.existingBubbleCoords=E.coords,D.existingBubbleAngles=E.angles,D.useExistingBubbles=!0;const P=E.isManual?"手动标注框":"已有的文本框";console.log(`批量翻译图片 ${g}: 使用 ${E.coords.length} 个${P}`)}}const O=w(M.originalDataURL,D),re=await Et(O);return Q(g,re,b),!!re.translated_image&&!re.error}catch(D){const O=D instanceof Error?D.message:"翻译请求失败";return n.setTranslationStatus(g,"failed",O),!1}}async function d(g={}){if(g.removeTextOnly){if(!o.validateBeforeTranslation("ocr"))return!1}else if(!o.validateBeforeTranslation("normal"))return!1;const b=n.images;if(b.length===0)return a.error("请先上传图片"),!1;const M=g.removeTextOnly===!0;t.value={current:0,total:b.length,completed:0,failed:0,isInProgress:!0,isPaused:!1,label:M?`消除文字: 0/${b.length}`:`0/${b.length}`,percentage:0},n.setBatchTranslationInProgress(!0),ae(),a.info(M?`开始消除 ${b.length} 张图片文字...`:`开始批量翻译 ${b.length} 张图片...`);let D=!0;try{for(let O=0;O<b.length;O++){if(n.isBatchTranslationPaused&&await new Promise(E=>{n.setBatchTranslationResumeCallback(E)}),!n.isBatchTranslationInProgress){console.log("批量翻译已取消");break}t.value.current=O+1,t.value.label=M?`消除文字: ${O+1}/${b.length}`:`${O+1}/${b.length}`,t.value.percentage=Math.round((O+1)/b.length*100),await H(O,g)?t.value.completed++:(t.value.failed++,D=!1)}return t.value.failed>0?a.warning(M?`消除文字完成，${t.value.failed} 张图片失败`:`翻译完成，${t.value.failed} 张图片失败`):a.success(M?"所有图片文字消除完成":"所有图片翻译完成"),D}catch(O){const re=O instanceof Error?O.message:"批量翻译失败";return a.error(re),!1}finally{n.setBatchTranslationInProgress(!1);const O=n.currentImageIndex;if(O>=0&&O<n.images.length){const re=n.images[O];re&&(re.bubbleStates&&re.bubbleStates.length>0&&u.setBubbles(re.bubbleStates),n.setCurrentImageIndex(O))}setTimeout(()=>{t.value.isInProgress=!1},1e3)}}function l(){n.isBatchTranslationInProgress&&!n.isBatchTranslationPaused&&(n.setBatchTranslationPaused(!0),t.value.isPaused=!0,a.info("批量翻译已暂停"))}function _(){n.isBatchTranslationInProgress&&n.isBatchTranslationPaused&&(n.resumeBatchTranslation(),t.value.isPaused=!1,a.info("批量翻译继续中"))}function x(){n.isBatchTranslationInProgress&&(n.isBatchTranslationPaused&&n.resumeBatchTranslation(),n.setBatchTranslationInProgress(!1),t.value.isInProgress=!1,a.info("批量翻译已取消"))}async function z(){return j({removeTextOnly:!0})}async function ee(){return d({removeTextOnly:!0})}async function be(g={}){if(!o.validateBeforeTranslation("normal"))return!1;const b=n.getFailedImageIndices();if(b.length===0)return a.info("没有失败的图片需要重新翻译"),!0;t.value={current:0,total:b.length,completed:0,failed:0,isInProgress:!0,isPaused:!1},n.setBatchTranslationInProgress(!0),ae();let M=!0;try{for(let D=0;D<b.length&&(n.isBatchTranslationPaused&&await new Promise(E=>{n.setBatchTranslationResumeCallback(E)}),!!n.isBatchTranslationInProgress);D++){t.value.current=D+1;const O=b[D];if(O===void 0)continue;await H(O,g)?t.value.completed++:(t.value.failed++,M=!1)}return t.value.failed>0?a.warning(`重试完成，仍有 ${t.value.failed} 张图片失败`):a.success("所有失败图片重新翻译完成"),M}catch(D){const O=D instanceof Error?D.message:"重试翻译失败";return a.error(O),!1}finally{n.setBatchTranslationInProgress(!1),setTimeout(()=>{t.value.isInProgress=!1},1e3)}}let G=[],F=null;function B(){return"session_"+Date.now()+"_"+Math.random().toString(36).substring(2,9)}function S(){const g=n.images;if(g.length===0)return null;const b=[];for(let M=0;M<g.length;M++){const D=g[M];if(!D)continue;const O=D.originalTexts||[],re={imageIndex:M,bubbles:[]};for(let E=0;E<O.length;E++){const P=O[E]||"";let R="vertical";const h=D.bubbleStates?.[E];if(h&&h.textDirection){const L=h.textDirection;R=L==="auto"?"vertical":L}else D.userLayoutDirection&&D.userLayoutDirection!=="auto"&&(R=D.userLayoutDirection);re.bubbles.push({bubbleIndex:E,original:P,translated:"",textDirection:R})}b.push(re)}return b}function v(){return n.images.map(g=>{const b=g.originalDataURL;return b.includes(",")?b.split(",")[1]||"":b})}function I(g,b,M){return g.filter(D=>D.imageIndex>=b&&D.imageIndex<M)}function T(g){if(!g||g.length===0)return[];const b=[];for(const M of g){if(!M){console.warn("mergeJsonResults: 跳过空的批次结果");continue}const D=Array.isArray(M)?M:[M];for(const O of D)O&&typeof O=="object"&&"imageIndex"in O?b.push(O):console.warn("mergeJsonResults: 跳过无效的图片数据",O)}return b.sort((M,D)=>M.imageIndex-D.imageIndex),b}async function p(g,b,M){const{hqTranslation:D}=r.settings,O=JSON.stringify(b,null,2),re=[{type:"text",text:D.prompt+`

以下是JSON数据:
\`\`\`json
`+O+"\n```"}];for(const R of g)re.push({type:"image_url",image_url:{url:`data:image/png;base64,${R}`}});const E=[{role:"system",content:"你是一个专业的漫画翻译助手，能够根据漫画图像内容和上下文提供高质量的翻译。"},{role:"user",content:re}],P={provider:D.provider,api_key:D.apiKey,model_name:D.modelName,custom_base_url:D.customBaseUrl,messages:E,low_reasoning:D.lowReasoning,force_json_output:D.forceJsonOutput,no_thinking_method:D.noThinkingMethod,use_stream:D.useStream};try{console.log(`高质量翻译: 通过后端代理调用 ${D.provider} API...`);const R=await en(P);if(!R.success)throw new Error(R.error||"API 调用失败");if(R.results&&R.results.length>0){const L=R.results[0];if(L&&"imageIndex"in L&&"bubbles"in L)return R.results}const h=R.content;if(h)if(D.forceJsonOutput)try{return JSON.parse(h)}catch(L){throw console.error("解析AI强制JSON返回的内容失败:",L),new Error("解析AI返回的JSON结果失败")}else{const L=h.match(/```json\s*([\s\S]*?)\s*```/);if(L&&L[1])try{return JSON.parse(L[1])}catch(X){throw console.error("解析AI返回的JSON失败:",X),new Error("解析AI返回的翻译结果失败")}}return null}catch(R){throw console.error("调用AI翻译API失败:",R),R}}async function f(){if(n.images.length===0)return a.warning("请先添加图片"),!1;if(n.isBatchTranslationInProgress)return a.warning("请等待当前批量操作完成"),!1;if(!o.validateBeforeTranslation("hq"))return!1;const{hqTranslation:g,textStyle:b}=r.settings,M=b.layoutDirection;F={fontFamily:b.fontFamily,fontSize:b.fontSize,autoFontSize:b.autoFontSize,autoTextDirection:M==="auto",textDirection:M==="auto"?"vertical":M,fillColor:b.fillColor,textColor:b.textColor,rotationAngle:0,strokeEnabled:b.strokeEnabled,strokeColor:b.strokeColor,strokeWidth:b.strokeWidth},console.log("高质量翻译前保存的文本样式设置:",F),t.value={current:0,total:n.images.length,completed:0,failed:0,isInProgress:!0,isPaused:!1,label:"准备翻译...",percentage:0},a.info("步骤1/4: 消除所有图片文字..."),k.value=!0,n.setBatchTranslationInProgress(!0);try{await te(),a.info("步骤2/4: 导出文本数据..."),t.value.label="导出文本数据...",t.value.percentage=25;const D=S();if(!D)throw new Error("导出文本失败");a.info("步骤3/4: 准备图片数据..."),t.value.label="准备图片数据...",t.value.percentage=40;const O=v();a.info("步骤4/4: 发送到AI进行翻译..."),t.value.label="开始发送到AI...",t.value.percentage=50;const re=g.batchSize||3,E=g.sessionReset||5,P=g.maxRetries??2;G=[];const R=O.length,h=Math.ceil(R/re),L=g.rpmLimit||0,X=L>0?Zt(L):null;let ne=0,ye=B();for(let ge=0;ge<h;ge++){t.value.label=`${ge+1}/${h}`,t.value.percentage=Math.round(50+ge/h*40),ne>=E&&(console.log("重置会话上下文"),ye=B(),ne=0);const ie=ge*re,ke=Math.min(ie+re,R),ve=O.slice(ie,ke),Pe=I(D,ie,ke);let De=0,_e=!1;for(;De<=P&&!_e;)try{X&&await X.acquire();const ce=await p(ve,Pe,ye);if(ce)G.push(ce),_e=!0;else{if(De++,De>P)break;await new Promise($e=>setTimeout($e,1e3));continue}ne++}catch(ce){De++,De<=P?(console.log(`批次 ${ge+1} 翻译失败，第 ${De}/${P} 次重试...`),a.warning(`批次 ${ge+1} 失败，正在重试 (${De}/${P})...`),await new Promise($e=>setTimeout($e,1e3))):(console.error(`批次 ${ge+1} 翻译最终失败:`,ce),a.error(`批次 ${ge+1} 翻译失败: ${ce instanceof Error?ce.message:"未知错误"}`))}}return a.info("翻译完成，正在导入翻译结果..."),t.value.label="导入翻译结果...",t.value.percentage=90,await se(T(G)),t.value.label="翻译完成！",t.value.percentage=100,a.success("高质量翻译完成！"),!0}catch(D){return console.error("高质量翻译过程出错:",D),a.error(`翻译失败: ${D instanceof Error?D.message:"未知错误"}`),!1}finally{k.value=!1,n.setBatchTranslationInProgress(!1),setTimeout(()=>{t.value.isInProgress=!1},1e3)}}async function te(){const g=n.images.length;let b=0;t.value.label=`消除文字: 0/${g}`,t.value.percentage=0;for(let M=0;M<g;M++){const D=Math.floor(M/g*25);t.value.label=`消除文字: ${M+1}/${g}`,t.value.percentage=D,n.setTranslationStatus(M,"processing");const O=n.images[M];if(!O||!O.originalDataURL){n.setTranslationStatus(M,"pending");continue}const re=Z(O);if(re?.isEmpty){console.log(`高质量翻译[${M}]: 文本框已被用户清空，跳过此图片`),n.setTranslationStatus(M,"pending");continue}if(re){const E=re.isManual?"手动标注框":"已有文本框";console.log(`高质量翻译[${M}]: 使用${E} ${re.coords.length} 个`)}try{const E=w(O.originalDataURL,{removeTextOnly:!0,existingBubbleCoords:re?.coords,existingBubbleAngles:re?.angles,useExistingBubbles:!!re}),P=await Et(E);if(P.translated_image){const R=F?.textDirection,h=R==="vertical"||R==="horizontal"||R==="auto"?R:"vertical",L=P.bubble_coords?Nn(P,{fontSize:F?.fontSize||r.settings.textStyle.fontSize,fontFamily:F?.fontFamily||r.settings.textStyle.fontFamily,textDirection:h,textColor:F?.textColor||r.settings.textStyle.textColor,fillColor:F?.fillColor||r.settings.textStyle.fillColor,strokeEnabled:F?.strokeEnabled??r.settings.textStyle.strokeEnabled,strokeColor:F?.strokeColor||r.settings.textStyle.strokeColor,strokeWidth:F?.strokeWidth??r.settings.textStyle.strokeWidth,inpaintMethod:r.settings.textStyle.inpaintMethod}):[];n.updateImageByIndex(M,{translatedDataURL:`data:image/png;base64,${P.translated_image}`,cleanImageData:P.clean_image||null,bubbleCoords:P.bubble_coords||[],bubbleAngles:P.bubble_angles||[],originalTexts:P.original_texts||[],textboxTexts:P.textbox_texts||[],bubbleStates:L,bubbleTexts:L.map(X=>X.translatedText||""),translationFailed:!1,translationStatus:"completed",showOriginal:!1,hasUnsavedChanges:!0}),console.log(`高质量翻译-消除文字[${M+1}/${g}]: 处理完成`)}else b++,n.updateImageByIndex(M,{translationFailed:!0,translationStatus:"failed"})}catch(E){console.error(`图片 ${M} 消除文字失败:`,E),b++,n.updateImageByIndex(M,{translationFailed:!0,translationStatus:"failed"})}}if(t.value.label="消除文字完成",t.value.percentage=25,b>0)throw new Error(`消除文字完成，但有 ${b} 张图片失败`)}async function se(g){if(!g||g.length===0)throw new Error("没有有效的翻译数据可导入");const b=n.images,M=n.currentImageIndex,D=F?.fontSize||r.settings.textStyle.fontSize,O=F?.autoFontSize??r.settings.textStyle.autoFontSize,re=F?.fontFamily||r.settings.textStyle.fontFamily,E=F?.textDirection||r.settings.textStyle.layoutDirection,P=E==="auto"?"vertical":E,R=F?.textColor||r.settings.textStyle.textColor,h=F?.fillColor||r.settings.textStyle.fillColor,L=F?.strokeEnabled??r.settings.textStyle.strokeEnabled,X=F?.strokeColor||r.settings.textStyle.strokeColor,ne=F?.strokeWidth??r.settings.textStyle.strokeWidth;t.value.label="更新图片数据...",t.value.percentage=90;const ye=g.length;let ge=0;for(const ie of g){ge++,t.value.label=`处理图片 ${ge}/${ye}`,t.value.percentage=90+ge/ye*5;const ke=ie.imageIndex;if(ke<0||ke>=b.length){console.warn(`跳过无效的图片索引: ${ke}`);continue}const ve=b[ke];if(!ve)continue;let Pe=!1;const De=ve.bubbleTexts||[],_e=ve.bubbleCoords||[];for(const ce of ie.bubbles||[]){const $e=ce.bubbleIndex;if($e<0||$e>=_e.length){console.warn(`图片 ${ke}: 跳过无效的气泡索引 ${$e}`);continue}const Ue=ce.translated;let Be=ce.textDirection;Be==="auto"&&(Be=P),De[$e]=Ue;const Fe=Be==="vertical"||Be==="horizontal"?Be:P;if(!ve.bubbleStates||!Array.isArray(ve.bubbleStates)||ve.bubbleStates.length!==_e.length){const Ce=ve.bubbleAngles||[],q=[];for(let pe=0;pe<_e.length;pe++){const Me=pe===$e?Fe:P,Oe=_e[pe];let ot=Me;const Xe=ve.bubbleStates?.[pe];if(Xe?.autoTextDirection&&Xe.autoTextDirection!=="auto")ot=Xe.autoTextDirection;else if(Oe&&Oe.length>=4){const[Je,mt,Pt,At]=Oe;ot=At-mt>Pt-Je?"vertical":"horizontal"}q.push({translatedText:De[pe]||"",originalText:ve.originalTexts?.[pe]||"",textboxText:"",coords:Oe,polygon:[],fontSize:D,fontFamily:re,textDirection:Me,autoTextDirection:ot,position:{x:0,y:0},textColor:R,rotationAngle:Ce[pe]||0,fillColor:h,strokeEnabled:L,strokeColor:X,strokeWidth:ne,inpaintMethod:r.settings.textStyle.inpaintMethod})}ve.bubbleStates=q}else if(ve.bubbleStates[$e])ve.bubbleStates[$e].translatedText=Ue,Be&&Be!=="auto"&&(ve.bubbleStates[$e].textDirection=Fe);else{const q=(ve.bubbleAngles||[])[$e]||0,pe=_e[$e];let Me=Fe;if(pe&&pe.length>=4){const[Oe,ot,Xe,Je]=pe;Me=Je-ot>Xe-Oe?"vertical":"horizontal"}ve.bubbleStates[$e]={translatedText:Ue,originalText:ve.originalTexts?.[$e]||"",textboxText:"",coords:pe,polygon:[],fontSize:D,fontFamily:re,textDirection:Fe,autoTextDirection:Me,position:{x:0,y:0},textColor:R,rotationAngle:q,fillColor:h,strokeEnabled:L,strokeColor:X,strokeWidth:ne,inpaintMethod:r.settings.textStyle.inpaintMethod}}Pe=!0}if(Pe&&ve.bubbleStates){const ce=ve.bubbleStates.map($e=>$e.translatedText||"");if(ve.cleanImageData)try{const{apiClient:$e}=await lt(async()=>{const{apiClient:Ce}=await import("./client.Bht704G-.js");return{apiClient:Ce}},__vite__mapDeps([4,5])),Ue=ve.bubbleStates.map(Ce=>({translatedText:Ce.translatedText||"",coords:Ce.coords,fontSize:Ce.fontSize||D,fontFamily:Ce.fontFamily||re,textDirection:Ce.textDirection||P,textColor:Ce.textColor||R,rotationAngle:Ce.rotationAngle||0,position:Ce.position||{x:0,y:0},strokeEnabled:Ce.strokeEnabled??L,strokeColor:Ce.strokeColor||X,strokeWidth:Ce.strokeWidth??ne}));let Be=ve.cleanImageData;Be.includes("base64,")&&(Be=Be.split("base64,")[1]||"");const Fe=await $e.post("/api/re_render_image",{clean_image:Be,bubble_texts:ce,bubble_coords:_e,fontSize:O?"auto":D,autoFontSize:O,fontFamily:re,textDirection:P,textColor:R,bubble_states:Ue,use_individual_styles:!0,use_inpainting:!1,use_lama:!1,fillColor:null,is_font_style_change:!1,strokeEnabled:L,strokeColor:X,strokeWidth:ne});Fe.rendered_image&&(n.updateImageByIndex(ke,{translatedDataURL:`data:image/png;base64,${Fe.rendered_image}`,bubbleStates:ve.bubbleStates,bubbleTexts:ce,hasUnsavedChanges:!0}),console.log(`已完成图片 ${ke} 的渲染`))}catch($e){console.error(`重新渲染图片 ${ke} 失败:`,$e)}else n.updateImageByIndex(ke,{bubbleStates:ve.bubbleStates,bubbleTexts:ce,hasUnsavedChanges:!0})}}M>=0&&M<b.length&&n.setCurrentImageIndex(M)}let m=[];function C(){const g=n.images;if(g.length===0)return null;const b=[];for(let M=0;M<g.length;M++){const D=g[M];if(!D)continue;const O=D.originalTexts||[],re=D.bubbleTexts||[],E={imageIndex:M,bubbles:[]};for(let P=0;P<O.length;P++){const R=O[P]||"",h=(P<re.length?re[P]:"")||"";let L="vertical";const X=D.bubbleStates?.[P];if(X&&X.textDirection){const ne=X.textDirection;L=ne==="auto"?"vertical":ne}else D.userLayoutDirection&&D.userLayoutDirection!=="auto"&&(L=D.userLayoutDirection);E.bubbles.push({bubbleIndex:P,original:R,translated:h,textDirection:L})}b.push(E)}return b}function c(g,b,M){return g.filter(D=>D.imageIndex>=b&&D.imageIndex<M)}function U(g){if(!g||g.length===0)return[];const b=[];for(const M of g){if(!M)continue;const D=Array.isArray(M)?M:[M];for(const O of D)O&&typeof O=="object"&&"imageIndex"in O&&b.push(O)}return b.sort((M,D)=>M.imageIndex-D.imageIndex),b}async function fe(g,b,M,D){const O=JSON.stringify(b,null,2),re=[{type:"text",text:M.prompt+`

以下是JSON数据，包含原文和已有译文:
\`\`\`json
`+O+"\n```\n请在保持JSON格式的情况下，校对每个bubble的translated字段，使翻译更加准确、自然、符合语境。"}];for(const P of g)re.push({type:"image_url",image_url:{url:`data:image/png;base64,${P}`}});const E={provider:M.provider,api_key:M.apiKey,model_name:M.modelName,custom_base_url:M.customBaseUrl,messages:[{role:"system",content:"你是一个专业的漫画翻译校对助手，能够根据漫画图像内容和上下文对已有翻译进行校对和润色。"},{role:"user",content:re}],low_reasoning:M.lowReasoning,no_thinking_method:M.noThinkingMethod,force_json_output:M.forceJsonOutput};try{console.log(`AI校对: 通过后端代理调用 ${M.provider} API...`);const P=await en(E);if(!P.success)throw new Error(P.error||"API 调用失败");if(P.results&&P.results.length>0){const h=P.results[0];if(h&&"imageIndex"in h&&"bubbles"in h)return P.results}const R=P.content;if(R)if(M.forceJsonOutput)try{return JSON.parse(R)}catch(h){throw console.error("解析AI强制JSON返回的内容失败:",h),new Error("解析AI返回的JSON结果失败")}else{const h=R.match(/```json\s*([\s\S]*?)\s*```/);if(h&&h[1])try{return JSON.parse(h[1])}catch(L){throw console.error("解析AI返回的JSON失败:",L),new Error("解析AI返回的校对结果失败")}try{return JSON.parse(R)}catch(L){throw console.error("直接解析AI返回内容失败:",L),new Error("无法解析AI返回的校对结果")}}return null}catch(P){throw console.error("调用AI校对API失败:",P),P}}async function K(g){if(!g||g.length===0){console.warn("没有有效的校对数据可导入"),a.warning("没有有效的校对结果可导入");return}const b=n.images,M=n.currentImageIndex,{textStyle:D}=r.settings,O=D.fontSize,re=D.fontFamily,E=D.layoutDirection,P=E==="auto"?"vertical":E,R=D.textColor,h=D.fillColor,L=D.strokeEnabled,X=D.strokeColor,ne=D.strokeWidth;for(const ye of g){const ge=ye.imageIndex;if(ge<0||ge>=b.length){console.warn(`跳过无效的图片索引: ${ge}`);continue}const ie=b[ge];if(!ie)continue;if(!ye.bubbles||!Array.isArray(ye.bubbles)||ye.bubbles.length===0){console.warn(`图片 ${ge}: 没有有效的气泡数据`);continue}let ke=!1;const ve=ie.bubbleTexts||[],Pe=ie.bubbleCoords||[];for(const De of ye.bubbles){const _e=De.bubbleIndex,ce=De.translated||"";let $e=De.textDirection;if((!$e||$e==="auto")&&($e=P),_e<0||_e>=Pe.length){console.warn(`图片 ${ge}: 跳过无效的气泡索引 ${_e}`);continue}for(;ve.length<=_e;)ve.push("");if(ve[_e]=ce,$e&&$e!=="auto"){const Ue=$e==="vertical"||$e==="horizontal"?$e:P;if(!ie.bubbleStates||!Array.isArray(ie.bubbleStates)||ie.bubbleStates.length!==Pe.length){const Be=ie.bubbleAngles||[],Fe=[];for(let Ce=0;Ce<Pe.length;Ce++){const q=Ce===_e?Ue:P,pe=Pe[Ce];let Me=q;const Oe=ie.bubbleStates?.[Ce];if(Oe?.autoTextDirection&&Oe.autoTextDirection!=="auto")Me=Oe.autoTextDirection;else if(pe&&pe.length>=4){const[ot,Xe,Je,mt]=pe;Me=mt-Xe>Je-ot?"vertical":"horizontal"}Fe.push({translatedText:ve[Ce]||"",originalText:ie.originalTexts?.[Ce]||"",coords:pe,fontSize:O,fontFamily:re,textDirection:q,autoTextDirection:Me,position:{x:0,y:0},textColor:R,rotationAngle:Be[Ce]||0,fillColor:h,strokeEnabled:L,strokeColor:X,strokeWidth:ne})}ie.bubbleStates=Fe}else ie.bubbleStates[_e]&&(ie.bubbleStates[_e].translatedText=ce,ie.bubbleStates[_e].textDirection=Ue)}ke=!0}if(ke&&ie.bubbleStates){const De=ie.bubbleStates.map(_e=>_e.translatedText||"");if(ie.cleanImageData)try{const{apiClient:_e}=await lt(async()=>{const{apiClient:Be}=await import("./client.Bht704G-.js");return{apiClient:Be}},__vite__mapDeps([4,5])),ce=ie.bubbleStates.map(Be=>({translatedText:Be.translatedText||"",coords:Be.coords,fontSize:Be.fontSize||O,fontFamily:Be.fontFamily||re,textDirection:Be.textDirection||P,textColor:Be.textColor||R,rotationAngle:Be.rotationAngle||0,position:Be.position||{x:0,y:0},strokeEnabled:Be.strokeEnabled??L,strokeColor:Be.strokeColor||X,strokeWidth:Be.strokeWidth??ne}));let $e=ie.cleanImageData;$e.includes("base64,")&&($e=$e.split("base64,")[1]||"");const Ue=await _e.post("/api/re_render_image",{clean_image:$e,bubble_texts:De,bubble_coords:Pe,fontSize:O,fontFamily:re,textDirection:P,textColor:R,bubble_states:ce,use_individual_styles:!0,use_inpainting:!1,use_lama:!1,fillColor:null,is_font_style_change:!1,strokeEnabled:L,strokeColor:X,strokeWidth:ne});Ue.rendered_image&&(n.updateImageByIndex(ge,{translatedDataURL:`data:image/png;base64,${Ue.rendered_image}`,bubbleStates:ie.bubbleStates,bubbleTexts:De,hasUnsavedChanges:!0}),console.log(`已完成图片 ${ge} 的校对渲染`))}catch(_e){console.error(`重新渲染图片 ${ge} 失败:`,_e)}else n.updateImageByIndex(ge,{bubbleStates:ie.bubbleStates,bubbleTexts:De,hasUnsavedChanges:!0})}}M>=0&&M<b.length&&n.setCurrentImageIndex(M)}async function Y(){if(!o.validateBeforeTranslation("proofread"))return!1;const{proofreading:g}=r.settings;if(!g.enabled||g.rounds.length===0)return a.error("请先启用 AI 校对并添加校对轮次"),!1;const b=n.images;if(b.length===0)return a.error("请先上传图片"),!1;if(!b.some(O=>O.bubbleTexts&&O.bubbleTexts.length>0))return a.error("请先进行翻译以获取译文"),!1;A.value=!0,n.setBatchTranslationInProgress(!0);const D=g.rounds.length;t.value={current:0,total:D,completed:0,failed:0,isInProgress:!0,isPaused:!1,label:"准备校对...",percentage:0},a.info(`开始校对，共 ${D} 轮`);try{for(let O=0;O<D;O++){const re=g.rounds[O];if(!re)continue;const E=re.name||`轮次${O+1}`,P=O/D*100,R=1/D*100;a.info(`校对第 ${O+1}/${D} 轮: ${E}`),t.value.label=`轮次 ${O+1}/${D}`,t.value.percentage=Math.round(P),a.info(`轮次 ${O+1}/${D}: 导出文本数据...`),t.value.label="导出文本...",t.value.percentage=Math.round(P+R*.2);const h=C();if(!h)throw new Error("导出文本失败");a.info(`轮次 ${O+1}/${D}: 准备图片数据...`),t.value.label="准备图片数据...",t.value.percentage=Math.round(P+R*.4);const L=v();a.info(`轮次 ${O+1}/${D}: 发送到AI进行校对...`),t.value.label="开始发送到AI...",t.value.percentage=Math.round(P+R*.5);const X=re.batchSize||3,ne=re.sessionReset||20,ye=g.maxRetries??2;m=[];const ge=L.length,ie=Math.ceil(ge/X),ke=re.rpmLimit||7,ve=ke>0?Zt(ke):null;let Pe=0,De=B(),_e=0;for(let ce=0;ce<ie;ce++){const $e=P+R*.5+R*.4*(ce/ie);t.value.label=`轮次 ${O+1}/${D}: ${ce+1}/${ie}`,t.value.percentage=Math.round($e),Pe>=ne&&(console.log("重置会话上下文"),De=B(),Pe=0);const Ue=ce*X,Be=Math.min(Ue+X,ge),Fe=L.slice(Ue,Be),Ce=c(h,Ue,Be);let q=0,pe=!1;for(;q<=ye&&!pe;)try{ve&&await ve.acquire();const Me=await fe(Fe,Ce,re,De);Me&&(m.push(Me),_e++,pe=!0),Pe++}catch(Me){q++,q<=ye?(console.log(`轮次 ${O+1}, 批次 ${ce+1} 校对失败，第 ${q}/${ye} 次重试...`),a.warning(`轮次 ${O+1}, 批次 ${ce+1} 失败，正在重试 (${q}/${ye})...`),await new Promise(Oe=>setTimeout(Oe,1e3))):(console.error(`轮次 ${O+1}, 批次 ${ce+1} 校对最终失败:`,Me),a.error(`轮次 ${O+1}, 批次 ${ce+1} 校对失败: ${Me instanceof Error?Me.message:"未知错误"}`))}}if(_e===0)throw new Error(`轮次 ${O+1} 校对完全失败，请检查API设置或校对提示词`);a.info(`轮次 ${O+1}/${D}: 导入校对结果...`),t.value.label="导入校对结果...",t.value.percentage=Math.round(P+R*.9),await K(U(m)),t.value.completed++}return t.value.label="校对完成！",t.value.percentage=100,a.success(`AI校对完成，共 ${D} 轮`),!0}catch(O){const re=O instanceof Error?O.message:"AI 校对失败";return a.error(`校对失败: ${re}`),t.value.label="校对已取消",t.value.percentage=0,!1}finally{A.value=!1,n.setBatchTranslationInProgress(!1),setTimeout(()=>{t.value.isInProgress=!1},1e3)}}async function Se(){if(!n.currentImage)return a.error("请先上传图片"),!1;const b=u.bubbles;return!b||b.length===0?(a.error("当前图片没有气泡框，请先检测或手动添加"),!1):j({useExistingBubbles:!0,existingBubbleStates:b})}return{progress:t,isTranslatingSingle:s,isHqTranslating:k,isProofreading:A,isTranslating:$,progressPercent:N,translateCurrentImage:j,translateImageByIndex:H,translateAllImages:d,pauseBatchTranslation:l,resumeBatchTranslation:_,cancelBatchTranslation:x,removeTextOnly:z,removeAllTexts:ee,retryFailedImages:be,executeHqTranslation:f,executeProofreading:Y,translateWithCurrentBubbles:Se}}function nl(){const n=gt(),r=st(),u=y(!1);function o(){if(!u.value)return;const a=r.currentImage;n.bubbleCount>0?r.updateCurrentBubbleStates([...n.bubbles]):a&&Array.isArray(a.bubbleStates)&&a.bubbleStates.length>0&&(r.updateCurrentBubbleStates([]),console.log("退出编辑模式（无重渲染），用户已删除所有气泡")),u.value=!1,n.clearSelection(),console.log("已退出编辑模式（无重渲染）")}return{isActive:u,exitEditModeWithoutRender:o}}function ol(){const n=Jn(),r=Qe(),u=st(),o=Zn(),a=gt(),i=nl(),t=y(!1),s=y(!1),k=y(null),A=y([]),$=y([]),N=y([]),ae=y(null),le=y(null),Z=y(null),w=y(null),Q=y(!1);async function j(B=!1){if(!B&&(t.value||s.value)){console.log("[TranslateInit] 已经初始化，仅重新加载上下文"),await x();return}console.log("[TranslateInit] 开始初始化应用..."),t.value=!0,k.value=null;try{await H(),await d(),await l(),await _(),await x(),console.log("[TranslateInit] 应用初始化完成"),s.value=!0}catch(S){console.error("[TranslateInit] 应用初始化失败:",S),k.value=S instanceof Error?S.message:"初始化失败"}finally{t.value=!1}}async function H(){console.log("[TranslateInit] 初始化设置..."),r.initSettings();try{const B=await r.loadFromBackend();console.log(B?"[TranslateInit] 已从后端加载设置":"[TranslateInit] 后端无设置，使用 localStorage 数据")}catch(B){console.warn("[TranslateInit] 从后端加载设置失败，使用 localStorage 数据:",B)}console.log("[TranslateInit] 设置初始化完成")}async function d(){console.log("[TranslateInit] 初始化字体列表...");try{const B=await Xn();B.fonts&&B.fonts.length>0?(A.value=B.fonts,console.log(`[TranslateInit] 已加载 ${B.fonts.length} 个字体`)):B.error?console.warn("[TranslateInit] 获取字体列表失败:",B.error):console.warn("[TranslateInit] 字体列表为空")}catch(B){console.error("[TranslateInit] 获取字体列表失败:",B)}}async function l(){console.log("[TranslateInit] 初始化翻译提示词设置...");try{const B=await Jo();B.prompt_names!==void 0?($.value=B.prompt_names||[],!r.settings.translatePrompt&&B.default_prompt_content&&r.setTranslatePrompt(B.default_prompt_content),console.log(`[TranslateInit] 已加载 ${$.value.length} 个翻译提示词`)):B.error&&console.warn("[TranslateInit] 获取翻译提示词失败:",B.error)}catch(B){console.error("[TranslateInit] 获取翻译提示词失败:",B)}}async function _(){console.log("[TranslateInit] 初始化文本框提示词设置...");try{const B=await Ho();B.prompt_names!==void 0?(N.value=B.prompt_names||[],!r.settings.textboxPrompt&&B.default_prompt_content&&r.setTextboxPrompt(B.default_prompt_content),console.log(`[TranslateInit] 已加载 ${N.value.length} 个文本框提示词`)):B.error&&console.warn("[TranslateInit] 获取文本框提示词失败:",B.error)}catch(B){console.error("[TranslateInit] 获取文本框提示词失败:",B)}}async function x(){const B=n.query.book,S=n.query.chapter;if(!B||!S){console.log("[TranslateInit] 未指定书籍/章节参数，使用独立模式"),Q.value=!1,ae.value=null,le.value=null,Z.value=null,w.value=null,o.clearContext();return}console.log(`[TranslateInit] 检测到书籍/章节参数: book=${B}, chapter=${S}`),Q.value=!0,ae.value=B,le.value=S;try{const v=await Xo(B);if(!v.success||!v.book){console.warn("[TranslateInit] 书籍不存在:",B),we("书籍不存在","warning");return}const I=v.book,T=I.chapters?.find(p=>p.id===S);if(!T){console.warn("[TranslateInit] 章节不存在:",S),we("章节不存在","warning");return}if(Z.value=I.title,w.value=T.title,o.setBookChapterContext(B,S,I.title,T.title),typeof document<"u"&&(document.title=`${T.title} - ${I.title} - Saber-Translator`),T.session_path){console.log(`[TranslateInit] 尝试加载章节会话: ${T.session_path}`);try{await o.loadSessionByPath(T.session_path),we(`已加载章节: ${T.title}`,"success")}catch{console.log("[TranslateInit] 章节会话数据不存在或加载失败，将创建新会话")}}}catch(v){console.error("[TranslateInit] 加载书籍/章节信息失败:",v),we("加载书籍信息失败","error")}}function z(B){if(B<0||B>=u.imageCount){console.warn(`[TranslateInit] 无效的图片索引: ${B}`);return}window._isChangingFromSwitchImage=!0,i.isActive.value&&i.exitEditModeWithoutRender(),u.currentImage&&a.bubbles.length>0&&u.updateCurrentImageProperty("bubbleStates",a.bubbles),u.setCurrentImageIndex(B);const v=u.currentImage;if(!v){console.warn("[TranslateInit] 切换到的图片不存在"),window._isChangingFromSwitchImage=!1;return}console.log(`[TranslateInit] 切换到图片: ${B}, ${v.fileName}`),v.bubbleStates&&v.bubbleStates.length>0?a.setBubbles(v.bubbleStates,!0):a.clearBubblesLocal(),ee(v),setTimeout(()=>{window._isChangingFromSwitchImage=!1,console.log("[TranslateInit] 已重置切换图片操作标记")},100)}function ee(B){if(!B)return;const S=B.bubbleStates?.[0];S&&r.updateTextStyle({fontSize:S.fontSize||r.settings.textStyle.fontSize,fontFamily:S.fontFamily||r.settings.textStyle.fontFamily,layoutDirection:B.userLayoutDirection||S.textDirection||r.settings.textStyle.layoutDirection,textColor:S.textColor||r.settings.textStyle.textColor,fillColor:S.fillColor||r.settings.textStyle.fillColor,strokeEnabled:S.strokeEnabled??r.settings.textStyle.strokeEnabled,strokeColor:S.strokeColor||r.settings.textStyle.strokeColor,strokeWidth:S.strokeWidth||r.settings.textStyle.strokeWidth,inpaintMethod:S.inpaintMethod||r.settings.textStyle.inpaintMethod,autoFontSize:B.autoFontSize??r.settings.textStyle.autoFontSize})}function be(){u.canGoPrevious&&z(u.currentImageIndex-1)}function G(){u.canGoNext&&z(u.currentImageIndex+1)}function F(){ut(async()=>{await j()})}return{isInitializing:t,isInitialized:s,initError:k,fontList:A,promptNames:$,textboxPromptNames:N,currentBookId:ae,currentChapterId:le,currentBookTitle:Z,currentChapterTitle:w,isBookshelfMode:Q,initializeApp:j,initializeSettings:H,initializeFontList:d,initializePromptSettings:l,initializeTextboxPromptSettings:_,initializeBookChapterContext:x,switchImage:z,goToPrevious:be,goToNext:G,loadImageSettingsToStore:ee,editMode:i,setupAutoInit:F}}const al={key:0,id:"translationProgressBar",class:"translation-progress-bar"},sl={class:"progress-bar-label"},ll={key:0,class:"failed-count"},il={key:0,class:"progress-controls"},rl=["title"],ul={class:"pause-icon"},cl=Ge({__name:"TranslationProgress",props:{progress:{},showControls:{type:Boolean,default:!0}},emits:["pause","resume"],setup(n,{emit:r}){const u=n,o=r,a=st(),i=gn(),t=oe(()=>u.progress||i.progress.value),s=oe(()=>t.value.isInProgress||a.isBatchTranslationInProgress),k=oe(()=>t.value.current),A=oe(()=>t.value.total),$=oe(()=>t.value.failed),N=oe(()=>t.value.percentage!==void 0?t.value.percentage:A.value===0?0:Math.round(k.value/A.value*100)),ae=oe(()=>t.value.isPaused||a.isBatchTranslationPaused),le=oe(()=>t.value.label?t.value.label:`${ae.value?"已暂停":"翻译中"}：${k.value} / ${A.value}`);function Z(){ae.value?(i.resumeBatchTranslation(),o("resume")):(i.pauseBatchTranslation(),o("pause"))}return(w,Q)=>s.value?(V(),J("div",al,[e("div",sl,[Ke(xe(le.value)+" ",1),$.value>0?(V(),J("span",ll,"（"+xe($.value)+" 张失败）",1)):Te("",!0)]),e("div",{class:Le(["progress-bar",{paused:ae.value}])},[e("div",{class:"progress",style:it({width:`${N.value}%`})},null,4)],2),u.showControls?(V(),J("div",il,[e("button",{class:Le(["pause-btn",{paused:ae.value}]),onClick:Z,title:ae.value?"继续翻译":"暂停翻译"},[e("span",ul,xe(ae.value?"▶":"⏸"),1),Ke(" "+xe(ae.value?"继续":"暂停"),1)],10,rl)])):Te("",!0)])):Te("",!0)}}),dl=je(cl,[["__scopeId","data-v-d438b9d6"]]),gl=Ge({__name:"SponsorModal",emits:["close"],setup(n,{emit:r}){const u=r;return(o,a)=>(V(),rt(jn,{title:"支持作者",onClose:a[1]||(a[1]=i=>u("close"))},{footer:_t(()=>[e("button",{type:"button",class:"btn btn-primary",onClick:a[0]||(a[0]=i=>u("close"))},"关闭")]),default:_t(()=>[a[2]||(a[2]=e("div",{class:"sponsor-content"},[e("p",{class:"sponsor-message"}," 如果这个项目对你有帮助，欢迎请作者喝杯咖啡 ☕ "),e("div",{class:"qr-codes"},[e("div",{class:"qr-item"},[e("div",{class:"qr-image"},[e("img",{src:"/pic/wechat_qrcode.png",alt:"微信支付"})]),e("span",{class:"qr-label"},"微信支付")]),e("div",{class:"qr-item"},[e("div",{class:"qr-image"},[e("img",{src:"/pic/alipay_qrcode.png",alt:"支付宝"})]),e("span",{class:"qr-label"},"支付宝")])]),e("p",{class:"sponsor-thanks"},"感谢您的支持！🙏")],-1))]),_:1}))}}),pl=je(gl,[["__scopeId","data-v-02b6948e"]]),bl={id:"thumbnail-sidebar",class:"thumbnail-sidebar"},vl={class:"card thumbnail-card"},ml=["title","data-index","onClick"],fl=["src","alt"],hl={key:1,class:"translation-failed-indicator"},yl={key:2,class:"labeled-indicator"},xl={key:3,class:"thumbnail-processing-indicator"},Sl={key:1,class:"empty-state"},kl=Ge({__name:"ThumbnailSidebar",emits:["select"],setup(n,{emit:r}){const u=r,o=st(),a=y(null),i=y([]),t=oe(()=>o.images),s=oe(()=>o.currentImageIndex),k=oe(()=>o.hasImages);function A(w){u("select",w)}function $(){ct(()=>{const w=i.value[s.value];if(w&&a.value){const Q=a.value,j=w.offsetTop-Q.clientHeight/2+w.clientHeight/2;Q.scrollTo({top:Math.max(0,j),behavior:"smooth"})}})}function N(w,Q){i.value[Q]=w}function ae(w){return w.translationFailed?"failed":w.isManuallyAnnotated?"labeled":w.translationStatus==="processing"?"processing":null}function le(w){const Q=[];return w.translationFailed&&Q.push("translation-failed"),w.isManuallyAnnotated&&Q.push("has-manual-labels"),Q}function Z(w){return w.translationFailed?"翻译失败，点击可重试":w.isManuallyAnnotated?"包含手动标注":w.fileName||""}return Re(s,()=>{$()}),ut(()=>{k.value&&$()}),(w,Q)=>(V(),J("aside",bl,[e("div",vl,[Q[1]||(Q[1]=e("h2",null,"图片概览",-1)),k.value?(V(),J("ul",{key:0,ref_key:"containerRef",ref:a,id:"thumbnailList",class:"thumbnail-list"},[(V(!0),J(Ze,null,et(t.value,(j,H)=>(V(),J("li",{key:j.id,ref_for:!0,ref:d=>N(d,H),class:Le(["thumbnail-item",[{active:H===s.value},...le(j)]]),title:Z(j),"data-index":H,onClick:d=>A(H)},[j.originalDataURL?(V(),J("img",{key:0,src:j.originalDataURL,alt:j.fileName,class:"thumbnail-image"},null,8,fl)):Te("",!0),ae(j)==="failed"?(V(),J("span",hl,"!")):ae(j)==="labeled"?(V(),J("span",yl,"✏️")):Te("",!0),ae(j)==="processing"?(V(),J("div",xl,"⟳")):Te("",!0)],10,ml))),128))],512)):(V(),J("div",Sl,[...Q[0]||(Q[0]=[e("p",null,"暂无图片",-1)])]))])]))}}),_l=je(kl,[["__scopeId","data-v-899e5674"]]),Cl={class:"saved-prompts-picker"},wl={class:"prompts-chips-container"},$l={key:0,class:"empty-hint"},Tl={key:1,class:"empty-hint"},Il=["title","onClick"],Dl=Ge({__name:"SavedPromptsPicker",props:{promptType:{}},emits:["select"],setup(n,{expose:r,emit:u}){const o=n,a=u,i=y([]),t=y(!1);async function s(){t.value=!0;try{let A;o.promptType==="textbox"?A=await He.getTextboxPrompts():A=await He.getPrompts(o.promptType);const $=A.prompt_names||[];i.value=$.map(N=>({name:N}))}catch(A){console.error("加载提示词列表失败:",A),i.value=[]}finally{t.value=!1}}async function k(A){try{let $;o.promptType==="textbox"?$=await He.getTextboxPromptContent(A):$=await He.getPromptContent(o.promptType,A),$.prompt_content&&a("select",$.prompt_content,A)}catch($){console.error("加载提示词内容失败:",$)}}return Re(()=>o.promptType,()=>{s()}),ut(()=>{s()}),r({refresh:s}),(A,$)=>(V(),J("div",Cl,[$[1]||($[1]=e("span",{class:"picker-label"},"📑 快速选择:",-1)),e("div",wl,[t.value?(V(),J("span",$l,"加载中...")):i.value.length===0?(V(),J("span",Tl,"暂无保存的提示词")):(V(!0),J(Ze,{key:2},et(i.value,N=>(V(),J("button",{key:N.name,type:"button",class:"prompt-chip",title:N.name,onClick:ae=>k(N.name)},[$[0]||($[0]=e("span",{class:"chip-icon"},"📝",-1)),Ke(" "+xe(N.name),1)],8,Il))),128))])]))}}),Tt=je(Dl,[["__scopeId","data-v-2ebbb8b3"]]),Rl={class:"ocr-settings"},Ml={class:"settings-group"},Bl={class:"settings-item"},El={class:"settings-item"},Pl={class:"input-hint"},Al={class:"settings-group"},Fl={class:"settings-row"},Ll={class:"settings-item"},Ul={class:"password-input-wrapper"},Ol=["type"],zl={key:0,class:"eye-icon"},Vl={key:1,class:"eye-off-icon"},Nl={class:"settings-item"},Wl={class:"password-input-wrapper"},Kl=["type"],ql={key:0,class:"eye-icon"},Hl={key:1,class:"eye-off-icon"},Jl={class:"settings-row"},Yl={class:"settings-item"},Xl={class:"settings-item"},jl=["disabled"],Gl={class:"settings-group"},Zl={class:"settings-row"},Ql={class:"settings-item"},ei={class:"settings-item"},ti={class:"password-input-wrapper"},ni=["type"],oi={key:0,class:"eye-icon"},ai={key:1,class:"eye-off-icon"},si={class:"settings-item"},li={class:"settings-item"},ii={class:"model-input-with-fetch"},ri=["disabled"],ui={class:"fetch-text"},ci={key:0,class:"model-select-container"},di={class:"model-count"},gi={class:"settings-item"},pi={class:"prompt-format-selector"},bi={class:"settings-item"},vi=["disabled"],mi=Ge({__name:"OcrSettings",setup(n){const r=[{label:"MangaOCR (日语专用)",value:"manga_ocr"},{label:"PaddleOCR (多语言)",value:"paddle_ocr"},{label:"百度OCR",value:"baidu_ocr"},{label:"AI视觉OCR",value:"ai_vision"}],u=[{label:"标准版",value:"standard"},{label:"高精度版",value:"high_precision"}],o=[{label:"自动检测",value:"auto_detect"},{label:"中英文混合",value:"CHN_ENG"},{label:"英文",value:"ENG"},{label:"日语",value:"JAP"},{label:"韩语",value:"KOR"},{label:"法语",value:"FRE"},{label:"德语",value:"GER"},{label:"俄语",value:"RUS"}],a=[{label:"SiliconFlow (硅基流动)",value:"siliconflow"},{label:"火山引擎",value:"volcano"},{label:"Google Gemini",value:"gemini"},{label:"自定义 OpenAI 兼容服务",value:"custom_openai_vision"}],i=[{label:"普通提示词",value:"false"},{label:"JSON提示词",value:"true"}],t=[{label:"🚀 常用语言",options:[{label:"日语",value:"japanese"},{label:"英语",value:"en"},{label:"简体中文",value:"chinese"},{label:"繁体中文",value:"chinese_cht"},{label:"韩语",value:"korean"}]},{label:"🌍 拉丁语系",options:[{label:"法语",value:"french"},{label:"德语",value:"german"},{label:"西班牙语",value:"spanish"},{label:"意大利语",value:"italian"},{label:"葡萄牙语",value:"portuguese"}]},{label:"🌏 其他语系",options:[{label:"俄语",value:"russian"}]}],s=Qe(),k=dt(),A=y({apiKey:s.settings.baiduOcr.apiKey,secretKey:s.settings.baiduOcr.secretKey,version:s.settings.baiduOcr.version,sourceLanguage:s.settings.baiduOcr.sourceLanguage}),$=y({apiKey:s.settings.aiVisionOcr.apiKey,modelName:s.settings.aiVisionOcr.modelName,customBaseUrl:s.settings.aiVisionOcr.customBaseUrl,prompt:s.settings.aiVisionOcr.prompt,rpmLimit:s.settings.aiVisionOcr.rpmLimit}),N=oe(()=>s.settings);Re(()=>A.value.apiKey,S=>{s.updateBaiduOcr({apiKey:S})}),Re(()=>A.value.secretKey,S=>{s.updateBaiduOcr({secretKey:S})}),Re(()=>A.value.version,S=>{s.updateBaiduOcr({version:S})}),Re(()=>A.value.sourceLanguage,S=>{s.updateBaiduOcr({sourceLanguage:S})}),Re(()=>$.value.apiKey,S=>{s.updateAiVisionOcr({apiKey:S})}),Re(()=>$.value.modelName,S=>{s.updateAiVisionOcr({modelName:S})}),Re(()=>$.value.customBaseUrl,S=>{s.updateAiVisionOcr({customBaseUrl:S})}),Re(()=>$.value.prompt,S=>{s.updateAiVisionOcr({prompt:S})}),Re(()=>$.value.rpmLimit,S=>{s.updateAiVisionOcr({rpmLimit:S})});const ae=y(!1),le=y(!1),Z=y(!1),w=y(!1),Q=y(!1),j=y([]),H=oe(()=>{const S=[{label:"-- 选择模型 --",value:""}];return j.value.forEach(v=>{S.push({label:v,value:v})}),S});function d(){s.saveToStorage()}function l(){s.saveToStorage()}function _(){switch(s.settings.ocrEngine){case"manga_ocr":return"MangaOCR 专为日语漫画优化，源语言设置不影响识别";case"paddle_ocr":return"PaddleOCR 会根据源语言加载对应的识别模型";case"baidu_ocr":return"百度OCR 使用独立的源语言设置（见下方）";case"ai_vision":return"AI视觉OCR 通过提示词指定识别语言";default:return"选择要识别的原文语言"}}function x(S){s.setAiVisionOcrProvider(S),j.value=[],z()}function z(){$.value.apiKey=s.settings.aiVisionOcr.apiKey,$.value.modelName=s.settings.aiVisionOcr.modelName,$.value.customBaseUrl=s.settings.aiVisionOcr.customBaseUrl,$.value.prompt=s.settings.aiVisionOcr.prompt,$.value.rpmLimit=s.settings.aiVisionOcr.rpmLimit}function ee(){const S=s.settings.aiVisionOcr.isJsonMode?To:Io;s.updateAiVisionOcr({prompt:S}),$.value.prompt=S}async function be(){const S=A.value.apiKey?.trim(),v=A.value.secretKey?.trim();if(!S||!v){k.warning("请填写百度OCR的API Key和Secret Key");return}w.value=!0,k.info("正在测试百度OCR连接...");try{const I=await He.testBaiduOcrConnection(S,v);I.success?k.success(I.message||"百度OCR连接成功!"):k.error(I.message||I.error||"百度OCR连接失败")}catch(I){const T=I instanceof Error?I.message:"连接测试失败";k.error(T)}finally{w.value=!1}}async function G(){w.value=!0;try{const S=await He.testAiVisionOcrConnection({provider:s.settings.aiVisionOcr.provider,apiKey:$.value.apiKey,modelName:$.value.modelName,customBaseUrl:$.value.customBaseUrl,prompt:$.value.prompt});S.success?k.success("AI视觉OCR连接成功"):k.error(`AI视觉OCR连接失败: ${S.error||"未知错误"}`)}catch(S){const v=S instanceof Error?S.message:"连接测试失败";k.error(v)}finally{w.value=!1}}async function F(){const S=s.settings.aiVisionOcr.provider,v=$.value.apiKey?.trim(),I=$.value.customBaseUrl?.trim();if(!v){k.warning("请先填写 API Key");return}if(!["siliconflow","volcano","gemini","custom_openai_vision"].includes(S)){k.warning("当前服务商不支持自动获取模型列表");return}if(S==="custom_openai_vision"&&!I){k.warning("自定义服务需要先填写 Base URL");return}Q.value=!0;try{const p=await He.fetchModels(S,v,I);p.success&&p.models&&p.models.length>0?(j.value=p.models.map(f=>f.id),k.success(`获取到 ${p.models.length} 个模型`)):k.warning(p.message||"未获取到可用模型")}catch(p){const f=p instanceof Error?p.message:"获取模型列表失败";k.error(f)}finally{Q.value=!1}}function B(S,v){s.updateAiVisionOcr({prompt:S}),$.value.prompt=S,k.success(`已应用提示词: ${v}`)}return(S,v)=>(V(),J("div",Rl,[e("div",Ml,[v[19]||(v[19]=e("div",{class:"settings-group-title"},"OCR引擎选择",-1)),e("div",Bl,[v[17]||(v[17]=e("label",{for:"settingsOcrEngine"},"OCR引擎:",-1)),Ie(We,{"model-value":N.value.ocrEngine,options:r,onChange:v[0]||(v[0]=I=>{N.value.ocrEngine=I,d()})},null,8,["model-value"])]),ue(e("div",El,[v[18]||(v[18]=e("label",{for:"settingsSourceLanguage"},"源语言:",-1)),Ie(We,{"model-value":N.value.sourceLanguage,groups:t,onChange:v[1]||(v[1]=I=>{N.value.sourceLanguage=I,l()})},null,8,["model-value"]),e("div",Pl,xe(_()),1)],512),[[qe,N.value.ocrEngine==="paddle_ocr"]])]),ue(e("div",Al,[v[24]||(v[24]=e("div",{class:"settings-group-title"},"百度OCR 设置",-1)),e("div",Fl,[e("div",Ll,[v[20]||(v[20]=e("label",{for:"settingsBaiduApiKey"},"API Key:",-1)),e("div",Ul,[ue(e("input",{type:ae.value?"text":"password",id:"settingsBaiduApiKey","onUpdate:modelValue":v[2]||(v[2]=I=>A.value.apiKey=I),class:"secure-input",placeholder:"请输入百度OCR API Key",autocomplete:"off"},null,8,Ol),[[St,A.value.apiKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:v[3]||(v[3]=I=>ae.value=!ae.value)},[ae.value?(V(),J("span",Vl,"👁‍🗨")):(V(),J("span",zl,"👁"))])])]),e("div",Nl,[v[21]||(v[21]=e("label",{for:"settingsBaiduSecretKey"},"Secret Key:",-1)),e("div",Wl,[ue(e("input",{type:le.value?"text":"password",id:"settingsBaiduSecretKey","onUpdate:modelValue":v[4]||(v[4]=I=>A.value.secretKey=I),class:"secure-input",placeholder:"请输入Secret Key",autocomplete:"off"},null,8,Kl),[[St,A.value.secretKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:v[5]||(v[5]=I=>le.value=!le.value)},[le.value?(V(),J("span",Hl,"👁‍🗨")):(V(),J("span",ql,"👁"))])])])]),e("div",Jl,[e("div",Yl,[v[22]||(v[22]=e("label",{for:"settingsBaiduVersion"},"识别版本:",-1)),Ie(We,{modelValue:A.value.version,"onUpdate:modelValue":v[6]||(v[6]=I=>A.value.version=I),options:u},null,8,["modelValue"])]),e("div",Xl,[v[23]||(v[23]=e("label",{for:"settingsBaiduSourceLanguage"},"源语言:",-1)),Ie(We,{modelValue:A.value.sourceLanguage,"onUpdate:modelValue":v[7]||(v[7]=I=>A.value.sourceLanguage=I),options:o},null,8,["modelValue"])])]),e("button",{class:"settings-test-btn",onClick:be,disabled:w.value},xe(w.value?"测试中...":"🔗 测试连接"),9,jl)],512),[[qe,N.value.ocrEngine==="baidu_ocr"]]),ue(e("div",Gl,[v[34]||(v[34]=e("div",{class:"settings-group-title"},"AI视觉OCR 设置",-1)),e("div",Zl,[e("div",Ql,[v[25]||(v[25]=e("label",{for:"settingsAiVisionProvider"},"服务商:",-1)),Ie(We,{"model-value":N.value.aiVisionOcr.provider,options:a,onChange:v[8]||(v[8]=I=>x(I))},null,8,["model-value"])]),e("div",ei,[v[26]||(v[26]=e("label",{for:"settingsAiVisionApiKey"},"API Key:",-1)),e("div",ti,[ue(e("input",{type:Z.value?"text":"password",id:"settingsAiVisionApiKey","onUpdate:modelValue":v[9]||(v[9]=I=>$.value.apiKey=I),class:"secure-input",placeholder:"请输入API Key",autocomplete:"off"},null,8,ni),[[St,$.value.apiKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:v[10]||(v[10]=I=>Z.value=!Z.value)},[Z.value?(V(),J("span",ai,"👁‍🗨")):(V(),J("span",oi,"👁"))])])])]),ue(e("div",si,[v[27]||(v[27]=e("label",{for:"settingsCustomAiVisionBaseUrl"},"Base URL:",-1)),ue(e("input",{type:"text",id:"settingsCustomAiVisionBaseUrl","onUpdate:modelValue":v[11]||(v[11]=I=>$.value.customBaseUrl=I),placeholder:"例如: https://api.example.com/v1"},null,512),[[Ee,$.value.customBaseUrl]])],512),[[qe,N.value.aiVisionOcr.provider==="custom_openai_vision"]]),e("div",li,[v[29]||(v[29]=e("label",{for:"settingsAiVisionModelName"},"模型名称:",-1)),e("div",ii,[ue(e("input",{type:"text",id:"settingsAiVisionModelName","onUpdate:modelValue":v[12]||(v[12]=I=>$.value.modelName=I),placeholder:"如: silicon-llava2-34b"},null,512),[[Ee,$.value.modelName]]),e("button",{type:"button",class:"fetch-models-btn",title:"获取可用模型列表",onClick:F,disabled:Q.value},[v[28]||(v[28]=e("span",{class:"fetch-icon"},"🔍",-1)),e("span",ui,xe(Q.value?"获取中...":"获取模型"),1)],8,ri)]),j.value.length>0?(V(),J("div",ci,[Ie(We,{modelValue:$.value.modelName,"onUpdate:modelValue":v[13]||(v[13]=I=>$.value.modelName=I),options:H.value},null,8,["modelValue","options"]),e("span",di,"共 "+xe(j.value.length)+" 个模型",1)])):Te("",!0)]),e("div",gi,[v[31]||(v[31]=e("label",{for:"settingsAiVisionOcrPrompt"},"OCR提示词:",-1)),ue(e("textarea",{id:"settingsAiVisionOcrPrompt","onUpdate:modelValue":v[14]||(v[14]=I=>$.value.prompt=I),rows:"3",placeholder:"AI视觉OCR提示词"},null,512),[[Ee,$.value.prompt]]),Ie(Tt,{"prompt-type":"ai_vision_ocr",onSelect:B}),e("div",pi,[Ie(We,{"model-value":N.value.aiVisionOcr.isJsonMode?"true":"false",options:i,onChange:v[15]||(v[15]=I=>{N.value.aiVisionOcr.isJsonMode=I==="true",ee()})},null,8,["model-value"]),v[30]||(v[30]=e("span",{class:"input-hint"},"JSON格式输出更结构化",-1))])]),e("div",bi,[v[32]||(v[32]=e("label",{for:"settingsRpmAiVisionOcr"},"RPM限制 (每分钟请求数):",-1)),ue(e("input",{type:"number",id:"settingsRpmAiVisionOcr","onUpdate:modelValue":v[16]||(v[16]=I=>$.value.rpmLimit=I),min:"0",step:"1"},null,512),[[Ee,$.value.rpmLimit,void 0,{number:!0}]]),v[33]||(v[33]=e("div",{class:"input-hint"},"0 表示无限制",-1))]),e("button",{class:"settings-test-btn",onClick:G,disabled:w.value},xe(w.value?"测试中...":"🔗 测试连接"),9,vi)],512),[[qe,N.value.ocrEngine==="ai_vision"]])]))}}),fi=je(mi,[["__scopeId","data-v-f3101cc5"]]),hi={class:"translation-settings"},yi={class:"settings-group"},xi={class:"settings-row"},Si={class:"settings-item"},ki={class:"settings-item"},_i={for:"settingsApiKey"},Ci={class:"password-input-wrapper"},wi=["type","placeholder"],$i={key:0,class:"eye-icon"},Ti={key:1,class:"eye-off-icon"},Ii={class:"settings-item"},Di={class:"settings-item"},Ri={for:"settingsModelName"},Mi={class:"model-input-with-fetch"},Bi=["placeholder"],Ei=["disabled"],Pi={class:"fetch-text"},Ai={key:0,class:"model-select-container"},Fi={class:"model-count"},Li={class:"settings-item"},Ui={class:"local-model-list"},Oi={key:0,class:"model-list-container"},zi=["disabled"],Vi={key:1,class:"model-hint"},Ni={key:1,class:"model-list-container"},Wi=["disabled"],Ki={key:1,class:"model-hint"},qi={class:"settings-row"},Hi={class:"settings-item"},Ji={class:"settings-item"},Yi={class:"settings-item"},Xi=["disabled"],ji={class:"settings-item"},Gi=["disabled"],Zi={class:"settings-group"},Qi={class:"settings-item"},er={class:"prompt-format-selector"},tr={class:"settings-item"},nr={class:"checkbox-label"},or={class:"settings-item"},ar=Ge({__name:"TranslationSettings",setup(n){const r=[{label:"SiliconFlow",value:"siliconflow"},{label:"DeepSeek",value:"deepseek"},{label:"火山引擎",value:"volcano"},{label:"彩云小译",value:"caiyun"},{label:"百度翻译",value:"baidu_translate"},{label:"有道翻译",value:"youdao_translate"},{label:"Google Gemini",value:"gemini"},{label:"Ollama (本地)",value:"ollama"},{label:"Sakura (本地)",value:"sakura"},{label:"自定义 OpenAI 兼容服务",value:"custom_openai"}],u=[{label:"普通提示词",value:"normal"},{label:"JSON提示词",value:"json"}],o=Qe(),a=dt(),i=y({modelProvider:o.settings.translation.provider,apiKey:o.settings.translation.apiKey,modelName:o.settings.translation.modelName,customBaseUrl:o.settings.translation.customBaseUrl,rpmTranslation:o.settings.translation.rpmLimit,translationMaxRetries:o.settings.translation.maxRetries,promptContent:o.settings.translatePrompt,translatePromptMode:o.settings.translation.isJsonMode?"json":"normal",enableTextboxPrompt:o.settings.useTextboxPrompt,textboxPromptContent:o.settings.textboxPrompt}),t=y(!1),s=y(!1),k=y(!1),A=y([]),$=y([]),N=y([]),ae=oe(()=>{const T=[{label:"-- 选择模型 --",value:""}];return A.value.forEach(p=>T.push({label:p,value:p})),T}),le=oe(()=>{const T=[{label:"-- 选择模型 --",value:""}];return $.value.forEach(p=>T.push({label:p,value:p})),T}),Z=oe(()=>{const T=[{label:"-- 选择模型 --",value:""}];return N.value.forEach(p=>T.push({label:p,value:p})),T}),w=oe(()=>["ollama","sakura"].includes(i.value.modelProvider)),Q=oe(()=>!["ollama","sakura","caiyun","baidu_translate","youdao_translate"].includes(i.value.modelProvider)),j=oe(()=>["siliconflow","deepseek","volcano","gemini","custom_openai"].includes(i.value.modelProvider)),H=oe(()=>{switch(i.value.modelProvider){case"baidu_translate":return"App ID";case"youdao_translate":return"App Key";case"caiyun":return"API Token";default:return"API Key"}}),d=oe(()=>{switch(i.value.modelProvider){case"baidu_translate":return"请输入百度翻译App ID";case"youdao_translate":return"请输入有道翻译应用ID";case"caiyun":return"请输入彩云小译Token";default:return"请输入API Key"}}),l=oe(()=>{switch(i.value.modelProvider){case"baidu_translate":return"App Key";case"youdao_translate":return"App Secret";case"caiyun":return"源语言 (可选)";default:return"模型名称"}}),_=oe(()=>{switch(i.value.modelProvider){case"baidu_translate":return"请输入百度翻译App Key";case"youdao_translate":return"请输入有道翻译应用密钥";case"caiyun":return"可选: auto/日语/英语";default:return"请输入模型名称"}});function x(){const T=i.value.modelProvider;o.setTranslationProvider(T),i.value.apiKey=o.settings.translation.apiKey,i.value.modelName=o.settings.translation.modelName,i.value.customBaseUrl=o.settings.translation.customBaseUrl,i.value.rpmTranslation=o.settings.translation.rpmLimit,i.value.translationMaxRetries=o.settings.translation.maxRetries,A.value=[]}function z(){const T=i.value.translatePromptMode==="json";T?i.value.promptContent=Do:i.value.promptContent=Ro,o.updateTranslationService({isJsonMode:T}),o.setTranslatePrompt(i.value.promptContent)}Re(()=>i.value.apiKey,T=>{o.updateTranslationService({apiKey:T})}),Re(()=>i.value.modelName,T=>{o.updateTranslationService({modelName:T})}),Re(()=>i.value.customBaseUrl,T=>{o.updateTranslationService({customBaseUrl:T})}),Re(()=>i.value.rpmTranslation,T=>{o.updateTranslationService({rpmLimit:T})}),Re(()=>i.value.translationMaxRetries,T=>{o.updateTranslationService({maxRetries:T})}),Re(()=>i.value.promptContent,T=>{o.setTranslatePrompt(T)}),Re(()=>i.value.enableTextboxPrompt,T=>{o.setUseTextboxPrompt(T)}),Re(()=>i.value.textboxPromptContent,T=>{o.setTextboxPrompt(T)});async function ee(){const T=i.value.modelProvider,p=i.value.apiKey?.trim(),f=i.value.customBaseUrl?.trim();if(!p){a.warning("请先填写 API Key");return}if(!["siliconflow","deepseek","volcano","gemini","custom_openai"].includes(T)){a.warning(`${be(T)} 不支持自动获取模型列表`);return}if(T==="custom_openai"&&!f){a.warning("自定义服务需要先填写 Base URL");return}k.value=!0;try{const se=await He.fetchModels(T,p,f);se.success&&se.models&&se.models.length>0?(A.value=se.models.map(m=>m.id),a.success(`获取到 ${se.models.length} 个模型`)):a.warning(se.message||"未获取到可用模型")}catch(se){const m=se instanceof Error?se.message:"获取模型列表失败";a.error(m)}finally{k.value=!1}}function be(T){return{siliconflow:"SiliconFlow",deepseek:"DeepSeek",volcano:"火山引擎",gemini:"Google Gemini",custom_openai:"自定义OpenAI",ollama:"Ollama",sakura:"Sakura",caiyun:"彩云小译",baidu_translate:"百度翻译",youdao_translate:"有道翻译"}[T]||T}async function G(){k.value=!0;try{const T=await He.testOllamaConnection();T.success&&T.models?($.value=T.models,a.success(`获取到 ${T.models.length} 个Ollama模型`)):a.error(T.error||"Ollama连接失败")}catch(T){const p=T instanceof Error?T.message:"获取Ollama模型失败";a.error(p)}finally{k.value=!1}}async function F(){k.value=!0;try{const T=await He.testSakuraConnection();T.success&&T.models?(N.value=T.models,a.success(`获取到 ${T.models.length} 个Sakura模型`)):a.error(T.error||"Sakura连接失败")}catch(T){const p=T instanceof Error?T.message:"获取Sakura模型失败";a.error(p)}finally{k.value=!1}}async function B(){s.value=!0;try{let T;i.value.modelProvider==="ollama"?T=await He.testOllamaConnection():T=await He.testSakuraConnection(),T.success?a.success(`${i.value.modelProvider==="ollama"?"Ollama":"Sakura"} 连接成功`):a.error(T.error||"连接失败")}catch(T){const p=T instanceof Error?T.message:"连接测试失败";a.error(p)}finally{s.value=!1}}async function S(){const T=i.value.modelProvider,p=i.value.apiKey?.trim(),f=i.value.modelName?.trim(),te=i.value.customBaseUrl?.trim();if(!p){a.warning("请先填写 API Key");return}if(T!=="caiyun"&&!f){a.warning("请填写模型名称");return}if(T==="custom_openai"&&!te){a.warning("自定义服务需要填写 Base URL");return}s.value=!0,a.info("正在测试连接...");try{let se;switch(T){case"baidu_translate":se=await He.testBaiduTranslateConnection(p,f);break;case"youdao_translate":se=await He.testYoudaoTranslateConnection(p,f);break;default:se=await He.testAiTranslateConnection({provider:T,apiKey:p,modelName:f,baseUrl:te})}se.success?a.success(se.message||`${be(T)} 连接成功!`):a.error(se.message||se.error||"连接失败")}catch(se){const m=se instanceof Error?se.message:"连接测试失败";a.error(m)}finally{s.value=!1}}function v(T,p){i.value.promptContent=T,a.success(`已应用提示词: ${p}`)}function I(T,p){i.value.textboxPromptContent=T,a.success(`已应用提示词: ${p}`)}return(T,p)=>(V(),J("div",hi,[e("div",yi,[p[21]||(p[21]=e("div",{class:"settings-group-title"},"翻译服务配置",-1)),e("div",xi,[e("div",Si,[p[14]||(p[14]=e("label",{for:"settingsModelProvider"},"翻译服务商:",-1)),Ie(We,{"model-value":i.value.modelProvider,options:r,onChange:p[0]||(p[0]=f=>{i.value.modelProvider=f,x()})},null,8,["model-value"])]),ue(e("div",ki,[e("label",_i,xe(H.value)+":",1),e("div",Ci,[ue(e("input",{type:t.value?"text":"password",id:"settingsApiKey","onUpdate:modelValue":p[1]||(p[1]=f=>i.value.apiKey=f),class:"secure-input",placeholder:d.value,autocomplete:"off"},null,8,wi),[[St,i.value.apiKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:p[2]||(p[2]=f=>t.value=!t.value)},[t.value?(V(),J("span",Ti,"👁‍🗨")):(V(),J("span",$i,"👁"))])])],512),[[qe,!w.value]])]),ue(e("div",Ii,[p[15]||(p[15]=e("label",{for:"settingsCustomBaseUrl"},"Base URL:",-1)),ue(e("input",{type:"text",id:"settingsCustomBaseUrl","onUpdate:modelValue":p[3]||(p[3]=f=>i.value.customBaseUrl=f),placeholder:"例如: https://api.example.com/v1"},null,512),[[Ee,i.value.customBaseUrl]])],512),[[qe,i.value.modelProvider==="custom_openai"]]),ue(e("div",Di,[e("label",Ri,xe(l.value)+":",1),e("div",Mi,[ue(e("input",{type:"text",id:"settingsModelName","onUpdate:modelValue":p[4]||(p[4]=f=>i.value.modelName=f),placeholder:_.value},null,8,Bi),[[Ee,i.value.modelName]]),ue(e("button",{type:"button",class:"fetch-models-btn",title:"获取可用模型列表",onClick:ee,disabled:k.value},[p[16]||(p[16]=e("span",{class:"fetch-icon"},"🔍",-1)),e("span",Pi,xe(k.value?"获取中...":"获取模型"),1)],8,Ei),[[qe,j.value]])]),A.value.length>0?(V(),J("div",Ai,[Ie(We,{"model-value":i.value.modelName,options:ae.value,onChange:p[5]||(p[5]=f=>{i.value.modelName=f})},null,8,["model-value","options"]),e("span",Fi,"共 "+xe(A.value.length)+" 个模型",1)])):Te("",!0)],512),[[qe,!w.value]]),ue(e("div",Li,[p[17]||(p[17]=e("label",null,"本地模型:",-1)),e("div",Ui,[i.value.modelProvider==="ollama"?(V(),J("div",Oi,[e("button",{class:"settings-test-btn",onClick:G,disabled:k.value},xe(k.value?"获取中...":"🔄 刷新模型列表"),9,zi),$.value.length>0?(V(),rt(We,{key:0,"model-value":i.value.modelName,options:le.value,onChange:p[6]||(p[6]=f=>i.value.modelName=f)},null,8,["model-value","options"])):(V(),J("p",Vi,"点击刷新获取可用模型"))])):i.value.modelProvider==="sakura"?(V(),J("div",Ni,[e("button",{class:"settings-test-btn",onClick:F,disabled:k.value},xe(k.value?"获取中...":"🔄 刷新模型列表"),9,Wi),N.value.length>0?(V(),rt(We,{key:0,"model-value":i.value.modelName,options:Z.value,onChange:p[7]||(p[7]=f=>i.value.modelName=f)},null,8,["model-value","options"])):(V(),J("p",Ki,"点击刷新获取可用模型"))])):Te("",!0)])],512),[[qe,w.value]]),ue(e("div",qi,[e("div",Hi,[p[18]||(p[18]=e("label",{for:"settingsRpmTranslation"},"RPM限制:",-1)),ue(e("input",{type:"number",id:"settingsRpmTranslation","onUpdate:modelValue":p[8]||(p[8]=f=>i.value.rpmTranslation=f),min:"0",step:"1"},null,512),[[Ee,i.value.rpmTranslation,void 0,{number:!0}]]),p[19]||(p[19]=e("div",{class:"input-hint"},"每分钟请求数，0表示无限制",-1))]),e("div",Ji,[p[20]||(p[20]=e("label",{for:"settingsTranslationMaxRetries"},"重试次数:",-1)),ue(e("input",{type:"number",id:"settingsTranslationMaxRetries","onUpdate:modelValue":p[9]||(p[9]=f=>i.value.translationMaxRetries=f),min:"0",max:"10",step:"1"},null,512),[[Ee,i.value.translationMaxRetries,void 0,{number:!0}]])])],512),[[qe,Q.value]]),ue(e("div",Yi,[e("button",{class:"settings-test-btn",onClick:B,disabled:s.value},xe(s.value?"测试中...":"🔗 测试连接"),9,Xi)],512),[[qe,w.value]]),ue(e("div",ji,[e("button",{class:"settings-test-btn",onClick:S,disabled:s.value},xe(s.value?"测试中...":"🔗 测试连接"),9,Gi)],512),[[qe,!w.value]])]),e("div",Zi,[p[26]||(p[26]=e("div",{class:"settings-group-title"},"提示词设置",-1)),e("div",Qi,[p[23]||(p[23]=e("label",{for:"settingsPromptContent"},"翻译提示词:",-1)),ue(e("textarea",{id:"settingsPromptContent","onUpdate:modelValue":p[10]||(p[10]=f=>i.value.promptContent=f),rows:"4",placeholder:"翻译提示词"},null,512),[[Ee,i.value.promptContent]]),e("div",er,[Ie(We,{"model-value":i.value.translatePromptMode,options:u,onChange:p[11]||(p[11]=f=>{i.value.translatePromptMode=f,z()})},null,8,["model-value"]),p[22]||(p[22]=e("span",{class:"input-hint"},"JSON格式输出更结构化",-1))]),Ie(Tt,{"prompt-type":"translate",onSelect:v})]),e("div",tr,[e("label",nr,[ue(e("input",{type:"checkbox","onUpdate:modelValue":p[12]||(p[12]=f=>i.value.enableTextboxPrompt=f)},null,512),[[tt,i.value.enableTextboxPrompt]]),p[24]||(p[24]=Ke(" 启用文本框提示词 ",-1))])]),ue(e("div",or,[p[25]||(p[25]=e("label",{for:"settingsTextboxPromptContent"},"文本框提示词:",-1)),ue(e("textarea",{id:"settingsTextboxPromptContent","onUpdate:modelValue":p[13]||(p[13]=f=>i.value.textboxPromptContent=f),rows:"3",placeholder:"文本框提示词"},null,512),[[Ee,i.value.textboxPromptContent]]),Ie(Tt,{"prompt-type":"textbox",onSelect:I})],512),[[qe,i.value.enableTextboxPrompt]])])]))}}),sr=je(ar,[["__scopeId","data-v-165d523b"]]),lr={class:"detection-settings"},ir={class:"settings-group"},rr={class:"settings-item"},ur={class:"settings-group"},cr={class:"settings-item"},dr={class:"settings-row"},gr={class:"settings-item"},pr={class:"settings-item"},br={class:"settings-row"},vr={class:"settings-item"},mr={class:"settings-item"},fr={class:"settings-group"},hr={class:"settings-item"},yr={class:"checkbox-label"},xr={class:"settings-row"},Sr={class:"settings-item"},kr={class:"settings-item"},_r={class:"settings-group"},Cr={class:"settings-item"},wr={class:"checkbox-label"},$r=Ge({__name:"DetectionSettings",setup(n){const r=[{label:"CTD (Comic Text Detector)",value:"ctd"},{label:"YOLO",value:"yolo"},{label:"YOLOv5",value:"yolov5"},{label:"Default (DBNet)",value:"default"}],u=Qe(),o=Eo({textDetector:u.settings.textDetector,boxExpandRatio:u.settings.boxExpand.ratio,boxExpandTop:u.settings.boxExpand.top,boxExpandBottom:u.settings.boxExpand.bottom,boxExpandLeft:u.settings.boxExpand.left,boxExpandRight:u.settings.boxExpand.right,usePreciseMask:u.settings.preciseMask.enabled,maskDilateSize:u.settings.preciseMask.dilateSize,maskBoxExpandRatio:u.settings.preciseMask.boxExpandRatio,showDetectionDebug:u.settings.showDetectionDebug}),a=oe(()=>["ctd","default"].includes(o.textDetector));Re(()=>o.textDetector,t=>{u.setTextDetector(t)}),Re(()=>o.boxExpandRatio,t=>{u.updateBoxExpand({ratio:t})}),Re(()=>o.boxExpandTop,t=>{u.updateBoxExpand({top:t})}),Re(()=>o.boxExpandBottom,t=>{u.updateBoxExpand({bottom:t})}),Re(()=>o.boxExpandLeft,t=>{u.updateBoxExpand({left:t})}),Re(()=>o.boxExpandRight,t=>{u.updateBoxExpand({right:t})}),Re(()=>o.usePreciseMask,t=>{u.updatePreciseMask({enabled:t})}),Re(()=>o.maskDilateSize,t=>{u.updatePreciseMask({dilateSize:t})}),Re(()=>o.maskBoxExpandRatio,t=>{u.updatePreciseMask({boxExpandRatio:t})}),Re(()=>o.showDetectionDebug,t=>{u.setShowDetectionDebug(t)});function i(){a.value||(o.usePreciseMask=!1)}return(t,s)=>(V(),J("div",lr,[e("div",ir,[s[11]||(s[11]=e("div",{class:"settings-group-title"},"文字检测器",-1)),e("div",rr,[s[10]||(s[10]=e("label",{for:"settingsTextDetector"},"检测器类型:",-1)),Ie(We,{modelValue:o.textDetector,"onUpdate:modelValue":s[0]||(s[0]=k=>o.textDetector=k),options:r,onChange:i},null,8,["modelValue"])])]),e("div",ur,[s[18]||(s[18]=e("div",{class:"settings-group-title"},"文本框扩展参数",-1)),e("div",cr,[s[12]||(s[12]=e("label",{for:"settingsBoxExpandRatio"},"整体扩展 (%):",-1)),ue(e("input",{type:"number",id:"settingsBoxExpandRatio","onUpdate:modelValue":s[1]||(s[1]=k=>o.boxExpandRatio=k),min:"0",max:"50",step:"1"},null,512),[[Ee,o.boxExpandRatio,void 0,{number:!0}]]),s[13]||(s[13]=e("div",{class:"input-hint"},"向四周均匀扩展的百分比 (0-50%)",-1))]),e("div",dr,[e("div",gr,[s[14]||(s[14]=e("label",{for:"settingsBoxExpandTop"},"上方扩展 (%):",-1)),ue(e("input",{type:"number",id:"settingsBoxExpandTop","onUpdate:modelValue":s[2]||(s[2]=k=>o.boxExpandTop=k),min:"0",max:"50",step:"1"},null,512),[[Ee,o.boxExpandTop,void 0,{number:!0}]])]),e("div",pr,[s[15]||(s[15]=e("label",{for:"settingsBoxExpandBottom"},"下方扩展 (%):",-1)),ue(e("input",{type:"number",id:"settingsBoxExpandBottom","onUpdate:modelValue":s[3]||(s[3]=k=>o.boxExpandBottom=k),min:"0",max:"50",step:"1"},null,512),[[Ee,o.boxExpandBottom,void 0,{number:!0}]])])]),e("div",br,[e("div",vr,[s[16]||(s[16]=e("label",{for:"settingsBoxExpandLeft"},"左侧扩展 (%):",-1)),ue(e("input",{type:"number",id:"settingsBoxExpandLeft","onUpdate:modelValue":s[4]||(s[4]=k=>o.boxExpandLeft=k),min:"0",max:"50",step:"1"},null,512),[[Ee,o.boxExpandLeft,void 0,{number:!0}]])]),e("div",mr,[s[17]||(s[17]=e("label",{for:"settingsBoxExpandRight"},"右侧扩展 (%):",-1)),ue(e("input",{type:"number",id:"settingsBoxExpandRight","onUpdate:modelValue":s[5]||(s[5]=k=>o.boxExpandRight=k),min:"0",max:"50",step:"1"},null,512),[[Ee,o.boxExpandRight,void 0,{number:!0}]])])])]),ue(e("div",fr,[s[25]||(s[25]=e("div",{class:"settings-group-title"},"精确文字掩膜",-1)),e("div",hr,[e("label",yr,[ue(e("input",{type:"checkbox","onUpdate:modelValue":s[6]||(s[6]=k=>o.usePreciseMask=k)},null,512),[[tt,o.usePreciseMask]]),s[19]||(s[19]=Ke(" 启用精确文字掩膜 ",-1))]),s[20]||(s[20]=e("div",{class:"input-hint"},"使用更精确的文字区域掩膜进行修复",-1))]),ue(e("div",xr,[e("div",Sr,[s[21]||(s[21]=e("label",{for:"settingsMaskDilateSize"},"膨胀大小:",-1)),ue(e("input",{type:"number",id:"settingsMaskDilateSize","onUpdate:modelValue":s[7]||(s[7]=k=>o.maskDilateSize=k),min:"0",step:"1"},null,512),[[Ee,o.maskDilateSize,void 0,{number:!0}]]),s[22]||(s[22]=e("div",{class:"input-hint"},"掩膜膨胀像素数",-1))]),e("div",kr,[s[23]||(s[23]=e("label",{for:"settingsMaskBoxExpandRatio"},"标注框扩大比例 (%):",-1)),ue(e("input",{type:"number",id:"settingsMaskBoxExpandRatio","onUpdate:modelValue":s[8]||(s[8]=k=>o.maskBoxExpandRatio=k),min:"0",max:"100",step:"1"},null,512),[[Ee,o.maskBoxExpandRatio,void 0,{number:!0}]]),s[24]||(s[24]=e("div",{class:"input-hint"},"标注框区域扩大百分比",-1))])],512),[[qe,o.usePreciseMask]])],512),[[qe,a.value]]),e("div",_r,[s[28]||(s[28]=e("div",{class:"settings-group-title"},"调试选项",-1)),e("div",Cr,[e("label",wr,[ue(e("input",{type:"checkbox","onUpdate:modelValue":s[9]||(s[9]=k=>o.showDetectionDebug=k)},null,512),[[tt,o.showDetectionDebug]]),s[26]||(s[26]=Ke(" 显示检测框调试信息 ",-1))]),s[27]||(s[27]=e("div",{class:"input-hint"},"在翻译结果中显示气泡检测框，用于调试",-1))])])]))}}),Tr=je($r,[["__scopeId","data-v-c12c43ee"]]),Ir={class:"hq-translation-settings"},Dr={class:"settings-group"},Rr={class:"settings-row"},Mr={class:"settings-item"},Br={class:"settings-item"},Er={class:"password-input-wrapper"},Pr=["type"],Ar={key:0,class:"eye-icon"},Fr={key:1,class:"eye-off-icon"},Lr={class:"settings-item"},Ur={class:"settings-item"},Or={class:"model-input-with-fetch"},zr=["disabled"],Vr={class:"fetch-text"},Nr={key:0,class:"model-select-container"},Wr={class:"model-count"},Kr={class:"settings-item"},qr=["disabled"],Hr={class:"settings-group"},Jr={class:"settings-row"},Yr={class:"settings-item"},Xr={class:"settings-item"},jr={class:"settings-row"},Gr={class:"settings-item"},Zr={class:"settings-item"},Qr={class:"settings-group"},eu={class:"settings-row"},tu={class:"settings-item"},nu={class:"checkbox-label"},ou={class:"settings-item"},au={class:"settings-row"},su={class:"settings-item"},lu={class:"checkbox-label"},iu={class:"settings-item"},ru={class:"checkbox-label"},uu={class:"settings-group"},cu={class:"settings-item"},du=Ge({__name:"HqTranslationSettings",setup(n){const r=[{label:"SiliconFlow",value:"siliconflow"},{label:"DeepSeek",value:"deepseek"},{label:"火山引擎",value:"volcano"},{label:"Google Gemini",value:"gemini"},{label:"自定义 OpenAI 兼容服务",value:"custom_openai"}],u=[{label:"Gemini风格 (reasoning_effort=low)",value:"gemini"},{label:"火山引擎风格 (thinking=null)",value:"volcano"}],o=Qe(),a=dt(),i=oe(()=>o.settings.hqTranslation),t=y({apiKey:o.settings.hqTranslation.apiKey,modelName:o.settings.hqTranslation.modelName,customBaseUrl:o.settings.hqTranslation.customBaseUrl,batchSize:o.settings.hqTranslation.batchSize,sessionReset:o.settings.hqTranslation.sessionReset,rpmLimit:o.settings.hqTranslation.rpmLimit,maxRetries:o.settings.hqTranslation.maxRetries,lowReasoning:o.settings.hqTranslation.lowReasoning,noThinkingMethod:o.settings.hqTranslation.noThinkingMethod,forceJsonOutput:o.settings.hqTranslation.forceJsonOutput,useStream:o.settings.hqTranslation.useStream,prompt:o.settings.hqTranslation.prompt});Re(()=>t.value.apiKey,d=>{o.updateHqTranslation({apiKey:d})}),Re(()=>t.value.modelName,d=>{o.updateHqTranslation({modelName:d})}),Re(()=>t.value.customBaseUrl,d=>{o.updateHqTranslation({customBaseUrl:d})}),Re(()=>t.value.batchSize,d=>{o.updateHqTranslation({batchSize:d})}),Re(()=>t.value.sessionReset,d=>{o.updateHqTranslation({sessionReset:d})}),Re(()=>t.value.rpmLimit,d=>{o.updateHqTranslation({rpmLimit:d})}),Re(()=>t.value.maxRetries,d=>{o.updateHqTranslation({maxRetries:d})}),Re(()=>t.value.lowReasoning,d=>{o.updateHqTranslation({lowReasoning:d})}),Re(()=>t.value.noThinkingMethod,d=>{o.updateHqTranslation({noThinkingMethod:d})}),Re(()=>t.value.forceJsonOutput,d=>{o.updateHqTranslation({forceJsonOutput:d})}),Re(()=>t.value.useStream,d=>{o.updateHqTranslation({useStream:d})}),Re(()=>t.value.prompt,d=>{o.updateHqTranslation({prompt:d})});const s=y(!1),k=y(!1),A=y([]),$=y(!1),N=oe(()=>{const d=[{label:"-- 选择模型 --",value:""}];return A.value.forEach(l=>d.push({label:l,value:l})),d});function ae(d){o.setHqProvider(d),A.value=[],le()}function le(){const d=o.settings.hqTranslation;t.value.apiKey=d.apiKey,t.value.modelName=d.modelName,t.value.customBaseUrl=d.customBaseUrl,t.value.batchSize=d.batchSize,t.value.sessionReset=d.sessionReset,t.value.rpmLimit=d.rpmLimit,t.value.maxRetries=d.maxRetries,t.value.lowReasoning=d.lowReasoning,t.value.noThinkingMethod=d.noThinkingMethod,t.value.forceJsonOutput=d.forceJsonOutput,t.value.useStream=d.useStream,t.value.prompt=d.prompt}function Z(d){return{siliconflow:"SiliconFlow",deepseek:"DeepSeek",volcano:"火山引擎",gemini:"Google Gemini",custom_openai:"自定义OpenAI"}[d]||d}async function w(){const d=i.value.provider,l=t.value.apiKey?.trim(),_=t.value.customBaseUrl?.trim();if(!l){a.warning("请先填写 API Key");return}if(!["siliconflow","deepseek","volcano","gemini","custom_openai"].includes(d)){a.warning(`${Z(d)} 不支持自动获取模型列表`);return}if(d==="custom_openai"&&!_){a.warning("自定义服务需要先填写 Base URL");return}k.value=!0;try{const z=await He.fetchModels(d,l,_);z.success&&z.models&&z.models.length>0?(A.value=z.models.map(ee=>ee.id),a.success(`获取到 ${z.models.length} 个模型`)):a.warning(z.message||"未获取到可用模型")}catch(z){const ee=z instanceof Error?z.message:"获取模型列表失败";a.error(ee)}finally{k.value=!1}}async function Q(){const d=i.value.provider,l=t.value.apiKey?.trim(),_=t.value.modelName?.trim(),x=t.value.customBaseUrl?.trim();if(!l){a.warning("请先填写 API Key");return}if(!_){a.warning("请填写模型名称");return}if(d==="custom_openai"&&!x){a.warning("自定义服务需要填写 Base URL");return}$.value=!0,a.info("正在测试连接...");try{const z=await He.testAiTranslateConnection({provider:d,apiKey:l,modelName:_,baseUrl:x});z.success?a.success(z.message||`${Z(d)} 连接成功!`):a.error(z.message||z.error||"连接失败")}catch(z){const ee=z instanceof Error?z.message:"连接测试失败";a.error(ee)}finally{$.value=!1}}function j(){o.updateHqTranslation({prompt:Mn}),t.value.prompt=Mn,a.success("已重置为默认提示词")}function H(d,l){o.updateHqTranslation({prompt:d}),t.value.prompt=d,a.success(`已应用提示词: ${l}`)}return(d,l)=>(V(),J("div",Ir,[e("div",Dr,[l[20]||(l[20]=e("div",{class:"settings-group-title"},"高质量翻译服务配置",-1)),e("div",Rr,[e("div",Mr,[l[15]||(l[15]=e("label",{for:"settingsHqTranslateProvider"},"服务商:",-1)),Ie(We,{"model-value":i.value.provider,options:r,onChange:l[0]||(l[0]=_=>ae(_))},null,8,["model-value"])]),e("div",Br,[l[16]||(l[16]=e("label",{for:"settingsHqApiKey"},"API Key:",-1)),e("div",Er,[ue(e("input",{type:s.value?"text":"password",id:"settingsHqApiKey","onUpdate:modelValue":l[1]||(l[1]=_=>t.value.apiKey=_),class:"secure-input",placeholder:"请输入API Key",autocomplete:"off"},null,8,Pr),[[St,t.value.apiKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:l[2]||(l[2]=_=>s.value=!s.value)},[s.value?(V(),J("span",Fr,"👁‍🗨")):(V(),J("span",Ar,"👁"))])])])]),ue(e("div",Lr,[l[17]||(l[17]=e("label",{for:"settingsHqCustomBaseUrl"},"Base URL:",-1)),ue(e("input",{type:"text",id:"settingsHqCustomBaseUrl","onUpdate:modelValue":l[3]||(l[3]=_=>t.value.customBaseUrl=_),placeholder:"例如: https://api.example.com/v1"},null,512),[[Ee,t.value.customBaseUrl]])],512),[[qe,i.value.provider==="custom_openai"]]),e("div",Ur,[l[19]||(l[19]=e("label",{for:"settingsHqModelName"},"模型名称:",-1)),e("div",Or,[ue(e("input",{type:"text",id:"settingsHqModelName","onUpdate:modelValue":l[4]||(l[4]=_=>t.value.modelName=_),placeholder:"请输入模型名称"},null,512),[[Ee,t.value.modelName]]),e("button",{type:"button",class:"fetch-models-btn",title:"获取可用模型列表",onClick:w,disabled:k.value},[l[18]||(l[18]=e("span",{class:"fetch-icon"},"🔍",-1)),e("span",Vr,xe(k.value?"获取中...":"获取模型"),1)],8,zr)]),A.value.length>0?(V(),J("div",Nr,[Ie(We,{modelValue:t.value.modelName,"onUpdate:modelValue":l[5]||(l[5]=_=>t.value.modelName=_),options:N.value},null,8,["modelValue","options"]),e("span",Wr,"共 "+xe(A.value.length)+" 个模型",1)])):Te("",!0)]),e("div",Kr,[e("button",{class:"settings-test-btn",onClick:Q,disabled:$.value},xe($.value?"测试中...":"🔗 测试连接"),9,qr)])]),e("div",Hr,[l[28]||(l[28]=e("div",{class:"settings-group-title"},"批处理设置",-1)),e("div",Jr,[e("div",Yr,[l[21]||(l[21]=e("label",{for:"settingsHqBatchSize"},"批次大小:",-1)),ue(e("input",{type:"number",id:"settingsHqBatchSize","onUpdate:modelValue":l[6]||(l[6]=_=>t.value.batchSize=_),min:"1",max:"10",step:"1"},null,512),[[Ee,t.value.batchSize,void 0,{number:!0}]]),l[22]||(l[22]=e("div",{class:"input-hint"},"每批处理的图片数量 (推荐3-5张)",-1))]),e("div",Xr,[l[23]||(l[23]=e("label",{for:"settingsHqSessionReset"},"会话重置频率:",-1)),ue(e("input",{type:"number",id:"settingsHqSessionReset","onUpdate:modelValue":l[7]||(l[7]=_=>t.value.sessionReset=_),min:"1",step:"1"},null,512),[[Ee,t.value.sessionReset,void 0,{number:!0}]]),l[24]||(l[24]=e("div",{class:"input-hint"},"多少批次后重置上下文",-1))])]),e("div",jr,[e("div",Gr,[l[25]||(l[25]=e("label",{for:"settingsHqRpmLimit"},"RPM限制:",-1)),ue(e("input",{type:"number",id:"settingsHqRpmLimit","onUpdate:modelValue":l[8]||(l[8]=_=>t.value.rpmLimit=_),min:"0",step:"1"},null,512),[[Ee,t.value.rpmLimit,void 0,{number:!0}]]),l[26]||(l[26]=e("div",{class:"input-hint"},"每分钟请求数，0表示无限制",-1))]),e("div",Zr,[l[27]||(l[27]=e("label",{for:"settingsHqMaxRetries"},"重试次数:",-1)),ue(e("input",{type:"number",id:"settingsHqMaxRetries","onUpdate:modelValue":l[9]||(l[9]=_=>t.value.maxRetries=_),min:"0",max:"10",step:"1"},null,512),[[Ee,t.value.maxRetries,void 0,{number:!0}]])])])]),e("div",Qr,[l[36]||(l[36]=e("div",{class:"settings-group-title"},"高级选项",-1)),e("div",eu,[e("div",tu,[e("label",nu,[ue(e("input",{type:"checkbox","onUpdate:modelValue":l[10]||(l[10]=_=>t.value.lowReasoning=_)},null,512),[[tt,t.value.lowReasoning]]),l[29]||(l[29]=Ke(" 低推理模式 ",-1))]),l[30]||(l[30]=e("div",{class:"input-hint"},"减少模型推理深度，提高速度",-1))]),e("div",ou,[l[31]||(l[31]=e("label",{for:"settingsHqNoThinkingMethod"},"取消思考方法:",-1)),Ie(We,{modelValue:t.value.noThinkingMethod,"onUpdate:modelValue":l[11]||(l[11]=_=>t.value.noThinkingMethod=_),options:u},null,8,["modelValue"])])]),e("div",au,[e("div",su,[e("label",lu,[ue(e("input",{type:"checkbox","onUpdate:modelValue":l[12]||(l[12]=_=>t.value.forceJsonOutput=_)},null,512),[[tt,t.value.forceJsonOutput]]),l[32]||(l[32]=Ke(" 强制JSON输出 ",-1))]),l[33]||(l[33]=e("div",{class:"input-hint"},"使用 response_format: json_object",-1))]),e("div",iu,[e("label",ru,[ue(e("input",{type:"checkbox","onUpdate:modelValue":l[13]||(l[13]=_=>t.value.useStream=_)},null,512),[[tt,t.value.useStream]]),l[34]||(l[34]=Ke(" 流式调用 ",-1))]),l[35]||(l[35]=e("div",{class:"input-hint"},"使用流式API调用",-1))])])]),e("div",uu,[l[37]||(l[37]=e("div",{class:"settings-group-title"},"高质量翻译提示词",-1)),e("div",cu,[ue(e("textarea",{id:"settingsHqPrompt","onUpdate:modelValue":l[14]||(l[14]=_=>t.value.prompt=_),rows:"6",placeholder:"高质量翻译提示词"},null,512),[[Ee,t.value.prompt]]),Ie(Tt,{"prompt-type":"hq_translate",onSelect:H}),e("button",{class:"btn btn-secondary btn-sm",onClick:j},"重置为默认")])])]))}}),gu=je(du,[["__scopeId","data-v-23f4a3f7"]]),pu={class:"proofreading-settings"},bu={class:"settings-group"},vu={class:"settings-item"},mu={class:"checkbox-label"},fu={class:"settings-item"},hu={class:"settings-group"},yu={class:"round-header"},xu={class:"round-title"},Su=["onClick","disabled"],ku={class:"round-content"},_u={class:"settings-item"},Cu=["onUpdate:modelValue"],wu={class:"settings-row"},$u={class:"settings-item"},Tu={class:"settings-item"},Iu={class:"password-input-wrapper"},Du=["type","onUpdate:modelValue"],Ru=["onClick"],Mu={key:0,class:"eye-icon"},Bu={key:1,class:"eye-off-icon"},Eu={class:"settings-item"},Pu=["onUpdate:modelValue"],Au={class:"settings-item"},Fu={class:"model-input-with-fetch"},Lu=["onUpdate:modelValue"],Uu=["onClick","disabled"],Ou={class:"fetch-text"},zu={key:0,class:"model-select-container"},Vu={class:"model-count"},Nu={class:"settings-item"},Wu=["onClick","disabled"],Ku={class:"settings-row"},qu={class:"settings-item"},Hu=["onUpdate:modelValue"],Ju={class:"settings-item"},Yu=["onUpdate:modelValue"],Xu={class:"settings-item"},ju=["onUpdate:modelValue"],Gu={class:"settings-row"},Zu={class:"settings-item"},Qu={class:"checkbox-label"},ec=["onUpdate:modelValue"],tc={class:"settings-item"},nc={class:"settings-item"},oc={class:"checkbox-label"},ac=["onUpdate:modelValue"],sc={class:"settings-item"},lc=["onUpdate:modelValue"],ic=["onClick"],rc=Ge({__name:"ProofreadingSettings",setup(n){const r=[{label:"SiliconFlow",value:"siliconflow"},{label:"DeepSeek",value:"deepseek"},{label:"火山引擎",value:"volcano"},{label:"Google Gemini",value:"gemini"},{label:"自定义 OpenAI 兼容服务",value:"custom_openai"}],u=[{label:"Gemini风格",value:"gemini"},{label:"火山引擎风格",value:"volcano"}],o=Qe(),a=dt(),i=y({}),t=y({}),s=y({}),k=oe(()=>o.settings.proofreading.rounds),A=oe({get:()=>o.settings.proofreading.maxRetries,set:H=>o.setProofreadingMaxRetries(H)}),$=oe({get:()=>o.settings.proofreading.enabled,set:H=>o.setProofreadingEnabled(H)});Re(()=>o.settings.proofreading.rounds,()=>{o.saveToStorage()},{deep:!0});function N(H){const d=s.value[H]||[],l=[{label:"-- 选择模型 --",value:""}];return d.forEach(_=>l.push({label:_,value:_})),l}async function ae(H){const d=k.value[H];if(!d)return;const l=d.provider,_=d.apiKey?.trim(),x=d.customBaseUrl?.trim();if(!_){a.warning("请先填写 API Key");return}if(!["siliconflow","deepseek","volcano","gemini","custom_openai"].includes(l)){a.warning("当前服务商不支持获取模型列表");return}i.value[H]=!0;try{const ee=await He.fetchModels(l,_,x);ee.success&&ee.models&&ee.models.length>0?(s.value[H]=ee.models.map(be=>be.id),a.success(`轮次 ${H+1}: 获取到 ${ee.models.length} 个模型`)):a.warning(ee.message||"未获取到可用模型")}catch(ee){const be=ee instanceof Error?ee.message:"获取模型列表失败";a.error(be)}finally{i.value[H]=!1}}async function le(H){const d=k.value[H];if(!d)return;const l=d.provider,_=d.apiKey?.trim(),x=d.modelName?.trim(),z=d.customBaseUrl?.trim();if(!_){a.warning("请先填写 API Key");return}if(!x){a.warning("请填写模型名称");return}t.value[H]=!0,a.info(`正在测试轮次 ${H+1} 的连接...`);try{const ee=await He.testAiTranslateConnection({provider:l,apiKey:_,modelName:x,baseUrl:z});ee.success?a.success(ee.message||"连接成功!"):a.error(ee.message||ee.error||"连接失败")}catch(ee){const be=ee instanceof Error?ee.message:"连接测试失败";a.error(be)}finally{t.value[H]=!1}}function Z(){const H={name:`第${k.value.length+1}轮校对`,provider:"siliconflow",apiKey:"",modelName:"",customBaseUrl:"",batchSize:3,sessionReset:20,rpmLimit:7,lowReasoning:!1,noThinkingMethod:"gemini",forceJsonOutput:!0,prompt:Bn,showApiKey:!1};o.addProofreadingRound(H),a.success("已添加新的校对轮次")}function w(H){if(k.value.length<=1){a.warning("至少需要保留一个校对轮次");return}o.removeProofreadingRound(H),a.success("已删除校对轮次")}function Q(H){o.updateProofreadingRound(H,{prompt:Bn}),a.success("已重置为默认提示词")}function j(H,d,l){o.updateProofreadingRound(H,{prompt:d}),a.success(`已应用提示词: ${l}`)}return(H,d)=>(V(),J("div",pu,[e("div",bu,[d[5]||(d[5]=e("div",{class:"settings-group-title"},"AI校对设置",-1)),e("div",vu,[e("label",mu,[ue(e("input",{type:"checkbox","onUpdate:modelValue":d[0]||(d[0]=l=>$.value=l)},null,512),[[tt,$.value]]),d[2]||(d[2]=Ke(" 启用AI校对 ",-1))]),d[3]||(d[3]=e("div",{class:"input-hint"},"翻译完成后自动进行AI校对",-1))]),e("div",fu,[d[4]||(d[4]=e("label",{for:"settingsProofreadingMaxRetries"},"全局重试次数:",-1)),ue(e("input",{type:"number",id:"settingsProofreadingMaxRetries","onUpdate:modelValue":d[1]||(d[1]=l=>A.value=l),min:"0",max:"10",step:"1"},null,512),[[Ee,A.value,void 0,{number:!0}]])])]),ue(e("div",hu,[e("div",{class:"settings-group-title"},[d[6]||(d[6]=Ke(" 校对轮次配置 ",-1)),e("button",{class:"btn btn-secondary btn-sm",onClick:Z},"+ 添加轮次")]),(V(!0),J(Ze,null,et(k.value,(l,_)=>(V(),J("div",{key:_,class:"proofreading-round"},[e("div",yu,[e("span",xu,"轮次 "+xe(_+1)+": "+xe(l.name||"未命名"),1),e("button",{class:"btn btn-danger btn-sm",onClick:x=>w(_),disabled:k.value.length<=1}," 删除 ",8,Su)]),e("div",ku,[e("div",_u,[d[7]||(d[7]=e("label",null,"轮次名称:",-1)),ue(e("input",{type:"text","onUpdate:modelValue":x=>l.name=x,placeholder:"如: 第一轮校对"},null,8,Cu),[[Ee,l.name]])]),e("div",wu,[e("div",$u,[d[8]||(d[8]=e("label",null,"服务商:",-1)),Ie(We,{modelValue:l.provider,"onUpdate:modelValue":x=>l.provider=x,options:r},null,8,["modelValue","onUpdate:modelValue"])]),e("div",Tu,[d[9]||(d[9]=e("label",null,"API Key:",-1)),e("div",Iu,[ue(e("input",{type:l.showApiKey?"text":"password","onUpdate:modelValue":x=>l.apiKey=x,class:"secure-input",placeholder:"请输入API Key",autocomplete:"off"},null,8,Du),[[St,l.apiKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:x=>l.showApiKey=!l.showApiKey},[l.showApiKey?(V(),J("span",Bu,"👁‍🗨")):(V(),J("span",Mu,"👁"))],8,Ru)])])]),ue(e("div",Eu,[d[10]||(d[10]=e("label",null,"Base URL:",-1)),ue(e("input",{type:"text","onUpdate:modelValue":x=>l.customBaseUrl=x,placeholder:"例如: https://api.example.com/v1"},null,8,Pu),[[Ee,l.customBaseUrl]])],512),[[qe,l.provider==="custom_openai"]]),e("div",Au,[d[12]||(d[12]=e("label",null,"模型名称:",-1)),e("div",Fu,[ue(e("input",{type:"text","onUpdate:modelValue":x=>l.modelName=x,placeholder:"请输入模型名称"},null,8,Lu),[[Ee,l.modelName]]),e("button",{type:"button",class:"fetch-models-btn",title:"获取可用模型列表",onClick:x=>ae(_),disabled:i.value[_]},[d[11]||(d[11]=e("span",{class:"fetch-icon"},"🔍",-1)),e("span",Ou,xe(i.value[_]?"获取中...":"获取模型"),1)],8,Uu)]),s.value[_]&&s.value[_].length>0?(V(),J("div",zu,[Ie(We,{modelValue:l.modelName,"onUpdate:modelValue":x=>l.modelName=x,options:N(_)},null,8,["modelValue","onUpdate:modelValue","options"]),e("span",Vu,"共 "+xe(s.value[_].length)+" 个模型",1)])):Te("",!0)]),e("div",Nu,[e("button",{class:"settings-test-btn",onClick:x=>le(_),disabled:t.value[_]},xe(t.value[_]?"测试中...":"🔗 测试连接"),9,Wu)]),e("div",Ku,[e("div",qu,[d[13]||(d[13]=e("label",null,"批次大小:",-1)),ue(e("input",{type:"number","onUpdate:modelValue":x=>l.batchSize=x,min:"1",max:"10",step:"1"},null,8,Hu),[[Ee,l.batchSize,void 0,{number:!0}]])]),e("div",Ju,[d[14]||(d[14]=e("label",null,"会话重置频率:",-1)),ue(e("input",{type:"number","onUpdate:modelValue":x=>l.sessionReset=x,min:"1",step:"1"},null,8,Yu),[[Ee,l.sessionReset,void 0,{number:!0}]])]),e("div",Xu,[d[15]||(d[15]=e("label",null,"RPM限制:",-1)),ue(e("input",{type:"number","onUpdate:modelValue":x=>l.rpmLimit=x,min:"0",step:"1"},null,8,ju),[[Ee,l.rpmLimit,void 0,{number:!0}]])])]),e("div",Gu,[e("div",Zu,[e("label",Qu,[ue(e("input",{type:"checkbox","onUpdate:modelValue":x=>l.lowReasoning=x},null,8,ec),[[tt,l.lowReasoning]]),d[16]||(d[16]=Ke(" 低推理模式 ",-1))])]),e("div",tc,[d[17]||(d[17]=e("label",null,"取消思考方法:",-1)),Ie(We,{modelValue:l.noThinkingMethod,"onUpdate:modelValue":x=>l.noThinkingMethod=x,options:u},null,8,["modelValue","onUpdate:modelValue"])]),e("div",nc,[e("label",oc,[ue(e("input",{type:"checkbox","onUpdate:modelValue":x=>l.forceJsonOutput=x},null,8,ac),[[tt,l.forceJsonOutput]]),d[18]||(d[18]=Ke(" 强制JSON输出 ",-1))])])]),e("div",sc,[d[19]||(d[19]=e("label",null,"校对提示词:",-1)),ue(e("textarea",{"onUpdate:modelValue":x=>l.prompt=x,rows:"4",placeholder:"校对提示词"},null,8,lc),[[Ee,l.prompt]]),Ie(Tt,{"prompt-type":"proofreading",onSelect:(x,z)=>j(_,x,z)},null,8,["onSelect"]),e("button",{class:"btn btn-secondary btn-sm",onClick:x=>Q(_)},"重置为默认",8,ic)])])]))),128))],512),[[qe,$.value]])]))}}),uc=je(rc,[["__scopeId","data-v-663a7972"]]),cc={class:"prompt-library"},dc={class:"settings-group"},gc={class:"settings-item"},pc={key:0,class:"settings-item"},bc={class:"mode-hint"},vc={class:"settings-group"},mc={key:0,class:"loading-hint"},fc={key:1,class:"empty-hint"},hc={key:2,class:"prompt-list"},yc=["onClick"],xc={class:"prompt-name"},Sc={class:"prompt-actions"},kc=["onClick"],_c=["onClick","disabled"],Cc={class:"settings-group"},wc={class:"settings-item"},$c={class:"settings-item"},Tc={class:"prompt-editor-actions"},Ic=["disabled"],Dc=Ge({__name:"PromptLibrary",setup(n){const r=[{label:"翻译提示词",value:"translate"},{label:"文本框提示词",value:"textbox"},{label:"AI视觉OCR提示词",value:"ai_vision_ocr"},{label:"高质量翻译提示词",value:"hq_translate"},{label:"校对提示词",value:"proofreading"}],u=[{label:"普通模式",value:"false"},{label:"JSON格式模式",value:"true"}],o=dt(),a=Qe(),i=y("translate"),t=y([]),s=y(""),k=y(""),A=y(""),$=y(!1),N=y(!1),ae=oe(()=>i.value==="translate"||i.value==="ai_vision_ocr"),le=oe(()=>N.value?"适用于需要结构化输出的场景":"适用于普通翻译场景");async function Z(){$.value=!0;try{let _;i.value==="textbox"?_=await He.getTextboxPrompts():_=await He.getPrompts(i.value);const x=_.prompt_names||[];t.value=x.map(z=>({name:z}))}catch(_){const x=_ instanceof Error?_.message:"加载提示词列表失败";o.error(x)}finally{$.value=!1}}async function w(_){s.value=_,k.value=_,await Q(_)}async function Q(_){try{let x;i.value==="textbox"?x=await He.getTextboxPromptContent(_):x=await He.getPromptContent(i.value,_),k.value=_,A.value=x.prompt_content||"",s.value=_,o.success("已加载提示词")}catch(x){const z=x instanceof Error?x.message:"加载提示词内容失败";o.error(z)}}async function j(){if(!k.value||!A.value){o.warning("请输入提示词名称和内容");return}try{i.value==="textbox"?await He.saveTextboxPrompt(k.value,A.value):await He.savePrompt(i.value,k.value,A.value),o.success("提示词保存成功"),k.value="",A.value="",await Z()}catch(_){const x=_ instanceof Error?_.message:"保存提示词失败";o.error(x)}}async function H(_){if(_==="default"){o.warning("默认提示词不能删除");return}try{i.value==="textbox"?await He.deleteTextboxPrompt(_):await He.deletePrompt(i.value,_),o.success("提示词删除成功"),s.value===_&&(s.value="",k.value="",A.value=""),await Z()}catch(x){const z=x instanceof Error?x.message:"删除提示词失败";o.error(z)}}function d(){s.value="",k.value="",A.value="",i.value==="translate"?N.value=a.settings.translation.isJsonMode:i.value==="ai_vision_ocr"?N.value=a.settings.aiVisionOcr.isJsonMode:N.value=!1,Z()}function l(){i.value==="translate"?a.updateTranslationService({isJsonMode:N.value}):i.value==="ai_vision_ocr"&&a.updateAiVisionOcr({isJsonMode:N.value}),o.info(`已切换到${N.value?"JSON格式":"普通"}模式`)}return ut(()=>{N.value=a.settings.translation.isJsonMode,Z()}),(_,x)=>(V(),J("div",cc,[e("div",dc,[x[6]||(x[6]=e("div",{class:"settings-group-title"},"提示词管理",-1)),e("div",gc,[x[4]||(x[4]=e("label",{for:"promptType"},"提示词类型:",-1)),Ie(We,{modelValue:i.value,"onUpdate:modelValue":x[0]||(x[0]=z=>i.value=z),options:r,onChange:d},null,8,["modelValue"])]),ae.value?(V(),J("div",pc,[x[5]||(x[5]=e("label",{for:"promptMode"},"提示词模式:",-1)),Ie(We,{"model-value":N.value?"true":"false",options:u,onChange:x[1]||(x[1]=z=>{N.value=z==="true",l()})},null,8,["model-value"]),e("span",bc,xe(le.value),1)])):Te("",!0)]),e("div",vc,[x[7]||(x[7]=e("div",{class:"settings-group-title"},"已保存的提示词",-1)),$.value?(V(),J("div",mc,"加载中...")):t.value.length===0?(V(),J("div",fc,"暂无保存的提示词")):(V(),J("div",hc,[(V(!0),J(Ze,null,et(t.value,z=>(V(),J("div",{key:z.name,class:Le(["prompt-item",{active:s.value===z.name}]),onClick:ee=>w(z.name)},[e("span",xc,xe(z.name),1),e("div",Sc,[e("button",{class:"btn btn-sm",onClick:nt(ee=>Q(z.name),["stop"]),title:"加载到编辑器"},"📥",8,kc),e("button",{class:"btn btn-sm btn-danger",onClick:nt(ee=>H(z.name),["stop"]),title:"删除",disabled:z.name==="default"}," 🗑️ ",8,_c)])],10,yc))),128))]))]),e("div",Cc,[x[10]||(x[10]=e("div",{class:"settings-group-title"},"提示词编辑",-1)),e("div",wc,[x[8]||(x[8]=e("label",{for:"promptName"},"提示词名称:",-1)),ue(e("input",{type:"text",id:"promptName","onUpdate:modelValue":x[2]||(x[2]=z=>k.value=z),placeholder:"请输入提示词名称"},null,512),[[Ee,k.value]])]),e("div",$c,[x[9]||(x[9]=e("label",{for:"promptContent"},"提示词内容:",-1)),ue(e("textarea",{id:"promptContent","onUpdate:modelValue":x[3]||(x[3]=z=>A.value=z),rows:"8",placeholder:"请输入提示词内容"},null,512),[[Ee,A.value]])]),e("div",Tc,[e("button",{class:"btn btn-primary",onClick:j,disabled:!k.value||!A.value},"保存提示词",8,Ic)])])]))}}),Rc=je(Dc,[["__scopeId","data-v-70f0ec19"]]),Mc={class:"plugin-manager"},Bc={class:"settings-group"},Ec={key:0,class:"loading-hint"},Pc={key:1,class:"empty-hint"},Ac={key:2,class:"plugin-list"},Fc={class:"plugin-info"},Lc={class:"plugin-header"},Uc={class:"plugin-name"},Oc={class:"plugin-version"},zc={class:"plugin-description"},Vc={class:"plugin-controls"},Nc={class:"switch"},Wc=["checked","onChange"],Kc=["onClick"],qc=["onClick"],Hc={class:"settings-group"},Jc={class:"plugin-name"},Yc={class:"switch"},Xc=["checked","onChange"],jc={class:"plugin-config-content"},Gc={class:"plugin-config-header"},Zc={class:"plugin-config-body"},Qc=["for"],ed=["id","onUpdate:modelValue"],td=["id","onUpdate:modelValue","min","max"],nd=["id","onUpdate:modelValue","placeholder"],od={key:4,class:"field-description"},ad=Ge({__name:"PluginManager",setup(n){const r=dt(),u=y([]),o=y({}),a=y(!1),i=y(!1),t=y(null),s=y({}),k=y({});async function A(){a.value=!0;try{const j=await Zo();u.value=j.plugins||[]}catch(j){const H=j instanceof Error?j.message:"加载插件列表失败";r.error(H)}finally{a.value=!1}}async function $(){try{const j=await ia();o.value=j.states||{}}catch(j){console.error("加载默认状态失败:",j)}}async function N(j){try{j.enabled?(await ea(j.name),j.enabled=!1,r.success(`已禁用 ${j.display_name||j.name}`)):(await Qo(j.name),j.enabled=!0,r.success(`已启用 ${j.display_name||j.name}`))}catch(H){const d=H instanceof Error?H.message:"操作失败";r.error(d)}}async function ae(j,H){const d=H.target,l=d.checked;try{await ra(j,l),o.value[j]=l,r.success("默认状态已更新")}catch(_){const x=_ instanceof Error?_.message:"设置失败";r.error(x),d.checked=!l}}async function le(j){t.value=j;try{const H=await ua(j.name);s.value=H.schema||{};const d=await ca(j.name);k.value=d.config||{},i.value=!0}catch(H){const d=H instanceof Error?H.message:"加载配置失败";r.error(d)}}function Z(){i.value=!1,t.value=null,s.value={},k.value={}}async function w(){if(t.value)try{await da(t.value.name,k.value),r.success("配置保存成功"),Z()}catch(j){const H=j instanceof Error?j.message:"保存配置失败";r.error(H)}}async function Q(j){if(confirm(`确定要删除插件 "${j.display_name||j.name}" 吗？`))try{await ta(j.name),r.success("插件删除成功"),await A()}catch(H){const d=H instanceof Error?H.message:"删除插件失败";r.error(d)}}return ut(()=>{A(),$()}),(j,H)=>(V(),J("div",Mc,[e("div",Bc,[H[1]||(H[1]=e("div",{class:"settings-group-title"},"已安装插件",-1)),a.value?(V(),J("div",Ec,"加载中...")):u.value.length===0?(V(),J("div",Pc,"暂无已安装的插件")):(V(),J("div",Ac,[(V(!0),J(Ze,null,et(u.value,d=>(V(),J("div",{key:d.name,class:"plugin-item"},[e("div",Fc,[e("div",Lc,[e("span",Uc,xe(d.display_name||d.name),1),e("span",Oc,"v"+xe(d.version||"1.0.0"),1)]),e("p",zc,xe(d.description||"暂无描述"),1)]),e("div",Vc,[e("label",Nc,[e("input",{type:"checkbox",checked:d.enabled,onChange:l=>N(d)},null,40,Wc),H[0]||(H[0]=e("span",{class:"slider"},null,-1))]),d.has_config?(V(),J("button",{key:0,class:"btn btn-sm",onClick:l=>le(d),title:"配置"},"⚙️",8,Kc)):Te("",!0),e("button",{class:"btn btn-sm btn-danger",onClick:l=>Q(d),title:"删除"},"🗑️",8,qc)])]))),128))]))]),e("div",Hc,[H[3]||(H[3]=e("div",{class:"settings-group-title"},"默认启用状态",-1)),H[4]||(H[4]=e("p",{class:"settings-hint"},"设置插件在新会话中的默认启用状态",-1)),(V(!0),J(Ze,null,et(u.value,d=>(V(),J("div",{key:"default-"+d.name,class:"default-state-item"},[e("span",Jc,xe(d.display_name||d.name),1),e("label",Yc,[e("input",{type:"checkbox",checked:o.value[d.name],onChange:l=>ae(d.name,l)},null,40,Xc),H[2]||(H[2]=e("span",{class:"slider"},null,-1))])]))),128))]),i.value?(V(),J("div",{key:0,class:"plugin-config-modal",onClick:nt(Z,["self"])},[e("div",jc,[e("div",Gc,[e("h4",null,xe(t.value?.display_name||t.value?.name)+" 配置",1),e("span",{class:"close-btn",onClick:Z},"×")]),e("div",Zc,[(V(!0),J(Ze,null,et(s.value,(d,l)=>(V(),J("div",{key:l,class:"config-field"},[e("label",{for:"config-"+l},xe(d.label||l)+":",9,Qc),d.type==="boolean"?ue((V(),J("input",{key:0,type:"checkbox",id:"config-"+l,"onUpdate:modelValue":_=>k.value[l]=_},null,8,ed)),[[tt,k.value[l]]]):d.type==="select"?(V(),rt(We,{key:1,"model-value":String(k.value[l]??""),options:d.options||[],onChange:_=>{k.value[l]=_}},null,8,["model-value","options","onChange"])):d.type==="number"?ue((V(),J("input",{key:2,type:"number",id:"config-"+l,"onUpdate:modelValue":_=>k.value[l]=_,min:d.min,max:d.max},null,8,td)),[[Ee,k.value[l],void 0,{number:!0}]]):ue((V(),J("input",{key:3,type:"text",id:"config-"+l,"onUpdate:modelValue":_=>k.value[l]=_,placeholder:d.placeholder},null,8,nd)),[[Ee,k.value[l]]]),d.description?(V(),J("p",od,xe(d.description),1)):Te("",!0)]))),128))]),e("div",{class:"plugin-config-footer"},[e("button",{class:"btn btn-secondary",onClick:Z},"取消"),e("button",{class:"btn btn-primary",onClick:w},"保存")])])])):Te("",!0)]))}}),sd=je(ad,[["__scopeId","data-v-a62393a7"]]),ld={class:"more-settings"},id={class:"settings-group"},rd={class:"settings-item"},ud={class:"settings-group"},cd={class:"settings-item"},dd=["disabled"],gd={key:0,class:"font-count"},pd={class:"settings-item"},bd={class:"settings-group"},vd={class:"settings-row"},md={class:"settings-item"},fd=["disabled"],hd={class:"settings-item"},yd=["disabled"],xd=Ge({__name:"MoreSettings",setup(n){const r=[{label:"前端 pdf.js (推荐)",value:"frontend"},{label:"后端 PyMuPDF",value:"backend"}],u=Qe(),o=dt(),a=y(!1),i=y([]),t=y(!1),s=y(null),k=y({pdfProcessingMethod:u.settings.pdfProcessingMethod||"frontend"});Re(()=>k.value.pdfProcessingMethod,le=>{u.setPdfProcessingMethod(le)});async function A(){a.value=!0;try{const le=await He.getFontList();i.value=le.fonts||[],o.success(`获取到 ${i.value.length} 个字体`)}catch(le){const Z=le instanceof Error?le.message:"获取字体列表失败";o.error(Z)}finally{a.value=!1}}async function $(le){const w=le.target.files?.[0];if(!w)return;const Q=[".ttf",".ttc",".otf"],j=w.name.toLowerCase().slice(w.name.lastIndexOf("."));if(!Q.includes(j)){o.error("不支持的字体格式，请上传 .ttf, .ttc 或 .otf 文件");return}try{const H=await He.uploadFont(w);H.success?(o.success(`字体 "${H.fontPath||w.name}" 上传成功`),await A()):o.error(H.error||"字体上传失败")}catch(H){const d=H instanceof Error?H.message:"字体上传失败";o.error(d)}finally{s.value&&(s.value.value="")}}async function N(){t.value=!0;try{const le=await Yn();le.success?o.success(`已清理 ${le.deleted_count||0} 个调试文件`):o.error(le.error||"清理失败")}catch(le){const Z=le instanceof Error?le.message:"清理失败";o.error(Z)}finally{t.value=!1}}async function ae(){t.value=!0;try{const le=await rn();le.success?o.success(`已清理 ${le.deleted_count||0} 个临时文件`):o.error(le.error||"清理失败")}catch(le){const Z=le instanceof Error?le.message:"清理失败";o.error(Z)}finally{t.value=!1}}return(le,Z)=>(V(),J("div",ld,[e("div",id,[Z[3]||(Z[3]=e("div",{class:"settings-group-title"},"PDF处理设置",-1)),e("div",rd,[Z[1]||(Z[1]=e("label",{for:"settingsPdfProcessingMethod"},"PDF处理方式:",-1)),Ie(We,{modelValue:k.value.pdfProcessingMethod,"onUpdate:modelValue":Z[0]||(Z[0]=w=>k.value.pdfProcessingMethod=w),options:r},null,8,["modelValue"]),Z[2]||(Z[2]=e("div",{class:"input-hint"},"前端处理速度更快，后端处理兼容性更好",-1))])]),e("div",ud,[Z[7]||(Z[7]=e("div",{class:"settings-group-title"},"字体设置",-1)),e("div",cd,[Z[4]||(Z[4]=e("label",null,"系统字体列表:",-1)),e("button",{class:"btn btn-secondary",onClick:A,disabled:a.value},xe(a.value?"加载中...":"🔄 刷新字体列表"),9,dd),i.value.length>0?(V(),J("div",gd,"共 "+xe(i.value.length)+" 个字体",1)):Te("",!0)]),e("div",pd,[Z[5]||(Z[5]=e("label",null,"上传自定义字体:",-1)),e("input",{type:"file",accept:".ttf,.ttc,.otf",onChange:$,ref_key:"fontInput",ref:s},null,544),Z[6]||(Z[6]=e("div",{class:"input-hint"},"支持 .ttf, .ttc, .otf 格式",-1))])]),e("div",bd,[Z[10]||(Z[10]=e("div",{class:"settings-group-title"},"缓存清理",-1)),e("div",vd,[e("div",md,[e("button",{class:"btn btn-secondary",onClick:N,disabled:t.value},xe(t.value?"清理中...":"🗑️ 清理调试文件"),9,fd),Z[8]||(Z[8]=e("div",{class:"input-hint"},"清理调试过程中生成的临时文件",-1))]),e("div",hd,[e("button",{class:"btn btn-secondary",onClick:ae,disabled:t.value},xe(t.value?"清理中...":"🗑️ 清理临时文件"),9,yd),Z[9]||(Z[9]=e("div",{class:"input-hint"},"清理下载和处理过程中的临时文件",-1))])])]),Z[11]||(Z[11]=Qt('<div class="settings-group" data-v-136fb3b8><div class="settings-group-title" data-v-136fb3b8>关于</div><div class="about-info" data-v-136fb3b8><p data-v-136fb3b8><strong data-v-136fb3b8>Saber-Translator</strong></p><p data-v-136fb3b8>AI驱动的漫画翻译工具</p><p class="links" data-v-136fb3b8><a href="http://www.mashirosaber.top" target="_blank" data-v-136fb3b8>📖 使用教程</a><a href="https://github.com/MashiroSaber/saber-translator" target="_blank" data-v-136fb3b8>🐙 GitHub</a></p><p class="disclaimer" data-v-136fb3b8>本项目完全开源免费，请勿上当受骗</p></div></div>',1))]))}}),Sd=je(xd,[["__scopeId","data-v-136fb3b8"]]),kd={class:"settings-modal-content"},_d={class:"settings-tabs"},Cd=["onClick"],wd={class:"settings-tab-content"},$d={class:"settings-tab-pane active"},Td={class:"settings-tab-pane"},Id={class:"settings-tab-pane"},Dd={class:"settings-tab-pane"},Rd={class:"settings-tab-pane"},Md={class:"settings-tab-pane"},Bd={class:"settings-tab-pane"},Ed={class:"settings-tab-pane"},Pd=Ge({__name:"SettingsModal",props:{modelValue:{type:Boolean}},emits:["update:modelValue","save"],setup(n,{emit:r}){const u=n,o=r,a=Qe(),i=y(u.modelValue),t=y("ocr"),s=[{id:"ocr",label:"OCR识别"},{id:"translate",label:"翻译服务"},{id:"detection",label:"检测设置"},{id:"hq",label:"高质量翻译"},{id:"proofreading",label:"AI校对"},{id:"prompt-library",label:"提示词管理"},{id:"plugins",label:"插件管理"},{id:"more",label:"更多"}];Re(()=>u.modelValue,N=>{i.value=N,N?document.body.style.overflow="hidden":document.body.style.overflow=""});function k(){i.value=!1,o("update:modelValue",!1),document.body.style.overflow=""}async function A(){a.saveToStorage();try{await a.saveToBackend(),console.log("[SettingsModal] 设置已保存到后端")}catch(N){console.warn("[SettingsModal] 保存到后端失败，仅保存到 localStorage:",N)}o("save"),k()}function $(N){N.key==="Escape"&&i.value&&k()}return ut(()=>{document.addEventListener("keydown",$)}),It(()=>{document.removeEventListener("keydown",$),document.body.style.overflow=""}),(N,ae)=>i.value?(V(),J("div",{key:0,class:"settings-modal",onClick:nt(k,["self"])},[e("div",kd,[e("div",{class:"settings-modal-header"},[ae[0]||(ae[0]=e("h3",null,"⚙️ 设置",-1)),e("span",{class:"settings-modal-close",onClick:k},"×")]),e("div",_d,[(V(),J(Ze,null,et(s,le=>e("button",{key:le.id,class:Le(["settings-tab",{active:t.value===le.id}]),onClick:Z=>t.value=le.id},xe(le.label),11,Cd)),64))]),e("div",wd,[ue(e("div",$d,[Ie(fi)],512),[[qe,t.value==="ocr"]]),ue(e("div",Td,[Ie(sr)],512),[[qe,t.value==="translate"]]),ue(e("div",Id,[Ie(Tr)],512),[[qe,t.value==="detection"]]),ue(e("div",Dd,[Ie(gu)],512),[[qe,t.value==="hq"]]),ue(e("div",Rd,[Ie(uc)],512),[[qe,t.value==="proofreading"]]),ue(e("div",Md,[Ie(Rc)],512),[[qe,t.value==="prompt-library"]]),ue(e("div",Bd,[Ie(sd)],512),[[qe,t.value==="plugins"]]),ue(e("div",Ed,[Ie(Sd)],512),[[qe,t.value==="more"]])]),e("div",{class:"settings-modal-footer"},[e("button",{class:"btn btn-secondary",onClick:k},"取消"),e("button",{class:"btn btn-primary",onClick:A},"保存设置")])])])):Te("",!0)}}),Ad=je(Pd,[["__scopeId","data-v-80c56eb8"]]),Fd={minScale:.1,maxScale:5,zoomSpeed:.1};function Kn(n={}){const r={...Fd,...n},u=y(1),o=y(0),a=y(0),i=y(!1),t=y(0),s=y(0),k=oe(()=>({transform:`translate(${o.value}px, ${a.value}px) scale(${u.value})`}));function A(G,F,B){const S=Math.min(Math.max(u.value*B,r.minScale),r.maxScale),v=S/u.value;o.value=G-(G-o.value)*v,a.value=F-(F-a.value)*v,u.value=S,n.onScaleChange?.(u.value),n.onTransformChange?.(x())}function $(G,F=800,B=600){A(F/2,B/2,G)}function N(){$(1.2)}function ae(){$(.8)}function le(G,F=800,B=600){const S=G/u.value;A(F/2,B/2,S)}function Z(G,F){i.value=!0,t.value=G,s.value=F}function w(G,F){if(!i.value)return;const B=G-t.value,S=F-s.value;o.value+=B,a.value+=S,t.value=G,s.value=F,n.onTransformChange?.(x())}function Q(){i.value=!1}function j(G,F){o.value+=G,a.value+=F,n.onTransformChange?.(x())}function H(){u.value=1,o.value=0,a.value=0,n.onScaleChange?.(u.value),n.onTransformChange?.(x())}function d(){H()}function l(){u.value=1,o.value=0,a.value=0}function _(G,F,B,S){if(!G||!F)return;const v=B/G,I=S/F;u.value=Math.min(v,I)*.95,o.value=(B-G*u.value)/2,a.value=(S-F*u.value)/2,n.onScaleChange?.(u.value),n.onTransformChange?.(x())}function x(){return{scale:u.value,translateX:o.value,translateY:a.value}}function z(G){G.scale!==void 0&&(u.value=G.scale),G.translateX!==void 0&&(o.value=G.translateX),G.translateY!==void 0&&(a.value=G.translateY),n.onTransformChange?.(x())}function ee(G){u.value=G.scale,o.value=G.translateX,a.value=G.translateY}function be(G,F,B){if(!G||G.length<4)return;const[S,v,I,T]=G,p=(S+I)/2,f=(v+T)/2,te=F/2,se=B/2;o.value=te-p*u.value,a.value=se-f*u.value,n.onTransformChange?.(x())}return{scale:u,translateX:o,translateY:a,isDragging:i,transformStyle:k,zoomAt:A,zoom:$,zoomIn:N,zoomOut:ae,setScale:le,startDrag:Z,drag:w,endDrag:Q,pan:j,reset:H,resetZoom:d,resetTransform:l,fitToScreen:_,getTransform:x,setTransform:z,syncWith:ee,scrollToBubble:be}}function Ld(n){const r=st(),u=Qe(),o=y(null),a=y(Mo),i=y(!1),t=y(!1),s=y([]),k=y(0),A=y(0);let $=null,N=null,ae=null;const le=oe(()=>o.value!==null),Z=oe(()=>o.value==="repair"?{fill:"rgba(76, 175, 80, 0.4)",border:"#4CAF50"}:o.value==="restore"?{fill:"rgba(33, 150, 243, 0.4)",border:"#2196F3"}:{fill:"transparent",border:"transparent"});function w(f){o.value!==f&&(o.value=f,i.value=!0,s.value=[],console.log(`进入${f==="repair"?"修复":"还原"}笔刷模式，笔刷大小: ${a.value}px`))}function Q(){t.value&&z();const f=o.value!==null;o.value=null,i.value=!1,t.value=!1,s.value=[],F(),f&&console.log("退出笔刷模式")}function j(f){o.value===f?Q():w(f)}function H(f){a.value=Math.max(Pn,Math.min(En,f))}function d(f){H(a.value+f)}function l(f){if(!le.value)return;f.preventDefault(),f.stopPropagation();const te=f.deltaY>0?-5:5;d(te)}function _(f,te){if(!le.value||f.button!==0)return;f.preventDefault(),f.stopPropagation(),t.value=!0,$=te,s.value=[];const se=ee(f,te);se&&(s.value.push(se),G(te),B(se)),console.log("开始笔刷涂抹")}function x(f){if(k.value=f.clientX,A.value=f.clientY,!t.value||!le.value)return;const te=ee(f,$);te&&(s.value.push(te),B(te))}function z(){if(!t.value)return;t.value=!1;const f=r.currentImage;if(!f||s.value.length===0){F(),s.value=[];return}const te=be();if(!te){F(),s.value=[];return}const se=o.value;(async()=>{se==="restore"?await S(f,te):se==="repair"&&await v(f,te),n?.onBrushComplete?.()})(),F(),s.value=[]}function ee(f,te){if(!te)return null;const se=te.querySelector(".image-canvas-wrapper"),m=se?.querySelector("img");if(!m||!m.naturalWidth)return null;const C=se.getBoundingClientRect(),c=window.getComputedStyle(se).transform;let U=1;c&&c!=="none"&&(U=new DOMMatrix(c).a);const fe=(f.clientX-C.left)/U,K=(f.clientY-C.top)/U,Y=m.naturalWidth,Se=m.naturalHeight;return fe<0||K<0||fe>Y||K>Se?null:{x:fe,y:K,scale:U}}function be(){if(s.value.length===0)return null;const te=s.value[0]?.scale||1,se=a.value/2/te;let m=1/0,C=1/0,c=-1/0,U=-1/0;for(const fe of s.value)m=Math.min(m,fe.x-se),C=Math.min(C,fe.y-se),c=Math.max(c,fe.x+se),U=Math.max(U,fe.y+se);return{x1:Math.max(0,Math.floor(m)),y1:Math.max(0,Math.floor(C)),x2:Math.ceil(c),y2:Math.ceil(U),path:[...s.value],radius:se}}function G(f){F();const te=f.querySelector(".image-canvas-wrapper"),se=te?.querySelector("img");if(!se)return;const m=document.createElement("canvas");m.id="brushOverlayCanvas",m.width=se.naturalWidth,m.height=se.naturalHeight,m.style.cssText="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100;",te.appendChild(m),N=m,ae=m.getContext("2d")}function F(){N&&N.parentNode&&N.parentNode.removeChild(N),N=null,ae=null}function B(f){if(!ae||!f)return;const te=Z.value.fill,se=a.value/2/(f.scale||1);ae.beginPath(),ae.arc(f.x,f.y,se,0,Math.PI*2),ae.fillStyle=te,ae.fill()}async function S(f,te){if(!f.originalDataURL)return;let se;return f.cleanImageData?se="data:image/png;base64,"+f.cleanImageData:se=f.originalDataURL,new Promise(m=>{const C=new Image,c=new Image;let U=0;const fe=()=>{if(U++,U<2)return;const K=document.createElement("canvas");K.width=C.naturalWidth,K.height=C.naturalHeight;const Y=K.getContext("2d");if(!Y){m();return}Y.drawImage(C,0,0);const Se=document.createElement("canvas");Se.width=K.width,Se.height=K.height;const g=Se.getContext("2d");if(!g){m();return}g.fillStyle="white";for(const M of te.path)g.beginPath(),g.arc(M.x,M.y,te.radius,0,Math.PI*2),g.fill();Y.globalCompositeOperation="destination-out",Y.drawImage(Se,0,0),Y.globalCompositeOperation="destination-over",Y.drawImage(c,0,0),Y.globalCompositeOperation="source-over";const b=K.toDataURL("image/png").split(",")[1];r.updateCurrentImage({cleanImageData:b}),console.log("还原笔刷区域完成"),m()};C.onload=fe,C.onerror=()=>m(),c.onload=fe,c.onerror=()=>m(),C.src=se,c.src=f.originalDataURL})}async function v(f,te){const se=n?.getCurrentRepairSettings?.()||{inpaintMethod:"solid",fillColor:"#FFFFFF"},m=se.inpaintMethod;m==="lama_mpe"||m==="litelama"?await I(f,te,m):await T(f,te,se.fillColor)}async function I(f,te,se="lama_mpe"){let m,C;if(f.cleanImageData)m=f.cleanImageData,C="data:image/png;base64,"+f.cleanImageData;else if(f.originalDataURL)m=f.originalDataURL.split(",")[1],C=f.originalDataURL;else{console.error("无法获取基础图像用于 LAMA 修复");return}return new Promise(c=>{const U=new Image;U.onload=async()=>{const fe=U.naturalWidth,K=U.naturalHeight,Y=document.createElement("canvas");Y.width=fe,Y.height=K;const Se=Y.getContext("2d");if(!Se){console.error("无法创建掩膜画布上下文"),c();return}Se.fillStyle="black",Se.fillRect(0,0,fe,K),Se.fillStyle="white";for(const O of te.path)Se.beginPath(),Se.arc(O.x,O.y,te.radius,0,Math.PI*2),Se.fill();const b=Y.toDataURL("image/png").split(",")[1],M=[te.x1,te.y1,te.x2,te.y2],D=se==="litelama"?"litelama":"lama_mpe";try{we("LAMA 修复中...","info");const O=await cn(m,M,{method:"lama",lamaModel:D,maskData:b});if(O.success&&O.inpainted_image)r.updateCurrentImage({cleanImageData:O.inpainted_image}),console.log("修复笔刷区域完成（LAMA 修复，精确掩膜）"),we("LAMA 修复完成","success");else throw new Error(O.error||"LAMA 修复返回无效数据")}catch(O){console.error("LAMA 修复失败，回退到纯色填充:",O),we("LAMA 修复失败，使用纯色填充","warning");const re=n?.getCurrentRepairSettings?.();await T(f,te,re?.fillColor)}c()},U.onerror=()=>{console.error("加载图像失败，无法进行 LAMA 修复"),c()},U.src=C})}async function T(f,te,se){const m=se||u.settings.textStyle.fillColor||"#FFFFFF";let C;if(f.cleanImageData)C="data:image/png;base64,"+f.cleanImageData;else if(f.originalDataURL)C=f.originalDataURL;else return;return new Promise(c=>{const U=new Image;U.onload=()=>{const fe=document.createElement("canvas");fe.width=U.naturalWidth,fe.height=U.naturalHeight;const K=fe.getContext("2d");if(!K){c();return}K.drawImage(U,0,0),K.fillStyle=m;for(const Se of te.path)K.beginPath(),K.arc(Se.x,Se.y,te.radius,0,Math.PI*2),K.fill();const Y=fe.toDataURL("image/png").split(",")[1];r.updateCurrentImage({cleanImageData:Y}),console.log("修复笔刷区域完成（纯色填充）"),c()},U.onerror=()=>c(),U.src=C})}async function p(){const f=r.currentImage;if(!f)return console.warn("ensureCleanBackground: 没有当前图片"),!1;if(f.cleanImageData)return console.log("ensureCleanBackground: 已有干净背景"),!0;const te=n?.getCurrentRepairSettings?.();if((te?.inpaintMethod||u.settings.textStyle.inpaintMethod)!=="solid")return console.log("ensureCleanBackground: 非纯色填充模式，跳过"),!1;if(!f.bubbleStates||f.bubbleStates.length===0)return console.warn("ensureCleanBackground: 没有气泡数据"),!1;if(!f.translatedDataURL&&!f.originalDataURL)return console.warn("ensureCleanBackground: 没有图片数据"),!1;console.log("ensureCleanBackground: 尝试为纯色填充模式创建临时干净背景");const m=f.translatedDataURL||f.originalDataURL,C=te?.fillColor||u.settings.textStyle.fillColor||"#FFFFFF";return new Promise(c=>{const U=new Image;U.onload=()=>{try{const fe=document.createElement("canvas");fe.width=U.naturalWidth,fe.height=U.naturalHeight;const K=fe.getContext("2d");if(!K){console.error("ensureCleanBackground: 无法获取 Canvas 上下文"),c(!1);return}K.drawImage(U,0,0),K.fillStyle=C;for(const Se of f.bubbleStates){const[g,b,M,D]=Se.coords;K.fillRect(g,b,M-g+1,D-b+1)}const Y=fe.toDataURL("image/png").split(",")[1];r.updateCurrentImage({cleanImageData:Y}),console.log("ensureCleanBackground: 成功创建临时干净背景（纯色填充）"),c(!0)}catch(fe){console.error("ensureCleanBackground: Canvas 操作失败:",fe),c(!1)}},U.onerror=()=>{console.error("ensureCleanBackground: 加载图像失败"),c(!1)},U.src=m})}return It(()=>{Q()}),{brushMode:o,brushSize:a,isBrushKeyDown:i,isBrushPainting:t,mouseX:k,mouseY:A,isActive:le,brushColor:Z,BRUSH_MIN_SIZE:Pn,BRUSH_MAX_SIZE:En,enterBrushMode:w,exitBrushMode:Q,toggleBrushMode:j,setBrushSize:H,adjustBrushSize:d,handleBrushWheel:l,startBrushPainting:_,continueBrushPainting:x,finishBrushPainting:z,getBrushPositionInImage:ee,getBrushPathBounds:be,ensureCleanBackground:p}}function Ud(n){return[Math.round(n[0]),Math.round(n[1]),Math.round(n[2]),Math.round(n[3])]}function Od(n){const r=gt(),u=st(),o=Qe(),{bubbles:a,selectedIndex:i,hasSelection:t}=yt(r),{currentImage:s}=yt(u),k=y(!1),A=y(!1),$=y(null),N=y(0),ae=y(0),le=y(!1);function Z(K){r.selectBubble(K)}function w(K){r.toggleMultiSelect(K)}function Q(){r.clearMultiSelect()}function j(K,Y){console.log(`开始拖动气泡 #${K+1}`)}function H(K,Y){}function d(K,Y){r.updateBubble(K,{coords:Y}),console.log(`气泡 #${K+1} 拖动完成:`,Y),se()}function l(K,Y,Se){console.log(`开始调整气泡 #${K+1} 大小，手柄: ${Y}`)}function _(K){}function x(K,Y){r.updateBubble(K,{coords:Y}),console.log(`气泡 #${K+1} 调整大小完成:`,Y),se()}function z(K,Y){console.log(`开始旋转气泡 #${K+1}`)}function ee(K){}function be(K,Y){r.updateBubble(K,{rotationAngle:Y}),console.log(`气泡 #${K+1} 旋转完成: ${Y}°`),se()}function G(){k.value=!k.value,k.value?console.log("进入绘制模式"):console.log("退出绘制模式")}function F(K){r.addBubble(K),r.selectBubble(r.bubbleCount-1),console.log("已添加新气泡:",K),n?.onReRender?.()}function B(K,Y){A.value=!0,N.value=K,ae.value=Y,$.value=[K,Y,K,Y]}function S(K,Y){A.value&&($.value=[N.value,ae.value,K,Y])}function v(){if(!A.value||!$.value)return A.value=!1,$.value=null,null;const[K,Y,Se,g]=$.value,b=10;if(Math.abs(Se-K)<b||Math.abs(g-Y)<b)return A.value=!1,$.value=null,null;const M=[Math.min(K,Se),Math.min(Y,g),Math.max(K,Se),Math.max(Y,g)];return A.value=!1,$.value=null,M}function I(){A.value=!1,$.value=null,k.value=!1}function T(){if(!$.value)return{};const[K,Y,Se,g]=$.value;return{position:"absolute",left:`${Math.min(K,Se)}px`,top:`${Math.min(Y,g)}px`,width:`${Math.abs(Se-K)}px`,height:`${Math.abs(g-Y)}px`,border:"2px dashed #00d4ff",background:"rgba(0, 212, 255, 0.1)",pointerEvents:"none",zIndex:"25",boxSizing:"border-box"}}let p=null,f=!1;const te=150;function se(){p&&clearTimeout(p),p=setTimeout(async()=>{if(f){console.log("跳过渲染，上一次渲染仍在进行中");return}console.log("触发延迟渲染预览"),f=!0;try{n?.onDelayedPreview?await n.onDelayedPreview():n?.onReRender&&await n.onReRender()}catch(K){console.error("延迟渲染预览失败:",K)}finally{f=!1}},te)}function m(K){r.updateSelectedBubble(K),se()}function C(){t.value&&(r.deleteSelected(),console.log("已删除选中的气泡"),n?.onReRender?.())}async function c(){const K=i.value;if(K<0){console.warn("请先选中要修复的气泡框");return}const Y=a.value[K],Se=s.value;if(!Y||!Se?.originalDataURL){console.warn("无法修复背景：缺少气泡或图片数据");return}const g=Y.inpaintMethod||"solid",b=Y.fillColor||"#FFFFFF",M=Y.rotationAngle||0;try{console.log(`开始修复气泡 #${K+1} 背景，方法: ${g}`);let D;if(Se.cleanImageData)D=Se.cleanImageData;else{const re=Se.originalDataURL.match(/^data:image\/[^;]+;base64,(.+)$/);if(D=re&&re[1]?re[1]:"",!D){console.error("无法解析图像数据");return}}if(g==="lama_mpe"||g==="litelama"){const re=g==="litelama"?"litelama":"lama_mpe",E=Ud(Y.coords),P=await cn(D,E,{bubbleAngle:M,method:"lama",lamaModel:re});P.success&&P.inpainted_image?(u.updateCurrentImage({cleanImageData:P.inpainted_image}),console.log(`气泡 #${K+1} LAMA背景修复成功`),se()):(console.error("LAMA修复失败:",P.error||"未知错误"),await U(Y.coords,b,M),se())}else await U(Y.coords,b,M),console.log(`气泡 #${K+1} 纯色填充修复成功`),se()}catch(D){console.error("背景修复出错:",D)}}async function U(K,Y,Se=0){const g=s.value;if(!g)return;const[b,M,D,O]=K;let re;if(g.cleanImageData)re="data:image/png;base64,"+g.cleanImageData;else if(g.originalDataURL)re=g.originalDataURL;else{console.error("无法找到基础图像用于填充");return}return new Promise(E=>{const P=new Image;P.onload=()=>{const R=document.createElement("canvas");R.width=P.naturalWidth,R.height=P.naturalHeight;const h=R.getContext("2d");if(!h){E();return}if(h.drawImage(P,0,0),h.fillStyle=Y,Math.abs(Se)<.1)h.fillRect(b,M,D-b,O-M);else{const X=(b+D)/2,ne=(M+O)/2,ye=(D-b)/2,ge=(O-M)/2,ie=Se*Math.PI/180,ke=Math.cos(ie),ve=Math.sin(ie),Pe=[[-ye,-ge],[ye,-ge],[ye,ge],[-ye,ge]].map(([_e,ce])=>[X+_e*ke-ce*ve,ne+_e*ve+ce*ke]);h.beginPath();const De=Pe[0];if(De){h.moveTo(De[0],De[1]);for(let _e=1;_e<Pe.length;_e++){const ce=Pe[_e];ce&&h.lineTo(ce[0],ce[1])}}h.closePath(),h.fill()}const L=R.toDataURL("image/png").split(",")[1];u.updateCurrentImage({cleanImageData:L}),console.log("已对气泡区域进行纯色填充:",K,Y,"角度:",Se),E()},P.onerror=()=>{console.error("加载基础图像失败"),E()},P.src=re})}async function fe(K){const Y=a.value[K],Se=s.value;if(!Y||!Se?.originalDataURL){console.warn("无法进行 OCR 识别：缺少气泡或图片数据");return}try{console.log(`开始 OCR 识别气泡 #${K+1}`);const g=Se.originalDataURL.split(",")[1]||"",b=o.settings,M=await Gn(g,Y.coords,b.ocrEngine||"manga_ocr",{source_language:b.sourceLanguage,baidu_ocr_api_key:b.baiduOcr.apiKey,baidu_ocr_secret_key:b.baiduOcr.secretKey,baidu_version:b.baiduOcr.version,baidu_source_language:b.baiduOcr.sourceLanguage,ai_vision_provider:b.aiVisionOcr.provider,ai_vision_api_key:b.aiVisionOcr.apiKey,ai_vision_model_name:b.aiVisionOcr.modelName,ai_vision_ocr_prompt:b.aiVisionOcr.prompt,custom_ai_vision_base_url:b.aiVisionOcr.customBaseUrl});M.success&&M.text!==void 0?(r.updateBubble(K,{originalText:M.text}),console.log(`OCR 识别成功: "${M.text}"`)):console.error("OCR 识别失败:",M.error||"未知错误")}catch(g){console.error("OCR 识别出错:",g)}}return{isDrawingMode:k,isDrawingBox:A,currentDrawingRect:$,isMiddleButtonDown:le,handleBubbleSelect:Z,handleBubbleMultiSelect:w,handleClearMultiSelect:Q,handleBubbleDragStart:j,handleBubbleDragging:H,handleBubbleDragEnd:d,handleBubbleResizeStart:l,handleBubbleResizing:_,handleBubbleResizeEnd:x,handleBubbleRotateStart:z,handleBubbleRotating:ee,handleBubbleRotateEnd:be,toggleDrawingMode:G,handleDrawBubble:F,startDrawingBox:B,updateDrawingBox:S,finishDrawingBox:v,cancelDrawing:I,getDrawingRectStyle:T,handleBubbleUpdate:m,deleteSelectedBubbles:C,repairSelectedBubble:c,triggerDelayedPreview:se,handleOcrRecognize:fe}}function zd(n){const r=gt(),u=st(),{bubbles:o}=yt(r),{currentImage:a}=yt(u),i=y(!1),t=y("");let s=null;function k(){const N=a.value;if(!N)return null;if(N.cleanImageData)return N.cleanImageData;if(N.originalDataURL){const ae=N.originalDataURL.match(/^data:image\/[^;]+;base64,(.+)$/);if(ae&&ae[1])return ae[1]}return null}async function A(N=!1){if(!a.value)return console.warn("reRenderFullImage: 没有当前图片"),!1;if(o.value.length===0){console.log("reRenderFullImage: 没有气泡，跳过后端渲染");const w=k();if(w){const Q=`data:image/png;base64,${w}`;u.updateCurrentImage({translatedDataURL:Q}),N||n?.onRenderSuccess?.(Q)}return!0}const le=k();if(!le)return console.error("reRenderFullImage: 缺少图像数据"),t.value="缺少图像数据",N||n?.onRenderError?.("缺少图像数据"),!1;const Z=Symbol("render");s=Z,i.value=!0,t.value="",N||n?.onRenderStart?.();try{console.log("reRenderFullImage: 开始重新渲染，气泡数量:",o.value.length);const w=o.value,Q=w.map(l=>l.translatedText||""),j=w.map(l=>l.coords.map(_=>Math.round(_))),H=w.map(l=>({translatedText:l.translatedText||"",coords:l.coords,fontSize:Number(l.fontSize)||24,fontFamily:l.fontFamily||"fonts/STSONG.TTF",textDirection:kt(l),textColor:l.textColor||"#231816",rotationAngle:Math.round(Number(l.rotationAngle)||0),position:l.position?{x:Math.round(l.position.x||0),y:Math.round(l.position.y||0)}:{x:0,y:0},strokeEnabled:l.strokeEnabled!==void 0?l.strokeEnabled:!0,strokeColor:l.strokeColor||"#FFFFFF",strokeWidth:Number(l.strokeWidth)||3})),d=await un({clean_image:le,bubble_texts:Q,bubble_coords:j,bubble_states:H,fontSize:Number(w[0]?.fontSize)||24,fontFamily:w[0]?.fontFamily||"fonts/STSONG.TTF",textDirection:w[0]?kt(w[0]):"vertical",textColor:w[0]?.textColor||"#231816",strokeEnabled:w[0]?.strokeEnabled!==void 0?w[0].strokeEnabled:!0,strokeColor:w[0]?.strokeColor||"#FFFFFF",strokeWidth:Number(w[0]?.strokeWidth)||3,use_individual_styles:!0,use_inpainting:!1,use_lama:!1,is_font_style_change:!0});if(s!==Z)return console.log("reRenderFullImage: 渲染结果已过期，忽略"),!1;if(d.rendered_image){const l=`data:image/png;base64,${d.rendered_image}`;return u.updateCurrentImage({translatedDataURL:l}),console.log("reRenderFullImage: 渲染成功"),N||n?.onRenderSuccess?.(l),!0}else{const l=d.error||"渲染失败";return console.error("reRenderFullImage: 渲染失败 -",l),t.value=l,N||n?.onRenderError?.(l),!1}}catch(w){if(s!==Z)return!1;const Q=w instanceof Error?w.message:"渲染请求失败";return console.error("reRenderFullImage: 渲染出错 -",w),t.value=Q,N||n?.onRenderError?.(Q),!1}finally{s===Z&&(i.value=!1,N||n?.onRenderEnd?.())}}function $(){s=null,i.value=!1}return{isRendering:i,renderError:t,reRenderFullImage:A,cancelRender:$}}const Vd=["data-index","data-coords","data-rotation","onClick","onMousedown"],Nd={class:"bubble-index"},Wd=["data-parent-index","onMousedown"],Kd=["data-parent-index","onMousedown"],qd=["data-parent-index","onMousedown"],Hd=["data-parent-index","onMousedown"],Jd=["data-parent-index","onMousedown"],Yd=["data-parent-index","onMousedown"],Xd=["data-parent-index","onMousedown"],jd=["data-parent-index","onMousedown"],Gd=["data-parent-index","onMousedown"],Zd=Ge({__name:"BubbleOverlay",props:{bubbles:{},selectedIndex:{},selectedIndices:{},scale:{},isDrawingMode:{type:Boolean},isBrushMode:{type:Boolean},imageWidth:{},imageHeight:{}},emits:["select","multiSelect","dragStart","dragging","dragEnd","resizeStart","resizing","resizeEnd","rotateStart","rotating","rotateEnd","drawBubble"],setup(n,{emit:r}){const u=gt(),{isDragging:o,draggingIndex:a,dragOffsetX:i,dragOffsetY:t,dragInitialX:s,dragInitialY:k,isResizing:A,resizingIndex:$,resizeCurrentCoords:N,isRotating:ae,rotatingIndex:le,rotateCurrentAngle:Z}=yt(u),w=n,Q=r,j=y(null),H=y(0),d=y(0),l=y(""),_=y(0),x=y(0),z=y(null),ee=y(0),be=y(0),G=y(0),F=y(0),B=y(!1),S=y(0),v=y(0),I=y(null),T=y(!1);function p(R,h){let L,X,ne,ye,ge=R.rotationAngle||0;if(o.value&&a.value===h){const[Pe,De,_e,ce]=R.coords;L=s.value+i.value,X=k.value+t.value,ne=L+(_e-Pe),ye=X+(ce-De)}else A.value&&$.value===h&&N.value?[L,X,ne,ye]=N.value:ae.value&&le.value===h?([L,X,ne,ye]=R.coords,ge=Z.value):[L,X,ne,ye]=R.coords;const ie=ne-L,ke=ye-X,ve={left:`${L}px`,top:`${X}px`,width:`${ie}px`,height:`${ke}px`};return ge&&(ve.transformOrigin="center center",ve.transform=`rotate(${ge}deg)`),ve}function f(){if(!I.value)return{};const[R,h,L,X]=I.value;return{left:`${Math.min(R,L)}px`,top:`${Math.min(h,X)}px`,width:`${Math.abs(L-R)}px`,height:`${Math.abs(X-h)}px`}}function te(R){if(!j.value)return null;const h=j.value.getBoundingClientRect(),L=w.scale||1,X=(R.clientX-h.left)/L,ne=(R.clientY-h.top)/L;return{x:X,y:ne}}function se(R,h){w.isBrushMode||h.shiftKey||Q("select",R)}function m(R){if(!w.isBrushMode){if(R.button===1){R.preventDefault(),T.value=!0,document.body.classList.add("middle-button-drawing"),D(R);return}R.button===0&&w.isDrawingMode&&D(R)}}function C(R,h){if(!w.isBrushMode&&h.button===0){if(h.preventDefault(),h.stopPropagation(),h.shiftKey){Q("multiSelect",R);return}if(R!==w.selectedIndex){Q("select",R);return}c(R,h)}}function c(R,h){document.removeEventListener("mousemove",E),document.removeEventListener("mouseup",P),o.value=!0,a.value=R,H.value=h.clientX,d.value=h.clientY,i.value=0,t.value=0;const L=w.bubbles[R];L&&(s.value=L.coords[0],k.value=L.coords[1]),Q("dragStart",R,h),document.addEventListener("mousemove",E),document.addEventListener("mouseup",P)}function U(R){const h=w.scale||1,L=(R.clientX-H.value)/h,X=(R.clientY-d.value)/h;i.value=L,t.value=X}function fe(R){const h=a.value;o.value=!1,a.value=-1,i.value=0,t.value=0;const L=w.scale||1,X=(R.clientX-H.value)/L,ne=(R.clientY-d.value)/L,ye=w.bubbles[h];if(!ye)return;const[ge,ie,ke,ve]=ye.coords,Pe=ke-ge,De=ve-ie;let _e=Math.round(s.value+X),ce=Math.round(k.value+ne);const $e=w.imageWidth||2e3,Ue=w.imageHeight||2e3,Be=Math.min(Pe,$e),Fe=Math.min(De,Ue);_e=Math.max(0,Math.min(_e,$e-Be)),ce=Math.max(0,Math.min(ce,Ue-Fe));const Ce=[_e,ce,_e+Be,ce+Fe];Q("dragEnd",h,Ce)}function K(R,h,L){if(w.isBrushMode||L.button!==0)return;L.preventDefault(),L.stopPropagation(),document.removeEventListener("mousemove",E),document.removeEventListener("mouseup",P),A.value=!0,$.value=h,l.value=R,_.value=L.clientX,x.value=L.clientY;const X=w.bubbles[h];X&&(z.value=[...X.coords],N.value=[...X.coords]),Q("resizeStart",h,R,L),document.addEventListener("mousemove",E),document.addEventListener("mouseup",P)}function Y(R){if(!z.value)return;const h=w.scale||1,L=(R.clientX-_.value)/h,X=(R.clientY-x.value)/h;let[ne,ye,ge,ie]=z.value;const ke=l.value;ke.includes("w")&&(ne+=L),ke.includes("e")&&(ge+=L),ke.includes("n")&&(ye+=X),ke.includes("s")&&(ie+=X),ne>ge&&([ne,ge]=[ge,ne]),ye>ie&&([ye,ie]=[ie,ye]);const ve=10;ge-ne<ve||ie-ye<ve||(N.value=[ne,ye,ge,ie])}function Se(R){if(!z.value)return;const h=w.scale||1,L=(R.clientX-_.value)/h,X=(R.clientY-x.value)/h;let[ne,ye,ge,ie]=z.value;const ke=l.value;ke.includes("w")&&(ne+=L),ke.includes("e")&&(ge+=L),ke.includes("n")&&(ye+=X),ke.includes("s")&&(ie+=X),ne>ge&&([ne,ge]=[ge,ne]),ye>ie&&([ye,ie]=[ie,ye]);const ve=w.imageWidth||2e3,Pe=w.imageHeight||2e3;ne=Math.max(0,Math.round(ne)),ye=Math.max(0,Math.round(ye)),ge=Math.min(ve,Math.round(ge)),ie=Math.min(Pe,Math.round(ie));const De=10;if(ge-ne<De||ie-ye<De){console.warn("调整后尺寸过小，已撤销"),A.value=!1,$.value=-1,z.value=null;return}Q("resizeEnd",$.value,[ne,ye,ge,ie]),A.value=!1,$.value=-1,z.value=null,N.value=null}function g(R,h){if(w.isBrushMode||h.button!==0)return;h.preventDefault(),h.stopPropagation(),document.removeEventListener("mousemove",E),document.removeEventListener("mouseup",P),ae.value=!0,le.value=R;const L=w.bubbles[R];if(!L||!j.value)return;const[X,ne,ye,ge]=L.coords,ie=w.scale||1,ke=j.value.getBoundingClientRect();G.value=ke.left+(X+ye)/2*ie,F.value=ke.top+(ne+ge)/2*ie;const ve=h.clientX-G.value,Pe=h.clientY-F.value;ee.value=Math.atan2(Pe,ve)*180/Math.PI,be.value=L.rotationAngle||0,Z.value=L.rotationAngle||0,Q("rotateStart",R,h),document.body.classList.add("rotating-box"),document.addEventListener("mousemove",E),document.addEventListener("mouseup",P),console.log(`开始旋转气泡 #${R+1}，初始角度: ${be.value}°`)}function b(R){const h=R.clientX-G.value,L=R.clientY-F.value,ne=Math.atan2(L,h)*180/Math.PI-ee.value;let ye=be.value+ne;for(;ye>180;)ye-=360;for(;ye<-180;)ye+=360;R.shiftKey&&(ye=Math.round(ye/15)*15),Z.value=ye}function M(R){document.body.classList.remove("rotating-box");const h=le.value,L=Z.value;Q("rotateEnd",h,L),ae.value=!1,le.value=-1,console.log(`气泡 #${h+1} 旋转完成，角度: ${L}°`)}function D(R){const h=te(R);if(!h)return;const L=w.imageWidth||2e3,X=w.imageHeight||2e3;h.x<0||h.x>L||h.y<0||h.y>X||(B.value=!0,S.value=h.x,v.value=h.y,I.value=[h.x,h.y,h.x,h.y],document.addEventListener("mousemove",E),document.addEventListener("mouseup",P),console.log("开始绘制新框:",h.x.toFixed(1),h.y.toFixed(1)))}function O(R){const h=te(R);!h||!I.value||(I.value=[S.value,v.value,h.x,h.y])}function re(R){const h=te(R);if(T.value&&(T.value=!1,document.body.classList.remove("middle-button-drawing")),!h||!I.value){B.value=!1,I.value=null;return}const L=w.imageWidth||2e3,X=w.imageHeight||2e3,ne=Math.max(0,Math.round(Math.min(S.value,h.x))),ye=Math.max(0,Math.round(Math.min(v.value,h.y))),ge=Math.min(L,Math.round(Math.max(S.value,h.x))),ie=Math.min(X,Math.round(Math.max(v.value,h.y))),ke=10;if(ge-ne<ke||ie-ye<ke){console.log("绘制的框太小，已忽略"),B.value=!1,I.value=null;return}console.log("完成绘制新框:",[ne,ye,ge,ie]),Q("drawBubble",[ne,ye,ge,ie]),B.value=!1,I.value=null}function E(R){o.value?U(R):A.value?Y(R):ae.value?b(R):B.value&&O(R)}function P(R){document.removeEventListener("mousemove",E),document.removeEventListener("mouseup",P),(R.button===1||T.value)&&(T.value=!1,document.body.classList.remove("middle-button-drawing")),o.value?fe(R):A.value?Se(R):ae.value?M():B.value&&re(R)}return ut(()=>{}),It(()=>{document.removeEventListener("mousemove",E),document.removeEventListener("mouseup",P),document.body.classList.remove("middle-button-drawing"),document.body.classList.remove("rotating-box")}),(R,h)=>(V(),J("div",{class:Le(["bubble-overlay",{"brush-mode":n.isBrushMode}]),ref_key:"overlayRef",ref:j,onMousedown:m},[(V(!0),J(Ze,null,et(n.bubbles,(L,X)=>(V(),J("div",{key:X,class:Le(["bubble-highlight-box",{selected:X===n.selectedIndex,"multi-selected":n.selectedIndices.length>1&&n.selectedIndices.includes(X)&&X!==n.selectedIndex}]),style:it(p(L,X)),"data-index":X,"data-coords":JSON.stringify(L.coords),"data-rotation":L.rotationAngle||0,onClick:nt(ne=>se(X,ne),["stop"]),onMousedown:nt(ne=>C(X,ne),["stop"])},[e("span",Nd,xe(X+1),1),X===n.selectedIndex?(V(),J(Ze,{key:0},[e("div",{class:"resize-handle nw","data-handle":"nw","data-parent-index":X,onMousedown:nt(ne=>K("nw",X,ne),["stop"])},null,40,Wd),e("div",{class:"resize-handle n","data-handle":"n","data-parent-index":X,onMousedown:nt(ne=>K("n",X,ne),["stop"])},null,40,Kd),e("div",{class:"resize-handle ne","data-handle":"ne","data-parent-index":X,onMousedown:nt(ne=>K("ne",X,ne),["stop"])},null,40,qd),e("div",{class:"resize-handle e","data-handle":"e","data-parent-index":X,onMousedown:nt(ne=>K("e",X,ne),["stop"])},null,40,Hd),e("div",{class:"resize-handle se","data-handle":"se","data-parent-index":X,onMousedown:nt(ne=>K("se",X,ne),["stop"])},null,40,Jd),e("div",{class:"resize-handle s","data-handle":"s","data-parent-index":X,onMousedown:nt(ne=>K("s",X,ne),["stop"])},null,40,Yd),e("div",{class:"resize-handle sw","data-handle":"sw","data-parent-index":X,onMousedown:nt(ne=>K("sw",X,ne),["stop"])},null,40,Xd),e("div",{class:"resize-handle w","data-handle":"w","data-parent-index":X,onMousedown:nt(ne=>K("w",X,ne),["stop"])},null,40,jd),h[0]||(h[0]=e("div",{class:"rotate-line"},null,-1)),e("div",{class:"rotate-handle",title:"拖拽旋转","data-parent-index":X,onMousedown:nt(ne=>g(X,ne),["stop"])},null,40,Gd)],64)):Te("",!0)],46,Vd))),128)),I.value?(V(),J("div",{key:0,class:"drawing-rect",style:it(f())},null,4)):Te("",!0)],34))}}),qn=je(Zd,[["__scopeId","data-v-a3e510ac"]]),Qd={key:0,class:"kana-keyboard"},eg={class:"kana-keyboard-header"},tg={class:"kana-keyboard-tabs"},ng=["onClick"],og={class:"kana-keyboard-options"},ag={class:"kana-mode-select"},sg={class:"kana-target-select"},lg={class:"kana-table"},ig={class:"row-label"},rg=["onClick"],ug={class:"kana-hiragana"},cg={class:"kana-katakana"},dg={class:"kana-table"},gg={class:"row-label"},pg=["onClick"],bg={class:"kana-hiragana"},vg={class:"kana-katakana"},mg={class:"kana-table combo-table"},fg={class:"row-label"},hg=["onClick"],yg={class:"kana-hiragana"},xg={class:"kana-katakana"},Sg={class:"special-chars-grid"},kg=["onClick"],_g={key:0,class:"char-label"},Cg=Ge({__name:"JapaneseKeyboard",props:{visible:{type:Boolean,default:!1},defaultTarget:{default:"original"}},emits:["close","insert","delete"],setup(n,{emit:r}){const u=n,o=r,a=y("basic"),i=y("hiragana"),t=y(u.defaultTarget),s=y(null),k=[{label:"原文",value:"original"},{label:"译文",value:"translated"}],A=[{id:"basic",label:"基本"},{id:"dakuten",label:"浊/半浊音"},{id:"combo",label:"拗音"},{id:"special",label:"特殊"}],$=[{label:"あ行",chars:[{h:"あ",k:"ア"},{h:"い",k:"イ"},{h:"う",k:"ウ"},{h:"え",k:"エ"},{h:"お",k:"オ"}]},{label:"か行",chars:[{h:"か",k:"カ"},{h:"き",k:"キ"},{h:"く",k:"ク"},{h:"け",k:"ケ"},{h:"こ",k:"コ"}]},{label:"さ行",chars:[{h:"さ",k:"サ"},{h:"し",k:"シ"},{h:"す",k:"ス"},{h:"せ",k:"セ"},{h:"そ",k:"ソ"}]},{label:"た行",chars:[{h:"た",k:"タ"},{h:"ち",k:"チ"},{h:"つ",k:"ツ"},{h:"て",k:"テ"},{h:"と",k:"ト"}]},{label:"な行",chars:[{h:"な",k:"ナ"},{h:"に",k:"ニ"},{h:"ぬ",k:"ヌ"},{h:"ね",k:"ネ"},{h:"の",k:"ノ"}]},{label:"は行",chars:[{h:"は",k:"ハ"},{h:"ひ",k:"ヒ"},{h:"ふ",k:"フ"},{h:"へ",k:"ヘ"},{h:"ほ",k:"ホ"}]},{label:"ま行",chars:[{h:"ま",k:"マ"},{h:"み",k:"ミ"},{h:"む",k:"ム"},{h:"め",k:"メ"},{h:"も",k:"モ"}]},{label:"や行",chars:[{h:"や",k:"ヤ"},null,{h:"ゆ",k:"ユ"},null,{h:"よ",k:"ヨ"}]},{label:"ら行",chars:[{h:"ら",k:"ラ"},{h:"り",k:"リ"},{h:"る",k:"ル"},{h:"れ",k:"レ"},{h:"ろ",k:"ロ"}]},{label:"わ行",chars:[{h:"わ",k:"ワ"},null,null,null,{h:"を",k:"ヲ"}]},{label:"ん",chars:[{h:"ん",k:"ン"},null,null,null,null]}],N=[{label:"が行",chars:[{h:"が",k:"ガ"},{h:"ぎ",k:"ギ"},{h:"ぐ",k:"グ"},{h:"げ",k:"ゲ"},{h:"ご",k:"ゴ"}]},{label:"ざ行",chars:[{h:"ざ",k:"ザ"},{h:"じ",k:"ジ"},{h:"ず",k:"ズ"},{h:"ぜ",k:"ゼ"},{h:"ぞ",k:"ゾ"}]},{label:"だ行",chars:[{h:"だ",k:"ダ"},{h:"ぢ",k:"ヂ"},{h:"づ",k:"ヅ"},{h:"で",k:"デ"},{h:"ど",k:"ド"}]},{label:"ば行",chars:[{h:"ば",k:"バ"},{h:"び",k:"ビ"},{h:"ぶ",k:"ブ"},{h:"べ",k:"ベ"},{h:"ぼ",k:"ボ"}]},{label:"ぱ行",chars:[{h:"ぱ",k:"パ"},{h:"ぴ",k:"ピ"},{h:"ぷ",k:"プ"},{h:"ぺ",k:"ペ"},{h:"ぽ",k:"ポ"}]}],ae=[{label:"きゃ行",chars:[{h:"きゃ",k:"キャ"},{h:"きゅ",k:"キュ"},{h:"きょ",k:"キョ"}]},{label:"しゃ行",chars:[{h:"しゃ",k:"シャ"},{h:"しゅ",k:"シュ"},{h:"しょ",k:"ショ"}]},{label:"ちゃ行",chars:[{h:"ちゃ",k:"チャ"},{h:"ちゅ",k:"チュ"},{h:"ちょ",k:"チョ"}]},{label:"にゃ行",chars:[{h:"にゃ",k:"ニャ"},{h:"にゅ",k:"ニュ"},{h:"にょ",k:"ニョ"}]},{label:"ひゃ行",chars:[{h:"ひゃ",k:"ヒャ"},{h:"ひゅ",k:"ヒュ"},{h:"ひょ",k:"ヒョ"}]},{label:"みゃ行",chars:[{h:"みゃ",k:"ミャ"},{h:"みゅ",k:"ミュ"},{h:"みょ",k:"ミョ"}]},{label:"りゃ行",chars:[{h:"りゃ",k:"リャ"},{h:"りゅ",k:"リュ"},{h:"りょ",k:"リョ"}]},{label:"ぎゃ行",chars:[{h:"ぎゃ",k:"ギャ"},{h:"ぎゅ",k:"ギュ"},{h:"ぎょ",k:"ギョ"}]},{label:"じゃ行",chars:[{h:"じゃ",k:"ジャ"},{h:"じゅ",k:"ジュ"},{h:"じょ",k:"ジョ"}]},{label:"びゃ行",chars:[{h:"びゃ",k:"ビャ"},{h:"びゅ",k:"ビュ"},{h:"びょ",k:"ビョ"}]},{label:"ぴゃ行",chars:[{h:"ぴゃ",k:"ピャ"},{h:"ぴゅ",k:"ピュ"},{h:"ぴょ",k:"ピョ"}]}],le=[{char:"っ",label:"促音"},{char:"ッ",label:"促音"},{char:"ー",label:"长音"},{char:"〜",label:"波浪"},{char:"。",label:"句号"},{char:"、",label:"顿号"},{char:"「",label:"引号"},{char:"」",label:"引号"},{char:"『",label:"双引"},{char:"』",label:"双引"},{char:"…",label:"省略"},{char:"・",label:"中点"},{char:"！",label:"感叹"},{char:"？",label:"问号"},{char:"♪",label:"音符"},{char:"♡",label:"心形"},{char:"★",label:"星形"},{char:"☆",label:"空星"},{char:"ぁ",label:"小あ"},{char:"ぃ",label:"小い"},{char:"ぅ",label:"小う"},{char:"ぇ",label:"小え"},{char:"ぉ",label:"小お"},{char:"ァ",label:"小ア"},{char:"ィ",label:"小イ"},{char:"ゥ",label:"小ウ"},{char:"ェ",label:"小エ"},{char:"ォ",label:"小オ"},{char:"ゃ",label:"小や"},{char:"ゅ",label:"小ゆ"},{char:"ょ",label:"小よ"},{char:"ャ",label:"小ヤ"},{char:"ュ",label:"小ユ"},{char:"ョ",label:"小ヨ"}];function Z(){o("close")}function w(H){const d=i.value==="hiragana"?H.h:H.k;s.value=H.h,setTimeout(()=>{s.value=null},100),o("insert",d,t.value)}function Q(H){s.value=H,setTimeout(()=>{s.value=null},100),o("insert",H,t.value)}function j(){o("delete",t.value)}return(H,d)=>n.visible?(V(),J("div",Qd,[e("div",eg,[d[3]||(d[3]=e("span",{class:"kana-keyboard-title"},"50音键盘",-1)),e("div",tg,[(V(),J(Ze,null,et(A,l=>e("button",{key:l.id,class:Le(["kana-tab",{active:a.value===l.id}]),onClick:_=>a.value=l.id},xe(l.label),11,ng)),64))]),e("button",{class:"kana-keyboard-close",onClick:Z},"✕")]),e("div",og,[e("div",ag,[e("label",null,[ue(e("input",{type:"radio",name:"kanaMode",value:"hiragana","onUpdate:modelValue":d[0]||(d[0]=l=>i.value=l)},null,512),[[On,i.value]]),d[4]||(d[4]=Ke(" 平假名 ",-1))]),e("label",null,[ue(e("input",{type:"radio",name:"kanaMode",value:"katakana","onUpdate:modelValue":d[1]||(d[1]=l=>i.value=l)},null,512),[[On,i.value]]),d[5]||(d[5]=Ke(" 片假名 ",-1))])]),e("div",sg,[d[6]||(d[6]=e("label",null,"输入到：",-1)),Ie(We,{modelValue:t.value,"onUpdate:modelValue":d[2]||(d[2]=l=>t.value=l),options:k},null,8,["modelValue"])])]),e("div",{class:Le(["kana-tab-content",{active:a.value==="basic"}])},[e("table",lg,[d[7]||(d[7]=e("thead",null,[e("tr",null,[e("th"),e("th",null,"あ段"),e("th",null,"い段"),e("th",null,"う段"),e("th",null,"え段"),e("th",null,"お段")])],-1)),e("tbody",null,[(V(),J(Ze,null,et($,l=>e("tr",{key:l.label},[e("td",ig,xe(l.label),1),(V(!0),J(Ze,null,et(l.chars,(_,x)=>(V(),J("td",{key:x},[_?(V(),J("button",{key:0,class:Le(["kana-key",{pressed:s.value===_.h}]),onClick:z=>w(_)},[e("span",ug,xe(_.h),1),e("span",cg,xe(_.k),1)],10,rg)):Te("",!0)]))),128))])),64))])])],2),e("div",{class:Le(["kana-tab-content",{active:a.value==="dakuten"}])},[e("table",dg,[d[8]||(d[8]=e("thead",null,[e("tr",null,[e("th"),e("th",null,"あ段"),e("th",null,"い段"),e("th",null,"う段"),e("th",null,"え段"),e("th",null,"お段")])],-1)),e("tbody",null,[(V(),J(Ze,null,et(N,l=>e("tr",{key:l.label},[e("td",gg,xe(l.label),1),(V(!0),J(Ze,null,et(l.chars,(_,x)=>(V(),J("td",{key:x},[_?(V(),J("button",{key:0,class:Le(["kana-key",{pressed:s.value===_.h}]),onClick:z=>w(_)},[e("span",bg,xe(_.h),1),e("span",vg,xe(_.k),1)],10,pg)):Te("",!0)]))),128))])),64))])])],2),e("div",{class:Le(["kana-tab-content",{active:a.value==="combo"}])},[e("table",mg,[d[9]||(d[9]=e("thead",null,[e("tr",null,[e("th"),e("th",null,"ゃ"),e("th",null,"ゅ"),e("th",null,"ょ")])],-1)),e("tbody",null,[(V(),J(Ze,null,et(ae,l=>e("tr",{key:l.label},[e("td",fg,xe(l.label),1),(V(!0),J(Ze,null,et(l.chars,(_,x)=>(V(),J("td",{key:x},[_?(V(),J("button",{key:0,class:Le(["kana-key",{pressed:s.value===_.h}]),onClick:z=>w(_)},[e("span",yg,xe(_.h),1),e("span",xg,xe(_.k),1)],10,hg)):Te("",!0)]))),128))])),64))])])],2),e("div",{class:Le(["kana-tab-content",{active:a.value==="special"}])},[e("div",Sg,[(V(),J(Ze,null,et(le,l=>e("button",{key:l.char,class:Le(["kana-key special-key",{pressed:s.value===l.char}]),onClick:_=>Q(l.char)},[Ke(xe(l.char)+" ",1),l.label?(V(),J("span",_g,xe(l.label),1)):Te("",!0)],10,kg)),64))])],2),e("div",{class:"kana-keyboard-footer"},[e("button",{class:"kana-backspace",onClick:j},"⌫ 退格")])])):Te("",!0)}}),wg=je(Cg,[["__scopeId","data-v-ebfc2125"]]),$g={class:"edit-panel-content"},Tg={class:"text-column original-text-column text-block"},Ig={class:"text-column translated-text-column text-block"},Dg={class:"style-settings-section text-block"},Rg={class:"office-toolbar"},Mg={class:"toolbar-row toolbar-row-top"},Bg={class:"combo-control font-control"},Eg={class:"combo-control size-control"},Pg={class:"size-input-wrap"},Ag=["min","max","step"],Fg={class:"toolbar-row toolbar-row-actions"},Lg={class:"toolbar-icon-group","aria-label":"排版方向"},Ug=["data-active"],Og=["data-active"],zg={class:"toolbar-color-group"},Vg={class:"toolbar-color-picker",title:"文字颜色"},Ng={class:"toolbar-inpaint-group",title:"背景修复方式"},Wg={class:"toolbar-stroke-cluster"},Kg=["data-active"],qg={class:"toolbar-row toolbar-row-bottom"},Hg={class:"toolbar-rotation-group",title:"旋转角度"},Jg={class:"toolbar-position-group",title:"位置调整"},Yg={class:"toolbar-position-value"},Xg={class:"fontsize-presets-panel"},jg={class:"font-size-presets"},Gg=["onClick"],Bt=2,Zg=Ge({__name:"BubbleEditor",props:{bubble:{},bubbleIndex:{}},emits:["update","reRender","ocrRecognize","reTranslate","applyBubble","resetCurrent"],setup(n,{emit:r}){const u=n,o=r,a=gt(),i={originalText:"",translatedText:"",fontSize:24,fontFamily:"fonts/STSONG.TTF",textDirection:"auto",textColor:"#231816",fillColor:"#FFFFFF",strokeEnabled:!0,strokeColor:"#FFFFFF",strokeWidth:3,rotationAngle:0,inpaintMethod:"solid",position:{x:0,y:0}},t=y(""),s=y(""),k=y(24),A=y("fonts/STSONG.TTF"),$=y("auto"),N=y("#231816"),ae=y("#FFFFFF"),le=y(!0),Z=y("#FFFFFF"),w=y(3),Q=y(0),j=y("solid"),H=y(0),d=y(0),l=y(null),_=y(null),x=y(null),z=y(null),ee=y(null),be=y(!1),G=y("original"),F=y([{name:"华文宋体",path:"fonts/STSONG.TTF"},{name:"华文楷体",path:"fonts/STKAITI.TTF"},{name:"华文细黑",path:"fonts/STXIHEI.TTF"},{name:"黑体",path:"fonts/SIMHEI.TTF"},{name:"宋体",path:"fonts/SIMSUN.TTC"}]),B=y([]),S=oe(()=>u.bubble?u.bubble.coords[0]+H.value:0),v=oe(()=>u.bubble?u.bubble.coords[1]+d.value:0),I=oe(()=>{const Ce=[{label:"系统字体",options:F.value.map(q=>({label:q.name,value:q.path}))}];return B.value.length>0&&Ce.push({label:"自定义字体",options:B.value.map(q=>({label:q.name,value:q.path}))}),Ce}),T=[{label:"纯色填充",value:"solid"},{label:"LAMA修复(漫画)",value:"lama_mpe"},{label:"LAMA修复(通用)",value:"litelama"}];function p(Ce){const q=Ce||i;t.value=q.originalText,s.value=q.translatedText,k.value=q.fontSize,A.value=q.fontFamily,$.value=q.textDirection,N.value=q.textColor,ae.value=q.fillColor,le.value=q.strokeEnabled,Z.value=q.strokeColor,w.value=q.strokeWidth,Q.value=q.rotationAngle,j.value=q.inpaintMethod,H.value=q.position?.x||0,d.value=q.position?.y||0}Re(()=>u.bubble,Ce=>{p(Ce)},{deep:!0,immediate:!0});function f(){o("update",{originalText:t.value})}function te(){o("update",{translatedText:s.value})}function se(){navigator.clipboard.writeText(t.value)}function m(){navigator.clipboard.writeText(s.value)}function C(){o("update",{fontSize:k.value})}function c(Ce){k.value=Ce,o("update",{fontSize:Ce})}function U(){k.value=Math.min(An,k.value+Xt),o("update",{fontSize:k.value})}function fe(){k.value=Math.max(Fn,k.value-Xt),o("update",{fontSize:k.value})}function K(){o("update",{fontFamily:A.value})}function Y(Ce){$.value=Ce,o("update",{textDirection:Ce})}function Se(){x.value?.click()}function g(){o("update",{textColor:N.value})}function b(){z.value?.click()}function M(){o("update",{fillColor:ae.value})}function D(){ee.value?.click()}function O(){o("update",{strokeColor:Z.value})}function re(){le.value=!le.value,o("update",{strokeEnabled:le.value})}function E(){o("update",{strokeWidth:w.value})}function P(){o("update",{inpaintMethod:j.value})}function R(){o("update",{rotationAngle:Q.value})}function h(){Q.value=Math.max(-180,Q.value-5),o("update",{rotationAngle:Q.value})}function L(){Q.value=Math.min(180,Q.value+5),o("update",{rotationAngle:Q.value})}function X(){Q.value=0,o("update",{rotationAngle:0})}function ne(){H.value-=Bt,o("update",{position:{x:H.value,y:d.value}})}function ye(){H.value+=Bt,o("update",{position:{x:H.value,y:d.value}})}function ge(){d.value-=Bt,o("update",{position:{x:H.value,y:d.value}})}function ie(){d.value+=Bt,o("update",{position:{x:H.value,y:d.value}})}function ke(){H.value=0,d.value=0,o("update",{position:{x:0,y:0}})}function ve(){o("applyBubble",u.bubbleIndex)}function Pe(){a.updateAllBubbles({fontSize:k.value,fontFamily:A.value,textDirection:$.value,textColor:N.value,fillColor:ae.value,strokeEnabled:le.value,strokeColor:Z.value,strokeWidth:w.value,inpaintMethod:j.value}),console.log("样式已应用到所有气泡"),o("reRender")}function De(){o("resetCurrent",u.bubbleIndex)}function _e(){o("ocrRecognize",u.bubbleIndex)}function ce(){o("reTranslate",u.bubbleIndex)}function $e(){be.value=!be.value}function Ue(Ce,q){if(q==="original"){const pe=l.value;if(pe){const Me=pe.selectionStart||t.value.length,Oe=pe.selectionEnd||t.value.length,ot=t.value;t.value=ot.slice(0,Me)+Ce+ot.slice(Oe),ct(()=>{pe.selectionStart=pe.selectionEnd=Me+Ce.length,pe.focus()}),o("update",{originalText:t.value})}}else{const pe=_.value;if(pe){const Me=pe.selectionStart||s.value.length,Oe=pe.selectionEnd||s.value.length,ot=s.value;s.value=ot.slice(0,Me)+Ce+ot.slice(Oe),ct(()=>{pe.selectionStart=pe.selectionEnd=Me+Ce.length,pe.focus()}),o("update",{translatedText:s.value})}}}function Be(Ce){if(Ce==="original"){const q=l.value;if(q&&t.value.length>0){const pe=q.selectionStart||t.value.length,Me=q.selectionEnd||t.value.length,Oe=t.value;pe===Me&&pe>0?(t.value=Oe.slice(0,pe-1)+Oe.slice(Me),ct(()=>{q.selectionStart=q.selectionEnd=pe-1,q.focus()})):pe!==Me&&(t.value=Oe.slice(0,pe)+Oe.slice(Me),ct(()=>{q.selectionStart=q.selectionEnd=pe,q.focus()})),o("update",{originalText:t.value})}}else{const q=_.value;if(q&&s.value.length>0){const pe=q.selectionStart||s.value.length,Me=q.selectionEnd||s.value.length,Oe=s.value;pe===Me&&pe>0?(s.value=Oe.slice(0,pe-1)+Oe.slice(Me),ct(()=>{q.selectionStart=q.selectionEnd=pe-1,q.focus()})):pe!==Me&&(s.value=Oe.slice(0,pe)+Oe.slice(Me),ct(()=>{q.selectionStart=q.selectionEnd=pe,q.focus()})),o("update",{translatedText:s.value})}}}async function Fe(){try{const Ce=await Yo();if(Ce.fonts){const q=[],pe=[];for(const Me of Ce.fonts){const Oe={name:typeof Me=="string"?Me:Me.display_name||Me.file_name||"",path:typeof Me=="string"?Me:Me.path};Oe.path.startsWith("fonts/")?q.push(Oe):pe.push(Oe)}q.length>0&&(F.value=q),B.value=pe}}catch(Ce){console.error("加载字体列表失败:",Ce)}}return ut(()=>{Fe()}),(Ce,q)=>(V(),J("div",$g,[e("div",Tg,[e("div",{class:"text-column-header"},[q[13]||(q[13]=e("span",{class:"column-title"},"🇯🇵 日语原文 (OCR结果)",-1)),e("button",{class:"re-ocr-btn",onClick:_e,title:"重新OCR此气泡"},"🔄")]),ue(e("textarea",{ref_key:"originalTextInput",ref:l,"onUpdate:modelValue":q[0]||(q[0]=pe=>t.value=pe),class:"text-editor original-editor",placeholder:"OCR识别的日语原文...",spellcheck:"false",onInput:f},null,544),[[Ee,t.value]]),e("div",{class:"text-actions"},[e("button",{class:"copy-btn",onClick:se},"📋 复制"),e("button",{class:"keyboard-toggle-btn",onClick:$e,title:"显示/隐藏50音键盘"}," ⌨️ 50音 ")]),Ie(wg,{visible:be.value,"default-target":G.value,onClose:q[1]||(q[1]=pe=>be.value=!1),onInsert:Ue,onDelete:Be},null,8,["visible","default-target"])]),e("div",Ig,[e("div",{class:"text-column-header"},[q[14]||(q[14]=e("span",{class:"column-title"},"🇨🇳 中文译文",-1)),e("button",{class:"re-translate-btn",onClick:ce,title:"重新翻译此气泡"}," 🔄 ")]),ue(e("textarea",{ref_key:"translatedTextInput",ref:_,"onUpdate:modelValue":q[2]||(q[2]=pe=>s.value=pe),class:"text-editor translated-editor",placeholder:"翻译后的中文...",spellcheck:"false",onInput:te},null,544),[[Ee,s.value]]),e("div",{class:"text-actions"},[e("button",{class:"copy-btn",onClick:m},"📋 复制"),e("button",{class:"apply-text-btn",onClick:ve},"✓ 应用文本")])]),e("div",Dg,[e("div",Rg,[e("div",Mg,[e("div",Bg,[q[15]||(q[15]=e("label",null,"字体",-1)),Ie(We,{modelValue:A.value,"onUpdate:modelValue":q[3]||(q[3]=pe=>A.value=pe),groups:I.value,title:"字体",onChange:K},null,8,["modelValue","groups"])]),e("div",Eg,[q[16]||(q[16]=e("label",null,"字号",-1)),e("div",Pg,[ue(e("input",{type:"number","onUpdate:modelValue":q[4]||(q[4]=pe=>k.value=pe),class:"toolbar-fontsize-input",min:he(Fn),max:he(An),step:he(Xt),title:"字号",onChange:C},null,40,Ag),[[Ee,k.value,void 0,{number:!0}]]),e("div",{class:"toolbar-fontsize-btns"},[e("button",{class:"toolbar-fontsize-btn",onClick:U,title:"增大字号"}," A+ "),e("button",{class:"toolbar-fontsize-btn",onClick:fe,title:"减小字号"}," A- ")])])])]),e("div",Fg,[e("div",Lg,[e("button",{class:"toolbar-btn","data-active":$.value==="vertical",onClick:q[5]||(q[5]=pe=>Y("vertical")),title:"竖向排版"},[...q[17]||(q[17]=[e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("path",{d:"M8 2v12M8 2L5 5M8 2l3 3",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])],8,Ug),e("button",{class:"toolbar-btn","data-active":$.value==="horizontal",onClick:q[6]||(q[6]=pe=>Y("horizontal")),title:"横向排版"},[...q[18]||(q[18]=[e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("path",{d:"M2 8h12M14 8l-3-3M14 8l-3 3",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])],8,Og)]),q[24]||(q[24]=e("div",{class:"toolbar-divider vertical"},null,-1)),e("div",zg,[e("div",Vg,[e("button",{class:"toolbar-btn toolbar-color-btn",onClick:Se},[q[19]||(q[19]=e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("text",{x:"3",y:"11","font-size":"10","font-weight":"bold",fill:"currentColor"},"A")],-1)),e("span",{class:"color-indicator",style:it({background:N.value})},null,4)]),ue(e("input",{ref_key:"textColorInput",ref:x,type:"color","onUpdate:modelValue":q[7]||(q[7]=pe=>N.value=pe),class:"hidden-color-input",onChange:g},null,544),[[Ee,N.value]])])]),q[25]||(q[25]=e("div",{class:"toolbar-divider vertical"},null,-1)),e("div",Ng,[Ie(We,{modelValue:j.value,"onUpdate:modelValue":q[8]||(q[8]=pe=>j.value=pe),options:T,onChange:P},null,8,["modelValue"]),e("div",{class:Le(["toolbar-color-picker toolbar-solid-color-options",{hidden:j.value!=="solid"}])},[e("button",{class:"toolbar-btn toolbar-color-btn",onClick:b},[q[20]||(q[20]=e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("rect",{x:"2",y:"2",width:"12",height:"12",rx:"2",fill:"none",stroke:"currentColor","stroke-width":"1.2"}),e("rect",{x:"4",y:"4",width:"8",height:"8",rx:"1",fill:"currentColor",opacity:"0.3"})],-1)),e("span",{class:"color-indicator",style:it({background:ae.value})},null,4)]),ue(e("input",{ref_key:"fillColorInput",ref:z,type:"color","onUpdate:modelValue":q[9]||(q[9]=pe=>ae.value=pe),class:"hidden-color-input",onChange:M},null,544),[[Ee,ae.value]])],2)]),q[26]||(q[26]=e("div",{class:"toolbar-divider vertical"},null,-1)),e("div",Wg,[e("button",{class:"toolbar-btn","data-active":le.value,onClick:re,title:"文字描边"},[...q[21]||(q[21]=[e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("text",{x:"3",y:"12","font-size":"11","font-weight":"bold",stroke:"currentColor","stroke-width":"2",fill:"none"}," A "),e("text",{x:"3",y:"12","font-size":"11","font-weight":"bold",fill:"currentColor"},"A")],-1)])],8,Kg),e("div",{class:Le(["toolbar-color-picker toolbar-stroke-options",{hidden:!le.value}]),title:"描边颜色"},[e("button",{class:"toolbar-btn toolbar-color-btn",onClick:D},[q[22]||(q[22]=e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("circle",{cx:"8",cy:"8",r:"5",fill:"none",stroke:"currentColor","stroke-width":"2"})],-1)),e("span",{class:"color-indicator",style:it({background:Z.value})},null,4)]),ue(e("input",{ref_key:"strokeColorInput",ref:ee,type:"color","onUpdate:modelValue":q[10]||(q[10]=pe=>Z.value=pe),class:"hidden-color-input",onChange:O},null,544),[[Ee,Z.value]])],2),e("div",{class:Le(["toolbar-stroke-width toolbar-stroke-options",{hidden:!le.value}]),title:"描边宽度"},[ue(e("input",{type:"number","onUpdate:modelValue":q[11]||(q[11]=pe=>w.value=pe),class:"toolbar-mini-input",min:"0",max:"10",onChange:E},null,544),[[Ee,w.value,void 0,{number:!0}]]),q[23]||(q[23]=e("span",{class:"toolbar-unit"},"px",-1))],2)])]),e("div",qg,[e("div",Hg,[e("button",{class:"toolbar-btn",onClick:h,title:"逆时针旋转"},[...q[27]||(q[27]=[e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("path",{d:"M2 8a6 6 0 1 1 1.5 4",stroke:"currentColor","stroke-width":"1.5",fill:"none"}),e("path",{d:"M2 5v3.5h3.5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),ue(e("input",{type:"number","onUpdate:modelValue":q[12]||(q[12]=pe=>Q.value=pe),class:"toolbar-mini-input toolbar-rotation-input",min:"-180",max:"180",step:"5",onChange:R},null,544),[[Ee,Q.value,void 0,{number:!0}]]),q[29]||(q[29]=e("span",{class:"toolbar-unit"},"°",-1)),e("button",{class:"toolbar-btn",onClick:L,title:"顺时针旋转"},[...q[28]||(q[28]=[e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("path",{d:"M14 8a6 6 0 1 0-1.5 4",stroke:"currentColor","stroke-width":"1.5",fill:"none"}),e("path",{d:"M14 5v3.5h-3.5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),e("button",{class:"toolbar-btn toolbar-small-btn",onClick:X,title:"重置旋转"}," 0 ")]),q[35]||(q[35]=e("div",{class:"toolbar-divider vertical"},null,-1)),e("div",Jg,[e("button",{class:"toolbar-btn",onClick:ne,title:"左移"},[...q[30]||(q[30]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("path",{d:"M10 3L5 8l5 5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),e("button",{class:"toolbar-btn",onClick:ye,title:"右移"},[...q[31]||(q[31]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("path",{d:"M6 3l5 5-5 5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),e("button",{class:"toolbar-btn",onClick:ge,title:"上移"},[...q[32]||(q[32]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("path",{d:"M3 10l5-5 5 5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),e("button",{class:"toolbar-btn",onClick:ie,title:"下移"},[...q[33]||(q[33]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("path",{d:"M3 6l5 5 5-5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),e("span",Yg,[e("span",null,xe(S.value),1),q[34]||(q[34]=Ke(",",-1)),e("span",null,xe(v.value),1)]),e("button",{class:"toolbar-btn toolbar-small-btn",onClick:ke,title:"重置位置"}," ⌂ ")])])]),e("details",Xg,[q[36]||(q[36]=e("summary",null,"字号预设",-1)),e("div",jg,[(V(!0),J(Ze,null,et(he(Bo),pe=>(V(),J("button",{key:pe,class:Le(["preset-btn",{active:k.value===pe}]),onClick:Me=>c(pe)},xe(pe),11,Gg))),128))])]),e("div",{class:"edit-action-buttons"},[e("button",{class:"btn-apply",onClick:ve},"应用"),e("button",{class:"btn-apply-all",onClick:Pe},"应用全部"),e("button",{class:"btn-reset",onClick:De},"重置")])])]))}}),Qg=je(Zg,[["__scopeId","data-v-75af88de"]]),ep={class:"edit-toolbar-wrapper"},tp={class:"edit-toolbar toolbar-row-1"},np={class:"image-navigator"},op=["disabled"],ap=["disabled"],sp={class:"bubble-navigator"},lp=["disabled"],ip={class:"bubble-indicator"},rp={id:"currentBubbleNum"},up={id:"totalBubbleNum"},cp=["disabled"],dp={class:"view-controls"},gp={key:0,viewBox:"0 0 20 20",width:"16",height:"16"},pp={key:1,viewBox:"0 0 20 20",width:"16",height:"16"},bp={id:"zoomLevel"},vp={class:"edit-toolbar toolbar-row-2"},mp={class:"annotation-tools"},fp=["disabled"],hp=["disabled"],yp={key:0,class:"brush-size-indicator"},xp={key:1,class:"brush-mode-hint"},Sp={class:"edit-progress-info"},kp={class:"edit-progress-text"},_p={class:"edit-progress-count"},Cp={class:"edit-progress-bar"},wp={class:"quick-actions"},$p=Ge({__name:"EditToolbar",props:{currentImageIndex:{},imageCount:{},canGoPrevious:{type:Boolean},canGoNext:{type:Boolean},showThumbnails:{type:Boolean},hasBubbles:{type:Boolean},selectedBubbleIndex:{},bubbleCount:{},layoutMode:{},syncEnabled:{type:Boolean},scale:{},isDrawingMode:{type:Boolean},hasSelection:{type:Boolean},brushMode:{},brushSize:{},mouseX:{},mouseY:{},isProcessing:{type:Boolean},progressText:{},progressCurrent:{},progressTotal:{}},emits:["go-previous-image","go-next-image","toggle-thumbnails","select-previous-bubble","select-next-bubble","toggle-layout","toggle-view-mode","toggle-sync","fit-to-screen","zoom-in","zoom-out","reset-zoom","exit-edit-mode","auto-detect-bubbles","detect-all-images","translate-with-bubbles","toggle-drawing-mode","delete-selected-bubbles","repair-selected-bubble","activate-repair-brush","activate-restore-brush","apply-and-next"],setup(n){const r=n,u=oe(()=>r.progressTotal===0?0:Math.round(r.progressCurrent/r.progressTotal*100)),o=oe(()=>r.progressTotal>0&&r.progressCurrent>=r.progressTotal),a=oe(()=>{const i=r.brushMode==="repair"?{fill:"rgba(76, 175, 80, 0.4)",border:"#4CAF50"}:{fill:"rgba(33, 150, 243, 0.4)",border:"#2196F3"};return{position:"fixed",left:`${r.mouseX}px`,top:`${r.mouseY}px`,width:`${r.brushSize}px`,height:`${r.brushSize}px`,borderRadius:"50%",border:`2px solid ${i.border}`,backgroundColor:i.fill,pointerEvents:"none",zIndex:99999,transform:"translate(-50%, -50%)",display:r.brushMode?"block":"none"}});return(i,t)=>(V(),J("div",ep,[e("div",tp,[e("div",np,[e("button",{class:"nav-btn",disabled:!n.canGoPrevious,onClick:t[0]||(t[0]=s=>i.$emit("go-previous-image")),title:"上一张图片 (PageUp)"}," ◀◀ ",8,op),e("span",{class:"image-indicator",onClick:t[1]||(t[1]=s=>i.$emit("toggle-thumbnails")),title:"点击展开缩略图"},[t[23]||(t[23]=Ke(" 图 ",-1)),e("span",null,xe(n.currentImageIndex+1),1),t[24]||(t[24]=Ke(" / ",-1)),e("span",null,xe(n.imageCount),1)]),e("button",{class:"nav-btn",disabled:!n.canGoNext,onClick:t[2]||(t[2]=s=>i.$emit("go-next-image")),title:"下一张图片 (PageDown)"}," ▶▶ ",8,ap),e("button",{class:Le(["thumb-toggle-btn",{active:n.showThumbnails}]),onClick:t[3]||(t[3]=s=>i.$emit("toggle-thumbnails")),title:"显示/隐藏缩略图"}," ☷ ",2)]),t[30]||(t[30]=e("div",{class:"toolbar-divider"},null,-1)),e("div",sp,[e("button",{id:"prevBubbleBtn",class:"nav-btn",disabled:!n.hasBubbles||n.selectedBubbleIndex<=0,onClick:t[4]||(t[4]=s=>i.$emit("select-previous-bubble")),title:"上一个气泡 (←)"}," ◀ ",8,lp),e("span",ip,[t[25]||(t[25]=Ke(" 气泡 ",-1)),e("span",rp,xe(n.selectedBubbleIndex>=0?n.selectedBubbleIndex+1:0),1),t[26]||(t[26]=Ke(" / ",-1)),e("span",up,xe(n.bubbleCount),1)]),e("button",{id:"nextBubbleBtn",class:"nav-btn",disabled:!n.hasBubbles||n.selectedBubbleIndex>=n.bubbleCount-1,onClick:t[5]||(t[5]=s=>i.$emit("select-next-bubble")),title:"下一个气泡 (→)"}," ▶ ",8,cp)]),t[31]||(t[31]=e("div",{class:"toolbar-divider"},null,-1)),e("div",dp,[e("button",{class:"layout-toggle-btn",onClick:t[6]||(t[6]=s=>i.$emit("toggle-layout")),title:"切换布局：左右/上下"},[n.layoutMode==="horizontal"?(V(),J("svg",gp,[...t[27]||(t[27]=[e("rect",{x:"1",y:"2",width:"8",height:"16",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"},null,-1),e("rect",{x:"11",y:"2",width:"8",height:"16",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"},null,-1)])])):(V(),J("svg",pp,[...t[28]||(t[28]=[e("rect",{x:"2",y:"1",width:"16",height:"8",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"},null,-1),e("rect",{x:"2",y:"11",width:"16",height:"8",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"},null,-1)])]))]),e("button",{class:"view-mode-btn",onClick:t[7]||(t[7]=s=>i.$emit("toggle-view-mode")),title:"切换视图模式"},[...t[29]||(t[29]=[e("span",{class:"dual-icon"},"⧉",-1)])]),e("button",{class:Le({active:n.syncEnabled}),onClick:t[8]||(t[8]=s=>i.$emit("toggle-sync")),title:"同步缩放/拖动",style:{"font-size":"12px"}}," 🔗 ",2),e("button",{onClick:t[9]||(t[9]=s=>i.$emit("fit-to-screen")),title:"适应屏幕 (双击)"},"⛶"),e("button",{onClick:t[10]||(t[10]=s=>i.$emit("zoom-in")),title:"放大 (+)"},"+"),e("span",bp,xe(Math.round(n.scale*100))+"%",1),e("button",{onClick:t[11]||(t[11]=s=>i.$emit("zoom-out")),title:"缩小 (-)"},"−"),e("button",{onClick:t[12]||(t[12]=s=>i.$emit("reset-zoom")),title:"原始大小"},"1:1")]),t[32]||(t[32]=e("div",{class:"toolbar-spacer"},null,-1)),e("button",{class:"secondary-btn",onClick:t[13]||(t[13]=s=>i.$emit("exit-edit-mode"))},"退出编辑")]),e("div",vp,[e("div",mp,[e("button",{class:"annotation-btn detect-btn",onClick:t[14]||(t[14]=s=>i.$emit("auto-detect-bubbles")),title:"自动检测当前图片的文本框"},[...t[33]||(t[33]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("circle",{cx:"6",cy:"6",r:"4",fill:"none",stroke:"currentColor","stroke-width":"1.5"}),e("path",{d:"M9 9l4 4",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round"})],-1),e("span",null,"检测",-1)])]),e("button",{class:"annotation-btn detect-btn",onClick:t[15]||(t[15]=s=>i.$emit("detect-all-images")),title:"批量检测所有图片"},[...t[34]||(t[34]=[Qt('<svg viewBox="0 0 16 16" width="14" height="14" data-v-b7164359><circle cx="5" cy="5" r="2.5" fill="none" stroke="currentColor" stroke-width="1" data-v-b7164359></circle><path d="M7 7l2 2" stroke="currentColor" stroke-width="1" stroke-linecap="round" data-v-b7164359></path><circle cx="10" cy="10" r="2.5" fill="none" stroke="currentColor" stroke-width="1" data-v-b7164359></circle><path d="M12 12l2 2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" data-v-b7164359></path></svg><span data-v-b7164359>批量检测</span>',2)])]),e("button",{class:"annotation-btn primary-action-btn",onClick:t[16]||(t[16]=s=>i.$emit("translate-with-bubbles")),title:"使用当前文本框翻译此图片"},[...t[35]||(t[35]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("path",{d:"M2 3h5M4.5 3v7M2 6h5",stroke:"currentColor","stroke-width":"1.2",fill:"none"}),e("path",{d:"M9 13l2-7 2 7M9.5 11h3",stroke:"currentColor","stroke-width":"1.2",fill:"none"})],-1),e("span",null,"翻译",-1)])]),t[41]||(t[41]=e("div",{class:"toolbar-divider"},null,-1)),e("button",{class:Le(["annotation-btn",{active:n.isDrawingMode}]),onClick:t[17]||(t[17]=s=>i.$emit("toggle-drawing-mode")),title:"添加气泡框（或中键拖拽绘制）"},[...t[36]||(t[36]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("rect",{x:"3",y:"3",width:"10",height:"10",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"}),e("path",{d:"M8 5v6M5 8h6",stroke:"currentColor","stroke-width":"1.5"})],-1),e("span",null,"添加",-1)])],2),e("button",{class:"annotation-btn",disabled:!n.hasSelection,onClick:t[18]||(t[18]=s=>i.$emit("delete-selected-bubbles")),title:"删除选中气泡框 (Delete)"},[...t[37]||(t[37]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("rect",{x:"3",y:"3",width:"10",height:"10",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"}),e("path",{d:"M5 8h6",stroke:"currentColor","stroke-width":"1.5"})],-1),e("span",null,"删除",-1)])],8,fp),e("button",{class:"annotation-btn",disabled:!n.hasSelection,onClick:t[19]||(t[19]=s=>i.$emit("repair-selected-bubble")),title:"修复选中气泡背景 (R)"},[...t[38]||(t[38]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("path",{d:"M2 14l3-3m0 0l6-6 3 3-6 6m-3 0l-1 1 1-1z",fill:"none",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round"}),e("path",{d:"M11 5l-1-1 2-2 2 2-2 2-1-1z",fill:"currentColor"})],-1),e("span",null,"修复",-1)])],8,hp),t[42]||(t[42]=e("div",{class:"toolbar-divider"},null,-1)),e("button",{class:Le(["annotation-btn brush-btn",{active:n.brushMode==="repair"}]),onClick:t[20]||(t[20]=s=>i.$emit("activate-repair-brush")),title:"修复笔刷 (按住R+左键拖拽)"},[...t[39]||(t[39]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("circle",{cx:"8",cy:"8",r:"5",fill:"none",stroke:"currentColor","stroke-width":"1.5"}),e("circle",{cx:"8",cy:"8",r:"2",fill:"currentColor"})],-1),e("span",null,"修复笔刷",-1)])],2),e("button",{class:Le(["annotation-btn brush-btn",{active:n.brushMode==="restore"}]),onClick:t[21]||(t[21]=s=>i.$emit("activate-restore-brush")),title:"还原笔刷 (按住U+左键拖拽)"},[...t[40]||(t[40]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("circle",{cx:"8",cy:"8",r:"5",fill:"none",stroke:"currentColor","stroke-width":"1.5"}),e("path",{d:"M5 8h6M8 5v6",stroke:"currentColor","stroke-width":"1",transform:"rotate(45 8 8)"})],-1),e("span",null,"还原笔刷",-1)])],2),n.brushMode?(V(),J("span",yp," 笔刷: "+xe(n.brushSize)+"px ",1)):Te("",!0),t[43]||(t[43]=Qt('<div class="help-tooltip-container" data-v-b7164359><button class="help-tooltip-btn" title="快捷键操作帮助" data-v-b7164359><svg viewBox="0 0 16 16" width="14" height="14" data-v-b7164359><circle cx="8" cy="8" r="6.5" fill="none" stroke="currentColor" stroke-width="1.2" data-v-b7164359></circle><text x="8" y="11" text-anchor="middle" font-size="9" font-weight="bold" fill="currentColor" data-v-b7164359>?</text></svg><span class="help-btn-text" data-v-b7164359>快捷键</span></button><div class="help-tooltip-popup" data-v-b7164359><div class="help-section" data-v-b7164359><div class="help-title" data-v-b7164359>🖱️ 鼠标操作</div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>左键点击气泡</span><span class="help-desc" data-v-b7164359>选择气泡</span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>Shift+左键点击</span><span class="help-desc" data-v-b7164359>多选气泡</span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>左键拖拽四角/边</span><span class="help-desc" data-v-b7164359>调整大小</span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>左键拖拽框内部</span><span class="help-desc" data-v-b7164359>移动气泡框</span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>中键拖拽</span><span class="help-desc" data-v-b7164359>绘制新气泡框</span></div></div><div class="help-section" data-v-b7164359><div class="help-title" data-v-b7164359>⌨️ 快捷键</div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>A / D</span><span class="help-desc" data-v-b7164359>切换上/下一张图片</span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>Ctrl+Enter</span><span class="help-desc" data-v-b7164359>应用并跳转下一张</span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>Delete / Backspace</span><span class="help-desc" data-v-b7164359>删除选中气泡</span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>按住R+左键拖拽</span><span class="help-desc" data-v-b7164359>修复笔刷</span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>按住U+左键拖拽</span><span class="help-desc" data-v-b7164359>还原笔刷</span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>笔刷模式下滚轮</span><span class="help-desc" data-v-b7164359>调整笔刷大小</span></div></div></div></div>',1))]),n.brushMode?(V(),J("div",{key:0,class:"brush-cursor",style:it(a.value)},null,4)):Te("",!0),n.brushMode?(V(),J("div",xp,xe(n.brushMode==="repair"?"修复笔刷 (R)":"还原笔刷 (U)")+" - 滚轮调整大小 ",1)):Te("",!0),n.isProcessing?(V(),J("div",{key:2,class:Le(["edit-progress-container",{completed:o.value}])},[e("div",Sp,[e("span",kp,xe(n.progressText),1),e("span",_p,xe(n.progressCurrent)+"/"+xe(n.progressTotal),1)]),e("div",Cp,[e("div",{class:Le(["edit-progress-fill",{animating:!o.value}]),style:it({width:u.value+"%"})},null,6)])],2)):Te("",!0),t[44]||(t[44]=e("div",{class:"toolbar-spacer"},null,-1)),e("div",wp,[e("button",{class:"primary-btn",onClick:t[22]||(t[22]=s=>i.$emit("apply-and-next")),title:"应用更改并跳转下一张 (Ctrl+Enter)"}," 应用并下一张 ")])])]))}}),Tp=je($p,[["__scopeId","data-v-b7164359"]]),Ip={key:0,class:"edit-thumbnails-panel"},Dp={class:"thumbnails-scroll"},Rp=["onClick"],Mp=["src","alt"],Bp={class:"thumb-index"},Ep=Ge({__name:"EditThumbnailPanel",props:{visible:{type:Boolean},images:{},currentImageIndex:{}},emits:["switch-to-image"],setup(n){return(r,u)=>n.visible?(V(),J("div",Ip,[e("div",Dp,[(V(!0),J(Ze,null,et(n.images,(o,a)=>(V(),J("div",{key:o.id,class:Le(["edit-thumbnail-item",{active:a===n.currentImageIndex}]),onClick:i=>r.$emit("switch-to-image",a)},[e("img",{src:o.translatedDataURL||o.originalDataURL,alt:`图片 ${a+1}`},null,8,Mp),e("span",Bp,xe(a+1),1)],10,Rp))),128))])])):Te("",!0)}}),Pp=je(Ep,[["__scopeId","data-v-9d2a43d9"]]),Ap={class:"edit-main-layout"},Fp={class:"image-comparison-container"},Lp={class:"panel-header"},Up=["src"],Op={class:"panel-header"},zp=["src"],Vp=Ge({__name:"EditWorkspace",props:{isEditModeActive:{type:Boolean}},emits:["exit"],setup(n,{emit:r}){const u=n,o=r,a=st(),i=gt(),{translateWithCurrentBubbles:t}=gn(),{reRenderFullImage:s}=zd({onRenderStart:()=>console.log("开始重新渲染..."),onRenderSuccess:W=>console.log("渲染成功:",W.substring(0,50)+"..."),onRenderError:W=>console.error("渲染失败:",W)}),{isDrawingMode:k,isDrawingBox:A,currentDrawingRect:$,isMiddleButtonDown:N,handleBubbleSelect:ae,handleBubbleMultiSelect:le,handleClearMultiSelect:Z,handleBubbleDragStart:w,handleBubbleDragging:Q,handleBubbleDragEnd:j,handleBubbleResizeStart:H,handleBubbleResizing:d,handleBubbleResizeEnd:l,handleBubbleRotateStart:_,handleBubbleRotating:x,handleBubbleRotateEnd:z,toggleDrawingMode:ee,handleDrawBubble:be,getDrawingRectStyle:G,handleBubbleUpdate:F,deleteSelectedBubbles:B,repairSelectedBubble:S,handleOcrRecognize:v}=Od({onReRender:()=>s(),onDelayedPreview:()=>s()}),I=y(0),T=y(0),{brushMode:p,brushSize:f,mouseX:te,mouseY:se,isBrushKeyDown:m,toggleBrushMode:C,exitBrushMode:c,startBrushPainting:U,continueBrushPainting:fe,finishBrushPainting:K,adjustBrushSize:Y}=Ld({onBrushComplete:()=>s(),getCurrentRepairSettings:()=>({inpaintMethod:Ce.value,fillColor:q.value})}),{images:Se,currentImageIndex:g,currentImage:b,imageCount:M,canGoPrevious:D,canGoNext:O}=yt(a),{bubbles:re,selectedIndex:E,selectedIndices:P,selectedBubble:R,bubbleCount:h,hasBubbles:L,hasSelection:X}=yt(i),ne=oe(()=>ke.value?.querySelector("img")?.naturalWidth||2e3),ye=oe(()=>ke.value?.querySelector("img")?.naturalHeight||2e3),ge=y(null),ie=y(null),ke=y(null),ve=y(null),Pe=y(null),De=y(null),_e=y("dual"),ce=y("horizontal"),$e=y(!1),Ue=y(!0),Be=y(!1),Fe=y(!1),Ce=y("solid"),q=y("#FFFFFF"),pe=y(!1),Me=y("处理中..."),Oe=y(0),ot=y(0),Xe=Kn(),Je=Kn(),mt=oe(()=>Je.scale.value),Pt=oe(()=>Je.translateX.value),At=oe(()=>Je.translateY.value),to=oe(()=>Xe.scale.value),ft=y(null),no=oe(()=>({transform:`translate(${Xe.translateX.value}px, ${Xe.translateY.value}px) scale(${Xe.scale.value})`})),oo=oe(()=>({transform:`translate(${Je.translateX.value}px, ${Je.translateY.value}px) scale(${Je.scale.value})`}));function pn(){Je.zoomIn(),Ue.value&&Xe.setTransform(Je.getTransform())}function bn(){Je.zoomOut(),Ue.value&&Xe.setTransform(Je.getTransform())}function vn(){Je.resetZoom(),Ue.value&&Xe.setTransform(Je.getTransform())}const Ft=y(!1),ao=y(0),Lt=y(!1),Ct=y({x:0,y:0,size:0});function Ut(){p.value&&c(),Vt()}function Ot(){i.bubbles.length>0&&i.selectBubble(0)}function mn(){D.value&&(Ut(),a.goToPrevious())}function zt(){O.value&&(Ut(),a.goToNext())}function so(W){W!==g.value&&W>=0&&W<M.value&&(Ut(),a.setCurrentImageIndex(W))}function Vt(){if(!b.value)return;const W=Array.isArray(b.value.bubbleStates);re.value.length>0?(a.updateCurrentBubbleStates([...re.value]),a.setManuallyAnnotated(!0),console.log("已保存气泡状态到当前图片，标记为手动标注")):W&&(a.updateCurrentBubbleStates([]),a.setManuallyAnnotated(!0),console.log("已保存空气泡状态到当前图片（用户主动清空，标记为手动标注）"))}function wt(){b.value?.bubbleStates?(i.setBubbles([...b.value.bubbleStates],!0),console.log(`已加载 ${b.value.bubbleStates.length} 个气泡状态`)):i.clearBubblesLocal(),Ot()}function lo(){i.selectPrevious()}function io(){i.selectNext()}function ro(){$e.value=!$e.value}function uo(){ce.value=ce.value==="horizontal"?"vertical":"horizontal";try{localStorage.setItem(Ln,ce.value)}catch(W){console.warn("保存布局模式失败:",W)}setTimeout(()=>{$t()},300)}function co(){const W=["dual","original","translated"],de=W.indexOf(_e.value),me=W[(de+1)%W.length];me&&(_e.value=me)}function go(){Ue.value=!Ue.value,console.log("双图同步:",Ue.value?"开启":"关闭"),Ue.value&&Xe.setTransform(Je.getTransform())}function $t(){const W=ve.value||ie.value,de=Pe.value||ke.value;if(!W||!de)return;const me=de.querySelector("img");if(!me||!me.naturalWidth)return;const Ye=W.getBoundingClientRect(),Ve=Ye.width/me.naturalWidth,Ae=Ye.height/me.naturalHeight,Ne=Math.min(Ve,Ae)*.95,ze=(Ye.width-me.naturalWidth*Ne)/2,vt=(Ye.height-me.naturalHeight*Ne)/2,ht={scale:Ne,translateX:ze,translateY:vt};Je.setTransform(ht),Xe.setTransform(ht)}function fn(W,de){if(p.value){const ze=W.deltaY>0?-5:5;Y(ze);return}const me=W.currentTarget.getBoundingClientRect(),Ye=W.clientX-me.left,Ve=W.clientY-me.top,Ae=W.deltaY>0?.9:1.1,Ne=de==="original"?Xe:Je;Ne.zoomAt(Ye,Ve,Ae),Ue.value&&(de==="original"?Je:Xe).setTransform(Ne.getTransform())}function hn(W,de){if(p.value){const me=de==="original"?ie.value:ve.value;me&&U(W,me);return}if(W.button===1){N.value=!0,Sn(W,de),W.preventDefault();return}if(k.value&&W.button===0){Sn(W,de),W.preventDefault();return}if(W.button===0){if(W.target.closest(".bubble-highlight-box"))return;W.shiftKey||Z(),ft.value=de,(de==="original"?Xe:Je).startDrag(W.clientX,W.clientY),document.addEventListener("mousemove",yn),document.addEventListener("mouseup",xn),W.preventDefault()}}function yn(W){if(!ft.value)return;const de=ft.value==="original"?Xe:Je;de.drag(W.clientX,W.clientY),Ue.value&&(ft.value==="original"?Je:Xe).setTransform(de.getTransform())}function xn(){ft.value&&(ft.value==="original"?Xe:Je).endDrag(),ft.value=null,document.removeEventListener("mousemove",yn),document.removeEventListener("mouseup",xn)}let Nt="translated";function Sn(W,de="translated"){Nt=de;const me=de==="original"?ke.value:Pe.value,Ye=de==="original"?Xe:Je;if(!me)return;const Ve=me.getBoundingClientRect(),Ae=(W.clientX-Ve.left)/Ye.scale.value,Ne=(W.clientY-Ve.top)/Ye.scale.value;I.value=Ae,T.value=Ne,A.value=!0,$.value=[Ae,Ne,Ae,Ne],document.addEventListener("mousemove",Wt),document.addEventListener("mouseup",Kt)}function Wt(W){if(!A.value)return;const de=Nt==="original"?ke.value:Pe.value,me=Nt==="original"?Xe:Je;if(!de)return;const Ye=de.getBoundingClientRect(),Ve=(W.clientX-Ye.left)/me.scale.value,Ae=(W.clientY-Ye.top)/me.scale.value;$.value=[Math.min(I.value,Ve),Math.min(T.value,Ae),Math.max(I.value,Ve),Math.max(T.value,Ae)]}function Kt(W){document.removeEventListener("mousemove",Wt),document.removeEventListener("mouseup",Kt);const de=N.value;if(!A.value||!$.value){A.value=!1,$.value=null,N.value=!1;return}const[me,Ye,Ve,Ae]=$.value,Ne=Ve-me,ze=Ae-Ye;Ne>10&&ze>10&&(i.addBubble($.value),i.selectBubble(i.bubbleCount-1),console.log("已添加新气泡:",$.value)),A.value=!1,$.value=null,N.value=!1,!de&&k.value&&(k.value=!1)}function kn(W){console.log(`${W} 图片加载完成`),mt.value===1&&Pt.value===0&&At.value===0&&ct(()=>{$t()})}function po(){s()}function bo(W){W.inpaintMethod!==void 0&&(Ce.value=W.inpaintMethod),W.fillColor!==void 0&&(q.value=W.fillColor),E.value>=0&&F(W)}function vo(W){we("文本已应用","success"),s()}function mo(W){const de=i.initialStates[W];if(!de){console.warn(`无法重置气泡 #${W+1}：找不到初始状态`),we("无法重置：找不到初始状态","warning");return}const me=JSON.parse(JSON.stringify(de));i.updateBubble(W,me),console.log(`气泡 #${W+1} 已重置到初始状态`),we("气泡已重置","success"),s()}async function fo(W){const de=re.value[W];if(!de?.originalText){console.warn("无法重新翻译：缺少气泡或原文");return}try{console.log(`开始重新翻译气泡 #${W+1}`);const{translateSingleText:me}=await lt(async()=>{const{translateSingleText:Ne}=await Promise.resolve().then(()=>Go);return{translateSingleText:Ne}},void 0),{useSettingsStore:Ye}=await lt(async()=>{const{useSettingsStore:Ne}=await import("./index.71kVCBu7.js").then(ze=>ze.q);return{useSettingsStore:Ne}},__vite__mapDeps([0,1,2])),Ve=Ye().settings,Ae=await me({original_text:de.originalText,model_provider:Ve.translation.provider,api_key:Ve.translation.apiKey,model_name:Ve.translation.modelName,custom_base_url:Ve.translation.customBaseUrl,target_language:Ve.targetLanguage,prompt_content:Ve.translatePrompt});Ae.success&&Ae.data?.translated_text?(i.updateBubble(W,{translatedText:Ae.data.translated_text}),console.log(`翻译成功: "${Ae.data.translated_text}"`),s()):console.error("翻译失败:",Ae.error||"未知错误")}catch(me){console.error("翻译出错:",me)}}function _n(W,de){for(W.bubbleTexts||(W.bubbleTexts=[]),W.originalTexts||(W.originalTexts=[]);W.bubbleTexts.length<de;)W.bubbleTexts.push("");for(;W.originalTexts.length<de;)W.originalTexts.push("")}function Cn(W,de,me){const Ye=W.auto_directions||[];return W.bubble_coords.map((Ve,Ae)=>{const Ne=Ve[0]??0,ze=Ve[1]??0,vt=Ve[2]??0,ht=Ve[3]??0;let pt;return Ye[Ae]?pt=Ye[Ae]==="v"?"vertical":"horizontal":pt=ht-ze>vt-Ne?"vertical":"horizontal",{coords:Ve,originalText:de.originalTexts?.[Ae]||"",translatedText:de.bubbleTexts?.[Ae]||"",textboxText:"",fontSize:me.fontSize,fontFamily:me.fontFamily,textDirection:pt,autoTextDirection:pt,textColor:me.textColor,fillColor:me.fillColor,strokeEnabled:me.strokeEnabled,strokeColor:me.strokeColor,strokeWidth:me.strokeWidth,rotationAngle:W.bubble_angles?.[Ae]||0,inpaintMethod:me.inpaintMethod,position:{x:0,y:0},polygon:[]}})}async function ho(){const W=b.value;if(!W?.originalDataURL){we("没有有效的图片用于检测","warning");return}try{we("正在自动检测文本框...","info");const me=W.originalDataURL.match(/^data:image\/[^;]+;base64,(.+)$/)?.[1]||"";if(!me){we("无法解析图片数据","error");return}const Ye=Qe(),{textDetector:Ve,boxExpand:Ae,textStyle:Ne}=Ye.settings,ze=await tn(me,Ve,{box_expand_ratio:Ae.ratio,box_expand_top:Ae.top,box_expand_bottom:Ae.bottom,box_expand_left:Ae.left,box_expand_right:Ae.right});if(ze.success&&ze.bubble_coords){a.updateCurrentImage({bubbleCoords:ze.bubble_coords,bubbleAngles:ze.bubble_angles||[]}),_n(W,ze.bubble_coords.length);const vt={bubble_coords:ze.bubble_coords.map(pt=>[...pt]),bubble_angles:ze.bubble_angles,auto_directions:ze.auto_directions},ht=Cn(vt,W,Ne);i.setBubbles(ht),Ot(),we(`自动检测到 ${ze.bubble_coords.length} 个文本框`,"success")}else we(ze.error||"检测失败","error")}catch(de){console.error("自动检测失败:",de),we("自动检测失败","error")}}async function yo(){if(Se.value.length<=1){we("至少需要两张图片才能执行批量检测","warning");return}if(!confirm("此操作将对所有图片进行文本框检测，可能会覆盖已有的检测结果。确定继续吗？"))return;const W=Qe(),{textDetector:de,boxExpand:me,textStyle:Ye}=W.settings,Ve=g.value,Ae=Se.value.length;pe.value=!0,Me.value="批量检测中",ot.value=Ae,Oe.value=0;try{let Ne=0;for(let ze=0;ze<Ae;ze++){const vt=Se.value[ze];if(!vt?.originalDataURL)continue;Oe.value=ze+1;const pt=vt.originalDataURL.match(/^data:image\/[^;]+;base64,(.+)$/)?.[1]||"";if(!pt)continue;const bt=await tn(pt,de,{box_expand_ratio:me.ratio,box_expand_top:me.top,box_expand_bottom:me.bottom,box_expand_left:me.left,box_expand_right:me.right});if(bt.success&&bt.bubble_coords){const xt=Se.value[ze];if(xt){xt.bubbleCoords=bt.bubble_coords,xt.bubbleAngles=bt.bubble_angles||[],_n(xt,bt.bubble_coords.length);const wo={bubble_coords:bt.bubble_coords.map($o=>[...$o]),bubble_angles:bt.bubble_angles,auto_directions:bt.auto_directions};xt.bubbleStates=Cn(wo,xt,Ye),Ne+=bt.bubble_coords.length,ze===g.value&&wt()}}}Me.value="检测完成",Oe.value=Ae,Ve!==g.value&&a.setCurrentImageIndex(Ve),wt(),we(`批量检测完成！共处理 ${Ae} 张图片，检测到 ${Ne} 个文本框`,"success"),setTimeout(()=>{pe.value=!1},2e3)}catch(Ne){console.error("批量检测失败:",Ne),we("批量检测失败","error"),pe.value=!1}}async function xo(){if(!b.value?.originalDataURL){we("没有有效的图片用于翻译","warning");return}if(re.value.length===0){we("没有文本框可用于翻译，请先检测或添加文本框","warning");return}we("正在使用当前文本框翻译...","info");try{await t()&&(we("翻译成功！","success"),Ot())}catch(de){console.error("翻译失败:",de),we(`翻译失败: ${de instanceof Error?de.message:"未知错误"}`,"error")}}function So(){C("repair")}function ko(){C("restore")}function wn(W){fe(W)}function $n(){K()}function _o(W){Ft.value=!0,ao.value=ce.value==="horizontal"?W.clientX:W.clientY,document.body.style.cursor=ce.value==="horizontal"?"col-resize":"row-resize",document.body.style.userSelect="none",document.addEventListener("mousemove",qt),document.addEventListener("mouseup",Ht),W.preventDefault()}function qt(W){if(!Ft.value)return;const de=ie.value?.parentElement?.parentElement;if(!de)return;const me=de.getBoundingClientRect();if(ce.value==="horizontal"){const Ye=W.clientX-me.left,Ve=me.width,Ae=Math.max(20,Math.min(80,Ye/Ve*100)),Ne=de.querySelector(".original-panel"),ze=de.querySelector(".translated-panel");Ne&&ze&&(Ne.style.flex=`0 0 ${Ae}%`,ze.style.flex=`0 0 ${100-Ae}%`)}else{const Ye=W.clientY-me.top,Ve=me.height,Ae=Math.max(20,Math.min(80,Ye/Ve*100)),Ne=de.querySelector(".original-panel"),ze=de.querySelector(".translated-panel");Ne&&ze&&(Ne.style.flex=`0 0 ${Ae}%`,ze.style.flex=`0 0 ${100-Ae}%`)}}function Ht(){Ft.value=!1,document.body.style.cursor="",document.body.style.userSelect="",document.removeEventListener("mousemove",qt),document.removeEventListener("mouseup",Ht)}function Co(W){Lt.value=!0;const de=De.value;de&&(Ct.value={x:W.clientX,y:W.clientY,size:ce.value==="horizontal"?de.offsetWidth:de.offsetHeight},document.body.style.cursor=ce.value==="horizontal"?"ew-resize":"ns-resize",document.body.style.userSelect="none",document.addEventListener("mousemove",Jt),document.addEventListener("mouseup",Yt),W.preventDefault())}function Jt(W){if(!(!Lt.value||!De.value))if(ce.value==="horizontal"){const de=Ct.value.x-W.clientX;let me=Ct.value.size+de;me=Math.max(300,Math.min(window.innerWidth*.6,me)),De.value.style.flex=`0 0 ${me}px`,De.value.style.minWidth=`${me}px`}else{const de=Ct.value.y-W.clientY;let me=Ct.value.size+de;me=Math.max(200,Math.min(window.innerHeight*.5,me)),De.value.style.flex=`0 0 ${me}px`,De.value.style.height=`${me}px`}}function Yt(){Lt.value=!1,document.body.style.cursor="",document.body.style.userSelect="",document.removeEventListener("mousemove",Jt),document.removeEventListener("mouseup",Yt)}function Tn(W){const de=W.target,me=W.key.toLowerCase();if(me==="r"||me==="u"||me==="a"||me==="d"){if(de.tagName==="TEXTAREA")return;(de.tagName==="INPUT"||de.tagName==="SELECT"||de.tagName==="BUTTON")&&de.blur()}else if(de.tagName==="INPUT"||de.tagName==="TEXTAREA"||de.tagName==="SELECT")return;switch(W.key){case"Escape":Rn();break;case"Delete":case"Backspace":!p.value&&X.value&&(B(),W.preventDefault());break;case"a":case"A":p.value||(mn(),W.preventDefault());break;case"d":case"D":p.value||(zt(),W.preventDefault());break;case"Enter":W.ctrlKey&&!p.value&&(Dn(),W.preventDefault());break;case"r":case"R":m.value||(C("repair"),W.preventDefault());break;case"u":case"U":m.value||(C("restore"),W.preventDefault());break;case"+":case"=":pn(),W.preventDefault();break;case"-":bn(),W.preventDefault();break;case"0":vn(),W.preventDefault();break}}function In(W){(W.key==="r"||W.key==="R"||W.key==="u"||W.key==="U")&&(c(),W.preventDefault())}async function Dn(){Vt(),await s(),O.value?zt():we("已是最后一张图片","info")}function Rn(){Vt(),o("exit")}return ut(()=>{try{const W=localStorage.getItem(Ln);(W==="horizontal"||W==="vertical")&&(ce.value=W)}catch(W){console.warn("加载布局模式失败:",W)}document.addEventListener("keydown",Tn),document.addEventListener("keyup",In),document.addEventListener("mousemove",wn),document.addEventListener("mouseup",$n),u.isEditModeActive&&(wt(),ct(()=>{ge.value?.focus()}))}),It(()=>{document.removeEventListener("keydown",Tn),document.removeEventListener("keyup",In),document.removeEventListener("mousemove",wn),document.removeEventListener("mouseup",$n),document.removeEventListener("mousemove",Wt),document.removeEventListener("mouseup",Kt),document.removeEventListener("mousemove",qt),document.removeEventListener("mouseup",Ht),document.removeEventListener("mousemove",Jt),document.removeEventListener("mouseup",Yt)}),Re(()=>u.isEditModeActive,W=>{W&&(wt(),ct(()=>{ge.value?.focus()}))}),Re(g,()=>{u.isEditModeActive&&wt()}),Re(R,W=>{W&&(Ce.value=W.inpaintMethod||"solid",q.value=W.fillColor||"#FFFFFF")},{immediate:!0}),(W,de)=>n.isEditModeActive?(V(),J("div",{key:0,class:Le(["edit-workspace",[`layout-${ce.value}`,{"drawing-mode":he(k)}]]),tabindex:"0",ref_key:"workspaceRef",ref:ge},[Ie(Tp,{"current-image-index":he(g),"image-count":he(M),"can-go-previous":he(D),"can-go-next":he(O),"show-thumbnails":$e.value,"has-bubbles":he(L),"selected-bubble-index":he(E),"bubble-count":he(h),"layout-mode":ce.value,"sync-enabled":Ue.value,scale:mt.value,"is-drawing-mode":he(k),"has-selection":he(X),"brush-mode":he(p),"brush-size":he(f),"mouse-x":he(te),"mouse-y":he(se),"is-processing":pe.value,"progress-text":Me.value,"progress-current":Oe.value,"progress-total":ot.value,onGoPreviousImage:mn,onGoNextImage:zt,onToggleThumbnails:ro,onSelectPreviousBubble:lo,onSelectNextBubble:io,onToggleLayout:uo,onToggleViewMode:co,onToggleSync:go,onFitToScreen:$t,onZoomIn:pn,onZoomOut:bn,onResetZoom:vn,onExitEditMode:Rn,onAutoDetectBubbles:ho,onDetectAllImages:yo,onTranslateWithBubbles:xo,onToggleDrawingMode:he(ee),onDeleteSelectedBubbles:he(B),onRepairSelectedBubble:he(S),onActivateRepairBrush:So,onActivateRestoreBrush:ko,onApplyAndNext:Dn},null,8,["current-image-index","image-count","can-go-previous","can-go-next","show-thumbnails","has-bubbles","selected-bubble-index","bubble-count","layout-mode","sync-enabled","scale","is-drawing-mode","has-selection","brush-mode","brush-size","mouse-x","mouse-y","is-processing","progress-text","progress-current","progress-total","onToggleDrawingMode","onDeleteSelectedBubbles","onRepairSelectedBubble"]),Ie(Pp,{visible:$e.value,images:he(Se),"current-image-index":he(g),onSwitchToImage:so},null,8,["visible","images","current-image-index"]),e("div",Ap,[e("div",Fp,[ue(e("div",{class:Le(["image-panel original-panel",{collapsed:_e.value==="translated"||Be.value}])},[e("div",Lp,[de[8]||(de[8]=e("span",{class:"panel-title"},"📖 原图 (日文)",-1)),e("button",{class:"panel-toggle",onClick:de[0]||(de[0]=me=>Be.value=!Be.value),title:"折叠/展开"},xe(Be.value?"+":"−"),1)]),e("div",{ref_key:"originalViewportRef",ref:ie,class:"image-viewport",onWheel:de[2]||(de[2]=nt(me=>fn(me,"original"),["prevent"])),onMousedown:de[3]||(de[3]=me=>hn(me,"original")),onDblclick:$t},[e("div",{ref_key:"originalWrapperRef",ref:ke,class:"image-canvas-wrapper",style:it(no.value)},[he(b)?.originalDataURL?(V(),J("img",{key:0,src:he(b).originalDataURL,alt:"原图",onLoad:de[1]||(de[1]=me=>kn("original"))},null,40,Up)):Te("",!0),he(b)?.originalDataURL?(V(),rt(qn,{key:1,bubbles:he(re),"selected-index":he(E),"selected-indices":he(P),scale:to.value,"is-drawing-mode":he(k),"is-brush-mode":!!he(p),"image-width":ne.value,"image-height":ye.value,onSelect:he(ae),onMultiSelect:he(le),onDragStart:he(w),onDragging:he(Q),onDragEnd:he(j),onResizeStart:he(H),onResizing:he(d),onResizeEnd:he(l),onRotateStart:he(_),onRotating:he(x),onRotateEnd:he(z),onDrawBubble:he(be)},null,8,["bubbles","selected-index","selected-indices","scale","is-drawing-mode","is-brush-mode","image-width","image-height","onSelect","onMultiSelect","onDragStart","onDragging","onDragEnd","onResizeStart","onResizing","onResizeEnd","onRotateStart","onRotating","onRotateEnd","onDrawBubble"])):Te("",!0),he($)?(V(),J("div",{key:2,class:"drawing-rect-edit",style:it(he(G)())},null,4)):Te("",!0)],4)],544)],2),[[qe,_e.value!=="translated"]]),_e.value==="dual"?(V(),J("div",{key:0,class:Le(["panel-divider",{"vertical-divider":ce.value==="vertical"}]),onMousedown:_o},null,34)):Te("",!0),ue(e("div",{class:Le(["image-panel translated-panel",{collapsed:_e.value==="original"||Fe.value}])},[e("div",Op,[de[9]||(de[9]=e("span",{class:"panel-title"},"📝 翻译图 (中文)",-1)),e("button",{class:"panel-toggle",onClick:de[4]||(de[4]=me=>Fe.value=!Fe.value),title:"折叠/展开"},xe(Fe.value?"+":"−"),1)]),e("div",{ref_key:"translatedViewportRef",ref:ve,class:"image-viewport",onWheel:de[6]||(de[6]=nt(me=>fn(me,"translated"),["prevent"])),onMousedown:de[7]||(de[7]=me=>hn(me,"translated")),onDblclick:$t},[e("div",{ref_key:"translatedWrapperRef",ref:Pe,class:"image-canvas-wrapper",style:it(oo.value)},[he(b)?.translatedDataURL||he(b)?.originalDataURL?(V(),J("img",{key:0,src:he(b)?.translatedDataURL||he(b)?.originalDataURL,alt:"翻译图",onLoad:de[5]||(de[5]=me=>kn("translated"))},null,40,zp)):Te("",!0),he(b)?.translatedDataURL||he(b)?.originalDataURL?(V(),rt(qn,{key:1,bubbles:he(re),"selected-index":he(E),"selected-indices":he(P),scale:mt.value,"is-drawing-mode":he(k),"is-brush-mode":!!he(p),"image-width":ne.value,"image-height":ye.value,onSelect:he(ae),onMultiSelect:he(le),onDragStart:he(w),onDragging:he(Q),onDragEnd:he(j),onResizeStart:he(H),onResizing:he(d),onResizeEnd:he(l),onRotateStart:he(_),onRotating:he(x),onRotateEnd:he(z),onDrawBubble:he(be)},null,8,["bubbles","selected-index","selected-indices","scale","is-drawing-mode","is-brush-mode","image-width","image-height","onSelect","onMultiSelect","onDragStart","onDragging","onDragEnd","onResizeStart","onResizing","onResizeEnd","onRotateStart","onRotating","onRotateEnd","onDrawBubble"])):Te("",!0),he($)?(V(),J("div",{key:2,class:"drawing-rect-edit translated-drawing-rect",style:it(he(G)())},null,4)):Te("",!0)],4)],544)],2),[[qe,_e.value!=="original"]])]),e("div",{ref_key:"editPanelRef",ref:De,class:"edit-panel-container"},[e("div",{class:"panel-resize-handle vertical",onMousedown:Co}," ⋮⋮⋮ ",32),Ie(Qg,{bubble:he(R),"bubble-index":he(E),onUpdate:bo,onReRender:po,onOcrRecognize:he(v),onReTranslate:fo,onApplyBubble:vo,onResetCurrent:mo},null,8,["bubble","bubble-index","onOcrRecognize"])],512)])],2)):Te("",!0)}}),Np=je(Vp,[["__scopeId","data-v-0916fb0e"]]),Wp={class:"app-header"},Kp={class:"header-content"},qp={class:"logo-container"},Hp={class:"header-links"},Jp={class:"container"},Yp={id:"image-display-area"},Xp={id:"upload-section",class:"card upload-card"},jp={key:1,class:"bookshelf-mode-hint"},Gp=Ge({__name:"TranslateView",setup(n){const r=Jn(),u=st(),o=Qe(),a=Zn(),i=gt(),{validateBeforeTranslation:t,initValidation:s}=Qn(),k=gn(),A=ol(),$=y(!1),N=y(!1),ae=y(!1),le=y(null),Z=y(null),w=oe(()=>u.currentImage),Q=oe(()=>u.hasImages);oe(()=>u.imageCount),oe(()=>u.currentImageIndex+1),oe(()=>Q.value&&!u.isBatchTranslationInProgress),oe(()=>u.canGoPrevious),oe(()=>u.canGoNext);const j=oe(()=>u.isBatchTranslationInProgress);oe(()=>u.isBatchTranslationPaused);const H=oe(()=>j.value&&!k.isHqTranslating.value&&!k.isProofreading.value);oe(()=>{if(!j.value)return 0;const E=u.completedImageCount,P=u.imageCount;return P>0?Math.round(E/P*100):0}),oe(()=>`${u.completedImageCount}/${u.imageCount}`);const d=oe(()=>u.failedImageCount>0),l=oe(()=>!!r.query.book&&!!r.query.chapter),_=oe(()=>r.query.book),x=oe(()=>r.query.chapter),z=oe(()=>A.currentBookTitle.value),ee=oe(()=>A.currentChapterTitle.value),be=oe(()=>l.value&&ee.value&&z.value?`${ee.value} - ${z.value}`:"Saber-Translator");ut(async()=>{u.clearImages(),i.clearBubbles(),await A.initializeApp(),s(),window.addEventListener("keydown",M)}),It(()=>{window.removeEventListener("keydown",M)}),Re(()=>[r.query.book,r.query.chapter],async([E,P],[R,h])=>{E&&P?(u.clearImages(),i.clearBubbles(),await G()):R&&h&&!E&&!P&&(u.clearImages(),i.clearBubbles(),await A.initializeBookChapterContext(),console.log("[TranslateView] 从书架模式切换到快速翻译模式，已清空数据"))}),Re(be,E=>{typeof document<"u"&&(document.title=E)},{immediate:!0});async function G(){if(!(!_.value||!x.value))try{await A.initializeBookChapterContext()}catch(E){console.error("加载章节会话失败:",E),we("加载章节会话失败","error")}}function F(E){console.log(`上传完成，共 ${E} 张图片`),u.hasImages&&(u.sortImagesByFileName(),A.switchImage(0))}async function B(E){const P=w.value;if(!P||!P.bubbleStates||P.bubbleStates.length===0){we("请先选择一张已翻译的图片","warning");return}if(u.images.length<=1){we("只有一张图片，无需应用到全部","info");return}if(!Object.values(E).some(h=>h)){we("请至少选择一个要应用的设置项","warning");return}try{const h=P.bubbleStates[0],L={};E.fontSize&&(L.fontSize=h.fontSize),E.fontFamily&&(L.fontFamily=h.fontFamily),E.layoutDirection&&(L.textDirection=h.textDirection==="auto"?"vertical":h.textDirection),E.textColor&&(L.textColor=h.textColor),E.fillColor&&(L.fillColor=h.fillColor),E.strokeEnabled&&(L.strokeEnabled=h.strokeEnabled),E.strokeColor&&(L.strokeColor=h.strokeColor),E.strokeWidth&&(L.strokeWidth=h.strokeWidth);const X=ke=>{const ve={...ke};return E.fontSize&&L.fontSize!==void 0&&(ve.fontSize=L.fontSize),E.fontFamily&&L.fontFamily!==void 0&&(ve.fontFamily=L.fontFamily),E.layoutDirection&&L.textDirection!==void 0&&(ve.textDirection=L.textDirection),E.textColor&&L.textColor!==void 0&&(ve.textColor=L.textColor),E.fillColor&&L.fillColor!==void 0&&(ve.fillColor=L.fillColor),E.strokeEnabled&&L.strokeEnabled!==void 0&&(ve.strokeEnabled=L.strokeEnabled),E.strokeColor&&L.strokeColor!==void 0&&(ve.strokeColor=L.strokeColor),E.strokeWidth&&L.strokeWidth!==void 0&&(ve.strokeWidth=L.strokeWidth),ve};let ne=0;const ye=u.images;for(let ke=0;ke<ye.length;ke++){const ve=ye[ke];if(ve&&ve.bubbleStates&&ve.bubbleStates.length>0){const Pe=ve.bubbleStates.map(X);u.updateImageByIndex(ke,{bubbleStates:Pe}),ne++}}if(i.bubbles.length>0){const ke=i.bubbles.map(X);i.setBubbles(ke)}const ge=[];E.fontSize&&ge.push("字号"),E.fontFamily&&ge.push("字体"),E.layoutDirection&&ge.push("排版方向"),E.textColor&&ge.push("文字颜色"),E.fillColor&&ge.push("填充颜色"),E.strokeEnabled&&ge.push("描边开关"),E.strokeColor&&ge.push("描边颜色"),E.strokeWidth&&ge.push("描边宽度");const ie=[];for(let ke=0;ke<ye.length;ke++){const ve=ye[ke];ve&&ve.translatedDataURL&&ve.bubbleStates&&ve.bubbleStates.length>0&&ie.push(ke)}if(ie.length>0){const{apiClient:ke}=await lt(async()=>{const{apiClient:De}=await import("./client.Bht704G-.js");return{apiClient:De}},__vite__mapDeps([4,5])),ve=o.settings.textStyle.layoutDirection,Pe=ve==="auto";for(let De=0;De<ie.length;De++){const _e=ie[De];if(_e===void 0)continue;const ce=u.images[_e];if(!(!ce||!ce.bubbleStates))try{let $e="";if(ce.cleanImageData?$e=ce.cleanImageData.includes("base64,")?ce.cleanImageData.split("base64,")[1]||"":ce.cleanImageData:ce.originalDataURL&&($e=ce.originalDataURL.includes("base64,")?ce.originalDataURL.split("base64,")[1]||"":ce.originalDataURL,console.log(`handleApplyToAll: 图片 ${_e} 使用原图作为背景（兜底）`)),!$e){console.log(`handleApplyToAll: 图片 ${_e} 没有可用的背景图，跳过`);continue}const Ue=ce.bubbleStates.map(Fe=>({translatedText:Fe.translatedText||"",coords:Fe.coords,fontSize:Fe.fontSize||o.settings.textStyle.fontSize,fontFamily:Fe.fontFamily||o.settings.textStyle.fontFamily,textDirection:kt(Fe),textColor:Fe.textColor||o.settings.textStyle.textColor,rotationAngle:Fe.rotationAngle||0,position:Fe.position||{x:0,y:0},strokeEnabled:Fe.strokeEnabled??o.settings.textStyle.strokeEnabled,strokeColor:Fe.strokeColor||o.settings.textStyle.strokeColor,strokeWidth:Fe.strokeWidth??o.settings.textStyle.strokeWidth})),Be=await ke.post("/api/re_render_image",{clean_image:$e,bubble_texts:Ue.map(Fe=>Fe.translatedText),bubble_coords:Ue.map(Fe=>Fe.coords),fontSize:o.settings.textStyle.fontSize,fontFamily:o.settings.textStyle.fontFamily,textDirection:Pe?"vertical":ve,textColor:o.settings.textStyle.textColor,bubble_states:Ue,use_individual_styles:!0,use_inpainting:!1,use_lama:!1,fillColor:null,is_font_style_change:!0,strokeEnabled:o.settings.textStyle.strokeEnabled,strokeColor:o.settings.textStyle.strokeColor,strokeWidth:o.settings.textStyle.strokeWidth});Be.rendered_image&&u.updateImageByIndex(_e,{translatedDataURL:`data:image/png;base64,${Be.rendered_image}`,hasUnsavedChanges:!0})}catch($e){console.error(`重渲染图片 ${_e} 失败:`,$e)}}}we(`已将 ${ge.join("、")} 应用到 ${ne} 张图片`,"success"),console.log(`[TranslateView] 应用设置到全部完成，更新了 ${ne} 张图片，重渲染了 ${ie.length} 张`)}catch(h){console.error("应用设置到全部失败:",h),we("应用设置失败","error")}}async function S(){w.value&&t("normal")&&await k.translateCurrentImage()}async function v(){Q.value&&t("normal")&&await k.translateAllImages()}async function I(){Q.value&&t("hq")&&await k.executeHqTranslation()}async function T(){Q.value&&t("proofread")&&await k.executeProofreading()}async function p(){w.value&&await k.removeTextOnly()}async function f(){Q.value&&await k.removeAllTexts()}function te(){if(!w.value)return;const E=w.value.fileName||`图片 ${u.currentImageIndex+1}`;confirm(`确定要删除当前图片 (${E}) 吗？`)&&(u.deleteCurrentImage(),we("图片已删除","success"))}function se(){Q.value&&confirm("确定要清除所有图片吗？这将丢失所有未保存的进度。")&&(u.clearImages(),we("所有图片已清除","success"))}async function m(){try{const E=await Yn(),P=await rn();if(E.success&&P.success)we("临时文件清理完成","success");else{const R=[];E.success||R.push("调试文件清理失败"),P.success||R.push("临时文件清理失败"),we(R.join("，"),"warning")}}catch{we("清理临时文件失败","error")}}function C(){A.goToPrevious()}function c(){A.goToNext()}function U(){ae.value=!ae.value}async function fe(){if(!d.value){we("没有失败的图片需要重新翻译","info");return}t("normal")&&await k.retryFailedImages()}async function K(){if(!Q.value){we("没有可保存的内容","warning");return}if(!(!_.value||!x.value))try{await a.saveChapterSession(_.value,x.value)?we("章节进度已保存","success"):we("保存失败","error")}catch(E){console.error("保存会话失败:",E),we("保存失败: "+(E instanceof Error?E.message:"未知错误"),"error")}}function Y(){$.value=!0}function Se(){we("设置已保存","success")}function g(){N.value=!0}function b(){we("🌙 该功能正在开发中，敬请期待！","info")}function M(E){const P=E.target;if(!(P instanceof HTMLInputElement||P instanceof HTMLTextAreaElement||P.getAttribute("contenteditable")==="true"||P.id==="bubbleTextEditor")&&!ae.value&&E.altKey)switch(E.key){case"ArrowLeft":E.preventDefault(),C();break;case"ArrowRight":E.preventDefault(),c();break;case"ArrowUp":if(E.preventDefault(),!o.settings.textStyle.autoFontSize){const h=o.settings.textStyle.fontSize;o.updateTextStyle({fontSize:h+1})}break;case"ArrowDown":if(E.preventDefault(),!o.settings.textStyle.autoFontSize){const h=o.settings.textStyle.fontSize;o.updateTextStyle({fontSize:Math.max(10,h-1)})}break}}async function D(E){const P=w.value;if(!P||!P.translatedDataURL){console.log(`自动字号设置变更: ${E} (仅影响下次翻译)`);return}const R=P.bubbleStates;if(!R||!Array.isArray(R)||R.length===0){console.log("当前图片没有 bubbleStates，跳过重渲染");return}if(console.log(`自动字号设置变更: ${E}，将重新渲染...`),E){console.log("自动字号已开启，重新计算字号并渲染...");try{const{apiClient:h}=await lt(async()=>{const{apiClient:ie}=await import("./client.Bht704G-.js");return{apiClient:ie}},__vite__mapDeps([4,5]));let L="";if(P.cleanImageData){const ie=P.cleanImageData;L=ie.includes("base64,")?ie.split("base64,")[1]||"":ie}else P.originalDataURL&&(L=P.originalDataURL.includes("base64,")?P.originalDataURL.split("base64,")[1]||"":P.originalDataURL);if(!L){console.log("没有可用的背景图，跳过重渲染");return}const X=R.map(ie=>({translatedText:ie.translatedText||"",coords:ie.coords,fontSize:ie.fontSize||o.settings.textStyle.fontSize,fontFamily:ie.fontFamily||o.settings.textStyle.fontFamily,textDirection:kt(ie),textColor:ie.textColor||o.settings.textStyle.textColor,rotationAngle:ie.rotationAngle||0,position:ie.position||{x:0,y:0},strokeEnabled:ie.strokeEnabled??o.settings.textStyle.strokeEnabled,strokeColor:ie.strokeColor||o.settings.textStyle.strokeColor,strokeWidth:ie.strokeWidth??o.settings.textStyle.strokeWidth})),ne=X.map(ie=>ie.translatedText),ye=X.map(ie=>ie.coords),ge=await h.post("/api/re_render_image",{clean_image:L,bubble_texts:ne,bubble_coords:ye,fontSize:o.settings.textStyle.fontSize,fontFamily:o.settings.textStyle.fontFamily,textDirection:o.settings.textStyle.layoutDirection==="auto"?"vertical":o.settings.textStyle.layoutDirection,textColor:o.settings.textStyle.textColor,bubble_states:X,use_individual_styles:!0,use_inpainting:!1,use_lama:!1,fillColor:null,is_font_style_change:!0,autoFontSize:!0,strokeEnabled:o.settings.textStyle.strokeEnabled,strokeColor:o.settings.textStyle.strokeColor,strokeWidth:o.settings.textStyle.strokeWidth});if(ge.rendered_image){if(ge.bubble_states&&Array.isArray(ge.bubble_states)){const ie=R.map((ke,ve)=>({...ke,fontSize:ge.bubble_states[ve]?.fontSize??ke.fontSize}));u.updateCurrentImage({translatedDataURL:`data:image/png;base64,${ge.rendered_image}`,bubbleStates:ie,hasUnsavedChanges:!0}),i.setBubbles(ie)}else u.updateCurrentImage({translatedDataURL:`data:image/png;base64,${ge.rendered_image}`,hasUnsavedChanges:!0});console.log("自动字号渲染成功")}else ge.error&&(console.error("自动字号渲染失败:",ge.error),we("重新渲染失败: "+ge.error,"error"))}catch(h){console.error("自动字号渲染出错:",h)}}else{const h=o.settings.textStyle.fontSize;console.log(`自动字号已关闭，使用固定字号 ${h} 渲染...`);const L=R.map(X=>({...X,fontSize:h}));u.updateCurrentImage({bubbleStates:L}),i.setBubbles(L),await O("fontSize",h)}}async function O(E,P){const R=w.value;if(!R||!R.translatedDataURL||!R.bubbleStates||R.bubbleStates.length===0||!["fontSize","fontFamily","layoutDirection","textColor","strokeEnabled","strokeColor","strokeWidth","fillColor"].includes(E))return;console.log(`全局设置变更 (${E}=${P})，准备重渲染...`);const X={fontSize:"fontSize",fontFamily:"fontFamily",layoutDirection:"textDirection",textColor:"textColor",strokeEnabled:"strokeEnabled",strokeColor:"strokeColor",strokeWidth:"strokeWidth",fillColor:"fillColor"}[E];if(X&&R.bubbleStates)if(E==="layoutDirection"&&P==="auto")console.log("排版方向设置为 'auto'，不修改气泡的 textDirection，使用 autoTextDirection 渲染");else{const ne=R.bubbleStates.map(ye=>({...ye,[X]:P}));u.updateCurrentImage({bubbleStates:ne}),i.setBubbles(ne)}try{const ye=u.currentImage?.bubbleStates||R.bubbleStates||[];if(ye.length===0||!ye[0]?.coords){console.log("没有有效的气泡坐标，跳过重渲染");return}const ge=o.settings.textStyle.layoutDirection,ie=ye.map(ce=>({translatedText:ce.translatedText||"",coords:ce.coords,fontSize:ce.fontSize||o.settings.textStyle.fontSize,fontFamily:ce.fontFamily||o.settings.textStyle.fontFamily,textDirection:kt(ce),textColor:ce.textColor||o.settings.textStyle.textColor,rotationAngle:ce.rotationAngle||0,position:ce.position||{x:0,y:0},strokeEnabled:ce.strokeEnabled??o.settings.textStyle.strokeEnabled,strokeColor:ce.strokeColor||o.settings.textStyle.strokeColor,strokeWidth:ce.strokeWidth??o.settings.textStyle.strokeWidth})),ke=ie.map(ce=>ce.translatedText),ve=ie.map(ce=>ce.coords);let Pe="";if(R.cleanImageData){const ce=R.cleanImageData;Pe=ce.includes("base64,")?ce.split("base64,")[1]||"":ce}else R.originalDataURL&&(Pe=R.originalDataURL.includes("base64,")?R.originalDataURL.split("base64,")[1]||"":R.originalDataURL,console.log("handleTextStyleChanged: 使用原图作为背景（兜底）"));if(!Pe){console.log("没有可用的背景图，跳过重渲染");return}const{apiClient:De}=await lt(async()=>{const{apiClient:ce}=await import("./client.Bht704G-.js");return{apiClient:ce}},__vite__mapDeps([4,5])),_e=await De.post("/api/re_render_image",{clean_image:Pe,bubble_texts:ke,bubble_coords:ve,fontSize:o.settings.textStyle.fontSize,fontFamily:o.settings.textStyle.fontFamily,textDirection:ge==="auto"?"vertical":ge,textColor:o.settings.textStyle.textColor,bubble_states:ie,use_individual_styles:!0,use_inpainting:!1,use_lama:!1,fillColor:null,is_font_style_change:!0,strokeEnabled:o.settings.textStyle.strokeEnabled,strokeColor:o.settings.textStyle.strokeColor,strokeWidth:o.settings.textStyle.strokeWidth});_e.rendered_image?(u.updateCurrentImage({translatedDataURL:`data:image/png;base64,${_e.rendered_image}`,hasUnsavedChanges:!0}),console.log("设置变更后重新渲染成功")):_e.error&&console.error("重新渲染失败:",_e.error)}catch(ne){console.error("设置变更后重新渲染失败:",ne)}}function re(E){A.switchImage(E)}return(E,P)=>{const R=Po("router-link");return V(),J("div",{class:Le(["translate-page",{"edit-mode-active":ae.value}])},[e("header",Wp,[e("div",Kp,[e("div",qp,[Ie(R,{to:"/",title:"返回书架"},{default:_t(()=>[...P[2]||(P[2]=[e("img",{src:"/pic/logo.png",alt:"Saber-Translator Logo",class:"app-logo"},null,-1),e("span",{class:"app-name"},"Saber-Translator",-1)])]),_:1})]),e("div",Hp,[P[6]||(P[6]=e("a",{href:"/",class:"back-to-shelf",title:"返回书架"},"📚",-1)),l.value?(V(),J("button",{key:0,class:"save-header-btn",title:"保存进度",onClick:K}," 💾 ")):Te("",!0),e("button",{id:"openSettingsBtn",class:"settings-header-btn",title:"打开设置",onClick:Y},[...P[3]||(P[3]=[e("span",{class:"icon"},"⚙️",-1),e("span",null,"设置",-1)])]),P[7]||(P[7]=e("a",{href:"http://www.mashirosaber.top",target:"_blank",class:"tutorial-link"},"使用教程",-1)),e("a",{href:"javascript:void(0)",class:"donate-link",onClick:g},[...P[4]||(P[4]=[e("span",null,"❤️ 请作者喝奶茶",-1)])]),P[8]||(P[8]=e("a",{href:"https://github.com/MashiroSaber03",target:"_blank",class:"github-link"},[e("img",{src:"/pic/github.jpg",alt:"GitHub",class:"github-icon"})],-1)),e("button",{class:"theme-toggle",title:"功能开发中",onClick:b},[...P[5]||(P[5]=[e("span",{class:"theme-icon"},"☀️",-1)])])])])]),e("div",Jp,[Ie(ys,{onTranslateCurrent:S,onTranslateAll:v,onHqTranslate:I,onProofread:T,onRemoveText:p,onRemoveAllText:f,onRetryFailed:fe,onDeleteCurrent:te,onClearAll:se,onCleanTemp:m,onOpenPlugins:Y,onOpenSettings:Y,onPrevious:C,onNext:c,onApplyToAll:B,onTextStyleChanged:O,onAutoFontSizeChanged:D}),e("main",Yp,[e("section",Xp,[Ie(Sa,{ref_key:"imageUploadRef",ref:le,onUploadComplete:F},null,512),he(a).loadingProgress.total>0?(V(),rt(dn,{key:0,visible:!0,percentage:he(a).loadingProgress.current/he(a).loadingProgress.total*100,label:he(a).loadingProgress.message},null,8,["percentage","label"])):Te("",!0),Ie(dl,{progress:he(k).progress.value,"show-controls":H.value},null,8,["progress","show-controls"]),j.value&&l.value?(V(),J("div",jp,[...P[9]||(P[9]=[e("span",{style:{color:"#888","font-size":"0.85em"}}," （书架模式下退出前请点击顶部保存按钮） ",-1)])])):Te("",!0)]),Ie(Ns,{ref_key:"imageResultRef",ref:Z,"is-edit-mode":ae.value,onToggleEditMode:U,onRetryFailed:fe},null,8,["is-edit-mode"])]),Q.value&&!ae.value?(V(),rt(_l,{key:0,onSelect:re})):Te("",!0)]),w.value&&ae.value?(V(),rt(Np,{key:0,"is-edit-mode-active":ae.value,onExit:U},null,8,["is-edit-mode-active"])):Te("",!0),Ie(Js,{onOpenSettings:Y}),Ie(Ad,{modelValue:$.value,"onUpdate:modelValue":P[0]||(P[0]=h=>$.value=h),onSave:Se},null,8,["modelValue"]),N.value?(V(),rt(pl,{key:1,onClose:P[1]||(P[1]=h=>N.value=!1)})):Te("",!0)],2)}}}),ib=je(Gp,[["__scopeId","data-v-7ce000dd"]]);export{ib as default};
