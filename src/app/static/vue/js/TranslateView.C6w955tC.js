const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["js/index.D0MSxQDE.js","js/vue-vendor.BToK7iAN.js","assets/index.DGYZNHnW.css","js/session.Kpy-QhBa.js","js/client.Bht704G-.js","js/utils-vendor.B9ygI19o.js"])))=>i.map(i=>d[i]);
import{D as on,b as an,c as sn,d as On,a as it,_ as Xe,u as Qe,s as Re,e as ct,f as Ht,g as Yt,h as Xt,i as Jt,j as Un,k as jt,B as In,l as Tn,m as wo,F as Nt,n as Dn,o as Rn,p as _o,L as Mn}from"./index.D0MSxQDE.js";import{d as ln,r as h,c as X,a as Je,i as U,v as we,e,t as pe,x as tt,h as P,b as lt,n as Le,B as Oe,l as rt,y as ie,E as Ye,f as Te,G as Gt,w as ht,H as Ze,F as Ke,j as je,o as St,I as We,u as ce,J as st,K as zn,g as $o,L as kt,z as Be,M as Io,k as at,N as Zt,O as yt,P as Bn,D as To,C as Do}from"./vue-vendor.BToK7iAN.js";import{p as Ro,a as Mo,b as Bo,c as Eo,d as Po,e as Ao,f as Fo,h as Lo,i as Oo,j as Uo,k as rn,l as Vn}from"./system.DQNodmdY.js";import{getFontList as Nn,uploadFont as zo,getTextboxPrompts as Vo,getPrompts as No,configApi as Ge,getFontListApi as Wo}from"./config.CbW489zd.js";import{_ as Ne}from"./CustomSelect.vue_vue_type_style_index_0_lang.CWP4Q_ni.js";import{B as Wn}from"./BaseModal.Chcbe_b7.js";import{apiClient as nt}from"./client.Bht704G-.js";import{getBookDetail as Ko}from"./bookshelf.C_zUWUVG.js";import"./utils-vendor.B9ygI19o.js";async function Mt(t){return nt.post("/api/translate_image",t)}async function Kn(t){return nt.post("/api/re_render_image",t)}async function qo(t){return nt.post("/api/translate_single_text",t)}async function Qt(t){return nt.post("/api/hq_translate_batch",t)}async function en(t,u,l){return nt.post("/api/detect_boxes",{image:t,detector_type:u,...l})}async function qn(t,u,l,i){return nt.post("/api/ocr_single_bubble",{image_data:t,bubble_coords:u,ocr_engine:l,...i})}async function tn(t,u,l){return nt.post("/api/inpaint_single_bubble",{image_data:t,bubble_coords:u,...l&&{current_clean_image:l}})}const Ho=Object.freeze(Object.defineProperty({__proto__:null,detectBoxes:en,hqTranslateBatch:Qt,inpaintSingleBubble:tn,ocrSingleBubble:qn,reRenderImage:Kn,translateImage:Mt,translateSingleText:qo},Symbol.toStringTag,{value:"Module"}));async function Yo(){return nt.get("/api/plugins")}async function Xo(t){return nt.post(`/api/plugins/${t}/enable`)}async function Jo(t){return nt.post(`/api/plugins/${t}/disable`)}async function jo(t){return nt.delete(`/api/plugins/${t}`)}async function Go(t){return nt.get(`/api/plugins/${t}/config_schema`)}async function Zo(t){return nt.get(`/api/plugins/${t}/config`)}async function Qo(t,u){return nt.post(`/api/plugins/${t}/config`,u)}async function ea(){return nt.get("/api/plugins/default_states")}async function ta(t,u){return nt.post(`/api/plugins/${t}/set_default_state`,{enabled:u})}async function na(){return{states:(await ea()).default_states}}const oa=ta,aa=Go,sa=Zo,la=Qo;function ia(){return`img_${Date.now()}_${Math.random().toString(36).substring(2,9)}`}function En(t,u,l){return{id:ia(),fileName:t,originalDataURL:u,translatedDataURL:null,cleanImageData:null,bubbleStates:null,translationStatus:"pending",translationFailed:!1,fontSize:25,autoFontSize:!0,fontFamily:"fonts/STSONG.TTF",layoutDirection:"vertical",textColor:"#000000",fillColor:On,inpaintMethod:"solid",strokeEnabled:sn,strokeColor:an,strokeWidth:on,hasUnsavedChanges:!1,...l}}const ot=ln("image",()=>{const t=h([]),u=h(-1),l=h(!1),i=h(!1),n=h(null),a=X(()=>u.value>=0&&u.value<t.value.length?t.value[u.value]??null:null),o=X(()=>t.value.length),S=X(()=>t.value.length>0),y=X(()=>u.value>0),C=X(()=>u.value<t.value.length-1),b=X(()=>t.value.filter(x=>x.translationFailed).length),I=X(()=>t.value.filter(x=>x.translationStatus==="completed").length),R=X(()=>t.value.filter(x=>x.translationStatus==="pending").length);function E(x,oe,me){const ue=En(x,oe,me);return t.value.push(ue),t.value.length===1&&(u.value=0),console.log(`图片已添加: ${x}，当前共 ${t.value.length} 张图片`),ue}function g(x){const oe=x.map(({fileName:ue,originalDataURL:Se,overrides:K})=>En(ue,Se,K)),me=t.value.length===0;return t.value.push(...oe),me&&t.value.length>0&&(u.value=0),console.log(`批量添加了 ${oe.length} 张图片，当前共 ${t.value.length} 张`),oe}function d(x){t.value=x.map(oe=>({...oe,strokeEnabled:oe.strokeEnabled??sn,strokeColor:oe.strokeColor||an,strokeWidth:oe.strokeWidth??on,hasUnsavedChanges:oe.hasUnsavedChanges||!1})),t.value.length>0?u.value=Math.min(Math.max(0,u.value),t.value.length-1):u.value=-1,console.log(`图片数组已设置，共 ${t.value.length} 张图片`)}function Y(x){return x<0||x>=t.value.length?(console.warn(`删除失败: 无效的索引 ${x}`),!1):(t.value.splice(x,1),u.value===x?(u.value=Math.min(x,t.value.length-1),t.value.length===0&&(u.value=-1)):u.value>x&&u.value--,console.log(`图片已删除，当前共 ${t.value.length} 张图片`),!0)}function q(){return Y(u.value)}function te(){t.value=[],u.value=-1,l.value=!1,i.value=!1,n.value=null,console.log("所有图片已清除")}function M(x){x>=-1&&x<t.value.length?(u.value=x,console.log(`当前图片索引已设置为 ${x}`)):console.warn(`设置索引失败: 无效的索引 ${x}`)}function w(){return y.value?(u.value--,!0):!1}function Z(){return C.value?(u.value++,!0):!1}function z(x){a.value?(Object.assign(a.value,x),console.log("当前图片属性已更新:",Object.keys(x))):console.warn("更新失败: 当前没有选中的图片")}function re(x,oe){if(x>=0&&x<t.value.length){const me=t.value[x];me&&(Object.assign(me,oe),console.log(`图片 ${x} 属性已更新:`,Object.keys(oe)))}else console.warn(`更新失败: 无效的索引 ${x}`)}function G(x){a.value&&(a.value.bubbleStates=x,a.value.hasUnsavedChanges=!0,console.log(`当前图片气泡状态已更新，共 ${x?.length??0} 个气泡`))}function A(x,oe){a.value?(a.value[x]=oe,a.value.hasUnsavedChanges=!0,console.log(`当前图片属性 ${String(x)} 已更新`)):console.warn("更新失败: 当前没有选中的图片")}function c(x,oe){a.value&&(a.value.translatedDataURL=x,oe&&(a.value.cleanImageData=oe),a.value.translationStatus="completed",a.value.translationFailed=!1,a.value.hasUnsavedChanges=!0,console.log("当前图片翻译结果已更新"))}function T(x,oe,me){if(x>=0&&x<t.value.length){const ue=t.value[x];ue&&(ue.translationStatus=oe,ue.translationFailed=oe==="failed",me&&(ue.errorMessage=me),console.log(`图片 ${x} 翻译状态: ${oe}`))}}function ne(x){a.value&&(a.value.translationStatus="failed",a.value.translationFailed=!0,a.value.errorMessage=x,console.log(`当前图片翻译失败: ${x}`))}function m(){t.value.forEach(x=>{x.translationStatus="pending",x.translationFailed=!1,x.errorMessage=void 0}),console.log("所有图片翻译状态已重置")}function V(x){l.value=x,x||(i.value=!1,n.value=null),console.log(`批量翻译状态: ${x?"进行中":"已完成"}`)}function J(x){i.value=x,console.log(`批量翻译暂停状态: ${x?"已暂停":"继续中"}`)}function le(x){n.value=x}function s(){if(i.value&&n.value){i.value=!1;const x=n.value;n.value=null,x(),console.log("批量翻译已继续")}}function p(){return t.value.map((x,oe)=>x.translationFailed?oe:-1).filter(x=>x!==-1)}return{images:t,currentImageIndex:u,isBatchTranslationInProgress:l,isBatchTranslationPaused:i,batchTranslationResumeCallback:n,currentImage:a,imageCount:o,hasImages:S,canGoPrevious:y,canGoNext:C,failedImageCount:b,completedImageCount:I,pendingImageCount:R,addImage:E,addImages:g,setImages:d,deleteImage:Y,deleteCurrentImage:q,clearImages:te,setCurrentImageIndex:M,goToPrevious:w,goToNext:Z,updateCurrentImage:z,updateImageByIndex:re,updateCurrentBubbleStates:G,updateCurrentImageProperty:A,updateCurrentTranslationResult:c,setTranslationStatus:T,markCurrentAsFailed:ne,resetAllTranslationStatus:m,setBatchTranslationInProgress:V,setBatchTranslationPaused:J,setBatchTranslationResumeCallback:le,resumeBatchTranslation:s,getFailedImageIndices:p}}),Pn=Object.freeze(Object.defineProperty({__proto__:null,useImageStore:ot},Symbol.toStringTag,{value:"Module"})),Hn=ln("session",()=>{const t=h(null),u=h({bookId:null,chapterId:null,bookTitle:null,chapterTitle:null}),l=h([]),i=h(!1),n=h({current:0,total:0,message:""}),a=h(null),o=h(!1),S=X(()=>u.value.bookId!==null&&u.value.chapterId!==null),y=X(()=>u.value.bookId),C=X(()=>u.value.chapterId);function b(m,V,J=null,le=null){u.value={bookId:m,chapterId:V,bookTitle:J,chapterTitle:le},console.log(`会话上下文已设置: 书籍=${m}, 章节=${V}`)}function I(m,V,J,le){b(m,V,J,le)}function R(){u.value={bookId:null,chapterId:null,bookTitle:null,chapterTitle:null},console.log("会话上下文已清除")}function E(m){const V=m.get("book"),J=m.get("chapter");V&&J&&b(V,J)}function g(m){t.value=m,console.log(`当前会话名称: ${m}`)}function d(){t.value=null}function Y(m){l.value=m,console.log(`会话列表已更新，共 ${m.length} 个会话`)}function q(m){const V=l.value.findIndex(J=>J.name===m.name);V>=0?l.value[V]=m:l.value.unshift(m)}function te(m){const V=l.value.findIndex(J=>J.name===m);V>=0&&l.value.splice(V,1)}function M(m,V){const J=l.value.find(le=>le.name===m);J&&(J.name=V)}function w(m){i.value=m}function Z(m){o.value=m}function z(m){a.value=m}function re(m,V,J,le){return{name:m,version:"2.0",savedAt:new Date().toISOString(),imageCount:V.length,ui_settings:le,images:V.map(s=>({originalDataURL:s.originalDataURL,translatedDataURL:s.translatedDataURL||void 0,cleanImageData:s.cleanImageData||void 0,bubbleStates:s.bubbleStates||void 0,fileName:s.fileName,fontSize:s.fontSize,autoFontSize:s.autoFontSize,fontFamily:s.fontFamily,layoutDirection:s.layoutDirection,textColor:s.textColor,fillColor:s.fillColor,inpaintMethod:s.inpaintMethod,strokeEnabled:s.strokeEnabled,strokeColor:s.strokeColor,strokeWidth:s.strokeWidth,translationStatus:s.translationStatus,translationFailed:s.translationFailed})),currentImageIndex:J}}function G(){t.value=null,u.value={bookId:null,chapterId:null,bookTitle:null,chapterTitle:null},l.value=[],i.value=!1,o.value=!1,a.value=null,console.log("会话状态已重置")}async function A(m){if(!m||typeof m!="string")return null;if(m.startsWith("data:"))return m;if(!m.startsWith("/api/"))return null;try{const V=await fetch(m);if(!V.ok)return null;const J=await V.blob();return new Promise(le=>{const s=new FileReader;s.onloadend=()=>le(s.result),s.onerror=()=>le(null),s.readAsDataURL(J)})}catch(V){return console.error(`转换图片 URL 失败: ${m}`,V),null}}async function c(m,V){const J=m.length;for(let le=0;le<J;le++){const s=m[le];if(s){if(V&&V(le+1,J),s.originalDataURL&&s.originalDataURL.startsWith("/api/")){const p=await A(s.originalDataURL);p&&(s.originalDataURL=p)}if(s.translatedDataURL&&s.translatedDataURL.startsWith("/api/")){const p=await A(s.translatedDataURL);p&&(s.translatedDataURL=p)}if(s.cleanImageData&&s.cleanImageData.startsWith("/api/")){const p=await A(s.cleanImageData);p&&(s.cleanImageData=p.replace(/^data:image\/\w+;base64,/,""))}}}}async function T(m){w(!0),z(null),n.value={current:0,total:0,message:"正在加载..."};try{const{useImageStore:V}=await it(async()=>{const{useImageStore:K}=await Promise.resolve().then(()=>Pn);return{useImageStore:K}},void 0),{useSettingsStore:J}=await it(async()=>{const{useSettingsStore:K}=await import("./index.D0MSxQDE.js").then(k=>k.q);return{useSettingsStore:K}},__vite__mapDeps([0,1,2])),{useBubbleStore:le}=await it(async()=>{const{useBubbleStore:K}=await Promise.resolve().then(()=>ms);return{useBubbleStore:K}},void 0),s=V(),p=J(),x=le(),{loadSessionByPathApi:oe}=await it(async()=>{const{loadSessionByPathApi:K}=await import("./session.Kpy-QhBa.js");return{loadSessionByPathApi:K}},__vite__mapDeps([3,4,5])),me=await oe(m);if(!me.success||!me.session)throw new Error(me.error||"加载会话失败");const ue=me.session;if(ue.images&&ue.images.length>0){const K=ue.images.map((H,_)=>({id:`session-${_}-${Date.now()}`,originalDataURL:H.originalDataURL,translatedDataURL:H.translatedDataURL||null,cleanImageData:H.cleanImageData||null,bubbleStates:H.bubbleStates||[],fileName:H.fileName||`image-${_+1}.png`,translationStatus:H.translationStatus||"pending",translationFailed:!!H.translationFailed,hasUnsavedChanges:!1,fontSize:H.fontSize||24,autoFontSize:H.autoFontSize??!0,fontFamily:H.fontFamily||"Microsoft YaHei",layoutDirection:H.layoutDirection||"vertical",textColor:H.textColor||"#000000",fillColor:H.fillColor||"#FFFFFF",inpaintMethod:H.inpaintMethod||"litelama",strokeEnabled:H.strokeEnabled??!1,strokeColor:H.strokeColor||"#FFFFFF",strokeWidth:H.strokeWidth||2}));K.length>0&&(console.log("正在加载图片..."),n.value={current:0,total:K.length,message:"正在加载图片..."},await c(K,(H,_)=>{const D=H/_*100;n.value={current:H,total:_,message:`加载图片 ${H}/${_}...`},console.log(`加载图片 ${H}/${_}... (${D.toFixed(0)}%)`)}),n.value={current:K.length,total:K.length,message:"加载完成"},console.log("图片加载完成，已转换为 Base64"),setTimeout(()=>{n.value={current:0,total:0,message:""}},500)),s.setImages(K);let k=0;typeof ue.currentImageIndex=="number"&&(k=ue.currentImageIndex,(k>=K.length||k<0)&&(k=K.length>0?0:-1)),s.setCurrentImageIndex(k);const de=K[k];de&&de.bubbleStates&&de.bubbleStates.length>0?x.setBubbles(de.bubbleStates,!0):x.clearBubbles(),console.log(`按路径加载会话成功: ${m}, 共 ${K.length} 张图片`)}const Se=ue.ui_settings;if(Se){(Se.targetLanguage||Se.sourceLanguage)&&p.updateSettings({targetLanguage:Se.targetLanguage||void 0,sourceLanguage:Se.sourceLanguage||void 0});const K=Se.useInpaintingMethod,de=["solid","lama_mpe","litelama"].includes(K)?K:p.settings.textStyle.inpaintMethod;p.updateTextStyle({fontSize:Se.fontSize||p.settings.textStyle.fontSize,autoFontSize:Se.autoFontSize??p.settings.textStyle.autoFontSize,fontFamily:Se.fontFamily||p.settings.textStyle.fontFamily,layoutDirection:Se.layoutDirection||p.settings.textStyle.layoutDirection,textColor:Se.textColor||p.settings.textStyle.textColor,fillColor:Se.fillColor||p.settings.textStyle.fillColor,inpaintMethod:de,strokeEnabled:Se.strokeEnabled??p.settings.textStyle.strokeEnabled,strokeColor:Se.strokeColor||p.settings.textStyle.strokeColor,strokeWidth:Se.strokeWidth||p.settings.textStyle.strokeWidth}),console.log("UI 设置已恢复")}return g(m),!0}catch(V){const J=V instanceof Error?V.message:"加载会话失败";throw z(J),console.error(`按路径加载会话失败: ${m}`,V),V}finally{w(!1)}}async function ne(m,V){if(!m||!V)return console.log("未在书籍/章节模式，不支持保存"),!1;console.log(`保存章节会话（分批）: book=${m}, chapter=${V}`);const{useImageStore:J}=await it(async()=>{const{useImageStore:me}=await Promise.resolve().then(()=>Pn);return{useImageStore:me}},void 0),{useSettingsStore:le}=await it(async()=>{const{useSettingsStore:me}=await import("./index.D0MSxQDE.js").then(ue=>ue.q);return{useSettingsStore:me}},__vite__mapDeps([0,1,2])),s=J(),p=le(),x=Array.isArray(s.images)?s.images:[];if(!x||x.length===0)return console.log("没有图片数据可保存"),!1;const oe=`bookshelf/${m}/${V}`;Z(!0),z(null),n.value={current:0,total:100,message:"准备保存..."};try{const{batchSaveStartApi:me,batchSaveImageApi:ue,batchSaveCompleteApi:Se}=await it(async()=>{const{batchSaveStartApi:f,batchSaveImageApi:B,batchSaveCompleteApi:j}=await import("./session.Kpy-QhBa.js");return{batchSaveStartApi:f,batchSaveImageApi:B,batchSaveCompleteApi:j}},__vite__mapDeps([3,4,5])),K=x.length;n.value={current:5,total:100,message:"收集元数据..."};const{textStyle:k,targetLanguage:de,sourceLanguage:H}=p.settings,_={targetLanguage:de,sourceLanguage:H,fontSize:k.fontSize,autoFontSize:k.autoFontSize,fontFamily:k.fontFamily,layoutDirection:k.layoutDirection,textColor:k.textColor,useInpaintingMethod:k.inpaintMethod,fillColor:k.fillColor,strokeEnabled:k.strokeEnabled,strokeColor:k.strokeColor,strokeWidth:k.strokeWidth},D=x.map(f=>{const B={};for(const j of Object.keys(f))j!=="originalDataURL"&&j!=="translatedDataURL"&&j!=="cleanImageData"&&(B[j]=f[j]);return B.hasOriginalData=!!f.originalDataURL,B.hasTranslatedData=!!f.translatedDataURL,B.hasCleanData=!!f.cleanImageData,B}),$={ui_settings:_,images_meta:D,currentImageIndex:s.currentImageIndex};n.value={current:10,total:100,message:"初始化保存..."};const r=await me(oe,$);if(!r.success)throw new Error(r.error||"初始化保存失败");const v=r.session_folder;if(!v)throw new Error("未获取到会话文件夹路径");console.log(`会话文件夹: ${v}`);let W=0,ge=0;const N=f=>!!f&&typeof f=="string"&&f.startsWith("data:");for(let f=0;f<K;f++){const B=x[f];if(!B)continue;const j=10+f/K*80;if(n.value={current:Math.round(j),total:100,message:`保存图片 ${f+1}/${K}...`},N(B.originalDataURL))try{const ee=await ue(v,f,"original",B.originalDataURL);ee.success||(console.error(`保存图片 ${f} original 失败:`,ee.error),ge++)}catch(ee){console.error(`保存图片 ${f} original 出错:`,ee),ge++}if(N(B.translatedDataURL))try{const ee=await ue(v,f,"translated",B.translatedDataURL);ee.success||(console.error(`保存图片 ${f} translated 失败:`,ee.error),ge++)}catch(ee){console.error(`保存图片 ${f} translated 出错:`,ee),ge++}if(B.cleanImageData&&typeof B.cleanImageData=="string"&&!B.cleanImageData.startsWith("/api/"))try{const ee=await ue(v,f,"clean",B.cleanImageData);ee.success||(console.error(`保存图片 ${f} clean 失败:`,ee.error),ge++)}catch(ee){console.error(`保存图片 ${f} clean 出错:`,ee),ge++}W++}n.value={current:95,total:100,message:"完成保存..."};const O=await Se(v,D);if(!O.success)throw new Error(O.error||"完成保存失败");return n.value={current:100,total:100,message:"保存完成"},console.log(`分批保存完成: ${W} 张图片, ${ge} 个失败`),setTimeout(()=>{n.value={current:0,total:0,message:""}},1e3),!0}catch(me){const ue=me instanceof Error?me.message:"保存章节会话失败";return z(ue),console.error("分批保存失败:",me),n.value={current:0,total:0,message:""},!1}finally{Z(!1)}}return{currentSessionName:t,context:u,sessionList:l,isLoading:i,isSaving:o,error:a,loadingProgress:n,isBookshelfMode:S,currentBookId:y,currentChapterId:C,setContext:b,clearContext:R,parseContextFromUrl:E,setSessionName:g,clearSessionName:d,setSessionList:Y,addToSessionList:q,removeFromSessionList:te,renameInSessionList:M,setLoading:w,setSaving:Z,setError:z,createSessionData:re,imageUrlToBase64:A,saveChapterSession:ne,loadSessionByPath:T,setBookChapterContext:I,reset:G}}),ra={key:0,class:"translation-progress-bar"},ua={class:"progress-bar-label"},ca={class:"progress-bar"},da=Je({__name:"ProgressBar",props:{visible:{type:Boolean,default:!0},percentage:{},label:{default:"进度"}},setup(t){return(u,l)=>t.visible?(P(),U("div",ra,[e("div",ua,pe(t.label),1),e("div",ca,[e("div",{class:"progress",style:tt({width:`${t.percentage}%`})},null,4)])])):we("",!0)}}),un=Xe(da,[["__scopeId","data-v-f373c973"]]),ga={class:"image-upload"},ba={class:"error-text"},va={key:2,class:"loading-overlay"},fa=Je({__name:"ImageUpload",emits:["uploadStart","uploadComplete","uploadError"],setup(t,{expose:u,emit:l}){const i=l,n=ot(),a=Qe(),o=h(null),S=h(!1),y=h(!1),C=h(""),b=h(0),I=h(""),R=h(!1),E=X(()=>a.settings.pdfProcessingMethod);function g(){o.value?.click()}async function d(T){const ne=T.target;!ne.files||ne.files.length===0||(await M(Array.from(ne.files)),ne.value="")}async function Y(T){T.preventDefault(),y.value=!1,!(!T.dataTransfer?.files||T.dataTransfer.files.length===0)&&await M(Array.from(T.dataTransfer.files))}function q(T){T.preventDefault(),y.value=!0}function te(T){const ne=T.currentTarget.getBoundingClientRect(),m=T.clientX,V=T.clientY;(m<ne.left||m>ne.right||V<ne.top||V>ne.bottom)&&(y.value=!1)}async function M(T){if(T.length!==0){S.value=!0,C.value="",R.value=!0,b.value=0,i("uploadStart");try{const ne=w(T);let m=0;const V=ne.length;for(let J=0;J<ne.length;J++){const le=ne[J];if(!le)continue;I.value=le.name;const s=le.type,p=le.name.toLowerCase();if(s.startsWith("image/"))await Z(le),m++;else if(s==="application/pdf"||p.endsWith(".pdf")){const x=await z(le);m+=x}else if(p.endsWith(".mobi")||p.endsWith(".azw")||p.endsWith(".azw3")){const x=await A(le);m+=x}else console.warn(`不支持的文件类型: ${le.name}`),Re(`不支持的文件类型: ${le.name}`,"warning");b.value=Math.round((J+1)/V*100)}m>0&&(Re(`已添加 ${m} 张图片`,"success"),i("uploadComplete",m))}catch(ne){console.error("处理文件失败:",ne);const m=ne instanceof Error?ne.message:"处理文件失败，请重试";C.value=m,Re(m,"error"),i("uploadError",m)}finally{S.value=!1,R.value=!1,I.value=""}}}function w(T){return[...T].sort((ne,m)=>ne.name.localeCompare(m.name,void 0,{numeric:!0,sensitivity:"base"}))}async function Z(T){return new Promise((ne,m)=>{const V=new FileReader;V.onload=J=>{const le=J.target?.result;n.addImage(T.name,le),ne()},V.onerror=()=>m(new Error(`读取图片文件失败: ${T.name}`)),V.readAsDataURL(T)})}async function z(T){return E.value==="frontend"?await re(T):await G(T)}async function re(T){try{const ne=await it(()=>import("./pdf.U7tdldy2.js").then(s=>s.p),[]);ne.GlobalWorkerOptions.workerSrc=`https://cdnjs.cloudflare.com/ajax/libs/pdf.js/${ne.version}/pdf.worker.min.js`;const m=await T.arrayBuffer(),V=await ne.getDocument({data:m}).promise,J=V.numPages;Re(`正在解析 PDF，共 ${J} 页...`,"info");let le=0;for(let s=1;s<=J;s++){I.value=`${T.name} - 第 ${s}/${J} 页`,b.value=Math.round(s/J*100);const p=await V.getPage(s),oe=p.getViewport({scale:2}),me=document.createElement("canvas"),ue=me.getContext("2d");me.width=oe.width,me.height=oe.height,await p.render({canvasContext:ue,viewport:oe}).promise;const Se=me.toDataURL("image/png"),K=`${T.name.replace(".pdf","")}_page_${String(s).padStart(3,"0")}.png`;n.addImage(K,Se),le++}return le}catch(ne){return console.error("前端 PDF 解析失败:",ne),Re("前端 PDF 解析失败，尝试使用后端解析...","warning"),await G(T)}}async function G(T){let ne=null;try{Re("正在上传 PDF 文件...","info");const m=await Ro(T,5);if(!m.success||!m.session_id)throw new Error(m.error||"PDF 解析启动失败");ne=m.session_id;const V=m.total_pages||0;Re(`正在解析 PDF，共 ${V} 页...`,"info");let J=0,le=!0;for(;le;){I.value=`${T.name} - 已处理 ${J}/${V} 页`,b.value=V>0?Math.round(J/V*100):0;const s=await Mo(ne);if(!s.success)throw new Error(s.error||"PDF 批次解析失败");if(s.images&&s.images.length>0){for(let p=0;p<s.images.length;p++){const x=s.images[p];if(!x)continue;const oe=J+p+1,me=`${T.name.replace(".pdf","")}_page_${String(oe).padStart(3,"0")}.png`,ue=x.startsWith("data:")?x:`data:image/png;base64,${x}`;n.addImage(me,ue)}J+=s.images.length}le=s.has_more??!1}return J}catch(m){throw console.error("后端 PDF 解析失败:",m),m}finally{if(ne)try{await Bo(ne)}catch(m){console.warn("PDF 会话清理失败:",m)}}}async function A(T){let ne=null;try{Re("正在上传电子书文件...","info");const m=await Eo(T,5);if(!m.success||!m.session_id)throw new Error(m.error||"MOBI/AZW 解析启动失败");ne=m.session_id;const V=m.total_images||0;Re(`正在解析电子书，共 ${V} 张图片...`,"info");let J=0,le=!0;for(;le;){I.value=`${T.name} - 已处理 ${J}/${V} 张`,b.value=V>0?Math.round(J/V*100):0;const s=await Po(ne);if(!s.success)throw new Error(s.error||"MOBI/AZW 批次解析失败");if(s.images&&s.images.length>0){for(let p=0;p<s.images.length;p++){const x=s.images[p];if(!x)continue;const oe=J+p+1,me=`${T.name.replace(/\.(mobi|azw|azw3)$/i,"")}_image_${String(oe).padStart(3,"0")}.png`,ue=x.startsWith("data:")?x:`data:image/png;base64,${x}`;n.addImage(me,ue)}J+=s.images.length}le=s.has_more??!1}return J}catch(m){throw console.error("MOBI/AZW 解析失败:",m),m}finally{if(ne)try{await Ao(ne)}catch(m){console.warn("MOBI/AZW 会话清理失败:",m)}}}function c(){C.value=""}return u({triggerFileSelect:g,processFiles:M,clearError:c}),(T,ne)=>(P(),U("div",ga,[e("div",{id:"drop-area",class:Le(["drop-area",{"drag-over":y.value,loading:S.value}]),onDragover:q,onDragleave:te,onDrop:Y},[e("div",{class:"drop-content"},[e("p",{class:"drop-text"},[ne[0]||(ne[0]=Oe(" 拖拽图片、PDF或MOBI文件到这里，或 ",-1)),e("span",{class:"select-link",onClick:g}," 点击选择文件 ")])]),e("input",{ref_key:"fileInputRef",ref:o,type:"file",id:"imageUpload",accept:"image/*,application/pdf,.mobi,.azw,.azw3",multiple:"",class:"file-input",onChange:d},null,544)],34),R.value?(P(),lt(un,{key:0,visible:!0,percentage:b.value,label:I.value||"处理中..."},null,8,["percentage","label"])):we("",!0),C.value?(P(),U("div",{key:1,class:"error-message",onClick:c},[ne[1]||(ne[1]=e("span",{class:"error-icon"},"⚠️",-1)),e("span",ba,pe(C.value),1),ne[2]||(ne[2]=e("span",{class:"error-close"},"×",-1))])):we("",!0),S.value&&!R.value?(P(),U("div",va,[...ne[3]||(ne[3]=[e("div",{class:"spinner"},null,-1),e("span",{class:"loading-text"},"处理中...",-1)])])):we("",!0)]))}}),pa=Xe(fa,[["__scopeId","data-v-42038b94"]]),ma={id:"settings-sidebar",class:"settings-sidebar"},ha={class:"card settings-card"},ya={id:"font-settings",class:"settings-card collapsible-panel"},xa={class:"toggle-icon"},ka={class:"collapsible-content"},Sa={class:"settings-form"},Ca={class:"form-group"},wa=["value","disabled","title"],_a={class:"auto-fontSize-option",title:"勾选后，首次翻译时自动为每个气泡计算合适的字号"},$a=["checked"],Ia={class:"form-group"},Ta={class:"form-group"},Da={class:"form-group"},Ra=["value"],Ma={class:"form-group"},Ba={class:"checkbox-label"},Ea=["checked"],Pa={key:0,id:"strokeOptions",class:"stroke-options"},Aa={class:"form-group"},Fa=["value"],La={class:"form-group"},Oa=["value"],Ua={class:"form-group"},za={key:0,id:"solidColorOptions",class:"form-group"},Va=["value"],Na={class:"apply-settings-group"},Wa=["disabled"],Ka={key:0,class:"apply-options-dropdown"},qa={class:"apply-option"},Ha=["checked"],Ya={class:"apply-option"},Xa={class:"apply-option"},Ja={class:"apply-option"},ja={class:"apply-option"},Ga={class:"apply-option"},Za={class:"apply-option"},Qa={class:"apply-option"},es={class:"apply-option"},ts={class:"action-buttons"},ns=["disabled"],os=["disabled"],as=["disabled"],ss=["disabled"],ls=["disabled"],is=["disabled"],rs=["disabled"],us=["disabled"],cs=["disabled"],ds={class:"navigation-buttons"},gs=["disabled"],bs=["disabled"],vs=Je({__name:"SettingsSidebar",emits:["translateCurrent","translateAll","hqTranslate","proofread","removeText","removeAllText","retryFailed","deleteCurrent","clearAll","cleanTemp","openPlugins","openSettings","previous","next","applyToAll","textStyleChanged"],setup(t,{emit:u}){const l=u,i=ot(),n=Qe(),a=h(!0),o=h(!1),S=h({fontSize:!0,fontFamily:!0,layoutDirection:!0,textColor:!0,fillColor:!0,strokeEnabled:!0,strokeColor:!0,strokeWidth:!0}),y=[{label:"自动 (根据检测)",value:"auto"},{label:"竖向排版",value:"vertical"},{label:"横向排版",value:"horizontal"}],C=[{label:"纯色填充",value:"solid"},{label:"LAMA修复 (速度优化)",value:"lama_mpe"},{label:"LAMA修复 (通用)",value:"litelama"}],b=X(()=>i.currentImage),I=X(()=>i.hasImages),R=X(()=>I.value&&!i.isBatchTranslationInProgress),E=X(()=>i.canGoPrevious),g=X(()=>i.canGoNext),d=X(()=>i.failedImageCount>0),Y=X(()=>i.failedImageCount),q=X(()=>n.textStyle),te=h([]),M=["fonts/STSONG.TTF","fonts/msyh.ttc","fonts/simhei.ttf","fonts/simsun.ttc"],w=h(null),Z=X(()=>{const K=te.value.map(k=>({label:T(k),value:k}));return K.push({label:"自定义字体...",value:"custom-font"}),K});rt(async()=>{await z();const K=q.value.fontFamily;K&&!te.value.includes(K)&&(te.value=[K,...te.value])});async function z(){try{const K=await Nn();if(K.fonts&&Array.isArray(K.fonts)&&K.fonts.length>0){const k=K.fonts[0];if(typeof k=="object"&&"path"in k){const de=K.fonts.map(H=>typeof H=="object"?H.path:H);te.value=de}else te.value=K.fonts}else te.value=[...M]}catch(K){console.error("加载字体列表失败:",K),te.value=[...M]}}function re(){a.value=!a.value}function G(K){const k=parseInt(K.target.value);isNaN(k)||(n.updateTextStyle({fontSize:k}),l("textStyleChanged","fontSize",k))}function A(K){const k=K.target.checked;n.updateTextStyle({autoFontSize:k}),console.log(`自动字号设置变更: ${k} (仅影响下次翻译)`)}async function c(K){const k=K.target,de=k.files?.[0];if(!de)return;const H=[".ttf",".ttc",".otf"],_=de.name.toLowerCase();if(!H.some($=>_.endsWith($))){Re("请选择 .ttf、.ttc 或 .otf 格式的字体文件","error"),k.value="";return}try{const $=await zo(de);$.success&&$.fontPath?(await z(),n.updateTextStyle({fontFamily:$.fontPath}),Re("字体上传成功","success")):Re($.error||"字体上传失败","error")}catch($){console.error("字体上传失败:",$),Re("字体上传失败","error")}finally{k.value=""}}function T(K){const k={"fonts/STXINGKA.TTF":"华文行楷","fonts/STXINWEI.TTF":"华文新魏","fonts/STZHONGS.TTF":"华文中宋","fonts/STKAITI.TTF":"楷体","fonts/STLITI.TTF":"隶书","fonts/STSONG.TTF":"华文宋体","fonts/msyh.ttc":"微软雅黑","fonts/msyhbd.ttc":"微软雅黑粗体","fonts/SIMYOU.TTF":"幼圆","fonts/STFANGSO.TTF":"仿宋","fonts/STHUPO.TTF":"华文琥珀","fonts/STXIHEI.TTF":"华文细黑","fonts/simkai.ttf":"中易楷体","fonts/simfang.ttf":"中易仿宋","fonts/simhei.ttf":"中易黑体","fonts/SIMLI.TTF":"中易隶书","fonts/simsun.ttc":"宋体"};if(k[K])return k[K];const de=K.split("/").pop()||K;for(const[H,_]of Object.entries(k))if((H.split("/").pop()||"").toLowerCase()===de.toLowerCase())return _;return de.replace(/\.(ttf|ttc|otf)$/i,"")}function ne(K){if(K==="custom-font"){w.value?.click();return}n.updateTextStyle({fontFamily:K}),l("textStyleChanged","fontFamily",K)}function m(K){n.updateTextStyle({layoutDirection:K}),l("textStyleChanged","layoutDirection",K)}function V(K){n.updateTextStyle({inpaintMethod:K})}function J(K){const k=K.target.value;n.updateTextStyle({textColor:k}),l("textStyleChanged","textColor",k)}function le(K){const k=K.target.checked;n.updateTextStyle({strokeEnabled:k}),l("textStyleChanged","strokeEnabled",k)}function s(K){const k=K.target.value;n.updateTextStyle({strokeColor:k}),l("textStyleChanged","strokeColor",k)}function p(K){const k=parseInt(K.target.value);isNaN(k)||(n.updateTextStyle({strokeWidth:k}),l("textStyleChanged","strokeWidth",k))}function x(K){const k=K.target.value;n.updateTextStyle({fillColor:k}),l("textStyleChanged","fillColor",k)}function oe(){o.value=!o.value}function me(){const k=!Object.values(S.value).every(de=>de);S.value={fontSize:k,fontFamily:k,layoutDirection:k,textColor:k,fillColor:k,strokeEnabled:k,strokeColor:k,strokeWidth:k}}function ue(){l("applyToAll",{...S.value}),o.value=!1}function Se(K){K.target.closest(".apply-settings-group")||(o.value=!1)}return typeof window<"u"&&window.addEventListener("click",Se),(K,k)=>(P(),U("aside",ma,[e("div",ha,[k[43]||(k[43]=e("h2",null,"翻译设置",-1)),e("div",ya,[e("h3",{class:"collapsible-header",onClick:re},[k[21]||(k[21]=Oe(" 文字设置 ",-1)),e("span",xa,pe(a.value?"▼":"▶"),1)]),ie(e("div",ka,[e("div",Sa,[e("div",Ca,[k[23]||(k[23]=e("label",{for:"fontSize"},"字号大小:",-1)),e("input",{type:"number",id:"fontSize",value:q.value.fontSize,min:"10",max:"100",disabled:q.value.autoFontSize,class:Le({"disabled-input":q.value.autoFontSize}),title:q.value.autoFontSize?"已启用自动字号，首次翻译时将自动计算":"",onInput:G},null,42,wa),e("span",_a,[e("input",{type:"checkbox",id:"autoFontSize",checked:q.value.autoFontSize,onChange:A},null,40,$a),k[22]||(k[22]=e("label",{for:"autoFontSize"},"自动计算初始字号",-1))])]),e("div",Ia,[k[24]||(k[24]=e("label",{for:"fontFamily"},"文本字体:",-1)),Te(Ne,{"model-value":q.value.fontFamily,options:Z.value,onChange:ne},null,8,["model-value","options"]),e("input",{ref_key:"fontUploadInput",ref:w,type:"file",id:"fontUpload",accept:".ttf,.ttc,.otf",style:{display:"none"},onChange:c},null,544)]),e("div",Ta,[k[25]||(k[25]=e("label",{for:"layoutDirection"},"排版设置:",-1)),Te(Ne,{"model-value":q.value.layoutDirection,options:y,onChange:m},null,8,["model-value"])]),e("div",Da,[k[26]||(k[26]=e("label",{for:"textColor"},"文字颜色:",-1)),e("input",{type:"color",id:"textColor",value:q.value.textColor,onInput:J},null,40,Ra)]),e("div",Ma,[e("span",Ba,[e("input",{type:"checkbox",id:"strokeEnabled",checked:q.value.strokeEnabled,onChange:le},null,40,Ea),k[27]||(k[27]=e("label",{for:"strokeEnabled"},"启用文本描边:",-1))])]),Te(Gt,{name:"stroke-slide"},{default:ht(()=>[q.value.strokeEnabled?(P(),U("div",Pa,[e("div",Aa,[k[28]||(k[28]=e("label",{for:"strokeColor"},"描边颜色:",-1)),e("input",{type:"color",id:"strokeColor",value:q.value.strokeColor,onInput:s},null,40,Fa)]),e("div",La,[k[29]||(k[29]=e("label",{for:"strokeWidth"},"描边宽度 (px):",-1)),e("input",{type:"number",id:"strokeWidth",value:q.value.strokeWidth,min:"0",max:"10",style:{width:"60px",padding:"5px"},onInput:p},null,40,Oa),k[30]||(k[30]=e("div",{class:"input-hint"},"0 表示无描边。",-1))])])):we("",!0)]),_:1}),e("div",Ua,[k[31]||(k[31]=e("label",{for:"useInpainting"},"气泡填充方式:",-1)),Te(Ne,{"model-value":q.value.inpaintMethod,options:C,onChange:V},null,8,["model-value"])]),Te(Gt,{name:"slide-fade"},{default:ht(()=>[q.value.inpaintMethod==="solid"?(P(),U("div",za,[k[32]||(k[32]=e("label",{for:"fillColor"},"填充颜色:",-1)),e("input",{type:"color",id:"fillColor",value:q.value.fillColor,onInput:x},null,40,Va)])):we("",!0)]),_:1})]),e("div",Na,[e("button",{type:"button",class:"settings-button",disabled:!I.value,onClick:ue}," 应用到全部 ",8,Wa),e("button",{type:"button",class:"settings-gear-btn",title:"选择要应用的参数",onClick:oe}," ⚙️ "),o.value?(P(),U("div",Ka,[e("div",qa,[e("input",{type:"checkbox",id:"apply_selectAll",checked:Object.values(S.value).every(de=>de),onChange:me},null,40,Ha),k[33]||(k[33]=e("label",{for:"apply_selectAll"},"全选",-1))]),k[42]||(k[42]=e("hr",null,null,-1)),e("div",Ya,[ie(e("input",{type:"checkbox",id:"apply_fontSize","onUpdate:modelValue":k[0]||(k[0]=de=>S.value.fontSize=de)},null,512),[[Ze,S.value.fontSize]]),k[34]||(k[34]=e("label",{for:"apply_fontSize"},"字号",-1))]),e("div",Xa,[ie(e("input",{type:"checkbox",id:"apply_fontFamily","onUpdate:modelValue":k[1]||(k[1]=de=>S.value.fontFamily=de)},null,512),[[Ze,S.value.fontFamily]]),k[35]||(k[35]=e("label",{for:"apply_fontFamily"},"字体",-1))]),e("div",Ja,[ie(e("input",{type:"checkbox",id:"apply_layoutDirection","onUpdate:modelValue":k[2]||(k[2]=de=>S.value.layoutDirection=de)},null,512),[[Ze,S.value.layoutDirection]]),k[36]||(k[36]=e("label",{for:"apply_layoutDirection"},"排版方向",-1))]),e("div",ja,[ie(e("input",{type:"checkbox",id:"apply_textColor","onUpdate:modelValue":k[3]||(k[3]=de=>S.value.textColor=de)},null,512),[[Ze,S.value.textColor]]),k[37]||(k[37]=e("label",{for:"apply_textColor"},"文字颜色",-1))]),e("div",Ga,[ie(e("input",{type:"checkbox",id:"apply_fillColor","onUpdate:modelValue":k[4]||(k[4]=de=>S.value.fillColor=de)},null,512),[[Ze,S.value.fillColor]]),k[38]||(k[38]=e("label",{for:"apply_fillColor"},"填充颜色",-1))]),e("div",Za,[ie(e("input",{type:"checkbox",id:"apply_strokeEnabled","onUpdate:modelValue":k[5]||(k[5]=de=>S.value.strokeEnabled=de)},null,512),[[Ze,S.value.strokeEnabled]]),k[39]||(k[39]=e("label",{for:"apply_strokeEnabled"},"描边开关",-1))]),e("div",Qa,[ie(e("input",{type:"checkbox",id:"apply_strokeColor","onUpdate:modelValue":k[6]||(k[6]=de=>S.value.strokeColor=de)},null,512),[[Ze,S.value.strokeColor]]),k[40]||(k[40]=e("label",{for:"apply_strokeColor"},"描边颜色",-1))]),e("div",es,[ie(e("input",{type:"checkbox",id:"apply_strokeWidth","onUpdate:modelValue":k[7]||(k[7]=de=>S.value.strokeWidth=de)},null,512),[[Ze,S.value.strokeWidth]]),k[41]||(k[41]=e("label",{for:"apply_strokeWidth"},"描边宽度",-1))])])):we("",!0)])],512),[[Ye,a.value]])]),e("div",ts,[e("button",{id:"translateButton",disabled:!R.value,onClick:k[8]||(k[8]=de=>l("translateCurrent"))}," 翻译当前图片 ",8,ns),e("button",{id:"translateAllButton",disabled:!R.value,onClick:k[9]||(k[9]=de=>l("translateAll"))}," 翻译所有图片 ",8,os),e("button",{id:"startHqTranslationBtn",class:"settings-button purple-button",disabled:!R.value,title:"使用高质量翻译模式（需在设置中配置）",onClick:k[10]||(k[10]=de=>l("hqTranslate"))}," 高质量翻译 ",8,as),e("button",{id:"proofreadButton",disabled:!R.value,onClick:k[11]||(k[11]=de=>l("proofread"))}," AI校对 ",8,ss),d.value?(P(),U("button",{key:0,id:"retryFailedButton",class:"settings-button warning-button",disabled:!R.value,title:"重新翻译所有失败的图片",onClick:k[12]||(k[12]=de=>l("retryFailed"))}," 重新翻译失败图片 ("+pe(Y.value)+") ",9,ls)):we("",!0),e("button",{id:"removeTextOnlyButton",disabled:!b.value,title:"消除图片中的气泡文字，无需填写翻译服务商和API Key",onClick:k[13]||(k[13]=de=>l("removeText"))}," 仅消除文字 ",8,is),e("button",{id:"removeAllTextButton",disabled:!I.value,title:"消除所有图片中的气泡文字，无需填写翻译服务商和API Key",onClick:k[14]||(k[14]=de=>l("removeAllText"))}," 消除所有图片文字 ",8,rs),e("button",{id:"deleteCurrentImageButton",class:"settings-button red-button",disabled:!b.value,onClick:k[15]||(k[15]=de=>l("deleteCurrent"))}," 删除当前图片 ",8,us),e("button",{id:"clearAllImagesButton",class:"settings-button red-button",disabled:!I.value,onClick:k[16]||(k[16]=de=>l("clearAll"))}," 清除所有图片 ",8,cs),e("button",{id:"cleanDebugFilesButton",class:"settings-button orange-button",onClick:k[17]||(k[17]=de=>l("cleanTemp"))}," 清理临时文件 "),e("button",{id:"managePluginsButton",class:"settings-button blue-button",onClick:k[18]||(k[18]=de=>l("openPlugins"))}," 插件管理 ")]),e("div",ds,[e("button",{id:"prevImageButton",disabled:!E.value,onClick:k[19]||(k[19]=de=>l("previous"))}," 上一张 ",8,gs),e("button",{id:"nextImageButton",disabled:!g.value,onClick:k[20]||(k[20]=de=>l("next"))}," 下一张 ",8,bs)])])]))}}),fs=Xe(vs,[["__scopeId","data-v-3e82dac2"]]),It={originalText:"",translatedText:"",textboxText:"",coords:[0,0,100,100],polygon:[],fontSize:25,fontFamily:"fonts/STSONG.TTF",textDirection:"auto",autoTextDirection:"vertical",textColor:"#000000",fillColor:On,rotationAngle:0,position:{x:0,y:0},strokeEnabled:sn,strokeColor:an,strokeWidth:on,inpaintMethod:"solid"};function nn(t){return{...{...It,...t},coords:t?.coords?[...t.coords]:[...It.coords],polygon:t?.polygon?t.polygon.map(l=>[...l]):[],position:t?.position?{...It.position,...t.position}:{...It.position}}}function Yn(t){const[u,l,i,n]=t,a=Math.abs(i-u);return Math.abs(n-l)>a?"vertical":"horizontal"}function An(t,u){const{bubble_coords:l=[],bubble_states:i=[],original_texts:n=[],bubble_texts:a=[],textbox_texts:o=[],bubble_angles:S=[],auto_directions:y=[]}=t;return i.length>0?i.map((C,b)=>({...nn(u),...C,coords:C.coords||l[b]||[0,0,100,100]})):l.map((C,b)=>{let I;return y[b]?I=y[b]==="v"?"vertical":"horizontal":I=Yn(C),nn({coords:C,originalText:n[b]||"",translatedText:a[b]||"",textboxText:o[b]||"",rotationAngle:S[b]||0,autoTextDirection:I,...u})})}function Tt(t){return t.map(u=>({...u,coords:[...u.coords],polygon:u.polygon.map(l=>[...l]),position:{...u.position}}))}function ps(t){if(!t||typeof t!="object")return!1;const u=t;if(!Array.isArray(u.coords)||u.coords.length!==4||!u.coords.every(n=>typeof n=="number"&&!isNaN(n))||typeof u.fontSize!="number"||u.fontSize<=0)return!1;const l=["vertical","horizontal","auto"];if(typeof u.textDirection!="string"||!l.includes(u.textDirection))return!1;const i=["solid","lama_mpe","litelama"];return!(typeof u.inpaintMethod!="string"||!i.includes(u.inpaintMethod))}const dt=ln("bubble",()=>{const t=h([]),u=h(-1),l=h([]),i=h([]),n=h(!1),a=h(-1),o=h(0),S=h(0),y=h(0),C=h(0),b=h(!1),I=h(-1),R=h(null),E=h(!1),g=h(-1),d=h(0),Y=X(()=>u.value>=0&&u.value<t.value.length?t.value[u.value]??null:null),q=X(()=>t.value.length),te=X(()=>t.value.length>0),M=X(()=>u.value>=0),w=X(()=>l.value.length>1),Z=X(()=>l.value.filter(r=>r>=0&&r<t.value.length).map(r=>t.value[r]).filter(r=>r!==void 0));function z(){const v=ot().currentImage;v&&(v.bubbleStates=Tt(t.value),v.hasUnsavedChanges=!0,console.log("气泡状态已同步到当前图片"))}function re(r,v=!1){t.value=r,i.value=Tt(r),V(),console.log(`气泡数组已设置，共 ${r.length} 个气泡`),v||z()}function G(r,v){const W=Yn(r),ge=nn({coords:r,autoTextDirection:W,...v});return t.value.push(ge),console.log(`已添加气泡，当前共 ${t.value.length} 个`),z(),ge}function A(r){return r<0||r>=t.value.length?(console.warn(`删除失败: 无效的索引 ${r}`),!1):(t.value.splice(r,1),u.value===r?u.value=-1:u.value>r&&u.value--,l.value=l.value.filter(v=>v!==r).map(v=>v>r?v-1:v),console.log(`已删除气泡，当前共 ${t.value.length} 个`),z(),!0)}function c(){if(l.value.length===0&&u.value<0)return;const r=[...new Set([...l.value,u.value])].filter(v=>v>=0).sort((v,W)=>W-v);for(const v of r)t.value.splice(v,1);V(),console.log(`已删除 ${r.length} 个气泡`),z()}function T(){t.value=[],i.value=[],V(),console.log("所有气泡已清除"),z()}function ne(r){r>=-1&&r<t.value.length&&(u.value=r,l.value=r>=0?[r]:[],console.log(`已选中气泡 ${r}`))}function m(r){if(r<0||r>=t.value.length)return;const v=l.value.indexOf(r);v>=0?(l.value.splice(v,1),u.value===r&&(u.value=l.value[0]??-1)):(l.value.push(r),u.value=r),console.log(`多选状态: ${l.value.join(", ")}`)}function V(){u.value=-1,l.value=[]}function J(){u.value>=0?l.value=[u.value]:l.value=[]}function le(){if(t.value.length===0)return!1;const r=u.value<t.value.length-1?u.value+1:0;return ne(r),!0}function s(){if(t.value.length===0)return!1;const r=u.value>0?u.value-1:t.value.length-1;return ne(r),!0}function p(r,v){if(r<0||r>=t.value.length)return console.warn(`更新失败: 无效的索引 ${r}`),!1;const W=t.value[r];return W?(Object.assign(W,v),console.log(`已更新气泡 ${r}`),z(),!0):!1}function x(r){return u.value<0?(console.warn("更新失败: 没有选中的气泡"),!1):p(u.value,r)}function oe(r){const v=l.value.length>0?l.value:u.value>=0?[u.value]:[];for(const W of v){const ge=t.value[W];ge&&Object.assign(ge,r)}z(),console.log(`已批量更新 ${v.length} 个气泡`)}function me(r){for(let v=0;v<t.value.length;v++){const W=t.value[v];W&&Object.assign(W,r)}z(),console.log(`已更新所有 ${t.value.length} 个气泡`)}function ue(r,v){if(r<0||r>=t.value.length)return!1;const W=t.value[r];if(!W)return!1;W.coords=v;const ge=v[2]-v[0],N=v[3]-v[1];return W.autoTextDirection=N>ge?"vertical":"horizontal",z(),!0}function Se(r,v){if(r<0||r>=t.value.length)return!1;const W=t.value[r];return W?(W.polygon=v,z(),!0):!1}function K(r,v){if(r<0||r>=t.value.length)return!1;const W=t.value[r];return W?(W.rotationAngle=v,z(),!0):!1}function k(){if(t.value.length!==i.value.length)return!0;for(let r=0;r<t.value.length;r++){const v=t.value[r],W=i.value[r];if(!(!v||!W)&&(v.translatedText!==W.translatedText||v.textboxText!==W.textboxText||v.fontSize!==W.fontSize||v.fontFamily!==W.fontFamily||v.textDirection!==W.textDirection||v.textColor!==W.textColor||v.fillColor!==W.fillColor||v.rotationAngle!==W.rotationAngle||v.strokeEnabled!==W.strokeEnabled||v.strokeColor!==W.strokeColor||v.strokeWidth!==W.strokeWidth||v.inpaintMethod!==W.inpaintMethod||JSON.stringify(v.coords)!==JSON.stringify(W.coords)))return!0}return!1}function de(){t.value=Tt(i.value),V(),console.log("气泡状态已重置到初始状态")}function H(){i.value=Tt(t.value),console.log("当前状态已保存为初始状态")}function _(){return{bubble_coords:t.value.map(r=>r.coords),bubble_texts:t.value.map(r=>r.translatedText),textbox_texts:t.value.map(r=>r.textboxText),font_sizes:t.value.map(r=>r.fontSize),font_families:t.value.map(r=>r.fontFamily),text_directions:t.value.map(r=>r.textDirection==="auto"?r.autoTextDirection==="vertical"?"v":"h":r.textDirection==="vertical"?"v":"h"),text_colors:t.value.map(r=>r.textColor),fill_colors:t.value.map(r=>r.fillColor),rotation_angles:t.value.map(r=>r.rotationAngle),stroke_enabled:t.value.map(r=>r.strokeEnabled),stroke_colors:t.value.map(r=>r.strokeColor),stroke_widths:t.value.map(r=>r.strokeWidth),inpaint_methods:t.value.map(r=>r.inpaintMethod)}}function D(){return JSON.stringify(t.value)}function $(r){try{const v=JSON.parse(r);if(!Array.isArray(v))return console.error("反序列化失败: 数据不是数组"),!1;const W=[];for(const ge of v)ps(ge)?W.push(ge):console.warn("跳过无效的气泡状态:",ge);return re(W),!0}catch(v){return console.error("反序列化失败:",v),!1}}return{bubbles:t,selectedIndex:u,selectedIndices:l,initialStates:i,isDragging:n,draggingIndex:a,dragOffsetX:o,dragOffsetY:S,dragInitialX:y,dragInitialY:C,isResizing:b,resizingIndex:I,resizeCurrentCoords:R,isRotating:E,rotatingIndex:g,rotateCurrentAngle:d,selectedBubble:Y,bubbleCount:q,hasBubbles:te,hasSelection:M,isMultiSelect:w,selectedBubbles:Z,setBubbles:re,addBubble:G,deleteBubble:A,deleteSelected:c,clearBubbles:T,selectBubble:ne,toggleMultiSelect:m,clearSelection:V,clearMultiSelect:J,selectNext:le,selectPrevious:s,updateBubble:p,updateSelectedBubble:x,updateAllSelected:oe,updateAllBubbles:me,updateBubbleCoords:ue,updateBubblePolygon:Se,updateBubbleRotation:K,hasChanges:k,resetToInitial:de,saveAsInitial:H,toApiRequest:_,serialize:D,deserialize:$}}),ms=Object.freeze(Object.defineProperty({__proto__:null,useBubbleStore:dt},Symbol.toStringTag,{value:"Module"}));function hs(t){if(!t)return console.error("calculateImageDisplayMetrics: 图像元素无效"),null;if(!t.complete||t.naturalWidth===0||t.naturalHeight===0)return console.warn("calculateImageDisplayMetrics: 图像未完全加载或尺寸为0"),null;const u=t.naturalWidth,l=t.naturalHeight,i=t.clientWidth,n=t.clientHeight;let a,o;const S=u/l,y=i/n;S>y?(a=i,o=i/S):(o=n,a=n*S);const C=(i-a)/2,b=(n-o)/2,I=t.offsetLeft,R=t.offsetTop,E=I+C,g=R+b,d=u>0?a/u:0,Y=l>0?o/l:0;return{visualContentWidth:a,visualContentHeight:o,visualContentOffsetX:E,visualContentOffsetY:g,scaleX:d,scaleY:Y,naturalWidth:u,naturalHeight:l,elementWidth:i,elementHeight:n}}function Xn(){const t=ot(),u=Qe(),l=ct(),i=h(!1),n=h(0),a=h(""),o=h(!1),S=h(0),y=h(""),C=X(()=>t.hasImages),b=X(()=>t.hasImages),I=X(()=>t.hasImages);function R(){const M=t.images;if(M.length===0){l.warning("没有可导出的图片文本");return}const w=[];for(let T=0;T<M.length;T++){const ne=M[T];if(!ne)continue;const m=ne.bubbleStates||[],V={imageIndex:T,bubbles:[]};for(let J=0;J<m.length;J++){const le=m[J];if(!le)continue;const s=le.originalText||"",p=le.translatedText||le.textboxText||"";let x="vertical";le.textDirection&&le.textDirection!=="auto"?x=le.textDirection:le.autoTextDirection&&(x=le.autoTextDirection),V.bubbles.push({bubbleIndex:J,original:s,translated:p,textDirection:x})}w.push(V)}const Z=JSON.stringify(w,null,2),z=new Blob([Z],{type:"application/json"}),re=URL.createObjectURL(z),G=document.createElement("a");G.href=re;const c=new Date().toISOString().replace(/[-:T]/g,"").slice(0,15);G.download=`translations_${c}.json`,document.body.appendChild(G),G.click(),document.body.removeChild(G),URL.revokeObjectURL(re),l.success("文本导出成功！")}function E(){const M=t.images;if(M.length===0)return null;const w=[];for(let Z=0;Z<M.length;Z++){const z=M[Z];if(!z)continue;const re=z.bubbleStates||[],G={imageIndex:Z,bubbles:[]};for(let A=0;A<re.length;A++){const c=re[A];if(!c)continue;const T=c.originalText||"",ne=c.translatedText||c.textboxText||"";let m="vertical";c.textDirection&&c.textDirection!=="auto"?m=c.textDirection:c.autoTextDirection&&(m=c.autoTextDirection),G.bubbles.push({bubbleIndex:A,original:T,translated:ne,textDirection:m})}w.push(G)}return w}async function g(M,w){if(!M){l.warning("未选择文件");return}o.value=!0,S.value=0,y.value="准备导入文本...",l.info("正在导入文本...",0);try{const Z=await d(M);S.value=10,y.value="解析 JSON 数据...";const z=JSON.parse(Z);if(!Array.isArray(z))throw new Error("导入的 JSON 格式不正确，应为数组");let re=0,G=0;const A=u.settings.textStyle,c=A.autoFontSize?"auto":A.fontSize,T=A.fontFamily,ne=A.textColor,m=A.fillColor;S.value=20,y.value="开始更新图片...";const V=z.length;let J=0;const le=[];for(const s of z){J++;const p=20+J/V*60;S.value=p,y.value=`处理图片 ${J}/${V}`;const x=s.imageIndex;if(x<0||x>=t.images.length){console.warn(`跳过无效的图片索引: ${x}`);continue}const oe=t.images[x];if(!oe)continue;let me=!1;oe.bubbleStates||(oe.bubbleStates=[]);for(const ue of s.bubbles){const Se=ue.bubbleIndex,K=ue.original,k=ue.translated,de=ue.textDirection||"vertical";for(;oe.bubbleStates.length<=Se;)oe.bubbleStates.push(Y(c,T,ne,m));const H=oe.bubbleStates[Se];H&&(K&&(H.originalText=K),k&&(H.translatedText=k,H.textboxText=k),H.textDirection=de,me=!0,G++)}me&&(re++,oe.hasUnsavedChanges=!0,oe.translatedDataURL&&w&&le.push(x))}if(le.length>0&&w){S.value=80,y.value="开始渲染图片...",l.info("正在渲染图片，请稍候...",0);for(let s=0;s<le.length;s++){const p=le[s];p!==void 0&&(S.value=80+s/le.length*20,y.value=`渲染图片 ${s+1}/${le.length}`,await w(p))}}S.value=100,y.value="导入完成",l.success(`导入成功！更新了 ${re} 张图片中的 ${G} 个气泡文本`)}catch(Z){console.error("导入文本出错:",Z),l.error(`导入失败: ${Z instanceof Error?Z.message:String(Z)}`)}finally{o.value=!1,setTimeout(()=>{S.value=0,y.value=""},2e3)}}function d(M){return new Promise((w,Z)=>{const z=new FileReader;z.onload=re=>{re.target?.result?w(re.target.result):Z(new Error("读取文件失败"))},z.onerror=()=>Z(new Error("读取文件时出错")),z.readAsText(M)})}function Y(M,w,Z,z){const re=u.settings.textStyle;return{coords:[0,0,100,100],polygon:[],originalText:"",translatedText:"",textboxText:"",fontSize:typeof M=="number"?M:25,fontFamily:w,textDirection:"vertical",autoTextDirection:"vertical",textColor:Z,fillColor:z,rotationAngle:0,position:{x:0,y:0},strokeEnabled:re.strokeEnabled,strokeColor:re.strokeColor,strokeWidth:re.strokeWidth,inpaintMethod:re.inpaintMethod}}function q(){const M=t.currentImage;if(!M){l.warning("没有可下载的图片");return}const w=M.translatedDataURL||M.originalDataURL;if(!w){l.warning("没有可下载的图片");return}i.value=!0;try{const Z=w.split(",")[1];if(!Z)throw new Error("无效的图片数据");const z=atob(Z),re=[];for(let m=0;m<z.length;m+=512){const V=z.slice(m,m+512),J=new Array(V.length);for(let s=0;s<V.length;s++)J[s]=V.charCodeAt(s);const le=new Uint8Array(J);re.push(le.buffer)}const G=new Blob(re,{type:"image/png"}),A=URL.createObjectURL(G),c=document.createElement("a");c.href=A;let T=M.fileName||`image_${t.currentImageIndex}.png`;T=`${M.translatedDataURL?"translated":"original"}_${T.replace(/\.[^/.]+$/,"")}.png`,c.download=T,document.body.appendChild(c),c.click(),document.body.removeChild(c),URL.revokeObjectURL(A),l.success(`下载成功: ${T}`)}catch(Z){console.error("下载图片时出错:",Z),l.error("下载失败")}finally{i.value=!1}}async function te(M="zip"){const w=t.images;if(w.length===0){l.warning("没有可下载的图片");return}i.value=!0,n.value=0,a.value="准备下载...",l.info("下载中...处理可能需要一定时间，请耐心等待...",0);try{const Z=[];let z=0,re=0;n.value=5,a.value="检查图片数据...";for(let s=0;s<w.length;s++){const p=w[s];p&&(p.translatedDataURL?(Z.push({index:s,type:"translated"}),z++):p.originalDataURL&&(Z.push({index:s,type:"original"}),re++))}if(Z.length===0){l.warning("没有可下载的图片");return}n.value=10,a.value="创建下载会话...";const G=await Fo(Z.length);if(!G.success||!G.session_id)throw new Error(G.error||"创建会话失败");const A=G.session_id,c=Z.length;let T=0,ne=0;for(let s=0;s<Z.length;s++){const p=Z[s];if(!p)continue;const x=w[p.index];if(!x)continue;const oe=p.type==="translated"?x.translatedDataURL:x.originalDataURL;if(!oe)continue;const me=10+s/c*70;n.value=me,a.value=`上传图片 ${s+1}/${c}...`;try{const ue=await Lo(A,oe,s);ue.success?T++:(console.error(`上传图片 ${s} 失败:`,ue.error),ne++)}catch(ue){console.error(`上传图片 ${s} 出错:`,ue),ne++}}if(T===0)throw new Error("所有图片上传失败");n.value=85,a.value="打包文件...";const m=await Oo(A,M);if(!m.success||!m.file_id)throw new Error(m.error||"打包失败");n.value=95,a.value="准备下载...";const V=Uo(m.file_id,M),J=document.createElement("a");J.href=V,document.body.appendChild(J),J.click(),document.body.removeChild(J),n.value=100,a.value="下载已开始";let le=`已成功处理 ${T} 张图片`;ne>0&&(le+=`（${ne} 张失败）`),z>0&&re>0?le+=`（${z} 张翻译图片和 ${re} 张原始图片）`:z>0?le+="（全部为翻译后图片）":re>0&&(le+="（全部为原始图片）"),le+="，下载即将开始",l.success(le),setTimeout(async()=>{try{const s=await rn();console.log("临时文件清理结果:",s)}catch(s){console.error("清理临时文件失败:",s)}},6e4)}catch(Z){console.error("下载所有图片时出错:",Z),l.error(`下载失败: ${Z instanceof Error?Z.message:String(Z)}`)}finally{i.value=!1,setTimeout(()=>{n.value=0,a.value=""},2e3)}}return{isDownloading:i,downloadProgress:n,downloadProgressText:a,isImporting:o,importProgress:S,importProgressText:y,canExportText:C,canImportText:b,canDownload:I,exportText:R,exportTextToJson:E,importText:g,downloadCurrentImage:q,downloadAllImages:te}}const ys={key:0,class:"bubble-highlight-container"},xs=["data-bubble-index","data-rotation","onClick"],ks={key:0,class:"bubble-index"},Ss={key:0,class:"polygon-overlay"},Cs=["onClick"],ws=["d","data-bubble-index"],_s=["x","y"],$s=Je({__name:"BubbleHighlight",props:{bubbleCoords:{},bubblePolygons:{default:()=>[]},bubbleRotations:{default:()=>[]},selectedIndex:{default:-1},selectedIndices:{default:()=>[]},imageMetrics:{},visible:{type:Boolean,default:!0},showIndex:{type:Boolean,default:!0}},emits:["select"],setup(t,{emit:u}){const l=t,i=u,n=X(()=>l.bubblePolygons&&l.bubblePolygons.some(b=>b!==null));function a(b,I){if(!l.imageMetrics)return{display:"none"};const[R,E,g,d]=b,Y=l.imageMetrics,q=l.bubbleRotations[I]||0,te=(g-R)*Y.scaleX,M=(d-E)*Y.scaleY,w=Y.visualContentOffsetX+R*Y.scaleX,Z=Y.visualContentOffsetY+E*Y.scaleY,z={left:`${w}px`,top:`${Z}px`,width:`${te}px`,height:`${M}px`};return q!==0&&(z.transformOrigin="center center",z.transform=`rotate(${q}deg)`),z}function o(b){if(!b||b.length<3||!l.imageMetrics)return"";const I=l.imageMetrics;return`M ${b.map(([E,g])=>{const d=I.visualContentOffsetX+E*I.scaleX,Y=I.visualContentOffsetY+g*I.scaleY;return`${d},${Y}`}).join(" L ")} Z`}function S(b){return!!(l.bubblePolygons&&l.bubblePolygons[b])}function y(b,I){I.preventDefault(),I.stopPropagation(),i("select",b)}function C(b){return!!(b===l.selectedIndex||l.selectedIndices&&l.selectedIndices.includes(b))}return(b,I)=>t.visible&&t.imageMetrics?(P(),U("div",ys,[(P(!0),U(Ke,null,je(t.bubbleCoords,(R,E)=>(P(),U(Ke,{key:`rect-${E}`},[S(E)?we("",!0):(P(),U("div",{key:0,class:Le(["highlight-bubble",{selected:C(E)}]),style:tt(a(R,E)),"data-bubble-index":E,"data-rotation":t.bubbleRotations[E]||0,onClick:g=>y(E,g)},[t.showIndex?(P(),U("span",ks,"#"+pe(E+1),1)):we("",!0)],14,xs))],64))),128)),n.value?(P(),U("svg",Ss,[(P(!0),U(Ke,null,je(t.bubblePolygons,(R,E)=>(P(),U(Ke,{key:`polygon-${E}`},[R?(P(),U("g",{key:0,onClick:g=>y(E,g)},[e("path",{d:o(R),class:Le(["polygon-highlight",{selected:C(E)}]),"data-bubble-index":E},null,10,ws),t.showIndex&&R.length>0?(P(),U("text",{key:0,x:t.imageMetrics.visualContentOffsetX+R.reduce((g,d)=>g+d[0],0)/R.length*t.imageMetrics.scaleX,y:t.imageMetrics.visualContentOffsetY+R.reduce((g,d)=>g+d[1],0)/R.length*t.imageMetrics.scaleY,class:"polygon-index","text-anchor":"middle","dominant-baseline":"middle"}," #"+pe(E+1),9,_s)):we("",!0)],8,Cs)):we("",!0)],64))),128))])):we("",!0)])):we("",!0)}}),Is=Xe($s,[["__scopeId","data-v-62ad9da5"]]),Ts={key:0,class:"result-section card result-card"},Ds={class:"image-controls"},Rs={class:"image-size-control"},Ms=["value"],Bs={id:"imageSizeValue"},Es={class:"content-container"},Ps=["src"],As={id:"detectedTextInfo",class:"text-info"},Fs={id:"detectedTextList"},Ls={class:"original-text"},Os={class:"download-section"},Us={class:"download-buttons"},zs=["disabled"],Vs={class:"download-all-container"},Ns=["disabled"],Ws={class:"download-format-selector"},Ks=["disabled"],qs=["disabled"],Hs={key:1,class:"empty-state-section"},Wt=60,Ys=Je({__name:"ImageResultDisplay",props:{isEditMode:{type:Boolean,default:!1},showHighlight:{type:Boolean,default:!1}},emits:["toggle-edit-mode","retry-failed","select-bubble"],setup(t,{emit:u}){const l=[{label:"ZIP压缩包",value:"zip"},{label:"PDF文档",value:"pdf"},{label:"CBZ漫画",value:"cbz"}],i=t,n=u,a=ot(),o=Qe(),S=dt(),y=Xn(),C=h(100),b=X({get:()=>w.value?.showOriginal??!1,set:N=>{w.value&&a.updateCurrentImage({showOriginal:N})}}),I=h(null),R=h(null),E=h(null),g=h("zip"),d=h(null),Y=X(()=>y.isDownloading.value),q=X(()=>y.downloadProgressText.value),te=X(()=>y.downloadProgress.value),M=X(()=>a.hasImages),w=X(()=>a.currentImage),Z=X(()=>!!w.value?.translatedDataURL),z=X(()=>!!(w.value?.translatedDataURL||w.value?.originalDataURL)),re=X(()=>w.value?b.value||!w.value.translatedDataURL?w.value.originalDataURL:w.value.translatedDataURL:""),G=X(()=>a.failedImageCount>0),A=X(()=>o.settings.showDetectionDebug),c=X(()=>w.value?w.value.bubbleStates&&w.value.bubbleStates.length>0?w.value.bubbleStates.map(N=>N.coords):w.value.bubbleCoords?w.value.bubbleCoords:[]:[]),T=X(()=>w.value?.bubbleStates?w.value.bubbleStates.map(N=>N.polygon||null):[]),ne=X(()=>w.value?.bubbleStates?w.value.bubbleStates.map(N=>N.rotationAngle||0):[]),m=X(()=>S.selectedIndex),V=X(()=>({width:`${C.value}%`})),J=X(()=>o.settings.useTextboxPrompt),le=X(()=>{if(!w.value)return[];if(w.value.bubbleStates&&w.value.bubbleStates.length>0)return w.value.bubbleStates.map(f=>({original:f.originalText||"",translated:J.value?f.textboxText||f.translatedText||"":f.translatedText||""}));const N=w.value.originalTexts||[],O=J.value?w.value.textboxTexts||w.value.bubbleTexts||[]:w.value.bubbleTexts||[];return N.length===0?[]:N.map((f,B)=>({original:f||"",translated:O[B]||""}))}),s=X(()=>le.value.length>0);X(()=>Z.value&&s.value&&!i.isEditMode);function p(N){if(!N||N.length<=Wt)return N;let O="",f="";for(let B=0;B<N.length;B++)if(f+=N[B],f.length>=Wt){let j=-1;for(let ee=f.length-1;ee>=0;ee--){const be=f[ee];if(be&&["。","！","？",".","!","?","；",";","，",","].includes(be)){j=ee+1;break}}j>Wt*.6?(O+=f.substring(0,j)+`
`,f=f.substring(j)):(O+=f+`
`,f="")}return f&&(O+=f),O}function x(N){return p((N||"").trim())}function oe(N){const O=(N||"").trim();return p(O)}function me(N){return(N||"").includes("翻译失败")}function ue(){E.value=hs(I.value)}function Se(){b.value=!b.value}function K(){n("toggle-edit-mode")}function k(N){const O=N.target;C.value=parseInt(O.value,10),st(()=>{ue()})}function de(){n("retry-failed")}function H(N){n("select-bubble",N)}function _(){ue()}function D(){ue()}function $(){y.downloadCurrentImage()}function r(){y.downloadAllImages(g.value)}function v(){y.exportText()}function W(){d.value?.click()}async function ge(N){const O=N.target,f=O.files?.[0];f&&(await y.importText(f),O.value="")}return rt(()=>{window.addEventListener("resize",D)}),St(()=>{window.removeEventListener("resize",D)}),We(()=>w.value?.id,()=>{st(()=>{ue()})}),We(C,()=>{st(()=>{ue()})}),(N,O)=>w.value?(P(),U("section",Ts,[e("div",Ds,[Z.value?(P(),U("button",{key:0,id:"toggleImageButton",class:"control-btn",onClick:Se},pe(b.value?"查看翻译图":"查看原图"),1)):we("",!0),e("button",{id:"toggleEditModeButton",class:Le(["control-btn",{active:t.isEditMode}]),onClick:K},pe(t.isEditMode?"退出编辑":"切换编辑模式"),3),e("div",Rs,[O[1]||(O[1]=e("label",{for:"imageSize"},"图片大小:",-1)),e("input",{type:"range",id:"imageSize",min:"50",max:"200",value:C.value,class:"slider range-slider",onInput:k},null,40,Ms),e("span",Bs,pe(C.value)+"%",1)]),G.value?(P(),U("button",{key:1,id:"retranslateFailedButton",class:"retry-failed-btn",onClick:de,title:"重新翻译所有失败的图片"}," 重新翻译失败图片 ("+pe(ce(a).failedImageCount)+") ",1)):we("",!0)]),e("div",Es,[e("div",{ref_key:"containerRef",ref:R,class:"image-container"},[e("img",{ref_key:"imageRef",ref:I,id:"translatedImageDisplay",src:re.value,alt:"翻译后图片",style:tt(V.value),onLoad:_},null,44,Ps),A.value||t.showHighlight||t.isEditMode?(P(),lt(Is,{key:0,"bubble-coords":c.value,"bubble-polygons":T.value,"bubble-rotations":ne.value,"selected-index":m.value,"image-metrics":E.value,visible:!0,"show-index":!0,onSelect:H},null,8,["bubble-coords","bubble-polygons","bubble-rotations","selected-index","image-metrics"])):we("",!0)],512)]),e("div",As,[O[18]||(O[18]=e("h3",null,"检测到的文本（原文 → 译文）",-1)),e("pre",Fs,[O[16]||(O[16]=Oe("        ",-1)),s.value?(P(),U(Ke,{key:0},[O[14]||(O[14]=Oe(`
          `,-1)),(P(!0),U(Ke,null,je(le.value,(f,B)=>(P(),U("span",{key:B,class:"text-item"},[O[2]||(O[2]=Oe(`
            `,-1)),e("span",Ls,pe(x(f.original)),1),O[3]||(O[3]=Oe(`
            `,-1)),O[4]||(O[4]=e("br",null,null,-1)),O[5]||(O[5]=Oe(`
            `,-1)),e("span",{class:Le(["translated-text",{"translation-error":me(f.translated)}])},pe(oe(f.translated)),3),O[6]||(O[6]=Oe(`
            `,-1)),O[7]||(O[7]=e("br",null,null,-1)),O[8]||(O[8]=Oe(`
            `,-1)),O[9]||(O[9]=e("span",{class:"separator"},"──────────────────────────",-1)),O[10]||(O[10]=Oe(`
            `,-1)),O[11]||(O[11]=e("br",null,null,-1)),O[12]||(O[12]=e("br",null,null,-1)),O[13]||(O[13]=Oe(`
          `,-1))]))),128)),O[15]||(O[15]=Oe(`
        `,-1))],64)):(P(),U(Ke,{key:1},[Oe("未检测到文本或尚未翻译")],64)),O[17]||(O[17]=Oe(`
      `,-1))])]),e("div",Os,[Y.value?(P(),lt(un,{key:0,visible:!0,percentage:te.value,label:q.value||"下载中，请稍候..."},null,8,["percentage","label"])):we("",!0),e("div",Us,[e("button",{id:"downloadButton",class:"download-btn primary",disabled:!z.value,onClick:$}," 下载当前图片 ",8,zs),e("div",Vs,[e("button",{id:"downloadAllImagesButton",class:"download-btn primary",disabled:!M.value,onClick:r}," 下载所有图片 ",8,Ns),e("div",Ws,[Te(Ne,{modelValue:g.value,"onUpdate:modelValue":O[0]||(O[0]=f=>g.value=f),options:l},null,8,["modelValue"])])]),e("button",{id:"exportTextButton",class:"download-btn success",disabled:!M.value,onClick:v}," 导出文本 ",8,Ks),e("button",{id:"importTextButton",class:"download-btn success",disabled:!M.value,onClick:W}," 导入文本 ",8,qs),e("input",{type:"file",ref_key:"importFileInput",ref:d,id:"importTextFileInput",style:{display:"none"},accept:".json",onChange:ge},null,544)])])])):(P(),U("section",Hs))}}),Xs=Xe(Ys,[["__scopeId","data-v-8c7c5817"]]),Js={class:"guide-content"},js={class:"guide-footer"},Gs={class:"dont-show-option"},Dt="first_time_guide_shown",Zs=Je({__name:"FirstTimeGuide",emits:["openSettings"],setup(t,{expose:u,emit:l}){const i=l,n=h(!1),a=h(!1);rt(()=>{localStorage.getItem(Dt)||(n.value=!0)});function o(){a.value&&localStorage.setItem(Dt,"true"),n.value=!1}function S(){localStorage.setItem(Dt,"true"),n.value=!1,i("openSettings")}function y(){localStorage.removeItem(Dt)}return u({resetGuideState:y,showGuide:n}),(C,b)=>(P(),lt(Wn,{"model-value":n.value,title:"欢迎使用 Saber-Translator",onClose:o},{default:ht(()=>[e("div",Js,[b[3]||(b[3]=e("div",{class:"guide-icon"},"🎉",-1)),b[4]||(b[4]=e("div",{class:"guide-message"},[e("p",{class:"guide-title"},"首次使用提醒"),e("p",{class:"guide-text"}," 在开始翻译之前，请先配置翻译服务。 "),e("p",{class:"guide-text"},[Oe(" 点击右上角的 "),e("span",{class:"highlight"},"⚙️ 设置"),Oe(" 按钮，配置以下内容： ")]),e("ul",{class:"guide-list"},[e("li",null,"选择 OCR 引擎（文字识别）"),e("li",null,"配置翻译服务商和 API Key"),e("li",null,"（可选）配置高质量翻译和 AI 校对")])],-1)),e("div",{class:"guide-actions"},[e("button",{class:"guide-btn primary",onClick:S},[...b[1]||(b[1]=[e("span",{class:"btn-icon"},"⚙️",-1),Oe(" 立即配置 ",-1)])]),e("button",{class:"guide-btn secondary",onClick:o}," 稍后配置 ")]),e("div",js,[e("label",Gs,[ie(e("input",{type:"checkbox","onUpdate:modelValue":b[0]||(b[0]=I=>a.value=I)},null,512),[[Ze,a.value]]),b[2]||(b[2]=e("span",null,"不再显示此提醒",-1))])])])]),_:1},8,["model-value"]))}}),Qs=Xe(Zs,[["__scopeId","data-v-04dfb2b8"]]),Kt="saber_translator_dismiss_setup_reminder",el=["siliconflow","deepseek","volcano","caiyun","baidu","youdao","gemini","custom_openai"],tl={manga_ocr:"MangaOCR",paddle_ocr:"PaddleOCR",baidu_ocr:"百度OCR",ai_vision:"AI视觉OCR"},nl=["ollama","sakura"],ol=["custom_openai"],al=["custom_openai"],sl={siliconflow:"SiliconFlow",deepseek:"DeepSeek",volcano:"火山引擎",caiyun:"彩云小译",baidu:"百度翻译",youdao:"有道翻译",gemini:"Google Gemini",custom_openai:"自定义 OpenAI",ollama:"Ollama",sakura:"Sakura"};function Jn(){const t=Qe(),u=ct(),l=h(!1),i=h(!1),n=X(()=>{try{return localStorage.getItem(Kt)==="true"}catch{return!1}});function a(z){return sl[z]||z}function o(z){return el.includes(z)}function S(z){return nl.includes(z)}function y(z){return ol.includes(z)}function C(z){return al.includes(z)}function b(z){return tl[z]||z}function I(){const z=t.settings,re=z.ocrEngine,G=z.baiduOcr,A=z.aiVisionOcr,c=[];return re?(re==="baidu_ocr"&&((!G?.apiKey||G.apiKey.trim()==="")&&c.push("百度OCR 的 API Key"),(!G?.secretKey||G.secretKey.trim()==="")&&c.push("百度OCR 的 Secret Key")),re==="ai_vision"&&(A?.provider||c.push("AI视觉OCR 的服务商"),(!A?.apiKey||A.apiKey.trim()==="")&&c.push("AI视觉OCR 的 API Key"),(!A?.modelName||A.modelName.trim()==="")&&c.push("AI视觉OCR 的模型名称"),A?.provider==="custom"&&(!A?.customBaseUrl||A.customBaseUrl.trim()==="")&&c.push("AI视觉OCR 的自定义 Base URL")),c.length>0?{valid:!1,message:`请先在顶部 ⚙️ 设置菜单中填写 ${c[0]}`,missingItems:c}:{valid:!0,message:""}):{valid:!1,message:"请先在顶部 ⚙️ 设置菜单中选择 OCR 引擎",missingItems:["OCR 引擎"]}}function R(){const{translation:z}=t.settings,{provider:re,apiKey:G,modelName:A,customBaseUrl:c}=z,T=[];return re?(o(re)&&(!G||G.trim()==="")&&T.push(`${a(re)} 的 API Key`),(!A||A.trim()==="")&&(S(re)||o(re))&&T.push(`${a(re)} 的模型名称`),y(re)&&(!c||c.trim()==="")&&T.push("自定义 OpenAI 服务的 Base URL"),T.length>0?{valid:!1,message:`请先在顶部 ⚙️ 设置菜单中填写 ${T[0]}`,missingItems:T}:{valid:!0,message:""}):{valid:!1,message:"请先在顶部 ⚙️ 设置菜单中选择翻译服务商",missingItems:["翻译服务商"]}}function E(){const{hqTranslation:z}=t.settings,{provider:re,apiKey:G,modelName:A,customBaseUrl:c}=z,T=[];return re?((!G||G.trim()==="")&&T.push("高质量翻译的 API Key"),(!A||A.trim()==="")&&T.push("高质量翻译的模型名称"),C(re)&&(!c||c.trim()==="")&&T.push("高质量翻译的 Base URL"),T.length>0?{valid:!1,message:`请先在顶部 ⚙️ 设置菜单中填写 ${T[0]}`,missingItems:T}:{valid:!0,message:""}):{valid:!1,message:"请先在顶部 ⚙️ 设置菜单中选择高质量翻译的服务商",missingItems:["高质量翻译服务商"]}}function g(z){const re=z||t.settings.proofreading.rounds,G=[];if(!re||re.length===0)return{valid:!1,message:"请先在顶部 ⚙️ 设置菜单中添加至少一个校对轮次",missingItems:["校对轮次"]};for(let A=0;A<re.length;A++){const c=re[A];if(!c)continue;const T=c.name||`轮次${A+1}`;if(c.provider||G.push(`校对 ${T} 的服务商`),(!c.apiKey||c.apiKey.trim()==="")&&G.push(`校对 ${T} 的 API Key`),(!c.modelName||c.modelName.trim()==="")&&G.push(`校对 ${T} 的模型名称`),G.length>0)return{valid:!1,message:`请先在顶部 ⚙️ 设置菜单中为 ${G[0]}`,missingItems:G}}return{valid:!0,message:""}}function d(z="normal",re={}){let G;switch(z){case"normal":G=R();break;case"hq":G=E();break;case"proofread":G=g(re.proofreadingRounds);break;case"ocr":G=I();break;default:G=R()}return G.valid?!0:(u.error(G.message),q(),!1)}function Y(){const z=I();if(!z.valid)return u.error(z.message),q(),!1;const re=R();return re.valid?!0:(u.error(re.message),q(),!1)}function q(){const z=document.getElementById("openSettingsBtn");z&&(i.value=!0,z.style.animation="settingsBtnPulse 0.5s ease-in-out 3",z.style.boxShadow="0 0 10px var(--primary-color, #4a90d9)",setTimeout(()=>{z.style.animation="",z.style.boxShadow="",i.value=!1},3e3))}function te(){if(n.value){console.log("用户已选择不再显示设置提醒");return}l.value=!0}function M(z=!1){if(z)try{localStorage.setItem(Kt,"true"),console.log("用户选择永久关闭设置提醒")}catch(re){console.error("保存设置提醒状态失败:",re)}l.value=!1}function w(){try{localStorage.removeItem(Kt),console.log("设置提醒状态已重置")}catch(z){console.error("重置设置提醒状态失败:",z)}}function Z(){setTimeout(()=>{te()},500)}return{showSetupReminder:l,isSettingsButtonHighlighted:i,isSetupReminderDismissed:n,validateOcrConfig:I,validateTranslationConfig:R,validateHqTranslationConfig:E,validateProofreadingConfig:g,validateBeforeTranslation:d,validateFullTranslationConfig:Y,highlightSettingsButton:q,checkAndShowSetupReminder:te,closeSetupReminder:M,resetSetupReminderDismiss:w,initValidation:Z,getProviderDisplayName:a,getOcrEngineDisplayName:b,requiresApiKey:o,isLocalProvider:S,requiresBaseUrl:y}}function qt(t){let u=t,l=0,i=0,n=Date.now();const a=()=>u<=0?0:Math.ceil(6e4/u);return{async acquire(){if(u<=0)return;const o=Date.now(),S=a();if(o-n>=6e4&&(n=o,i=0),i>=u){const C=6e4-(o-n);C>0&&await Fn(C),n=Date.now(),i=0}const y=o-l;y<S&&await Fn(S-y),l=Date.now(),i++},reset(){l=0,i=0,n=Date.now()},getRpm(){return u},setRpm(o){u=o,this.reset()}}}function Fn(t){return new Promise(u=>setTimeout(u,t))}function cn(){const t=ot(),u=Qe(),l=dt(),i=Jn(),n=ct(),a=h(null),o=h({current:0,total:0,completed:0,failed:0,isInProgress:!1,isPaused:!1}),S=h(!1),y=h(!1),C=h(!1),b=X(()=>S.value||t.isBatchTranslationInProgress||y.value||C.value),I=X(()=>o.value.total===0?0:Math.round(o.value.completed/o.value.total*100));function R(){const _=u.settings.translation.rpmLimit;a.value?a.value.setRpm(_):a.value=qt(_)}function E(_){return _.includes(",")&&_.split(",")[1]||_}function g(_,D={}){const{settings:$}=u,{textStyle:r,translation:v,baiduOcr:W,aiVisionOcr:ge,boxExpand:N,preciseMask:O}=$,f={image:E(_),ocr_engine:$.ocrEngine,source_language:$.sourceLanguage,model_provider:v.provider,api_key:v.apiKey,model_name:v.modelName,custom_base_url:v.customBaseUrl,target_language:$.targetLanguage,prompt_content:$.translatePrompt,textbox_prompt_content:$.textboxPrompt,use_textbox_prompt:$.useTextboxPrompt,rpm_limit_translation:v.rpmLimit,max_retries:v.maxRetries,use_json_format_translation:v.isJsonMode,detector_type:$.textDetector,box_expand_ratio:N.ratio,box_expand_top:N.top,box_expand_bottom:N.bottom,box_expand_left:N.left,box_expand_right:N.right,use_precise_mask:O.enabled,mask_dilate_size:O.dilateSize,mask_box_expand_ratio:O.boxExpandRatio,fontSize:r.autoFontSize?"auto":r.fontSize,autoFontSize:r.autoFontSize,fontFamily:r.fontFamily,textDirection:r.layoutDirection==="auto"?"vertical":r.layoutDirection,autoTextDirection:r.layoutDirection==="auto",textColor:r.textColor,fillColor:r.fillColor,strokeEnabled:r.strokeEnabled,strokeColor:r.strokeColor,strokeWidth:r.strokeWidth,use_inpainting:!1,use_lama:r.inpaintMethod==="lama_mpe"||r.inpaintMethod==="litelama",lamaModel:r.inpaintMethod==="litelama"?"litelama":"lama_mpe",showDetectionDebug:$.showDetectionDebug,remove_only:D.removeTextOnly,skip_translation:D.removeTextOnly,bubble_coords:D.existingBubbleCoords,bubble_angles:D.existingBubbleAngles};return $.ocrEngine==="baidu_ocr"&&(f.baidu_api_key=W.apiKey,f.baidu_secret_key=W.secretKey,f.baidu_version=W.version,f.baidu_ocr_language=W.sourceLanguage),$.ocrEngine==="ai_vision"&&(f.ai_vision_provider=ge.provider,f.ai_vision_api_key=ge.apiKey,f.ai_vision_model_name=ge.modelName,f.ai_vision_ocr_prompt=ge.prompt,f.rpm_limit_ai_vision_ocr=ge.rpmLimit,f.custom_ai_vision_base_url=ge.customBaseUrl,f.use_json_format_ai_vision_ocr=ge.isJsonMode),f}function d(_,D,$={}){if(D.error||!D.translated_image){t.setTranslationStatus(_,"failed",D.error||"翻译失败");return}const{settings:r}=u,{textStyle:v}=r;let W=null;if(D.bubble_coords&&D.bubble_coords.length>0){const O={bubble_coords:D.bubble_coords,bubble_states:D.bubble_states,original_texts:D.original_texts,bubble_texts:D.bubble_texts,textbox_texts:D.textbox_texts,bubble_angles:D.bubble_angles,auto_directions:D.auto_directions},f={fontSize:v.fontSize,fontFamily:v.fontFamily,textDirection:v.layoutDirection==="auto"?"vertical":v.layoutDirection,textColor:v.textColor,fillColor:v.fillColor,strokeEnabled:v.strokeEnabled,strokeColor:v.strokeColor,strokeWidth:v.strokeWidth,inpaintMethod:v.inpaintMethod};W=An(O,f)}const ge=D.translated_image?`data:image/png;base64,${D.translated_image}`:null,N=u.settings.textStyle.layoutDirection;t.updateImageByIndex(_,{translatedDataURL:ge,cleanImageData:D.clean_image||null,bubbleStates:W,bubbleCoords:D.bubble_coords,bubbleAngles:D.bubble_angles||[],originalTexts:D.original_texts,textboxTexts:D.textbox_texts||[],bubbleTexts:W?.map(O=>O.translatedText||"")||[],userLayoutDirection:N,translationStatus:"completed",translationFailed:!1,hasUnsavedChanges:!0}),_===t.currentImageIndex&&W&&l.setBubbles(W)}async function Y(_={}){if(_.removeTextOnly){if(!i.validateBeforeTranslation("ocr"))return!1}else if(!i.validateBeforeTranslation("normal"))return!1;const D=t.currentImage;if(!D)return n.error("请先上传图片"),!1;S.value=!0,t.setTranslationStatus(t.currentImageIndex,"processing");const $=n.showGeneralMessage("翻译中...","info",!1,0);try{R(),a.value&&await a.value.acquire();const r={..._},v=Array.isArray(D.bubbleStates),W=Array.isArray(D.bubbleCoords),ge=v||W;if(!r.existingBubbleCoords&&ge){let f,B;if(v&&D.bubbleStates.length>0?(f=D.bubbleStates.map(j=>j.coords),B=D.bubbleStates.map(j=>j.rotationAngle||0),console.log(`翻译当前图片: 使用 ${f.length} 个已有气泡状态中的坐标`)):v&&D.bubbleStates.length===0?(f=[],B=[],console.log("翻译当前图片: 检测到用户清空了气泡状态")):W&&D.bubbleCoords.length>0?(f=D.bubbleCoords,B=D.bubbleAngles,console.log(`翻译当前图片: 使用 ${f.length} 个已有的气泡坐标`)):W&&D.bubbleCoords.length===0&&(f=[],B=[],console.log("翻译当前图片: 检测到用户清空了气泡坐标")),f&&f.length>0)r.existingBubbleCoords=f,r.existingBubbleAngles=B,r.useExistingBubbles=!0,n.info("使用已有的文本框进行翻译...",3e3);else if(f&&f.length===0)return console.log("文本框已被用户清空，跳过翻译"),n.info("该图片无文本框，跳过翻译",3e3),n.clearGeneralMessageById($),S.value=!1,t.setTranslationStatus(t.currentImageIndex,"completed"),!0}const N=g(D.originalDataURL,r),O=await Mt(N);return n.clearGeneralMessageById($),d(t.currentImageIndex,O,_),O.translated_image&&!O.error?(n.success("翻译成功！"),!0):(n.error(O.error||"翻译失败"),!1)}catch(r){n.clearGeneralMessageById($);const v=r instanceof Error?r.message:"翻译请求失败";return t.markCurrentAsFailed(v),n.error(v),!1}finally{S.value=!1}}async function q(_,D={}){const $=t.images[_];if(!$)return console.error(`图片索引 ${_} 不存在`),!1;t.setTranslationStatus(_,"processing");try{a.value&&await a.value.acquire();const r={...D},v=Array.isArray($.bubbleStates),W=Array.isArray($.bubbleCoords),ge=v||W;if(!r.existingBubbleCoords&&ge){let f,B;if(v&&$.bubbleStates.length>0?(f=$.bubbleStates.map(j=>j.coords),B=$.bubbleStates.map(j=>j.rotationAngle||0)):v&&$.bubbleStates.length===0?(f=[],B=[]):W&&$.bubbleCoords.length>0?(f=$.bubbleCoords,B=$.bubbleAngles):W&&$.bubbleCoords.length===0&&(f=[],B=[]),f&&f.length>0)r.existingBubbleCoords=f,r.existingBubbleAngles=B,r.useExistingBubbles=!0;else if(f&&f.length===0)return t.setTranslationStatus(_,"completed"),!0}const N=g($.originalDataURL,r),O=await Mt(N);return d(_,O,D),!!O.translated_image&&!O.error}catch(r){const v=r instanceof Error?r.message:"翻译请求失败";return t.setTranslationStatus(_,"failed",v),!1}}async function te(_={}){if(_.removeTextOnly){if(!i.validateBeforeTranslation("ocr"))return!1}else if(!i.validateBeforeTranslation("normal"))return!1;const D=t.images;if(D.length===0)return n.error("请先上传图片"),!1;const $=_.removeTextOnly===!0;o.value={current:0,total:D.length,completed:0,failed:0,isInProgress:!0,isPaused:!1,label:$?`消除文字: 0/${D.length}`:`0/${D.length}`,percentage:0},t.setBatchTranslationInProgress(!0),R(),n.info($?`开始消除 ${D.length} 张图片文字...`:`开始批量翻译 ${D.length} 张图片...`);let r=!0;try{for(let v=0;v<D.length;v++){if(t.isBatchTranslationPaused&&await new Promise(N=>{t.setBatchTranslationResumeCallback(N)}),!t.isBatchTranslationInProgress){console.log("批量翻译已取消");break}o.value.current=v+1,o.value.label=$?`消除文字: ${v+1}/${D.length}`:`${v+1}/${D.length}`,o.value.percentage=Math.round((v+1)/D.length*100);const W=D[v];if(W&&W.translationStatus==="completed"&&!W.translationFailed){o.value.completed++;continue}await q(v,_)?o.value.completed++:(o.value.failed++,r=!1)}return o.value.failed>0?n.warning($?`消除文字完成，${o.value.failed} 张图片失败`:`翻译完成，${o.value.failed} 张图片失败`):n.success($?"所有图片文字消除完成":"所有图片翻译完成"),r}catch(v){const W=v instanceof Error?v.message:"批量翻译失败";return n.error(W),!1}finally{t.setBatchTranslationInProgress(!1),o.value.isInProgress=!1}}function M(){t.isBatchTranslationInProgress&&!t.isBatchTranslationPaused&&(t.setBatchTranslationPaused(!0),o.value.isPaused=!0,n.info("批量翻译已暂停"))}function w(){t.isBatchTranslationInProgress&&t.isBatchTranslationPaused&&(t.resumeBatchTranslation(),o.value.isPaused=!1,n.info("批量翻译继续中"))}function Z(){t.isBatchTranslationInProgress&&(t.isBatchTranslationPaused&&t.resumeBatchTranslation(),t.setBatchTranslationInProgress(!1),o.value.isInProgress=!1,n.info("批量翻译已取消"))}async function z(){return Y({removeTextOnly:!0})}async function re(){return te({removeTextOnly:!0})}async function G(_={}){if(!i.validateBeforeTranslation("normal"))return!1;const D=t.getFailedImageIndices();if(D.length===0)return n.info("没有失败的图片需要重新翻译"),!0;o.value={current:0,total:D.length,completed:0,failed:0,isInProgress:!0,isPaused:!1},t.setBatchTranslationInProgress(!0),R();let $=!0;try{for(let r=0;r<D.length&&(t.isBatchTranslationPaused&&await new Promise(ge=>{t.setBatchTranslationResumeCallback(ge)}),!!t.isBatchTranslationInProgress);r++){o.value.current=r+1;const v=D[r];if(v===void 0)continue;await q(v,_)?o.value.completed++:(o.value.failed++,$=!1)}return o.value.failed>0?n.warning(`重试完成，仍有 ${o.value.failed} 张图片失败`):n.success("所有失败图片重新翻译完成"),$}catch(r){const v=r instanceof Error?r.message:"重试翻译失败";return n.error(v),!1}finally{t.setBatchTranslationInProgress(!1),o.value.isInProgress=!1}}let A=[],c=null;function T(){return"session_"+Date.now()+"_"+Math.random().toString(36).substring(2,9)}function ne(){const _=t.images;if(_.length===0)return null;const D=[];for(let $=0;$<_.length;$++){const r=_[$];if(!r)continue;const v=r.originalTexts||[],W={imageIndex:$,bubbles:[]};for(let ge=0;ge<v.length;ge++){const N=v[ge]||"";let O="vertical";const f=r.bubbleStates?.[ge];if(f&&f.textDirection){const B=f.textDirection;O=B==="auto"?"vertical":B}else r.userLayoutDirection&&r.userLayoutDirection!=="auto"&&(O=r.userLayoutDirection);W.bubbles.push({bubbleIndex:ge,original:N,translated:"",textDirection:O})}D.push(W)}return D}function m(){return t.images.map(_=>{const D=_.originalDataURL;return D.includes(",")?D.split(",")[1]||"":D})}function V(_,D,$){return _.filter(r=>r.imageIndex>=D&&r.imageIndex<$)}function J(_){if(!_||_.length===0)return[];const D=[];for(const $ of _){if(!$){console.warn("mergeJsonResults: 跳过空的批次结果");continue}const r=Array.isArray($)?$:[$];for(const v of r)v&&typeof v=="object"&&"imageIndex"in v?D.push(v):console.warn("mergeJsonResults: 跳过无效的图片数据",v)}return D.sort(($,r)=>$.imageIndex-r.imageIndex),D}async function le(_,D,$){const{hqTranslation:r}=u.settings,v=JSON.stringify(D,null,2),W=[{type:"text",text:r.prompt+`

以下是JSON数据:
\`\`\`json
`+v+"\n```"}];for(const O of _)W.push({type:"image_url",image_url:{url:`data:image/png;base64,${O}`}});const ge=[{role:"system",content:"你是一个专业的漫画翻译助手，能够根据漫画图像内容和上下文提供高质量的翻译。"},{role:"user",content:W}],N={provider:r.provider,api_key:r.apiKey,model_name:r.modelName,custom_base_url:r.customBaseUrl,messages:ge,low_reasoning:r.lowReasoning,force_json_output:r.forceJsonOutput,no_thinking_method:r.noThinkingMethod,use_stream:r.useStream};try{console.log(`高质量翻译: 通过后端代理调用 ${r.provider} API...`);const O=await Qt(N);if(!O.success)throw new Error(O.error||"API 调用失败");if(O.results)return O.results.map(B=>({imageIndex:B.index,bubbles:B.translations.map((j,ee)=>({bubbleIndex:ee,original:"",translated:j,textDirection:"vertical"}))}));const f=O.content;if(f)if(r.forceJsonOutput)try{return JSON.parse(f)}catch(B){throw console.error("解析AI强制JSON返回的内容失败:",B),new Error("解析AI返回的JSON结果失败")}else{const B=f.match(/```json\s*([\s\S]*?)\s*```/);if(B&&B[1])try{return JSON.parse(B[1])}catch(j){throw console.error("解析AI返回的JSON失败:",j),new Error("解析AI返回的翻译结果失败")}}return null}catch(O){throw console.error("调用AI翻译API失败:",O),O}}async function s(){if(t.images.length===0)return n.warning("请先添加图片"),!1;if(t.isBatchTranslationInProgress)return n.warning("请等待当前批量操作完成"),!1;if(!i.validateBeforeTranslation("hq"))return!1;const{hqTranslation:_,textStyle:D}=u.settings,$=D.layoutDirection;c={fontFamily:D.fontFamily,fontSize:D.fontSize,autoFontSize:D.autoFontSize,autoTextDirection:$==="auto",textDirection:$==="auto"?"vertical":$,fillColor:D.fillColor,textColor:D.textColor,rotationAngle:0,strokeEnabled:D.strokeEnabled,strokeColor:D.strokeColor,strokeWidth:D.strokeWidth},console.log("高质量翻译前保存的文本样式设置:",c),o.value={current:0,total:t.images.length,completed:0,failed:0,isInProgress:!0,isPaused:!1,label:"准备翻译...",percentage:0},n.info("步骤1/4: 消除所有图片文字..."),y.value=!0,t.setBatchTranslationInProgress(!0);try{await p(),n.info("步骤2/4: 导出文本数据..."),o.value.label="导出文本数据...",o.value.percentage=25;const r=ne();if(!r)throw new Error("导出文本失败");n.info("步骤3/4: 准备图片数据..."),o.value.label="准备图片数据...",o.value.percentage=40;const v=m();n.info("步骤4/4: 发送到AI进行翻译..."),o.value.label="开始发送到AI...",o.value.percentage=50;const W=_.batchSize||3,ge=_.sessionReset||5,N=_.maxRetries??2;A=[];const O=v.length,f=Math.ceil(O/W),B=_.rpmLimit||0,j=B>0?qt(B):null;let ee=0,be=T();for(let F=0;F<f;F++){o.value.label=`${F+1}/${f}`,o.value.percentage=Math.round(50+F/f*40),ee>=ge&&(console.log("重置会话上下文"),be=T(),ee=0);const ae=F*W,ve=Math.min(ae+W,O),se=v.slice(ae,ve),Pe=V(r,ae,ve);let Ee=0,Ce=!1;for(;Ee<=N&&!Ce;)try{j&&await j.acquire();const ke=await le(se,Pe,be);ke&&(A.push(ke),Ce=!0),ee++}catch(ke){Ee++,Ee<=N?(console.log(`批次 ${F+1} 翻译失败，第 ${Ee}/${N} 次重试...`),n.warning(`批次 ${F+1} 失败，正在重试 (${Ee}/${N})...`),await new Promise(he=>setTimeout(he,1e3))):(console.error(`批次 ${F+1} 翻译最终失败:`,ke),n.error(`批次 ${F+1} 翻译失败: ${ke instanceof Error?ke.message:"未知错误"}`))}}return n.info("翻译完成，正在导入翻译结果..."),o.value.label="导入翻译结果...",o.value.percentage=90,await x(J(A)),o.value.label="翻译完成！",o.value.percentage=100,n.success("高质量翻译完成！"),!0}catch(r){return console.error("高质量翻译过程出错:",r),n.error(`翻译失败: ${r instanceof Error?r.message:"未知错误"}`),!1}finally{y.value=!1,t.setBatchTranslationInProgress(!1),setTimeout(()=>{o.value.isInProgress=!1},1e3)}}async function p(){const _=t.images.length;let D=0;o.value.label=`消除文字: 0/${_}`,o.value.percentage=0;for(let $=0;$<_;$++){const r=Math.floor($/_*25);o.value.label=`消除文字: ${$+1}/${_}`,o.value.percentage=r;const v=t.images[$];if(!v||!v.originalDataURL)continue;const W=Array.isArray(v.bubbleStates)||Array.isArray(v.bubbleCoords)&&v.bubbleCoords.length>0;let ge,N;if(W&&(v.bubbleStates&&v.bubbleStates.length>0?(ge=v.bubbleStates.map(O=>O.coords),N=v.bubbleStates.map(O=>O.rotationAngle||0)):v.bubbleCoords&&v.bubbleCoords.length>0&&(ge=v.bubbleCoords,N=v.bubbleAngles),ge&&ge.length===0)){console.log(`高质量翻译[${$}]: 文本框已被用户清空，跳过此图片`);continue}try{const O=g(v.originalDataURL,{removeTextOnly:!0,existingBubbleCoords:ge,existingBubbleAngles:N,useExistingBubbles:!!ge}),f=await Mt(O);if(f.translated_image){const B=c?.textDirection,j=B==="vertical"||B==="horizontal"||B==="auto"?B:"vertical",ee=f.bubble_coords?An(f,{fontSize:c?.fontSize||u.settings.textStyle.fontSize,fontFamily:c?.fontFamily||u.settings.textStyle.fontFamily,textDirection:j,textColor:c?.textColor||u.settings.textStyle.textColor,fillColor:c?.fillColor||u.settings.textStyle.fillColor,strokeEnabled:c?.strokeEnabled??u.settings.textStyle.strokeEnabled,strokeColor:c?.strokeColor||u.settings.textStyle.strokeColor,strokeWidth:c?.strokeWidth??u.settings.textStyle.strokeWidth,inpaintMethod:u.settings.textStyle.inpaintMethod}):[];t.updateImageByIndex($,{translatedDataURL:`data:image/png;base64,${f.translated_image}`,cleanImageData:f.clean_image||null,bubbleCoords:f.bubble_coords||[],bubbleAngles:f.bubble_angles||[],originalTexts:f.original_texts||[],textboxTexts:f.textbox_texts||[],bubbleStates:ee,bubbleTexts:ee.map(be=>be.translatedText||""),translationFailed:!1,translationStatus:"completed",hasUnsavedChanges:!0}),console.log(`高质量翻译-消除文字[${$+1}/${_}]: 处理完成`)}else D++,t.updateImageByIndex($,{translationFailed:!0,translationStatus:"failed"})}catch(O){console.error(`图片 ${$} 消除文字失败:`,O),D++,t.updateImageByIndex($,{translationFailed:!0,translationStatus:"failed"})}}if(o.value.label="消除文字完成",o.value.percentage=25,D>0)throw new Error(`消除文字完成，但有 ${D} 张图片失败`)}async function x(_){if(!_||_.length===0)throw new Error("没有有效的翻译数据可导入");const D=t.images,$=t.currentImageIndex,r=c?.fontSize||u.settings.textStyle.fontSize,v=c?.autoFontSize??u.settings.textStyle.autoFontSize,W=c?.fontFamily||u.settings.textStyle.fontFamily,ge=c?.textDirection||u.settings.textStyle.layoutDirection,N=ge==="auto"?"vertical":ge,O=c?.textColor||u.settings.textStyle.textColor,f=c?.fillColor||u.settings.textStyle.fillColor,B=c?.strokeEnabled??u.settings.textStyle.strokeEnabled,j=c?.strokeColor||u.settings.textStyle.strokeColor,ee=c?.strokeWidth??u.settings.textStyle.strokeWidth;o.value.label="更新图片数据...",o.value.percentage=90;const be=_.length;let F=0;for(const ae of _){F++,o.value.label=`处理图片 ${F}/${be}`,o.value.percentage=90+F/be*5;const ve=ae.imageIndex;if(ve<0||ve>=D.length){console.warn(`跳过无效的图片索引: ${ve}`);continue}const se=D[ve];if(!se)continue;let Pe=!1;const Ee=se.bubbleTexts||[],Ce=se.bubbleCoords||[];for(const ke of ae.bubbles||[]){const he=ke.bubbleIndex;if(he<0||he>=Ce.length){console.warn(`图片 ${ve}: 跳过无效的气泡索引 ${he}`);continue}const Ae=ke.translated;let $e=ke.textDirection;$e==="auto"&&($e=N),Ee[he]=Ae;const Ue=$e==="vertical"||$e==="horizontal"?$e:N;if(!se.bubbleStates||!Array.isArray(se.bubbleStates)||se.bubbleStates.length!==Ce.length){const Ie=se.bubbleAngles||[],De=[];for(let L=0;L<Ce.length;L++){const fe=L===he?Ue:N,Me=Ce[L];let xe=fe;const Fe=se.bubbleStates?.[L];if(Fe?.autoTextDirection&&Fe.autoTextDirection!=="auto")xe=Fe.autoTextDirection;else if(Me&&Me.length>=4){const[ut,bt,vt,ft]=Me;xe=ft-bt>vt-ut?"vertical":"horizontal"}De.push({translatedText:Ee[L]||"",originalText:se.originalTexts?.[L]||"",coords:Me,fontSize:r,fontFamily:W,textDirection:fe,autoTextDirection:xe,position:{x:0,y:0},textColor:O,rotationAngle:Ie[L]||0,fillColor:f,strokeEnabled:B,strokeColor:j,strokeWidth:ee})}se.bubbleStates=De}else se.bubbleStates[he]&&(se.bubbleStates[he].translatedText=Ae,$e&&$e!=="auto"&&(se.bubbleStates[he].textDirection=Ue));Pe=!0}if(Pe&&se.bubbleStates){const ke=se.bubbleStates.map(he=>he.translatedText||"");if(se.cleanImageData)try{const{apiClient:he}=await it(async()=>{const{apiClient:Ie}=await import("./client.Bht704G-.js");return{apiClient:Ie}},__vite__mapDeps([4,5])),Ae=se.bubbleStates.map(Ie=>({translatedText:Ie.translatedText||"",coords:Ie.coords,fontSize:Ie.fontSize||r,fontFamily:Ie.fontFamily||W,textDirection:Ie.textDirection||N,textColor:Ie.textColor||O,rotationAngle:Ie.rotationAngle||0,position:Ie.position||{x:0,y:0},strokeEnabled:Ie.strokeEnabled??B,strokeColor:Ie.strokeColor||j,strokeWidth:Ie.strokeWidth??ee}));let $e=se.cleanImageData;$e.includes("base64,")&&($e=$e.split("base64,")[1]||"");const Ue=await he.post("/api/re_render_image",{clean_image:$e,bubble_texts:ke,bubble_coords:Ce,fontSize:r,autoFontSize:v,fontFamily:W,textDirection:N,textColor:O,bubble_states:Ae,use_individual_styles:!0,use_inpainting:!1,use_lama:!1,fillColor:null,is_font_style_change:!1,strokeEnabled:B,strokeColor:j,strokeWidth:ee});Ue.rendered_image&&(t.updateImageByIndex(ve,{translatedDataURL:`data:image/png;base64,${Ue.rendered_image}`,bubbleStates:se.bubbleStates,bubbleTexts:ke,hasUnsavedChanges:!0}),console.log(`已完成图片 ${ve} 的渲染`))}catch(he){console.error(`重新渲染图片 ${ve} 失败:`,he)}else t.updateImageByIndex(ve,{bubbleStates:se.bubbleStates,bubbleTexts:ke,hasUnsavedChanges:!0})}}$>=0&&$<D.length&&t.setCurrentImageIndex($)}let oe=[];function me(){const _=t.images;if(_.length===0)return null;const D=[];for(let $=0;$<_.length;$++){const r=_[$];if(!r)continue;const v=r.originalTexts||[],W=r.bubbleTexts||[],ge={imageIndex:$,bubbles:[]};for(let N=0;N<v.length;N++){const O=v[N]||"",f=(N<W.length?W[N]:"")||"";let B="vertical";const j=r.bubbleStates?.[N];if(j&&j.textDirection){const ee=j.textDirection;B=ee==="auto"?"vertical":ee}else r.userLayoutDirection&&r.userLayoutDirection!=="auto"&&(B=r.userLayoutDirection);ge.bubbles.push({bubbleIndex:N,original:O,translated:f,textDirection:B})}D.push(ge)}return D}function ue(_,D,$){return _.filter(r=>r.imageIndex>=D&&r.imageIndex<$)}function Se(_){if(!_||_.length===0)return[];const D=[];for(const $ of _){if(!$)continue;const r=Array.isArray($)?$:[$];for(const v of r)v&&typeof v=="object"&&"imageIndex"in v&&D.push(v)}return D.sort(($,r)=>$.imageIndex-r.imageIndex),D}async function K(_,D,$,r){const v=JSON.stringify(D,null,2),W=[{type:"text",text:$.prompt+`

以下是JSON数据，包含原文和已有译文:
\`\`\`json
`+v+"\n```\n请在保持JSON格式的情况下，校对每个bubble的translated字段，使翻译更加准确、自然、符合语境。"}];for(const N of _)W.push({type:"image_url",image_url:{url:`data:image/png;base64,${N}`}});const ge={provider:$.provider,api_key:$.apiKey,model_name:$.modelName,custom_base_url:$.customBaseUrl,messages:[{role:"system",content:"你是一个专业的漫画翻译校对助手，能够根据漫画图像内容和上下文对已有翻译进行校对和润色。"},{role:"user",content:W}],low_reasoning:$.lowReasoning,no_thinking_method:$.noThinkingMethod,force_json_output:$.forceJsonOutput};try{console.log(`AI校对: 通过后端代理调用 ${$.provider} API...`);const N=await Qt(ge);if(!N.success)throw new Error(N.error||"API 调用失败");const O=N.content;if(O)if($.forceJsonOutput)try{return JSON.parse(O)}catch(f){throw console.error("解析AI强制JSON返回的内容失败:",f),new Error("解析AI返回的JSON结果失败")}else{const f=O.match(/```json\s*([\s\S]*?)\s*```/);if(f&&f[1])try{return JSON.parse(f[1])}catch(B){throw console.error("解析AI返回的JSON失败:",B),new Error("解析AI返回的校对结果失败")}try{return JSON.parse(O)}catch(B){throw console.error("直接解析AI返回内容失败:",B),new Error("无法解析AI返回的校对结果")}}return null}catch(N){throw console.error("调用AI校对API失败:",N),N}}async function k(_){if(!_||_.length===0){console.warn("没有有效的校对数据可导入"),n.warning("没有有效的校对结果可导入");return}const D=t.images,$=t.currentImageIndex,{textStyle:r}=u.settings,v=r.fontSize,W=r.fontFamily,ge=r.layoutDirection,N=ge==="auto"?"vertical":ge,O=r.textColor,f=r.fillColor,B=r.strokeEnabled,j=r.strokeColor,ee=r.strokeWidth;for(const be of _){const F=be.imageIndex;if(F<0||F>=D.length){console.warn(`跳过无效的图片索引: ${F}`);continue}const ae=D[F];if(!ae)continue;if(!be.bubbles||!Array.isArray(be.bubbles)||be.bubbles.length===0){console.warn(`图片 ${F}: 没有有效的气泡数据`);continue}let ve=!1;const se=ae.bubbleTexts||[],Pe=ae.bubbleCoords||[];for(const Ee of be.bubbles){const Ce=Ee.bubbleIndex,ke=Ee.translated||"";let he=Ee.textDirection;if((!he||he==="auto")&&(he=N),Ce<0||Ce>=Pe.length){console.warn(`图片 ${F}: 跳过无效的气泡索引 ${Ce}`);continue}for(;se.length<=Ce;)se.push("");if(se[Ce]=ke,he&&he!=="auto"){const Ae=he==="vertical"||he==="horizontal"?he:N;if(!ae.bubbleStates||!Array.isArray(ae.bubbleStates)||ae.bubbleStates.length!==Pe.length){const $e=ae.bubbleAngles||[],Ue=[];for(let Ie=0;Ie<Pe.length;Ie++){const De=Ie===Ce?Ae:N,L=Pe[Ie];let fe=De;const Me=ae.bubbleStates?.[Ie];if(Me?.autoTextDirection&&Me.autoTextDirection!=="auto")fe=Me.autoTextDirection;else if(L&&L.length>=4){const[xe,Fe,ut,bt]=L;fe=bt-Fe>ut-xe?"vertical":"horizontal"}Ue.push({translatedText:se[Ie]||"",originalText:ae.originalTexts?.[Ie]||"",coords:L,fontSize:v,fontFamily:W,textDirection:De,autoTextDirection:fe,position:{x:0,y:0},textColor:O,rotationAngle:$e[Ie]||0,fillColor:f,strokeEnabled:B,strokeColor:j,strokeWidth:ee})}ae.bubbleStates=Ue}else ae.bubbleStates[Ce]&&(ae.bubbleStates[Ce].translatedText=ke,ae.bubbleStates[Ce].textDirection=Ae)}ve=!0}if(ve&&ae.bubbleStates){const Ee=ae.bubbleStates.map(Ce=>Ce.translatedText||"");if(ae.cleanImageData)try{const{apiClient:Ce}=await it(async()=>{const{apiClient:$e}=await import("./client.Bht704G-.js");return{apiClient:$e}},__vite__mapDeps([4,5])),ke=ae.bubbleStates.map($e=>({translatedText:$e.translatedText||"",coords:$e.coords,fontSize:$e.fontSize||v,fontFamily:$e.fontFamily||W,textDirection:$e.textDirection||N,textColor:$e.textColor||O,rotationAngle:$e.rotationAngle||0,position:$e.position||{x:0,y:0},strokeEnabled:$e.strokeEnabled??B,strokeColor:$e.strokeColor||j,strokeWidth:$e.strokeWidth??ee}));let he=ae.cleanImageData;he.includes("base64,")&&(he=he.split("base64,")[1]||"");const Ae=await Ce.post("/api/re_render_image",{clean_image:he,bubble_texts:Ee,bubble_coords:Pe,fontSize:v,fontFamily:W,textDirection:N,textColor:O,bubble_states:ke,use_individual_styles:!0,use_inpainting:!1,use_lama:!1,fillColor:null,is_font_style_change:!1,strokeEnabled:B,strokeColor:j,strokeWidth:ee});Ae.rendered_image&&(t.updateImageByIndex(F,{translatedDataURL:`data:image/png;base64,${Ae.rendered_image}`,bubbleStates:ae.bubbleStates,bubbleTexts:Ee,hasUnsavedChanges:!0}),console.log(`已完成图片 ${F} 的校对渲染`))}catch(Ce){console.error(`重新渲染图片 ${F} 失败:`,Ce)}else t.updateImageByIndex(F,{bubbleStates:ae.bubbleStates,bubbleTexts:Ee,hasUnsavedChanges:!0})}}$>=0&&$<D.length&&t.setCurrentImageIndex($)}async function de(){if(!i.validateBeforeTranslation("proofread"))return!1;const{proofreading:_}=u.settings;if(!_.enabled||_.rounds.length===0)return n.error("请先启用 AI 校对并添加校对轮次"),!1;const D=t.images;if(D.length===0)return n.error("请先上传图片"),!1;if(!D.some(v=>v.bubbleTexts&&v.bubbleTexts.length>0))return n.error("请先进行翻译以获取译文"),!1;C.value=!0,t.setBatchTranslationInProgress(!0);const r=_.rounds.length;o.value={current:0,total:r,completed:0,failed:0,isInProgress:!0,isPaused:!1,label:"准备校对...",percentage:0},n.info(`开始校对，共 ${r} 轮`);try{for(let v=0;v<r;v++){const W=_.rounds[v];if(!W)continue;const ge=W.name||`轮次${v+1}`,N=v/r*100,O=1/r*100;n.info(`校对第 ${v+1}/${r} 轮: ${ge}`),o.value.label=`轮次 ${v+1}/${r}`,o.value.percentage=Math.round(N),n.info(`轮次 ${v+1}/${r}: 导出文本数据...`),o.value.label="导出文本...",o.value.percentage=Math.round(N+O*.2);const f=me();if(!f)throw new Error("导出文本失败");n.info(`轮次 ${v+1}/${r}: 准备图片数据...`),o.value.label="准备图片数据...",o.value.percentage=Math.round(N+O*.4);const B=m();n.info(`轮次 ${v+1}/${r}: 发送到AI进行校对...`),o.value.label="开始发送到AI...",o.value.percentage=Math.round(N+O*.5);const j=W.batchSize||3,ee=W.sessionReset||20,be=_.maxRetries??2;oe=[];const F=B.length,ae=Math.ceil(F/j),ve=W.rpmLimit||7,se=ve>0?qt(ve):null;let Pe=0,Ee=T(),Ce=0;for(let ke=0;ke<ae;ke++){const he=N+O*.5+O*.4*(ke/ae);o.value.label=`轮次 ${v+1}/${r}: ${ke+1}/${ae}`,o.value.percentage=Math.round(he),Pe>=ee&&(console.log("重置会话上下文"),Ee=T(),Pe=0);const Ae=ke*j,$e=Math.min(Ae+j,F),Ue=B.slice(Ae,$e),Ie=ue(f,Ae,$e);let De=0,L=!1;for(;De<=be&&!L;)try{se&&await se.acquire();const fe=await K(Ue,Ie,W,Ee);fe&&(oe.push(fe),Ce++,L=!0),Pe++}catch(fe){De++,De<=be?(console.log(`轮次 ${v+1}, 批次 ${ke+1} 校对失败，第 ${De}/${be} 次重试...`),n.warning(`轮次 ${v+1}, 批次 ${ke+1} 失败，正在重试 (${De}/${be})...`),await new Promise(Me=>setTimeout(Me,1e3))):(console.error(`轮次 ${v+1}, 批次 ${ke+1} 校对最终失败:`,fe),n.error(`轮次 ${v+1}, 批次 ${ke+1} 校对失败: ${fe instanceof Error?fe.message:"未知错误"}`))}}if(Ce===0)throw new Error(`轮次 ${v+1} 校对完全失败，请检查API设置或校对提示词`);n.info(`轮次 ${v+1}/${r}: 导入校对结果...`),o.value.label="导入校对结果...",o.value.percentage=Math.round(N+O*.9),await k(Se(oe)),o.value.completed++}return o.value.label="校对完成！",o.value.percentage=100,n.success(`AI校对完成，共 ${r} 轮`),!0}catch(v){const W=v instanceof Error?v.message:"AI 校对失败";return n.error(`校对失败: ${W}`),o.value.label="校对已取消",o.value.percentage=0,!1}finally{C.value=!1,t.setBatchTranslationInProgress(!1),setTimeout(()=>{o.value.isInProgress=!1},1e3)}}async function H(){if(!t.currentImage)return n.error("请先上传图片"),!1;const D=l.bubbles;if(!D||D.length===0)return n.error("当前图片没有气泡框，请先检测或手动添加"),!1;const $=D.map(r=>r.coords);return Y({useExistingBubbles:!0,existingBubbleCoords:$})}return{progress:o,isTranslatingSingle:S,isHqTranslating:y,isProofreading:C,isTranslating:b,progressPercent:I,translateCurrentImage:Y,translateImageByIndex:q,translateAllImages:te,pauseBatchTranslation:M,resumeBatchTranslation:w,cancelBatchTranslation:Z,removeTextOnly:z,removeAllTexts:re,retryFailedImages:G,executeHqTranslation:s,executeProofreading:de,translateWithCurrentBubbles:H}}function ll(){const t=dt(),u=ot(),l=h(!1);function i(){l.value&&(t.bubbleCount>0&&u.updateCurrentBubbleStates([...t.bubbles]),l.value=!1,t.clearSelection(),console.log("已退出编辑模式（无重渲染）"))}return{isActive:l,exitEditModeWithoutRender:i}}function il(){const t=zn(),u=Qe(),l=ot(),i=Hn(),n=dt(),a=ll(),o=h(!1),S=h(!1),y=h(null),C=h([]),b=h([]),I=h([]),R=h(null),E=h(null),g=h(null),d=h(null),Y=h(!1);async function q(){if(o.value||S.value){console.log("[TranslateInit] 已经初始化或正在初始化中，跳过");return}console.log("[TranslateInit] 开始初始化应用..."),o.value=!0,y.value=null;try{await te(),await M(),await w(),await Z(),z(),await re(),console.log("[TranslateInit] 应用初始化完成"),S.value=!0}catch(m){console.error("[TranslateInit] 应用初始化失败:",m),y.value=m instanceof Error?m.message:"初始化失败"}finally{o.value=!1}}async function te(){console.log("[TranslateInit] 初始化设置..."),u.initSettings();try{const m=await u.loadFromBackend();console.log(m?"[TranslateInit] 已从后端加载设置":"[TranslateInit] 后端无设置，使用 localStorage 数据")}catch(m){console.warn("[TranslateInit] 从后端加载设置失败，使用 localStorage 数据:",m)}console.log("[TranslateInit] 设置初始化完成")}async function M(){console.log("[TranslateInit] 初始化字体列表...");try{const m=await Nn();m.fonts&&m.fonts.length>0?(C.value=m.fonts,console.log(`[TranslateInit] 已加载 ${m.fonts.length} 个字体`)):m.error?console.warn("[TranslateInit] 获取字体列表失败:",m.error):console.warn("[TranslateInit] 字体列表为空")}catch(m){console.error("[TranslateInit] 获取字体列表失败:",m)}}async function w(){console.log("[TranslateInit] 初始化翻译提示词设置...");try{const m=await No();m.prompt_names!==void 0?(b.value=m.prompt_names||[],!u.settings.translatePrompt&&m.default_prompt_content&&u.setTranslatePrompt(m.default_prompt_content),console.log(`[TranslateInit] 已加载 ${b.value.length} 个翻译提示词`)):m.error&&console.warn("[TranslateInit] 获取翻译提示词失败:",m.error)}catch(m){console.error("[TranslateInit] 获取翻译提示词失败:",m)}}async function Z(){console.log("[TranslateInit] 初始化文本框提示词设置...");try{const m=await Vo();m.prompt_names!==void 0?(I.value=m.prompt_names||[],!u.settings.textboxPrompt&&m.default_prompt_content&&u.setTextboxPrompt(m.default_prompt_content),console.log(`[TranslateInit] 已加载 ${I.value.length} 个文本框提示词`)):m.error&&console.warn("[TranslateInit] 获取文本框提示词失败:",m.error)}catch(m){console.error("[TranslateInit] 获取文本框提示词失败:",m)}}function z(){console.log("[TranslateInit] 初始化主题模式...");const m=u.theme;typeof document<"u"&&(document.documentElement.setAttribute("data-theme",m),m==="dark"?(document.body.classList.add("dark-mode"),document.body.classList.remove("light-mode")):(document.body.classList.add("light-mode"),document.body.classList.remove("dark-mode"))),console.log(`[TranslateInit] 主题模式已设置为: ${m}`)}async function re(){const m=t.query.book,V=t.query.chapter;if(!m||!V){console.log("[TranslateInit] 未指定书籍/章节参数，使用独立模式"),Y.value=!1;return}console.log(`[TranslateInit] 检测到书籍/章节参数: book=${m}, chapter=${V}`),Y.value=!0,R.value=m,E.value=V;try{const J=await Ko(m);if(!J.success||!J.book){console.warn("[TranslateInit] 书籍不存在:",m),Re("书籍不存在","warning");return}const le=J.book,s=le.chapters?.find(p=>p.id===V);if(!s){console.warn("[TranslateInit] 章节不存在:",V),Re("章节不存在","warning");return}if(g.value=le.title,d.value=s.title,i.setBookChapterContext(m,V,le.title,s.title),typeof document<"u"&&(document.title=`${s.title} - ${le.title} - Saber-Translator`),s.session_path){console.log(`[TranslateInit] 尝试加载章节会话: ${s.session_path}`);try{await i.loadSessionByPath(s.session_path),Re(`已加载章节: ${s.title}`,"success")}catch{console.log("[TranslateInit] 章节会话数据不存在或加载失败，将创建新会话")}}}catch(J){console.error("[TranslateInit] 加载书籍/章节信息失败:",J),Re("加载书籍信息失败","error")}}function G(m){if(m<0||m>=l.imageCount){console.warn(`[TranslateInit] 无效的图片索引: ${m}`);return}window._isChangingFromSwitchImage=!0,a.isActive.value&&a.exitEditModeWithoutRender(),l.currentImage&&n.bubbles.length>0&&l.updateCurrentImageProperty("bubbleStates",n.bubbles),l.setCurrentImageIndex(m);const J=l.currentImage;if(!J){console.warn("[TranslateInit] 切换到的图片不存在"),window._isChangingFromSwitchImage=!1;return}console.log(`[TranslateInit] 切换到图片: ${m}, ${J.fileName}`),J.bubbleStates&&J.bubbleStates.length>0?n.setBubbles(J.bubbleStates,!0):n.clearBubbles(),A(J),setTimeout(()=>{window._isChangingFromSwitchImage=!1,console.log("[TranslateInit] 已重置切换图片操作标记")},100)}function A(m){if(!m)return;const V=m.bubbleStates?.[0];V&&u.updateTextStyle({fontSize:V.fontSize||u.settings.textStyle.fontSize,fontFamily:V.fontFamily||u.settings.textStyle.fontFamily,layoutDirection:m.userLayoutDirection||V.textDirection||u.settings.textStyle.layoutDirection,textColor:V.textColor||u.settings.textStyle.textColor,fillColor:V.fillColor||u.settings.textStyle.fillColor,strokeEnabled:V.strokeEnabled??u.settings.textStyle.strokeEnabled,strokeColor:V.strokeColor||u.settings.textStyle.strokeColor,strokeWidth:V.strokeWidth||u.settings.textStyle.strokeWidth,inpaintMethod:V.inpaintMethod||u.settings.textStyle.inpaintMethod,autoFontSize:m.autoFontSize??u.settings.textStyle.autoFontSize})}function c(){l.canGoPrevious&&G(l.currentImageIndex-1)}function T(){l.canGoNext&&G(l.currentImageIndex+1)}function ne(){rt(async()=>{await q()})}return{isInitializing:o,isInitialized:S,initError:y,fontList:C,promptNames:b,textboxPromptNames:I,currentBookId:R,currentChapterId:E,currentBookTitle:g,currentChapterTitle:d,isBookshelfMode:Y,initializeApp:q,initializeSettings:te,initializeFontList:M,initializePromptSettings:w,initializeTextboxPromptSettings:Z,initializeThemeMode:z,initializeBookChapterContext:re,switchImage:G,goToPrevious:c,goToNext:T,loadImageSettingsToStore:A,editMode:a,setupAutoInit:ne}}const rl={key:0,id:"translationProgressBar",class:"translation-progress-bar"},ul={class:"progress-bar-label"},cl={key:0,class:"failed-count"},dl={key:0,class:"progress-controls"},gl=["title"],bl={class:"pause-icon"},vl=Je({__name:"TranslationProgress",props:{progress:{},showControls:{type:Boolean,default:!0}},emits:["pause","resume","cancel"],setup(t,{emit:u}){const l=t,i=u,n=ot(),a=cn(),o=X(()=>l.progress||a.progress.value),S=X(()=>o.value.isInProgress||n.isBatchTranslationInProgress),y=X(()=>o.value.current),C=X(()=>o.value.total),b=X(()=>o.value.failed),I=X(()=>o.value.percentage!==void 0?o.value.percentage:C.value===0?0:Math.round(y.value/C.value*100)),R=X(()=>o.value.isPaused||n.isBatchTranslationPaused),E=X(()=>o.value.label?o.value.label:`${R.value?"已暂停":"翻译中"}：${y.value} / ${C.value}`);function g(){R.value?(a.resumeBatchTranslation(),i("resume")):(a.pauseBatchTranslation(),i("pause"))}function d(){a.cancelBatchTranslation(),i("cancel")}return(Y,q)=>S.value?(P(),U("div",rl,[e("div",ul,[Oe(pe(E.value)+" ",1),b.value>0?(P(),U("span",cl,"（"+pe(b.value)+" 张失败）",1)):we("",!0)]),e("div",{class:Le(["progress-bar",{paused:R.value}])},[e("div",{class:"progress",style:tt({width:`${I.value}%`})},null,4)],2),l.showControls?(P(),U("div",dl,[e("button",{class:Le(["pause-btn",{paused:R.value}]),onClick:g,title:R.value?"继续翻译":"暂停翻译"},[e("span",bl,pe(R.value?"▶":"⏸"),1),Oe(" "+pe(R.value?"继续":"暂停"),1)],10,gl),e("button",{class:"pause-btn cancel-btn",onClick:d,title:"取消翻译"}," ✕ 取消 ")])):we("",!0)])):we("",!0)}}),fl=Xe(vl,[["__scopeId","data-v-7e6898a3"]]),pl=Je({__name:"SponsorModal",emits:["close"],setup(t,{emit:u}){const l=u;return(i,n)=>(P(),lt(Wn,{title:"支持作者",onClose:n[1]||(n[1]=a=>l("close"))},{footer:ht(()=>[e("button",{type:"button",class:"btn btn-primary",onClick:n[0]||(n[0]=a=>l("close"))},"关闭")]),default:ht(()=>[n[2]||(n[2]=e("div",{class:"sponsor-content"},[e("p",{class:"sponsor-message"}," 如果这个项目对你有帮助，欢迎请作者喝杯咖啡 ☕ "),e("div",{class:"qr-codes"},[e("div",{class:"qr-item"},[e("div",{class:"qr-image"},[e("img",{src:"/pic/wechat_qrcode.png",alt:"微信支付"})]),e("span",{class:"qr-label"},"微信支付")]),e("div",{class:"qr-item"},[e("div",{class:"qr-image"},[e("img",{src:"/pic/alipay_qrcode.png",alt:"支付宝"})]),e("span",{class:"qr-label"},"支付宝")])]),e("p",{class:"sponsor-thanks"},"感谢您的支持！🙏")],-1))]),_:1}))}}),ml=Xe(pl,[["__scopeId","data-v-8b97c0ae"]]),hl={class:"loading-content"},yl={key:0,class:"loading-message"},xl={key:1,class:"loading-progress"},kl={class:"progress-bar"},Sl={class:"progress-text"},Cl=Je({__name:"LoadingOverlay",props:{visible:{type:Boolean,default:!1},message:{default:""},fullscreen:{type:Boolean,default:!1},size:{default:"medium"},showProgress:{type:Boolean,default:!1},progress:{default:void 0}},setup(t){const u=t,l=X(()=>u.fullscreen?"body":void 0),i=X(()=>`spinner-${u.size}`);return(n,a)=>(P(),lt($o,{to:l.value,disabled:!t.fullscreen},[Te(Gt,{name:"fade"},{default:ht(()=>[t.visible?(P(),U("div",{key:0,class:Le(["loading-overlay",{"loading-overlay-fullscreen":t.fullscreen}])},[e("div",hl,[e("div",{class:Le(["loading-spinner",i.value])},[...a[0]||(a[0]=[e("div",{class:"spinner-ring"},null,-1),e("div",{class:"spinner-ring"},null,-1),e("div",{class:"spinner-ring"},null,-1)])],2),t.message?(P(),U("div",yl,pe(t.message),1)):we("",!0),t.showProgress&&t.progress!==void 0?(P(),U("div",xl,[e("div",kl,[e("div",{class:"progress-fill",style:tt({width:`${t.progress}%`})},null,4)]),e("span",Sl,pe(t.progress)+"%",1)])):we("",!0)])],2)):we("",!0)]),_:1})],8,["to","disabled"]))}}),wl=Xe(Cl,[["__scopeId","data-v-57628bef"]]),_l={id:"thumbnail-sidebar",class:"thumbnail-sidebar"},$l={class:"card thumbnail-card"},Il=["title","onClick"],Tl=["src","alt"],Dl={class:"thumbnail-index"},Rl={key:1,class:"empty-state"},Ml=Je({__name:"ThumbnailSidebar",emits:["select"],setup(t,{emit:u}){const l=u,i=ot(),n=h(null),a=h([]),o=X(()=>i.images),S=X(()=>i.currentImageIndex),y=X(()=>i.hasImages);function C(g){l("select",g)}function b(){st(()=>{const g=a.value[S.value];if(g&&n.value){const d=n.value,Y=g.offsetTop-d.clientHeight/2+g.clientHeight/2;d.scrollTo({top:Math.max(0,Y),behavior:"smooth"})}})}function I(g,d){a.value[d]=g}function R(g){return g.translationFailed?"❌":g.translationStatus==="processing"?"⏳":g.translationStatus==="completed"?"✓":g.isManualAnnotation?"✏️":null}function E(g){return g.translationFailed?"failed":g.translationStatus==="processing"?"processing":g.translationStatus==="completed"?"completed":g.isManualAnnotation?"annotated":""}return We(S,()=>{b()}),rt(()=>{y.value&&b()}),(g,d)=>(P(),U("aside",_l,[e("div",$l,[d[1]||(d[1]=e("h2",null,"图片概览",-1)),y.value?(P(),U("ul",{key:0,ref_key:"containerRef",ref:n,id:"thumbnailList",class:"thumbnail-list"},[(P(!0),U(Ke,null,je(o.value,(Y,q)=>(P(),U("li",{key:Y.id,ref_for:!0,ref:te=>I(te,q),class:Le(["thumbnail-item",[{active:q===S.value},E(Y)]]),title:Y.fileName,onClick:te=>C(q)},[Y.originalDataURL?(P(),U("img",{key:0,src:Y.translatedDataURL||Y.originalDataURL,alt:Y.fileName,class:"thumbnail-image"},null,8,Tl)):we("",!0),e("span",Dl,pe(q+1),1),R(Y)?(P(),U("span",{key:1,class:Le(["status-indicator",E(Y)])},pe(R(Y)),3)):we("",!0)],10,Il))),128))],512)):(P(),U("div",Rl,[...d[0]||(d[0]=[e("p",null,"暂无图片",-1)])]))])]))}}),Bl=Xe(Ml,[["__scopeId","data-v-7efe8378"]]),El={class:"ocr-settings"},Pl={class:"settings-group"},Al={class:"settings-item"},Fl={class:"settings-item"},Ll={class:"input-hint"},Ol={class:"settings-group"},Ul={class:"settings-row"},zl={class:"settings-item"},Vl={class:"password-input-wrapper"},Nl=["type"],Wl={key:0,class:"eye-icon"},Kl={key:1,class:"eye-off-icon"},ql={class:"settings-item"},Hl={class:"password-input-wrapper"},Yl=["type"],Xl={key:0,class:"eye-icon"},Jl={key:1,class:"eye-off-icon"},jl={class:"settings-row"},Gl={class:"settings-item"},Zl={class:"settings-item"},Ql=["disabled"],ei={class:"settings-group"},ti={class:"settings-row"},ni={class:"settings-item"},oi={class:"settings-item"},ai={class:"password-input-wrapper"},si=["type"],li={key:0,class:"eye-icon"},ii={key:1,class:"eye-off-icon"},ri={class:"settings-item"},ui={class:"settings-item"},ci={class:"model-input-with-fetch"},di=["disabled"],gi={class:"fetch-text"},bi={key:0,class:"model-select-container"},vi={class:"model-count"},fi={class:"settings-item"},pi={class:"prompt-format-selector"},mi={class:"settings-item"},hi=["disabled"],yi=Je({__name:"OcrSettings",setup(t){const u=[{label:"MangaOCR (日语专用)",value:"manga_ocr"},{label:"PaddleOCR (多语言)",value:"paddle_ocr"},{label:"百度OCR",value:"baidu_ocr"},{label:"AI视觉OCR",value:"ai_vision"}],l=[{label:"标准版",value:"standard"},{label:"高精度版",value:"high_precision"}],i=[{label:"自动检测",value:"auto_detect"},{label:"中英文混合",value:"CHN_ENG"},{label:"英文",value:"ENG"},{label:"日语",value:"JAP"},{label:"韩语",value:"KOR"},{label:"法语",value:"FRE"},{label:"德语",value:"GER"},{label:"俄语",value:"RUS"}],n=[{label:"SiliconFlow (硅基流动)",value:"siliconflow"},{label:"火山引擎",value:"volcano"},{label:"Google Gemini",value:"gemini"},{label:"自定义 OpenAI 兼容服务",value:"custom_openai_vision"}],a=[{label:"普通提示词",value:!1},{label:"JSON提示词",value:!0}],o=[{label:"🚀 常用语言",options:[{label:"日语",value:"japanese"},{label:"英语",value:"en"},{label:"简体中文",value:"chinese"},{label:"繁体中文",value:"chinese_cht"},{label:"韩语",value:"korean"}]},{label:"🌍 拉丁语系",options:[{label:"法语",value:"french"},{label:"德语",value:"german"},{label:"西班牙语",value:"spanish"},{label:"意大利语",value:"italian"},{label:"葡萄牙语",value:"portuguese"}]},{label:"🌏 其他语系",options:[{label:"俄语",value:"russian"}]}],S=Qe(),y=X(()=>S.settings),C=ct(),b=h(!1),I=h(!1),R=h(!1),E=h(!1),g=h(!1),d=h([]),Y=X(()=>{const A=[{label:"-- 选择模型 --",value:""}];return d.value.forEach(c=>{A.push({label:c,value:c})}),A});function q(){S.saveToStorage()}function te(){S.saveToStorage(),console.log(`源语言已切换为: ${S.settings.sourceLanguage}`)}function M(){switch(S.settings.ocrEngine){case"manga_ocr":return"MangaOCR 专为日语漫画优化，源语言设置不影响识别";case"paddle_ocr":return"PaddleOCR 会根据源语言加载对应的识别模型";case"baidu_ocr":return"百度OCR 使用独立的源语言设置（见下方）";case"ai_vision":return"AI视觉OCR 通过提示词指定识别语言";default:return"选择要识别的原文语言"}}function w(){d.value=[],S.saveToStorage()}function Z(){S.settings.aiVisionOcr.isJsonMode?S.settings.aiVisionOcr.prompt=Ht:S.settings.aiVisionOcr.prompt=Yt,S.saveToStorage()}async function z(){E.value=!0;try{const A=await Ge.testBaiduOcrConnection();A.success?C.success("百度OCR连接成功"):C.error(`百度OCR连接失败: ${A.error||"未知错误"}`)}catch(A){const c=A instanceof Error?A.message:"连接测试失败";C.error(c)}finally{E.value=!1}}async function re(){E.value=!0;try{const A=S.settings.aiVisionOcr,c=await Ge.testAiVisionOcrConnection({provider:A.provider,apiKey:A.apiKey,modelName:A.modelName,customBaseUrl:A.customBaseUrl});c.success?C.success("AI视觉OCR连接成功"):C.error(`AI视觉OCR连接失败: ${c.error||"未知错误"}`)}catch(A){const c=A instanceof Error?A.message:"连接测试失败";C.error(c)}finally{E.value=!1}}async function G(){g.value=!0;try{const A=S.settings.aiVisionOcr,c=await Ge.getModelInfo(A.provider,A.apiKey);c.models&&c.models.length>0?(d.value=c.models,C.success(`获取到 ${c.models.length} 个模型`)):C.warning("未获取到可用模型")}catch(A){const c=A instanceof Error?A.message:"获取模型列表失败";C.error(c)}finally{g.value=!1}}return(A,c)=>(P(),U("div",El,[e("div",Pl,[c[19]||(c[19]=e("div",{class:"settings-group-title"},"OCR引擎选择",-1)),e("div",Al,[c[17]||(c[17]=e("label",{for:"settingsOcrEngine"},"OCR引擎:",-1)),Te(Ne,{"model-value":y.value.ocrEngine,options:u,onChange:c[0]||(c[0]=T=>{y.value.ocrEngine=T,q()})},null,8,["model-value"])]),e("div",Fl,[c[18]||(c[18]=e("label",{for:"settingsSourceLanguage"},"源语言:",-1)),Te(Ne,{"model-value":y.value.sourceLanguage,groups:o,onChange:c[1]||(c[1]=T=>{y.value.sourceLanguage=T,te()})},null,8,["model-value"]),e("div",Ll,pe(M()),1)])]),ie(e("div",Ol,[c[24]||(c[24]=e("div",{class:"settings-group-title"},"百度OCR 设置",-1)),e("div",Ul,[e("div",zl,[c[20]||(c[20]=e("label",{for:"settingsBaiduApiKey"},"API Key:",-1)),e("div",Vl,[ie(e("input",{type:b.value?"text":"password",id:"settingsBaiduApiKey","onUpdate:modelValue":c[2]||(c[2]=T=>y.value.baiduOcr.apiKey=T),class:"secure-input",placeholder:"请输入百度OCR API Key",autocomplete:"off"},null,8,Nl),[[kt,y.value.baiduOcr.apiKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:c[3]||(c[3]=T=>b.value=!b.value)},[b.value?(P(),U("span",Kl,"👁‍🗨")):(P(),U("span",Wl,"👁"))])])]),e("div",ql,[c[21]||(c[21]=e("label",{for:"settingsBaiduSecretKey"},"Secret Key:",-1)),e("div",Hl,[ie(e("input",{type:I.value?"text":"password",id:"settingsBaiduSecretKey","onUpdate:modelValue":c[4]||(c[4]=T=>y.value.baiduOcr.secretKey=T),class:"secure-input",placeholder:"请输入Secret Key",autocomplete:"off"},null,8,Yl),[[kt,y.value.baiduOcr.secretKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:c[5]||(c[5]=T=>I.value=!I.value)},[I.value?(P(),U("span",Jl,"👁‍🗨")):(P(),U("span",Xl,"👁"))])])])]),e("div",jl,[e("div",Gl,[c[22]||(c[22]=e("label",{for:"settingsBaiduVersion"},"识别版本:",-1)),Te(Ne,{"model-value":y.value.baiduOcr.version,options:l,onChange:c[6]||(c[6]=T=>y.value.baiduOcr.version=T)},null,8,["model-value"])]),e("div",Zl,[c[23]||(c[23]=e("label",{for:"settingsBaiduSourceLanguage"},"源语言:",-1)),Te(Ne,{"model-value":y.value.baiduOcr.sourceLanguage,options:i,onChange:c[7]||(c[7]=T=>y.value.baiduOcr.sourceLanguage=T)},null,8,["model-value"])])]),e("button",{class:"settings-test-btn",onClick:z,disabled:E.value},pe(E.value?"测试中...":"🔗 测试连接"),9,Ql)],512),[[Ye,y.value.ocrEngine==="baidu_ocr"]]),ie(e("div",ei,[c[34]||(c[34]=e("div",{class:"settings-group-title"},"AI视觉OCR 设置",-1)),e("div",ti,[e("div",ni,[c[25]||(c[25]=e("label",{for:"settingsAiVisionProvider"},"服务商:",-1)),Te(Ne,{"model-value":y.value.aiVisionOcr.provider,options:n,onChange:c[8]||(c[8]=T=>{y.value.aiVisionOcr.provider=T,w()})},null,8,["model-value"])]),e("div",oi,[c[26]||(c[26]=e("label",{for:"settingsAiVisionApiKey"},"API Key:",-1)),e("div",ai,[ie(e("input",{type:R.value?"text":"password",id:"settingsAiVisionApiKey","onUpdate:modelValue":c[9]||(c[9]=T=>y.value.aiVisionOcr.apiKey=T),class:"secure-input",placeholder:"请输入API Key",autocomplete:"off"},null,8,si),[[kt,y.value.aiVisionOcr.apiKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:c[10]||(c[10]=T=>R.value=!R.value)},[R.value?(P(),U("span",ii,"👁‍🗨")):(P(),U("span",li,"👁"))])])])]),ie(e("div",ri,[c[27]||(c[27]=e("label",{for:"settingsCustomAiVisionBaseUrl"},"Base URL:",-1)),ie(e("input",{type:"text",id:"settingsCustomAiVisionBaseUrl","onUpdate:modelValue":c[11]||(c[11]=T=>y.value.aiVisionOcr.customBaseUrl=T),placeholder:"例如: https://api.example.com/v1"},null,512),[[Be,y.value.aiVisionOcr.customBaseUrl]])],512),[[Ye,y.value.aiVisionOcr.provider==="custom_openai_vision"]]),e("div",ui,[c[29]||(c[29]=e("label",{for:"settingsAiVisionModelName"},"模型名称:",-1)),e("div",ci,[ie(e("input",{type:"text",id:"settingsAiVisionModelName","onUpdate:modelValue":c[12]||(c[12]=T=>y.value.aiVisionOcr.modelName=T),placeholder:"如: silicon-llava2-34b"},null,512),[[Be,y.value.aiVisionOcr.modelName]]),e("button",{type:"button",class:"fetch-models-btn",title:"获取可用模型列表",onClick:G,disabled:g.value},[c[28]||(c[28]=e("span",{class:"fetch-icon"},"🔍",-1)),e("span",gi,pe(g.value?"获取中...":"获取模型"),1)],8,di)]),d.value.length>0?(P(),U("div",bi,[Te(Ne,{"model-value":y.value.aiVisionOcr.modelName,options:Y.value,onChange:c[13]||(c[13]=T=>y.value.aiVisionOcr.modelName=T)},null,8,["model-value","options"]),e("span",vi,"共 "+pe(d.value.length)+" 个模型",1)])):we("",!0)]),e("div",fi,[c[31]||(c[31]=e("label",{for:"settingsAiVisionOcrPrompt"},"OCR提示词:",-1)),ie(e("textarea",{id:"settingsAiVisionOcrPrompt","onUpdate:modelValue":c[14]||(c[14]=T=>y.value.aiVisionOcr.prompt=T),rows:"3",placeholder:"AI视觉OCR提示词"},null,512),[[Be,y.value.aiVisionOcr.prompt]]),e("div",pi,[Te(Ne,{"model-value":y.value.aiVisionOcr.isJsonMode,options:a,onChange:c[15]||(c[15]=T=>{y.value.aiVisionOcr.isJsonMode=T,Z()})},null,8,["model-value"]),c[30]||(c[30]=e("span",{class:"input-hint"},"JSON格式输出更结构化",-1))])]),e("div",mi,[c[32]||(c[32]=e("label",{for:"settingsRpmAiVisionOcr"},"RPM限制 (每分钟请求数):",-1)),ie(e("input",{type:"number",id:"settingsRpmAiVisionOcr","onUpdate:modelValue":c[16]||(c[16]=T=>y.value.aiVisionOcr.rpmLimit=T),min:"0",step:"1"},null,512),[[Be,y.value.aiVisionOcr.rpmLimit,void 0,{number:!0}]]),c[33]||(c[33]=e("div",{class:"input-hint"},"0 表示无限制",-1))]),e("button",{class:"settings-test-btn",onClick:re,disabled:E.value},pe(E.value?"测试中...":"🔗 测试连接"),9,hi)],512),[[Ye,y.value.ocrEngine==="ai_vision"]])]))}}),xi=Xe(yi,[["__scopeId","data-v-3857bec2"]]),ki={class:"translation-settings"},Si={class:"settings-group"},Ci={class:"settings-row"},wi={class:"settings-item"},_i={class:"settings-item"},$i={for:"settingsApiKey"},Ii={class:"password-input-wrapper"},Ti=["type","placeholder"],Di={key:0,class:"eye-icon"},Ri={key:1,class:"eye-off-icon"},Mi={class:"settings-item"},Bi={class:"settings-item"},Ei={for:"settingsModelName"},Pi={class:"model-input-with-fetch"},Ai=["placeholder"],Fi={id:"modelHistoryDatalist"},Li=["value"],Oi=["disabled"],Ui={class:"fetch-text"},zi={key:0,class:"model-select-container"},Vi={class:"model-count"},Ni={key:1,class:"model-history-container"},Wi={class:"history-tags"},Ki=["onClick"],qi={class:"settings-item"},Hi={class:"local-model-list"},Yi={key:0,class:"model-list-container"},Xi=["disabled"],Ji={key:1,class:"model-hint"},ji={key:1,class:"model-list-container"},Gi=["disabled"],Zi={key:1,class:"model-hint"},Qi={class:"settings-row"},er={class:"settings-item"},tr={class:"settings-item"},nr={class:"settings-item"},or=["disabled"],ar={class:"settings-group"},sr={class:"settings-item"},lr={class:"prompt-format-selector"},ir={class:"settings-item"},rr={class:"settings-item"},ur={class:"checkbox-label"},cr={class:"settings-item"},dr=Je({__name:"TranslationSettings",setup(t){const u=[{label:"SiliconFlow",value:"siliconflow"},{label:"DeepSeek",value:"deepseek"},{label:"火山引擎",value:"volcano"},{label:"彩云小译",value:"caiyun"},{label:"百度翻译",value:"baidu_translate"},{label:"有道翻译",value:"youdao_translate"},{label:"Google Gemini",value:"gemini"},{label:"Ollama (本地)",value:"ollama"},{label:"Sakura (本地)",value:"sakura"},{label:"自定义 OpenAI 兼容服务",value:"custom_openai"}],l=[{label:"普通提示词",value:"normal"},{label:"JSON提示词",value:"json"}],i=[{label:"简体中文",value:"简体中文"},{label:"繁體中文",value:"繁體中文"},{label:"English",value:"English"},{label:"日本語",value:"日本語"},{label:"한국어",value:"한국어"}],n=Qe(),a=ct(),o=h({modelProvider:n.settings.translation.provider,apiKey:n.settings.translation.apiKey,modelName:n.settings.translation.modelName,customBaseUrl:n.settings.translation.customBaseUrl,rpmTranslation:n.settings.translation.rpmLimit,translationMaxRetries:n.settings.translation.maxRetries,promptContent:n.settings.translatePrompt,translatePromptMode:n.settings.translation.isJsonMode?"json":"normal",targetLanguage:n.settings.targetLanguage,enableTextboxPrompt:n.settings.useTextboxPrompt,textboxPromptContent:n.settings.textboxPrompt}),S=h(!1),y=h(!1),C=h(!1),b=h([]),I=h([]),R=h([]),E=X(()=>{const s=[{label:"-- 选择模型 --",value:""}];return b.value.forEach(p=>s.push({label:p,value:p})),s}),g=X(()=>{const s=[{label:"-- 选择模型 --",value:""}];return I.value.forEach(p=>s.push({label:p,value:p})),s}),d=X(()=>{const s=[{label:"-- 选择模型 --",value:""}];return R.value.forEach(p=>s.push({label:p,value:p})),s}),Y=X(()=>n.getModelHistory(o.value.modelProvider)),q=X(()=>["ollama","sakura"].includes(o.value.modelProvider)),te=X(()=>!["ollama","sakura","caiyun","baidu_translate","youdao_translate"].includes(o.value.modelProvider)),M=X(()=>["siliconflow","deepseek","volcano","gemini","custom_openai"].includes(o.value.modelProvider)),w=X(()=>{switch(o.value.modelProvider){case"baidu_translate":return"App ID";case"youdao_translate":return"App Key";case"caiyun":return"API Token";default:return"API Key"}}),Z=X(()=>{switch(o.value.modelProvider){case"baidu_translate":return"请输入百度翻译App ID";case"youdao_translate":return"请输入有道翻译应用ID";case"caiyun":return"请输入彩云小译Token";default:return"请输入API Key"}}),z=X(()=>{switch(o.value.modelProvider){case"baidu_translate":return"App Key";case"youdao_translate":return"App Secret";case"caiyun":return"源语言 (可选)";default:return"模型名称"}}),re=X(()=>{switch(o.value.modelProvider){case"baidu_translate":return"请输入百度翻译App Key";case"youdao_translate":return"请输入有道翻译应用密钥";case"caiyun":return"可选: auto/日语/英语";default:return"请输入模型名称"}});function G(){const s=o.value.modelProvider;n.setTranslationProvider(s),o.value.apiKey=n.settings.translation.apiKey,o.value.modelName=n.settings.translation.modelName,o.value.customBaseUrl=n.settings.translation.customBaseUrl,o.value.rpmTranslation=n.settings.translation.rpmLimit,o.value.translationMaxRetries=n.settings.translation.maxRetries,b.value=[],console.log(`[TranslationSettings] 服务商已切换为: ${s}`)}function A(){const s=o.value.translatePromptMode==="json";s?o.value.promptContent=Xt:o.value.promptContent=Jt,n.updateTranslationService({isJsonMode:s}),n.setTranslatePrompt(o.value.promptContent)}We(()=>o.value.apiKey,s=>{n.updateTranslationService({apiKey:s})}),We(()=>o.value.modelName,s=>{n.updateTranslationService({modelName:s})}),We(()=>o.value.customBaseUrl,s=>{n.updateTranslationService({customBaseUrl:s})}),We(()=>o.value.rpmTranslation,s=>{n.updateTranslationService({rpmLimit:s})}),We(()=>o.value.translationMaxRetries,s=>{n.updateTranslationService({maxRetries:s})}),We(()=>o.value.promptContent,s=>{n.setTranslatePrompt(s)}),We(()=>o.value.targetLanguage,s=>{n.updateSettings({targetLanguage:s})}),We(()=>o.value.enableTextboxPrompt,s=>{n.setUseTextboxPrompt(s)}),We(()=>o.value.textboxPromptContent,s=>{n.setTextboxPrompt(s)});async function c(){C.value=!0;try{const s=await Ge.getModelInfo(o.value.modelProvider,o.value.apiKey);s.models&&s.models.length>0?(b.value=s.models,a.success(`获取到 ${s.models.length} 个模型`)):a.warning("未获取到可用模型")}catch(s){const p=s instanceof Error?s.message:"获取模型列表失败";a.error(p)}finally{C.value=!1}}async function T(){C.value=!0;try{const s=await Ge.testOllamaConnection();s.success&&s.models?(I.value=s.models,a.success(`获取到 ${s.models.length} 个Ollama模型`)):a.error(s.error||"Ollama连接失败")}catch(s){const p=s instanceof Error?s.message:"获取Ollama模型失败";a.error(p)}finally{C.value=!1}}async function ne(){C.value=!0;try{const s=await Ge.testSakuraConnection();s.success&&s.models?(R.value=s.models,a.success(`获取到 ${s.models.length} 个Sakura模型`)):a.error(s.error||"Sakura连接失败")}catch(s){const p=s instanceof Error?s.message:"获取Sakura模型失败";a.error(p)}finally{C.value=!1}}async function m(){y.value=!0;try{let s;o.value.modelProvider==="ollama"?s=await Ge.testOllamaConnection():s=await Ge.testSakuraConnection(),s.success?a.success(`${o.value.modelProvider==="ollama"?"Ollama":"Sakura"} 连接成功`):a.error(s.error||"连接失败")}catch(s){const p=s instanceof Error?s.message:"连接测试失败";a.error(p)}finally{y.value=!1}}async function V(){const s=o.value.modelProvider,p=o.value.modelName;if(!(!p||!s)&&(n.addModelToHistory(s,p),!["baidu_translate","youdao_translate"].includes(s)))try{await Ge.saveModelInfo(s,p),console.log(`[TranslationSettings] 模型历史已保存到后端: ${s} -> ${p}`)}catch(x){console.warn("保存模型历史到后端失败:",x)}}async function J(){const s=o.value.modelProvider;if(!["baidu_translate","youdao_translate","ollama","sakura"].includes(s))try{const p=await Ge.getUsedModels(s);p.models&&p.models.length>0&&p.models.forEach(x=>{n.addModelToHistory(s,x)})}catch(p){console.warn("从后端加载模型历史失败:",p)}}function le(s){o.value.modelName=s}return rt(()=>{J()}),(s,p)=>(P(),U("div",ki,[e("div",Si,[p[23]||(p[23]=e("div",{class:"settings-group-title"},"翻译服务配置",-1)),e("div",Ci,[e("div",wi,[p[15]||(p[15]=e("label",{for:"settingsModelProvider"},"翻译服务商:",-1)),Te(Ne,{"model-value":o.value.modelProvider,options:u,onChange:p[0]||(p[0]=x=>{o.value.modelProvider=x,G()})},null,8,["model-value"])]),ie(e("div",_i,[e("label",$i,pe(w.value)+":",1),e("div",Ii,[ie(e("input",{type:S.value?"text":"password",id:"settingsApiKey","onUpdate:modelValue":p[1]||(p[1]=x=>o.value.apiKey=x),class:"secure-input",placeholder:Z.value,autocomplete:"off"},null,8,Ti),[[kt,o.value.apiKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:p[2]||(p[2]=x=>S.value=!S.value)},[S.value?(P(),U("span",Ri,"👁‍🗨")):(P(),U("span",Di,"👁"))])])],512),[[Ye,!q.value]])]),ie(e("div",Mi,[p[16]||(p[16]=e("label",{for:"settingsCustomBaseUrl"},"Base URL:",-1)),ie(e("input",{type:"text",id:"settingsCustomBaseUrl","onUpdate:modelValue":p[3]||(p[3]=x=>o.value.customBaseUrl=x),placeholder:"例如: https://api.example.com/v1"},null,512),[[Be,o.value.customBaseUrl]])],512),[[Ye,o.value.modelProvider==="custom_openai"]]),ie(e("div",Bi,[e("label",Ei,pe(z.value)+":",1),e("div",Pi,[ie(e("input",{type:"text",id:"settingsModelName","onUpdate:modelValue":p[4]||(p[4]=x=>o.value.modelName=x),placeholder:re.value,onBlur:V,list:"modelHistoryDatalist"},null,40,Ai),[[Be,o.value.modelName]]),e("datalist",Fi,[(P(!0),U(Ke,null,je(Y.value,x=>(P(),U("option",{key:x,value:x},null,8,Li))),128))]),ie(e("button",{type:"button",class:"fetch-models-btn",title:"获取可用模型列表",onClick:c,disabled:C.value},[p[17]||(p[17]=e("span",{class:"fetch-icon"},"🔍",-1)),e("span",Ui,pe(C.value?"获取中...":"获取模型"),1)],8,Oi),[[Ye,M.value]])]),b.value.length>0?(P(),U("div",zi,[Te(Ne,{"model-value":o.value.modelName,options:E.value,onChange:p[5]||(p[5]=x=>{o.value.modelName=x,V()})},null,8,["model-value","options"]),e("span",Vi,"共 "+pe(b.value.length)+" 个模型",1)])):we("",!0),Y.value.length>0&&b.value.length===0?(P(),U("div",Ni,[p[18]||(p[18]=e("span",{class:"history-label"},"历史记录:",-1)),e("div",Wi,[(P(!0),U(Ke,null,je(Y.value.slice(0,5),x=>(P(),U("span",{key:x,class:Le(["history-tag",{active:o.value.modelName===x}]),onClick:oe=>le(x)},pe(x),11,Ki))),128))])])):we("",!0)],512),[[Ye,!q.value]]),ie(e("div",qi,[p[19]||(p[19]=e("label",null,"本地模型:",-1)),e("div",Hi,[o.value.modelProvider==="ollama"?(P(),U("div",Yi,[e("button",{class:"settings-test-btn",onClick:T,disabled:C.value},pe(C.value?"获取中...":"🔄 刷新模型列表"),9,Xi),I.value.length>0?(P(),lt(Ne,{key:0,"model-value":o.value.modelName,options:g.value,onChange:p[6]||(p[6]=x=>o.value.modelName=x)},null,8,["model-value","options"])):(P(),U("p",Ji,"点击刷新获取可用模型"))])):o.value.modelProvider==="sakura"?(P(),U("div",ji,[e("button",{class:"settings-test-btn",onClick:ne,disabled:C.value},pe(C.value?"获取中...":"🔄 刷新模型列表"),9,Gi),R.value.length>0?(P(),lt(Ne,{key:0,"model-value":o.value.modelName,options:d.value,onChange:p[7]||(p[7]=x=>o.value.modelName=x)},null,8,["model-value","options"])):(P(),U("p",Zi,"点击刷新获取可用模型"))])):we("",!0)])],512),[[Ye,q.value]]),ie(e("div",Qi,[e("div",er,[p[20]||(p[20]=e("label",{for:"settingsRpmTranslation"},"RPM限制:",-1)),ie(e("input",{type:"number",id:"settingsRpmTranslation","onUpdate:modelValue":p[8]||(p[8]=x=>o.value.rpmTranslation=x),min:"0",step:"1"},null,512),[[Be,o.value.rpmTranslation,void 0,{number:!0}]]),p[21]||(p[21]=e("div",{class:"input-hint"},"每分钟请求数，0表示无限制",-1))]),e("div",tr,[p[22]||(p[22]=e("label",{for:"settingsTranslationMaxRetries"},"重试次数:",-1)),ie(e("input",{type:"number",id:"settingsTranslationMaxRetries","onUpdate:modelValue":p[9]||(p[9]=x=>o.value.translationMaxRetries=x),min:"0",max:"10",step:"1"},null,512),[[Be,o.value.translationMaxRetries,void 0,{number:!0}]])])],512),[[Ye,te.value]]),ie(e("div",nr,[e("button",{class:"settings-test-btn",onClick:m,disabled:y.value},pe(y.value?"测试中...":"🔗 测试连接"),9,or)],512),[[Ye,q.value]])]),e("div",ar,[p[29]||(p[29]=e("div",{class:"settings-group-title"},"提示词设置",-1)),e("div",sr,[p[25]||(p[25]=e("label",{for:"settingsPromptContent"},"翻译提示词:",-1)),ie(e("textarea",{id:"settingsPromptContent","onUpdate:modelValue":p[10]||(p[10]=x=>o.value.promptContent=x),rows:"4",placeholder:"翻译提示词"},null,512),[[Be,o.value.promptContent]]),e("div",lr,[Te(Ne,{"model-value":o.value.translatePromptMode,options:l,onChange:p[11]||(p[11]=x=>{o.value.translatePromptMode=x,A()})},null,8,["model-value"]),p[24]||(p[24]=e("span",{class:"input-hint"},"JSON格式输出更结构化",-1))])]),e("div",ir,[p[26]||(p[26]=e("label",{for:"settingsTargetLanguage"},"目标语言:",-1)),Te(Ne,{"model-value":o.value.targetLanguage,options:i,onChange:p[12]||(p[12]=x=>o.value.targetLanguage=x)},null,8,["model-value"])]),e("div",rr,[e("label",ur,[ie(e("input",{type:"checkbox","onUpdate:modelValue":p[13]||(p[13]=x=>o.value.enableTextboxPrompt=x)},null,512),[[Ze,o.value.enableTextboxPrompt]]),p[27]||(p[27]=Oe(" 启用文本框提示词 ",-1))])]),ie(e("div",cr,[p[28]||(p[28]=e("label",{for:"settingsTextboxPromptContent"},"文本框提示词:",-1)),ie(e("textarea",{id:"settingsTextboxPromptContent","onUpdate:modelValue":p[14]||(p[14]=x=>o.value.textboxPromptContent=x),rows:"3",placeholder:"文本框提示词"},null,512),[[Be,o.value.textboxPromptContent]])],512),[[Ye,o.value.enableTextboxPrompt]])])]))}}),gr=Xe(dr,[["__scopeId","data-v-7a5d1f82"]]),br={class:"detection-settings"},vr={class:"settings-group"},fr={class:"settings-item"},pr={class:"settings-group"},mr={class:"settings-item"},hr={class:"settings-row"},yr={class:"settings-item"},xr={class:"settings-item"},kr={class:"settings-row"},Sr={class:"settings-item"},Cr={class:"settings-item"},wr={class:"settings-group"},_r={class:"settings-item"},$r={class:"checkbox-label"},Ir={class:"settings-row"},Tr={class:"settings-item"},Dr={class:"settings-item"},Rr={class:"settings-group"},Mr={class:"settings-item"},Br={class:"checkbox-label"},Er={class:"settings-group"},Pr=["disabled"],Ar=Je({__name:"DetectionSettings",setup(t){const u=[{label:"CTD (Comic Text Detector)",value:"ctd"},{label:"YOLO",value:"yolo"},{label:"YOLOv5",value:"yolov5"},{label:"Default (DBNet)",value:"default"}],l=Qe(),i=ct(),n=Io({textDetector:l.settings.textDetector,boxExpandRatio:l.settings.boxExpand.ratio,boxExpandTop:l.settings.boxExpand.top,boxExpandBottom:l.settings.boxExpand.bottom,boxExpandLeft:l.settings.boxExpand.left,boxExpandRight:l.settings.boxExpand.right,usePreciseMask:l.settings.preciseMask.enabled,maskDilateSize:l.settings.preciseMask.dilateSize,maskBoxExpandRatio:l.settings.preciseMask.boxExpandRatio,showDetectionDebug:l.settings.showDetectionDebug}),a=h(!1),o=X(()=>["ctd","default"].includes(n.textDetector));We(()=>n.textDetector,C=>{l.setTextDetector(C)}),We(()=>n.boxExpandRatio,C=>{l.updateBoxExpand({ratio:C})}),We(()=>n.boxExpandTop,C=>{l.updateBoxExpand({top:C})}),We(()=>n.boxExpandBottom,C=>{l.updateBoxExpand({bottom:C})}),We(()=>n.boxExpandLeft,C=>{l.updateBoxExpand({left:C})}),We(()=>n.boxExpandRight,C=>{l.updateBoxExpand({right:C})}),We(()=>n.usePreciseMask,C=>{l.updatePreciseMask({enabled:C})}),We(()=>n.maskDilateSize,C=>{l.updatePreciseMask({dilateSize:C})}),We(()=>n.maskBoxExpandRatio,C=>{l.updatePreciseMask({boxExpandRatio:C})}),We(()=>n.showDetectionDebug,C=>{l.setShowDetectionDebug(C)});function S(){o.value||(n.usePreciseMask=!1)}async function y(){a.value=!0;try{const C=await Ge.testLamaRepair();C.success?i.success("LAMA修复功能正常"):i.error(`LAMA修复测试失败: ${C.error||"未知错误"}`)}catch(C){const b=C instanceof Error?C.message:"测试失败";i.error(b)}finally{a.value=!1}}return(C,b)=>(P(),U("div",br,[e("div",vr,[b[11]||(b[11]=e("div",{class:"settings-group-title"},"文字检测器",-1)),e("div",fr,[b[10]||(b[10]=e("label",{for:"settingsTextDetector"},"检测器类型:",-1)),Te(Ne,{modelValue:n.textDetector,"onUpdate:modelValue":b[0]||(b[0]=I=>n.textDetector=I),options:u,onChange:S},null,8,["modelValue"])])]),e("div",pr,[b[18]||(b[18]=e("div",{class:"settings-group-title"},"文本框扩展参数",-1)),e("div",mr,[b[12]||(b[12]=e("label",{for:"settingsBoxExpandRatio"},"整体扩展 (像素):",-1)),ie(e("input",{type:"number",id:"settingsBoxExpandRatio","onUpdate:modelValue":b[1]||(b[1]=I=>n.boxExpandRatio=I),min:"0",step:"1"},null,512),[[Be,n.boxExpandRatio,void 0,{number:!0}]]),b[13]||(b[13]=e("div",{class:"input-hint"},"向四周均匀扩展的像素数",-1))]),e("div",hr,[e("div",yr,[b[14]||(b[14]=e("label",{for:"settingsBoxExpandTop"},"上方扩展:",-1)),ie(e("input",{type:"number",id:"settingsBoxExpandTop","onUpdate:modelValue":b[2]||(b[2]=I=>n.boxExpandTop=I),min:"0",step:"1"},null,512),[[Be,n.boxExpandTop,void 0,{number:!0}]])]),e("div",xr,[b[15]||(b[15]=e("label",{for:"settingsBoxExpandBottom"},"下方扩展:",-1)),ie(e("input",{type:"number",id:"settingsBoxExpandBottom","onUpdate:modelValue":b[3]||(b[3]=I=>n.boxExpandBottom=I),min:"0",step:"1"},null,512),[[Be,n.boxExpandBottom,void 0,{number:!0}]])])]),e("div",kr,[e("div",Sr,[b[16]||(b[16]=e("label",{for:"settingsBoxExpandLeft"},"左侧扩展:",-1)),ie(e("input",{type:"number",id:"settingsBoxExpandLeft","onUpdate:modelValue":b[4]||(b[4]=I=>n.boxExpandLeft=I),min:"0",step:"1"},null,512),[[Be,n.boxExpandLeft,void 0,{number:!0}]])]),e("div",Cr,[b[17]||(b[17]=e("label",{for:"settingsBoxExpandRight"},"右侧扩展:",-1)),ie(e("input",{type:"number",id:"settingsBoxExpandRight","onUpdate:modelValue":b[5]||(b[5]=I=>n.boxExpandRight=I),min:"0",step:"1"},null,512),[[Be,n.boxExpandRight,void 0,{number:!0}]])])])]),ie(e("div",wr,[b[25]||(b[25]=e("div",{class:"settings-group-title"},"精确文字掩膜",-1)),e("div",_r,[e("label",$r,[ie(e("input",{type:"checkbox","onUpdate:modelValue":b[6]||(b[6]=I=>n.usePreciseMask=I)},null,512),[[Ze,n.usePreciseMask]]),b[19]||(b[19]=Oe(" 启用精确文字掩膜 ",-1))]),b[20]||(b[20]=e("div",{class:"input-hint"},"使用更精确的文字区域掩膜进行修复",-1))]),ie(e("div",Ir,[e("div",Tr,[b[21]||(b[21]=e("label",{for:"settingsMaskDilateSize"},"膨胀大小:",-1)),ie(e("input",{type:"number",id:"settingsMaskDilateSize","onUpdate:modelValue":b[7]||(b[7]=I=>n.maskDilateSize=I),min:"0",step:"1"},null,512),[[Be,n.maskDilateSize,void 0,{number:!0}]]),b[22]||(b[22]=e("div",{class:"input-hint"},"掩膜膨胀像素数",-1))]),e("div",Dr,[b[23]||(b[23]=e("label",{for:"settingsMaskBoxExpandRatio"},"标注框扩大比例 (%):",-1)),ie(e("input",{type:"number",id:"settingsMaskBoxExpandRatio","onUpdate:modelValue":b[8]||(b[8]=I=>n.maskBoxExpandRatio=I),min:"0",max:"100",step:"1"},null,512),[[Be,n.maskBoxExpandRatio,void 0,{number:!0}]]),b[24]||(b[24]=e("div",{class:"input-hint"},"标注框区域扩大百分比",-1))])],512),[[Ye,n.usePreciseMask]])],512),[[Ye,o.value]]),e("div",Rr,[b[28]||(b[28]=e("div",{class:"settings-group-title"},"调试选项",-1)),e("div",Mr,[e("label",Br,[ie(e("input",{type:"checkbox","onUpdate:modelValue":b[9]||(b[9]=I=>n.showDetectionDebug=I)},null,512),[[Ze,n.showDetectionDebug]]),b[26]||(b[26]=Oe(" 显示检测框调试信息 ",-1))]),b[27]||(b[27]=e("div",{class:"input-hint"},"在翻译结果中显示气泡检测框，用于调试",-1))])]),e("div",Er,[b[29]||(b[29]=e("div",{class:"settings-group-title"},"修复功能测试",-1)),e("button",{class:"settings-test-btn",onClick:y,disabled:a.value},pe(a.value?"测试中...":"🔗 测试LAMA修复"),9,Pr)])]))}}),Fr=Xe(Ar,[["__scopeId","data-v-99c07155"]]),Lr={class:"hq-translation-settings"},Or={class:"settings-group"},Ur={class:"settings-row"},zr={class:"settings-item"},Vr={class:"settings-item"},Nr={class:"password-input-wrapper"},Wr=["type"],Kr={key:0,class:"eye-icon"},qr={key:1,class:"eye-off-icon"},Hr={class:"settings-item"},Yr={class:"settings-item"},Xr={class:"model-input-with-fetch"},Jr=["disabled"],jr={class:"fetch-text"},Gr={key:0,class:"model-select-container"},Zr={class:"model-count"},Qr={class:"settings-group"},eu={class:"settings-row"},tu={class:"settings-item"},nu={class:"settings-item"},ou={class:"settings-row"},au={class:"settings-item"},su={class:"settings-item"},lu={class:"settings-group"},iu={class:"settings-row"},ru={class:"settings-item"},uu={class:"checkbox-label"},cu={class:"settings-item"},du={class:"settings-row"},gu={class:"settings-item"},bu={class:"checkbox-label"},vu={class:"settings-item"},fu={class:"checkbox-label"},pu={class:"settings-group"},mu={class:"settings-item"},hu=Je({__name:"HqTranslationSettings",setup(t){const u=[{label:"SiliconFlow",value:"siliconflow"},{label:"DeepSeek",value:"deepseek"},{label:"火山引擎",value:"volcano"},{label:"Google Gemini",value:"gemini"},{label:"自定义 OpenAI 兼容服务",value:"custom_openai"}],l=[{label:"Gemini风格 (reasoning_effort=low)",value:"gemini"},{label:"火山引擎风格 (thinking=null)",value:"volcano"}],i=Qe(),n=X(()=>i.settings.hqTranslation),a=ct(),o=h(!1),S=h(!1),y=h([]),C=X(()=>{const E=[{label:"-- 选择模型 --",value:""}];return y.value.forEach(g=>E.push({label:g,value:g})),E});function b(){y.value=[],i.saveToStorage()}async function I(){S.value=!0;try{const E=await Ge.getModelInfo(n.value.provider,n.value.apiKey);E.models&&E.models.length>0?(y.value=E.models,a.success(`获取到 ${E.models.length} 个模型`)):a.warning("未获取到可用模型")}catch(E){const g=E instanceof Error?E.message:"获取模型列表失败";a.error(g)}finally{S.value=!1}}function R(){i.updateHqTranslation({prompt:Un}),a.success("已重置为默认提示词")}return(E,g)=>(P(),U("div",Lr,[e("div",Or,[g[20]||(g[20]=e("div",{class:"settings-group-title"},"高质量翻译服务配置",-1)),e("div",Ur,[e("div",zr,[g[15]||(g[15]=e("label",{for:"settingsHqTranslateProvider"},"服务商:",-1)),Te(Ne,{"model-value":n.value.provider,options:u,onChange:g[0]||(g[0]=d=>{n.value.provider=d,b()})},null,8,["model-value"])]),e("div",Vr,[g[16]||(g[16]=e("label",{for:"settingsHqApiKey"},"API Key:",-1)),e("div",Nr,[ie(e("input",{type:o.value?"text":"password",id:"settingsHqApiKey","onUpdate:modelValue":g[1]||(g[1]=d=>n.value.apiKey=d),class:"secure-input",placeholder:"请输入API Key",autocomplete:"off"},null,8,Wr),[[kt,n.value.apiKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:g[2]||(g[2]=d=>o.value=!o.value)},[o.value?(P(),U("span",qr,"👁‍🗨")):(P(),U("span",Kr,"👁"))])])])]),ie(e("div",Hr,[g[17]||(g[17]=e("label",{for:"settingsHqCustomBaseUrl"},"Base URL:",-1)),ie(e("input",{type:"text",id:"settingsHqCustomBaseUrl","onUpdate:modelValue":g[3]||(g[3]=d=>n.value.customBaseUrl=d),placeholder:"例如: https://api.example.com/v1"},null,512),[[Be,n.value.customBaseUrl]])],512),[[Ye,n.value.provider==="custom_openai"]]),e("div",Yr,[g[19]||(g[19]=e("label",{for:"settingsHqModelName"},"模型名称:",-1)),e("div",Xr,[ie(e("input",{type:"text",id:"settingsHqModelName","onUpdate:modelValue":g[4]||(g[4]=d=>n.value.modelName=d),placeholder:"请输入模型名称"},null,512),[[Be,n.value.modelName]]),e("button",{type:"button",class:"fetch-models-btn",title:"获取可用模型列表",onClick:I,disabled:S.value},[g[18]||(g[18]=e("span",{class:"fetch-icon"},"🔍",-1)),e("span",jr,pe(S.value?"获取中...":"获取模型"),1)],8,Jr)]),y.value.length>0?(P(),U("div",Gr,[Te(Ne,{"model-value":n.value.modelName,options:C.value,onChange:g[5]||(g[5]=d=>n.value.modelName=d)},null,8,["model-value","options"]),e("span",Zr,"共 "+pe(y.value.length)+" 个模型",1)])):we("",!0)])]),e("div",Qr,[g[28]||(g[28]=e("div",{class:"settings-group-title"},"批处理设置",-1)),e("div",eu,[e("div",tu,[g[21]||(g[21]=e("label",{for:"settingsHqBatchSize"},"批次大小:",-1)),ie(e("input",{type:"number",id:"settingsHqBatchSize","onUpdate:modelValue":g[6]||(g[6]=d=>n.value.batchSize=d),min:"1",max:"10",step:"1"},null,512),[[Be,n.value.batchSize,void 0,{number:!0}]]),g[22]||(g[22]=e("div",{class:"input-hint"},"每批处理的图片数量 (推荐3-5张)",-1))]),e("div",nu,[g[23]||(g[23]=e("label",{for:"settingsHqSessionReset"},"会话重置频率:",-1)),ie(e("input",{type:"number",id:"settingsHqSessionReset","onUpdate:modelValue":g[7]||(g[7]=d=>n.value.sessionReset=d),min:"1",step:"1"},null,512),[[Be,n.value.sessionReset,void 0,{number:!0}]]),g[24]||(g[24]=e("div",{class:"input-hint"},"多少批次后重置上下文",-1))])]),e("div",ou,[e("div",au,[g[25]||(g[25]=e("label",{for:"settingsHqRpmLimit"},"RPM限制:",-1)),ie(e("input",{type:"number",id:"settingsHqRpmLimit","onUpdate:modelValue":g[8]||(g[8]=d=>n.value.rpmLimit=d),min:"0",step:"1"},null,512),[[Be,n.value.rpmLimit,void 0,{number:!0}]]),g[26]||(g[26]=e("div",{class:"input-hint"},"每分钟请求数，0表示无限制",-1))]),e("div",su,[g[27]||(g[27]=e("label",{for:"settingsHqMaxRetries"},"重试次数:",-1)),ie(e("input",{type:"number",id:"settingsHqMaxRetries","onUpdate:modelValue":g[9]||(g[9]=d=>n.value.maxRetries=d),min:"0",max:"10",step:"1"},null,512),[[Be,n.value.maxRetries,void 0,{number:!0}]])])])]),e("div",lu,[g[36]||(g[36]=e("div",{class:"settings-group-title"},"高级选项",-1)),e("div",iu,[e("div",ru,[e("label",uu,[ie(e("input",{type:"checkbox","onUpdate:modelValue":g[10]||(g[10]=d=>n.value.lowReasoning=d)},null,512),[[Ze,n.value.lowReasoning]]),g[29]||(g[29]=Oe(" 低推理模式 ",-1))]),g[30]||(g[30]=e("div",{class:"input-hint"},"减少模型推理深度，提高速度",-1))]),e("div",cu,[g[31]||(g[31]=e("label",{for:"settingsHqNoThinkingMethod"},"取消思考方法:",-1)),Te(Ne,{"model-value":n.value.noThinkingMethod,options:l,onChange:g[11]||(g[11]=d=>n.value.noThinkingMethod=d)},null,8,["model-value"])])]),e("div",du,[e("div",gu,[e("label",bu,[ie(e("input",{type:"checkbox","onUpdate:modelValue":g[12]||(g[12]=d=>n.value.forceJsonOutput=d)},null,512),[[Ze,n.value.forceJsonOutput]]),g[32]||(g[32]=Oe(" 强制JSON输出 ",-1))]),g[33]||(g[33]=e("div",{class:"input-hint"},"使用 response_format: json_object",-1))]),e("div",vu,[e("label",fu,[ie(e("input",{type:"checkbox","onUpdate:modelValue":g[13]||(g[13]=d=>n.value.useStream=d)},null,512),[[Ze,n.value.useStream]]),g[34]||(g[34]=Oe(" 流式调用 ",-1))]),g[35]||(g[35]=e("div",{class:"input-hint"},"使用流式API调用",-1))])])]),e("div",pu,[g[37]||(g[37]=e("div",{class:"settings-group-title"},"高质量翻译提示词",-1)),e("div",mu,[ie(e("textarea",{id:"settingsHqPrompt","onUpdate:modelValue":g[14]||(g[14]=d=>n.value.prompt=d),rows:"6",placeholder:"高质量翻译提示词"},null,512),[[Be,n.value.prompt]]),e("button",{class:"btn btn-secondary btn-sm",onClick:R},"重置为默认")])])]))}}),yu=Xe(hu,[["__scopeId","data-v-3da44faa"]]),xu={class:"proofreading-settings"},ku={class:"settings-group"},Su={class:"settings-item"},Cu={class:"checkbox-label"},wu={class:"settings-item"},_u={class:"settings-group"},$u={class:"round-header"},Iu={class:"round-title"},Tu=["onClick","disabled"],Du={class:"round-content"},Ru={class:"settings-item"},Mu=["onUpdate:modelValue"],Bu={class:"settings-row"},Eu={class:"settings-item"},Pu={class:"settings-item"},Au={class:"password-input-wrapper"},Fu=["type","onUpdate:modelValue"],Lu=["onClick"],Ou={key:0,class:"eye-icon"},Uu={key:1,class:"eye-off-icon"},zu={class:"settings-item"},Vu=["onUpdate:modelValue"],Nu={class:"settings-item"},Wu=["onUpdate:modelValue"],Ku={class:"settings-row"},qu={class:"settings-item"},Hu=["onUpdate:modelValue"],Yu={class:"settings-item"},Xu=["onUpdate:modelValue"],Ju={class:"settings-item"},ju=["onUpdate:modelValue"],Gu={class:"settings-row"},Zu={class:"settings-item"},Qu={class:"checkbox-label"},ec=["onUpdate:modelValue"],tc={class:"settings-item"},nc={class:"settings-item"},oc={class:"checkbox-label"},ac=["onUpdate:modelValue"],sc={class:"settings-item"},lc=["onUpdate:modelValue"],ic=["onClick"],rc=Je({__name:"ProofreadingSettings",setup(t){const u=[{label:"SiliconFlow",value:"siliconflow"},{label:"DeepSeek",value:"deepseek"},{label:"火山引擎",value:"volcano"},{label:"Google Gemini",value:"gemini"},{label:"自定义 OpenAI 兼容服务",value:"custom_openai"}],l=[{label:"Gemini风格",value:"gemini"},{label:"火山引擎风格",value:"volcano"}],i=Qe(),n=ct(),a=X(()=>i.settings.proofreading.rounds),o=X({get:()=>i.settings.proofreading.maxRetries,set:I=>i.setProofreadingMaxRetries(I)}),S=X({get:()=>i.settings.proofreading.enabled,set:I=>i.setProofreadingEnabled(I)});function y(){const I={name:`第${a.value.length+1}轮校对`,provider:"siliconflow",apiKey:"",modelName:"",customBaseUrl:"",batchSize:3,sessionReset:20,rpmLimit:7,lowReasoning:!1,noThinkingMethod:"gemini",forceJsonOutput:!0,prompt:jt,showApiKey:!1};i.addProofreadingRound(I),n.success("已添加新的校对轮次")}function C(I){if(a.value.length<=1){n.warning("至少需要保留一个校对轮次");return}i.removeProofreadingRound(I),n.success("已删除校对轮次")}function b(I){i.updateProofreadingRound(I,{prompt:jt}),n.success("已重置为默认提示词")}return(I,R)=>(P(),U("div",xu,[e("div",ku,[R[5]||(R[5]=e("div",{class:"settings-group-title"},"AI校对设置",-1)),e("div",Su,[e("label",Cu,[ie(e("input",{type:"checkbox","onUpdate:modelValue":R[0]||(R[0]=E=>S.value=E)},null,512),[[Ze,S.value]]),R[2]||(R[2]=Oe(" 启用AI校对 ",-1))]),R[3]||(R[3]=e("div",{class:"input-hint"},"翻译完成后自动进行AI校对",-1))]),e("div",wu,[R[4]||(R[4]=e("label",{for:"settingsProofreadingMaxRetries"},"全局重试次数:",-1)),ie(e("input",{type:"number",id:"settingsProofreadingMaxRetries","onUpdate:modelValue":R[1]||(R[1]=E=>o.value=E),min:"0",max:"10",step:"1"},null,512),[[Be,o.value,void 0,{number:!0}]])])]),ie(e("div",_u,[e("div",{class:"settings-group-title"},[R[6]||(R[6]=Oe(" 校对轮次配置 ",-1)),e("button",{class:"btn btn-secondary btn-sm",onClick:y},"+ 添加轮次")]),(P(!0),U(Ke,null,je(a.value,(E,g)=>(P(),U("div",{key:g,class:"proofreading-round"},[e("div",$u,[e("span",Iu,"轮次 "+pe(g+1)+": "+pe(E.name||"未命名"),1),e("button",{class:"btn btn-danger btn-sm",onClick:d=>C(g),disabled:a.value.length<=1}," 删除 ",8,Tu)]),e("div",Du,[e("div",Ru,[R[7]||(R[7]=e("label",null,"轮次名称:",-1)),ie(e("input",{type:"text","onUpdate:modelValue":d=>E.name=d,placeholder:"如: 第一轮校对"},null,8,Mu),[[Be,E.name]])]),e("div",Bu,[e("div",Eu,[R[8]||(R[8]=e("label",null,"服务商:",-1)),Te(Ne,{modelValue:E.provider,"onUpdate:modelValue":d=>E.provider=d,options:u},null,8,["modelValue","onUpdate:modelValue"])]),e("div",Pu,[R[9]||(R[9]=e("label",null,"API Key:",-1)),e("div",Au,[ie(e("input",{type:E.showApiKey?"text":"password","onUpdate:modelValue":d=>E.apiKey=d,class:"secure-input",placeholder:"请输入API Key",autocomplete:"off"},null,8,Fu),[[kt,E.apiKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:d=>E.showApiKey=!E.showApiKey},[E.showApiKey?(P(),U("span",Uu,"👁‍🗨")):(P(),U("span",Ou,"👁"))],8,Lu)])])]),ie(e("div",zu,[R[10]||(R[10]=e("label",null,"Base URL:",-1)),ie(e("input",{type:"text","onUpdate:modelValue":d=>E.customBaseUrl=d,placeholder:"例如: https://api.example.com/v1"},null,8,Vu),[[Be,E.customBaseUrl]])],512),[[Ye,E.provider==="custom_openai"]]),e("div",Nu,[R[11]||(R[11]=e("label",null,"模型名称:",-1)),ie(e("input",{type:"text","onUpdate:modelValue":d=>E.modelName=d,placeholder:"请输入模型名称"},null,8,Wu),[[Be,E.modelName]])]),e("div",Ku,[e("div",qu,[R[12]||(R[12]=e("label",null,"批次大小:",-1)),ie(e("input",{type:"number","onUpdate:modelValue":d=>E.batchSize=d,min:"1",max:"10",step:"1"},null,8,Hu),[[Be,E.batchSize,void 0,{number:!0}]])]),e("div",Yu,[R[13]||(R[13]=e("label",null,"会话重置频率:",-1)),ie(e("input",{type:"number","onUpdate:modelValue":d=>E.sessionReset=d,min:"1",step:"1"},null,8,Xu),[[Be,E.sessionReset,void 0,{number:!0}]])]),e("div",Ju,[R[14]||(R[14]=e("label",null,"RPM限制:",-1)),ie(e("input",{type:"number","onUpdate:modelValue":d=>E.rpmLimit=d,min:"0",step:"1"},null,8,ju),[[Be,E.rpmLimit,void 0,{number:!0}]])])]),e("div",Gu,[e("div",Zu,[e("label",Qu,[ie(e("input",{type:"checkbox","onUpdate:modelValue":d=>E.lowReasoning=d},null,8,ec),[[Ze,E.lowReasoning]]),R[15]||(R[15]=Oe(" 低推理模式 ",-1))])]),e("div",tc,[R[16]||(R[16]=e("label",null,"取消思考方法:",-1)),Te(Ne,{modelValue:E.noThinkingMethod,"onUpdate:modelValue":d=>E.noThinkingMethod=d,options:l},null,8,["modelValue","onUpdate:modelValue"])]),e("div",nc,[e("label",oc,[ie(e("input",{type:"checkbox","onUpdate:modelValue":d=>E.forceJsonOutput=d},null,8,ac),[[Ze,E.forceJsonOutput]]),R[17]||(R[17]=Oe(" 强制JSON输出 ",-1))])])]),e("div",sc,[R[18]||(R[18]=e("label",null,"校对提示词:",-1)),ie(e("textarea",{"onUpdate:modelValue":d=>E.prompt=d,rows:"4",placeholder:"校对提示词"},null,8,lc),[[Be,E.prompt]]),e("button",{class:"btn btn-secondary btn-sm",onClick:d=>b(g)},"重置为默认",8,ic)])])]))),128))],512),[[Ye,S.value]])]))}}),uc=Xe(rc,[["__scopeId","data-v-b7e87a61"]]),cc={class:"prompt-library"},dc={class:"settings-group"},gc={class:"settings-item"},bc={key:0,class:"settings-item"},vc={class:"mode-hint"},fc={class:"settings-group"},pc={key:0,class:"loading-hint"},mc={key:1,class:"empty-hint"},hc={key:2,class:"prompt-list"},yc=["onClick"],xc={class:"prompt-actions"},kc=["onClick"],Sc=["onClick","disabled"],Cc={class:"settings-group"},wc={class:"settings-item"},_c={class:"settings-item"},$c={class:"prompt-editor-actions"},Ic=["disabled"],Tc=["disabled"],Dc=Je({__name:"PromptLibrary",setup(t){const u=[{label:"翻译提示词",value:"translate"},{label:"文本框提示词",value:"textbox"},{label:"AI视觉OCR提示词",value:"ai_vision_ocr"},{label:"高质量翻译提示词",value:"hq_translate"},{label:"校对提示词",value:"proofreading"}],l=[{label:"普通模式",value:!1},{label:"JSON格式模式",value:!0}],i=ct(),n=Qe(),a=h("translate"),o=h([]),S=h(""),y=h(""),C=h(""),b=h(!1),I=h(!1),R=X(()=>a.value==="translate"||a.value==="ai_vision_ocr"),E=X(()=>I.value?"适用于需要结构化输出的场景":"适用于普通翻译场景");function g(G,A=!1){switch(G){case"translate":return A?Xt:Jt;case"textbox":return"";case"ai_vision_ocr":return A?Ht:Yt;case"hq_translate":return Un;case"proofreading":return jt;default:return""}}async function d(){b.value=!0;try{let G;a.value==="textbox"?G=await Ge.getTextboxPrompts():G=await Ge.getPrompts(a.value),o.value=G.prompts||[]}catch(G){const A=G instanceof Error?G.message:"加载提示词列表失败";i.error(A)}finally{b.value=!1}}function Y(G){S.value=G,y.value=G}async function q(G){try{let A;a.value==="textbox"?A=await Ge.getTextboxPromptContent(G):A=await Ge.getPromptContent(a.value,G),y.value=G,C.value=A.content||"",S.value=G,i.success("已加载提示词")}catch(A){const c=A instanceof Error?A.message:"加载提示词内容失败";i.error(c)}}async function te(){if(!y.value||!C.value){i.warning("请输入提示词名称和内容");return}try{a.value==="textbox"?await Ge.saveTextboxPrompt(y.value,C.value):await Ge.savePrompt(a.value,y.value,C.value),i.success("提示词保存成功"),await d()}catch(G){const A=G instanceof Error?G.message:"保存提示词失败";i.error(A)}}async function M(G){if(G==="default"){i.warning("默认提示词不能删除");return}try{a.value==="textbox"?await Ge.deleteTextboxPrompt(G):await Ge.deletePrompt(a.value,G),i.success("提示词删除成功"),S.value===G&&(S.value="",y.value="",C.value=""),await d()}catch(A){const c=A instanceof Error?A.message:"删除提示词失败";i.error(c)}}function w(){C.value=g(a.value,I.value),i.success("已重置为默认提示词")}function Z(){S.value="",y.value="",C.value="",a.value==="translate"?I.value=n.settings.translation.isJsonMode:a.value==="ai_vision_ocr"?I.value=n.settings.aiVisionOcr.isJsonMode:I.value=!1,d()}function z(){if(a.value==="translate"){n.updateTranslationService({isJsonMode:I.value});const G=Jt,A=Xt;(!C.value||C.value===G||C.value===A)&&(C.value=g("translate",I.value))}else if(a.value==="ai_vision_ocr"){n.updateAiVisionOcr({isJsonMode:I.value});const G=Yt,A=Ht;(!C.value||C.value===G||C.value===A)&&(C.value=g("ai_vision_ocr",I.value))}i.info(`已切换到${I.value?"JSON格式":"普通"}模式`)}function re(){if(!C.value){i.warning("请输入提示词内容");return}switch(a.value){case"translate":n.setTranslatePrompt(C.value),i.success("翻译提示词已应用到设置");break;case"textbox":n.setTextboxPrompt(C.value),i.success("文本框提示词已应用到设置");break;case"ai_vision_ocr":n.updateAiVisionOcr({prompt:C.value}),i.success("AI视觉OCR提示词已应用到设置");break;case"hq_translate":n.updateHqTranslation({prompt:C.value}),i.success("高质量翻译提示词已应用到设置");break;case"proofreading":i.info("校对提示词请在校对轮次配置中设置");break;default:i.warning("未知的提示词类型")}}return We(a,()=>{}),rt(()=>{I.value=n.settings.translation.isJsonMode,d()}),(G,A)=>(P(),U("div",cc,[e("div",dc,[A[6]||(A[6]=e("div",{class:"settings-group-title"},"提示词管理",-1)),e("div",gc,[A[4]||(A[4]=e("label",{for:"promptType"},"提示词类型:",-1)),Te(Ne,{modelValue:a.value,"onUpdate:modelValue":A[0]||(A[0]=c=>a.value=c),options:u,onChange:Z},null,8,["modelValue"])]),R.value?(P(),U("div",bc,[A[5]||(A[5]=e("label",{for:"promptMode"},"提示词模式:",-1)),Te(Ne,{modelValue:I.value,"onUpdate:modelValue":A[1]||(A[1]=c=>I.value=c),options:l,onChange:z},null,8,["modelValue"]),e("span",vc,pe(E.value),1)])):we("",!0)]),e("div",fc,[A[7]||(A[7]=e("div",{class:"settings-group-title"},"已保存的提示词",-1)),b.value?(P(),U("div",pc,"加载中...")):o.value.length===0?(P(),U("div",mc,"暂无保存的提示词")):(P(),U("div",hc,[(P(!0),U(Ke,null,je(o.value,c=>(P(),U("div",{key:c.name,class:Le(["prompt-item",{active:S.value===c.name}])},[e("span",{class:"prompt-name",onClick:T=>Y(c.name)},pe(c.name),9,yc),e("div",xc,[e("button",{class:"btn btn-sm",onClick:T=>q(c.name),title:"加载到编辑器"},"📥",8,kc),e("button",{class:"btn btn-sm btn-danger",onClick:T=>M(c.name),title:"删除",disabled:c.name==="default"}," 🗑️ ",8,Sc)])],2))),128))]))]),e("div",Cc,[A[10]||(A[10]=e("div",{class:"settings-group-title"},"提示词编辑",-1)),e("div",wc,[A[8]||(A[8]=e("label",{for:"promptName"},"提示词名称:",-1)),ie(e("input",{type:"text",id:"promptName","onUpdate:modelValue":A[2]||(A[2]=c=>y.value=c),placeholder:"请输入提示词名称"},null,512),[[Be,y.value]])]),e("div",_c,[A[9]||(A[9]=e("label",{for:"promptContent"},"提示词内容:",-1)),ie(e("textarea",{id:"promptContent","onUpdate:modelValue":A[3]||(A[3]=c=>C.value=c),rows:"8",placeholder:"请输入提示词内容"},null,512),[[Be,C.value]])]),e("div",$c,[e("button",{class:"btn btn-secondary",onClick:w},"重置为默认"),e("button",{class:"btn btn-primary",onClick:re,disabled:!C.value},"应用到设置",8,Ic),e("button",{class:"btn btn-primary",onClick:te,disabled:!y.value||!C.value},"保存提示词",8,Tc)])])]))}}),Rc=Xe(Dc,[["__scopeId","data-v-303ea299"]]),Mc={class:"plugin-manager"},Bc={class:"settings-group"},Ec={key:0,class:"loading-hint"},Pc={key:1,class:"empty-hint"},Ac={key:2,class:"plugin-list"},Fc={class:"plugin-info"},Lc={class:"plugin-header"},Oc={class:"plugin-name"},Uc={class:"plugin-version"},zc={class:"plugin-description"},Vc={class:"plugin-controls"},Nc={class:"switch"},Wc=["checked","onChange"],Kc=["onClick"],qc=["onClick"],Hc={class:"settings-group"},Yc={class:"plugin-name"},Xc={class:"switch"},Jc=["checked","onChange"],jc={class:"plugin-config-content"},Gc={class:"plugin-config-header"},Zc={class:"plugin-config-body"},Qc=["for"],ed=["id","onUpdate:modelValue"],td=["id","onUpdate:modelValue","min","max"],nd=["id","onUpdate:modelValue","placeholder"],od={key:4,class:"field-description"},ad=Je({__name:"PluginManager",setup(t){const u=ct(),l=h([]),i=h({}),n=h(!1),a=h(!1),o=h(null),S=h({}),y=h({});async function C(){n.value=!0;try{const q=await Yo();l.value=q.plugins||[]}catch(q){const te=q instanceof Error?q.message:"加载插件列表失败";u.error(te)}finally{n.value=!1}}async function b(){try{const q=await na();i.value=q.states||{}}catch(q){console.error("加载默认状态失败:",q)}}async function I(q){try{q.enabled?(await Jo(q.name),q.enabled=!1,u.success(`已禁用 ${q.display_name||q.name}`)):(await Xo(q.name),q.enabled=!0,u.success(`已启用 ${q.display_name||q.name}`))}catch(te){const M=te instanceof Error?te.message:"操作失败";u.error(M)}}async function R(q,te){const M=te.target,w=M.checked;try{await oa(q,w),i.value[q]=w,u.success("默认状态已更新")}catch(Z){const z=Z instanceof Error?Z.message:"设置失败";u.error(z),M.checked=!w}}async function E(q){o.value=q;try{const te=await aa(q.name);S.value=te.schema||{};const M=await sa(q.name);y.value=M.config||{},a.value=!0}catch(te){const M=te instanceof Error?te.message:"加载配置失败";u.error(M)}}function g(){a.value=!1,o.value=null,S.value={},y.value={}}async function d(){if(o.value)try{await la(o.value.name,y.value),u.success("配置保存成功"),g()}catch(q){const te=q instanceof Error?q.message:"保存配置失败";u.error(te)}}async function Y(q){if(confirm(`确定要删除插件 "${q.display_name||q.name}" 吗？`))try{await jo(q.name),u.success("插件删除成功"),await C()}catch(te){const M=te instanceof Error?te.message:"删除插件失败";u.error(M)}}return rt(()=>{C(),b()}),(q,te)=>(P(),U("div",Mc,[e("div",Bc,[te[1]||(te[1]=e("div",{class:"settings-group-title"},"已安装插件",-1)),n.value?(P(),U("div",Ec,"加载中...")):l.value.length===0?(P(),U("div",Pc,"暂无已安装的插件")):(P(),U("div",Ac,[(P(!0),U(Ke,null,je(l.value,M=>(P(),U("div",{key:M.name,class:"plugin-item"},[e("div",Fc,[e("div",Lc,[e("span",Oc,pe(M.display_name||M.name),1),e("span",Uc,"v"+pe(M.version||"1.0.0"),1)]),e("p",zc,pe(M.description||"暂无描述"),1)]),e("div",Vc,[e("label",Nc,[e("input",{type:"checkbox",checked:M.enabled,onChange:w=>I(M)},null,40,Wc),te[0]||(te[0]=e("span",{class:"slider"},null,-1))]),M.has_config?(P(),U("button",{key:0,class:"btn btn-sm",onClick:w=>E(M),title:"配置"},"⚙️",8,Kc)):we("",!0),e("button",{class:"btn btn-sm btn-danger",onClick:w=>Y(M),title:"删除"},"🗑️",8,qc)])]))),128))]))]),e("div",Hc,[te[3]||(te[3]=e("div",{class:"settings-group-title"},"默认启用状态",-1)),te[4]||(te[4]=e("p",{class:"settings-hint"},"设置插件在新会话中的默认启用状态",-1)),(P(!0),U(Ke,null,je(l.value,M=>(P(),U("div",{key:"default-"+M.name,class:"default-state-item"},[e("span",Yc,pe(M.display_name||M.name),1),e("label",Xc,[e("input",{type:"checkbox",checked:i.value[M.name],onChange:w=>R(M.name,w)},null,40,Jc),te[2]||(te[2]=e("span",{class:"slider"},null,-1))])]))),128))]),a.value?(P(),U("div",{key:0,class:"plugin-config-modal",onClick:at(g,["self"])},[e("div",jc,[e("div",Gc,[e("h4",null,pe(o.value?.display_name||o.value?.name)+" 配置",1),e("span",{class:"close-btn",onClick:g},"×")]),e("div",Zc,[(P(!0),U(Ke,null,je(S.value,(M,w)=>(P(),U("div",{key:w,class:"config-field"},[e("label",{for:"config-"+w},pe(M.label||w)+":",9,Qc),M.type==="boolean"?ie((P(),U("input",{key:0,type:"checkbox",id:"config-"+w,"onUpdate:modelValue":Z=>y.value[w]=Z},null,8,ed)),[[Ze,y.value[w]]]):M.type==="select"?(P(),lt(Ne,{key:1,modelValue:y.value[w],"onUpdate:modelValue":Z=>y.value[w]=Z,options:M.options||[]},null,8,["modelValue","onUpdate:modelValue","options"])):M.type==="number"?ie((P(),U("input",{key:2,type:"number",id:"config-"+w,"onUpdate:modelValue":Z=>y.value[w]=Z,min:M.min,max:M.max},null,8,td)),[[Be,y.value[w],void 0,{number:!0}]]):ie((P(),U("input",{key:3,type:"text",id:"config-"+w,"onUpdate:modelValue":Z=>y.value[w]=Z,placeholder:M.placeholder},null,8,nd)),[[Be,y.value[w]]]),M.description?(P(),U("p",od,pe(M.description),1)):we("",!0)]))),128))]),e("div",{class:"plugin-config-footer"},[e("button",{class:"btn btn-secondary",onClick:g},"取消"),e("button",{class:"btn btn-primary",onClick:d},"保存")])])])):we("",!0)]))}}),sd=Xe(ad,[["__scopeId","data-v-85a9b55f"]]),ld={class:"more-settings"},id={class:"settings-group"},rd={class:"settings-item"},ud={class:"settings-group"},cd={class:"settings-item"},dd=["disabled"],gd={key:0,class:"font-count"},bd={class:"settings-item"},vd={class:"settings-group"},fd={class:"settings-item"},pd={class:"checkbox-label"},md={class:"settings-group"},hd={class:"settings-item"},yd={class:"settings-item"},xd={class:"settings-item"},kd={class:"settings-group"},Sd={class:"settings-row"},Cd={class:"settings-item"},wd=["disabled"],_d={class:"settings-item"},$d=["disabled"],Id=Je({__name:"MoreSettings",setup(t){const u=[{label:"前端 pdf.js (推荐)",value:"frontend"},{label:"后端 PyMuPDF",value:"backend"}],l=Qe();X(()=>l);const i=ct(),n=h(!1),a=h([]),o=h(!1),S=h(null),y=h({showDetectionDebug:l.settings.showDetectionDebug||!1,translationMaxRetries:l.settings.translation?.maxRetries||2,hqTranslationMaxRetries:l.settings.hqTranslation?.maxRetries||2,proofreadingMaxRetries:l.settings.proofreading?.maxRetries||2});function C(){l.setShowDetectionDebug(y.value.showDetectionDebug),l.settings.translation&&(l.settings.translation.maxRetries=y.value.translationMaxRetries),l.settings.hqTranslation&&(l.settings.hqTranslation.maxRetries=y.value.hqTranslationMaxRetries),l.setProofreadingMaxRetries(y.value.proofreadingMaxRetries)}async function b(){n.value=!0;try{const g=await Ge.getFontList();a.value=g.fonts||[],i.success(`获取到 ${a.value.length} 个字体`)}catch(g){const d=g instanceof Error?g.message:"获取字体列表失败";i.error(d)}finally{n.value=!1}}async function I(g){const Y=g.target.files?.[0];if(!Y)return;const q=[".ttf",".ttc",".otf"],te=Y.name.toLowerCase().slice(Y.name.lastIndexOf("."));if(!q.includes(te)){i.error("不支持的字体格式，请上传 .ttf, .ttc 或 .otf 文件");return}try{const M=await Ge.uploadFont(Y);M.success?(i.success(`字体 "${M.fontPath||Y.name}" 上传成功`),await b()):i.error(M.error||"字体上传失败")}catch(M){const w=M instanceof Error?M.message:"字体上传失败";i.error(w)}finally{S.value&&(S.value.value="")}}async function R(){o.value=!0;try{const g=await Vn();g.success?i.success(`已清理 ${g.deleted_count||0} 个调试文件`):i.error(g.error||"清理失败")}catch(g){const d=g instanceof Error?g.message:"清理失败";i.error(d)}finally{o.value=!1}}async function E(){o.value=!0;try{const g=await rn();g.success?i.success(`已清理 ${g.deleted_count||0} 个临时文件`):i.error(g.error||"清理失败")}catch(g){const d=g instanceof Error?g.message:"清理失败";i.error(d)}finally{o.value=!1}}return(g,d)=>(P(),U("div",ld,[e("div",id,[d[7]||(d[7]=e("div",{class:"settings-group-title"},"PDF处理设置",-1)),e("div",rd,[d[5]||(d[5]=e("label",{for:"settingsPdfProcessingMethod"},"PDF处理方式:",-1)),Te(Ne,{modelValue:ce(l).settings.pdfProcessingMethod,"onUpdate:modelValue":d[0]||(d[0]=Y=>ce(l).settings.pdfProcessingMethod=Y),options:u},null,8,["modelValue"]),d[6]||(d[6]=e("div",{class:"input-hint"},"前端处理速度更快，后端处理兼容性更好",-1))])]),e("div",ud,[d[11]||(d[11]=e("div",{class:"settings-group-title"},"字体设置",-1)),e("div",cd,[d[8]||(d[8]=e("label",null,"系统字体列表:",-1)),e("button",{class:"btn btn-secondary",onClick:b,disabled:n.value},pe(n.value?"加载中...":"🔄 刷新字体列表"),9,dd),a.value.length>0?(P(),U("div",gd,"共 "+pe(a.value.length)+" 个字体",1)):we("",!0)]),e("div",bd,[d[9]||(d[9]=e("label",null,"上传自定义字体:",-1)),e("input",{type:"file",accept:".ttf,.ttc,.otf",onChange:I,ref_key:"fontInput",ref:S},null,544),d[10]||(d[10]=e("div",{class:"input-hint"},"支持 .ttf, .ttc, .otf 格式",-1))])]),e("div",vd,[d[14]||(d[14]=e("div",{class:"settings-group-title"},"调试选项",-1)),e("div",fd,[e("label",pd,[ie(e("input",{type:"checkbox","onUpdate:modelValue":d[1]||(d[1]=Y=>y.value.showDetectionDebug=Y),onChange:C},null,544),[[Ze,y.value.showDetectionDebug]]),d[12]||(d[12]=Oe(" 显示检测框调试信息 ",-1))]),d[13]||(d[13]=e("div",{class:"input-hint"},"开启后会在翻译结果中显示气泡检测框",-1))])]),e("div",md,[d[21]||(d[21]=e("div",{class:"settings-group-title"},"重试次数配置",-1)),e("div",hd,[d[15]||(d[15]=e("label",{for:"settingsTranslationMaxRetries"},"普通翻译重试次数:",-1)),ie(e("input",{type:"number",id:"settingsTranslationMaxRetries","onUpdate:modelValue":d[2]||(d[2]=Y=>y.value.translationMaxRetries=Y),min:"0",max:"10",onChange:C},null,544),[[Be,y.value.translationMaxRetries,void 0,{number:!0}]]),d[16]||(d[16]=e("div",{class:"input-hint"},"翻译失败时的最大重试次数（0-10）",-1))]),e("div",yd,[d[17]||(d[17]=e("label",{for:"settingsHqTranslationMaxRetries"},"高质量翻译重试次数:",-1)),ie(e("input",{type:"number",id:"settingsHqTranslationMaxRetries","onUpdate:modelValue":d[3]||(d[3]=Y=>y.value.hqTranslationMaxRetries=Y),min:"0",max:"10",onChange:C},null,544),[[Be,y.value.hqTranslationMaxRetries,void 0,{number:!0}]]),d[18]||(d[18]=e("div",{class:"input-hint"},"高质量翻译失败时的最大重试次数（0-10）",-1))]),e("div",xd,[d[19]||(d[19]=e("label",{for:"settingsProofreadingMaxRetries"},"AI校对重试次数:",-1)),ie(e("input",{type:"number",id:"settingsProofreadingMaxRetries","onUpdate:modelValue":d[4]||(d[4]=Y=>y.value.proofreadingMaxRetries=Y),min:"0",max:"10",onChange:C},null,544),[[Be,y.value.proofreadingMaxRetries,void 0,{number:!0}]]),d[20]||(d[20]=e("div",{class:"input-hint"},"AI校对失败时的最大重试次数（0-10）",-1))])]),e("div",kd,[d[24]||(d[24]=e("div",{class:"settings-group-title"},"缓存清理",-1)),e("div",Sd,[e("div",Cd,[e("button",{class:"btn btn-secondary",onClick:R,disabled:o.value},pe(o.value?"清理中...":"🗑️ 清理调试文件"),9,wd),d[22]||(d[22]=e("div",{class:"input-hint"},"清理调试过程中生成的临时文件",-1))]),e("div",_d,[e("button",{class:"btn btn-secondary",onClick:E,disabled:o.value},pe(o.value?"清理中...":"🗑️ 清理临时文件"),9,$d),d[23]||(d[23]=e("div",{class:"input-hint"},"清理下载和处理过程中的临时文件",-1))])])]),d[25]||(d[25]=Zt('<div class="settings-group" data-v-6650a4d5><div class="settings-group-title" data-v-6650a4d5>关于</div><div class="about-info" data-v-6650a4d5><p data-v-6650a4d5><strong data-v-6650a4d5>Saber-Translator</strong></p><p data-v-6650a4d5>AI驱动的漫画翻译工具</p><p class="links" data-v-6650a4d5><a href="http://www.mashirosaber.top" target="_blank" data-v-6650a4d5>📖 使用教程</a><a href="https://github.com/MashiroSaber/saber-translator" target="_blank" data-v-6650a4d5>🐙 GitHub</a></p><p class="disclaimer" data-v-6650a4d5>本项目完全开源免费，请勿上当受骗</p></div></div>',1))]))}}),Td=Xe(Id,[["__scopeId","data-v-6650a4d5"]]),Dd={class:"settings-modal-content"},Rd={class:"settings-tabs"},Md=["onClick"],Bd={class:"settings-tab-content"},Ed={class:"settings-tab-pane active"},Pd={class:"settings-tab-pane"},Ad={class:"settings-tab-pane"},Fd={class:"settings-tab-pane"},Ld={class:"settings-tab-pane"},Od={class:"settings-tab-pane"},Ud={class:"settings-tab-pane"},zd={class:"settings-tab-pane"},Vd=Je({__name:"SettingsModal",props:{modelValue:{type:Boolean}},emits:["update:modelValue","save"],setup(t,{emit:u}){const l=t,i=u,n=Qe(),a=h(l.modelValue),o=h("ocr"),S=[{id:"ocr",label:"OCR识别"},{id:"translate",label:"翻译服务"},{id:"detection",label:"检测设置"},{id:"hq",label:"高质量翻译"},{id:"proofreading",label:"AI校对"},{id:"prompt-library",label:"提示词管理"},{id:"plugins",label:"插件管理"},{id:"more",label:"更多"}];We(()=>l.modelValue,I=>{a.value=I,I?document.body.style.overflow="hidden":document.body.style.overflow=""});function y(){a.value=!1,i("update:modelValue",!1),document.body.style.overflow=""}async function C(){n.saveToStorage();try{await n.saveToBackend(),console.log("[SettingsModal] 设置已保存到后端")}catch(I){console.warn("[SettingsModal] 保存到后端失败，仅保存到 localStorage:",I)}i("save"),y()}function b(I){I.key==="Escape"&&a.value&&y()}return rt(()=>{document.addEventListener("keydown",b)}),St(()=>{document.removeEventListener("keydown",b),document.body.style.overflow=""}),(I,R)=>a.value?(P(),U("div",{key:0,class:"settings-modal",onClick:at(y,["self"])},[e("div",Dd,[e("div",{class:"settings-modal-header"},[R[0]||(R[0]=e("h3",null,"⚙️ 设置",-1)),e("span",{class:"settings-modal-close",onClick:y},"×")]),e("div",Rd,[(P(),U(Ke,null,je(S,E=>e("button",{key:E.id,class:Le(["settings-tab",{active:o.value===E.id}]),onClick:g=>o.value=E.id},pe(E.label),11,Md)),64))]),e("div",Bd,[ie(e("div",Ed,[Te(xi)],512),[[Ye,o.value==="ocr"]]),ie(e("div",Pd,[Te(gr)],512),[[Ye,o.value==="translate"]]),ie(e("div",Ad,[Te(Fr)],512),[[Ye,o.value==="detection"]]),ie(e("div",Fd,[Te(yu)],512),[[Ye,o.value==="hq"]]),ie(e("div",Ld,[Te(uc)],512),[[Ye,o.value==="proofreading"]]),ie(e("div",Od,[Te(Rc)],512),[[Ye,o.value==="prompt-library"]]),ie(e("div",Ud,[Te(sd)],512),[[Ye,o.value==="plugins"]]),ie(e("div",zd,[Te(Td)],512),[[Ye,o.value==="more"]])]),e("div",{class:"settings-modal-footer"},[e("button",{class:"btn btn-secondary",onClick:y},"取消"),e("button",{class:"btn btn-primary",onClick:C},"保存设置")])])])):we("",!0)}}),Nd=Xe(Vd,[["__scopeId","data-v-8f9d31e6"]]),Wd={minScale:.1,maxScale:5,zoomSpeed:.1};function Kd(t={}){const u={...Wd,...t},l=h(1),i=h(0),n=h(0),a=h(!1),o=h(0),S=h(0),y=X(()=>({transform:`translate(${i.value}px, ${n.value}px) scale(${l.value})`}));function C(c,T,ne){const m=Math.min(Math.max(l.value*ne,u.minScale),u.maxScale),V=m/l.value;i.value=c-(c-i.value)*V,n.value=T-(T-n.value)*V,l.value=m,t.onScaleChange?.(l.value),t.onTransformChange?.(z())}function b(c,T=800,ne=600){C(T/2,ne/2,c)}function I(){b(1.2)}function R(){b(.8)}function E(c,T=800,ne=600){const m=c/l.value;C(T/2,ne/2,m)}function g(c,T){a.value=!0,o.value=c,S.value=T}function d(c,T){if(!a.value)return;const ne=c-o.value,m=T-S.value;i.value+=ne,n.value+=m,o.value=c,S.value=T,t.onTransformChange?.(z())}function Y(){a.value=!1}function q(c,T){i.value+=c,n.value+=T,t.onTransformChange?.(z())}function te(){l.value=1,i.value=0,n.value=0,t.onScaleChange?.(l.value),t.onTransformChange?.(z())}function M(){te()}function w(){l.value=1,i.value=0,n.value=0}function Z(c,T,ne,m){if(!c||!T)return;const V=ne/c,J=m/T;l.value=Math.min(V,J)*.95,i.value=(ne-c*l.value)/2,n.value=(m-T*l.value)/2,t.onScaleChange?.(l.value),t.onTransformChange?.(z())}function z(){return{scale:l.value,translateX:i.value,translateY:n.value}}function re(c){c.scale!==void 0&&(l.value=c.scale),c.translateX!==void 0&&(i.value=c.translateX),c.translateY!==void 0&&(n.value=c.translateY),t.onTransformChange?.(z())}function G(c){l.value=c.scale,i.value=c.translateX,n.value=c.translateY}function A(c,T,ne){if(!c||c.length<4)return;const[m,V,J,le]=c,s=(m+J)/2,p=(V+le)/2,x=T/2,oe=ne/2;i.value=x-s*l.value,n.value=oe-p*l.value,t.onTransformChange?.(z())}return{scale:l,translateX:i,translateY:n,isDragging:a,transformStyle:y,zoomAt:C,zoom:b,zoomIn:I,zoomOut:R,setScale:E,startDrag:g,drag:d,endDrag:Y,pan:q,reset:te,resetZoom:M,resetTransform:w,fitToScreen:Z,getTransform:z,setTransform:re,syncWith:G,scrollToBubble:A}}function qd(t){const u=ot(),l=Qe(),i=h(null),n=h(wo),a=h(!1),o=h(!1),S=h([]),y=h(0),C=h(0);let b=null,I=null,R=null;const E=X(()=>i.value!==null),g=X(()=>i.value==="repair"?{fill:"rgba(76, 175, 80, 0.4)",border:"#4CAF50"}:i.value==="restore"?{fill:"rgba(33, 150, 243, 0.4)",border:"#2196F3"}:{fill:"transparent",border:"transparent"});function d(s){i.value!==s&&(i.value=s,a.value=!0,S.value=[],console.log(`进入${s==="repair"?"修复":"还原"}笔刷模式，笔刷大小: ${n.value}px`))}function Y(){o.value&&re();const s=i.value!==null;i.value=null,a.value=!1,o.value=!1,S.value=[],T(),s&&console.log("退出笔刷模式")}function q(s){i.value===s?Y():d(s)}function te(s){n.value=Math.max(Tn,Math.min(In,s))}function M(s){te(n.value+s)}function w(s){if(!E.value)return;s.preventDefault(),s.stopPropagation();const p=s.deltaY>0?-5:5;M(p)}function Z(s,p){if(!E.value||s.button!==0)return;s.preventDefault(),s.stopPropagation(),o.value=!0,b=p,S.value=[];const x=G(s,p);x&&(S.value.push(x),c(p),ne(x)),console.log("开始笔刷涂抹")}function z(s){if(y.value=s.clientX,C.value=s.clientY,!o.value||!E.value)return;const p=G(s,b);p&&(S.value.push(p),ne(p))}function re(){if(!o.value)return;o.value=!1;const s=u.currentImage;if(!s||S.value.length===0){T(),S.value=[];return}const p=A();if(!p){T(),S.value=[];return}const x=i.value;(async()=>{x==="restore"?await m(s,p):x==="repair"&&await V(s,p),t?.onBrushComplete?.()})(),T(),S.value=[]}function G(s,p){if(!p)return null;const x=p.querySelector(".image-canvas-wrapper"),oe=x?.querySelector("img");if(!oe||!oe.naturalWidth)return null;const me=x.getBoundingClientRect(),ue=window.getComputedStyle(x).transform;let Se=1;ue&&ue!=="none"&&(Se=new DOMMatrix(ue).a);const K=(s.clientX-me.left)/Se,k=(s.clientY-me.top)/Se,de=oe.naturalWidth,H=oe.naturalHeight;return K<0||k<0||K>de||k>H?null:{x:K,y:k,scale:Se}}function A(){if(S.value.length===0)return null;const p=S.value[0]?.scale||1,x=n.value/2/p;let oe=1/0,me=1/0,ue=-1/0,Se=-1/0;for(const K of S.value)oe=Math.min(oe,K.x-x),me=Math.min(me,K.y-x),ue=Math.max(ue,K.x+x),Se=Math.max(Se,K.y+x);return{x1:Math.max(0,Math.floor(oe)),y1:Math.max(0,Math.floor(me)),x2:Math.ceil(ue),y2:Math.ceil(Se),path:[...S.value],radius:x}}function c(s){T();const p=s.querySelector(".image-canvas-wrapper"),x=p?.querySelector("img");if(!x)return;const oe=document.createElement("canvas");oe.id="brushOverlayCanvas",oe.width=x.naturalWidth,oe.height=x.naturalHeight,oe.style.cssText="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100;",p.appendChild(oe),I=oe,R=oe.getContext("2d")}function T(){I&&I.parentNode&&I.parentNode.removeChild(I),I=null,R=null}function ne(s){if(!R||!s)return;const p=g.value.fill,x=n.value/2/(s.scale||1);R.beginPath(),R.arc(s.x,s.y,x,0,Math.PI*2),R.fillStyle=p,R.fill()}async function m(s,p){if(!s.originalDataURL)return;let x;return s.cleanImageData?x="data:image/png;base64,"+s.cleanImageData:x=s.originalDataURL,new Promise(oe=>{const me=new Image,ue=new Image;let Se=0;const K=()=>{if(Se++,Se<2)return;const k=document.createElement("canvas");k.width=me.naturalWidth,k.height=me.naturalHeight;const de=k.getContext("2d");if(!de){oe();return}de.drawImage(me,0,0);const H=document.createElement("canvas");H.width=k.width,H.height=k.height;const _=H.getContext("2d");if(!_){oe();return}_.fillStyle="white";for(const $ of p.path)_.beginPath(),_.arc($.x,$.y,p.radius,0,Math.PI*2),_.fill();de.globalCompositeOperation="destination-out",de.drawImage(H,0,0),de.globalCompositeOperation="destination-over",de.drawImage(ue,0,0),de.globalCompositeOperation="source-over";const D=k.toDataURL("image/png").split(",")[1];u.updateCurrentImage({cleanImageData:D}),console.log("还原笔刷区域完成"),oe()};me.onload=K,me.onerror=()=>oe(),ue.onload=K,ue.onerror=()=>oe(),me.src=x,ue.src=s.originalDataURL})}async function V(s,p){const x=l.settings.textStyle.inpaintMethod||"solid";x==="lama_mpe"||x==="litelama"?(console.log("LAMA 修复暂未实现，使用纯色填充"),await J(s,p)):await J(s,p)}async function J(s,p){const x=l.settings.textStyle.fillColor||"#FFFFFF";let oe;if(s.cleanImageData)oe="data:image/png;base64,"+s.cleanImageData;else if(s.originalDataURL)oe=s.originalDataURL;else return;return new Promise(me=>{const ue=new Image;ue.onload=()=>{const Se=document.createElement("canvas");Se.width=ue.naturalWidth,Se.height=ue.naturalHeight;const K=Se.getContext("2d");if(!K){me();return}K.drawImage(ue,0,0),K.fillStyle=x;for(const de of p.path)K.beginPath(),K.arc(de.x,de.y,p.radius,0,Math.PI*2),K.fill();const k=Se.toDataURL("image/png").split(",")[1];u.updateCurrentImage({cleanImageData:k}),console.log("修复笔刷区域完成（纯色填充）"),me()},ue.onerror=()=>me(),ue.src=oe})}async function le(){const s=u.currentImage;if(!s)return console.warn("ensureCleanBackground: 没有当前图片"),!1;if(s.cleanImageData)return console.log("ensureCleanBackground: 已有干净背景"),!0;if(l.settings.textStyle.inpaintMethod!=="solid")return console.log("ensureCleanBackground: 非纯色填充模式，跳过"),!1;if(!s.bubbleStates||s.bubbleStates.length===0)return console.warn("ensureCleanBackground: 没有气泡数据"),!1;if(!s.translatedDataURL&&!s.originalDataURL)return console.warn("ensureCleanBackground: 没有图片数据"),!1;console.log("ensureCleanBackground: 尝试为纯色填充模式创建临时干净背景");const x=s.translatedDataURL||s.originalDataURL,oe=l.settings.textStyle.fillColor||"#FFFFFF";return new Promise(me=>{const ue=new Image;ue.onload=()=>{try{const Se=document.createElement("canvas");Se.width=ue.naturalWidth,Se.height=ue.naturalHeight;const K=Se.getContext("2d");if(!K){console.error("ensureCleanBackground: 无法获取 Canvas 上下文"),me(!1);return}K.drawImage(ue,0,0),K.fillStyle=oe;for(const de of s.bubbleStates){const[H,_,D,$]=de.coords;K.fillRect(H,_,D-H+1,$-_+1)}const k=Se.toDataURL("image/png").split(",")[1];u.updateCurrentImage({cleanImageData:k}),console.log("ensureCleanBackground: 成功创建临时干净背景（纯色填充）"),me(!0)}catch(Se){console.error("ensureCleanBackground: Canvas 操作失败:",Se),me(!1)}},ue.onerror=()=>{console.error("ensureCleanBackground: 加载图像失败"),me(!1)},ue.src=x})}return St(()=>{Y()}),{brushMode:i,brushSize:n,isBrushKeyDown:a,isBrushPainting:o,mouseX:y,mouseY:C,isActive:E,brushColor:g,BRUSH_MIN_SIZE:Tn,BRUSH_MAX_SIZE:In,enterBrushMode:d,exitBrushMode:Y,toggleBrushMode:q,setBrushSize:te,adjustBrushSize:M,handleBrushWheel:w,startBrushPainting:Z,continueBrushPainting:z,finishBrushPainting:re,getBrushPositionInImage:G,getBrushPathBounds:A,ensureCleanBackground:le}}function Hd(t){const u=dt(),l=ot(),i=Qe(),{bubbles:n,selectedIndex:a,hasSelection:o}=yt(u),{currentImage:S}=yt(l),y=h(!1),C=h(!1),b=h(null),I=h(0),R=h(0),E=h(!1);function g(H){u.selectBubble(H)}function d(H){u.toggleMultiSelect(H)}function Y(){u.clearMultiSelect()}function q(H,_){console.log(`开始拖动气泡 #${H+1}`)}function te(H,_){}function M(H,_){u.updateBubble(H,{coords:_}),console.log(`气泡 #${H+1} 拖动完成:`,_),oe()}function w(H,_,D){console.log(`开始调整气泡 #${H+1} 大小，手柄: ${_}`)}function Z(H){const _=a.value;_>=0&&u.updateBubble(_,{coords:H})}function z(H,_){u.updateBubble(H,{coords:_}),console.log(`气泡 #${H+1} 调整大小完成:`,_),oe()}function re(H,_){console.log(`开始旋转气泡 #${H+1}`)}function G(H){const _=a.value;_>=0&&u.updateBubble(_,{rotationAngle:H})}function A(H,_){u.updateBubble(H,{rotationAngle:_}),console.log(`气泡 #${H+1} 旋转完成: ${_}°`),oe()}function c(){y.value=!y.value,y.value?console.log("进入绘制模式"):console.log("退出绘制模式")}function T(H){u.addBubble(H),u.selectBubble(u.bubbleCount-1),console.log("已添加新气泡:",H),t?.onReRender?.()}function ne(H,_){C.value=!0,I.value=H,R.value=_,b.value=[H,_,H,_]}function m(H,_){C.value&&(b.value=[I.value,R.value,H,_])}function V(){if(!C.value||!b.value)return C.value=!1,b.value=null,null;const[H,_,D,$]=b.value,r=10;if(Math.abs(D-H)<r||Math.abs($-_)<r)return C.value=!1,b.value=null,null;const v=[Math.min(H,D),Math.min(_,$),Math.max(H,D),Math.max(_,$)];return C.value=!1,b.value=null,v}function J(){C.value=!1,b.value=null,y.value=!1}function le(){if(!b.value)return{};const[H,_,D,$]=b.value;return{position:"absolute",left:`${Math.min(H,D)}px`,top:`${Math.min(_,$)}px`,width:`${Math.abs(D-H)}px`,height:`${Math.abs($-_)}px`,border:"2px dashed #00d4ff",background:"rgba(0, 212, 255, 0.1)",pointerEvents:"none",zIndex:"25",boxSizing:"border-box"}}let s=null,p=!1;const x=150;function oe(){s&&clearTimeout(s),s=setTimeout(()=>{if(p){console.log("跳过渲染，上一次渲染仍在进行中");return}console.log("触发延迟渲染预览"),p=!0,t?.onDelayedPreview?t.onDelayedPreview():t?.onReRender&&t.onReRender(),setTimeout(()=>{p=!1},100)},x)}function me(H){u.updateSelectedBubble(H),oe()}function ue(){o.value&&(u.deleteSelected(),console.log("已删除选中的气泡"),t?.onReRender?.())}async function Se(){const H=a.value;if(H<0){console.warn("请先选中要修复的气泡框");return}const _=n.value[H],D=S.value;if(!_||!D?.originalDataURL){console.warn("无法修复背景：缺少气泡或图片数据");return}const $=_.inpaintMethod||"solid",r=_.fillColor||"#FFFFFF",v=_.rotationAngle||0;try{console.log(`开始修复气泡 #${H+1} 背景，方法: ${$}`);let W;if(D.cleanImageData)W=D.cleanImageData;else{const N=D.originalDataURL.match(/^data:image\/[^;]+;base64,(.+)$/);if(W=N&&N[1]?N[1]:"",!W){console.error("无法解析图像数据");return}}if($==="lama_mpe"||$==="litelama"){const N=await tn(W,_.coords,D.cleanImageData??void 0);N.success&&N.inpainted_image?(l.updateCurrentImage({cleanImageData:N.inpainted_image}),console.log(`气泡 #${H+1} LAMA背景修复成功`),oe()):(console.error("LAMA修复失败:",N.error||"未知错误"),await K(_.coords,r,v),oe())}else await K(_.coords,r,v),console.log(`气泡 #${H+1} 纯色填充修复成功`),oe()}catch(W){console.error("背景修复出错:",W)}}async function K(H,_,D=0){const $=S.value;if(!$)return;const[r,v,W,ge]=H;let N;if($.cleanImageData)N="data:image/png;base64,"+$.cleanImageData;else if($.originalDataURL)N=$.originalDataURL;else{console.error("无法找到基础图像用于填充");return}return new Promise(O=>{const f=new Image;f.onload=()=>{const B=document.createElement("canvas");B.width=f.naturalWidth,B.height=f.naturalHeight;const j=B.getContext("2d");if(!j){O();return}if(j.drawImage(f,0,0),j.fillStyle=_,Math.abs(D)<.1)j.fillRect(r,v,W-r,ge-v);else{const be=(r+W)/2,F=(v+ge)/2,ae=(W-r)/2,ve=(ge-v)/2,se=D*Math.PI/180,Pe=Math.cos(se),Ee=Math.sin(se),Ce=[[-ae,-ve],[ae,-ve],[ae,ve],[-ae,ve]].map(([ke,he])=>[be+ke*Pe-he*Ee,F+ke*Ee+he*Pe]);j.beginPath(),j.moveTo(Ce[0][0],Ce[0][1]);for(let ke=1;ke<Ce.length;ke++)j.lineTo(Ce[ke][0],Ce[ke][1]);j.closePath(),j.fill()}const ee=B.toDataURL("image/png").split(",")[1];l.updateCurrentImage({cleanImageData:ee}),console.log("已对气泡区域进行纯色填充:",H,_,"角度:",D),O()},f.onerror=()=>{console.error("加载基础图像失败"),O()},f.src=N})}async function k(H){const _=n.value[H],D=S.value;if(!_||!D?.originalDataURL){console.warn("无法进行 OCR 识别：缺少气泡或图片数据");return}try{console.log(`开始 OCR 识别气泡 #${H+1}`);const $=D.originalDataURL.split(",")[1],r=i.settings,v=await qn($,_.coords,r.ocrEngine||"manga_ocr",{source_language:r.sourceLanguage,baidu_ocr_api_key:r.baiduOcr.apiKey,baidu_ocr_secret_key:r.baiduOcr.secretKey,ai_vision_provider:r.aiVisionOcr.provider,ai_vision_api_key:r.aiVisionOcr.apiKey,ai_vision_model_name:r.aiVisionOcr.modelName,ai_vision_ocr_prompt:r.aiVisionOcr.prompt});v.success&&v.text!==void 0?(u.updateBubble(H,{originalText:v.text}),console.log(`OCR 识别成功: "${v.text}"`)):console.error("OCR 识别失败:",v.error||"未知错误")}catch($){console.error("OCR 识别出错:",$)}}async function de(H){const _=n.value[H],D=S.value;if(!_||!D?.originalDataURL){console.warn("无法修复背景：缺少气泡或图片数据");return}try{console.log(`开始修复气泡 #${H+1} 背景`);const $=D.originalDataURL.split(",")[1],r=await tn($,_.coords,D.cleanImageData||void 0);r.success&&r.inpainted_image?(l.updateCurrentImage({cleanImageData:r.inpainted_image}),console.log("背景修复成功"),t?.onReRender?.()):console.error("背景修复失败:",r.error||"未知错误")}catch($){console.error("背景修复出错:",$)}}return{isDrawingMode:y,isDrawingBox:C,currentDrawingRect:b,isMiddleButtonDown:E,handleBubbleSelect:g,handleBubbleMultiSelect:d,handleClearMultiSelect:Y,handleBubbleDragStart:q,handleBubbleDragging:te,handleBubbleDragEnd:M,handleBubbleResizeStart:w,handleBubbleResizing:Z,handleBubbleResizeEnd:z,handleBubbleRotateStart:re,handleBubbleRotating:G,handleBubbleRotateEnd:A,toggleDrawingMode:c,handleDrawBubble:T,startDrawingBox:ne,updateDrawingBox:m,finishDrawingBox:V,cancelDrawing:J,getDrawingRectStyle:le,handleBubbleUpdate:me,deleteSelectedBubbles:ue,repairSelectedBubble:Se,triggerDelayedPreview:oe,handleOcrRecognize:k,handleInpaintBubble:de}}function Yd(t){const u=dt(),l=ot(),{bubbles:i}=yt(u),{currentImage:n}=yt(l),a=h(!1),o=h("");let S=null;function y(){const I=n.value;if(!I)return null;if(I.cleanImageData)return I.cleanImageData;if(I.originalDataURL){const R=I.originalDataURL.match(/^data:image\/[^;]+;base64,(.+)$/);if(R&&R[1])return R[1]}return null}async function C(I=!1){if(!n.value)return console.warn("reRenderFullImage: 没有当前图片"),!1;if(i.value.length===0)return console.log("reRenderFullImage: 没有气泡，跳过渲染"),!0;const E=y();if(!E)return console.error("reRenderFullImage: 缺少图像数据"),o.value="缺少图像数据",I||t?.onRenderError?.("缺少图像数据"),!1;const g=Symbol("render");S=g,a.value=!0,o.value="",I||t?.onRenderStart?.();try{console.log("reRenderFullImage: 开始重新渲染，气泡数量:",i.value.length);const d=i.value,Y=d.map(w=>w.translatedText||""),q=d.map(w=>w.coords),te=d.map(w=>({translatedText:w.translatedText||"",coords:w.coords,fontSize:w.fontSize||24,fontFamily:w.fontFamily||"fonts/STSONG.TTF",textDirection:w.textDirection||"vertical",textColor:w.textColor||"#231816",rotationAngle:w.rotationAngle||0,position:w.position||{x:0,y:0},strokeEnabled:w.strokeEnabled!==void 0?w.strokeEnabled:!0,strokeColor:w.strokeColor||"#FFFFFF",strokeWidth:w.strokeWidth!==void 0?w.strokeWidth:3})),M=await Kn({clean_image:E,bubble_texts:Y,bubble_coords:q,bubble_states:te,fontSize:d[0]?.fontSize||24,fontFamily:d[0]?.fontFamily||"fonts/STSONG.TTF",textDirection:d[0]?.textDirection||"vertical",textColor:d[0]?.textColor||"#231816",strokeEnabled:d[0]?.strokeEnabled!==void 0?d[0].strokeEnabled:!0,strokeColor:d[0]?.strokeColor||"#FFFFFF",strokeWidth:d[0]?.strokeWidth||3,use_individual_styles:!0,use_inpainting:!1,use_lama:!1,is_font_style_change:!0});if(S!==g)return console.log("reRenderFullImage: 渲染结果已过期，忽略"),!1;if(M.rendered_image){const w=`data:image/png;base64,${M.rendered_image}`;return l.updateCurrentImage({translatedDataURL:w}),console.log("reRenderFullImage: 渲染成功"),I||t?.onRenderSuccess?.(w),!0}else{const w=M.error||"渲染失败";return console.error("reRenderFullImage: 渲染失败 -",w),o.value=w,I||t?.onRenderError?.(w),!1}}catch(d){if(S!==g)return!1;const Y=d instanceof Error?d.message:"渲染请求失败";return console.error("reRenderFullImage: 渲染出错 -",d),o.value=Y,I||t?.onRenderError?.(Y),!1}finally{S===g&&(a.value=!1,I||t?.onRenderEnd?.())}}function b(){S=null,a.value=!1}return{isRendering:a,renderError:o,reRenderFullImage:C,cancelRender:b}}const Xd=["data-index","data-coords","data-rotation","onClick","onMousedown"],Jd={class:"bubble-index"},jd=["data-parent-index","onMousedown"],Gd=["data-parent-index","onMousedown"],Zd=["data-parent-index","onMousedown"],Qd=["data-parent-index","onMousedown"],eg=["data-parent-index","onMousedown"],tg=["data-parent-index","onMousedown"],ng=["data-parent-index","onMousedown"],og=["data-parent-index","onMousedown"],ag=["data-parent-index","onMousedown"],sg=Je({__name:"BubbleOverlay",props:{bubbles:{},selectedIndex:{},selectedIndices:{},scale:{},isDrawingMode:{type:Boolean},imageWidth:{},imageHeight:{}},emits:["select","multiSelect","dragStart","dragging","dragEnd","resizeStart","resizing","resizeEnd","rotateStart","rotating","rotateEnd","drawBubble","clearMultiSelect"],setup(t,{emit:u}){const l=dt(),{isDragging:i,draggingIndex:n,dragOffsetX:a,dragOffsetY:o,dragInitialX:S,dragInitialY:y,isResizing:C,resizingIndex:b,resizeCurrentCoords:I,isRotating:R,rotatingIndex:E,rotateCurrentAngle:g}=yt(l),d=t,Y=u,q=h(null),te=h(0),M=h(0),w=h(""),Z=h(0),z=h(0),re=h(null),G=h(0),A=h(0),c=h(0),T=h(0),ne=h(!1),m=h(0),V=h(0),J=h(null),le=h(!1);function s(f,B){let j,ee,be,F,ae=f.rotationAngle||0;if(i.value&&n.value===B){const[Ee,Ce,ke,he]=f.coords;j=S.value+a.value,ee=y.value+o.value,be=j+(ke-Ee),F=ee+(he-Ce)}else C.value&&b.value===B&&I.value?[j,ee,be,F]=I.value:R.value&&E.value===B?([j,ee,be,F]=f.coords,ae=g.value):[j,ee,be,F]=f.coords;const ve=be-j,se=F-ee,Pe={left:`${j}px`,top:`${ee}px`,width:`${ve}px`,height:`${se}px`};return ae&&(Pe.transformOrigin="center center",Pe.transform=`rotate(${ae}deg)`),Pe}function p(){if(!J.value)return{};const[f,B,j,ee]=J.value;return{left:`${Math.min(f,j)}px`,top:`${Math.min(B,ee)}px`,width:`${Math.abs(j-f)}px`,height:`${Math.abs(ee-B)}px`}}function x(f){if(!q.value)return null;const B=q.value.getBoundingClientRect(),j=d.scale||1,ee=(f.clientX-B.left)/j,be=(f.clientY-B.top)/j;return{x:ee,y:be}}function oe(f,B){B.shiftKey?Y("multiSelect",f):Y("select",f)}function me(f){if(f.button===1){f.preventDefault(),le.value=!0,document.body.classList.add("middle-button-drawing"),v(f);return}f.button===0&&(f.shiftKey||Y("clearMultiSelect"),d.isDrawingMode&&v(f))}function ue(f,B){if(B.button===0){if(B.preventDefault(),B.stopPropagation(),f!==d.selectedIndex){Y("select",f);return}Se(f,B)}}function Se(f,B){document.removeEventListener("mousemove",N),document.removeEventListener("mouseup",O),i.value=!0,n.value=f,te.value=B.clientX,M.value=B.clientY,a.value=0,o.value=0;const j=d.bubbles[f];j&&(S.value=j.coords[0],y.value=j.coords[1]),Y("dragStart",f,B),document.addEventListener("mousemove",N),document.addEventListener("mouseup",O)}function K(f){const B=d.scale||1,j=(f.clientX-te.value)/B,ee=(f.clientY-M.value)/B;a.value=j,o.value=ee}function k(f){const B=n.value;i.value=!1,n.value=-1,a.value=0,o.value=0;const j=d.scale||1,ee=(f.clientX-te.value)/j,be=(f.clientY-M.value)/j,F=d.bubbles[B];if(!F)return;const[ae,ve,se,Pe]=F.coords,Ee=se-ae,Ce=Pe-ve;let ke=Math.round(S.value+ee),he=Math.round(y.value+be);const Ae=d.imageWidth||2e3,$e=d.imageHeight||2e3,Ue=Math.min(Ee,Ae),Ie=Math.min(Ce,$e);ke=Math.max(0,Math.min(ke,Ae-Ue)),he=Math.max(0,Math.min(he,$e-Ie));const De=[ke,he,ke+Ue,he+Ie];Y("dragEnd",B,De)}function de(f,B,j){if(j.button!==0)return;j.preventDefault(),j.stopPropagation(),document.removeEventListener("mousemove",N),document.removeEventListener("mouseup",O),C.value=!0,b.value=B,w.value=f,Z.value=j.clientX,z.value=j.clientY;const ee=d.bubbles[B];ee&&(re.value=[...ee.coords],I.value=[...ee.coords]),Y("resizeStart",B,f,j),document.addEventListener("mousemove",N),document.addEventListener("mouseup",O)}function H(f){if(!re.value)return;const B=d.scale||1,j=(f.clientX-Z.value)/B,ee=(f.clientY-z.value)/B;let[be,F,ae,ve]=re.value;const se=w.value;se.includes("w")&&(be+=j),se.includes("e")&&(ae+=j),se.includes("n")&&(F+=ee),se.includes("s")&&(ve+=ee),be>ae&&([be,ae]=[ae,be]),F>ve&&([F,ve]=[ve,F]);const Pe=10;ae-be<Pe||ve-F<Pe||(I.value=[be,F,ae,ve])}function _(f){if(!re.value)return;const B=d.scale||1,j=(f.clientX-Z.value)/B,ee=(f.clientY-z.value)/B;let[be,F,ae,ve]=re.value;const se=w.value;se.includes("w")&&(be+=j),se.includes("e")&&(ae+=j),se.includes("n")&&(F+=ee),se.includes("s")&&(ve+=ee),be>ae&&([be,ae]=[ae,be]),F>ve&&([F,ve]=[ve,F]);const Pe=d.imageWidth||2e3,Ee=d.imageHeight||2e3;be=Math.max(0,Math.round(be)),F=Math.max(0,Math.round(F)),ae=Math.min(Pe,Math.round(ae)),ve=Math.min(Ee,Math.round(ve));const Ce=10;if(ae-be<Ce||ve-F<Ce){console.warn("调整后尺寸过小，已撤销"),C.value=!1,b.value=-1,re.value=null;return}Y("resizeEnd",b.value,[be,F,ae,ve]),C.value=!1,b.value=-1,re.value=null,I.value=null}function D(f,B){if(B.button!==0)return;B.preventDefault(),B.stopPropagation(),document.removeEventListener("mousemove",N),document.removeEventListener("mouseup",O),R.value=!0,E.value=f;const j=d.bubbles[f];if(!j||!q.value)return;const[ee,be,F,ae]=j.coords,ve=d.scale||1,se=q.value.getBoundingClientRect();c.value=se.left+(ee+F)/2*ve,T.value=se.top+(be+ae)/2*ve;const Pe=B.clientX-c.value,Ee=B.clientY-T.value;G.value=Math.atan2(Ee,Pe)*180/Math.PI,A.value=j.rotationAngle||0,g.value=j.rotationAngle||0,Y("rotateStart",f,B),document.body.classList.add("rotating-box"),document.addEventListener("mousemove",N),document.addEventListener("mouseup",O),console.log(`开始旋转气泡 #${f+1}，初始角度: ${A.value}°`)}function $(f){const B=f.clientX-c.value,j=f.clientY-T.value,be=Math.atan2(j,B)*180/Math.PI-G.value;let F=A.value+be;for(;F>180;)F-=360;for(;F<-180;)F+=360;f.shiftKey&&(F=Math.round(F/15)*15),g.value=F}function r(f){document.body.classList.remove("rotating-box");const B=E.value,j=g.value;Y("rotateEnd",B,j),R.value=!1,E.value=-1,console.log(`气泡 #${B+1} 旋转完成，角度: ${j}°`)}function v(f){const B=x(f);if(!B)return;const j=d.imageWidth||2e3,ee=d.imageHeight||2e3;B.x<0||B.x>j||B.y<0||B.y>ee||(ne.value=!0,m.value=B.x,V.value=B.y,J.value=[B.x,B.y,B.x,B.y],document.addEventListener("mousemove",N),document.addEventListener("mouseup",O),console.log("开始绘制新框:",B.x.toFixed(1),B.y.toFixed(1)))}function W(f){const B=x(f);!B||!J.value||(J.value=[m.value,V.value,B.x,B.y])}function ge(f){const B=x(f);if(le.value&&(le.value=!1,document.body.classList.remove("middle-button-drawing")),!B||!J.value){ne.value=!1,J.value=null;return}const j=d.imageWidth||2e3,ee=d.imageHeight||2e3,be=Math.max(0,Math.round(Math.min(m.value,B.x))),F=Math.max(0,Math.round(Math.min(V.value,B.y))),ae=Math.min(j,Math.round(Math.max(m.value,B.x))),ve=Math.min(ee,Math.round(Math.max(V.value,B.y))),se=10;if(ae-be<se||ve-F<se){console.log("绘制的框太小，已忽略"),ne.value=!1,J.value=null;return}console.log("完成绘制新框:",[be,F,ae,ve]),Y("drawBubble",[be,F,ae,ve]),ne.value=!1,J.value=null}function N(f){i.value?K(f):C.value?H(f):R.value?$(f):ne.value&&W(f)}function O(f){document.removeEventListener("mousemove",N),document.removeEventListener("mouseup",O),(f.button===1||le.value)&&(le.value=!1,document.body.classList.remove("middle-button-drawing")),i.value?k(f):C.value?_(f):R.value?r():ne.value&&ge(f)}return rt(()=>{}),St(()=>{document.removeEventListener("mousemove",N),document.removeEventListener("mouseup",O),document.body.classList.remove("middle-button-drawing"),document.body.classList.remove("rotating-box")}),(f,B)=>(P(),U("div",{class:"bubble-overlay",ref_key:"overlayRef",ref:q,onMousedown:me},[(P(!0),U(Ke,null,je(t.bubbles,(j,ee)=>(P(),U("div",{key:ee,class:Le(["bubble-highlight-box",{selected:ee===t.selectedIndex,"multi-selected":t.selectedIndices.length>1&&t.selectedIndices.includes(ee)&&ee!==t.selectedIndex}]),style:tt(s(j,ee)),"data-index":ee,"data-coords":JSON.stringify(j.coords),"data-rotation":j.rotationAngle||0,onClick:at(be=>oe(ee,be),["stop"]),onMousedown:at(be=>ue(ee,be),["stop"])},[e("span",Jd,pe(ee+1),1),ee===t.selectedIndex?(P(),U(Ke,{key:0},[e("div",{class:"resize-handle nw","data-handle":"nw","data-parent-index":ee,onMousedown:at(be=>de("nw",ee,be),["stop"])},null,40,jd),e("div",{class:"resize-handle n","data-handle":"n","data-parent-index":ee,onMousedown:at(be=>de("n",ee,be),["stop"])},null,40,Gd),e("div",{class:"resize-handle ne","data-handle":"ne","data-parent-index":ee,onMousedown:at(be=>de("ne",ee,be),["stop"])},null,40,Zd),e("div",{class:"resize-handle e","data-handle":"e","data-parent-index":ee,onMousedown:at(be=>de("e",ee,be),["stop"])},null,40,Qd),e("div",{class:"resize-handle se","data-handle":"se","data-parent-index":ee,onMousedown:at(be=>de("se",ee,be),["stop"])},null,40,eg),e("div",{class:"resize-handle s","data-handle":"s","data-parent-index":ee,onMousedown:at(be=>de("s",ee,be),["stop"])},null,40,tg),e("div",{class:"resize-handle sw","data-handle":"sw","data-parent-index":ee,onMousedown:at(be=>de("sw",ee,be),["stop"])},null,40,ng),e("div",{class:"resize-handle w","data-handle":"w","data-parent-index":ee,onMousedown:at(be=>de("w",ee,be),["stop"])},null,40,og),B[0]||(B[0]=e("div",{class:"rotate-line"},null,-1)),e("div",{class:"rotate-handle",title:"拖拽旋转","data-parent-index":ee,onMousedown:at(be=>D(ee,be),["stop"])},null,40,ag)],64)):we("",!0)],46,Xd))),128)),J.value?(P(),U("div",{key:0,class:"drawing-rect",style:tt(p())},null,4)):we("",!0)],544))}}),Ln=Xe(sg,[["__scopeId","data-v-6b359601"]]),lg={key:0,class:"kana-keyboard"},ig={class:"kana-keyboard-header"},rg={class:"kana-keyboard-tabs"},ug=["onClick"],cg={class:"kana-keyboard-options"},dg={class:"kana-mode-select"},gg={class:"kana-target-select"},bg={class:"kana-table"},vg={class:"row-label"},fg=["onClick"],pg={class:"kana-hiragana"},mg={class:"kana-katakana"},hg={class:"kana-table"},yg={class:"row-label"},xg=["onClick"],kg={class:"kana-hiragana"},Sg={class:"kana-katakana"},Cg={class:"kana-table combo-table"},wg={class:"row-label"},_g=["onClick"],$g={class:"kana-hiragana"},Ig={class:"kana-katakana"},Tg={class:"special-chars-grid"},Dg=["onClick"],Rg={key:0,class:"char-label"},Mg=Je({__name:"JapaneseKeyboard",props:{visible:{type:Boolean,default:!1},defaultTarget:{default:"original"}},emits:["close","insert","delete"],setup(t,{emit:u}){const l=t,i=u,n=h("basic"),a=h("hiragana"),o=h(l.defaultTarget),S=h(null),y=[{label:"原文",value:"original"},{label:"译文",value:"translated"}],C=[{id:"basic",label:"基本"},{id:"dakuten",label:"浊/半浊音"},{id:"combo",label:"拗音"},{id:"special",label:"特殊"}],b=[{label:"あ行",chars:[{h:"あ",k:"ア"},{h:"い",k:"イ"},{h:"う",k:"ウ"},{h:"え",k:"エ"},{h:"お",k:"オ"}]},{label:"か行",chars:[{h:"か",k:"カ"},{h:"き",k:"キ"},{h:"く",k:"ク"},{h:"け",k:"ケ"},{h:"こ",k:"コ"}]},{label:"さ行",chars:[{h:"さ",k:"サ"},{h:"し",k:"シ"},{h:"す",k:"ス"},{h:"せ",k:"セ"},{h:"そ",k:"ソ"}]},{label:"た行",chars:[{h:"た",k:"タ"},{h:"ち",k:"チ"},{h:"つ",k:"ツ"},{h:"て",k:"テ"},{h:"と",k:"ト"}]},{label:"な行",chars:[{h:"な",k:"ナ"},{h:"に",k:"ニ"},{h:"ぬ",k:"ヌ"},{h:"ね",k:"ネ"},{h:"の",k:"ノ"}]},{label:"は行",chars:[{h:"は",k:"ハ"},{h:"ひ",k:"ヒ"},{h:"ふ",k:"フ"},{h:"へ",k:"ヘ"},{h:"ほ",k:"ホ"}]},{label:"ま行",chars:[{h:"ま",k:"マ"},{h:"み",k:"ミ"},{h:"む",k:"ム"},{h:"め",k:"メ"},{h:"も",k:"モ"}]},{label:"や行",chars:[{h:"や",k:"ヤ"},null,{h:"ゆ",k:"ユ"},null,{h:"よ",k:"ヨ"}]},{label:"ら行",chars:[{h:"ら",k:"ラ"},{h:"り",k:"リ"},{h:"る",k:"ル"},{h:"れ",k:"レ"},{h:"ろ",k:"ロ"}]},{label:"わ行",chars:[{h:"わ",k:"ワ"},null,null,null,{h:"を",k:"ヲ"}]},{label:"ん",chars:[{h:"ん",k:"ン"},null,null,null,null]}],I=[{label:"が行",chars:[{h:"が",k:"ガ"},{h:"ぎ",k:"ギ"},{h:"ぐ",k:"グ"},{h:"げ",k:"ゲ"},{h:"ご",k:"ゴ"}]},{label:"ざ行",chars:[{h:"ざ",k:"ザ"},{h:"じ",k:"ジ"},{h:"ず",k:"ズ"},{h:"ぜ",k:"ゼ"},{h:"ぞ",k:"ゾ"}]},{label:"だ行",chars:[{h:"だ",k:"ダ"},{h:"ぢ",k:"ヂ"},{h:"づ",k:"ヅ"},{h:"で",k:"デ"},{h:"ど",k:"ド"}]},{label:"ば行",chars:[{h:"ば",k:"バ"},{h:"び",k:"ビ"},{h:"ぶ",k:"ブ"},{h:"べ",k:"ベ"},{h:"ぼ",k:"ボ"}]},{label:"ぱ行",chars:[{h:"ぱ",k:"パ"},{h:"ぴ",k:"ピ"},{h:"ぷ",k:"プ"},{h:"ぺ",k:"ペ"},{h:"ぽ",k:"ポ"}]}],R=[{label:"きゃ行",chars:[{h:"きゃ",k:"キャ"},{h:"きゅ",k:"キュ"},{h:"きょ",k:"キョ"}]},{label:"しゃ行",chars:[{h:"しゃ",k:"シャ"},{h:"しゅ",k:"シュ"},{h:"しょ",k:"ショ"}]},{label:"ちゃ行",chars:[{h:"ちゃ",k:"チャ"},{h:"ちゅ",k:"チュ"},{h:"ちょ",k:"チョ"}]},{label:"にゃ行",chars:[{h:"にゃ",k:"ニャ"},{h:"にゅ",k:"ニュ"},{h:"にょ",k:"ニョ"}]},{label:"ひゃ行",chars:[{h:"ひゃ",k:"ヒャ"},{h:"ひゅ",k:"ヒュ"},{h:"ひょ",k:"ヒョ"}]},{label:"みゃ行",chars:[{h:"みゃ",k:"ミャ"},{h:"みゅ",k:"ミュ"},{h:"みょ",k:"ミョ"}]},{label:"りゃ行",chars:[{h:"りゃ",k:"リャ"},{h:"りゅ",k:"リュ"},{h:"りょ",k:"リョ"}]},{label:"ぎゃ行",chars:[{h:"ぎゃ",k:"ギャ"},{h:"ぎゅ",k:"ギュ"},{h:"ぎょ",k:"ギョ"}]},{label:"じゃ行",chars:[{h:"じゃ",k:"ジャ"},{h:"じゅ",k:"ジュ"},{h:"じょ",k:"ジョ"}]},{label:"びゃ行",chars:[{h:"びゃ",k:"ビャ"},{h:"びゅ",k:"ビュ"},{h:"びょ",k:"ビョ"}]},{label:"ぴゃ行",chars:[{h:"ぴゃ",k:"ピャ"},{h:"ぴゅ",k:"ピュ"},{h:"ぴょ",k:"ピョ"}]}],E=[{char:"っ",label:"促音"},{char:"ッ",label:"促音"},{char:"ー",label:"长音"},{char:"〜",label:"波浪"},{char:"。",label:"句号"},{char:"、",label:"顿号"},{char:"「",label:"引号"},{char:"」",label:"引号"},{char:"『",label:"双引"},{char:"』",label:"双引"},{char:"…",label:"省略"},{char:"・",label:"中点"},{char:"！",label:"感叹"},{char:"？",label:"问号"},{char:"♪",label:"音符"},{char:"♡",label:"心形"},{char:"★",label:"星形"},{char:"☆",label:"空星"},{char:"ぁ",label:"小あ"},{char:"ぃ",label:"小い"},{char:"ぅ",label:"小う"},{char:"ぇ",label:"小え"},{char:"ぉ",label:"小お"},{char:"ァ",label:"小ア"},{char:"ィ",label:"小イ"},{char:"ゥ",label:"小ウ"},{char:"ェ",label:"小エ"},{char:"ォ",label:"小オ"},{char:"ゃ",label:"小や"},{char:"ゅ",label:"小ゆ"},{char:"ょ",label:"小よ"},{char:"ャ",label:"小ヤ"},{char:"ュ",label:"小ユ"},{char:"ョ",label:"小ヨ"}];function g(){i("close")}function d(te){const M=a.value==="hiragana"?te.h:te.k;S.value=te.h,setTimeout(()=>{S.value=null},100),i("insert",M,o.value)}function Y(te){S.value=te,setTimeout(()=>{S.value=null},100),i("insert",te,o.value)}function q(){i("delete",o.value)}return(te,M)=>t.visible?(P(),U("div",lg,[e("div",ig,[M[3]||(M[3]=e("span",{class:"kana-keyboard-title"},"50音键盘",-1)),e("div",rg,[(P(),U(Ke,null,je(C,w=>e("button",{key:w.id,class:Le(["kana-tab",{active:n.value===w.id}]),onClick:Z=>n.value=w.id},pe(w.label),11,ug)),64))]),e("button",{class:"kana-keyboard-close",onClick:g},"✕")]),e("div",cg,[e("div",dg,[e("label",null,[ie(e("input",{type:"radio",name:"kanaMode",value:"hiragana","onUpdate:modelValue":M[0]||(M[0]=w=>a.value=w)},null,512),[[Bn,a.value]]),M[4]||(M[4]=Oe(" 平假名 ",-1))]),e("label",null,[ie(e("input",{type:"radio",name:"kanaMode",value:"katakana","onUpdate:modelValue":M[1]||(M[1]=w=>a.value=w)},null,512),[[Bn,a.value]]),M[5]||(M[5]=Oe(" 片假名 ",-1))])]),e("div",gg,[M[6]||(M[6]=e("label",null,"输入到：",-1)),Te(Ne,{modelValue:o.value,"onUpdate:modelValue":M[2]||(M[2]=w=>o.value=w),options:y},null,8,["modelValue"])])]),e("div",{class:Le(["kana-tab-content",{active:n.value==="basic"}])},[e("table",bg,[M[7]||(M[7]=e("thead",null,[e("tr",null,[e("th"),e("th",null,"あ段"),e("th",null,"い段"),e("th",null,"う段"),e("th",null,"え段"),e("th",null,"お段")])],-1)),e("tbody",null,[(P(),U(Ke,null,je(b,w=>e("tr",{key:w.label},[e("td",vg,pe(w.label),1),(P(!0),U(Ke,null,je(w.chars,(Z,z)=>(P(),U("td",{key:z},[Z?(P(),U("button",{key:0,class:Le(["kana-key",{pressed:S.value===Z.h}]),onClick:re=>d(Z)},[e("span",pg,pe(Z.h),1),e("span",mg,pe(Z.k),1)],10,fg)):we("",!0)]))),128))])),64))])])],2),e("div",{class:Le(["kana-tab-content",{active:n.value==="dakuten"}])},[e("table",hg,[M[8]||(M[8]=e("thead",null,[e("tr",null,[e("th"),e("th",null,"あ段"),e("th",null,"い段"),e("th",null,"う段"),e("th",null,"え段"),e("th",null,"お段")])],-1)),e("tbody",null,[(P(),U(Ke,null,je(I,w=>e("tr",{key:w.label},[e("td",yg,pe(w.label),1),(P(!0),U(Ke,null,je(w.chars,(Z,z)=>(P(),U("td",{key:z},[Z?(P(),U("button",{key:0,class:Le(["kana-key",{pressed:S.value===Z.h}]),onClick:re=>d(Z)},[e("span",kg,pe(Z.h),1),e("span",Sg,pe(Z.k),1)],10,xg)):we("",!0)]))),128))])),64))])])],2),e("div",{class:Le(["kana-tab-content",{active:n.value==="combo"}])},[e("table",Cg,[M[9]||(M[9]=e("thead",null,[e("tr",null,[e("th"),e("th",null,"ゃ"),e("th",null,"ゅ"),e("th",null,"ょ")])],-1)),e("tbody",null,[(P(),U(Ke,null,je(R,w=>e("tr",{key:w.label},[e("td",wg,pe(w.label),1),(P(!0),U(Ke,null,je(w.chars,(Z,z)=>(P(),U("td",{key:z},[Z?(P(),U("button",{key:0,class:Le(["kana-key",{pressed:S.value===Z.h}]),onClick:re=>d(Z)},[e("span",$g,pe(Z.h),1),e("span",Ig,pe(Z.k),1)],10,_g)):we("",!0)]))),128))])),64))])])],2),e("div",{class:Le(["kana-tab-content",{active:n.value==="special"}])},[e("div",Tg,[(P(),U(Ke,null,je(E,w=>e("button",{key:w.char,class:Le(["kana-key special-key",{pressed:S.value===w.char}]),onClick:Z=>Y(w.char)},[Oe(pe(w.char)+" ",1),w.label?(P(),U("span",Rg,pe(w.label),1)):we("",!0)],10,Dg)),64))])],2),e("div",{class:"kana-keyboard-footer"},[e("button",{class:"kana-backspace",onClick:q},"⌫ 退格")])])):we("",!0)}}),Bg=Xe(Mg,[["__scopeId","data-v-245aef4a"]]),Eg={class:"edit-panel-content"},Pg={key:0,class:"no-selection-hint-panel"},Ag={class:"text-column original-text-column text-block"},Fg={class:"text-column translated-text-column text-block"},Lg={class:"style-settings-section text-block"},Og={class:"office-toolbar"},Ug={class:"toolbar-row toolbar-row-top"},zg={class:"combo-control font-control"},Vg={class:"combo-control size-control"},Ng={class:"size-input-wrap"},Wg=["min","max","step"],Kg={class:"toolbar-row toolbar-row-actions"},qg={class:"toolbar-icon-group","aria-label":"排版方向"},Hg=["data-active"],Yg=["data-active"],Xg={class:"toolbar-color-group"},Jg={class:"toolbar-color-picker",title:"文字颜色"},jg={class:"toolbar-inpaint-group",title:"背景修复方式"},Gg={class:"toolbar-stroke-cluster"},Zg=["data-active"],Qg={class:"toolbar-row toolbar-row-bottom"},eb={class:"toolbar-rotation-group",title:"旋转角度"},tb={class:"toolbar-position-group",title:"位置调整"},nb={class:"toolbar-position-value"},ob={class:"fontsize-presets-panel"},ab={class:"font-size-presets"},sb=["onClick"],Rt=2,lb=Je({__name:"BubbleEditor",props:{bubble:{},bubbleIndex:{},hasSelection:{type:Boolean}},emits:["update","reRender","ocrRecognize","inpaintBubble","reTranslate","applyBubble"],setup(t,{emit:u}){const l=t,i=u,n=dt(),a={originalText:"",translatedText:"",fontSize:24,fontFamily:"fonts/STSONG.TTF",textDirection:"auto",textColor:"#231816",fillColor:"#FFFFFF",strokeEnabled:!0,strokeColor:"#FFFFFF",strokeWidth:3,rotationAngle:0,inpaintMethod:"solid",position:{x:0,y:0}},o=h(""),S=h(""),y=h(24),C=h("fonts/STSONG.TTF"),b=h("auto"),I=h("#231816"),R=h("#FFFFFF"),E=h(!0),g=h("#FFFFFF"),d=h(3),Y=h(0),q=h("solid"),te=h(0),M=h(0),w=h(null),Z=h(null),z=h(null),re=h(null),G=h(null),A=h(!1),c=h("original"),T=h([{name:"华文宋体",path:"fonts/STSONG.TTF"},{name:"华文楷体",path:"fonts/STKAITI.TTF"},{name:"华文细黑",path:"fonts/STXIHEI.TTF"},{name:"黑体",path:"fonts/SIMHEI.TTF"},{name:"宋体",path:"fonts/SIMSUN.TTC"}]),ne=h([]),m=X(()=>l.bubble?l.bubble.coords[0]+te.value:0),V=X(()=>l.bubble?l.bubble.coords[1]+M.value:0),J=X(()=>{const De=[{label:"系统字体",options:T.value.map(L=>({label:L.name,value:L.path}))}];return ne.value.length>0&&De.push({label:"自定义字体",options:ne.value.map(L=>({label:L.name,value:L.path}))}),De}),le=[{label:"纯色填充",value:"solid"},{label:"LAMA修复(漫画)",value:"lama_mpe"},{label:"LAMA修复(通用)",value:"litelama"}];function s(De){const L=De||a;o.value=L.originalText,S.value=L.translatedText,y.value=L.fontSize,C.value=L.fontFamily,b.value=L.textDirection,I.value=L.textColor,R.value=L.fillColor,E.value=L.strokeEnabled,g.value=L.strokeColor,d.value=L.strokeWidth,Y.value=L.rotationAngle,q.value=L.inpaintMethod,te.value=L.position?.x||0,M.value=L.position?.y||0}We(()=>l.bubble,De=>{s(De)},{deep:!0,immediate:!0});function p(){i("update",{originalText:o.value})}function x(){i("update",{translatedText:S.value})}function oe(){navigator.clipboard.writeText(o.value)}function me(){navigator.clipboard.writeText(S.value)}function ue(){i("update",{fontSize:y.value})}function Se(De){y.value=De,i("update",{fontSize:De})}function K(){y.value=Math.min(Dn,y.value+Nt),i("update",{fontSize:y.value})}function k(){y.value=Math.max(Rn,y.value-Nt),i("update",{fontSize:y.value})}function de(){i("update",{fontFamily:C.value})}function H(De){b.value=De,i("update",{textDirection:De})}function _(){z.value?.click()}function D(){i("update",{textColor:I.value})}function $(){re.value?.click()}function r(){i("update",{fillColor:R.value})}function v(){G.value?.click()}function W(){i("update",{strokeColor:g.value})}function ge(){E.value=!E.value,i("update",{strokeEnabled:E.value})}function N(){i("update",{strokeWidth:d.value})}function O(){i("update",{inpaintMethod:q.value})}function f(){i("update",{rotationAngle:Y.value})}function B(){Y.value=Math.max(-180,Y.value-5),i("update",{rotationAngle:Y.value})}function j(){Y.value=Math.min(180,Y.value+5),i("update",{rotationAngle:Y.value})}function ee(){Y.value=0,i("update",{rotationAngle:0})}function be(){te.value-=Rt,i("update",{position:{x:te.value,y:M.value}})}function F(){te.value+=Rt,i("update",{position:{x:te.value,y:M.value}})}function ae(){M.value-=Rt,i("update",{position:{x:te.value,y:M.value}})}function ve(){M.value+=Rt,i("update",{position:{x:te.value,y:M.value}})}function se(){te.value=0,M.value=0,i("update",{position:{x:0,y:0}})}function Pe(){i("applyBubble",l.bubbleIndex)}function Ee(){n.updateAllBubbles({fontSize:y.value,fontFamily:C.value,textDirection:b.value,textColor:I.value,fillColor:R.value,strokeEnabled:E.value,strokeColor:g.value,strokeWidth:d.value,inpaintMethod:q.value}),console.log("样式已应用到所有气泡"),i("reRender")}function Ce(){s(l.bubble),i("reRender")}function ke(){i("ocrRecognize",l.bubbleIndex)}function he(){i("reTranslate",l.bubbleIndex)}function Ae(){A.value=!A.value}function $e(De,L){if(L==="original"){const fe=w.value;if(fe){const Me=fe.selectionStart||o.value.length,xe=fe.selectionEnd||o.value.length,Fe=o.value;o.value=Fe.slice(0,Me)+De+Fe.slice(xe),st(()=>{fe.selectionStart=fe.selectionEnd=Me+De.length,fe.focus()}),i("update",{originalText:o.value})}}else{const fe=Z.value;if(fe){const Me=fe.selectionStart||S.value.length,xe=fe.selectionEnd||S.value.length,Fe=S.value;S.value=Fe.slice(0,Me)+De+Fe.slice(xe),st(()=>{fe.selectionStart=fe.selectionEnd=Me+De.length,fe.focus()}),i("update",{translatedText:S.value})}}}function Ue(De){if(De==="original"){const L=w.value;if(L&&o.value.length>0){const fe=L.selectionStart||o.value.length,Me=L.selectionEnd||o.value.length,xe=o.value;fe===Me&&fe>0?(o.value=xe.slice(0,fe-1)+xe.slice(Me),st(()=>{L.selectionStart=L.selectionEnd=fe-1,L.focus()})):fe!==Me&&(o.value=xe.slice(0,fe)+xe.slice(Me),st(()=>{L.selectionStart=L.selectionEnd=fe,L.focus()})),i("update",{originalText:o.value})}}else{const L=Z.value;if(L&&S.value.length>0){const fe=L.selectionStart||S.value.length,Me=L.selectionEnd||S.value.length,xe=S.value;fe===Me&&fe>0?(S.value=xe.slice(0,fe-1)+xe.slice(Me),st(()=>{L.selectionStart=L.selectionEnd=fe-1,L.focus()})):fe!==Me&&(S.value=xe.slice(0,fe)+xe.slice(Me),st(()=>{L.selectionStart=L.selectionEnd=fe,L.focus()})),i("update",{translatedText:S.value})}}}async function Ie(){try{const De=await Wo();if(De.fonts){const L=[],fe=[];for(const Me of De.fonts){const xe={name:typeof Me=="string"?Me:Me.display_name||Me.file_name||"",path:typeof Me=="string"?Me:Me.path};xe.path.startsWith("fonts/")?L.push(xe):fe.push(xe)}L.length>0&&(T.value=L),ne.value=fe}}catch(De){console.error("加载字体列表失败:",De)}}return rt(()=>{Ie()}),(De,L)=>(P(),U("div",Eg,[t.hasSelection?(P(),U(Ke,{key:1},[e("div",Ag,[e("div",{class:"text-column-header"},[L[14]||(L[14]=e("span",{class:"column-title"},"🇯🇵 日语原文 (OCR结果)",-1)),e("button",{class:"re-ocr-btn",onClick:ke,title:"重新OCR此气泡"},"🔄")]),ie(e("textarea",{ref_key:"originalTextInput",ref:w,"onUpdate:modelValue":L[0]||(L[0]=fe=>o.value=fe),class:"text-editor original-editor",placeholder:"OCR识别的日语原文...",spellcheck:"false",onInput:p},null,544),[[Be,o.value]]),e("div",{class:"text-actions"},[e("button",{class:"copy-btn",onClick:oe},"📋 复制"),e("button",{class:"keyboard-toggle-btn",onClick:Ae,title:"显示/隐藏50音键盘"},"⌨️ 50音")]),Te(Bg,{visible:A.value,"default-target":c.value,onClose:L[1]||(L[1]=fe=>A.value=!1),onInsert:$e,onDelete:Ue},null,8,["visible","default-target"])]),e("div",Fg,[e("div",{class:"text-column-header"},[L[15]||(L[15]=e("span",{class:"column-title"},"🇨🇳 中文译文",-1)),e("button",{class:"re-translate-btn",onClick:he,title:"重新翻译此气泡"},"🔄")]),ie(e("textarea",{ref_key:"translatedTextInput",ref:Z,"onUpdate:modelValue":L[2]||(L[2]=fe=>S.value=fe),class:"text-editor translated-editor",placeholder:"翻译后的中文...",spellcheck:"false",onInput:x},null,544),[[Be,S.value]]),e("div",{class:"text-actions"},[e("button",{class:"copy-btn",onClick:me},"📋 复制"),e("button",{class:"apply-text-btn",onClick:Pe},"✓ 应用文本")])]),e("div",Lg,[e("div",Og,[e("div",Ug,[e("div",zg,[L[16]||(L[16]=e("label",null,"字体",-1)),Te(Ne,{modelValue:C.value,"onUpdate:modelValue":L[3]||(L[3]=fe=>C.value=fe),groups:J.value,title:"字体",onChange:de},null,8,["modelValue","groups"])]),e("div",Vg,[L[17]||(L[17]=e("label",null,"字号",-1)),e("div",Ng,[ie(e("input",{type:"number","onUpdate:modelValue":L[4]||(L[4]=fe=>y.value=fe),class:"toolbar-fontsize-input",min:ce(Rn),max:ce(Dn),step:ce(Nt),title:"字号",onChange:ue},null,40,Wg),[[Be,y.value,void 0,{number:!0}]]),e("div",{class:"toolbar-fontsize-btns"},[e("button",{class:"toolbar-fontsize-btn",onClick:K,title:"增大字号"},"A+"),e("button",{class:"toolbar-fontsize-btn",onClick:k,title:"减小字号"},"A-")])])])]),e("div",Kg,[e("div",qg,[e("button",{class:"toolbar-btn","data-active":b.value==="vertical",onClick:L[5]||(L[5]=fe=>H("vertical")),title:"竖向排版"},[...L[18]||(L[18]=[e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("path",{d:"M8 2v12M8 2L5 5M8 2l3 3",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])],8,Hg),e("button",{class:"toolbar-btn","data-active":b.value==="horizontal",onClick:L[6]||(L[6]=fe=>H("horizontal")),title:"横向排版"},[...L[19]||(L[19]=[e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("path",{d:"M2 8h12M14 8l-3-3M14 8l-3 3",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])],8,Yg)]),L[25]||(L[25]=e("div",{class:"toolbar-divider vertical"},null,-1)),e("div",Xg,[e("div",Jg,[e("button",{class:"toolbar-btn toolbar-color-btn",onClick:_},[L[20]||(L[20]=e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("text",{x:"3",y:"11","font-size":"10","font-weight":"bold",fill:"currentColor"},"A")],-1)),e("span",{class:"color-indicator",style:tt({background:I.value})},null,4)]),ie(e("input",{ref_key:"textColorInput",ref:z,type:"color","onUpdate:modelValue":L[7]||(L[7]=fe=>I.value=fe),class:"hidden-color-input",onChange:D},null,544),[[Be,I.value]])])]),L[26]||(L[26]=e("div",{class:"toolbar-divider vertical"},null,-1)),e("div",jg,[Te(Ne,{modelValue:q.value,"onUpdate:modelValue":L[8]||(L[8]=fe=>q.value=fe),options:le,onChange:O},null,8,["modelValue"]),e("div",{class:Le(["toolbar-color-picker toolbar-solid-color-options",{hidden:q.value!=="solid"}])},[e("button",{class:"toolbar-btn toolbar-color-btn",onClick:$},[L[21]||(L[21]=e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("rect",{x:"2",y:"2",width:"12",height:"12",rx:"2",fill:"none",stroke:"currentColor","stroke-width":"1.2"}),e("rect",{x:"4",y:"4",width:"8",height:"8",rx:"1",fill:"currentColor",opacity:"0.3"})],-1)),e("span",{class:"color-indicator",style:tt({background:R.value})},null,4)]),ie(e("input",{ref_key:"fillColorInput",ref:re,type:"color","onUpdate:modelValue":L[9]||(L[9]=fe=>R.value=fe),class:"hidden-color-input",onChange:r},null,544),[[Be,R.value]])],2)]),L[27]||(L[27]=e("div",{class:"toolbar-divider vertical"},null,-1)),e("div",Gg,[e("button",{class:"toolbar-btn","data-active":E.value,onClick:ge,title:"文字描边"},[...L[22]||(L[22]=[e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("text",{x:"3",y:"12","font-size":"11","font-weight":"bold",stroke:"currentColor","stroke-width":"2",fill:"none"},"A"),e("text",{x:"3",y:"12","font-size":"11","font-weight":"bold",fill:"currentColor"},"A")],-1)])],8,Zg),e("div",{class:Le(["toolbar-color-picker toolbar-stroke-options",{hidden:!E.value}]),title:"描边颜色"},[e("button",{class:"toolbar-btn toolbar-color-btn",onClick:v},[L[23]||(L[23]=e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("circle",{cx:"8",cy:"8",r:"5",fill:"none",stroke:"currentColor","stroke-width":"2"})],-1)),e("span",{class:"color-indicator",style:tt({background:g.value})},null,4)]),ie(e("input",{ref_key:"strokeColorInput",ref:G,type:"color","onUpdate:modelValue":L[10]||(L[10]=fe=>g.value=fe),class:"hidden-color-input",onChange:W},null,544),[[Be,g.value]])],2),e("div",{class:Le(["toolbar-stroke-width toolbar-stroke-options",{hidden:!E.value}]),title:"描边宽度"},[ie(e("input",{type:"number","onUpdate:modelValue":L[11]||(L[11]=fe=>d.value=fe),class:"toolbar-mini-input",min:"0",max:"10",onChange:N},null,544),[[Be,d.value,void 0,{number:!0}]]),L[24]||(L[24]=e("span",{class:"toolbar-unit"},"px",-1))],2)])]),e("div",Qg,[e("div",eb,[e("button",{class:"toolbar-btn",onClick:B,title:"逆时针旋转"},[...L[28]||(L[28]=[e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("path",{d:"M2 8a6 6 0 1 1 1.5 4",stroke:"currentColor","stroke-width":"1.5",fill:"none"}),e("path",{d:"M2 5v3.5h3.5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),ie(e("input",{type:"number","onUpdate:modelValue":L[12]||(L[12]=fe=>Y.value=fe),class:"toolbar-mini-input toolbar-rotation-input",min:"-180",max:"180",step:"5",onChange:f},null,544),[[Be,Y.value,void 0,{number:!0}]]),L[30]||(L[30]=e("span",{class:"toolbar-unit"},"°",-1)),e("button",{class:"toolbar-btn",onClick:j,title:"顺时针旋转"},[...L[29]||(L[29]=[e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("path",{d:"M14 8a6 6 0 1 0-1.5 4",stroke:"currentColor","stroke-width":"1.5",fill:"none"}),e("path",{d:"M14 5v3.5h-3.5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),e("button",{class:"toolbar-btn toolbar-small-btn",onClick:ee,title:"重置旋转"},"0")]),L[36]||(L[36]=e("div",{class:"toolbar-divider vertical"},null,-1)),e("div",tb,[e("button",{class:"toolbar-btn",onClick:be,title:"左移"},[...L[31]||(L[31]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("path",{d:"M10 3L5 8l5 5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),e("button",{class:"toolbar-btn",onClick:F,title:"右移"},[...L[32]||(L[32]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("path",{d:"M6 3l5 5-5 5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),e("button",{class:"toolbar-btn",onClick:ae,title:"上移"},[...L[33]||(L[33]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("path",{d:"M3 10l5-5 5 5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),e("button",{class:"toolbar-btn",onClick:ve,title:"下移"},[...L[34]||(L[34]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("path",{d:"M3 6l5 5 5-5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),e("span",nb,[e("span",null,pe(m.value),1),L[35]||(L[35]=Oe(",",-1)),e("span",null,pe(V.value),1)]),e("button",{class:"toolbar-btn toolbar-small-btn",onClick:se,title:"重置位置"},"⌂")])])]),e("details",ob,[L[37]||(L[37]=e("summary",null,"字号预设",-1)),e("div",ab,[(P(!0),U(Ke,null,je(ce(_o),fe=>(P(),U("button",{key:fe,class:Le(["preset-btn",{active:y.value===fe}]),onClick:Me=>Se(fe)},pe(fe),11,sb))),128))])]),e("div",{class:"edit-action-buttons"},[e("button",{class:"btn-apply",onClick:Pe},"应用"),e("button",{class:"btn-apply-all",onClick:Ee},"应用全部"),e("button",{class:"btn-reset",onClick:Ce},"重置")])])],64)):(P(),U("div",Pg,[...L[13]||(L[13]=[e("p",null,"请选择一个气泡进行编辑",-1),e("p",{class:"hint-sub"},"点击图片上的气泡框，或使用 ← → 键切换",-1)])]))]))}}),ib=Xe(lb,[["__scopeId","data-v-114c2a16"]]),rb={class:"edit-toolbar-wrapper"},ub={class:"edit-toolbar toolbar-row-1"},cb={class:"image-navigator"},db=["disabled"],gb=["disabled"],bb={class:"bubble-navigator"},vb=["disabled"],fb={class:"bubble-indicator"},pb={id:"currentBubbleNum"},mb={id:"totalBubbleNum"},hb=["disabled"],yb={class:"view-controls"},xb={key:0,viewBox:"0 0 20 20",width:"16",height:"16"},kb={key:1,viewBox:"0 0 20 20",width:"16",height:"16"},Sb={id:"zoomLevel"},Cb={class:"edit-toolbar toolbar-row-2"},wb={class:"annotation-tools"},_b=["disabled"],$b=["disabled"],Ib={key:0,class:"brush-size-indicator"},Tb={key:1,class:"brush-mode-hint"},Db={key:2,class:"edit-progress-container"},Rb={class:"edit-progress-info"},Mb={class:"edit-progress-text"},Bb={class:"edit-progress-count"},Eb={class:"edit-progress-bar"},Pb={class:"quick-actions"},Ab=Je({__name:"EditToolbar",props:{currentImageIndex:{},imageCount:{},canGoPrevious:{type:Boolean},canGoNext:{type:Boolean},showThumbnails:{type:Boolean},hasBubbles:{type:Boolean},selectedBubbleIndex:{},bubbleCount:{},layoutMode:{},syncEnabled:{type:Boolean},scale:{},isDrawingMode:{type:Boolean},hasSelection:{type:Boolean},brushMode:{},brushSize:{},mouseX:{},mouseY:{},isProcessing:{type:Boolean},progressText:{},progressCurrent:{},progressTotal:{}},emits:["go-previous-image","go-next-image","toggle-thumbnails","select-previous-bubble","select-next-bubble","toggle-layout","toggle-view-mode","toggle-sync","fit-to-screen","zoom-in","zoom-out","reset-zoom","exit-edit-mode","auto-detect-bubbles","detect-all-images","translate-with-bubbles","toggle-drawing-mode","delete-selected-bubbles","repair-selected-bubble","activate-repair-brush","activate-restore-brush","apply-and-next"],setup(t){const u=t,l=X(()=>u.progressTotal===0?0:Math.round(u.progressCurrent/u.progressTotal*100)),i=X(()=>{const n=u.brushMode==="repair"?{fill:"rgba(76, 175, 80, 0.4)",border:"#4CAF50"}:{fill:"rgba(33, 150, 243, 0.4)",border:"#2196F3"};return{position:"fixed",left:`${u.mouseX}px`,top:`${u.mouseY}px`,width:`${u.brushSize}px`,height:`${u.brushSize}px`,borderRadius:"50%",border:`2px solid ${n.border}`,backgroundColor:n.fill,pointerEvents:"none",zIndex:99999,transform:"translate(-50%, -50%)",display:u.brushMode?"block":"none"}});return(n,a)=>(P(),U("div",rb,[e("div",ub,[e("div",cb,[e("button",{class:"nav-btn",disabled:!t.canGoPrevious,onClick:a[0]||(a[0]=o=>n.$emit("go-previous-image")),title:"上一张图片 (PageUp)"}," ◀◀ ",8,db),e("span",{class:"image-indicator",onClick:a[1]||(a[1]=o=>n.$emit("toggle-thumbnails")),title:"点击展开缩略图"},[a[23]||(a[23]=Oe(" 图 ",-1)),e("span",null,pe(t.currentImageIndex+1),1),a[24]||(a[24]=Oe(" / ",-1)),e("span",null,pe(t.imageCount),1)]),e("button",{class:"nav-btn",disabled:!t.canGoNext,onClick:a[2]||(a[2]=o=>n.$emit("go-next-image")),title:"下一张图片 (PageDown)"}," ▶▶ ",8,gb),e("button",{class:Le(["thumb-toggle-btn",{active:t.showThumbnails}]),onClick:a[3]||(a[3]=o=>n.$emit("toggle-thumbnails")),title:"显示/隐藏缩略图"}," ☷ ",2)]),a[30]||(a[30]=e("div",{class:"toolbar-divider"},null,-1)),e("div",bb,[e("button",{id:"prevBubbleBtn",class:"nav-btn",disabled:!t.hasBubbles||t.selectedBubbleIndex<=0,onClick:a[4]||(a[4]=o=>n.$emit("select-previous-bubble")),title:"上一个气泡 (←)"}," ◀ ",8,vb),e("span",fb,[a[25]||(a[25]=Oe(" 气泡 ",-1)),e("span",pb,pe(t.selectedBubbleIndex>=0?t.selectedBubbleIndex+1:0),1),a[26]||(a[26]=Oe(" / ",-1)),e("span",mb,pe(t.bubbleCount),1)]),e("button",{id:"nextBubbleBtn",class:"nav-btn",disabled:!t.hasBubbles||t.selectedBubbleIndex>=t.bubbleCount-1,onClick:a[5]||(a[5]=o=>n.$emit("select-next-bubble")),title:"下一个气泡 (→)"}," ▶ ",8,hb)]),a[31]||(a[31]=e("div",{class:"toolbar-divider"},null,-1)),e("div",yb,[e("button",{class:"layout-toggle-btn",onClick:a[6]||(a[6]=o=>n.$emit("toggle-layout")),title:"切换布局：左右/上下"},[t.layoutMode==="horizontal"?(P(),U("svg",xb,[...a[27]||(a[27]=[e("rect",{x:"1",y:"2",width:"8",height:"16",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"},null,-1),e("rect",{x:"11",y:"2",width:"8",height:"16",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"},null,-1)])])):(P(),U("svg",kb,[...a[28]||(a[28]=[e("rect",{x:"2",y:"1",width:"16",height:"8",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"},null,-1),e("rect",{x:"2",y:"11",width:"16",height:"8",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"},null,-1)])]))]),e("button",{class:"view-mode-btn",onClick:a[7]||(a[7]=o=>n.$emit("toggle-view-mode")),title:"切换视图模式"},[...a[29]||(a[29]=[e("span",{class:"dual-icon"},"⧉",-1)])]),e("button",{class:Le({active:t.syncEnabled}),onClick:a[8]||(a[8]=o=>n.$emit("toggle-sync")),title:"同步缩放/拖动",style:{"font-size":"12px"}}," 🔗 ",2),e("button",{onClick:a[9]||(a[9]=o=>n.$emit("fit-to-screen")),title:"适应屏幕 (双击)"},"⛶"),e("button",{onClick:a[10]||(a[10]=o=>n.$emit("zoom-in")),title:"放大 (+)"},"+"),e("span",Sb,pe(Math.round(t.scale*100))+"%",1),e("button",{onClick:a[11]||(a[11]=o=>n.$emit("zoom-out")),title:"缩小 (-)"},"−"),e("button",{onClick:a[12]||(a[12]=o=>n.$emit("reset-zoom")),title:"原始大小"},"1:1")]),a[32]||(a[32]=e("div",{class:"toolbar-spacer"},null,-1)),e("button",{class:"secondary-btn",onClick:a[13]||(a[13]=o=>n.$emit("exit-edit-mode"))},"退出编辑")]),e("div",Cb,[e("div",wb,[e("button",{class:"annotation-btn detect-btn",onClick:a[14]||(a[14]=o=>n.$emit("auto-detect-bubbles")),title:"自动检测当前图片的文本框"},[...a[33]||(a[33]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("circle",{cx:"6",cy:"6",r:"4",fill:"none",stroke:"currentColor","stroke-width":"1.5"}),e("path",{d:"M9 9l4 4",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round"})],-1),e("span",null,"检测",-1)])]),e("button",{class:"annotation-btn detect-btn",onClick:a[15]||(a[15]=o=>n.$emit("detect-all-images")),title:"批量检测所有图片"},[...a[34]||(a[34]=[Zt('<svg viewBox="0 0 16 16" width="14" height="14" data-v-5ce2e8b4><circle cx="5" cy="5" r="2.5" fill="none" stroke="currentColor" stroke-width="1" data-v-5ce2e8b4></circle><path d="M7 7l2 2" stroke="currentColor" stroke-width="1" stroke-linecap="round" data-v-5ce2e8b4></path><circle cx="10" cy="10" r="2.5" fill="none" stroke="currentColor" stroke-width="1" data-v-5ce2e8b4></circle><path d="M12 12l2 2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" data-v-5ce2e8b4></path></svg><span data-v-5ce2e8b4>批量检测</span>',2)])]),e("button",{class:"annotation-btn primary-action-btn",onClick:a[16]||(a[16]=o=>n.$emit("translate-with-bubbles")),title:"使用当前文本框翻译此图片"},[...a[35]||(a[35]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("path",{d:"M2 3h5M4.5 3v7M2 6h5",stroke:"currentColor","stroke-width":"1.2",fill:"none"}),e("path",{d:"M9 13l2-7 2 7M9.5 11h3",stroke:"currentColor","stroke-width":"1.2",fill:"none"})],-1),e("span",null,"翻译",-1)])]),a[41]||(a[41]=e("div",{class:"toolbar-divider"},null,-1)),e("button",{class:Le(["annotation-btn",{active:t.isDrawingMode}]),onClick:a[17]||(a[17]=o=>n.$emit("toggle-drawing-mode")),title:"添加气泡框（或中键拖拽绘制）"},[...a[36]||(a[36]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("rect",{x:"3",y:"3",width:"10",height:"10",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"}),e("path",{d:"M8 5v6M5 8h6",stroke:"currentColor","stroke-width":"1.5"})],-1),e("span",null,"添加",-1)])],2),e("button",{class:"annotation-btn",disabled:!t.hasSelection,onClick:a[18]||(a[18]=o=>n.$emit("delete-selected-bubbles")),title:"删除选中气泡框 (Delete)"},[...a[37]||(a[37]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("rect",{x:"3",y:"3",width:"10",height:"10",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"}),e("path",{d:"M5 8h6",stroke:"currentColor","stroke-width":"1.5"})],-1),e("span",null,"删除",-1)])],8,_b),e("button",{class:"annotation-btn",disabled:!t.hasSelection,onClick:a[19]||(a[19]=o=>n.$emit("repair-selected-bubble")),title:"修复选中气泡背景 (R)"},[...a[38]||(a[38]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("path",{d:"M2 14l3-3m0 0l6-6 3 3-6 6m-3 0l-1 1 1-1z",fill:"none",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round"}),e("path",{d:"M11 5l-1-1 2-2 2 2-2 2-1-1z",fill:"currentColor"})],-1),e("span",null,"修复",-1)])],8,$b),a[42]||(a[42]=e("div",{class:"toolbar-divider"},null,-1)),e("button",{class:Le(["annotation-btn brush-btn",{active:t.brushMode==="repair"}]),onClick:a[20]||(a[20]=o=>n.$emit("activate-repair-brush")),title:"修复笔刷 (按住R+左键拖拽)"},[...a[39]||(a[39]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("circle",{cx:"8",cy:"8",r:"5",fill:"none",stroke:"currentColor","stroke-width":"1.5"}),e("circle",{cx:"8",cy:"8",r:"2",fill:"currentColor"})],-1),e("span",null,"修复笔刷",-1)])],2),e("button",{class:Le(["annotation-btn brush-btn",{active:t.brushMode==="restore"}]),onClick:a[21]||(a[21]=o=>n.$emit("activate-restore-brush")),title:"还原笔刷 (按住U+左键拖拽)"},[...a[40]||(a[40]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("circle",{cx:"8",cy:"8",r:"5",fill:"none",stroke:"currentColor","stroke-width":"1.5"}),e("path",{d:"M5 8h6M8 5v6",stroke:"currentColor","stroke-width":"1",transform:"rotate(45 8 8)"})],-1),e("span",null,"还原笔刷",-1)])],2),t.brushMode?(P(),U("span",Ib," 笔刷: "+pe(t.brushSize)+"px ",1)):we("",!0),a[43]||(a[43]=Zt('<div class="help-tooltip-container" data-v-5ce2e8b4><button class="help-tooltip-btn" title="快捷键操作帮助" data-v-5ce2e8b4><svg viewBox="0 0 16 16" width="14" height="14" data-v-5ce2e8b4><circle cx="8" cy="8" r="6.5" fill="none" stroke="currentColor" stroke-width="1.2" data-v-5ce2e8b4></circle><text x="8" y="11" text-anchor="middle" font-size="9" font-weight="bold" fill="currentColor" data-v-5ce2e8b4>?</text></svg><span class="help-btn-text" data-v-5ce2e8b4>快捷键</span></button><div class="help-tooltip-popup" data-v-5ce2e8b4><div class="help-section" data-v-5ce2e8b4><div class="help-title" data-v-5ce2e8b4>🖱️ 鼠标操作</div><div class="help-item" data-v-5ce2e8b4><span class="help-key" data-v-5ce2e8b4>左键点击气泡</span><span class="help-desc" data-v-5ce2e8b4>选择气泡</span></div><div class="help-item" data-v-5ce2e8b4><span class="help-key" data-v-5ce2e8b4>Shift+左键点击</span><span class="help-desc" data-v-5ce2e8b4>多选气泡</span></div><div class="help-item" data-v-5ce2e8b4><span class="help-key" data-v-5ce2e8b4>左键拖拽四角/边</span><span class="help-desc" data-v-5ce2e8b4>调整大小</span></div><div class="help-item" data-v-5ce2e8b4><span class="help-key" data-v-5ce2e8b4>左键拖拽框内部</span><span class="help-desc" data-v-5ce2e8b4>移动气泡框</span></div><div class="help-item" data-v-5ce2e8b4><span class="help-key" data-v-5ce2e8b4>中键拖拽</span><span class="help-desc" data-v-5ce2e8b4>绘制新气泡框</span></div></div><div class="help-section" data-v-5ce2e8b4><div class="help-title" data-v-5ce2e8b4>⌨️ 快捷键</div><div class="help-item" data-v-5ce2e8b4><span class="help-key" data-v-5ce2e8b4>A / D</span><span class="help-desc" data-v-5ce2e8b4>切换上/下一张图片</span></div><div class="help-item" data-v-5ce2e8b4><span class="help-key" data-v-5ce2e8b4>Ctrl+Enter</span><span class="help-desc" data-v-5ce2e8b4>应用并跳转下一张</span></div><div class="help-item" data-v-5ce2e8b4><span class="help-key" data-v-5ce2e8b4>Delete / Backspace</span><span class="help-desc" data-v-5ce2e8b4>删除选中气泡</span></div><div class="help-item" data-v-5ce2e8b4><span class="help-key" data-v-5ce2e8b4>按住R+左键拖拽</span><span class="help-desc" data-v-5ce2e8b4>修复笔刷</span></div><div class="help-item" data-v-5ce2e8b4><span class="help-key" data-v-5ce2e8b4>按住U+左键拖拽</span><span class="help-desc" data-v-5ce2e8b4>还原笔刷</span></div><div class="help-item" data-v-5ce2e8b4><span class="help-key" data-v-5ce2e8b4>笔刷模式下滚轮</span><span class="help-desc" data-v-5ce2e8b4>调整笔刷大小</span></div></div></div></div>',1))]),t.brushMode?(P(),U("div",{key:0,class:"brush-cursor",style:tt(i.value)},null,4)):we("",!0),t.brushMode?(P(),U("div",Tb,pe(t.brushMode==="repair"?"修复笔刷 (R)":"还原笔刷 (U)")+" - 滚轮调整大小 ",1)):we("",!0),a[44]||(a[44]=e("div",{class:"toolbar-spacer"},null,-1)),t.isProcessing?(P(),U("div",Db,[e("div",Rb,[e("span",Mb,pe(t.progressText),1),e("span",Bb,pe(t.progressCurrent)+"/"+pe(t.progressTotal),1)]),e("div",Eb,[e("div",{class:"edit-progress-fill",style:tt({width:l.value+"%"})},null,4)])])):we("",!0),a[45]||(a[45]=e("div",{class:"toolbar-spacer"},null,-1)),e("div",Pb,[e("button",{class:"primary-btn",onClick:a[22]||(a[22]=o=>n.$emit("apply-and-next")),title:"应用更改并跳转下一张 (Ctrl+Enter)"}," 应用并下一张 ")])])]))}}),Fb=Xe(Ab,[["__scopeId","data-v-5ce2e8b4"]]),Lb={key:0,class:"edit-thumbnails-panel"},Ob={class:"thumbnails-scroll"},Ub=["onClick"],zb=["src","alt"],Vb={class:"thumb-index"},Nb=Je({__name:"EditThumbnailPanel",props:{visible:{type:Boolean},images:{},currentImageIndex:{}},emits:["switch-to-image"],setup(t){return(u,l)=>t.visible?(P(),U("div",Lb,[e("div",Ob,[(P(!0),U(Ke,null,je(t.images,(i,n)=>(P(),U("div",{key:i.id,class:Le(["edit-thumbnail-item",{active:n===t.currentImageIndex}]),onClick:a=>u.$emit("switch-to-image",n)},[e("img",{src:i.translatedDataURL||i.originalDataURL,alt:`图片 ${n+1}`},null,8,zb),e("span",Vb,pe(n+1),1)],10,Ub))),128))])])):we("",!0)}}),Wb=Xe(Nb,[["__scopeId","data-v-9d2a43d9"]]),Kb={class:"edit-main-layout"},qb={class:"image-comparison-container"},Hb={class:"panel-header"},Yb=["src"],Xb={class:"panel-header"},Jb=["src"],jb=Je({__name:"EditWorkspace",props:{isEditModeActive:{type:Boolean}},emits:["exit","reRender"],setup(t,{emit:u}){const l=t,i=u,n=ot(),a=dt(),{translateWithCurrentBubbles:o}=cn(),{reRenderFullImage:S}=Yd({onRenderStart:()=>console.log("开始重新渲染..."),onRenderSuccess:Q=>console.log("渲染成功:",Q.substring(0,50)+"..."),onRenderError:Q=>console.error("渲染失败:",Q)}),{isDrawingMode:y,isDrawingBox:C,currentDrawingRect:b,isMiddleButtonDown:I,handleBubbleSelect:R,handleBubbleMultiSelect:E,handleClearMultiSelect:g,handleBubbleDragStart:d,handleBubbleDragging:Y,handleBubbleDragEnd:q,handleBubbleResizeStart:te,handleBubbleResizing:M,handleBubbleResizeEnd:w,handleBubbleRotateStart:Z,handleBubbleRotating:z,handleBubbleRotateEnd:re,toggleDrawingMode:G,handleDrawBubble:A,getDrawingRectStyle:c,handleBubbleUpdate:T,deleteSelectedBubbles:ne,repairSelectedBubble:m,handleOcrRecognize:V,handleInpaintBubble:J}=Hd({onReRender:()=>S(),onDelayedPreview:()=>S()}),le=h(0),s=h(0),{brushMode:p,brushSize:x,mouseX:oe,mouseY:me,isBrushKeyDown:ue,toggleBrushMode:Se,startBrushPainting:K,continueBrushPainting:k,finishBrushPainting:de,adjustBrushSize:H}=qd({onBrushComplete:()=>S()}),{images:_,currentImageIndex:D,currentImage:$,imageCount:r,canGoPrevious:v,canGoNext:W}=yt(n),{bubbles:ge,selectedIndex:N,selectedIndices:O,selectedBubble:f,bubbleCount:B,hasBubbles:j,hasSelection:ee}=yt(a),be=X(()=>se.value?.querySelector("img")?.naturalWidth||2e3),F=X(()=>se.value?.querySelector("img")?.naturalHeight||2e3),ae=h(null),ve=h(null),se=h(null),Pe=h(null),Ee=h(null),Ce=h(null),ke=h("dual"),he=h("horizontal"),Ae=h(!1),$e=h(!0),Ue=h(!1),Ie=h(!1),De=h(!1),L=h("处理中..."),fe=h(0),Me=h(0),{scale:xe,translateX:Fe,translateY:ut,isDragging:bt,zoomIn:vt,zoomOut:ft,resetZoom:dn,zoomAt:jn,setTransform:gn,startDrag:Gn,drag:Zn,endDrag:Qn}=Kd(),eo=X(()=>({transform:`translate(${Fe.value}px, ${ut.value}px) scale(${xe.value})`})),to=X(()=>({transform:`translate(${Fe.value}px, ${ut.value}px) scale(${xe.value})`})),Bt=h(!1),no=h(0),Et=h(!1),Ct=h({x:0,y:0,size:0});function Pt(){v.value&&(wt(),n.goToPrevious(),mt())}function _t(){W.value&&(wt(),n.goToNext(),mt())}function oo(Q){Q!==D.value&&Q>=0&&Q<r.value&&(wt(),n.setCurrentImageIndex(Q),mt())}function wt(){$.value&&ge.value.length>0&&(n.updateCurrentBubbleStates([...ge.value]),console.log("已保存气泡状态到当前图片"))}function mt(){$.value?.bubbleStates?(a.setBubbles([...$.value.bubbleStates],!0),console.log(`已加载 ${$.value.bubbleStates.length} 个气泡状态`)):a.clearBubbles(),st(()=>{pt()})}function bn(){a.selectPrevious(),fn()}function vn(){a.selectNext(),fn()}function fn(){if(f.value){const Q=f.value.coords,ye=(Q[0]+Q[2])/2,_e=(Q[1]+Q[3])/2,qe=Pe.value;if(qe){const ze=qe.getBoundingClientRect(),He=ze.width/2-ye*xe.value,Ve=ze.height/2-_e*xe.value;gn({scale:xe.value,translateX:He,translateY:Ve})}}}function ao(){Ae.value=!Ae.value}function so(){he.value=he.value==="horizontal"?"vertical":"horizontal";try{localStorage.setItem(Mn,he.value)}catch(Q){console.warn("保存布局模式失败:",Q)}}function lo(){const Q=["dual","original","translated"],ye=Q.indexOf(ke.value),_e=Q[(ye+1)%Q.length];_e&&(ke.value=_e)}function io(){$e.value=!$e.value,console.log("双图同步:",$e.value?"开启":"关闭")}function pt(){const Q=Pe.value||ve.value,ye=Ee.value||se.value;if(!Q||!ye)return;const _e=ye.querySelector("img");if(!_e||!_e.naturalWidth)return;const qe=Q.getBoundingClientRect(),ze=qe.width/_e.naturalWidth,He=qe.height/_e.naturalHeight,Ve=Math.min(ze,He)*.95,et=(qe.width-_e.naturalWidth*Ve)/2,gt=(qe.height-_e.naturalHeight*Ve)/2;gn({scale:Ve,translateX:et,translateY:gt})}function pn(Q,ye){if(p.value){const Ve=Q.deltaY>0?-5:5;H(Ve);return}const _e=Q.currentTarget.getBoundingClientRect(),qe=Q.clientX-_e.left,ze=Q.clientY-_e.top,He=Q.deltaY>0?.9:1.1;jn(qe,ze,He),$e.value&&console.log("视图同步缩放:",Math.round(xe.value*100)+"%")}function mn(Q,ye){if(p.value){const _e=ye==="original"?ve.value:Pe.value;_e&&K(Q,_e);return}if(Q.button===1){I.value=!0,xn(Q),Q.preventDefault();return}if(y.value&&Q.button===0){xn(Q),Q.preventDefault();return}if(Q.button===0){if(Q.target.closest(".bubble-highlight-box"))return;Gn(Q.clientX,Q.clientY),document.addEventListener("mousemove",hn),document.addEventListener("mouseup",yn),Q.preventDefault()}}function hn(Q){bt.value&&Zn(Q.clientX,Q.clientY)}function yn(){Qn(),document.removeEventListener("mousemove",hn),document.removeEventListener("mouseup",yn)}function xn(Q){const ye=Ee.value||se.value;if(!ye)return;const _e=ye.getBoundingClientRect(),qe=(Q.clientX-_e.left)/xe.value,ze=(Q.clientY-_e.top)/xe.value;le.value=qe,s.value=ze,C.value=!0,b.value=[qe,ze,qe,ze],document.addEventListener("mousemove",At),document.addEventListener("mouseup",Ft)}function At(Q){if(!C.value)return;const ye=Ee.value||se.value;if(!ye)return;const _e=ye.getBoundingClientRect(),qe=(Q.clientX-_e.left)/xe.value,ze=(Q.clientY-_e.top)/xe.value;b.value=[Math.min(le.value,qe),Math.min(s.value,ze),Math.max(le.value,qe),Math.max(s.value,ze)]}function Ft(Q){if(document.removeEventListener("mousemove",At),document.removeEventListener("mouseup",Ft),!C.value||!b.value){C.value=!1,b.value=null,I.value=!1;return}const[ye,_e,qe,ze]=b.value,He=qe-ye,Ve=ze-_e;He>10&&Ve>10&&(a.addBubble(b.value),a.selectBubble(a.bubbleCount-1),console.log("已添加新气泡:",b.value)),C.value=!1,b.value=null,I.value=!1,!I.value&&y.value&&(y.value=!1)}function kn(Q){console.log(`${Q} 图片加载完成`),xe.value===1&&Fe.value===0&&ut.value===0&&st(()=>{pt()})}function ro(){S()}function uo(Q){S()}async function co(Q){const ye=ge.value[Q];if(!ye?.originalText){console.warn("无法重新翻译：缺少气泡或原文");return}try{console.log(`开始重新翻译气泡 #${Q+1}`);const{translateSingleText:_e}=await it(async()=>{const{translateSingleText:Ve}=await Promise.resolve().then(()=>Ho);return{translateSingleText:Ve}},void 0),{useSettingsStore:qe}=await it(async()=>{const{useSettingsStore:Ve}=await import("./index.D0MSxQDE.js").then(et=>et.q);return{useSettingsStore:Ve}},__vite__mapDeps([0,1,2])),ze=qe().settings,He=await _e({text:ye.originalText,provider:ze.translation.provider,api_key:ze.translation.apiKey,model:ze.translation.modelName,custom_base_url:ze.translation.customBaseUrl,target_language:ze.targetLanguage,prompt:ze.translatePrompt});He.success&&He.data?.translated_text?(a.updateBubble(Q,{translatedText:He.data.translated_text}),console.log(`翻译成功: "${He.data.translated_text}"`),S()):console.error("翻译失败:",He.error||"未知错误")}catch(_e){console.error("翻译出错:",_e)}}async function go(){const Q=$.value;if(!Q?.originalDataURL){Re("没有有效的图片用于检测","warning");return}try{Re("正在自动检测文本框...","info");const _e=Q.originalDataURL.match(/^data:image\/[^;]+;base64,(.+)$/)?.[1]||"";if(!_e){Re("无法解析图片数据","error");return}const qe=Qe(),{textDetector:ze,boxExpand:He}=qe.settings,Ve=await en(_e,ze,{box_expand_ratio:He.ratio,box_expand_top:He.top,box_expand_bottom:He.bottom,box_expand_left:He.left,box_expand_right:He.right});if(Ve.success&&Ve.bubble_coords){n.updateCurrentImage({bubbleCoords:Ve.bubble_coords,bubbleAngles:Ve.bubble_angles||[]});const et=Ve.auto_directions||[],gt=Ve.bubble_coords.map((xt,Vt)=>{const[xo,ko,So,Co]=xt;let $t;return et[Vt]?$t=et[Vt]==="v"?"vertical":"horizontal":$t=Co-ko>So-xo?"vertical":"horizontal",{coords:xt,originalText:"",translatedText:"",textboxText:"",fontSize:24,fontFamily:"fonts/STSONG.TTF",textDirection:$t,autoTextDirection:$t,textColor:"#231816",fillColor:"#FFFFFF",strokeEnabled:!0,strokeColor:"#FFFFFF",strokeWidth:3,rotationAngle:Ve.bubble_angles?.[Vt]||0,inpaintMethod:"solid",position:{x:0,y:0},polygon:void 0}});a.setBubbles(gt),gt.length>0&&a.selectBubble(0),Re(`自动检测到 ${Ve.bubble_coords.length} 个文本框`,"success")}else Re(Ve.error||"检测失败","error")}catch(ye){console.error("自动检测失败:",ye),Re("自动检测失败","error")}}async function bo(){if(_.value.length<=1){Re("至少需要两张图片才能执行批量检测","warning");return}try{Re("开始批量检测...","info");let Q=0;for(let ye=0;ye<_.value.length;ye++){const _e=_.value[ye];if(!_e?.originalDataURL)continue;const ze=_e.originalDataURL.match(/^data:image\/[^;]+;base64,(.+)$/)?.[1]||"";if(!ze)continue;const He=Qe(),{textDetector:Ve,boxExpand:et}=He.settings,gt=await en(ze,Ve,{box_expand_ratio:et.ratio,box_expand_top:et.top,box_expand_bottom:et.bottom,box_expand_left:et.left,box_expand_right:et.right});if(gt.success&&gt.bubble_coords){const xt=_.value[ye];xt&&(xt.bubbleCoords=gt.bubble_coords,xt.bubbleAngles=gt.bubble_angles||[],Q+=gt.bubble_coords.length)}}mt(),Re(`批量检测完成，共检测到 ${Q} 个文本框`,"success")}catch(Q){console.error("批量检测失败:",Q),Re("批量检测失败","error")}}async function vo(){if(!$.value?.originalDataURL){Re("没有有效的图片用于翻译","warning");return}if(ge.value.length===0){Re("没有文本框可用于翻译，请先检测或添加文本框","warning");return}Re("正在使用当前文本框翻译...","info");try{await o()&&(Re("翻译成功！","success"),a.bubbles.length>0&&a.selectBubble(0))}catch(ye){console.error("翻译失败:",ye),Re(`翻译失败: ${ye instanceof Error?ye.message:"未知错误"}`,"error")}}function fo(){Se("repair")}function po(){Se("restore")}function Sn(Q){k(Q)}function Cn(){de()}function mo(Q){Bt.value=!0,no.value=he.value==="horizontal"?Q.clientX:Q.clientY,document.body.style.cursor=he.value==="horizontal"?"col-resize":"row-resize",document.body.style.userSelect="none",document.addEventListener("mousemove",Lt),document.addEventListener("mouseup",Ot),Q.preventDefault()}function Lt(Q){if(!Bt.value)return;const ye=ve.value?.parentElement?.parentElement;if(!ye)return;const _e=ye.getBoundingClientRect();if(he.value==="horizontal"){const qe=Q.clientX-_e.left,ze=_e.width,He=Math.max(20,Math.min(80,qe/ze*100)),Ve=ye.querySelector(".original-panel"),et=ye.querySelector(".translated-panel");Ve&&et&&(Ve.style.flex=`0 0 ${He}%`,et.style.flex=`0 0 ${100-He}%`)}else{const qe=Q.clientY-_e.top,ze=_e.height,He=Math.max(20,Math.min(80,qe/ze*100)),Ve=ye.querySelector(".original-panel"),et=ye.querySelector(".translated-panel");Ve&&et&&(Ve.style.flex=`0 0 ${He}%`,et.style.flex=`0 0 ${100-He}%`)}}function Ot(){Bt.value=!1,document.body.style.cursor="",document.body.style.userSelect="",document.removeEventListener("mousemove",Lt),document.removeEventListener("mouseup",Ot)}function ho(Q){Et.value=!0;const ye=Ce.value;ye&&(Ct.value={x:Q.clientX,y:Q.clientY,size:he.value==="horizontal"?ye.offsetWidth:ye.offsetHeight},document.body.style.cursor=he.value==="horizontal"?"ew-resize":"ns-resize",document.body.style.userSelect="none",document.addEventListener("mousemove",Ut),document.addEventListener("mouseup",zt),Q.preventDefault())}function Ut(Q){if(!(!Et.value||!Ce.value))if(he.value==="horizontal"){const ye=Ct.value.x-Q.clientX;let _e=Ct.value.size+ye;_e=Math.max(300,Math.min(window.innerWidth*.6,_e)),Ce.value.style.flex=`0 0 ${_e}px`,Ce.value.style.minWidth=`${_e}px`}else{const ye=Ct.value.y-Q.clientY;let _e=Ct.value.size+ye;_e=Math.max(200,Math.min(window.innerHeight*.5,_e)),Ce.value.style.flex=`0 0 ${_e}px`,Ce.value.style.height=`${_e}px`}}function zt(){Et.value=!1,document.body.style.cursor="",document.body.style.userSelect="",document.removeEventListener("mousemove",Ut),document.removeEventListener("mouseup",zt)}function yo(Q){const ye=Q.target;if(!(ye.tagName==="INPUT"||ye.tagName==="TEXTAREA"||ye.isContentEditable))switch(Q.key){case"Escape":$n();break;case"Delete":case"Backspace":ne(),Q.preventDefault();break;case"ArrowLeft":bn(),Q.preventDefault();break;case"ArrowRight":vn(),Q.preventDefault();break;case"PageUp":Pt(),Q.preventDefault();break;case"PageDown":_t(),Q.preventDefault();break;case"a":case"A":Pt(),Q.preventDefault();break;case"d":case"D":_t(),Q.preventDefault();break;case"+":case"=":vt(),Q.preventDefault();break;case"-":ft(),Q.preventDefault();break;case"0":dn(),Q.preventDefault();break;case"r":case"R":ue.value||(ue.value=!0,p.value="repair");break;case"u":case"U":ue.value||(ue.value=!0,p.value="restore");break;case"Enter":Q.ctrlKey&&(_n(),Q.preventDefault());break}}function wn(Q){(Q.key==="r"||Q.key==="R"||Q.key==="u"||Q.key==="U")&&(ue.value=!1,p.value=null)}function _n(){wt(),i("reRender"),_t()}function $n(){wt(),i("exit")}return rt(()=>{try{const Q=localStorage.getItem(Mn);(Q==="horizontal"||Q==="vertical")&&(he.value=Q)}catch(Q){console.warn("加载布局模式失败:",Q)}document.addEventListener("keyup",wn),document.addEventListener("mousemove",Sn),document.addEventListener("mouseup",Cn),l.isEditModeActive&&(mt(),st(()=>{pt(),ae.value?.focus()}))}),St(()=>{document.removeEventListener("keyup",wn),document.removeEventListener("mousemove",Sn),document.removeEventListener("mouseup",Cn),document.removeEventListener("mousemove",At),document.removeEventListener("mouseup",Ft),document.removeEventListener("mousemove",Lt),document.removeEventListener("mouseup",Ot),document.removeEventListener("mousemove",Ut),document.removeEventListener("mouseup",zt)}),We(()=>l.isEditModeActive,Q=>{Q&&(mt(),st(()=>{pt(),ae.value?.focus()}))}),We(D,()=>{l.isEditModeActive&&(mt(),st(()=>{pt()}))}),(Q,ye)=>t.isEditModeActive?(P(),U("div",{key:0,class:Le(["edit-workspace",[`layout-${he.value}`,{"drawing-mode":ce(y)}]]),onKeydown:yo,tabindex:"0",ref_key:"workspaceRef",ref:ae},[Te(Fb,{"current-image-index":ce(D),"image-count":ce(r),"can-go-previous":ce(v),"can-go-next":ce(W),"show-thumbnails":Ae.value,"has-bubbles":ce(j),"selected-bubble-index":ce(N),"bubble-count":ce(B),"layout-mode":he.value,"sync-enabled":$e.value,scale:ce(xe),"is-drawing-mode":ce(y),"has-selection":ce(ee),"brush-mode":ce(p),"brush-size":ce(x),"mouse-x":ce(oe),"mouse-y":ce(me),"is-processing":De.value,"progress-text":L.value,"progress-current":fe.value,"progress-total":Me.value,onGoPreviousImage:Pt,onGoNextImage:_t,onToggleThumbnails:ao,onSelectPreviousBubble:bn,onSelectNextBubble:vn,onToggleLayout:so,onToggleViewMode:lo,onToggleSync:io,onFitToScreen:pt,onZoomIn:ce(vt),onZoomOut:ce(ft),onResetZoom:ce(dn),onExitEditMode:$n,onAutoDetectBubbles:go,onDetectAllImages:bo,onTranslateWithBubbles:vo,onToggleDrawingMode:ce(G),onDeleteSelectedBubbles:ce(ne),onRepairSelectedBubble:ce(m),onActivateRepairBrush:fo,onActivateRestoreBrush:po,onApplyAndNext:_n},null,8,["current-image-index","image-count","can-go-previous","can-go-next","show-thumbnails","has-bubbles","selected-bubble-index","bubble-count","layout-mode","sync-enabled","scale","is-drawing-mode","has-selection","brush-mode","brush-size","mouse-x","mouse-y","is-processing","progress-text","progress-current","progress-total","onZoomIn","onZoomOut","onResetZoom","onToggleDrawingMode","onDeleteSelectedBubbles","onRepairSelectedBubble"]),Te(Wb,{visible:Ae.value,images:ce(_),"current-image-index":ce(D),onSwitchToImage:oo},null,8,["visible","images","current-image-index"]),e("div",Kb,[e("div",qb,[ie(e("div",{class:Le(["image-panel original-panel",{collapsed:ke.value==="translated"||Ue.value}])},[e("div",Hb,[ye[8]||(ye[8]=e("span",{class:"panel-title"},"📖 原图 (日文)",-1)),e("button",{class:"panel-toggle",onClick:ye[0]||(ye[0]=_e=>Ue.value=!Ue.value),title:"折叠/展开"},pe(Ue.value?"+":"−"),1)]),e("div",{ref_key:"originalViewportRef",ref:ve,class:"image-viewport",onWheel:ye[2]||(ye[2]=at(_e=>pn(_e),["prevent"])),onMousedown:ye[3]||(ye[3]=_e=>mn(_e,"original")),onDblclick:pt},[e("div",{ref_key:"originalWrapperRef",ref:se,class:"image-canvas-wrapper",style:tt(eo.value)},[ce($)?.originalDataURL?(P(),U("img",{key:0,src:ce($).originalDataURL,alt:"原图",onLoad:ye[1]||(ye[1]=_e=>kn("original"))},null,40,Yb)):we("",!0),ce($)?.originalDataURL?(P(),lt(Ln,{key:1,bubbles:ce(ge),"selected-index":ce(N),"selected-indices":ce(O),scale:ce(xe),"is-drawing-mode":ce(y),"image-width":be.value,"image-height":F.value,onSelect:ce(R),onMultiSelect:ce(E),onDragStart:ce(d),onDragging:ce(Y),onDragEnd:ce(q),onResizeStart:ce(te),onResizing:ce(M),onResizeEnd:ce(w),onRotateStart:ce(Z),onRotating:ce(z),onRotateEnd:ce(re),onDrawBubble:ce(A),onClearMultiSelect:ce(g)},null,8,["bubbles","selected-index","selected-indices","scale","is-drawing-mode","image-width","image-height","onSelect","onMultiSelect","onDragStart","onDragging","onDragEnd","onResizeStart","onResizing","onResizeEnd","onRotateStart","onRotating","onRotateEnd","onDrawBubble","onClearMultiSelect"])):we("",!0),ce(b)?(P(),U("div",{key:2,class:"drawing-rect-edit",style:tt(ce(c)())},null,4)):we("",!0)],4)],544)],2),[[Ye,ke.value!=="translated"]]),ke.value==="dual"?(P(),U("div",{key:0,ref:"panelDividerRef",class:Le(["panel-divider",{"vertical-divider":he.value==="vertical"}]),onMousedown:mo},null,34)):we("",!0),ie(e("div",{class:Le(["image-panel translated-panel",{collapsed:ke.value==="original"||Ie.value}])},[e("div",Xb,[ye[9]||(ye[9]=e("span",{class:"panel-title"},"📝 翻译图 (中文)",-1)),e("button",{class:"panel-toggle",onClick:ye[4]||(ye[4]=_e=>Ie.value=!Ie.value),title:"折叠/展开"},pe(Ie.value?"+":"−"),1)]),e("div",{ref_key:"translatedViewportRef",ref:Pe,class:"image-viewport",onWheel:ye[6]||(ye[6]=at(_e=>pn(_e),["prevent"])),onMousedown:ye[7]||(ye[7]=_e=>mn(_e,"translated")),onDblclick:pt},[e("div",{ref_key:"translatedWrapperRef",ref:Ee,class:"image-canvas-wrapper",style:tt(to.value)},[ce($)?.translatedDataURL||ce($)?.originalDataURL?(P(),U("img",{key:0,src:ce($)?.translatedDataURL||ce($)?.originalDataURL,alt:"翻译图",onLoad:ye[5]||(ye[5]=_e=>kn("translated"))},null,40,Jb)):we("",!0),ce($)?.translatedDataURL||ce($)?.originalDataURL?(P(),lt(Ln,{key:1,bubbles:ce(ge),"selected-index":ce(N),"selected-indices":ce(O),scale:ce(xe),"is-drawing-mode":ce(y),"image-width":be.value,"image-height":F.value,onSelect:ce(R),onMultiSelect:ce(E),onDragStart:ce(d),onDragging:ce(Y),onDragEnd:ce(q),onResizeStart:ce(te),onResizing:ce(M),onResizeEnd:ce(w),onRotateStart:ce(Z),onRotating:ce(z),onRotateEnd:ce(re),onDrawBubble:ce(A),onClearMultiSelect:ce(g)},null,8,["bubbles","selected-index","selected-indices","scale","is-drawing-mode","image-width","image-height","onSelect","onMultiSelect","onDragStart","onDragging","onDragEnd","onResizeStart","onResizing","onResizeEnd","onRotateStart","onRotating","onRotateEnd","onDrawBubble","onClearMultiSelect"])):we("",!0),ce(b)?(P(),U("div",{key:2,class:"drawing-rect-edit",style:tt(ce(c)())},null,4)):we("",!0)],4)],544)],2),[[Ye,ke.value!=="original"]])]),e("div",{ref_key:"editPanelRef",ref:Ce,class:"edit-panel-container"},[e("div",{ref:"editPanelResizerRef",class:"panel-resize-handle vertical",onMousedown:ho}," ⋮⋮⋮ ",544),Te(ib,{bubble:ce(f),"bubble-index":ce(N),"has-selection":ce(ee),onUpdate:ce(T),onReRender:ro,onOcrRecognize:ce(V),onInpaintBubble:ce(J),onReTranslate:co,onApplyBubble:uo},null,8,["bubble","bubble-index","has-selection","onUpdate","onOcrRecognize","onInpaintBubble"])],512)])],34)):we("",!0)}}),Gb=Xe(jb,[["__scopeId","data-v-a4d3c884"]]),Zb={class:"app-header"},Qb={class:"header-content"},ev={class:"logo-container"},tv={class:"header-links"},nv={class:"container"},ov={id:"image-display-area"},av={id:"upload-section",class:"card upload-card"},sv={key:1,class:"bookshelf-mode-hint"},lv=Je({__name:"TranslateView",setup(t){const u=zn();Do();const l=ot(),i=Qe(),n=Hn(),a=dt(),{validateBeforeTranslation:o,initValidation:S}=Jn(),y=cn();Xn();const C=il(),b=h(!1),I=h(!1),R=h(!1),E=h(!1),g=h(""),d=h(""),Y=h(null),q=h(null),te=X(()=>l.currentImage),M=X(()=>l.hasImages);X(()=>l.imageCount),X(()=>l.currentImageIndex+1),X(()=>M.value&&!l.isBatchTranslationInProgress),X(()=>l.canGoPrevious),X(()=>l.canGoNext);const w=X(()=>l.isBatchTranslationInProgress),Z=X(()=>l.isBatchTranslationPaused),z=X(()=>w.value&&!y.isHqTranslating.value&&!y.isProofreading.value);X(()=>{if(!w.value)return 0;const F=l.completedImageCount,ae=l.imageCount;return ae>0?Math.round(F/ae*100):0}),X(()=>`${l.completedImageCount}/${l.imageCount}`);const re=X(()=>l.failedImageCount>0),G=X(()=>!!u.query.book&&!!u.query.chapter),A=X(()=>u.query.book),c=X(()=>u.query.chapter),T=X(()=>C.currentBookTitle.value),ne=X(()=>C.currentChapterTitle.value),m=X(()=>G.value&&ne.value&&T.value?`${ne.value} - ${T.value}`:"Saber-Translator");rt(async()=>{u.query.book&&u.query.chapter&&(l.clearImages(),a.clearBubbles()),await C.initializeApp(),S(),window.addEventListener("keydown",j)}),St(()=>{window.removeEventListener("keydown",j)}),We(()=>[u.query.book,u.query.chapter],async([F,ae])=>{F&&ae&&(l.clearImages(),a.clearBubbles(),await V())}),We(m,F=>{typeof document<"u"&&(document.title=F)},{immediate:!0});async function V(){if(!(!A.value||!c.value))try{E.value=!0,g.value="正在加载章节会话...",await C.initializeBookChapterContext()}catch(F){console.error("加载章节会话失败:",F),Re("加载章节会话失败","error")}finally{E.value=!1,g.value=""}}function J(){E.value=!0,g.value="正在处理图片...",d.value=""}function le(F){E.value=!1,g.value="",console.log(`上传完成，共 ${F} 张图片`)}function s(F){E.value=!1,g.value="",d.value=F}async function p(F){if(!M.value){Re("没有可应用的图片","warning");return}if(!Object.values(F).some(ve=>ve)){Re("请至少选择一个要应用的设置项","warning");return}try{E.value=!0;const ve=i.textStyle,se={};F.fontSize&&(se.fontSize=ve.fontSize),F.fontFamily&&(se.fontFamily=ve.fontFamily),F.layoutDirection&&(se.textDirection=ve.layoutDirection),F.textColor&&(se.textColor=ve.textColor),F.fillColor&&(se.fillColor=ve.fillColor),F.strokeEnabled&&(se.strokeEnabled=ve.strokeEnabled),F.strokeColor&&(se.strokeColor=ve.strokeColor),F.strokeWidth&&(se.strokeWidth=ve.strokeWidth);let Pe=0;const Ee=l.images;for(let he=0;he<Ee.length;he++){const Ae=Ee[he];if(Ae&&Ae.bubbleStates&&Ae.bubbleStates.length>0){const $e=Ae.bubbleStates.map(Ue=>{const Ie={...Ue};return F.fontSize&&se.fontSize!==void 0&&(Ie.fontSize=se.fontSize),F.fontFamily&&se.fontFamily!==void 0&&(Ie.fontFamily=se.fontFamily),F.layoutDirection&&se.textDirection!==void 0&&(Ie.textDirection=se.textDirection),F.textColor&&se.textColor!==void 0&&(Ie.textColor=se.textColor),F.fillColor&&se.fillColor!==void 0&&(Ie.fillColor=se.fillColor),F.strokeEnabled&&se.strokeEnabled!==void 0&&(Ie.strokeEnabled=se.strokeEnabled),F.strokeColor&&se.strokeColor!==void 0&&(Ie.strokeColor=se.strokeColor),F.strokeWidth&&se.strokeWidth!==void 0&&(Ie.strokeWidth=se.strokeWidth),Ie});l.updateImageByIndex(he,{bubbleStates:$e}),Pe++}}if(a.bubbles.length>0){const he=a.bubbles.map(Ae=>{const $e={...Ae};return F.fontSize&&se.fontSize!==void 0&&($e.fontSize=se.fontSize),F.fontFamily&&se.fontFamily!==void 0&&($e.fontFamily=se.fontFamily),F.layoutDirection&&se.textDirection!==void 0&&($e.textDirection=se.textDirection),F.textColor&&se.textColor!==void 0&&($e.textColor=se.textColor),F.fillColor&&se.fillColor!==void 0&&($e.fillColor=se.fillColor),F.strokeEnabled&&se.strokeEnabled!==void 0&&($e.strokeEnabled=se.strokeEnabled),F.strokeColor&&se.strokeColor!==void 0&&($e.strokeColor=se.strokeColor),F.strokeWidth&&se.strokeWidth!==void 0&&($e.strokeWidth=se.strokeWidth),$e});a.setBubbles(he)}const Ce=[];F.fontSize&&Ce.push("字号"),F.fontFamily&&Ce.push("字体"),F.layoutDirection&&Ce.push("排版方向"),F.textColor&&Ce.push("文字颜色"),F.fillColor&&Ce.push("填充颜色"),F.strokeEnabled&&Ce.push("描边开关"),F.strokeColor&&Ce.push("描边颜色"),F.strokeWidth&&Ce.push("描边宽度");const ke=[];for(let he=0;he<Ee.length;he++){const Ae=Ee[he];Ae&&Ae.cleanImageData&&Ae.bubbleStates&&Ae.bubbleStates.length>0&&ke.push(he)}if(ke.length>0){g.value=`正在渲染图片 0/${ke.length}...`;const{apiClient:he}=await it(async()=>{const{apiClient:Ue}=await import("./client.Bht704G-.js");return{apiClient:Ue}},__vite__mapDeps([4,5])),Ae=i.settings.textStyle.layoutDirection,$e=Ae==="auto";for(let Ue=0;Ue<ke.length;Ue++){const Ie=ke[Ue];if(Ie===void 0)continue;const De=l.images[Ie];if(!(!De||!De.cleanImageData||!De.bubbleStates)){g.value=`正在渲染图片 ${Ue+1}/${ke.length}...`;try{const L=Fe=>{if($e){if(Fe.autoTextDirection&&Fe.autoTextDirection!=="auto")return Fe.autoTextDirection;if(Fe.textDirection&&Fe.textDirection!=="auto")return Fe.textDirection;if(Fe.coords){const[ut,bt,vt,ft]=Fe.coords;return ft-bt>vt-ut?"vertical":"horizontal"}return"vertical"}return Ae},fe=De.bubbleStates.map(Fe=>({translatedText:Fe.translatedText||"",coords:Fe.coords,fontSize:Fe.fontSize||i.settings.textStyle.fontSize,fontFamily:Fe.fontFamily||i.settings.textStyle.fontFamily,textDirection:L(Fe),textColor:Fe.textColor||i.settings.textStyle.textColor,rotationAngle:Fe.rotationAngle||0,position:Fe.position||{x:0,y:0},strokeEnabled:Fe.strokeEnabled??i.settings.textStyle.strokeEnabled,strokeColor:Fe.strokeColor||i.settings.textStyle.strokeColor,strokeWidth:Fe.strokeWidth??i.settings.textStyle.strokeWidth}));let Me=De.cleanImageData;Me.includes("base64,")&&(Me=Me.split("base64,")[1]||"");const xe=await he.post("/api/re_render_image",{clean_image:Me,bubble_texts:fe.map(Fe=>Fe.translatedText),bubble_coords:fe.map(Fe=>Fe.coords),fontSize:i.settings.textStyle.fontSize,fontFamily:i.settings.textStyle.fontFamily,textDirection:$e?"vertical":Ae,textColor:i.settings.textStyle.textColor,bubble_states:fe,use_individual_styles:!0,use_inpainting:!1,use_lama:!1,fillColor:null,is_font_style_change:!0,strokeEnabled:i.settings.textStyle.strokeEnabled,strokeColor:i.settings.textStyle.strokeColor,strokeWidth:i.settings.textStyle.strokeWidth});xe.rendered_image&&l.updateImageByIndex(Ie,{translatedDataURL:`data:image/png;base64,${xe.rendered_image}`,hasUnsavedChanges:!0})}catch(L){console.error(`重渲染图片 ${Ie} 失败:`,L)}}}}g.value="",Re(`已将 ${Ce.join("、")} 应用到 ${Pe} 张图片`,"success"),console.log(`[TranslateView] 应用设置到全部完成，更新了 ${Pe} 张图片，重渲染了 ${ke.length} 张`)}catch(ve){console.error("应用设置到全部失败:",ve),Re("应用设置失败","error")}finally{E.value=!1}}async function x(){te.value&&o("normal")&&await y.translateCurrentImage()}async function oe(){M.value&&o("normal")&&await y.translateAllImages()}async function me(){M.value&&o("hq")&&await y.executeHqTranslation()}async function ue(){M.value&&o("proofread")&&await y.executeProofreading()}async function Se(){te.value&&await y.removeTextOnly()}async function K(){M.value&&await y.removeAllTexts()}function k(){Z.value?y.resumeBatchTranslation():y.pauseBatchTranslation()}function de(){y.cancelBatchTranslation()}function H(){if(!te.value)return;const F=te.value.fileName||`图片 ${l.currentImageIndex+1}`;confirm(`确定要删除当前图片 (${F}) 吗？`)&&(l.deleteCurrentImage(),Re("图片已删除","success"))}function _(){M.value&&confirm("确定要清除所有图片吗？这将丢失所有未保存的进度。")&&(l.clearImages(),Re("所有图片已清除","success"))}async function D(){try{E.value=!0,g.value="正在清理临时文件...";const F=await Vn(),ae=await rn();if(F.success&&ae.success)Re("临时文件清理完成","success");else{const ve=[];F.success||ve.push("调试文件清理失败"),ae.success||ve.push("临时文件清理失败"),Re(ve.join("，"),"warning")}}catch(F){console.error("清理临时文件失败:",F),Re("清理临时文件失败","error")}finally{E.value=!1,g.value=""}}function $(){C.goToPrevious()}function r(){C.goToNext()}function v(){R.value=!R.value}function W(F){a.selectBubble(F)}async function ge(){if(!re.value){Re("没有失败的图片需要重新翻译","info");return}o("normal")&&await y.retryFailedImages()}async function N(){if(!M.value){Re("没有可保存的内容","warning");return}if(!(!A.value||!c.value))try{await n.saveChapterSession(A.value,c.value)?Re("章节进度已保存","success"):Re("保存失败","error")}catch(F){console.error("保存会话失败:",F),Re("保存失败: "+(F instanceof Error?F.message:"未知错误"),"error")}}function O(){b.value=!0}function f(){Re("设置已保存","success")}function B(){I.value=!0}function j(F){if(!(F.target instanceof HTMLInputElement||F.target instanceof HTMLTextAreaElement)&&!R.value&&F.altKey)switch(F.key){case"ArrowLeft":F.preventDefault(),$();break;case"ArrowRight":F.preventDefault(),r();break;case"ArrowUp":if(F.preventDefault(),!i.settings.textStyle.autoFontSize){const ae=i.settings.textStyle.fontSize;i.updateTextStyle({fontSize:ae+1})}break;case"ArrowDown":if(F.preventDefault(),!i.settings.textStyle.autoFontSize){const ae=i.settings.textStyle.fontSize;i.updateTextStyle({fontSize:Math.max(10,ae-1)})}break}}async function ee(F,ae){const ve=te.value;if(!ve||!ve.translatedDataURL||!ve.bubbleStates||ve.bubbleStates.length===0||!["fontSize","fontFamily","layoutDirection","textColor","strokeEnabled","strokeColor","strokeWidth","fillColor"].includes(F))return;console.log(`全局设置变更 (${F}=${ae})，准备重渲染...`);const Ee={fontSize:"fontSize",fontFamily:"fontFamily",layoutDirection:"textDirection",textColor:"textColor",strokeEnabled:"strokeEnabled",strokeColor:"strokeColor",strokeWidth:"strokeWidth",fillColor:"fillColor"}[F];if(Ee&&ve.bubbleStates)if(F==="layoutDirection"&&ae==="auto")console.log("排版方向设置为 'auto'，不修改气泡的 textDirection，使用 autoTextDirection 渲染");else{const Ce=ve.bubbleStates.map(ke=>({...ke,[Ee]:ae}));l.updateCurrentImage({bubbleStates:Ce}),a.setBubbles(Ce)}try{const ke=l.currentImage?.bubbleStates||ve.bubbleStates||[];if(ke.length===0||!ke[0]?.coords){console.log("没有有效的气泡坐标，跳过重渲染");return}const he=i.settings.textStyle.layoutDirection,Ae=he==="auto",$e=(xe,Fe)=>{if(Ae){if(xe.autoTextDirection&&xe.autoTextDirection!=="auto")return xe.autoTextDirection;if(xe.textDirection&&xe.textDirection!=="auto")return xe.textDirection;if(xe.coords){const[ut,bt,vt,ft]=xe.coords;return ft-bt>vt-ut?"vertical":"horizontal"}return"vertical"}else return he},Ue=ke.map((xe,Fe)=>({translatedText:xe.translatedText||"",coords:xe.coords,fontSize:xe.fontSize||i.settings.textStyle.fontSize,fontFamily:xe.fontFamily||i.settings.textStyle.fontFamily,textDirection:$e(xe,Fe),textColor:xe.textColor||i.settings.textStyle.textColor,rotationAngle:xe.rotationAngle||0,position:xe.position||{x:0,y:0},strokeEnabled:xe.strokeEnabled??i.settings.textStyle.strokeEnabled,strokeColor:xe.strokeColor||i.settings.textStyle.strokeColor,strokeWidth:xe.strokeWidth??i.settings.textStyle.strokeWidth})),Ie=Ue.map(xe=>xe.translatedText),De=Ue.map(xe=>xe.coords);let L="";if(ve.cleanImageData){const xe=ve.cleanImageData;L=xe.includes("base64,")?xe.split("base64,")[1]||"":xe}const{apiClient:fe}=await it(async()=>{const{apiClient:xe}=await import("./client.Bht704G-.js");return{apiClient:xe}},__vite__mapDeps([4,5])),Me=await fe.post("/api/re_render_image",{clean_image:L,bubble_texts:Ie,bubble_coords:De,fontSize:i.settings.textStyle.fontSize,fontFamily:i.settings.textStyle.fontFamily,textDirection:Ae?"vertical":he,textColor:i.settings.textStyle.textColor,bubble_states:Ue,use_individual_styles:!0,use_inpainting:!1,use_lama:!1,fillColor:null,is_font_style_change:!0,strokeEnabled:i.settings.textStyle.strokeEnabled,strokeColor:i.settings.textStyle.strokeColor,strokeWidth:i.settings.textStyle.strokeWidth});Me.rendered_image?(l.updateCurrentImage({translatedDataURL:`data:image/png;base64,${Me.rendered_image}`,hasUnsavedChanges:!0}),console.log("设置变更后重新渲染成功")):Me.error&&console.error("重新渲染失败:",Me.error)}catch(Ce){console.error("设置变更后重新渲染失败:",Ce)}}function be(F){C.switchImage(F)}return(F,ae)=>{const ve=To("router-link");return P(),U("div",{class:Le(["translate-page",{"edit-mode-active":R.value}])},[e("header",Zb,[e("div",Qb,[e("div",ev,[Te(ve,{to:"/",title:"返回书架"},{default:ht(()=>[...ae[3]||(ae[3]=[e("img",{src:"/pic/logo.png",alt:"Saber-Translator Logo",class:"app-logo"},null,-1),e("span",{class:"app-name"},"Saber-Translator",-1)])]),_:1})]),e("div",tv,[ae[7]||(ae[7]=e("a",{href:"/",class:"back-to-shelf",title:"返回书架"},"📚",-1)),G.value?(P(),U("button",{key:0,class:"save-header-btn",title:"保存进度",onClick:N}," 💾 ")):we("",!0),e("button",{id:"openSettingsBtn",class:"settings-header-btn",title:"打开设置",onClick:O},[...ae[4]||(ae[4]=[e("span",{class:"icon"},"⚙️",-1),e("span",null,"设置",-1)])]),ae[8]||(ae[8]=e("a",{href:"http://www.mashirosaber.top",target:"_blank",class:"tutorial-link"},"使用教程",-1)),e("a",{href:"javascript:void(0)",class:"donate-link",onClick:B},[...ae[5]||(ae[5]=[e("span",null,"❤️ 请作者喝奶茶",-1)])]),ae[9]||(ae[9]=e("a",{href:"https://github.com/MashiroSaber03",target:"_blank",class:"github-link"},[e("img",{src:"/pic/github.jpg",alt:"GitHub",class:"github-icon"})],-1)),e("button",{class:"theme-toggle",title:"切换亮暗模式",onClick:ae[0]||(ae[0]=(...se)=>ce(i).toggleTheme&&ce(i).toggleTheme(...se))},[...ae[6]||(ae[6]=[e("span",{class:"theme-icon light-icon"},"☀️",-1),e("span",{class:"theme-icon dark-icon"},"🌙",-1)])])])])]),e("div",nv,[Te(fs,{onTranslateCurrent:x,onTranslateAll:oe,onHqTranslate:me,onProofread:ue,onRemoveText:Se,onRemoveAllText:K,onRetryFailed:ge,onDeleteCurrent:H,onClearAll:_,onCleanTemp:D,onOpenPlugins:O,onOpenSettings:O,onPrevious:$,onNext:r,onApplyToAll:p,onTextStyleChanged:ee}),e("main",ov,[e("section",av,[Te(pa,{ref_key:"imageUploadRef",ref:Y,onUploadStart:J,onUploadComplete:le,onUploadError:s},null,512),ce(n).loadingProgress.total>0?(P(),lt(un,{key:0,visible:!0,percentage:ce(n).loadingProgress.current/ce(n).loadingProgress.total*100,label:ce(n).loadingProgress.message},null,8,["percentage","label"])):we("",!0),Te(fl,{progress:ce(y).progress.value,"show-controls":z.value,onPause:k,onResume:k,onCancel:de},null,8,["progress","show-controls"]),w.value&&G.value?(P(),U("div",sv,[...ae[10]||(ae[10]=[e("span",{style:{color:"#888","font-size":"0.85em"}}," （书架模式下退出前请点击顶部保存按钮） ",-1)])])):we("",!0)]),Te(Xs,{ref_key:"imageResultRef",ref:q,"is-edit-mode":R.value,"show-highlight":ce(i).settings.showDetectionDebug,onToggleEditMode:v,onRetryFailed:ge,onSelectBubble:W},null,8,["is-edit-mode","show-highlight"])]),M.value&&!R.value?(P(),lt(Bl,{key:0,onSelect:be})):we("",!0)]),te.value&&R.value?(P(),lt(Gb,{key:0,"is-edit-mode-active":R.value,onExit:v},null,8,["is-edit-mode-active"])):we("",!0),Te(Qs,{onOpenSettings:O}),Te(Nd,{modelValue:b.value,"onUpdate:modelValue":ae[1]||(ae[1]=se=>b.value=se),onSave:f},null,8,["modelValue"]),I.value?(P(),lt(ml,{key:1,onClose:ae[2]||(ae[2]=se=>I.value=!1)})):we("",!0),Te(wl,{visible:E.value,message:g.value,fullscreen:!1},null,8,["visible","message"])],2)}}}),pv=Xe(lv,[["__scopeId","data-v-7ef9a9a2"]]);export{pv as default};
