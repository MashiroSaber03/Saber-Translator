const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["js/system.qIGXsO2R.js","js/index.Bf0F74Qu.js","js/vue-vendor.DIYfje1l.js","assets/index.BYanE9pL.css","js/client.Bht704G-.js","js/utils-vendor.B9ygI19o.js","js/session.C_VZSWrV.js"])))=>i.map(i=>d[i]);
import{D as xn,b as mo,c as vo,d as fo,e as _n,f as xt,a as rt,S as Xo,_ as He,g as ze,s as _e,u as ct,h as ds,i as gs,j as ps,k as Go,l as Zo,m as Qo,n as en,B as tn,o as on,p as ms,F as ro,q as nn,r as sn,t as vs,L as an,W as fs}from"./index.Bf0F74Qu.js";import{d as Jt,r as C,c as Z,a as je,e as A,h as de,f as e,t as oe,i as at,k as M,g as ut,n as Ie,u as me,o as dt,v as ae,x as Fe,l as Ce,s as ln,m as St,K as nt,D as H,F as Oe,j as Ye,M as bo,N as bs,L as Cn,w as Se,B as pt,O as $t,z as we,p as lt,P as go,b as Ot,Q as kt,S as rn,A as Sn,U as hs,T as kn,C as ys}from"./vue-vendor.DIYfje1l.js";import{p as xs,a as _s,b as Cs,c as Ss,d as ks,e as ws,f as $s,h as Ts,i as Is,j as Ps,k as ho,l as wn}from"./system.qIGXsO2R.js";import{getFontList as $n,uploadFont as Rs,getTextboxPrompts as Ds,getPrompts as Ms,configApi as Ke,getFontListApi as Es}from"./config.CwRcCkM9.js";import{_ as We}from"./CustomSelect.vue_vue_type_style_index_0_lang.BbTiIb--.js";import{apiClient as Xe}from"./client.Bht704G-.js";import{B as Tn}from"./BaseModal.xmzIA7sn.js";import{getBookDetail as Bs}from"./bookshelf.B4ums9uK.js";import"./utils-vendor.B9ygI19o.js";function un(){return{firecrawl:{apiKey:""},agent:{provider:"openai",apiKey:"",customBaseUrl:"",modelName:"gpt-4o-mini",useStream:!1,forceJsonOutput:!0,maxRetries:3,timeout:120},extraction:{prompt:xn,maxIterations:10},download:{concurrency:3,timeout:30,retries:3,delay:100,useReferer:!0},imagePreprocess:{enabled:!1,autoRotate:!0,compression:{enabled:!1,quality:85,maxWidth:0,maxHeight:0},formatConvert:{enabled:!1,targetFormat:"original"}},advanced:{customCookie:"",customHeaders:"",bypassProxy:!1},ui:{showAgentLogs:!0,autoImport:!1}}}function As(n,t){function s(d){n.value.firecrawl.apiKey=d,t()}function o(d){n.value.agent.provider=d,t()}function i(d){n.value.agent.apiKey=d,t()}function r(d){n.value.agent.customBaseUrl=d,t()}function a(d){n.value.agent.modelName=d,t()}function c(d){n.value.agent.useStream=d,t()}function p(d){n.value.agent.forceJsonOutput=d,t()}function k(d){n.value.agent.timeout=d,t()}function y(d){n.value.extraction.prompt=d,t()}function $(d){n.value.extraction.maxIterations=d,t()}function E(){n.value.extraction.prompt=xn,t()}function R(d){n.value.download.concurrency=d,t()}function D(d){n.value.download.timeout=d,t()}function T(d){n.value.download.retries=d,t()}function q(d){n.value.download.delay=d,t()}function V(d){n.value.download.useReferer=d,t()}function L(d){n.value.imagePreprocess.enabled=d,t()}function v(d){n.value.imagePreprocess.autoRotate=d,t()}function g(d){n.value.imagePreprocess.compression.enabled=d,t()}function x(d){n.value.imagePreprocess.compression.quality=d,t()}function _(d){n.value.imagePreprocess.compression.maxWidth=d,t()}function K(d){n.value.imagePreprocess.compression.maxHeight=d,t()}function z(d){n.value.imagePreprocess.formatConvert.enabled=d,t()}function se(d){n.value.imagePreprocess.formatConvert.targetFormat=d,t()}function X(d){n.value.advanced.customCookie=d,t()}function ie(d){n.value.advanced.customHeaders=d,t()}function U(d){n.value.advanced.bypassProxy=d,t()}function W(d){n.value.ui.showAgentLogs=d,t()}function te(d){n.value.ui.autoImport=d,t()}function B(d){n.value={...n.value,...d},t()}return{setFirecrawlApiKey:s,setAgentProvider:o,setAgentApiKey:i,setAgentBaseUrl:r,setAgentModelName:a,setAgentUseStream:c,setAgentForceJson:p,setAgentTimeout:k,setExtractionPrompt:y,setExtractionMaxIterations:$,resetExtractionPrompt:E,setDownloadConcurrency:R,setDownloadTimeout:D,setDownloadRetries:T,setDownloadDelay:q,setDownloadUseReferer:V,setImagePreprocessEnabled:L,setImageAutoRotate:v,setImageCompressionEnabled:g,setImageCompressionQuality:x,setImageMaxWidth:_,setImageMaxHeight:K,setImageFormatConvertEnabled:z,setImageTargetFormat:se,setCustomCookie:X,setCustomHeaders:ie,setBypassProxy:U,setShowAgentLogs:W,setAutoImport:te,updateWebImportSettings:B}}async function yo(n){return Xe.post("/api/re_render_image",n)}async function Ls(n){try{return{success:!0,data:await Xe.post("/api/translate_single_text",n)}}catch(t){return{success:!1,error:t instanceof Error?t.message:"ç¿»è¯‘å¤±è´¥"}}}async function At(n){return Xe.post("/api/hq_translate_batch",n)}async function po(n,t,s){return Xe.post("/api/detect_boxes",{image:n,detector_type:t,...s})}async function In(n,t,s,o){return Xe.post("/api/ocr_single_bubble",{image_data:n,bubble_coords:t,ocr_engine:s,...o})}async function xo(n,t,s){return Xe.post("/api/inpaint_single_bubble",{image_data:n,bubble_coords:t,bubble_angle:s?.bubbleAngle??0,method:s?.method??"lama",lama_model:s?.lamaModel??"lama_mpe",...s?.maskData&&{mask_data:s.maskData}})}const Fs=Object.freeze(Object.defineProperty({__proto__:null,detectBoxes:po,hqTranslateBatch:At,inpaintSingleBubble:xo,ocrSingleBubble:In,reRenderImage:yo,translateSingleText:Ls},Symbol.toStringTag,{value:"Module"}));async function Pn(n,t){return Xe.post(`/api/sessions/meta/${n}`,t)}async function Ht(n,t,s,o){return Xe.post(`/api/sessions/page/${n}/${t}/${s}`,{data:o})}async function Rn(n,t,s){return Xe.post(`/api/sessions/page/${n}/${t}/meta`,s)}async function Dn(n,t,s){return Xe.post(`/api/sessions/save_translated/${n}/${t}`,s)}function jt(n){if(!n||typeof n!="string"||n.startsWith("/api/"))return null;if(n.startsWith("data:")){const t=n.split(",");return t.length>1?t[1]??null:null}return n}async function Us(n,t,s){const o=t.length;let i=0;for(let r=0;r<o;r++){const a=t[r];if(a){s?.onProgress?.(r+1,o);try{const c=jt(a.originalDataURL);c&&await Ht(n,r,"original",c);const p=jt(a.translatedDataURL);p&&await Ht(n,r,"translated",p);const k=jt(a.cleanImageData);k&&await Ht(n,r,"clean",k);const y={fileName:a.fileName,translationStatus:a.translationStatus,translationFailed:a.translationFailed,bubbleStates:a.bubbleStates,isManuallyAnnotated:a.isManuallyAnnotated,relativePath:a.relativePath,folderPath:a.folderPath,fontSize:a.fontSize,autoFontSize:a.autoFontSize,fontFamily:a.fontFamily,layoutDirection:a.layoutDirection,useAutoTextColor:a.useAutoTextColor,textColor:a.textColor,fillColor:a.fillColor,inpaintMethod:a.inpaintMethod,strokeEnabled:a.strokeEnabled,strokeColor:a.strokeColor,strokeWidth:a.strokeWidth};await Rn(n,r,y),i++}catch(c){console.error(`ä¿å­˜ç¬¬ ${r+1} é¡µå¤±è´¥:`,c)}}}return i}const Mn=Object.freeze(Object.defineProperty({__proto__:null,extractBase64:jt,saveAllPagesSequentially:Us,savePageImage:Ht,savePageMeta:Rn,saveSessionMeta:Pn,saveTranslatedPage:Dn},Symbol.toStringTag,{value:"Module"}));async function Os(){return Xe.get("/api/plugins")}async function zs(n){const t=encodeURIComponent(n);return Xe.post(`/api/plugins/${t}/enable`)}async function Ns(n){const t=encodeURIComponent(n);return Xe.post(`/api/plugins/${t}/disable`)}async function Vs(n){const t=encodeURIComponent(n);return Xe.delete(`/api/plugins/${t}`)}async function Ws(n){const t=encodeURIComponent(n);return Xe.get(`/api/plugins/${t}/config_schema`)}async function Ks(n){const t=encodeURIComponent(n);return Xe.get(`/api/plugins/${t}/config`)}async function qs(n,t){const s=encodeURIComponent(n);return Xe.post(`/api/plugins/${s}/config`,t)}async function Hs(){return Xe.get("/api/plugins/default_states")}async function js(n,t){const s=encodeURIComponent(n);return Xe.post(`/api/plugins/${s}/set_default_state`,{enabled:t})}async function Js(){return{states:(await Hs()).default_states}}const Ys=js,Xs=Ws,Gs=Ks,Zs=qs;function Qs(){return`img_${Date.now()}_${Math.random().toString(36).substring(2,9)}`}function cn(n,t,s){return{id:Qs(),fileName:n,originalDataURL:t,translatedDataURL:null,cleanImageData:null,bubbleStates:null,translationStatus:"pending",translationFailed:!1,fontSize:25,autoFontSize:!1,fontFamily:xt,layoutDirection:"auto",textColor:"#000000",fillColor:_n,inpaintMethod:"solid",strokeEnabled:fo,strokeColor:vo,strokeWidth:mo,hasUnsavedChanges:!1,...s}}const et=Jt("image",()=>{const n=C([]),t=C(-1),s=C(!1),o=Z(()=>t.value>=0&&t.value<n.value.length?n.value[t.value]??null:null),i=Z(()=>n.value.length),r=Z(()=>n.value.length>0),a=Z(()=>t.value>0),c=Z(()=>t.value<n.value.length-1),p=Z(()=>n.value.filter(d=>d.translationFailed).length),k=Z(()=>n.value.filter(d=>d.translationStatus==="completed").length),y=Z(()=>n.value.filter(d=>d.translationStatus==="pending").length);function $(d,m,l){const f=cn(d,m,l);return n.value.push(f),n.value.length===1&&(t.value=0),console.log(`å›¾ç‰‡å·²æ·»åŠ : ${d}ï¼Œå½“å‰å…± ${n.value.length} å¼ å›¾ç‰‡`),f}function E(d){const m=d.map(({fileName:f,originalDataURL:P,overrides:S})=>cn(f,P,S)),l=n.value.length===0;return n.value.push(...m),l&&n.value.length>0&&(t.value=0),console.log(`æ‰¹é‡æ·»åŠ äº† ${m.length} å¼ å›¾ç‰‡ï¼Œå½“å‰å…± ${n.value.length} å¼ `),m}function R(d){n.value=d.map(m=>({...m,strokeEnabled:m.strokeEnabled??fo,strokeColor:m.strokeColor||vo,strokeWidth:m.strokeWidth??mo,hasUnsavedChanges:m.hasUnsavedChanges||!1})),n.value.length>0?t.value=Math.min(Math.max(0,t.value),n.value.length-1):t.value=-1,console.log(`å›¾ç‰‡æ•°ç»„å·²è®¾ç½®ï¼Œå…± ${n.value.length} å¼ å›¾ç‰‡`)}function D(d){return d<0||d>=n.value.length?(console.warn(`åˆ é™¤å¤±è´¥: æ— æ•ˆçš„ç´¢å¼• ${d}`),!1):(n.value.splice(d,1),t.value===d?(t.value=Math.min(d,n.value.length-1),n.value.length===0&&(t.value=-1)):t.value>d&&t.value--,console.log(`å›¾ç‰‡å·²åˆ é™¤ï¼Œå½“å‰å…± ${n.value.length} å¼ å›¾ç‰‡`),!0)}function T(){return D(t.value)}function q(){n.value=[],t.value=-1,s.value=!1,console.log("æ‰€æœ‰å›¾ç‰‡å·²æ¸…é™¤")}function V(){const d=o.value?.id||null;if(n.value.sort((m,l)=>m.fileName.localeCompare(l.fileName,void 0,{numeric:!0,sensitivity:"base"})),d){const m=n.value.findIndex(l=>l.id===d);m>=0&&m!==t.value&&(console.log(`å›¾ç‰‡æ’åº: currentImageIndex ä» ${t.value} æ›´æ–°ä¸º ${m}`),t.value=m)}console.log("å›¾ç‰‡å·²æŒ‰æ–‡ä»¶åæ’åº")}function L(d){d>=-1&&d<n.value.length?(t.value=d,console.log(`å½“å‰å›¾ç‰‡ç´¢å¼•å·²è®¾ç½®ä¸º ${d}`)):console.warn(`è®¾ç½®ç´¢å¼•å¤±è´¥: æ— æ•ˆçš„ç´¢å¼• ${d}`)}function v(){return a.value?(t.value--,!0):!1}function g(){return c.value?(t.value++,!0):!1}function x(d){o.value?(Object.assign(o.value,d),console.log("å½“å‰å›¾ç‰‡å±æ€§å·²æ›´æ–°:",Object.keys(d))):console.warn("æ›´æ–°å¤±è´¥: å½“å‰æ²¡æœ‰é€‰ä¸­çš„å›¾ç‰‡")}function _(d,m){if(d>=0&&d<n.value.length){const l=n.value[d];l&&(Object.assign(l,m),console.log(`å›¾ç‰‡ ${d} å±æ€§å·²æ›´æ–°:`,Object.keys(m)))}else console.warn(`æ›´æ–°å¤±è´¥: æ— æ•ˆçš„ç´¢å¼• ${d}`)}function K(d){o.value&&(o.value.bubbleStates=d,o.value.hasUnsavedChanges=!0,console.log(`å½“å‰å›¾ç‰‡æ°”æ³¡çŠ¶æ€å·²æ›´æ–°ï¼Œå…± ${d?.length??0} ä¸ªæ°”æ³¡`))}function z(d){o.value&&(o.value.isManuallyAnnotated=d,o.value.hasUnsavedChanges=!0,console.log(`æ‰‹åŠ¨æ ‡æ³¨æ ‡è®°å·²è®¾ç½®ä¸º: ${d}`))}function se(d,m){o.value?(o.value[d]=m,o.value.hasUnsavedChanges=!0,console.log(`å½“å‰å›¾ç‰‡å±æ€§ ${String(d)} å·²æ›´æ–°`)):console.warn("æ›´æ–°å¤±è´¥: å½“å‰æ²¡æœ‰é€‰ä¸­çš„å›¾ç‰‡")}function X(d,m){o.value&&(o.value.translatedDataURL=d,m&&(o.value.cleanImageData=m),o.value.translationStatus="completed",o.value.translationFailed=!1,o.value.hasUnsavedChanges=!0,console.log("å½“å‰å›¾ç‰‡ç¿»è¯‘ç»“æœå·²æ›´æ–°"))}function ie(d,m,l){if(d>=0&&d<n.value.length){const f=n.value[d];f&&(f.translationStatus=m,f.translationFailed=m==="failed",l&&(f.errorMessage=l),console.log(`å›¾ç‰‡ ${d} ç¿»è¯‘çŠ¶æ€: ${m}`))}}function U(d){o.value&&(o.value.translationStatus="failed",o.value.translationFailed=!0,o.value.errorMessage=d,console.log(`å½“å‰å›¾ç‰‡ç¿»è¯‘å¤±è´¥: ${d}`))}function W(){n.value.forEach(d=>{d.translationStatus="pending",d.translationFailed=!1,d.errorMessage=void 0}),console.log("æ‰€æœ‰å›¾ç‰‡ç¿»è¯‘çŠ¶æ€å·²é‡ç½®")}function te(d){s.value=d,console.log(`æ‰¹é‡ç¿»è¯‘çŠ¶æ€: ${d?"è¿›è¡Œä¸­":"å·²å®Œæˆ"}`)}function B(){return n.value.map((d,m)=>d.translationFailed?m:-1).filter(d=>d!==-1)}return{images:n,currentImageIndex:t,isBatchTranslationInProgress:s,currentImage:o,imageCount:i,hasImages:r,canGoPrevious:a,canGoNext:c,failedImageCount:p,completedImageCount:k,pendingImageCount:y,addImage:$,addImages:E,setImages:R,deleteImage:D,deleteCurrentImage:T,clearImages:q,sortImagesByFileName:V,setCurrentImageIndex:L,goToPrevious:v,goToNext:g,updateCurrentImage:x,updateImageByIndex:_,updateCurrentBubbleStates:K,setManuallyAnnotated:z,updateCurrentImageProperty:se,updateCurrentTranslationResult:X,setTranslationStatus:ie,markCurrentAsFailed:U,resetAllTranslationStatus:W,setBatchTranslationInProgress:te,getFailedImageIndices:B}}),dn=Object.freeze(Object.defineProperty({__proto__:null,useImageStore:et},Symbol.toStringTag,{value:"Module"})),It=Jt("session",()=>{const n=C(null),t=C({bookId:null,chapterId:null,bookTitle:null,chapterTitle:null}),s=C([]),o=C(!1),i=C({current:0,total:0,message:""}),r=C(null),a=C(!1),c=Z(()=>t.value.bookId!==null&&t.value.chapterId!==null),p=Z(()=>t.value.bookId),k=Z(()=>t.value.chapterId);function y(U,W,te=null,B=null){t.value={bookId:U,chapterId:W,bookTitle:te,chapterTitle:B},console.log(`ä¼šè¯ä¸Šä¸‹æ–‡å·²è®¾ç½®: ä¹¦ç±=${U}, ç« èŠ‚=${W}`)}function $(U,W,te,B){y(U,W,te,B)}function E(){t.value={bookId:null,chapterId:null,bookTitle:null,chapterTitle:null},console.log("ä¼šè¯ä¸Šä¸‹æ–‡å·²æ¸…é™¤")}function R(U){const W=U.get("book"),te=U.get("chapter");W&&te&&y(W,te)}function D(U){n.value=U,console.log(`å½“å‰ä¼šè¯åç§°: ${U}`)}function T(){n.value=null}function q(U){s.value=U,console.log(`ä¼šè¯åˆ—è¡¨å·²æ›´æ–°ï¼Œå…± ${U.length} ä¸ªä¼šè¯`)}function V(U){const W=s.value.findIndex(te=>te.name===U.name);W>=0?s.value[W]=U:s.value.unshift(U)}function L(U){const W=s.value.findIndex(te=>te.name===U);W>=0&&s.value.splice(W,1)}function v(U,W){const te=s.value.find(B=>B.name===U);te&&(te.name=W)}function g(U){o.value=U}function x(U){a.value=U}function _(U){r.value=U}function K(){n.value=null,t.value={bookId:null,chapterId:null,bookTitle:null,chapterTitle:null},s.value=[],o.value=!1,a.value=!1,r.value=null,console.log("ä¼šè¯çŠ¶æ€å·²é‡ç½®")}async function z(U){if(!U||typeof U!="string")return null;if(U.startsWith("data:"))return U;if(!U.startsWith("/api/"))return null;try{const W=await fetch(U);if(!W.ok)return null;const te=await W.blob();return new Promise(B=>{const d=new FileReader;d.onloadend=()=>B(d.result),d.onerror=()=>B(null),d.readAsDataURL(te)})}catch(W){return console.error(`è½¬æ¢å›¾ç‰‡ URL å¤±è´¥: ${U}`,W),null}}async function se(U,W){const te=U.length;for(let B=0;B<te;B++){const d=U[B];if(d){if(W&&W(B+1,te),d.originalDataURL&&d.originalDataURL.startsWith("/api/")){const m=await z(d.originalDataURL);m&&(d.originalDataURL=m)}if(d.translatedDataURL&&d.translatedDataURL.startsWith("/api/")){const m=await z(d.translatedDataURL);m&&(d.translatedDataURL=m)}if(d.cleanImageData&&d.cleanImageData.startsWith("/api/")){const m=await z(d.cleanImageData);m&&(d.cleanImageData=m.replace(/^data:image\/\w+;base64,/,""))}}}}async function X(U){g(!0),_(null),i.value={current:0,total:0,message:"æ­£åœ¨åŠ è½½..."};try{const{useImageStore:W}=await rt(async()=>{const{useImageStore:N}=await Promise.resolve().then(()=>dn);return{useImageStore:N}},void 0),{useSettingsStore:te}=await rt(async()=>{const{useSettingsStore:N}=await import("./system.qIGXsO2R.js").then(G=>G.s);return{useSettingsStore:N}},__vite__mapDeps([0,1,2,3,4,5])),{useBubbleStore:B}=await rt(async()=>{const{useBubbleStore:N}=await Promise.resolve().then(()=>ui);return{useBubbleStore:N}},void 0),d=W(),m=te(),l=B(),{loadSessionByPathApi:f}=await rt(async()=>{const{loadSessionByPathApi:N}=await import("./session.C_VZSWrV.js");return{loadSessionByPathApi:N}},__vite__mapDeps([6,4,5])),P=await f(U);if(!P.success||!P.session)throw new Error(P.error||"åŠ è½½ä¼šè¯å¤±è´¥");const S=P.session;if(S.images&&S.images.length>0){const N=S.images.map((u,h)=>({id:`session-${h}-${Date.now()}`,originalDataURL:u.originalDataURL,translatedDataURL:u.translatedDataURL||null,cleanImageData:u.cleanImageData||null,bubbleStates:u.bubbleStates!==void 0&&u.bubbleStates!==null?u.bubbleStates:null,isManuallyAnnotated:!!u.isManuallyAnnotated,relativePath:u.relativePath||void 0,folderPath:u.folderPath||void 0,fileName:u.fileName||`image-${h+1}.png`,translationStatus:u.translationStatus||"pending",translationFailed:!!u.translationFailed,hasUnsavedChanges:!1,fontSize:u.fontSize||24,autoFontSize:u.autoFontSize??!1,fontFamily:u.fontFamily||"Microsoft YaHei",layoutDirection:u.layoutDirection||"auto",useAutoTextColor:u.useAutoTextColor??void 0,textColor:u.textColor||"#000000",fillColor:u.fillColor||"#FFFFFF",inpaintMethod:u.inpaintMethod||"litelama",strokeEnabled:u.strokeEnabled??!1,strokeColor:u.strokeColor||"#FFFFFF",strokeWidth:u.strokeWidth||2}));N.length>0&&(console.log("æ­£åœ¨åŠ è½½å›¾ç‰‡..."),i.value={current:0,total:N.length,message:"æ­£åœ¨åŠ è½½å›¾ç‰‡..."},await se(N,(u,h)=>{const le=u/h*100;i.value={current:u,total:h,message:`åŠ è½½å›¾ç‰‡ ${u}/${h}...`},console.log(`åŠ è½½å›¾ç‰‡ ${u}/${h}... (${le.toFixed(0)}%)`)}),i.value={current:N.length,total:N.length,message:"åŠ è½½å®Œæˆ"},console.log("å›¾ç‰‡åŠ è½½å®Œæˆï¼Œå·²è½¬æ¢ä¸º Base64"),setTimeout(()=>{i.value={current:0,total:0,message:""}},500)),d.setImages(N);let G=0;typeof S.currentImageIndex=="number"&&(G=S.currentImageIndex,(G>=N.length||G<0)&&(G=N.length>0?0:-1)),d.setCurrentImageIndex(G);const Y=N[G];Y&&Y.bubbleStates&&Y.bubbleStates.length>0?l.setBubbles(Y.bubbleStates,!0):l.clearBubblesLocal(),console.log(`æŒ‰è·¯å¾„åŠ è½½ä¼šè¯æˆåŠŸ: ${U}, å…± ${N.length} å¼ å›¾ç‰‡`)}const w=S.ui_settings;if(w){(w.targetLanguage||w.sourceLanguage)&&m.updateSettings({targetLanguage:w.targetLanguage||void 0,sourceLanguage:w.sourceLanguage||void 0});const N=w.useInpaintingMethod,Y=["solid","lama_mpe","litelama"].includes(N)?N:m.settings.textStyle.inpaintMethod;m.updateTextStyle({fontSize:w.fontSize||m.settings.textStyle.fontSize,autoFontSize:w.autoFontSize??m.settings.textStyle.autoFontSize,fontFamily:w.fontFamily||m.settings.textStyle.fontFamily,layoutDirection:w.layoutDirection||m.settings.textStyle.layoutDirection,textColor:w.textColor||m.settings.textStyle.textColor,fillColor:w.fillColor||m.settings.textStyle.fillColor,inpaintMethod:Y,strokeEnabled:w.strokeEnabled??m.settings.textStyle.strokeEnabled,strokeColor:w.strokeColor||m.settings.textStyle.strokeColor,strokeWidth:w.strokeWidth||m.settings.textStyle.strokeWidth,useAutoTextColor:w.useAutoTextColor??m.settings.textStyle.useAutoTextColor}),console.log("UI è®¾ç½®å·²æ¢å¤")}return D(U),!0}catch(W){const te=W instanceof Error?W.message:"åŠ è½½ä¼šè¯å¤±è´¥";throw _(te),console.error(`æŒ‰è·¯å¾„åŠ è½½ä¼šè¯å¤±è´¥: ${U}`,W),W}finally{g(!1)}}async function ie(U,W){if(!U||!W)return console.log("æœªåœ¨ä¹¦ç±/ç« èŠ‚æ¨¡å¼ï¼Œä¸æ”¯æŒä¿å­˜"),!1;console.log(`ä¿å­˜ç« èŠ‚ä¼šè¯: book=${U}, chapter=${W}`);const{useImageStore:te}=await rt(async()=>{const{useImageStore:S}=await Promise.resolve().then(()=>dn);return{useImageStore:S}},void 0),{useSettingsStore:B}=await rt(async()=>{const{useSettingsStore:S}=await import("./system.qIGXsO2R.js").then(w=>w.s);return{useSettingsStore:S}},__vite__mapDeps([0,1,2,3,4,5])),d=te(),m=B(),l=Array.isArray(d.images)?d.images:[];if(!l||l.length===0)return console.log("æ²¡æœ‰å›¾ç‰‡æ•°æ®å¯ä¿å­˜"),!1;const f=`bookshelf/${U}/${W}`;x(!0),_(null);const P=l.length;i.value={current:0,total:P,message:`å‡†å¤‡ä¿å­˜ ${P} å¼ å›¾ç‰‡...`};try{l.some(h=>h.originalDataURL&&h.originalDataURL.startsWith("/api/")||h.translatedDataURL&&h.translatedDataURL.startsWith("/api/")||h.cleanImageData&&h.cleanImageData.startsWith("/api/"))&&(console.log("[saveChapterSession] æ£€æµ‹åˆ° /api/ URL æ ¼å¼å›¾ç‰‡ï¼Œå¼€å§‹è½¬æ¢ä¸º Base64..."),i.value={current:0,total:P,message:"è½¬æ¢å›¾ç‰‡æ ¼å¼..."},await se(l,(h,le)=>{i.value={current:0,total:P,message:`è½¬æ¢å›¾ç‰‡ ${h}/${le}...`}}),console.log("[saveChapterSession] å›¾ç‰‡æ ¼å¼è½¬æ¢å®Œæˆ"));const{textStyle:w}=m.settings,N={fontSize:w.fontSize,autoFontSize:w.autoFontSize,fontFamily:w.fontFamily,layoutDirection:w.layoutDirection,textColor:w.textColor,useInpaintingMethod:w.inpaintMethod,fillColor:w.fillColor,strokeEnabled:w.strokeEnabled,strokeColor:w.strokeColor,strokeWidth:w.strokeWidth,useAutoTextColor:w.useAutoTextColor},{saveAllPagesSequentially:G,saveSessionMeta:Y}=await rt(async()=>{const{saveAllPagesSequentially:h,saveSessionMeta:le}=await Promise.resolve().then(()=>Mn);return{saveAllPagesSequentially:h,saveSessionMeta:le}},void 0),u=await G(f,l,{onProgress:(h,le)=>{i.value={current:h,total:le,message:`ä¿å­˜å›¾ç‰‡ ${h}/${le}...`}}});i.value={current:P,total:P,message:"å®Œæˆä¿å­˜..."},await Y(f,{ui_settings:N,total_pages:P,currentImageIndex:d.currentImageIndex}),console.log(`ç« èŠ‚ä¿å­˜å®Œæˆ: ${u}/${P} å¼ å›¾ç‰‡`);try{const{apiClient:h}=await rt(async()=>{const{apiClient:le}=await import("./client.Bht704G-.js");return{apiClient:le}},__vite__mapDeps([4,5]));await h.put(`/api/bookshelf/books/${U}/chapters/${W}/image-count`,{count:P})}catch(h){console.warn("æ›´æ–°ç« èŠ‚å›¾ç‰‡æ•°é‡å¤±è´¥ï¼ˆéè‡´å‘½ï¼‰:",h)}return i.value={current:P,total:P,message:"ä¿å­˜å®Œæˆ"},setTimeout(()=>{i.value={current:0,total:0,message:""}},1e3),!0}catch(S){const w=S instanceof Error?S.message:"ä¿å­˜ç« èŠ‚ä¼šè¯å¤±è´¥";return _(w),console.error("ä¿å­˜å¤±è´¥:",S),i.value={current:0,total:0,message:""},!1}finally{x(!1)}}return{currentSessionName:n,context:t,sessionList:s,isLoading:o,isSaving:a,error:r,loadingProgress:i,isBookshelfMode:c,currentBookId:p,currentChapterId:k,setContext:y,clearContext:E,parseContextFromUrl:R,setSessionName:D,clearSessionName:T,setSessionList:q,addToSessionList:V,removeFromSessionList:L,renameInSessionList:v,setLoading:g,setSaving:x,setError:_,imageUrlToBase64:z,saveChapterSession:ie,loadSessionByPath:X,setBookChapterContext:$,reset:K}}),zt={originalText:"",translatedText:"",textboxText:"",coords:[0,0,100,100],polygon:[],fontSize:25,fontFamily:xt,textDirection:"vertical",autoTextDirection:"vertical",textColor:"#000000",fillColor:_n,rotationAngle:0,position:{x:0,y:0},strokeEnabled:fo,strokeColor:vo,strokeWidth:mo,inpaintMethod:"solid",autoFgColor:null,autoBgColor:null,colorConfidence:0};function ea(n){return{...{...zt,...n},coords:n?.coords?[...n.coords]:[...zt.coords],polygon:n?.polygon?n.polygon.map(s=>[...s]):[],position:n?.position?{...zt.position,...n.position}:{...zt.position}}}function ta(n){const[t,s,o,i]=n,r=Math.abs(o-t);return Math.abs(i-s)>r?"vertical":"horizontal"}function Nt(n){return n.map(t=>({...t,coords:[...t.coords],polygon:t.polygon?t.polygon.map(s=>[...s]):[],position:{...t.position},autoFgColor:t.autoFgColor?[...t.autoFgColor]:null,autoBgColor:t.autoBgColor?[...t.autoBgColor]:null}))}function oa(n){if(!n||typeof n!="object")return!1;const t=n;if(!Array.isArray(t.coords)||t.coords.length!==4||!t.coords.every(i=>typeof i=="number"&&!isNaN(i))||typeof t.fontSize!="number"||t.fontSize<=0)return!1;const s=["vertical","horizontal","auto"];if(typeof t.textDirection!="string"||!s.includes(t.textDirection))return!1;const o=["solid","lama_mpe","litelama"];return!(typeof t.inpaintMethod!="string"||!o.includes(t.inpaintMethod))}function na(n){let t=n,s=0,o=0,i=Date.now();const r=()=>t<=0?0:Math.ceil(6e4/t);return{async acquire(){if(t<=0)return;const a=Date.now(),c=r();if(a-i>=6e4&&(i=a,o=0),o>=t){const k=6e4-(a-i);k>0&&await gn(k),i=Date.now(),o=0}const p=a-s;p<c&&await gn(c-p),s=Date.now(),o++},reset(){s=0,o=0,i=Date.now()},getRpm(){return t},setRpm(a){t=a,this.reset()}}}function gn(n){return new Promise(t=>setTimeout(t,n))}function pn(n){const t=n.replace(/\\/g,"/"),s=[],o=/(\d+)/g;let i=0,r;for(;(r=o.exec(t))!==null;){if(r.index>i){const a=t.slice(i,r.index);a&&s.push([!0,a.toLowerCase()])}s.push([!1,parseInt(r[0],10)]),i=o.lastIndex}if(i<t.length){const a=t.slice(i);a&&s.push([!0,a.toLowerCase()])}return s}function sa(n,t){const s=pn(n),o=pn(t),i=Math.min(s.length,o.length);for(let r=0;r<i;r++){const[a,c]=s[r],[p,k]=o[r];if(a!==p)return a?1:-1;if(c<k)return-1;if(c>k)return 1}return s.length-o.length}function aa(n,t=s=>String(s)){return[...n].sort((s,o)=>sa(t(s),t(o)))}const mn="webImportDisclaimerAccepted",_o=Jt("webImport",()=>{const n=C(un()),t=C("idle"),s=C(""),o=C([]),i=C(null),r=C(new Set),a=C({current:0,total:0}),c=C([]),p=C(null),k=C(!1),y=C(!1),$=C(!1),E=Z(()=>t.value==="extracting"),R=Z(()=>t.value==="downloading"),D=Z(()=>E.value||R.value),T=Z(()=>r.value.size),q=Z(()=>a.value.total===0?0:Math.round(a.value.current/a.value.total*100));function V(){try{localStorage.setItem(Xo,JSON.stringify(n.value))}catch(w){console.error("ä¿å­˜ç½‘é¡µå¯¼å…¥è®¾ç½®å¤±è´¥:",w)}}function L(){try{const w=localStorage.getItem(Xo);if(w){const N=JSON.parse(w);n.value=v(un(),N)}}catch(w){console.error("åŠ è½½ç½‘é¡µå¯¼å…¥è®¾ç½®å¤±è´¥:",w)}}function v(w,N){const G={...w};for(const Y in N)if(Object.prototype.hasOwnProperty.call(N,Y)){const u=N[Y],h=w[Y];u!==null&&typeof u=="object"&&!Array.isArray(u)&&h!==null&&typeof h=="object"&&!Array.isArray(h)?G[Y]=v(h,u):u!==void 0&&(G[Y]=u)}return G}function g(){y.value?k.value=!0:$.value=!0}function x(){y.value=!0,$.value=!1,k.value=!0;try{localStorage.setItem(mn,"true")}catch(w){console.error("ä¿å­˜å…è´£å£°æ˜çŠ¶æ€å¤±è´¥:",w)}}function _(){$.value=!1}function K(){try{const w=localStorage.getItem(mn);y.value=w==="true"}catch(w){console.error("åŠ è½½å…è´£å£°æ˜çŠ¶æ€å¤±è´¥:",w)}}function z(){k.value=!1}function se(){t.value="idle",s.value="",o.value=[],i.value=null,r.value=new Set,a.value={current:0,total:0},c.value=[],p.value=null}function X(w){s.value=w}function ie(w){o.value.push(w)}function U(){o.value=[]}function W(w){i.value&&i.value.pages.length>0?(i.value.comicTitle=w.comicTitle,i.value.chapterTitle=w.chapterTitle,i.value.totalPages=w.totalPages,i.value.sourceUrl=w.sourceUrl,i.value.referer=w.referer,i.value.engine=w.engine,i.value.success=w.success,i.value.error=w.error):(i.value=w,w.success&&w.pages&&(r.value=new Set(w.pages.map(N=>N.pageNumber))))}function te(w){r.value.has(w)?r.value.delete(w):r.value.add(w),r.value=new Set(r.value)}function B(){i.value?.pages&&(r.value.size===i.value.pages.length?r.value=new Set:r.value=new Set(i.value.pages.map(w=>w.pageNumber)))}function d(w){t.value=w}function m(w){p.value=w,w&&(t.value="error")}function l(w,N){a.value={current:w,total:N}}function f(w){c.value=w}function P(w){i.value||(i.value={success:!0,comicTitle:"",chapterTitle:"",pages:[],totalPages:0,sourceUrl:s.value,referer:"",engine:"gallery-dl"}),i.value.pages.push(w),i.value.totalPages=i.value.pages.length,r.value.add(w.pageNumber),r.value=new Set(r.value)}const S=As(n,V);return L(),K(),{settings:n,status:t,url:s,logs:o,extractResult:i,selectedPages:r,downloadProgress:a,downloadedImages:c,error:p,modalVisible:k,disclaimerAccepted:y,disclaimerVisible:$,isExtracting:E,isDownloading:R,isProcessing:D,selectedCount:T,downloadProgressPercent:q,saveToStorage:V,loadFromStorage:L,openModal:g,closeModal:z,resetState:se,setUrl:X,addLog:ie,clearLogs:U,setExtractResult:W,togglePageSelection:te,toggleSelectAll:B,setStatus:d,setError:m,updateDownloadProgress:l,setDownloadedImages:f,addPageIncremental:P,acceptDisclaimer:x,rejectDisclaimer:_,...S}}),la={key:0,class:"translation-progress-bar"},ia={class:"progress-bar-label"},ra={class:"progress-bar"},ua=je({__name:"ProgressBar",props:{visible:{type:Boolean,default:!0},percentage:{},label:{default:"è¿›åº¦"}},setup(n){return(t,s)=>n.visible?(M(),A("div",la,[e("div",ia,oe(n.label),1),e("div",ra,[e("div",{class:"progress",style:at({width:`${n.percentage}%`})},null,4)])])):de("",!0)}}),Co=He(ua,[["__scopeId","data-v-f915cadf"]]),ca={class:"image-upload"},da={class:"error-text"},ga={key:2,class:"loading-overlay"},pa=je({__name:"ImageUpload",emits:["uploadComplete"],setup(n,{expose:t,emit:s}){const o=s,i=et(),r=ze(),a=_o(),c=C(null),p=C(null),k=C(!1),y=C(!1),$=C(""),E=C(0),R=C(""),D=C(!1),T=Z(()=>r.settings.pdfProcessingMethod);function q(){c.value?.click()}function V(){a.openModal()}function L(){p.value?.click()}async function v(m){const l=m.target;if(!l.files||l.files.length===0)return;const P=Array.from(l.files).filter(w=>w.type.startsWith("image/"));if(P.length===0){_e("æ‰€é€‰æ–‡ä»¶å¤¹ä¸­æ²¡æœ‰æ‰¾åˆ°å›¾ç‰‡æ–‡ä»¶","warning"),l.value="";return}const S=aa(P,w=>w.webkitRelativePath);console.log(`ä»æ–‡ä»¶å¤¹å¯¼å…¥ ${S.length} å¼ å›¾ç‰‡`),await g(S),l.value=""}async function g(m){if(m.length!==0){k.value=!0,D.value=!0,E.value=0;try{let l=0;const f=m.length;for(let P=0;P<m.length;P++){const S=m[P];if(!S||!S.type.startsWith("image/"))continue;R.value=S.name;const w=S.webkitRelativePath||"",N=w.includes("/")?w.substring(0,w.lastIndexOf("/")):"";await new Promise((G,Y)=>{const u=new FileReader;u.onload=h=>{const le=h.target?.result;i.addImage(S.name,le,{relativePath:w,folderPath:N}),G()},u.onerror=()=>Y(new Error(`è¯»å–å›¾ç‰‡å¤±è´¥: ${S.name}`)),u.readAsDataURL(S)}),l++,E.value=Math.round((P+1)/f*100)}l>0&&(_e(`å·²æ·»åŠ  ${l} å¼ å›¾ç‰‡`,"success"),o("uploadComplete",l))}catch(l){console.error("å¤„ç†æ–‡ä»¶å¤±è´¥:",l);const f=l instanceof Error?l.message:"å¤„ç†æ–‡ä»¶å¤±è´¥";_e(f,"error")}finally{k.value=!1,D.value=!1}}}async function x(m){const l=m.target;!l.files||l.files.length===0||(await se(Array.from(l.files)),l.value="")}async function _(m){m.preventDefault(),y.value=!1,!(!m.dataTransfer?.files||m.dataTransfer.files.length===0)&&await se(Array.from(m.dataTransfer.files))}function K(m){m.preventDefault(),y.value=!0}function z(m){const l=m.currentTarget.getBoundingClientRect(),f=m.clientX,P=m.clientY;(f<l.left||f>l.right||P<l.top||P>l.bottom)&&(y.value=!1)}async function se(m){if(m.length!==0){k.value=!0,$.value="",D.value=!0,E.value=0;try{let l=0;const f=m.length;for(let P=0;P<m.length;P++){const S=m[P];if(!S)continue;R.value=S.name;const w=S.type,N=S.name.toLowerCase();if(w.startsWith("image/"))await X(S),l++;else if(w==="application/pdf"||N.endsWith(".pdf")){const G=await ie(S);l+=G}else if(N.endsWith(".mobi")||N.endsWith(".azw")||N.endsWith(".azw3")){const G=await B(S);l+=G}else console.warn(`ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹: ${S.name}`),_e(`ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹: ${S.name}`,"warning");E.value=Math.round((P+1)/f*100)}l>0&&(_e(`å·²æ·»åŠ  ${l} å¼ å›¾ç‰‡`,"success"),o("uploadComplete",l))}catch(l){console.error("å¤„ç†æ–‡ä»¶å¤±è´¥:",l);const f=l instanceof Error?l.message:"å¤„ç†æ–‡ä»¶å¤±è´¥ï¼Œè¯·é‡è¯•";$.value=f,_e(f,"error")}finally{k.value=!1,D.value=!1,R.value=""}}}async function X(m){return new Promise((l,f)=>{const P=new FileReader;P.onload=S=>{const w=S.target?.result;i.addImage(m.name,w),l()},P.onerror=()=>f(new Error(`è¯»å–å›¾ç‰‡æ–‡ä»¶å¤±è´¥: ${m.name}`)),P.readAsDataURL(m)})}async function ie(m){return T.value==="frontend"?await W(m):await te(m)}function U(m){return new Promise((l,f)=>{const P=new FileReader;P.onload=()=>l(P.result),P.onerror=f,P.readAsDataURL(m)})}async function W(m){try{const l=await rt(()=>import("./pdf.U7tdldy2.js").then(G=>G.p),[]);l.GlobalWorkerOptions.workerSrc=`https://cdnjs.cloudflare.com/ajax/libs/pdf.js/${l.version}/pdf.worker.min.js`;const f=await m.arrayBuffer(),P=await l.getDocument({data:f}).promise,S=P.numPages;console.log(`PDF ${m.name} å…± ${S} é¡µï¼Œå¼€å§‹æœ¬åœ°æ¸²æŸ“...`),_e(`æ­£åœ¨è§£æ PDFï¼Œå…± ${S} é¡µ...`,"info");const w=typeof OffscreenCanvas<"u";w&&console.log("ä½¿ç”¨ OffscreenCanvas åå°æ¸²æŸ“æ¨¡å¼");let N=0;for(let G=1;G<=S;G++){R.value=`${m.name} - ç¬¬ ${G}/${S} é¡µ`,E.value=Math.round(G/S*100);try{const Y=await P.getPage(G),h=Y.getViewport({scale:2});let le;if(w){const j=new OffscreenCanvas(h.width,h.height),ce=j.getContext("2d");await Y.render({canvasContext:ce,viewport:h}).promise;const ye=await j.convertToBlob({type:"image/jpeg",quality:1});le=await U(ye)}else{const j=document.createElement("canvas"),ce=j.getContext("2d");j.width=h.width,j.height=h.height,await Y.render({canvasContext:ce,viewport:h}).promise,le=j.toDataURL("image/jpeg",1)}const I=`${m.name}_é¡µé¢${G}`;i.addImage(I,le),N++,console.log(`  é¡µé¢ ${G}/${S} å¤„ç†å®Œæˆ`)}catch(Y){console.warn(`PDF ${m.name} ç¬¬ ${G} é¡µæ¸²æŸ“å¤±è´¥:`,Y)}}return console.log(`PDF ${m.name} å…¨éƒ¨ ${S} é¡µå¤„ç†å®Œæˆ`),N}catch(l){return console.error("å‰ç«¯ PDF è§£æå¤±è´¥:",l),_e("å‰ç«¯ PDF è§£æå¤±è´¥ï¼Œå°è¯•ä½¿ç”¨åç«¯è§£æ...","warning"),await te(m)}}async function te(m){let f=null;try{_e("æ­£åœ¨ä¸Šä¼  PDF æ–‡ä»¶...","info");const P=await xs(m,5);if(!P.success||!P.session_id)throw new Error(P.error||"PDF è§£æå¯åŠ¨å¤±è´¥");f=P.session_id;const S=P.total_pages||0;console.log(`PDF ${m.name} å…± ${S} é¡µï¼Œå¼€å§‹åç«¯åˆ†æ‰¹è§£æ...`),_e(`æ­£åœ¨è§£æ PDFï¼Œå…± ${S} é¡µ...`,"info");let w=0;for(let N=0;N<S;N+=5){R.value=`${m.name} - å¤„ç†ä¸­ ${Math.min(N+5,S)}/${S} é¡µ`,E.value=S>0?Math.round(N/S*100):0;const G=await _s(f,N,5);if(!G.success){console.warn(`æ‰¹æ¬¡ ${N} è·å–å¤±è´¥:`,G.error);continue}if(G.images&&G.images.length>0)for(const Y of G.images){if(!Y||!Y.data_url)continue;const u=`${m.name}_é¡µé¢${String(Y.page_index+1).padStart(4,"0")}`;i.addImage(u,Y.data_url),w++}console.log(`  å·²åŠ è½½ ${w}/${S} é¡µ`)}return console.log(`PDF ${m.name} å…¨éƒ¨ ${w} é¡µå¤„ç†å®Œæˆ`),w}catch(P){throw console.error("åç«¯ PDF è§£æå¤±è´¥:",P),P}finally{if(f)try{await Cs(f)}catch(P){console.warn("PDF ä¼šè¯æ¸…ç†å¤±è´¥:",P)}}}async function B(m){let l=null;try{_e("æ­£åœ¨ä¸Šä¼ ç”µå­ä¹¦æ–‡ä»¶...","info");const f=await Ss(m,5);if(!f.success||!f.session_id)throw new Error(f.error||"MOBI/AZW è§£æå¯åŠ¨å¤±è´¥");l=f.session_id;const P=f.total_images||0;_e(`æ­£åœ¨è§£æç”µå­ä¹¦ï¼Œå…± ${P} å¼ å›¾ç‰‡...`,"info");let S=0,w=!0;for(;w;){R.value=`${m.name} - å·²å¤„ç† ${S}/${P} å¼ `,E.value=P>0?Math.round(S/P*100):0;const N=await ks(l);if(!N.success)throw new Error(N.error||"MOBI/AZW æ‰¹æ¬¡è§£æå¤±è´¥");if(N.images&&N.images.length>0){for(let G=0;G<N.images.length;G++){const Y=N.images[G];if(!Y)continue;const u=S+G+1,h=`${m.name.replace(/\.(mobi|azw|azw3)$/i,"")}_image_${String(u).padStart(3,"0")}.png`,le=Y.startsWith("data:")?Y:`data:image/png;base64,${Y}`;i.addImage(h,le)}S+=N.images.length}w=N.has_more??!1}return S}catch(f){throw console.error("MOBI/AZW è§£æå¤±è´¥:",f),f}finally{if(l)try{await ws(l)}catch(f){console.warn("MOBI/AZW ä¼šè¯æ¸…ç†å¤±è´¥:",f)}}}function d(){$.value=""}return t({triggerFileSelect:q,triggerFolderSelect:L,processFiles:se,clearError:d}),(m,l)=>(M(),A("div",ca,[e("div",{id:"drop-area",class:Ie(["drop-area",{"drag-over":y.value,loading:k.value}]),onDragover:K,onDragleave:z,onDrop:_},[e("div",{class:"drop-content"},[e("p",{class:"drop-text"},[l[0]||(l[0]=me(" æ‹–æ‹½å›¾ç‰‡ã€PDFæˆ–MOBIæ–‡ä»¶åˆ°è¿™é‡Œï¼Œæˆ– ",-1)),e("span",{class:"select-link",onClick:q}," é€‰æ‹©æ–‡ä»¶ "),l[1]||(l[1]=e("span",{class:"separator"}," | ",-1)),e("span",{class:"select-link folder-link",onClick:L}," ğŸ“ é€‰æ‹©æ–‡ä»¶å¤¹ "),l[2]||(l[2]=e("span",{class:"separator"}," | ",-1)),e("span",{class:"select-link web-import-link",onClick:V}," ğŸŒ ä»ç½‘é¡µå¯¼å…¥ ")])]),e("input",{ref_key:"fileInputRef",ref:c,type:"file",id:"imageUpload",accept:"image/*,application/pdf,.mobi,.azw,.azw3",multiple:"",class:"file-input",onChange:x},null,544),e("input",{ref_key:"folderInputRef",ref:p,type:"file",webkitdirectory:"",class:"file-input",onChange:v},null,544)],34),D.value?(M(),ut(Co,{key:0,visible:!0,percentage:E.value,label:R.value||"å¤„ç†ä¸­..."},null,8,["percentage","label"])):de("",!0),$.value?(M(),A("div",{key:1,class:"error-message",onClick:d},[l[3]||(l[3]=e("span",{class:"error-icon"},"âš ï¸",-1)),e("span",da,oe($.value),1),l[4]||(l[4]=e("span",{class:"error-close"},"Ã—",-1))])):de("",!0),k.value&&!D.value?(M(),A("div",ga,[...l[5]||(l[5]=[e("div",{class:"spinner"},null,-1),e("span",{class:"loading-text"},"å¤„ç†ä¸­...",-1)])])):de("",!0)]))}}),ma=He(pa,[["__scopeId","data-v-5ff3dc04"]]),va={id:"settings-sidebar",class:"settings-sidebar"},fa={class:"card settings-card"},ba={id:"font-settings",class:"settings-card collapsible-panel"},ha={class:"toggle-icon"},ya={class:"collapsible-content"},xa={class:"settings-form"},_a={class:"form-group"},Ca=["value","disabled","title"],Sa={class:"auto-fontSize-option",title:"å‹¾é€‰åï¼Œé¦–æ¬¡ç¿»è¯‘æ—¶è‡ªåŠ¨ä¸ºæ¯ä¸ªæ°”æ³¡è®¡ç®—åˆé€‚çš„å­—å·"},ka=["checked"],wa={class:"form-group"},$a={class:"form-group"},Ta={class:"form-group"},Ia={class:"color-with-auto"},Pa={class:"auto-color-toggle",title:"ç¿»è¯‘æ—¶è‡ªåŠ¨ä½¿ç”¨è¯†åˆ«åˆ°çš„æ–‡å­—é¢œè‰²"},Ra=["checked"],Da=["value","disabled"],Ma={key:0,class:"auto-color-hint"},Ea={class:"form-group"},Ba={class:"checkbox-label"},Aa=["checked"],La={key:0,id:"strokeOptions",class:"stroke-options"},Fa={class:"form-group"},Ua=["value"],Oa={class:"form-group"},za=["value"],Na={class:"form-group"},Va={key:0,id:"solidColorOptions",class:"form-group"},Wa=["value"],Ka={class:"apply-settings-group"},qa=["disabled"],Ha={key:0,class:"apply-options-dropdown"},ja={class:"apply-option"},Ja=["checked"],Ya={class:"apply-option"},Xa={class:"apply-option"},Ga={class:"apply-option"},Za={class:"apply-option"},Qa={class:"apply-option"},el={class:"apply-option"},tl={class:"apply-option"},ol={class:"apply-option"},nl={id:"page-range-settings",class:"settings-card collapsible-panel"},sl={class:"toggle-icon"},al={class:"collapsible-content"},ll={class:"settings-form page-range-form"},il={class:"range-header-row"},rl={class:"range-toggle-compact"},ul=["disabled"],cl={class:"total-count"},dl={class:"page-range-inputs-compact"},gl=["value","max"],pl=["value","max"],ml={key:0,class:"range-error-compact"},vl={class:"action-buttons"},fl=["disabled"],bl=["disabled","title"],hl=["disabled","title"],yl=["disabled","title"],xl=["disabled"],_l=["disabled","title"],Cl=["disabled"],Sl=["disabled"],kl={class:"navigation-buttons"},wl=["disabled"],$l=["disabled"],Tl=je({__name:"SettingsSidebar",emits:["translateCurrent","translateAll","translateRange","hqTranslate","hqTranslateRange","proofread","proofreadRange","removeText","removeAllText","removeTextRange","deleteCurrent","clearAll","cleanTemp","openPlugins","openSettings","previous","next","applyToAll","textStyleChanged","autoFontSizeChanged"],setup(n,{emit:t}){const s=t,o=et(),i=ze(),r=C(!0),a=C(!1),c=C({fontSize:!0,fontFamily:!0,layoutDirection:!0,textColor:!0,fillColor:!0,strokeEnabled:!0,strokeColor:!0,strokeWidth:!0}),p=C(!1),k=C(!1),y=C(1),$=C(1),E=[{label:"è‡ªåŠ¨ (æ ¹æ®æ£€æµ‹)",value:"auto"},{label:"ç«–å‘æ’ç‰ˆ",value:"vertical"},{label:"æ¨ªå‘æ’ç‰ˆ",value:"horizontal"}],R=[{label:"çº¯è‰²å¡«å……",value:"solid"},{label:"LAMAä¿®å¤ (é€Ÿåº¦ä¼˜åŒ–)",value:"lama_mpe"},{label:"LAMAä¿®å¤ (é€šç”¨)",value:"litelama"}],D=Z(()=>o.currentImage),T=Z(()=>o.hasImages),q=Z(()=>o.images.length),V=Z(()=>y.value>=1&&$.value<=q.value&&y.value<=$.value),L=Z(()=>T.value&&!o.isBatchTranslationInProgress),v=Z(()=>o.canGoPrevious),g=Z(()=>o.canGoNext),x=Z(()=>i.textStyle),_=C([]),K=[xt,"fonts/msyh.ttc","fonts/simhei.ttf","fonts/simsun.ttc"],z=C(null),se=Z(()=>{const ee=_.value.map(b=>({label:B(b),value:b}));return ee.push({label:"è‡ªå®šä¹‰å­—ä½“...",value:"custom-font"}),ee});dt(async()=>{await X();const ee=x.value.fontFamily;ee&&!_.value.includes(ee)&&(_.value=[ee,..._.value])});async function X(){try{const ee=await $n();if(ee.fonts&&Array.isArray(ee.fonts)&&ee.fonts.length>0){const b=ee.fonts[0];if(typeof b=="object"&&"path"in b){const J=ee.fonts.map(ve=>typeof ve=="object"?ve.path:ve);_.value=J}else _.value=ee.fonts}else _.value=[...K]}catch(ee){console.error("åŠ è½½å­—ä½“åˆ—è¡¨å¤±è´¥:",ee),_.value=[...K]}}function ie(){r.value=!r.value}function U(ee){const b=parseInt(ee.target.value);isNaN(b)||(i.updateTextStyle({fontSize:b}),s("textStyleChanged","fontSize",b))}function W(ee){const b=ee.target.checked;i.updateTextStyle({autoFontSize:b}),console.log(`è‡ªåŠ¨å­—å·è®¾ç½®å˜æ›´: ${b}`),s("autoFontSizeChanged",b)}async function te(ee){const b=ee.target,J=b.files?.[0];if(!J)return;const ve=[".ttf",".ttc",".otf"],fe=J.name.toLowerCase();if(!ve.some(ne=>fe.endsWith(ne))){_e("è¯·é€‰æ‹© .ttfã€.ttc æˆ– .otf æ ¼å¼çš„å­—ä½“æ–‡ä»¶","error"),b.value="";return}try{const ne=await Rs(J);ne.success&&ne.fontPath?(await X(),i.updateTextStyle({fontFamily:ne.fontPath}),_e("å­—ä½“ä¸Šä¼ æˆåŠŸ","success")):_e(ne.error||"å­—ä½“ä¸Šä¼ å¤±è´¥","error")}catch(ne){console.error("å­—ä½“ä¸Šä¼ å¤±è´¥:",ne),_e("å­—ä½“ä¸Šä¼ å¤±è´¥","error")}finally{b.value=""}}function B(ee){const b={"fonts/STXINGKA.TTF":"åæ–‡è¡Œæ¥·","fonts/STXINWEI.TTF":"åæ–‡æ–°é­","fonts/STZHONGS.TTF":"åæ–‡ä¸­å®‹","fonts/STKAITI.TTF":"æ¥·ä½“","fonts/STLITI.TTF":"éš¶ä¹¦","fonts/æ€æºé»‘ä½“SourceHanSansK-Bold.TTF":"æ€æºé»‘ä½“","fonts/STSONG.TTF":"åæ–‡å®‹ä½“","fonts/msyh.ttc":"å¾®è½¯é›…é»‘","fonts/msyhbd.ttc":"å¾®è½¯é›…é»‘ç²—ä½“","fonts/SIMYOU.TTF":"å¹¼åœ†","fonts/STFANGSO.TTF":"ä»¿å®‹","fonts/STHUPO.TTF":"åæ–‡ç¥ç€","fonts/STXIHEI.TTF":"åæ–‡ç»†é»‘","fonts/simkai.ttf":"ä¸­æ˜“æ¥·ä½“","fonts/simfang.ttf":"ä¸­æ˜“ä»¿å®‹","fonts/simhei.ttf":"ä¸­æ˜“é»‘ä½“","fonts/SIMLI.TTF":"ä¸­æ˜“éš¶ä¹¦","fonts/simsun.ttc":"å®‹ä½“"};if(b[ee])return b[ee];const J=ee.split("/").pop()||ee;for(const[ve,fe]of Object.entries(b))if((ve.split("/").pop()||"").toLowerCase()===J.toLowerCase())return fe;return J.replace(/\.(ttf|ttc|otf)$/i,"")}function d(ee){const b=String(ee);if(b==="custom-font"){z.value?.click();return}i.updateTextStyle({fontFamily:b}),s("textStyleChanged","fontFamily",b)}function m(ee){const b=String(ee);i.updateTextStyle({layoutDirection:b}),s("textStyleChanged","layoutDirection",b)}function l(ee){const b=String(ee);i.updateTextStyle({inpaintMethod:b})}function f(ee){const b=ee.target.value;i.updateTextStyle({textColor:b}),s("textStyleChanged","textColor",b)}function P(ee){const b=ee.target.checked;i.updateTextStyle({useAutoTextColor:b})}function S(ee){const b=ee.target.checked;i.updateTextStyle({strokeEnabled:b}),s("textStyleChanged","strokeEnabled",b)}function w(ee){const b=ee.target.value;i.updateTextStyle({strokeColor:b}),s("textStyleChanged","strokeColor",b)}function N(ee){const b=parseInt(ee.target.value);isNaN(b)||(i.updateTextStyle({strokeWidth:b}),s("textStyleChanged","strokeWidth",b))}function G(ee){const b=ee.target.value;i.updateTextStyle({fillColor:b}),s("textStyleChanged","fillColor",b)}function Y(){a.value=!a.value}function u(){const b=!Object.values(c.value).every(J=>J);c.value={fontSize:b,fontFamily:b,layoutDirection:b,textColor:b,fillColor:b,strokeEnabled:b,strokeColor:b,strokeWidth:b}}function h(){s("applyToAll",{...c.value}),a.value=!1}function le(ee){ee.target.closest(".apply-settings-group")||(a.value=!1)}function I(){p.value=!p.value,p.value&&q.value>0&&(y.value=1,$.value=q.value)}function j(ee){const b=parseInt(ee.target.value);isNaN(b)||(y.value=Math.max(1,Math.min(b,q.value)),y.value>$.value&&($.value=y.value))}function ce(ee){const b=parseInt(ee.target.value);isNaN(b)||($.value=Math.max(1,Math.min(b,q.value)),$.value<y.value&&(y.value=$.value))}function ye(){k.value&&V.value?s("translateRange",y.value,$.value):s("translateAll")}function De(){k.value&&V.value?s("hqTranslateRange",y.value,$.value):s("hqTranslate")}function $e(){k.value&&V.value?s("proofreadRange",y.value,$.value):s("proofread")}function he(){k.value&&V.value?s("removeTextRange",y.value,$.value):s("removeAllText")}return typeof window<"u"&&window.addEventListener("click",le),(ee,b)=>(M(),A("aside",va,[e("div",fa,[b[43]||(b[43]=e("h2",null,"ç¿»è¯‘è®¾ç½®",-1)),e("div",ba,[e("h3",{class:"collapsible-header",onClick:ie},[b[17]||(b[17]=me(" æ–‡å­—è®¾ç½® ",-1)),e("span",ha,oe(r.value?"â–¼":"â–¶"),1)]),ae(e("div",ya,[e("div",xa,[e("div",_a,[b[19]||(b[19]=e("label",{for:"fontSize"},"å­—å·å¤§å°:",-1)),e("input",{type:"number",id:"fontSize",value:x.value.fontSize,min:"10",max:"100",disabled:x.value.autoFontSize,class:Ie({"disabled-input":x.value.autoFontSize}),title:x.value.autoFontSize?"å·²å¯ç”¨è‡ªåŠ¨å­—å·ï¼Œé¦–æ¬¡ç¿»è¯‘æ—¶å°†è‡ªåŠ¨è®¡ç®—":"",onInput:U},null,42,Ca),e("span",Sa,[e("input",{type:"checkbox",id:"autoFontSize",checked:x.value.autoFontSize,onChange:W},null,40,ka),b[18]||(b[18]=e("label",{for:"autoFontSize"},"è‡ªåŠ¨è®¡ç®—åˆå§‹å­—å·",-1))])]),e("div",wa,[b[20]||(b[20]=e("label",{for:"fontFamily"},"æ–‡æœ¬å­—ä½“:",-1)),Ce(We,{"model-value":x.value.fontFamily,options:se.value,onChange:d},null,8,["model-value","options"]),e("input",{ref_key:"fontUploadInput",ref:z,type:"file",id:"fontUpload",accept:".ttf,.ttc,.otf",style:{display:"none"},onChange:te},null,544)]),e("div",$a,[b[21]||(b[21]=e("label",{for:"layoutDirection"},"æ’ç‰ˆè®¾ç½®:",-1)),Ce(We,{"model-value":x.value.layoutDirection,options:E,onChange:m},null,8,["model-value"])]),e("div",Ta,[b[23]||(b[23]=e("label",{for:"textColor"},"æ–‡å­—é¢œè‰²:",-1)),e("div",Ia,[e("label",Pa,[e("input",{type:"checkbox",checked:x.value.useAutoTextColor,onChange:P},null,40,Ra),b[22]||(b[22]=e("span",null,"è‡ªåŠ¨",-1))]),e("input",{type:"color",id:"textColor",value:x.value.textColor,disabled:x.value.useAutoTextColor,onInput:f},null,40,Da)]),x.value.useAutoTextColor?(M(),A("div",Ma," ğŸ’¡ ç¿»è¯‘æ—¶å°†è‡ªåŠ¨ä½¿ç”¨è¯†åˆ«åˆ°çš„æ–‡å­—é¢œè‰² ")):de("",!0)]),e("div",Ea,[e("span",Ba,[e("input",{type:"checkbox",id:"strokeEnabled",checked:x.value.strokeEnabled,onChange:S},null,40,Aa),b[24]||(b[24]=e("label",{for:"strokeEnabled"},"å¯ç”¨æ–‡æœ¬æè¾¹:",-1))])]),Ce(ln,{name:"stroke-slide"},{default:St(()=>[x.value.strokeEnabled?(M(),A("div",La,[e("div",Fa,[b[25]||(b[25]=e("label",{for:"strokeColor"},"æè¾¹é¢œè‰²:",-1)),e("input",{type:"color",id:"strokeColor",value:x.value.strokeColor,onInput:w},null,40,Ua)]),e("div",Oa,[b[26]||(b[26]=e("label",{for:"strokeWidth"},"æè¾¹å®½åº¦ (px):",-1)),e("input",{type:"number",id:"strokeWidth",value:x.value.strokeWidth,min:"0",max:"10",style:{width:"60px",padding:"5px"},onInput:N},null,40,za),b[27]||(b[27]=e("div",{class:"input-hint"},"0 è¡¨ç¤ºæ— æè¾¹ã€‚",-1))])])):de("",!0)]),_:1}),e("div",Na,[b[28]||(b[28]=e("label",{for:"useInpainting"},"æ°”æ³¡å¡«å……æ–¹å¼:",-1)),Ce(We,{"model-value":x.value.inpaintMethod,options:R,onChange:l},null,8,["model-value"])]),Ce(ln,{name:"slide-fade"},{default:St(()=>[x.value.inpaintMethod==="solid"?(M(),A("div",Va,[b[29]||(b[29]=e("label",{for:"fillColor"},"å¡«å……é¢œè‰²:",-1)),e("input",{type:"color",id:"fillColor",value:x.value.fillColor,onInput:G},null,40,Wa)])):de("",!0)]),_:1})]),e("div",Ka,[e("button",{type:"button",class:"settings-button",disabled:!T.value,onClick:h}," åº”ç”¨åˆ°å…¨éƒ¨ ",8,qa),e("button",{type:"button",class:"settings-gear-btn",title:"é€‰æ‹©è¦åº”ç”¨çš„å‚æ•°",onClick:Y}," âš™ï¸ "),a.value?(M(),A("div",Ha,[e("div",ja,[e("input",{type:"checkbox",id:"apply_selectAll",checked:Object.values(c.value).every(J=>J),onChange:u},null,40,Ja),b[30]||(b[30]=e("label",{for:"apply_selectAll"},"å…¨é€‰",-1))]),b[39]||(b[39]=e("hr",null,null,-1)),e("div",Ya,[ae(e("input",{type:"checkbox",id:"apply_fontSize","onUpdate:modelValue":b[0]||(b[0]=J=>c.value.fontSize=J)},null,512),[[nt,c.value.fontSize]]),b[31]||(b[31]=e("label",{for:"apply_fontSize"},"å­—å·",-1))]),e("div",Xa,[ae(e("input",{type:"checkbox",id:"apply_fontFamily","onUpdate:modelValue":b[1]||(b[1]=J=>c.value.fontFamily=J)},null,512),[[nt,c.value.fontFamily]]),b[32]||(b[32]=e("label",{for:"apply_fontFamily"},"å­—ä½“",-1))]),e("div",Ga,[ae(e("input",{type:"checkbox",id:"apply_layoutDirection","onUpdate:modelValue":b[2]||(b[2]=J=>c.value.layoutDirection=J)},null,512),[[nt,c.value.layoutDirection]]),b[33]||(b[33]=e("label",{for:"apply_layoutDirection"},"æ’ç‰ˆæ–¹å‘",-1))]),e("div",Za,[ae(e("input",{type:"checkbox",id:"apply_textColor","onUpdate:modelValue":b[3]||(b[3]=J=>c.value.textColor=J)},null,512),[[nt,c.value.textColor]]),b[34]||(b[34]=e("label",{for:"apply_textColor"},"æ–‡å­—é¢œè‰²",-1))]),e("div",Qa,[ae(e("input",{type:"checkbox",id:"apply_fillColor","onUpdate:modelValue":b[4]||(b[4]=J=>c.value.fillColor=J)},null,512),[[nt,c.value.fillColor]]),b[35]||(b[35]=e("label",{for:"apply_fillColor"},"å¡«å……é¢œè‰²",-1))]),e("div",el,[ae(e("input",{type:"checkbox",id:"apply_strokeEnabled","onUpdate:modelValue":b[5]||(b[5]=J=>c.value.strokeEnabled=J)},null,512),[[nt,c.value.strokeEnabled]]),b[36]||(b[36]=e("label",{for:"apply_strokeEnabled"},"æè¾¹å¼€å…³",-1))]),e("div",tl,[ae(e("input",{type:"checkbox",id:"apply_strokeColor","onUpdate:modelValue":b[6]||(b[6]=J=>c.value.strokeColor=J)},null,512),[[nt,c.value.strokeColor]]),b[37]||(b[37]=e("label",{for:"apply_strokeColor"},"æè¾¹é¢œè‰²",-1))]),e("div",ol,[ae(e("input",{type:"checkbox",id:"apply_strokeWidth","onUpdate:modelValue":b[7]||(b[7]=J=>c.value.strokeWidth=J)},null,512),[[nt,c.value.strokeWidth]]),b[38]||(b[38]=e("label",{for:"apply_strokeWidth"},"æè¾¹å®½åº¦",-1))])])):de("",!0)])],512),[[Fe,r.value]])]),e("div",nl,[e("h3",{class:"collapsible-header",onClick:I},[b[40]||(b[40]=me(" æŒ‡å®šèŒƒå›´ ",-1)),e("span",sl,oe(p.value?"â–¼":"â–¶"),1)]),ae(e("div",al,[e("div",ll,[e("div",il,[e("label",rl,[ae(e("input",{type:"checkbox","onUpdate:modelValue":b[8]||(b[8]=J=>k.value=J),disabled:q.value===0},null,8,ul),[[nt,k.value]]),b[41]||(b[41]=e("span",null,"å¯ç”¨",-1))]),e("span",cl,"å…± "+oe(q.value)+" å¼ ",1)]),ae(e("div",dl,[e("input",{type:"number",id:"pageRangeStart",value:y.value,min:"1",max:q.value,onInput:j,placeholder:"èµ·å§‹"},null,40,gl),b[42]||(b[42]=e("span",{class:"range-sep"},"~",-1)),e("input",{type:"number",id:"pageRangeEnd",value:$.value,min:"1",max:q.value,onInput:ce,placeholder:"ç»“æŸ"},null,40,pl)],512),[[Fe,k.value]]),k.value&&!V.value&&q.value>0?(M(),A("div",ml," èŒƒå›´æ— æ•ˆ ")):de("",!0)])],512),[[Fe,p.value]])]),e("div",vl,[e("button",{id:"translateButton",disabled:!L.value,onClick:b[9]||(b[9]=J=>s("translateCurrent"))}," ç¿»è¯‘å½“å‰å›¾ç‰‡ ",8,fl),e("button",{id:"translateAllButton",disabled:!L.value||k.value&&!V.value,title:k.value?`ç¿»è¯‘ç¬¬ ${y.value}-${$.value} é¡µ`:"ç¿»è¯‘æ‰€æœ‰å›¾ç‰‡",onClick:ye},oe(k.value?`ç¿»è¯‘ ${y.value}-${$.value} é¡µ`:"ç¿»è¯‘æ‰€æœ‰å›¾ç‰‡"),9,bl),e("button",{id:"startHqTranslationBtn",class:"settings-button purple-button",disabled:!L.value||k.value&&!V.value,title:k.value?`é«˜è´¨é‡ç¿»è¯‘ç¬¬ ${y.value}-${$.value} é¡µ`:"ä½¿ç”¨é«˜è´¨é‡ç¿»è¯‘æ¨¡å¼ï¼ˆéœ€åœ¨è®¾ç½®ä¸­é…ç½®ï¼‰",onClick:De},oe(k.value?`é«˜è´¨é‡ç¿»è¯‘ ${y.value}-${$.value}`:"é«˜è´¨é‡ç¿»è¯‘"),9,hl),e("button",{id:"proofreadButton",disabled:!L.value||k.value&&!V.value,title:k.value?`AIæ ¡å¯¹ç¬¬ ${y.value}-${$.value} é¡µ`:"AIæ ¡å¯¹",onClick:$e},oe(k.value?`AIæ ¡å¯¹ ${y.value}-${$.value}`:"AIæ ¡å¯¹"),9,yl),e("button",{id:"removeTextOnlyButton",disabled:!D.value,title:"æ¶ˆé™¤å›¾ç‰‡ä¸­çš„æ°”æ³¡æ–‡å­—ï¼Œæ— éœ€å¡«å†™ç¿»è¯‘æœåŠ¡å•†å’ŒAPI Key",onClick:b[10]||(b[10]=J=>s("removeText"))}," ä»…æ¶ˆé™¤æ–‡å­— ",8,xl),e("button",{id:"removeAllTextButton",disabled:!T.value||k.value&&!V.value,title:k.value?`æ¶ˆé™¤ç¬¬ ${y.value}-${$.value} é¡µçš„æ–‡å­—`:"æ¶ˆé™¤æ‰€æœ‰å›¾ç‰‡ä¸­çš„æ°”æ³¡æ–‡å­—",onClick:he},oe(k.value?`æ¶ˆé™¤ ${y.value}-${$.value} é¡µæ–‡å­—`:"æ¶ˆé™¤æ‰€æœ‰å›¾ç‰‡æ–‡å­—"),9,_l),e("button",{id:"deleteCurrentImageButton",class:"settings-button red-button",disabled:!D.value,onClick:b[11]||(b[11]=J=>s("deleteCurrent"))}," åˆ é™¤å½“å‰å›¾ç‰‡ ",8,Cl),e("button",{id:"clearAllImagesButton",class:"settings-button red-button",disabled:!T.value,onClick:b[12]||(b[12]=J=>s("clearAll"))}," æ¸…é™¤æ‰€æœ‰å›¾ç‰‡ ",8,Sl),e("button",{id:"cleanDebugFilesButton",class:"settings-button orange-button",onClick:b[13]||(b[13]=J=>s("cleanTemp"))}," æ¸…ç†ä¸´æ—¶æ–‡ä»¶ "),e("button",{id:"managePluginsButton",class:"settings-button blue-button",onClick:b[14]||(b[14]=J=>s("openPlugins"))}," æ’ä»¶ç®¡ç† ")]),e("div",kl,[e("button",{id:"prevImageButton",disabled:!v.value,onClick:b[15]||(b[15]=J=>s("previous"))}," ä¸Šä¸€å¼  ",8,wl),e("button",{id:"nextImageButton",disabled:!g.value,onClick:b[16]||(b[16]=J=>s("next"))}," ä¸‹ä¸€å¼  ",8,$l)])])]))}}),Il=He(Tl,[["__scopeId","data-v-418fd3c5"]]);function Lt(n){if(n.textDirection==="vertical"||n.textDirection==="horizontal")return n.textDirection;if(n.autoTextDirection==="vertical"||n.autoTextDirection==="horizontal")return n.autoTextDirection;if(n.coords){const[t,s,o,i]=n.coords;return i-s>o-t?"vertical":"horizontal"}return"vertical"}function Pl(){const n=et(),t=ze(),s=ct(),o=C(!1),i=C(0),r=C(""),a=C(!1),c=C(0),p=C(""),k=Z(()=>n.hasImages),y=Z(()=>n.hasImages),$=Z(()=>n.hasImages);function E(){const v=n.images;if(v.length===0){s.warning("æ²¡æœ‰å¯å¯¼å‡ºçš„å›¾ç‰‡æ–‡æœ¬");return}const g=[];for(let ie=0;ie<v.length;ie++){const U=v[ie];if(!U)continue;const W=U.bubbleStates||[],te={imageIndex:ie,bubbles:[]};for(let B=0;B<W.length;B++){const d=W[B];if(!d)continue;const m=d.originalText||"",l=d.translatedText||d.textboxText||"";let f="vertical";d.textDirection&&d.textDirection!=="auto"?f=d.textDirection:d.autoTextDirection&&(f=d.autoTextDirection),te.bubbles.push({bubbleIndex:B,original:m,translated:l,textDirection:f})}g.push(te)}const x=JSON.stringify(g,null,2),_=new Blob([x],{type:"application/json"}),K=URL.createObjectURL(_),z=document.createElement("a");z.href=K;const X=new Date().toISOString().replace(/[-:T]/g,"").slice(0,15);z.download=`translations_${X}.json`,document.body.appendChild(z),z.click(),document.body.removeChild(z),URL.revokeObjectURL(K),s.success("æ–‡æœ¬å¯¼å‡ºæˆåŠŸï¼")}function R(){const v=n.images;if(v.length===0)return null;const g=[];for(let x=0;x<v.length;x++){const _=v[x];if(!_)continue;const K=_.bubbleStates||[],z={imageIndex:x,bubbles:[]};for(let se=0;se<K.length;se++){const X=K[se];if(!X)continue;const ie=X.originalText||"",U=X.translatedText||X.textboxText||"";let W="vertical";X.textDirection&&X.textDirection!=="auto"?W=X.textDirection:X.autoTextDirection&&(W=X.autoTextDirection),z.bubbles.push({bubbleIndex:se,original:ie,translated:U,textDirection:W})}g.push(z)}return g}async function D(v){if(!v){s.warning("æœªé€‰æ‹©æ–‡ä»¶");return}a.value=!0,c.value=0,p.value="å‡†å¤‡å¯¼å…¥æ–‡æœ¬...",s.info("æ­£åœ¨å¯¼å…¥æ–‡æœ¬...",0);try{const g=await T(v);c.value=10,p.value="è§£æ JSON æ•°æ®...";const x=JSON.parse(g);if(!Array.isArray(x))throw new Error("å¯¼å…¥çš„ JSON æ ¼å¼ä¸æ­£ç¡®ï¼Œåº”ä¸ºæ•°ç»„");let _=0,K=0;const z=t.settings.textStyle,se=z.autoFontSize?"auto":z.fontSize,X=z.fontFamily,ie=z.textColor,U=z.fillColor;c.value=20,p.value="å¼€å§‹æ›´æ–°å›¾ç‰‡...";const W=x.length;let te=0;const B=[];for(const l of x){te++;const f=20+te/W*60;c.value=f,p.value=`å¤„ç†å›¾ç‰‡ ${te}/${W}`;const P=l.imageIndex;if(P<0||P>=n.images.length){console.warn(`è·³è¿‡æ— æ•ˆçš„å›¾ç‰‡ç´¢å¼•: ${P}`);continue}const S=n.images[P];if(!S)continue;let w=!1;S.bubbleStates||(S.bubbleStates=[]),S.bubbleTexts||(S.bubbleTexts=[]),S.originalTexts||(S.originalTexts=[]);for(const N of l.bubbles){const G=N.bubbleIndex,Y=N.original,u=N.translated,h=N.textDirection,le=h==="vertical"||h==="horizontal"?h:"vertical";for(;S.bubbleTexts.length<=G;)S.bubbleTexts.push("");for(;S.originalTexts.length<=G;)S.originalTexts.push("");for(Y&&(S.originalTexts[G]=Y),u&&(S.bubbleTexts[G]=u);S.bubbleStates.length<=G;)S.bubbleStates.push(q(se,X,ie,U));const I=S.bubbleStates[G];I&&(Y&&(I.originalText=Y),u&&(I.translatedText=u,I.textboxText=u),I.textDirection=le,w=!0,K++)}w&&S.bubbleStates&&(S.bubbleTexts=S.bubbleStates.map(N=>N.translatedText||"")),w&&(_++,S.hasUnsavedChanges=!0,S.translatedDataURL&&S.bubbleStates&&S.bubbleStates.length>0&&B.push(P))}if(B.length>0){c.value=80,p.value="å¼€å§‹æ¸²æŸ“å›¾ç‰‡...",s.info("æ­£åœ¨æ¸²æŸ“å›¾ç‰‡ï¼Œè¯·ç¨å€™...",0);const l=t.settings.textStyle,f=l.layoutDirection,P=f==="auto";for(let S=0;S<B.length;S++){const w=B[S];if(w===void 0)continue;const N=n.images[w];if(!(!N||!N.bubbleStates)){c.value=80+S/B.length*20,p.value=`æ¸²æŸ“å›¾ç‰‡ ${S+1}/${B.length}`;try{let G="";if(N.cleanImageData?G=N.cleanImageData.includes("base64,")?N.cleanImageData.split("base64,")[1]||"":N.cleanImageData:N.originalDataURL&&(G=N.originalDataURL.includes("base64,")?N.originalDataURL.split("base64,")[1]||"":N.originalDataURL,console.log(`importText: å›¾ç‰‡ ${w} ä½¿ç”¨åŸå›¾ä½œä¸ºèƒŒæ™¯ï¼ˆå…œåº•ï¼‰`)),!G){console.log(`importText: å›¾ç‰‡ ${w} æ²¡æœ‰å¯ç”¨çš„èƒŒæ™¯å›¾ï¼Œè·³è¿‡`);continue}const Y=N.bubbleStates.map(h=>({translatedText:h.translatedText||"",coords:h.coords,fontSize:h.fontSize||l.fontSize,fontFamily:h.fontFamily||l.fontFamily,textDirection:Lt(h),textColor:h.textColor||l.textColor,rotationAngle:h.rotationAngle||0,position:h.position||{x:0,y:0},strokeEnabled:h.strokeEnabled??l.strokeEnabled,strokeColor:h.strokeColor||l.strokeColor,strokeWidth:h.strokeWidth??l.strokeWidth})),u=await yo({clean_image:G,bubble_texts:Y.map(h=>h.translatedText),bubble_coords:Y.map(h=>h.coords),fontSize:l.fontSize,fontFamily:l.fontFamily,textDirection:P?"vertical":f,textColor:l.textColor,bubble_states:Y,use_individual_styles:!0,use_inpainting:!1,use_lama:!1,is_font_style_change:!0,strokeEnabled:l.strokeEnabled,strokeColor:l.strokeColor,strokeWidth:l.strokeWidth});u.rendered_image&&(n.updateImageByIndex(w,{translatedDataURL:`data:image/png;base64,${u.rendered_image}`,hasUnsavedChanges:!0}),console.log(`importText: å›¾ç‰‡ ${w} æ¸²æŸ“æˆåŠŸ`))}catch(G){console.error(`importText: é‡æ¸²æŸ“å›¾ç‰‡ ${w} å¤±è´¥:`,G)}}}}c.value=100,p.value="å¯¼å…¥å®Œæˆ";const d=B.length,m=d>0?`å¯¼å…¥æˆåŠŸï¼æ›´æ–°äº† ${_} å¼ å›¾ç‰‡ä¸­çš„ ${K} ä¸ªæ°”æ³¡æ–‡æœ¬ï¼Œé‡æ¸²æŸ“äº† ${d} å¼ å›¾ç‰‡`:`å¯¼å…¥æˆåŠŸï¼æ›´æ–°äº† ${_} å¼ å›¾ç‰‡ä¸­çš„ ${K} ä¸ªæ°”æ³¡æ–‡æœ¬`;s.success(m)}catch(g){console.error("å¯¼å…¥æ–‡æœ¬å‡ºé”™:",g),s.error(`å¯¼å…¥å¤±è´¥: ${g instanceof Error?g.message:String(g)}`)}finally{a.value=!1,setTimeout(()=>{c.value=0,p.value=""},2e3)}}function T(v){return new Promise((g,x)=>{const _=new FileReader;_.onload=K=>{K.target?.result?g(K.target.result):x(new Error("è¯»å–æ–‡ä»¶å¤±è´¥"))},_.onerror=()=>x(new Error("è¯»å–æ–‡ä»¶æ—¶å‡ºé”™")),_.readAsText(v)})}function q(v,g,x,_){const K=t.settings.textStyle;return{coords:[0,0,100,100],polygon:[],originalText:"",translatedText:"",textboxText:"",fontSize:typeof v=="number"?v:25,fontFamily:g,textDirection:"vertical",autoTextDirection:"vertical",textColor:x,fillColor:_,rotationAngle:0,position:{x:0,y:0},strokeEnabled:K.strokeEnabled,strokeColor:K.strokeColor,strokeWidth:K.strokeWidth,inpaintMethod:K.inpaintMethod}}function V(){const v=n.currentImage;if(!v){s.warning("æ²¡æœ‰å¯ä¸‹è½½çš„å›¾ç‰‡");return}const g=v.translatedDataURL||v.originalDataURL;if(!g){s.warning("æ²¡æœ‰å¯ä¸‹è½½çš„å›¾ç‰‡");return}o.value=!0;try{const x=g.split(",")[1];if(!x)throw new Error("æ— æ•ˆçš„å›¾ç‰‡æ•°æ®");const _=atob(x),K=[];for(let W=0;W<_.length;W+=512){const te=_.slice(W,W+512),B=new Array(te.length);for(let m=0;m<te.length;m++)B[m]=te.charCodeAt(m);const d=new Uint8Array(B);K.push(d.buffer)}const z=new Blob(K,{type:"image/png"}),se=URL.createObjectURL(z),X=document.createElement("a");X.href=se;let ie=v.fileName||`image_${n.currentImageIndex}.png`;ie=`${v.translatedDataURL?"translated":"original"}_${ie.replace(/\.[^/.]+$/,"")}.png`,X.download=ie,document.body.appendChild(X),X.click(),document.body.removeChild(X),URL.revokeObjectURL(se),s.success(`ä¸‹è½½æˆåŠŸ: ${ie}`)}catch(x){console.error("ä¸‹è½½å›¾ç‰‡æ—¶å‡ºé”™:",x),s.error("ä¸‹è½½å¤±è´¥")}finally{o.value=!1}}async function L(v="zip"){const g=n.images;if(g.length===0){s.warning("æ²¡æœ‰å¯ä¸‹è½½çš„å›¾ç‰‡");return}o.value=!0,i.value=0,r.value="å‡†å¤‡ä¸‹è½½...",s.info("ä¸‹è½½ä¸­...å¤„ç†å¯èƒ½éœ€è¦ä¸€å®šæ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…...",0);try{const x=[];let _=0,K=0;i.value=5,r.value="æ£€æŸ¥å›¾ç‰‡æ•°æ®...";for(let m=0;m<g.length;m++){const l=g[m];l&&(l.translatedDataURL?(x.push({index:m,type:"translated"}),_++):l.originalDataURL&&(x.push({index:m,type:"original"}),K++))}if(x.length===0){s.warning("æ²¡æœ‰å¯ä¸‹è½½çš„å›¾ç‰‡");return}i.value=10,r.value="åˆ›å»ºä¸‹è½½ä¼šè¯...";const z=await $s(x.length);if(!z.success||!z.session_id)throw new Error(z.error||"åˆ›å»ºä¼šè¯å¤±è´¥");const se=z.session_id,X=x.length;let ie=0,U=0;for(let m=0;m<x.length;m++){const l=x[m];if(!l)continue;const f=g[l.index];if(!f)continue;const P=l.type==="translated"?f.translatedDataURL:f.originalDataURL;if(!P)continue;const S=10+m/X*70;i.value=S,r.value=`ä¸Šä¼ å›¾ç‰‡ ${m+1}/${X}...`;try{const w=await Ts(se,P,m);w.success?ie++:(console.error(`ä¸Šä¼ å›¾ç‰‡ ${m} å¤±è´¥:`,w.error),U++)}catch(w){console.error(`ä¸Šä¼ å›¾ç‰‡ ${m} å‡ºé”™:`,w),U++}}if(ie===0)throw new Error("æ‰€æœ‰å›¾ç‰‡ä¸Šä¼ å¤±è´¥");i.value=85,r.value="æ‰“åŒ…æ–‡ä»¶...";const W=await Is(se,v);if(!W.success||!W.file_id)throw new Error(W.error||"æ‰“åŒ…å¤±è´¥");i.value=95,r.value="å‡†å¤‡ä¸‹è½½...";const te=Ps(W.file_id,v),B=document.createElement("a");B.href=te,document.body.appendChild(B),B.click(),document.body.removeChild(B),i.value=100,r.value="ä¸‹è½½å·²å¼€å§‹";let d=`å·²æˆåŠŸå¤„ç† ${ie} å¼ å›¾ç‰‡`;U>0&&(d+=`ï¼ˆ${U} å¼ å¤±è´¥ï¼‰`),_>0&&K>0?d+=`ï¼ˆ${_} å¼ ç¿»è¯‘å›¾ç‰‡å’Œ ${K} å¼ åŸå§‹å›¾ç‰‡ï¼‰`:_>0?d+="ï¼ˆå…¨éƒ¨ä¸ºç¿»è¯‘åå›¾ç‰‡ï¼‰":K>0&&(d+="ï¼ˆå…¨éƒ¨ä¸ºåŸå§‹å›¾ç‰‡ï¼‰"),d+="ï¼Œä¸‹è½½å³å°†å¼€å§‹",s.success(d),setTimeout(async()=>{try{const m=await ho();console.log("ä¸´æ—¶æ–‡ä»¶æ¸…ç†ç»“æœ:",m)}catch(m){console.error("æ¸…ç†ä¸´æ—¶æ–‡ä»¶å¤±è´¥:",m)}},6e4)}catch(x){console.error("ä¸‹è½½æ‰€æœ‰å›¾ç‰‡æ—¶å‡ºé”™:",x),s.error(`ä¸‹è½½å¤±è´¥: ${x instanceof Error?x.message:String(x)}`)}finally{o.value=!1,setTimeout(()=>{i.value=0,r.value=""},2e3)}}return{isDownloading:o,downloadProgress:i,downloadProgressText:r,isImporting:a,importProgress:c,importProgressText:p,canExportText:k,canImportText:y,canDownload:$,exportText:E,exportTextToJson:R,importText:D,downloadCurrentImage:V,downloadAllImages:L}}const Rl={key:0,class:"result-section card result-card"},Dl={class:"image-controls"},Ml={class:"image-size-control"},El=["value"],Bl={id:"imageSizeValue"},Al={class:"content-container"},Ll={class:"image-container"},Fl=["src"],Ul={id:"detectedTextInfo",class:"text-info"},Ol={id:"detectedTextList"},zl={class:"original-text"},Nl={class:"download-section"},Vl={class:"download-buttons"},Wl=["disabled"],Kl={class:"download-all-container"},ql=["disabled"],Hl={class:"download-format-selector"},jl=["disabled"],Jl=["disabled"],Yl={key:1,class:"empty-state-section"},uo=60,Xl=je({__name:"ImageResultDisplay",props:{isEditMode:{type:Boolean,default:!1}},emits:["toggle-edit-mode","retry-failed"],setup(n,{emit:t}){const s=[{label:"ZIPå‹ç¼©åŒ…",value:"zip"},{label:"PDFæ–‡æ¡£",value:"pdf"},{label:"CBZæ¼«ç”»",value:"cbz"}],o=t,i=et(),r=ze(),a=Pl(),c=C(100),p=Z({get:()=>T.value?.showOriginal??!1,set:S=>{T.value&&i.updateCurrentImage({showOriginal:S})}}),k=C("zip"),y=C(null),$=Z(()=>a.isDownloading.value),E=Z(()=>a.downloadProgressText.value),R=Z(()=>a.downloadProgress.value),D=Z(()=>i.hasImages),T=Z(()=>i.currentImage),q=Z(()=>!!T.value?.translatedDataURL),V=Z(()=>!!(T.value?.translatedDataURL||T.value?.originalDataURL)),L=Z(()=>T.value?p.value||!T.value.translatedDataURL?T.value.originalDataURL:T.value.translatedDataURL:""),v=Z(()=>i.failedImageCount>0),g=Z(()=>({width:`${c.value}%`})),x=Z(()=>r.settings.useTextboxPrompt),_=Z(()=>{if(!T.value)return[];if(T.value.bubbleStates&&T.value.bubbleStates.length>0)return T.value.bubbleStates.map(N=>({original:N.originalText||"",translated:x.value?N.textboxText||N.translatedText||"":N.translatedText||""}));const S=T.value.originalTexts||[],w=x.value?T.value.textboxTexts||T.value.bubbleTexts||[]:T.value.bubbleTexts||[];return S.length===0?[]:S.map((N,G)=>({original:N||"",translated:w[G]||""}))}),K=Z(()=>_.value.length>0);function z(S){if(!S||S.length<=uo)return S;let w="",N="";for(let G=0;G<S.length;G++)if(N+=S[G],N.length>=uo){let Y=-1;for(let u=N.length-1;u>=0;u--){const h=N[u];if(h&&["ã€‚","ï¼","ï¼Ÿ",".","!","?","ï¼›",";","ï¼Œ",","].includes(h)){Y=u+1;break}}Y>uo*.6?(w+=N.substring(0,Y)+`
`,N=N.substring(Y)):(w+=N+`
`,N="")}return N&&(w+=N),w}function se(S){return z((S||"").trim())}function X(S){const w=(S||"").trim();return z(w)}function ie(S){return(S||"").includes("ç¿»è¯‘å¤±è´¥")}function U(){p.value=!p.value}function W(){o("toggle-edit-mode")}function te(S){const w=S.target;c.value=parseInt(w.value,10)}function B(){o("retry-failed")}function d(){a.downloadCurrentImage()}function m(){a.downloadAllImages(k.value)}function l(){a.exportText()}function f(){y.value?.click()}async function P(S){const w=S.target,N=w.files?.[0];N&&(await a.importText(N),w.value="")}return(S,w)=>T.value?(M(),A("section",Rl,[e("div",Dl,[q.value?(M(),A("button",{key:0,id:"toggleImageButton",class:"control-btn",onClick:U},oe(p.value?"æŸ¥çœ‹ç¿»è¯‘å›¾":"æŸ¥çœ‹åŸå›¾"),1)):de("",!0),e("button",{id:"toggleEditModeButton",class:Ie(["control-btn",{active:n.isEditMode}]),onClick:W},oe(n.isEditMode?"é€€å‡ºç¼–è¾‘":"åˆ‡æ¢ç¼–è¾‘æ¨¡å¼"),3),e("div",Ml,[w[1]||(w[1]=e("label",{for:"imageSize"},"å›¾ç‰‡å¤§å°:",-1)),e("input",{type:"range",id:"imageSize",min:"50",max:"200",value:c.value,class:"slider range-slider",onInput:te},null,40,El),e("span",Bl,oe(c.value)+"%",1)]),v.value?(M(),A("button",{key:1,id:"retranslateFailedButton",class:"retry-failed-btn",onClick:B,title:"é‡æ–°ç¿»è¯‘æ‰€æœ‰å¤±è´¥çš„å›¾ç‰‡"}," é‡æ–°ç¿»è¯‘å¤±è´¥å›¾ç‰‡ ("+oe(H(i).failedImageCount)+") ",1)):de("",!0)]),e("div",Al,[e("div",Ll,[e("img",{id:"translatedImageDisplay",src:L.value,alt:"ç¿»è¯‘åå›¾ç‰‡",style:at(g.value)},null,12,Fl)])]),e("div",Ul,[w[6]||(w[6]=e("h3",null,"æ£€æµ‹åˆ°çš„æ–‡æœ¬ï¼ˆåŸæ–‡ â†’ è¯‘æ–‡ï¼‰",-1)),e("pre",Ol,[K.value?(M(!0),A(Oe,{key:0},Ye(_.value,(N,G)=>(M(),A("span",{key:G,class:"text-item"},[e("span",zl,oe(se(N.original)),1),w[2]||(w[2]=me(`
`,-1)),e("span",{class:Ie(["translated-text",{"translation-error":ie(N.translated)}])},oe(X(N.translated)),3),w[3]||(w[3]=me(`
`,-1)),w[4]||(w[4]=e("span",{class:"separator"},"â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€",-1)),w[5]||(w[5]=me(`

`,-1))]))),128)):(M(),A(Oe,{key:1},[me("æœªæ£€æµ‹åˆ°æ–‡æœ¬æˆ–å°šæœªç¿»è¯‘")],64))])]),e("div",Nl,[$.value?(M(),ut(Co,{key:0,visible:!0,percentage:R.value,label:E.value||"ä¸‹è½½ä¸­ï¼Œè¯·ç¨å€™..."},null,8,["percentage","label"])):de("",!0),e("div",Vl,[e("button",{id:"downloadButton",class:"download-btn primary",disabled:!V.value,onClick:d}," ä¸‹è½½å½“å‰å›¾ç‰‡ ",8,Wl),e("div",Kl,[e("button",{id:"downloadAllImagesButton",class:"download-btn primary",disabled:!D.value,onClick:m}," ä¸‹è½½æ‰€æœ‰å›¾ç‰‡ ",8,ql),e("div",Hl,[Ce(We,{modelValue:k.value,"onUpdate:modelValue":w[0]||(w[0]=N=>k.value=N),options:s},null,8,["modelValue"])])]),e("button",{id:"exportTextButton",class:"download-btn success",disabled:!D.value,onClick:l}," å¯¼å‡ºæ–‡æœ¬ ",8,jl),e("button",{id:"importTextButton",class:"download-btn success",disabled:!D.value,onClick:f}," å¯¼å…¥æ–‡æœ¬ ",8,Jl),e("input",{type:"file",ref_key:"importFileInput",ref:y,id:"importTextFileInput",style:{display:"none"},accept:".json",onChange:P},null,544)])])])):(M(),A("section",Yl))}}),Gl=He(Xl,[["__scopeId","data-v-a26b9c58"]]),Zl={class:"guide-content"},Ql={class:"guide-footer"},ei={class:"dont-show-option"},Vt="saber_translator_dismiss_setup_reminder",ti=je({__name:"FirstTimeGuide",emits:["openSettings"],setup(n,{expose:t,emit:s}){const o=s,i=C(!1),r=C(!1);dt(()=>{localStorage.getItem(Vt)!=="true"&&(i.value=!0)});function a(){r.value&&localStorage.setItem(Vt,"true"),i.value=!1}function c(){localStorage.setItem(Vt,"true"),i.value=!1,o("openSettings")}function p(){localStorage.removeItem(Vt)}return t({resetGuideState:p,showGuide:i}),(k,y)=>(M(),ut(Tn,{"model-value":i.value,title:"æ¬¢è¿ä½¿ç”¨ Saber-Translator",onClose:a},{default:St(()=>[e("div",Zl,[y[3]||(y[3]=e("div",{class:"guide-icon"},"ğŸ‰",-1)),y[4]||(y[4]=e("div",{class:"guide-message"},[e("p",{class:"guide-title"},"é¦–æ¬¡ä½¿ç”¨æé†’"),e("p",{class:"guide-text"}," åœ¨å¼€å§‹ç¿»è¯‘ä¹‹å‰ï¼Œè¯·å…ˆé…ç½®ç¿»è¯‘æœåŠ¡ã€‚ "),e("p",{class:"guide-text"},[me(" ç‚¹å‡»å³ä¸Šè§’çš„ "),e("span",{class:"highlight"},"âš™ï¸ è®¾ç½®"),me(" æŒ‰é’®ï¼Œé…ç½®ä»¥ä¸‹å†…å®¹ï¼š ")]),e("ul",{class:"guide-list"},[e("li",null,"é€‰æ‹© OCR å¼•æ“ï¼ˆæ–‡å­—è¯†åˆ«ï¼‰"),e("li",null,"é…ç½®ç¿»è¯‘æœåŠ¡å•†å’Œ API Key"),e("li",null,"ï¼ˆå¯é€‰ï¼‰é…ç½®é«˜è´¨é‡ç¿»è¯‘å’Œ AI æ ¡å¯¹")])],-1)),e("div",{class:"guide-actions"},[e("button",{class:"guide-btn primary",onClick:c},[...y[1]||(y[1]=[e("span",{class:"btn-icon"},"âš™ï¸",-1),me(" ç«‹å³é…ç½® ",-1)])]),e("button",{class:"guide-btn secondary",onClick:a}," ç¨åé…ç½® ")]),e("div",Ql,[e("label",ei,[ae(e("input",{type:"checkbox","onUpdate:modelValue":y[0]||(y[0]=$=>r.value=$)},null,512),[[nt,r.value]]),y[2]||(y[2]=e("span",null,"ä¸å†æ˜¾ç¤ºæ­¤æé†’",-1))])])])]),_:1},8,["model-value"]))}}),oi=He(ti,[["__scopeId","data-v-eda18e4a"]]),co="saber_translator_dismiss_setup_reminder",ni=["siliconflow","deepseek","volcano","caiyun","baidu_translate","youdao_translate","gemini","custom_openai"],si={manga_ocr:"MangaOCR",paddle_ocr:"PaddleOCR",baidu_ocr:"ç™¾åº¦OCR",ai_vision:"AIè§†è§‰OCR"},ai=["ollama","sakura"],li=["custom_openai"],ii=["custom_openai"],ri={siliconflow:"SiliconFlow",deepseek:"DeepSeek",volcano:"ç«å±±å¼•æ“",caiyun:"å½©äº‘å°è¯‘",baidu_translate:"ç™¾åº¦ç¿»è¯‘",youdao_translate:"æœ‰é“ç¿»è¯‘",gemini:"Google Gemini",custom_openai:"è‡ªå®šä¹‰ OpenAI",ollama:"Ollama",sakura:"Sakura"};function En(){const n=ze(),t=ct(),s=C(!1),o=C(!1),i=Z(()=>{try{return localStorage.getItem(co)==="true"}catch{return!1}});function r(_){return ri[_]||_}function a(_){return ni.includes(_)}function c(_){return ai.includes(_)}function p(_){return li.includes(_)}function k(_){return ii.includes(_)}function y(_){return si[_]||_}function $(){const _=n.settings,K=_.ocrEngine,z=_.baiduOcr,se=_.aiVisionOcr,X=[];return K?(K==="baidu_ocr"&&((!z?.apiKey||z.apiKey.trim()==="")&&X.push("ç™¾åº¦OCR çš„ API Key"),(!z?.secretKey||z.secretKey.trim()==="")&&X.push("ç™¾åº¦OCR çš„ Secret Key")),K==="ai_vision"&&(se?.provider||X.push("AIè§†è§‰OCR çš„æœåŠ¡å•†"),(!se?.apiKey||se.apiKey.trim()==="")&&X.push("AIè§†è§‰OCR çš„ API Key"),(!se?.modelName||se.modelName.trim()==="")&&X.push("AIè§†è§‰OCR çš„æ¨¡å‹åç§°"),se?.provider==="custom"&&(!se?.customBaseUrl||se.customBaseUrl.trim()==="")&&X.push("AIè§†è§‰OCR çš„è‡ªå®šä¹‰ Base URL")),X.length>0?{valid:!1,message:`è¯·å…ˆåœ¨é¡¶éƒ¨ âš™ï¸ è®¾ç½®èœå•ä¸­å¡«å†™ ${X[0]}`,missingItems:X}:{valid:!0,message:""}):{valid:!1,message:"è¯·å…ˆåœ¨é¡¶éƒ¨ âš™ï¸ è®¾ç½®èœå•ä¸­é€‰æ‹© OCR å¼•æ“",missingItems:["OCR å¼•æ“"]}}function E(){const{translation:_}=n.settings,{provider:K,apiKey:z,modelName:se,customBaseUrl:X}=_,ie=[];return K?(a(K)&&(!z||z.trim()==="")&&ie.push(`${r(K)} çš„ API Key`),(!se||se.trim()==="")&&(c(K)||a(K))&&ie.push(`${r(K)} çš„æ¨¡å‹åç§°`),p(K)&&(!X||X.trim()==="")&&ie.push("è‡ªå®šä¹‰ OpenAI æœåŠ¡çš„ Base URL"),ie.length>0?{valid:!1,message:`è¯·å…ˆåœ¨é¡¶éƒ¨ âš™ï¸ è®¾ç½®èœå•ä¸­å¡«å†™ ${ie[0]}`,missingItems:ie}:{valid:!0,message:""}):{valid:!1,message:"è¯·å…ˆåœ¨é¡¶éƒ¨ âš™ï¸ è®¾ç½®èœå•ä¸­é€‰æ‹©ç¿»è¯‘æœåŠ¡å•†",missingItems:["ç¿»è¯‘æœåŠ¡å•†"]}}function R(){const{hqTranslation:_}=n.settings,{provider:K,apiKey:z,modelName:se,customBaseUrl:X}=_,ie=[];return K?((!z||z.trim()==="")&&ie.push("é«˜è´¨é‡ç¿»è¯‘çš„ API Key"),(!se||se.trim()==="")&&ie.push("é«˜è´¨é‡ç¿»è¯‘çš„æ¨¡å‹åç§°"),k(K)&&(!X||X.trim()==="")&&ie.push("é«˜è´¨é‡ç¿»è¯‘çš„ Base URL"),ie.length>0?{valid:!1,message:`è¯·å…ˆåœ¨é¡¶éƒ¨ âš™ï¸ è®¾ç½®èœå•ä¸­å¡«å†™ ${ie[0]}`,missingItems:ie}:{valid:!0,message:""}):{valid:!1,message:"è¯·å…ˆåœ¨é¡¶éƒ¨ âš™ï¸ è®¾ç½®èœå•ä¸­é€‰æ‹©é«˜è´¨é‡ç¿»è¯‘çš„æœåŠ¡å•†",missingItems:["é«˜è´¨é‡ç¿»è¯‘æœåŠ¡å•†"]}}function D(_){const K=_||n.settings.proofreading.rounds,z=[];if(!K||K.length===0)return{valid:!1,message:"è¯·å…ˆåœ¨é¡¶éƒ¨ âš™ï¸ è®¾ç½®èœå•ä¸­æ·»åŠ è‡³å°‘ä¸€ä¸ªæ ¡å¯¹è½®æ¬¡",missingItems:["æ ¡å¯¹è½®æ¬¡"]};for(let se=0;se<K.length;se++){const X=K[se];if(!X)continue;const ie=X.name||`è½®æ¬¡${se+1}`;if(X.provider||z.push(`æ ¡å¯¹ ${ie} çš„æœåŠ¡å•†`),(!X.apiKey||X.apiKey.trim()==="")&&z.push(`æ ¡å¯¹ ${ie} çš„ API Key`),(!X.modelName||X.modelName.trim()==="")&&z.push(`æ ¡å¯¹ ${ie} çš„æ¨¡å‹åç§°`),z.length>0)return{valid:!1,message:`è¯·å…ˆåœ¨é¡¶éƒ¨ âš™ï¸ è®¾ç½®èœå•ä¸­ä¸º ${z[0]}`,missingItems:z}}return{valid:!0,message:""}}function T(_="normal",K={}){let z;switch(_){case"normal":z=E();break;case"hq":z=R();break;case"proofread":z=D(K.proofreadingRounds);break;case"ocr":z=$();break;default:z=E()}return z.valid?!0:(t.error(z.message),V(),!1)}function q(){const _=$();if(!_.valid)return t.error(_.message),V(),!1;const K=E();return K.valid?!0:(t.error(K.message),V(),!1)}function V(){const _=document.getElementById("openSettingsBtn");_&&(o.value=!0,_.style.animation="settingsBtnPulse 0.5s ease-in-out 3",_.style.boxShadow="0 0 10px var(--primary-color, #4a90d9)",setTimeout(()=>{_.style.animation="",_.style.boxShadow="",o.value=!1},3e3))}function L(){if(i.value){console.log("ç”¨æˆ·å·²é€‰æ‹©ä¸å†æ˜¾ç¤ºè®¾ç½®æé†’");return}s.value=!0}function v(_=!1){if(_)try{localStorage.setItem(co,"true"),console.log("ç”¨æˆ·é€‰æ‹©æ°¸ä¹…å…³é—­è®¾ç½®æé†’")}catch(K){console.error("ä¿å­˜è®¾ç½®æé†’çŠ¶æ€å¤±è´¥:",K)}s.value=!1}function g(){try{localStorage.removeItem(co),console.log("è®¾ç½®æé†’çŠ¶æ€å·²é‡ç½®")}catch(_){console.error("é‡ç½®è®¾ç½®æé†’çŠ¶æ€å¤±è´¥:",_)}}function x(){setTimeout(()=>{L()},500)}return{showSetupReminder:s,isSettingsButtonHighlighted:o,isSetupReminderDismissed:i,validateOcrConfig:$,validateTranslationConfig:E,validateHqTranslationConfig:R,validateProofreadingConfig:D,validateBeforeTranslation:T,validateFullTranslationConfig:q,highlightSettingsButton:V,checkAndShowSetupReminder:L,closeSetupReminder:v,resetSetupReminderDismiss:g,initValidation:x,getProviderDisplayName:r,getOcrEngineDisplayName:y,requiresApiKey:a,isLocalProvider:c,requiresBaseUrl:p}}const gt=Jt("bubble",()=>{const n=C([]),t=C(-1),s=C([]),o=C([]),i=C(!1),r=C(-1),a=C(0),c=C(0),p=C(0),k=C(0),y=C(!1),$=C(-1),E=C(null),R=C(!1),D=C(-1),T=C(0),q=Z(()=>t.value>=0&&t.value<n.value.length?n.value[t.value]??null:null),V=Z(()=>n.value.length),L=Z(()=>n.value.length>0),v=Z(()=>t.value>=0),g=Z(()=>s.value.length>1),x=Z(()=>s.value.filter(I=>I>=0&&I<n.value.length).map(I=>n.value[I]).filter(I=>I!==void 0));function _(){const j=et().currentImage;j&&(j.bubbleStates=Nt(n.value),j.hasUnsavedChanges=!0,console.log("æ°”æ³¡çŠ¶æ€å·²åŒæ­¥åˆ°å½“å‰å›¾ç‰‡"))}function K(I,j=!1){n.value=I,o.value=Nt(I),B(),console.log(`æ°”æ³¡æ•°ç»„å·²è®¾ç½®ï¼Œå…± ${I.length} ä¸ªæ°”æ³¡`),j||_()}function z(I,j){const ce=ta(I),De=ze().settings.textStyle,$e=De.layoutDirection,he=$e==="vertical"||$e==="horizontal"?$e:ce==="vertical"||ce==="horizontal"?ce:"vertical",ee=ea({coords:I,translatedText:"",autoTextDirection:ce,fontSize:De.fontSize,fontFamily:De.fontFamily,textDirection:he,textColor:De.textColor,fillColor:De.fillColor,inpaintMethod:De.inpaintMethod,strokeEnabled:De.strokeEnabled,strokeColor:De.strokeColor,strokeWidth:De.strokeWidth,rotationAngle:0,position:{x:0,y:0},...j});return n.value.push(ee),console.log(`å·²æ·»åŠ æ°”æ³¡ï¼Œå½“å‰å…± ${n.value.length} ä¸ª`),_(),ee}function se(I){return I<0||I>=n.value.length?(console.warn(`åˆ é™¤å¤±è´¥: æ— æ•ˆçš„ç´¢å¼• ${I}`),!1):(n.value.splice(I,1),t.value===I?t.value=-1:t.value>I&&t.value--,s.value=s.value.filter(j=>j!==I).map(j=>j>I?j-1:j),console.log(`å·²åˆ é™¤æ°”æ³¡ï¼Œå½“å‰å…± ${n.value.length} ä¸ª`),_(),!0)}function X(){if(s.value.length===0&&t.value<0)return;const I=[...new Set([...s.value,t.value])].filter(j=>j>=0).sort((j,ce)=>ce-j);for(const j of I)n.value.splice(j,1);B(),console.log(`å·²åˆ é™¤ ${I.length} ä¸ªæ°”æ³¡`),_()}function ie(){n.value=[],o.value=[],B(),console.log("æ‰€æœ‰æ°”æ³¡å·²æ¸…é™¤"),_()}function U(){n.value=[],o.value=[],B(),console.log("æœ¬åœ°æ°”æ³¡çŠ¶æ€å·²æ¸…é™¤ï¼ˆä¸åŒæ­¥åˆ°imageStoreï¼‰")}function W(I){I>=-1&&I<n.value.length&&(t.value=I,s.value=I>=0?[I]:[],console.log(`å·²é€‰ä¸­æ°”æ³¡ ${I}`))}function te(I){if(I<0||I>=n.value.length)return;const j=s.value.indexOf(I);j>=0?(s.value.splice(j,1),t.value===I&&(t.value=s.value[0]??-1)):(s.value.push(I),t.value=I),console.log(`å¤šé€‰çŠ¶æ€: ${s.value.join(", ")}`)}function B(){t.value=-1,s.value=[]}function d(){t.value>=0?s.value=[t.value]:s.value=[]}function m(){if(n.value.length===0)return!1;const I=t.value<n.value.length-1?t.value+1:0;return W(I),!0}function l(){if(n.value.length===0)return!1;const I=t.value>0?t.value-1:n.value.length-1;return W(I),!0}function f(I,j){if(I<0||I>=n.value.length)return console.warn(`æ›´æ–°å¤±è´¥: æ— æ•ˆçš„ç´¢å¼• ${I}`),!1;const ce=n.value[I];return ce?(Object.assign(ce,j),console.log(`å·²æ›´æ–°æ°”æ³¡ ${I}`),_(),!0):!1}function P(I){return t.value<0?(console.warn("æ›´æ–°å¤±è´¥: æ²¡æœ‰é€‰ä¸­çš„æ°”æ³¡"),!1):f(t.value,I)}function S(I){const j=s.value.length>0?s.value:t.value>=0?[t.value]:[];for(const ce of j){const ye=n.value[ce];ye&&Object.assign(ye,I)}_(),console.log(`å·²æ‰¹é‡æ›´æ–° ${j.length} ä¸ªæ°”æ³¡`)}function w(I){for(let j=0;j<n.value.length;j++){const ce=n.value[j];ce&&Object.assign(ce,I)}_(),console.log(`å·²æ›´æ–°æ‰€æœ‰ ${n.value.length} ä¸ªæ°”æ³¡`)}function N(){if(n.value.length!==o.value.length)return!0;for(let I=0;I<n.value.length;I++){const j=n.value[I],ce=o.value[I];if(!(!j||!ce)&&(j.translatedText!==ce.translatedText||j.textboxText!==ce.textboxText||j.fontSize!==ce.fontSize||j.fontFamily!==ce.fontFamily||j.textDirection!==ce.textDirection||j.textColor!==ce.textColor||j.fillColor!==ce.fillColor||j.rotationAngle!==ce.rotationAngle||j.strokeEnabled!==ce.strokeEnabled||j.strokeColor!==ce.strokeColor||j.strokeWidth!==ce.strokeWidth||j.inpaintMethod!==ce.inpaintMethod||JSON.stringify(j.coords)!==JSON.stringify(ce.coords)))return!0}return!1}function G(){n.value=Nt(o.value),B(),console.log("æ°”æ³¡çŠ¶æ€å·²é‡ç½®åˆ°åˆå§‹çŠ¶æ€")}function Y(){o.value=Nt(n.value),console.log("å½“å‰çŠ¶æ€å·²ä¿å­˜ä¸ºåˆå§‹çŠ¶æ€")}function u(){return{bubble_coords:n.value.map(I=>I.coords),bubble_texts:n.value.map(I=>I.translatedText),textbox_texts:n.value.map(I=>I.textboxText),font_sizes:n.value.map(I=>I.fontSize),font_families:n.value.map(I=>I.fontFamily),text_directions:n.value.map(I=>I.textDirection==="vertical"||I.textDirection==="horizontal"?I.textDirection==="vertical"?"v":"h":I.autoTextDirection==="vertical"||I.autoTextDirection==="horizontal"?I.autoTextDirection==="vertical"?"v":"h":"v"),text_colors:n.value.map(I=>I.textColor),fill_colors:n.value.map(I=>I.fillColor),rotation_angles:n.value.map(I=>I.rotationAngle),stroke_enabled:n.value.map(I=>I.strokeEnabled),stroke_colors:n.value.map(I=>I.strokeColor),stroke_widths:n.value.map(I=>I.strokeWidth),inpaint_methods:n.value.map(I=>I.inpaintMethod)}}function h(){return JSON.stringify(n.value)}function le(I){try{const j=JSON.parse(I);if(!Array.isArray(j))return console.error("ååºåˆ—åŒ–å¤±è´¥: æ•°æ®ä¸æ˜¯æ•°ç»„"),!1;const ce=[];for(const ye of j)oa(ye)?ce.push(ye):console.warn("è·³è¿‡æ— æ•ˆçš„æ°”æ³¡çŠ¶æ€:",ye);return K(ce),!0}catch(j){return console.error("ååºåˆ—åŒ–å¤±è´¥:",j),!1}}return{bubbles:n,selectedIndex:t,selectedIndices:s,initialStates:o,isDragging:i,draggingIndex:r,dragOffsetX:a,dragOffsetY:c,dragInitialX:p,dragInitialY:k,isResizing:y,resizingIndex:$,resizeCurrentCoords:E,isRotating:R,rotatingIndex:D,rotateCurrentAngle:T,selectedBubble:q,bubbleCount:V,hasBubbles:L,hasSelection:v,isMultiSelect:g,selectedBubbles:x,setBubbles:K,addBubble:z,deleteBubble:se,deleteSelected:X,clearBubbles:ie,clearBubblesLocal:U,selectBubble:W,toggleMultiSelect:te,clearSelection:B,clearMultiSelect:d,selectNext:m,selectPrevious:l,updateBubble:f,updateSelectedBubble:P,updateAllSelected:S,updateAllBubbles:w,hasChanges:N,resetToInitial:G,saveAsInitial:Y,toApiRequest:u,serialize:h,deserialize:le}}),ui=Object.freeze(Object.defineProperty({__proto__:null,useBubbleStore:gt},Symbol.toStringTag,{value:"Module"}));function ci(){const n=C({current:0,total:0,completed:0,failed:0,isInProgress:!1,label:"",percentage:0});return{progress:n,reporter:{init(s,o){n.value={current:0,total:s,completed:0,failed:0,isInProgress:!0,label:o||"å‡†å¤‡ä¸­...",percentage:0}},update(s,o){n.value.current=s,o!==void 0&&(n.value.label=o),n.value.total>0&&(n.value.percentage=Math.round(s/n.value.total*100))},setPercentage(s,o){n.value.percentage=Math.min(100,Math.max(0,s)),o!==void 0&&(n.value.label=o)},incrementCompleted(){n.value.completed++},incrementFailed(){n.value.failed++},finish(){n.value.isInProgress=!1,n.value.percentage=100},getProgress(){return{...n.value}}}}}async function So(n){return Xe.post("/api/parallel/detect",n)}async function ko(n){return Xe.post("/api/parallel/ocr",n)}async function wo(n){return Xe.post("/api/parallel/color",n)}async function $o(n){return Xe.post("/api/parallel/translate",n)}async function To(n){return Xe.post("/api/parallel/inpaint",n)}async function Io(n){return Xe.post("/api/parallel/render",n)}const di=Object.freeze(Object.defineProperty({__proto__:null,parallelColor:wo,parallelDetect:So,parallelInpaint:To,parallelOcr:ko,parallelRender:Io,parallelTranslate:$o},Symbol.toStringTag,{value:"Module"}));let Tt=null,Ft=!1;function Pt(){const n=It();return ze().settings.autoSaveInBookshelfMode&&n.isBookshelfMode}function Po(){const n=It(),t=n.currentBookId,s=n.currentChapterId;return!t||!s?null:`bookshelf/${t}/${s}`}function Bn(){const n=ze(),{textStyle:t}=n.settings;return{fontSize:t.fontSize,autoFontSize:t.autoFontSize,fontFamily:t.fontFamily,layoutDirection:t.layoutDirection,textColor:t.textColor,useInpaintingMethod:t.inpaintMethod,fillColor:t.fillColor,strokeEnabled:t.strokeEnabled,strokeColor:t.strokeColor,strokeWidth:t.strokeWidth,useAutoTextColor:t.useAutoTextColor}}async function An(n){const t=et();if(!Pt())return console.log("[AutoSave] è‡ªåŠ¨ä¿å­˜æœªå¯ç”¨æˆ–éä¹¦æ¶æ¨¡å¼ï¼Œè·³è¿‡é¢„ä¿å­˜"),!0;const s=Po();if(!s)return console.warn("[AutoSave] ç¼ºå°‘ä¹¦ç±/ç« èŠ‚IDï¼Œè·³è¿‡é¢„ä¿å­˜"),n?.onError?.("ç¼ºå°‘ä¹¦ç±/ç« èŠ‚ID"),!1;const o=t.images,i=o.length;if(i===0)return console.warn("[AutoSave] æ²¡æœ‰å›¾ç‰‡ï¼Œè·³è¿‡é¢„ä¿å­˜"),n?.onError?.("æ²¡æœ‰å›¾ç‰‡"),!1;console.log(`[AutoSave] é¢„ä¿å­˜å¼€å§‹ï¼š${i} é¡µï¼ˆé€é¡µä¿å­˜ï¼‰`),n?.onStart?.(i);try{const{saveAllPagesSequentially:r,saveSessionMeta:a}=await rt(async()=>{const{saveAllPagesSequentially:E,saveSessionMeta:R}=await Promise.resolve().then(()=>Mn);return{saveAllPagesSequentially:E,saveSessionMeta:R}},void 0),c=Bn(),p=await r(s,o,{onProgress:(E,R)=>{n?.onProgress?.(E,R)}});await a(s,{ui_settings:c,total_pages:i,currentImageIndex:t.currentImageIndex});const k=It(),y=k.currentBookId,$=k.currentChapterId;if(y&&$)try{const{apiClient:E}=await rt(async()=>{const{apiClient:R}=await import("./client.Bht704G-.js");return{apiClient:R}},__vite__mapDeps([4,5]));await E.put(`/api/bookshelf/books/${y}/chapters/${$}/image-count`,{count:i}),console.log(`[AutoSave] å·²æ›´æ–°ç« èŠ‚å›¾ç‰‡æ•°é‡ä¸º ${i}`)}catch(E){console.warn("[AutoSave] æ›´æ–°ç« èŠ‚å›¾ç‰‡æ•°é‡å¤±è´¥ï¼ˆéè‡´å‘½ï¼‰:",E)}return Tt=s,Ft=!0,console.log(`[AutoSave] é¢„ä¿å­˜å®Œæˆï¼Œå…±ä¿å­˜ ${p}/${i} é¡µ`),n?.onComplete?.(),!0}catch(r){console.error("[AutoSave] é¢„ä¿å­˜å¤±è´¥:",r);const a=r instanceof Error?r.message:"é¢„ä¿å­˜å¤±è´¥";return n?.onError?.(a),Tt=null,Ft=!1,!1}}async function Ln(n){if(!Pt())return;const t=Tt||Po();if(!t){console.warn("[AutoSave] ä¼šè¯è·¯å¾„ä¸å­˜åœ¨ï¼Œè·³è¿‡ä¿å­˜");return}const s=et(),o=s.images[n];if(!o){console.warn(`[AutoSave] é¡µé¢ ${n} ä¸å­˜åœ¨`);return}try{const i={};o.translatedDataURL?.startsWith("data:")&&(i.translated=o.translatedDataURL),o.cleanImageData&&typeof o.cleanImageData=="string"&&!o.cleanImageData.startsWith("/api/")&&(i.clean=o.cleanImageData.startsWith("data:")?o.cleanImageData:`data:image/png;base64,${o.cleanImageData}`);const r={};for(const c of Object.keys(o))["originalDataURL","translatedDataURL","cleanImageData"].includes(c)||(r[c]=o[c]);i.meta=r;const a=await Dn(t,n,i);if(!a.success)throw new Error(a.error||"ä¿å­˜å¤±è´¥");s.updateImageByIndex(n,{hasUnsavedChanges:!1}),console.log(`[AutoSave] é¡µé¢ ${n+1} å·²ä¿å­˜`)}catch(i){throw console.error(`[AutoSave] ä¿å­˜é¡µé¢ ${n+1} å¤±è´¥:`,i),i}}async function Fn(){if(!Pt())return;const n=Tt||Po();if(!n||!Ft){console.log("[AutoSave] æœªæ‰§è¡Œé¢„ä¿å­˜ï¼Œè·³è¿‡å®Œæˆä¿å­˜");return}console.log("[AutoSave] å®Œæˆä¿å­˜...");const t=et(),s=It(),o=t.images.length;try{await Pn(n,{ui_settings:Bn(),total_pages:o,currentImageIndex:t.currentImageIndex});const i=s.currentBookId,r=s.currentChapterId;if(i&&r)try{const{apiClient:a}=await rt(async()=>{const{apiClient:c}=await import("./client.Bht704G-.js");return{apiClient:c}},__vite__mapDeps([4,5]));await a.put(`/api/bookshelf/books/${i}/chapters/${r}/image-count`,{count:o}),console.log(`[AutoSave] å·²æ›´æ–°ç« èŠ‚å›¾ç‰‡æ•°é‡ä¸º ${o}`)}catch(a){console.warn("[AutoSave] æ›´æ–°ç« èŠ‚å›¾ç‰‡æ•°é‡å¤±è´¥ï¼ˆéè‡´å‘½ï¼‰:",a)}console.log("[AutoSave] ä¼šè¯ä¿å­˜å®Œæˆ")}catch(i){console.error("[AutoSave] å®Œæˆä¿å­˜å¤±è´¥:",i)}finally{Tt=null,Ft=!1}}function Un(){Tt=null,Ft=!1,console.log("[AutoSave] ä¿å­˜çŠ¶æ€å·²é‡ç½®")}const vn={standard:["detection","ocr","color","translate","inpaint","render"],hq:["detection","ocr","color","aiTranslate","inpaint","render"],proofread:["aiTranslate","render"],removeText:["detection","inpaint","render"]},Wt={detection:"æ°”æ³¡æ£€æµ‹",ocr:"æ–‡å­—è¯†åˆ«",color:"é¢œè‰²æå–",translate:"ç¿»è¯‘",aiTranslate:"AIç¿»è¯‘",inpaint:"èƒŒæ™¯ä¿®å¤",render:"æ¸²æŸ“",save:"ä¿å­˜"};function gi(){const n=et(),t=gt(),s=ze(),o=En(),i=ct(),{progress:r,reporter:a}=ci(),c=C(!1),p=C(null);let k=null,y="standard";const $=Z(()=>c.value||n.isBatchTranslationInProgress),E=Z(()=>r.value.percentage||0);function R(){const l=s.settings.translation.rpmLimit;p.value?p.value.setRpm(l):p.value=na(l)}function D(l){const f=l.mode==="hq"?"hq":l.mode==="proofread"?"proofread":l.mode==="removeText"?"ocr":"normal";return o.validateBeforeTranslation(f)}function T(){const{textStyle:l}=s.settings,f=l.layoutDirection;k={fontFamily:l.fontFamily,fontSize:l.fontSize,autoFontSize:l.autoFontSize,autoTextDirection:f==="auto",textDirection:f==="auto"?"vertical":f,layoutDirection:f,fillColor:l.fillColor,textColor:l.textColor,rotationAngle:0,strokeEnabled:l.strokeEnabled,strokeColor:l.strokeColor,strokeWidth:l.strokeWidth,useAutoTextColor:l.useAutoTextColor}}function q(l){return l.includes("base64,")?l.split("base64,")[1]||"":l}function V(l){const f=n.images;if(l.scope==="current"){const P=n.currentImage;return P?[{image:P,index:n.currentImageIndex}]:[]}if(l.scope==="failed")return n.getFailedImageIndices().map(P=>({image:f[P],index:P})).filter(P=>P.image!==void 0);if(l.scope==="range"&&l.pageRange){const P=Math.max(0,l.pageRange.startPage-1),S=Math.min(f.length-1,l.pageRange.endPage-1);return P>S||P>=f.length?[]:f.slice(P,S+1).map((w,N)=>({image:w,index:P+N}))}return f.map((P,S)=>({image:P,index:S}))}async function L(l){const f=s.settings,P=q(l.image.originalDataURL),S=await So({image:P,detector_type:f.textDetector,box_expand_ratio:f.boxExpand.ratio,box_expand_top:f.boxExpand.top,box_expand_bottom:f.boxExpand.bottom,box_expand_left:f.boxExpand.left,box_expand_right:f.boxExpand.right});if(!S.success)throw new Error(S.error||"æ£€æµ‹å¤±è´¥");l.bubbleCoords=S.bubble_coords||[],l.bubbleAngles=S.bubble_angles||[],l.bubblePolygons=S.bubble_polygons||[],l.autoDirections=S.auto_directions||[],l.rawMask=S.raw_mask,l.textlinesPerBubble=S.textlines_per_bubble||[]}async function v(l){if(l.bubbleCoords.length===0){l.originalTexts=[];return}const f=s.settings,P=q(l.image.originalDataURL),S=f.ocrEngine==="paddleocr_vl"?f.paddleOcrVl?.sourceLanguage||"japanese":f.sourceLanguage,w=await ko({image:P,bubble_coords:l.bubbleCoords,source_language:S,ocr_engine:f.ocrEngine,baidu_api_key:f.baiduOcr?.apiKey,baidu_secret_key:f.baiduOcr?.secretKey,baidu_version:f.baiduOcr?.version,baidu_ocr_language:f.baiduOcr?.sourceLanguage,ai_vision_provider:f.aiVisionOcr?.provider,ai_vision_api_key:f.aiVisionOcr?.apiKey,ai_vision_model_name:f.aiVisionOcr?.modelName,ai_vision_ocr_prompt:f.aiVisionOcr?.prompt,custom_ai_vision_base_url:f.aiVisionOcr?.customBaseUrl,textlines_per_bubble:l.textlinesPerBubble});if(!w.success)throw new Error(w.error||"OCRå¤±è´¥");l.originalTexts=w.original_texts||[]}async function g(l){if(l.bubbleCoords.length===0){l.colors=[];return}const f=q(l.image.originalDataURL),P=await wo({image:f,bubble_coords:l.bubbleCoords,textlines_per_bubble:l.textlinesPerBubble});if(!P.success)throw new Error(P.error||"é¢œè‰²æå–å¤±è´¥");l.colors=P.colors||[]}async function x(l){if(l.originalTexts.length===0){l.translatedTexts=[],l.textboxTexts=[];return}const f=s.settings,P=await $o({original_texts:l.originalTexts,target_language:f.targetLanguage,source_language:f.sourceLanguage,model_provider:f.translation.provider,model_name:f.translation.modelName,api_key:f.translation.apiKey,custom_base_url:f.translation.customBaseUrl,prompt_content:f.translatePrompt,textbox_prompt_content:f.textboxPrompt,use_textbox_prompt:f.useTextboxPrompt,rpm_limit:f.translation.rpmLimit,max_retries:f.translation.maxRetries,use_json_format:f.translation.isJsonMode});if(!P.success)throw new Error(P.error||"ç¿»è¯‘å¤±è´¥");l.translatedTexts=P.translated_texts||[],l.textboxTexts=P.textbox_texts||[]}async function _(l){const f=s.settings,P=y==="proofread",S=l.map(he=>P?{imageIndex:he.imageIndex,bubbles:(he.image.bubbleStates||[]).map((ee,b)=>({bubbleIndex:b,original:ee.originalText||"",translated:f.useTextboxPrompt?ee.textboxText||ee.translatedText||"":ee.translatedText||"",textDirection:ee.textDirection==="vertical"||ee.textDirection==="horizontal"?ee.textDirection:ee.autoTextDirection==="vertical"||ee.autoTextDirection==="horizontal"?ee.autoTextDirection:"vertical"}))}:{imageIndex:he.imageIndex,bubbles:he.originalTexts.map((ee,b)=>({bubbleIndex:b,original:ee,translated:"",textDirection:he.autoDirections[b]||"vertical"}))}),w=l.map(he=>{const ee=P&&he.image.translatedDataURL||he.image.originalDataURL;return q(ee)}),N=P?f.proofreading.rounds[0]:f.hqTranslation,G=P?N?.prompt:f.hqTranslation.prompt,Y=P?"ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ¼«ç”»ç¿»è¯‘æ ¡å¯¹åŠ©æ‰‹ï¼Œèƒ½å¤Ÿæ ¹æ®æ¼«ç”»å›¾åƒå†…å®¹æ£€æŸ¥å’Œä¿®æ­£ç¿»è¯‘ã€‚":"ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ¼«ç”»ç¿»è¯‘åŠ©æ‰‹ï¼Œèƒ½å¤Ÿæ ¹æ®æ¼«ç”»å›¾åƒå†…å®¹å’Œä¸Šä¸‹æ–‡æä¾›é«˜è´¨é‡çš„ç¿»è¯‘ã€‚",u=JSON.stringify(S,null,2),h=[{type:"text",text:(G||"")+`

ä»¥ä¸‹æ˜¯JSONæ•°æ®:
\`\`\`json
`+u+"\n```"}];for(const he of w)h.push({type:"image_url",image_url:{url:`data:image/png;base64,${he}`}});const le=[{role:"system",content:Y},{role:"user",content:h}],I=f.hqTranslation,j=P?N:null,ce=await At({provider:(P?j?.provider:I.provider)||"openai",api_key:(P?j?.apiKey:I.apiKey)||"",model_name:(P?j?.modelName:I.modelName)||"",custom_base_url:P?j?.customBaseUrl:I.customBaseUrl,messages:le,low_reasoning:P?j?.lowReasoning:I.lowReasoning,force_json_output:P?j?.forceJsonOutput:I.forceJsonOutput,no_thinking_method:P?j?.noThinkingMethod:I.noThinkingMethod,use_stream:P?!1:I.useStream,max_retries:P?f.proofreading.maxRetries||2:I.maxRetries||2}),ye=P?j?.forceJsonOutput||!1:I.forceJsonOutput;let $e=X(ce,ye)||S;if(P&&f.proofreading.rounds.length>1)for(let he=1;he<f.proofreading.rounds.length;he++){const ee=f.proofreading.rounds[he],b=JSON.stringify($e,null,2),J=[{type:"text",text:ee.prompt+`

ä»¥ä¸‹æ˜¯JSONæ•°æ®:
\`\`\`json
`+b+"\n```"}];for(const ne of w)J.push({type:"image_url",image_url:{url:`data:image/png;base64,${ne}`}});const ve=[{role:"system",content:Y},{role:"user",content:J}],fe=await At({provider:ee.provider,api_key:ee.apiKey,model_name:ee.modelName,custom_base_url:ee.customBaseUrl,messages:ve,low_reasoning:ee.lowReasoning,force_json_output:ee.forceJsonOutput,no_thinking_method:ee.noThinkingMethod,use_stream:!1,max_retries:ee.maxRetries||f.proofreading.maxRetries||2}),F=X(fe,ee.forceJsonOutput);F&&($e=F)}for(const he of l){const ee=$e?.find(b=>b.imageIndex===he.imageIndex);ee?he.translatedTexts=ee.bubbles.map(b=>b.translated):he.translatedTexts=[],he.textboxTexts=[]}}async function K(l){if(l.bubbleCoords.length===0){l.cleanImage=q(l.image.originalDataURL);return}const f=s.settings,{textStyle:P,preciseMask:S}=f,w=q(l.image.originalDataURL),N=await To({image:w,bubble_coords:l.bubbleCoords,bubble_polygons:l.bubblePolygons,raw_mask:l.rawMask,method:P.inpaintMethod==="solid"?"solid":"lama",lama_model:P.inpaintMethod==="litelama"?"litelama":"lama_mpe",fill_color:P.fillColor,mask_dilate_size:S.dilateSize,mask_box_expand_ratio:S.boxExpandRatio});if(!N.success)throw new Error(N.error||"èƒŒæ™¯ä¿®å¤å¤±è´¥");l.cleanImage=N.clean_image}async function z(l){if(!l.cleanImage)throw y==="proofread"?new Error("æ­¤å›¾ç‰‡å°šæœªç¿»è¯‘ï¼Œè¯·å…ˆç¿»è¯‘åå†è¿›è¡Œæ ¡å¯¹"):new Error("ç¼ºå°‘å¹²å‡€èƒŒæ™¯å›¾ç‰‡");const{textStyle:f}=s.settings,P=k?.autoTextDirection?"auto":k?.textDirection||f.layoutDirection,S=l.bubbleCoords.map((N,G)=>{const Y=l.autoDirections[G]||"vertical",u=Y==="v"?"vertical":Y==="h"?"horizontal":Y==="vertical"||Y==="horizontal"?Y:"vertical",h=P==="vertical"||P==="horizontal"?P:u,le=k?.useAutoTextColor??f.useAutoTextColor;let I=k?.textColor||f.textColor,j=k?.fillColor||f.fillColor;const ce=l.colors[G];return le&&ce&&(ce.textColor&&(I=ce.textColor),ce.bgColor&&(j=ce.bgColor)),{coords:N,polygon:[],position:{x:0,y:0},rotationAngle:l.bubbleAngles[G]||0,originalText:l.originalTexts[G]||"",translatedText:l.translatedTexts[G]||"",textboxText:l.textboxTexts[G]||"",textDirection:h,autoTextDirection:u,fontSize:k?.fontSize||f.fontSize,fontFamily:k?.fontFamily||f.fontFamily,autoFontSize:k?.autoFontSize??f.autoFontSize,textColor:I,fillColor:j,strokeEnabled:k?.strokeEnabled??f.strokeEnabled,strokeColor:k?.strokeColor||f.strokeColor,strokeWidth:k?.strokeWidth||f.strokeWidth,inpaintMethod:f.inpaintMethod,autoFgColor:l.colors[G]?.autoFgColor||null,autoBgColor:l.colors[G]?.autoBgColor||null}}),w=await Io({clean_image:l.cleanImage,bubble_states:S,fontSize:k?.fontSize||f.fontSize,fontFamily:k?.fontFamily||f.fontFamily,textDirection:k?.textDirection||f.layoutDirection,textColor:k?.textColor||f.textColor,strokeEnabled:k?.strokeEnabled??f.strokeEnabled,strokeColor:k?.strokeColor||f.strokeColor,strokeWidth:k?.strokeWidth||f.strokeWidth,autoFontSize:k?.autoFontSize??f.autoFontSize,use_individual_styles:!0});if(!w.success)throw new Error(w.error||"æ¸²æŸ“å¤±è´¥");l.finalImage=w.final_image,l.bubbleStates=w.bubble_states||S}async function se(l,f){switch(l){case"detection":await L(f);break;case"ocr":await v(f);break;case"color":await g(f);break;case"translate":await x(f);break;case"inpaint":await K(f);break;case"render":await z(f);break;case"save":await Ln(f.imageIndex);break;case"aiTranslate":throw new Error("aiTranslate åº”é€šè¿‡æ‰¹é‡å¤„ç†é€»è¾‘è°ƒç”¨")}}function X(l,f){if(!l.success)return console.error("APIè°ƒç”¨å¤±è´¥:",l.error),null;if(l.results&&l.results.length>0){const S=l.results[0];if(S&&"imageIndex"in S&&"bubbles"in S)return l.results}const P=l.content;if(P)if(f)try{return JSON.parse(P)}catch{return null}else{const S=P.match(/```json\s*([\s\S]*?)\s*```/);if(S?.[1])try{return JSON.parse(S[1])}catch{return null}}return null}function ie(l){const f=l.finalImage?`data:image/png;base64,${l.finalImage}`:l.cleanImage?`data:image/png;base64,${l.cleanImage}`:null;n.updateImageByIndex(l.imageIndex,{translatedDataURL:f,cleanImageData:l.cleanImage||null,bubbleStates:l.bubbleStates,bubbleCoords:l.bubbleCoords,bubbleAngles:l.bubbleAngles,originalTexts:l.originalTexts,textboxTexts:l.textboxTexts,bubbleTexts:l.translatedTexts,translationStatus:"completed",translationFailed:!1,showOriginal:!1,hasUnsavedChanges:!0,layoutDirection:k?.layoutDirection,autoFontSize:k?.autoFontSize??!1,useAutoTextColor:k?.useAutoTextColor??!1}),l.imageIndex===n.currentImageIndex&&l.bubbleStates&&t.setBubbles(l.bubbleStates)}function U(l){return l==="standard"||l==="removeText"}function W(l){const f=s.settings;return l==="hq"?f.hqTranslation.batchSize||5:l==="proofread"?f.proofreading.rounds[0]?.batchSize||5:1}async function te(l,f,P,S){let w=0,N=0;for(let G=0;G<l.length;G++){const Y=l[G];if(P.scope==="all"&&!n.isBatchTranslationInProgress){console.log("â¹ï¸ æ‰¹é‡ç¿»è¯‘å·²å–æ¶ˆï¼Œåœæ­¢å¤„ç†");break}const u=Math.floor(G/l.length*90);a.setPercentage(u,`å¤„ç†å›¾ç‰‡ ${G+1}/${l.length}`),i.info(`å¤„ç†å›¾ç‰‡ ${G+1}/${l.length}...`),n.setTranslationStatus(Y.imageIndex,"processing");let h=!1;for(let le=0;le<f.length;le++){const I=f[le];if(h)break;p.value&&await p.value.acquire();try{const j=u+Math.floor(le/f.length*(90/l.length));a.setPercentage(j,`å›¾ç‰‡ ${G+1}: ${Wt[I]}`),await se(I,Y)}catch(j){const ce=j instanceof Error?j.message:"æœªçŸ¥é”™è¯¯";S.push(`å›¾ç‰‡ ${Y.imageIndex+1}: ${I} - ${ce}`),n.setTranslationStatus(Y.imageIndex,"failed",ce),h=!0,N++}}h||(ie(Y),w++,console.log(`âœ… å›¾ç‰‡ ${G+1}/${l.length} å¤„ç†å®Œæˆ`))}return{completed:w,failed:N}}async function B(l,f,P,S){let w=0,N=0;const G=W(P.mode),Y=Math.ceil(l.length/G),u=f.indexOf("aiTranslate"),h=u>=0?f.slice(0,u):f,le=u>=0?f.slice(u+1):[];console.log(`ğŸ“¦ æ‰¹æ¬¡å¤„ç†æ¨¡å¼ï¼šå…± ${l.length} å¼ å›¾ç‰‡ï¼Œæ¯æ‰¹ ${G} å¼ ï¼Œå…± ${Y} æ‰¹`),console.log(`   AIç¿»è¯‘å‰æ­¥éª¤: [${h.join(" â†’ ")}]`),console.log(`   AIç¿»è¯‘åæ­¥éª¤: [${le.join(" â†’ ")}]`);for(let I=0;I<Y;I++){if(P.scope==="all"&&!n.isBatchTranslationInProgress){console.log("â¹ï¸ æ‰¹é‡ç¿»è¯‘å·²å–æ¶ˆï¼Œåœæ­¢å¤„ç†");break}const j=I*G,ce=Math.min(j+G,l.length),ye=l.slice(j,ce),De=Math.floor(I/Y*90);a.setPercentage(De,`å¤„ç†æ‰¹æ¬¡ ${I+1}/${Y}`),i.info(`å¤„ç†æ‰¹æ¬¡ ${I+1}/${Y}ï¼ˆå›¾ç‰‡ ${j+1}-${ce}ï¼‰...`);for(const he of ye)n.setTranslationStatus(he.imageIndex,"processing");const $e=new Set;for(let he=0;he<ye.length;he++){const ee=ye[he];for(const b of h){if($e.has(ee.imageIndex))break;p.value&&await p.value.acquire();try{const J=De+Math.floor(he/ye.length*30);a.setPercentage(J,`å›¾ç‰‡ ${j+he+1}: ${Wt[b]}`),await se(b,ee)}catch(J){const ve=J instanceof Error?J.message:"æœªçŸ¥é”™è¯¯";S.push(`å›¾ç‰‡ ${ee.imageIndex+1}: ${b} - ${ve}`),n.setTranslationStatus(ee.imageIndex,"failed",ve),$e.add(ee.imageIndex)}}}if(u>=0){const he=De+40;a.setPercentage(he,`æ‰¹æ¬¡ ${I+1}: ${Wt.aiTranslate}`);try{const ee=ye.filter(b=>!$e.has(b.imageIndex));ee.length>0&&await _(ee)}catch(ee){const b=ee instanceof Error?ee.message:"æœªçŸ¥é”™è¯¯";S.push(`æ‰¹æ¬¡ ${I+1} AIç¿»è¯‘å¤±è´¥: ${b}`);for(const J of ye)$e.has(J.imageIndex)||(n.setTranslationStatus(J.imageIndex,"failed",b),$e.add(J.imageIndex))}}for(let he=0;he<ye.length;he++){const ee=ye[he];if(!$e.has(ee.imageIndex)){for(const b of le){if($e.has(ee.imageIndex))break;p.value&&await p.value.acquire();try{const J=De+50+Math.floor(he/ye.length*40);a.setPercentage(J,`å›¾ç‰‡ ${j+he+1}: ${Wt[b]}`),await se(b,ee)}catch(J){const ve=J instanceof Error?J.message:"æœªçŸ¥é”™è¯¯";S.push(`å›¾ç‰‡ ${ee.imageIndex+1}: ${b} - ${ve}`),n.setTranslationStatus(ee.imageIndex,"failed",ve),$e.add(ee.imageIndex)}}$e.has(ee.imageIndex)||(ie(ee),w++,console.log(`âœ… å›¾ç‰‡ ${j+he+1} å¤„ç†å®Œæˆ`))}}N+=$e.size,console.log(`âœ… æ‰¹æ¬¡ ${I+1}/${Y} å¤„ç†å®Œæˆ`)}return{completed:w,failed:N}}async function d(l){if(!D(l))return{success:!1,completed:0,failed:0,errors:["é…ç½®éªŒè¯å¤±è´¥"]};if(n.images.length===0)return i.error("è¯·å…ˆä¸Šä¼ å›¾ç‰‡"),{success:!1,completed:0,failed:0,errors:["æ²¡æœ‰å›¾ç‰‡"]};y=l.mode;const P=U(l.mode);c.value=!0,(l.scope==="all"||l.scope==="failed")&&n.setBatchTranslationInProgress(!0),R(),T();const S=V(l),w=[],N=Pt(),G=[...vn[l.mode]];N&&G.push("save"),console.log("ğŸš€ é¡ºåºç®¡çº¿å¯åŠ¨"),console.log(`   æ¨¡å¼: ${l.mode}`),console.log(`   å¤„ç†æ–¹å¼: ${P?"é€å¼ å¤„ç†":"æ‰¹æ¬¡å¤„ç†"}`),console.log(`   æ­¥éª¤é“¾: [${G.join(" â†’ ")}]`),console.log(`   è‡ªåŠ¨ä¿å­˜: ${N?"å¯ç”¨":"ç¦ç”¨"}`);const Y=S.map(({image:u,index:h})=>{const le={imageIndex:h,image:u,bubbleCoords:[],bubbleAngles:[],bubblePolygons:[],autoDirections:[],textlinesPerBubble:[],originalTexts:[],colors:[],translatedTexts:[],textboxTexts:[]};return l.mode==="proofread"&&u.bubbleStates&&u.bubbleStates.length>0&&(le.bubbleCoords=u.bubbleStates.map(I=>I.coords),le.bubbleAngles=u.bubbleStates.map(I=>I.rotationAngle||0),le.autoDirections=u.bubbleStates.map(I=>I.autoTextDirection||I.textDirection||"vertical"),le.originalTexts=u.bubbleStates.map(I=>I.originalText||""),le.translatedTexts=u.bubbleStates.map(I=>I.translatedText||""),le.textboxTexts=u.bubbleStates.map(I=>I.textboxText||""),le.colors=u.bubbleStates.map(I=>({textColor:I.textColor||"",bgColor:I.fillColor||"",autoFgColor:I.autoFgColor||null,autoBgColor:I.autoBgColor||null})),u.cleanImageData&&(le.cleanImage=u.cleanImageData)),le});try{a.init(S.length,`${l.mode} æ¨¡å¼å¯åŠ¨...`),N&&(a.setPercentage(0,"é¢„ä¿å­˜åŸå§‹å›¾ç‰‡..."),await An({onStart:I=>{a.setPercentage(0,`é¢„ä¿å­˜åŸå§‹å›¾ç‰‡ 0/${I}...`)},onProgress:(I,j)=>{const ce=Math.round(I/j*10);a.setPercentage(ce,`é¢„ä¿å­˜åŸå§‹å›¾ç‰‡ ${I}/${j}...`)},onComplete:()=>{a.setPercentage(10,"é¢„ä¿å­˜å®Œæˆï¼Œå¼€å§‹ç¿»è¯‘...")},onError:I=>{a.setPercentage(0,`é¢„ä¿å­˜å¤±è´¥: ${I}`)}})||i.warning("é¢„ä¿å­˜å¤±è´¥ï¼Œç¿»è¯‘å®Œæˆåè¯·æ‰‹åŠ¨ä¿å­˜"));let u;P?u=await te(Y,G,l,w):u=await B(Y,G,l,w),a.setPercentage(100,"å®Œæˆï¼");const h={standard:"ç¿»è¯‘",hq:"é«˜è´¨é‡ç¿»è¯‘",proofread:"AIæ ¡å¯¹",removeText:"æ¶ˆé™¤æ–‡å­—"};return i.success(`${h[l.mode]}å®Œæˆï¼`),{success:u.failed===0,completed:u.completed,failed:u.failed,errors:w.length>0?w:void 0}}catch(u){const h=u instanceof Error?u.message:"æ‰§è¡Œå¤±è´¥";return i.error(h),w.push(h),{success:!1,completed:0,failed:S.length,errors:w}}finally{c.value=!1,n.setBatchTranslationInProgress(!1),N&&await Fn();const u=n.currentImageIndex,h=n.images[u];h?.bubbleStates&&h.bubbleStates.length>0&&t.setBubbles(h.bubbleStates),setTimeout(()=>a.finish(),1e3)}}function m(){n.isBatchTranslationInProgress&&(n.setBatchTranslationInProgress(!1),Un(),i.info("æ“ä½œå·²å–æ¶ˆ"))}return{progress:r,isExecuting:c,isTranslating:$,progressPercent:E,execute:d,cancel:m,STEP_CHAIN_CONFIGS:vn}}class pi{currentCount=0;maxCount;waitQueue=[];holders=[];constructor(t=1){this.maxCount=Math.max(1,t)}setSize(t){this.maxCount=Math.max(1,t),this.tryWakeUp()}getSize(){return this.maxCount}async acquire(t){if(this.currentCount<this.maxCount){this.currentCount++,this.holders.push(t);return}return new Promise(s=>{this.waitQueue.push({resolve:s,poolName:t})})}release(t){const s=this.holders.indexOf(t);s>=0&&(this.holders.splice(s,1),this.currentCount--),this.tryWakeUp()}tryWakeUp(){for(;this.currentCount<this.maxCount&&this.waitQueue.length>0;){const t=this.waitQueue.shift();this.currentCount++,this.holders.push(t.poolName),t.resolve()}}async withLock(t,s){await this.acquire(t);try{return await s()}finally{this.release(t)}}getStatus(){return{isLocked:this.currentCount>=this.maxCount,currentCount:this.currentCount,maxCount:this.maxCount,holders:[...this.holders],waitingCount:this.waitQueue.length,waitingPools:this.waitQueue.map(t=>t.poolName)}}isWaiting(t){return this.waitQueue.some(s=>s.poolName===t)}isHolding(t){return this.holders.includes(t)}reset(){this.currentCount=0,this.holders=[];for(const t of this.waitQueue)t.resolve();this.waitQueue=[]}}class Rt{queue=[];currentTask=null;isRunning=!1;isCancelled=!1;completedCount=0;nextPool;name;icon;lock;progressTracker;onTaskComplete;constructor(t,s,o,i,r,a){this.name=t,this.icon=s,this.nextPool=o,this.lock=i,this.progressTracker=r,this.onTaskComplete=a}getName(){return this.name}getIcon(){return this.icon}setNextPool(t){this.nextPool=t}enqueue(t){this.isCancelled||(this.queue.push(t),this.progressTracker.updatePool(this.name,{waiting:this.queue.length}),this.tryProcessNext())}enqueueBatch(t){if(!this.isCancelled){for(const s of t)this.queue.push(s);this.progressTracker.updatePool(this.name,{waiting:this.queue.length}),this.tryProcessNext()}}async tryProcessNext(){if(!(this.isRunning||this.isCancelled||this.queue.length===0)){this.isRunning=!0,this.currentTask=this.queue.shift(),this.progressTracker.updatePool(this.name,{waiting:this.queue.length,isProcessing:!0,currentPage:this.currentTask.imageIndex+1,isWaitingLock:!1});try{let t;this.lock?(this.progressTracker.updatePool(this.name,{isWaitingLock:!0}),t=await this.lock.withLock(this.name,async()=>(this.progressTracker.updatePool(this.name,{isWaitingLock:!1}),await this.process(this.currentTask)))):t=await this.process(this.currentTask),this.completedCount++,this.progressTracker.updatePool(this.name,{completed:this.completedCount}),this.nextPool&&t.status!=="failed"&&t.status!=="buffered"&&this.nextPool.enqueue(t),this.onTaskComplete?.(t)}catch(t){this.currentTask.status="failed",this.currentTask.error=t.message,console.error(`[${this.name}] å¤„ç†ä»»åŠ¡å¤±è´¥:`,t),this.onTaskComplete?.(this.currentTask)}finally{this.currentTask=null,this.isRunning=!1,this.progressTracker.updatePool(this.name,{isProcessing:!1,currentPage:void 0}),this.tryProcessNext()}}}getStatus(){return{name:this.name,icon:this.icon,waiting:this.queue.length,processing:this.isRunning,currentPage:this.currentTask?.imageIndex,completed:this.completedCount,isWaitingLock:this.lock?.isWaiting(this.name)??!1}}cancel(){this.isCancelled=!0,this.queue=[]}reset(){this.isCancelled=!1,this.queue=[],this.currentTask=null,this.isRunning=!1,this.completedCount=0}getCompletedCount(){return this.completedCount}getWaitingCount(){return this.queue.length}isProcessing(){return this.isRunning}}const mi=[{name:"æ£€æµ‹",icon:"ğŸ“"},{name:"OCR",icon:"ğŸ“–"},{name:"é¢œè‰²",icon:"ğŸ¨"},{name:"ç¿»è¯‘",icon:"ğŸŒ"},{name:"ä¿®å¤",icon:"ğŸ–Œï¸"},{name:"æ¸²æŸ“",icon:"âœ¨"}];class vi{poolStatuses=new Map;totalPages=0;startTime=0;progress=bo({pools:[],totalCompleted:0,totalFailed:0,totalPages:0,estimatedTimeRemaining:0});constructor(){this.initPools()}initPools(){for(const t of mi){const s={name:t.name,icon:t.icon,waiting:0,processing:!1,completed:0,isWaitingLock:!1};this.poolStatuses.set(t.name,s)}this.syncToReactive()}init(t){this.totalPages=t,this.startTime=Date.now();for(const s of this.poolStatuses.values())s.waiting=0,s.processing=!1,s.currentPage=void 0,s.completed=0,s.isWaitingLock=!1;this.progress.totalCompleted=0,this.progress.totalFailed=0,this.progress.totalPages=t,this.progress.estimatedTimeRemaining=0,this.syncToReactive()}updatePool(t,s){const o=this.poolStatuses.get(t);o&&(s.waiting!==void 0&&(o.waiting=s.waiting),s.isProcessing!==void 0&&(o.processing=s.isProcessing),s.currentPage!==void 0&&(o.currentPage=s.currentPage),s.completed!==void 0&&(o.completed=s.completed),s.isWaitingLock!==void 0&&(o.isWaitingLock=s.isWaitingLock),this.syncToReactive(),this.updateEstimatedTime())}incrementCompleted(){this.progress.totalCompleted++,this.updateEstimatedTime()}incrementFailed(){this.progress.totalFailed++}updateEstimatedTime(){if(this.progress.totalCompleted===0){this.progress.estimatedTimeRemaining=0;return}const s=(Date.now()-this.startTime)/1e3/this.progress.totalCompleted,o=this.totalPages-this.progress.totalCompleted-this.progress.totalFailed;this.progress.estimatedTimeRemaining=Math.ceil(s*o)}syncToReactive(){this.progress.pools=Array.from(this.poolStatuses.values()).map(t=>({...t}))}getPoolStatus(t){return this.poolStatuses.get(t)}getAllPoolStatuses(){return Array.from(this.poolStatuses.values())}getProgress(){return{...this.progress}}reset(){this.totalPages=0,this.startTime=0,this.initPools()}formatRemainingTime(){const t=this.progress.estimatedTimeRemaining;if(t<=0)return"--";const s=Math.floor(t/60),o=t%60;return s>0?`${s}åˆ†${o}ç§’`:`${o}ç§’`}}class fi{results=new Map;totalExpected=0;completedCount=0;failedCount=0;resolveWaitAll=null;init(t){this.results.clear(),this.totalExpected=t,this.completedCount=0,this.failedCount=0,this.resolveWaitAll=null}add(t){this.results.set(t.imageIndex,t),t.status==="completed"?this.completedCount++:t.status==="failed"&&this.failedCount++,this.completedCount+this.failedCount>=this.totalExpected&&this.resolveWaitAll&&(this.resolveWaitAll({success:this.completedCount,failed:this.failedCount}),this.resolveWaitAll=null)}waitForAll(t){return this.totalExpected=t,this.completedCount+this.failedCount>=t?Promise.resolve({success:this.completedCount,failed:this.failedCount}):new Promise(s=>{this.resolveWaitAll=s})}get(t){return this.results.get(t)}getAll(){return Array.from(this.results.values()).sort((t,s)=>t.imageIndex-s.imageIndex)}getSuccessful(){return this.getAll().filter(t=>t.status==="completed")}getFailed(){return this.getAll().filter(t=>t.status==="failed")}getStats(){return{total:this.totalExpected,completed:this.completedCount,failed:this.failedCount,pending:this.totalExpected-this.completedCount-this.failedCount}}reset(){this.results.clear(),this.totalExpected=0,this.completedCount=0,this.failedCount=0,this.resolveWaitAll=null}}class bi extends Rt{constructor(t,s,o,i){super("æ£€æµ‹","ğŸ“",t,s,o,i)}async process(t){const{imageData:s}=t,i=ze().settings,r=this.extractBase64(s.originalDataURL),a=await So({image:r,detector_type:i.textDetector,box_expand_ratio:i.boxExpand.ratio,box_expand_top:i.boxExpand.top,box_expand_bottom:i.boxExpand.bottom,box_expand_left:i.boxExpand.left,box_expand_right:i.boxExpand.right});if(!a.success)throw new Error(a.error||"æ£€æµ‹å¤±è´¥");return t.detectionResult={bubbleCoords:a.bubble_coords||[],bubbleAngles:a.bubble_angles||[],bubblePolygons:a.bubble_polygons||[],autoDirections:a.auto_directions||[],rawMask:a.raw_mask,textlinesPerBubble:a.textlines_per_bubble||[]},t.status="processing",t}extractBase64(t){return t.includes("base64,")?t.split("base64,")[1]||"":t}}class hi extends Rt{constructor(t,s,o,i){super("OCR","ğŸ“–",t,s,o,i)}async process(t){const{imageData:s,detectionResult:o}=t,r=ze().settings;if(!o||o.bubbleCoords.length===0)return t.ocrResult={originalTexts:[],textlinesPerBubble:[]},t.status="processing",t;const a=this.extractBase64(s.originalDataURL),c=r.ocrEngine==="paddleocr_vl"?r.paddleOcrVl?.sourceLanguage||"japanese":r.sourceLanguage,p=await ko({image:a,bubble_coords:o.bubbleCoords,source_language:c,ocr_engine:r.ocrEngine,baidu_api_key:r.baiduOcr?.apiKey,baidu_secret_key:r.baiduOcr?.secretKey,baidu_version:r.baiduOcr?.version,baidu_ocr_language:r.baiduOcr?.sourceLanguage,ai_vision_provider:r.aiVisionOcr?.provider,ai_vision_api_key:r.aiVisionOcr?.apiKey,ai_vision_model_name:r.aiVisionOcr?.modelName,ai_vision_ocr_prompt:r.aiVisionOcr?.prompt,custom_ai_vision_base_url:r.aiVisionOcr?.customBaseUrl,ai_vision_min_image_size:r.aiVisionOcr?.minImageSize??ds,textlines_per_bubble:o.textlinesPerBubble});if(!p.success)throw new Error(p.error||"OCRå¤±è´¥");return t.ocrResult={originalTexts:p.original_texts||[],textlinesPerBubble:p.textlines_per_bubble||[]},t.status="processing",t}extractBase64(t){return t.includes("base64,")?t.split("base64,")[1]||"":t}}class yi extends Rt{constructor(t,s,o,i){super("é¢œè‰²","ğŸ¨",t,s,o,i)}async process(t){const{imageData:s,detectionResult:o,ocrResult:i}=t;if(!o||o.bubbleCoords.length===0)return t.colorResult={colors:[]},t.status="processing",t;const r=this.extractBase64(s.originalDataURL),a=await wo({image:r,bubble_coords:o.bubbleCoords,textlines_per_bubble:i?.textlinesPerBubble||o.textlinesPerBubble});if(!a.success)throw new Error(a.error||"é¢œè‰²æå–å¤±è´¥");return t.colorResult={colors:a.colors||[]},t.status="processing",t}extractBase64(t){return t.includes("base64,")?t.split("base64,")[1]||"":t}}class xi extends Rt{mode="standard";batchBuffer=[];totalTasks=0;processedCount=0;constructor(t,s,o){super("ç¿»è¯‘","ğŸŒ",t,null,s,o)}setMode(t,s,o){this.mode=t,this.totalTasks=s,this.batchBuffer=[],this.processedCount=0,this.nextPool=o}async process(t){switch(this.mode){case"standard":return this.handleStandardTranslate(t);case"hq":return this.handleHqTranslate(t);case"proofread":return this.handleProofread(t);case"removeText":return this.handleRemoveTextOnly(t);default:return t}}async handleStandardTranslate(t){const o=ze().settings;if(!t.ocrResult||t.ocrResult.originalTexts.length===0)return t.translateResult={translatedTexts:[],textboxTexts:[]},t.status="processing",t;const i=await $o({original_texts:t.ocrResult.originalTexts,target_language:o.targetLanguage,source_language:o.sourceLanguage,model_provider:o.translation.provider,model_name:o.translation.modelName,api_key:o.translation.apiKey,custom_base_url:o.translation.customBaseUrl,prompt_content:o.translatePrompt,textbox_prompt_content:o.textboxPrompt,use_textbox_prompt:o.useTextboxPrompt,rpm_limit:o.translation.rpmLimit,max_retries:o.translation.maxRetries,use_json_format:o.translation.isJsonMode});if(!i.success)throw new Error(i.error||"ç¿»è¯‘å¤±è´¥");return t.translateResult={translatedTexts:i.translated_texts||[],textboxTexts:i.textbox_texts||[]},t.status="processing",t}async handleHqTranslate(t){this.batchBuffer.push(t),this.processedCount++;const s=ze(),{hqTranslation:o}=s.settings,i=o.batchSize||3,r=this.processedCount>=this.totalTasks;if(!(this.batchBuffer.length>=i||r))return t.status="buffered",t;const c=[...this.batchBuffer];this.batchBuffer=[];const p=c.map(T=>({imageIndex:T.imageIndex,bubbles:(T.ocrResult?.originalTexts||[]).map((q,V)=>({bubbleIndex:V,original:q,translated:"",textDirection:T.detectionResult?.autoDirections[V]||"vertical"}))})),k=c.map(T=>this.extractBase64(T.imageData.originalDataURL)),y=JSON.stringify(p,null,2),$=[{type:"text",text:o.prompt+`

ä»¥ä¸‹æ˜¯JSONæ•°æ®:
\`\`\`json
`+y+"\n```"}];for(const T of k)$.push({type:"image_url",image_url:{url:`data:image/png;base64,${T}`}});const E=[{role:"system",content:"ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ¼«ç”»ç¿»è¯‘åŠ©æ‰‹ï¼Œèƒ½å¤Ÿæ ¹æ®æ¼«ç”»å›¾åƒå†…å®¹å’Œä¸Šä¸‹æ–‡æä¾›é«˜è´¨é‡çš„ç¿»è¯‘ã€‚"},{role:"user",content:$}],R=await At({provider:o.provider,api_key:o.apiKey,model_name:o.modelName,custom_base_url:o.customBaseUrl,messages:E,low_reasoning:o.lowReasoning,force_json_output:o.forceJsonOutput,no_thinking_method:o.noThinkingMethod,use_stream:o.useStream,max_retries:o.maxRetries||2}),D=this.parseHqResponse(R,o.forceJsonOutput);for(const T of c){const q=D?.find(V=>V.imageIndex===T.imageIndex);q?T.translateResult={translatedTexts:q.bubbles.map(V=>V.translated),textboxTexts:[]}:T.translateResult={translatedTexts:[],textboxTexts:[]},T.status="processing",this.nextPool&&this.nextPool.enqueue(T)}return t}async handleProofread(t){this.batchBuffer.push(t),this.processedCount++;const s=ze(),{proofreading:o,useTextboxPrompt:i}=s.settings,r=o.rounds[0]?.batchSize||3,a=this.processedCount>=this.totalTasks;if(!(this.batchBuffer.length>=r||a))return t.status="buffered",t;const p=[...this.batchBuffer];this.batchBuffer=[];const k=p.map(E=>({imageIndex:E.imageIndex,bubbles:(E.imageData.bubbleStates||[]).map((R,D)=>({bubbleIndex:D,original:R.originalText||"",translated:i?R.textboxText||R.translatedText||"":R.translatedText||"",textDirection:R.textDirection==="vertical"||R.textDirection==="horizontal"?R.textDirection:R.autoTextDirection==="vertical"||R.autoTextDirection==="horizontal"?R.autoTextDirection:"vertical"}))})),y=p.map(E=>{const R=E.imageData.translatedDataURL||E.imageData.originalDataURL;return this.extractBase64(R)});let $=k;for(const E of o.rounds){const R=JSON.stringify($,null,2),D=[{type:"text",text:E.prompt+`

ä»¥ä¸‹æ˜¯JSONæ•°æ®:
\`\`\`json
`+R+"\n```"}];for(const L of y)D.push({type:"image_url",image_url:{url:`data:image/png;base64,${L}`}});const T=[{role:"system",content:"ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ¼«ç”»ç¿»è¯‘æ ¡å¯¹åŠ©æ‰‹ï¼Œèƒ½å¤Ÿæ ¹æ®æ¼«ç”»å›¾åƒå†…å®¹æ£€æŸ¥å’Œä¿®æ­£ç¿»è¯‘ã€‚"},{role:"user",content:D}],q=await At({provider:E.provider,api_key:E.apiKey,model_name:E.modelName,custom_base_url:E.customBaseUrl,messages:T,low_reasoning:E.lowReasoning,force_json_output:E.forceJsonOutput,no_thinking_method:E.noThinkingMethod,use_stream:!1,max_retries:E.maxRetries||o.maxRetries||2}),V=this.parseHqResponse(q,E.forceJsonOutput);V&&($=V)}for(const E of p){const R=$.find(D=>D.imageIndex===E.imageIndex);R?E.translateResult={translatedTexts:R.bubbles.map(D=>D.translated),textboxTexts:[]}:E.translateResult={translatedTexts:[],textboxTexts:[]},E.status="processing",this.nextPool&&this.nextPool.enqueue(E)}return t}async handleRemoveTextOnly(t){return t.translateResult={translatedTexts:[],textboxTexts:[]},t.status="processing",t}extractBase64(t){return t.includes("base64,")?t.split("base64,")[1]||"":t}parseHqResponse(t,s){if(!t.success)return console.error("APIè°ƒç”¨å¤±è´¥:",t.error),null;if(t.results&&t.results.length>0){const i=t.results[0];if(i&&"imageIndex"in i&&"bubbles"in i)return t.results}const o=t.content;if(o)if(s)try{return JSON.parse(o)}catch(i){return console.error("è§£æAIå¼ºåˆ¶JSONè¿”å›çš„å†…å®¹å¤±è´¥:",i),null}else{const i=o.match(/```json\s*([\s\S]*?)\s*```/);if(i?.[1])try{return JSON.parse(i[1])}catch(r){return console.error("è§£æAIè¿”å›çš„JSONå¤±è´¥:",r),null}}return null}}class _i extends Rt{constructor(t,s,o,i){super("ä¿®å¤","ğŸ–Œï¸",t,s,o,i)}async process(t){const{imageData:s,detectionResult:o}=t,r=ze().settings;if(!o||o.bubbleCoords.length===0)return t.inpaintResult={cleanImage:this.extractBase64(s.originalDataURL)},t.status="processing",t;const a=this.extractBase64(s.originalDataURL),c=r.textStyle.inpaintMethod,p=c==="lama_mpe"||c==="litelama",k=await To({image:a,bubble_coords:o.bubbleCoords,bubble_polygons:o.bubblePolygons,raw_mask:o.rawMask,method:p?"lama":"solid",lama_model:p?c:void 0,fill_color:r.textStyle.fillColor,mask_dilate_size:r.preciseMask.dilateSize,mask_box_expand_ratio:r.preciseMask.boxExpandRatio});if(!k.success)throw new Error(k.error||"ä¿®å¤å¤±è´¥");return t.inpaintResult={cleanImage:k.clean_image||""},t.status="processing",t}extractBase64(t){return t.includes("base64,")?t.split("base64,")[1]||"":t}}const ft=bo({pools:[{name:"æ£€æµ‹",icon:"ğŸ“",waiting:0,processing:!1,completed:0,isWaitingLock:!1},{name:"OCR",icon:"ğŸ“–",waiting:0,processing:!1,completed:0,isWaitingLock:!1},{name:"é¢œè‰²",icon:"ğŸ¨",waiting:0,processing:!1,completed:0,isWaitingLock:!1},{name:"ç¿»è¯‘",icon:"ğŸŒ",waiting:0,processing:!1,completed:0,isWaitingLock:!1},{name:"ä¿®å¤",icon:"ğŸ–Œï¸",waiting:0,processing:!1,completed:0,isWaitingLock:!1},{name:"æ¸²æŸ“",icon:"âœ¨",waiting:0,processing:!1,completed:0,isWaitingLock:!1}],totalCompleted:0,totalFailed:0,totalPages:0,estimatedTimeRemaining:0,preSave:void 0,save:void 0}),Ci=C(!1);function Ro(){const n=et(),t=ze(),s=bs(null),o=Z(()=>t.settings.parallel),i=Z(()=>o.value?.enabled??!1),r=Ci,a=Z(()=>ft);function c(){const E=t.settings;return E.proofreading?.enabled&&E.proofreading.rounds.length>0?"proofread":["gemini","openai","claude","deepseek"].includes(E.hqTranslation?.provider||"")&&E.hqTranslation?.apiKey?"hq":"standard"}function p(){if(!s.value)return;const E=s.value.progress;E&&(ft.pools=E.pools.map(R=>({...R})),ft.totalCompleted=E.totalCompleted,ft.totalFailed=E.totalFailed,ft.totalPages=E.totalPages,ft.estimatedTimeRemaining=E.estimatedTimeRemaining)}async function k(E,R,D=0){if(r.value)return{success:0,failed:0,errors:["ç¿»è¯‘æ­£åœ¨è¿›è¡Œä¸­"]};const T=R??n.images;if(T.length===0)return{success:0,failed:0,errors:["æ²¡æœ‰å›¾ç‰‡"]};r.value=!0,ft.totalPages=T.length,ft.totalCompleted=0,ft.totalFailed=0;const q=setInterval(p,200);try{s.value=wi({enabled:!0,deepLearningLockSize:o.value?.deepLearningLockSize??1});const V=E??c();console.log(`ğŸš€ å¼€å§‹å¹¶è¡Œç¿»è¯‘ï¼Œæ¨¡å¼: ${V}ï¼Œå›¾ç‰‡æ•°: ${T.length}ï¼Œèµ·å§‹ç´¢å¼•: ${D}`);const L=await s.value.execute(T,V,D);return p(),console.log(`âœ… å¹¶è¡Œç¿»è¯‘å®Œæˆï¼ŒæˆåŠŸ: ${L.success}ï¼Œå¤±è´¥: ${L.failed}`),L}catch(V){return console.error("å¹¶è¡Œç¿»è¯‘å‡ºé”™:",V),{success:0,failed:T.length,errors:[V.message]}}finally{clearInterval(q),r.value=!1}}function y(){s.value&&s.value.cancel(),r.value=!1}function $(){s.value=null,r.value=!1}return{isEnabled:i,isRunning:r,progress:a,executeParallel:k,cancel:y,reset:$,determineMode:c}}class Si extends Rt{resultCollector;constructor(t,s,o){super("æ¸²æŸ“","âœ¨",null,null,t,o),this.resultCollector=s}async process(t){const s=et(),o=gt(),i=ze(),r=this.buildBubbleStates(t,i);if(r.length===0){const p=t.inpaintResult?.cleanImage||t.imageData.cleanImageData||this.extractBase64(t.imageData.originalDataURL);return t.renderResult={finalImage:p,bubbleStates:[]},t.status="completed",this.updateImageToUI(t,s,o,i),this.resultCollector.add(t),t}const a=t.inpaintResult?.cleanImage||t.imageData.cleanImageData||this.extractBase64(t.imageData.translatedDataURL||t.imageData.originalDataURL),c=await Io({clean_image:a,bubble_states:r,fontSize:i.settings.textStyle.fontSize,fontFamily:i.settings.textStyle.fontFamily,textDirection:i.settings.textStyle.layoutDirection,textColor:i.settings.textStyle.textColor,strokeEnabled:i.settings.textStyle.strokeEnabled,strokeColor:i.settings.textStyle.strokeColor,strokeWidth:i.settings.textStyle.strokeWidth,autoFontSize:i.settings.textStyle.autoFontSize,use_individual_styles:!0});if(!c.success)throw new Error(c.error||"æ¸²æŸ“å¤±è´¥");return t.renderResult={finalImage:c.final_image||"",bubbleStates:c.bubble_states||r},t.status="completed",this.updateImageToUI(t,s,o,i),this.resultCollector.add(t),t}updateImageToUI(t,s,o,i){const r=t.imageIndex,a=(t.detectionResult?.bubbleCoords||[]).map(c=>c.length>=4?[c[0],c[1],c[2],c[3]]:[0,0,0,0]);s.updateImageByIndex(r,{translatedDataURL:`data:image/png;base64,${t.renderResult.finalImage}`,cleanImageData:t.inpaintResult?.cleanImage||null,bubbleStates:t.renderResult.bubbleStates,bubbleCoords:a,bubbleAngles:t.detectionResult?.bubbleAngles||[],originalTexts:t.ocrResult?.originalTexts||[],bubbleTexts:t.translateResult?.translatedTexts||[],textboxTexts:t.translateResult?.textboxTexts||[],translationStatus:"completed",translationFailed:!1,showOriginal:!1,hasUnsavedChanges:!0,layoutDirection:i.settings.textStyle.layoutDirection,autoFontSize:i.settings.textStyle.autoFontSize,useAutoTextColor:i.settings.textStyle.useAutoTextColor}),r===s.currentImageIndex&&t.renderResult?.bubbleStates&&o.setBubbles(t.renderResult.bubbleStates),this.progressTracker.incrementCompleted(),Pt()&&Ln(r).catch(c=>{console.error(`[RenderPool] è‡ªåŠ¨ä¿å­˜å›¾ç‰‡ ${r+1} å¤±è´¥:`,c)}).finally(()=>{const{progress:c}=Ro(),p=c.value;p.save&&(p.save.completed=(p.save.completed||0)+1)}),console.log(`âœ… å›¾ç‰‡ ${r+1} æ¸²æŸ“å®Œæˆ`)}buildBubbleStates(t,s){if(!t.detectionResult&&t.imageData.bubbleStates&&t.imageData.bubbleStates.length>0){const $=t.translateResult?.translatedTexts||[];return t.imageData.bubbleStates.map((E,R)=>({...E,translatedText:$[R]||E.translatedText||""}))}if(t.detectionResult&&!t.translateResult)return console.log(`[æ¸²æŸ“æ± ] å›¾ç‰‡ ${t.imageIndex+1}: æ£€æµ‹åˆ°æ¶ˆé™¤æ–‡å­—æ¨¡å¼ï¼ˆæ— ç¿»è¯‘ç»“æœï¼‰ï¼Œè·³è¿‡æ¸²æŸ“`),[];const o=t.detectionResult?.bubbleCoords||[],i=t.translateResult?.translatedTexts||[],r=t.ocrResult?.originalTexts||[],a=t.colorResult?.colors||[],c=t.detectionResult?.bubbleAngles||[],p=t.detectionResult?.autoDirections||[],k=t.detectionResult?.bubblePolygons||[],y=s.settings;return o.map(($,E)=>{const R=p[E],D=R==="v"?"vertical":R==="h"?"horizontal":"vertical",T=y.textStyle.layoutDirection,q=T==="vertical"||T==="horizontal"?T:D;let V=y.textStyle.textColor,L=y.textStyle.fillColor;const v=a[E];return y.textStyle.useAutoTextColor&&v&&(v.textColor&&(V=v.textColor),v.bgColor&&(L=v.bgColor)),{originalText:r[E]||"",translatedText:i[E]||"",textboxText:"",coords:$.length>=4?[$[0],$[1],$[2],$[3]]:[0,0,0,0],polygon:k[E]||[],fontSize:y.textStyle.fontSize,fontFamily:y.textStyle.fontFamily,textDirection:q,autoTextDirection:D,textColor:V,fillColor:L,rotationAngle:c[E]||0,position:{x:0,y:0},strokeEnabled:y.textStyle.strokeEnabled,strokeColor:y.textStyle.strokeColor,strokeWidth:y.textStyle.strokeWidth,inpaintMethod:y.textStyle.inpaintMethod,autoFgColor:v?.autoFgColor||null,autoBgColor:v?.autoBgColor||null}})}extractBase64(t){return t.includes("base64,")?t.split("base64,")[1]||"":t}}const fn={standard:["detection","ocr","color","translate","inpaint","render"],hq:["detection","ocr","color","translate","inpaint","render"],proofread:["translate","render"],removeText:["detection","inpaint","render"]};class ki{lock;progressTracker;resultCollector;detectionPool;ocrPool;colorPool;translatePool;inpaintPool;renderPool;isCancelled=!1;config;constructor(t){this.config=t,this.lock=new pi(t.deepLearningLockSize),this.progressTracker=new vi,this.resultCollector=new fi,this.renderPool=new Si(this.progressTracker,this.resultCollector),this.inpaintPool=new _i(this.renderPool,this.lock,this.progressTracker),this.translatePool=new xi(this.inpaintPool,this.progressTracker),this.colorPool=new yi(this.translatePool,this.lock,this.progressTracker),this.ocrPool=new hi(this.colorPool,this.lock,this.progressTracker),this.detectionPool=new bi(this.ocrPool,this.lock,this.progressTracker)}updateConfig(t){t.deepLearningLockSize!==void 0&&(this.lock.setSize(t.deepLearningLockSize),this.config.deepLearningLockSize=t.deepLearningLockSize),t.enabled!==void 0&&(this.config.enabled=t.enabled)}async execute(t,s,o=0){this.reset(),this.progressTracker.init(t.length),this.resultCollector.init(t.length),this.setupPoolChain(s,t.length);const i=t.map((c,p)=>({id:`task-${o+p}`,imageIndex:o+p,imageData:c,status:"pending"})),r=this.getEntryPool(s);for(const c of i)r.enqueue(c);const a=await this.resultCollector.waitForAll(t.length);return{success:a.success,failed:a.failed,errors:this.resultCollector.getFailed().map(c=>c.error||"æœªçŸ¥é”™è¯¯")}}setupPoolChain(t,s){const o=fn[t],i=this.getPoolMap();for(let p=0;p<o.length-1;p++){const k=o[p],y=o[p+1],$=i[k],E=i[y];$&&E&&$.setNextPool(E)}const r=o[o.length-1],a=i[r];a&&a.setNextPool(null);const c=o.indexOf("translate");if(c>=0&&c<o.length-1){const p=o[c+1];this.translatePool.setMode(t,s,i[p]||null)}else c===o.length-1&&this.translatePool.setMode(t,s,null)}getPoolMap(){return{detection:this.detectionPool,ocr:this.ocrPool,color:this.colorPool,translate:this.translatePool,inpaint:this.inpaintPool,render:this.renderPool}}getEntryPool(t){const o=fn[t][0];return this.getPoolMap()[o]||this.detectionPool}cancel(){this.isCancelled=!0,this.detectionPool.cancel(),this.ocrPool.cancel(),this.colorPool.cancel(),this.translatePool.cancel(),this.inpaintPool.cancel(),this.renderPool.cancel(),this.lock.reset()}reset(){this.isCancelled=!1,this.detectionPool.reset(),this.ocrPool.reset(),this.colorPool.reset(),this.translatePool.reset(),this.inpaintPool.reset(),this.renderPool.reset(),this.resultCollector.reset(),this.progressTracker.reset()}get progress(){return this.progressTracker.progress}getProgressTracker(){return this.progressTracker}getLockStatus(){return this.lock.getStatus()}get cancelled(){return this.isCancelled}}function wi(n){return new ki(n)}function $i(){const n=et(),t=ze(),s=ct(),o=gi(),i=Ro(),r=Z(()=>o.isTranslating.value||n.isBatchTranslationInProgress),a=Z(()=>o.progressPercent.value);async function c(y){if(n.images.length===0)return s.error("è¯·å…ˆä¸Šä¼ å›¾ç‰‡"),{success:!1,completed:0,failed:0,errors:["æ²¡æœ‰å›¾ç‰‡"]};const $=t.settings.parallel,E=y.scope==="all"||y.scope==="range";return $?.enabled&&E?(console.log(`ğŸš€ ä½¿ç”¨å¹¶è¡Œç®¡çº¿ï¼Œæ¨¡å¼: ${y.mode}, èŒƒå›´: ${y.scope}`),p(y)):(console.log(`ğŸš€ ä½¿ç”¨é¡ºåºç®¡çº¿ï¼Œæ¨¡å¼: ${y.mode}`),o.execute(y))}async function p(y){let $=n.images,E=0;if(y.scope==="range"&&y.pageRange){E=Math.max(0,y.pageRange.startPage-1);const D=Math.min(n.images.length-1,y.pageRange.endPage-1);if(E<=D&&E<n.images.length)$=n.images.slice(E,D+1),console.log(`ğŸ¯ å¹¶è¡Œç¿»è¯‘èŒƒå›´: ç¬¬ ${y.pageRange.startPage} è‡³ ${y.pageRange.endPage} é¡µï¼Œå…± ${$.length} å¼ ï¼Œèµ·å§‹ç´¢å¼• ${E}`);else return s.error("æ— æ•ˆçš„é¡µé¢èŒƒå›´"),{success:!1,completed:0,failed:0,errors:["æ— æ•ˆçš„é¡µé¢èŒƒå›´"]}}const R=Pt();try{if(i.progress.value.totalPages=$.length,i.progress.value.totalCompleted=0,i.progress.value.totalFailed=0,R&&(console.log("[ParallelPipeline] æ‰§è¡Œé¢„ä¿å­˜..."),s.info("å¼€å§‹é¢„ä¿å­˜åŸå§‹å›¾ç‰‡..."),!await An({onStart:V=>{const L=i.progress.value;L.preSave={isRunning:!0,current:0,total:V}},onProgress:(V,L)=>{const v=i.progress.value;v.preSave&&(v.preSave.current=V,v.preSave.total=L)},onComplete:()=>{const V=i.progress.value;V.preSave&&(V.preSave.isRunning=!1),s.success("é¢„ä¿å­˜å®Œæˆï¼Œå¼€å§‹ç¿»è¯‘...")},onError:V=>{const L=i.progress.value;L.preSave=void 0,s.warning(`é¢„ä¿å­˜å¤±è´¥ï¼š${V}ï¼Œç¿»è¯‘å®Œæˆåè¯·æ‰‹åŠ¨ä¿å­˜`)}}))){const V=i.progress.value;V.preSave=void 0}const D=y.mode;if(console.log(`ğŸš€ å¯åŠ¨å¹¶è¡Œç¿»è¯‘æ¨¡å¼: ${D}`),console.log(`   å›¾ç‰‡æ•°é‡: ${$.length}`),console.log(`   èµ·å§‹ç´¢å¼•: ${E}`),console.log(`   è‡ªåŠ¨ä¿å­˜: ${R?"å¯ç”¨":"ç¦ç”¨"}`),R){const q=i.progress.value;q.save={completed:0,total:$.length}}const T=await i.executeParallel(D,$,E);return T.success>0&&T.failed===0?s.success(`å¹¶è¡Œç¿»è¯‘å®Œæˆï¼ŒæˆåŠŸå¤„ç† ${T.success} å¼ å›¾ç‰‡`):T.success>0&&T.failed>0?s.warning(`å¹¶è¡Œç¿»è¯‘å®Œæˆï¼ŒæˆåŠŸ ${T.success} å¼ ï¼Œå¤±è´¥ ${T.failed} å¼ `):s.error("å¹¶è¡Œç¿»è¯‘å¤±è´¥"),{success:T.failed===0,completed:T.success,failed:T.failed,errors:T.errors}}catch(D){const T=D instanceof Error?D.message:"å¹¶è¡Œç¿»è¯‘å‡ºé”™";return s.error(T),{success:!1,completed:0,failed:$.length,errors:[T]}}finally{const D=i.progress.value;D.preSave=void 0,D.save=void 0,R&&(console.log("[ParallelPipeline] å®Œæˆä¿å­˜..."),await Fn())}}function k(){o.cancel(),i.cancel(),Un()}return{progress:o.progress,isExecuting:o.isExecuting,isTranslating:r,progressPercent:a,execute:c,cancel:k,STEP_CHAIN_CONFIGS:o.STEP_CHAIN_CONFIGS}}function bn(n="current",t){return{mode:"standard",scope:n,pageRange:t?.pageRange}}function Ti(n="all",t){return{mode:"hq",scope:n,pageRange:t?.pageRange,batchOptions:{batchSize:t?.batchSize??3,maxRetries:t?.maxRetries??2,rpmLimit:t?.rpmLimit??10,sessionResetFrequency:t?.sessionResetFrequency??5}}}function Ii(n="all",t){return{mode:"proofread",scope:n,pageRange:t?.pageRange,batchOptions:{batchSize:t?.batchSize??3,maxRetries:t?.maxRetries??2,rpmLimit:t?.rpmLimit??10,sessionResetFrequency:t?.sessionResetFrequency??5}}}function Pi(n="current",t){return{mode:"removeText",scope:n,pageRange:t?.pageRange}}function Ri(n){if(n.length===0)return{startPage:1,endPage:0};const t=[...n].sort((i,r)=>i-r),s=t[0],o=t[t.length-1];return{startPage:(s??0)+1,endPage:(o??0)+1}}function bt(n,t){const s=[];for(let o=n;o<t;o++)s.push(o);return s}function Do(){const n=et(),t=gt(),s=ct(),o=$i(),i=o.progress,r=o.isExecuting,a=o.isTranslating,c=o.progressPercent,p=Z(()=>o.isExecuting.value),k=Z(()=>o.isExecuting.value);async function y(z,se){if(z.length===0)return s.error("æ²¡æœ‰æŒ‡å®šè¦ç¿»è¯‘çš„é¡µé¢"),{success:!1,completed:0,failed:0,errors:["æ²¡æœ‰æŒ‡å®šè¦ç¿»è¯‘çš„é¡µé¢"]};const X=n.images.length;if(X===0)return s.error("è¯·å…ˆä¸Šä¼ å›¾ç‰‡"),{success:!1,completed:0,failed:0,errors:["è¯·å…ˆä¸Šä¼ å›¾ç‰‡"]};for(const B of z)if(B<0||B>=X)return s.error(`æ— æ•ˆçš„é¡µé¢ç´¢å¼•: ${B}`),{success:!1,completed:0,failed:0,errors:[`æ— æ•ˆçš„é¡µé¢ç´¢å¼•: ${B}`]};const ie=z.length===1,U=z.length===X;let W;if(ie){const B=n.currentImageIndex,d=z[0];d!==void 0&&n.setCurrentImageIndex(d),W=$(se,"current");const m=await o.execute(W);return n.setCurrentImageIndex(B),{success:m.success,completed:m.completed,failed:m.failed,errors:m.errors??[]}}else if(U)W=$(se,"all");else{const B=Ri(z);W=$(se,"range",B)}const te=await o.execute(W);return{success:te.success,completed:te.completed,failed:te.failed,errors:te.errors??[]}}function $(z,se,X){switch(z){case"standard":return bn(se,X?{pageRange:X}:void 0);case"hq":return Ti(se,X?{pageRange:X}:void 0);case"proofread":return Ii(se,X?{pageRange:X}:void 0);case"removeText":return Pi(se,X?{pageRange:X}:void 0);default:return bn(se,X?{pageRange:X}:void 0)}}async function E(){return(await y([n.currentImageIndex],"standard")).success}async function R(z){return(await y([z],"standard")).success}async function D(){return(await y(bt(0,n.images.length),"standard")).success}async function T(z){const se=bt(z.startPage-1,z.endPage);return(await y(se,"standard")).success}function q(){o.cancel()}async function V(){return(await y([n.currentImageIndex],"removeText")).success}async function L(){return(await y(bt(0,n.images.length),"removeText")).success}async function v(z){const se=bt(z.startPage-1,z.endPage);return(await y(se,"removeText")).success}async function g(){const z=n.getFailedImageIndices();return z.length===0?(s.info("æ²¡æœ‰å¤±è´¥çš„å›¾ç‰‡éœ€è¦é‡æ–°ç¿»è¯‘"),!0):(await y(z,"standard")).success}async function x(z){const se=z?bt(z.startPage-1,z.endPage):bt(0,n.images.length);return(await y(se,"hq")).success}async function _(z){const se=z?bt(z.startPage-1,z.endPage):bt(0,n.images.length);return(await y(se,"proofread")).success}async function K(){if(!n.currentImage)return s.error("è¯·å…ˆä¸Šä¼ å›¾ç‰‡"),!1;const se=t.bubbles;return!se||se.length===0?(s.error("å½“å‰å›¾ç‰‡æ²¡æœ‰æ°”æ³¡æ¡†ï¼Œè¯·å…ˆæ£€æµ‹æˆ–æ‰‹åŠ¨æ·»åŠ "),!1):(n.setManuallyAnnotated(!0),E())}return{progress:i,isTranslatingSingle:r,isHqTranslating:p,isProofreading:k,isTranslating:a,progressPercent:c,translatePages:y,range:bt,translateCurrentImage:E,translateImageByIndex:R,translateAllImages:D,translateImageRange:T,cancelBatchTranslation:q,removeTextOnly:V,removeAllTexts:L,removeTextRange:v,retryFailedImages:g,executeHqTranslation:x,executeProofreading:_,translateWithCurrentBubbles:K}}function Di(){const n=gt(),t=et(),s=C(!1);function o(){if(!s.value)return;const i=t.currentImage;n.bubbleCount>0?t.updateCurrentBubbleStates([...n.bubbles]):i&&Array.isArray(i.bubbleStates)&&i.bubbleStates.length>0&&(t.updateCurrentBubbleStates([]),console.log("é€€å‡ºç¼–è¾‘æ¨¡å¼ï¼ˆæ— é‡æ¸²æŸ“ï¼‰ï¼Œç”¨æˆ·å·²åˆ é™¤æ‰€æœ‰æ°”æ³¡")),s.value=!1,n.clearSelection(),console.log("å·²é€€å‡ºç¼–è¾‘æ¨¡å¼ï¼ˆæ— é‡æ¸²æŸ“ï¼‰")}return{isActive:s,exitEditModeWithoutRender:o}}function Mi(){const n=Cn(),t=ze(),s=et(),o=It(),i=gt(),r=Di(),a=C(!1),c=C(!1),p=C(null),k=C([]),y=C([]),$=C([]),E=C(null),R=C(null),D=C(null),T=C(null),q=C(!1);async function V(U=!1){if(!U&&(a.value||c.value)){console.log("[TranslateInit] å·²ç»åˆå§‹åŒ–ï¼Œä»…é‡æ–°åŠ è½½ä¸Šä¸‹æ–‡"),await _();return}console.log("[TranslateInit] å¼€å§‹åˆå§‹åŒ–åº”ç”¨..."),a.value=!0,p.value=null;try{await L(),await v(),await g(),await x(),await _(),console.log("[TranslateInit] åº”ç”¨åˆå§‹åŒ–å®Œæˆ"),c.value=!0}catch(W){console.error("[TranslateInit] åº”ç”¨åˆå§‹åŒ–å¤±è´¥:",W),p.value=W instanceof Error?W.message:"åˆå§‹åŒ–å¤±è´¥"}finally{a.value=!1}}async function L(){console.log("[TranslateInit] åˆå§‹åŒ–è®¾ç½®..."),t.initSettings();try{const U=await t.loadFromBackend();console.log(U?"[TranslateInit] å·²ä»åç«¯åŠ è½½è®¾ç½®":"[TranslateInit] åç«¯æ— è®¾ç½®ï¼Œä½¿ç”¨ localStorage æ•°æ®")}catch(U){console.warn("[TranslateInit] ä»åç«¯åŠ è½½è®¾ç½®å¤±è´¥ï¼Œä½¿ç”¨ localStorage æ•°æ®:",U)}console.log("[TranslateInit] è®¾ç½®åˆå§‹åŒ–å®Œæˆ")}async function v(){console.log("[TranslateInit] åˆå§‹åŒ–å­—ä½“åˆ—è¡¨...");try{const U=await $n();U.fonts&&U.fonts.length>0?(k.value=U.fonts,console.log(`[TranslateInit] å·²åŠ è½½ ${U.fonts.length} ä¸ªå­—ä½“`)):U.error?console.warn("[TranslateInit] è·å–å­—ä½“åˆ—è¡¨å¤±è´¥:",U.error):console.warn("[TranslateInit] å­—ä½“åˆ—è¡¨ä¸ºç©º")}catch(U){console.error("[TranslateInit] è·å–å­—ä½“åˆ—è¡¨å¤±è´¥:",U)}}async function g(){console.log("[TranslateInit] åˆå§‹åŒ–ç¿»è¯‘æç¤ºè¯è®¾ç½®...");try{const U=await Ms();U.prompt_names!==void 0?(y.value=U.prompt_names||[],!t.settings.translatePrompt&&U.default_prompt_content&&t.setTranslatePrompt(U.default_prompt_content),console.log(`[TranslateInit] å·²åŠ è½½ ${y.value.length} ä¸ªç¿»è¯‘æç¤ºè¯`)):U.error&&console.warn("[TranslateInit] è·å–ç¿»è¯‘æç¤ºè¯å¤±è´¥:",U.error)}catch(U){console.error("[TranslateInit] è·å–ç¿»è¯‘æç¤ºè¯å¤±è´¥:",U)}}async function x(){console.log("[TranslateInit] åˆå§‹åŒ–æ–‡æœ¬æ¡†æç¤ºè¯è®¾ç½®...");try{const U=await Ds();U.prompt_names!==void 0?($.value=U.prompt_names||[],!t.settings.textboxPrompt&&U.default_prompt_content&&t.setTextboxPrompt(U.default_prompt_content),console.log(`[TranslateInit] å·²åŠ è½½ ${$.value.length} ä¸ªæ–‡æœ¬æ¡†æç¤ºè¯`)):U.error&&console.warn("[TranslateInit] è·å–æ–‡æœ¬æ¡†æç¤ºè¯å¤±è´¥:",U.error)}catch(U){console.error("[TranslateInit] è·å–æ–‡æœ¬æ¡†æç¤ºè¯å¤±è´¥:",U)}}async function _(){const U=n.query.book,W=n.query.chapter;if(!U||!W){console.log("[TranslateInit] æœªæŒ‡å®šä¹¦ç±/ç« èŠ‚å‚æ•°ï¼Œä½¿ç”¨ç‹¬ç«‹æ¨¡å¼"),q.value=!1,E.value=null,R.value=null,D.value=null,T.value=null,o.clearContext();return}console.log(`[TranslateInit] æ£€æµ‹åˆ°ä¹¦ç±/ç« èŠ‚å‚æ•°: book=${U}, chapter=${W}`),q.value=!0,E.value=U,R.value=W;try{const te=await Bs(U);if(!te.success||!te.book){console.warn("[TranslateInit] ä¹¦ç±ä¸å­˜åœ¨:",U),_e("ä¹¦ç±ä¸å­˜åœ¨","warning");return}const B=te.book,d=B.chapters?.find(m=>m.id===W);if(!d){console.warn("[TranslateInit] ç« èŠ‚ä¸å­˜åœ¨:",W),_e("ç« èŠ‚ä¸å­˜åœ¨","warning");return}if(D.value=B.title,T.value=d.title,o.setBookChapterContext(U,W,B.title,d.title),typeof document<"u"&&(document.title=`${d.title} - ${B.title} - Saber-Translator`),d.session_path){console.log(`[TranslateInit] å°è¯•åŠ è½½ç« èŠ‚ä¼šè¯: ${d.session_path}`);try{await o.loadSessionByPath(d.session_path),_e(`å·²åŠ è½½ç« èŠ‚: ${d.title}`,"success")}catch{console.log("[TranslateInit] ç« èŠ‚ä¼šè¯æ•°æ®ä¸å­˜åœ¨æˆ–åŠ è½½å¤±è´¥ï¼Œå°†åˆ›å»ºæ–°ä¼šè¯")}}}catch(te){console.error("[TranslateInit] åŠ è½½ä¹¦ç±/ç« èŠ‚ä¿¡æ¯å¤±è´¥:",te),_e("åŠ è½½ä¹¦ç±ä¿¡æ¯å¤±è´¥","error")}}function K(U){if(U<0||U>=s.imageCount){console.warn(`[TranslateInit] æ— æ•ˆçš„å›¾ç‰‡ç´¢å¼•: ${U}`);return}window._isChangingFromSwitchImage=!0,r.isActive.value&&r.exitEditModeWithoutRender(),s.currentImage&&i.bubbles.length>0&&s.updateCurrentImageProperty("bubbleStates",i.bubbles),s.setCurrentImageIndex(U);const te=s.currentImage;if(!te){console.warn("[TranslateInit] åˆ‡æ¢åˆ°çš„å›¾ç‰‡ä¸å­˜åœ¨"),window._isChangingFromSwitchImage=!1;return}console.log(`[TranslateInit] åˆ‡æ¢åˆ°å›¾ç‰‡: ${U}, ${te.fileName}`),te.bubbleStates&&te.bubbleStates.length>0?i.setBubbles(te.bubbleStates,!0):i.clearBubblesLocal(),z(te),setTimeout(()=>{window._isChangingFromSwitchImage=!1,console.log("[TranslateInit] å·²é‡ç½®åˆ‡æ¢å›¾ç‰‡æ“ä½œæ ‡è®°")},100)}function z(U){if(!U)return;const W=U.bubbleStates?.[0];W&&t.updateTextStyle({fontSize:W.fontSize||t.settings.textStyle.fontSize,fontFamily:W.fontFamily||t.settings.textStyle.fontFamily,layoutDirection:U.layoutDirection||t.settings.textStyle.layoutDirection,textColor:W.textColor||t.settings.textStyle.textColor,fillColor:W.fillColor||t.settings.textStyle.fillColor,strokeEnabled:W.strokeEnabled??t.settings.textStyle.strokeEnabled,strokeColor:W.strokeColor||t.settings.textStyle.strokeColor,strokeWidth:W.strokeWidth||t.settings.textStyle.strokeWidth,inpaintMethod:W.inpaintMethod||t.settings.textStyle.inpaintMethod,autoFontSize:U.autoFontSize??t.settings.textStyle.autoFontSize,useAutoTextColor:U.useAutoTextColor??t.settings.textStyle.useAutoTextColor})}function se(){s.canGoPrevious&&K(s.currentImageIndex-1)}function X(){s.canGoNext&&K(s.currentImageIndex+1)}function ie(){dt(async()=>{await V()})}return{isInitializing:a,isInitialized:c,initError:p,fontList:k,promptNames:y,textboxPromptNames:$,currentBookId:E,currentChapterId:R,currentBookTitle:D,currentChapterTitle:T,isBookshelfMode:q,initializeApp:V,initializeSettings:L,initializeFontList:v,initializePromptSettings:g,initializeTextboxPromptSettings:x,initializeBookChapterContext:_,switchImage:K,goToPrevious:se,goToNext:X,loadImageSettingsToStore:z,editMode:r,setupAutoInit:ie}}const Ei={key:0,id:"translationProgressBar",class:"translation-progress-bar"},Bi={class:"parallel-header"},Ai={class:"header-title"},Li={key:0,class:"presave-section"},Fi={class:"presave-label"},Ui={class:"presave-progress-bar"},Oi={class:"pools-list"},zi={class:"pool-label"},Ni={class:"pool-icon"},Vi={class:"pool-name"},Wi={class:"pool-progress-bar"},Ki={class:"pool-stats"},qi={class:"completed-count"},Hi={class:"total-count"},ji={key:0,class:"waiting-badge"},Ji={key:1,class:"lock-indicator",title:"ç­‰å¾…æ·±åº¦å­¦ä¹ é”"},Yi={key:0,class:"pool-row save-row"},Xi={class:"pool-progress-bar"},Gi={class:"pool-stats"},Zi={class:"completed-count"},Qi={class:"total-count"},er={class:"overall-section"},tr={class:"overall-label"},or={key:0,class:"failed-text"},nr={class:"overall-progress-bar"},sr={class:"progress-bar-label"},ar={key:0,class:"failed-count"},lr={class:"progress-bar"},ir=je({__name:"TranslationProgress",props:{progress:{}},setup(n){const t=n,s=et(),o=ze(),i=Do(),r=Ro(),a=Z(()=>{const g=r.progress.value?.preSave?.isRunning;return o.settings.parallel?.enabled&&(r.isRunning.value||g)}),c=Z(()=>r.progress.value),p=Z(()=>{const g=c.value;return!g||g.totalPages===0?0:Math.round(g.totalCompleted/g.totalPages*100)});function k(g){const x=c.value?.totalPages||0;return x===0?0:Math.round(g.completed/x*100)}function y(){const g=c.value?.totalPages||0;return g===0?0:Math.max(3,Math.round(1/g*100))}function $(){const g=c.value?.preSave;return!g||g.total===0?0:Math.round(g.current/g.total*100)}function E(){const g=c.value?.save;return!g||g.total===0?0:Math.round(g.completed/g.total*100)}const R=Z(()=>t.progress||i.progress.value),D=Z(()=>R.value.isInProgress||s.isBatchTranslationInProgress||a.value),T=Z(()=>R.value.current),q=Z(()=>R.value.total),V=Z(()=>R.value.failed),L=Z(()=>R.value.percentage!==void 0?R.value.percentage:q.value===0?0:Math.round(T.value/q.value*100)),v=Z(()=>R.value.label?R.value.label:`ç¿»è¯‘ä¸­ï¼š${T.value} / ${q.value}`);return(g,x)=>D.value?(M(),A("div",Ei,[a.value&&c.value?(M(),A(Oe,{key:0},[e("div",Bi,[e("span",Ai,"ğŸš€ å¹¶è¡Œç¿»è¯‘ä¸­ï¼š"+oe(c.value.totalCompleted)+"/"+oe(c.value.totalPages),1)]),c.value.preSave?.isRunning?(M(),A("div",Li,[e("div",Fi," ğŸ“¥ é¢„ä¿å­˜åŸå§‹å›¾ç‰‡ï¼š"+oe(c.value.preSave.current)+"/"+oe(c.value.preSave.total),1),e("div",Ui,[e("div",{class:"presave-progress-fill",style:at({width:$()+"%"})},null,4)])])):de("",!0),e("div",Oi,[(M(!0),A(Oe,null,Ye(c.value.pools,_=>(M(),A("div",{key:_.name,class:Ie(["pool-row",{"pool-processing":_.processing,"pool-waiting-lock":_.isWaitingLock}])},[e("div",zi,[e("span",Ni,oe(_.icon),1),e("span",Vi,oe(_.name),1)]),e("div",Wi,[e("div",{class:"progress-completed",style:at({width:k(_)+"%"})},null,4),_.processing?(M(),A("div",{key:0,class:"progress-processing",style:at({left:k(_)+"%",width:y()+"%"})},null,4)):de("",!0)]),e("div",Ki,[e("span",qi,oe(_.completed),1),e("span",Hi,"/ "+oe(c.value.totalPages),1),_.waiting>0?(M(),A("span",ji,"+"+oe(_.waiting),1)):de("",!0),_.isWaitingLock?(M(),A("span",Ji,"ğŸ”’")):de("",!0)])],2))),128)),c.value.save?(M(),A("div",Yi,[x[0]||(x[0]=e("div",{class:"pool-label"},[e("span",{class:"pool-icon"},"ğŸ’¾"),e("span",{class:"pool-name"},"ä¿å­˜")],-1)),e("div",Xi,[e("div",{class:"progress-completed save-progress",style:at({width:E()+"%"})},null,4)]),e("div",Gi,[e("span",Zi,oe(c.value.save.completed),1),e("span",Qi,"/ "+oe(c.value.save.total),1)])])):de("",!0)]),x[1]||(x[1]=e("div",{class:"divider"},null,-1)),e("div",er,[e("div",tr,[me(" æ€»è¿›åº¦ï¼š"+oe(p.value)+"% ",1),c.value.totalFailed>0?(M(),A("span",or," ï¼ˆ"+oe(c.value.totalFailed)+" å¤±è´¥ï¼‰ ",1)):de("",!0)]),e("div",nr,[e("div",{class:"overall-progress-fill progress-stripe",style:at({width:p.value+"%"})},null,4)])])],64)):(M(),A(Oe,{key:1},[e("div",sr,[me(oe(v.value)+" ",1),V.value>0?(M(),A("span",ar,"ï¼ˆ"+oe(V.value)+" å¼ å¤±è´¥ï¼‰",1)):de("",!0)]),e("div",lr,[e("div",{class:"progress progress-stripe",style:at({width:`${L.value}%`})},null,4)])],64))])):de("",!0)}}),rr=He(ir,[["__scopeId","data-v-532ece5f"]]),ur=je({__name:"SponsorModal",emits:["close"],setup(n,{emit:t}){const s=t;return(o,i)=>(M(),ut(Tn,{title:"æ”¯æŒä½œè€…",onClose:i[1]||(i[1]=r=>s("close"))},{footer:St(()=>[e("button",{type:"button",class:"btn btn-primary",onClick:i[0]||(i[0]=r=>s("close"))},"å…³é—­")]),default:St(()=>[i[2]||(i[2]=e("div",{class:"sponsor-content"},[e("p",{class:"sponsor-message"}," å¦‚æœè¿™ä¸ªé¡¹ç›®å¯¹ä½ æœ‰å¸®åŠ©ï¼Œæ¬¢è¿è¯·ä½œè€…å–æ¯å’–å•¡ â˜• "),e("div",{class:"qr-codes"},[e("div",{class:"qr-item"},[e("div",{class:"qr-image"},[e("img",{src:"/pic/wechat_qrcode.png",alt:"å¾®ä¿¡æ”¯ä»˜"})]),e("span",{class:"qr-label"},"å¾®ä¿¡æ”¯ä»˜")]),e("div",{class:"qr-item"},[e("div",{class:"qr-image"},[e("img",{src:"/pic/alipay_qrcode.png",alt:"æ”¯ä»˜å®"})]),e("span",{class:"qr-label"},"æ”¯ä»˜å®")])]),e("p",{class:"sponsor-thanks"},"æ„Ÿè°¢æ‚¨çš„æ”¯æŒï¼ğŸ™")],-1))]),_:1}))}}),cr=He(ur,[["__scopeId","data-v-02b6948e"]]);function dr(n){const t=C(""),s=Z(()=>n.value.some(R=>R.folderPath)),o=Z(()=>{if(!s.value)return null;const R={name:"æ ¹ç›®å½•",path:"",images:[],subfolders:[]},D=new Map;D.set("",R);for(const T of n.value){const q=T.folderPath||"";if(q&&!D.has(q)){const V=q.split("/");let L="";for(const v of V){const g=L;if(L=L?`${L}/${v}`:v,!D.has(L)){const x={name:v,path:L,images:[],subfolders:[]};D.set(L,x),D.has(g)&&D.get(g).subfolders.push(x)}}}D.has(q)&&D.get(q).images.push(T)}return R}),i=Z(()=>{if(!t.value)return[{name:"æ ¹ç›®å½•",path:""}];const R=t.value.split("/"),D=[{name:"æ ¹ç›®å½•",path:""}];let T="";for(const q of R)T=T?`${T}/${q}`:q,D.push({name:q,path:T});return D}),r=Z(()=>{if(!o.value)return null;if(!t.value)return o.value;const R=(D,T)=>{if(D.path===T)return D;for(const q of D.subfolders){const V=R(q,T);if(V)return V}return null};return R(o.value,t.value)}),a=Z(()=>r.value?.subfolders||[]),c=Z(()=>r.value?.images||[]);function p(R){t.value=R}function k(){if(!t.value)return;const R=t.value.lastIndexOf("/");t.value=R>0?t.value.substring(0,R):""}function y(R){t.value=R}function $(R){let D=R.images.length;for(const T of R.subfolders)D+=$(T);return D}function E(){t.value=""}return{currentFolderPath:t,useTreeMode:s,folderTree:o,breadcrumbs:i,currentFolder:r,currentSubfolders:a,currentImages:c,enterFolder:p,goUp:k,navigateTo:y,getFolderImageCount:$,resetToRoot:E}}const gr={id:"thumbnail-sidebar",class:"thumbnail-sidebar"},pr={class:"card thumbnail-card"},mr={class:"breadcrumb-nav"},vr=["onClick"],fr={key:0,class:"breadcrumb-sep"},br=["onClick"],hr={class:"folder-info"},yr=["title"],xr={class:"folder-count"},_r=["title","onClick"],Cr=["src","alt"],Sr={class:"page-number-indicator"},kr={key:1,class:"translated-indicator"},wr={key:2,class:"translation-failed-indicator"},$r={key:3,class:"labeled-indicator"},Tr={key:4,class:"thumbnail-processing-indicator"},Ir={key:0,class:"empty-folder"},Pr=["title","data-index","onClick"],Rr=["src","alt"],Dr={class:"page-number-indicator"},Mr={key:1,class:"translated-indicator"},Er={key:2,class:"translation-failed-indicator"},Br={key:3,class:"labeled-indicator"},Ar={key:4,class:"thumbnail-processing-indicator"},Lr={key:2,class:"empty-state"},Fr=je({__name:"ThumbnailSidebar",emits:["select"],setup(n,{emit:t}){const s=t,o=et(),i=C(null),r=C([]),a=Z(()=>o.images),c=Z(()=>o.currentImageIndex),p=Z(()=>o.hasImages),{useTreeMode:k,breadcrumbs:y,currentSubfolders:$,currentImages:E,currentFolderPath:R,enterFolder:D,goUp:T,navigateTo:q,getFolderImageCount:V,folderTree:L,resetToRoot:v}=dr(a);Se(()=>a.value.length,(W,te)=>{(W===0||te===0&&W>0)&&v()});function g(W){return a.value.findIndex(te=>te.id===W.id)}function x(W){return W.translationFailed?"failed":W.isManuallyAnnotated?"labeled":W.translationStatus==="processing"?"processing":null}function _(W){return W.translationStatus==="completed"}function K(W){s("select",W)}function z(W){D(W.path)}function se(W){q(W)}function X(){pt(()=>{const W=r.value[c.value];if(W&&i.value){const te=i.value,B=W.offsetTop-te.clientHeight/2+W.clientHeight/2;te.scrollTo({top:Math.max(0,B),behavior:"smooth"})}})}function ie(W,te){r.value[te]=W}function U(W){return W.translationFailed?"ç¿»è¯‘å¤±è´¥ï¼Œç‚¹å‡»å¯é‡è¯•":W.isManuallyAnnotated?"åŒ…å«æ‰‹åŠ¨æ ‡æ³¨":W.translationStatus==="completed"?"å·²å®Œæˆç¿»è¯‘":W.fileName||""}return Se(c,()=>{X()}),dt(()=>{p.value&&X()}),(W,te)=>(M(),A("aside",gr,[e("div",pr,[te[5]||(te[5]=e("h2",null,"å›¾ç‰‡æ¦‚è§ˆ",-1)),p.value&&H(k)&&H(L)?(M(),A(Oe,{key:0},[e("div",mr,[(M(!0),A(Oe,null,Ye(H(y),(B,d)=>(M(),A(Oe,{key:B.path},[e("span",{class:Ie(["breadcrumb-item",{active:d===H(y).length-1}]),onClick:m=>d<H(y).length-1&&se(B.path)},oe(d===0?"ğŸ“":"")+oe(B.name),11,vr),d<H(y).length-1?(M(),A("span",fr,"/")):de("",!0)],64))),128))]),H(R)?(M(),A("div",{key:0,class:"folder-back-btn",onClick:te[0]||(te[0]=(...B)=>H(T)&&H(T)(...B))},[...te[1]||(te[1]=[e("span",{class:"back-icon"},"â¬…ï¸",-1),e("span",null,"è¿”å›ä¸Šçº§",-1)])])):de("",!0),e("div",{ref_key:"containerRef",ref:i,class:"folder-content-list"},[(M(!0),A(Oe,null,Ye(H($),B=>(M(),A("div",{key:B.path,class:"folder-item",onClick:d=>z(B)},[te[2]||(te[2]=e("span",{class:"folder-icon"},"ğŸ“",-1)),e("div",hr,[e("span",{class:"folder-name",title:B.name},oe(B.name),9,yr),e("span",xr,"("+oe(H(V)(B))+")",1)])],8,br))),128)),(M(!0),A(Oe,null,Ye(H(E),B=>(M(),A("div",{key:B.id,ref_for:!0,ref:d=>ie(d,g(B)),class:Ie(["thumbnail-item",{active:g(B)===c.value}]),title:U(B),onClick:d=>K(g(B))},[B.originalDataURL?(M(),A("img",{key:0,src:B.originalDataURL,alt:B.fileName,class:"thumbnail-image"},null,8,Cr)):de("",!0),e("span",Sr,oe(g(B)+1),1),_(B)?(M(),A("span",kr,"âœ“")):de("",!0),x(B)==="failed"?(M(),A("span",wr,"!")):x(B)==="labeled"?(M(),A("span",$r,"âœï¸")):de("",!0),x(B)==="processing"?(M(),A("div",Tr,"âŸ³")):de("",!0)],10,_r))),128)),H($).length===0&&H(E).length===0?(M(),A("div",Ir,[...te[3]||(te[3]=[e("p",null,"æ­¤æ–‡ä»¶å¤¹ä¸ºç©º",-1)])])):de("",!0)],512)],64)):p.value?(M(),A("ul",{key:1,ref_key:"containerRef",ref:i,id:"thumbnailList",class:"thumbnail-list"},[(M(!0),A(Oe,null,Ye(a.value,(B,d)=>(M(),A("li",{key:B.id,ref_for:!0,ref:m=>ie(m,d),class:Ie(["thumbnail-item",{active:d===c.value}]),title:U(B),"data-index":d,onClick:m=>K(d)},[B.originalDataURL?(M(),A("img",{key:0,src:B.originalDataURL,alt:B.fileName,class:"thumbnail-image"},null,8,Rr)):de("",!0),e("span",Dr,oe(d+1),1),_(B)?(M(),A("span",Mr,"âœ“")):de("",!0),x(B)==="failed"?(M(),A("span",Er,"!")):x(B)==="labeled"?(M(),A("span",Br,"âœï¸")):de("",!0),x(B)==="processing"?(M(),A("div",Ar," âŸ³ ")):de("",!0)],10,Pr))),128))],512)):(M(),A("div",Lr,[...te[4]||(te[4]=[e("p",null,"æš‚æ— å›¾ç‰‡",-1)])]))])]))}}),Ur=He(Fr,[["__scopeId","data-v-4c1f4f1b"]]),Or={class:"saved-prompts-picker"},zr={class:"prompts-chips-container"},Nr={key:0,class:"empty-hint"},Vr={key:1,class:"empty-hint"},Wr=["title","onClick"],Kr=je({__name:"SavedPromptsPicker",props:{promptType:{}},emits:["select"],setup(n,{expose:t,emit:s}){const o=n,i=s,r=C([]),a=C(!1);async function c(){a.value=!0;try{let k;o.promptType==="textbox"?k=await Ke.getTextboxPrompts():k=await Ke.getPrompts(o.promptType);const y=k.prompt_names||[];r.value=y.map($=>({name:$}))}catch(k){console.error("åŠ è½½æç¤ºè¯åˆ—è¡¨å¤±è´¥:",k),r.value=[]}finally{a.value=!1}}async function p(k){try{let y;o.promptType==="textbox"?y=await Ke.getTextboxPromptContent(k):y=await Ke.getPromptContent(o.promptType,k),y.prompt_content&&i("select",y.prompt_content,k)}catch(y){console.error("åŠ è½½æç¤ºè¯å†…å®¹å¤±è´¥:",y)}}return Se(()=>o.promptType,()=>{c()}),dt(()=>{c()}),t({refresh:c}),(k,y)=>(M(),A("div",Or,[y[1]||(y[1]=e("span",{class:"picker-label"},"ğŸ“‘ å¿«é€Ÿé€‰æ‹©:",-1)),e("div",zr,[a.value?(M(),A("span",Nr,"åŠ è½½ä¸­...")):r.value.length===0?(M(),A("span",Vr,"æš‚æ— ä¿å­˜çš„æç¤ºè¯")):(M(!0),A(Oe,{key:2},Ye(r.value,$=>(M(),A("button",{key:$.name,type:"button",class:"prompt-chip",title:$.name,onClick:E=>p($.name)},[y[0]||(y[0]=e("span",{class:"chip-icon"},"ğŸ“",-1)),me(" "+oe($.name),1)],8,Wr))),128))])]))}}),Ut=He(Kr,[["__scopeId","data-v-2ebbb8b3"]]),qr={class:"ocr-settings"},Hr={class:"settings-group"},jr={class:"settings-item"},Jr={class:"settings-item"},Yr={class:"input-hint"},Xr={class:"settings-group"},Gr={class:"settings-item"},Zr={class:"settings-group"},Qr={class:"settings-row"},eu={class:"settings-item"},tu={class:"password-input-wrapper"},ou=["type"],nu={key:0,class:"eye-icon"},su={key:1,class:"eye-off-icon"},au={class:"settings-item"},lu={class:"password-input-wrapper"},iu=["type"],ru={key:0,class:"eye-icon"},uu={key:1,class:"eye-off-icon"},cu={class:"settings-row"},du={class:"settings-item"},gu={class:"settings-item"},pu=["disabled"],mu={class:"settings-group"},vu={class:"settings-row"},fu={class:"settings-item"},bu={class:"settings-item"},hu={class:"password-input-wrapper"},yu=["type"],xu={key:0,class:"eye-icon"},_u={key:1,class:"eye-off-icon"},Cu={class:"settings-item"},Su={class:"settings-item"},ku={class:"model-input-with-fetch"},wu=["disabled"],$u={class:"fetch-text"},Tu={key:0,class:"model-select-container"},Iu={class:"model-count"},Pu={class:"settings-item"},Ru={class:"prompt-format-selector"},Du={class:"settings-item"},Mu={class:"settings-item"},Eu=["disabled"],Bu=je({__name:"OcrSettings",setup(n){const t=[{label:"MangaOCR (æ—¥è¯­ä¸“ç”¨)",value:"manga_ocr"},{label:"PaddleOCR (å¤šè¯­è¨€)",value:"paddle_ocr"},{label:"PaddleOCR-VL",value:"paddleocr_vl"},{label:"ç™¾åº¦OCR",value:"baidu_ocr"},{label:"48px OCR",value:"48px_ocr"},{label:"AIè§†è§‰OCR",value:"ai_vision"}],s=[{label:"æ ‡å‡†ç‰ˆ",value:"standard"},{label:"é«˜ç²¾åº¦ç‰ˆ",value:"high_precision"}],o=[{label:"è‡ªåŠ¨æ£€æµ‹",value:"auto_detect"},{label:"ä¸­è‹±æ–‡æ··åˆ",value:"CHN_ENG"},{label:"è‹±æ–‡",value:"ENG"},{label:"æ—¥è¯­",value:"JAP"},{label:"éŸ©è¯­",value:"KOR"},{label:"æ³•è¯­",value:"FRE"},{label:"å¾·è¯­",value:"GER"},{label:"ä¿„è¯­",value:"RUS"}],i=[{label:"SiliconFlow (ç¡…åŸºæµåŠ¨)",value:"siliconflow"},{label:"ç«å±±å¼•æ“",value:"volcano"},{label:"Google Gemini",value:"gemini"},{label:"è‡ªå®šä¹‰ OpenAI å…¼å®¹æœåŠ¡",value:"custom_openai_vision"}],r=[{label:"æ—¥è¯­",value:"japanese"},{label:"ç®€ä½“ä¸­æ–‡",value:"chinese"},{label:"ç¹ä½“ä¸­æ–‡",value:"chinese_cht"},{label:"è‹±è¯­",value:"english"},{label:"éŸ©è¯­",value:"korean"}],a=[{label:"æ™®é€šæç¤ºè¯",value:"false"},{label:"JSONæç¤ºè¯",value:"true"}],c=[{label:"ğŸš€ å¸¸ç”¨è¯­è¨€",options:[{label:"æ—¥è¯­",value:"japanese"},{label:"è‹±è¯­",value:"en"},{label:"ç®€ä½“ä¸­æ–‡",value:"chinese"},{label:"ç¹ä½“ä¸­æ–‡",value:"chinese_cht"},{label:"éŸ©è¯­",value:"korean"}]},{label:"ğŸŒ æ‹‰ä¸è¯­ç³»",options:[{label:"æ³•è¯­",value:"french"},{label:"å¾·è¯­",value:"german"},{label:"è¥¿ç­ç‰™è¯­",value:"spanish"},{label:"æ„å¤§åˆ©è¯­",value:"italian"},{label:"è‘¡è„ç‰™è¯­",value:"portuguese"}]},{label:"ğŸŒ å…¶ä»–è¯­ç³»",options:[{label:"ä¿„è¯­",value:"russian"}]}],p=ze(),k=ct(),y=C({apiKey:p.settings.baiduOcr.apiKey,secretKey:p.settings.baiduOcr.secretKey,version:p.settings.baiduOcr.version,sourceLanguage:p.settings.baiduOcr.sourceLanguage}),$=C({apiKey:p.settings.aiVisionOcr.apiKey,modelName:p.settings.aiVisionOcr.modelName,customBaseUrl:p.settings.aiVisionOcr.customBaseUrl,prompt:p.settings.aiVisionOcr.prompt,rpmLimit:p.settings.aiVisionOcr.rpmLimit,minImageSize:p.settings.aiVisionOcr.minImageSize}),E=Z(()=>p.settings);Se(()=>y.value.apiKey,B=>{p.updateBaiduOcr({apiKey:B})}),Se(()=>y.value.secretKey,B=>{p.updateBaiduOcr({secretKey:B})}),Se(()=>y.value.version,B=>{p.updateBaiduOcr({version:B})}),Se(()=>y.value.sourceLanguage,B=>{p.updateBaiduOcr({sourceLanguage:B})}),Se(()=>$.value.apiKey,B=>{p.updateAiVisionOcr({apiKey:B})}),Se(()=>$.value.modelName,B=>{p.updateAiVisionOcr({modelName:B})}),Se(()=>$.value.customBaseUrl,B=>{p.updateAiVisionOcr({customBaseUrl:B})}),Se(()=>$.value.prompt,B=>{p.updateAiVisionOcr({prompt:B})}),Se(()=>$.value.rpmLimit,B=>{p.updateAiVisionOcr({rpmLimit:B})}),Se(()=>$.value.minImageSize,B=>{p.updateAiVisionOcr({minImageSize:B})});const R=C(!1),D=C(!1),T=C(!1),q=C(!1),V=C(!1),L=C([]),v=Z(()=>{const B=[{label:"-- é€‰æ‹©æ¨¡å‹ --",value:""}];return L.value.forEach(d=>{B.push({label:d,value:d})}),B});function g(){p.saveToStorage()}function x(){p.saveToStorage()}function _(B){p.updatePaddleOcrVl({sourceLanguage:B})}function K(){switch(p.settings.ocrEngine){case"manga_ocr":return"MangaOCR ä¸“ä¸ºæ—¥è¯­æ¼«ç”»ä¼˜åŒ–ï¼Œæºè¯­è¨€è®¾ç½®ä¸å½±å“è¯†åˆ«";case"paddle_ocr":return"PaddleOCR ä¼šæ ¹æ®æºè¯­è¨€åŠ è½½å¯¹åº”çš„è¯†åˆ«æ¨¡å‹";case"paddleocr_vl":return"PaddleOCR-VL åŸºäº VLM å¾®è°ƒï¼Œä¸“ä¸ºæ—¥è¯­æ¼«ç”»ä¼˜åŒ–ï¼Œå‡†ç¡®ç‡é«˜è¾¾ 70%";case"baidu_ocr":return"ç™¾åº¦OCR ä½¿ç”¨ç‹¬ç«‹çš„æºè¯­è¨€è®¾ç½®ï¼ˆè§ä¸‹æ–¹ï¼‰";case"ai_vision":return"AIè§†è§‰OCR é€šè¿‡æç¤ºè¯æŒ‡å®šè¯†åˆ«è¯­è¨€";case"48px_ocr":return"48px OCR æ”¯æŒæ—¥ä¸­è‹±éŸ©ç­‰å¤šè¯­è¨€ï¼Œæºè¯­è¨€è®¾ç½®ä¸å½±å“è¯†åˆ«";default:return"é€‰æ‹©è¦è¯†åˆ«çš„åŸæ–‡è¯­è¨€"}}function z(B){p.setAiVisionOcrProvider(B),L.value=[],se()}function se(){$.value.apiKey=p.settings.aiVisionOcr.apiKey,$.value.modelName=p.settings.aiVisionOcr.modelName,$.value.customBaseUrl=p.settings.aiVisionOcr.customBaseUrl,$.value.prompt=p.settings.aiVisionOcr.prompt,$.value.rpmLimit=p.settings.aiVisionOcr.rpmLimit,$.value.minImageSize=p.settings.aiVisionOcr.minImageSize}function X(){const B=p.settings.aiVisionOcr.isJsonMode?gs:ps;p.updateAiVisionOcr({prompt:B}),$.value.prompt=B}async function ie(){const B=y.value.apiKey?.trim(),d=y.value.secretKey?.trim();if(!B||!d){k.warning("è¯·å¡«å†™ç™¾åº¦OCRçš„API Keyå’ŒSecret Key");return}q.value=!0,k.info("æ­£åœ¨æµ‹è¯•ç™¾åº¦OCRè¿æ¥...");try{const m=await Ke.testBaiduOcrConnection(B,d);m.success?k.success(m.message||"ç™¾åº¦OCRè¿æ¥æˆåŠŸ!"):k.error(m.message||m.error||"ç™¾åº¦OCRè¿æ¥å¤±è´¥")}catch(m){const l=m instanceof Error?m.message:"è¿æ¥æµ‹è¯•å¤±è´¥";k.error(l)}finally{q.value=!1}}async function U(){q.value=!0;try{const B=await Ke.testAiVisionOcrConnection({provider:p.settings.aiVisionOcr.provider,apiKey:$.value.apiKey,modelName:$.value.modelName,customBaseUrl:$.value.customBaseUrl,prompt:$.value.prompt});B.success?k.success("AIè§†è§‰OCRè¿æ¥æˆåŠŸ"):k.error(`AIè§†è§‰OCRè¿æ¥å¤±è´¥: ${B.error||"æœªçŸ¥é”™è¯¯"}`)}catch(B){const d=B instanceof Error?B.message:"è¿æ¥æµ‹è¯•å¤±è´¥";k.error(d)}finally{q.value=!1}}async function W(){const B=p.settings.aiVisionOcr.provider,d=$.value.apiKey?.trim(),m=$.value.customBaseUrl?.trim();if(!d){k.warning("è¯·å…ˆå¡«å†™ API Key");return}if(!["siliconflow","volcano","gemini","custom_openai_vision"].includes(B)){k.warning("å½“å‰æœåŠ¡å•†ä¸æ”¯æŒè‡ªåŠ¨è·å–æ¨¡å‹åˆ—è¡¨");return}if(B==="custom_openai_vision"&&!m){k.warning("è‡ªå®šä¹‰æœåŠ¡éœ€è¦å…ˆå¡«å†™ Base URL");return}V.value=!0;try{const f=await Ke.fetchModels(B,d,m);f.success&&f.models&&f.models.length>0?(L.value=f.models.map(P=>P.id),k.success(`è·å–åˆ° ${f.models.length} ä¸ªæ¨¡å‹`)):k.warning(f.message||"æœªè·å–åˆ°å¯ç”¨æ¨¡å‹")}catch(f){const P=f instanceof Error?f.message:"è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥";k.error(P)}finally{V.value=!1}}function te(B,d){p.updateAiVisionOcr({prompt:B}),$.value.prompt=B,k.success(`å·²åº”ç”¨æç¤ºè¯: ${d}`)}return(B,d)=>(M(),A("div",qr,[e("div",Hr,[d[21]||(d[21]=e("div",{class:"settings-group-title"},"OCRå¼•æ“é€‰æ‹©",-1)),e("div",jr,[d[19]||(d[19]=e("label",{for:"settingsOcrEngine"},"OCRå¼•æ“:",-1)),Ce(We,{"model-value":E.value.ocrEngine,options:t,onChange:d[0]||(d[0]=m=>{E.value.ocrEngine=m,g()})},null,8,["model-value"])]),ae(e("div",Jr,[d[20]||(d[20]=e("label",{for:"settingsSourceLanguage"},"æºè¯­è¨€:",-1)),Ce(We,{"model-value":E.value.sourceLanguage,groups:c,onChange:d[1]||(d[1]=m=>{E.value.sourceLanguage=m,x()})},null,8,["model-value"]),e("div",Yr,oe(K()),1)],512),[[Fe,E.value.ocrEngine==="paddle_ocr"]])]),ae(e("div",Xr,[d[24]||(d[24]=e("div",{class:"settings-group-title"},"PaddleOCR-VL è®¾ç½®",-1)),e("div",Gr,[d[22]||(d[22]=e("label",{for:"settingsPaddleOcrVlSourceLanguage"},"æºè¯­è¨€:",-1)),Ce(We,{"model-value":E.value.paddleOcrVl.sourceLanguage,options:r,onChange:d[2]||(d[2]=m=>_(m))},null,8,["model-value"]),d[23]||(d[23]=e("div",{class:"input-hint"}," é€‰æ‹©å›¾åƒä¸­çš„æºè¯­è¨€ï¼Œç”¨äºä¼˜åŒ– OCR è¯†åˆ«æ•ˆæœ ",-1))])],512),[[Fe,E.value.ocrEngine==="paddleocr_vl"]]),ae(e("div",Zr,[d[29]||(d[29]=e("div",{class:"settings-group-title"},"ç™¾åº¦OCR è®¾ç½®",-1)),e("div",Qr,[e("div",eu,[d[25]||(d[25]=e("label",{for:"settingsBaiduApiKey"},"API Key:",-1)),e("div",tu,[ae(e("input",{type:R.value?"text":"password",id:"settingsBaiduApiKey","onUpdate:modelValue":d[3]||(d[3]=m=>y.value.apiKey=m),class:"secure-input",placeholder:"è¯·è¾“å…¥ç™¾åº¦OCR API Key",autocomplete:"off"},null,8,ou),[[$t,y.value.apiKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:d[4]||(d[4]=m=>R.value=!R.value)},[R.value?(M(),A("span",su,"ğŸ‘â€ğŸ—¨")):(M(),A("span",nu,"ğŸ‘"))])])]),e("div",au,[d[26]||(d[26]=e("label",{for:"settingsBaiduSecretKey"},"Secret Key:",-1)),e("div",lu,[ae(e("input",{type:D.value?"text":"password",id:"settingsBaiduSecretKey","onUpdate:modelValue":d[5]||(d[5]=m=>y.value.secretKey=m),class:"secure-input",placeholder:"è¯·è¾“å…¥Secret Key",autocomplete:"off"},null,8,iu),[[$t,y.value.secretKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:d[6]||(d[6]=m=>D.value=!D.value)},[D.value?(M(),A("span",uu,"ğŸ‘â€ğŸ—¨")):(M(),A("span",ru,"ğŸ‘"))])])])]),e("div",cu,[e("div",du,[d[27]||(d[27]=e("label",{for:"settingsBaiduVersion"},"è¯†åˆ«ç‰ˆæœ¬:",-1)),Ce(We,{modelValue:y.value.version,"onUpdate:modelValue":d[7]||(d[7]=m=>y.value.version=m),options:s},null,8,["modelValue"])]),e("div",gu,[d[28]||(d[28]=e("label",{for:"settingsBaiduSourceLanguage"},"æºè¯­è¨€:",-1)),Ce(We,{modelValue:y.value.sourceLanguage,"onUpdate:modelValue":d[8]||(d[8]=m=>y.value.sourceLanguage=m),options:o},null,8,["modelValue"])])]),e("button",{class:"settings-test-btn",onClick:ie,disabled:q.value},oe(q.value?"æµ‹è¯•ä¸­...":"ğŸ”— æµ‹è¯•è¿æ¥"),9,pu)],512),[[Fe,E.value.ocrEngine==="baidu_ocr"]]),ae(e("div",mu,[d[41]||(d[41]=e("div",{class:"settings-group-title"},"AIè§†è§‰OCR è®¾ç½®",-1)),e("div",vu,[e("div",fu,[d[30]||(d[30]=e("label",{for:"settingsAiVisionProvider"},"æœåŠ¡å•†:",-1)),Ce(We,{"model-value":E.value.aiVisionOcr.provider,options:i,onChange:d[9]||(d[9]=m=>z(m))},null,8,["model-value"])]),e("div",bu,[d[31]||(d[31]=e("label",{for:"settingsAiVisionApiKey"},"API Key:",-1)),e("div",hu,[ae(e("input",{type:T.value?"text":"password",id:"settingsAiVisionApiKey","onUpdate:modelValue":d[10]||(d[10]=m=>$.value.apiKey=m),class:"secure-input",placeholder:"è¯·è¾“å…¥API Key",autocomplete:"off"},null,8,yu),[[$t,$.value.apiKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:d[11]||(d[11]=m=>T.value=!T.value)},[T.value?(M(),A("span",_u,"ğŸ‘â€ğŸ—¨")):(M(),A("span",xu,"ğŸ‘"))])])])]),ae(e("div",Cu,[d[32]||(d[32]=e("label",{for:"settingsCustomAiVisionBaseUrl"},"Base URL:",-1)),ae(e("input",{type:"text",id:"settingsCustomAiVisionBaseUrl","onUpdate:modelValue":d[12]||(d[12]=m=>$.value.customBaseUrl=m),placeholder:"ä¾‹å¦‚: https://api.example.com/v1"},null,512),[[we,$.value.customBaseUrl]])],512),[[Fe,E.value.aiVisionOcr.provider==="custom_openai_vision"]]),e("div",Su,[d[34]||(d[34]=e("label",{for:"settingsAiVisionModelName"},"æ¨¡å‹åç§°:",-1)),e("div",ku,[ae(e("input",{type:"text",id:"settingsAiVisionModelName","onUpdate:modelValue":d[13]||(d[13]=m=>$.value.modelName=m),placeholder:"å¦‚: silicon-llava2-34b"},null,512),[[we,$.value.modelName]]),e("button",{type:"button",class:"fetch-models-btn",title:"è·å–å¯ç”¨æ¨¡å‹åˆ—è¡¨",onClick:W,disabled:V.value},[d[33]||(d[33]=e("span",{class:"fetch-icon"},"ğŸ”",-1)),e("span",$u,oe(V.value?"è·å–ä¸­...":"è·å–æ¨¡å‹"),1)],8,wu)]),L.value.length>0?(M(),A("div",Tu,[Ce(We,{modelValue:$.value.modelName,"onUpdate:modelValue":d[14]||(d[14]=m=>$.value.modelName=m),options:v.value},null,8,["modelValue","options"]),e("span",Iu,"å…± "+oe(L.value.length)+" ä¸ªæ¨¡å‹",1)])):de("",!0)]),e("div",Pu,[d[36]||(d[36]=e("label",{for:"settingsAiVisionOcrPrompt"},"OCRæç¤ºè¯:",-1)),ae(e("textarea",{id:"settingsAiVisionOcrPrompt","onUpdate:modelValue":d[15]||(d[15]=m=>$.value.prompt=m),rows:"3",placeholder:"AIè§†è§‰OCRæç¤ºè¯"},null,512),[[we,$.value.prompt]]),Ce(Ut,{"prompt-type":"ai_vision_ocr",onSelect:te}),e("div",Ru,[Ce(We,{"model-value":E.value.aiVisionOcr.isJsonMode?"true":"false",options:a,onChange:d[16]||(d[16]=m=>{E.value.aiVisionOcr.isJsonMode=m==="true",X()})},null,8,["model-value"]),d[35]||(d[35]=e("span",{class:"input-hint"},"JSONæ ¼å¼è¾“å‡ºæ›´ç»“æ„åŒ–",-1))])]),e("div",Du,[d[37]||(d[37]=e("label",{for:"settingsRpmAiVisionOcr"},"RPMé™åˆ¶ (æ¯åˆ†é’Ÿè¯·æ±‚æ•°):",-1)),ae(e("input",{type:"number",id:"settingsRpmAiVisionOcr","onUpdate:modelValue":d[17]||(d[17]=m=>$.value.rpmLimit=m),min:"0",step:"1"},null,512),[[we,$.value.rpmLimit,void 0,{number:!0}]]),d[38]||(d[38]=e("div",{class:"input-hint"},"0 è¡¨ç¤ºæ— é™åˆ¶",-1))]),e("div",Mu,[d[39]||(d[39]=e("label",{for:"settingsMinImageSize"},"æœ€å°å›¾ç‰‡å°ºå¯¸ (åƒç´ ):",-1)),ae(e("input",{type:"number",id:"settingsMinImageSize","onUpdate:modelValue":d[18]||(d[18]=m=>$.value.minImageSize=m),min:"0",step:"1"},null,512),[[we,$.value.minImageSize,void 0,{number:!0}]]),d[40]||(d[40]=e("div",{class:"input-hint"},"VLMæ¨¡å‹é€šå¸¸è¦æ±‚å›¾ç‰‡å°ºå¯¸ â‰¥28pxï¼Œè®¾ä¸º0åˆ™ä¸è‡ªåŠ¨æ”¾å¤§å°å›¾",-1))]),e("button",{class:"settings-test-btn",onClick:U,disabled:q.value},oe(q.value?"æµ‹è¯•ä¸­...":"ğŸ”— æµ‹è¯•è¿æ¥"),9,Eu)],512),[[Fe,E.value.ocrEngine==="ai_vision"]])]))}}),Au=He(Bu,[["__scopeId","data-v-60d41103"]]),Lu={class:"translation-settings"},Fu={class:"settings-group"},Uu={class:"settings-row"},Ou={class:"settings-item"},zu={class:"settings-item"},Nu={for:"settingsApiKey"},Vu={class:"password-input-wrapper"},Wu=["type","placeholder"],Ku={key:0,class:"eye-icon"},qu={key:1,class:"eye-off-icon"},Hu={class:"settings-item"},ju={class:"settings-item"},Ju={for:"settingsModelName"},Yu={class:"model-input-with-fetch"},Xu=["placeholder"],Gu=["disabled"],Zu={class:"fetch-text"},Qu={key:0,class:"model-select-container"},ec={class:"model-count"},tc={class:"settings-item"},oc={class:"local-model-list"},nc={key:0,class:"model-list-container"},sc=["disabled"],ac={key:1,class:"model-hint"},lc={key:1,class:"model-list-container"},ic=["disabled"],rc={key:1,class:"model-hint"},uc={class:"settings-row"},cc={class:"settings-item"},dc={class:"settings-item"},gc={class:"settings-item"},pc=["disabled"],mc={class:"settings-item"},vc=["disabled"],fc={class:"settings-group"},bc={class:"settings-item"},hc={class:"prompt-format-selector"},yc={class:"settings-item"},xc={class:"checkbox-label"},_c={class:"settings-item"},Cc=je({__name:"TranslationSettings",setup(n){const t=[{label:"SiliconFlow",value:"siliconflow"},{label:"DeepSeek",value:"deepseek"},{label:"ç«å±±å¼•æ“",value:"volcano"},{label:"å½©äº‘å°è¯‘",value:"caiyun"},{label:"ç™¾åº¦ç¿»è¯‘",value:"baidu_translate"},{label:"æœ‰é“ç¿»è¯‘",value:"youdao_translate"},{label:"Google Gemini",value:"gemini"},{label:"Ollama (æœ¬åœ°)",value:"ollama"},{label:"Sakura (æœ¬åœ°)",value:"sakura"},{label:"è‡ªå®šä¹‰ OpenAI å…¼å®¹æœåŠ¡",value:"custom_openai"}],s=[{label:"æ™®é€šæç¤ºè¯",value:"normal"},{label:"JSONæç¤ºè¯",value:"json"}],o=ze(),i=ct(),r=C({modelProvider:o.settings.translation.provider,apiKey:o.settings.translation.apiKey,modelName:o.settings.translation.modelName,customBaseUrl:o.settings.translation.customBaseUrl,rpmTranslation:o.settings.translation.rpmLimit,translationMaxRetries:o.settings.translation.maxRetries,promptContent:o.settings.translatePrompt,translatePromptMode:o.settings.translation.isJsonMode?"json":"normal",enableTextboxPrompt:o.settings.useTextboxPrompt,textboxPromptContent:o.settings.textboxPrompt}),a=C(!1),c=C(!1),p=C(!1),k=C([]),y=C([]),$=C([]),E=Z(()=>{const m=[{label:"-- é€‰æ‹©æ¨¡å‹ --",value:""}];return k.value.forEach(l=>m.push({label:l,value:l})),m}),R=Z(()=>{const m=[{label:"-- é€‰æ‹©æ¨¡å‹ --",value:""}];return y.value.forEach(l=>m.push({label:l,value:l})),m}),D=Z(()=>{const m=[{label:"-- é€‰æ‹©æ¨¡å‹ --",value:""}];return $.value.forEach(l=>m.push({label:l,value:l})),m}),T=Z(()=>["ollama","sakura"].includes(r.value.modelProvider)),q=Z(()=>!["ollama","sakura","caiyun","baidu_translate","youdao_translate"].includes(r.value.modelProvider)),V=Z(()=>["siliconflow","deepseek","volcano","gemini","custom_openai"].includes(r.value.modelProvider)),L=Z(()=>{switch(r.value.modelProvider){case"baidu_translate":return"App ID";case"youdao_translate":return"App Key";case"caiyun":return"API Token";default:return"API Key"}}),v=Z(()=>{switch(r.value.modelProvider){case"baidu_translate":return"è¯·è¾“å…¥ç™¾åº¦ç¿»è¯‘App ID";case"youdao_translate":return"è¯·è¾“å…¥æœ‰é“ç¿»è¯‘åº”ç”¨ID";case"caiyun":return"è¯·è¾“å…¥å½©äº‘å°è¯‘Token";default:return"è¯·è¾“å…¥API Key"}}),g=Z(()=>{switch(r.value.modelProvider){case"baidu_translate":return"App Key";case"youdao_translate":return"App Secret";case"caiyun":return"æºè¯­è¨€ (å¯é€‰)";default:return"æ¨¡å‹åç§°"}}),x=Z(()=>{switch(r.value.modelProvider){case"baidu_translate":return"è¯·è¾“å…¥ç™¾åº¦ç¿»è¯‘App Key";case"youdao_translate":return"è¯·è¾“å…¥æœ‰é“ç¿»è¯‘åº”ç”¨å¯†é’¥";case"caiyun":return"å¯é€‰: auto/æ—¥è¯­/è‹±è¯­";default:return"è¯·è¾“å…¥æ¨¡å‹åç§°"}});function _(){const m=r.value.modelProvider;o.setTranslationProvider(m),r.value.apiKey=o.settings.translation.apiKey,r.value.modelName=o.settings.translation.modelName,r.value.customBaseUrl=o.settings.translation.customBaseUrl,r.value.rpmTranslation=o.settings.translation.rpmLimit,r.value.translationMaxRetries=o.settings.translation.maxRetries,k.value=[]}function K(){const m=r.value.translatePromptMode==="json";m?r.value.promptContent=Go:r.value.promptContent=Zo,o.updateTranslationService({isJsonMode:m}),o.setTranslatePrompt(r.value.promptContent)}Se(()=>r.value.apiKey,m=>{o.updateTranslationService({apiKey:m})}),Se(()=>r.value.modelName,m=>{o.updateTranslationService({modelName:m})}),Se(()=>r.value.customBaseUrl,m=>{o.updateTranslationService({customBaseUrl:m})}),Se(()=>r.value.rpmTranslation,m=>{o.updateTranslationService({rpmLimit:m})}),Se(()=>r.value.translationMaxRetries,m=>{o.updateTranslationService({maxRetries:m})}),Se(()=>r.value.promptContent,m=>{o.setTranslatePrompt(m)}),Se(()=>r.value.enableTextboxPrompt,m=>{o.setUseTextboxPrompt(m)}),Se(()=>r.value.textboxPromptContent,m=>{o.setTextboxPrompt(m)});async function z(){const m=r.value.modelProvider,l=r.value.apiKey?.trim(),f=r.value.customBaseUrl?.trim();if(!l){i.warning("è¯·å…ˆå¡«å†™ API Key");return}if(!["siliconflow","deepseek","volcano","gemini","custom_openai"].includes(m)){i.warning(`${se(m)} ä¸æ”¯æŒè‡ªåŠ¨è·å–æ¨¡å‹åˆ—è¡¨`);return}if(m==="custom_openai"&&!f){i.warning("è‡ªå®šä¹‰æœåŠ¡éœ€è¦å…ˆå¡«å†™ Base URL");return}p.value=!0;try{const S=await Ke.fetchModels(m,l,f);S.success&&S.models&&S.models.length>0?(k.value=S.models.map(w=>w.id),i.success(`è·å–åˆ° ${S.models.length} ä¸ªæ¨¡å‹`)):i.warning(S.message||"æœªè·å–åˆ°å¯ç”¨æ¨¡å‹")}catch(S){const w=S instanceof Error?S.message:"è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥";i.error(w)}finally{p.value=!1}}function se(m){return{siliconflow:"SiliconFlow",deepseek:"DeepSeek",volcano:"ç«å±±å¼•æ“",gemini:"Google Gemini",custom_openai:"è‡ªå®šä¹‰OpenAI",ollama:"Ollama",sakura:"Sakura",caiyun:"å½©äº‘å°è¯‘",baidu_translate:"ç™¾åº¦ç¿»è¯‘",youdao_translate:"æœ‰é“ç¿»è¯‘"}[m]||m}async function X(){p.value=!0;try{const m=await Ke.testOllamaConnection();m.success&&m.models?(y.value=m.models,i.success(`è·å–åˆ° ${m.models.length} ä¸ªOllamaæ¨¡å‹`)):i.error(m.error||"Ollamaè¿æ¥å¤±è´¥")}catch(m){const l=m instanceof Error?m.message:"è·å–Ollamaæ¨¡å‹å¤±è´¥";i.error(l)}finally{p.value=!1}}async function ie(){p.value=!0;try{const m=await Ke.testSakuraConnection();m.success&&m.models?($.value=m.models,i.success(`è·å–åˆ° ${m.models.length} ä¸ªSakuraæ¨¡å‹`)):i.error(m.error||"Sakuraè¿æ¥å¤±è´¥")}catch(m){const l=m instanceof Error?m.message:"è·å–Sakuraæ¨¡å‹å¤±è´¥";i.error(l)}finally{p.value=!1}}async function U(){c.value=!0;try{let m;r.value.modelProvider==="ollama"?m=await Ke.testOllamaConnection():m=await Ke.testSakuraConnection(),m.success?i.success(`${r.value.modelProvider==="ollama"?"Ollama":"Sakura"} è¿æ¥æˆåŠŸ`):i.error(m.error||"è¿æ¥å¤±è´¥")}catch(m){const l=m instanceof Error?m.message:"è¿æ¥æµ‹è¯•å¤±è´¥";i.error(l)}finally{c.value=!1}}async function W(){const m=r.value.modelProvider,l=r.value.apiKey?.trim(),f=r.value.modelName?.trim(),P=r.value.customBaseUrl?.trim();if(!l){i.warning("è¯·å…ˆå¡«å†™ API Key");return}if(m!=="caiyun"&&!f){i.warning("è¯·å¡«å†™æ¨¡å‹åç§°");return}if(m==="custom_openai"&&!P){i.warning("è‡ªå®šä¹‰æœåŠ¡éœ€è¦å¡«å†™ Base URL");return}c.value=!0,i.info("æ­£åœ¨æµ‹è¯•è¿æ¥...");try{let S;switch(m){case"baidu_translate":S=await Ke.testBaiduTranslateConnection(l,f);break;case"youdao_translate":S=await Ke.testYoudaoTranslateConnection(l,f);break;default:S=await Ke.testAiTranslateConnection({provider:m,apiKey:l,modelName:f,baseUrl:P})}S.success?i.success(S.message||`${se(m)} è¿æ¥æˆåŠŸ!`):i.error(S.message||S.error||"è¿æ¥å¤±è´¥")}catch(S){const w=S instanceof Error?S.message:"è¿æ¥æµ‹è¯•å¤±è´¥";i.error(w)}finally{c.value=!1}}function te(m,l){r.value.promptContent=m,i.success(`å·²åº”ç”¨æç¤ºè¯: ${l}`)}function B(m,l){r.value.textboxPromptContent=m,i.success(`å·²åº”ç”¨æç¤ºè¯: ${l}`)}function d(){r.value.translatePromptMode==="json"?r.value.promptContent=Go:r.value.promptContent=Zo,i.success("å·²é‡ç½®ä¸ºé»˜è®¤æç¤ºè¯")}return(m,l)=>(M(),A("div",Lu,[e("div",Fu,[l[21]||(l[21]=e("div",{class:"settings-group-title"},"ç¿»è¯‘æœåŠ¡é…ç½®",-1)),e("div",Uu,[e("div",Ou,[l[14]||(l[14]=e("label",{for:"settingsModelProvider"},"ç¿»è¯‘æœåŠ¡å•†:",-1)),Ce(We,{"model-value":r.value.modelProvider,options:t,onChange:l[0]||(l[0]=f=>{r.value.modelProvider=f,_()})},null,8,["model-value"])]),ae(e("div",zu,[e("label",Nu,oe(L.value)+":",1),e("div",Vu,[ae(e("input",{type:a.value?"text":"password",id:"settingsApiKey","onUpdate:modelValue":l[1]||(l[1]=f=>r.value.apiKey=f),class:"secure-input",placeholder:v.value,autocomplete:"off"},null,8,Wu),[[$t,r.value.apiKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:l[2]||(l[2]=f=>a.value=!a.value)},[a.value?(M(),A("span",qu,"ğŸ‘â€ğŸ—¨")):(M(),A("span",Ku,"ğŸ‘"))])])],512),[[Fe,!T.value]])]),ae(e("div",Hu,[l[15]||(l[15]=e("label",{for:"settingsCustomBaseUrl"},"Base URL:",-1)),ae(e("input",{type:"text",id:"settingsCustomBaseUrl","onUpdate:modelValue":l[3]||(l[3]=f=>r.value.customBaseUrl=f),placeholder:"ä¾‹å¦‚: https://api.example.com/v1"},null,512),[[we,r.value.customBaseUrl]])],512),[[Fe,r.value.modelProvider==="custom_openai"]]),ae(e("div",ju,[e("label",Ju,oe(g.value)+":",1),e("div",Yu,[ae(e("input",{type:"text",id:"settingsModelName","onUpdate:modelValue":l[4]||(l[4]=f=>r.value.modelName=f),placeholder:x.value},null,8,Xu),[[we,r.value.modelName]]),ae(e("button",{type:"button",class:"fetch-models-btn",title:"è·å–å¯ç”¨æ¨¡å‹åˆ—è¡¨",onClick:z,disabled:p.value},[l[16]||(l[16]=e("span",{class:"fetch-icon"},"ğŸ”",-1)),e("span",Zu,oe(p.value?"è·å–ä¸­...":"è·å–æ¨¡å‹"),1)],8,Gu),[[Fe,V.value]])]),k.value.length>0?(M(),A("div",Qu,[Ce(We,{"model-value":r.value.modelName,options:E.value,onChange:l[5]||(l[5]=f=>{r.value.modelName=f})},null,8,["model-value","options"]),e("span",ec,"å…± "+oe(k.value.length)+" ä¸ªæ¨¡å‹",1)])):de("",!0)],512),[[Fe,!T.value]]),ae(e("div",tc,[l[17]||(l[17]=e("label",null,"æœ¬åœ°æ¨¡å‹:",-1)),e("div",oc,[r.value.modelProvider==="ollama"?(M(),A("div",nc,[e("button",{class:"settings-test-btn",onClick:X,disabled:p.value},oe(p.value?"è·å–ä¸­...":"ğŸ”„ åˆ·æ–°æ¨¡å‹åˆ—è¡¨"),9,sc),y.value.length>0?(M(),ut(We,{key:0,"model-value":r.value.modelName,options:R.value,onChange:l[6]||(l[6]=f=>r.value.modelName=f)},null,8,["model-value","options"])):(M(),A("p",ac,"ç‚¹å‡»åˆ·æ–°è·å–å¯ç”¨æ¨¡å‹"))])):r.value.modelProvider==="sakura"?(M(),A("div",lc,[e("button",{class:"settings-test-btn",onClick:ie,disabled:p.value},oe(p.value?"è·å–ä¸­...":"ğŸ”„ åˆ·æ–°æ¨¡å‹åˆ—è¡¨"),9,ic),$.value.length>0?(M(),ut(We,{key:0,"model-value":r.value.modelName,options:D.value,onChange:l[7]||(l[7]=f=>r.value.modelName=f)},null,8,["model-value","options"])):(M(),A("p",rc,"ç‚¹å‡»åˆ·æ–°è·å–å¯ç”¨æ¨¡å‹"))])):de("",!0)])],512),[[Fe,T.value]]),ae(e("div",uc,[e("div",cc,[l[18]||(l[18]=e("label",{for:"settingsRpmTranslation"},"RPMé™åˆ¶:",-1)),ae(e("input",{type:"number",id:"settingsRpmTranslation","onUpdate:modelValue":l[8]||(l[8]=f=>r.value.rpmTranslation=f),min:"0",step:"1"},null,512),[[we,r.value.rpmTranslation,void 0,{number:!0}]]),l[19]||(l[19]=e("div",{class:"input-hint"},"æ¯åˆ†é’Ÿè¯·æ±‚æ•°ï¼Œ0è¡¨ç¤ºæ— é™åˆ¶",-1))]),e("div",dc,[l[20]||(l[20]=e("label",{for:"settingsTranslationMaxRetries"},"é‡è¯•æ¬¡æ•°:",-1)),ae(e("input",{type:"number",id:"settingsTranslationMaxRetries","onUpdate:modelValue":l[9]||(l[9]=f=>r.value.translationMaxRetries=f),min:"0",max:"10",step:"1"},null,512),[[we,r.value.translationMaxRetries,void 0,{number:!0}]])])],512),[[Fe,q.value]]),ae(e("div",gc,[e("button",{class:"settings-test-btn",onClick:U,disabled:c.value},oe(c.value?"æµ‹è¯•ä¸­...":"ğŸ”— æµ‹è¯•è¿æ¥"),9,pc)],512),[[Fe,T.value]]),ae(e("div",mc,[e("button",{class:"settings-test-btn",onClick:W,disabled:c.value},oe(c.value?"æµ‹è¯•ä¸­...":"ğŸ”— æµ‹è¯•è¿æ¥"),9,vc)],512),[[Fe,!T.value]])]),e("div",fc,[l[26]||(l[26]=e("div",{class:"settings-group-title"},"æç¤ºè¯è®¾ç½®",-1)),e("div",bc,[l[23]||(l[23]=e("label",{for:"settingsPromptContent"},"ç¿»è¯‘æç¤ºè¯:",-1)),ae(e("textarea",{id:"settingsPromptContent","onUpdate:modelValue":l[10]||(l[10]=f=>r.value.promptContent=f),rows:"4",placeholder:"ç¿»è¯‘æç¤ºè¯"},null,512),[[we,r.value.promptContent]]),e("div",hc,[Ce(We,{"model-value":r.value.translatePromptMode,options:s,onChange:l[11]||(l[11]=f=>{r.value.translatePromptMode=f,K()})},null,8,["model-value"]),l[22]||(l[22]=e("span",{class:"input-hint"},"JSONæ ¼å¼è¾“å‡ºæ›´ç»“æ„åŒ–",-1))]),Ce(Ut,{"prompt-type":"translate",onSelect:te}),e("button",{type:"button",class:"reset-btn",onClick:d}," é‡ç½®ä¸ºé»˜è®¤ ")]),e("div",yc,[e("label",xc,[ae(e("input",{type:"checkbox","onUpdate:modelValue":l[12]||(l[12]=f=>r.value.enableTextboxPrompt=f)},null,512),[[nt,r.value.enableTextboxPrompt]]),l[24]||(l[24]=me(" å¯ç”¨æ–‡æœ¬æ¡†æç¤ºè¯ ",-1))])]),ae(e("div",_c,[l[25]||(l[25]=e("label",{for:"settingsTextboxPromptContent"},"æ–‡æœ¬æ¡†æç¤ºè¯:",-1)),ae(e("textarea",{id:"settingsTextboxPromptContent","onUpdate:modelValue":l[13]||(l[13]=f=>r.value.textboxPromptContent=f),rows:"3",placeholder:"æ–‡æœ¬æ¡†æç¤ºè¯"},null,512),[[we,r.value.textboxPromptContent]]),Ce(Ut,{"prompt-type":"textbox",onSelect:B})],512),[[Fe,r.value.enableTextboxPrompt]])])]))}}),Sc=He(Cc,[["__scopeId","data-v-1eaa2d97"]]),kc={class:"detection-settings"},wc={class:"settings-group"},$c={class:"settings-item"},Tc={class:"settings-group"},Ic={class:"settings-item"},Pc={class:"settings-row"},Rc={class:"settings-item"},Dc={class:"settings-item"},Mc={class:"settings-row"},Ec={class:"settings-item"},Bc={class:"settings-item"},Ac={class:"settings-group"},Lc={class:"settings-item"},Fc={class:"checkbox-label"},Uc={class:"settings-row"},Oc={class:"settings-item"},zc={class:"settings-item"},Nc={class:"settings-group"},Vc={class:"settings-item"},Wc={class:"checkbox-label"},Kc=je({__name:"DetectionSettings",setup(n){const t=[{label:"CTD (Comic Text Detector)",value:"ctd"},{label:"YOLO",value:"yolo"},{label:"YOLOv5",value:"yolov5"},{label:"Default (DBNet)",value:"default"}],s=ze(),o=bo({textDetector:s.settings.textDetector,boxExpandRatio:s.settings.boxExpand.ratio,boxExpandTop:s.settings.boxExpand.top,boxExpandBottom:s.settings.boxExpand.bottom,boxExpandLeft:s.settings.boxExpand.left,boxExpandRight:s.settings.boxExpand.right,usePreciseMask:s.settings.preciseMask.enabled,maskDilateSize:s.settings.preciseMask.dilateSize,maskBoxExpandRatio:s.settings.preciseMask.boxExpandRatio,showDetectionDebug:s.settings.showDetectionDebug}),i=Z(()=>["ctd","default"].includes(o.textDetector));Se(()=>o.textDetector,a=>{s.setTextDetector(a)}),Se(()=>o.boxExpandRatio,a=>{s.updateBoxExpand({ratio:a})}),Se(()=>o.boxExpandTop,a=>{s.updateBoxExpand({top:a})}),Se(()=>o.boxExpandBottom,a=>{s.updateBoxExpand({bottom:a})}),Se(()=>o.boxExpandLeft,a=>{s.updateBoxExpand({left:a})}),Se(()=>o.boxExpandRight,a=>{s.updateBoxExpand({right:a})}),Se(()=>o.usePreciseMask,a=>{s.updatePreciseMask({enabled:a})}),Se(()=>o.maskDilateSize,a=>{s.updatePreciseMask({dilateSize:a})}),Se(()=>o.maskBoxExpandRatio,a=>{s.updatePreciseMask({boxExpandRatio:a})}),Se(()=>o.showDetectionDebug,a=>{s.setShowDetectionDebug(a)});function r(){i.value||(o.usePreciseMask=!1)}return(a,c)=>(M(),A("div",kc,[e("div",wc,[c[11]||(c[11]=e("div",{class:"settings-group-title"},"æ–‡å­—æ£€æµ‹å™¨",-1)),e("div",$c,[c[10]||(c[10]=e("label",{for:"settingsTextDetector"},"æ£€æµ‹å™¨ç±»å‹:",-1)),Ce(We,{modelValue:o.textDetector,"onUpdate:modelValue":c[0]||(c[0]=p=>o.textDetector=p),options:t,onChange:r},null,8,["modelValue"])])]),e("div",Tc,[c[18]||(c[18]=e("div",{class:"settings-group-title"},"æ–‡æœ¬æ¡†æ‰©å±•å‚æ•°",-1)),e("div",Ic,[c[12]||(c[12]=e("label",{for:"settingsBoxExpandRatio"},"æ•´ä½“æ‰©å±• (%):",-1)),ae(e("input",{type:"number",id:"settingsBoxExpandRatio","onUpdate:modelValue":c[1]||(c[1]=p=>o.boxExpandRatio=p),min:"0",max:"50",step:"1"},null,512),[[we,o.boxExpandRatio,void 0,{number:!0}]]),c[13]||(c[13]=e("div",{class:"input-hint"},"å‘å››å‘¨å‡åŒ€æ‰©å±•çš„ç™¾åˆ†æ¯” (0-50%)",-1))]),e("div",Pc,[e("div",Rc,[c[14]||(c[14]=e("label",{for:"settingsBoxExpandTop"},"ä¸Šæ–¹æ‰©å±• (%):",-1)),ae(e("input",{type:"number",id:"settingsBoxExpandTop","onUpdate:modelValue":c[2]||(c[2]=p=>o.boxExpandTop=p),min:"0",max:"50",step:"1"},null,512),[[we,o.boxExpandTop,void 0,{number:!0}]])]),e("div",Dc,[c[15]||(c[15]=e("label",{for:"settingsBoxExpandBottom"},"ä¸‹æ–¹æ‰©å±• (%):",-1)),ae(e("input",{type:"number",id:"settingsBoxExpandBottom","onUpdate:modelValue":c[3]||(c[3]=p=>o.boxExpandBottom=p),min:"0",max:"50",step:"1"},null,512),[[we,o.boxExpandBottom,void 0,{number:!0}]])])]),e("div",Mc,[e("div",Ec,[c[16]||(c[16]=e("label",{for:"settingsBoxExpandLeft"},"å·¦ä¾§æ‰©å±• (%):",-1)),ae(e("input",{type:"number",id:"settingsBoxExpandLeft","onUpdate:modelValue":c[4]||(c[4]=p=>o.boxExpandLeft=p),min:"0",max:"50",step:"1"},null,512),[[we,o.boxExpandLeft,void 0,{number:!0}]])]),e("div",Bc,[c[17]||(c[17]=e("label",{for:"settingsBoxExpandRight"},"å³ä¾§æ‰©å±• (%):",-1)),ae(e("input",{type:"number",id:"settingsBoxExpandRight","onUpdate:modelValue":c[5]||(c[5]=p=>o.boxExpandRight=p),min:"0",max:"50",step:"1"},null,512),[[we,o.boxExpandRight,void 0,{number:!0}]])])])]),ae(e("div",Ac,[c[25]||(c[25]=e("div",{class:"settings-group-title"},"ç²¾ç¡®æ–‡å­—æ©è†œ",-1)),e("div",Lc,[e("label",Fc,[ae(e("input",{type:"checkbox","onUpdate:modelValue":c[6]||(c[6]=p=>o.usePreciseMask=p)},null,512),[[nt,o.usePreciseMask]]),c[19]||(c[19]=me(" å¯ç”¨ç²¾ç¡®æ–‡å­—æ©è†œ ",-1))]),c[20]||(c[20]=e("div",{class:"input-hint"},"ä½¿ç”¨æ›´ç²¾ç¡®çš„æ–‡å­—åŒºåŸŸæ©è†œè¿›è¡Œä¿®å¤",-1))]),ae(e("div",Uc,[e("div",Oc,[c[21]||(c[21]=e("label",{for:"settingsMaskDilateSize"},"è†¨èƒ€å¤§å°:",-1)),ae(e("input",{type:"number",id:"settingsMaskDilateSize","onUpdate:modelValue":c[7]||(c[7]=p=>o.maskDilateSize=p),min:"0",step:"1"},null,512),[[we,o.maskDilateSize,void 0,{number:!0}]]),c[22]||(c[22]=e("div",{class:"input-hint"},"æ©è†œè†¨èƒ€åƒç´ æ•°",-1))]),e("div",zc,[c[23]||(c[23]=e("label",{for:"settingsMaskBoxExpandRatio"},"æ ‡æ³¨æ¡†æ‰©å¤§æ¯”ä¾‹ (%):",-1)),ae(e("input",{type:"number",id:"settingsMaskBoxExpandRatio","onUpdate:modelValue":c[8]||(c[8]=p=>o.maskBoxExpandRatio=p),min:"0",max:"100",step:"1"},null,512),[[we,o.maskBoxExpandRatio,void 0,{number:!0}]]),c[24]||(c[24]=e("div",{class:"input-hint"},"æ ‡æ³¨æ¡†åŒºåŸŸæ‰©å¤§ç™¾åˆ†æ¯”",-1))])],512),[[Fe,o.usePreciseMask]])],512),[[Fe,i.value]]),e("div",Nc,[c[28]||(c[28]=e("div",{class:"settings-group-title"},"è°ƒè¯•é€‰é¡¹",-1)),e("div",Vc,[e("label",Wc,[ae(e("input",{type:"checkbox","onUpdate:modelValue":c[9]||(c[9]=p=>o.showDetectionDebug=p)},null,512),[[nt,o.showDetectionDebug]]),c[26]||(c[26]=me(" æ˜¾ç¤ºæ£€æµ‹æ¡†è°ƒè¯•ä¿¡æ¯ ",-1))]),c[27]||(c[27]=e("div",{class:"input-hint"},"åœ¨ç¿»è¯‘ç»“æœä¸­æ˜¾ç¤ºæ°”æ³¡æ£€æµ‹æ¡†ï¼Œç”¨äºè°ƒè¯•",-1))])])]))}}),qc=He(Kc,[["__scopeId","data-v-c12c43ee"]]),Hc={class:"hq-translation-settings"},jc={class:"settings-group"},Jc={class:"settings-row"},Yc={class:"settings-item"},Xc={class:"settings-item"},Gc={class:"password-input-wrapper"},Zc=["type"],Qc={key:0,class:"eye-icon"},ed={key:1,class:"eye-off-icon"},td={class:"settings-item"},od={class:"settings-item"},nd={class:"model-input-with-fetch"},sd=["disabled"],ad={class:"fetch-text"},ld={key:0,class:"model-select-container"},id={class:"model-count"},rd={class:"settings-item"},ud=["disabled"],cd={class:"settings-group"},dd={class:"settings-row"},gd={class:"settings-item"},pd={class:"settings-item"},md={class:"settings-row"},vd={class:"settings-item"},fd={class:"settings-item"},bd={class:"settings-group"},hd={class:"settings-row"},yd={class:"settings-item"},xd={class:"checkbox-label"},_d={class:"settings-item"},Cd={class:"settings-row"},Sd={class:"settings-item"},kd={class:"checkbox-label"},wd={class:"settings-item"},$d={class:"checkbox-label"},Td={class:"settings-group"},Id={class:"settings-item"},Pd=je({__name:"HqTranslationSettings",setup(n){const t=[{label:"SiliconFlow",value:"siliconflow"},{label:"DeepSeek",value:"deepseek"},{label:"ç«å±±å¼•æ“",value:"volcano"},{label:"Google Gemini",value:"gemini"},{label:"è‡ªå®šä¹‰ OpenAI å…¼å®¹æœåŠ¡",value:"custom_openai"}],s=[{label:"Geminié£æ ¼ (reasoning_effort=low)",value:"gemini"},{label:"ç«å±±å¼•æ“é£æ ¼ (thinking=null)",value:"volcano"}],o=ze(),i=ct(),r=Z(()=>o.settings.hqTranslation),a=C({apiKey:o.settings.hqTranslation.apiKey,modelName:o.settings.hqTranslation.modelName,customBaseUrl:o.settings.hqTranslation.customBaseUrl,batchSize:o.settings.hqTranslation.batchSize,sessionReset:o.settings.hqTranslation.sessionReset,rpmLimit:o.settings.hqTranslation.rpmLimit,maxRetries:o.settings.hqTranslation.maxRetries,lowReasoning:o.settings.hqTranslation.lowReasoning,noThinkingMethod:o.settings.hqTranslation.noThinkingMethod,forceJsonOutput:o.settings.hqTranslation.forceJsonOutput,useStream:o.settings.hqTranslation.useStream,prompt:o.settings.hqTranslation.prompt});Se(()=>a.value.apiKey,v=>{o.updateHqTranslation({apiKey:v})}),Se(()=>a.value.modelName,v=>{o.updateHqTranslation({modelName:v})}),Se(()=>a.value.customBaseUrl,v=>{o.updateHqTranslation({customBaseUrl:v})}),Se(()=>a.value.batchSize,v=>{o.updateHqTranslation({batchSize:v})}),Se(()=>a.value.sessionReset,v=>{o.updateHqTranslation({sessionReset:v})}),Se(()=>a.value.rpmLimit,v=>{o.updateHqTranslation({rpmLimit:v})}),Se(()=>a.value.maxRetries,v=>{o.updateHqTranslation({maxRetries:v})}),Se(()=>a.value.lowReasoning,v=>{o.updateHqTranslation({lowReasoning:v})}),Se(()=>a.value.noThinkingMethod,v=>{o.updateHqTranslation({noThinkingMethod:v})}),Se(()=>a.value.forceJsonOutput,v=>{o.updateHqTranslation({forceJsonOutput:v})}),Se(()=>a.value.useStream,v=>{o.updateHqTranslation({useStream:v})}),Se(()=>a.value.prompt,v=>{o.updateHqTranslation({prompt:v})});const c=C(!1),p=C(!1),k=C([]),y=C(!1),$=Z(()=>{const v=[{label:"-- é€‰æ‹©æ¨¡å‹ --",value:""}];return k.value.forEach(g=>v.push({label:g,value:g})),v});function E(v){o.setHqProvider(v),k.value=[],R()}function R(){const v=o.settings.hqTranslation;a.value.apiKey=v.apiKey,a.value.modelName=v.modelName,a.value.customBaseUrl=v.customBaseUrl,a.value.batchSize=v.batchSize,a.value.sessionReset=v.sessionReset,a.value.rpmLimit=v.rpmLimit,a.value.maxRetries=v.maxRetries,a.value.lowReasoning=v.lowReasoning,a.value.noThinkingMethod=v.noThinkingMethod,a.value.forceJsonOutput=v.forceJsonOutput,a.value.useStream=v.useStream,a.value.prompt=v.prompt}function D(v){return{siliconflow:"SiliconFlow",deepseek:"DeepSeek",volcano:"ç«å±±å¼•æ“",gemini:"Google Gemini",custom_openai:"è‡ªå®šä¹‰OpenAI"}[v]||v}async function T(){const v=r.value.provider,g=a.value.apiKey?.trim(),x=a.value.customBaseUrl?.trim();if(!g){i.warning("è¯·å…ˆå¡«å†™ API Key");return}if(!["siliconflow","deepseek","volcano","gemini","custom_openai"].includes(v)){i.warning(`${D(v)} ä¸æ”¯æŒè‡ªåŠ¨è·å–æ¨¡å‹åˆ—è¡¨`);return}if(v==="custom_openai"&&!x){i.warning("è‡ªå®šä¹‰æœåŠ¡éœ€è¦å…ˆå¡«å†™ Base URL");return}p.value=!0;try{const K=await Ke.fetchModels(v,g,x);K.success&&K.models&&K.models.length>0?(k.value=K.models.map(z=>z.id),i.success(`è·å–åˆ° ${K.models.length} ä¸ªæ¨¡å‹`)):i.warning(K.message||"æœªè·å–åˆ°å¯ç”¨æ¨¡å‹")}catch(K){const z=K instanceof Error?K.message:"è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥";i.error(z)}finally{p.value=!1}}async function q(){const v=r.value.provider,g=a.value.apiKey?.trim(),x=a.value.modelName?.trim(),_=a.value.customBaseUrl?.trim();if(!g){i.warning("è¯·å…ˆå¡«å†™ API Key");return}if(!x){i.warning("è¯·å¡«å†™æ¨¡å‹åç§°");return}if(v==="custom_openai"&&!_){i.warning("è‡ªå®šä¹‰æœåŠ¡éœ€è¦å¡«å†™ Base URL");return}y.value=!0,i.info("æ­£åœ¨æµ‹è¯•è¿æ¥...");try{const K=await Ke.testAiTranslateConnection({provider:v,apiKey:g,modelName:x,baseUrl:_});K.success?i.success(K.message||`${D(v)} è¿æ¥æˆåŠŸ!`):i.error(K.message||K.error||"è¿æ¥å¤±è´¥")}catch(K){const z=K instanceof Error?K.message:"è¿æ¥æµ‹è¯•å¤±è´¥";i.error(z)}finally{y.value=!1}}function V(){o.updateHqTranslation({prompt:Qo}),a.value.prompt=Qo,i.success("å·²é‡ç½®ä¸ºé»˜è®¤æç¤ºè¯")}function L(v,g){o.updateHqTranslation({prompt:v}),a.value.prompt=v,i.success(`å·²åº”ç”¨æç¤ºè¯: ${g}`)}return(v,g)=>(M(),A("div",Hc,[e("div",jc,[g[20]||(g[20]=e("div",{class:"settings-group-title"},"é«˜è´¨é‡ç¿»è¯‘æœåŠ¡é…ç½®",-1)),e("div",Jc,[e("div",Yc,[g[15]||(g[15]=e("label",{for:"settingsHqTranslateProvider"},"æœåŠ¡å•†:",-1)),Ce(We,{"model-value":r.value.provider,options:t,onChange:g[0]||(g[0]=x=>E(x))},null,8,["model-value"])]),e("div",Xc,[g[16]||(g[16]=e("label",{for:"settingsHqApiKey"},"API Key:",-1)),e("div",Gc,[ae(e("input",{type:c.value?"text":"password",id:"settingsHqApiKey","onUpdate:modelValue":g[1]||(g[1]=x=>a.value.apiKey=x),class:"secure-input",placeholder:"è¯·è¾“å…¥API Key",autocomplete:"off"},null,8,Zc),[[$t,a.value.apiKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:g[2]||(g[2]=x=>c.value=!c.value)},[c.value?(M(),A("span",ed,"ğŸ‘â€ğŸ—¨")):(M(),A("span",Qc,"ğŸ‘"))])])])]),ae(e("div",td,[g[17]||(g[17]=e("label",{for:"settingsHqCustomBaseUrl"},"Base URL:",-1)),ae(e("input",{type:"text",id:"settingsHqCustomBaseUrl","onUpdate:modelValue":g[3]||(g[3]=x=>a.value.customBaseUrl=x),placeholder:"ä¾‹å¦‚: https://api.example.com/v1"},null,512),[[we,a.value.customBaseUrl]])],512),[[Fe,r.value.provider==="custom_openai"]]),e("div",od,[g[19]||(g[19]=e("label",{for:"settingsHqModelName"},"æ¨¡å‹åç§°:",-1)),e("div",nd,[ae(e("input",{type:"text",id:"settingsHqModelName","onUpdate:modelValue":g[4]||(g[4]=x=>a.value.modelName=x),placeholder:"è¯·è¾“å…¥æ¨¡å‹åç§°"},null,512),[[we,a.value.modelName]]),e("button",{type:"button",class:"fetch-models-btn",title:"è·å–å¯ç”¨æ¨¡å‹åˆ—è¡¨",onClick:T,disabled:p.value},[g[18]||(g[18]=e("span",{class:"fetch-icon"},"ğŸ”",-1)),e("span",ad,oe(p.value?"è·å–ä¸­...":"è·å–æ¨¡å‹"),1)],8,sd)]),k.value.length>0?(M(),A("div",ld,[Ce(We,{modelValue:a.value.modelName,"onUpdate:modelValue":g[5]||(g[5]=x=>a.value.modelName=x),options:$.value},null,8,["modelValue","options"]),e("span",id,"å…± "+oe(k.value.length)+" ä¸ªæ¨¡å‹",1)])):de("",!0)]),e("div",rd,[e("button",{class:"settings-test-btn",onClick:q,disabled:y.value},oe(y.value?"æµ‹è¯•ä¸­...":"ğŸ”— æµ‹è¯•è¿æ¥"),9,ud)])]),e("div",cd,[g[28]||(g[28]=e("div",{class:"settings-group-title"},"æ‰¹å¤„ç†è®¾ç½®",-1)),e("div",dd,[e("div",gd,[g[21]||(g[21]=e("label",{for:"settingsHqBatchSize"},"æ‰¹æ¬¡å¤§å°:",-1)),ae(e("input",{type:"number",id:"settingsHqBatchSize","onUpdate:modelValue":g[6]||(g[6]=x=>a.value.batchSize=x),min:"1",max:"10",step:"1"},null,512),[[we,a.value.batchSize,void 0,{number:!0}]]),g[22]||(g[22]=e("div",{class:"input-hint"},"æ¯æ‰¹å¤„ç†çš„å›¾ç‰‡æ•°é‡ (æ¨è3-5å¼ )",-1))]),e("div",pd,[g[23]||(g[23]=e("label",{for:"settingsHqSessionReset"},"ä¼šè¯é‡ç½®é¢‘ç‡:",-1)),ae(e("input",{type:"number",id:"settingsHqSessionReset","onUpdate:modelValue":g[7]||(g[7]=x=>a.value.sessionReset=x),min:"1",step:"1"},null,512),[[we,a.value.sessionReset,void 0,{number:!0}]]),g[24]||(g[24]=e("div",{class:"input-hint"},"å¤šå°‘æ‰¹æ¬¡åé‡ç½®ä¸Šä¸‹æ–‡",-1))])]),e("div",md,[e("div",vd,[g[25]||(g[25]=e("label",{for:"settingsHqRpmLimit"},"RPMé™åˆ¶:",-1)),ae(e("input",{type:"number",id:"settingsHqRpmLimit","onUpdate:modelValue":g[8]||(g[8]=x=>a.value.rpmLimit=x),min:"0",step:"1"},null,512),[[we,a.value.rpmLimit,void 0,{number:!0}]]),g[26]||(g[26]=e("div",{class:"input-hint"},"æ¯åˆ†é’Ÿè¯·æ±‚æ•°ï¼Œ0è¡¨ç¤ºæ— é™åˆ¶",-1))]),e("div",fd,[g[27]||(g[27]=e("label",{for:"settingsHqMaxRetries"},"é‡è¯•æ¬¡æ•°:",-1)),ae(e("input",{type:"number",id:"settingsHqMaxRetries","onUpdate:modelValue":g[9]||(g[9]=x=>a.value.maxRetries=x),min:"0",max:"10",step:"1"},null,512),[[we,a.value.maxRetries,void 0,{number:!0}]])])])]),e("div",bd,[g[36]||(g[36]=e("div",{class:"settings-group-title"},"é«˜çº§é€‰é¡¹",-1)),e("div",hd,[e("div",yd,[e("label",xd,[ae(e("input",{type:"checkbox","onUpdate:modelValue":g[10]||(g[10]=x=>a.value.lowReasoning=x)},null,512),[[nt,a.value.lowReasoning]]),g[29]||(g[29]=me(" ä½æ¨ç†æ¨¡å¼ ",-1))]),g[30]||(g[30]=e("div",{class:"input-hint"},"å‡å°‘æ¨¡å‹æ¨ç†æ·±åº¦ï¼Œæé«˜é€Ÿåº¦",-1))]),e("div",_d,[g[31]||(g[31]=e("label",{for:"settingsHqNoThinkingMethod"},"å–æ¶ˆæ€è€ƒæ–¹æ³•:",-1)),Ce(We,{modelValue:a.value.noThinkingMethod,"onUpdate:modelValue":g[11]||(g[11]=x=>a.value.noThinkingMethod=x),options:s},null,8,["modelValue"])])]),e("div",Cd,[e("div",Sd,[e("label",kd,[ae(e("input",{type:"checkbox","onUpdate:modelValue":g[12]||(g[12]=x=>a.value.forceJsonOutput=x)},null,512),[[nt,a.value.forceJsonOutput]]),g[32]||(g[32]=me(" å¼ºåˆ¶JSONè¾“å‡º ",-1))]),g[33]||(g[33]=e("div",{class:"input-hint"},"ä½¿ç”¨ response_format: json_object",-1))]),e("div",wd,[e("label",$d,[ae(e("input",{type:"checkbox","onUpdate:modelValue":g[13]||(g[13]=x=>a.value.useStream=x)},null,512),[[nt,a.value.useStream]]),g[34]||(g[34]=me(" æµå¼è°ƒç”¨ ",-1))]),g[35]||(g[35]=e("div",{class:"input-hint"},"ä½¿ç”¨æµå¼APIè°ƒç”¨",-1))])])]),e("div",Td,[g[37]||(g[37]=e("div",{class:"settings-group-title"},"é«˜è´¨é‡ç¿»è¯‘æç¤ºè¯",-1)),e("div",Id,[ae(e("textarea",{id:"settingsHqPrompt","onUpdate:modelValue":g[14]||(g[14]=x=>a.value.prompt=x),rows:"6",placeholder:"é«˜è´¨é‡ç¿»è¯‘æç¤ºè¯"},null,512),[[we,a.value.prompt]]),Ce(Ut,{"prompt-type":"hq_translate",onSelect:L}),e("button",{class:"btn btn-secondary btn-sm",onClick:V},"é‡ç½®ä¸ºé»˜è®¤")])])]))}}),Rd=He(Pd,[["__scopeId","data-v-23f4a3f7"]]),Dd={class:"proofreading-settings"},Md={class:"settings-group"},Ed={class:"settings-item"},Bd={class:"checkbox-label"},Ad={class:"settings-item"},Ld={class:"settings-group"},Fd={class:"round-header"},Ud={class:"round-title"},Od=["onClick","disabled"],zd={class:"round-content"},Nd={class:"settings-item"},Vd=["onUpdate:modelValue"],Wd={class:"settings-row"},Kd={class:"settings-item"},qd={class:"settings-item"},Hd={class:"password-input-wrapper"},jd=["type","onUpdate:modelValue"],Jd=["onClick"],Yd={key:0,class:"eye-icon"},Xd={key:1,class:"eye-off-icon"},Gd={class:"settings-item"},Zd=["onUpdate:modelValue"],Qd={class:"settings-item"},eg={class:"model-input-with-fetch"},tg=["onUpdate:modelValue"],og=["onClick","disabled"],ng={class:"fetch-text"},sg={key:0,class:"model-select-container"},ag={class:"model-count"},lg={class:"settings-item"},ig=["onClick","disabled"],rg={class:"settings-row"},ug={class:"settings-item"},cg=["onUpdate:modelValue"],dg={class:"settings-item"},gg=["onUpdate:modelValue"],pg={class:"settings-item"},mg=["onUpdate:modelValue"],vg={class:"settings-row"},fg={class:"settings-item"},bg={class:"checkbox-label"},hg=["onUpdate:modelValue"],yg={class:"settings-item"},xg={class:"settings-item"},_g={class:"checkbox-label"},Cg=["onUpdate:modelValue"],Sg={class:"settings-item"},kg=["onUpdate:modelValue"],wg=["onClick"],$g=je({__name:"ProofreadingSettings",setup(n){const t=[{label:"SiliconFlow",value:"siliconflow"},{label:"DeepSeek",value:"deepseek"},{label:"ç«å±±å¼•æ“",value:"volcano"},{label:"Google Gemini",value:"gemini"},{label:"è‡ªå®šä¹‰ OpenAI å…¼å®¹æœåŠ¡",value:"custom_openai"}],s=[{label:"Geminié£æ ¼",value:"gemini"},{label:"ç«å±±å¼•æ“é£æ ¼",value:"volcano"}],o=ze(),i=ct(),r=C({}),a=C({}),c=C({}),p=Z(()=>o.settings.proofreading.rounds),k=Z({get:()=>o.settings.proofreading.maxRetries,set:L=>o.setProofreadingMaxRetries(L)}),y=Z({get:()=>o.settings.proofreading.enabled,set:L=>o.setProofreadingEnabled(L)});Se(()=>o.settings.proofreading.rounds,()=>{o.saveToStorage()},{deep:!0});function $(L){const v=c.value[L]||[],g=[{label:"-- é€‰æ‹©æ¨¡å‹ --",value:""}];return v.forEach(x=>g.push({label:x,value:x})),g}async function E(L){const v=p.value[L];if(!v)return;const g=v.provider,x=v.apiKey?.trim(),_=v.customBaseUrl?.trim();if(!x){i.warning("è¯·å…ˆå¡«å†™ API Key");return}if(!["siliconflow","deepseek","volcano","gemini","custom_openai"].includes(g)){i.warning("å½“å‰æœåŠ¡å•†ä¸æ”¯æŒè·å–æ¨¡å‹åˆ—è¡¨");return}r.value[L]=!0;try{const z=await Ke.fetchModels(g,x,_);z.success&&z.models&&z.models.length>0?(c.value[L]=z.models.map(se=>se.id),i.success(`è½®æ¬¡ ${L+1}: è·å–åˆ° ${z.models.length} ä¸ªæ¨¡å‹`)):i.warning(z.message||"æœªè·å–åˆ°å¯ç”¨æ¨¡å‹")}catch(z){const se=z instanceof Error?z.message:"è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥";i.error(se)}finally{r.value[L]=!1}}async function R(L){const v=p.value[L];if(!v)return;const g=v.provider,x=v.apiKey?.trim(),_=v.modelName?.trim(),K=v.customBaseUrl?.trim();if(!x){i.warning("è¯·å…ˆå¡«å†™ API Key");return}if(!_){i.warning("è¯·å¡«å†™æ¨¡å‹åç§°");return}a.value[L]=!0,i.info(`æ­£åœ¨æµ‹è¯•è½®æ¬¡ ${L+1} çš„è¿æ¥...`);try{const z=await Ke.testAiTranslateConnection({provider:g,apiKey:x,modelName:_,baseUrl:K});z.success?i.success(z.message||"è¿æ¥æˆåŠŸ!"):i.error(z.message||z.error||"è¿æ¥å¤±è´¥")}catch(z){const se=z instanceof Error?z.message:"è¿æ¥æµ‹è¯•å¤±è´¥";i.error(se)}finally{a.value[L]=!1}}function D(){const L={name:`ç¬¬${p.value.length+1}è½®æ ¡å¯¹`,provider:"siliconflow",apiKey:"",modelName:"",customBaseUrl:"",batchSize:3,sessionReset:20,rpmLimit:7,lowReasoning:!1,noThinkingMethod:"gemini",forceJsonOutput:!0,prompt:en,showApiKey:!1};o.addProofreadingRound(L),i.success("å·²æ·»åŠ æ–°çš„æ ¡å¯¹è½®æ¬¡")}function T(L){if(p.value.length<=1){i.warning("è‡³å°‘éœ€è¦ä¿ç•™ä¸€ä¸ªæ ¡å¯¹è½®æ¬¡");return}o.removeProofreadingRound(L),i.success("å·²åˆ é™¤æ ¡å¯¹è½®æ¬¡")}function q(L){o.updateProofreadingRound(L,{prompt:en}),i.success("å·²é‡ç½®ä¸ºé»˜è®¤æç¤ºè¯")}function V(L,v,g){o.updateProofreadingRound(L,{prompt:v}),i.success(`å·²åº”ç”¨æç¤ºè¯: ${g}`)}return(L,v)=>(M(),A("div",Dd,[e("div",Md,[v[5]||(v[5]=e("div",{class:"settings-group-title"},"AIæ ¡å¯¹è®¾ç½®",-1)),e("div",Ed,[e("label",Bd,[ae(e("input",{type:"checkbox","onUpdate:modelValue":v[0]||(v[0]=g=>y.value=g)},null,512),[[nt,y.value]]),v[2]||(v[2]=me(" å¯ç”¨AIæ ¡å¯¹ ",-1))]),v[3]||(v[3]=e("div",{class:"input-hint"},"ç¿»è¯‘å®Œæˆåè‡ªåŠ¨è¿›è¡ŒAIæ ¡å¯¹",-1))]),e("div",Ad,[v[4]||(v[4]=e("label",{for:"settingsProofreadingMaxRetries"},"å…¨å±€é‡è¯•æ¬¡æ•°:",-1)),ae(e("input",{type:"number",id:"settingsProofreadingMaxRetries","onUpdate:modelValue":v[1]||(v[1]=g=>k.value=g),min:"0",max:"10",step:"1"},null,512),[[we,k.value,void 0,{number:!0}]])])]),ae(e("div",Ld,[e("div",{class:"settings-group-title"},[v[6]||(v[6]=me(" æ ¡å¯¹è½®æ¬¡é…ç½® ",-1)),e("button",{class:"btn btn-secondary btn-sm",onClick:D},"+ æ·»åŠ è½®æ¬¡")]),(M(!0),A(Oe,null,Ye(p.value,(g,x)=>(M(),A("div",{key:x,class:"proofreading-round"},[e("div",Fd,[e("span",Ud,"è½®æ¬¡ "+oe(x+1)+": "+oe(g.name||"æœªå‘½å"),1),e("button",{class:"btn btn-danger btn-sm",onClick:_=>T(x),disabled:p.value.length<=1}," åˆ é™¤ ",8,Od)]),e("div",zd,[e("div",Nd,[v[7]||(v[7]=e("label",null,"è½®æ¬¡åç§°:",-1)),ae(e("input",{type:"text","onUpdate:modelValue":_=>g.name=_,placeholder:"å¦‚: ç¬¬ä¸€è½®æ ¡å¯¹"},null,8,Vd),[[we,g.name]])]),e("div",Wd,[e("div",Kd,[v[8]||(v[8]=e("label",null,"æœåŠ¡å•†:",-1)),Ce(We,{modelValue:g.provider,"onUpdate:modelValue":_=>g.provider=_,options:t},null,8,["modelValue","onUpdate:modelValue"])]),e("div",qd,[v[9]||(v[9]=e("label",null,"API Key:",-1)),e("div",Hd,[ae(e("input",{type:g.showApiKey?"text":"password","onUpdate:modelValue":_=>g.apiKey=_,class:"secure-input",placeholder:"è¯·è¾“å…¥API Key",autocomplete:"off"},null,8,jd),[[$t,g.apiKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:_=>g.showApiKey=!g.showApiKey},[g.showApiKey?(M(),A("span",Xd,"ğŸ‘â€ğŸ—¨")):(M(),A("span",Yd,"ğŸ‘"))],8,Jd)])])]),ae(e("div",Gd,[v[10]||(v[10]=e("label",null,"Base URL:",-1)),ae(e("input",{type:"text","onUpdate:modelValue":_=>g.customBaseUrl=_,placeholder:"ä¾‹å¦‚: https://api.example.com/v1"},null,8,Zd),[[we,g.customBaseUrl]])],512),[[Fe,g.provider==="custom_openai"]]),e("div",Qd,[v[12]||(v[12]=e("label",null,"æ¨¡å‹åç§°:",-1)),e("div",eg,[ae(e("input",{type:"text","onUpdate:modelValue":_=>g.modelName=_,placeholder:"è¯·è¾“å…¥æ¨¡å‹åç§°"},null,8,tg),[[we,g.modelName]]),e("button",{type:"button",class:"fetch-models-btn",title:"è·å–å¯ç”¨æ¨¡å‹åˆ—è¡¨",onClick:_=>E(x),disabled:r.value[x]},[v[11]||(v[11]=e("span",{class:"fetch-icon"},"ğŸ”",-1)),e("span",ng,oe(r.value[x]?"è·å–ä¸­...":"è·å–æ¨¡å‹"),1)],8,og)]),c.value[x]&&c.value[x].length>0?(M(),A("div",sg,[Ce(We,{modelValue:g.modelName,"onUpdate:modelValue":_=>g.modelName=_,options:$(x)},null,8,["modelValue","onUpdate:modelValue","options"]),e("span",ag,"å…± "+oe(c.value[x].length)+" ä¸ªæ¨¡å‹",1)])):de("",!0)]),e("div",lg,[e("button",{class:"settings-test-btn",onClick:_=>R(x),disabled:a.value[x]},oe(a.value[x]?"æµ‹è¯•ä¸­...":"ğŸ”— æµ‹è¯•è¿æ¥"),9,ig)]),e("div",rg,[e("div",ug,[v[13]||(v[13]=e("label",null,"æ‰¹æ¬¡å¤§å°:",-1)),ae(e("input",{type:"number","onUpdate:modelValue":_=>g.batchSize=_,min:"1",max:"10",step:"1"},null,8,cg),[[we,g.batchSize,void 0,{number:!0}]])]),e("div",dg,[v[14]||(v[14]=e("label",null,"ä¼šè¯é‡ç½®é¢‘ç‡:",-1)),ae(e("input",{type:"number","onUpdate:modelValue":_=>g.sessionReset=_,min:"1",step:"1"},null,8,gg),[[we,g.sessionReset,void 0,{number:!0}]])]),e("div",pg,[v[15]||(v[15]=e("label",null,"RPMé™åˆ¶:",-1)),ae(e("input",{type:"number","onUpdate:modelValue":_=>g.rpmLimit=_,min:"0",step:"1"},null,8,mg),[[we,g.rpmLimit,void 0,{number:!0}]])])]),e("div",vg,[e("div",fg,[e("label",bg,[ae(e("input",{type:"checkbox","onUpdate:modelValue":_=>g.lowReasoning=_},null,8,hg),[[nt,g.lowReasoning]]),v[16]||(v[16]=me(" ä½æ¨ç†æ¨¡å¼ ",-1))])]),e("div",yg,[v[17]||(v[17]=e("label",null,"å–æ¶ˆæ€è€ƒæ–¹æ³•:",-1)),Ce(We,{modelValue:g.noThinkingMethod,"onUpdate:modelValue":_=>g.noThinkingMethod=_,options:s},null,8,["modelValue","onUpdate:modelValue"])]),e("div",xg,[e("label",_g,[ae(e("input",{type:"checkbox","onUpdate:modelValue":_=>g.forceJsonOutput=_},null,8,Cg),[[nt,g.forceJsonOutput]]),v[18]||(v[18]=me(" å¼ºåˆ¶JSONè¾“å‡º ",-1))])])]),e("div",Sg,[v[19]||(v[19]=e("label",null,"æ ¡å¯¹æç¤ºè¯:",-1)),ae(e("textarea",{"onUpdate:modelValue":_=>g.prompt=_,rows:"4",placeholder:"æ ¡å¯¹æç¤ºè¯"},null,8,kg),[[we,g.prompt]]),Ce(Ut,{"prompt-type":"proofreading",onSelect:(_,K)=>V(x,_,K)},null,8,["onSelect"]),e("button",{class:"btn btn-secondary btn-sm",onClick:_=>q(x)},"é‡ç½®ä¸ºé»˜è®¤",8,wg)])])]))),128))],512),[[Fe,y.value]])]))}}),Tg=He($g,[["__scopeId","data-v-663a7972"]]),Ig={class:"prompt-library"},Pg={class:"settings-group"},Rg={class:"settings-item"},Dg={key:0,class:"settings-item"},Mg={class:"mode-hint"},Eg={class:"settings-group"},Bg={key:0,class:"loading-hint"},Ag={key:1,class:"empty-hint"},Lg={key:2,class:"prompt-list"},Fg=["onClick"],Ug={class:"prompt-name"},Og={class:"prompt-actions"},zg=["onClick"],Ng=["onClick","disabled"],Vg={class:"settings-group"},Wg={class:"settings-item"},Kg={class:"settings-item"},qg={class:"prompt-editor-actions"},Hg=["disabled"],jg=je({__name:"PromptLibrary",setup(n){const t=[{label:"ç¿»è¯‘æç¤ºè¯",value:"translate"},{label:"æ–‡æœ¬æ¡†æç¤ºè¯",value:"textbox"},{label:"AIè§†è§‰OCRæç¤ºè¯",value:"ai_vision_ocr"},{label:"é«˜è´¨é‡ç¿»è¯‘æç¤ºè¯",value:"hq_translate"},{label:"æ ¡å¯¹æç¤ºè¯",value:"proofreading"}],s=[{label:"æ™®é€šæ¨¡å¼",value:"false"},{label:"JSONæ ¼å¼æ¨¡å¼",value:"true"}],o=ct(),i=ze(),r=C("translate"),a=C([]),c=C(""),p=C(""),k=C(""),y=C(!1),$=C(!1),E=Z(()=>r.value==="translate"||r.value==="ai_vision_ocr"),R=Z(()=>$.value?"é€‚ç”¨äºéœ€è¦ç»“æ„åŒ–è¾“å‡ºçš„åœºæ™¯":"é€‚ç”¨äºæ™®é€šç¿»è¯‘åœºæ™¯");async function D(){y.value=!0;try{let x;r.value==="textbox"?x=await Ke.getTextboxPrompts():x=await Ke.getPrompts(r.value);const _=x.prompt_names||[];a.value=_.map(K=>({name:K}))}catch(x){const _=x instanceof Error?x.message:"åŠ è½½æç¤ºè¯åˆ—è¡¨å¤±è´¥";o.error(_)}finally{y.value=!1}}async function T(x){c.value=x,p.value=x,await q(x)}async function q(x){try{let _;r.value==="textbox"?_=await Ke.getTextboxPromptContent(x):_=await Ke.getPromptContent(r.value,x),p.value=x,k.value=_.prompt_content||"",c.value=x,o.success("å·²åŠ è½½æç¤ºè¯")}catch(_){const K=_ instanceof Error?_.message:"åŠ è½½æç¤ºè¯å†…å®¹å¤±è´¥";o.error(K)}}async function V(){if(!p.value||!k.value){o.warning("è¯·è¾“å…¥æç¤ºè¯åç§°å’Œå†…å®¹");return}try{r.value==="textbox"?await Ke.saveTextboxPrompt(p.value,k.value):await Ke.savePrompt(r.value,p.value,k.value),o.success("æç¤ºè¯ä¿å­˜æˆåŠŸ"),p.value="",k.value="",await D()}catch(x){const _=x instanceof Error?x.message:"ä¿å­˜æç¤ºè¯å¤±è´¥";o.error(_)}}async function L(x){if(x==="default"){o.warning("é»˜è®¤æç¤ºè¯ä¸èƒ½åˆ é™¤");return}try{r.value==="textbox"?await Ke.deleteTextboxPrompt(x):await Ke.deletePrompt(r.value,x),o.success("æç¤ºè¯åˆ é™¤æˆåŠŸ"),c.value===x&&(c.value="",p.value="",k.value=""),await D()}catch(_){const K=_ instanceof Error?_.message:"åˆ é™¤æç¤ºè¯å¤±è´¥";o.error(K)}}function v(){c.value="",p.value="",k.value="",r.value==="translate"?$.value=i.settings.translation.isJsonMode:r.value==="ai_vision_ocr"?$.value=i.settings.aiVisionOcr.isJsonMode:$.value=!1,D()}function g(){r.value==="translate"?i.updateTranslationService({isJsonMode:$.value}):r.value==="ai_vision_ocr"&&i.updateAiVisionOcr({isJsonMode:$.value}),o.info(`å·²åˆ‡æ¢åˆ°${$.value?"JSONæ ¼å¼":"æ™®é€š"}æ¨¡å¼`)}return dt(()=>{$.value=i.settings.translation.isJsonMode,D()}),(x,_)=>(M(),A("div",Ig,[e("div",Pg,[_[6]||(_[6]=e("div",{class:"settings-group-title"},"æç¤ºè¯ç®¡ç†",-1)),e("div",Rg,[_[4]||(_[4]=e("label",{for:"promptType"},"æç¤ºè¯ç±»å‹:",-1)),Ce(We,{modelValue:r.value,"onUpdate:modelValue":_[0]||(_[0]=K=>r.value=K),options:t,onChange:v},null,8,["modelValue"])]),E.value?(M(),A("div",Dg,[_[5]||(_[5]=e("label",{for:"promptMode"},"æç¤ºè¯æ¨¡å¼:",-1)),Ce(We,{"model-value":$.value?"true":"false",options:s,onChange:_[1]||(_[1]=K=>{$.value=K==="true",g()})},null,8,["model-value"]),e("span",Mg,oe(R.value),1)])):de("",!0)]),e("div",Eg,[_[7]||(_[7]=e("div",{class:"settings-group-title"},"å·²ä¿å­˜çš„æç¤ºè¯",-1)),y.value?(M(),A("div",Bg,"åŠ è½½ä¸­...")):a.value.length===0?(M(),A("div",Ag,"æš‚æ— ä¿å­˜çš„æç¤ºè¯")):(M(),A("div",Lg,[(M(!0),A(Oe,null,Ye(a.value,K=>(M(),A("div",{key:K.name,class:Ie(["prompt-item",{active:c.value===K.name}]),onClick:z=>T(K.name)},[e("span",Ug,oe(K.name),1),e("div",Og,[e("button",{class:"btn btn-sm",onClick:lt(z=>q(K.name),["stop"]),title:"åŠ è½½åˆ°ç¼–è¾‘å™¨"},"ğŸ“¥",8,zg),e("button",{class:"btn btn-sm btn-danger",onClick:lt(z=>L(K.name),["stop"]),title:"åˆ é™¤",disabled:K.name==="default"}," ğŸ—‘ï¸ ",8,Ng)])],10,Fg))),128))]))]),e("div",Vg,[_[10]||(_[10]=e("div",{class:"settings-group-title"},"æç¤ºè¯ç¼–è¾‘",-1)),e("div",Wg,[_[8]||(_[8]=e("label",{for:"promptName"},"æç¤ºè¯åç§°:",-1)),ae(e("input",{type:"text",id:"promptName","onUpdate:modelValue":_[2]||(_[2]=K=>p.value=K),placeholder:"è¯·è¾“å…¥æç¤ºè¯åç§°"},null,512),[[we,p.value]])]),e("div",Kg,[_[9]||(_[9]=e("label",{for:"promptContent"},"æç¤ºè¯å†…å®¹:",-1)),ae(e("textarea",{id:"promptContent","onUpdate:modelValue":_[3]||(_[3]=K=>k.value=K),rows:"8",placeholder:"è¯·è¾“å…¥æç¤ºè¯å†…å®¹"},null,512),[[we,k.value]])]),e("div",qg,[e("button",{class:"btn btn-primary",onClick:V,disabled:!p.value||!k.value},"ä¿å­˜æç¤ºè¯",8,Hg)])])]))}}),Jg=He(jg,[["__scopeId","data-v-70f0ec19"]]),Yg={class:"plugin-manager"},Xg={class:"settings-group"},Gg={key:0,class:"loading-hint"},Zg={key:1,class:"empty-hint"},Qg={key:2,class:"plugin-list"},ep={class:"plugin-info"},tp={class:"plugin-header"},op={class:"plugin-name"},np={class:"plugin-version"},sp={class:"plugin-description"},ap={class:"plugin-controls"},lp={class:"switch"},ip=["checked","onChange"],rp=["onClick"],up=["onClick"],cp={class:"settings-group"},dp={class:"plugin-name"},gp={class:"switch"},pp=["checked","onChange"],mp={class:"plugin-config-content"},vp={class:"plugin-config-header"},fp={class:"plugin-config-body"},bp=["for"],hp=["id","onUpdate:modelValue"],yp=["id","onUpdate:modelValue","min","max"],xp=["id","onUpdate:modelValue","placeholder"],_p={key:4,class:"field-description"},Cp=je({__name:"PluginManager",setup(n){const t=ct(),s=C([]),o=C({}),i=C(!1),r=C(!1),a=C(null),c=C({}),p=C({});async function k(){i.value=!0;try{const V=await Os();s.value=V.plugins||[]}catch(V){const L=V instanceof Error?V.message:"åŠ è½½æ’ä»¶åˆ—è¡¨å¤±è´¥";t.error(L)}finally{i.value=!1}}async function y(){try{const V=await Js();o.value=V.states||{}}catch(V){console.error("åŠ è½½é»˜è®¤çŠ¶æ€å¤±è´¥:",V)}}async function $(V){try{V.enabled?(await Ns(V.name),V.enabled=!1,t.success(`å·²ç¦ç”¨ ${V.display_name||V.name}`)):(await zs(V.name),V.enabled=!0,t.success(`å·²å¯ç”¨ ${V.display_name||V.name}`))}catch(L){const v=L instanceof Error?L.message:"æ“ä½œå¤±è´¥";t.error(v)}}async function E(V,L){const v=L.target,g=v.checked;try{await Ys(V,g),o.value[V]=g,t.success("é»˜è®¤çŠ¶æ€å·²æ›´æ–°")}catch(x){const _=x instanceof Error?x.message:"è®¾ç½®å¤±è´¥";t.error(_),v.checked=!g}}async function R(V){a.value=V;try{const L=await Xs(V.name);c.value=L.schema||{};const v=await Gs(V.name);p.value=v.config||{},r.value=!0}catch(L){const v=L instanceof Error?L.message:"åŠ è½½é…ç½®å¤±è´¥";t.error(v)}}function D(){r.value=!1,a.value=null,c.value={},p.value={}}async function T(){if(a.value)try{await Zs(a.value.name,p.value),t.success("é…ç½®ä¿å­˜æˆåŠŸ"),D()}catch(V){const L=V instanceof Error?V.message:"ä¿å­˜é…ç½®å¤±è´¥";t.error(L)}}async function q(V){if(confirm(`ç¡®å®šè¦åˆ é™¤æ’ä»¶ "${V.display_name||V.name}" å—ï¼Ÿ`))try{await Vs(V.name),t.success("æ’ä»¶åˆ é™¤æˆåŠŸ"),await k()}catch(L){const v=L instanceof Error?L.message:"åˆ é™¤æ’ä»¶å¤±è´¥";t.error(v)}}return dt(()=>{k(),y()}),(V,L)=>(M(),A("div",Yg,[e("div",Xg,[L[1]||(L[1]=e("div",{class:"settings-group-title"},"å·²å®‰è£…æ’ä»¶",-1)),i.value?(M(),A("div",Gg,"åŠ è½½ä¸­...")):s.value.length===0?(M(),A("div",Zg,"æš‚æ— å·²å®‰è£…çš„æ’ä»¶")):(M(),A("div",Qg,[(M(!0),A(Oe,null,Ye(s.value,v=>(M(),A("div",{key:v.name,class:"plugin-item"},[e("div",ep,[e("div",tp,[e("span",op,oe(v.display_name||v.name),1),e("span",np,"v"+oe(v.version||"1.0.0"),1)]),e("p",sp,oe(v.description||"æš‚æ— æè¿°"),1)]),e("div",ap,[e("label",lp,[e("input",{type:"checkbox",checked:v.enabled,onChange:g=>$(v)},null,40,ip),L[0]||(L[0]=e("span",{class:"slider"},null,-1))]),v.has_config?(M(),A("button",{key:0,class:"btn btn-sm",onClick:g=>R(v),title:"é…ç½®"},"âš™ï¸",8,rp)):de("",!0),e("button",{class:"btn btn-sm btn-danger",onClick:g=>q(v),title:"åˆ é™¤"},"ğŸ—‘ï¸",8,up)])]))),128))]))]),e("div",cp,[L[3]||(L[3]=e("div",{class:"settings-group-title"},"é»˜è®¤å¯ç”¨çŠ¶æ€",-1)),L[4]||(L[4]=e("p",{class:"settings-hint"},"è®¾ç½®æ’ä»¶åœ¨æ–°ä¼šè¯ä¸­çš„é»˜è®¤å¯ç”¨çŠ¶æ€",-1)),(M(!0),A(Oe,null,Ye(s.value,v=>(M(),A("div",{key:"default-"+v.name,class:"default-state-item"},[e("span",dp,oe(v.display_name||v.name),1),e("label",gp,[e("input",{type:"checkbox",checked:o.value[v.name],onChange:g=>E(v.name,g)},null,40,pp),L[2]||(L[2]=e("span",{class:"slider"},null,-1))])]))),128))]),r.value?(M(),A("div",{key:0,class:"plugin-config-modal",onClick:lt(D,["self"])},[e("div",mp,[e("div",vp,[e("h4",null,oe(a.value?.display_name||a.value?.name)+" é…ç½®",1),e("span",{class:"close-btn",onClick:D},"Ã—")]),e("div",fp,[(M(!0),A(Oe,null,Ye(c.value,(v,g)=>(M(),A("div",{key:g,class:"config-field"},[e("label",{for:"config-"+g},oe(v.label||g)+":",9,bp),v.type==="boolean"?ae((M(),A("input",{key:0,type:"checkbox",id:"config-"+g,"onUpdate:modelValue":x=>p.value[g]=x},null,8,hp)),[[nt,p.value[g]]]):v.type==="select"?(M(),ut(We,{key:1,"model-value":String(p.value[g]??""),options:v.options||[],onChange:x=>{p.value[g]=x}},null,8,["model-value","options","onChange"])):v.type==="number"?ae((M(),A("input",{key:2,type:"number",id:"config-"+g,"onUpdate:modelValue":x=>p.value[g]=x,min:v.min,max:v.max},null,8,yp)),[[we,p.value[g],void 0,{number:!0}]]):ae((M(),A("input",{key:3,type:"text",id:"config-"+g,"onUpdate:modelValue":x=>p.value[g]=x,placeholder:v.placeholder},null,8,xp)),[[we,p.value[g]]]),v.description?(M(),A("p",_p,oe(v.description),1)):de("",!0)]))),128))]),e("div",{class:"plugin-config-footer"},[e("button",{class:"btn btn-secondary",onClick:D},"å–æ¶ˆ"),e("button",{class:"btn btn-primary",onClick:T},"ä¿å­˜")])])])):de("",!0)]))}}),Sp=He(Cp,[["__scopeId","data-v-a62393a7"]]),kp={class:"parallel-settings"},wp={class:"settings-group"},$p={class:"settings-item"},Tp={class:"toggle-switch"},Ip={class:"number-control"},Pp=["disabled"],Rp=["disabled"],Dp=["disabled"],Mp={key:0,class:"settings-note"},Ep=je({__name:"ParallelSettings",setup(n){const t=ze(),s=Z({get:()=>t.settings.parallel.enabled,set:i=>{t.updateSettings({parallel:{...t.settings.parallel,enabled:i}})}}),o=Z({get:()=>t.settings.parallel.deepLearningLockSize,set:i=>{t.updateSettings({parallel:{...t.settings.parallel,deepLearningLockSize:Math.max(1,Math.min(4,i))}})}});return(i,r)=>(M(),A("div",kp,[e("div",wp,[r[10]||(r[10]=e("div",{class:"settings-group-title"},"ğŸš€ å¹¶è¡Œç¿»è¯‘",-1)),e("div",$p,[r[5]||(r[5]=e("label",null,"å¯ç”¨å¹¶è¡Œæ¨¡å¼:",-1)),e("label",Tp,[ae(e("input",{type:"checkbox","onUpdate:modelValue":r[0]||(r[0]=a=>s.value=a)},null,512),[[nt,s.value]]),r[4]||(r[4]=e("span",{class:"toggle-slider"},null,-1))]),r[6]||(r[6]=e("div",{class:"input-hint"},"ä½¿ç”¨æµæ°´çº¿å¹¶è¡Œå¤„ç†ï¼Œå¯èƒ½æå‡æ‰¹é‡ç¿»è¯‘é€Ÿåº¦",-1))]),e("div",{class:Ie(["settings-item",{"item-disabled":!s.value}])},[r[7]||(r[7]=e("label",null,"æ·±åº¦å­¦ä¹ å¹¶å‘æ•°:",-1)),e("div",Ip,[e("button",{class:"btn btn-sm",onClick:r[1]||(r[1]=a=>o.value=Math.max(1,o.value-1)),disabled:!s.value},"-",8,Pp),ae(e("input",{type:"number","onUpdate:modelValue":r[2]||(r[2]=a=>o.value=a),min:"1",max:"4",disabled:!s.value,class:"number-input"},null,8,Rp),[[we,o.value,void 0,{number:!0}]]),e("button",{class:"btn btn-sm",onClick:r[3]||(r[3]=a=>o.value=Math.min(4,o.value+1)),disabled:!s.value},"+",8,Dp)]),r[8]||(r[8]=e("div",{class:"input-hint"},"æ§åˆ¶æ£€æµ‹/OCR/é¢œè‰²/ä¿®å¤çš„æœ€å¤§å¹¶å‘æ•°ï¼ˆå»ºè®®1-2ï¼‰",-1))],2),s.value?(M(),A("div",Mp,[...r[9]||(r[9]=[e("div",{class:"note-title"},"âš ï¸ æ³¨æ„äº‹é¡¹ï¼š",-1),e("ul",null,[e("li",null,"å¹¶å‘æ•°è®¾ä¸º1æ—¶ä¸ºä¸²è¡Œæ‰§è¡Œï¼Œæœ€ç¨³å®š"),e("li",null,"å¢å¤§å¹¶å‘æ•°å¯èƒ½åŠ é€Ÿå¤„ç†ï¼Œä½†ä¼šå ç”¨æ›´å¤šGPU/CPUèµ„æº"),e("li",null,"å¦‚æœé‡åˆ°æ˜¾å­˜ä¸è¶³ï¼Œè¯·å°†å¹¶å‘æ•°è®¾ä¸º1")],-1)])])):de("",!0)])]))}}),Bp=He(Ep,[["__scopeId","data-v-4a6e42d5"]]),Ap={class:"more-settings"},Lp={class:"settings-group"},Fp={class:"settings-item checkbox-item"},Up={class:"checkbox-label"},Op={class:"settings-group"},zp={class:"settings-item"},Np={class:"settings-group"},Vp={class:"settings-item"},Wp=["disabled"],Kp={key:0,class:"font-count"},qp={class:"settings-item"},Hp={class:"settings-group"},jp={class:"settings-row"},Jp={class:"settings-item"},Yp=["disabled"],Xp={class:"settings-item"},Gp=["disabled"],Zp=je({__name:"MoreSettings",setup(n){const t=[{label:"å‰ç«¯ pdf.js (æ¨è)",value:"frontend"},{label:"åç«¯ PyMuPDF",value:"backend"}],s=ze(),o=ct(),i=C(!1),r=C([]),a=C(!1),c=C(null),p=C({pdfProcessingMethod:s.settings.pdfProcessingMethod||"frontend",autoSaveInBookshelfMode:s.settings.autoSaveInBookshelfMode||!1});Se(()=>p.value.pdfProcessingMethod,R=>{s.setPdfProcessingMethod(R)}),Se(()=>p.value.autoSaveInBookshelfMode,R=>{s.setAutoSaveInBookshelfMode(R)});async function k(){i.value=!0;try{const R=await Ke.getFontList();r.value=R.fonts||[],o.success(`è·å–åˆ° ${r.value.length} ä¸ªå­—ä½“`)}catch(R){const D=R instanceof Error?R.message:"è·å–å­—ä½“åˆ—è¡¨å¤±è´¥";o.error(D)}finally{i.value=!1}}async function y(R){const T=R.target.files?.[0];if(!T)return;const q=[".ttf",".ttc",".otf"],V=T.name.toLowerCase().slice(T.name.lastIndexOf("."));if(!q.includes(V)){o.error("ä¸æ”¯æŒçš„å­—ä½“æ ¼å¼ï¼Œè¯·ä¸Šä¼  .ttf, .ttc æˆ– .otf æ–‡ä»¶");return}try{const L=await Ke.uploadFont(T);L.success?(o.success(`å­—ä½“ "${L.fontPath||T.name}" ä¸Šä¼ æˆåŠŸ`),await k()):o.error(L.error||"å­—ä½“ä¸Šä¼ å¤±è´¥")}catch(L){const v=L instanceof Error?L.message:"å­—ä½“ä¸Šä¼ å¤±è´¥";o.error(v)}finally{c.value&&(c.value.value="")}}async function $(){a.value=!0;try{const R=await wn();R.success?o.success(`å·²æ¸…ç† ${R.deleted_count||0} ä¸ªè°ƒè¯•æ–‡ä»¶`):o.error(R.error||"æ¸…ç†å¤±è´¥")}catch(R){const D=R instanceof Error?R.message:"æ¸…ç†å¤±è´¥";o.error(D)}finally{a.value=!1}}async function E(){a.value=!0;try{const R=await ho();R.success?o.success(`å·²æ¸…ç† ${R.deleted_count||0} ä¸ªä¸´æ—¶æ–‡ä»¶`):o.error(R.error||"æ¸…ç†å¤±è´¥")}catch(R){const D=R instanceof Error?R.message:"æ¸…ç†å¤±è´¥";o.error(D)}finally{a.value=!1}}return(R,D)=>(M(),A("div",Ap,[Ce(Bp),e("div",Lp,[D[4]||(D[4]=e("div",{class:"settings-group-title"},"è‡ªåŠ¨ä¿å­˜è®¾ç½®",-1)),e("div",Fp,[e("label",Up,[ae(e("input",{type:"checkbox","onUpdate:modelValue":D[0]||(D[0]=T=>p.value.autoSaveInBookshelfMode=T)},null,512),[[nt,p.value.autoSaveInBookshelfMode]]),D[2]||(D[2]=e("span",{class:"checkbox-text"},"ä¹¦æ¶æ¨¡å¼è‡ªåŠ¨ä¿å­˜",-1))]),D[3]||(D[3]=e("div",{class:"input-hint"},[me(" å¼€å¯åï¼Œåœ¨ä¹¦æ¶æ¨¡å¼ä¸‹ç¿»è¯‘æ—¶ä¼šè‡ªåŠ¨ä¿å­˜è¿›åº¦ï¼ˆç¿»è¯‘ä¸€å¼ ä¿å­˜ä¸€å¼ ï¼‰ï¼Œé˜²æ­¢æ„å¤–å…³é—­å¯¼è‡´æ•°æ®ä¸¢å¤±ã€‚ "),e("br"),e("span",{class:"hint-note"},"æ³¨æ„ï¼šæ­¤åŠŸèƒ½ä»…åœ¨ä¹¦æ¶æ¨¡å¼ä¸‹ç”Ÿæ•ˆï¼Œå¿«é€Ÿç¿»è¯‘æ¨¡å¼ä¸æ”¯æŒã€‚")],-1))])]),e("div",Op,[D[7]||(D[7]=e("div",{class:"settings-group-title"},"PDFå¤„ç†è®¾ç½®",-1)),e("div",zp,[D[5]||(D[5]=e("label",{for:"settingsPdfProcessingMethod"},"PDFå¤„ç†æ–¹å¼:",-1)),Ce(We,{modelValue:p.value.pdfProcessingMethod,"onUpdate:modelValue":D[1]||(D[1]=T=>p.value.pdfProcessingMethod=T),options:t},null,8,["modelValue"]),D[6]||(D[6]=e("div",{class:"input-hint"},"å‰ç«¯å¤„ç†é€Ÿåº¦æ›´å¿«ï¼Œåç«¯å¤„ç†å…¼å®¹æ€§æ›´å¥½",-1))])]),e("div",Np,[D[11]||(D[11]=e("div",{class:"settings-group-title"},"å­—ä½“è®¾ç½®",-1)),e("div",Vp,[D[8]||(D[8]=e("label",null,"ç³»ç»Ÿå­—ä½“åˆ—è¡¨:",-1)),e("button",{class:"btn btn-secondary",onClick:k,disabled:i.value},oe(i.value?"åŠ è½½ä¸­...":"ğŸ”„ åˆ·æ–°å­—ä½“åˆ—è¡¨"),9,Wp),r.value.length>0?(M(),A("div",Kp,"å…± "+oe(r.value.length)+" ä¸ªå­—ä½“",1)):de("",!0)]),e("div",qp,[D[9]||(D[9]=e("label",null,"ä¸Šä¼ è‡ªå®šä¹‰å­—ä½“:",-1)),e("input",{type:"file",accept:".ttf,.ttc,.otf",onChange:y,ref_key:"fontInput",ref:c},null,544),D[10]||(D[10]=e("div",{class:"input-hint"},"æ”¯æŒ .ttf, .ttc, .otf æ ¼å¼",-1))])]),e("div",Hp,[D[14]||(D[14]=e("div",{class:"settings-group-title"},"ç¼“å­˜æ¸…ç†",-1)),e("div",jp,[e("div",Jp,[e("button",{class:"btn btn-secondary",onClick:$,disabled:a.value},oe(a.value?"æ¸…ç†ä¸­...":"ğŸ—‘ï¸ æ¸…ç†è°ƒè¯•æ–‡ä»¶"),9,Yp),D[12]||(D[12]=e("div",{class:"input-hint"},"æ¸…ç†è°ƒè¯•è¿‡ç¨‹ä¸­ç”Ÿæˆçš„ä¸´æ—¶æ–‡ä»¶",-1))]),e("div",Xp,[e("button",{class:"btn btn-secondary",onClick:E,disabled:a.value},oe(a.value?"æ¸…ç†ä¸­...":"ğŸ—‘ï¸ æ¸…ç†ä¸´æ—¶æ–‡ä»¶"),9,Gp),D[13]||(D[13]=e("div",{class:"input-hint"},"æ¸…ç†ä¸‹è½½å’Œå¤„ç†è¿‡ç¨‹ä¸­çš„ä¸´æ—¶æ–‡ä»¶",-1))])])]),D[15]||(D[15]=go('<div class="settings-group" data-v-8667f80e><div class="settings-group-title" data-v-8667f80e>å…³äº</div><div class="about-info" data-v-8667f80e><p data-v-8667f80e><strong data-v-8667f80e>Saber-Translator</strong></p><p data-v-8667f80e>AIé©±åŠ¨çš„æ¼«ç”»ç¿»è¯‘å·¥å…·</p><p class="links" data-v-8667f80e><a href="http://www.mashirosaber.top" target="_blank" data-v-8667f80e>ğŸ“– ä½¿ç”¨æ•™ç¨‹</a><a href="https://github.com/MashiroSaber/saber-translator" target="_blank" data-v-8667f80e>ğŸ™ GitHub</a></p><p class="disclaimer" data-v-8667f80e>æœ¬é¡¹ç›®å®Œå…¨å¼€æºå…è´¹ï¼Œè¯·å‹¿ä¸Šå½“å—éª—</p></div></div>',1))]))}}),Qp=He(Zp,[["__scopeId","data-v-8667f80e"]]),em={class:"settings-modal-content"},tm={class:"settings-tabs"},om=["onClick"],nm={class:"settings-tab-content"},sm={class:"settings-tab-pane active"},am={class:"settings-tab-pane"},lm={class:"settings-tab-pane"},im={class:"settings-tab-pane"},rm={class:"settings-tab-pane"},um={class:"settings-tab-pane"},cm={class:"settings-tab-pane"},dm={class:"settings-tab-pane"},gm=je({__name:"SettingsModal",props:{modelValue:{type:Boolean},initialTab:{}},emits:["update:modelValue","save"],setup(n,{emit:t}){const s=n,o=t,i=ze(),r=C(s.modelValue),a=C("ocr"),c=[{id:"ocr",label:"OCRè¯†åˆ«"},{id:"translate",label:"ç¿»è¯‘æœåŠ¡"},{id:"detection",label:"æ£€æµ‹è®¾ç½®"},{id:"hq",label:"é«˜è´¨é‡ç¿»è¯‘"},{id:"proofreading",label:"AIæ ¡å¯¹"},{id:"prompt-library",label:"æç¤ºè¯ç®¡ç†"},{id:"plugins",label:"æ’ä»¶ç®¡ç†"},{id:"more",label:"æ›´å¤š"}];Se(()=>s.modelValue,$=>{r.value=$,$?(document.body.style.overflow="hidden",s.initialTab&&c.some(E=>E.id===s.initialTab)&&(a.value=s.initialTab)):(document.body.style.overflow="",a.value="ocr")});function p(){r.value=!1,o("update:modelValue",!1),document.body.style.overflow=""}async function k(){i.saveToStorage();try{await i.saveToBackend(),console.log("[SettingsModal] è®¾ç½®å·²ä¿å­˜åˆ°åç«¯")}catch($){console.warn("[SettingsModal] ä¿å­˜åˆ°åç«¯å¤±è´¥ï¼Œä»…ä¿å­˜åˆ° localStorage:",$)}o("save"),p()}function y($){$.key==="Escape"&&r.value&&p()}return dt(()=>{document.addEventListener("keydown",y)}),Ot(()=>{document.removeEventListener("keydown",y),document.body.style.overflow=""}),($,E)=>r.value?(M(),A("div",{key:0,class:"settings-modal",onClick:lt(p,["self"])},[e("div",em,[e("div",{class:"settings-modal-header"},[E[0]||(E[0]=e("h3",null,"âš™ï¸ è®¾ç½®",-1)),e("span",{class:"settings-modal-close",onClick:p},"Ã—")]),e("div",tm,[(M(),A(Oe,null,Ye(c,R=>e("button",{key:R.id,class:Ie(["settings-tab",{active:a.value===R.id}]),onClick:D=>a.value=R.id},oe(R.label),11,om)),64))]),e("div",nm,[ae(e("div",sm,[Ce(Au)],512),[[Fe,a.value==="ocr"]]),ae(e("div",am,[Ce(Sc)],512),[[Fe,a.value==="translate"]]),ae(e("div",lm,[Ce(qc)],512),[[Fe,a.value==="detection"]]),ae(e("div",im,[Ce(Rd)],512),[[Fe,a.value==="hq"]]),ae(e("div",rm,[Ce(Tg)],512),[[Fe,a.value==="proofreading"]]),ae(e("div",um,[Ce(Jg)],512),[[Fe,a.value==="prompt-library"]]),ae(e("div",cm,[Ce(Sp)],512),[[Fe,a.value==="plugins"]]),ae(e("div",dm,[Ce(Qp)],512),[[Fe,a.value==="more"]])]),e("div",{class:"settings-modal-footer"},[e("button",{class:"btn btn-secondary",onClick:p},"å–æ¶ˆ"),e("button",{class:"btn btn-primary",onClick:k},"ä¿å­˜è®¾ç½®")])])])):de("",!0)}}),pm=He(gm,[["__scopeId","data-v-e1ec20ab"]]),mm={minScale:.1,maxScale:5,zoomSpeed:.1};function hn(n={}){const t={...mm,...n},s=C(1),o=C(0),i=C(0),r=C(!1),a=C(0),c=C(0),p=Z(()=>({transform:`translate(${o.value}px, ${i.value}px) scale(${s.value})`}));function k(X,ie,U){const W=Math.min(Math.max(s.value*U,t.minScale),t.maxScale),te=W/s.value;o.value=X-(X-o.value)*te,i.value=ie-(ie-i.value)*te,s.value=W,n.onScaleChange?.(s.value),n.onTransformChange?.(_())}function y(X,ie=800,U=600){k(ie/2,U/2,X)}function $(){y(1.2)}function E(){y(.8)}function R(X,ie=800,U=600){const W=X/s.value;k(ie/2,U/2,W)}function D(X,ie){r.value=!0,a.value=X,c.value=ie}function T(X,ie){if(!r.value)return;const U=X-a.value,W=ie-c.value;o.value+=U,i.value+=W,a.value=X,c.value=ie,n.onTransformChange?.(_())}function q(){r.value=!1}function V(X,ie){o.value+=X,i.value+=ie,n.onTransformChange?.(_())}function L(){s.value=1,o.value=0,i.value=0,n.onScaleChange?.(s.value),n.onTransformChange?.(_())}function v(){L()}function g(){s.value=1,o.value=0,i.value=0}function x(X,ie,U,W){if(!X||!ie)return;const te=U/X,B=W/ie;s.value=Math.min(te,B)*.95,o.value=(U-X*s.value)/2,i.value=(W-ie*s.value)/2,n.onScaleChange?.(s.value),n.onTransformChange?.(_())}function _(){return{scale:s.value,translateX:o.value,translateY:i.value}}function K(X){X.scale!==void 0&&(s.value=X.scale),X.translateX!==void 0&&(o.value=X.translateX),X.translateY!==void 0&&(i.value=X.translateY),n.onTransformChange?.(_())}function z(X){s.value=X.scale,o.value=X.translateX,i.value=X.translateY}function se(X,ie,U){if(!X||X.length<4)return;const[W,te,B,d]=X,m=(W+B)/2,l=(te+d)/2,f=ie/2,P=U/2;o.value=f-m*s.value,i.value=P-l*s.value,n.onTransformChange?.(_())}return{scale:s,translateX:o,translateY:i,isDragging:r,transformStyle:p,zoomAt:k,zoom:y,zoomIn:$,zoomOut:E,setScale:R,startDrag:D,drag:T,endDrag:q,pan:V,reset:L,resetZoom:v,resetTransform:g,fitToScreen:x,getTransform:_,setTransform:K,syncWith:z,scrollToBubble:se}}function vm(n){const t=et(),s=ze(),o=C(null),i=C(ms),r=C(!1),a=C(!1),c=C([]),p=C(0),k=C(0);let y=null,$=null,E=null;const R=Z(()=>o.value!==null),D=Z(()=>o.value==="repair"?{fill:"rgba(76, 175, 80, 0.4)",border:"#4CAF50"}:o.value==="restore"?{fill:"rgba(33, 150, 243, 0.4)",border:"#2196F3"}:{fill:"transparent",border:"transparent"});function T(l){o.value!==l&&(o.value=l,r.value=!0,c.value=[],console.log(`è¿›å…¥${l==="repair"?"ä¿®å¤":"è¿˜åŸ"}ç¬”åˆ·æ¨¡å¼ï¼Œç¬”åˆ·å¤§å°: ${i.value}px`))}function q(){a.value&&K();const l=o.value!==null;o.value=null,r.value=!1,a.value=!1,c.value=[],ie(),l&&console.log("é€€å‡ºç¬”åˆ·æ¨¡å¼")}function V(l){o.value===l?q():T(l)}function L(l){i.value=Math.max(on,Math.min(tn,l))}function v(l){L(i.value+l)}function g(l){if(!R.value)return;l.preventDefault(),l.stopPropagation();const f=l.deltaY>0?-5:5;v(f)}function x(l,f){if(!R.value||l.button!==0)return;l.preventDefault(),l.stopPropagation(),a.value=!0,y=f,c.value=[];const P=z(l,f);P&&(c.value.push(P),X(f),U(P)),console.log("å¼€å§‹ç¬”åˆ·æ¶‚æŠ¹")}function _(l){if(p.value=l.clientX,k.value=l.clientY,!a.value||!R.value)return;const f=z(l,y);f&&(c.value.push(f),U(f))}function K(){if(!a.value)return;a.value=!1;const l=t.currentImage;if(!l||c.value.length===0){ie(),c.value=[];return}const f=se();if(!f){ie(),c.value=[];return}const P=o.value;(async()=>{P==="restore"?await W(l,f):P==="repair"&&await te(l,f),n?.onBrushComplete?.()})(),ie(),c.value=[]}function z(l,f){if(!f)return null;const P=f.querySelector(".image-canvas-wrapper"),S=P?.querySelector("img");if(!S||!S.naturalWidth)return null;const w=P.getBoundingClientRect(),N=window.getComputedStyle(P).transform;let G=1;N&&N!=="none"&&(G=new DOMMatrix(N).a);const Y=(l.clientX-w.left)/G,u=(l.clientY-w.top)/G,h=S.naturalWidth,le=S.naturalHeight;return Y<0||u<0||Y>h||u>le?null:{x:Y,y:u,scale:G}}function se(){if(c.value.length===0)return null;const f=c.value[0]?.scale||1,P=i.value/2/f;let S=1/0,w=1/0,N=-1/0,G=-1/0;for(const Y of c.value)S=Math.min(S,Y.x-P),w=Math.min(w,Y.y-P),N=Math.max(N,Y.x+P),G=Math.max(G,Y.y+P);return{x1:Math.max(0,Math.floor(S)),y1:Math.max(0,Math.floor(w)),x2:Math.ceil(N),y2:Math.ceil(G),path:[...c.value],radius:P}}function X(l){ie();const f=l.querySelector(".image-canvas-wrapper"),P=f?.querySelector("img");if(!P)return;const S=document.createElement("canvas");S.id="brushOverlayCanvas",S.width=P.naturalWidth,S.height=P.naturalHeight,S.style.cssText="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100;",f.appendChild(S),$=S,E=S.getContext("2d")}function ie(){$&&$.parentNode&&$.parentNode.removeChild($),$=null,E=null}function U(l){if(!E||!l)return;const f=D.value.fill,P=i.value/2/(l.scale||1);E.beginPath(),E.arc(l.x,l.y,P,0,Math.PI*2),E.fillStyle=f,E.fill()}async function W(l,f){if(!l.originalDataURL)return;let P;return l.cleanImageData?P="data:image/png;base64,"+l.cleanImageData:P=l.originalDataURL,new Promise(S=>{const w=new Image,N=new Image;let G=0;const Y=()=>{if(G++,G<2)return;const u=document.createElement("canvas");u.width=w.naturalWidth,u.height=w.naturalHeight;const h=u.getContext("2d");if(!h){S();return}h.drawImage(w,0,0);const le=document.createElement("canvas");le.width=u.width,le.height=u.height;const I=le.getContext("2d");if(!I){S();return}I.fillStyle="white";for(const ce of f.path)I.beginPath(),I.arc(ce.x,ce.y,f.radius,0,Math.PI*2),I.fill();h.globalCompositeOperation="destination-out",h.drawImage(le,0,0),h.globalCompositeOperation="destination-over",h.drawImage(N,0,0),h.globalCompositeOperation="source-over";const j=u.toDataURL("image/png").split(",")[1];t.updateCurrentImage({cleanImageData:j}),console.log("è¿˜åŸç¬”åˆ·åŒºåŸŸå®Œæˆ"),S()};w.onload=Y,w.onerror=()=>S(),N.onload=Y,N.onerror=()=>S(),w.src=P,N.src=l.originalDataURL})}async function te(l,f){const P=n?.getCurrentRepairSettings?.()||{inpaintMethod:"solid",fillColor:"#FFFFFF"},S=P.inpaintMethod;S==="lama_mpe"||S==="litelama"?await B(l,f,S):await d(l,f,P.fillColor)}async function B(l,f,P="lama_mpe"){let S,w;if(l.cleanImageData)S=l.cleanImageData,w="data:image/png;base64,"+l.cleanImageData;else if(l.originalDataURL)S=l.originalDataURL.split(",")[1],w=l.originalDataURL;else{console.error("æ— æ³•è·å–åŸºç¡€å›¾åƒç”¨äº LAMA ä¿®å¤");return}return new Promise(N=>{const G=new Image;G.onload=async()=>{const Y=G.naturalWidth,u=G.naturalHeight,h=document.createElement("canvas");h.width=Y,h.height=u;const le=h.getContext("2d");if(!le){console.error("æ— æ³•åˆ›å»ºæ©è†œç”»å¸ƒä¸Šä¸‹æ–‡"),N();return}le.fillStyle="black",le.fillRect(0,0,Y,u),le.fillStyle="white";for(const De of f.path)le.beginPath(),le.arc(De.x,De.y,f.radius,0,Math.PI*2),le.fill();const j=h.toDataURL("image/png").split(",")[1],ce=[f.x1,f.y1,f.x2,f.y2],ye=P==="litelama"?"litelama":"lama_mpe";try{_e("LAMA ä¿®å¤ä¸­...","info");const De=await xo(S,ce,{method:"lama",lamaModel:ye,maskData:j});if(De.success&&De.inpainted_image)t.updateCurrentImage({cleanImageData:De.inpainted_image}),console.log("ä¿®å¤ç¬”åˆ·åŒºåŸŸå®Œæˆï¼ˆLAMA ä¿®å¤ï¼Œç²¾ç¡®æ©è†œï¼‰"),_e("LAMA ä¿®å¤å®Œæˆ","success");else throw new Error(De.error||"LAMA ä¿®å¤è¿”å›æ— æ•ˆæ•°æ®")}catch(De){console.error("LAMA ä¿®å¤å¤±è´¥ï¼Œå›é€€åˆ°çº¯è‰²å¡«å……:",De),_e("LAMA ä¿®å¤å¤±è´¥ï¼Œä½¿ç”¨çº¯è‰²å¡«å……","warning");const $e=n?.getCurrentRepairSettings?.();await d(l,f,$e?.fillColor)}N()},G.onerror=()=>{console.error("åŠ è½½å›¾åƒå¤±è´¥ï¼Œæ— æ³•è¿›è¡Œ LAMA ä¿®å¤"),N()},G.src=w})}async function d(l,f,P){const S=P||s.settings.textStyle.fillColor||"#FFFFFF";let w;if(l.cleanImageData)w="data:image/png;base64,"+l.cleanImageData;else if(l.originalDataURL)w=l.originalDataURL;else return;return new Promise(N=>{const G=new Image;G.onload=()=>{const Y=document.createElement("canvas");Y.width=G.naturalWidth,Y.height=G.naturalHeight;const u=Y.getContext("2d");if(!u){N();return}u.drawImage(G,0,0),u.fillStyle=S;for(const le of f.path)u.beginPath(),u.arc(le.x,le.y,f.radius,0,Math.PI*2),u.fill();const h=Y.toDataURL("image/png").split(",")[1];t.updateCurrentImage({cleanImageData:h}),console.log("ä¿®å¤ç¬”åˆ·åŒºåŸŸå®Œæˆï¼ˆçº¯è‰²å¡«å……ï¼‰"),N()},G.onerror=()=>N(),G.src=w})}async function m(){const l=t.currentImage;if(!l)return console.warn("ensureCleanBackground: æ²¡æœ‰å½“å‰å›¾ç‰‡"),!1;if(l.cleanImageData)return console.log("ensureCleanBackground: å·²æœ‰å¹²å‡€èƒŒæ™¯"),!0;const f=n?.getCurrentRepairSettings?.();if((f?.inpaintMethod||s.settings.textStyle.inpaintMethod)!=="solid")return console.log("ensureCleanBackground: éçº¯è‰²å¡«å……æ¨¡å¼ï¼Œè·³è¿‡"),!1;if(!l.bubbleStates||l.bubbleStates.length===0)return console.warn("ensureCleanBackground: æ²¡æœ‰æ°”æ³¡æ•°æ®"),!1;if(!l.translatedDataURL&&!l.originalDataURL)return console.warn("ensureCleanBackground: æ²¡æœ‰å›¾ç‰‡æ•°æ®"),!1;console.log("ensureCleanBackground: å°è¯•ä¸ºçº¯è‰²å¡«å……æ¨¡å¼åˆ›å»ºä¸´æ—¶å¹²å‡€èƒŒæ™¯");const S=l.translatedDataURL||l.originalDataURL,w=f?.fillColor||s.settings.textStyle.fillColor||"#FFFFFF";return new Promise(N=>{const G=new Image;G.onload=()=>{try{const Y=document.createElement("canvas");Y.width=G.naturalWidth,Y.height=G.naturalHeight;const u=Y.getContext("2d");if(!u){console.error("ensureCleanBackground: æ— æ³•è·å– Canvas ä¸Šä¸‹æ–‡"),N(!1);return}u.drawImage(G,0,0),u.fillStyle=w;for(const le of l.bubbleStates){const[I,j,ce,ye]=le.coords;u.fillRect(I,j,ce-I+1,ye-j+1)}const h=Y.toDataURL("image/png").split(",")[1];t.updateCurrentImage({cleanImageData:h}),console.log("ensureCleanBackground: æˆåŠŸåˆ›å»ºä¸´æ—¶å¹²å‡€èƒŒæ™¯ï¼ˆçº¯è‰²å¡«å……ï¼‰"),N(!0)}catch(Y){console.error("ensureCleanBackground: Canvas æ“ä½œå¤±è´¥:",Y),N(!1)}},G.onerror=()=>{console.error("ensureCleanBackground: åŠ è½½å›¾åƒå¤±è´¥"),N(!1)},G.src=S})}return Ot(()=>{q()}),{brushMode:o,brushSize:i,isBrushKeyDown:r,isBrushPainting:a,mouseX:p,mouseY:k,isActive:R,brushColor:D,BRUSH_MIN_SIZE:on,BRUSH_MAX_SIZE:tn,enterBrushMode:T,exitBrushMode:q,toggleBrushMode:V,setBrushSize:L,adjustBrushSize:v,handleBrushWheel:g,startBrushPainting:x,continueBrushPainting:_,finishBrushPainting:K,getBrushPositionInImage:z,getBrushPathBounds:se,ensureCleanBackground:m}}function fm(n){return[Math.round(n[0]),Math.round(n[1]),Math.round(n[2]),Math.round(n[3])]}function bm(n){const t=gt(),s=et(),o=ze(),{bubbles:i,selectedIndex:r,hasSelection:a}=kt(t),{currentImage:c}=kt(s),p=C(!1),k=C(!1),y=C(null),$=C(0),E=C(0),R=C(!1);function D(u){t.selectBubble(u)}function T(u){t.toggleMultiSelect(u)}function q(){t.clearMultiSelect()}function V(u,h){console.log(`å¼€å§‹æ‹–åŠ¨æ°”æ³¡ #${u+1}`)}function L(u,h){}function v(u,h){t.updateBubble(u,{coords:h}),console.log(`æ°”æ³¡ #${u+1} æ‹–åŠ¨å®Œæˆ:`,h),P()}function g(u,h,le){console.log(`å¼€å§‹è°ƒæ•´æ°”æ³¡ #${u+1} å¤§å°ï¼Œæ‰‹æŸ„: ${h}`)}function x(u){}function _(u,h){t.updateBubble(u,{coords:h}),console.log(`æ°”æ³¡ #${u+1} è°ƒæ•´å¤§å°å®Œæˆ:`,h),P()}function K(u,h){console.log(`å¼€å§‹æ—‹è½¬æ°”æ³¡ #${u+1}`)}function z(u){}function se(u,h){t.updateBubble(u,{rotationAngle:h}),console.log(`æ°”æ³¡ #${u+1} æ—‹è½¬å®Œæˆ: ${h}Â°`),P()}function X(){p.value=!p.value,p.value?console.log("è¿›å…¥ç»˜åˆ¶æ¨¡å¼"):console.log("é€€å‡ºç»˜åˆ¶æ¨¡å¼")}function ie(u){t.addBubble(u),t.selectBubble(t.bubbleCount-1),console.log("å·²æ·»åŠ æ–°æ°”æ³¡:",u),n?.onReRender?.()}function U(u,h){k.value=!0,$.value=u,E.value=h,y.value=[u,h,u,h]}function W(u,h){k.value&&(y.value=[$.value,E.value,u,h])}function te(){if(!k.value||!y.value)return k.value=!1,y.value=null,null;const[u,h,le,I]=y.value,j=10;if(Math.abs(le-u)<j||Math.abs(I-h)<j)return k.value=!1,y.value=null,null;const ce=[Math.min(u,le),Math.min(h,I),Math.max(u,le),Math.max(h,I)];return k.value=!1,y.value=null,ce}function B(){k.value=!1,y.value=null,p.value=!1}function d(){if(!y.value)return{};const[u,h,le,I]=y.value;return{position:"absolute",left:`${Math.min(u,le)}px`,top:`${Math.min(h,I)}px`,width:`${Math.abs(le-u)}px`,height:`${Math.abs(I-h)}px`,border:"2px dashed #00d4ff",background:"rgba(0, 212, 255, 0.1)",pointerEvents:"none",zIndex:"25",boxSizing:"border-box"}}let m=null,l=!1;const f=150;function P(){m&&clearTimeout(m),m=setTimeout(async()=>{if(l){console.log("è·³è¿‡æ¸²æŸ“ï¼Œä¸Šä¸€æ¬¡æ¸²æŸ“ä»åœ¨è¿›è¡Œä¸­");return}console.log("è§¦å‘å»¶è¿Ÿæ¸²æŸ“é¢„è§ˆ"),l=!0;try{n?.onDelayedPreview?await n.onDelayedPreview():n?.onReRender&&await n.onReRender()}catch(u){console.error("å»¶è¿Ÿæ¸²æŸ“é¢„è§ˆå¤±è´¥:",u)}finally{l=!1}},f)}function S(u){t.updateSelectedBubble(u),P()}function w(){a.value&&(t.deleteSelected(),console.log("å·²åˆ é™¤é€‰ä¸­çš„æ°”æ³¡"),n?.onReRender?.())}async function N(){const u=r.value;if(u<0){console.warn("è¯·å…ˆé€‰ä¸­è¦ä¿®å¤çš„æ°”æ³¡æ¡†");return}const h=i.value[u],le=c.value;if(!h||!le?.originalDataURL){console.warn("æ— æ³•ä¿®å¤èƒŒæ™¯ï¼šç¼ºå°‘æ°”æ³¡æˆ–å›¾ç‰‡æ•°æ®");return}const I=h.inpaintMethod||"solid",j=h.fillColor||"#FFFFFF",ce=h.rotationAngle||0;try{console.log(`å¼€å§‹ä¿®å¤æ°”æ³¡ #${u+1} èƒŒæ™¯ï¼Œæ–¹æ³•: ${I}`);let ye;if(le.cleanImageData)ye=le.cleanImageData;else{const $e=le.originalDataURL.match(/^data:image\/[^;]+;base64,(.+)$/);if(ye=$e&&$e[1]?$e[1]:"",!ye){console.error("æ— æ³•è§£æå›¾åƒæ•°æ®");return}}if(I==="lama_mpe"||I==="litelama"){const $e=I==="litelama"?"litelama":"lama_mpe",he=fm(h.coords),ee=await xo(ye,he,{bubbleAngle:ce,method:"lama",lamaModel:$e});ee.success&&ee.inpainted_image?(s.updateCurrentImage({cleanImageData:ee.inpainted_image}),console.log(`æ°”æ³¡ #${u+1} LAMAèƒŒæ™¯ä¿®å¤æˆåŠŸ`),P()):(console.error("LAMAä¿®å¤å¤±è´¥:",ee.error||"æœªçŸ¥é”™è¯¯"),await G(h.coords,j,ce),P())}else await G(h.coords,j,ce),console.log(`æ°”æ³¡ #${u+1} çº¯è‰²å¡«å……ä¿®å¤æˆåŠŸ`),P()}catch(ye){console.error("èƒŒæ™¯ä¿®å¤å‡ºé”™:",ye)}}async function G(u,h,le=0){const I=c.value;if(!I)return;const[j,ce,ye,De]=u;let $e;if(I.cleanImageData)$e="data:image/png;base64,"+I.cleanImageData;else if(I.originalDataURL)$e=I.originalDataURL;else{console.error("æ— æ³•æ‰¾åˆ°åŸºç¡€å›¾åƒç”¨äºå¡«å……");return}return new Promise(he=>{const ee=new Image;ee.onload=()=>{const b=document.createElement("canvas");b.width=ee.naturalWidth,b.height=ee.naturalHeight;const J=b.getContext("2d");if(!J){he();return}if(J.drawImage(ee,0,0),J.fillStyle=h,Math.abs(le)<.1)J.fillRect(j,ce,ye-j,De-ce);else{const fe=(j+ye)/2,F=(ce+De)/2,ne=(ye-j)/2,be=(De-ce)/2,ge=le*Math.PI/180,Pe=Math.cos(ge),Ee=Math.sin(ge),Le=[[-ne,-be],[ne,-be],[ne,be],[-ne,be]].map(([Be,xe])=>[fe+Be*Pe-xe*Ee,F+Be*Ee+xe*Pe]);J.beginPath();const ke=Le[0];if(ke){J.moveTo(ke[0],ke[1]);for(let Be=1;Be<Le.length;Be++){const xe=Le[Be];xe&&J.lineTo(xe[0],xe[1])}}J.closePath(),J.fill()}const ve=b.toDataURL("image/png").split(",")[1];s.updateCurrentImage({cleanImageData:ve}),console.log("å·²å¯¹æ°”æ³¡åŒºåŸŸè¿›è¡Œçº¯è‰²å¡«å……:",u,h,"è§’åº¦:",le),he()},ee.onerror=()=>{console.error("åŠ è½½åŸºç¡€å›¾åƒå¤±è´¥"),he()},ee.src=$e})}async function Y(u){const h=i.value[u],le=c.value;if(!h||!le?.originalDataURL){console.warn("æ— æ³•è¿›è¡Œ OCR è¯†åˆ«ï¼šç¼ºå°‘æ°”æ³¡æˆ–å›¾ç‰‡æ•°æ®");return}try{console.log(`å¼€å§‹ OCR è¯†åˆ«æ°”æ³¡ #${u+1}`);const I=le.originalDataURL.split(",")[1]||"",j=o.settings,ce=j.ocrEngine==="paddleocr_vl"?j.paddleOcrVl?.sourceLanguage||"japanese":j.sourceLanguage,ye=await In(I,h.coords,j.ocrEngine||"manga_ocr",{source_language:ce,baidu_ocr_api_key:j.baiduOcr.apiKey,baidu_ocr_secret_key:j.baiduOcr.secretKey,baidu_version:j.baiduOcr.version,baidu_source_language:j.baiduOcr.sourceLanguage,ai_vision_provider:j.aiVisionOcr.provider,ai_vision_api_key:j.aiVisionOcr.apiKey,ai_vision_model_name:j.aiVisionOcr.modelName,ai_vision_ocr_prompt:j.aiVisionOcr.prompt,custom_ai_vision_base_url:j.aiVisionOcr.customBaseUrl,ai_vision_min_image_size:j.aiVisionOcr.minImageSize});ye.success&&ye.text!==void 0?(t.updateBubble(u,{originalText:ye.text}),console.log(`OCR è¯†åˆ«æˆåŠŸ: "${ye.text}"`)):console.error("OCR è¯†åˆ«å¤±è´¥:",ye.error||"æœªçŸ¥é”™è¯¯")}catch(I){console.error("OCR è¯†åˆ«å‡ºé”™:",I)}}return{isDrawingMode:p,isDrawingBox:k,currentDrawingRect:y,isMiddleButtonDown:R,handleBubbleSelect:D,handleBubbleMultiSelect:T,handleClearMultiSelect:q,handleBubbleDragStart:V,handleBubbleDragging:L,handleBubbleDragEnd:v,handleBubbleResizeStart:g,handleBubbleResizing:x,handleBubbleResizeEnd:_,handleBubbleRotateStart:K,handleBubbleRotating:z,handleBubbleRotateEnd:se,toggleDrawingMode:X,handleDrawBubble:ie,startDrawingBox:U,updateDrawingBox:W,finishDrawingBox:te,cancelDrawing:B,getDrawingRectStyle:d,handleBubbleUpdate:S,deleteSelectedBubbles:w,repairSelectedBubble:N,triggerDelayedPreview:P,handleOcrRecognize:Y}}function hm(n){const t=gt(),s=et(),{bubbles:o}=kt(t),{currentImage:i}=kt(s),r=C(!1),a=C("");let c=null;function p(){const $=i.value;if(!$)return null;if($.cleanImageData)return $.cleanImageData;if($.originalDataURL){const E=$.originalDataURL.match(/^data:image\/[^;]+;base64,(.+)$/);if(E&&E[1])return E[1]}return null}async function k($=!1){if(!i.value)return console.warn("reRenderFullImage: æ²¡æœ‰å½“å‰å›¾ç‰‡"),!1;if(o.value.length===0){console.log("reRenderFullImage: æ²¡æœ‰æ°”æ³¡ï¼Œè·³è¿‡åç«¯æ¸²æŸ“");const T=p();if(T){const q=`data:image/png;base64,${T}`;s.updateCurrentImage({translatedDataURL:q}),$||n?.onRenderSuccess?.(q)}return!0}const R=p();if(!R)return console.error("reRenderFullImage: ç¼ºå°‘å›¾åƒæ•°æ®"),a.value="ç¼ºå°‘å›¾åƒæ•°æ®",$||n?.onRenderError?.("ç¼ºå°‘å›¾åƒæ•°æ®"),!1;const D=Symbol("render");c=D,r.value=!0,a.value="",$||n?.onRenderStart?.();try{console.log("reRenderFullImage: å¼€å§‹é‡æ–°æ¸²æŸ“ï¼Œæ°”æ³¡æ•°é‡:",o.value.length);const T=o.value,q=T.map(g=>g.translatedText||""),V=T.map(g=>g.coords.map(x=>Math.round(x))),L=T.map(g=>({translatedText:g.translatedText||"",coords:g.coords,fontSize:Number(g.fontSize)||24,fontFamily:g.fontFamily||xt,textDirection:Lt(g),textColor:g.textColor||"#231816",rotationAngle:Math.round(Number(g.rotationAngle)||0),position:g.position?{x:Math.round(g.position.x||0),y:Math.round(g.position.y||0)}:{x:0,y:0},strokeEnabled:g.strokeEnabled!==void 0?g.strokeEnabled:!0,strokeColor:g.strokeColor||"#FFFFFF",strokeWidth:Number(g.strokeWidth)||3})),v=await yo({clean_image:R,bubble_texts:q,bubble_coords:V,bubble_states:L,fontSize:Number(T[0]?.fontSize)||24,fontFamily:T[0]?.fontFamily||xt,textDirection:T[0]?Lt(T[0]):"vertical",textColor:T[0]?.textColor||"#231816",strokeEnabled:T[0]?.strokeEnabled!==void 0?T[0].strokeEnabled:!0,strokeColor:T[0]?.strokeColor||"#FFFFFF",strokeWidth:Number(T[0]?.strokeWidth)||3,use_individual_styles:!0,use_inpainting:!1,use_lama:!1,is_font_style_change:!0});if(c!==D)return console.log("reRenderFullImage: æ¸²æŸ“ç»“æœå·²è¿‡æœŸï¼Œå¿½ç•¥"),!1;if(v.rendered_image){const g=`data:image/png;base64,${v.rendered_image}`;return s.updateCurrentImage({translatedDataURL:g}),console.log("reRenderFullImage: æ¸²æŸ“æˆåŠŸ"),$||n?.onRenderSuccess?.(g),!0}else{const g=v.error||"æ¸²æŸ“å¤±è´¥";return console.error("reRenderFullImage: æ¸²æŸ“å¤±è´¥ -",g),a.value=g,$||n?.onRenderError?.(g),!1}}catch(T){if(c!==D)return!1;const q=T instanceof Error?T.message:"æ¸²æŸ“è¯·æ±‚å¤±è´¥";return console.error("reRenderFullImage: æ¸²æŸ“å‡ºé”™ -",T),a.value=q,$||n?.onRenderError?.(q),!1}finally{c===D&&(r.value=!1,$||n?.onRenderEnd?.())}}function y(){c=null,r.value=!1}return{isRendering:r,renderError:a,reRenderFullImage:k,cancelRender:y}}const ym=["data-index","data-coords","data-rotation","onClick","onMousedown"],xm={class:"bubble-index"},_m=["data-parent-index","onMousedown"],Cm=["data-parent-index","onMousedown"],Sm=["data-parent-index","onMousedown"],km=["data-parent-index","onMousedown"],wm=["data-parent-index","onMousedown"],$m=["data-parent-index","onMousedown"],Tm=["data-parent-index","onMousedown"],Im=["data-parent-index","onMousedown"],Pm=["data-parent-index","onMousedown"],Rm=je({__name:"BubbleOverlay",props:{bubbles:{},selectedIndex:{},selectedIndices:{},scale:{},isDrawingMode:{type:Boolean},isBrushMode:{type:Boolean},imageWidth:{},imageHeight:{}},emits:["select","multiSelect","dragStart","dragging","dragEnd","resizeStart","resizing","resizeEnd","rotateStart","rotating","rotateEnd","drawBubble"],setup(n,{emit:t}){const s=gt(),{isDragging:o,draggingIndex:i,dragOffsetX:r,dragOffsetY:a,dragInitialX:c,dragInitialY:p,isResizing:k,resizingIndex:y,resizeCurrentCoords:$,isRotating:E,rotatingIndex:R,rotateCurrentAngle:D}=kt(s),T=n,q=t,V=C(null),L=C(0),v=C(0),g=C(""),x=C(0),_=C(0),K=C(null),z=C(0),se=C(0),X=C(0),ie=C(0),U=C(!1),W=C(0),te=C(0),B=C(null),d=C(!1);function m(b,J){let ve,fe,F,ne,be=b.rotationAngle||0;if(o.value&&i.value===J){const[Le,ke,Be,xe]=b.coords;ve=c.value+r.value,fe=p.value+a.value,F=ve+(Be-Le),ne=fe+(xe-ke)}else k.value&&y.value===J&&$.value?[ve,fe,F,ne]=$.value:E.value&&R.value===J?([ve,fe,F,ne]=b.coords,be=D.value):[ve,fe,F,ne]=b.coords;const ge=F-ve,Pe=ne-fe,Ee={left:`${ve}px`,top:`${fe}px`,width:`${ge}px`,height:`${Pe}px`};return be&&(Ee.transformOrigin="center center",Ee.transform=`rotate(${be}deg)`),Ee}function l(){if(!B.value)return{};const[b,J,ve,fe]=B.value;return{left:`${Math.min(b,ve)}px`,top:`${Math.min(J,fe)}px`,width:`${Math.abs(ve-b)}px`,height:`${Math.abs(fe-J)}px`}}function f(b){if(!V.value)return null;const J=V.value.getBoundingClientRect(),ve=T.scale||1,fe=(b.clientX-J.left)/ve,F=(b.clientY-J.top)/ve;return{x:fe,y:F}}function P(b,J){T.isBrushMode||J.shiftKey||q("select",b)}function S(b){if(!T.isBrushMode){if(b.button===1){b.preventDefault(),d.value=!0,document.body.classList.add("middle-button-drawing"),ye(b);return}b.button===0&&T.isDrawingMode&&ye(b)}}function w(b,J){if(!T.isBrushMode&&J.button===0){if(J.preventDefault(),J.stopPropagation(),J.shiftKey){q("multiSelect",b);return}if(b!==T.selectedIndex){q("select",b);return}N(b,J)}}function N(b,J){document.removeEventListener("mousemove",he),document.removeEventListener("mouseup",ee),o.value=!0,i.value=b,L.value=J.clientX,v.value=J.clientY,r.value=0,a.value=0;const ve=T.bubbles[b];ve&&(c.value=ve.coords[0],p.value=ve.coords[1]),q("dragStart",b,J),document.addEventListener("mousemove",he),document.addEventListener("mouseup",ee)}function G(b){const J=T.scale||1,ve=(b.clientX-L.value)/J,fe=(b.clientY-v.value)/J;r.value=ve,a.value=fe}function Y(b){const J=i.value;o.value=!1,i.value=-1,r.value=0,a.value=0;const ve=T.scale||1,fe=(b.clientX-L.value)/ve,F=(b.clientY-v.value)/ve,ne=T.bubbles[J];if(!ne)return;const[be,ge,Pe,Ee]=ne.coords,Le=Pe-be,ke=Ee-ge;let Be=Math.round(c.value+fe),xe=Math.round(p.value+F);const it=T.imageWidth||2e3,Ge=T.imageHeight||2e3,Ze=Math.min(Le,it),st=Math.min(ke,Ge);Be=Math.max(0,Math.min(Be,it-Ze)),xe=Math.max(0,Math.min(xe,Ge-st));const Ae=[Be,xe,Be+Ze,xe+st];q("dragEnd",J,Ae)}function u(b,J,ve){if(T.isBrushMode||ve.button!==0)return;ve.preventDefault(),ve.stopPropagation(),document.removeEventListener("mousemove",he),document.removeEventListener("mouseup",ee),k.value=!0,y.value=J,g.value=b,x.value=ve.clientX,_.value=ve.clientY;const fe=T.bubbles[J];fe&&(K.value=[...fe.coords],$.value=[...fe.coords]),q("resizeStart",J,b,ve),document.addEventListener("mousemove",he),document.addEventListener("mouseup",ee)}function h(b){if(!K.value)return;const J=T.scale||1,ve=(b.clientX-x.value)/J,fe=(b.clientY-_.value)/J;let[F,ne,be,ge]=K.value;const Pe=g.value;Pe.includes("w")&&(F+=ve),Pe.includes("e")&&(be+=ve),Pe.includes("n")&&(ne+=fe),Pe.includes("s")&&(ge+=fe),F>be&&([F,be]=[be,F]),ne>ge&&([ne,ge]=[ge,ne]);const Ee=10;be-F<Ee||ge-ne<Ee||($.value=[F,ne,be,ge])}function le(b){if(!K.value)return;const J=T.scale||1,ve=(b.clientX-x.value)/J,fe=(b.clientY-_.value)/J;let[F,ne,be,ge]=K.value;const Pe=g.value;Pe.includes("w")&&(F+=ve),Pe.includes("e")&&(be+=ve),Pe.includes("n")&&(ne+=fe),Pe.includes("s")&&(ge+=fe),F>be&&([F,be]=[be,F]),ne>ge&&([ne,ge]=[ge,ne]);const Ee=T.imageWidth||2e3,Le=T.imageHeight||2e3;F=Math.max(0,Math.round(F)),ne=Math.max(0,Math.round(ne)),be=Math.min(Ee,Math.round(be)),ge=Math.min(Le,Math.round(ge));const ke=10;if(be-F<ke||ge-ne<ke){console.warn("è°ƒæ•´åå°ºå¯¸è¿‡å°ï¼Œå·²æ’¤é”€"),k.value=!1,y.value=-1,K.value=null;return}q("resizeEnd",y.value,[F,ne,be,ge]),k.value=!1,y.value=-1,K.value=null,$.value=null}function I(b,J){if(T.isBrushMode||J.button!==0)return;J.preventDefault(),J.stopPropagation(),document.removeEventListener("mousemove",he),document.removeEventListener("mouseup",ee),E.value=!0,R.value=b;const ve=T.bubbles[b];if(!ve||!V.value)return;const[fe,F,ne,be]=ve.coords,ge=T.scale||1,Pe=V.value.getBoundingClientRect();X.value=Pe.left+(fe+ne)/2*ge,ie.value=Pe.top+(F+be)/2*ge;const Ee=J.clientX-X.value,Le=J.clientY-ie.value;z.value=Math.atan2(Le,Ee)*180/Math.PI,se.value=ve.rotationAngle||0,D.value=ve.rotationAngle||0,q("rotateStart",b,J),document.body.classList.add("rotating-box"),document.addEventListener("mousemove",he),document.addEventListener("mouseup",ee),console.log(`å¼€å§‹æ—‹è½¬æ°”æ³¡ #${b+1}ï¼Œåˆå§‹è§’åº¦: ${se.value}Â°`)}function j(b){const J=b.clientX-X.value,ve=b.clientY-ie.value,F=Math.atan2(ve,J)*180/Math.PI-z.value;let ne=se.value+F;for(;ne>180;)ne-=360;for(;ne<-180;)ne+=360;b.shiftKey&&(ne=Math.round(ne/15)*15),D.value=ne}function ce(b){document.body.classList.remove("rotating-box");const J=R.value,ve=D.value;q("rotateEnd",J,ve),E.value=!1,R.value=-1,console.log(`æ°”æ³¡ #${J+1} æ—‹è½¬å®Œæˆï¼Œè§’åº¦: ${ve}Â°`)}function ye(b){const J=f(b);if(!J)return;const ve=T.imageWidth||2e3,fe=T.imageHeight||2e3;J.x<0||J.x>ve||J.y<0||J.y>fe||(U.value=!0,W.value=J.x,te.value=J.y,B.value=[J.x,J.y,J.x,J.y],document.addEventListener("mousemove",he),document.addEventListener("mouseup",ee),console.log("å¼€å§‹ç»˜åˆ¶æ–°æ¡†:",J.x.toFixed(1),J.y.toFixed(1)))}function De(b){const J=f(b);!J||!B.value||(B.value=[W.value,te.value,J.x,J.y])}function $e(b){const J=f(b);if(d.value&&(d.value=!1,document.body.classList.remove("middle-button-drawing")),!J||!B.value){U.value=!1,B.value=null;return}const ve=T.imageWidth||2e3,fe=T.imageHeight||2e3,F=Math.max(0,Math.round(Math.min(W.value,J.x))),ne=Math.max(0,Math.round(Math.min(te.value,J.y))),be=Math.min(ve,Math.round(Math.max(W.value,J.x))),ge=Math.min(fe,Math.round(Math.max(te.value,J.y))),Pe=10;if(be-F<Pe||ge-ne<Pe){console.log("ç»˜åˆ¶çš„æ¡†å¤ªå°ï¼Œå·²å¿½ç•¥"),U.value=!1,B.value=null;return}console.log("å®Œæˆç»˜åˆ¶æ–°æ¡†:",[F,ne,be,ge]),q("drawBubble",[F,ne,be,ge]),U.value=!1,B.value=null}function he(b){o.value?G(b):k.value?h(b):E.value?j(b):U.value&&De(b)}function ee(b){document.removeEventListener("mousemove",he),document.removeEventListener("mouseup",ee),(b.button===1||d.value)&&(d.value=!1,document.body.classList.remove("middle-button-drawing")),o.value?Y(b):k.value?le(b):E.value?ce():U.value&&$e(b)}return dt(()=>{}),Ot(()=>{document.removeEventListener("mousemove",he),document.removeEventListener("mouseup",ee),document.body.classList.remove("middle-button-drawing"),document.body.classList.remove("rotating-box")}),(b,J)=>(M(),A("div",{class:Ie(["bubble-overlay",{"brush-mode":n.isBrushMode}]),style:at({"--scale":n.scale||1}),ref_key:"overlayRef",ref:V,onMousedown:S},[(M(!0),A(Oe,null,Ye(n.bubbles,(ve,fe)=>(M(),A("div",{key:fe,class:Ie(["bubble-highlight-box",{selected:fe===n.selectedIndex,"multi-selected":n.selectedIndices.length>1&&n.selectedIndices.includes(fe)&&fe!==n.selectedIndex}]),style:at(m(ve,fe)),"data-index":fe,"data-coords":JSON.stringify(ve.coords),"data-rotation":ve.rotationAngle||0,onClick:lt(F=>P(fe,F),["stop"]),onMousedown:lt(F=>w(fe,F),["stop"])},[e("span",xm,oe(fe+1),1),fe===n.selectedIndex?(M(),A(Oe,{key:0},[e("div",{class:"resize-handle nw","data-handle":"nw","data-parent-index":fe,onMousedown:lt(F=>u("nw",fe,F),["stop"])},null,40,_m),e("div",{class:"resize-handle n","data-handle":"n","data-parent-index":fe,onMousedown:lt(F=>u("n",fe,F),["stop"])},null,40,Cm),e("div",{class:"resize-handle ne","data-handle":"ne","data-parent-index":fe,onMousedown:lt(F=>u("ne",fe,F),["stop"])},null,40,Sm),e("div",{class:"resize-handle e","data-handle":"e","data-parent-index":fe,onMousedown:lt(F=>u("e",fe,F),["stop"])},null,40,km),e("div",{class:"resize-handle se","data-handle":"se","data-parent-index":fe,onMousedown:lt(F=>u("se",fe,F),["stop"])},null,40,wm),e("div",{class:"resize-handle s","data-handle":"s","data-parent-index":fe,onMousedown:lt(F=>u("s",fe,F),["stop"])},null,40,$m),e("div",{class:"resize-handle sw","data-handle":"sw","data-parent-index":fe,onMousedown:lt(F=>u("sw",fe,F),["stop"])},null,40,Tm),e("div",{class:"resize-handle w","data-handle":"w","data-parent-index":fe,onMousedown:lt(F=>u("w",fe,F),["stop"])},null,40,Im),J[0]||(J[0]=e("div",{class:"rotate-line"},null,-1)),e("div",{class:"rotate-handle",title:"æ‹–æ‹½æ—‹è½¬","data-parent-index":fe,onMousedown:lt(F=>I(fe,F),["stop"])},null,40,Pm)],64)):de("",!0)],46,ym))),128)),B.value?(M(),A("div",{key:0,class:"drawing-rect",style:at(l())},null,4)):de("",!0)],38))}}),yn=He(Rm,[["__scopeId","data-v-8d9cb1b9"]]),Dm={key:0,class:"kana-keyboard"},Mm={class:"kana-keyboard-header"},Em={class:"kana-keyboard-tabs"},Bm=["onClick"],Am={class:"kana-keyboard-options"},Lm={class:"kana-mode-select"},Fm={class:"kana-target-select"},Um={class:"kana-table"},Om={class:"row-label"},zm=["onClick"],Nm={class:"kana-hiragana"},Vm={class:"kana-katakana"},Wm={class:"kana-table"},Km={class:"row-label"},qm=["onClick"],Hm={class:"kana-hiragana"},jm={class:"kana-katakana"},Jm={class:"kana-table combo-table"},Ym={class:"row-label"},Xm=["onClick"],Gm={class:"kana-hiragana"},Zm={class:"kana-katakana"},Qm={class:"special-chars-grid"},ev=["onClick"],tv={key:0,class:"char-label"},ov=je({__name:"JapaneseKeyboard",props:{visible:{type:Boolean,default:!1},defaultTarget:{default:"original"}},emits:["close","insert","delete"],setup(n,{emit:t}){const s=n,o=t,i=C("basic"),r=C("hiragana"),a=C(s.defaultTarget),c=C(null),p=[{label:"åŸæ–‡",value:"original"},{label:"è¯‘æ–‡",value:"translated"}],k=[{id:"basic",label:"åŸºæœ¬"},{id:"dakuten",label:"æµŠ/åŠæµŠéŸ³"},{id:"combo",label:"æ‹—éŸ³"},{id:"special",label:"ç‰¹æ®Š"}],y=[{label:"ã‚è¡Œ",chars:[{h:"ã‚",k:"ã‚¢"},{h:"ã„",k:"ã‚¤"},{h:"ã†",k:"ã‚¦"},{h:"ãˆ",k:"ã‚¨"},{h:"ãŠ",k:"ã‚ª"}]},{label:"ã‹è¡Œ",chars:[{h:"ã‹",k:"ã‚«"},{h:"ã",k:"ã‚­"},{h:"ã",k:"ã‚¯"},{h:"ã‘",k:"ã‚±"},{h:"ã“",k:"ã‚³"}]},{label:"ã•è¡Œ",chars:[{h:"ã•",k:"ã‚µ"},{h:"ã—",k:"ã‚·"},{h:"ã™",k:"ã‚¹"},{h:"ã›",k:"ã‚»"},{h:"ã",k:"ã‚½"}]},{label:"ãŸè¡Œ",chars:[{h:"ãŸ",k:"ã‚¿"},{h:"ã¡",k:"ãƒ"},{h:"ã¤",k:"ãƒ„"},{h:"ã¦",k:"ãƒ†"},{h:"ã¨",k:"ãƒˆ"}]},{label:"ãªè¡Œ",chars:[{h:"ãª",k:"ãƒŠ"},{h:"ã«",k:"ãƒ‹"},{h:"ã¬",k:"ãƒŒ"},{h:"ã­",k:"ãƒ"},{h:"ã®",k:"ãƒ"}]},{label:"ã¯è¡Œ",chars:[{h:"ã¯",k:"ãƒ"},{h:"ã²",k:"ãƒ’"},{h:"ãµ",k:"ãƒ•"},{h:"ã¸",k:"ãƒ˜"},{h:"ã»",k:"ãƒ›"}]},{label:"ã¾è¡Œ",chars:[{h:"ã¾",k:"ãƒ"},{h:"ã¿",k:"ãƒŸ"},{h:"ã‚€",k:"ãƒ "},{h:"ã‚",k:"ãƒ¡"},{h:"ã‚‚",k:"ãƒ¢"}]},{label:"ã‚„è¡Œ",chars:[{h:"ã‚„",k:"ãƒ¤"},null,{h:"ã‚†",k:"ãƒ¦"},null,{h:"ã‚ˆ",k:"ãƒ¨"}]},{label:"ã‚‰è¡Œ",chars:[{h:"ã‚‰",k:"ãƒ©"},{h:"ã‚Š",k:"ãƒª"},{h:"ã‚‹",k:"ãƒ«"},{h:"ã‚Œ",k:"ãƒ¬"},{h:"ã‚",k:"ãƒ­"}]},{label:"ã‚è¡Œ",chars:[{h:"ã‚",k:"ãƒ¯"},null,null,null,{h:"ã‚’",k:"ãƒ²"}]},{label:"ã‚“",chars:[{h:"ã‚“",k:"ãƒ³"},null,null,null,null]}],$=[{label:"ãŒè¡Œ",chars:[{h:"ãŒ",k:"ã‚¬"},{h:"ã",k:"ã‚®"},{h:"ã",k:"ã‚°"},{h:"ã’",k:"ã‚²"},{h:"ã”",k:"ã‚´"}]},{label:"ã–è¡Œ",chars:[{h:"ã–",k:"ã‚¶"},{h:"ã˜",k:"ã‚¸"},{h:"ãš",k:"ã‚º"},{h:"ãœ",k:"ã‚¼"},{h:"ã",k:"ã‚¾"}]},{label:"ã è¡Œ",chars:[{h:"ã ",k:"ãƒ€"},{h:"ã¢",k:"ãƒ‚"},{h:"ã¥",k:"ãƒ…"},{h:"ã§",k:"ãƒ‡"},{h:"ã©",k:"ãƒ‰"}]},{label:"ã°è¡Œ",chars:[{h:"ã°",k:"ãƒ"},{h:"ã³",k:"ãƒ“"},{h:"ã¶",k:"ãƒ–"},{h:"ã¹",k:"ãƒ™"},{h:"ã¼",k:"ãƒœ"}]},{label:"ã±è¡Œ",chars:[{h:"ã±",k:"ãƒ‘"},{h:"ã´",k:"ãƒ”"},{h:"ã·",k:"ãƒ—"},{h:"ãº",k:"ãƒš"},{h:"ã½",k:"ãƒ"}]}],E=[{label:"ãã‚ƒè¡Œ",chars:[{h:"ãã‚ƒ",k:"ã‚­ãƒ£"},{h:"ãã‚…",k:"ã‚­ãƒ¥"},{h:"ãã‚‡",k:"ã‚­ãƒ§"}]},{label:"ã—ã‚ƒè¡Œ",chars:[{h:"ã—ã‚ƒ",k:"ã‚·ãƒ£"},{h:"ã—ã‚…",k:"ã‚·ãƒ¥"},{h:"ã—ã‚‡",k:"ã‚·ãƒ§"}]},{label:"ã¡ã‚ƒè¡Œ",chars:[{h:"ã¡ã‚ƒ",k:"ãƒãƒ£"},{h:"ã¡ã‚…",k:"ãƒãƒ¥"},{h:"ã¡ã‚‡",k:"ãƒãƒ§"}]},{label:"ã«ã‚ƒè¡Œ",chars:[{h:"ã«ã‚ƒ",k:"ãƒ‹ãƒ£"},{h:"ã«ã‚…",k:"ãƒ‹ãƒ¥"},{h:"ã«ã‚‡",k:"ãƒ‹ãƒ§"}]},{label:"ã²ã‚ƒè¡Œ",chars:[{h:"ã²ã‚ƒ",k:"ãƒ’ãƒ£"},{h:"ã²ã‚…",k:"ãƒ’ãƒ¥"},{h:"ã²ã‚‡",k:"ãƒ’ãƒ§"}]},{label:"ã¿ã‚ƒè¡Œ",chars:[{h:"ã¿ã‚ƒ",k:"ãƒŸãƒ£"},{h:"ã¿ã‚…",k:"ãƒŸãƒ¥"},{h:"ã¿ã‚‡",k:"ãƒŸãƒ§"}]},{label:"ã‚Šã‚ƒè¡Œ",chars:[{h:"ã‚Šã‚ƒ",k:"ãƒªãƒ£"},{h:"ã‚Šã‚…",k:"ãƒªãƒ¥"},{h:"ã‚Šã‚‡",k:"ãƒªãƒ§"}]},{label:"ãã‚ƒè¡Œ",chars:[{h:"ãã‚ƒ",k:"ã‚®ãƒ£"},{h:"ãã‚…",k:"ã‚®ãƒ¥"},{h:"ãã‚‡",k:"ã‚®ãƒ§"}]},{label:"ã˜ã‚ƒè¡Œ",chars:[{h:"ã˜ã‚ƒ",k:"ã‚¸ãƒ£"},{h:"ã˜ã‚…",k:"ã‚¸ãƒ¥"},{h:"ã˜ã‚‡",k:"ã‚¸ãƒ§"}]},{label:"ã³ã‚ƒè¡Œ",chars:[{h:"ã³ã‚ƒ",k:"ãƒ“ãƒ£"},{h:"ã³ã‚…",k:"ãƒ“ãƒ¥"},{h:"ã³ã‚‡",k:"ãƒ“ãƒ§"}]},{label:"ã´ã‚ƒè¡Œ",chars:[{h:"ã´ã‚ƒ",k:"ãƒ”ãƒ£"},{h:"ã´ã‚…",k:"ãƒ”ãƒ¥"},{h:"ã´ã‚‡",k:"ãƒ”ãƒ§"}]}],R=[{char:"ã£",label:"ä¿ƒéŸ³"},{char:"ãƒƒ",label:"ä¿ƒéŸ³"},{char:"ãƒ¼",label:"é•¿éŸ³"},{char:"ã€œ",label:"æ³¢æµª"},{char:"ã€‚",label:"å¥å·"},{char:"ã€",label:"é¡¿å·"},{char:"ã€Œ",label:"å¼•å·"},{char:"ã€",label:"å¼•å·"},{char:"ã€",label:"åŒå¼•"},{char:"ã€",label:"åŒå¼•"},{char:"â€¦",label:"çœç•¥"},{char:"ãƒ»",label:"ä¸­ç‚¹"},{char:"ï¼",label:"æ„Ÿå¹"},{char:"ï¼Ÿ",label:"é—®å·"},{char:"â™ª",label:"éŸ³ç¬¦"},{char:"â™¡",label:"å¿ƒå½¢"},{char:"â˜…",label:"æ˜Ÿå½¢"},{char:"â˜†",label:"ç©ºæ˜Ÿ"},{char:"ã",label:"å°ã‚"},{char:"ãƒ",label:"å°ã„"},{char:"ã…",label:"å°ã†"},{char:"ã‡",label:"å°ãˆ"},{char:"ã‰",label:"å°ãŠ"},{char:"ã‚¡",label:"å°ã‚¢"},{char:"ã‚£",label:"å°ã‚¤"},{char:"ã‚¥",label:"å°ã‚¦"},{char:"ã‚§",label:"å°ã‚¨"},{char:"ã‚©",label:"å°ã‚ª"},{char:"ã‚ƒ",label:"å°ã‚„"},{char:"ã‚…",label:"å°ã‚†"},{char:"ã‚‡",label:"å°ã‚ˆ"},{char:"ãƒ£",label:"å°ãƒ¤"},{char:"ãƒ¥",label:"å°ãƒ¦"},{char:"ãƒ§",label:"å°ãƒ¨"}];function D(){o("close")}function T(L){const v=r.value==="hiragana"?L.h:L.k;c.value=L.h,setTimeout(()=>{c.value=null},100),o("insert",v,a.value)}function q(L){c.value=L,setTimeout(()=>{c.value=null},100),o("insert",L,a.value)}function V(){o("delete",a.value)}return(L,v)=>n.visible?(M(),A("div",Dm,[e("div",Mm,[v[3]||(v[3]=e("span",{class:"kana-keyboard-title"},"50éŸ³é”®ç›˜",-1)),e("div",Em,[(M(),A(Oe,null,Ye(k,g=>e("button",{key:g.id,class:Ie(["kana-tab",{active:i.value===g.id}]),onClick:x=>i.value=g.id},oe(g.label),11,Bm)),64))]),e("button",{class:"kana-keyboard-close",onClick:D},"âœ•")]),e("div",Am,[e("div",Lm,[e("label",null,[ae(e("input",{type:"radio",name:"kanaMode",value:"hiragana","onUpdate:modelValue":v[0]||(v[0]=g=>r.value=g)},null,512),[[rn,r.value]]),v[4]||(v[4]=me(" å¹³å‡å ",-1))]),e("label",null,[ae(e("input",{type:"radio",name:"kanaMode",value:"katakana","onUpdate:modelValue":v[1]||(v[1]=g=>r.value=g)},null,512),[[rn,r.value]]),v[5]||(v[5]=me(" ç‰‡å‡å ",-1))])]),e("div",Fm,[v[6]||(v[6]=e("label",null,"è¾“å…¥åˆ°ï¼š",-1)),Ce(We,{modelValue:a.value,"onUpdate:modelValue":v[2]||(v[2]=g=>a.value=g),options:p},null,8,["modelValue"])])]),e("div",{class:Ie(["kana-tab-content",{active:i.value==="basic"}])},[e("table",Um,[v[7]||(v[7]=e("thead",null,[e("tr",null,[e("th"),e("th",null,"ã‚æ®µ"),e("th",null,"ã„æ®µ"),e("th",null,"ã†æ®µ"),e("th",null,"ãˆæ®µ"),e("th",null,"ãŠæ®µ")])],-1)),e("tbody",null,[(M(),A(Oe,null,Ye(y,g=>e("tr",{key:g.label},[e("td",Om,oe(g.label),1),(M(!0),A(Oe,null,Ye(g.chars,(x,_)=>(M(),A("td",{key:_},[x?(M(),A("button",{key:0,class:Ie(["kana-key",{pressed:c.value===x.h}]),onClick:K=>T(x)},[e("span",Nm,oe(x.h),1),e("span",Vm,oe(x.k),1)],10,zm)):de("",!0)]))),128))])),64))])])],2),e("div",{class:Ie(["kana-tab-content",{active:i.value==="dakuten"}])},[e("table",Wm,[v[8]||(v[8]=e("thead",null,[e("tr",null,[e("th"),e("th",null,"ã‚æ®µ"),e("th",null,"ã„æ®µ"),e("th",null,"ã†æ®µ"),e("th",null,"ãˆæ®µ"),e("th",null,"ãŠæ®µ")])],-1)),e("tbody",null,[(M(),A(Oe,null,Ye($,g=>e("tr",{key:g.label},[e("td",Km,oe(g.label),1),(M(!0),A(Oe,null,Ye(g.chars,(x,_)=>(M(),A("td",{key:_},[x?(M(),A("button",{key:0,class:Ie(["kana-key",{pressed:c.value===x.h}]),onClick:K=>T(x)},[e("span",Hm,oe(x.h),1),e("span",jm,oe(x.k),1)],10,qm)):de("",!0)]))),128))])),64))])])],2),e("div",{class:Ie(["kana-tab-content",{active:i.value==="combo"}])},[e("table",Jm,[v[9]||(v[9]=e("thead",null,[e("tr",null,[e("th"),e("th",null,"ã‚ƒ"),e("th",null,"ã‚…"),e("th",null,"ã‚‡")])],-1)),e("tbody",null,[(M(),A(Oe,null,Ye(E,g=>e("tr",{key:g.label},[e("td",Ym,oe(g.label),1),(M(!0),A(Oe,null,Ye(g.chars,(x,_)=>(M(),A("td",{key:_},[x?(M(),A("button",{key:0,class:Ie(["kana-key",{pressed:c.value===x.h}]),onClick:K=>T(x)},[e("span",Gm,oe(x.h),1),e("span",Zm,oe(x.k),1)],10,Xm)):de("",!0)]))),128))])),64))])])],2),e("div",{class:Ie(["kana-tab-content",{active:i.value==="special"}])},[e("div",Qm,[(M(),A(Oe,null,Ye(R,g=>e("button",{key:g.char,class:Ie(["kana-key special-key",{pressed:c.value===g.char}]),onClick:x=>q(g.char)},[me(oe(g.char)+" ",1),g.label?(M(),A("span",tv,oe(g.label),1)):de("",!0)],10,ev)),64))])],2),e("div",{class:"kana-keyboard-footer"},[e("button",{class:"kana-backspace",onClick:V},"âŒ« é€€æ ¼")])])):de("",!0)}}),nv=He(ov,[["__scopeId","data-v-ebfc2125"]]),sv={class:"edit-panel-content"},av={class:"text-column original-text-column text-block"},lv={class:"text-column translated-text-column text-block"},iv={class:"style-settings-section text-block"},rv={class:"office-toolbar"},uv={class:"toolbar-row toolbar-row-top"},cv={class:"combo-control font-control"},dv={class:"combo-control size-control"},gv={class:"size-input-wrap"},pv=["min","max","step"],mv={class:"toolbar-row toolbar-row-actions"},vv={class:"toolbar-icon-group","aria-label":"æ’ç‰ˆæ–¹å‘"},fv=["data-active"],bv=["data-active"],hv={class:"toolbar-color-group"},yv={class:"toolbar-color-picker",title:"æ–‡å­—é¢œè‰²"},xv={class:"toolbar-inpaint-group",title:"èƒŒæ™¯ä¿®å¤æ–¹å¼"},_v={class:"toolbar-stroke-cluster"},Cv=["data-active"],Sv={class:"toolbar-row toolbar-row-bottom"},kv={class:"toolbar-rotation-group",title:"æ—‹è½¬è§’åº¦"},wv={class:"toolbar-position-group",title:"ä½ç½®è°ƒæ•´"},$v={class:"toolbar-position-value"},Tv={class:"fontsize-presets-panel"},Iv={class:"font-size-presets"},Pv=["onClick"],Kt=2,Rv=je({__name:"BubbleEditor",props:{bubble:{},bubbleIndex:{}},emits:["update","reRender","ocrRecognize","reTranslate","applyBubble","resetCurrent"],setup(n,{emit:t}){const s=n,o=t,i=gt(),r={originalText:"",translatedText:"",fontSize:24,fontFamily:xt,textDirection:"vertical",textColor:"#231816",fillColor:"#FFFFFF",strokeEnabled:!0,strokeColor:"#FFFFFF",strokeWidth:3,rotationAngle:0,inpaintMethod:"solid",position:{x:0,y:0}},a=C(""),c=C(""),p=C(24),k=C(xt),y=C("vertical"),$=C("#231816"),E=C("#FFFFFF"),R=C(!0),D=C("#FFFFFF"),T=C(3),q=C(0),V=C("solid"),L=C(0),v=C(0),g=C(null),x=C(null),_=C(null),K=C(null),z=C(null),se=C(!1),X=C("original"),ie=C([{name:"æ€æºé»‘ä½“",path:xt},{name:"åæ–‡æ¥·ä½“",path:"fonts/STKAITI.TTF"},{name:"åæ–‡ç»†é»‘",path:"fonts/STXIHEI.TTF"},{name:"é»‘ä½“",path:"fonts/SIMHEI.TTF"},{name:"å®‹ä½“",path:"fonts/SIMSUN.TTC"}]),U=C([]),W=Z(()=>s.bubble?s.bubble.coords[0]+L.value:0),te=Z(()=>s.bubble?s.bubble.coords[1]+v.value:0),B=Z(()=>{const Ae=[{label:"ç³»ç»Ÿå­—ä½“",options:ie.value.map(O=>({label:O.name,value:O.path}))}];return U.value.length>0&&Ae.push({label:"è‡ªå®šä¹‰å­—ä½“",options:U.value.map(O=>({label:O.name,value:O.path}))}),Ae}),d=[{label:"çº¯è‰²å¡«å……",value:"solid"},{label:"LAMAä¿®å¤(æ¼«ç”»)",value:"lama_mpe"},{label:"LAMAä¿®å¤(é€šç”¨)",value:"litelama"}];function m(Ae){const O=Ae||r;a.value=O.originalText,c.value=O.translatedText,p.value=O.fontSize,k.value=O.fontFamily,y.value=O.textDirection,$.value=O.textColor,E.value=O.fillColor,R.value=O.strokeEnabled,D.value=O.strokeColor,T.value=O.strokeWidth,q.value=O.rotationAngle,V.value=O.inpaintMethod,L.value=O.position?.x||0,v.value=O.position?.y||0}Se(()=>s.bubble,Ae=>{m(Ae)},{deep:!0,immediate:!0});function l(){o("update",{originalText:a.value})}function f(){o("update",{translatedText:c.value})}function P(){navigator.clipboard.writeText(a.value)}function S(){navigator.clipboard.writeText(c.value)}function w(){o("update",{fontSize:p.value})}function N(Ae){p.value=Ae,o("update",{fontSize:Ae})}function G(){p.value=Math.min(nn,p.value+ro),o("update",{fontSize:p.value})}function Y(){p.value=Math.max(sn,p.value-ro),o("update",{fontSize:p.value})}function u(){o("update",{fontFamily:k.value})}function h(Ae){y.value=Ae,o("update",{textDirection:Ae})}function le(){_.value?.click()}function I(){o("update",{textColor:$.value})}function j(){K.value?.click()}function ce(){o("update",{fillColor:E.value})}function ye(){z.value?.click()}function De(){o("update",{strokeColor:D.value})}function $e(){R.value=!R.value,o("update",{strokeEnabled:R.value})}function he(){o("update",{strokeWidth:T.value})}function ee(){o("update",{inpaintMethod:V.value})}function b(){o("update",{rotationAngle:q.value})}function J(){q.value=Math.max(-180,q.value-5),o("update",{rotationAngle:q.value})}function ve(){q.value=Math.min(180,q.value+5),o("update",{rotationAngle:q.value})}function fe(){q.value=0,o("update",{rotationAngle:0})}function F(){L.value-=Kt,o("update",{position:{x:L.value,y:v.value}})}function ne(){L.value+=Kt,o("update",{position:{x:L.value,y:v.value}})}function be(){v.value-=Kt,o("update",{position:{x:L.value,y:v.value}})}function ge(){v.value+=Kt,o("update",{position:{x:L.value,y:v.value}})}function Pe(){L.value=0,v.value=0,o("update",{position:{x:0,y:0}})}function Ee(){o("applyBubble",s.bubbleIndex)}function Le(){i.updateAllBubbles({fontSize:p.value,fontFamily:k.value,textDirection:y.value,textColor:$.value,fillColor:E.value,strokeEnabled:R.value,strokeColor:D.value,strokeWidth:T.value,inpaintMethod:V.value}),console.log("æ ·å¼å·²åº”ç”¨åˆ°æ‰€æœ‰æ°”æ³¡"),o("reRender")}function ke(){o("resetCurrent",s.bubbleIndex)}function Be(){o("ocrRecognize",s.bubbleIndex)}function xe(){o("reTranslate",s.bubbleIndex)}function it(){se.value=!se.value}function Ge(Ae,O){if(O==="original"){const re=g.value;if(re){const Te=re.selectionStart||a.value.length,Re=re.selectionEnd||a.value.length,tt=a.value;a.value=tt.slice(0,Te)+Ae+tt.slice(Re),pt(()=>{re.selectionStart=re.selectionEnd=Te+Ae.length,re.focus()}),o("update",{originalText:a.value})}}else{const re=x.value;if(re){const Te=re.selectionStart||c.value.length,Re=re.selectionEnd||c.value.length,tt=c.value;c.value=tt.slice(0,Te)+Ae+tt.slice(Re),pt(()=>{re.selectionStart=re.selectionEnd=Te+Ae.length,re.focus()}),o("update",{translatedText:c.value})}}}function Ze(Ae){if(Ae==="original"){const O=g.value;if(O&&a.value.length>0){const re=O.selectionStart||a.value.length,Te=O.selectionEnd||a.value.length,Re=a.value;re===Te&&re>0?(a.value=Re.slice(0,re-1)+Re.slice(Te),pt(()=>{O.selectionStart=O.selectionEnd=re-1,O.focus()})):re!==Te&&(a.value=Re.slice(0,re)+Re.slice(Te),pt(()=>{O.selectionStart=O.selectionEnd=re,O.focus()})),o("update",{originalText:a.value})}}else{const O=x.value;if(O&&c.value.length>0){const re=O.selectionStart||c.value.length,Te=O.selectionEnd||c.value.length,Re=c.value;re===Te&&re>0?(c.value=Re.slice(0,re-1)+Re.slice(Te),pt(()=>{O.selectionStart=O.selectionEnd=re-1,O.focus()})):re!==Te&&(c.value=Re.slice(0,re)+Re.slice(Te),pt(()=>{O.selectionStart=O.selectionEnd=re,O.focus()})),o("update",{translatedText:c.value})}}}async function st(){try{const Ae=await Es();if(Ae.fonts){const O=[],re=[];for(const Te of Ae.fonts){const Re={name:typeof Te=="string"?Te:Te.display_name||Te.file_name||"",path:typeof Te=="string"?Te:Te.path};Re.path.startsWith("fonts/")?O.push(Re):re.push(Re)}O.length>0&&(ie.value=O),U.value=re}}catch(Ae){console.error("åŠ è½½å­—ä½“åˆ—è¡¨å¤±è´¥:",Ae)}}return dt(()=>{st()}),(Ae,O)=>(M(),A("div",sv,[e("div",av,[e("div",{class:"text-column-header"},[O[13]||(O[13]=e("span",{class:"column-title"},"ğŸ‡¯ğŸ‡µ æ—¥è¯­åŸæ–‡ (OCRç»“æœ)",-1)),e("button",{class:"re-ocr-btn",onClick:Be,title:"é‡æ–°OCRæ­¤æ°”æ³¡"},"ğŸ”„")]),ae(e("textarea",{ref_key:"originalTextInput",ref:g,"onUpdate:modelValue":O[0]||(O[0]=re=>a.value=re),class:"text-editor original-editor",placeholder:"OCRè¯†åˆ«çš„æ—¥è¯­åŸæ–‡...",spellcheck:"false",onInput:l},null,544),[[we,a.value]]),e("div",{class:"text-actions"},[e("button",{class:"copy-btn",onClick:P},"ğŸ“‹ å¤åˆ¶"),e("button",{class:"keyboard-toggle-btn",onClick:it,title:"æ˜¾ç¤º/éšè—50éŸ³é”®ç›˜"}," âŒ¨ï¸ 50éŸ³ ")]),Ce(nv,{visible:se.value,"default-target":X.value,onClose:O[1]||(O[1]=re=>se.value=!1),onInsert:Ge,onDelete:Ze},null,8,["visible","default-target"])]),e("div",lv,[e("div",{class:"text-column-header"},[O[14]||(O[14]=e("span",{class:"column-title"},"ğŸ‡¨ğŸ‡³ ä¸­æ–‡è¯‘æ–‡",-1)),e("button",{class:"re-translate-btn",onClick:xe,title:"é‡æ–°ç¿»è¯‘æ­¤æ°”æ³¡"}," ğŸ”„ ")]),ae(e("textarea",{ref_key:"translatedTextInput",ref:x,"onUpdate:modelValue":O[2]||(O[2]=re=>c.value=re),class:"text-editor translated-editor",placeholder:"ç¿»è¯‘åçš„ä¸­æ–‡...",spellcheck:"false",onInput:f},null,544),[[we,c.value]]),e("div",{class:"text-actions"},[e("button",{class:"copy-btn",onClick:S},"ğŸ“‹ å¤åˆ¶"),e("button",{class:"apply-text-btn",onClick:Ee},"âœ“ åº”ç”¨æ–‡æœ¬")])]),e("div",iv,[e("div",rv,[e("div",uv,[e("div",cv,[O[15]||(O[15]=e("label",null,"å­—ä½“",-1)),Ce(We,{modelValue:k.value,"onUpdate:modelValue":O[3]||(O[3]=re=>k.value=re),groups:B.value,title:"å­—ä½“",onChange:u},null,8,["modelValue","groups"])]),e("div",dv,[O[16]||(O[16]=e("label",null,"å­—å·",-1)),e("div",gv,[ae(e("input",{type:"number","onUpdate:modelValue":O[4]||(O[4]=re=>p.value=re),class:"toolbar-fontsize-input",min:H(sn),max:H(nn),step:H(ro),title:"å­—å·",onChange:w},null,40,pv),[[we,p.value,void 0,{number:!0}]]),e("div",{class:"toolbar-fontsize-btns"},[e("button",{class:"toolbar-fontsize-btn",onClick:G,title:"å¢å¤§å­—å·"}," A+ "),e("button",{class:"toolbar-fontsize-btn",onClick:Y,title:"å‡å°å­—å·"}," A- ")])])])]),e("div",mv,[e("div",vv,[e("button",{class:"toolbar-btn","data-active":y.value==="vertical",onClick:O[5]||(O[5]=re=>h("vertical")),title:"ç«–å‘æ’ç‰ˆ"},[...O[17]||(O[17]=[e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("path",{d:"M8 2v12M8 2L5 5M8 2l3 3",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])],8,fv),e("button",{class:"toolbar-btn","data-active":y.value==="horizontal",onClick:O[6]||(O[6]=re=>h("horizontal")),title:"æ¨ªå‘æ’ç‰ˆ"},[...O[18]||(O[18]=[e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("path",{d:"M2 8h12M14 8l-3-3M14 8l-3 3",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])],8,bv)]),O[24]||(O[24]=e("div",{class:"toolbar-divider vertical"},null,-1)),e("div",hv,[e("div",yv,[e("button",{class:"toolbar-btn toolbar-color-btn",onClick:le},[O[19]||(O[19]=e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("text",{x:"3",y:"11","font-size":"10","font-weight":"bold",fill:"currentColor"},"A")],-1)),e("span",{class:"color-indicator",style:at({background:$.value})},null,4)]),ae(e("input",{ref_key:"textColorInput",ref:_,type:"color","onUpdate:modelValue":O[7]||(O[7]=re=>$.value=re),class:"hidden-color-input",onInput:I,onChange:I},null,544),[[we,$.value]])])]),O[25]||(O[25]=e("div",{class:"toolbar-divider vertical"},null,-1)),e("div",xv,[Ce(We,{modelValue:V.value,"onUpdate:modelValue":O[8]||(O[8]=re=>V.value=re),options:d,onChange:ee},null,8,["modelValue"]),e("div",{class:Ie(["toolbar-color-picker toolbar-solid-color-options",{hidden:V.value!=="solid"}])},[e("button",{class:"toolbar-btn toolbar-color-btn",onClick:j},[O[20]||(O[20]=e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("rect",{x:"2",y:"2",width:"12",height:"12",rx:"2",fill:"none",stroke:"currentColor","stroke-width":"1.2"}),e("rect",{x:"4",y:"4",width:"8",height:"8",rx:"1",fill:"currentColor",opacity:"0.3"})],-1)),e("span",{class:"color-indicator",style:at({background:E.value})},null,4)]),ae(e("input",{ref_key:"fillColorInput",ref:K,type:"color","onUpdate:modelValue":O[9]||(O[9]=re=>E.value=re),class:"hidden-color-input",onChange:ce},null,544),[[we,E.value]])],2)]),O[26]||(O[26]=e("div",{class:"toolbar-divider vertical"},null,-1)),e("div",_v,[e("button",{class:"toolbar-btn","data-active":R.value,onClick:$e,title:"æ–‡å­—æè¾¹"},[...O[21]||(O[21]=[e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("text",{x:"3",y:"12","font-size":"11","font-weight":"bold",stroke:"currentColor","stroke-width":"2",fill:"none"}," A "),e("text",{x:"3",y:"12","font-size":"11","font-weight":"bold",fill:"currentColor"},"A")],-1)])],8,Cv),e("div",{class:Ie(["toolbar-color-picker toolbar-stroke-options",{hidden:!R.value}]),title:"æè¾¹é¢œè‰²"},[e("button",{class:"toolbar-btn toolbar-color-btn",onClick:ye},[O[22]||(O[22]=e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("circle",{cx:"8",cy:"8",r:"5",fill:"none",stroke:"currentColor","stroke-width":"2"})],-1)),e("span",{class:"color-indicator",style:at({background:D.value})},null,4)]),ae(e("input",{ref_key:"strokeColorInput",ref:z,type:"color","onUpdate:modelValue":O[10]||(O[10]=re=>D.value=re),class:"hidden-color-input",onChange:De},null,544),[[we,D.value]])],2),e("div",{class:Ie(["toolbar-stroke-width toolbar-stroke-options",{hidden:!R.value}]),title:"æè¾¹å®½åº¦"},[ae(e("input",{type:"number","onUpdate:modelValue":O[11]||(O[11]=re=>T.value=re),class:"toolbar-mini-input",min:"0",max:"10",onChange:he},null,544),[[we,T.value,void 0,{number:!0}]]),O[23]||(O[23]=e("span",{class:"toolbar-unit"},"px",-1))],2)])]),e("div",Sv,[e("div",kv,[e("button",{class:"toolbar-btn",onClick:J,title:"é€†æ—¶é’ˆæ—‹è½¬"},[...O[27]||(O[27]=[e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("path",{d:"M2 8a6 6 0 1 1 1.5 4",stroke:"currentColor","stroke-width":"1.5",fill:"none"}),e("path",{d:"M2 5v3.5h3.5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),ae(e("input",{type:"number","onUpdate:modelValue":O[12]||(O[12]=re=>q.value=re),class:"toolbar-mini-input toolbar-rotation-input",min:"-180",max:"180",step:"5",onChange:b},null,544),[[we,q.value,void 0,{number:!0}]]),O[29]||(O[29]=e("span",{class:"toolbar-unit"},"Â°",-1)),e("button",{class:"toolbar-btn",onClick:ve,title:"é¡ºæ—¶é’ˆæ—‹è½¬"},[...O[28]||(O[28]=[e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("path",{d:"M14 8a6 6 0 1 0-1.5 4",stroke:"currentColor","stroke-width":"1.5",fill:"none"}),e("path",{d:"M14 5v3.5h-3.5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),e("button",{class:"toolbar-btn toolbar-small-btn",onClick:fe,title:"é‡ç½®æ—‹è½¬"}," 0 ")]),O[35]||(O[35]=e("div",{class:"toolbar-divider vertical"},null,-1)),e("div",wv,[e("button",{class:"toolbar-btn",onClick:F,title:"å·¦ç§»"},[...O[30]||(O[30]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("path",{d:"M10 3L5 8l5 5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),e("button",{class:"toolbar-btn",onClick:ne,title:"å³ç§»"},[...O[31]||(O[31]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("path",{d:"M6 3l5 5-5 5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),e("button",{class:"toolbar-btn",onClick:be,title:"ä¸Šç§»"},[...O[32]||(O[32]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("path",{d:"M3 10l5-5 5 5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),e("button",{class:"toolbar-btn",onClick:ge,title:"ä¸‹ç§»"},[...O[33]||(O[33]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("path",{d:"M3 6l5 5 5-5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),e("span",$v,[e("span",null,oe(W.value),1),O[34]||(O[34]=me(",",-1)),e("span",null,oe(te.value),1)]),e("button",{class:"toolbar-btn toolbar-small-btn",onClick:Pe,title:"é‡ç½®ä½ç½®"}," âŒ‚ ")])])]),e("details",Tv,[O[36]||(O[36]=e("summary",null,"å­—å·é¢„è®¾",-1)),e("div",Iv,[(M(!0),A(Oe,null,Ye(H(vs),re=>(M(),A("button",{key:re,class:Ie(["preset-btn",{active:p.value===re}]),onClick:Te=>N(re)},oe(re),11,Pv))),128))])]),e("div",{class:"edit-action-buttons"},[e("button",{class:"btn-apply",onClick:Ee},"åº”ç”¨"),e("button",{class:"btn-apply-all",onClick:Le},"åº”ç”¨å…¨éƒ¨"),e("button",{class:"btn-reset",onClick:ke},"é‡ç½®")])])]))}}),Dv=He(Rv,[["__scopeId","data-v-edcb1ca9"]]),Mv={class:"edit-toolbar-wrapper"},Ev={class:"edit-toolbar toolbar-row-1"},Bv={class:"image-navigator"},Av=["disabled"],Lv=["disabled"],Fv={class:"bubble-navigator"},Uv=["disabled"],Ov={class:"bubble-indicator"},zv={id:"currentBubbleNum"},Nv={id:"totalBubbleNum"},Vv=["disabled"],Wv={class:"view-controls"},Kv={key:0,viewBox:"0 0 20 20",width:"16",height:"16"},qv={key:1,viewBox:"0 0 20 20",width:"16",height:"16"},Hv={id:"zoomLevel"},jv={class:"edit-toolbar toolbar-row-2"},Jv={class:"annotation-tools"},Yv=["disabled"],Xv=["disabled"],Gv={key:0,class:"brush-size-indicator"},Zv={key:1,class:"brush-mode-hint"},Qv={class:"edit-progress-info"},ef={class:"edit-progress-text"},tf={class:"edit-progress-count"},of={class:"edit-progress-bar"},nf={class:"quick-actions"},sf=je({__name:"EditToolbar",props:{currentImageIndex:{},imageCount:{},canGoPrevious:{type:Boolean},canGoNext:{type:Boolean},showThumbnails:{type:Boolean},hasBubbles:{type:Boolean},selectedBubbleIndex:{},bubbleCount:{},layoutMode:{},syncEnabled:{type:Boolean},scale:{},isDrawingMode:{type:Boolean},hasSelection:{type:Boolean},brushMode:{},brushSize:{},mouseX:{},mouseY:{},isProcessing:{type:Boolean},progressText:{},progressCurrent:{},progressTotal:{}},emits:["go-previous-image","go-next-image","toggle-thumbnails","select-previous-bubble","select-next-bubble","toggle-layout","toggle-view-mode","toggle-sync","fit-to-screen","zoom-in","zoom-out","reset-zoom","exit-edit-mode","auto-detect-bubbles","detect-all-images","translate-with-bubbles","toggle-drawing-mode","delete-selected-bubbles","repair-selected-bubble","activate-repair-brush","activate-restore-brush","apply-and-next"],setup(n){const t=n,s=Z(()=>t.progressTotal===0?0:Math.round(t.progressCurrent/t.progressTotal*100)),o=Z(()=>t.progressTotal>0&&t.progressCurrent>=t.progressTotal),i=Z(()=>{const r=t.brushMode==="repair"?{fill:"rgba(76, 175, 80, 0.4)",border:"#4CAF50"}:{fill:"rgba(33, 150, 243, 0.4)",border:"#2196F3"};return{position:"fixed",left:`${t.mouseX}px`,top:`${t.mouseY}px`,width:`${t.brushSize}px`,height:`${t.brushSize}px`,borderRadius:"50%",border:`2px solid ${r.border}`,backgroundColor:r.fill,pointerEvents:"none",zIndex:99999,transform:"translate(-50%, -50%)",display:t.brushMode?"block":"none"}});return(r,a)=>(M(),A("div",Mv,[e("div",Ev,[e("div",Bv,[e("button",{class:"nav-btn",disabled:!n.canGoPrevious,onClick:a[0]||(a[0]=c=>r.$emit("go-previous-image")),title:"ä¸Šä¸€å¼ å›¾ç‰‡ (PageUp)"}," â—€â—€ ",8,Av),e("span",{class:"image-indicator",onClick:a[1]||(a[1]=c=>r.$emit("toggle-thumbnails")),title:"ç‚¹å‡»å±•å¼€ç¼©ç•¥å›¾"},[a[23]||(a[23]=me(" å›¾ ",-1)),e("span",null,oe(n.currentImageIndex+1),1),a[24]||(a[24]=me(" / ",-1)),e("span",null,oe(n.imageCount),1)]),e("button",{class:"nav-btn",disabled:!n.canGoNext,onClick:a[2]||(a[2]=c=>r.$emit("go-next-image")),title:"ä¸‹ä¸€å¼ å›¾ç‰‡ (PageDown)"}," â–¶â–¶ ",8,Lv),e("button",{class:Ie(["thumb-toggle-btn",{active:n.showThumbnails}]),onClick:a[3]||(a[3]=c=>r.$emit("toggle-thumbnails")),title:"æ˜¾ç¤º/éšè—ç¼©ç•¥å›¾"}," â˜· ",2)]),a[30]||(a[30]=e("div",{class:"toolbar-divider"},null,-1)),e("div",Fv,[e("button",{id:"prevBubbleBtn",class:"nav-btn",disabled:!n.hasBubbles||n.selectedBubbleIndex<=0,onClick:a[4]||(a[4]=c=>r.$emit("select-previous-bubble")),title:"ä¸Šä¸€ä¸ªæ°”æ³¡ (â†)"}," â—€ ",8,Uv),e("span",Ov,[a[25]||(a[25]=me(" æ°”æ³¡ ",-1)),e("span",zv,oe(n.selectedBubbleIndex>=0?n.selectedBubbleIndex+1:0),1),a[26]||(a[26]=me(" / ",-1)),e("span",Nv,oe(n.bubbleCount),1)]),e("button",{id:"nextBubbleBtn",class:"nav-btn",disabled:!n.hasBubbles||n.selectedBubbleIndex>=n.bubbleCount-1,onClick:a[5]||(a[5]=c=>r.$emit("select-next-bubble")),title:"ä¸‹ä¸€ä¸ªæ°”æ³¡ (â†’)"}," â–¶ ",8,Vv)]),a[31]||(a[31]=e("div",{class:"toolbar-divider"},null,-1)),e("div",Wv,[e("button",{class:"layout-toggle-btn",onClick:a[6]||(a[6]=c=>r.$emit("toggle-layout")),title:"åˆ‡æ¢å¸ƒå±€ï¼šå·¦å³/ä¸Šä¸‹"},[n.layoutMode==="horizontal"?(M(),A("svg",Kv,[...a[27]||(a[27]=[e("rect",{x:"1",y:"2",width:"8",height:"16",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"},null,-1),e("rect",{x:"11",y:"2",width:"8",height:"16",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"},null,-1)])])):(M(),A("svg",qv,[...a[28]||(a[28]=[e("rect",{x:"2",y:"1",width:"16",height:"8",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"},null,-1),e("rect",{x:"2",y:"11",width:"16",height:"8",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"},null,-1)])]))]),e("button",{class:"view-mode-btn",onClick:a[7]||(a[7]=c=>r.$emit("toggle-view-mode")),title:"åˆ‡æ¢è§†å›¾æ¨¡å¼"},[...a[29]||(a[29]=[e("span",{class:"dual-icon"},"â§‰",-1)])]),e("button",{class:Ie({active:n.syncEnabled}),onClick:a[8]||(a[8]=c=>r.$emit("toggle-sync")),title:"åŒæ­¥ç¼©æ”¾/æ‹–åŠ¨",style:{"font-size":"12px"}}," ğŸ”— ",2),e("button",{onClick:a[9]||(a[9]=c=>r.$emit("fit-to-screen")),title:"é€‚åº”å±å¹• (åŒå‡»)"},"â›¶"),e("button",{onClick:a[10]||(a[10]=c=>r.$emit("zoom-in")),title:"æ”¾å¤§ (+)"},"+"),e("span",Hv,oe(Math.round(n.scale*100))+"%",1),e("button",{onClick:a[11]||(a[11]=c=>r.$emit("zoom-out")),title:"ç¼©å° (-)"},"âˆ’"),e("button",{onClick:a[12]||(a[12]=c=>r.$emit("reset-zoom")),title:"åŸå§‹å¤§å°"},"1:1")]),a[32]||(a[32]=e("div",{class:"toolbar-spacer"},null,-1)),e("button",{class:"secondary-btn",onClick:a[13]||(a[13]=c=>r.$emit("exit-edit-mode"))},"é€€å‡ºç¼–è¾‘")]),e("div",jv,[e("div",Jv,[e("button",{class:"annotation-btn detect-btn",onClick:a[14]||(a[14]=c=>r.$emit("auto-detect-bubbles")),title:"è‡ªåŠ¨æ£€æµ‹å½“å‰å›¾ç‰‡çš„æ–‡æœ¬æ¡†"},[...a[33]||(a[33]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("circle",{cx:"6",cy:"6",r:"4",fill:"none",stroke:"currentColor","stroke-width":"1.5"}),e("path",{d:"M9 9l4 4",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round"})],-1),e("span",null,"æ£€æµ‹",-1)])]),e("button",{class:"annotation-btn detect-btn",onClick:a[15]||(a[15]=c=>r.$emit("detect-all-images")),title:"æ‰¹é‡æ£€æµ‹æ‰€æœ‰å›¾ç‰‡"},[...a[34]||(a[34]=[go('<svg viewBox="0 0 16 16" width="14" height="14" data-v-b7164359><circle cx="5" cy="5" r="2.5" fill="none" stroke="currentColor" stroke-width="1" data-v-b7164359></circle><path d="M7 7l2 2" stroke="currentColor" stroke-width="1" stroke-linecap="round" data-v-b7164359></path><circle cx="10" cy="10" r="2.5" fill="none" stroke="currentColor" stroke-width="1" data-v-b7164359></circle><path d="M12 12l2 2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" data-v-b7164359></path></svg><span data-v-b7164359>æ‰¹é‡æ£€æµ‹</span>',2)])]),e("button",{class:"annotation-btn primary-action-btn",onClick:a[16]||(a[16]=c=>r.$emit("translate-with-bubbles")),title:"ä½¿ç”¨å½“å‰æ–‡æœ¬æ¡†ç¿»è¯‘æ­¤å›¾ç‰‡"},[...a[35]||(a[35]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("path",{d:"M2 3h5M4.5 3v7M2 6h5",stroke:"currentColor","stroke-width":"1.2",fill:"none"}),e("path",{d:"M9 13l2-7 2 7M9.5 11h3",stroke:"currentColor","stroke-width":"1.2",fill:"none"})],-1),e("span",null,"ç¿»è¯‘",-1)])]),a[41]||(a[41]=e("div",{class:"toolbar-divider"},null,-1)),e("button",{class:Ie(["annotation-btn",{active:n.isDrawingMode}]),onClick:a[17]||(a[17]=c=>r.$emit("toggle-drawing-mode")),title:"æ·»åŠ æ°”æ³¡æ¡†ï¼ˆæˆ–ä¸­é”®æ‹–æ‹½ç»˜åˆ¶ï¼‰"},[...a[36]||(a[36]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("rect",{x:"3",y:"3",width:"10",height:"10",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"}),e("path",{d:"M8 5v6M5 8h6",stroke:"currentColor","stroke-width":"1.5"})],-1),e("span",null,"æ·»åŠ ",-1)])],2),e("button",{class:"annotation-btn",disabled:!n.hasSelection,onClick:a[18]||(a[18]=c=>r.$emit("delete-selected-bubbles")),title:"åˆ é™¤é€‰ä¸­æ°”æ³¡æ¡† (Delete)"},[...a[37]||(a[37]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("rect",{x:"3",y:"3",width:"10",height:"10",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"}),e("path",{d:"M5 8h6",stroke:"currentColor","stroke-width":"1.5"})],-1),e("span",null,"åˆ é™¤",-1)])],8,Yv),e("button",{class:"annotation-btn",disabled:!n.hasSelection,onClick:a[19]||(a[19]=c=>r.$emit("repair-selected-bubble")),title:"ä¿®å¤é€‰ä¸­æ°”æ³¡èƒŒæ™¯ (R)"},[...a[38]||(a[38]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("path",{d:"M2 14l3-3m0 0l6-6 3 3-6 6m-3 0l-1 1 1-1z",fill:"none",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round"}),e("path",{d:"M11 5l-1-1 2-2 2 2-2 2-1-1z",fill:"currentColor"})],-1),e("span",null,"ä¿®å¤",-1)])],8,Xv),a[42]||(a[42]=e("div",{class:"toolbar-divider"},null,-1)),e("button",{class:Ie(["annotation-btn brush-btn",{active:n.brushMode==="repair"}]),onClick:a[20]||(a[20]=c=>r.$emit("activate-repair-brush")),title:"ä¿®å¤ç¬”åˆ· (æŒ‰ä½R+å·¦é”®æ‹–æ‹½)"},[...a[39]||(a[39]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("circle",{cx:"8",cy:"8",r:"5",fill:"none",stroke:"currentColor","stroke-width":"1.5"}),e("circle",{cx:"8",cy:"8",r:"2",fill:"currentColor"})],-1),e("span",null,"ä¿®å¤ç¬”åˆ·",-1)])],2),e("button",{class:Ie(["annotation-btn brush-btn",{active:n.brushMode==="restore"}]),onClick:a[21]||(a[21]=c=>r.$emit("activate-restore-brush")),title:"è¿˜åŸç¬”åˆ· (æŒ‰ä½U+å·¦é”®æ‹–æ‹½)"},[...a[40]||(a[40]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("circle",{cx:"8",cy:"8",r:"5",fill:"none",stroke:"currentColor","stroke-width":"1.5"}),e("path",{d:"M5 8h6M8 5v6",stroke:"currentColor","stroke-width":"1",transform:"rotate(45 8 8)"})],-1),e("span",null,"è¿˜åŸç¬”åˆ·",-1)])],2),n.brushMode?(M(),A("span",Gv," ç¬”åˆ·: "+oe(n.brushSize)+"px ",1)):de("",!0),a[43]||(a[43]=go('<div class="help-tooltip-container" data-v-b7164359><button class="help-tooltip-btn" title="å¿«æ·é”®æ“ä½œå¸®åŠ©" data-v-b7164359><svg viewBox="0 0 16 16" width="14" height="14" data-v-b7164359><circle cx="8" cy="8" r="6.5" fill="none" stroke="currentColor" stroke-width="1.2" data-v-b7164359></circle><text x="8" y="11" text-anchor="middle" font-size="9" font-weight="bold" fill="currentColor" data-v-b7164359>?</text></svg><span class="help-btn-text" data-v-b7164359>å¿«æ·é”®</span></button><div class="help-tooltip-popup" data-v-b7164359><div class="help-section" data-v-b7164359><div class="help-title" data-v-b7164359>ğŸ–±ï¸ é¼ æ ‡æ“ä½œ</div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>å·¦é”®ç‚¹å‡»æ°”æ³¡</span><span class="help-desc" data-v-b7164359>é€‰æ‹©æ°”æ³¡</span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>Shift+å·¦é”®ç‚¹å‡»</span><span class="help-desc" data-v-b7164359>å¤šé€‰æ°”æ³¡</span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>å·¦é”®æ‹–æ‹½å››è§’/è¾¹</span><span class="help-desc" data-v-b7164359>è°ƒæ•´å¤§å°</span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>å·¦é”®æ‹–æ‹½æ¡†å†…éƒ¨</span><span class="help-desc" data-v-b7164359>ç§»åŠ¨æ°”æ³¡æ¡†</span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>ä¸­é”®æ‹–æ‹½</span><span class="help-desc" data-v-b7164359>ç»˜åˆ¶æ–°æ°”æ³¡æ¡†</span></div></div><div class="help-section" data-v-b7164359><div class="help-title" data-v-b7164359>âŒ¨ï¸ å¿«æ·é”®</div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>A / D</span><span class="help-desc" data-v-b7164359>åˆ‡æ¢ä¸Š/ä¸‹ä¸€å¼ å›¾ç‰‡</span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>Ctrl+Enter</span><span class="help-desc" data-v-b7164359>åº”ç”¨å¹¶è·³è½¬ä¸‹ä¸€å¼ </span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>Delete / Backspace</span><span class="help-desc" data-v-b7164359>åˆ é™¤é€‰ä¸­æ°”æ³¡</span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>æŒ‰ä½R+å·¦é”®æ‹–æ‹½</span><span class="help-desc" data-v-b7164359>ä¿®å¤ç¬”åˆ·</span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>æŒ‰ä½U+å·¦é”®æ‹–æ‹½</span><span class="help-desc" data-v-b7164359>è¿˜åŸç¬”åˆ·</span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>ç¬”åˆ·æ¨¡å¼ä¸‹æ»šè½®</span><span class="help-desc" data-v-b7164359>è°ƒæ•´ç¬”åˆ·å¤§å°</span></div></div></div></div>',1))]),n.brushMode?(M(),A("div",{key:0,class:"brush-cursor",style:at(i.value)},null,4)):de("",!0),n.brushMode?(M(),A("div",Zv,oe(n.brushMode==="repair"?"ä¿®å¤ç¬”åˆ· (R)":"è¿˜åŸç¬”åˆ· (U)")+" - æ»šè½®è°ƒæ•´å¤§å° ",1)):de("",!0),n.isProcessing?(M(),A("div",{key:2,class:Ie(["edit-progress-container",{completed:o.value}])},[e("div",Qv,[e("span",ef,oe(n.progressText),1),e("span",tf,oe(n.progressCurrent)+"/"+oe(n.progressTotal),1)]),e("div",of,[e("div",{class:Ie(["edit-progress-fill",{animating:!o.value}]),style:at({width:s.value+"%"})},null,6)])],2)):de("",!0),a[44]||(a[44]=e("div",{class:"toolbar-spacer"},null,-1)),e("div",nf,[e("button",{class:"primary-btn",onClick:a[22]||(a[22]=c=>r.$emit("apply-and-next")),title:"åº”ç”¨æ›´æ”¹å¹¶è·³è½¬ä¸‹ä¸€å¼  (Ctrl+Enter)"}," åº”ç”¨å¹¶ä¸‹ä¸€å¼  ")])])]))}}),af=He(sf,[["__scopeId","data-v-b7164359"]]),lf={key:0,class:"edit-thumbnails-panel"},rf={class:"thumbnails-scroll"},uf=["onClick"],cf=["src","alt"],df={class:"thumb-index"},gf=je({__name:"EditThumbnailPanel",props:{visible:{type:Boolean},images:{},currentImageIndex:{}},emits:["switch-to-image"],setup(n){return(t,s)=>n.visible?(M(),A("div",lf,[e("div",rf,[(M(!0),A(Oe,null,Ye(n.images,(o,i)=>(M(),A("div",{key:o.id,class:Ie(["edit-thumbnail-item",{active:i===n.currentImageIndex}]),onClick:r=>t.$emit("switch-to-image",i)},[e("img",{src:o.translatedDataURL||o.originalDataURL,alt:`å›¾ç‰‡ ${i+1}`},null,8,cf),e("span",df,oe(i+1),1)],10,uf))),128))])])):de("",!0)}}),pf=He(gf,[["__scopeId","data-v-9d2a43d9"]]),mf=["data-brush-mode"],vf={class:"edit-main-layout"},ff={class:"image-comparison-container"},bf={class:"panel-header"},hf=["src"],yf={class:"panel-header"},xf=["src"],_f=je({__name:"EditWorkspace",props:{isEditModeActive:{type:Boolean}},emits:["exit"],setup(n,{emit:t}){const s=n,o=t,i=et(),r=gt(),{translateWithCurrentBubbles:a}=Do(),{reRenderFullImage:c}=hm({onRenderStart:()=>console.log("å¼€å§‹é‡æ–°æ¸²æŸ“..."),onRenderSuccess:Q=>console.log("æ¸²æŸ“æˆåŠŸ:",Q.substring(0,50)+"..."),onRenderError:Q=>console.error("æ¸²æŸ“å¤±è´¥:",Q)}),{isDrawingMode:p,isDrawingBox:k,currentDrawingRect:y,isMiddleButtonDown:$,handleBubbleSelect:E,handleBubbleMultiSelect:R,handleClearMultiSelect:D,handleBubbleDragStart:T,handleBubbleDragging:q,handleBubbleDragEnd:V,handleBubbleResizeStart:L,handleBubbleResizing:v,handleBubbleResizeEnd:g,handleBubbleRotateStart:x,handleBubbleRotating:_,handleBubbleRotateEnd:K,toggleDrawingMode:z,handleDrawBubble:se,getDrawingRectStyle:X,handleBubbleUpdate:ie,deleteSelectedBubbles:U,repairSelectedBubble:W,handleOcrRecognize:te}=bm({onReRender:()=>c(),onDelayedPreview:()=>c()}),B=C(0),d=C(0),{brushMode:m,brushSize:l,mouseX:f,mouseY:P,isBrushKeyDown:S,toggleBrushMode:w,exitBrushMode:N,startBrushPainting:G,continueBrushPainting:Y,finishBrushPainting:u,adjustBrushSize:h}=vm({onBrushComplete:()=>c(),getCurrentRepairSettings:()=>({inpaintMethod:Ae.value,fillColor:O.value})}),{images:le,currentImageIndex:I,currentImage:j,imageCount:ce,canGoPrevious:ye,canGoNext:De}=kt(i),{bubbles:$e,selectedIndex:he,selectedIndices:ee,selectedBubble:b,bubbleCount:J,hasBubbles:ve,hasSelection:fe}=kt(r),F=Z(()=>Pe.value?.querySelector("img")?.naturalWidth||2e3),ne=Z(()=>Pe.value?.querySelector("img")?.naturalHeight||2e3),be=C(null),ge=C(null),Pe=C(null),Ee=C(null),Le=C(null),ke=C(null),Be=C("dual"),xe=C("horizontal"),it=C(!1),Ge=C(!0),Ze=C(!1),st=C(!1),Ae=C("solid"),O=C("#FFFFFF"),re=C(!1),Te=C("å¤„ç†ä¸­..."),Re=C(0),tt=C(0),qe=hn(),Qe=hn(),ht=Z(()=>Qe.scale.value),ot=Z(()=>Qe.translateX.value),On=Z(()=>Qe.translateY.value),zn=Z(()=>qe.scale.value),_t=C(null),Nn=Z(()=>({transform:`translate(${qe.translateX.value}px, ${qe.translateY.value}px) scale(${qe.scale.value})`})),Vn=Z(()=>({transform:`translate(${Qe.translateX.value}px, ${Qe.translateY.value}px) scale(${Qe.scale.value})`}));function Mo(){Qe.zoomIn(),Ge.value&&qe.setTransform(Qe.getTransform())}function Eo(){Qe.zoomOut(),Ge.value&&qe.setTransform(Qe.getTransform())}function Bo(){Qe.resetZoom(),Ge.value&&qe.setTransform(Qe.getTransform())}const Yt=C(!1),Wn=C(0),Xt=C(!1),Mt=C({x:0,y:0,size:0});function Gt(){m.value&&N(),eo()}function Zt(){r.bubbles.length>0&&r.selectBubble(0)}function Ao(){ye.value&&(Gt(),i.goToPrevious())}function Qt(){De.value&&(Gt(),i.goToNext())}function Kn(Q){Q!==I.value&&Q>=0&&Q<ce.value&&(Gt(),i.setCurrentImageIndex(Q))}function eo(){if(!j.value)return;const Q=Array.isArray(j.value.bubbleStates);$e.value.length>0?(i.updateCurrentBubbleStates([...$e.value]),i.setManuallyAnnotated(!0),console.log("å·²ä¿å­˜æ°”æ³¡çŠ¶æ€åˆ°å½“å‰å›¾ç‰‡ï¼Œæ ‡è®°ä¸ºæ‰‹åŠ¨æ ‡æ³¨")):Q&&(i.updateCurrentBubbleStates([]),i.setManuallyAnnotated(!0),console.log("å·²ä¿å­˜ç©ºæ°”æ³¡çŠ¶æ€åˆ°å½“å‰å›¾ç‰‡ï¼ˆç”¨æˆ·ä¸»åŠ¨æ¸…ç©ºï¼Œæ ‡è®°ä¸ºæ‰‹åŠ¨æ ‡æ³¨ï¼‰"))}function Et(){j.value?.bubbleStates?(r.setBubbles([...j.value.bubbleStates],!0),console.log(`å·²åŠ è½½ ${j.value.bubbleStates.length} ä¸ªæ°”æ³¡çŠ¶æ€`)):r.clearBubblesLocal(),Zt()}function qn(){r.selectPrevious()}function Hn(){r.selectNext()}function jn(){it.value=!it.value}function Jn(){xe.value=xe.value==="horizontal"?"vertical":"horizontal";try{localStorage.setItem(an,xe.value)}catch(Q){console.warn("ä¿å­˜å¸ƒå±€æ¨¡å¼å¤±è´¥:",Q)}setTimeout(()=>{Bt()},300)}function Yn(){const Q=["dual","original","translated"],ue=Q.indexOf(Be.value),pe=Q[(ue+1)%Q.length];pe&&(Be.value=pe)}function Xn(){Ge.value=!Ge.value,console.log("åŒå›¾åŒæ­¥:",Ge.value?"å¼€å¯":"å…³é—­"),Ge.value&&qe.setTransform(Qe.getTransform())}function Bt(){const Q=Ee.value||ge.value,ue=Le.value||Pe.value;if(!Q||!ue)return;const pe=ue.querySelector("img");if(!pe||!pe.naturalWidth)return;const Je=Q.getBoundingClientRect(),Ne=Je.width/pe.naturalWidth,Me=Je.height/pe.naturalHeight,Ve=Math.min(Ne,Me)*.95,Ue=(Je.width-pe.naturalWidth*Ve)/2,yt=(Je.height-pe.naturalHeight*Ve)/2,Ct={scale:Ve,translateX:Ue,translateY:yt};Qe.setTransform(Ct),qe.setTransform(Ct)}function Lo(Q,ue){if(m.value){const Ue=Q.deltaY>0?-5:5;h(Ue);return}const pe=Q.currentTarget.getBoundingClientRect(),Je=Q.clientX-pe.left,Ne=Q.clientY-pe.top,Me=Q.deltaY>0?.9:1.1,Ve=ue==="original"?qe:Qe;Ve.zoomAt(Je,Ne,Me),Ge.value&&(ue==="original"?Qe:qe).setTransform(Ve.getTransform())}function Fo(Q,ue){if(m.value){const pe=ue==="original"?ge.value:Ee.value;pe&&G(Q,pe);return}if(Q.button===1){$.value=!0,zo(Q,ue),Q.preventDefault();return}if(p.value&&Q.button===0){zo(Q,ue),Q.preventDefault();return}if(Q.button===0){if(Q.target.closest(".bubble-highlight-box"))return;Q.shiftKey||D(),_t.value=ue,(ue==="original"?qe:Qe).startDrag(Q.clientX,Q.clientY),document.addEventListener("mousemove",Uo),document.addEventListener("mouseup",Oo),Q.preventDefault()}}function Uo(Q){if(!_t.value)return;const ue=_t.value==="original"?qe:Qe;ue.drag(Q.clientX,Q.clientY),Ge.value&&(_t.value==="original"?Qe:qe).setTransform(ue.getTransform())}function Oo(){_t.value&&(_t.value==="original"?qe:Qe).endDrag(),_t.value=null,document.removeEventListener("mousemove",Uo),document.removeEventListener("mouseup",Oo)}let to="translated";function zo(Q,ue="translated"){to=ue;const pe=ue==="original"?Pe.value:Le.value,Je=ue==="original"?qe:Qe;if(!pe)return;const Ne=pe.getBoundingClientRect(),Me=(Q.clientX-Ne.left)/Je.scale.value,Ve=(Q.clientY-Ne.top)/Je.scale.value;B.value=Me,d.value=Ve,k.value=!0,y.value=[Me,Ve,Me,Ve],document.addEventListener("mousemove",oo),document.addEventListener("mouseup",no)}function oo(Q){if(!k.value)return;const ue=to==="original"?Pe.value:Le.value,pe=to==="original"?qe:Qe;if(!ue)return;const Je=ue.getBoundingClientRect(),Ne=(Q.clientX-Je.left)/pe.scale.value,Me=(Q.clientY-Je.top)/pe.scale.value;y.value=[Math.min(B.value,Ne),Math.min(d.value,Me),Math.max(B.value,Ne),Math.max(d.value,Me)]}function no(Q){document.removeEventListener("mousemove",oo),document.removeEventListener("mouseup",no);const ue=$.value;if(!k.value||!y.value){k.value=!1,y.value=null,$.value=!1;return}const[pe,Je,Ne,Me]=y.value,Ve=Ne-pe,Ue=Me-Je;Ve>10&&Ue>10&&(r.addBubble(y.value),r.selectBubble(r.bubbleCount-1),console.log("å·²æ·»åŠ æ–°æ°”æ³¡:",y.value)),k.value=!1,y.value=null,$.value=!1,!ue&&p.value&&(p.value=!1)}function No(Q){console.log(`${Q} å›¾ç‰‡åŠ è½½å®Œæˆ`),ht.value===1&&ot.value===0&&On.value===0&&pt(()=>{Bt()})}function Gn(){c()}function Zn(Q){Q.inpaintMethod!==void 0&&(Ae.value=Q.inpaintMethod),Q.fillColor!==void 0&&(O.value=Q.fillColor),he.value>=0&&ie(Q)}function Qn(Q){_e("æ–‡æœ¬å·²åº”ç”¨","success"),c()}function es(Q){const ue=r.initialStates[Q];if(!ue){console.warn(`æ— æ³•é‡ç½®æ°”æ³¡ #${Q+1}ï¼šæ‰¾ä¸åˆ°åˆå§‹çŠ¶æ€`),_e("æ— æ³•é‡ç½®ï¼šæ‰¾ä¸åˆ°åˆå§‹çŠ¶æ€","warning");return}const pe=JSON.parse(JSON.stringify(ue));r.updateBubble(Q,pe),console.log(`æ°”æ³¡ #${Q+1} å·²é‡ç½®åˆ°åˆå§‹çŠ¶æ€`),_e("æ°”æ³¡å·²é‡ç½®","success"),c()}async function ts(Q){const ue=$e.value[Q];if(!ue?.originalText){console.warn("æ— æ³•é‡æ–°ç¿»è¯‘ï¼šç¼ºå°‘æ°”æ³¡æˆ–åŸæ–‡");return}try{console.log(`å¼€å§‹é‡æ–°ç¿»è¯‘æ°”æ³¡ #${Q+1}`);const{translateSingleText:pe}=await rt(async()=>{const{translateSingleText:Ve}=await Promise.resolve().then(()=>Fs);return{translateSingleText:Ve}},void 0),{useSettingsStore:Je}=await rt(async()=>{const{useSettingsStore:Ve}=await import("./system.qIGXsO2R.js").then(Ue=>Ue.s);return{useSettingsStore:Ve}},__vite__mapDeps([0,1,2,3,4,5])),Ne=Je().settings,Me=await pe({original_text:ue.originalText,model_provider:Ne.translation.provider,api_key:Ne.translation.apiKey,model_name:Ne.translation.modelName,custom_base_url:Ne.translation.customBaseUrl,target_language:Ne.targetLanguage,prompt_content:void 0});Me.success&&Me.data?.translated_text?(r.updateBubble(Q,{translatedText:Me.data.translated_text}),console.log(`ç¿»è¯‘æˆåŠŸ: "${Me.data.translated_text}"`),c()):console.error("ç¿»è¯‘å¤±è´¥:",Me.error||"æœªçŸ¥é”™è¯¯")}catch(pe){console.error("ç¿»è¯‘å‡ºé”™:",pe)}}function Vo(Q,ue){for(Q.bubbleTexts||(Q.bubbleTexts=[]),Q.originalTexts||(Q.originalTexts=[]);Q.bubbleTexts.length<ue;)Q.bubbleTexts.push("");for(;Q.originalTexts.length<ue;)Q.originalTexts.push("")}function Wo(Q,ue,pe){const Je=Q.auto_directions||[];return Q.bubble_coords.map((Ne,Me)=>{const Ve=Ne[0]??0,Ue=Ne[1]??0,yt=Ne[2]??0,Ct=Ne[3]??0;let mt;return Je[Me]?mt=Je[Me]==="v"?"vertical":"horizontal":mt=Ct-Ue>yt-Ve?"vertical":"horizontal",{coords:Ne,originalText:ue.originalTexts?.[Me]||"",translatedText:ue.bubbleTexts?.[Me]||"",textboxText:"",fontSize:pe.fontSize,fontFamily:pe.fontFamily,textDirection:mt,autoTextDirection:mt,textColor:pe.textColor,fillColor:pe.fillColor,strokeEnabled:pe.strokeEnabled,strokeColor:pe.strokeColor,strokeWidth:pe.strokeWidth,rotationAngle:Q.bubble_angles?.[Me]||0,inpaintMethod:pe.inpaintMethod,position:{x:0,y:0},polygon:[]}})}async function os(){const Q=j.value;if(!Q?.originalDataURL){_e("æ²¡æœ‰æœ‰æ•ˆçš„å›¾ç‰‡ç”¨äºæ£€æµ‹","warning");return}try{_e("æ­£åœ¨è‡ªåŠ¨æ£€æµ‹æ–‡æœ¬æ¡†...","info");const pe=Q.originalDataURL.match(/^data:image\/[^;]+;base64,(.+)$/)?.[1]||"";if(!pe){_e("æ— æ³•è§£æå›¾ç‰‡æ•°æ®","error");return}const Je=ze(),{textDetector:Ne,boxExpand:Me,textStyle:Ve}=Je.settings,Ue=await po(pe,Ne,{box_expand_ratio:Me.ratio,box_expand_top:Me.top,box_expand_bottom:Me.bottom,box_expand_left:Me.left,box_expand_right:Me.right});if(Ue.success&&Ue.bubble_coords){i.updateCurrentImage({bubbleCoords:Ue.bubble_coords,bubbleAngles:Ue.bubble_angles||[]}),Vo(Q,Ue.bubble_coords.length);const yt={bubble_coords:Ue.bubble_coords.map(mt=>[...mt]),bubble_angles:Ue.bubble_angles,auto_directions:Ue.auto_directions},Ct=Wo(yt,Q,Ve);r.setBubbles(Ct),Zt(),_e(`è‡ªåŠ¨æ£€æµ‹åˆ° ${Ue.bubble_coords.length} ä¸ªæ–‡æœ¬æ¡†`,"success")}else _e(Ue.error||"æ£€æµ‹å¤±è´¥","error")}catch(ue){console.error("è‡ªåŠ¨æ£€æµ‹å¤±è´¥:",ue),_e("è‡ªåŠ¨æ£€æµ‹å¤±è´¥","error")}}async function ns(){if(le.value.length<=1){_e("è‡³å°‘éœ€è¦ä¸¤å¼ å›¾ç‰‡æ‰èƒ½æ‰§è¡Œæ‰¹é‡æ£€æµ‹","warning");return}if(!confirm("æ­¤æ“ä½œå°†å¯¹æ‰€æœ‰å›¾ç‰‡è¿›è¡Œæ–‡æœ¬æ¡†æ£€æµ‹ï¼Œå¯èƒ½ä¼šè¦†ç›–å·²æœ‰çš„æ£€æµ‹ç»“æœã€‚ç¡®å®šç»§ç»­å—ï¼Ÿ"))return;const Q=ze(),{textDetector:ue,boxExpand:pe,textStyle:Je}=Q.settings,Ne=I.value,Me=le.value.length;re.value=!0,Te.value="æ‰¹é‡æ£€æµ‹ä¸­",tt.value=Me,Re.value=0;try{let Ve=0;for(let Ue=0;Ue<Me;Ue++){const yt=le.value[Ue];if(!yt?.originalDataURL)continue;Re.value=Ue+1;const mt=yt.originalDataURL.match(/^data:image\/[^;]+;base64,(.+)$/)?.[1]||"";if(!mt)continue;const vt=await po(mt,ue,{box_expand_ratio:pe.ratio,box_expand_top:pe.top,box_expand_bottom:pe.bottom,box_expand_left:pe.left,box_expand_right:pe.right});if(vt.success&&vt.bubble_coords){const wt=le.value[Ue];if(wt){wt.bubbleCoords=vt.bubble_coords,wt.bubbleAngles=vt.bubble_angles||[],Vo(wt,vt.bubble_coords.length);const us={bubble_coords:vt.bubble_coords.map(cs=>[...cs]),bubble_angles:vt.bubble_angles,auto_directions:vt.auto_directions};wt.bubbleStates=Wo(us,wt,Je),Ve+=vt.bubble_coords.length,Ue===I.value&&Et()}}}Te.value="æ£€æµ‹å®Œæˆ",Re.value=Me,Ne!==I.value&&i.setCurrentImageIndex(Ne),Et(),_e(`æ‰¹é‡æ£€æµ‹å®Œæˆï¼å…±å¤„ç† ${Me} å¼ å›¾ç‰‡ï¼Œæ£€æµ‹åˆ° ${Ve} ä¸ªæ–‡æœ¬æ¡†`,"success"),setTimeout(()=>{re.value=!1},2e3)}catch(Ve){console.error("æ‰¹é‡æ£€æµ‹å¤±è´¥:",Ve),_e("æ‰¹é‡æ£€æµ‹å¤±è´¥","error"),re.value=!1}}async function ss(){if(!j.value?.originalDataURL){_e("æ²¡æœ‰æœ‰æ•ˆçš„å›¾ç‰‡ç”¨äºç¿»è¯‘","warning");return}if($e.value.length===0){_e("æ²¡æœ‰æ–‡æœ¬æ¡†å¯ç”¨äºç¿»è¯‘ï¼Œè¯·å…ˆæ£€æµ‹æˆ–æ·»åŠ æ–‡æœ¬æ¡†","warning");return}_e("æ­£åœ¨ä½¿ç”¨å½“å‰æ–‡æœ¬æ¡†ç¿»è¯‘...","info");try{await a()&&(_e("ç¿»è¯‘æˆåŠŸï¼","success"),Zt())}catch(ue){console.error("ç¿»è¯‘å¤±è´¥:",ue),_e(`ç¿»è¯‘å¤±è´¥: ${ue instanceof Error?ue.message:"æœªçŸ¥é”™è¯¯"}`,"error")}}function as(){w("repair")}function ls(){w("restore")}function Ko(Q){Y(Q)}function qo(){u()}function is(Q){Yt.value=!0,Wn.value=xe.value==="horizontal"?Q.clientX:Q.clientY,document.body.style.cursor=xe.value==="horizontal"?"col-resize":"row-resize",document.body.style.userSelect="none",document.addEventListener("mousemove",so),document.addEventListener("mouseup",ao),Q.preventDefault()}function so(Q){if(!Yt.value)return;const ue=ge.value?.parentElement?.parentElement;if(!ue)return;const pe=ue.getBoundingClientRect();if(xe.value==="horizontal"){const Je=Q.clientX-pe.left,Ne=pe.width,Me=Math.max(20,Math.min(80,Je/Ne*100)),Ve=ue.querySelector(".original-panel"),Ue=ue.querySelector(".translated-panel");Ve&&Ue&&(Ve.style.flex=`0 0 ${Me}%`,Ue.style.flex=`0 0 ${100-Me}%`)}else{const Je=Q.clientY-pe.top,Ne=pe.height,Me=Math.max(20,Math.min(80,Je/Ne*100)),Ve=ue.querySelector(".original-panel"),Ue=ue.querySelector(".translated-panel");Ve&&Ue&&(Ve.style.flex=`0 0 ${Me}%`,Ue.style.flex=`0 0 ${100-Me}%`)}}function ao(){Yt.value=!1,document.body.style.cursor="",document.body.style.userSelect="",document.removeEventListener("mousemove",so),document.removeEventListener("mouseup",ao)}function rs(Q){Xt.value=!0;const ue=ke.value;ue&&(Mt.value={x:Q.clientX,y:Q.clientY,size:xe.value==="horizontal"?ue.offsetWidth:ue.offsetHeight},document.body.style.cursor=xe.value==="horizontal"?"ew-resize":"ns-resize",document.body.style.userSelect="none",document.addEventListener("mousemove",lo),document.addEventListener("mouseup",io),Q.preventDefault())}function lo(Q){if(!(!Xt.value||!ke.value))if(xe.value==="horizontal"){const ue=Mt.value.x-Q.clientX;let pe=Mt.value.size+ue;pe=Math.max(300,Math.min(window.innerWidth*.6,pe)),ke.value.style.flex=`0 0 ${pe}px`,ke.value.style.minWidth=`${pe}px`}else{const ue=Mt.value.y-Q.clientY;let pe=Mt.value.size+ue;pe=Math.max(200,Math.min(window.innerHeight*.5,pe)),ke.value.style.flex=`0 0 ${pe}px`,ke.value.style.height=`${pe}px`}}function io(){Xt.value=!1,document.body.style.cursor="",document.body.style.userSelect="",document.removeEventListener("mousemove",lo),document.removeEventListener("mouseup",io)}function Ho(Q){const ue=Q.target,pe=Q.key.toLowerCase();if(pe==="r"||pe==="u"||pe==="a"||pe==="d"){if(ue.tagName==="TEXTAREA")return;(ue.tagName==="INPUT"||ue.tagName==="SELECT"||ue.tagName==="BUTTON")&&ue.blur()}else if(ue.tagName==="INPUT"||ue.tagName==="TEXTAREA"||ue.tagName==="SELECT")return;switch(Q.key){case"Escape":Yo();break;case"Delete":case"Backspace":!m.value&&fe.value&&(U(),Q.preventDefault());break;case"a":case"A":m.value||(Ao(),Q.preventDefault());break;case"d":case"D":m.value||(Qt(),Q.preventDefault());break;case"Enter":Q.ctrlKey&&!m.value&&(Jo(),Q.preventDefault());break;case"r":case"R":S.value||(w("repair"),Q.preventDefault());break;case"u":case"U":S.value||(w("restore"),Q.preventDefault());break;case"+":case"=":Mo(),Q.preventDefault();break;case"-":Eo(),Q.preventDefault();break;case"0":Bo(),Q.preventDefault();break}}function jo(Q){(Q.key==="r"||Q.key==="R"||Q.key==="u"||Q.key==="U")&&(N(),Q.preventDefault())}async function Jo(){eo(),await c(),De.value?Qt():_e("å·²æ˜¯æœ€åä¸€å¼ å›¾ç‰‡","info")}function Yo(){eo(),o("exit")}return dt(()=>{try{const Q=localStorage.getItem(an);(Q==="horizontal"||Q==="vertical")&&(xe.value=Q)}catch(Q){console.warn("åŠ è½½å¸ƒå±€æ¨¡å¼å¤±è´¥:",Q)}document.addEventListener("keydown",Ho),document.addEventListener("keyup",jo),document.addEventListener("mousemove",Ko),document.addEventListener("mouseup",qo),s.isEditModeActive&&(Et(),pt(()=>{be.value?.focus()}))}),Ot(()=>{document.removeEventListener("keydown",Ho),document.removeEventListener("keyup",jo),document.removeEventListener("mousemove",Ko),document.removeEventListener("mouseup",qo),document.removeEventListener("mousemove",oo),document.removeEventListener("mouseup",no),document.removeEventListener("mousemove",so),document.removeEventListener("mouseup",ao),document.removeEventListener("mousemove",lo),document.removeEventListener("mouseup",io)}),Se(()=>s.isEditModeActive,Q=>{Q&&(Et(),pt(()=>{be.value?.focus()}))}),Se(I,()=>{s.isEditModeActive&&Et()}),Se(b,Q=>{Q&&(Ae.value=Q.inpaintMethod||"solid",O.value=Q.fillColor||"#FFFFFF")},{immediate:!0}),(Q,ue)=>n.isEditModeActive?(M(),A("div",{key:0,class:Ie(["edit-workspace",[`layout-${xe.value}`,{"drawing-mode":H(p)},{"brush-mode-active":!!H(m)}]]),"data-brush-mode":H(m)||void 0,tabindex:"0",ref_key:"workspaceRef",ref:be},[Ce(af,{"current-image-index":H(I),"image-count":H(ce),"can-go-previous":H(ye),"can-go-next":H(De),"show-thumbnails":it.value,"has-bubbles":H(ve),"selected-bubble-index":H(he),"bubble-count":H(J),"layout-mode":xe.value,"sync-enabled":Ge.value,scale:ht.value,"is-drawing-mode":H(p),"has-selection":H(fe),"brush-mode":H(m),"brush-size":H(l),"mouse-x":H(f),"mouse-y":H(P),"is-processing":re.value,"progress-text":Te.value,"progress-current":Re.value,"progress-total":tt.value,onGoPreviousImage:Ao,onGoNextImage:Qt,onToggleThumbnails:jn,onSelectPreviousBubble:qn,onSelectNextBubble:Hn,onToggleLayout:Jn,onToggleViewMode:Yn,onToggleSync:Xn,onFitToScreen:Bt,onZoomIn:Mo,onZoomOut:Eo,onResetZoom:Bo,onExitEditMode:Yo,onAutoDetectBubbles:os,onDetectAllImages:ns,onTranslateWithBubbles:ss,onToggleDrawingMode:H(z),onDeleteSelectedBubbles:H(U),onRepairSelectedBubble:H(W),onActivateRepairBrush:as,onActivateRestoreBrush:ls,onApplyAndNext:Jo},null,8,["current-image-index","image-count","can-go-previous","can-go-next","show-thumbnails","has-bubbles","selected-bubble-index","bubble-count","layout-mode","sync-enabled","scale","is-drawing-mode","has-selection","brush-mode","brush-size","mouse-x","mouse-y","is-processing","progress-text","progress-current","progress-total","onToggleDrawingMode","onDeleteSelectedBubbles","onRepairSelectedBubble"]),Ce(pf,{visible:it.value,images:H(le),"current-image-index":H(I),onSwitchToImage:Kn},null,8,["visible","images","current-image-index"]),e("div",vf,[e("div",ff,[ae(e("div",{class:Ie(["image-panel original-panel",{collapsed:Be.value==="translated"||Ze.value}])},[e("div",bf,[ue[8]||(ue[8]=e("span",{class:"panel-title"},"ğŸ“– åŸå›¾ (æ—¥æ–‡)",-1)),e("button",{class:"panel-toggle",onClick:ue[0]||(ue[0]=pe=>Ze.value=!Ze.value),title:"æŠ˜å /å±•å¼€"},oe(Ze.value?"+":"âˆ’"),1)]),e("div",{ref_key:"originalViewportRef",ref:ge,class:"image-viewport",onWheel:ue[2]||(ue[2]=lt(pe=>Lo(pe,"original"),["prevent"])),onMousedown:ue[3]||(ue[3]=pe=>Fo(pe,"original")),onDblclick:Bt},[e("div",{ref_key:"originalWrapperRef",ref:Pe,class:"image-canvas-wrapper",style:at(Nn.value)},[H(j)?.originalDataURL?(M(),A("img",{key:0,src:H(j).originalDataURL,alt:"åŸå›¾",onLoad:ue[1]||(ue[1]=pe=>No("original"))},null,40,hf)):de("",!0),H(j)?.originalDataURL?(M(),ut(yn,{key:1,bubbles:H($e),"selected-index":H(he),"selected-indices":H(ee),scale:zn.value,"is-drawing-mode":H(p),"is-brush-mode":!!H(m),"image-width":F.value,"image-height":ne.value,onSelect:H(E),onMultiSelect:H(R),onDragStart:H(T),onDragging:H(q),onDragEnd:H(V),onResizeStart:H(L),onResizing:H(v),onResizeEnd:H(g),onRotateStart:H(x),onRotating:H(_),onRotateEnd:H(K),onDrawBubble:H(se)},null,8,["bubbles","selected-index","selected-indices","scale","is-drawing-mode","is-brush-mode","image-width","image-height","onSelect","onMultiSelect","onDragStart","onDragging","onDragEnd","onResizeStart","onResizing","onResizeEnd","onRotateStart","onRotating","onRotateEnd","onDrawBubble"])):de("",!0),H(y)?(M(),A("div",{key:2,class:"drawing-rect-edit",style:at(H(X)())},null,4)):de("",!0)],4)],544)],2),[[Fe,Be.value!=="translated"]]),Be.value==="dual"?(M(),A("div",{key:0,class:Ie(["panel-divider",{"vertical-divider":xe.value==="vertical"}]),onMousedown:is},null,34)):de("",!0),ae(e("div",{class:Ie(["image-panel translated-panel",{collapsed:Be.value==="original"||st.value}])},[e("div",yf,[ue[9]||(ue[9]=e("span",{class:"panel-title"},"ğŸ“ ç¿»è¯‘å›¾ (ä¸­æ–‡)",-1)),e("button",{class:"panel-toggle",onClick:ue[4]||(ue[4]=pe=>st.value=!st.value),title:"æŠ˜å /å±•å¼€"},oe(st.value?"+":"âˆ’"),1)]),e("div",{ref_key:"translatedViewportRef",ref:Ee,class:"image-viewport",onWheel:ue[6]||(ue[6]=lt(pe=>Lo(pe,"translated"),["prevent"])),onMousedown:ue[7]||(ue[7]=pe=>Fo(pe,"translated")),onDblclick:Bt},[e("div",{ref_key:"translatedWrapperRef",ref:Le,class:"image-canvas-wrapper",style:at(Vn.value)},[H(j)?.translatedDataURL||H(j)?.originalDataURL?(M(),A("img",{key:0,src:H(j)?.translatedDataURL||H(j)?.originalDataURL,alt:"ç¿»è¯‘å›¾",onLoad:ue[5]||(ue[5]=pe=>No("translated"))},null,40,xf)):de("",!0),H(j)?.translatedDataURL||H(j)?.originalDataURL?(M(),ut(yn,{key:1,bubbles:H($e),"selected-index":H(he),"selected-indices":H(ee),scale:ht.value,"is-drawing-mode":H(p),"is-brush-mode":!!H(m),"image-width":F.value,"image-height":ne.value,onSelect:H(E),onMultiSelect:H(R),onDragStart:H(T),onDragging:H(q),onDragEnd:H(V),onResizeStart:H(L),onResizing:H(v),onResizeEnd:H(g),onRotateStart:H(x),onRotating:H(_),onRotateEnd:H(K),onDrawBubble:H(se)},null,8,["bubbles","selected-index","selected-indices","scale","is-drawing-mode","is-brush-mode","image-width","image-height","onSelect","onMultiSelect","onDragStart","onDragging","onDragEnd","onResizeStart","onResizing","onResizeEnd","onRotateStart","onRotating","onRotateEnd","onDrawBubble"])):de("",!0),H(y)?(M(),A("div",{key:2,class:"drawing-rect-edit translated-drawing-rect",style:at(H(X)())},null,4)):de("",!0)],4)],544)],2),[[Fe,Be.value!=="original"]])]),e("div",{ref_key:"editPanelRef",ref:ke,class:"edit-panel-container"},[e("div",{class:"panel-resize-handle vertical",onMousedown:rs}," â‹®â‹®â‹® ",32),Ce(Dv,{bubble:H(b),"bubble-index":H(he),onUpdate:Zn,onReRender:Gn,onOcrRecognize:H(te),onReTranslate:ts,onApplyBubble:Qn,onResetCurrent:es},null,8,["bubble","bubble-index","onOcrRecognize"])],512)])],10,mf)):de("",!0)}}),Cf=He(_f,[["__scopeId","data-v-7cf83f19"]]),Dt="/api/web-import";async function Sf(n){return(await fetch(`${Dt}/check-support?url=${encodeURIComponent(n)}`)).json()}async function kf(){return(await fetch(`${Dt}/gallery-dl-images`)).json()}async function wf(n,t,s,o,i,r="auto",a){const c=await fetch(`${Dt}/extract`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:n,config:t,engine:r})});if(!c.ok){const $=await c.json().catch(()=>({error:"è¯·æ±‚å¤±è´¥"}));i($.error||`HTTP ${c.status}`);return}const p=c.body?.getReader();if(!p){i("æ— æ³•è¯»å–å“åº”æµ");return}const k=new TextDecoder;let y="";try{for(;;){const{done:$,value:E}=await p.read();if($)break;y+=k.decode(E,{stream:!0});const R=y.split(`
`);y=R.pop()||"";let D="",T="";for(const q of R)if(q.startsWith("event:"))D=q.slice(6).trim();else if(q.startsWith("data:"))T=q.slice(5).trim();else if(q===""&&D&&T){try{const V=JSON.parse(T);D==="log"?s(V):D==="page"?a&&a(V):D==="result"?o(V):D==="error"&&i(V.error||"æœªçŸ¥é”™è¯¯")}catch(V){console.error("è§£æ SSE æ•°æ®å¤±è´¥:",V)}D="",T=""}}}finally{p.releaseLock()}}async function $f(n,t,s,o="ai-agent"){const i=await fetch(`${Dt}/download`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({pages:n,sourceUrl:t,config:s,engine:o})});if(!i.ok){const r=await i.json().catch(()=>({error:"è¯·æ±‚å¤±è´¥"}));throw new Error(r.error||`HTTP ${i.status}`)}return i.json()}async function Tf(n){return(await fetch(`${Dt}/test-firecrawl`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({apiKey:n})})).json()}async function If(n,t,s,o){return(await fetch(`${Dt}/test-agent`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({provider:n,apiKey:t,customBaseUrl:s,modelName:o})})).json()}const Pf={class:"modal-container"},Rf={class:"modal-body"},Df={class:"url-section"},Mf=["disabled"],Ef=["disabled"],Bf=["disabled"],Af={key:0,class:"loading-spinner"},Lf={key:1},Ff={key:0,class:"engine-hint"},Uf={key:0,class:"hint-checking"},Of={key:1,class:"hint-supported"},zf={key:2,class:"hint-unsupported"},Nf={class:"settings-section"},Vf={class:"settings-toggle"},Wf={key:0,class:"settings-content"},Kf={class:"settings-tabs"},qf={class:"settings-tab-content"},Hf={class:"settings-group"},jf={class:"form-row"},Jf={class:"input-group"},Yf=["type","value"],Xf=["disabled"],Gf={class:"settings-group"},Zf={class:"form-row"},Qf=["value"],eb=["value"],tb={class:"form-row"},ob={class:"input-group"},nb=["type","value"],sb={key:0,class:"form-row"},ab=["value"],lb={class:"form-row"},ib=["value"],rb={class:"form-row inline"},ub={class:"checkbox-label"},cb=["checked"],db={class:"checkbox-label"},gb=["checked"],pb={class:"form-row"},mb=["disabled"],vb={class:"settings-group"},fb={class:"form-row"},bb=["value"],hb={class:"form-row"},yb=["value"],xb={class:"settings-group"},_b={class:"form-grid"},Cb={class:"form-row"},Sb=["value"],kb={class:"form-row"},wb=["value"],$b={class:"form-row"},Tb=["value"],Ib={class:"form-row"},Pb=["value"],Rb={class:"form-row"},Db={class:"checkbox-label"},Mb=["checked"],Eb={class:"settings-group"},Bb={class:"form-row inline"},Ab={class:"checkbox-label"},Lb=["checked"],Fb={class:"checkbox-label"},Ub=["checked"],Ob={class:"settings-tab-content"},zb={class:"settings-group"},Nb={class:"form-row"},Vb={class:"checkbox-label"},Wb=["checked"],Kb={class:"form-row"},qb={class:"checkbox-label"},Hb=["checked"],jb={class:"form-row"},Jb={class:"checkbox-label"},Yb=["checked"],Xb={key:0,class:"form-grid"},Gb={class:"form-row"},Zb=["value"],Qb={class:"form-row"},eh=["value"],th={class:"form-row"},oh=["value"],nh={class:"form-row"},sh={class:"checkbox-label"},ah=["checked"],lh={key:1,class:"form-row"},ih=["value"],rh={class:"settings-tab-content"},uh={class:"settings-group"},ch={class:"form-row"},dh=["value"],gh={class:"form-row"},ph=["value"],mh={class:"form-row"},vh={class:"checkbox-label"},fh=["checked"],bh={key:1,class:"logs-section"},hh={class:"logs-toggle"},yh={key:0,class:"extracting-hint"},xh={key:0,class:"logs-content"},_h={class:"log-time"},Ch={class:"log-message"},Sh={key:2,class:"error-section"},kh={class:"error-message"},wh={key:3,class:"result-section"},$h={class:"result-header"},Th={class:"result-title"},Ih={class:"result-meta"},Ph={class:"result-count"},Rh={key:0,class:"result-engine"},Dh={class:"select-control"},Mh={class:"select-all"},Eh=["checked"],Bh={class:"selected-count"},Ah={class:"image-grid"},Lh=["onClick"],Fh={class:"image-checkbox"},Uh=["checked","onChange"],Oh={class:"image-preview"},zh=["src","alt"],Nh={class:"image-label"},Vh={key:4,class:"progress-section"},Wh={class:"progress-label"},Kh={class:"progress-bar"},qh={class:"modal-footer"},Hh=["disabled"],jh=["disabled"],Jh={key:0,class:"loading-spinner"},Yh={key:1},Xh=je({__name:"WebImportModal",setup(n){const t=_o(),s=et(),o=C(""),i=C(!0),r=C("auto"),a=C(!1),c=C(!1),p=C(!1),k=C(!1),y=C("basic"),$=C(!1),E=C(!1),R=C(!1),D=C(!1),T=Z(()=>t.modalVisible),q=Z(()=>t.status),V=Z(()=>t.logs),L=Z(()=>t.extractResult),v=Z(()=>t.selectedPages),g=Z(()=>t.selectedCount),x=Z(()=>t.downloadProgress),_=Z(()=>t.downloadProgressPercent),K=Z(()=>t.error),z=Z(()=>t.isProcessing),se=Z(()=>t.settings.ui.showAgentLogs),X=Z(()=>L.value?.engine||null),ie=Z(()=>{switch(X.value){case"gallery-dl":return"Gallery-DL";case"ai-agent":return"AI Agent";default:return""}}),U=Z(()=>L.value?.pages?g.value===L.value.pages.length:!1);function W(Y){return X.value==="gallery-dl",Y}let te=null;async function B(Y){if(te&&clearTimeout(te),!Y.trim()){a.value=!1,c.value=!1;return}te=setTimeout(async()=>{p.value=!0;try{const u=await Sf(Y);a.value=u.available,c.value=u.supported}catch{a.value=!1,c.value=!1}finally{p.value=!1}},500)}function d(){z.value&&!confirm("æ­£åœ¨å¤„ç†ä¸­ï¼Œç¡®å®šè¦å…³é—­å—ï¼Ÿ")||(t.closeModal(),t.resetState(),o.value="")}async function m(){const Y=o.value.trim();if(!Y){alert("è¯·è¾“å…¥ç½‘å€");return}try{new URL(Y)}catch{alert("è¯·è¾“å…¥æœ‰æ•ˆçš„ç½‘å€");return}t.resetState(),t.setUrl(Y),t.setStatus("extracting");try{await wf(Y,t.settings,u=>{t.addLog(u)},u=>{t.setExtractResult(u),u.success?t.setStatus("extracted"):t.setError(u.error||"æå–å¤±è´¥")},u=>{t.setError(u)},r.value,u=>{t.addPageIncremental(u)})}catch(u){t.setError(u instanceof Error?u.message:"æå–å¤±è´¥")}}function l(Y){t.togglePageSelection(Y)}function f(){t.toggleSelectAll()}async function P(){if(!L.value?.pages||g.value===0){alert("è¯·é€‰æ‹©è¦å¯¼å…¥çš„å›¾ç‰‡");return}const Y=L.value.pages.filter(h=>v.value.has(h.pageNumber));t.setStatus("downloading"),t.updateDownloadProgress(0,Y.length);const u=X.value||"ai-agent";try{if(u==="gallery-dl"){const le=await kf();if(le.success&&le.images.length>0){let I=0;const j=Math.min(le.images.length,Y.length);for(let ce=0;ce<j;ce++){const ye=le.images[ce];ye&&ye.filename&&ye.data&&(s.addImage(ye.filename,ye.data),I++,t.updateDownloadProgress(I,j))}t.setStatus("completed"),alert(`æˆåŠŸå¯¼å…¥ ${I} å¼ å›¾ç‰‡`),d();return}else throw new Error(le.error||"è·å–å›¾ç‰‡å¤±è´¥")}const h=await $f(Y,L.value.sourceUrl,t.settings,u);if(h.success&&h.images.length>0){t.setDownloadedImages(h.images),t.updateDownloadProgress(h.images.length,Y.length);for(const I of h.images)s.addImage(I.filename,I.dataUrl);t.setStatus("completed");const le=h.failedCount>0?`ï¼Œ${h.failedCount} å¼ å¤±è´¥`:"";alert(`æˆåŠŸå¯¼å…¥ ${h.images.length} å¼ å›¾ç‰‡${le}`),d()}else t.setError(h.error||"ä¸‹è½½å¤±è´¥")}catch(h){t.setError(h instanceof Error?h.message:"ä¸‹è½½å¤±è´¥")}}Se(T,Y=>{Y&&setTimeout(()=>{document.querySelector(".url-input")?.focus()},100)}),Se(o,Y=>{B(Y)});const S=Z(()=>t.settings.agent.provider==="custom_openai");async function w(){if(!t.settings.firecrawl.apiKey){alert("è¯·è¾“å…¥ Firecrawl API Key");return}$.value=!0;try{const Y=await Tf(t.settings.firecrawl.apiKey);Y.success?alert("âœ… Firecrawl è¿æ¥æˆåŠŸ"):alert(`âŒ è¿æ¥å¤±è´¥: ${Y.error}`)}catch(Y){alert(`âŒ è¿æ¥å¤±è´¥: ${Y instanceof Error?Y.message:"æœªçŸ¥é”™è¯¯"}`)}finally{$.value=!1}}async function N(){if(!t.settings.agent.apiKey){alert("è¯·è¾“å…¥ AI Agent API Key");return}E.value=!0;try{const Y=await If(t.settings.agent.provider,t.settings.agent.apiKey,t.settings.agent.customBaseUrl,t.settings.agent.modelName);Y.success?alert("âœ… AI Agent è¿æ¥æˆåŠŸ"):alert(`âŒ è¿æ¥å¤±è´¥: ${Y.error}`)}catch(Y){alert(`âŒ è¿æ¥å¤±è´¥: ${Y instanceof Error?Y.message:"æœªçŸ¥é”™è¯¯"}`)}finally{E.value=!1}}function G(){confirm("ç¡®å®šè¦é‡ç½®ä¸ºé»˜è®¤æç¤ºè¯å—ï¼Ÿ")&&t.resetExtractionPrompt()}return(Y,u)=>(M(),ut(kn,{to:"body"},[T.value?(M(),A("div",{key:0,class:"modal-overlay",onClick:lt(d,["self"])},[e("div",Pf,[e("div",{class:"modal-header"},[u[37]||(u[37]=e("h2",{class:"modal-title"},[e("span",{class:"title-icon"},"ğŸŒ"),me(" ä»ç½‘é¡µå¯¼å…¥æ¼«ç”» ")],-1)),e("button",{class:"close-btn",onClick:d,title:"å…³é—­"},"Ã—")]),e("div",Rf,[e("div",Df,[ae(e("input",{"onUpdate:modelValue":u[0]||(u[0]=h=>o.value=h),type:"url",class:"url-input",placeholder:"è¾“å…¥æ¼«ç”»ç½‘é¡µ URLï¼Œå¦‚ https://example.com/chapter-1",disabled:z.value,onKeyup:Sn(m,["enter"])},null,40,Mf),[[we,o.value]]),ae(e("select",{"onUpdate:modelValue":u[1]||(u[1]=h=>r.value=h),class:"engine-select",disabled:z.value},[...u[38]||(u[38]=[e("option",{value:"auto"},"è‡ªåŠ¨é€‰æ‹©",-1),e("option",{value:"gallery-dl"},"Gallery-DL",-1),e("option",{value:"ai-agent"},"AI Agent",-1)])],8,Ef),[[hs,r.value]]),e("button",{class:"extract-btn",disabled:z.value||!o.value.trim(),onClick:m},[q.value==="extracting"?(M(),A("span",Af)):(M(),A("span",Lf,"ğŸ”")),me(" "+oe(q.value==="extracting"?"æå–ä¸­...":"å¼€å§‹æå–"),1)],8,Bf)]),o.value.trim()&&!z.value?(M(),A("div",Ff,[p.value?(M(),A("span",Uf,"æ£€æŸ¥ä¸­...")):c.value?(M(),A("span",Of,"âœ“ è¯¥ç½‘ç«™æ”¯æŒ Gallery-DL é«˜é€Ÿä¸‹è½½")):a.value?(M(),A("span",zf,"è¯¥ç½‘ç«™å°†ä½¿ç”¨ AI Agent æ¨¡å¼")):de("",!0)])):de("",!0),u[80]||(u[80]=e("div",{class:"notice"}," âš ï¸ è¯·ä»…çˆ¬å–æ‚¨æœ‰æƒè®¿é—®çš„å†…å®¹ï¼Œå¹¶éµå®ˆç›®æ ‡ç½‘ç«™çš„ä½¿ç”¨æ¡æ¬¾ã€‚ ",-1)),e("div",Nf,[e("div",{class:"settings-header",onClick:u[2]||(u[2]=h=>k.value=!k.value)},[e("span",Vf,oe(k.value?"â–¼":"â–¶"),1),u[39]||(u[39]=e("span",{class:"settings-title"},"âš™ï¸ è®¾ç½®",-1)),u[40]||(u[40]=e("span",{class:"settings-hint"},"ç‚¹å‡»å±•å¼€é…ç½®",-1))]),k.value?(M(),A("div",Wf,[e("div",Kf,[e("button",{class:Ie(["settings-tab",{active:y.value==="basic"}]),onClick:u[3]||(u[3]=h=>y.value="basic")}," åŸºæœ¬è®¾ç½® ",2),e("button",{class:Ie(["settings-tab",{active:y.value==="preprocess"}]),onClick:u[4]||(u[4]=h=>y.value="preprocess")}," å›¾ç‰‡é¢„å¤„ç† ",2),e("button",{class:Ie(["settings-tab",{active:y.value==="advanced"}]),onClick:u[5]||(u[5]=h=>y.value="advanced")}," é«˜çº§è®¾ç½® ",2)]),ae(e("div",qf,[e("div",Hf,[u[42]||(u[42]=e("h4",{class:"group-title"},"Firecrawl é…ç½®",-1)),e("div",jf,[u[41]||(u[41]=e("label",{class:"form-label"},"API Key",-1)),e("div",Jf,[e("input",{type:R.value?"text":"password",class:"form-input",value:H(t).settings.firecrawl.apiKey,onInput:u[6]||(u[6]=h=>H(t).setFirecrawlApiKey(h.target.value)),placeholder:"fc-xxxxxxxxxxxxxxxx"},null,40,Yf),e("button",{class:"toggle-btn",onClick:u[7]||(u[7]=h=>R.value=!R.value)},oe(R.value?"ğŸ‘":"ğŸ‘â€ğŸ—¨"),1),e("button",{class:"test-btn",disabled:$.value||!H(t).settings.firecrawl.apiKey,onClick:w},oe($.value?"æµ‹è¯•ä¸­...":"æµ‹è¯•è¿æ¥"),9,Xf)])])]),e("div",Gf,[u[49]||(u[49]=e("h4",{class:"group-title"},"AI Agent é…ç½®",-1)),e("div",Zf,[u[43]||(u[43]=e("label",{class:"form-label"},"æœåŠ¡å•†",-1)),e("select",{class:"form-select",value:H(t).settings.agent.provider,onChange:u[8]||(u[8]=h=>H(t).setAgentProvider(h.target.value))},[(M(!0),A(Oe,null,Ye(H(fs),h=>(M(),A("option",{key:h.value,value:h.value},oe(h.label),9,eb))),128))],40,Qf)]),e("div",tb,[u[44]||(u[44]=e("label",{class:"form-label"},"API Key",-1)),e("div",ob,[e("input",{type:D.value?"text":"password",class:"form-input",value:H(t).settings.agent.apiKey,onInput:u[9]||(u[9]=h=>H(t).setAgentApiKey(h.target.value)),placeholder:"sk-xxxxxxxxxxxxxxxx"},null,40,nb),e("button",{class:"toggle-btn",onClick:u[10]||(u[10]=h=>D.value=!D.value)},oe(D.value?"ğŸ‘":"ğŸ‘â€ğŸ—¨"),1)])]),S.value?(M(),A("div",sb,[u[45]||(u[45]=e("label",{class:"form-label"},"è‡ªå®šä¹‰ API åœ°å€",-1)),e("input",{type:"url",class:"form-input",value:H(t).settings.agent.customBaseUrl,onInput:u[11]||(u[11]=h=>H(t).setAgentBaseUrl(h.target.value)),placeholder:"https://api.example.com/v1"},null,40,ab)])):de("",!0),e("div",lb,[u[46]||(u[46]=e("label",{class:"form-label"},"æ¨¡å‹åç§°",-1)),e("input",{type:"text",class:"form-input",value:H(t).settings.agent.modelName,onInput:u[12]||(u[12]=h=>H(t).setAgentModelName(h.target.value)),placeholder:"gpt-4o-mini"},null,40,ib)]),e("div",rb,[e("label",ub,[e("input",{type:"checkbox",checked:H(t).settings.agent.forceJsonOutput,onChange:u[13]||(u[13]=h=>H(t).setAgentForceJson(h.target.checked))},null,40,cb),u[47]||(u[47]=me(" å¼ºåˆ¶ JSON æ ¼å¼ ",-1))]),e("label",db,[e("input",{type:"checkbox",checked:H(t).settings.agent.useStream,onChange:u[14]||(u[14]=h=>H(t).setAgentUseStream(h.target.checked))},null,40,gb),u[48]||(u[48]=me(" æµå¼è°ƒç”¨ ",-1))])]),e("div",pb,[e("button",{class:"test-btn full",disabled:E.value||!H(t).settings.agent.apiKey,onClick:N},oe(E.value?"æµ‹è¯•ä¸­...":"æµ‹è¯• Agent è¿æ¥"),9,mb)])]),e("div",vb,[e("h4",{class:"group-title"},[u[50]||(u[50]=me(" æå–è®¾ç½® ",-1)),e("button",{class:"reset-btn",onClick:G},"é‡ç½®ä¸ºé»˜è®¤")]),e("div",fb,[u[51]||(u[51]=e("label",{class:"form-label"},"æå–æç¤ºè¯",-1)),e("textarea",{class:"form-textarea",value:H(t).settings.extraction.prompt,onInput:u[15]||(u[15]=h=>H(t).setExtractionPrompt(h.target.value)),rows:"6",placeholder:"è¾“å…¥æå–æç¤ºè¯..."},null,40,bb)]),e("div",hb,[u[52]||(u[52]=e("label",{class:"form-label"},"æœ€å¤§è¿­ä»£æ¬¡æ•°",-1)),e("input",{type:"number",class:"form-input small",value:H(t).settings.extraction.maxIterations,onInput:u[16]||(u[16]=h=>H(t).setExtractionMaxIterations(Number(h.target.value))),min:"1",max:"20"},null,40,yb)])]),e("div",xb,[u[58]||(u[58]=e("h4",{class:"group-title"},"ä¸‹è½½è®¾ç½®",-1)),e("div",_b,[e("div",Cb,[u[53]||(u[53]=e("label",{class:"form-label"},"å¹¶å‘æ•°",-1)),e("input",{type:"number",class:"form-input small",value:H(t).settings.download.concurrency,onInput:u[17]||(u[17]=h=>H(t).setDownloadConcurrency(Number(h.target.value))),min:"1",max:"10"},null,40,Sb)]),e("div",kb,[u[54]||(u[54]=e("label",{class:"form-label"},"è¶…æ—¶ (ç§’)",-1)),e("input",{type:"number",class:"form-input small",value:H(t).settings.download.timeout,onInput:u[18]||(u[18]=h=>H(t).setDownloadTimeout(Number(h.target.value))),min:"5",max:"120"},null,40,wb)]),e("div",$b,[u[55]||(u[55]=e("label",{class:"form-label"},"é‡è¯•æ¬¡æ•°",-1)),e("input",{type:"number",class:"form-input small",value:H(t).settings.download.retries,onInput:u[19]||(u[19]=h=>H(t).setDownloadRetries(Number(h.target.value))),min:"0",max:"5"},null,40,Tb)]),e("div",Ib,[u[56]||(u[56]=e("label",{class:"form-label"},"ä¸‹è½½é—´éš” (ms)",-1)),e("input",{type:"number",class:"form-input small",value:H(t).settings.download.delay,onInput:u[20]||(u[20]=h=>H(t).setDownloadDelay(Number(h.target.value))),min:"0",max:"2000",step:"100"},null,40,Pb)])]),e("div",Rb,[e("label",Db,[e("input",{type:"checkbox",checked:H(t).settings.download.useReferer,onChange:u[21]||(u[21]=h=>H(t).setDownloadUseReferer(h.target.checked))},null,40,Mb),u[57]||(u[57]=me(" è‡ªåŠ¨æ·»åŠ  Referer ",-1))])])]),e("div",Eb,[u[61]||(u[61]=e("h4",{class:"group-title"},"ç•Œé¢è®¾ç½®",-1)),e("div",Bb,[e("label",Ab,[e("input",{type:"checkbox",checked:H(t).settings.ui.showAgentLogs,onChange:u[22]||(u[22]=h=>H(t).setShowAgentLogs(h.target.checked))},null,40,Lb),u[59]||(u[59]=me(" æ˜¾ç¤º AI å·¥ä½œæ—¥å¿— ",-1))]),e("label",Fb,[e("input",{type:"checkbox",checked:H(t).settings.ui.autoImport,onChange:u[23]||(u[23]=h=>H(t).setAutoImport(h.target.checked))},null,40,Ub),u[60]||(u[60]=me(" æå–åè‡ªåŠ¨å¯¼å…¥ ",-1))])])])],512),[[Fe,y.value==="basic"]]),ae(e("div",Ob,[e("div",zb,[e("div",Nb,[e("label",Vb,[e("input",{type:"checkbox",checked:H(t).settings.imagePreprocess.enabled,onChange:u[24]||(u[24]=h=>H(t).setImagePreprocessEnabled(h.target.checked))},null,40,Wb),u[62]||(u[62]=me(" å¯ç”¨å›¾ç‰‡é¢„å¤„ç† ",-1))])]),H(t).settings.imagePreprocess.enabled?(M(),A(Oe,{key:0},[e("div",Kb,[e("label",qb,[e("input",{type:"checkbox",checked:H(t).settings.imagePreprocess.autoRotate,onChange:u[25]||(u[25]=h=>H(t).setImageAutoRotate(h.target.checked))},null,40,Hb),u[63]||(u[63]=me(" æ ¹æ® EXIF è‡ªåŠ¨æ—‹è½¬ ",-1))])]),u[71]||(u[71]=e("h5",{class:"subsection-title"},"å‹ç¼©è®¾ç½®",-1)),e("div",jb,[e("label",Jb,[e("input",{type:"checkbox",checked:H(t).settings.imagePreprocess.compression.enabled,onChange:u[26]||(u[26]=h=>H(t).setImageCompressionEnabled(h.target.checked))},null,40,Yb),u[64]||(u[64]=me(" å¯ç”¨å‹ç¼© ",-1))])]),H(t).settings.imagePreprocess.compression.enabled?(M(),A("div",Xb,[e("div",Gb,[u[65]||(u[65]=e("label",{class:"form-label"},"è´¨é‡ (0-100)",-1)),e("input",{type:"number",class:"form-input small",value:H(t).settings.imagePreprocess.compression.quality,onInput:u[27]||(u[27]=h=>H(t).setImageCompressionQuality(Number(h.target.value))),min:"1",max:"100"},null,40,Zb)]),e("div",Qb,[u[66]||(u[66]=e("label",{class:"form-label"},"æœ€å¤§å®½åº¦ (0=ä¸é™)",-1)),e("input",{type:"number",class:"form-input small",value:H(t).settings.imagePreprocess.compression.maxWidth,onInput:u[28]||(u[28]=h=>H(t).setImageMaxWidth(Number(h.target.value))),min:"0"},null,40,eh)]),e("div",th,[u[67]||(u[67]=e("label",{class:"form-label"},"æœ€å¤§é«˜åº¦ (0=ä¸é™)",-1)),e("input",{type:"number",class:"form-input small",value:H(t).settings.imagePreprocess.compression.maxHeight,onInput:u[29]||(u[29]=h=>H(t).setImageMaxHeight(Number(h.target.value))),min:"0"},null,40,oh)])])):de("",!0),u[72]||(u[72]=e("h5",{class:"subsection-title"},"æ ¼å¼è½¬æ¢",-1)),e("div",nh,[e("label",sh,[e("input",{type:"checkbox",checked:H(t).settings.imagePreprocess.formatConvert.enabled,onChange:u[30]||(u[30]=h=>H(t).setImageFormatConvertEnabled(h.target.checked))},null,40,ah),u[68]||(u[68]=me(" å¯ç”¨æ ¼å¼è½¬æ¢ ",-1))])]),H(t).settings.imagePreprocess.formatConvert.enabled?(M(),A("div",lh,[u[70]||(u[70]=e("label",{class:"form-label"},"ç›®æ ‡æ ¼å¼",-1)),e("select",{class:"form-select",value:H(t).settings.imagePreprocess.formatConvert.targetFormat,onChange:u[31]||(u[31]=h=>H(t).setImageTargetFormat(h.target.value))},[...u[69]||(u[69]=[e("option",{value:"original"},"ä¿æŒåŸæ ¼å¼",-1),e("option",{value:"jpeg"},"JPEG",-1),e("option",{value:"png"},"PNG",-1),e("option",{value:"webp"},"WebP",-1)])],40,ih)])):de("",!0)],64)):de("",!0)])],512),[[Fe,y.value==="preprocess"]]),ae(e("div",rh,[e("div",uh,[u[76]||(u[76]=e("h4",{class:"group-title"},"è‡ªå®šä¹‰è¯·æ±‚å¤´",-1)),e("div",ch,[u[73]||(u[73]=e("label",{class:"form-label"},"Cookie",-1)),e("input",{type:"text",class:"form-input",value:H(t).settings.advanced.customCookie,onInput:u[32]||(u[32]=h=>H(t).setCustomCookie(h.target.value)),placeholder:"name=value; name2=value2"},null,40,dh)]),e("div",gh,[u[74]||(u[74]=e("label",{class:"form-label"},"Headers (JSON)",-1)),e("textarea",{class:"form-textarea",value:H(t).settings.advanced.customHeaders,onInput:u[33]||(u[33]=h=>H(t).setCustomHeaders(h.target.value)),rows:"3",placeholder:'{"X-Custom-Header": "value"}'},null,40,ph)]),e("div",mh,[e("label",vh,[e("input",{type:"checkbox",checked:H(t).settings.advanced.bypassProxy,onChange:u[34]||(u[34]=h=>H(t).setBypassProxy(h.target.checked))},null,40,fh),u[75]||(u[75]=me(" ç»•è¿‡ç³»ç»Ÿä»£ç† (è¿æ¥æœ¬åœ°æœåŠ¡æ—¶ä½¿ç”¨) ",-1))])])])],512),[[Fe,y.value==="advanced"]])])):de("",!0)]),se.value&&V.value.length>0?(M(),A("div",bh,[e("div",{class:"logs-header",onClick:u[35]||(u[35]=h=>i.value=!i.value)},[e("span",hh,oe(i.value?"â–¼":"â–¶"),1),u[77]||(u[77]=e("span",null,"AI å·¥ä½œæ—¥å¿—",-1)),q.value==="extracting"?(M(),A("span",yh,"(æå–ä¸­...)")):de("",!0)]),i.value?(M(),A("div",xh,[(M(!0),A(Oe,null,Ye(V.value,(h,le)=>(M(),A("div",{key:le,class:Ie(["log-item",`log-${h.type}`])},[e("span",_h,"["+oe(h.timestamp)+"]",1),e("span",Ch,oe(h.message),1)],2))),128))])):de("",!0)])):de("",!0),K.value?(M(),A("div",Sh,[u[78]||(u[78]=e("span",{class:"error-icon"},"âŒ",-1)),e("span",kh,oe(K.value),1)])):de("",!0),L.value?.success?(M(),A("div",wh,[e("div",$h,[e("span",Th," ğŸ“– ã€Š"+oe(L.value.comicTitle)+"ã€‹- "+oe(L.value.chapterTitle),1),e("span",Ih,[e("span",Ph,"å…± "+oe(L.value.totalPages)+" å¼ ",1),ie.value?(M(),A("span",Rh,"| å¼•æ“: "+oe(ie.value),1)):de("",!0)])]),e("div",Dh,[e("label",Mh,[e("input",{type:"checkbox",checked:U.value,onChange:f},null,40,Eh),u[79]||(u[79]=me(" å…¨é€‰ ",-1))]),e("span",Bh,"å·²é€‰: "+oe(g.value)+" å¼ ",1)]),e("div",Ah,[(M(!0),A(Oe,null,Ye(L.value.pages,h=>(M(),A("div",{key:h.pageNumber,class:Ie(["image-item",{selected:v.value.has(h.pageNumber)}]),onClick:le=>l(h.pageNumber)},[e("div",Fh,[e("input",{type:"checkbox",checked:v.value.has(h.pageNumber),onClick:u[36]||(u[36]=lt(()=>{},["stop"])),onChange:le=>l(h.pageNumber)},null,40,Uh)]),e("div",Oh,[e("img",{src:W(h.imageUrl),alt:`ç¬¬${h.pageNumber}é¡µ`,loading:"lazy"},null,8,zh)]),e("div",Nh,"ç¬¬ "+oe(h.pageNumber)+" é¡µ",1)],10,Lh))),128))])])):de("",!0),q.value==="downloading"?(M(),A("div",Vh,[e("div",Wh," ä¸‹è½½è¿›åº¦: "+oe(x.value.current)+"/"+oe(x.value.total),1),e("div",Kh,[e("div",{class:"progress-fill",style:at({width:`${_.value}%`})},null,4)])])):de("",!0)]),e("div",qh,[e("button",{class:"cancel-btn",onClick:d,disabled:q.value==="downloading"}," å–æ¶ˆ ",8,Hh),e("button",{class:"import-btn",disabled:!L.value?.success||g.value===0||z.value,onClick:P},[q.value==="downloading"?(M(),A("span",Jh)):(M(),A("span",Yh,"ğŸ“¥")),me(" "+oe(q.value==="downloading"?"ä¸‹è½½ä¸­...":"å¯¼å…¥"),1)],8,jh)])])])):de("",!0)]))}}),Gh=He(Xh,[["__scopeId","data-v-78fc5cb0"]]),Zh={class:"disclaimer-container"},Qh={class:"disclaimer-content"},ey={class:"confirmation-area"},ty=["placeholder"],oy={key:0,class:"input-error"},ny={class:"disclaimer-footer"},sy=["disabled"],qt="æˆ‘å·²é˜…è¯»å¹¶åŒæ„",ay=je({__name:"WebImportDisclaimer",setup(n){const t=_o(),s=C(""),o=Z(()=>t.disclaimerVisible),i=Z(()=>s.value.trim()===qt);function r(){i.value&&(t.acceptDisclaimer(),s.value="")}function a(){t.rejectDisclaimer(),s.value=""}return(c,p)=>(M(),ut(kn,{to:"body"},[o.value?(M(),A("div",{key:0,class:"disclaimer-overlay",onClick:lt(a,["self"])},[e("div",Zh,[p[3]||(p[3]=e("div",{class:"disclaimer-header"},[e("span",{class:"warning-icon"},"âš ï¸"),e("h2",{class:"disclaimer-title"},"é‡è¦å…è´£å£°æ˜")],-1)),e("div",Qh,[p[2]||(p[2]=e("div",{class:"disclaimer-text"},[e("h3",null,"ğŸ“œ ä½¿ç”¨æ¡æ¬¾ä¸æ³•å¾‹å£°æ˜"),e("div",{class:"section"},[e("h4",null,"1. åŠŸèƒ½è¯´æ˜"),e("p",null,[me(' "ä»ç½‘é¡µå¯¼å…¥"åŠŸèƒ½å…è®¸æ‚¨ä»äº’è”ç½‘ç½‘é¡µä¸­æå–å›¾ç‰‡ã€‚æ­¤åŠŸèƒ½ä»…ä¾›'),e("strong",null,"æŠ€æœ¯ç ”ç©¶ä¸ä¸ªäººå­¦ä¹ "),me("ä¹‹ç›®çš„æä¾›ã€‚ ")])]),e("div",{class:"section"},[e("h4",null,"2. ç”¨æˆ·è´£ä»»"),e("ul",null,[e("li",null,[me("æ‚¨åº”å½“ç¡®ä¿æ‹¥æœ‰"),e("strong",null,"åˆæ³•æƒåˆ©"),me("è®¿é—®å’Œä¸‹è½½ç›®æ ‡å†…å®¹")]),e("li",null,[me("æ‚¨åº”å½“éµå®ˆç›®æ ‡ç½‘ç«™çš„"),e("strong",null,"æœåŠ¡æ¡æ¬¾"),me("å’Œ"),e("strong",null,"ä½¿ç”¨åè®®")]),e("li",null,[me("æ‚¨åº”å½“å°Šé‡å†…å®¹åˆ›ä½œè€…çš„"),e("strong",null,"ç‰ˆæƒ"),me("å’Œ"),e("strong",null,"çŸ¥è¯†äº§æƒ")]),e("li",null,[me("æ‚¨"),e("strong",null,"ä¸å¾—"),me("å°†ä¸‹è½½çš„å†…å®¹ç”¨äºå•†ä¸šç›®çš„æˆ–éæ³•ä¼ æ’­")]),e("li",null,[me("æ‚¨"),e("strong",null,"ä¸å¾—"),me("ä½¿ç”¨æœ¬åŠŸèƒ½ç»•è¿‡ä»˜è´¹å†…å®¹çš„è®¿é—®é™åˆ¶")])])]),e("div",{class:"section"},[e("h4",null,"3. ä½¿ç”¨é™åˆ¶"),e("p",null,[me("æœ¬åŠŸèƒ½"),e("strong",null,"ä¸¥ç¦"),me("ç”¨äºä»¥ä¸‹ç›®çš„ï¼š")]),e("ul",null,[e("li",null,[me("ä¸‹è½½ã€å­˜å‚¨æˆ–ä¼ æ’­"),e("strong",null,"ä¾µæƒå†…å®¹")]),e("li",null,[me("ç»•è¿‡ç½‘ç«™çš„"),e("strong",null,"ä»˜è´¹å¢™"),me("æˆ–"),e("strong",null,"è®¿é—®æ§åˆ¶")]),e("li",null,[me("è¿›è¡Œ"),e("strong",null,"å•†ä¸šç”¨é€”"),me("æˆ–å¤§è§„æ¨¡"),e("strong",null,"æ‰¹é‡çˆ¬å–")]),e("li",null,[me("ä»»ä½•è¿å"),e("strong",null,"å½“åœ°æ³•å¾‹æ³•è§„"),me("çš„æ´»åŠ¨")]),e("li",null,[me("å¯¹ç›®æ ‡ç½‘ç«™é€ æˆ"),e("strong",null,"æœåŠ¡å™¨è´Ÿæ‹…"),me("æˆ–"),e("strong",null,"æ¶æ„æ”»å‡»")])])]),e("div",{class:"section"},[e("h4",null,"4. å…è´£æ¡æ¬¾"),e("p",null,[me(" æœ¬è½¯ä»¶ä½œè€…åŠè´¡çŒ®è€…"),e("strong",null,"ä¸å¯¹æ‚¨ä½¿ç”¨æœ¬åŠŸèƒ½æ‰€å¯¼è‡´çš„ä»»ä½•ç›´æ¥æˆ–é—´æ¥åæœæ‰¿æ‹…è´£ä»»"),me("ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºï¼š ")]),e("ul",null,[e("li",null,"å› ä¾µçŠ¯ç‰ˆæƒè€Œäº§ç”Ÿçš„æ³•å¾‹è´£ä»»"),e("li",null,"å› è¿åæœåŠ¡æ¡æ¬¾è€Œå¯¼è‡´çš„è´¦å·å°ç¦"),e("li",null,"å› æ•°æ®ä¸¢å¤±æˆ–æŸåè€Œé€ æˆçš„æŸå¤±"),e("li",null,"ä»»ä½•å…¶ä»–å› ä½¿ç”¨æœ¬åŠŸèƒ½è€Œäº§ç”Ÿçš„ä¸åˆ©åæœ")])]),e("div",{class:"section warning-section"},[e("h4",null,"5. ç¡®è®¤å£°æ˜"),e("p",null,[me(" ä½¿ç”¨æœ¬åŠŸèƒ½å³è¡¨ç¤ºæ‚¨"),e("strong",null,"å·²é˜…è¯»ã€ç†è§£å¹¶åŒæ„"),me("ä¸Šè¿°æ‰€æœ‰æ¡æ¬¾ï¼Œå¹¶æ‰¿è¯ºï¼š ")]),e("ul",null,[e("li",null,[me("ä»…å°†æœ¬åŠŸèƒ½ç”¨äº"),e("strong",null,"åˆæ³•ã€åˆè§„"),me("çš„ç›®çš„")]),e("li",null,[e("strong",null,"è‡ªè¡Œæ‰¿æ‹…"),me("ä½¿ç”¨æœ¬åŠŸèƒ½æ‰€å¸¦æ¥çš„ä¸€åˆ‡é£é™©å’Œè´£ä»»")]),e("li",null,[me("å¦‚å› ä½¿ç”¨æœ¬åŠŸèƒ½å¯¼è‡´ä»»ä½•äº‰è®®ï¼Œ"),e("strong",null,"ä¸æœ¬è½¯ä»¶ä½œè€…æ— å…³")])])])],-1)),e("div",ey,[p[1]||(p[1]=e("p",{class:"confirmation-prompt"}," å¦‚æœæ‚¨å·²å®Œæ•´é˜…è¯»å¹¶åŒæ„ä»¥ä¸Šæ¡æ¬¾ï¼Œè¯·åœ¨ä¸‹æ–¹è¾“å…¥æ¡†ä¸­å‡†ç¡®è¾“å…¥ï¼š ",-1)),e("p",{class:"required-text"},[e("code",null,oe(qt))]),ae(e("input",{"onUpdate:modelValue":p[0]||(p[0]=k=>s.value=k),type:"text",class:"confirmation-input",placeholder:`è¯·è¾“å…¥: ${qt}`,onKeyup:Sn(r,["enter"])},null,40,ty),[[we,s.value]]),s.value&&!i.value?(M(),A("p",oy," è¾“å…¥ä¸æ­£ç¡®ï¼Œè¯·å®Œæ•´è¾“å…¥ã€Œ"+oe(qt)+"ã€ ")):de("",!0)])]),e("div",ny,[e("button",{class:"btn-cancel",onClick:a}," æˆ‘ä¸åŒæ„ï¼Œè¿”å› "),e("button",{class:"btn-confirm",disabled:!i.value,onClick:r}," âœ“ ç¡®è®¤å¹¶ç»§ç»­ ",8,sy)])])])):de("",!0)]))}}),ly=He(ay,[["__scopeId","data-v-3750d090"]]),iy={class:"app-header"},ry={class:"header-content"},uy={class:"logo-container"},cy={class:"header-links"},dy={class:"container"},gy={id:"image-display-area"},py={id:"upload-section",class:"card upload-card"},my={class:"upload-actions"},vy={key:1,class:"bookshelf-mode-hint"},fy=je({__name:"TranslateView",setup(n){const t=Cn(),s=et(),o=ze(),i=It(),r=gt(),{validateBeforeTranslation:a,initValidation:c}=En(),p=Do(),k=Mi(),y=C(!1),$=C(void 0),E=C(!1),R=C(!1),D=Z(()=>s.currentImage),T=Z(()=>s.hasImages),q=Z(()=>s.isBatchTranslationInProgress),V=Z(()=>s.failedImageCount>0),L=Z(()=>!!t.query.book&&!!t.query.chapter),v=Z(()=>t.query.book),g=Z(()=>t.query.chapter),x=Z(()=>k.currentBookTitle.value),_=Z(()=>k.currentChapterTitle.value),K=Z(()=>L.value&&_.value&&x.value?`${_.value} - ${x.value}`:"Saber-Translator");dt(async()=>{s.clearImages(),r.clearBubbles(),await k.initializeApp(),c(),window.addEventListener("keydown",b)}),Ot(()=>{window.removeEventListener("keydown",b)}),Se(()=>[t.query.book,t.query.chapter],async([F,ne],[be,ge])=>{F&&ne?(s.clearImages(),r.clearBubbles(),await ie()):be&&ge&&!F&&!ne&&(s.clearImages(),r.clearBubbles(),await k.initializeBookChapterContext(),console.log("[TranslateView] ä»ä¹¦æ¶æ¨¡å¼åˆ‡æ¢åˆ°å¿«é€Ÿç¿»è¯‘æ¨¡å¼ï¼Œå·²æ¸…ç©ºæ•°æ®"))}),Se(K,F=>{typeof document<"u"&&(document.title=F)},{immediate:!0});const z=C(!1);function se(F){F&&o.updateTextStyle({fontSize:F.fontSize,autoFontSize:F.autoFontSize,fontFamily:F.fontFamily,layoutDirection:F.layoutDirection,textColor:F.textColor,fillColor:F.fillColor,strokeEnabled:F.strokeEnabled,strokeColor:F.strokeColor,strokeWidth:F.strokeWidth,inpaintMethod:F.inpaintMethod,useAutoTextColor:F.useAutoTextColor})}function X(F){s.currentImage&&s.updateCurrentImage({fontSize:F.fontSize,autoFontSize:F.autoFontSize,fontFamily:F.fontFamily,layoutDirection:F.layoutDirection,textColor:F.textColor,fillColor:F.fillColor,strokeEnabled:F.strokeEnabled,strokeColor:F.strokeColor,strokeWidth:F.strokeWidth,inpaintMethod:F.inpaintMethod,useAutoTextColor:F.useAutoTextColor})}Se(()=>s.currentImage,F=>{if(F&&!z.value){z.value=!0;try{se(F),console.log(`[TranslateView] å·²åŒæ­¥å›¾ç‰‡ ${s.currentImageIndex} çš„æ–‡å­—è®¾ç½®åˆ°ä¾§è¾¹æ `)}finally{z.value=!1}}},{immediate:!1}),Se(()=>o.settings.textStyle,F=>{if(s.currentImage&&!z.value){z.value=!0;try{X(F),console.log(`[TranslateView] å·²å°†ä¾§è¾¹æ è®¾ç½®åŒæ­¥åˆ°å›¾ç‰‡ ${s.currentImageIndex}`)}finally{z.value=!1}}},{deep:!0});async function ie(){if(!(!v.value||!g.value))try{await k.initializeBookChapterContext()}catch(F){console.error("åŠ è½½ç« èŠ‚ä¼šè¯å¤±è´¥:",F),_e("åŠ è½½ç« èŠ‚ä¼šè¯å¤±è´¥","error")}}function U(F){console.log(`ä¸Šä¼ å®Œæˆï¼Œå…± ${F} å¼ å›¾ç‰‡`),s.hasImages&&(s.sortImagesByFileName(),k.switchImage(0))}async function W(F){if(!Object.values(F).some(ge=>ge)){_e("è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè¦åº”ç”¨çš„è®¾ç½®é¡¹","warning");return}if(s.images.length===0){_e("æ²¡æœ‰å¯åº”ç”¨çš„å›¾ç‰‡","warning");return}if(s.images.length<=1){_e("åªæœ‰ä¸€å¼ å›¾ç‰‡ï¼Œæ— éœ€åº”ç”¨åˆ°å…¨éƒ¨","info");return}if(!s.images.some(ge=>ge.bubbleStates&&ge.bubbleStates.length>0)){_e("æ²¡æœ‰å·²ç¿»è¯‘çš„å›¾ç‰‡","warning");return}try{const{textStyle:ge}=o.settings,Pe=ge.layoutDirection==="auto",Ee=ge.useAutoTextColor===!0,Le=ge.autoFontSize===!0,ke={fontSize:ge.fontSize,fontFamily:ge.fontFamily,textDirection:ge.layoutDirection==="auto"?"vertical":ge.layoutDirection,textColor:ge.textColor,fillColor:ge.fillColor,strokeEnabled:ge.strokeEnabled,strokeColor:ge.strokeColor,strokeWidth:ge.strokeWidth},Be=O=>{if(!O||O.length!==3)return null;const[re,Te,Re]=O;return"#"+[re,Te,Re].map(tt=>{const qe=Math.max(0,Math.min(255,Math.round(tt))).toString(16);return qe.length===1?"0"+qe:qe}).join("")},xe=O=>{const re={...O};if(F.fontSize&&!Le&&(re.fontSize=ke.fontSize),F.fontFamily&&(re.fontFamily=ke.fontFamily),F.layoutDirection)if(Pe){const Te=O.autoTextDirection;re.textDirection=Te==="vertical"||Te==="horizontal"?Te:"vertical"}else re.textDirection=ke.textDirection;if(F.textColor)if(Ee&&O.autoFgColor){const Te=Be(O.autoFgColor);re.textColor=Te??ke.textColor}else re.textColor=ke.textColor;if(F.fillColor)if(Ee&&O.autoBgColor){const Te=Be(O.autoBgColor);re.fillColor=Te??ke.fillColor}else re.fillColor=ke.fillColor;return F.strokeEnabled&&(re.strokeEnabled=ke.strokeEnabled),F.strokeColor&&(re.strokeColor=ke.strokeColor),F.strokeWidth&&(re.strokeWidth=ke.strokeWidth),re};let it=0;const Ge=s.images;for(let O=0;O<Ge.length;O++){const re=Ge[O];if(re&&re.bubbleStates&&re.bubbleStates.length>0){const Re={bubbleStates:re.bubbleStates.map(xe)};F.fontSize&&(Re.autoFontSize=Le,Le||(Re.fontSize=ke.fontSize)),F.fontFamily&&(Re.fontFamily=ke.fontFamily),F.layoutDirection&&(Re.layoutDirection=ge.layoutDirection),(F.textColor||F.fillColor)&&(Re.useAutoTextColor=Ee),F.textColor&&(Ee||(Re.textColor=ke.textColor)),F.fillColor&&(Ee||(Re.fillColor=ke.fillColor)),F.strokeEnabled&&(Re.strokeEnabled=ke.strokeEnabled),F.strokeColor&&(Re.strokeColor=ke.strokeColor),F.strokeWidth&&(Re.strokeWidth=ke.strokeWidth),s.updateImageByIndex(O,Re),it++}}if(r.bubbles.length>0){const O=r.bubbles.map(xe);r.setBubbles(O)}const Ze=[];F.fontSize&&Ze.push(Le?"è‡ªåŠ¨å­—å·":"å­—å·"),F.fontFamily&&Ze.push("å­—ä½“"),F.layoutDirection&&Ze.push(Pe?"è‡ªåŠ¨æ’ç‰ˆæ–¹å‘":"æ’ç‰ˆæ–¹å‘"),F.textColor&&Ze.push(Ee?"è‡ªåŠ¨æ–‡å­—é¢œè‰²":"æ–‡å­—é¢œè‰²"),F.fillColor&&Ze.push(Ee?"è‡ªåŠ¨å¡«å……é¢œè‰²":"å¡«å……é¢œè‰²"),F.strokeEnabled&&Ze.push("æè¾¹å¼€å…³"),F.strokeColor&&Ze.push("æè¾¹é¢œè‰²"),F.strokeWidth&&Ze.push("æè¾¹å®½åº¦");const st=[];for(let O=0;O<Ge.length;O++){const re=Ge[O];re&&re.translatedDataURL&&re.bubbleStates&&re.bubbleStates.length>0&&st.push(O)}if(st.length>0){p.progress.value={isInProgress:!0,current:0,total:st.length,completed:0,failed:0,label:`åº”ç”¨è®¾ç½®ä¸­ï¼š0 / ${st.length}`,percentage:0};const{parallelRender:O}=await rt(async()=>{const{parallelRender:Te}=await Promise.resolve().then(()=>di);return{parallelRender:Te}},void 0);let re=0;for(let Te=0;Te<st.length;Te++){const Re=st[Te];if(Re===void 0)continue;const tt=s.images[Re];if(!(!tt||!tt.bubbleStates))try{let qe="";if(tt.cleanImageData?qe=tt.cleanImageData.includes("base64,")?tt.cleanImageData.split("base64,")[1]||"":tt.cleanImageData:tt.originalDataURL&&(qe=tt.originalDataURL.includes("base64,")?tt.originalDataURL.split("base64,")[1]||"":tt.originalDataURL,console.log(`handleApplyToAll: å›¾ç‰‡ ${Re} ä½¿ç”¨åŸå›¾ä½œä¸ºèƒŒæ™¯ï¼ˆå…œåº•ï¼‰`)),!qe){console.log(`handleApplyToAll: å›¾ç‰‡ ${Re} æ²¡æœ‰å¯ç”¨çš„èƒŒæ™¯å›¾ï¼Œè·³è¿‡`),p.progress.value.failed++;continue}const Qe=tt.bubbleStates.map(ot=>({originalText:ot.originalText||"",translatedText:ot.translatedText||"",textboxText:ot.textboxText||"",coords:ot.coords,polygon:ot.polygon,fontSize:ot.fontSize,fontFamily:ot.fontFamily,textDirection:ot.textDirection,autoTextDirection:ot.autoTextDirection,textColor:ot.textColor,fillColor:ot.fillColor,rotationAngle:ot.rotationAngle||0,position:ot.position||{x:0,y:0},strokeEnabled:ot.strokeEnabled,strokeColor:ot.strokeColor,strokeWidth:ot.strokeWidth,inpaintMethod:ot.inpaintMethod,autoFgColor:ot.autoFgColor,autoBgColor:ot.autoBgColor})),ht=await O({clean_image:qe,bubble_states:Qe,fontSize:ge.fontSize,fontFamily:ge.fontFamily,textDirection:ge.layoutDirection==="auto"?"vertical":ge.layoutDirection,textColor:ge.textColor,strokeEnabled:ge.strokeEnabled,strokeColor:ge.strokeColor,strokeWidth:ge.strokeWidth,autoFontSize:F.fontSize&&Le,use_individual_styles:!0});if(ht.success&&ht.final_image){const ot=ht.bubble_states||tt.bubbleStates;s.updateImageByIndex(Re,{translatedDataURL:`data:image/png;base64,${ht.final_image}`,bubbleStates:ot,hasUnsavedChanges:!0}),re++,p.progress.value.current=re,p.progress.value.label=`åº”ç”¨è®¾ç½®ä¸­ï¼š${re} / ${st.length}`,p.progress.value.percentage=Math.round(re/st.length*100)}else p.progress.value.failed++}catch(qe){console.error(`é‡æ¸²æŸ“å›¾ç‰‡ ${Re} å¤±è´¥:`,qe),p.progress.value.failed++}}p.progress.value.isInProgress=!1}const Ae=s.currentImage;if(Ae){z.value=!0;try{se(Ae),console.log("[TranslateView] åº”ç”¨åˆ°å…¨éƒ¨å®Œæˆï¼Œå·²åŒæ­¥å½“å‰å›¾ç‰‡è®¾ç½®åˆ°ä¾§è¾¹æ ")}finally{z.value=!1}}_e(`å·²å°† ${Ze.join("ã€")} åº”ç”¨åˆ° ${it} å¼ å›¾ç‰‡`,"success"),console.log(`[TranslateView] åº”ç”¨è®¾ç½®åˆ°å…¨éƒ¨å®Œæˆï¼Œæ›´æ–°äº† ${it} å¼ å›¾ç‰‡ï¼Œé‡æ¸²æŸ“äº† ${st.length} å¼ `)}catch(ge){console.error("åº”ç”¨è®¾ç½®åˆ°å…¨éƒ¨å¤±è´¥:",ge),_e("åº”ç”¨è®¾ç½®å¤±è´¥","error")}}async function te(){D.value&&a("normal")&&await p.translateCurrentImage()}async function B(){T.value&&a("normal")&&await p.translateAllImages()}async function d(){T.value&&a("hq")&&await p.executeHqTranslation()}async function m(){T.value&&a("proofread")&&await p.executeProofreading()}async function l(){D.value&&await p.removeTextOnly()}async function f(){T.value&&await p.removeAllTexts()}async function P(F,ne){T.value&&a("normal")&&await p.translateImageRange({startPage:F,endPage:ne})}async function S(F,ne){T.value&&a("hq")&&await p.executeHqTranslation({startPage:F,endPage:ne})}async function w(F,ne){T.value&&a("proofread")&&await p.executeProofreading({startPage:F,endPage:ne})}async function N(F,ne){T.value&&await p.removeTextRange({startPage:F,endPage:ne})}function G(){if(!D.value)return;const F=D.value.fileName||`å›¾ç‰‡ ${s.currentImageIndex+1}`;confirm(`ç¡®å®šè¦åˆ é™¤å½“å‰å›¾ç‰‡ (${F}) å—ï¼Ÿ`)&&(s.deleteCurrentImage(),_e("å›¾ç‰‡å·²åˆ é™¤","success"))}function Y(){T.value&&confirm("ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰å›¾ç‰‡å—ï¼Ÿè¿™å°†ä¸¢å¤±æ‰€æœ‰æœªä¿å­˜çš„è¿›åº¦ã€‚")&&(s.clearImages(),_e("æ‰€æœ‰å›¾ç‰‡å·²æ¸…é™¤","success"))}async function u(){try{const F=await wn(),ne=await ho();if(F.success&&ne.success)_e("ä¸´æ—¶æ–‡ä»¶æ¸…ç†å®Œæˆ","success");else{const be=[];F.success||be.push("è°ƒè¯•æ–‡ä»¶æ¸…ç†å¤±è´¥"),ne.success||be.push("ä¸´æ—¶æ–‡ä»¶æ¸…ç†å¤±è´¥"),_e(be.join("ï¼Œ"),"warning")}}catch{_e("æ¸…ç†ä¸´æ—¶æ–‡ä»¶å¤±è´¥","error")}}function h(){k.goToPrevious()}function le(){k.goToNext()}function I(){R.value=!R.value}async function j(){if(!V.value){_e("æ²¡æœ‰å¤±è´¥çš„å›¾ç‰‡éœ€è¦é‡æ–°ç¿»è¯‘","info");return}a("normal")&&await p.retryFailedImages()}async function ce(){if(!T.value){_e("æ²¡æœ‰å¯ä¿å­˜çš„å†…å®¹","warning");return}if(!(!v.value||!g.value))try{await i.saveChapterSession(v.value,g.value)?_e("ç« èŠ‚è¿›åº¦å·²ä¿å­˜","success"):_e("ä¿å­˜å¤±è´¥","error")}catch(F){console.error("ä¿å­˜ä¼šè¯å¤±è´¥:",F),_e("ä¿å­˜å¤±è´¥: "+(F instanceof Error?F.message:"æœªçŸ¥é”™è¯¯"),"error")}}function ye(F){$.value=F,y.value=!0}function De(){ye("plugins")}function $e(){_e("è®¾ç½®å·²ä¿å­˜","success")}function he(){E.value=!0}function ee(){_e("ğŸŒ™ è¯¥åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­ï¼Œæ•¬è¯·æœŸå¾…ï¼","info")}function b(F){const ne=F.target;if(!(ne instanceof HTMLInputElement||ne instanceof HTMLTextAreaElement||ne.getAttribute("contenteditable")==="true"||ne.id==="bubbleTextEditor")&&!R.value&&F.altKey)switch(F.key){case"ArrowLeft":F.preventDefault(),h();break;case"ArrowRight":F.preventDefault(),le();break;case"ArrowUp":if(F.preventDefault(),!o.settings.textStyle.autoFontSize){const ge=o.settings.textStyle.fontSize;o.updateTextStyle({fontSize:ge+1})}break;case"ArrowDown":if(F.preventDefault(),!o.settings.textStyle.autoFontSize){const ge=o.settings.textStyle.fontSize;o.updateTextStyle({fontSize:Math.max(10,ge-1)})}break}}async function J(F){const ne=D.value;if(!ne||!ne.translatedDataURL){console.log(`è‡ªåŠ¨å­—å·è®¾ç½®å˜æ›´: ${F} (ä»…å½±å“ä¸‹æ¬¡ç¿»è¯‘)`);return}const be=ne.bubbleStates;if(!be||!Array.isArray(be)||be.length===0){console.log("å½“å‰å›¾ç‰‡æ²¡æœ‰ bubbleStatesï¼Œè·³è¿‡é‡æ¸²æŸ“");return}if(console.log(`è‡ªåŠ¨å­—å·è®¾ç½®å˜æ›´: ${F}ï¼Œå°†é‡æ–°æ¸²æŸ“...`),F){console.log("è‡ªåŠ¨å­—å·å·²å¼€å¯ï¼Œé‡æ–°è®¡ç®—å­—å·å¹¶æ¸²æŸ“...");try{const{apiClient:ge}=await rt(async()=>{const{apiClient:xe}=await import("./client.Bht704G-.js");return{apiClient:xe}},__vite__mapDeps([4,5]));let Pe="";if(ne.cleanImageData){const xe=ne.cleanImageData;Pe=xe.includes("base64,")?xe.split("base64,")[1]||"":xe}else ne.originalDataURL&&(Pe=ne.originalDataURL.includes("base64,")?ne.originalDataURL.split("base64,")[1]||"":ne.originalDataURL);if(!Pe){console.log("æ²¡æœ‰å¯ç”¨çš„èƒŒæ™¯å›¾ï¼Œè·³è¿‡é‡æ¸²æŸ“");return}const Ee=be.map(xe=>({translatedText:xe.translatedText||"",coords:xe.coords,fontSize:xe.fontSize||o.settings.textStyle.fontSize,fontFamily:xe.fontFamily||o.settings.textStyle.fontFamily,textDirection:Lt(xe),textColor:xe.textColor||o.settings.textStyle.textColor,rotationAngle:xe.rotationAngle||0,position:xe.position||{x:0,y:0},strokeEnabled:xe.strokeEnabled??o.settings.textStyle.strokeEnabled,strokeColor:xe.strokeColor||o.settings.textStyle.strokeColor,strokeWidth:xe.strokeWidth??o.settings.textStyle.strokeWidth})),Le=Ee.map(xe=>xe.translatedText),ke=Ee.map(xe=>xe.coords),Be=await ge.post("/api/re_render_image",{clean_image:Pe,bubble_texts:Le,bubble_coords:ke,fontSize:o.settings.textStyle.fontSize,fontFamily:o.settings.textStyle.fontFamily,textDirection:o.settings.textStyle.layoutDirection==="auto"?"vertical":o.settings.textStyle.layoutDirection,textColor:o.settings.textStyle.textColor,bubble_states:Ee,use_individual_styles:!0,use_inpainting:!1,use_lama:!1,fillColor:null,is_font_style_change:!0,autoFontSize:!0,strokeEnabled:o.settings.textStyle.strokeEnabled,strokeColor:o.settings.textStyle.strokeColor,strokeWidth:o.settings.textStyle.strokeWidth});if(Be.rendered_image){if(Be.bubble_states&&Array.isArray(Be.bubble_states)){const xe=be.map((it,Ge)=>({...it,fontSize:Be.bubble_states[Ge]?.fontSize??it.fontSize}));s.updateCurrentImage({translatedDataURL:`data:image/png;base64,${Be.rendered_image}`,bubbleStates:xe,hasUnsavedChanges:!0}),r.setBubbles(xe)}else s.updateCurrentImage({translatedDataURL:`data:image/png;base64,${Be.rendered_image}`,hasUnsavedChanges:!0});console.log("è‡ªåŠ¨å­—å·æ¸²æŸ“æˆåŠŸ")}else Be.error&&(console.error("è‡ªåŠ¨å­—å·æ¸²æŸ“å¤±è´¥:",Be.error),_e("é‡æ–°æ¸²æŸ“å¤±è´¥: "+Be.error,"error"))}catch(ge){console.error("è‡ªåŠ¨å­—å·æ¸²æŸ“å‡ºé”™:",ge)}}else{const ge=o.settings.textStyle.fontSize;console.log(`è‡ªåŠ¨å­—å·å·²å…³é—­ï¼Œä½¿ç”¨å›ºå®šå­—å· ${ge} æ¸²æŸ“...`);const Pe=be.map(Ee=>({...Ee,fontSize:ge}));s.updateCurrentImage({bubbleStates:Pe}),r.setBubbles(Pe),await ve("fontSize",ge)}}async function ve(F,ne){const be=D.value;if(!be||!be.translatedDataURL||!be.bubbleStates||be.bubbleStates.length===0||!["fontSize","fontFamily","layoutDirection","textColor","strokeEnabled","strokeColor","strokeWidth","fillColor"].includes(F))return;console.log(`å…¨å±€è®¾ç½®å˜æ›´ (${F}=${ne})ï¼Œå‡†å¤‡é‡æ¸²æŸ“...`);const Ee={fontSize:"fontSize",fontFamily:"fontFamily",layoutDirection:"textDirection",textColor:"textColor",strokeEnabled:"strokeEnabled",strokeColor:"strokeColor",strokeWidth:"strokeWidth",fillColor:"fillColor"}[F];if(Ee&&be.bubbleStates)if(F==="layoutDirection")if(ne==="auto"){console.log("æ’ç‰ˆæ–¹å‘è®¾ç½®ä¸º 'auto'ï¼Œä» autoTextDirection æ¢å¤æ¯ä¸ªæ°”æ³¡çš„æ’ç‰ˆæ–¹å‘");const Le=be.bubbleStates.map(ke=>({...ke,textDirection:ke.autoTextDirection==="vertical"||ke.autoTextDirection==="horizontal"?ke.autoTextDirection:"vertical"}));s.updateCurrentImage({bubbleStates:Le}),r.setBubbles(Le)}else{console.log(`æ’ç‰ˆæ–¹å‘è®¾ç½®ä¸º '${ne}'ï¼Œåº”ç”¨åˆ°æ‰€æœ‰æ°”æ³¡`);const Le=be.bubbleStates.map(ke=>({...ke,textDirection:ne}));s.updateCurrentImage({bubbleStates:Le}),r.setBubbles(Le)}else{const Le=be.bubbleStates.map(ke=>({...ke,[Ee]:ne}));s.updateCurrentImage({bubbleStates:Le}),r.setBubbles(Le)}try{const ke=s.currentImage?.bubbleStates||be.bubbleStates||[];if(ke.length===0||!ke[0]?.coords){console.log("æ²¡æœ‰æœ‰æ•ˆçš„æ°”æ³¡åæ ‡ï¼Œè·³è¿‡é‡æ¸²æŸ“");return}const Be=o.settings.textStyle.layoutDirection,xe=ke.map(O=>({translatedText:O.translatedText||"",coords:O.coords,fontSize:O.fontSize||o.settings.textStyle.fontSize,fontFamily:O.fontFamily||o.settings.textStyle.fontFamily,textDirection:Lt(O),textColor:O.textColor||o.settings.textStyle.textColor,rotationAngle:O.rotationAngle||0,position:O.position||{x:0,y:0},strokeEnabled:O.strokeEnabled??o.settings.textStyle.strokeEnabled,strokeColor:O.strokeColor||o.settings.textStyle.strokeColor,strokeWidth:O.strokeWidth??o.settings.textStyle.strokeWidth})),it=xe.map(O=>O.translatedText),Ge=xe.map(O=>O.coords);let Ze="";if(be.cleanImageData){const O=be.cleanImageData;Ze=O.includes("base64,")?O.split("base64,")[1]||"":O}else be.originalDataURL&&(Ze=be.originalDataURL.includes("base64,")?be.originalDataURL.split("base64,")[1]||"":be.originalDataURL,console.log("handleTextStyleChanged: ä½¿ç”¨åŸå›¾ä½œä¸ºèƒŒæ™¯ï¼ˆå…œåº•ï¼‰"));if(!Ze){console.log("æ²¡æœ‰å¯ç”¨çš„èƒŒæ™¯å›¾ï¼Œè·³è¿‡é‡æ¸²æŸ“");return}const{apiClient:st}=await rt(async()=>{const{apiClient:O}=await import("./client.Bht704G-.js");return{apiClient:O}},__vite__mapDeps([4,5])),Ae=await st.post("/api/re_render_image",{clean_image:Ze,bubble_texts:it,bubble_coords:Ge,fontSize:o.settings.textStyle.fontSize,fontFamily:o.settings.textStyle.fontFamily,textDirection:Be==="auto"?"vertical":Be,textColor:o.settings.textStyle.textColor,bubble_states:xe,use_individual_styles:!0,use_inpainting:!1,use_lama:!1,fillColor:null,is_font_style_change:!0,strokeEnabled:o.settings.textStyle.strokeEnabled,strokeColor:o.settings.textStyle.strokeColor,strokeWidth:o.settings.textStyle.strokeWidth});Ae.rendered_image?(s.updateCurrentImage({translatedDataURL:`data:image/png;base64,${Ae.rendered_image}`,hasUnsavedChanges:!0}),console.log("è®¾ç½®å˜æ›´åé‡æ–°æ¸²æŸ“æˆåŠŸ")):Ae.error&&console.error("é‡æ–°æ¸²æŸ“å¤±è´¥:",Ae.error)}catch(Le){console.error("è®¾ç½®å˜æ›´åé‡æ–°æ¸²æŸ“å¤±è´¥:",Le)}}function fe(F){k.switchImage(F)}return(F,ne)=>{const be=ys("router-link");return M(),A("div",{class:Ie(["translate-page",{"edit-mode-active":R.value}])},[e("header",iy,[e("div",ry,[e("div",uy,[Ce(be,{to:"/",title:"è¿”å›ä¹¦æ¶"},{default:St(()=>[...ne[3]||(ne[3]=[e("img",{src:"/pic/logo.png",alt:"Saber-Translator Logo",class:"app-logo"},null,-1),e("span",{class:"app-name"},"Saber-Translator",-1)])]),_:1})]),e("div",cy,[Ce(be,{to:"/",class:"back-to-shelf",title:"è¿”å›ä¹¦æ¶"},{default:St(()=>[...ne[4]||(ne[4]=[me("ğŸ“š",-1)])]),_:1}),L.value?(M(),A("button",{key:0,class:"save-header-btn",title:"ä¿å­˜è¿›åº¦",onClick:ce}," ğŸ’¾ ")):de("",!0),e("button",{id:"openSettingsBtn",class:"settings-header-btn",title:"æ‰“å¼€è®¾ç½®",onClick:ne[0]||(ne[0]=ge=>ye())},[...ne[5]||(ne[5]=[e("span",{class:"icon"},"âš™ï¸",-1),e("span",null,"è®¾ç½®",-1)])]),ne[8]||(ne[8]=e("a",{href:"http://www.mashirosaber.top",target:"_blank",class:"tutorial-link"},"ä½¿ç”¨æ•™ç¨‹",-1)),e("a",{href:"javascript:void(0)",class:"donate-link",onClick:he},[...ne[6]||(ne[6]=[e("span",null,"â¤ï¸ è¯·ä½œè€…å–å¥¶èŒ¶",-1)])]),ne[9]||(ne[9]=e("a",{href:"https://github.com/MashiroSaber03",target:"_blank",class:"github-link"},[e("img",{src:"/pic/github.jpg",alt:"GitHub",class:"github-icon"})],-1)),e("button",{class:"theme-toggle",title:"åŠŸèƒ½å¼€å‘ä¸­",onClick:ee},[...ne[7]||(ne[7]=[e("span",{class:"theme-icon"},"â˜€ï¸",-1)])])])])]),e("div",dy,[Ce(Il,{onTranslateCurrent:te,onTranslateAll:B,onTranslateRange:P,onHqTranslate:d,onHqTranslateRange:S,onProofread:m,onProofreadRange:w,onRemoveText:l,onRemoveAllText:f,onRemoveTextRange:N,onRetryFailed:j,onDeleteCurrent:G,onClearAll:Y,onCleanTemp:u,onOpenPlugins:De,onOpenSettings:ye,onPrevious:h,onNext:le,onApplyToAll:W,onTextStyleChanged:ve,onAutoFontSizeChanged:J}),e("main",gy,[e("section",py,[e("div",my,[Ce(ma,{ref:"imageUploadRef",onUploadComplete:U},null,512)]),H(i).loadingProgress.total>0?(M(),ut(Co,{key:0,visible:!0,percentage:H(i).loadingProgress.current/H(i).loadingProgress.total*100,label:H(i).loadingProgress.message},null,8,["percentage","label"])):de("",!0),Ce(rr,{progress:H(p).progress.value},null,8,["progress"]),q.value&&L.value?(M(),A("div",vy,[...ne[10]||(ne[10]=[e("span",{style:{color:"#888","font-size":"0.85em"}}," ï¼ˆä¹¦æ¶æ¨¡å¼ä¸‹é€€å‡ºå‰è¯·ç‚¹å‡»é¡¶éƒ¨ä¿å­˜æŒ‰é’®ï¼‰ ",-1)])])):de("",!0)]),Ce(Gl,{ref:"imageResultRef","is-edit-mode":R.value,onToggleEditMode:I,onRetryFailed:j},null,8,["is-edit-mode"])]),T.value&&!R.value?(M(),ut(Ur,{key:0,onSelect:fe})):de("",!0)]),D.value&&R.value?(M(),ut(Cf,{key:0,"is-edit-mode-active":R.value,onExit:I},null,8,["is-edit-mode-active"])):de("",!0),Ce(oi,{onOpenSettings:ye}),Ce(pm,{modelValue:y.value,"onUpdate:modelValue":ne[1]||(ne[1]=ge=>y.value=ge),"initial-tab":$.value,onSave:$e},null,8,["modelValue","initial-tab"]),E.value?(M(),ut(cr,{key:1,onClose:ne[2]||(ne[2]=ge=>E.value=!1)})):de("",!0),Ce(ly),Ce(Gh)],2)}}}),$y=He(fy,[["__scopeId","data-v-626f57c5"]]);export{$y as default};
