const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["js/system.BYrUrKi-.js","js/index.DkuoOOnN.js","js/vue-vendor.DIYfje1l.js","assets/index.BYanE9pL.css","js/client.Bht704G-.js","js/utils-vendor.B9ygI19o.js","js/session.C_VZSWrV.js"])))=>i.map(i=>d[i]);
import{D as yn,b as bo,c as ho,d as xo,e as _n,f as yt,a as it,_ as He,g as ze,s as _e,u as ct,h as vs,i as fs,j as bs,k as hs,l as xs,m as ys,n as _s,o as Zo,p as Qo,B as en,q as tn,r as Cs,F as go,t as on,v as nn,w as Ss,L as sn,S as an,W as ks}from"./index.DkuoOOnN.js";import{d as Xt,r as w,c as X,a as je,e as L,h as ce,f as e,t as oe,i as st,k as A,g as ut,n as Ie,u as me,o as dt,v as ne,x as Oe,l as Ce,s as ln,m as St,K as Qe,D as K,F as Ve,j as Ye,M as yo,N as ws,L as Cn,w as Se,B as pt,O as $t,z as Te,p as at,P as vo,b as Nt,Q as kt,S as rn,A as Sn,U as $s,T as kn,C as Ts}from"./vue-vendor.DIYfje1l.js";import{p as Is,a as Ps,b as Rs,c as Ds,d as Ms,e as Es,f as Bs,h as As,i as Ls,j as Fs,k as _o,l as wn}from"./system.BYrUrKi-.js";import{getFontList as $n,uploadFont as Us,getTextboxPrompts as Os,getPrompts as zs,configApi as qe,getFontListApi as Ns}from"./config.CwRcCkM9.js";import{_ as Ke}from"./CustomSelect.vue_vue_type_style_index_0_lang.BbTiIb--.js";import{apiClient as Xe}from"./client.Bht704G-.js";import{B as Tn}from"./BaseModal.DMkJmu4S.js";import{getBookDetail as Vs}from"./bookshelf.B4ums9uK.js";import"./utils-vendor.B9ygI19o.js";function un(){return{firecrawl:{apiKey:""},agent:{provider:"openai",apiKey:"",customBaseUrl:"",modelName:"gpt-4o-mini",useStream:!1,forceJsonOutput:!0,maxRetries:3,timeout:120},extraction:{prompt:yn,maxIterations:10},download:{concurrency:3,timeout:30,retries:3,delay:100,useReferer:!0},imagePreprocess:{enabled:!1,autoRotate:!0,compression:{enabled:!1,quality:85,maxWidth:0,maxHeight:0},formatConvert:{enabled:!1,targetFormat:"original"}},advanced:{customCookie:"",customHeaders:"",bypassProxy:!1},ui:{showAgentLogs:!0,autoImport:!1}}}function Ws(n,t){function s(i){n.value.firecrawl.apiKey=i,t()}function o(i){n.value.agent.provider=i,t()}function l(i){n.value.agent.apiKey=i,t()}function u(i){n.value.agent.customBaseUrl=i,t()}function a(i){n.value.agent.modelName=i,t()}function c(i){n.value.agent.useStream=i,t()}function m(i){n.value.agent.forceJsonOutput=i,t()}function p(i){n.value.agent.timeout=i,t()}function _(i){n.value.extraction.prompt=i,t()}function T(i){n.value.extraction.maxIterations=i,t()}function M(){n.value.extraction.prompt=yn,t()}function R(i){n.value.download.concurrency=i,t()}function I(i){n.value.download.timeout=i,t()}function E(i){n.value.download.retries=i,t()}function H(i){n.value.download.delay=i,t()}function V(i){n.value.download.useReferer=i,t()}function F(i){n.value.imagePreprocess.enabled=i,t()}function b(i){n.value.imagePreprocess.autoRotate=i,t()}function v(i){n.value.imagePreprocess.compression.enabled=i,t()}function k(i){n.value.imagePreprocess.compression.quality=i,t()}function $(i){n.value.imagePreprocess.compression.maxWidth=i,t()}function N(i){n.value.imagePreprocess.compression.maxHeight=i,t()}function z(i){n.value.imagePreprocess.formatConvert.enabled=i,t()}function ae(i){n.value.imagePreprocess.formatConvert.targetFormat=i,t()}function j(i){n.value.advanced.customCookie=i,t()}function q(i){n.value.advanced.customHeaders=i,t()}function Q(i){n.value.advanced.bypassProxy=i,t()}function W(i){n.value.ui.showAgentLogs=i,t()}function se(i){n.value.ui.autoImport=i,t()}function S(i){n.value={...n.value,...i},t()}return{setFirecrawlApiKey:s,setAgentProvider:o,setAgentApiKey:l,setAgentBaseUrl:u,setAgentModelName:a,setAgentUseStream:c,setAgentForceJson:m,setAgentTimeout:p,setExtractionPrompt:_,setExtractionMaxIterations:T,resetExtractionPrompt:M,setDownloadConcurrency:R,setDownloadTimeout:I,setDownloadRetries:E,setDownloadDelay:H,setDownloadUseReferer:V,setImagePreprocessEnabled:F,setImageAutoRotate:b,setImageCompressionEnabled:v,setImageCompressionQuality:k,setImageMaxWidth:$,setImageMaxHeight:N,setImageFormatConvertEnabled:z,setImageTargetFormat:ae,setCustomCookie:j,setCustomHeaders:q,setBypassProxy:Q,setShowAgentLogs:W,setAutoImport:se,updateWebImportSettings:S}}async function Co(n){return Xe.post("/api/re_render_image",n)}async function Lt(n){try{return{success:!0,data:await Xe.post("/api/translate_single_text",n)}}catch(t){return{success:!1,error:t instanceof Error?t.message:"ç¿»è¯‘å¤±è´¥"}}}async function Ft(n){return Xe.post("/api/hq_translate_batch",n)}async function fo(n,t,s){return Xe.post("/api/detect_boxes",{image:n,detector_type:t,...s})}async function In(n,t,s,o){return Xe.post("/api/ocr_single_bubble",{image_data:n,bubble_coords:t,ocr_engine:s,...o})}async function So(n,t,s){return Xe.post("/api/inpaint_single_bubble",{image_data:n,bubble_coords:t,bubble_angle:s?.bubbleAngle??0,method:s?.method??"lama",lama_model:s?.lamaModel??"lama_mpe",...s?.maskData&&{mask_data:s.maskData}})}const Ks=Object.freeze(Object.defineProperty({__proto__:null,detectBoxes:fo,hqTranslateBatch:Ft,inpaintSingleBubble:So,ocrSingleBubble:In,reRenderImage:Co,translateSingleText:Lt},Symbol.toStringTag,{value:"Module"}));async function Pn(n,t){return Xe.post(`/api/sessions/meta/${n}`,t)}async function Jt(n,t,s,o){return Xe.post(`/api/sessions/page/${n}/${t}/${s}`,{data:o})}async function Rn(n,t,s){return Xe.post(`/api/sessions/page/${n}/${t}/meta`,s)}async function Dn(n,t,s){return Xe.post(`/api/sessions/save_translated/${n}/${t}`,s)}function Yt(n){if(!n||typeof n!="string"||n.startsWith("/api/"))return null;if(n.startsWith("data:")){const t=n.split(",");return t.length>1?t[1]??null:null}return n}async function qs(n,t,s){const o=t.length;let l=0;for(let u=0;u<o;u++){const a=t[u];if(a){s?.onProgress?.(u+1,o);try{const c=Yt(a.originalDataURL);c&&await Jt(n,u,"original",c);const m=Yt(a.translatedDataURL);m&&await Jt(n,u,"translated",m);const p=Yt(a.cleanImageData);p&&await Jt(n,u,"clean",p);const _={fileName:a.fileName,translationStatus:a.translationStatus,translationFailed:a.translationFailed,bubbleStates:a.bubbleStates,isManuallyAnnotated:a.isManuallyAnnotated,relativePath:a.relativePath,folderPath:a.folderPath,fontSize:a.fontSize,autoFontSize:a.autoFontSize,fontFamily:a.fontFamily,layoutDirection:a.layoutDirection,useAutoTextColor:a.useAutoTextColor,textColor:a.textColor,fillColor:a.fillColor,inpaintMethod:a.inpaintMethod,strokeEnabled:a.strokeEnabled,strokeColor:a.strokeColor,strokeWidth:a.strokeWidth};await Rn(n,u,_),l++}catch(c){console.error(`ä¿å­˜ç¬¬ ${u+1} é¡µå¤±è´¥:`,c)}}}return l}const Mn=Object.freeze(Object.defineProperty({__proto__:null,extractBase64:Yt,saveAllPagesSequentially:qs,savePageImage:Jt,savePageMeta:Rn,saveSessionMeta:Pn,saveTranslatedPage:Dn},Symbol.toStringTag,{value:"Module"}));async function Hs(){return Xe.get("/api/plugins")}async function js(n){const t=encodeURIComponent(n);return Xe.post(`/api/plugins/${t}/enable`)}async function Js(n){const t=encodeURIComponent(n);return Xe.post(`/api/plugins/${t}/disable`)}async function Ys(n){const t=encodeURIComponent(n);return Xe.delete(`/api/plugins/${t}`)}async function Xs(n){const t=encodeURIComponent(n);return Xe.get(`/api/plugins/${t}/config_schema`)}async function Gs(n){const t=encodeURIComponent(n);return Xe.get(`/api/plugins/${t}/config`)}async function Zs(n,t){const s=encodeURIComponent(n);return Xe.post(`/api/plugins/${s}/config`,t)}async function Qs(){return Xe.get("/api/plugins/default_states")}async function ea(n,t){const s=encodeURIComponent(n);return Xe.post(`/api/plugins/${s}/set_default_state`,{enabled:t})}async function ta(){return{states:(await Qs()).default_states}}const oa=ea,na=Xs,sa=Gs,aa=Zs;function la(){return`img_${Date.now()}_${Math.random().toString(36).substring(2,9)}`}function cn(n,t,s){return{id:la(),fileName:n,originalDataURL:t,translatedDataURL:null,cleanImageData:null,bubbleStates:null,translationStatus:"pending",translationFailed:!1,fontSize:25,autoFontSize:!1,fontFamily:yt,layoutDirection:"auto",textColor:"#000000",fillColor:_n,inpaintMethod:"solid",strokeEnabled:xo,strokeColor:ho,strokeWidth:bo,hasUnsavedChanges:!1,...s}}const et=Xt("image",()=>{const n=w([]),t=w(-1),s=w(!1),o=X(()=>t.value>=0&&t.value<n.value.length?n.value[t.value]??null:null),l=X(()=>n.value.length),u=X(()=>n.value.length>0),a=X(()=>t.value>0),c=X(()=>t.value<n.value.length-1),m=X(()=>n.value.filter(i=>i.translationFailed).length),p=X(()=>n.value.filter(i=>i.translationStatus==="completed").length),_=X(()=>n.value.filter(i=>i.translationStatus==="pending").length);function T(i,P,d){const g=cn(i,P,d);return n.value.push(g),n.value.length===1&&(t.value=0),console.log(`å›¾ç‰‡å·²æ·»åŠ : ${i}ï¼Œå½“å‰å…± ${n.value.length} å¼ å›¾ç‰‡`),g}function M(i){const P=i.map(({fileName:g,originalDataURL:f,overrides:x})=>cn(g,f,x)),d=n.value.length===0;return n.value.push(...P),d&&n.value.length>0&&(t.value=0),console.log(`æ‰¹é‡æ·»åŠ äº† ${P.length} å¼ å›¾ç‰‡ï¼Œå½“å‰å…± ${n.value.length} å¼ `),P}function R(i){n.value=i.map(P=>({...P,strokeEnabled:P.strokeEnabled??xo,strokeColor:P.strokeColor||ho,strokeWidth:P.strokeWidth??bo,hasUnsavedChanges:P.hasUnsavedChanges||!1})),n.value.length>0?t.value=Math.min(Math.max(0,t.value),n.value.length-1):t.value=-1,console.log(`å›¾ç‰‡æ•°ç»„å·²è®¾ç½®ï¼Œå…± ${n.value.length} å¼ å›¾ç‰‡`)}function I(i){return i<0||i>=n.value.length?(console.warn(`åˆ é™¤å¤±è´¥: æ— æ•ˆçš„ç´¢å¼• ${i}`),!1):(n.value.splice(i,1),t.value===i?(t.value=Math.min(i,n.value.length-1),n.value.length===0&&(t.value=-1)):t.value>i&&t.value--,console.log(`å›¾ç‰‡å·²åˆ é™¤ï¼Œå½“å‰å…± ${n.value.length} å¼ å›¾ç‰‡`),!0)}function E(){return I(t.value)}function H(){n.value=[],t.value=-1,s.value=!1,console.log("æ‰€æœ‰å›¾ç‰‡å·²æ¸…é™¤")}function V(){const i=o.value?.id||null;if(n.value.sort((P,d)=>P.fileName.localeCompare(d.fileName,void 0,{numeric:!0,sensitivity:"base"})),i){const P=n.value.findIndex(d=>d.id===i);P>=0&&P!==t.value&&(console.log(`å›¾ç‰‡æ’åº: currentImageIndex ä» ${t.value} æ›´æ–°ä¸º ${P}`),t.value=P)}console.log("å›¾ç‰‡å·²æŒ‰æ–‡ä»¶åæ’åº")}function F(i){i>=-1&&i<n.value.length?(t.value=i,console.log(`å½“å‰å›¾ç‰‡ç´¢å¼•å·²è®¾ç½®ä¸º ${i}`)):console.warn(`è®¾ç½®ç´¢å¼•å¤±è´¥: æ— æ•ˆçš„ç´¢å¼• ${i}`)}function b(){return a.value?(t.value--,!0):!1}function v(){return c.value?(t.value++,!0):!1}function k(i){o.value?(Object.assign(o.value,i),console.log("å½“å‰å›¾ç‰‡å±æ€§å·²æ›´æ–°:",Object.keys(i))):console.warn("æ›´æ–°å¤±è´¥: å½“å‰æ²¡æœ‰é€‰ä¸­çš„å›¾ç‰‡")}function $(i,P){if(i>=0&&i<n.value.length){const d=n.value[i];d&&(Object.assign(d,P),console.log(`å›¾ç‰‡ ${i} å±æ€§å·²æ›´æ–°:`,Object.keys(P)))}else console.warn(`æ›´æ–°å¤±è´¥: æ— æ•ˆçš„ç´¢å¼• ${i}`)}function N(i){o.value&&(o.value.bubbleStates=i,o.value.hasUnsavedChanges=!0,console.log(`å½“å‰å›¾ç‰‡æ°”æ³¡çŠ¶æ€å·²æ›´æ–°ï¼Œå…± ${i?.length??0} ä¸ªæ°”æ³¡`))}function z(i){o.value&&(o.value.isManuallyAnnotated=i,o.value.hasUnsavedChanges=!0,console.log(`æ‰‹åŠ¨æ ‡æ³¨æ ‡è®°å·²è®¾ç½®ä¸º: ${i}`))}function ae(i,P){o.value?(o.value[i]=P,o.value.hasUnsavedChanges=!0,console.log(`å½“å‰å›¾ç‰‡å±æ€§ ${String(i)} å·²æ›´æ–°`)):console.warn("æ›´æ–°å¤±è´¥: å½“å‰æ²¡æœ‰é€‰ä¸­çš„å›¾ç‰‡")}function j(i,P){o.value&&(o.value.translatedDataURL=i,P&&(o.value.cleanImageData=P),o.value.translationStatus="completed",o.value.translationFailed=!1,o.value.hasUnsavedChanges=!0,console.log("å½“å‰å›¾ç‰‡ç¿»è¯‘ç»“æœå·²æ›´æ–°"))}function q(i,P,d){if(i>=0&&i<n.value.length){const g=n.value[i];g&&(g.translationStatus=P,g.translationFailed=P==="failed",d&&(g.errorMessage=d),console.log(`å›¾ç‰‡ ${i} ç¿»è¯‘çŠ¶æ€: ${P}`))}}function Q(i){o.value&&(o.value.translationStatus="failed",o.value.translationFailed=!0,o.value.errorMessage=i,console.log(`å½“å‰å›¾ç‰‡ç¿»è¯‘å¤±è´¥: ${i}`))}function W(){n.value.forEach(i=>{i.translationStatus="pending",i.translationFailed=!1,i.errorMessage=void 0}),console.log("æ‰€æœ‰å›¾ç‰‡ç¿»è¯‘çŠ¶æ€å·²é‡ç½®")}function se(i){s.value=i,console.log(`æ‰¹é‡ç¿»è¯‘çŠ¶æ€: ${i?"è¿›è¡Œä¸­":"å·²å®Œæˆ"}`)}function S(){return n.value.map((i,P)=>i.translationFailed?P:-1).filter(i=>i!==-1)}return{images:n,currentImageIndex:t,isBatchTranslationInProgress:s,currentImage:o,imageCount:l,hasImages:u,canGoPrevious:a,canGoNext:c,failedImageCount:m,completedImageCount:p,pendingImageCount:_,addImage:T,addImages:M,setImages:R,deleteImage:I,deleteCurrentImage:E,clearImages:H,sortImagesByFileName:V,setCurrentImageIndex:F,goToPrevious:b,goToNext:v,updateCurrentImage:k,updateImageByIndex:$,updateCurrentBubbleStates:N,setManuallyAnnotated:z,updateCurrentImageProperty:ae,updateCurrentTranslationResult:j,setTranslationStatus:q,markCurrentAsFailed:Q,resetAllTranslationStatus:W,setBatchTranslationInProgress:se,getFailedImageIndices:S}}),dn=Object.freeze(Object.defineProperty({__proto__:null,useImageStore:et},Symbol.toStringTag,{value:"Module"})),It=Xt("session",()=>{const n=w(null),t=w({bookId:null,chapterId:null,bookTitle:null,chapterTitle:null}),s=w([]),o=w(!1),l=w({current:0,total:0,message:""}),u=w(null),a=w(!1),c=X(()=>t.value.bookId!==null&&t.value.chapterId!==null),m=X(()=>t.value.bookId),p=X(()=>t.value.chapterId);function _(Q,W,se=null,S=null){t.value={bookId:Q,chapterId:W,bookTitle:se,chapterTitle:S},console.log(`ä¼šè¯ä¸Šä¸‹æ–‡å·²è®¾ç½®: ä¹¦ç±=${Q}, ç« èŠ‚=${W}`)}function T(Q,W,se,S){_(Q,W,se,S)}function M(){t.value={bookId:null,chapterId:null,bookTitle:null,chapterTitle:null},console.log("ä¼šè¯ä¸Šä¸‹æ–‡å·²æ¸…é™¤")}function R(Q){const W=Q.get("book"),se=Q.get("chapter");W&&se&&_(W,se)}function I(Q){n.value=Q,console.log(`å½“å‰ä¼šè¯åç§°: ${Q}`)}function E(){n.value=null}function H(Q){s.value=Q,console.log(`ä¼šè¯åˆ—è¡¨å·²æ›´æ–°ï¼Œå…± ${Q.length} ä¸ªä¼šè¯`)}function V(Q){const W=s.value.findIndex(se=>se.name===Q.name);W>=0?s.value[W]=Q:s.value.unshift(Q)}function F(Q){const W=s.value.findIndex(se=>se.name===Q);W>=0&&s.value.splice(W,1)}function b(Q,W){const se=s.value.find(S=>S.name===Q);se&&(se.name=W)}function v(Q){o.value=Q}function k(Q){a.value=Q}function $(Q){u.value=Q}function N(){n.value=null,t.value={bookId:null,chapterId:null,bookTitle:null,chapterTitle:null},s.value=[],o.value=!1,a.value=!1,u.value=null,console.log("ä¼šè¯çŠ¶æ€å·²é‡ç½®")}async function z(Q){if(!Q||typeof Q!="string")return null;if(Q.startsWith("data:"))return Q;if(!Q.startsWith("/api/"))return null;try{const W=await fetch(Q);if(!W.ok)return null;const se=await W.blob();return new Promise(S=>{const i=new FileReader;i.onloadend=()=>S(i.result),i.onerror=()=>S(null),i.readAsDataURL(se)})}catch(W){return console.error(`è½¬æ¢å›¾ç‰‡ URL å¤±è´¥: ${Q}`,W),null}}async function ae(Q,W){const se=Q.length;for(let S=0;S<se;S++){const i=Q[S];if(i){if(W&&W(S+1,se),i.originalDataURL&&i.originalDataURL.startsWith("/api/")){const P=await z(i.originalDataURL);P&&(i.originalDataURL=P)}if(i.translatedDataURL&&i.translatedDataURL.startsWith("/api/")){const P=await z(i.translatedDataURL);P&&(i.translatedDataURL=P)}if(i.cleanImageData&&i.cleanImageData.startsWith("/api/")){const P=await z(i.cleanImageData);P&&(i.cleanImageData=P.replace(/^data:image\/\w+;base64,/,""))}}}}async function j(Q){v(!0),$(null),l.value={current:0,total:0,message:"æ­£åœ¨åŠ è½½..."};try{const{useImageStore:W}=await it(async()=>{const{useImageStore:D}=await Promise.resolve().then(()=>dn);return{useImageStore:D}},void 0),{useSettingsStore:se}=await it(async()=>{const{useSettingsStore:D}=await import("./system.BYrUrKi-.js").then(Y=>Y.s);return{useSettingsStore:D}},__vite__mapDeps([0,1,2,3,4,5])),{useBubbleStore:S}=await it(async()=>{const{useBubbleStore:D}=await Promise.resolve().then(()=>fi);return{useBubbleStore:D}},void 0),i=W(),P=se(),d=S(),{loadSessionByPathApi:g}=await it(async()=>{const{loadSessionByPathApi:D}=await import("./session.C_VZSWrV.js");return{loadSessionByPathApi:D}},__vite__mapDeps([6,4,5])),f=await g(Q);if(!f.success||!f.session)throw new Error(f.error||"åŠ è½½ä¼šè¯å¤±è´¥");const x=f.session;if(x.images&&x.images.length>0){const D=x.images.map((r,y)=>({id:`session-${y}-${Date.now()}`,originalDataURL:r.originalDataURL,translatedDataURL:r.translatedDataURL||null,cleanImageData:r.cleanImageData||null,bubbleStates:r.bubbleStates!==void 0&&r.bubbleStates!==null?r.bubbleStates:null,isManuallyAnnotated:!!r.isManuallyAnnotated,relativePath:r.relativePath||void 0,folderPath:r.folderPath||void 0,fileName:r.fileName||`image-${y+1}.png`,translationStatus:r.translationStatus||"pending",translationFailed:!!r.translationFailed,hasUnsavedChanges:!1,fontSize:r.fontSize||24,autoFontSize:r.autoFontSize??!1,fontFamily:r.fontFamily||"Microsoft YaHei",layoutDirection:r.layoutDirection||"auto",useAutoTextColor:r.useAutoTextColor??void 0,textColor:r.textColor||"#000000",fillColor:r.fillColor||"#FFFFFF",inpaintMethod:r.inpaintMethod||"litelama",strokeEnabled:r.strokeEnabled??!1,strokeColor:r.strokeColor||"#FFFFFF",strokeWidth:r.strokeWidth||2}));D.length>0&&(console.log("æ­£åœ¨åŠ è½½å›¾ç‰‡..."),l.value={current:0,total:D.length,message:"æ­£åœ¨åŠ è½½å›¾ç‰‡..."},await ae(D,(r,y)=>{const le=r/y*100;l.value={current:r,total:y,message:`åŠ è½½å›¾ç‰‡ ${r}/${y}...`},console.log(`åŠ è½½å›¾ç‰‡ ${r}/${y}... (${le.toFixed(0)}%)`)}),l.value={current:D.length,total:D.length,message:"åŠ è½½å®Œæˆ"},console.log("å›¾ç‰‡åŠ è½½å®Œæˆï¼Œå·²è½¬æ¢ä¸º Base64"),setTimeout(()=>{l.value={current:0,total:0,message:""}},500)),i.setImages(D);let Y=0;typeof x.currentImageIndex=="number"&&(Y=x.currentImageIndex,(Y>=D.length||Y<0)&&(Y=D.length>0?0:-1)),i.setCurrentImageIndex(Y);const Z=D[Y];Z&&Z.bubbleStates&&Z.bubbleStates.length>0?d.setBubbles(Z.bubbleStates,!0):d.clearBubblesLocal(),console.log(`æŒ‰è·¯å¾„åŠ è½½ä¼šè¯æˆåŠŸ: ${Q}, å…± ${D.length} å¼ å›¾ç‰‡`)}const h=x.ui_settings;if(h){(h.targetLanguage||h.sourceLanguage)&&P.updateSettings({targetLanguage:h.targetLanguage||void 0,sourceLanguage:h.sourceLanguage||void 0});const D=h.useInpaintingMethod,Z=["solid","lama_mpe","litelama"].includes(D)?D:P.settings.textStyle.inpaintMethod;P.updateTextStyle({fontSize:h.fontSize||P.settings.textStyle.fontSize,autoFontSize:h.autoFontSize??P.settings.textStyle.autoFontSize,fontFamily:h.fontFamily||P.settings.textStyle.fontFamily,layoutDirection:h.layoutDirection||P.settings.textStyle.layoutDirection,textColor:h.textColor||P.settings.textStyle.textColor,fillColor:h.fillColor||P.settings.textStyle.fillColor,inpaintMethod:Z,strokeEnabled:h.strokeEnabled??P.settings.textStyle.strokeEnabled,strokeColor:h.strokeColor||P.settings.textStyle.strokeColor,strokeWidth:h.strokeWidth||P.settings.textStyle.strokeWidth,useAutoTextColor:h.useAutoTextColor??P.settings.textStyle.useAutoTextColor}),console.log("UI è®¾ç½®å·²æ¢å¤")}return I(Q),!0}catch(W){const se=W instanceof Error?W.message:"åŠ è½½ä¼šè¯å¤±è´¥";throw $(se),console.error(`æŒ‰è·¯å¾„åŠ è½½ä¼šè¯å¤±è´¥: ${Q}`,W),W}finally{v(!1)}}async function q(Q,W){if(!Q||!W)return console.log("æœªåœ¨ä¹¦ç±/ç« èŠ‚æ¨¡å¼ï¼Œä¸æ”¯æŒä¿å­˜"),!1;console.log(`ä¿å­˜ç« èŠ‚ä¼šè¯: book=${Q}, chapter=${W}`);const{useImageStore:se}=await it(async()=>{const{useImageStore:x}=await Promise.resolve().then(()=>dn);return{useImageStore:x}},void 0),{useSettingsStore:S}=await it(async()=>{const{useSettingsStore:x}=await import("./system.BYrUrKi-.js").then(h=>h.s);return{useSettingsStore:x}},__vite__mapDeps([0,1,2,3,4,5])),i=se(),P=S(),d=Array.isArray(i.images)?i.images:[];if(!d||d.length===0)return console.log("æ²¡æœ‰å›¾ç‰‡æ•°æ®å¯ä¿å­˜"),!1;const g=`bookshelf/${Q}/${W}`;k(!0),$(null);const f=d.length;l.value={current:0,total:f,message:`å‡†å¤‡ä¿å­˜ ${f} å¼ å›¾ç‰‡...`};try{d.some(y=>y.originalDataURL&&y.originalDataURL.startsWith("/api/")||y.translatedDataURL&&y.translatedDataURL.startsWith("/api/")||y.cleanImageData&&y.cleanImageData.startsWith("/api/"))&&(console.log("[saveChapterSession] æ£€æµ‹åˆ° /api/ URL æ ¼å¼å›¾ç‰‡ï¼Œå¼€å§‹è½¬æ¢ä¸º Base64..."),l.value={current:0,total:f,message:"è½¬æ¢å›¾ç‰‡æ ¼å¼..."},await ae(d,(y,le)=>{l.value={current:0,total:f,message:`è½¬æ¢å›¾ç‰‡ ${y}/${le}...`}}),console.log("[saveChapterSession] å›¾ç‰‡æ ¼å¼è½¬æ¢å®Œæˆ"));const{textStyle:h}=P.settings,D={fontSize:h.fontSize,autoFontSize:h.autoFontSize,fontFamily:h.fontFamily,layoutDirection:h.layoutDirection,textColor:h.textColor,useInpaintingMethod:h.inpaintMethod,fillColor:h.fillColor,strokeEnabled:h.strokeEnabled,strokeColor:h.strokeColor,strokeWidth:h.strokeWidth,useAutoTextColor:h.useAutoTextColor},{saveAllPagesSequentially:Y,saveSessionMeta:Z}=await it(async()=>{const{saveAllPagesSequentially:y,saveSessionMeta:le}=await Promise.resolve().then(()=>Mn);return{saveAllPagesSequentially:y,saveSessionMeta:le}},void 0),r=await Y(g,d,{onProgress:(y,le)=>{l.value={current:y,total:le,message:`ä¿å­˜å›¾ç‰‡ ${y}/${le}...`}}});l.value={current:f,total:f,message:"å®Œæˆä¿å­˜..."},await Z(g,{ui_settings:D,total_pages:f,currentImageIndex:i.currentImageIndex}),console.log(`ç« èŠ‚ä¿å­˜å®Œæˆ: ${r}/${f} å¼ å›¾ç‰‡`);try{const{apiClient:y}=await it(async()=>{const{apiClient:le}=await import("./client.Bht704G-.js");return{apiClient:le}},__vite__mapDeps([4,5]));await y.put(`/api/bookshelf/books/${Q}/chapters/${W}/image-count`,{count:f})}catch(y){console.warn("æ›´æ–°ç« èŠ‚å›¾ç‰‡æ•°é‡å¤±è´¥ï¼ˆéè‡´å‘½ï¼‰:",y)}return l.value={current:f,total:f,message:"ä¿å­˜å®Œæˆ"},setTimeout(()=>{l.value={current:0,total:0,message:""}},1e3),!0}catch(x){const h=x instanceof Error?x.message:"ä¿å­˜ç« èŠ‚ä¼šè¯å¤±è´¥";return $(h),console.error("ä¿å­˜å¤±è´¥:",x),l.value={current:0,total:0,message:""},!1}finally{k(!1)}}return{currentSessionName:n,context:t,sessionList:s,isLoading:o,isSaving:a,error:u,loadingProgress:l,isBookshelfMode:c,currentBookId:m,currentChapterId:p,setContext:_,clearContext:M,parseContextFromUrl:R,setSessionName:I,clearSessionName:E,setSessionList:H,addToSessionList:V,removeFromSessionList:F,renameInSessionList:b,setLoading:v,setSaving:k,setError:$,imageUrlToBase64:z,saveChapterSession:q,loadSessionByPath:j,setBookChapterContext:T,reset:N}}),Vt={originalText:"",translatedText:"",textboxText:"",coords:[0,0,100,100],polygon:[],fontSize:25,fontFamily:yt,textDirection:"vertical",autoTextDirection:"vertical",textColor:"#000000",fillColor:_n,rotationAngle:0,position:{x:0,y:0},strokeEnabled:xo,strokeColor:ho,strokeWidth:bo,inpaintMethod:"solid",autoFgColor:null,autoBgColor:null,colorConfidence:0};function ia(n){return{...{...Vt,...n},coords:n?.coords?[...n.coords]:[...Vt.coords],polygon:n?.polygon?n.polygon.map(s=>[...s]):[],position:n?.position?{...Vt.position,...n.position}:{...Vt.position}}}function ra(n){const[t,s,o,l]=n,u=Math.abs(o-t);return Math.abs(l-s)>u?"vertical":"horizontal"}function Wt(n){return n.map(t=>({...t,coords:[...t.coords],polygon:t.polygon?t.polygon.map(s=>[...s]):[],position:{...t.position},autoFgColor:t.autoFgColor?[...t.autoFgColor]:null,autoBgColor:t.autoBgColor?[...t.autoBgColor]:null}))}function ua(n){if(!n||typeof n!="object")return!1;const t=n;if(!Array.isArray(t.coords)||t.coords.length!==4||!t.coords.every(l=>typeof l=="number"&&!isNaN(l))||typeof t.fontSize!="number"||t.fontSize<=0)return!1;const s=["vertical","horizontal","auto"];if(typeof t.textDirection!="string"||!s.includes(t.textDirection))return!1;const o=["solid","lama_mpe","litelama"];return!(typeof t.inpaintMethod!="string"||!o.includes(t.inpaintMethod))}function ca(n){let t=n,s=0,o=0,l=Date.now();const u=()=>t<=0?0:Math.ceil(6e4/t);return{async acquire(){if(t<=0)return;const a=Date.now(),c=u();if(a-l>=6e4&&(l=a,o=0),o>=t){const p=6e4-(a-l);p>0&&await gn(p),l=Date.now(),o=0}const m=a-s;m<c&&await gn(c-m),s=Date.now(),o++},reset(){s=0,o=0,l=Date.now()},getRpm(){return t},setRpm(a){t=a,this.reset()}}}function gn(n){return new Promise(t=>setTimeout(t,n))}function pn(n){const t=n.replace(/\\/g,"/"),s=[],o=/(\d+)/g;let l=0,u;for(;(u=o.exec(t))!==null;){if(u.index>l){const a=t.slice(l,u.index);a&&s.push([!0,a.toLowerCase()])}s.push([!1,parseInt(u[0],10)]),l=o.lastIndex}if(l<t.length){const a=t.slice(l);a&&s.push([!0,a.toLowerCase()])}return s}function da(n,t){const s=pn(n),o=pn(t),l=Math.min(s.length,o.length);for(let u=0;u<l;u++){const[a,c]=s[u],[m,p]=o[u];if(a!==m)return a?1:-1;if(c<p)return-1;if(c>p)return 1}return s.length-o.length}function ga(n,t=s=>String(s)){return[...n].sort((s,o)=>da(t(s),t(o)))}const pa={key:0,class:"translation-progress-bar"},ma={class:"progress-bar-label"},va={class:"progress-bar"},fa=je({__name:"ProgressBar",props:{visible:{type:Boolean,default:!0},percentage:{},label:{default:"è¿›åº¦"}},setup(n){return(t,s)=>n.visible?(A(),L("div",pa,[e("div",ma,oe(n.label),1),e("div",va,[e("div",{class:"progress",style:st({width:`${n.percentage}%`})},null,4)])])):ce("",!0)}}),ko=He(fa,[["__scopeId","data-v-f915cadf"]]),ba={class:"image-upload"},ha={class:"error-text"},xa={key:2,class:"loading-overlay"},ya=je({__name:"ImageUpload",emits:["uploadComplete"],setup(n,{expose:t,emit:s}){const o=s,l=et(),u=ze(),a=w(null),c=w(null),m=w(!1),p=w(!1),_=w(""),T=w(0),M=w(""),R=w(!1),I=X(()=>u.settings.pdfProcessingMethod);function E(){a.value?.click()}function H(){c.value?.click()}async function V(S){const i=S.target;if(!i.files||i.files.length===0)return;const d=Array.from(i.files).filter(f=>f.type.startsWith("image/"));if(d.length===0){_e("æ‰€é€‰æ–‡ä»¶å¤¹ä¸­æ²¡æœ‰æ‰¾åˆ°å›¾ç‰‡æ–‡ä»¶","warning"),i.value="";return}const g=ga(d,f=>f.webkitRelativePath);console.log(`ä»æ–‡ä»¶å¤¹å¯¼å…¥ ${g.length} å¼ å›¾ç‰‡`),await F(g),i.value=""}async function F(S){if(S.length!==0){m.value=!0,R.value=!0,T.value=0;try{let i=0;const P=S.length;for(let d=0;d<S.length;d++){const g=S[d];if(!g||!g.type.startsWith("image/"))continue;M.value=g.name;const f=g.webkitRelativePath||"",x=f.includes("/")?f.substring(0,f.lastIndexOf("/")):"";await new Promise((h,D)=>{const Y=new FileReader;Y.onload=Z=>{const r=Z.target?.result;l.addImage(g.name,r,{relativePath:f,folderPath:x}),h()},Y.onerror=()=>D(new Error(`è¯»å–å›¾ç‰‡å¤±è´¥: ${g.name}`)),Y.readAsDataURL(g)}),i++,T.value=Math.round((d+1)/P*100)}i>0&&(_e(`å·²æ·»åŠ  ${i} å¼ å›¾ç‰‡`,"success"),o("uploadComplete",i))}catch(i){console.error("å¤„ç†æ–‡ä»¶å¤±è´¥:",i);const P=i instanceof Error?i.message:"å¤„ç†æ–‡ä»¶å¤±è´¥";_e(P,"error")}finally{m.value=!1,R.value=!1}}}async function b(S){const i=S.target;!i.files||i.files.length===0||(await N(Array.from(i.files)),i.value="")}async function v(S){S.preventDefault(),p.value=!1,!(!S.dataTransfer?.files||S.dataTransfer.files.length===0)&&await N(Array.from(S.dataTransfer.files))}function k(S){S.preventDefault(),p.value=!0}function $(S){const i=S.currentTarget.getBoundingClientRect(),P=S.clientX,d=S.clientY;(P<i.left||P>i.right||d<i.top||d>i.bottom)&&(p.value=!1)}async function N(S){if(S.length!==0){m.value=!0,_.value="",R.value=!0,T.value=0;try{let i=0;const P=S.length;for(let d=0;d<S.length;d++){const g=S[d];if(!g)continue;M.value=g.name;const f=g.type,x=g.name.toLowerCase();if(f.startsWith("image/"))await z(g),i++;else if(f==="application/pdf"||x.endsWith(".pdf")){const h=await ae(g);i+=h}else if(x.endsWith(".mobi")||x.endsWith(".azw")||x.endsWith(".azw3")){const h=await W(g);i+=h}else console.warn(`ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹: ${g.name}`),_e(`ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹: ${g.name}`,"warning");T.value=Math.round((d+1)/P*100)}i>0&&(_e(`å·²æ·»åŠ  ${i} å¼ å›¾ç‰‡`,"success"),o("uploadComplete",i))}catch(i){console.error("å¤„ç†æ–‡ä»¶å¤±è´¥:",i);const P=i instanceof Error?i.message:"å¤„ç†æ–‡ä»¶å¤±è´¥ï¼Œè¯·é‡è¯•";_.value=P,_e(P,"error")}finally{m.value=!1,R.value=!1,M.value=""}}}async function z(S){return new Promise((i,P)=>{const d=new FileReader;d.onload=g=>{const f=g.target?.result;l.addImage(S.name,f),i()},d.onerror=()=>P(new Error(`è¯»å–å›¾ç‰‡æ–‡ä»¶å¤±è´¥: ${S.name}`)),d.readAsDataURL(S)})}async function ae(S){return I.value==="frontend"?await q(S):await Q(S)}function j(S){return new Promise((i,P)=>{const d=new FileReader;d.onload=()=>i(d.result),d.onerror=P,d.readAsDataURL(S)})}async function q(S){try{const i=await it(()=>import("./pdf.U7tdldy2.js").then(h=>h.p),[]);i.GlobalWorkerOptions.workerSrc=`https://cdnjs.cloudflare.com/ajax/libs/pdf.js/${i.version}/pdf.worker.min.js`;const P=await S.arrayBuffer(),d=await i.getDocument({data:P}).promise,g=d.numPages;console.log(`PDF ${S.name} å…± ${g} é¡µï¼Œå¼€å§‹æœ¬åœ°æ¸²æŸ“...`),_e(`æ­£åœ¨è§£æ PDFï¼Œå…± ${g} é¡µ...`,"info");const f=typeof OffscreenCanvas<"u";f&&console.log("ä½¿ç”¨ OffscreenCanvas åå°æ¸²æŸ“æ¨¡å¼");let x=0;for(let h=1;h<=g;h++){M.value=`${S.name} - ç¬¬ ${h}/${g} é¡µ`,T.value=Math.round(h/g*100);try{const D=await d.getPage(h),Z=D.getViewport({scale:2});let r;if(f){const le=new OffscreenCanvas(Z.width,Z.height),B=le.getContext("2d");await D.render({canvasContext:B,viewport:Z}).promise;const ee=await le.convertToBlob({type:"image/jpeg",quality:1});r=await j(ee)}else{const le=document.createElement("canvas"),B=le.getContext("2d");le.width=Z.width,le.height=Z.height,await D.render({canvasContext:B,viewport:Z}).promise,r=le.toDataURL("image/jpeg",1)}const y=`${S.name}_é¡µé¢${h}`;l.addImage(y,r),x++,console.log(`  é¡µé¢ ${h}/${g} å¤„ç†å®Œæˆ`)}catch(D){console.warn(`PDF ${S.name} ç¬¬ ${h} é¡µæ¸²æŸ“å¤±è´¥:`,D)}}return console.log(`PDF ${S.name} å…¨éƒ¨ ${g} é¡µå¤„ç†å®Œæˆ`),x}catch(i){return console.error("å‰ç«¯ PDF è§£æå¤±è´¥:",i),_e("å‰ç«¯ PDF è§£æå¤±è´¥ï¼Œå°è¯•ä½¿ç”¨åç«¯è§£æ...","warning"),await Q(S)}}async function Q(S){let P=null;try{_e("æ­£åœ¨ä¸Šä¼  PDF æ–‡ä»¶...","info");const d=await Is(S,5);if(!d.success||!d.session_id)throw new Error(d.error||"PDF è§£æå¯åŠ¨å¤±è´¥");P=d.session_id;const g=d.total_pages||0;console.log(`PDF ${S.name} å…± ${g} é¡µï¼Œå¼€å§‹åç«¯åˆ†æ‰¹è§£æ...`),_e(`æ­£åœ¨è§£æ PDFï¼Œå…± ${g} é¡µ...`,"info");let f=0;for(let x=0;x<g;x+=5){M.value=`${S.name} - å¤„ç†ä¸­ ${Math.min(x+5,g)}/${g} é¡µ`,T.value=g>0?Math.round(x/g*100):0;const h=await Ps(P,x,5);if(!h.success){console.warn(`æ‰¹æ¬¡ ${x} è·å–å¤±è´¥:`,h.error);continue}if(h.images&&h.images.length>0)for(const D of h.images){if(!D||!D.data_url)continue;const Y=`${S.name}_é¡µé¢${String(D.page_index+1).padStart(4,"0")}`;l.addImage(Y,D.data_url),f++}console.log(`  å·²åŠ è½½ ${f}/${g} é¡µ`)}return console.log(`PDF ${S.name} å…¨éƒ¨ ${f} é¡µå¤„ç†å®Œæˆ`),f}catch(d){throw console.error("åç«¯ PDF è§£æå¤±è´¥:",d),d}finally{if(P)try{await Rs(P)}catch(d){console.warn("PDF ä¼šè¯æ¸…ç†å¤±è´¥:",d)}}}async function W(S){let i=null;try{_e("æ­£åœ¨ä¸Šä¼ ç”µå­ä¹¦æ–‡ä»¶...","info");const P=await Ds(S,5);if(!P.success||!P.session_id)throw new Error(P.error||"MOBI/AZW è§£æå¯åŠ¨å¤±è´¥");i=P.session_id;const d=P.total_images||0;_e(`æ­£åœ¨è§£æç”µå­ä¹¦ï¼Œå…± ${d} å¼ å›¾ç‰‡...`,"info");let g=0,f=!0;for(;f;){M.value=`${S.name} - å·²å¤„ç† ${g}/${d} å¼ `,T.value=d>0?Math.round(g/d*100):0;const x=await Ms(i);if(!x.success)throw new Error(x.error||"MOBI/AZW æ‰¹æ¬¡è§£æå¤±è´¥");if(x.images&&x.images.length>0){for(let h=0;h<x.images.length;h++){const D=x.images[h];if(!D)continue;const Y=g+h+1,Z=`${S.name.replace(/\.(mobi|azw|azw3)$/i,"")}_image_${String(Y).padStart(3,"0")}.png`,r=D.startsWith("data:")?D:`data:image/png;base64,${D}`;l.addImage(Z,r)}g+=x.images.length}f=x.has_more??!1}return g}catch(P){throw console.error("MOBI/AZW è§£æå¤±è´¥:",P),P}finally{if(i)try{await Es(i)}catch(P){console.warn("MOBI/AZW ä¼šè¯æ¸…ç†å¤±è´¥:",P)}}}function se(){_.value=""}return t({triggerFileSelect:E,triggerFolderSelect:H,processFiles:N,clearError:se}),(S,i)=>(A(),L("div",ba,[e("div",{id:"drop-area",class:Ie(["drop-area",{"drag-over":p.value,loading:m.value}]),onDragover:k,onDragleave:$,onDrop:v},[e("div",{class:"drop-content"},[e("p",{class:"drop-text"},[i[0]||(i[0]=me(" æ‹–æ‹½å›¾ç‰‡ã€PDFæˆ–MOBIæ–‡ä»¶åˆ°è¿™é‡Œï¼Œæˆ– ",-1)),e("span",{class:"select-link",onClick:E}," é€‰æ‹©æ–‡ä»¶ "),i[1]||(i[1]=e("span",{class:"separator"}," | ",-1)),e("span",{class:"select-link folder-link",onClick:H}," ğŸ“ é€‰æ‹©æ–‡ä»¶å¤¹ ")])]),e("input",{ref_key:"fileInputRef",ref:a,type:"file",id:"imageUpload",accept:"image/*,application/pdf,.mobi,.azw,.azw3",multiple:"",class:"file-input",onChange:b},null,544),e("input",{ref_key:"folderInputRef",ref:c,type:"file",webkitdirectory:"",class:"file-input",onChange:V},null,544)],34),R.value?(A(),ut(ko,{key:0,visible:!0,percentage:T.value,label:M.value||"å¤„ç†ä¸­..."},null,8,["percentage","label"])):ce("",!0),_.value?(A(),L("div",{key:1,class:"error-message",onClick:se},[i[2]||(i[2]=e("span",{class:"error-icon"},"âš ï¸",-1)),e("span",ha,oe(_.value),1),i[3]||(i[3]=e("span",{class:"error-close"},"Ã—",-1))])):ce("",!0),m.value&&!R.value?(A(),L("div",xa,[...i[4]||(i[4]=[e("div",{class:"spinner"},null,-1),e("span",{class:"loading-text"},"å¤„ç†ä¸­...",-1)])])):ce("",!0)]))}}),_a=He(ya,[["__scopeId","data-v-42054ac8"]]),Ca={id:"settings-sidebar",class:"settings-sidebar"},Sa={class:"card settings-card"},ka={id:"font-settings",class:"settings-card collapsible-panel"},wa={class:"toggle-icon"},$a={class:"collapsible-content"},Ta={class:"settings-form"},Ia={class:"form-group"},Pa=["value","disabled","title"],Ra={class:"auto-fontSize-option",title:"å‹¾é€‰åï¼Œé¦–æ¬¡ç¿»è¯‘æ—¶è‡ªåŠ¨ä¸ºæ¯ä¸ªæ°”æ³¡è®¡ç®—åˆé€‚çš„å­—å·"},Da=["checked"],Ma={class:"form-group"},Ea={class:"form-group"},Ba={class:"form-group"},Aa={class:"color-with-auto"},La={class:"auto-color-toggle",title:"ç¿»è¯‘æ—¶è‡ªåŠ¨ä½¿ç”¨è¯†åˆ«åˆ°çš„æ–‡å­—é¢œè‰²"},Fa=["checked"],Ua=["value","disabled"],Oa={key:0,class:"auto-color-hint"},za={class:"form-group"},Na={class:"checkbox-label"},Va=["checked"],Wa={key:0,id:"strokeOptions",class:"stroke-options"},Ka={class:"form-group"},qa=["value"],Ha={class:"form-group"},ja=["value"],Ja={class:"form-group"},Ya={key:0,id:"solidColorOptions",class:"form-group"},Xa=["value"],Ga={class:"apply-settings-group"},Za=["disabled"],Qa={key:0,class:"apply-options-dropdown"},el={class:"apply-option"},tl=["checked"],ol={class:"apply-option"},nl={class:"apply-option"},sl={class:"apply-option"},al={class:"apply-option"},ll={class:"apply-option"},il={class:"apply-option"},rl={class:"apply-option"},ul={class:"apply-option"},cl={id:"page-range-settings",class:"settings-card collapsible-panel"},dl={class:"toggle-icon"},gl={class:"collapsible-content"},pl={class:"settings-form page-range-form"},ml={class:"range-header-row"},vl={class:"range-toggle-compact"},fl=["disabled"],bl={class:"total-count"},hl={class:"page-range-inputs-compact"},xl=["value"],yl=["value"],_l={key:0,class:"range-error-compact"},Cl={class:"action-buttons"},Sl=["disabled"],kl=["disabled","title"],wl=["disabled","title"],$l=["disabled","title"],Tl=["disabled"],Il=["disabled","title"],Pl=["disabled"],Rl=["disabled"],Dl={class:"navigation-buttons"},Ml=["disabled"],El=["disabled"],Bl=je({__name:"SettingsSidebar",emits:["translateCurrent","translateAll","translateRange","hqTranslate","hqTranslateRange","proofread","proofreadRange","removeText","removeAllText","removeTextRange","deleteCurrent","clearAll","cleanTemp","openPlugins","openSettings","previous","next","applyToAll","textStyleChanged","autoFontSizeChanged"],setup(n,{emit:t}){const s=t,o=et(),l=ze(),u=w(!0),a=w(!1),c=w({fontSize:!0,fontFamily:!0,layoutDirection:!0,textColor:!0,fillColor:!0,strokeEnabled:!0,strokeColor:!0,strokeWidth:!0}),m=w(!1),p=w(!1),_=w(1),T=w(1),M=[{label:"è‡ªåŠ¨ (æ ¹æ®æ£€æµ‹)",value:"auto"},{label:"ç«–å‘æ’ç‰ˆ",value:"vertical"},{label:"æ¨ªå‘æ’ç‰ˆ",value:"horizontal"}],R=[{label:"çº¯è‰²å¡«å……",value:"solid"},{label:"LAMAä¿®å¤ (é€Ÿåº¦ä¼˜åŒ–)",value:"lama_mpe"},{label:"LAMAä¿®å¤ (é€šç”¨)",value:"litelama"}],I=X(()=>o.currentImage),E=X(()=>o.hasImages),H=X(()=>o.images.length),V=X(()=>_.value>=1&&T.value<=H.value&&_.value<=T.value),F=X(()=>E.value&&!o.isBatchTranslationInProgress),b=X(()=>o.canGoPrevious),v=X(()=>o.canGoNext),k=X(()=>l.textStyle),$=w([]),N=[yt,"fonts/msyh.ttc","fonts/simhei.ttf","fonts/simsun.ttc"],z=w(null),ae=X(()=>{const ie=$.value.map(C=>({label:S(C),value:C}));return ie.push({label:"è‡ªå®šä¹‰å­—ä½“...",value:"custom-font"}),ie});dt(async()=>{await j();const ie=k.value.fontFamily;ie&&!$.value.includes(ie)&&($.value=[ie,...$.value])});async function j(){try{const ie=await $n();if(ie.fonts&&Array.isArray(ie.fonts)&&ie.fonts.length>0){const C=ie.fonts[0];if(typeof C=="object"&&"path"in C){const J=ie.fonts.map(fe=>typeof fe=="object"?fe.path:fe);$.value=J}else $.value=ie.fonts}else $.value=[...N]}catch(ie){console.error("åŠ è½½å­—ä½“åˆ—è¡¨å¤±è´¥:",ie),$.value=[...N]}}function q(){u.value=!u.value}function Q(ie){const C=parseInt(ie.target.value);isNaN(C)||(l.updateTextStyle({fontSize:C}),s("textStyleChanged","fontSize",C))}function W(ie){const C=ie.target.checked;l.updateTextStyle({autoFontSize:C}),console.log(`è‡ªåŠ¨å­—å·è®¾ç½®å˜æ›´: ${C}`),s("autoFontSizeChanged",C)}async function se(ie){const C=ie.target,J=C.files?.[0];if(!J)return;const fe=[".ttf",".ttc",".otf"],be=J.name.toLowerCase();if(!fe.some(te=>be.endsWith(te))){_e("è¯·é€‰æ‹© .ttfã€.ttc æˆ– .otf æ ¼å¼çš„å­—ä½“æ–‡ä»¶","error"),C.value="";return}try{const te=await Us(J);te.success&&te.fontPath?(await j(),l.updateTextStyle({fontFamily:te.fontPath}),_e("å­—ä½“ä¸Šä¼ æˆåŠŸ","success")):_e(te.error||"å­—ä½“ä¸Šä¼ å¤±è´¥","error")}catch(te){console.error("å­—ä½“ä¸Šä¼ å¤±è´¥:",te),_e("å­—ä½“ä¸Šä¼ å¤±è´¥","error")}finally{C.value=""}}function S(ie){const C={"fonts/STXINGKA.TTF":"åæ–‡è¡Œæ¥·","fonts/STXINWEI.TTF":"åæ–‡æ–°é­","fonts/STZHONGS.TTF":"åæ–‡ä¸­å®‹","fonts/STKAITI.TTF":"æ¥·ä½“","fonts/STLITI.TTF":"éš¶ä¹¦","fonts/æ€æºé»‘ä½“SourceHanSansK-Bold.TTF":"æ€æºé»‘ä½“","fonts/STSONG.TTF":"åæ–‡å®‹ä½“","fonts/msyh.ttc":"å¾®è½¯é›…é»‘","fonts/msyhbd.ttc":"å¾®è½¯é›…é»‘ç²—ä½“","fonts/SIMYOU.TTF":"å¹¼åœ†","fonts/STFANGSO.TTF":"ä»¿å®‹","fonts/STHUPO.TTF":"åæ–‡ç¥ç€","fonts/STXIHEI.TTF":"åæ–‡ç»†é»‘","fonts/simkai.ttf":"ä¸­æ˜“æ¥·ä½“","fonts/simfang.ttf":"ä¸­æ˜“ä»¿å®‹","fonts/simhei.ttf":"ä¸­æ˜“é»‘ä½“","fonts/SIMLI.TTF":"ä¸­æ˜“éš¶ä¹¦","fonts/simsun.ttc":"å®‹ä½“"};if(C[ie])return C[ie];const J=ie.split("/").pop()||ie;for(const[fe,be]of Object.entries(C))if((fe.split("/").pop()||"").toLowerCase()===J.toLowerCase())return be;return J.replace(/\.(ttf|ttc|otf)$/i,"")}function i(ie){const C=String(ie);if(C==="custom-font"){z.value?.click();return}l.updateTextStyle({fontFamily:C}),s("textStyleChanged","fontFamily",C)}function P(ie){const C=String(ie);l.updateTextStyle({layoutDirection:C}),s("textStyleChanged","layoutDirection",C)}function d(ie){const C=String(ie);l.updateTextStyle({inpaintMethod:C})}function g(ie){const C=ie.target.value;l.updateTextStyle({textColor:C}),s("textStyleChanged","textColor",C)}function f(ie){const C=ie.target.checked;l.updateTextStyle({useAutoTextColor:C})}function x(ie){const C=ie.target.checked;l.updateTextStyle({strokeEnabled:C}),s("textStyleChanged","strokeEnabled",C)}function h(ie){const C=ie.target.value;l.updateTextStyle({strokeColor:C}),s("textStyleChanged","strokeColor",C)}function D(ie){const C=parseInt(ie.target.value);isNaN(C)||(l.updateTextStyle({strokeWidth:C}),s("textStyleChanged","strokeWidth",C))}function Y(ie){const C=ie.target.value;l.updateTextStyle({fillColor:C}),s("textStyleChanged","fillColor",C)}function Z(){a.value=!a.value}function r(){const C=!Object.values(c.value).every(J=>J);c.value={fontSize:C,fontFamily:C,layoutDirection:C,textColor:C,fillColor:C,strokeEnabled:C,strokeColor:C,strokeWidth:C}}function y(){s("applyToAll",{...c.value}),a.value=!1}function le(ie){ie.target.closest(".apply-settings-group")||(a.value=!1)}function B(){m.value=!m.value,m.value&&H.value>0&&(!V.value||_.value===1&&T.value===1)&&(_.value=1,T.value=H.value)}function ee(ie){const C=parseInt(ie.target.value);isNaN(C)||(_.value=Math.max(1,Math.min(C,H.value)))}function de(ie){const C=parseInt(ie.target.value);isNaN(C)||(T.value=Math.max(1,Math.min(C,H.value)))}function ve(){p.value&&V.value?s("translateRange",_.value,T.value):s("translateAll")}function xe(){p.value&&V.value?s("hqTranslateRange",_.value,T.value):s("hqTranslate")}function we(){p.value&&V.value?s("proofreadRange",_.value,T.value):s("proofread")}function $e(){p.value&&V.value?s("removeTextRange",_.value,T.value):s("removeAllText")}return typeof window<"u"&&window.addEventListener("click",le),(ie,C)=>(A(),L("aside",Ca,[e("div",Sa,[C[43]||(C[43]=e("h2",null,"ç¿»è¯‘è®¾ç½®",-1)),e("div",ka,[e("h3",{class:"collapsible-header",onClick:q},[C[17]||(C[17]=me(" æ–‡å­—è®¾ç½® ",-1)),e("span",wa,oe(u.value?"â–¼":"â–¶"),1)]),ne(e("div",$a,[e("div",Ta,[e("div",Ia,[C[19]||(C[19]=e("label",{for:"fontSize"},"å­—å·å¤§å°:",-1)),e("input",{type:"number",id:"fontSize",value:k.value.fontSize,min:"10",disabled:k.value.autoFontSize,class:Ie({"disabled-input":k.value.autoFontSize}),title:k.value.autoFontSize?"å·²å¯ç”¨è‡ªåŠ¨å­—å·ï¼Œé¦–æ¬¡ç¿»è¯‘æ—¶å°†è‡ªåŠ¨è®¡ç®—":"",onInput:Q},null,42,Pa),e("span",Ra,[e("input",{type:"checkbox",id:"autoFontSize",checked:k.value.autoFontSize,onChange:W},null,40,Da),C[18]||(C[18]=e("label",{for:"autoFontSize"},"è‡ªåŠ¨è®¡ç®—åˆå§‹å­—å·",-1))])]),e("div",Ma,[C[20]||(C[20]=e("label",{for:"fontFamily"},"æ–‡æœ¬å­—ä½“:",-1)),Ce(Ke,{"model-value":k.value.fontFamily,options:ae.value,onChange:i},null,8,["model-value","options"]),e("input",{ref_key:"fontUploadInput",ref:z,type:"file",id:"fontUpload",accept:".ttf,.ttc,.otf",style:{display:"none"},onChange:se},null,544)]),e("div",Ea,[C[21]||(C[21]=e("label",{for:"layoutDirection"},"æ’ç‰ˆè®¾ç½®:",-1)),Ce(Ke,{"model-value":k.value.layoutDirection,options:M,onChange:P},null,8,["model-value"])]),e("div",Ba,[C[23]||(C[23]=e("label",{for:"textColor"},"æ–‡å­—é¢œè‰²:",-1)),e("div",Aa,[e("label",La,[e("input",{type:"checkbox",checked:k.value.useAutoTextColor,onChange:f},null,40,Fa),C[22]||(C[22]=e("span",null,"è‡ªåŠ¨",-1))]),e("input",{type:"color",id:"textColor",value:k.value.textColor,disabled:k.value.useAutoTextColor,onInput:g},null,40,Ua)]),k.value.useAutoTextColor?(A(),L("div",Oa," ğŸ’¡ ç¿»è¯‘æ—¶å°†è‡ªåŠ¨ä½¿ç”¨è¯†åˆ«åˆ°çš„æ–‡å­—é¢œè‰² ")):ce("",!0)]),e("div",za,[e("span",Na,[e("input",{type:"checkbox",id:"strokeEnabled",checked:k.value.strokeEnabled,onChange:x},null,40,Va),C[24]||(C[24]=e("label",{for:"strokeEnabled"},"å¯ç”¨æ–‡æœ¬æè¾¹:",-1))])]),Ce(ln,{name:"stroke-slide"},{default:St(()=>[k.value.strokeEnabled?(A(),L("div",Wa,[e("div",Ka,[C[25]||(C[25]=e("label",{for:"strokeColor"},"æè¾¹é¢œè‰²:",-1)),e("input",{type:"color",id:"strokeColor",value:k.value.strokeColor,onInput:h},null,40,qa)]),e("div",Ha,[C[26]||(C[26]=e("label",{for:"strokeWidth"},"æè¾¹å®½åº¦ (px):",-1)),e("input",{type:"number",id:"strokeWidth",value:k.value.strokeWidth,min:"0",max:"10",style:{width:"60px",padding:"5px"},onInput:D},null,40,ja),C[27]||(C[27]=e("div",{class:"input-hint"},"0 è¡¨ç¤ºæ— æè¾¹ã€‚",-1))])])):ce("",!0)]),_:1}),e("div",Ja,[C[28]||(C[28]=e("label",{for:"useInpainting"},"æ°”æ³¡å¡«å……æ–¹å¼:",-1)),Ce(Ke,{"model-value":k.value.inpaintMethod,options:R,onChange:d},null,8,["model-value"])]),Ce(ln,{name:"slide-fade"},{default:St(()=>[k.value.inpaintMethod==="solid"?(A(),L("div",Ya,[C[29]||(C[29]=e("label",{for:"fillColor"},"å¡«å……é¢œè‰²:",-1)),e("input",{type:"color",id:"fillColor",value:k.value.fillColor,onInput:Y},null,40,Xa)])):ce("",!0)]),_:1})]),e("div",Ga,[e("button",{type:"button",class:"settings-button",disabled:!E.value,onClick:y}," åº”ç”¨åˆ°å…¨éƒ¨ ",8,Za),e("button",{type:"button",class:"settings-gear-btn",title:"é€‰æ‹©è¦åº”ç”¨çš„å‚æ•°",onClick:Z}," âš™ï¸ "),a.value?(A(),L("div",Qa,[e("div",el,[e("input",{type:"checkbox",id:"apply_selectAll",checked:Object.values(c.value).every(J=>J),onChange:r},null,40,tl),C[30]||(C[30]=e("label",{for:"apply_selectAll"},"å…¨é€‰",-1))]),C[39]||(C[39]=e("hr",null,null,-1)),e("div",ol,[ne(e("input",{type:"checkbox",id:"apply_fontSize","onUpdate:modelValue":C[0]||(C[0]=J=>c.value.fontSize=J)},null,512),[[Qe,c.value.fontSize]]),C[31]||(C[31]=e("label",{for:"apply_fontSize"},"å­—å·",-1))]),e("div",nl,[ne(e("input",{type:"checkbox",id:"apply_fontFamily","onUpdate:modelValue":C[1]||(C[1]=J=>c.value.fontFamily=J)},null,512),[[Qe,c.value.fontFamily]]),C[32]||(C[32]=e("label",{for:"apply_fontFamily"},"å­—ä½“",-1))]),e("div",sl,[ne(e("input",{type:"checkbox",id:"apply_layoutDirection","onUpdate:modelValue":C[2]||(C[2]=J=>c.value.layoutDirection=J)},null,512),[[Qe,c.value.layoutDirection]]),C[33]||(C[33]=e("label",{for:"apply_layoutDirection"},"æ’ç‰ˆæ–¹å‘",-1))]),e("div",al,[ne(e("input",{type:"checkbox",id:"apply_textColor","onUpdate:modelValue":C[3]||(C[3]=J=>c.value.textColor=J)},null,512),[[Qe,c.value.textColor]]),C[34]||(C[34]=e("label",{for:"apply_textColor"},"æ–‡å­—é¢œè‰²",-1))]),e("div",ll,[ne(e("input",{type:"checkbox",id:"apply_fillColor","onUpdate:modelValue":C[4]||(C[4]=J=>c.value.fillColor=J)},null,512),[[Qe,c.value.fillColor]]),C[35]||(C[35]=e("label",{for:"apply_fillColor"},"å¡«å……é¢œè‰²",-1))]),e("div",il,[ne(e("input",{type:"checkbox",id:"apply_strokeEnabled","onUpdate:modelValue":C[5]||(C[5]=J=>c.value.strokeEnabled=J)},null,512),[[Qe,c.value.strokeEnabled]]),C[36]||(C[36]=e("label",{for:"apply_strokeEnabled"},"æè¾¹å¼€å…³",-1))]),e("div",rl,[ne(e("input",{type:"checkbox",id:"apply_strokeColor","onUpdate:modelValue":C[6]||(C[6]=J=>c.value.strokeColor=J)},null,512),[[Qe,c.value.strokeColor]]),C[37]||(C[37]=e("label",{for:"apply_strokeColor"},"æè¾¹é¢œè‰²",-1))]),e("div",ul,[ne(e("input",{type:"checkbox",id:"apply_strokeWidth","onUpdate:modelValue":C[7]||(C[7]=J=>c.value.strokeWidth=J)},null,512),[[Qe,c.value.strokeWidth]]),C[38]||(C[38]=e("label",{for:"apply_strokeWidth"},"æè¾¹å®½åº¦",-1))])])):ce("",!0)])],512),[[Oe,u.value]])]),e("div",cl,[e("h3",{class:"collapsible-header",onClick:B},[C[40]||(C[40]=me(" æŒ‡å®šèŒƒå›´ ",-1)),e("span",dl,oe(m.value?"â–¼":"â–¶"),1)]),ne(e("div",gl,[e("div",pl,[e("div",ml,[e("label",vl,[ne(e("input",{type:"checkbox","onUpdate:modelValue":C[8]||(C[8]=J=>p.value=J),disabled:H.value===0},null,8,fl),[[Qe,p.value]]),C[41]||(C[41]=e("span",null,"å¯ç”¨",-1))]),e("span",bl,"å…± "+oe(H.value)+" å¼ ",1)]),ne(e("div",hl,[e("input",{type:"number",id:"pageRangeStart",value:_.value,onInput:ee,placeholder:"èµ·å§‹"},null,40,xl),C[42]||(C[42]=e("span",{class:"range-sep"},"~",-1)),e("input",{type:"number",id:"pageRangeEnd",value:T.value,onInput:de,placeholder:"ç»“æŸ"},null,40,yl)],512),[[Oe,p.value]]),p.value&&!V.value&&H.value>0?(A(),L("div",_l," èŒƒå›´æ— æ•ˆ ")):ce("",!0)])],512),[[Oe,m.value]])]),e("div",Cl,[e("button",{id:"translateButton",disabled:!F.value,onClick:C[9]||(C[9]=J=>s("translateCurrent"))}," ç¿»è¯‘å½“å‰å›¾ç‰‡ ",8,Sl),e("button",{id:"translateAllButton",disabled:!F.value||p.value&&!V.value,title:p.value?`ç¿»è¯‘ç¬¬ ${_.value}-${T.value} é¡µ`:"ç¿»è¯‘æ‰€æœ‰å›¾ç‰‡",onClick:ve},oe(p.value?`ç¿»è¯‘ ${_.value}-${T.value} é¡µ`:"ç¿»è¯‘æ‰€æœ‰å›¾ç‰‡"),9,kl),e("button",{id:"startHqTranslationBtn",class:"settings-button purple-button",disabled:!F.value||p.value&&!V.value,title:p.value?`é«˜è´¨é‡ç¿»è¯‘ç¬¬ ${_.value}-${T.value} é¡µ`:"ä½¿ç”¨é«˜è´¨é‡ç¿»è¯‘æ¨¡å¼ï¼ˆéœ€åœ¨è®¾ç½®ä¸­é…ç½®ï¼‰",onClick:xe},oe(p.value?`é«˜è´¨é‡ç¿»è¯‘ ${_.value}-${T.value}`:"é«˜è´¨é‡ç¿»è¯‘"),9,wl),e("button",{id:"proofreadButton",disabled:!F.value||p.value&&!V.value,title:p.value?`AIæ ¡å¯¹ç¬¬ ${_.value}-${T.value} é¡µ`:"AIæ ¡å¯¹",onClick:we},oe(p.value?`AIæ ¡å¯¹ ${_.value}-${T.value}`:"AIæ ¡å¯¹"),9,$l),e("button",{id:"removeTextOnlyButton",disabled:!I.value,title:"æ¶ˆé™¤å›¾ç‰‡ä¸­çš„æ°”æ³¡æ–‡å­—ï¼Œæ— éœ€å¡«å†™ç¿»è¯‘æœåŠ¡å•†å’ŒAPI Key",onClick:C[10]||(C[10]=J=>s("removeText"))}," ä»…æ¶ˆé™¤æ–‡å­— ",8,Tl),e("button",{id:"removeAllTextButton",disabled:!E.value||p.value&&!V.value,title:p.value?`æ¶ˆé™¤ç¬¬ ${_.value}-${T.value} é¡µçš„æ–‡å­—`:"æ¶ˆé™¤æ‰€æœ‰å›¾ç‰‡ä¸­çš„æ°”æ³¡æ–‡å­—",onClick:$e},oe(p.value?`æ¶ˆé™¤ ${_.value}-${T.value} é¡µæ–‡å­—`:"æ¶ˆé™¤æ‰€æœ‰å›¾ç‰‡æ–‡å­—"),9,Il),e("button",{id:"deleteCurrentImageButton",class:"settings-button red-button",disabled:!I.value,onClick:C[11]||(C[11]=J=>s("deleteCurrent"))}," åˆ é™¤å½“å‰å›¾ç‰‡ ",8,Pl),e("button",{id:"clearAllImagesButton",class:"settings-button red-button",disabled:!E.value,onClick:C[12]||(C[12]=J=>s("clearAll"))}," æ¸…é™¤æ‰€æœ‰å›¾ç‰‡ ",8,Rl),e("button",{id:"cleanDebugFilesButton",class:"settings-button orange-button",onClick:C[13]||(C[13]=J=>s("cleanTemp"))}," æ¸…ç†ä¸´æ—¶æ–‡ä»¶ "),e("button",{id:"managePluginsButton",class:"settings-button blue-button",onClick:C[14]||(C[14]=J=>s("openPlugins"))}," æ’ä»¶ç®¡ç† ")]),e("div",Dl,[e("button",{id:"prevImageButton",disabled:!b.value,onClick:C[15]||(C[15]=J=>s("previous"))}," ä¸Šä¸€å¼  ",8,Ml),e("button",{id:"nextImageButton",disabled:!v.value,onClick:C[16]||(C[16]=J=>s("next"))}," ä¸‹ä¸€å¼  ",8,El)])])]))}}),Al=He(Bl,[["__scopeId","data-v-cf679ea9"]]);function Ut(n){if(n.textDirection==="vertical"||n.textDirection==="horizontal")return n.textDirection;if(n.autoTextDirection==="vertical"||n.autoTextDirection==="horizontal")return n.autoTextDirection;if(n.coords){const[t,s,o,l]=n.coords;return l-s>o-t?"vertical":"horizontal"}return"vertical"}function Ll(){const n=et(),t=ze(),s=ct(),o=w(!1),l=w(0),u=w(""),a=w(!1),c=w(0),m=w(""),p=X(()=>n.hasImages),_=X(()=>n.hasImages),T=X(()=>n.hasImages);function M(){const b=n.images;if(b.length===0){s.warning("æ²¡æœ‰å¯å¯¼å‡ºçš„å›¾ç‰‡æ–‡æœ¬");return}const v=[];for(let q=0;q<b.length;q++){const Q=b[q];if(!Q)continue;const W=Q.bubbleStates||[],se={imageIndex:q,bubbles:[]};for(let S=0;S<W.length;S++){const i=W[S];if(!i)continue;const P=i.originalText||"",d=i.translatedText||i.textboxText||"";let g="vertical";i.textDirection&&i.textDirection!=="auto"?g=i.textDirection:i.autoTextDirection&&(g=i.autoTextDirection),se.bubbles.push({bubbleIndex:S,original:P,translated:d,textDirection:g})}v.push(se)}const k=JSON.stringify(v,null,2),$=new Blob([k],{type:"application/json"}),N=URL.createObjectURL($),z=document.createElement("a");z.href=N;const j=new Date().toISOString().replace(/[-:T]/g,"").slice(0,15);z.download=`translations_${j}.json`,document.body.appendChild(z),z.click(),document.body.removeChild(z),URL.revokeObjectURL(N),s.success("æ–‡æœ¬å¯¼å‡ºæˆåŠŸï¼")}function R(){const b=n.images;if(b.length===0)return null;const v=[];for(let k=0;k<b.length;k++){const $=b[k];if(!$)continue;const N=$.bubbleStates||[],z={imageIndex:k,bubbles:[]};for(let ae=0;ae<N.length;ae++){const j=N[ae];if(!j)continue;const q=j.originalText||"",Q=j.translatedText||j.textboxText||"";let W="vertical";j.textDirection&&j.textDirection!=="auto"?W=j.textDirection:j.autoTextDirection&&(W=j.autoTextDirection),z.bubbles.push({bubbleIndex:ae,original:q,translated:Q,textDirection:W})}v.push(z)}return v}async function I(b){if(!b){s.warning("æœªé€‰æ‹©æ–‡ä»¶");return}a.value=!0,c.value=0,m.value="å‡†å¤‡å¯¼å…¥æ–‡æœ¬...",s.info("æ­£åœ¨å¯¼å…¥æ–‡æœ¬...",0);try{const v=await E(b);c.value=10,m.value="è§£æ JSON æ•°æ®...";const k=JSON.parse(v);if(!Array.isArray(k))throw new Error("å¯¼å…¥çš„ JSON æ ¼å¼ä¸æ­£ç¡®ï¼Œåº”ä¸ºæ•°ç»„");let $=0,N=0;const z=t.settings.textStyle,ae=z.autoFontSize?"auto":z.fontSize,j=z.fontFamily,q=z.textColor,Q=z.fillColor;c.value=20,m.value="å¼€å§‹æ›´æ–°å›¾ç‰‡...";const W=k.length;let se=0;const S=[];for(const d of k){se++;const g=20+se/W*60;c.value=g,m.value=`å¤„ç†å›¾ç‰‡ ${se}/${W}`;const f=d.imageIndex;if(f<0||f>=n.images.length){console.warn(`è·³è¿‡æ— æ•ˆçš„å›¾ç‰‡ç´¢å¼•: ${f}`);continue}const x=n.images[f];if(!x)continue;let h=!1;x.bubbleStates||(x.bubbleStates=[]),x.bubbleTexts||(x.bubbleTexts=[]),x.originalTexts||(x.originalTexts=[]);for(const D of d.bubbles){const Y=D.bubbleIndex,Z=D.original,r=D.translated,y=D.textDirection,le=y==="vertical"||y==="horizontal"?y:"vertical";for(;x.bubbleTexts.length<=Y;)x.bubbleTexts.push("");for(;x.originalTexts.length<=Y;)x.originalTexts.push("");for(Z&&(x.originalTexts[Y]=Z),r&&(x.bubbleTexts[Y]=r);x.bubbleStates.length<=Y;)x.bubbleStates.push(H(ae,j,q,Q));const B=x.bubbleStates[Y];B&&(Z&&(B.originalText=Z),r&&(B.translatedText=r,B.textboxText=r),B.textDirection=le,h=!0,N++)}h&&x.bubbleStates&&(x.bubbleTexts=x.bubbleStates.map(D=>D.translatedText||"")),h&&($++,x.hasUnsavedChanges=!0,x.translatedDataURL&&x.bubbleStates&&x.bubbleStates.length>0&&S.push(f))}if(S.length>0){c.value=80,m.value="å¼€å§‹æ¸²æŸ“å›¾ç‰‡...",s.info("æ­£åœ¨æ¸²æŸ“å›¾ç‰‡ï¼Œè¯·ç¨å€™...",0);const d=t.settings.textStyle,g=d.layoutDirection,f=g==="auto";for(let x=0;x<S.length;x++){const h=S[x];if(h===void 0)continue;const D=n.images[h];if(!(!D||!D.bubbleStates)){c.value=80+x/S.length*20,m.value=`æ¸²æŸ“å›¾ç‰‡ ${x+1}/${S.length}`;try{let Y="";if(D.cleanImageData?Y=D.cleanImageData.includes("base64,")?D.cleanImageData.split("base64,")[1]||"":D.cleanImageData:D.originalDataURL&&(Y=D.originalDataURL.includes("base64,")?D.originalDataURL.split("base64,")[1]||"":D.originalDataURL,console.log(`importText: å›¾ç‰‡ ${h} ä½¿ç”¨åŸå›¾ä½œä¸ºèƒŒæ™¯ï¼ˆå…œåº•ï¼‰`)),!Y){console.log(`importText: å›¾ç‰‡ ${h} æ²¡æœ‰å¯ç”¨çš„èƒŒæ™¯å›¾ï¼Œè·³è¿‡`);continue}const Z=D.bubbleStates.map(y=>({translatedText:y.translatedText||"",coords:y.coords,fontSize:y.fontSize||d.fontSize,fontFamily:y.fontFamily||d.fontFamily,textDirection:Ut(y),textColor:y.textColor||d.textColor,rotationAngle:y.rotationAngle||0,position:y.position||{x:0,y:0},strokeEnabled:y.strokeEnabled??d.strokeEnabled,strokeColor:y.strokeColor||d.strokeColor,strokeWidth:y.strokeWidth??d.strokeWidth})),r=await Co({clean_image:Y,bubble_texts:Z.map(y=>y.translatedText),bubble_coords:Z.map(y=>y.coords),fontSize:d.fontSize,fontFamily:d.fontFamily,textDirection:f?"vertical":g,textColor:d.textColor,bubble_states:Z,use_individual_styles:!0,use_inpainting:!1,use_lama:!1,is_font_style_change:!0,strokeEnabled:d.strokeEnabled,strokeColor:d.strokeColor,strokeWidth:d.strokeWidth});r.rendered_image&&(n.updateImageByIndex(h,{translatedDataURL:`data:image/png;base64,${r.rendered_image}`,hasUnsavedChanges:!0}),console.log(`importText: å›¾ç‰‡ ${h} æ¸²æŸ“æˆåŠŸ`))}catch(Y){console.error(`importText: é‡æ¸²æŸ“å›¾ç‰‡ ${h} å¤±è´¥:`,Y)}}}}c.value=100,m.value="å¯¼å…¥å®Œæˆ";const i=S.length,P=i>0?`å¯¼å…¥æˆåŠŸï¼æ›´æ–°äº† ${$} å¼ å›¾ç‰‡ä¸­çš„ ${N} ä¸ªæ°”æ³¡æ–‡æœ¬ï¼Œé‡æ¸²æŸ“äº† ${i} å¼ å›¾ç‰‡`:`å¯¼å…¥æˆåŠŸï¼æ›´æ–°äº† ${$} å¼ å›¾ç‰‡ä¸­çš„ ${N} ä¸ªæ°”æ³¡æ–‡æœ¬`;s.success(P)}catch(v){console.error("å¯¼å…¥æ–‡æœ¬å‡ºé”™:",v),s.error(`å¯¼å…¥å¤±è´¥: ${v instanceof Error?v.message:String(v)}`)}finally{a.value=!1,setTimeout(()=>{c.value=0,m.value=""},2e3)}}function E(b){return new Promise((v,k)=>{const $=new FileReader;$.onload=N=>{N.target?.result?v(N.target.result):k(new Error("è¯»å–æ–‡ä»¶å¤±è´¥"))},$.onerror=()=>k(new Error("è¯»å–æ–‡ä»¶æ—¶å‡ºé”™")),$.readAsText(b)})}function H(b,v,k,$){const N=t.settings.textStyle;return{coords:[0,0,100,100],polygon:[],originalText:"",translatedText:"",textboxText:"",fontSize:typeof b=="number"?b:25,fontFamily:v,textDirection:"vertical",autoTextDirection:"vertical",textColor:k,fillColor:$,rotationAngle:0,position:{x:0,y:0},strokeEnabled:N.strokeEnabled,strokeColor:N.strokeColor,strokeWidth:N.strokeWidth,inpaintMethod:N.inpaintMethod}}function V(){const b=n.currentImage;if(!b){s.warning("æ²¡æœ‰å¯ä¸‹è½½çš„å›¾ç‰‡");return}const v=b.translatedDataURL||b.originalDataURL;if(!v){s.warning("æ²¡æœ‰å¯ä¸‹è½½çš„å›¾ç‰‡");return}o.value=!0;try{const k=v.split(",")[1];if(!k)throw new Error("æ— æ•ˆçš„å›¾ç‰‡æ•°æ®");const $=atob(k),N=[];for(let W=0;W<$.length;W+=512){const se=$.slice(W,W+512),S=new Array(se.length);for(let P=0;P<se.length;P++)S[P]=se.charCodeAt(P);const i=new Uint8Array(S);N.push(i.buffer)}const z=new Blob(N,{type:"image/png"}),ae=URL.createObjectURL(z),j=document.createElement("a");j.href=ae;let q=b.fileName||`image_${n.currentImageIndex}.png`;q=`${b.translatedDataURL?"translated":"original"}_${q.replace(/\.[^/.]+$/,"")}.png`,j.download=q,document.body.appendChild(j),j.click(),document.body.removeChild(j),URL.revokeObjectURL(ae),s.success(`ä¸‹è½½æˆåŠŸ: ${q}`)}catch(k){console.error("ä¸‹è½½å›¾ç‰‡æ—¶å‡ºé”™:",k),s.error("ä¸‹è½½å¤±è´¥")}finally{o.value=!1}}async function F(b="zip"){const v=n.images;if(v.length===0){s.warning("æ²¡æœ‰å¯ä¸‹è½½çš„å›¾ç‰‡");return}o.value=!0,l.value=0,u.value="å‡†å¤‡ä¸‹è½½...",s.info("ä¸‹è½½ä¸­...å¤„ç†å¯èƒ½éœ€è¦ä¸€å®šæ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…...",0);try{const k=[];let $=0,N=0;l.value=5,u.value="æ£€æŸ¥å›¾ç‰‡æ•°æ®...";for(let P=0;P<v.length;P++){const d=v[P];d&&(d.translatedDataURL?(k.push({index:P,type:"translated"}),$++):d.originalDataURL&&(k.push({index:P,type:"original"}),N++))}if(k.length===0){s.warning("æ²¡æœ‰å¯ä¸‹è½½çš„å›¾ç‰‡");return}l.value=10,u.value="åˆ›å»ºä¸‹è½½ä¼šè¯...";const z=await Bs(k.length);if(!z.success||!z.session_id)throw new Error(z.error||"åˆ›å»ºä¼šè¯å¤±è´¥");const ae=z.session_id,j=k.length;let q=0,Q=0;for(let P=0;P<k.length;P++){const d=k[P];if(!d)continue;const g=v[d.index];if(!g)continue;const f=d.type==="translated"?g.translatedDataURL:g.originalDataURL;if(!f)continue;const x=10+P/j*70;l.value=x,u.value=`ä¸Šä¼ å›¾ç‰‡ ${P+1}/${j}...`;try{const h=await As(ae,f,P);h.success?q++:(console.error(`ä¸Šä¼ å›¾ç‰‡ ${P} å¤±è´¥:`,h.error),Q++)}catch(h){console.error(`ä¸Šä¼ å›¾ç‰‡ ${P} å‡ºé”™:`,h),Q++}}if(q===0)throw new Error("æ‰€æœ‰å›¾ç‰‡ä¸Šä¼ å¤±è´¥");l.value=85,u.value="æ‰“åŒ…æ–‡ä»¶...";const W=await Ls(ae,b);if(!W.success||!W.file_id)throw new Error(W.error||"æ‰“åŒ…å¤±è´¥");l.value=95,u.value="å‡†å¤‡ä¸‹è½½...";const se=Fs(W.file_id,b),S=document.createElement("a");S.href=se,document.body.appendChild(S),S.click(),document.body.removeChild(S),l.value=100,u.value="ä¸‹è½½å·²å¼€å§‹";let i=`å·²æˆåŠŸå¤„ç† ${q} å¼ å›¾ç‰‡`;Q>0&&(i+=`ï¼ˆ${Q} å¼ å¤±è´¥ï¼‰`),$>0&&N>0?i+=`ï¼ˆ${$} å¼ ç¿»è¯‘å›¾ç‰‡å’Œ ${N} å¼ åŸå§‹å›¾ç‰‡ï¼‰`:$>0?i+="ï¼ˆå…¨éƒ¨ä¸ºç¿»è¯‘åå›¾ç‰‡ï¼‰":N>0&&(i+="ï¼ˆå…¨éƒ¨ä¸ºåŸå§‹å›¾ç‰‡ï¼‰"),i+="ï¼Œä¸‹è½½å³å°†å¼€å§‹",s.success(i),setTimeout(async()=>{try{const P=await _o();console.log("ä¸´æ—¶æ–‡ä»¶æ¸…ç†ç»“æœ:",P)}catch(P){console.error("æ¸…ç†ä¸´æ—¶æ–‡ä»¶å¤±è´¥:",P)}},6e4)}catch(k){console.error("ä¸‹è½½æ‰€æœ‰å›¾ç‰‡æ—¶å‡ºé”™:",k),s.error(`ä¸‹è½½å¤±è´¥: ${k instanceof Error?k.message:String(k)}`)}finally{o.value=!1,setTimeout(()=>{l.value=0,u.value=""},2e3)}}return{isDownloading:o,downloadProgress:l,downloadProgressText:u,isImporting:a,importProgress:c,importProgressText:m,canExportText:p,canImportText:_,canDownload:T,exportText:M,exportTextToJson:R,importText:I,downloadCurrentImage:V,downloadAllImages:F}}const Fl={key:0,class:"result-section card result-card"},Ul={class:"image-controls"},Ol={class:"image-size-control"},zl=["value"],Nl={id:"imageSizeValue"},Vl={class:"content-container"},Wl={class:"image-container"},Kl=["src"],ql={id:"detectedTextInfo",class:"text-info"},Hl={id:"detectedTextList"},jl={class:"original-text"},Jl={class:"download-section"},Yl={class:"download-buttons"},Xl=["disabled"],Gl={class:"download-all-container"},Zl=["disabled"],Ql={class:"download-format-selector"},ei=["disabled"],ti=["disabled"],oi={key:1,class:"empty-state-section"},po=60,ni=je({__name:"ImageResultDisplay",props:{isEditMode:{type:Boolean,default:!1}},emits:["toggle-edit-mode","retry-failed"],setup(n,{emit:t}){const s=[{label:"ZIPå‹ç¼©åŒ…",value:"zip"},{label:"PDFæ–‡æ¡£",value:"pdf"},{label:"CBZæ¼«ç”»",value:"cbz"}],o=t,l=et(),u=ze(),a=Ll(),c=w(100),m=X({get:()=>E.value?.showOriginal??!1,set:x=>{E.value&&l.updateCurrentImage({showOriginal:x})}}),p=w("zip"),_=w(null),T=X(()=>a.isDownloading.value),M=X(()=>a.downloadProgressText.value),R=X(()=>a.downloadProgress.value),I=X(()=>l.hasImages),E=X(()=>l.currentImage),H=X(()=>!!E.value?.translatedDataURL),V=X(()=>!!(E.value?.translatedDataURL||E.value?.originalDataURL)),F=X(()=>E.value?m.value||!E.value.translatedDataURL?E.value.originalDataURL:E.value.translatedDataURL:""),b=X(()=>l.failedImageCount>0),v=X(()=>({width:`${c.value}%`})),k=X(()=>u.settings.useTextboxPrompt),$=X(()=>{if(!E.value)return[];if(E.value.bubbleStates&&E.value.bubbleStates.length>0)return E.value.bubbleStates.map(D=>({original:D.originalText||"",translated:k.value?D.textboxText||D.translatedText||"":D.translatedText||""}));const x=E.value.originalTexts||[],h=k.value?E.value.textboxTexts||E.value.bubbleTexts||[]:E.value.bubbleTexts||[];return x.length===0?[]:x.map((D,Y)=>({original:D||"",translated:h[Y]||""}))}),N=X(()=>$.value.length>0);function z(x){if(!x||x.length<=po)return x;let h="",D="";for(let Y=0;Y<x.length;Y++)if(D+=x[Y],D.length>=po){let Z=-1;for(let r=D.length-1;r>=0;r--){const y=D[r];if(y&&["ã€‚","ï¼","ï¼Ÿ",".","!","?","ï¼›",";","ï¼Œ",","].includes(y)){Z=r+1;break}}Z>po*.6?(h+=D.substring(0,Z)+`
`,D=D.substring(Z)):(h+=D+`
`,D="")}return D&&(h+=D),h}function ae(x){return z((x||"").trim())}function j(x){const h=(x||"").trim();return z(h)}function q(x){const h=x||"";return h.includes("ã€ç¿»è¯‘å¤±è´¥ã€‘")||h.includes("[ç¿»è¯‘å¤±è´¥]")||h.includes("ç¿»è¯‘å¤±è´¥")}function Q(){m.value=!m.value}function W(){o("toggle-edit-mode")}function se(x){const h=x.target;c.value=parseInt(h.value,10)}function S(){o("retry-failed")}function i(){a.downloadCurrentImage()}function P(){a.downloadAllImages(p.value)}function d(){a.exportText()}function g(){_.value?.click()}async function f(x){const h=x.target,D=h.files?.[0];D&&(await a.importText(D),h.value="")}return(x,h)=>E.value?(A(),L("section",Fl,[e("div",Ul,[H.value?(A(),L("button",{key:0,id:"toggleImageButton",class:"control-btn",onClick:Q},oe(m.value?"æŸ¥çœ‹ç¿»è¯‘å›¾":"æŸ¥çœ‹åŸå›¾"),1)):ce("",!0),e("button",{id:"toggleEditModeButton",class:Ie(["control-btn",{active:n.isEditMode}]),onClick:W},oe(n.isEditMode?"é€€å‡ºç¼–è¾‘":"åˆ‡æ¢ç¼–è¾‘æ¨¡å¼"),3),e("div",Ol,[h[1]||(h[1]=e("label",{for:"imageSize"},"å›¾ç‰‡å¤§å°:",-1)),e("input",{type:"range",id:"imageSize",min:"50",max:"200",value:c.value,class:"slider range-slider",onInput:se},null,40,zl),e("span",Nl,oe(c.value)+"%",1)]),b.value?(A(),L("button",{key:1,id:"retranslateFailedButton",class:"retry-failed-btn",onClick:S,title:"é‡æ–°ç¿»è¯‘æ‰€æœ‰å¤±è´¥çš„å›¾ç‰‡"}," é‡æ–°ç¿»è¯‘å¤±è´¥å›¾ç‰‡ ("+oe(K(l).failedImageCount)+") ",1)):ce("",!0)]),e("div",Vl,[e("div",Wl,[e("img",{id:"translatedImageDisplay",src:F.value,alt:"ç¿»è¯‘åå›¾ç‰‡",style:st(v.value)},null,12,Kl)])]),e("div",ql,[h[6]||(h[6]=e("h3",null,"æ£€æµ‹åˆ°çš„æ–‡æœ¬ï¼ˆåŸæ–‡ â†’ è¯‘æ–‡ï¼‰",-1)),e("pre",Hl,[N.value?(A(!0),L(Ve,{key:0},Ye($.value,(D,Y)=>(A(),L("span",{key:Y,class:"text-item"},[e("span",jl,oe(ae(D.original)),1),h[2]||(h[2]=me(`
`,-1)),e("span",{class:Ie(["translated-text",{"translation-error":q(D.translated)}])},oe(j(D.translated)),3),h[3]||(h[3]=me(`
`,-1)),h[4]||(h[4]=e("span",{class:"separator"},"â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€",-1)),h[5]||(h[5]=me(`

`,-1))]))),128)):(A(),L(Ve,{key:1},[me("æœªæ£€æµ‹åˆ°æ–‡æœ¬æˆ–å°šæœªç¿»è¯‘")],64))])]),e("div",Jl,[T.value?(A(),ut(ko,{key:0,visible:!0,percentage:R.value,label:M.value||"ä¸‹è½½ä¸­ï¼Œè¯·ç¨å€™..."},null,8,["percentage","label"])):ce("",!0),e("div",Yl,[e("button",{id:"downloadButton",class:"download-btn primary",disabled:!V.value,onClick:i}," ä¸‹è½½å½“å‰å›¾ç‰‡ ",8,Xl),e("div",Gl,[e("button",{id:"downloadAllImagesButton",class:"download-btn primary",disabled:!I.value,onClick:P}," ä¸‹è½½æ‰€æœ‰å›¾ç‰‡ ",8,Zl),e("div",Ql,[Ce(Ke,{modelValue:p.value,"onUpdate:modelValue":h[0]||(h[0]=D=>p.value=D),options:s},null,8,["modelValue"])])]),e("button",{id:"exportTextButton",class:"download-btn success",disabled:!I.value,onClick:d}," å¯¼å‡ºæ–‡æœ¬ ",8,ei),e("button",{id:"importTextButton",class:"download-btn success",disabled:!I.value,onClick:g}," å¯¼å…¥æ–‡æœ¬ ",8,ti),e("input",{type:"file",ref_key:"importFileInput",ref:_,id:"importTextFileInput",style:{display:"none"},accept:".json",onChange:f},null,544)])])])):(A(),L("section",oi))}}),si=He(ni,[["__scopeId","data-v-7a09e8a5"]]),ai={class:"guide-content"},li={class:"guide-footer"},ii={class:"dont-show-option"},Kt="saber_translator_dismiss_setup_reminder",ri=je({__name:"FirstTimeGuide",emits:["openSettings"],setup(n,{expose:t,emit:s}){const o=s,l=w(!1),u=w(!1);dt(()=>{localStorage.getItem(Kt)!=="true"&&(l.value=!0)});function a(){u.value&&localStorage.setItem(Kt,"true"),l.value=!1}function c(){localStorage.setItem(Kt,"true"),l.value=!1,o("openSettings")}function m(){localStorage.removeItem(Kt)}return t({resetGuideState:m,showGuide:l}),(p,_)=>(A(),ut(Tn,{"model-value":l.value,title:"æ¬¢è¿ä½¿ç”¨ Saber-Translator",onClose:a},{default:St(()=>[e("div",ai,[_[3]||(_[3]=e("div",{class:"guide-icon"},"ğŸ‰",-1)),_[4]||(_[4]=e("div",{class:"guide-message"},[e("p",{class:"guide-title"},"é¦–æ¬¡ä½¿ç”¨æé†’"),e("p",{class:"guide-text"}," åœ¨å¼€å§‹ç¿»è¯‘ä¹‹å‰ï¼Œè¯·å…ˆé…ç½®ç¿»è¯‘æœåŠ¡ã€‚ "),e("p",{class:"guide-text"},[me(" ç‚¹å‡»å³ä¸Šè§’çš„ "),e("span",{class:"highlight"},"âš™ï¸ è®¾ç½®"),me(" æŒ‰é’®ï¼Œé…ç½®ä»¥ä¸‹å†…å®¹ï¼š ")]),e("ul",{class:"guide-list"},[e("li",null,"é€‰æ‹© OCR å¼•æ“ï¼ˆæ–‡å­—è¯†åˆ«ï¼‰"),e("li",null,"é…ç½®ç¿»è¯‘æœåŠ¡å•†å’Œ API Key"),e("li",null,"ï¼ˆå¯é€‰ï¼‰é…ç½®é«˜è´¨é‡ç¿»è¯‘å’Œ AI æ ¡å¯¹")])],-1)),e("div",{class:"guide-actions"},[e("button",{class:"guide-btn primary",onClick:c},[..._[1]||(_[1]=[e("span",{class:"btn-icon"},"âš™ï¸",-1),me(" ç«‹å³é…ç½® ",-1)])]),e("button",{class:"guide-btn secondary",onClick:a}," ç¨åé…ç½® ")]),e("div",li,[e("label",ii,[ne(e("input",{type:"checkbox","onUpdate:modelValue":_[0]||(_[0]=T=>u.value=T)},null,512),[[Qe,u.value]]),_[2]||(_[2]=e("span",null,"ä¸å†æ˜¾ç¤ºæ­¤æé†’",-1))])])])]),_:1},8,["model-value"]))}}),ui=He(ri,[["__scopeId","data-v-eda18e4a"]]),mo="saber_translator_dismiss_setup_reminder",ci=["siliconflow","deepseek","volcano","caiyun","baidu_translate","youdao_translate","gemini","custom_openai"],di={manga_ocr:"MangaOCR",paddle_ocr:"PaddleOCR",baidu_ocr:"ç™¾åº¦OCR",ai_vision:"AIè§†è§‰OCR"},gi=["ollama","sakura"],pi=["custom_openai"],mi=["custom_openai"],vi={siliconflow:"SiliconFlow",deepseek:"DeepSeek",volcano:"ç«å±±å¼•æ“",caiyun:"å½©äº‘å°è¯‘",baidu_translate:"ç™¾åº¦ç¿»è¯‘",youdao_translate:"æœ‰é“ç¿»è¯‘",gemini:"Google Gemini",custom_openai:"è‡ªå®šä¹‰ OpenAI",ollama:"Ollama",sakura:"Sakura"};function En(){const n=ze(),t=ct(),s=w(!1),o=w(!1),l=X(()=>{try{return localStorage.getItem(mo)==="true"}catch{return!1}});function u($){return vi[$]||$}function a($){return ci.includes($)}function c($){return gi.includes($)}function m($){return pi.includes($)}function p($){return mi.includes($)}function _($){return di[$]||$}function T(){const $=n.settings,N=$.ocrEngine,z=$.baiduOcr,ae=$.aiVisionOcr,j=[];return N?(N==="baidu_ocr"&&((!z?.apiKey||z.apiKey.trim()==="")&&j.push("ç™¾åº¦OCR çš„ API Key"),(!z?.secretKey||z.secretKey.trim()==="")&&j.push("ç™¾åº¦OCR çš„ Secret Key")),N==="ai_vision"&&(ae?.provider||j.push("AIè§†è§‰OCR çš„æœåŠ¡å•†"),(!ae?.apiKey||ae.apiKey.trim()==="")&&j.push("AIè§†è§‰OCR çš„ API Key"),(!ae?.modelName||ae.modelName.trim()==="")&&j.push("AIè§†è§‰OCR çš„æ¨¡å‹åç§°"),ae?.provider==="custom"&&(!ae?.customBaseUrl||ae.customBaseUrl.trim()==="")&&j.push("AIè§†è§‰OCR çš„è‡ªå®šä¹‰ Base URL")),j.length>0?{valid:!1,message:`è¯·å…ˆåœ¨é¡¶éƒ¨ âš™ï¸ è®¾ç½®èœå•ä¸­å¡«å†™ ${j[0]}`,missingItems:j}:{valid:!0,message:""}):{valid:!1,message:"è¯·å…ˆåœ¨é¡¶éƒ¨ âš™ï¸ è®¾ç½®èœå•ä¸­é€‰æ‹© OCR å¼•æ“",missingItems:["OCR å¼•æ“"]}}function M(){const{translation:$}=n.settings,{provider:N,apiKey:z,modelName:ae,customBaseUrl:j}=$,q=[];return N?(a(N)&&(!z||z.trim()==="")&&q.push(`${u(N)} çš„ API Key`),(!ae||ae.trim()==="")&&(c(N)||a(N))&&q.push(`${u(N)} çš„æ¨¡å‹åç§°`),m(N)&&(!j||j.trim()==="")&&q.push("è‡ªå®šä¹‰ OpenAI æœåŠ¡çš„ Base URL"),q.length>0?{valid:!1,message:`è¯·å…ˆåœ¨é¡¶éƒ¨ âš™ï¸ è®¾ç½®èœå•ä¸­å¡«å†™ ${q[0]}`,missingItems:q}:{valid:!0,message:""}):{valid:!1,message:"è¯·å…ˆåœ¨é¡¶éƒ¨ âš™ï¸ è®¾ç½®èœå•ä¸­é€‰æ‹©ç¿»è¯‘æœåŠ¡å•†",missingItems:["ç¿»è¯‘æœåŠ¡å•†"]}}function R(){const{hqTranslation:$}=n.settings,{provider:N,apiKey:z,modelName:ae,customBaseUrl:j}=$,q=[];return N?((!z||z.trim()==="")&&q.push("é«˜è´¨é‡ç¿»è¯‘çš„ API Key"),(!ae||ae.trim()==="")&&q.push("é«˜è´¨é‡ç¿»è¯‘çš„æ¨¡å‹åç§°"),p(N)&&(!j||j.trim()==="")&&q.push("é«˜è´¨é‡ç¿»è¯‘çš„ Base URL"),q.length>0?{valid:!1,message:`è¯·å…ˆåœ¨é¡¶éƒ¨ âš™ï¸ è®¾ç½®èœå•ä¸­å¡«å†™ ${q[0]}`,missingItems:q}:{valid:!0,message:""}):{valid:!1,message:"è¯·å…ˆåœ¨é¡¶éƒ¨ âš™ï¸ è®¾ç½®èœå•ä¸­é€‰æ‹©é«˜è´¨é‡ç¿»è¯‘çš„æœåŠ¡å•†",missingItems:["é«˜è´¨é‡ç¿»è¯‘æœåŠ¡å•†"]}}function I($){const N=$||n.settings.proofreading.rounds,z=[];if(!N||N.length===0)return{valid:!1,message:"è¯·å…ˆåœ¨é¡¶éƒ¨ âš™ï¸ è®¾ç½®èœå•ä¸­æ·»åŠ è‡³å°‘ä¸€ä¸ªæ ¡å¯¹è½®æ¬¡",missingItems:["æ ¡å¯¹è½®æ¬¡"]};for(let ae=0;ae<N.length;ae++){const j=N[ae];if(!j)continue;const q=j.name||`è½®æ¬¡${ae+1}`;if(j.provider||z.push(`æ ¡å¯¹ ${q} çš„æœåŠ¡å•†`),(!j.apiKey||j.apiKey.trim()==="")&&z.push(`æ ¡å¯¹ ${q} çš„ API Key`),(!j.modelName||j.modelName.trim()==="")&&z.push(`æ ¡å¯¹ ${q} çš„æ¨¡å‹åç§°`),z.length>0)return{valid:!1,message:`è¯·å…ˆåœ¨é¡¶éƒ¨ âš™ï¸ è®¾ç½®èœå•ä¸­ä¸º ${z[0]}`,missingItems:z}}return{valid:!0,message:""}}function E($="normal",N={}){let z;switch($){case"normal":z=M();break;case"hq":z=R();break;case"proofread":z=I(N.proofreadingRounds);break;case"ocr":z=T();break;default:z=M()}return z.valid?!0:(t.error(z.message),V(),!1)}function H(){const $=T();if(!$.valid)return t.error($.message),V(),!1;const N=M();return N.valid?!0:(t.error(N.message),V(),!1)}function V(){const $=document.getElementById("openSettingsBtn");$&&(o.value=!0,$.style.animation="settingsBtnPulse 0.5s ease-in-out 3",$.style.boxShadow="0 0 10px var(--primary-color, #4a90d9)",setTimeout(()=>{$.style.animation="",$.style.boxShadow="",o.value=!1},3e3))}function F(){if(l.value){console.log("ç”¨æˆ·å·²é€‰æ‹©ä¸å†æ˜¾ç¤ºè®¾ç½®æé†’");return}s.value=!0}function b($=!1){if($)try{localStorage.setItem(mo,"true"),console.log("ç”¨æˆ·é€‰æ‹©æ°¸ä¹…å…³é—­è®¾ç½®æé†’")}catch(N){console.error("ä¿å­˜è®¾ç½®æé†’çŠ¶æ€å¤±è´¥:",N)}s.value=!1}function v(){try{localStorage.removeItem(mo),console.log("è®¾ç½®æé†’çŠ¶æ€å·²é‡ç½®")}catch($){console.error("é‡ç½®è®¾ç½®æé†’çŠ¶æ€å¤±è´¥:",$)}}function k(){setTimeout(()=>{F()},500)}return{showSetupReminder:s,isSettingsButtonHighlighted:o,isSetupReminderDismissed:l,validateOcrConfig:T,validateTranslationConfig:M,validateHqTranslationConfig:R,validateProofreadingConfig:I,validateBeforeTranslation:E,validateFullTranslationConfig:H,highlightSettingsButton:V,checkAndShowSetupReminder:F,closeSetupReminder:b,resetSetupReminderDismiss:v,initValidation:k,getProviderDisplayName:u,getOcrEngineDisplayName:_,requiresApiKey:a,isLocalProvider:c,requiresBaseUrl:m}}const gt=Xt("bubble",()=>{const n=w([]),t=w(-1),s=w([]),o=w([]),l=w(!1),u=w(-1),a=w(0),c=w(0),m=w(0),p=w(0),_=w(!1),T=w(-1),M=w(null),R=w(!1),I=w(-1),E=w(0),H=X(()=>t.value>=0&&t.value<n.value.length?n.value[t.value]??null:null),V=X(()=>n.value.length),F=X(()=>n.value.length>0),b=X(()=>t.value>=0),v=X(()=>s.value.length>1),k=X(()=>s.value.filter(B=>B>=0&&B<n.value.length).map(B=>n.value[B]).filter(B=>B!==void 0));function $(){const ee=et().currentImage;ee&&(ee.bubbleStates=Wt(n.value),ee.hasUnsavedChanges=!0,console.log("æ°”æ³¡çŠ¶æ€å·²åŒæ­¥åˆ°å½“å‰å›¾ç‰‡"))}function N(B,ee=!1){n.value=B,o.value=Wt(B),S(),console.log(`æ°”æ³¡æ•°ç»„å·²è®¾ç½®ï¼Œå…± ${B.length} ä¸ªæ°”æ³¡`),ee||$()}function z(B,ee){const de=ra(B),xe=ze().settings.textStyle,we=xe.layoutDirection,$e=we==="vertical"||we==="horizontal"?we:de==="vertical"||de==="horizontal"?de:"vertical",ie=ia({coords:B,translatedText:"",autoTextDirection:de,fontSize:xe.fontSize,fontFamily:xe.fontFamily,textDirection:$e,textColor:xe.textColor,fillColor:xe.fillColor,inpaintMethod:xe.inpaintMethod,strokeEnabled:xe.strokeEnabled,strokeColor:xe.strokeColor,strokeWidth:xe.strokeWidth,rotationAngle:0,position:{x:0,y:0},...ee});return n.value.push(ie),console.log(`å·²æ·»åŠ æ°”æ³¡ï¼Œå½“å‰å…± ${n.value.length} ä¸ª`),$(),ie}function ae(B){return B<0||B>=n.value.length?(console.warn(`åˆ é™¤å¤±è´¥: æ— æ•ˆçš„ç´¢å¼• ${B}`),!1):(n.value.splice(B,1),t.value===B?t.value=-1:t.value>B&&t.value--,s.value=s.value.filter(ee=>ee!==B).map(ee=>ee>B?ee-1:ee),console.log(`å·²åˆ é™¤æ°”æ³¡ï¼Œå½“å‰å…± ${n.value.length} ä¸ª`),$(),!0)}function j(){if(s.value.length===0&&t.value<0)return;const B=[...new Set([...s.value,t.value])].filter(ee=>ee>=0).sort((ee,de)=>de-ee);for(const ee of B)n.value.splice(ee,1);S(),console.log(`å·²åˆ é™¤ ${B.length} ä¸ªæ°”æ³¡`),$()}function q(){n.value=[],o.value=[],S(),console.log("æ‰€æœ‰æ°”æ³¡å·²æ¸…é™¤"),$()}function Q(){n.value=[],o.value=[],S(),console.log("æœ¬åœ°æ°”æ³¡çŠ¶æ€å·²æ¸…é™¤ï¼ˆä¸åŒæ­¥åˆ°imageStoreï¼‰")}function W(B){B>=-1&&B<n.value.length&&(t.value=B,s.value=B>=0?[B]:[],console.log(`å·²é€‰ä¸­æ°”æ³¡ ${B}`))}function se(B){if(B<0||B>=n.value.length)return;const ee=s.value.indexOf(B);ee>=0?(s.value.splice(ee,1),t.value===B&&(t.value=s.value[0]??-1)):(s.value.push(B),t.value=B),console.log(`å¤šé€‰çŠ¶æ€: ${s.value.join(", ")}`)}function S(){t.value=-1,s.value=[]}function i(){t.value>=0?s.value=[t.value]:s.value=[]}function P(){if(n.value.length===0)return!1;const B=t.value<n.value.length-1?t.value+1:0;return W(B),!0}function d(){if(n.value.length===0)return!1;const B=t.value>0?t.value-1:n.value.length-1;return W(B),!0}function g(B,ee){if(B<0||B>=n.value.length)return console.warn(`æ›´æ–°å¤±è´¥: æ— æ•ˆçš„ç´¢å¼• ${B}`),!1;const de=n.value[B];return de?(Object.assign(de,ee),console.log(`å·²æ›´æ–°æ°”æ³¡ ${B}`),$(),!0):!1}function f(B){return t.value<0?(console.warn("æ›´æ–°å¤±è´¥: æ²¡æœ‰é€‰ä¸­çš„æ°”æ³¡"),!1):g(t.value,B)}function x(B){const ee=s.value.length>0?s.value:t.value>=0?[t.value]:[];for(const de of ee){const ve=n.value[de];ve&&Object.assign(ve,B)}$(),console.log(`å·²æ‰¹é‡æ›´æ–° ${ee.length} ä¸ªæ°”æ³¡`)}function h(B){for(let ee=0;ee<n.value.length;ee++){const de=n.value[ee];de&&Object.assign(de,B)}$(),console.log(`å·²æ›´æ–°æ‰€æœ‰ ${n.value.length} ä¸ªæ°”æ³¡`)}function D(){if(n.value.length!==o.value.length)return!0;for(let B=0;B<n.value.length;B++){const ee=n.value[B],de=o.value[B];if(!(!ee||!de)&&(ee.translatedText!==de.translatedText||ee.textboxText!==de.textboxText||ee.fontSize!==de.fontSize||ee.fontFamily!==de.fontFamily||ee.textDirection!==de.textDirection||ee.textColor!==de.textColor||ee.fillColor!==de.fillColor||ee.rotationAngle!==de.rotationAngle||ee.strokeEnabled!==de.strokeEnabled||ee.strokeColor!==de.strokeColor||ee.strokeWidth!==de.strokeWidth||ee.inpaintMethod!==de.inpaintMethod||JSON.stringify(ee.coords)!==JSON.stringify(de.coords)))return!0}return!1}function Y(){n.value=Wt(o.value),S(),console.log("æ°”æ³¡çŠ¶æ€å·²é‡ç½®åˆ°åˆå§‹çŠ¶æ€")}function Z(){o.value=Wt(n.value),console.log("å½“å‰çŠ¶æ€å·²ä¿å­˜ä¸ºåˆå§‹çŠ¶æ€")}function r(){return{bubble_coords:n.value.map(B=>B.coords),bubble_texts:n.value.map(B=>B.translatedText),textbox_texts:n.value.map(B=>B.textboxText),font_sizes:n.value.map(B=>B.fontSize),font_families:n.value.map(B=>B.fontFamily),text_directions:n.value.map(B=>B.textDirection==="vertical"||B.textDirection==="horizontal"?B.textDirection==="vertical"?"v":"h":B.autoTextDirection==="vertical"||B.autoTextDirection==="horizontal"?B.autoTextDirection==="vertical"?"v":"h":"v"),text_colors:n.value.map(B=>B.textColor),fill_colors:n.value.map(B=>B.fillColor),rotation_angles:n.value.map(B=>B.rotationAngle),stroke_enabled:n.value.map(B=>B.strokeEnabled),stroke_colors:n.value.map(B=>B.strokeColor),stroke_widths:n.value.map(B=>B.strokeWidth),inpaint_methods:n.value.map(B=>B.inpaintMethod)}}function y(){return JSON.stringify(n.value)}function le(B){try{const ee=JSON.parse(B);if(!Array.isArray(ee))return console.error("ååºåˆ—åŒ–å¤±è´¥: æ•°æ®ä¸æ˜¯æ•°ç»„"),!1;const de=[];for(const ve of ee)ua(ve)?de.push(ve):console.warn("è·³è¿‡æ— æ•ˆçš„æ°”æ³¡çŠ¶æ€:",ve);return N(de),!0}catch(ee){return console.error("ååºåˆ—åŒ–å¤±è´¥:",ee),!1}}return{bubbles:n,selectedIndex:t,selectedIndices:s,initialStates:o,isDragging:l,draggingIndex:u,dragOffsetX:a,dragOffsetY:c,dragInitialX:m,dragInitialY:p,isResizing:_,resizingIndex:T,resizeCurrentCoords:M,isRotating:R,rotatingIndex:I,rotateCurrentAngle:E,selectedBubble:H,bubbleCount:V,hasBubbles:F,hasSelection:b,isMultiSelect:v,selectedBubbles:k,setBubbles:N,addBubble:z,deleteBubble:ae,deleteSelected:j,clearBubbles:q,clearBubblesLocal:Q,selectBubble:W,toggleMultiSelect:se,clearSelection:S,clearMultiSelect:i,selectNext:P,selectPrevious:d,updateBubble:g,updateSelectedBubble:f,updateAllSelected:x,updateAllBubbles:h,hasChanges:D,resetToInitial:Y,saveAsInitial:Z,toApiRequest:r,serialize:y,deserialize:le}}),fi=Object.freeze(Object.defineProperty({__proto__:null,useBubbleStore:gt},Symbol.toStringTag,{value:"Module"}));function bi(){const n=w({current:0,total:0,completed:0,failed:0,isInProgress:!1,label:"",percentage:0});return{progress:n,reporter:{init(s,o){n.value={current:0,total:s,completed:0,failed:0,isInProgress:!0,label:o||"å‡†å¤‡ä¸­...",percentage:0}},update(s,o){n.value.current=s,o!==void 0&&(n.value.label=o),n.value.total>0&&(n.value.percentage=Math.round(s/n.value.total*100))},setPercentage(s,o){n.value.percentage=Math.min(100,Math.max(0,s)),o!==void 0&&(n.value.label=o)},incrementCompleted(){n.value.completed++},incrementFailed(){n.value.failed++},finish(){n.value.isInProgress=!1,n.value.percentage=100},getProgress(){return{...n.value}}}}}async function wo(n){return Xe.post("/api/parallel/detect",n)}async function $o(n){return Xe.post("/api/parallel/ocr",n)}async function To(n){return Xe.post("/api/parallel/color",n)}async function Io(n){return Xe.post("/api/parallel/translate",n)}async function Po(n){return Xe.post("/api/parallel/inpaint",n)}async function Ro(n){return Xe.post("/api/parallel/render",n)}const hi=Object.freeze(Object.defineProperty({__proto__:null,parallelColor:To,parallelDetect:wo,parallelInpaint:Po,parallelOcr:$o,parallelRender:Ro,parallelTranslate:Io},Symbol.toStringTag,{value:"Module"}));let Tt=null,Ot=!1;function Pt(){const n=It();return ze().settings.autoSaveInBookshelfMode&&n.isBookshelfMode}function Do(){const n=It(),t=n.currentBookId,s=n.currentChapterId;return!t||!s?null:`bookshelf/${t}/${s}`}function Bn(){const n=ze(),{textStyle:t}=n.settings;return{fontSize:t.fontSize,autoFontSize:t.autoFontSize,fontFamily:t.fontFamily,layoutDirection:t.layoutDirection,textColor:t.textColor,useInpaintingMethod:t.inpaintMethod,fillColor:t.fillColor,strokeEnabled:t.strokeEnabled,strokeColor:t.strokeColor,strokeWidth:t.strokeWidth,useAutoTextColor:t.useAutoTextColor}}async function An(n){const t=et();if(!Pt())return console.log("[AutoSave] è‡ªåŠ¨ä¿å­˜æœªå¯ç”¨æˆ–éä¹¦æ¶æ¨¡å¼ï¼Œè·³è¿‡é¢„ä¿å­˜"),!0;const s=Do();if(!s)return console.warn("[AutoSave] ç¼ºå°‘ä¹¦ç±/ç« èŠ‚IDï¼Œè·³è¿‡é¢„ä¿å­˜"),n?.onError?.("ç¼ºå°‘ä¹¦ç±/ç« èŠ‚ID"),!1;const o=t.images,l=o.length;if(l===0)return console.warn("[AutoSave] æ²¡æœ‰å›¾ç‰‡ï¼Œè·³è¿‡é¢„ä¿å­˜"),n?.onError?.("æ²¡æœ‰å›¾ç‰‡"),!1;console.log(`[AutoSave] é¢„ä¿å­˜å¼€å§‹ï¼š${l} é¡µï¼ˆé€é¡µä¿å­˜ï¼‰`),n?.onStart?.(l);try{const{saveAllPagesSequentially:u,saveSessionMeta:a}=await it(async()=>{const{saveAllPagesSequentially:M,saveSessionMeta:R}=await Promise.resolve().then(()=>Mn);return{saveAllPagesSequentially:M,saveSessionMeta:R}},void 0),c=Bn(),m=await u(s,o,{onProgress:(M,R)=>{n?.onProgress?.(M,R)}});await a(s,{ui_settings:c,total_pages:l,currentImageIndex:t.currentImageIndex});const p=It(),_=p.currentBookId,T=p.currentChapterId;if(_&&T)try{const{apiClient:M}=await it(async()=>{const{apiClient:R}=await import("./client.Bht704G-.js");return{apiClient:R}},__vite__mapDeps([4,5]));await M.put(`/api/bookshelf/books/${_}/chapters/${T}/image-count`,{count:l}),console.log(`[AutoSave] å·²æ›´æ–°ç« èŠ‚å›¾ç‰‡æ•°é‡ä¸º ${l}`)}catch(M){console.warn("[AutoSave] æ›´æ–°ç« èŠ‚å›¾ç‰‡æ•°é‡å¤±è´¥ï¼ˆéè‡´å‘½ï¼‰:",M)}return Tt=s,Ot=!0,console.log(`[AutoSave] é¢„ä¿å­˜å®Œæˆï¼Œå…±ä¿å­˜ ${m}/${l} é¡µ`),n?.onComplete?.(),!0}catch(u){console.error("[AutoSave] é¢„ä¿å­˜å¤±è´¥:",u);const a=u instanceof Error?u.message:"é¢„ä¿å­˜å¤±è´¥";return n?.onError?.(a),Tt=null,Ot=!1,!1}}async function Ln(n){if(!Pt())return;const t=Tt||Do();if(!t){console.warn("[AutoSave] ä¼šè¯è·¯å¾„ä¸å­˜åœ¨ï¼Œè·³è¿‡ä¿å­˜");return}const s=et(),o=s.images[n];if(!o){console.warn(`[AutoSave] é¡µé¢ ${n} ä¸å­˜åœ¨`);return}try{const l={};o.translatedDataURL?.startsWith("data:")&&(l.translated=o.translatedDataURL),o.cleanImageData&&typeof o.cleanImageData=="string"&&!o.cleanImageData.startsWith("/api/")&&(l.clean=o.cleanImageData.startsWith("data:")?o.cleanImageData:`data:image/png;base64,${o.cleanImageData}`);const u={};for(const c of Object.keys(o))["originalDataURL","translatedDataURL","cleanImageData"].includes(c)||(u[c]=o[c]);l.meta=u;const a=await Dn(t,n,l);if(!a.success)throw new Error(a.error||"ä¿å­˜å¤±è´¥");s.updateImageByIndex(n,{hasUnsavedChanges:!1}),console.log(`[AutoSave] é¡µé¢ ${n+1} å·²ä¿å­˜`)}catch(l){throw console.error(`[AutoSave] ä¿å­˜é¡µé¢ ${n+1} å¤±è´¥:`,l),l}}async function Fn(){if(!Pt())return;const n=Tt||Do();if(!n||!Ot){console.log("[AutoSave] æœªæ‰§è¡Œé¢„ä¿å­˜ï¼Œè·³è¿‡å®Œæˆä¿å­˜");return}console.log("[AutoSave] å®Œæˆä¿å­˜...");const t=et(),s=It(),o=t.images.length;try{await Pn(n,{ui_settings:Bn(),total_pages:o,currentImageIndex:t.currentImageIndex});const l=s.currentBookId,u=s.currentChapterId;if(l&&u)try{const{apiClient:a}=await it(async()=>{const{apiClient:c}=await import("./client.Bht704G-.js");return{apiClient:c}},__vite__mapDeps([4,5]));await a.put(`/api/bookshelf/books/${l}/chapters/${u}/image-count`,{count:o}),console.log(`[AutoSave] å·²æ›´æ–°ç« èŠ‚å›¾ç‰‡æ•°é‡ä¸º ${o}`)}catch(a){console.warn("[AutoSave] æ›´æ–°ç« èŠ‚å›¾ç‰‡æ•°é‡å¤±è´¥ï¼ˆéè‡´å‘½ï¼‰:",a)}console.log("[AutoSave] ä¼šè¯ä¿å­˜å®Œæˆ")}catch(l){console.error("[AutoSave] å®Œæˆä¿å­˜å¤±è´¥:",l)}finally{Tt=null,Ot=!1}}function Un(){Tt=null,Ot=!1,console.log("[AutoSave] ä¿å­˜çŠ¶æ€å·²é‡ç½®")}const mn={standard:["detection","ocr","color","translate","inpaint","render"],hq:["detection","ocr","color","aiTranslate","inpaint","render"],proofread:["aiTranslate","render"],removeText:["detection","inpaint","render"]},qt={detection:"æ°”æ³¡æ£€æµ‹",ocr:"æ–‡å­—è¯†åˆ«",color:"é¢œè‰²æå–",translate:"ç¿»è¯‘",aiTranslate:"AIç¿»è¯‘",inpaint:"èƒŒæ™¯ä¿®å¤",render:"æ¸²æŸ“",save:"ä¿å­˜"};function xi(){const n=et(),t=gt(),s=ze(),o=En(),l=ct(),{progress:u,reporter:a}=bi(),c=w(!1),m=w(null);let p=null,_="standard";const T=X(()=>c.value||n.isBatchTranslationInProgress),M=X(()=>u.value.percentage||0);function R(){const d=s.settings.translation.rpmLimit;m.value?m.value.setRpm(d):m.value=ca(d)}function I(d){const g=d.mode==="hq"?"hq":d.mode==="proofread"?"proofread":d.mode==="removeText"?"ocr":"normal";return o.validateBeforeTranslation(g)}function E(){const{textStyle:d}=s.settings,g=d.layoutDirection;p={fontFamily:d.fontFamily,fontSize:d.fontSize,autoFontSize:d.autoFontSize,autoTextDirection:g==="auto",textDirection:g==="auto"?"vertical":g,layoutDirection:g,fillColor:d.fillColor,textColor:d.textColor,rotationAngle:0,strokeEnabled:d.strokeEnabled,strokeColor:d.strokeColor,strokeWidth:d.strokeWidth,useAutoTextColor:d.useAutoTextColor,inpaintMethod:d.inpaintMethod}}function H(d){return d.includes("base64,")?d.split("base64,")[1]||"":d}function V(d){const g=n.images;if(d.scope==="current"){const f=n.currentImage;return f?[{image:f,index:n.currentImageIndex}]:[]}if(d.scope==="failed")return n.getFailedImageIndices().map(f=>({image:g[f],index:f})).filter(f=>f.image!==void 0);if(d.scope==="range"&&d.pageRange){const f=Math.max(0,d.pageRange.startPage-1),x=Math.min(g.length-1,d.pageRange.endPage-1);return f>x||f>=g.length?[]:g.slice(f,x+1).map((h,D)=>({image:h,index:f+D}))}return g.map((f,x)=>({image:f,index:x}))}async function F(d){const g=d.image.bubbleStates;if(g!=null){g.length>0?(console.log(`å›¾ç‰‡ ${d.imageIndex+1} å·²æœ‰ ${g.length} ä¸ªæ°”æ³¡ï¼Œè·³è¿‡æ£€æµ‹`),d.bubbleCoords=g.map(D=>D.coords.map(Y=>Math.round(Y))),d.bubbleAngles=g.map(D=>D.rotationAngle||0),d.bubblePolygons=g.map(D=>D.polygon||[]),d.autoDirections=g.map(D=>D.autoTextDirection||D.textDirection||"vertical"),d.originalTexts=g.map(D=>D.originalText||"")):(console.log(`å›¾ç‰‡ ${d.imageIndex+1} æ°”æ³¡å·²è¢«æ¸…ç©ºï¼Œè·³è¿‡æ£€æµ‹`),d.bubbleCoords=[],d.bubbleAngles=[],d.bubblePolygons=[],d.autoDirections=[],d.originalTexts=[]);return}const f=s.settings,x=H(d.image.originalDataURL),h=await wo({image:x,detector_type:f.textDetector,box_expand_ratio:f.boxExpand.ratio,box_expand_top:f.boxExpand.top,box_expand_bottom:f.boxExpand.bottom,box_expand_left:f.boxExpand.left,box_expand_right:f.boxExpand.right});if(!h.success)throw new Error(h.error||"æ£€æµ‹å¤±è´¥");d.bubbleCoords=h.bubble_coords||[],d.bubbleAngles=h.bubble_angles||[],d.bubblePolygons=h.bubble_polygons||[],d.autoDirections=h.auto_directions||[],d.rawMask=h.raw_mask,d.textlinesPerBubble=h.textlines_per_bubble||[]}async function b(d){if(d.bubbleCoords.length===0){d.originalTexts=[];return}const g=s.settings,f=H(d.image.originalDataURL),x=g.ocrEngine==="paddleocr_vl"?g.paddleOcrVl?.sourceLanguage||"japanese":g.sourceLanguage,h=await $o({image:f,bubble_coords:d.bubbleCoords,source_language:x,ocr_engine:g.ocrEngine,baidu_api_key:g.baiduOcr?.apiKey,baidu_secret_key:g.baiduOcr?.secretKey,baidu_version:g.baiduOcr?.version,baidu_ocr_language:g.baiduOcr?.sourceLanguage,ai_vision_provider:g.aiVisionOcr?.provider,ai_vision_api_key:g.aiVisionOcr?.apiKey,ai_vision_model_name:g.aiVisionOcr?.modelName,ai_vision_ocr_prompt:g.aiVisionOcr?.prompt,custom_ai_vision_base_url:g.aiVisionOcr?.customBaseUrl,textlines_per_bubble:d.textlinesPerBubble});if(!h.success)throw new Error(h.error||"OCRå¤±è´¥");d.originalTexts=h.original_texts||[]}async function v(d){if(d.bubbleCoords.length===0){d.colors=[];return}const g=H(d.image.originalDataURL),f=await To({image:g,bubble_coords:d.bubbleCoords,textlines_per_bubble:d.textlinesPerBubble});if(!f.success)throw new Error(f.error||"é¢œè‰²æå–å¤±è´¥");d.colors=f.colors||[]}async function k(d){if(d.originalTexts.length===0){d.translatedTexts=[],d.textboxTexts=[];return}const g=s.settings;if((g.translation.translationMode||"batch")==="single"){console.log(`[ç¿»è¯‘] ä½¿ç”¨é€æ°”æ³¡ç¿»è¯‘æ¨¡å¼ï¼Œå…± ${d.originalTexts.length} ä¸ªæ°”æ³¡`),d.translatedTexts=[],d.textboxTexts=[];for(let x=0;x<d.originalTexts.length;x++){const h=d.originalTexts[x];if(!h||h.trim()===""){d.translatedTexts.push(""),g.useTextboxPrompt&&d.textboxTexts.push("");continue}try{const D=await Lt({original_text:h,model_provider:g.translation.provider,model_name:g.translation.modelName,api_key:g.translation.apiKey,custom_base_url:g.translation.customBaseUrl,target_language:g.targetLanguage,prompt_content:g.translatePrompt,use_json_format:g.translation.isJsonMode,rpm_limit_translation:g.translation.rpmLimit,max_retries:g.translation.maxRetries});if(D.success&&D.data?d.translatedTexts.push(D.data.translated_text||""):(console.warn(`[ç¿»è¯‘] æ°”æ³¡ ${x+1} ç¿»è¯‘å¤±è´¥: ${D.error}`),d.translatedTexts.push("ã€ç¿»è¯‘å¤±è´¥ã€‘è¯·æ£€æŸ¥ç»ˆç«¯ä¸­çš„é”™è¯¯æ—¥å¿—")),g.useTextboxPrompt&&g.textboxPrompt){const Y=await Lt({original_text:h,model_provider:g.translation.provider,model_name:g.translation.modelName,api_key:g.translation.apiKey,custom_base_url:g.translation.customBaseUrl,target_language:g.targetLanguage,prompt_content:g.textboxPrompt,rpm_limit_translation:g.translation.rpmLimit,max_retries:g.translation.maxRetries});Y.success&&Y.data?d.textboxTexts.push(Y.data.translated_text||""):d.textboxTexts.push("")}m.value&&x<d.originalTexts.length-1&&await m.value.acquire()}catch(D){console.error(`[ç¿»è¯‘] æ°”æ³¡ ${x+1} ç¿»è¯‘å‡ºé”™:`,D),d.translatedTexts.push("ã€ç¿»è¯‘å¤±è´¥ã€‘è¯·æ£€æŸ¥ç»ˆç«¯ä¸­çš„é”™è¯¯æ—¥å¿—"),g.useTextboxPrompt&&d.textboxTexts.push("")}}console.log(`[ç¿»è¯‘] é€æ°”æ³¡ç¿»è¯‘å®Œæˆï¼ŒæˆåŠŸ ${d.translatedTexts.filter(x=>x&&!x.startsWith("[ç¿»è¯‘")).length}/${d.originalTexts.length}`)}else{console.log(`[ç¿»è¯‘] ä½¿ç”¨æ•´é¡µæ‰¹é‡ç¿»è¯‘æ¨¡å¼ï¼Œå…± ${d.originalTexts.length} ä¸ªæ°”æ³¡`);const x=await Io({original_texts:d.originalTexts,target_language:g.targetLanguage,source_language:g.sourceLanguage,model_provider:g.translation.provider,model_name:g.translation.modelName,api_key:g.translation.apiKey,custom_base_url:g.translation.customBaseUrl,prompt_content:g.translatePrompt,textbox_prompt_content:g.textboxPrompt,use_textbox_prompt:g.useTextboxPrompt,rpm_limit:g.translation.rpmLimit,max_retries:g.translation.maxRetries,use_json_format:g.translation.isJsonMode});if(!x.success)throw new Error(x.error||"ç¿»è¯‘å¤±è´¥");d.translatedTexts=x.translated_texts||[],d.textboxTexts=x.textbox_texts||[]}}async function $(d){const g=s.settings,f=_==="proofread",x=d.map(ve=>f?{imageIndex:ve.imageIndex,bubbles:(ve.image.bubbleStates||[]).map((xe,we)=>({bubbleIndex:we,original:xe.originalText||"",translated:g.useTextboxPrompt?xe.textboxText||xe.translatedText||"":xe.translatedText||"",textDirection:xe.textDirection==="vertical"||xe.textDirection==="horizontal"?xe.textDirection:xe.autoTextDirection==="vertical"||xe.autoTextDirection==="horizontal"?xe.autoTextDirection:"vertical"}))}:{imageIndex:ve.imageIndex,bubbles:ve.originalTexts.map((xe,we)=>({bubbleIndex:we,original:xe,translated:"",textDirection:ve.autoDirections[we]||"vertical"}))}),h=d.map(ve=>{const xe=f&&ve.image.translatedDataURL||ve.image.originalDataURL;return H(xe)}),D=f?g.proofreading.rounds[0]:g.hqTranslation,Y=f?D?.prompt:g.hqTranslation.prompt,Z=f?"ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ¼«ç”»ç¿»è¯‘æ ¡å¯¹åŠ©æ‰‹ï¼Œèƒ½å¤Ÿæ ¹æ®æ¼«ç”»å›¾åƒå†…å®¹æ£€æŸ¥å’Œä¿®æ­£ç¿»è¯‘ã€‚":"ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ¼«ç”»ç¿»è¯‘åŠ©æ‰‹ï¼Œèƒ½å¤Ÿæ ¹æ®æ¼«ç”»å›¾åƒå†…å®¹å’Œä¸Šä¸‹æ–‡æä¾›é«˜è´¨é‡çš„ç¿»è¯‘ã€‚",r=g.hqTranslation,y=f?D:null,le=await Ft({provider:(f?y?.provider:r.provider)||"openai",api_key:(f?y?.apiKey:r.apiKey)||"",model_name:(f?y?.modelName:r.modelName)||"",custom_base_url:f?y?.customBaseUrl:r.customBaseUrl,jsonData:x,imageBase64Array:h,prompt:Y||"",systemPrompt:Z,isProofreading:f,enableDebugLogs:g.enableVerboseLogs,low_reasoning:f?y?.lowReasoning:r.lowReasoning,force_json_output:f?y?.forceJsonOutput:r.forceJsonOutput,no_thinking_method:f?y?.noThinkingMethod:r.noThinkingMethod,use_stream:f?!1:r.useStream,max_retries:f?g.proofreading.maxRetries||2:r.maxRetries||2}),B=f?y?.forceJsonOutput||!1:r.forceJsonOutput;let de=j(le,B)||x;if(f&&g.proofreading.rounds.length>1)for(let ve=1;ve<g.proofreading.rounds.length;ve++){const xe=g.proofreading.rounds[ve],we=await Ft({provider:xe.provider,api_key:xe.apiKey,model_name:xe.modelName,custom_base_url:xe.customBaseUrl,jsonData:de,imageBase64Array:h,prompt:xe.prompt,systemPrompt:Z,isProofreading:!0,enableDebugLogs:g.enableVerboseLogs,low_reasoning:xe.lowReasoning,force_json_output:xe.forceJsonOutput,no_thinking_method:xe.noThinkingMethod,use_stream:!1,max_retries:xe.maxRetries||g.proofreading.maxRetries||2}),$e=j(we,xe.forceJsonOutput);$e&&(de=$e)}for(const ve of d){const xe=de?.find(we=>we.imageIndex===ve.imageIndex);xe?ve.translatedTexts=xe.bubbles.map(we=>we.translated):ve.translatedTexts=[],ve.textboxTexts=[]}}async function N(d){if(d.bubbleCoords.length===0){d.cleanImage=H(d.image.originalDataURL);return}const g=s.settings,{textStyle:f,preciseMask:x}=g,h=H(d.image.originalDataURL),D=await Po({image:h,bubble_coords:d.bubbleCoords,bubble_polygons:d.bubblePolygons,raw_mask:d.rawMask,method:f.inpaintMethod==="solid"?"solid":"lama",lama_model:f.inpaintMethod==="litelama"?"litelama":"lama_mpe",fill_color:f.fillColor,mask_dilate_size:x.dilateSize,mask_box_expand_ratio:x.boxExpandRatio});if(!D.success)throw new Error(D.error||"èƒŒæ™¯ä¿®å¤å¤±è´¥");d.cleanImage=D.clean_image}async function z(d){if(!d.cleanImage)throw _==="proofread"?new Error("æ­¤å›¾ç‰‡å°šæœªç¿»è¯‘ï¼Œè¯·å…ˆç¿»è¯‘åå†è¿›è¡Œæ ¡å¯¹"):new Error("ç¼ºå°‘å¹²å‡€èƒŒæ™¯å›¾ç‰‡");const{textStyle:g}=s.settings,f=p?.autoTextDirection?"auto":p?.textDirection||g.layoutDirection,x=d.bubbleCoords.map((D,Y)=>{const Z=d.autoDirections[Y]||"vertical",r=Z==="v"?"vertical":Z==="h"?"horizontal":Z==="vertical"||Z==="horizontal"?Z:"vertical",y=f==="vertical"||f==="horizontal"?f:r,le=p?.useAutoTextColor??g.useAutoTextColor;let B=p?.textColor||g.textColor,ee=p?.fillColor||g.fillColor;const de=d.colors[Y];return le&&de&&(de.textColor&&(B=de.textColor),de.bgColor&&(ee=de.bgColor)),{coords:D,polygon:[],position:{x:0,y:0},rotationAngle:d.bubbleAngles[Y]||0,originalText:d.originalTexts[Y]||"",translatedText:d.translatedTexts[Y]||"",textboxText:d.textboxTexts[Y]||"",textDirection:y,autoTextDirection:r,fontSize:p?.fontSize||g.fontSize,fontFamily:p?.fontFamily||g.fontFamily,autoFontSize:p?.autoFontSize??g.autoFontSize,textColor:B,fillColor:ee,strokeEnabled:p?.strokeEnabled??g.strokeEnabled,strokeColor:p?.strokeColor||g.strokeColor,strokeWidth:p?.strokeWidth||g.strokeWidth,inpaintMethod:p?.inpaintMethod||g.inpaintMethod,autoFgColor:d.colors[Y]?.autoFgColor||null,autoBgColor:d.colors[Y]?.autoBgColor||null}}),h=await Ro({clean_image:d.cleanImage,bubble_states:x,fontSize:p?.fontSize||g.fontSize,fontFamily:p?.fontFamily||g.fontFamily,textDirection:p?.textDirection||g.layoutDirection,textColor:p?.textColor||g.textColor,strokeEnabled:p?.strokeEnabled??g.strokeEnabled,strokeColor:p?.strokeColor||g.strokeColor,strokeWidth:p?.strokeWidth||g.strokeWidth,autoFontSize:p?.autoFontSize??g.autoFontSize,use_individual_styles:!0});if(!h.success)throw new Error(h.error||"æ¸²æŸ“å¤±è´¥");d.finalImage=h.final_image,d.bubbleStates=h.bubble_states||x}async function ae(d,g){switch(d){case"detection":await F(g);break;case"ocr":await b(g);break;case"color":await v(g);break;case"translate":await k(g);break;case"inpaint":await N(g);break;case"render":await z(g);break;case"save":await Ln(g.imageIndex);break;case"aiTranslate":throw new Error("aiTranslate åº”é€šè¿‡æ‰¹é‡å¤„ç†é€»è¾‘è°ƒç”¨")}}function j(d,g){if(!d.success)return console.error("APIè°ƒç”¨å¤±è´¥:",d.error),null;if(d.results&&d.results.length>0){const x=d.results[0];if(x&&"imageIndex"in x&&"bubbles"in x)return d.results}const f=d.content;if(f){let x=null;if(g)try{x=JSON.parse(f)}catch{return null}else{const h=f.match(/```json\s*([\s\S]*?)\s*```/);if(h?.[1])try{x=JSON.parse(h[1])}catch{return null}}if(x){if(Array.isArray(x))return x;if(typeof x=="object"&&"imageIndex"in x&&"bubbles"in x)return console.log("[parseHqResponse] æ£€æµ‹åˆ°å•å¼ å›¾ç‰‡æ ¼å¼ï¼Œè‡ªåŠ¨åŒ…è£…ä¸ºæ•°ç»„"),[x]}}return null}function q(d){const g=d.finalImage?`data:image/png;base64,${d.finalImage}`:d.cleanImage?`data:image/png;base64,${d.cleanImage}`:null,{textStyle:f}=s.settings;n.updateImageByIndex(d.imageIndex,{translatedDataURL:g,cleanImageData:d.cleanImage||null,bubbleStates:d.bubbleStates,bubbleCoords:d.bubbleCoords,bubbleAngles:d.bubbleAngles,originalTexts:d.originalTexts,textboxTexts:d.textboxTexts,bubbleTexts:d.translatedTexts,translationStatus:"completed",translationFailed:!1,showOriginal:!1,hasUnsavedChanges:!0,fontSize:p?.fontSize??f.fontSize,autoFontSize:p?.autoFontSize??f.autoFontSize,fontFamily:p?.fontFamily??f.fontFamily,layoutDirection:p?.layoutDirection??f.layoutDirection,textColor:p?.textColor??f.textColor,fillColor:p?.fillColor??f.fillColor,strokeEnabled:p?.strokeEnabled??f.strokeEnabled,strokeColor:p?.strokeColor??f.strokeColor,strokeWidth:p?.strokeWidth??f.strokeWidth,inpaintMethod:p?.inpaintMethod??f.inpaintMethod,useAutoTextColor:p?.useAutoTextColor??f.useAutoTextColor}),d.imageIndex===n.currentImageIndex&&d.bubbleStates&&t.setBubbles(d.bubbleStates)}function Q(d){return d==="standard"||d==="removeText"}function W(d){const g=s.settings;return d==="hq"?g.hqTranslation.batchSize||5:d==="proofread"?g.proofreading.rounds[0]?.batchSize||5:1}async function se(d,g,f,x){let h=0,D=0;for(let Y=0;Y<d.length;Y++){const Z=d[Y];if(f.scope==="all"&&!n.isBatchTranslationInProgress){console.log("â¹ï¸ æ‰¹é‡ç¿»è¯‘å·²å–æ¶ˆï¼Œåœæ­¢å¤„ç†");break}const r=Math.floor(Y/d.length*90);a.setPercentage(r,`å¤„ç†å›¾ç‰‡ ${Y+1}/${d.length}`),l.info(`å¤„ç†å›¾ç‰‡ ${Y+1}/${d.length}...`),n.setTranslationStatus(Z.imageIndex,"processing");let y=!1;for(let le=0;le<g.length;le++){const B=g[le];if(y)break;m.value&&await m.value.acquire();try{const ee=r+Math.floor(le/g.length*(90/d.length));a.setPercentage(ee,`å›¾ç‰‡ ${Y+1}: ${qt[B]}`),await ae(B,Z)}catch(ee){const de=ee instanceof Error?ee.message:"æœªçŸ¥é”™è¯¯";x.push(`å›¾ç‰‡ ${Z.imageIndex+1}: ${B} - ${de}`),n.setTranslationStatus(Z.imageIndex,"failed",de),y=!0,D++}}y||(q(Z),h++,console.log(`âœ… å›¾ç‰‡ ${Y+1}/${d.length} å¤„ç†å®Œæˆ`))}return{completed:h,failed:D}}async function S(d,g,f,x){let h=0,D=0;const Y=W(f.mode),Z=Math.ceil(d.length/Y),r=g.indexOf("aiTranslate"),y=r>=0?g.slice(0,r):g,le=r>=0?g.slice(r+1):[];console.log(`ğŸ“¦ æ‰¹æ¬¡å¤„ç†æ¨¡å¼ï¼šå…± ${d.length} å¼ å›¾ç‰‡ï¼Œæ¯æ‰¹ ${Y} å¼ ï¼Œå…± ${Z} æ‰¹`),console.log(`   AIç¿»è¯‘å‰æ­¥éª¤: [${y.join(" â†’ ")}]`),console.log(`   AIç¿»è¯‘åæ­¥éª¤: [${le.join(" â†’ ")}]`);for(let B=0;B<Z;B++){if(f.scope==="all"&&!n.isBatchTranslationInProgress){console.log("â¹ï¸ æ‰¹é‡ç¿»è¯‘å·²å–æ¶ˆï¼Œåœæ­¢å¤„ç†");break}const ee=B*Y,de=Math.min(ee+Y,d.length),ve=d.slice(ee,de),xe=Math.floor(B/Z*90);a.setPercentage(xe,`å¤„ç†æ‰¹æ¬¡ ${B+1}/${Z}`),l.info(`å¤„ç†æ‰¹æ¬¡ ${B+1}/${Z}ï¼ˆå›¾ç‰‡ ${ee+1}-${de}ï¼‰...`);for(const $e of ve)n.setTranslationStatus($e.imageIndex,"processing");const we=new Set;for(let $e=0;$e<ve.length;$e++){const ie=ve[$e];for(const C of y){if(we.has(ie.imageIndex))break;m.value&&await m.value.acquire();try{const J=xe+Math.floor($e/ve.length*30);a.setPercentage(J,`å›¾ç‰‡ ${ee+$e+1}: ${qt[C]}`),await ae(C,ie)}catch(J){const fe=J instanceof Error?J.message:"æœªçŸ¥é”™è¯¯";x.push(`å›¾ç‰‡ ${ie.imageIndex+1}: ${C} - ${fe}`),n.setTranslationStatus(ie.imageIndex,"failed",fe),we.add(ie.imageIndex)}}}if(r>=0){const $e=xe+40;a.setPercentage($e,`æ‰¹æ¬¡ ${B+1}: ${qt.aiTranslate}`);try{const ie=ve.filter(C=>!we.has(C.imageIndex));ie.length>0&&await $(ie)}catch(ie){const C=ie instanceof Error?ie.message:"æœªçŸ¥é”™è¯¯";x.push(`æ‰¹æ¬¡ ${B+1} AIç¿»è¯‘å¤±è´¥: ${C}`);for(const J of ve)we.has(J.imageIndex)||(n.setTranslationStatus(J.imageIndex,"failed",C),we.add(J.imageIndex))}}for(let $e=0;$e<ve.length;$e++){const ie=ve[$e];if(!we.has(ie.imageIndex)){for(const C of le){if(we.has(ie.imageIndex))break;m.value&&await m.value.acquire();try{const J=xe+50+Math.floor($e/ve.length*40);a.setPercentage(J,`å›¾ç‰‡ ${ee+$e+1}: ${qt[C]}`),await ae(C,ie)}catch(J){const fe=J instanceof Error?J.message:"æœªçŸ¥é”™è¯¯";x.push(`å›¾ç‰‡ ${ie.imageIndex+1}: ${C} - ${fe}`),n.setTranslationStatus(ie.imageIndex,"failed",fe),we.add(ie.imageIndex)}}we.has(ie.imageIndex)||(q(ie),h++,console.log(`âœ… å›¾ç‰‡ ${ee+$e+1} å¤„ç†å®Œæˆ`))}}D+=we.size,console.log(`âœ… æ‰¹æ¬¡ ${B+1}/${Z} å¤„ç†å®Œæˆ`)}return{completed:h,failed:D}}async function i(d){if(!I(d))return{success:!1,completed:0,failed:0,errors:["é…ç½®éªŒè¯å¤±è´¥"]};if(n.images.length===0)return l.error("è¯·å…ˆä¸Šä¼ å›¾ç‰‡"),{success:!1,completed:0,failed:0,errors:["æ²¡æœ‰å›¾ç‰‡"]};_=d.mode;const f=Q(d.mode);c.value=!0,(d.scope==="all"||d.scope==="failed")&&n.setBatchTranslationInProgress(!0),R(),E();const x=V(d),h=[],D=Pt();let Y=[...mn[d.mode]];if(d.mode==="removeText"&&s.settings.removeTextWithOcr){const r=Y.indexOf("detection");r!==-1&&Y.splice(r+1,0,"ocr")}D&&Y.push("save"),console.log("ğŸš€ é¡ºåºç®¡çº¿å¯åŠ¨"),console.log(`   æ¨¡å¼: ${d.mode}`),console.log(`   å¤„ç†æ–¹å¼: ${f?"é€å¼ å¤„ç†":"æ‰¹æ¬¡å¤„ç†"}`),console.log(`   æ­¥éª¤é“¾: [${Y.join(" â†’ ")}]`),console.log(`   è‡ªåŠ¨ä¿å­˜: ${D?"å¯ç”¨":"ç¦ç”¨"}`);const Z=x.map(({image:r,index:y})=>{const le={imageIndex:y,image:r,bubbleCoords:[],bubbleAngles:[],bubblePolygons:[],autoDirections:[],textlinesPerBubble:[],originalTexts:[],colors:[],translatedTexts:[],textboxTexts:[]};return d.mode==="proofread"&&r.bubbleStates&&r.bubbleStates.length>0&&(le.bubbleCoords=r.bubbleStates.map(B=>B.coords),le.bubbleAngles=r.bubbleStates.map(B=>B.rotationAngle||0),le.autoDirections=r.bubbleStates.map(B=>B.autoTextDirection||B.textDirection||"vertical"),le.originalTexts=r.bubbleStates.map(B=>B.originalText||""),le.translatedTexts=r.bubbleStates.map(B=>B.translatedText||""),le.textboxTexts=r.bubbleStates.map(B=>B.textboxText||""),le.colors=r.bubbleStates.map(B=>({textColor:B.textColor||"",bgColor:B.fillColor||"",autoFgColor:B.autoFgColor||null,autoBgColor:B.autoBgColor||null})),r.cleanImageData&&(le.cleanImage=r.cleanImageData)),le});try{a.init(x.length,`${d.mode} æ¨¡å¼å¯åŠ¨...`),D&&(a.setPercentage(0,"é¢„ä¿å­˜åŸå§‹å›¾ç‰‡..."),await An({onStart:B=>{a.setPercentage(0,`é¢„ä¿å­˜åŸå§‹å›¾ç‰‡ 0/${B}...`)},onProgress:(B,ee)=>{const de=Math.round(B/ee*10);a.setPercentage(de,`é¢„ä¿å­˜åŸå§‹å›¾ç‰‡ ${B}/${ee}...`)},onComplete:()=>{a.setPercentage(10,"é¢„ä¿å­˜å®Œæˆï¼Œå¼€å§‹ç¿»è¯‘...")},onError:B=>{a.setPercentage(0,`é¢„ä¿å­˜å¤±è´¥: ${B}`)}})||l.warning("é¢„ä¿å­˜å¤±è´¥ï¼Œç¿»è¯‘å®Œæˆåè¯·æ‰‹åŠ¨ä¿å­˜"));let r;f?r=await se(Z,Y,d,h):r=await S(Z,Y,d,h),a.setPercentage(100,"å®Œæˆï¼");const y={standard:"ç¿»è¯‘",hq:"é«˜è´¨é‡ç¿»è¯‘",proofread:"AIæ ¡å¯¹",removeText:"æ¶ˆé™¤æ–‡å­—"};return l.success(`${y[d.mode]}å®Œæˆï¼`),{success:r.failed===0,completed:r.completed,failed:r.failed,errors:h.length>0?h:void 0}}catch(r){const y=r instanceof Error?r.message:"æ‰§è¡Œå¤±è´¥";return l.error(y),h.push(y),{success:!1,completed:0,failed:x.length,errors:h}}finally{c.value=!1,n.setBatchTranslationInProgress(!1),D&&await Fn();const r=n.currentImageIndex,y=n.images[r];y?.bubbleStates&&y.bubbleStates.length>0&&t.setBubbles(y.bubbleStates),setTimeout(()=>a.finish(),1e3)}}function P(){n.isBatchTranslationInProgress&&(n.setBatchTranslationInProgress(!1),Un(),l.info("æ“ä½œå·²å–æ¶ˆ"))}return{progress:u,isExecuting:c,isTranslating:T,progressPercent:M,execute:i,cancel:P,STEP_CHAIN_CONFIGS:mn}}class yi{currentCount=0;maxCount;waitQueue=[];holders=[];constructor(t=1){this.maxCount=Math.max(1,t)}setSize(t){this.maxCount=Math.max(1,t),this.tryWakeUp()}getSize(){return this.maxCount}async acquire(t){if(this.currentCount<this.maxCount){this.currentCount++,this.holders.push(t);return}return new Promise(s=>{this.waitQueue.push({resolve:s,poolName:t})})}release(t){const s=this.holders.indexOf(t);s>=0&&(this.holders.splice(s,1),this.currentCount--),this.tryWakeUp()}tryWakeUp(){for(;this.currentCount<this.maxCount&&this.waitQueue.length>0;){const t=this.waitQueue.shift();this.currentCount++,this.holders.push(t.poolName),t.resolve()}}async withLock(t,s){await this.acquire(t);try{return await s()}finally{this.release(t)}}getStatus(){return{isLocked:this.currentCount>=this.maxCount,currentCount:this.currentCount,maxCount:this.maxCount,holders:[...this.holders],waitingCount:this.waitQueue.length,waitingPools:this.waitQueue.map(t=>t.poolName)}}isWaiting(t){return this.waitQueue.some(s=>s.poolName===t)}isHolding(t){return this.holders.includes(t)}reset(){this.currentCount=0,this.holders=[];for(const t of this.waitQueue)t.resolve();this.waitQueue=[]}}class Rt{queue=[];currentTask=null;isRunning=!1;isCancelled=!1;completedCount=0;nextPool;name;icon;lock;progressTracker;onTaskComplete;constructor(t,s,o,l,u,a){this.name=t,this.icon=s,this.nextPool=o,this.lock=l,this.progressTracker=u,this.onTaskComplete=a}getName(){return this.name}getIcon(){return this.icon}setNextPool(t){this.nextPool=t}enqueue(t){this.isCancelled||(this.queue.push(t),this.progressTracker.updatePool(this.name,{waiting:this.queue.length}),this.tryProcessNext())}enqueueBatch(t){if(!this.isCancelled){for(const s of t)this.queue.push(s);this.progressTracker.updatePool(this.name,{waiting:this.queue.length}),this.tryProcessNext()}}async tryProcessNext(){if(!(this.isRunning||this.isCancelled||this.queue.length===0)){this.isRunning=!0,this.currentTask=this.queue.shift(),this.progressTracker.updatePool(this.name,{waiting:this.queue.length,isProcessing:!0,currentPage:this.currentTask.imageIndex+1,isWaitingLock:!1});try{let t;this.lock?(this.progressTracker.updatePool(this.name,{isWaitingLock:!0}),t=await this.lock.withLock(this.name,async()=>(this.progressTracker.updatePool(this.name,{isWaitingLock:!1}),await this.process(this.currentTask)))):t=await this.process(this.currentTask),this.completedCount++,this.progressTracker.updatePool(this.name,{completed:this.completedCount}),this.nextPool&&t.status!=="failed"&&t.status!=="buffered"&&this.nextPool.enqueue(t),this.onTaskComplete?.(t)}catch(t){this.currentTask.status="failed",this.currentTask.error=t.message,console.error(`[${this.name}] å¤„ç†ä»»åŠ¡å¤±è´¥:`,t),this.onTaskComplete?.(this.currentTask)}finally{this.currentTask=null,this.isRunning=!1,this.progressTracker.updatePool(this.name,{isProcessing:!1,currentPage:void 0}),this.tryProcessNext()}}}getStatus(){return{name:this.name,icon:this.icon,waiting:this.queue.length,processing:this.isRunning,currentPage:this.currentTask?.imageIndex,completed:this.completedCount,isWaitingLock:this.lock?.isWaiting(this.name)??!1}}cancel(){this.isCancelled=!0,this.queue=[]}reset(){this.isCancelled=!1,this.queue=[],this.currentTask=null,this.isRunning=!1,this.completedCount=0}getCompletedCount(){return this.completedCount}getWaitingCount(){return this.queue.length}isProcessing(){return this.isRunning}}const _i=[{name:"æ£€æµ‹",icon:"ğŸ“"},{name:"OCR",icon:"ğŸ“–"},{name:"é¢œè‰²",icon:"ğŸ¨"},{name:"ç¿»è¯‘",icon:"ğŸŒ"},{name:"ä¿®å¤",icon:"ğŸ–Œï¸"},{name:"æ¸²æŸ“",icon:"âœ¨"}];class Ci{poolStatuses=new Map;totalPages=0;startTime=0;progress=yo({pools:[],totalCompleted:0,totalFailed:0,totalPages:0,estimatedTimeRemaining:0});constructor(){this.initPools()}initPools(){for(const t of _i){const s={name:t.name,icon:t.icon,waiting:0,processing:!1,completed:0,isWaitingLock:!1};this.poolStatuses.set(t.name,s)}this.syncToReactive()}init(t){this.totalPages=t,this.startTime=Date.now();for(const s of this.poolStatuses.values())s.waiting=0,s.processing=!1,s.currentPage=void 0,s.completed=0,s.isWaitingLock=!1;this.progress.totalCompleted=0,this.progress.totalFailed=0,this.progress.totalPages=t,this.progress.estimatedTimeRemaining=0,this.syncToReactive()}updatePool(t,s){const o=this.poolStatuses.get(t);o&&(s.waiting!==void 0&&(o.waiting=s.waiting),s.isProcessing!==void 0&&(o.processing=s.isProcessing),s.currentPage!==void 0&&(o.currentPage=s.currentPage),s.completed!==void 0&&(o.completed=s.completed),s.isWaitingLock!==void 0&&(o.isWaitingLock=s.isWaitingLock),this.syncToReactive(),this.updateEstimatedTime())}incrementCompleted(){this.progress.totalCompleted++,this.updateEstimatedTime()}incrementFailed(){this.progress.totalFailed++}updateEstimatedTime(){if(this.progress.totalCompleted===0){this.progress.estimatedTimeRemaining=0;return}const s=(Date.now()-this.startTime)/1e3/this.progress.totalCompleted,o=this.totalPages-this.progress.totalCompleted-this.progress.totalFailed;this.progress.estimatedTimeRemaining=Math.ceil(s*o)}syncToReactive(){this.progress.pools=Array.from(this.poolStatuses.values()).map(t=>({...t}))}getPoolStatus(t){return this.poolStatuses.get(t)}getAllPoolStatuses(){return Array.from(this.poolStatuses.values())}getProgress(){return{...this.progress}}reset(){this.totalPages=0,this.startTime=0,this.initPools()}formatRemainingTime(){const t=this.progress.estimatedTimeRemaining;if(t<=0)return"--";const s=Math.floor(t/60),o=t%60;return s>0?`${s}åˆ†${o}ç§’`:`${o}ç§’`}}class Si{results=new Map;totalExpected=0;completedCount=0;failedCount=0;resolveWaitAll=null;init(t){this.results.clear(),this.totalExpected=t,this.completedCount=0,this.failedCount=0,this.resolveWaitAll=null}add(t){this.results.set(t.imageIndex,t),t.status==="completed"?this.completedCount++:t.status==="failed"&&this.failedCount++,this.completedCount+this.failedCount>=this.totalExpected&&this.resolveWaitAll&&(this.resolveWaitAll({success:this.completedCount,failed:this.failedCount}),this.resolveWaitAll=null)}waitForAll(t){return this.totalExpected=t,this.completedCount+this.failedCount>=t?Promise.resolve({success:this.completedCount,failed:this.failedCount}):new Promise(s=>{this.resolveWaitAll=s})}get(t){return this.results.get(t)}getAll(){return Array.from(this.results.values()).sort((t,s)=>t.imageIndex-s.imageIndex)}getSuccessful(){return this.getAll().filter(t=>t.status==="completed")}getFailed(){return this.getAll().filter(t=>t.status==="failed")}getStats(){return{total:this.totalExpected,completed:this.completedCount,failed:this.failedCount,pending:this.totalExpected-this.completedCount-this.failedCount}}reset(){this.results.clear(),this.totalExpected=0,this.completedCount=0,this.failedCount=0,this.resolveWaitAll=null}}class ki extends Rt{constructor(t,s,o,l){super("æ£€æµ‹","ğŸ“",t,s,o,l)}async process(t){const{imageData:s}=t,l=ze().settings,u=s.bubbleStates;if(u!=null)return u.length>0?(console.log(`[æ£€æµ‹æ± ] å›¾ç‰‡ ${t.imageIndex+1} å·²æœ‰ ${u.length} ä¸ªæ°”æ³¡ï¼Œè·³è¿‡æ£€æµ‹`),t.detectionResult={bubbleCoords:u.map(m=>m.coords.map(p=>Math.round(p))),bubbleAngles:u.map(m=>m.rotationAngle||0),bubblePolygons:u.map(m=>m.polygon||[]),autoDirections:u.map(m=>m.autoTextDirection||m.textDirection||"vertical"),rawMask:void 0,textlinesPerBubble:[]}):(console.log(`[æ£€æµ‹æ± ] å›¾ç‰‡ ${t.imageIndex+1} æ°”æ³¡å·²è¢«æ¸…ç©ºï¼Œè·³è¿‡æ£€æµ‹`),t.detectionResult={bubbleCoords:[],bubbleAngles:[],bubblePolygons:[],autoDirections:[],rawMask:void 0,textlinesPerBubble:[]}),t.status="processing",t;const a=this.extractBase64(s.originalDataURL),c=await wo({image:a,detector_type:l.textDetector,box_expand_ratio:l.boxExpand.ratio,box_expand_top:l.boxExpand.top,box_expand_bottom:l.boxExpand.bottom,box_expand_left:l.boxExpand.left,box_expand_right:l.boxExpand.right});if(!c.success)throw new Error(c.error||"æ£€æµ‹å¤±è´¥");return t.detectionResult={bubbleCoords:c.bubble_coords||[],bubbleAngles:c.bubble_angles||[],bubblePolygons:c.bubble_polygons||[],autoDirections:c.auto_directions||[],rawMask:c.raw_mask,textlinesPerBubble:c.textlines_per_bubble||[]},t.status="processing",t}extractBase64(t){return t.includes("base64,")?t.split("base64,")[1]||"":t}}class wi extends Rt{constructor(t,s,o,l){super("OCR","ğŸ“–",t,s,o,l)}async process(t){const{imageData:s,detectionResult:o}=t,u=ze().settings;if(!o||o.bubbleCoords.length===0)return t.ocrResult={originalTexts:[],textlinesPerBubble:[]},t.status="processing",t;const a=this.extractBase64(s.originalDataURL),c=u.ocrEngine==="paddleocr_vl"?u.paddleOcrVl?.sourceLanguage||"japanese":u.sourceLanguage,m=await $o({image:a,bubble_coords:o.bubbleCoords,source_language:c,ocr_engine:u.ocrEngine,baidu_api_key:u.baiduOcr?.apiKey,baidu_secret_key:u.baiduOcr?.secretKey,baidu_version:u.baiduOcr?.version,baidu_ocr_language:u.baiduOcr?.sourceLanguage,ai_vision_provider:u.aiVisionOcr?.provider,ai_vision_api_key:u.aiVisionOcr?.apiKey,ai_vision_model_name:u.aiVisionOcr?.modelName,ai_vision_ocr_prompt:u.aiVisionOcr?.prompt,custom_ai_vision_base_url:u.aiVisionOcr?.customBaseUrl,ai_vision_min_image_size:u.aiVisionOcr?.minImageSize??vs,textlines_per_bubble:o.textlinesPerBubble});if(!m.success)throw new Error(m.error||"OCRå¤±è´¥");return t.ocrResult={originalTexts:m.original_texts||[],textlinesPerBubble:m.textlines_per_bubble||[]},t.status="processing",t}extractBase64(t){return t.includes("base64,")?t.split("base64,")[1]||"":t}}class $i extends Rt{constructor(t,s,o,l){super("é¢œè‰²","ğŸ¨",t,s,o,l)}async process(t){const{imageData:s,detectionResult:o,ocrResult:l}=t;if(!o||o.bubbleCoords.length===0)return t.colorResult={colors:[]},t.status="processing",t;const u=this.extractBase64(s.originalDataURL),a=await To({image:u,bubble_coords:o.bubbleCoords,textlines_per_bubble:l?.textlinesPerBubble||o.textlinesPerBubble});if(!a.success)throw new Error(a.error||"é¢œè‰²æå–å¤±è´¥");return t.colorResult={colors:a.colors||[]},t.status="processing",t}extractBase64(t){return t.includes("base64,")?t.split("base64,")[1]||"":t}}class Ti extends Rt{mode="standard";batchBuffer=[];totalTasks=0;processedCount=0;constructor(t,s,o){super("ç¿»è¯‘","ğŸŒ",t,null,s,o)}setMode(t,s,o){this.mode=t,this.totalTasks=s,this.batchBuffer=[],this.processedCount=0,this.nextPool=o}async process(t){switch(this.mode){case"standard":return this.handleStandardTranslate(t);case"hq":return this.handleHqTranslate(t);case"proofread":return this.handleProofread(t);case"removeText":return this.handleRemoveTextOnly(t);default:return t}}async handleStandardTranslate(t){const o=ze().settings;if(!t.ocrResult||t.ocrResult.originalTexts.length===0)return t.translateResult={translatedTexts:[],textboxTexts:[]},t.status="processing",t;const l=o.translation.translationMode||"batch",u=t.ocrResult.originalTexts;if(l==="single"){console.log(`[å¹¶è¡Œç¿»è¯‘æ± ] ä½¿ç”¨é€æ°”æ³¡ç¿»è¯‘æ¨¡å¼ï¼Œå›¾ç‰‡ ${t.imageIndex}ï¼Œå…± ${u.length} ä¸ªæ°”æ³¡`);const a=[],c=[];for(let m=0;m<u.length;m++){const p=u[m];if(!p||p.trim()===""){a.push(""),o.useTextboxPrompt&&c.push("");continue}try{const _=await Lt({original_text:p,model_provider:o.translation.provider,model_name:o.translation.modelName,api_key:o.translation.apiKey,custom_base_url:o.translation.customBaseUrl,target_language:o.targetLanguage,prompt_content:o.translatePrompt,use_json_format:o.translation.isJsonMode,rpm_limit_translation:o.translation.rpmLimit,max_retries:o.translation.maxRetries});if(_.success&&_.data?a.push(_.data.translated_text||""):(console.warn(`[å¹¶è¡Œç¿»è¯‘æ± ] æ°”æ³¡ ${m+1} ç¿»è¯‘å¤±è´¥: ${_.error}`),a.push("ã€ç¿»è¯‘å¤±è´¥ã€‘è¯·æ£€æŸ¥ç»ˆç«¯ä¸­çš„é”™è¯¯æ—¥å¿—")),o.useTextboxPrompt&&o.textboxPrompt){const T=await Lt({original_text:p,model_provider:o.translation.provider,model_name:o.translation.modelName,api_key:o.translation.apiKey,custom_base_url:o.translation.customBaseUrl,target_language:o.targetLanguage,prompt_content:o.textboxPrompt,rpm_limit_translation:o.translation.rpmLimit,max_retries:o.translation.maxRetries});T.success&&T.data?c.push(T.data.translated_text||""):c.push("")}}catch(_){console.error(`[å¹¶è¡Œç¿»è¯‘æ± ] æ°”æ³¡ ${m+1} ç¿»è¯‘å‡ºé”™:`,_),a.push("ã€ç¿»è¯‘å¤±è´¥ã€‘è¯·æ£€æŸ¥ç»ˆç«¯ä¸­çš„é”™è¯¯æ—¥å¿—"),o.useTextboxPrompt&&c.push("")}}t.translateResult={translatedTexts:a,textboxTexts:c}}else{console.log(`[å¹¶è¡Œç¿»è¯‘æ± ] ä½¿ç”¨æ•´é¡µæ‰¹é‡ç¿»è¯‘æ¨¡å¼ï¼Œå›¾ç‰‡ ${t.imageIndex}ï¼Œå…± ${u.length} ä¸ªæ°”æ³¡`);const a=await Io({original_texts:u,target_language:o.targetLanguage,source_language:o.sourceLanguage,model_provider:o.translation.provider,model_name:o.translation.modelName,api_key:o.translation.apiKey,custom_base_url:o.translation.customBaseUrl,prompt_content:o.translatePrompt,textbox_prompt_content:o.textboxPrompt,use_textbox_prompt:o.useTextboxPrompt,rpm_limit:o.translation.rpmLimit,max_retries:o.translation.maxRetries,use_json_format:o.translation.isJsonMode});if(!a.success)throw new Error(a.error||"ç¿»è¯‘å¤±è´¥");t.translateResult={translatedTexts:a.translated_texts||[],textboxTexts:a.textbox_texts||[]}}return t.status="processing",t}async handleHqTranslate(t){this.batchBuffer.push(t),this.processedCount++;const s=ze(),{hqTranslation:o}=s.settings,l=o.batchSize||3,u=this.processedCount>=this.totalTasks;if(!(this.batchBuffer.length>=l||u))return t.status="buffered",t;const c=[...this.batchBuffer];this.batchBuffer=[];const m=c.map(M=>({imageIndex:M.imageIndex,bubbles:(M.ocrResult?.originalTexts||[]).map((R,I)=>({bubbleIndex:I,original:R,translated:"",textDirection:M.detectionResult?.autoDirections[I]||"vertical"}))})),p=c.map(M=>this.extractBase64(M.imageData.originalDataURL)),_=await Ft({provider:o.provider,api_key:o.apiKey,model_name:o.modelName,custom_base_url:o.customBaseUrl,jsonData:m,imageBase64Array:p,prompt:o.prompt,systemPrompt:"ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ¼«ç”»ç¿»è¯‘åŠ©æ‰‹ï¼Œèƒ½å¤Ÿæ ¹æ®æ¼«ç”»å›¾åƒå†…å®¹å’Œä¸Šä¸‹æ–‡æä¾›é«˜è´¨é‡çš„ç¿»è¯‘ã€‚",isProofreading:!1,enableDebugLogs:s.settings.enableVerboseLogs,low_reasoning:o.lowReasoning,force_json_output:o.forceJsonOutput,no_thinking_method:o.noThinkingMethod,use_stream:o.useStream,max_retries:o.maxRetries||2}),T=this.parseHqResponse(_,o.forceJsonOutput);for(const M of c){const R=T?.find(I=>I.imageIndex===M.imageIndex);R?M.translateResult={translatedTexts:R.bubbles.map(I=>I.translated),textboxTexts:[]}:M.translateResult={translatedTexts:[],textboxTexts:[]},M.status="processing",this.nextPool&&this.nextPool.enqueue(M)}return t}async handleProofread(t){this.batchBuffer.push(t),this.processedCount++;const s=ze(),{proofreading:o,useTextboxPrompt:l}=s.settings,u=o.rounds[0]?.batchSize||3,a=this.processedCount>=this.totalTasks;if(!(this.batchBuffer.length>=u||a))return t.status="buffered",t;const m=[...this.batchBuffer];this.batchBuffer=[];const p=m.map(M=>({imageIndex:M.imageIndex,bubbles:(M.imageData.bubbleStates||[]).map((R,I)=>({bubbleIndex:I,original:R.originalText||"",translated:l?R.textboxText||R.translatedText||"":R.translatedText||"",textDirection:R.textDirection==="vertical"||R.textDirection==="horizontal"?R.textDirection:R.autoTextDirection==="vertical"||R.autoTextDirection==="horizontal"?R.autoTextDirection:"vertical"}))})),_=m.map(M=>{const R=M.imageData.translatedDataURL||M.imageData.originalDataURL;return this.extractBase64(R)});let T=p;for(const M of o.rounds){const R=await Ft({provider:M.provider,api_key:M.apiKey,model_name:M.modelName,custom_base_url:M.customBaseUrl,jsonData:T,imageBase64Array:_,prompt:M.prompt,systemPrompt:"ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ¼«ç”»ç¿»è¯‘æ ¡å¯¹åŠ©æ‰‹ï¼Œèƒ½å¤Ÿæ ¹æ®æ¼«ç”»å›¾åƒå†…å®¹æ£€æŸ¥å’Œä¿®æ­£ç¿»è¯‘ã€‚",isProofreading:!0,enableDebugLogs:s.settings.enableVerboseLogs,low_reasoning:M.lowReasoning,force_json_output:M.forceJsonOutput,no_thinking_method:M.noThinkingMethod,use_stream:!1,max_retries:M.maxRetries||o.maxRetries||2}),I=this.parseHqResponse(R,M.forceJsonOutput);I&&(T=I)}for(const M of m){const R=T.find(I=>I.imageIndex===M.imageIndex);R?M.translateResult={translatedTexts:R.bubbles.map(I=>I.translated),textboxTexts:[]}:M.translateResult={translatedTexts:[],textboxTexts:[]},M.status="processing",this.nextPool&&this.nextPool.enqueue(M)}return t}async handleRemoveTextOnly(t){return t.translateResult={translatedTexts:[],textboxTexts:[]},t.status="processing",t}extractBase64(t){return t.includes("base64,")?t.split("base64,")[1]||"":t}parseHqResponse(t,s){if(!t.success)return console.error("APIè°ƒç”¨å¤±è´¥:",t.error),null;if(t.results&&t.results.length>0){const l=t.results[0];if(l&&"imageIndex"in l&&"bubbles"in l)return t.results}const o=t.content;if(o){let l=null;if(s)try{l=JSON.parse(o)}catch(u){return console.error("è§£æAIå¼ºåˆ¶JSONè¿”å›çš„å†…å®¹å¤±è´¥:",u),null}else{const u=o.match(/```json\s*([\s\S]*?)\s*```/);if(u?.[1])try{l=JSON.parse(u[1])}catch(a){return console.error("è§£æAIè¿”å›çš„JSONå¤±è´¥:",a),null}}if(l){if(Array.isArray(l))return l;if(typeof l=="object"&&"imageIndex"in l&&"bubbles"in l)return console.log("[TranslatePool.parseHqResponse] æ£€æµ‹åˆ°å•å¼ å›¾ç‰‡æ ¼å¼ï¼Œè‡ªåŠ¨åŒ…è£…ä¸ºæ•°ç»„"),[l]}}return null}}class Ii extends Rt{constructor(t,s,o,l){super("ä¿®å¤","ğŸ–Œï¸",t,s,o,l)}async process(t){const{imageData:s,detectionResult:o}=t,u=ze().settings;if(!o||o.bubbleCoords.length===0)return t.inpaintResult={cleanImage:this.extractBase64(s.originalDataURL)},t.status="processing",t;const a=this.extractBase64(s.originalDataURL),c=u.textStyle.inpaintMethod,m=c==="lama_mpe"||c==="litelama",p=await Po({image:a,bubble_coords:o.bubbleCoords,bubble_polygons:o.bubblePolygons,raw_mask:o.rawMask,method:m?"lama":"solid",lama_model:m?c:void 0,fill_color:u.textStyle.fillColor,mask_dilate_size:u.preciseMask.dilateSize,mask_box_expand_ratio:u.preciseMask.boxExpandRatio});if(!p.success)throw new Error(p.error||"ä¿®å¤å¤±è´¥");return t.inpaintResult={cleanImage:p.clean_image||""},t.status="processing",t}extractBase64(t){return t.includes("base64,")?t.split("base64,")[1]||"":t}}const ft=yo({pools:[{name:"æ£€æµ‹",icon:"ğŸ“",waiting:0,processing:!1,completed:0,isWaitingLock:!1},{name:"OCR",icon:"ğŸ“–",waiting:0,processing:!1,completed:0,isWaitingLock:!1},{name:"é¢œè‰²",icon:"ğŸ¨",waiting:0,processing:!1,completed:0,isWaitingLock:!1},{name:"ç¿»è¯‘",icon:"ğŸŒ",waiting:0,processing:!1,completed:0,isWaitingLock:!1},{name:"ä¿®å¤",icon:"ğŸ–Œï¸",waiting:0,processing:!1,completed:0,isWaitingLock:!1},{name:"æ¸²æŸ“",icon:"âœ¨",waiting:0,processing:!1,completed:0,isWaitingLock:!1}],totalCompleted:0,totalFailed:0,totalPages:0,estimatedTimeRemaining:0,preSave:void 0,save:void 0}),Pi=w(!1);function Mo(){const n=et(),t=ze(),s=ws(null),o=X(()=>t.settings.parallel),l=X(()=>o.value?.enabled??!1),u=Pi,a=X(()=>ft);function c(){const M=t.settings;return M.proofreading?.enabled&&M.proofreading.rounds.length>0?"proofread":["gemini","openai","claude","deepseek"].includes(M.hqTranslation?.provider||"")&&M.hqTranslation?.apiKey?"hq":"standard"}function m(){if(!s.value)return;const M=s.value.progress;M&&(ft.pools=M.pools.map(R=>({...R})),ft.totalCompleted=M.totalCompleted,ft.totalFailed=M.totalFailed,ft.totalPages=M.totalPages,ft.estimatedTimeRemaining=M.estimatedTimeRemaining)}async function p(M,R,I=0){if(u.value)return{success:0,failed:0,errors:["ç¿»è¯‘æ­£åœ¨è¿›è¡Œä¸­"]};const E=R??n.images;if(E.length===0)return{success:0,failed:0,errors:["æ²¡æœ‰å›¾ç‰‡"]};u.value=!0,ft.totalPages=E.length,ft.totalCompleted=0,ft.totalFailed=0;const H=setInterval(m,200);try{s.value=Mi({enabled:!0,deepLearningLockSize:o.value?.deepLearningLockSize??1});const V=M??c();console.log(`ğŸš€ å¼€å§‹å¹¶è¡Œç¿»è¯‘ï¼Œæ¨¡å¼: ${V}ï¼Œå›¾ç‰‡æ•°: ${E.length}ï¼Œèµ·å§‹ç´¢å¼•: ${I}`);const F=await s.value.execute(E,V,I);return m(),console.log(`âœ… å¹¶è¡Œç¿»è¯‘å®Œæˆï¼ŒæˆåŠŸ: ${F.success}ï¼Œå¤±è´¥: ${F.failed}`),F}catch(V){return console.error("å¹¶è¡Œç¿»è¯‘å‡ºé”™:",V),{success:0,failed:E.length,errors:[V.message]}}finally{clearInterval(H),u.value=!1}}function _(){s.value&&s.value.cancel(),u.value=!1}function T(){s.value=null,u.value=!1}return{isEnabled:l,isRunning:u,progress:a,executeParallel:p,cancel:_,reset:T,determineMode:c}}class Ri extends Rt{resultCollector;constructor(t,s,o){super("æ¸²æŸ“","âœ¨",null,null,t,o),this.resultCollector=s}async process(t){const s=et(),o=gt(),l=ze(),u=this.buildBubbleStates(t,l);if(u.length===0){const m=t.inpaintResult?.cleanImage||t.imageData.cleanImageData||this.extractBase64(t.imageData.originalDataURL);return t.renderResult={finalImage:m,bubbleStates:[]},t.status="completed",this.updateImageToUI(t,s,o,l),this.resultCollector.add(t),t}const a=t.inpaintResult?.cleanImage||t.imageData.cleanImageData||this.extractBase64(t.imageData.translatedDataURL||t.imageData.originalDataURL),c=await Ro({clean_image:a,bubble_states:u,fontSize:l.settings.textStyle.fontSize,fontFamily:l.settings.textStyle.fontFamily,textDirection:l.settings.textStyle.layoutDirection,textColor:l.settings.textStyle.textColor,strokeEnabled:l.settings.textStyle.strokeEnabled,strokeColor:l.settings.textStyle.strokeColor,strokeWidth:l.settings.textStyle.strokeWidth,autoFontSize:l.settings.textStyle.autoFontSize,use_individual_styles:!0});if(!c.success)throw new Error(c.error||"æ¸²æŸ“å¤±è´¥");return t.renderResult={finalImage:c.final_image||"",bubbleStates:c.bubble_states||u},t.status="completed",this.updateImageToUI(t,s,o,l),this.resultCollector.add(t),t}updateImageToUI(t,s,o,l){const u=t.imageIndex,a=(t.detectionResult?.bubbleCoords||[]).map(c=>c.length>=4?[c[0],c[1],c[2],c[3]]:[0,0,0,0]);s.updateImageByIndex(u,{translatedDataURL:`data:image/png;base64,${t.renderResult.finalImage}`,cleanImageData:t.inpaintResult?.cleanImage||null,bubbleStates:t.renderResult.bubbleStates,bubbleCoords:a,bubbleAngles:t.detectionResult?.bubbleAngles||[],originalTexts:t.ocrResult?.originalTexts||[],bubbleTexts:t.translateResult?.translatedTexts||[],textboxTexts:t.translateResult?.textboxTexts||[],translationStatus:"completed",translationFailed:!1,showOriginal:!1,hasUnsavedChanges:!0,fontSize:l.settings.textStyle.fontSize,autoFontSize:l.settings.textStyle.autoFontSize,fontFamily:l.settings.textStyle.fontFamily,layoutDirection:l.settings.textStyle.layoutDirection,textColor:l.settings.textStyle.textColor,fillColor:l.settings.textStyle.fillColor,strokeEnabled:l.settings.textStyle.strokeEnabled,strokeColor:l.settings.textStyle.strokeColor,strokeWidth:l.settings.textStyle.strokeWidth,inpaintMethod:l.settings.textStyle.inpaintMethod,useAutoTextColor:l.settings.textStyle.useAutoTextColor}),u===s.currentImageIndex&&t.renderResult?.bubbleStates&&o.setBubbles(t.renderResult.bubbleStates),this.progressTracker.incrementCompleted(),Pt()&&Ln(u).catch(c=>{console.error(`[RenderPool] è‡ªåŠ¨ä¿å­˜å›¾ç‰‡ ${u+1} å¤±è´¥:`,c)}).finally(()=>{const{progress:c}=Mo(),m=c.value;m.save&&(m.save.completed=(m.save.completed||0)+1)}),console.log(`âœ… å›¾ç‰‡ ${u+1} æ¸²æŸ“å®Œæˆ`)}buildBubbleStates(t,s){if(!t.detectionResult&&t.imageData.bubbleStates&&t.imageData.bubbleStates.length>0){const T=t.translateResult?.translatedTexts||[];return t.imageData.bubbleStates.map((M,R)=>({...M,translatedText:T[R]||M.translatedText||""}))}if(t.detectionResult&&!t.translateResult&&!t.ocrResult)return console.log(`[æ¸²æŸ“æ± ] å›¾ç‰‡ ${t.imageIndex+1}: æ£€æµ‹åˆ°æ¶ˆé™¤æ–‡å­—æ¨¡å¼ï¼ˆæ— ç¿»è¯‘å’ŒOCRç»“æœï¼‰ï¼Œè·³è¿‡æ¸²æŸ“`),[];const o=t.detectionResult?.bubbleCoords||[],l=t.translateResult?.translatedTexts||[],u=t.ocrResult?.originalTexts||[],a=t.colorResult?.colors||[],c=t.detectionResult?.bubbleAngles||[],m=t.detectionResult?.autoDirections||[],p=t.detectionResult?.bubblePolygons||[],_=s.settings;return o.map((T,M)=>{const R=m[M],I=R==="v"?"vertical":R==="h"?"horizontal":"vertical",E=_.textStyle.layoutDirection,H=E==="vertical"||E==="horizontal"?E:I;let V=_.textStyle.textColor,F=_.textStyle.fillColor;const b=a[M];return _.textStyle.useAutoTextColor&&b&&(b.textColor&&(V=b.textColor),b.bgColor&&(F=b.bgColor)),{originalText:u[M]||"",translatedText:l[M]||"",textboxText:"",coords:T.length>=4?[T[0],T[1],T[2],T[3]]:[0,0,0,0],polygon:p[M]||[],fontSize:_.textStyle.fontSize,fontFamily:_.textStyle.fontFamily,textDirection:H,autoTextDirection:I,textColor:V,fillColor:F,rotationAngle:c[M]||0,position:{x:0,y:0},strokeEnabled:_.textStyle.strokeEnabled,strokeColor:_.textStyle.strokeColor,strokeWidth:_.textStyle.strokeWidth,inpaintMethod:_.textStyle.inpaintMethod,autoFgColor:b?.autoFgColor||null,autoBgColor:b?.autoBgColor||null}})}extractBase64(t){return t.includes("base64,")?t.split("base64,")[1]||"":t}}const vn={standard:["detection","ocr","color","translate","inpaint","render"],hq:["detection","ocr","color","translate","inpaint","render"],proofread:["translate","render"],removeText:["detection","inpaint","render"]};class Di{lock;progressTracker;resultCollector;detectionPool;ocrPool;colorPool;translatePool;inpaintPool;renderPool;isCancelled=!1;config;constructor(t){this.config=t,this.lock=new yi(t.deepLearningLockSize),this.progressTracker=new Ci,this.resultCollector=new Si,this.renderPool=new Ri(this.progressTracker,this.resultCollector),this.inpaintPool=new Ii(this.renderPool,this.lock,this.progressTracker),this.translatePool=new Ti(this.inpaintPool,this.progressTracker),this.colorPool=new $i(this.translatePool,this.lock,this.progressTracker),this.ocrPool=new wi(this.colorPool,this.lock,this.progressTracker),this.detectionPool=new ki(this.ocrPool,this.lock,this.progressTracker)}updateConfig(t){t.deepLearningLockSize!==void 0&&(this.lock.setSize(t.deepLearningLockSize),this.config.deepLearningLockSize=t.deepLearningLockSize),t.enabled!==void 0&&(this.config.enabled=t.enabled)}async execute(t,s,o=0){this.reset(),this.progressTracker.init(t.length),this.resultCollector.init(t.length),this.setupPoolChain(s,t.length);const l=t.map((c,m)=>({id:`task-${o+m}`,imageIndex:o+m,imageData:c,status:"pending"})),u=this.getEntryPool(s);for(const c of l)u.enqueue(c);const a=await this.resultCollector.waitForAll(t.length);return{success:a.success,failed:a.failed,errors:this.resultCollector.getFailed().map(c=>c.error||"æœªçŸ¥é”™è¯¯")}}setupPoolChain(t,s){let o=[...vn[t]];if(t==="removeText")try{if(ze().settings.removeTextWithOcr){const p=o.indexOf("detection");p!==-1&&!o.includes("ocr")&&o.splice(p+1,0,"ocr")}}catch{}const l=this.getPoolMap();for(let m=0;m<o.length-1;m++){const p=o[m],_=o[m+1],T=l[p],M=l[_];T&&M&&T.setNextPool(M)}const u=o[o.length-1],a=l[u];a&&a.setNextPool(null);const c=o.indexOf("translate");if(c>=0&&c<o.length-1){const m=o[c+1];this.translatePool.setMode(t,s,l[m]||null)}else c===o.length-1&&this.translatePool.setMode(t,s,null)}getPoolMap(){return{detection:this.detectionPool,ocr:this.ocrPool,color:this.colorPool,translate:this.translatePool,inpaint:this.inpaintPool,render:this.renderPool}}getEntryPool(t){const o=vn[t][0];return this.getPoolMap()[o]||this.detectionPool}cancel(){this.isCancelled=!0,this.detectionPool.cancel(),this.ocrPool.cancel(),this.colorPool.cancel(),this.translatePool.cancel(),this.inpaintPool.cancel(),this.renderPool.cancel(),this.lock.reset()}reset(){this.isCancelled=!1,this.detectionPool.reset(),this.ocrPool.reset(),this.colorPool.reset(),this.translatePool.reset(),this.inpaintPool.reset(),this.renderPool.reset(),this.resultCollector.reset(),this.progressTracker.reset()}get progress(){return this.progressTracker.progress}getProgressTracker(){return this.progressTracker}getLockStatus(){return this.lock.getStatus()}get cancelled(){return this.isCancelled}}function Mi(n){return new Di(n)}function Ei(){const n=et(),t=ze(),s=ct(),o=xi(),l=Mo(),u=X(()=>o.isTranslating.value||n.isBatchTranslationInProgress),a=X(()=>o.progressPercent.value);async function c(_){if(n.images.length===0)return s.error("è¯·å…ˆä¸Šä¼ å›¾ç‰‡"),{success:!1,completed:0,failed:0,errors:["æ²¡æœ‰å›¾ç‰‡"]};const T=t.settings.parallel,M=_.scope==="all"||_.scope==="range";return T?.enabled&&M?(console.log(`ğŸš€ ä½¿ç”¨å¹¶è¡Œç®¡çº¿ï¼Œæ¨¡å¼: ${_.mode}, èŒƒå›´: ${_.scope}`),m(_)):(console.log(`ğŸš€ ä½¿ç”¨é¡ºåºç®¡çº¿ï¼Œæ¨¡å¼: ${_.mode}`),o.execute(_))}async function m(_){let T=n.images,M=0;if(_.scope==="range"&&_.pageRange){M=Math.max(0,_.pageRange.startPage-1);const I=Math.min(n.images.length-1,_.pageRange.endPage-1);if(M<=I&&M<n.images.length)T=n.images.slice(M,I+1),console.log(`ğŸ¯ å¹¶è¡Œç¿»è¯‘èŒƒå›´: ç¬¬ ${_.pageRange.startPage} è‡³ ${_.pageRange.endPage} é¡µï¼Œå…± ${T.length} å¼ ï¼Œèµ·å§‹ç´¢å¼• ${M}`);else return s.error("æ— æ•ˆçš„é¡µé¢èŒƒå›´"),{success:!1,completed:0,failed:0,errors:["æ— æ•ˆçš„é¡µé¢èŒƒå›´"]}}const R=Pt();try{if(l.progress.value.totalPages=T.length,l.progress.value.totalCompleted=0,l.progress.value.totalFailed=0,R&&(console.log("[ParallelPipeline] æ‰§è¡Œé¢„ä¿å­˜..."),s.info("å¼€å§‹é¢„ä¿å­˜åŸå§‹å›¾ç‰‡..."),!await An({onStart:V=>{const F=l.progress.value;F.preSave={isRunning:!0,current:0,total:V}},onProgress:(V,F)=>{const b=l.progress.value;b.preSave&&(b.preSave.current=V,b.preSave.total=F)},onComplete:()=>{const V=l.progress.value;V.preSave&&(V.preSave.isRunning=!1),s.success("é¢„ä¿å­˜å®Œæˆï¼Œå¼€å§‹ç¿»è¯‘...")},onError:V=>{const F=l.progress.value;F.preSave=void 0,s.warning(`é¢„ä¿å­˜å¤±è´¥ï¼š${V}ï¼Œç¿»è¯‘å®Œæˆåè¯·æ‰‹åŠ¨ä¿å­˜`)}}))){const V=l.progress.value;V.preSave=void 0}const I=_.mode;if(console.log(`ğŸš€ å¯åŠ¨å¹¶è¡Œç¿»è¯‘æ¨¡å¼: ${I}`),console.log(`   å›¾ç‰‡æ•°é‡: ${T.length}`),console.log(`   èµ·å§‹ç´¢å¼•: ${M}`),console.log(`   è‡ªåŠ¨ä¿å­˜: ${R?"å¯ç”¨":"ç¦ç”¨"}`),R){const H=l.progress.value;H.save={completed:0,total:T.length}}const E=await l.executeParallel(I,T,M);return E.success>0&&E.failed===0?s.success(`å¹¶è¡Œç¿»è¯‘å®Œæˆï¼ŒæˆåŠŸå¤„ç† ${E.success} å¼ å›¾ç‰‡`):E.success>0&&E.failed>0?s.warning(`å¹¶è¡Œç¿»è¯‘å®Œæˆï¼ŒæˆåŠŸ ${E.success} å¼ ï¼Œå¤±è´¥ ${E.failed} å¼ `):s.error("å¹¶è¡Œç¿»è¯‘å¤±è´¥"),{success:E.failed===0,completed:E.success,failed:E.failed,errors:E.errors}}catch(I){const E=I instanceof Error?I.message:"å¹¶è¡Œç¿»è¯‘å‡ºé”™";return s.error(E),{success:!1,completed:0,failed:T.length,errors:[E]}}finally{const I=l.progress.value;I.preSave=void 0,I.save=void 0,R&&(console.log("[ParallelPipeline] å®Œæˆä¿å­˜..."),await Fn())}}function p(){o.cancel(),l.cancel(),Un()}return{progress:o.progress,isExecuting:o.isExecuting,isTranslating:u,progressPercent:a,execute:c,cancel:p,STEP_CHAIN_CONFIGS:o.STEP_CHAIN_CONFIGS}}function fn(n="current",t){return{mode:"standard",scope:n,pageRange:t?.pageRange}}function Bi(n="all",t){return{mode:"hq",scope:n,pageRange:t?.pageRange,batchOptions:{batchSize:t?.batchSize??3,maxRetries:t?.maxRetries??2,rpmLimit:t?.rpmLimit??10,sessionResetFrequency:t?.sessionResetFrequency??5}}}function Ai(n="all",t){return{mode:"proofread",scope:n,pageRange:t?.pageRange,batchOptions:{batchSize:t?.batchSize??3,maxRetries:t?.maxRetries??2,rpmLimit:t?.rpmLimit??10,sessionResetFrequency:t?.sessionResetFrequency??5}}}function Li(n="current",t){return{mode:"removeText",scope:n,pageRange:t?.pageRange}}function Fi(n){if(n.length===0)return{startPage:1,endPage:0};const t=[...n].sort((l,u)=>l-u),s=t[0],o=t[t.length-1];return{startPage:(s??0)+1,endPage:(o??0)+1}}function bt(n,t){const s=[];for(let o=n;o<t;o++)s.push(o);return s}function Eo(){const n=et(),t=gt(),s=ct(),o=Ei(),l=o.progress,u=o.isExecuting,a=o.isTranslating,c=o.progressPercent,m=X(()=>o.isExecuting.value),p=X(()=>o.isExecuting.value);async function _(z,ae){if(z.length===0)return s.error("æ²¡æœ‰æŒ‡å®šè¦ç¿»è¯‘çš„é¡µé¢"),{success:!1,completed:0,failed:0,errors:["æ²¡æœ‰æŒ‡å®šè¦ç¿»è¯‘çš„é¡µé¢"]};const j=n.images.length;if(j===0)return s.error("è¯·å…ˆä¸Šä¼ å›¾ç‰‡"),{success:!1,completed:0,failed:0,errors:["è¯·å…ˆä¸Šä¼ å›¾ç‰‡"]};for(const S of z)if(S<0||S>=j)return s.error(`æ— æ•ˆçš„é¡µé¢ç´¢å¼•: ${S}`),{success:!1,completed:0,failed:0,errors:[`æ— æ•ˆçš„é¡µé¢ç´¢å¼•: ${S}`]};const q=z.length===1,Q=z.length===j;let W;if(q){const S=n.currentImageIndex,i=z[0];i!==void 0&&n.setCurrentImageIndex(i),W=T(ae,"current");const P=await o.execute(W);return n.setCurrentImageIndex(S),{success:P.success,completed:P.completed,failed:P.failed,errors:P.errors??[]}}else if(Q)W=T(ae,"all");else{const S=Fi(z);W=T(ae,"range",S)}const se=await o.execute(W);return{success:se.success,completed:se.completed,failed:se.failed,errors:se.errors??[]}}function T(z,ae,j){switch(z){case"standard":return fn(ae,j?{pageRange:j}:void 0);case"hq":return Bi(ae,j?{pageRange:j}:void 0);case"proofread":return Ai(ae,j?{pageRange:j}:void 0);case"removeText":return Li(ae,j?{pageRange:j}:void 0);default:return fn(ae,j?{pageRange:j}:void 0)}}async function M(){return(await _([n.currentImageIndex],"standard")).success}async function R(z){return(await _([z],"standard")).success}async function I(){return(await _(bt(0,n.images.length),"standard")).success}async function E(z){const ae=bt(z.startPage-1,z.endPage);return(await _(ae,"standard")).success}function H(){o.cancel()}async function V(){return(await _([n.currentImageIndex],"removeText")).success}async function F(){return(await _(bt(0,n.images.length),"removeText")).success}async function b(z){const ae=bt(z.startPage-1,z.endPage);return(await _(ae,"removeText")).success}async function v(){const z=n.getFailedImageIndices();return z.length===0?(s.info("æ²¡æœ‰å¤±è´¥çš„å›¾ç‰‡éœ€è¦é‡æ–°ç¿»è¯‘"),!0):(await _(z,"standard")).success}async function k(z){const ae=z?bt(z.startPage-1,z.endPage):bt(0,n.images.length);return(await _(ae,"hq")).success}async function $(z){const ae=z?bt(z.startPage-1,z.endPage):bt(0,n.images.length);return(await _(ae,"proofread")).success}async function N(){if(!n.currentImage)return s.error("è¯·å…ˆä¸Šä¼ å›¾ç‰‡"),!1;const ae=t.bubbles;return!ae||ae.length===0?(s.error("å½“å‰å›¾ç‰‡æ²¡æœ‰æ°”æ³¡æ¡†ï¼Œè¯·å…ˆæ£€æµ‹æˆ–æ‰‹åŠ¨æ·»åŠ "),!1):(n.setManuallyAnnotated(!0),M())}return{progress:l,isTranslatingSingle:u,isHqTranslating:m,isProofreading:p,isTranslating:a,progressPercent:c,translatePages:_,range:bt,translateCurrentImage:M,translateImageByIndex:R,translateAllImages:I,translateImageRange:E,cancelBatchTranslation:H,removeTextOnly:V,removeAllTexts:F,removeTextRange:b,retryFailedImages:v,executeHqTranslation:k,executeProofreading:$,translateWithCurrentBubbles:N}}function Ui(){const n=gt(),t=et(),s=w(!1);function o(){if(!s.value)return;const l=t.currentImage;n.bubbleCount>0?t.updateCurrentBubbleStates([...n.bubbles]):l&&Array.isArray(l.bubbleStates)&&l.bubbleStates.length>0&&(t.updateCurrentBubbleStates([]),console.log("é€€å‡ºç¼–è¾‘æ¨¡å¼ï¼ˆæ— é‡æ¸²æŸ“ï¼‰ï¼Œç”¨æˆ·å·²åˆ é™¤æ‰€æœ‰æ°”æ³¡")),s.value=!1,n.clearSelection(),console.log("å·²é€€å‡ºç¼–è¾‘æ¨¡å¼ï¼ˆæ— é‡æ¸²æŸ“ï¼‰")}return{isActive:s,exitEditModeWithoutRender:o}}function Oi(){const n=Cn(),t=ze(),s=et(),o=It(),l=gt(),u=Ui(),a=w(!1),c=w(!1),m=w(null),p=w([]),_=w([]),T=w([]),M=w(null),R=w(null),I=w(null),E=w(null),H=w(!1);async function V(q=!1){if(!q&&(a.value||c.value)){console.log("[TranslateInit] å·²ç»åˆå§‹åŒ–ï¼Œä»…é‡æ–°åŠ è½½ä¸Šä¸‹æ–‡"),await $();return}console.log("[TranslateInit] å¼€å§‹åˆå§‹åŒ–åº”ç”¨..."),a.value=!0,m.value=null;try{await F(),await b(),await v(),await k(),await $(),console.log("[TranslateInit] åº”ç”¨åˆå§‹åŒ–å®Œæˆ"),c.value=!0}catch(Q){console.error("[TranslateInit] åº”ç”¨åˆå§‹åŒ–å¤±è´¥:",Q),m.value=Q instanceof Error?Q.message:"åˆå§‹åŒ–å¤±è´¥"}finally{a.value=!1}}async function F(){console.log("[TranslateInit] åˆå§‹åŒ–è®¾ç½®..."),t.initSettings();try{const q=await t.loadFromBackend();console.log(q?"[TranslateInit] å·²ä»åç«¯åŠ è½½è®¾ç½®":"[TranslateInit] åç«¯æ— è®¾ç½®ï¼Œä½¿ç”¨ localStorage æ•°æ®")}catch(q){console.warn("[TranslateInit] ä»åç«¯åŠ è½½è®¾ç½®å¤±è´¥ï¼Œä½¿ç”¨ localStorage æ•°æ®:",q)}console.log("[TranslateInit] è®¾ç½®åˆå§‹åŒ–å®Œæˆ")}async function b(){console.log("[TranslateInit] åˆå§‹åŒ–å­—ä½“åˆ—è¡¨...");try{const q=await $n();q.fonts&&q.fonts.length>0?(p.value=q.fonts,console.log(`[TranslateInit] å·²åŠ è½½ ${q.fonts.length} ä¸ªå­—ä½“`)):q.error?console.warn("[TranslateInit] è·å–å­—ä½“åˆ—è¡¨å¤±è´¥:",q.error):console.warn("[TranslateInit] å­—ä½“åˆ—è¡¨ä¸ºç©º")}catch(q){console.error("[TranslateInit] è·å–å­—ä½“åˆ—è¡¨å¤±è´¥:",q)}}async function v(){console.log("[TranslateInit] åˆå§‹åŒ–ç¿»è¯‘æç¤ºè¯è®¾ç½®...");try{const q=await zs();q.prompt_names!==void 0?(_.value=q.prompt_names||[],!t.settings.translatePrompt&&q.default_prompt_content&&t.setTranslatePrompt(q.default_prompt_content),console.log(`[TranslateInit] å·²åŠ è½½ ${_.value.length} ä¸ªç¿»è¯‘æç¤ºè¯`)):q.error&&console.warn("[TranslateInit] è·å–ç¿»è¯‘æç¤ºè¯å¤±è´¥:",q.error)}catch(q){console.error("[TranslateInit] è·å–ç¿»è¯‘æç¤ºè¯å¤±è´¥:",q)}}async function k(){console.log("[TranslateInit] åˆå§‹åŒ–æ–‡æœ¬æ¡†æç¤ºè¯è®¾ç½®...");try{const q=await Os();q.prompt_names!==void 0?(T.value=q.prompt_names||[],!t.settings.textboxPrompt&&q.default_prompt_content&&t.setTextboxPrompt(q.default_prompt_content),console.log(`[TranslateInit] å·²åŠ è½½ ${T.value.length} ä¸ªæ–‡æœ¬æ¡†æç¤ºè¯`)):q.error&&console.warn("[TranslateInit] è·å–æ–‡æœ¬æ¡†æç¤ºè¯å¤±è´¥:",q.error)}catch(q){console.error("[TranslateInit] è·å–æ–‡æœ¬æ¡†æç¤ºè¯å¤±è´¥:",q)}}async function $(){const q=n.query.book,Q=n.query.chapter;if(!q||!Q){console.log("[TranslateInit] æœªæŒ‡å®šä¹¦ç±/ç« èŠ‚å‚æ•°ï¼Œä½¿ç”¨ç‹¬ç«‹æ¨¡å¼"),H.value=!1,M.value=null,R.value=null,I.value=null,E.value=null,o.clearContext();return}console.log(`[TranslateInit] æ£€æµ‹åˆ°ä¹¦ç±/ç« èŠ‚å‚æ•°: book=${q}, chapter=${Q}`),H.value=!0,M.value=q,R.value=Q;try{const W=await Vs(q);if(!W.success||!W.book){console.warn("[TranslateInit] ä¹¦ç±ä¸å­˜åœ¨:",q),_e("ä¹¦ç±ä¸å­˜åœ¨","warning");return}const se=W.book,S=se.chapters?.find(i=>i.id===Q);if(!S){console.warn("[TranslateInit] ç« èŠ‚ä¸å­˜åœ¨:",Q),_e("ç« èŠ‚ä¸å­˜åœ¨","warning");return}if(I.value=se.title,E.value=S.title,o.setBookChapterContext(q,Q,se.title,S.title),typeof document<"u"&&(document.title=`${S.title} - ${se.title} - Saber-Translator`),S.session_path){console.log(`[TranslateInit] å°è¯•åŠ è½½ç« èŠ‚ä¼šè¯: ${S.session_path}`);try{await o.loadSessionByPath(S.session_path),_e(`å·²åŠ è½½ç« èŠ‚: ${S.title}`,"success")}catch{console.log("[TranslateInit] ç« èŠ‚ä¼šè¯æ•°æ®ä¸å­˜åœ¨æˆ–åŠ è½½å¤±è´¥ï¼Œå°†åˆ›å»ºæ–°ä¼šè¯")}}}catch(W){console.error("[TranslateInit] åŠ è½½ä¹¦ç±/ç« èŠ‚ä¿¡æ¯å¤±è´¥:",W),_e("åŠ è½½ä¹¦ç±ä¿¡æ¯å¤±è´¥","error")}}function N(q){if(q<0||q>=s.imageCount){console.warn(`[TranslateInit] æ— æ•ˆçš„å›¾ç‰‡ç´¢å¼•: ${q}`);return}window._isChangingFromSwitchImage=!0,u.isActive.value&&u.exitEditModeWithoutRender(),s.currentImage&&l.bubbles.length>0&&s.updateCurrentImageProperty("bubbleStates",l.bubbles),s.setCurrentImageIndex(q);const W=s.currentImage;if(!W){console.warn("[TranslateInit] åˆ‡æ¢åˆ°çš„å›¾ç‰‡ä¸å­˜åœ¨"),window._isChangingFromSwitchImage=!1;return}console.log(`[TranslateInit] åˆ‡æ¢åˆ°å›¾ç‰‡: ${q}, ${W.fileName}`),W.bubbleStates&&W.bubbleStates.length>0?l.setBubbles(W.bubbleStates,!0):l.clearBubblesLocal(),setTimeout(()=>{window._isChangingFromSwitchImage=!1,console.log("[TranslateInit] å·²é‡ç½®åˆ‡æ¢å›¾ç‰‡æ“ä½œæ ‡è®°")},100)}function z(){s.canGoPrevious&&N(s.currentImageIndex-1)}function ae(){s.canGoNext&&N(s.currentImageIndex+1)}function j(){dt(async()=>{await V()})}return{isInitializing:a,isInitialized:c,initError:m,fontList:p,promptNames:_,textboxPromptNames:T,currentBookId:M,currentChapterId:R,currentBookTitle:I,currentChapterTitle:E,isBookshelfMode:H,initializeApp:V,initializeSettings:F,initializeFontList:b,initializePromptSettings:v,initializeTextboxPromptSettings:k,initializeBookChapterContext:$,switchImage:N,goToPrevious:z,goToNext:ae,editMode:u,setupAutoInit:j}}const zi={key:0,id:"translationProgressBar",class:"translation-progress-bar"},Ni={class:"parallel-header"},Vi={class:"header-title"},Wi={key:0,class:"presave-section"},Ki={class:"presave-label"},qi={class:"presave-progress-bar"},Hi={class:"pools-list"},ji={class:"pool-label"},Ji={class:"pool-icon"},Yi={class:"pool-name"},Xi={class:"pool-progress-bar"},Gi={class:"pool-stats"},Zi={class:"completed-count"},Qi={class:"total-count"},er={key:0,class:"waiting-badge"},tr={key:1,class:"lock-indicator",title:"ç­‰å¾…æ·±åº¦å­¦ä¹ é”"},or={key:0,class:"pool-row save-row"},nr={class:"pool-progress-bar"},sr={class:"pool-stats"},ar={class:"completed-count"},lr={class:"total-count"},ir={class:"overall-section"},rr={class:"overall-label"},ur={key:0,class:"failed-text"},cr={class:"overall-progress-bar"},dr={class:"progress-bar-label"},gr={key:0,class:"failed-count"},pr={class:"progress-bar"},mr=je({__name:"TranslationProgress",props:{progress:{}},setup(n){const t=n,s=et(),o=ze(),l=Eo(),u=Mo(),a=X(()=>{const v=u.progress.value?.preSave?.isRunning;return o.settings.parallel?.enabled&&(u.isRunning.value||v)}),c=X(()=>u.progress.value),m=X(()=>{const v=c.value;return!v||v.totalPages===0?0:Math.round(v.totalCompleted/v.totalPages*100)});function p(v){const k=c.value?.totalPages||0;return k===0?0:Math.round(v.completed/k*100)}function _(){const v=c.value?.totalPages||0;return v===0?0:Math.max(3,Math.round(1/v*100))}function T(){const v=c.value?.preSave;return!v||v.total===0?0:Math.round(v.current/v.total*100)}function M(){const v=c.value?.save;return!v||v.total===0?0:Math.round(v.completed/v.total*100)}const R=X(()=>t.progress||l.progress.value),I=X(()=>R.value.isInProgress||s.isBatchTranslationInProgress||a.value),E=X(()=>R.value.current),H=X(()=>R.value.total),V=X(()=>R.value.failed),F=X(()=>R.value.percentage!==void 0?R.value.percentage:H.value===0?0:Math.round(E.value/H.value*100)),b=X(()=>R.value.label?R.value.label:`ç¿»è¯‘ä¸­ï¼š${E.value} / ${H.value}`);return(v,k)=>I.value?(A(),L("div",zi,[a.value&&c.value?(A(),L(Ve,{key:0},[e("div",Ni,[e("span",Vi,"ğŸš€ å¹¶è¡Œç¿»è¯‘ä¸­ï¼š"+oe(c.value.totalCompleted)+"/"+oe(c.value.totalPages),1)]),c.value.preSave?.isRunning?(A(),L("div",Wi,[e("div",Ki," ğŸ“¥ é¢„ä¿å­˜åŸå§‹å›¾ç‰‡ï¼š"+oe(c.value.preSave.current)+"/"+oe(c.value.preSave.total),1),e("div",qi,[e("div",{class:"presave-progress-fill",style:st({width:T()+"%"})},null,4)])])):ce("",!0),e("div",Hi,[(A(!0),L(Ve,null,Ye(c.value.pools,$=>(A(),L("div",{key:$.name,class:Ie(["pool-row",{"pool-processing":$.processing,"pool-waiting-lock":$.isWaitingLock}])},[e("div",ji,[e("span",Ji,oe($.icon),1),e("span",Yi,oe($.name),1)]),e("div",Xi,[e("div",{class:"progress-completed",style:st({width:p($)+"%"})},null,4),$.processing?(A(),L("div",{key:0,class:"progress-processing",style:st({left:p($)+"%",width:_()+"%"})},null,4)):ce("",!0)]),e("div",Gi,[e("span",Zi,oe($.completed),1),e("span",Qi,"/ "+oe(c.value.totalPages),1),$.waiting>0?(A(),L("span",er,"+"+oe($.waiting),1)):ce("",!0),$.isWaitingLock?(A(),L("span",tr,"ğŸ”’")):ce("",!0)])],2))),128)),c.value.save?(A(),L("div",or,[k[0]||(k[0]=e("div",{class:"pool-label"},[e("span",{class:"pool-icon"},"ğŸ’¾"),e("span",{class:"pool-name"},"ä¿å­˜")],-1)),e("div",nr,[e("div",{class:"progress-completed save-progress",style:st({width:M()+"%"})},null,4)]),e("div",sr,[e("span",ar,oe(c.value.save.completed),1),e("span",lr,"/ "+oe(c.value.save.total),1)])])):ce("",!0)]),k[1]||(k[1]=e("div",{class:"divider"},null,-1)),e("div",ir,[e("div",rr,[me(" æ€»è¿›åº¦ï¼š"+oe(m.value)+"% ",1),c.value.totalFailed>0?(A(),L("span",ur," ï¼ˆ"+oe(c.value.totalFailed)+" å¤±è´¥ï¼‰ ",1)):ce("",!0)]),e("div",cr,[e("div",{class:"overall-progress-fill progress-stripe",style:st({width:m.value+"%"})},null,4)])])],64)):(A(),L(Ve,{key:1},[e("div",dr,[me(oe(b.value)+" ",1),V.value>0?(A(),L("span",gr,"ï¼ˆ"+oe(V.value)+" å¼ å¤±è´¥ï¼‰",1)):ce("",!0)]),e("div",pr,[e("div",{class:"progress progress-stripe",style:st({width:`${F.value}%`})},null,4)])],64))])):ce("",!0)}}),vr=He(mr,[["__scopeId","data-v-532ece5f"]]),fr=je({__name:"SponsorModal",emits:["close"],setup(n,{emit:t}){const s=t;return(o,l)=>(A(),ut(Tn,{title:"æ”¯æŒä½œè€…",onClose:l[1]||(l[1]=u=>s("close"))},{footer:St(()=>[e("button",{type:"button",class:"btn btn-primary",onClick:l[0]||(l[0]=u=>s("close"))},"å…³é—­")]),default:St(()=>[l[2]||(l[2]=e("div",{class:"sponsor-content"},[e("p",{class:"sponsor-message"}," å¦‚æœè¿™ä¸ªé¡¹ç›®å¯¹ä½ æœ‰å¸®åŠ©ï¼Œæ¬¢è¿è¯·ä½œè€…å–æ¯å’–å•¡ â˜• "),e("div",{class:"qr-codes"},[e("div",{class:"qr-item"},[e("div",{class:"qr-image"},[e("img",{src:"/pic/wechat_qrcode.png",alt:"å¾®ä¿¡æ”¯ä»˜"})]),e("span",{class:"qr-label"},"å¾®ä¿¡æ”¯ä»˜")]),e("div",{class:"qr-item"},[e("div",{class:"qr-image"},[e("img",{src:"/pic/alipay_qrcode.png",alt:"æ”¯ä»˜å®"})]),e("span",{class:"qr-label"},"æ”¯ä»˜å®")])]),e("p",{class:"sponsor-thanks"},"æ„Ÿè°¢æ‚¨çš„æ”¯æŒï¼ğŸ™")],-1))]),_:1}))}}),br=He(fr,[["__scopeId","data-v-02b6948e"]]);function hr(n){const t=w(""),s=X(()=>n.value.some(R=>R.folderPath)),o=X(()=>{if(!s.value)return null;const R={name:"æ ¹ç›®å½•",path:"",images:[],subfolders:[]},I=new Map;I.set("",R);for(const E of n.value){const H=E.folderPath||"";if(H&&!I.has(H)){const V=H.split("/");let F="";for(const b of V){const v=F;if(F=F?`${F}/${b}`:b,!I.has(F)){const k={name:b,path:F,images:[],subfolders:[]};I.set(F,k),I.has(v)&&I.get(v).subfolders.push(k)}}}I.has(H)&&I.get(H).images.push(E)}return R}),l=X(()=>{if(!t.value)return[{name:"æ ¹ç›®å½•",path:""}];const R=t.value.split("/"),I=[{name:"æ ¹ç›®å½•",path:""}];let E="";for(const H of R)E=E?`${E}/${H}`:H,I.push({name:H,path:E});return I}),u=X(()=>{if(!o.value)return null;if(!t.value)return o.value;const R=(I,E)=>{if(I.path===E)return I;for(const H of I.subfolders){const V=R(H,E);if(V)return V}return null};return R(o.value,t.value)}),a=X(()=>u.value?.subfolders||[]),c=X(()=>u.value?.images||[]);function m(R){t.value=R}function p(){if(!t.value)return;const R=t.value.lastIndexOf("/");t.value=R>0?t.value.substring(0,R):""}function _(R){t.value=R}function T(R){let I=R.images.length;for(const E of R.subfolders)I+=T(E);return I}function M(){t.value=""}return{currentFolderPath:t,useTreeMode:s,folderTree:o,breadcrumbs:l,currentFolder:u,currentSubfolders:a,currentImages:c,enterFolder:m,goUp:p,navigateTo:_,getFolderImageCount:T,resetToRoot:M}}const xr={id:"thumbnail-sidebar",class:"thumbnail-sidebar"},yr={class:"card thumbnail-card"},_r={class:"breadcrumb-nav"},Cr=["onClick"],Sr={key:0,class:"breadcrumb-sep"},kr=["onClick"],wr={class:"folder-info"},$r=["title"],Tr={class:"folder-count"},Ir=["title","onClick"],Pr=["src","alt"],Rr={class:"page-number-indicator"},Dr={key:1,class:"translated-indicator"},Mr={key:2,class:"translation-failed-indicator"},Er={key:3,class:"labeled-indicator"},Br={key:4,class:"thumbnail-processing-indicator"},Ar={key:0,class:"empty-folder"},Lr=["title","data-index","onClick"],Fr=["src","alt"],Ur={class:"page-number-indicator"},Or={key:1,class:"translated-indicator"},zr={key:2,class:"translation-failed-indicator"},Nr={key:3,class:"labeled-indicator"},Vr={key:4,class:"thumbnail-processing-indicator"},Wr={key:2,class:"empty-state"},Kr=je({__name:"ThumbnailSidebar",emits:["select"],setup(n,{emit:t}){const s=t,o=et(),l=w(null),u=w([]),a=X(()=>o.images),c=X(()=>o.currentImageIndex),m=X(()=>o.hasImages),{useTreeMode:p,breadcrumbs:_,currentSubfolders:T,currentImages:M,currentFolderPath:R,enterFolder:I,goUp:E,navigateTo:H,getFolderImageCount:V,folderTree:F,resetToRoot:b}=hr(a);Se(()=>a.value.length,(W,se)=>{(W===0||se===0&&W>0)&&b()});function v(W){return a.value.findIndex(se=>se.id===W.id)}function k(W){return W.translationFailed?"failed":W.isManuallyAnnotated?"labeled":W.translationStatus==="processing"?"processing":null}function $(W){return W.translationStatus==="completed"}function N(W){s("select",W)}function z(W){I(W.path)}function ae(W){H(W)}function j(){pt(()=>{const W=u.value[c.value];if(W&&l.value){const se=l.value,S=W.offsetTop-se.clientHeight/2+W.clientHeight/2;se.scrollTo({top:Math.max(0,S),behavior:"smooth"})}})}function q(W,se){u.value[se]=W}function Q(W){return W.translationFailed?"ç¿»è¯‘å¤±è´¥ï¼Œç‚¹å‡»å¯é‡è¯•":W.isManuallyAnnotated?"åŒ…å«æ‰‹åŠ¨æ ‡æ³¨":W.translationStatus==="completed"?"å·²å®Œæˆç¿»è¯‘":W.fileName||""}return Se(c,()=>{j()}),dt(()=>{m.value&&j()}),(W,se)=>(A(),L("aside",xr,[e("div",yr,[se[5]||(se[5]=e("h2",null,"å›¾ç‰‡æ¦‚è§ˆ",-1)),m.value&&K(p)&&K(F)?(A(),L(Ve,{key:0},[e("div",_r,[(A(!0),L(Ve,null,Ye(K(_),(S,i)=>(A(),L(Ve,{key:S.path},[e("span",{class:Ie(["breadcrumb-item",{active:i===K(_).length-1}]),onClick:P=>i<K(_).length-1&&ae(S.path)},oe(i===0?"ğŸ“":"")+oe(S.name),11,Cr),i<K(_).length-1?(A(),L("span",Sr,"/")):ce("",!0)],64))),128))]),K(R)?(A(),L("div",{key:0,class:"folder-back-btn",onClick:se[0]||(se[0]=(...S)=>K(E)&&K(E)(...S))},[...se[1]||(se[1]=[e("span",{class:"back-icon"},"â¬…ï¸",-1),e("span",null,"è¿”å›ä¸Šçº§",-1)])])):ce("",!0),e("div",{ref_key:"containerRef",ref:l,class:"folder-content-list"},[(A(!0),L(Ve,null,Ye(K(T),S=>(A(),L("div",{key:S.path,class:"folder-item",onClick:i=>z(S)},[se[2]||(se[2]=e("span",{class:"folder-icon"},"ğŸ“",-1)),e("div",wr,[e("span",{class:"folder-name",title:S.name},oe(S.name),9,$r),e("span",Tr,"("+oe(K(V)(S))+")",1)])],8,kr))),128)),(A(!0),L(Ve,null,Ye(K(M),S=>(A(),L("div",{key:S.id,ref_for:!0,ref:i=>q(i,v(S)),class:Ie(["thumbnail-item",{active:v(S)===c.value}]),title:Q(S),onClick:i=>N(v(S))},[S.originalDataURL?(A(),L("img",{key:0,src:S.originalDataURL,alt:S.fileName,class:"thumbnail-image"},null,8,Pr)):ce("",!0),e("span",Rr,oe(v(S)+1),1),$(S)?(A(),L("span",Dr,"âœ“")):ce("",!0),k(S)==="failed"?(A(),L("span",Mr,"!")):k(S)==="labeled"?(A(),L("span",Er,"âœï¸")):ce("",!0),k(S)==="processing"?(A(),L("div",Br,"âŸ³")):ce("",!0)],10,Ir))),128)),K(T).length===0&&K(M).length===0?(A(),L("div",Ar,[...se[3]||(se[3]=[e("p",null,"æ­¤æ–‡ä»¶å¤¹ä¸ºç©º",-1)])])):ce("",!0)],512)],64)):m.value?(A(),L("ul",{key:1,ref_key:"containerRef",ref:l,id:"thumbnailList",class:"thumbnail-list"},[(A(!0),L(Ve,null,Ye(a.value,(S,i)=>(A(),L("li",{key:S.id,ref_for:!0,ref:P=>q(P,i),class:Ie(["thumbnail-item",{active:i===c.value}]),title:Q(S),"data-index":i,onClick:P=>N(i)},[S.originalDataURL?(A(),L("img",{key:0,src:S.originalDataURL,alt:S.fileName,class:"thumbnail-image"},null,8,Fr)):ce("",!0),e("span",Ur,oe(i+1),1),$(S)?(A(),L("span",Or,"âœ“")):ce("",!0),k(S)==="failed"?(A(),L("span",zr,"!")):k(S)==="labeled"?(A(),L("span",Nr,"âœï¸")):ce("",!0),k(S)==="processing"?(A(),L("div",Vr," âŸ³ ")):ce("",!0)],10,Lr))),128))],512)):(A(),L("div",Wr,[...se[4]||(se[4]=[e("p",null,"æš‚æ— å›¾ç‰‡",-1)])]))])]))}}),qr=He(Kr,[["__scopeId","data-v-4c1f4f1b"]]),Hr={class:"saved-prompts-picker"},jr={class:"prompts-chips-container"},Jr={key:0,class:"empty-hint"},Yr={key:1,class:"empty-hint"},Xr=["title","onClick"],Gr=je({__name:"SavedPromptsPicker",props:{promptType:{}},emits:["select"],setup(n,{expose:t,emit:s}){const o=n,l=s,u=w([]),a=w(!1);async function c(){a.value=!0;try{let p;o.promptType==="textbox"?p=await qe.getTextboxPrompts():p=await qe.getPrompts(o.promptType);const _=p.prompt_names||[];u.value=_.map(T=>({name:T}))}catch(p){console.error("åŠ è½½æç¤ºè¯åˆ—è¡¨å¤±è´¥:",p),u.value=[]}finally{a.value=!1}}async function m(p){try{let _;o.promptType==="textbox"?_=await qe.getTextboxPromptContent(p):_=await qe.getPromptContent(o.promptType,p),_.prompt_content&&l("select",_.prompt_content,p)}catch(_){console.error("åŠ è½½æç¤ºè¯å†…å®¹å¤±è´¥:",_)}}return Se(()=>o.promptType,()=>{c()}),dt(()=>{c()}),t({refresh:c}),(p,_)=>(A(),L("div",Hr,[_[1]||(_[1]=e("span",{class:"picker-label"},"ğŸ“‘ å¿«é€Ÿé€‰æ‹©:",-1)),e("div",jr,[a.value?(A(),L("span",Jr,"åŠ è½½ä¸­...")):u.value.length===0?(A(),L("span",Yr,"æš‚æ— ä¿å­˜çš„æç¤ºè¯")):(A(!0),L(Ve,{key:2},Ye(u.value,T=>(A(),L("button",{key:T.name,type:"button",class:"prompt-chip",title:T.name,onClick:M=>m(T.name)},[_[0]||(_[0]=e("span",{class:"chip-icon"},"ğŸ“",-1)),me(" "+oe(T.name),1)],8,Xr))),128))])]))}}),zt=He(Gr,[["__scopeId","data-v-2ebbb8b3"]]),Zr={class:"ocr-settings"},Qr={class:"settings-group"},eu={class:"settings-item"},tu={class:"settings-item"},ou={class:"input-hint"},nu={class:"settings-group"},su={class:"settings-item"},au={class:"settings-group"},lu={class:"settings-row"},iu={class:"settings-item"},ru={class:"password-input-wrapper"},uu=["type"],cu={key:0,class:"eye-icon"},du={key:1,class:"eye-off-icon"},gu={class:"settings-item"},pu={class:"password-input-wrapper"},mu=["type"],vu={key:0,class:"eye-icon"},fu={key:1,class:"eye-off-icon"},bu={class:"settings-row"},hu={class:"settings-item"},xu={class:"settings-item"},yu=["disabled"],_u={class:"settings-group"},Cu={class:"settings-row"},Su={class:"settings-item"},ku={class:"settings-item"},wu={class:"password-input-wrapper"},$u=["type"],Tu={key:0,class:"eye-icon"},Iu={key:1,class:"eye-off-icon"},Pu={class:"settings-item"},Ru={class:"settings-item"},Du={class:"model-input-with-fetch"},Mu=["disabled"],Eu={class:"fetch-text"},Bu={key:0,class:"model-select-container"},Au={class:"model-count"},Lu={class:"settings-item"},Fu={class:"prompt-format-selector"},Uu={class:"settings-item"},Ou={class:"settings-item"},zu=["disabled"],Nu=je({__name:"OcrSettings",setup(n){const t=[{label:"MangaOCR (æ—¥è¯­ä¸“ç”¨)",value:"manga_ocr"},{label:"PaddleOCR (å¤šè¯­è¨€)",value:"paddle_ocr"},{label:"PaddleOCR-VL",value:"paddleocr_vl"},{label:"ç™¾åº¦OCR",value:"baidu_ocr"},{label:"48px OCR",value:"48px_ocr"},{label:"AIè§†è§‰OCR",value:"ai_vision"}],s=[{label:"æ ‡å‡†ç‰ˆ",value:"standard"},{label:"é«˜ç²¾åº¦ç‰ˆ",value:"high_precision"}],o=[{label:"è‡ªåŠ¨æ£€æµ‹",value:"auto_detect"},{label:"ä¸­è‹±æ–‡æ··åˆ",value:"CHN_ENG"},{label:"è‹±æ–‡",value:"ENG"},{label:"æ—¥è¯­",value:"JAP"},{label:"éŸ©è¯­",value:"KOR"},{label:"æ³•è¯­",value:"FRE"},{label:"å¾·è¯­",value:"GER"},{label:"ä¿„è¯­",value:"RUS"}],l=[{label:"SiliconFlow (ç¡…åŸºæµåŠ¨)",value:"siliconflow"},{label:"ç«å±±å¼•æ“",value:"volcano"},{label:"Google Gemini",value:"gemini"},{label:"è‡ªå®šä¹‰ OpenAI å…¼å®¹æœåŠ¡",value:"custom_openai_vision"}],u=[{label:"ğŸŒ ä¸œäºšè¯­è¨€",options:[{label:"æ—¥è¯­",value:"japanese"},{label:"ç®€ä½“ä¸­æ–‡",value:"chinese"},{label:"ç¹ä½“ä¸­æ–‡",value:"chinese_cht"},{label:"éŸ©è¯­",value:"korean"}]},{label:"ğŸŒ æ‹‰ä¸è¯­ç³»",options:[{label:"è‹±è¯­",value:"english"},{label:"æ³•è¯­",value:"french"},{label:"å¾·è¯­",value:"german"},{label:"è¥¿ç­ç‰™è¯­",value:"spanish"},{label:"æ„å¤§åˆ©è¯­",value:"italian"},{label:"è‘¡è„ç‰™è¯­",value:"portuguese"},{label:"è·å…°è¯­",value:"dutch"},{label:"æ³¢å…°è¯­",value:"polish"}]},{label:"ğŸŒ ä¸œå—äºšè¯­è¨€",options:[{label:"æ³°è¯­",value:"thai"},{label:"è¶Šå—è¯­",value:"vietnamese"},{label:"å°å°¼è¯­",value:"indonesian"},{label:"é©¬æ¥è¯­",value:"malay"}]},{label:"ğŸŒ å…¶ä»–è¯­ç³»",options:[{label:"ä¿„è¯­",value:"russian"},{label:"é˜¿æ‹‰ä¼¯è¯­",value:"arabic"},{label:"å°åœ°è¯­",value:"hindi"},{label:"åœŸè€³å…¶è¯­",value:"turkish"},{label:"å¸Œè…Šè¯­",value:"greek"},{label:"å¸Œä¼¯æ¥è¯­",value:"hebrew"}]}],a=[{label:"æ™®é€šæç¤ºè¯",value:"false"},{label:"JSONæç¤ºè¯",value:"true"}],c=[{label:"ğŸš€ å¸¸ç”¨è¯­è¨€",options:[{label:"æ—¥è¯­",value:"japanese"},{label:"è‹±è¯­",value:"en"},{label:"ç®€ä½“ä¸­æ–‡",value:"chinese"},{label:"ç¹ä½“ä¸­æ–‡",value:"chinese_cht"},{label:"éŸ©è¯­",value:"korean"}]},{label:"ğŸŒ æ‹‰ä¸è¯­ç³»",options:[{label:"æ³•è¯­",value:"french"},{label:"å¾·è¯­",value:"german"},{label:"è¥¿ç­ç‰™è¯­",value:"spanish"},{label:"æ„å¤§åˆ©è¯­",value:"italian"},{label:"è‘¡è„ç‰™è¯­",value:"portuguese"}]},{label:"ğŸŒ å…¶ä»–è¯­ç³»",options:[{label:"ä¿„è¯­",value:"russian"}]}],m=ze(),p=ct(),_=w({apiKey:m.settings.baiduOcr.apiKey,secretKey:m.settings.baiduOcr.secretKey,version:m.settings.baiduOcr.version,sourceLanguage:m.settings.baiduOcr.sourceLanguage}),T=w({apiKey:m.settings.aiVisionOcr.apiKey,modelName:m.settings.aiVisionOcr.modelName,customBaseUrl:m.settings.aiVisionOcr.customBaseUrl,prompt:m.settings.aiVisionOcr.prompt,rpmLimit:m.settings.aiVisionOcr.rpmLimit,minImageSize:m.settings.aiVisionOcr.minImageSize}),M=X(()=>m.settings);Se(()=>_.value.apiKey,S=>{m.updateBaiduOcr({apiKey:S})}),Se(()=>_.value.secretKey,S=>{m.updateBaiduOcr({secretKey:S})}),Se(()=>_.value.version,S=>{m.updateBaiduOcr({version:S})}),Se(()=>_.value.sourceLanguage,S=>{m.updateBaiduOcr({sourceLanguage:S})}),Se(()=>T.value.apiKey,S=>{m.updateAiVisionOcr({apiKey:S})}),Se(()=>T.value.modelName,S=>{m.updateAiVisionOcr({modelName:S})}),Se(()=>T.value.customBaseUrl,S=>{m.updateAiVisionOcr({customBaseUrl:S})}),Se(()=>T.value.prompt,S=>{m.updateAiVisionOcr({prompt:S})}),Se(()=>T.value.rpmLimit,S=>{m.updateAiVisionOcr({rpmLimit:S})}),Se(()=>T.value.minImageSize,S=>{m.updateAiVisionOcr({minImageSize:S})});const R=w(!1),I=w(!1),E=w(!1),H=w(!1),V=w(!1),F=w([]),b=X(()=>{const S=[{label:"-- é€‰æ‹©æ¨¡å‹ --",value:""}];return F.value.forEach(i=>{S.push({label:i,value:i})}),S});function v(){m.saveToStorage()}function k(){m.saveToStorage()}function $(S){m.updatePaddleOcrVl({sourceLanguage:S})}function N(){switch(m.settings.ocrEngine){case"manga_ocr":return"MangaOCR ä¸“ä¸ºæ—¥è¯­æ¼«ç”»ä¼˜åŒ–ï¼Œæºè¯­è¨€è®¾ç½®ä¸å½±å“è¯†åˆ«";case"paddle_ocr":return"PaddleOCR ä¼šæ ¹æ®æºè¯­è¨€åŠ è½½å¯¹åº”çš„è¯†åˆ«æ¨¡å‹";case"paddleocr_vl":return"PaddleOCR-VL åŸºäº VLM å¾®è°ƒï¼Œä¸“ä¸ºæ—¥è¯­æ¼«ç”»ä¼˜åŒ–ï¼Œå‡†ç¡®ç‡é«˜è¾¾ 70%";case"baidu_ocr":return"ç™¾åº¦OCR ä½¿ç”¨ç‹¬ç«‹çš„æºè¯­è¨€è®¾ç½®ï¼ˆè§ä¸‹æ–¹ï¼‰";case"ai_vision":return"AIè§†è§‰OCR é€šè¿‡æç¤ºè¯æŒ‡å®šè¯†åˆ«è¯­è¨€";case"48px_ocr":return"48px OCR æ”¯æŒæ—¥ä¸­è‹±éŸ©ç­‰å¤šè¯­è¨€ï¼Œæºè¯­è¨€è®¾ç½®ä¸å½±å“è¯†åˆ«";default:return"é€‰æ‹©è¦è¯†åˆ«çš„åŸæ–‡è¯­è¨€"}}function z(S){m.setAiVisionOcrProvider(S),F.value=[],ae()}function ae(){T.value.apiKey=m.settings.aiVisionOcr.apiKey,T.value.modelName=m.settings.aiVisionOcr.modelName,T.value.customBaseUrl=m.settings.aiVisionOcr.customBaseUrl,T.value.prompt=m.settings.aiVisionOcr.prompt,T.value.rpmLimit=m.settings.aiVisionOcr.rpmLimit,T.value.minImageSize=m.settings.aiVisionOcr.minImageSize}function j(){const S=m.settings.aiVisionOcr.isJsonMode?fs:bs;m.updateAiVisionOcr({prompt:S}),T.value.prompt=S}async function q(){const S=_.value.apiKey?.trim(),i=_.value.secretKey?.trim();if(!S||!i){p.warning("è¯·å¡«å†™ç™¾åº¦OCRçš„API Keyå’ŒSecret Key");return}H.value=!0,p.info("æ­£åœ¨æµ‹è¯•ç™¾åº¦OCRè¿æ¥...");try{const P=await qe.testBaiduOcrConnection(S,i);P.success?p.success(P.message||"ç™¾åº¦OCRè¿æ¥æˆåŠŸ!"):p.error(P.message||P.error||"ç™¾åº¦OCRè¿æ¥å¤±è´¥")}catch(P){const d=P instanceof Error?P.message:"è¿æ¥æµ‹è¯•å¤±è´¥";p.error(d)}finally{H.value=!1}}async function Q(){H.value=!0;try{const S=await qe.testAiVisionOcrConnection({provider:m.settings.aiVisionOcr.provider,apiKey:T.value.apiKey,modelName:T.value.modelName,customBaseUrl:T.value.customBaseUrl,prompt:T.value.prompt});S.success?p.success("AIè§†è§‰OCRè¿æ¥æˆåŠŸ"):p.error(`AIè§†è§‰OCRè¿æ¥å¤±è´¥: ${S.error||"æœªçŸ¥é”™è¯¯"}`)}catch(S){const i=S instanceof Error?S.message:"è¿æ¥æµ‹è¯•å¤±è´¥";p.error(i)}finally{H.value=!1}}async function W(){const S=m.settings.aiVisionOcr.provider,i=T.value.apiKey?.trim(),P=T.value.customBaseUrl?.trim();if(!i){p.warning("è¯·å…ˆå¡«å†™ API Key");return}if(!["siliconflow","volcano","gemini","custom_openai_vision"].includes(S)){p.warning("å½“å‰æœåŠ¡å•†ä¸æ”¯æŒè‡ªåŠ¨è·å–æ¨¡å‹åˆ—è¡¨");return}if(S==="custom_openai_vision"&&!P){p.warning("è‡ªå®šä¹‰æœåŠ¡éœ€è¦å…ˆå¡«å†™ Base URL");return}V.value=!0;try{const g=await qe.fetchModels(S,i,P);g.success&&g.models&&g.models.length>0?(F.value=g.models.map(f=>f.id),p.success(`è·å–åˆ° ${g.models.length} ä¸ªæ¨¡å‹`)):p.warning(g.message||"æœªè·å–åˆ°å¯ç”¨æ¨¡å‹")}catch(g){const f=g instanceof Error?g.message:"è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥";p.error(f)}finally{V.value=!1}}function se(S,i){m.updateAiVisionOcr({prompt:S}),T.value.prompt=S,p.success(`å·²åº”ç”¨æç¤ºè¯: ${i}`)}return(S,i)=>(A(),L("div",Zr,[e("div",Qr,[i[21]||(i[21]=e("div",{class:"settings-group-title"},"OCRå¼•æ“é€‰æ‹©",-1)),e("div",eu,[i[19]||(i[19]=e("label",{for:"settingsOcrEngine"},"OCRå¼•æ“:",-1)),Ce(Ke,{"model-value":M.value.ocrEngine,options:t,onChange:i[0]||(i[0]=P=>{M.value.ocrEngine=P,v()})},null,8,["model-value"])]),ne(e("div",tu,[i[20]||(i[20]=e("label",{for:"settingsSourceLanguage"},"æºè¯­è¨€:",-1)),Ce(Ke,{"model-value":M.value.sourceLanguage,groups:c,onChange:i[1]||(i[1]=P=>{M.value.sourceLanguage=P,k()})},null,8,["model-value"]),e("div",ou,oe(N()),1)],512),[[Oe,M.value.ocrEngine==="paddle_ocr"]])]),ne(e("div",nu,[i[24]||(i[24]=e("div",{class:"settings-group-title"},"PaddleOCR-VL è®¾ç½®",-1)),e("div",su,[i[22]||(i[22]=e("label",{for:"settingsPaddleOcrVlSourceLanguage"},"æºè¯­è¨€:",-1)),Ce(Ke,{"model-value":M.value.paddleOcrVl.sourceLanguage,groups:u,onChange:i[2]||(i[2]=P=>$(P))},null,8,["model-value"]),i[23]||(i[23]=e("div",{class:"input-hint"}," é€‰æ‹©å›¾åƒä¸­çš„æºè¯­è¨€ï¼Œç”¨äºä¼˜åŒ– OCR è¯†åˆ«æ•ˆæœ ",-1))])],512),[[Oe,M.value.ocrEngine==="paddleocr_vl"]]),ne(e("div",au,[i[29]||(i[29]=e("div",{class:"settings-group-title"},"ç™¾åº¦OCR è®¾ç½®",-1)),e("div",lu,[e("div",iu,[i[25]||(i[25]=e("label",{for:"settingsBaiduApiKey"},"API Key:",-1)),e("div",ru,[ne(e("input",{type:R.value?"text":"password",id:"settingsBaiduApiKey","onUpdate:modelValue":i[3]||(i[3]=P=>_.value.apiKey=P),class:"secure-input",placeholder:"è¯·è¾“å…¥ç™¾åº¦OCR API Key",autocomplete:"off"},null,8,uu),[[$t,_.value.apiKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:i[4]||(i[4]=P=>R.value=!R.value)},[R.value?(A(),L("span",du,"ğŸ‘â€ğŸ—¨")):(A(),L("span",cu,"ğŸ‘"))])])]),e("div",gu,[i[26]||(i[26]=e("label",{for:"settingsBaiduSecretKey"},"Secret Key:",-1)),e("div",pu,[ne(e("input",{type:I.value?"text":"password",id:"settingsBaiduSecretKey","onUpdate:modelValue":i[5]||(i[5]=P=>_.value.secretKey=P),class:"secure-input",placeholder:"è¯·è¾“å…¥Secret Key",autocomplete:"off"},null,8,mu),[[$t,_.value.secretKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:i[6]||(i[6]=P=>I.value=!I.value)},[I.value?(A(),L("span",fu,"ğŸ‘â€ğŸ—¨")):(A(),L("span",vu,"ğŸ‘"))])])])]),e("div",bu,[e("div",hu,[i[27]||(i[27]=e("label",{for:"settingsBaiduVersion"},"è¯†åˆ«ç‰ˆæœ¬:",-1)),Ce(Ke,{modelValue:_.value.version,"onUpdate:modelValue":i[7]||(i[7]=P=>_.value.version=P),options:s},null,8,["modelValue"])]),e("div",xu,[i[28]||(i[28]=e("label",{for:"settingsBaiduSourceLanguage"},"æºè¯­è¨€:",-1)),Ce(Ke,{modelValue:_.value.sourceLanguage,"onUpdate:modelValue":i[8]||(i[8]=P=>_.value.sourceLanguage=P),options:o},null,8,["modelValue"])])]),e("button",{class:"settings-test-btn",onClick:q,disabled:H.value},oe(H.value?"æµ‹è¯•ä¸­...":"ğŸ”— æµ‹è¯•è¿æ¥"),9,yu)],512),[[Oe,M.value.ocrEngine==="baidu_ocr"]]),ne(e("div",_u,[i[41]||(i[41]=e("div",{class:"settings-group-title"},"AIè§†è§‰OCR è®¾ç½®",-1)),e("div",Cu,[e("div",Su,[i[30]||(i[30]=e("label",{for:"settingsAiVisionProvider"},"æœåŠ¡å•†:",-1)),Ce(Ke,{"model-value":M.value.aiVisionOcr.provider,options:l,onChange:i[9]||(i[9]=P=>z(P))},null,8,["model-value"])]),e("div",ku,[i[31]||(i[31]=e("label",{for:"settingsAiVisionApiKey"},"API Key:",-1)),e("div",wu,[ne(e("input",{type:E.value?"text":"password",id:"settingsAiVisionApiKey","onUpdate:modelValue":i[10]||(i[10]=P=>T.value.apiKey=P),class:"secure-input",placeholder:"è¯·è¾“å…¥API Key",autocomplete:"off"},null,8,$u),[[$t,T.value.apiKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:i[11]||(i[11]=P=>E.value=!E.value)},[E.value?(A(),L("span",Iu,"ğŸ‘â€ğŸ—¨")):(A(),L("span",Tu,"ğŸ‘"))])])])]),ne(e("div",Pu,[i[32]||(i[32]=e("label",{for:"settingsCustomAiVisionBaseUrl"},"Base URL:",-1)),ne(e("input",{type:"text",id:"settingsCustomAiVisionBaseUrl","onUpdate:modelValue":i[12]||(i[12]=P=>T.value.customBaseUrl=P),placeholder:"ä¾‹å¦‚: https://api.example.com/v1"},null,512),[[Te,T.value.customBaseUrl]])],512),[[Oe,M.value.aiVisionOcr.provider==="custom_openai_vision"]]),e("div",Ru,[i[34]||(i[34]=e("label",{for:"settingsAiVisionModelName"},"æ¨¡å‹åç§°:",-1)),e("div",Du,[ne(e("input",{type:"text",id:"settingsAiVisionModelName","onUpdate:modelValue":i[13]||(i[13]=P=>T.value.modelName=P),placeholder:"å¦‚: silicon-llava2-34b"},null,512),[[Te,T.value.modelName]]),e("button",{type:"button",class:"fetch-models-btn",title:"è·å–å¯ç”¨æ¨¡å‹åˆ—è¡¨",onClick:W,disabled:V.value},[i[33]||(i[33]=e("span",{class:"fetch-icon"},"ğŸ”",-1)),e("span",Eu,oe(V.value?"è·å–ä¸­...":"è·å–æ¨¡å‹"),1)],8,Mu)]),F.value.length>0?(A(),L("div",Bu,[Ce(Ke,{modelValue:T.value.modelName,"onUpdate:modelValue":i[14]||(i[14]=P=>T.value.modelName=P),options:b.value},null,8,["modelValue","options"]),e("span",Au,"å…± "+oe(F.value.length)+" ä¸ªæ¨¡å‹",1)])):ce("",!0)]),e("div",Lu,[i[36]||(i[36]=e("label",{for:"settingsAiVisionOcrPrompt"},"OCRæç¤ºè¯:",-1)),ne(e("textarea",{id:"settingsAiVisionOcrPrompt","onUpdate:modelValue":i[15]||(i[15]=P=>T.value.prompt=P),rows:"3",placeholder:"AIè§†è§‰OCRæç¤ºè¯"},null,512),[[Te,T.value.prompt]]),Ce(zt,{"prompt-type":"ai_vision_ocr",onSelect:se}),e("div",Fu,[Ce(Ke,{"model-value":M.value.aiVisionOcr.isJsonMode?"true":"false",options:a,onChange:i[16]||(i[16]=P=>{M.value.aiVisionOcr.isJsonMode=P==="true",j()})},null,8,["model-value"]),i[35]||(i[35]=e("span",{class:"input-hint"},"JSONæ ¼å¼è¾“å‡ºæ›´ç»“æ„åŒ–",-1))])]),e("div",Uu,[i[37]||(i[37]=e("label",{for:"settingsRpmAiVisionOcr"},"RPMé™åˆ¶ (æ¯åˆ†é’Ÿè¯·æ±‚æ•°):",-1)),ne(e("input",{type:"number",id:"settingsRpmAiVisionOcr","onUpdate:modelValue":i[17]||(i[17]=P=>T.value.rpmLimit=P),min:"0",step:"1"},null,512),[[Te,T.value.rpmLimit,void 0,{number:!0}]]),i[38]||(i[38]=e("div",{class:"input-hint"},"0 è¡¨ç¤ºæ— é™åˆ¶",-1))]),e("div",Ou,[i[39]||(i[39]=e("label",{for:"settingsMinImageSize"},"æœ€å°å›¾ç‰‡å°ºå¯¸ (åƒç´ ):",-1)),ne(e("input",{type:"number",id:"settingsMinImageSize","onUpdate:modelValue":i[18]||(i[18]=P=>T.value.minImageSize=P),min:"0",step:"1"},null,512),[[Te,T.value.minImageSize,void 0,{number:!0}]]),i[40]||(i[40]=e("div",{class:"input-hint"},"VLMæ¨¡å‹é€šå¸¸è¦æ±‚å›¾ç‰‡å°ºå¯¸ â‰¥28pxï¼Œè®¾ä¸º0åˆ™ä¸è‡ªåŠ¨æ”¾å¤§å°å›¾",-1))]),e("button",{class:"settings-test-btn",onClick:Q,disabled:H.value},oe(H.value?"æµ‹è¯•ä¸­...":"ğŸ”— æµ‹è¯•è¿æ¥"),9,zu)],512),[[Oe,M.value.ocrEngine==="ai_vision"]])]))}}),Vu=He(Nu,[["__scopeId","data-v-03445600"]]),Wu={class:"translation-settings"},Ku={class:"settings-group"},qu={class:"settings-row"},Hu={class:"settings-item"},ju={class:"settings-item"},Ju={for:"settingsApiKey"},Yu={class:"password-input-wrapper"},Xu=["type","placeholder"],Gu={key:0,class:"eye-icon"},Zu={key:1,class:"eye-off-icon"},Qu={class:"settings-item"},ec={class:"settings-item"},tc={for:"settingsModelName"},oc={class:"model-input-with-fetch"},nc=["placeholder"],sc=["disabled"],ac={class:"fetch-text"},lc={key:0,class:"model-select-container"},ic={class:"model-count"},rc={class:"settings-item"},uc={class:"model-input-with-fetch"},cc=["placeholder"],dc=["disabled"],gc={class:"fetch-text"},pc={key:0,class:"model-select-container"},mc={class:"model-count"},vc={class:"settings-row"},fc={class:"settings-item"},bc={class:"settings-item"},hc={class:"settings-item"},xc={class:"input-hint translation-mode-hint"},yc={key:0},_c={key:1},Cc={key:0,class:"input-hint sakura-suggestion"},Sc={class:"settings-item"},kc=["disabled"],wc={class:"settings-item"},$c=["disabled"],Tc={class:"settings-group"},Ic={class:"settings-item"},Pc={class:"prompt-format-selector"},Rc={class:"settings-item"},Dc={class:"checkbox-label"},Mc={class:"settings-item"},Ec=je({__name:"TranslationSettings",setup(n){const t=[{label:"SiliconFlow",value:"siliconflow"},{label:"DeepSeek",value:"deepseek"},{label:"ç«å±±å¼•æ“",value:"volcano"},{label:"å½©äº‘å°è¯‘",value:"caiyun"},{label:"ç™¾åº¦ç¿»è¯‘",value:"baidu_translate"},{label:"æœ‰é“ç¿»è¯‘",value:"youdao_translate"},{label:"Google Gemini",value:"gemini"},{label:"Ollama (æœ¬åœ°)",value:"ollama"},{label:"Sakura (æœ¬åœ°)",value:"sakura"},{label:"è‡ªå®šä¹‰ OpenAI å…¼å®¹æœåŠ¡",value:"custom_openai"}],s=[{label:"æ™®é€šæç¤ºè¯",value:"normal"},{label:"JSONæç¤ºè¯",value:"json"}],o=[{label:"æ•´é¡µæ‰¹é‡ç¿»è¯‘ (æ¨è)",value:"batch"},{label:"é€æ°”æ³¡ç¿»è¯‘ (é€‚åˆå°æ¨¡å‹)",value:"single"}],l=ze(),u=ct(),a=l.settings.translation.translationMode||"batch",c=l.settings.translation.isJsonMode||!1,m=()=>{const g=l.settings.translation;return a==="single"?c?g.singleJsonPrompt:g.singleNormalPrompt:c?g.batchJsonPrompt:g.batchNormalPrompt},p=w({modelProvider:l.settings.translation.provider,apiKey:l.settings.translation.apiKey,modelName:l.settings.translation.modelName,customBaseUrl:l.settings.translation.customBaseUrl,rpmTranslation:l.settings.translation.rpmLimit,translationMaxRetries:l.settings.translation.maxRetries,translationMode:a,promptContent:m(),translatePromptMode:c?"json":"normal",enableTextboxPrompt:l.settings.useTextboxPrompt,textboxPromptContent:l.settings.textboxPrompt}),_=w(!1),T=w(!1),M=w(!1),R=w([]),I=w([]),E=X(()=>{const g=[{label:"-- é€‰æ‹©æ¨¡å‹ --",value:""}];return R.value.forEach(f=>g.push({label:f,value:f})),g}),H=X(()=>{const g=[{label:"-- é€‰æ‹©æ¨¡å‹ --",value:""}];return I.value.forEach(f=>g.push({label:f,value:f})),g}),V=X(()=>["ollama","sakura"].includes(p.value.modelProvider)),F=X(()=>!["ollama","sakura","caiyun","baidu_translate","youdao_translate"].includes(p.value.modelProvider)),b=X(()=>["siliconflow","deepseek","volcano","gemini","custom_openai"].includes(p.value.modelProvider)),v=X(()=>{switch(p.value.modelProvider){case"baidu_translate":return"App ID";case"youdao_translate":return"App Key";case"caiyun":return"API Token";default:return"API Key"}}),k=X(()=>{switch(p.value.modelProvider){case"baidu_translate":return"è¯·è¾“å…¥ç™¾åº¦ç¿»è¯‘App ID";case"youdao_translate":return"è¯·è¾“å…¥æœ‰é“ç¿»è¯‘åº”ç”¨ID";case"caiyun":return"è¯·è¾“å…¥å½©äº‘å°è¯‘Token";default:return"è¯·è¾“å…¥API Key"}}),$=X(()=>{switch(p.value.modelProvider){case"baidu_translate":return"App Key";case"youdao_translate":return"App Secret";case"caiyun":return"æºè¯­è¨€ (å¯é€‰)";default:return"æ¨¡å‹åç§°"}}),N=X(()=>{switch(p.value.modelProvider){case"baidu_translate":return"è¯·è¾“å…¥ç™¾åº¦ç¿»è¯‘App Key";case"youdao_translate":return"è¯·è¾“å…¥æœ‰é“ç¿»è¯‘åº”ç”¨å¯†é’¥";case"caiyun":return"å¯é€‰: auto/æ—¥è¯­/è‹±è¯­";default:return"è¯·è¾“å…¥æ¨¡å‹åç§°"}});function z(){const g=p.value.modelProvider;l.setTranslationProvider(g),p.value.apiKey=l.settings.translation.apiKey,p.value.modelName=l.settings.translation.modelName,p.value.customBaseUrl=l.settings.translation.customBaseUrl,p.value.rpmTranslation=l.settings.translation.rpmLimit,p.value.translationMaxRetries=l.settings.translation.maxRetries,p.value.translationMode=l.settings.translation.translationMode||"batch",R.value=[],I.value=[]}function ae(){const g=p.value.translatePromptMode==="json",f=!g,x=p.value.translationMode==="single";x?f?l.updateTranslationService({singleJsonPrompt:p.value.promptContent}):l.updateTranslationService({singleNormalPrompt:p.value.promptContent}):f?l.updateTranslationService({batchJsonPrompt:p.value.promptContent}):l.updateTranslationService({batchNormalPrompt:p.value.promptContent});const h=l.settings.translation;let D;x?D=g?h.singleJsonPrompt:h.singleNormalPrompt:D=g?h.batchJsonPrompt:h.batchNormalPrompt,p.value.promptContent=D,l.updateTranslationService({isJsonMode:g}),l.setTranslatePrompt(D)}function j(g){const f=String(g),x=p.value.translationMode,h=p.value.translatePromptMode==="json";if(f===x)return;x==="batch"?h?l.updateTranslationService({batchJsonPrompt:p.value.promptContent}):l.updateTranslationService({batchNormalPrompt:p.value.promptContent}):h?l.updateTranslationService({singleJsonPrompt:p.value.promptContent}):l.updateTranslationService({singleNormalPrompt:p.value.promptContent}),p.value.translationMode=f,l.updateTranslationService({translationMode:f});const D=l.settings.translation;let Y;f==="single"?Y=h?D.singleJsonPrompt:D.singleNormalPrompt:Y=h?D.batchJsonPrompt:D.batchNormalPrompt,p.value.promptContent=Y,l.setTranslatePrompt(Y),console.log(`ç¿»è¯‘æ¨¡å¼å·²åˆ‡æ¢ä¸º: ${f==="batch"?"æ•´é¡µæ‰¹é‡ç¿»è¯‘":"é€æ°”æ³¡ç¿»è¯‘"}`)}Se(()=>p.value.apiKey,g=>{l.updateTranslationService({apiKey:g})}),Se(()=>p.value.modelName,g=>{l.updateTranslationService({modelName:g})}),Se(()=>p.value.customBaseUrl,g=>{l.updateTranslationService({customBaseUrl:g})}),Se(()=>p.value.rpmTranslation,g=>{l.updateTranslationService({rpmLimit:g})}),Se(()=>p.value.translationMaxRetries,g=>{l.updateTranslationService({maxRetries:g})}),Se(()=>p.value.promptContent,g=>{l.setTranslatePrompt(g);const f=p.value.translationMode==="batch",x=p.value.translatePromptMode==="json";f?x?l.updateTranslationService({batchJsonPrompt:g}):l.updateTranslationService({batchNormalPrompt:g}):x?l.updateTranslationService({singleJsonPrompt:g}):l.updateTranslationService({singleNormalPrompt:g})}),Se(()=>p.value.enableTextboxPrompt,g=>{l.setUseTextboxPrompt(g)}),Se(()=>p.value.textboxPromptContent,g=>{l.setTextboxPrompt(g)});async function q(){const g=p.value.modelProvider,f=p.value.apiKey?.trim(),x=p.value.customBaseUrl?.trim();if(!f){u.warning("è¯·å…ˆå¡«å†™ API Key");return}if(!["siliconflow","deepseek","volcano","gemini","custom_openai"].includes(g)){u.warning(`${Q(g)} ä¸æ”¯æŒè‡ªåŠ¨è·å–æ¨¡å‹åˆ—è¡¨`);return}if(g==="custom_openai"&&!x){u.warning("è‡ªå®šä¹‰æœåŠ¡éœ€è¦å…ˆå¡«å†™ Base URL");return}M.value=!0;try{const D=await qe.fetchModels(g,f,x);D.success&&D.models&&D.models.length>0?(R.value=D.models.map(Y=>Y.id),u.success(`è·å–åˆ° ${D.models.length} ä¸ªæ¨¡å‹`)):u.warning(D.message||"æœªè·å–åˆ°å¯ç”¨æ¨¡å‹")}catch(D){const Y=D instanceof Error?D.message:"è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥";u.error(Y)}finally{M.value=!1}}function Q(g){return{siliconflow:"SiliconFlow",deepseek:"DeepSeek",volcano:"ç«å±±å¼•æ“",gemini:"Google Gemini",custom_openai:"è‡ªå®šä¹‰OpenAI",ollama:"Ollama",sakura:"Sakura",caiyun:"å½©äº‘å°è¯‘",baidu_translate:"ç™¾åº¦ç¿»è¯‘",youdao_translate:"æœ‰é“ç¿»è¯‘"}[g]||g}async function W(){const g=p.value.modelProvider;M.value=!0;try{let f;if(g==="ollama")f=await qe.testOllamaConnection();else if(g==="sakura")f=await qe.testSakuraConnection();else{u.error("æœªé€‰æ‹©æœ¬åœ°æœåŠ¡å•†");return}f.success&&f.models?(I.value=f.models,u.success(`è·å–åˆ° ${f.models.length} ä¸ª${g==="ollama"?"Ollama":"Sakura"}æ¨¡å‹`)):u.error(f.error||`${g==="ollama"?"Ollama":"Sakura"}è¿æ¥å¤±è´¥`)}catch(f){const x=f instanceof Error?f.message:"è·å–æœ¬åœ°æ¨¡å‹å¤±è´¥";u.error(x)}finally{M.value=!1}}async function se(){T.value=!0;try{let g;p.value.modelProvider==="ollama"?g=await qe.testOllamaConnection():g=await qe.testSakuraConnection(),g.success?u.success(`${p.value.modelProvider==="ollama"?"Ollama":"Sakura"} è¿æ¥æˆåŠŸ`):u.error(g.error||"è¿æ¥å¤±è´¥")}catch(g){const f=g instanceof Error?g.message:"è¿æ¥æµ‹è¯•å¤±è´¥";u.error(f)}finally{T.value=!1}}async function S(){const g=p.value.modelProvider,f=p.value.apiKey?.trim(),x=p.value.modelName?.trim(),h=p.value.customBaseUrl?.trim();if(!f){u.warning("è¯·å…ˆå¡«å†™ API Key");return}if(g!=="caiyun"&&!x){u.warning("è¯·å¡«å†™æ¨¡å‹åç§°");return}if(g==="custom_openai"&&!h){u.warning("è‡ªå®šä¹‰æœåŠ¡éœ€è¦å¡«å†™ Base URL");return}T.value=!0,u.info("æ­£åœ¨æµ‹è¯•è¿æ¥...");try{let D;switch(g){case"baidu_translate":D=await qe.testBaiduTranslateConnection(f,x);break;case"youdao_translate":D=await qe.testYoudaoTranslateConnection(f,x);break;default:D=await qe.testAiTranslateConnection({provider:g,apiKey:f,modelName:x,baseUrl:h})}D.success?u.success(D.message||`${Q(g)} è¿æ¥æˆåŠŸ!`):u.error(D.message||D.error||"è¿æ¥å¤±è´¥")}catch(D){const Y=D instanceof Error?D.message:"è¿æ¥æµ‹è¯•å¤±è´¥";u.error(Y)}finally{T.value=!1}}function i(g,f){p.value.promptContent=g,u.success(`å·²åº”ç”¨æç¤ºè¯: ${f}`)}function P(g,f){p.value.textboxPromptContent=g,u.success(`å·²åº”ç”¨æç¤ºè¯: ${f}`)}function d(){const g=p.value.translatePromptMode==="json";p.value.translationMode==="single"?p.value.promptContent=g?hs:xs:p.value.promptContent=g?ys:_s,u.success("å·²é‡ç½®ä¸ºé»˜è®¤æç¤ºè¯")}return(g,f)=>(A(),L("div",Wu,[e("div",Ku,[f[23]||(f[23]=e("div",{class:"settings-group-title"},"ç¿»è¯‘æœåŠ¡é…ç½®",-1)),e("div",qu,[e("div",Hu,[f[14]||(f[14]=e("label",{for:"settingsModelProvider"},"ç¿»è¯‘æœåŠ¡å•†:",-1)),Ce(Ke,{"model-value":p.value.modelProvider,options:t,onChange:f[0]||(f[0]=x=>{p.value.modelProvider=x,z()})},null,8,["model-value"])]),ne(e("div",ju,[e("label",Ju,oe(v.value)+":",1),e("div",Yu,[ne(e("input",{type:_.value?"text":"password",id:"settingsApiKey","onUpdate:modelValue":f[1]||(f[1]=x=>p.value.apiKey=x),class:"secure-input",placeholder:k.value,autocomplete:"off"},null,8,Xu),[[$t,p.value.apiKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:f[2]||(f[2]=x=>_.value=!_.value)},[_.value?(A(),L("span",Zu,"ğŸ‘â€ğŸ—¨")):(A(),L("span",Gu,"ğŸ‘"))])])],512),[[Oe,!V.value]])]),ne(e("div",Qu,[f[15]||(f[15]=e("label",{for:"settingsCustomBaseUrl"},"Base URL:",-1)),ne(e("input",{type:"text",id:"settingsCustomBaseUrl","onUpdate:modelValue":f[3]||(f[3]=x=>p.value.customBaseUrl=x),placeholder:"ä¾‹å¦‚: https://api.example.com/v1"},null,512),[[Te,p.value.customBaseUrl]])],512),[[Oe,p.value.modelProvider==="custom_openai"]]),ne(e("div",ec,[e("label",tc,oe($.value)+":",1),e("div",oc,[ne(e("input",{type:"text",id:"settingsModelName","onUpdate:modelValue":f[4]||(f[4]=x=>p.value.modelName=x),placeholder:N.value},null,8,nc),[[Te,p.value.modelName]]),ne(e("button",{type:"button",class:"fetch-models-btn",title:"è·å–å¯ç”¨æ¨¡å‹åˆ—è¡¨",onClick:q,disabled:M.value},[f[16]||(f[16]=e("span",{class:"fetch-icon"},"ğŸ”",-1)),e("span",ac,oe(M.value?"è·å–ä¸­...":"è·å–æ¨¡å‹"),1)],8,sc),[[Oe,b.value]])]),R.value.length>0?(A(),L("div",lc,[Ce(Ke,{"model-value":p.value.modelName,options:E.value,onChange:f[5]||(f[5]=x=>{p.value.modelName=x})},null,8,["model-value","options"]),e("span",ic,"å…± "+oe(R.value.length)+" ä¸ªæ¨¡å‹",1)])):ce("",!0)],512),[[Oe,!V.value]]),ne(e("div",rc,[f[18]||(f[18]=e("label",{for:"settingsLocalModelName"},"æ¨¡å‹åç§°:",-1)),e("div",uc,[ne(e("input",{type:"text",id:"settingsLocalModelName","onUpdate:modelValue":f[6]||(f[6]=x=>p.value.modelName=x),placeholder:p.value.modelProvider==="ollama"?"ä¾‹å¦‚: qwen2.5:7b":"ä¾‹å¦‚: sakura-14b-qwen2.5-v1.0"},null,8,cc),[[Te,p.value.modelName]]),e("button",{type:"button",class:"fetch-models-btn",title:"è·å–æœ¬åœ°å¯ç”¨æ¨¡å‹åˆ—è¡¨",onClick:W,disabled:M.value},[f[17]||(f[17]=e("span",{class:"fetch-icon"},"ğŸ”",-1)),e("span",gc,oe(M.value?"è·å–ä¸­...":"è·å–æ¨¡å‹"),1)],8,dc)]),I.value.length>0?(A(),L("div",pc,[Ce(Ke,{"model-value":p.value.modelName,options:H.value,onChange:f[7]||(f[7]=x=>p.value.modelName=x)},null,8,["model-value","options"]),e("span",mc,"å…± "+oe(I.value.length)+" ä¸ªæ¨¡å‹",1)])):ce("",!0)],512),[[Oe,V.value]]),ne(e("div",vc,[e("div",fc,[f[19]||(f[19]=e("label",{for:"settingsRpmTranslation"},"RPMé™åˆ¶:",-1)),ne(e("input",{type:"number",id:"settingsRpmTranslation","onUpdate:modelValue":f[8]||(f[8]=x=>p.value.rpmTranslation=x),min:"0",step:"1"},null,512),[[Te,p.value.rpmTranslation,void 0,{number:!0}]]),f[20]||(f[20]=e("div",{class:"input-hint"},"æ¯åˆ†é’Ÿè¯·æ±‚æ•°ï¼Œ0è¡¨ç¤ºæ— é™åˆ¶",-1))]),e("div",bc,[f[21]||(f[21]=e("label",{for:"settingsTranslationMaxRetries"},"é‡è¯•æ¬¡æ•°:",-1)),ne(e("input",{type:"number",id:"settingsTranslationMaxRetries","onUpdate:modelValue":f[9]||(f[9]=x=>p.value.translationMaxRetries=x),min:"0",max:"10",step:"1"},null,512),[[Te,p.value.translationMaxRetries,void 0,{number:!0}]])])],512),[[Oe,F.value]]),e("div",hc,[f[22]||(f[22]=e("label",{for:"settingsTranslationMode"},"ç¿»è¯‘æ¨¡å¼:",-1)),Ce(Ke,{"model-value":p.value.translationMode,options:o,onChange:j},null,8,["model-value"]),e("div",xc,[p.value.translationMode==="batch"?(A(),L("span",yc," ğŸ’¡ æ•´é¡µæ‰¹é‡ç¿»è¯‘ï¼šä¸€æ¬¡å‘é€å…¨éƒ¨æ°”æ³¡ï¼Œæ•ˆç‡é«˜ï¼Œéœ€è¦æ¨¡å‹æ”¯æŒå¤æ‚æŒ‡ä»¤ ")):(A(),L("span",_c," ğŸ’¡ é€æ°”æ³¡ç¿»è¯‘ï¼šæ¯ä¸ªæ°”æ³¡å•ç‹¬ç¿»è¯‘ï¼Œæ›´ç¨³å®šï¼Œé€‚åˆå°æ¨¡å‹æˆ–æ ¼å¼æ•æ„Ÿåœºæ™¯ "))]),p.value.modelProvider==="sakura"?(A(),L("div",Cc,' âš ï¸ å»ºè®® Sakura æœåŠ¡ä½¿ç”¨"é€æ°”æ³¡ç¿»è¯‘"æ¨¡å¼ï¼Œå¯è·å¾—æ›´ç¨³å®šçš„ç¿»è¯‘æ•ˆæœ ')):ce("",!0)]),ne(e("div",Sc,[e("button",{class:"settings-test-btn",onClick:se,disabled:T.value},oe(T.value?"æµ‹è¯•ä¸­...":"ğŸ”— æµ‹è¯•è¿æ¥"),9,kc)],512),[[Oe,V.value]]),ne(e("div",wc,[e("button",{class:"settings-test-btn",onClick:S,disabled:T.value},oe(T.value?"æµ‹è¯•ä¸­...":"ğŸ”— æµ‹è¯•è¿æ¥"),9,$c)],512),[[Oe,!V.value]])]),e("div",Tc,[f[28]||(f[28]=e("div",{class:"settings-group-title"},"æç¤ºè¯è®¾ç½®",-1)),e("div",Ic,[f[25]||(f[25]=e("label",{for:"settingsPromptContent"},"ç¿»è¯‘æç¤ºè¯:",-1)),ne(e("textarea",{id:"settingsPromptContent","onUpdate:modelValue":f[10]||(f[10]=x=>p.value.promptContent=x),rows:"4",placeholder:"ç¿»è¯‘æç¤ºè¯"},null,512),[[Te,p.value.promptContent]]),e("div",Pc,[Ce(Ke,{"model-value":p.value.translatePromptMode,options:s,onChange:f[11]||(f[11]=x=>{p.value.translatePromptMode=x,ae()})},null,8,["model-value"]),f[24]||(f[24]=e("span",{class:"input-hint"},"JSONæ ¼å¼è¾“å‡ºæ›´ç»“æ„åŒ–",-1))]),Ce(zt,{"prompt-type":"translate",onSelect:i}),e("button",{type:"button",class:"reset-btn",onClick:d}," é‡ç½®ä¸ºé»˜è®¤ ")]),e("div",Rc,[e("label",Dc,[ne(e("input",{type:"checkbox","onUpdate:modelValue":f[12]||(f[12]=x=>p.value.enableTextboxPrompt=x)},null,512),[[Qe,p.value.enableTextboxPrompt]]),f[26]||(f[26]=me(" å¯ç”¨æ–‡æœ¬æ¡†æç¤ºè¯ ",-1))])]),ne(e("div",Mc,[f[27]||(f[27]=e("label",{for:"settingsTextboxPromptContent"},"æ–‡æœ¬æ¡†æç¤ºè¯:",-1)),ne(e("textarea",{id:"settingsTextboxPromptContent","onUpdate:modelValue":f[13]||(f[13]=x=>p.value.textboxPromptContent=x),rows:"3",placeholder:"æ–‡æœ¬æ¡†æç¤ºè¯"},null,512),[[Te,p.value.textboxPromptContent]]),Ce(zt,{"prompt-type":"textbox",onSelect:P})],512),[[Oe,p.value.enableTextboxPrompt]])])]))}}),Bc=He(Ec,[["__scopeId","data-v-7c76de5c"]]),Ac={class:"detection-settings"},Lc={class:"settings-group"},Fc={class:"settings-item"},Uc={class:"settings-group"},Oc={class:"settings-item"},zc={class:"settings-row"},Nc={class:"settings-item"},Vc={class:"settings-item"},Wc={class:"settings-row"},Kc={class:"settings-item"},qc={class:"settings-item"},Hc={class:"settings-group"},jc={class:"settings-item"},Jc={class:"checkbox-label"},Yc={class:"settings-row"},Xc={class:"settings-item"},Gc={class:"settings-item"},Zc={class:"settings-group"},Qc={class:"settings-item"},ed={class:"checkbox-label"},td=je({__name:"DetectionSettings",setup(n){const t=[{label:"CTD (Comic Text Detector)",value:"ctd"},{label:"YOLO",value:"yolo"},{label:"YOLOv5",value:"yolov5"},{label:"Default (DBNet)",value:"default"}],s=ze(),o=yo({textDetector:s.settings.textDetector,boxExpandRatio:s.settings.boxExpand.ratio,boxExpandTop:s.settings.boxExpand.top,boxExpandBottom:s.settings.boxExpand.bottom,boxExpandLeft:s.settings.boxExpand.left,boxExpandRight:s.settings.boxExpand.right,usePreciseMask:s.settings.preciseMask.enabled,maskDilateSize:s.settings.preciseMask.dilateSize,maskBoxExpandRatio:s.settings.preciseMask.boxExpandRatio,showDetectionDebug:s.settings.showDetectionDebug}),l=X(()=>["ctd","default"].includes(o.textDetector));Se(()=>o.textDetector,a=>{s.setTextDetector(a)}),Se(()=>o.boxExpandRatio,a=>{s.updateBoxExpand({ratio:a})}),Se(()=>o.boxExpandTop,a=>{s.updateBoxExpand({top:a})}),Se(()=>o.boxExpandBottom,a=>{s.updateBoxExpand({bottom:a})}),Se(()=>o.boxExpandLeft,a=>{s.updateBoxExpand({left:a})}),Se(()=>o.boxExpandRight,a=>{s.updateBoxExpand({right:a})}),Se(()=>o.usePreciseMask,a=>{s.updatePreciseMask({enabled:a})}),Se(()=>o.maskDilateSize,a=>{s.updatePreciseMask({dilateSize:a})}),Se(()=>o.maskBoxExpandRatio,a=>{s.updatePreciseMask({boxExpandRatio:a})}),Se(()=>o.showDetectionDebug,a=>{s.setShowDetectionDebug(a)});function u(){l.value||(o.usePreciseMask=!1)}return(a,c)=>(A(),L("div",Ac,[e("div",Lc,[c[11]||(c[11]=e("div",{class:"settings-group-title"},"æ–‡å­—æ£€æµ‹å™¨",-1)),e("div",Fc,[c[10]||(c[10]=e("label",{for:"settingsTextDetector"},"æ£€æµ‹å™¨ç±»å‹:",-1)),Ce(Ke,{modelValue:o.textDetector,"onUpdate:modelValue":c[0]||(c[0]=m=>o.textDetector=m),options:t,onChange:u},null,8,["modelValue"])])]),e("div",Uc,[c[18]||(c[18]=e("div",{class:"settings-group-title"},"æ–‡æœ¬æ¡†æ‰©å±•å‚æ•°",-1)),e("div",Oc,[c[12]||(c[12]=e("label",{for:"settingsBoxExpandRatio"},"æ•´ä½“æ‰©å±• (%):",-1)),ne(e("input",{type:"number",id:"settingsBoxExpandRatio","onUpdate:modelValue":c[1]||(c[1]=m=>o.boxExpandRatio=m),min:"0",max:"50",step:"1"},null,512),[[Te,o.boxExpandRatio,void 0,{number:!0}]]),c[13]||(c[13]=e("div",{class:"input-hint"},"å‘å››å‘¨å‡åŒ€æ‰©å±•çš„ç™¾åˆ†æ¯” (0-50%)",-1))]),e("div",zc,[e("div",Nc,[c[14]||(c[14]=e("label",{for:"settingsBoxExpandTop"},"ä¸Šæ–¹æ‰©å±• (%):",-1)),ne(e("input",{type:"number",id:"settingsBoxExpandTop","onUpdate:modelValue":c[2]||(c[2]=m=>o.boxExpandTop=m),min:"0",max:"50",step:"1"},null,512),[[Te,o.boxExpandTop,void 0,{number:!0}]])]),e("div",Vc,[c[15]||(c[15]=e("label",{for:"settingsBoxExpandBottom"},"ä¸‹æ–¹æ‰©å±• (%):",-1)),ne(e("input",{type:"number",id:"settingsBoxExpandBottom","onUpdate:modelValue":c[3]||(c[3]=m=>o.boxExpandBottom=m),min:"0",max:"50",step:"1"},null,512),[[Te,o.boxExpandBottom,void 0,{number:!0}]])])]),e("div",Wc,[e("div",Kc,[c[16]||(c[16]=e("label",{for:"settingsBoxExpandLeft"},"å·¦ä¾§æ‰©å±• (%):",-1)),ne(e("input",{type:"number",id:"settingsBoxExpandLeft","onUpdate:modelValue":c[4]||(c[4]=m=>o.boxExpandLeft=m),min:"0",max:"50",step:"1"},null,512),[[Te,o.boxExpandLeft,void 0,{number:!0}]])]),e("div",qc,[c[17]||(c[17]=e("label",{for:"settingsBoxExpandRight"},"å³ä¾§æ‰©å±• (%):",-1)),ne(e("input",{type:"number",id:"settingsBoxExpandRight","onUpdate:modelValue":c[5]||(c[5]=m=>o.boxExpandRight=m),min:"0",max:"50",step:"1"},null,512),[[Te,o.boxExpandRight,void 0,{number:!0}]])])])]),ne(e("div",Hc,[c[25]||(c[25]=e("div",{class:"settings-group-title"},"ç²¾ç¡®æ–‡å­—æ©è†œ",-1)),e("div",jc,[e("label",Jc,[ne(e("input",{type:"checkbox","onUpdate:modelValue":c[6]||(c[6]=m=>o.usePreciseMask=m)},null,512),[[Qe,o.usePreciseMask]]),c[19]||(c[19]=me(" å¯ç”¨ç²¾ç¡®æ–‡å­—æ©è†œ ",-1))]),c[20]||(c[20]=e("div",{class:"input-hint"},"ä½¿ç”¨æ›´ç²¾ç¡®çš„æ–‡å­—åŒºåŸŸæ©è†œè¿›è¡Œä¿®å¤",-1))]),ne(e("div",Yc,[e("div",Xc,[c[21]||(c[21]=e("label",{for:"settingsMaskDilateSize"},"è†¨èƒ€å¤§å°:",-1)),ne(e("input",{type:"number",id:"settingsMaskDilateSize","onUpdate:modelValue":c[7]||(c[7]=m=>o.maskDilateSize=m),min:"0",step:"1"},null,512),[[Te,o.maskDilateSize,void 0,{number:!0}]]),c[22]||(c[22]=e("div",{class:"input-hint"},"æ©è†œè†¨èƒ€åƒç´ æ•°",-1))]),e("div",Gc,[c[23]||(c[23]=e("label",{for:"settingsMaskBoxExpandRatio"},"æ ‡æ³¨æ¡†æ‰©å¤§æ¯”ä¾‹ (%):",-1)),ne(e("input",{type:"number",id:"settingsMaskBoxExpandRatio","onUpdate:modelValue":c[8]||(c[8]=m=>o.maskBoxExpandRatio=m),min:"0",max:"100",step:"1"},null,512),[[Te,o.maskBoxExpandRatio,void 0,{number:!0}]]),c[24]||(c[24]=e("div",{class:"input-hint"},"æ ‡æ³¨æ¡†åŒºåŸŸæ‰©å¤§ç™¾åˆ†æ¯”",-1))])],512),[[Oe,o.usePreciseMask]])],512),[[Oe,l.value]]),e("div",Zc,[c[28]||(c[28]=e("div",{class:"settings-group-title"},"è°ƒè¯•é€‰é¡¹",-1)),e("div",Qc,[e("label",ed,[ne(e("input",{type:"checkbox","onUpdate:modelValue":c[9]||(c[9]=m=>o.showDetectionDebug=m)},null,512),[[Qe,o.showDetectionDebug]]),c[26]||(c[26]=me(" æ˜¾ç¤ºæ£€æµ‹æ¡†è°ƒè¯•ä¿¡æ¯ ",-1))]),c[27]||(c[27]=e("div",{class:"input-hint"},"åœ¨ç¿»è¯‘ç»“æœä¸­æ˜¾ç¤ºæ°”æ³¡æ£€æµ‹æ¡†ï¼Œç”¨äºè°ƒè¯•",-1))])])]))}}),od=He(td,[["__scopeId","data-v-c12c43ee"]]),nd={class:"hq-translation-settings"},sd={class:"settings-group"},ad={class:"settings-row"},ld={class:"settings-item"},id={class:"settings-item"},rd={class:"password-input-wrapper"},ud=["type"],cd={key:0,class:"eye-icon"},dd={key:1,class:"eye-off-icon"},gd={class:"settings-item"},pd={class:"settings-item"},md={class:"model-input-with-fetch"},vd=["disabled"],fd={class:"fetch-text"},bd={key:0,class:"model-select-container"},hd={class:"model-count"},xd={class:"settings-item"},yd=["disabled"],_d={class:"settings-group"},Cd={class:"settings-row"},Sd={class:"settings-item"},kd={class:"settings-item"},wd={class:"settings-row"},$d={class:"settings-item"},Td={class:"settings-item"},Id={class:"settings-group"},Pd={class:"settings-row"},Rd={class:"settings-item"},Dd={class:"checkbox-label"},Md={class:"settings-item"},Ed={class:"settings-row"},Bd={class:"settings-item"},Ad={class:"checkbox-label"},Ld={class:"settings-item"},Fd={class:"checkbox-label"},Ud={class:"settings-group"},Od={class:"settings-item"},zd=je({__name:"HqTranslationSettings",setup(n){const t=[{label:"SiliconFlow",value:"siliconflow"},{label:"DeepSeek",value:"deepseek"},{label:"ç«å±±å¼•æ“",value:"volcano"},{label:"Google Gemini",value:"gemini"},{label:"è‡ªå®šä¹‰ OpenAI å…¼å®¹æœåŠ¡",value:"custom_openai"}],s=[{label:"Geminié£æ ¼ (reasoning_effort=low)",value:"gemini"},{label:"ç«å±±å¼•æ“é£æ ¼ (thinking=null)",value:"volcano"}],o=ze(),l=ct(),u=X(()=>o.settings.hqTranslation),a=w({apiKey:o.settings.hqTranslation.apiKey,modelName:o.settings.hqTranslation.modelName,customBaseUrl:o.settings.hqTranslation.customBaseUrl,batchSize:o.settings.hqTranslation.batchSize,sessionReset:o.settings.hqTranslation.sessionReset,rpmLimit:o.settings.hqTranslation.rpmLimit,maxRetries:o.settings.hqTranslation.maxRetries,lowReasoning:o.settings.hqTranslation.lowReasoning,noThinkingMethod:o.settings.hqTranslation.noThinkingMethod,forceJsonOutput:o.settings.hqTranslation.forceJsonOutput,useStream:o.settings.hqTranslation.useStream,prompt:o.settings.hqTranslation.prompt});Se(()=>a.value.apiKey,b=>{o.updateHqTranslation({apiKey:b})}),Se(()=>a.value.modelName,b=>{o.updateHqTranslation({modelName:b})}),Se(()=>a.value.customBaseUrl,b=>{o.updateHqTranslation({customBaseUrl:b})}),Se(()=>a.value.batchSize,b=>{o.updateHqTranslation({batchSize:b})}),Se(()=>a.value.sessionReset,b=>{o.updateHqTranslation({sessionReset:b})}),Se(()=>a.value.rpmLimit,b=>{o.updateHqTranslation({rpmLimit:b})}),Se(()=>a.value.maxRetries,b=>{o.updateHqTranslation({maxRetries:b})}),Se(()=>a.value.lowReasoning,b=>{o.updateHqTranslation({lowReasoning:b})}),Se(()=>a.value.noThinkingMethod,b=>{o.updateHqTranslation({noThinkingMethod:b})}),Se(()=>a.value.forceJsonOutput,b=>{o.updateHqTranslation({forceJsonOutput:b})}),Se(()=>a.value.useStream,b=>{o.updateHqTranslation({useStream:b})}),Se(()=>a.value.prompt,b=>{o.updateHqTranslation({prompt:b})});const c=w(!1),m=w(!1),p=w([]),_=w(!1),T=X(()=>{const b=[{label:"-- é€‰æ‹©æ¨¡å‹ --",value:""}];return p.value.forEach(v=>b.push({label:v,value:v})),b});function M(b){o.setHqProvider(b),p.value=[],R()}function R(){const b=o.settings.hqTranslation;a.value.apiKey=b.apiKey,a.value.modelName=b.modelName,a.value.customBaseUrl=b.customBaseUrl,a.value.batchSize=b.batchSize,a.value.sessionReset=b.sessionReset,a.value.rpmLimit=b.rpmLimit,a.value.maxRetries=b.maxRetries,a.value.lowReasoning=b.lowReasoning,a.value.noThinkingMethod=b.noThinkingMethod,a.value.forceJsonOutput=b.forceJsonOutput,a.value.useStream=b.useStream,a.value.prompt=b.prompt}function I(b){return{siliconflow:"SiliconFlow",deepseek:"DeepSeek",volcano:"ç«å±±å¼•æ“",gemini:"Google Gemini",custom_openai:"è‡ªå®šä¹‰OpenAI"}[b]||b}async function E(){const b=u.value.provider,v=a.value.apiKey?.trim(),k=a.value.customBaseUrl?.trim();if(!v){l.warning("è¯·å…ˆå¡«å†™ API Key");return}if(!["siliconflow","deepseek","volcano","gemini","custom_openai"].includes(b)){l.warning(`${I(b)} ä¸æ”¯æŒè‡ªåŠ¨è·å–æ¨¡å‹åˆ—è¡¨`);return}if(b==="custom_openai"&&!k){l.warning("è‡ªå®šä¹‰æœåŠ¡éœ€è¦å…ˆå¡«å†™ Base URL");return}m.value=!0;try{const N=await qe.fetchModels(b,v,k);N.success&&N.models&&N.models.length>0?(p.value=N.models.map(z=>z.id),l.success(`è·å–åˆ° ${N.models.length} ä¸ªæ¨¡å‹`)):l.warning(N.message||"æœªè·å–åˆ°å¯ç”¨æ¨¡å‹")}catch(N){const z=N instanceof Error?N.message:"è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥";l.error(z)}finally{m.value=!1}}async function H(){const b=u.value.provider,v=a.value.apiKey?.trim(),k=a.value.modelName?.trim(),$=a.value.customBaseUrl?.trim();if(!v){l.warning("è¯·å…ˆå¡«å†™ API Key");return}if(!k){l.warning("è¯·å¡«å†™æ¨¡å‹åç§°");return}if(b==="custom_openai"&&!$){l.warning("è‡ªå®šä¹‰æœåŠ¡éœ€è¦å¡«å†™ Base URL");return}_.value=!0,l.info("æ­£åœ¨æµ‹è¯•è¿æ¥...");try{const N=await qe.testAiTranslateConnection({provider:b,apiKey:v,modelName:k,baseUrl:$});N.success?l.success(N.message||`${I(b)} è¿æ¥æˆåŠŸ!`):l.error(N.message||N.error||"è¿æ¥å¤±è´¥")}catch(N){const z=N instanceof Error?N.message:"è¿æ¥æµ‹è¯•å¤±è´¥";l.error(z)}finally{_.value=!1}}function V(){o.updateHqTranslation({prompt:Zo}),a.value.prompt=Zo,l.success("å·²é‡ç½®ä¸ºé»˜è®¤æç¤ºè¯")}function F(b,v){o.updateHqTranslation({prompt:b}),a.value.prompt=b,l.success(`å·²åº”ç”¨æç¤ºè¯: ${v}`)}return(b,v)=>(A(),L("div",nd,[e("div",sd,[v[20]||(v[20]=e("div",{class:"settings-group-title"},"é«˜è´¨é‡ç¿»è¯‘æœåŠ¡é…ç½®",-1)),e("div",ad,[e("div",ld,[v[15]||(v[15]=e("label",{for:"settingsHqTranslateProvider"},"æœåŠ¡å•†:",-1)),Ce(Ke,{"model-value":u.value.provider,options:t,onChange:v[0]||(v[0]=k=>M(k))},null,8,["model-value"])]),e("div",id,[v[16]||(v[16]=e("label",{for:"settingsHqApiKey"},"API Key:",-1)),e("div",rd,[ne(e("input",{type:c.value?"text":"password",id:"settingsHqApiKey","onUpdate:modelValue":v[1]||(v[1]=k=>a.value.apiKey=k),class:"secure-input",placeholder:"è¯·è¾“å…¥API Key",autocomplete:"off"},null,8,ud),[[$t,a.value.apiKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:v[2]||(v[2]=k=>c.value=!c.value)},[c.value?(A(),L("span",dd,"ğŸ‘â€ğŸ—¨")):(A(),L("span",cd,"ğŸ‘"))])])])]),ne(e("div",gd,[v[17]||(v[17]=e("label",{for:"settingsHqCustomBaseUrl"},"Base URL:",-1)),ne(e("input",{type:"text",id:"settingsHqCustomBaseUrl","onUpdate:modelValue":v[3]||(v[3]=k=>a.value.customBaseUrl=k),placeholder:"ä¾‹å¦‚: https://api.example.com/v1"},null,512),[[Te,a.value.customBaseUrl]])],512),[[Oe,u.value.provider==="custom_openai"]]),e("div",pd,[v[19]||(v[19]=e("label",{for:"settingsHqModelName"},"æ¨¡å‹åç§°:",-1)),e("div",md,[ne(e("input",{type:"text",id:"settingsHqModelName","onUpdate:modelValue":v[4]||(v[4]=k=>a.value.modelName=k),placeholder:"è¯·è¾“å…¥æ¨¡å‹åç§°"},null,512),[[Te,a.value.modelName]]),e("button",{type:"button",class:"fetch-models-btn",title:"è·å–å¯ç”¨æ¨¡å‹åˆ—è¡¨",onClick:E,disabled:m.value},[v[18]||(v[18]=e("span",{class:"fetch-icon"},"ğŸ”",-1)),e("span",fd,oe(m.value?"è·å–ä¸­...":"è·å–æ¨¡å‹"),1)],8,vd)]),p.value.length>0?(A(),L("div",bd,[Ce(Ke,{modelValue:a.value.modelName,"onUpdate:modelValue":v[5]||(v[5]=k=>a.value.modelName=k),options:T.value},null,8,["modelValue","options"]),e("span",hd,"å…± "+oe(p.value.length)+" ä¸ªæ¨¡å‹",1)])):ce("",!0)]),e("div",xd,[e("button",{class:"settings-test-btn",onClick:H,disabled:_.value},oe(_.value?"æµ‹è¯•ä¸­...":"ğŸ”— æµ‹è¯•è¿æ¥"),9,yd)])]),e("div",_d,[v[28]||(v[28]=e("div",{class:"settings-group-title"},"æ‰¹å¤„ç†è®¾ç½®",-1)),e("div",Cd,[e("div",Sd,[v[21]||(v[21]=e("label",{for:"settingsHqBatchSize"},"æ‰¹æ¬¡å¤§å°:",-1)),ne(e("input",{type:"number",id:"settingsHqBatchSize","onUpdate:modelValue":v[6]||(v[6]=k=>a.value.batchSize=k),min:"1",max:"10",step:"1"},null,512),[[Te,a.value.batchSize,void 0,{number:!0}]]),v[22]||(v[22]=e("div",{class:"input-hint"},"æ¯æ‰¹å¤„ç†çš„å›¾ç‰‡æ•°é‡ (æ¨è3-5å¼ )",-1))]),e("div",kd,[v[23]||(v[23]=e("label",{for:"settingsHqSessionReset"},"ä¼šè¯é‡ç½®é¢‘ç‡:",-1)),ne(e("input",{type:"number",id:"settingsHqSessionReset","onUpdate:modelValue":v[7]||(v[7]=k=>a.value.sessionReset=k),min:"1",step:"1"},null,512),[[Te,a.value.sessionReset,void 0,{number:!0}]]),v[24]||(v[24]=e("div",{class:"input-hint"},"å¤šå°‘æ‰¹æ¬¡åé‡ç½®ä¸Šä¸‹æ–‡",-1))])]),e("div",wd,[e("div",$d,[v[25]||(v[25]=e("label",{for:"settingsHqRpmLimit"},"RPMé™åˆ¶:",-1)),ne(e("input",{type:"number",id:"settingsHqRpmLimit","onUpdate:modelValue":v[8]||(v[8]=k=>a.value.rpmLimit=k),min:"0",step:"1"},null,512),[[Te,a.value.rpmLimit,void 0,{number:!0}]]),v[26]||(v[26]=e("div",{class:"input-hint"},"æ¯åˆ†é’Ÿè¯·æ±‚æ•°ï¼Œ0è¡¨ç¤ºæ— é™åˆ¶",-1))]),e("div",Td,[v[27]||(v[27]=e("label",{for:"settingsHqMaxRetries"},"é‡è¯•æ¬¡æ•°:",-1)),ne(e("input",{type:"number",id:"settingsHqMaxRetries","onUpdate:modelValue":v[9]||(v[9]=k=>a.value.maxRetries=k),min:"0",max:"10",step:"1"},null,512),[[Te,a.value.maxRetries,void 0,{number:!0}]])])])]),e("div",Id,[v[36]||(v[36]=e("div",{class:"settings-group-title"},"é«˜çº§é€‰é¡¹",-1)),e("div",Pd,[e("div",Rd,[e("label",Dd,[ne(e("input",{type:"checkbox","onUpdate:modelValue":v[10]||(v[10]=k=>a.value.lowReasoning=k)},null,512),[[Qe,a.value.lowReasoning]]),v[29]||(v[29]=me(" ä½æ¨ç†æ¨¡å¼ ",-1))]),v[30]||(v[30]=e("div",{class:"input-hint"},"å‡å°‘æ¨¡å‹æ¨ç†æ·±åº¦ï¼Œæé«˜é€Ÿåº¦",-1))]),e("div",Md,[v[31]||(v[31]=e("label",{for:"settingsHqNoThinkingMethod"},"å–æ¶ˆæ€è€ƒæ–¹æ³•:",-1)),Ce(Ke,{modelValue:a.value.noThinkingMethod,"onUpdate:modelValue":v[11]||(v[11]=k=>a.value.noThinkingMethod=k),options:s},null,8,["modelValue"])])]),e("div",Ed,[e("div",Bd,[e("label",Ad,[ne(e("input",{type:"checkbox","onUpdate:modelValue":v[12]||(v[12]=k=>a.value.forceJsonOutput=k)},null,512),[[Qe,a.value.forceJsonOutput]]),v[32]||(v[32]=me(" å¼ºåˆ¶JSONè¾“å‡º ",-1))]),v[33]||(v[33]=e("div",{class:"input-hint"},"ä½¿ç”¨ response_format: json_object",-1))]),e("div",Ld,[e("label",Fd,[ne(e("input",{type:"checkbox","onUpdate:modelValue":v[13]||(v[13]=k=>a.value.useStream=k)},null,512),[[Qe,a.value.useStream]]),v[34]||(v[34]=me(" æµå¼è°ƒç”¨ ",-1))]),v[35]||(v[35]=e("div",{class:"input-hint"},"ä½¿ç”¨æµå¼APIè°ƒç”¨",-1))])])]),e("div",Ud,[v[37]||(v[37]=e("div",{class:"settings-group-title"},"é«˜è´¨é‡ç¿»è¯‘æç¤ºè¯",-1)),e("div",Od,[ne(e("textarea",{id:"settingsHqPrompt","onUpdate:modelValue":v[14]||(v[14]=k=>a.value.prompt=k),rows:"6",placeholder:"é«˜è´¨é‡ç¿»è¯‘æç¤ºè¯"},null,512),[[Te,a.value.prompt]]),Ce(zt,{"prompt-type":"hq_translate",onSelect:F}),e("button",{class:"btn btn-secondary btn-sm",onClick:V},"é‡ç½®ä¸ºé»˜è®¤")])])]))}}),Nd=He(zd,[["__scopeId","data-v-23f4a3f7"]]),Vd={class:"proofreading-settings"},Wd={class:"settings-group"},Kd={class:"settings-item"},qd={class:"checkbox-label"},Hd={class:"settings-item"},jd={class:"settings-group"},Jd={class:"round-header"},Yd={class:"round-title"},Xd=["onClick","disabled"],Gd={class:"round-content"},Zd={class:"settings-item"},Qd=["onUpdate:modelValue"],eg={class:"settings-row"},tg={class:"settings-item"},og={class:"settings-item"},ng={class:"password-input-wrapper"},sg=["type","onUpdate:modelValue"],ag=["onClick"],lg={key:0,class:"eye-icon"},ig={key:1,class:"eye-off-icon"},rg={class:"settings-item"},ug=["onUpdate:modelValue"],cg={class:"settings-item"},dg={class:"model-input-with-fetch"},gg=["onUpdate:modelValue"],pg=["onClick","disabled"],mg={class:"fetch-text"},vg={key:0,class:"model-select-container"},fg={class:"model-count"},bg={class:"settings-item"},hg=["onClick","disabled"],xg={class:"settings-row"},yg={class:"settings-item"},_g=["onUpdate:modelValue"],Cg={class:"settings-item"},Sg=["onUpdate:modelValue"],kg={class:"settings-item"},wg=["onUpdate:modelValue"],$g={class:"settings-row"},Tg={class:"settings-item"},Ig={class:"checkbox-label"},Pg=["onUpdate:modelValue"],Rg={class:"settings-item"},Dg={class:"settings-item"},Mg={class:"checkbox-label"},Eg=["onUpdate:modelValue"],Bg={class:"settings-item"},Ag=["onUpdate:modelValue"],Lg=["onClick"],Fg=je({__name:"ProofreadingSettings",setup(n){const t=[{label:"SiliconFlow",value:"siliconflow"},{label:"DeepSeek",value:"deepseek"},{label:"ç«å±±å¼•æ“",value:"volcano"},{label:"Google Gemini",value:"gemini"},{label:"è‡ªå®šä¹‰ OpenAI å…¼å®¹æœåŠ¡",value:"custom_openai"}],s=[{label:"Geminié£æ ¼",value:"gemini"},{label:"ç«å±±å¼•æ“é£æ ¼",value:"volcano"}],o=ze(),l=ct(),u=w({}),a=w({}),c=w({}),m=X(()=>o.settings.proofreading.rounds),p=X({get:()=>o.settings.proofreading.maxRetries,set:F=>o.setProofreadingMaxRetries(F)}),_=X({get:()=>o.settings.proofreading.enabled,set:F=>o.setProofreadingEnabled(F)});Se(()=>o.settings.proofreading.rounds,()=>{o.saveToStorage()},{deep:!0});function T(F){const b=c.value[F]||[],v=[{label:"-- é€‰æ‹©æ¨¡å‹ --",value:""}];return b.forEach(k=>v.push({label:k,value:k})),v}async function M(F){const b=m.value[F];if(!b)return;const v=b.provider,k=b.apiKey?.trim(),$=b.customBaseUrl?.trim();if(!k){l.warning("è¯·å…ˆå¡«å†™ API Key");return}if(!["siliconflow","deepseek","volcano","gemini","custom_openai"].includes(v)){l.warning("å½“å‰æœåŠ¡å•†ä¸æ”¯æŒè·å–æ¨¡å‹åˆ—è¡¨");return}u.value[F]=!0;try{const z=await qe.fetchModels(v,k,$);z.success&&z.models&&z.models.length>0?(c.value[F]=z.models.map(ae=>ae.id),l.success(`è½®æ¬¡ ${F+1}: è·å–åˆ° ${z.models.length} ä¸ªæ¨¡å‹`)):l.warning(z.message||"æœªè·å–åˆ°å¯ç”¨æ¨¡å‹")}catch(z){const ae=z instanceof Error?z.message:"è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥";l.error(ae)}finally{u.value[F]=!1}}async function R(F){const b=m.value[F];if(!b)return;const v=b.provider,k=b.apiKey?.trim(),$=b.modelName?.trim(),N=b.customBaseUrl?.trim();if(!k){l.warning("è¯·å…ˆå¡«å†™ API Key");return}if(!$){l.warning("è¯·å¡«å†™æ¨¡å‹åç§°");return}a.value[F]=!0,l.info(`æ­£åœ¨æµ‹è¯•è½®æ¬¡ ${F+1} çš„è¿æ¥...`);try{const z=await qe.testAiTranslateConnection({provider:v,apiKey:k,modelName:$,baseUrl:N});z.success?l.success(z.message||"è¿æ¥æˆåŠŸ!"):l.error(z.message||z.error||"è¿æ¥å¤±è´¥")}catch(z){const ae=z instanceof Error?z.message:"è¿æ¥æµ‹è¯•å¤±è´¥";l.error(ae)}finally{a.value[F]=!1}}function I(){const F={name:`ç¬¬${m.value.length+1}è½®æ ¡å¯¹`,provider:"siliconflow",apiKey:"",modelName:"",customBaseUrl:"",batchSize:3,sessionReset:3,rpmLimit:7,lowReasoning:!1,noThinkingMethod:"gemini",forceJsonOutput:!1,prompt:Qo,showApiKey:!1};o.addProofreadingRound(F),l.success("å·²æ·»åŠ æ–°çš„æ ¡å¯¹è½®æ¬¡")}function E(F){if(m.value.length<=1){l.warning("è‡³å°‘éœ€è¦ä¿ç•™ä¸€ä¸ªæ ¡å¯¹è½®æ¬¡");return}o.removeProofreadingRound(F),l.success("å·²åˆ é™¤æ ¡å¯¹è½®æ¬¡")}function H(F){o.updateProofreadingRound(F,{prompt:Qo}),l.success("å·²é‡ç½®ä¸ºé»˜è®¤æç¤ºè¯")}function V(F,b,v){o.updateProofreadingRound(F,{prompt:b}),l.success(`å·²åº”ç”¨æç¤ºè¯: ${v}`)}return(F,b)=>(A(),L("div",Vd,[e("div",Wd,[b[5]||(b[5]=e("div",{class:"settings-group-title"},"AIæ ¡å¯¹è®¾ç½®",-1)),e("div",Kd,[e("label",qd,[ne(e("input",{type:"checkbox","onUpdate:modelValue":b[0]||(b[0]=v=>_.value=v)},null,512),[[Qe,_.value]]),b[2]||(b[2]=me(" å¯ç”¨AIæ ¡å¯¹ ",-1))]),b[3]||(b[3]=e("div",{class:"input-hint"},"ç¿»è¯‘å®Œæˆåè‡ªåŠ¨è¿›è¡ŒAIæ ¡å¯¹",-1))]),e("div",Hd,[b[4]||(b[4]=e("label",{for:"settingsProofreadingMaxRetries"},"å…¨å±€é‡è¯•æ¬¡æ•°:",-1)),ne(e("input",{type:"number",id:"settingsProofreadingMaxRetries","onUpdate:modelValue":b[1]||(b[1]=v=>p.value=v),min:"0",max:"10",step:"1"},null,512),[[Te,p.value,void 0,{number:!0}]])])]),ne(e("div",jd,[e("div",{class:"settings-group-title"},[b[6]||(b[6]=me(" æ ¡å¯¹è½®æ¬¡é…ç½® ",-1)),e("button",{class:"btn btn-secondary btn-sm",onClick:I},"+ æ·»åŠ è½®æ¬¡")]),(A(!0),L(Ve,null,Ye(m.value,(v,k)=>(A(),L("div",{key:k,class:"proofreading-round"},[e("div",Jd,[e("span",Yd,"è½®æ¬¡ "+oe(k+1)+": "+oe(v.name||"æœªå‘½å"),1),e("button",{class:"btn btn-danger btn-sm",onClick:$=>E(k),disabled:m.value.length<=1}," åˆ é™¤ ",8,Xd)]),e("div",Gd,[e("div",Zd,[b[7]||(b[7]=e("label",null,"è½®æ¬¡åç§°:",-1)),ne(e("input",{type:"text","onUpdate:modelValue":$=>v.name=$,placeholder:"å¦‚: ç¬¬ä¸€è½®æ ¡å¯¹"},null,8,Qd),[[Te,v.name]])]),e("div",eg,[e("div",tg,[b[8]||(b[8]=e("label",null,"æœåŠ¡å•†:",-1)),Ce(Ke,{modelValue:v.provider,"onUpdate:modelValue":$=>v.provider=$,options:t},null,8,["modelValue","onUpdate:modelValue"])]),e("div",og,[b[9]||(b[9]=e("label",null,"API Key:",-1)),e("div",ng,[ne(e("input",{type:v.showApiKey?"text":"password","onUpdate:modelValue":$=>v.apiKey=$,class:"secure-input",placeholder:"è¯·è¾“å…¥API Key",autocomplete:"off"},null,8,sg),[[$t,v.apiKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:$=>v.showApiKey=!v.showApiKey},[v.showApiKey?(A(),L("span",ig,"ğŸ‘â€ğŸ—¨")):(A(),L("span",lg,"ğŸ‘"))],8,ag)])])]),ne(e("div",rg,[b[10]||(b[10]=e("label",null,"Base URL:",-1)),ne(e("input",{type:"text","onUpdate:modelValue":$=>v.customBaseUrl=$,placeholder:"ä¾‹å¦‚: https://api.example.com/v1"},null,8,ug),[[Te,v.customBaseUrl]])],512),[[Oe,v.provider==="custom_openai"]]),e("div",cg,[b[12]||(b[12]=e("label",null,"æ¨¡å‹åç§°:",-1)),e("div",dg,[ne(e("input",{type:"text","onUpdate:modelValue":$=>v.modelName=$,placeholder:"è¯·è¾“å…¥æ¨¡å‹åç§°"},null,8,gg),[[Te,v.modelName]]),e("button",{type:"button",class:"fetch-models-btn",title:"è·å–å¯ç”¨æ¨¡å‹åˆ—è¡¨",onClick:$=>M(k),disabled:u.value[k]},[b[11]||(b[11]=e("span",{class:"fetch-icon"},"ğŸ”",-1)),e("span",mg,oe(u.value[k]?"è·å–ä¸­...":"è·å–æ¨¡å‹"),1)],8,pg)]),c.value[k]&&c.value[k].length>0?(A(),L("div",vg,[Ce(Ke,{modelValue:v.modelName,"onUpdate:modelValue":$=>v.modelName=$,options:T(k)},null,8,["modelValue","onUpdate:modelValue","options"]),e("span",fg,"å…± "+oe(c.value[k].length)+" ä¸ªæ¨¡å‹",1)])):ce("",!0)]),e("div",bg,[e("button",{class:"settings-test-btn",onClick:$=>R(k),disabled:a.value[k]},oe(a.value[k]?"æµ‹è¯•ä¸­...":"ğŸ”— æµ‹è¯•è¿æ¥"),9,hg)]),e("div",xg,[e("div",yg,[b[13]||(b[13]=e("label",null,"æ‰¹æ¬¡å¤§å°:",-1)),ne(e("input",{type:"number","onUpdate:modelValue":$=>v.batchSize=$,min:"1",max:"10",step:"1"},null,8,_g),[[Te,v.batchSize,void 0,{number:!0}]])]),e("div",Cg,[b[14]||(b[14]=e("label",null,"ä¼šè¯é‡ç½®é¢‘ç‡:",-1)),ne(e("input",{type:"number","onUpdate:modelValue":$=>v.sessionReset=$,min:"1",step:"1"},null,8,Sg),[[Te,v.sessionReset,void 0,{number:!0}]])]),e("div",kg,[b[15]||(b[15]=e("label",null,"RPMé™åˆ¶:",-1)),ne(e("input",{type:"number","onUpdate:modelValue":$=>v.rpmLimit=$,min:"0",step:"1"},null,8,wg),[[Te,v.rpmLimit,void 0,{number:!0}]])])]),e("div",$g,[e("div",Tg,[e("label",Ig,[ne(e("input",{type:"checkbox","onUpdate:modelValue":$=>v.lowReasoning=$},null,8,Pg),[[Qe,v.lowReasoning]]),b[16]||(b[16]=me(" ä½æ¨ç†æ¨¡å¼ ",-1))])]),e("div",Rg,[b[17]||(b[17]=e("label",null,"å–æ¶ˆæ€è€ƒæ–¹æ³•:",-1)),Ce(Ke,{modelValue:v.noThinkingMethod,"onUpdate:modelValue":$=>v.noThinkingMethod=$,options:s},null,8,["modelValue","onUpdate:modelValue"])]),e("div",Dg,[e("label",Mg,[ne(e("input",{type:"checkbox","onUpdate:modelValue":$=>v.forceJsonOutput=$},null,8,Eg),[[Qe,v.forceJsonOutput]]),b[18]||(b[18]=me(" å¼ºåˆ¶JSONè¾“å‡º ",-1))])])]),e("div",Bg,[b[19]||(b[19]=e("label",null,"æ ¡å¯¹æç¤ºè¯:",-1)),ne(e("textarea",{"onUpdate:modelValue":$=>v.prompt=$,rows:"4",placeholder:"æ ¡å¯¹æç¤ºè¯"},null,8,Ag),[[Te,v.prompt]]),Ce(zt,{"prompt-type":"proofreading",onSelect:($,N)=>V(k,$,N)},null,8,["onSelect"]),e("button",{class:"btn btn-secondary btn-sm",onClick:$=>H(k)},"é‡ç½®ä¸ºé»˜è®¤",8,Lg)])])]))),128))],512),[[Oe,_.value]])]))}}),Ug=He(Fg,[["__scopeId","data-v-a41d5a05"]]),Og={class:"prompt-library"},zg={class:"settings-group"},Ng={class:"settings-item"},Vg={key:0,class:"settings-item"},Wg={class:"mode-hint"},Kg={class:"settings-group"},qg={key:0,class:"loading-hint"},Hg={key:1,class:"empty-hint"},jg={key:2,class:"prompt-list"},Jg=["onClick"],Yg={class:"prompt-name"},Xg={class:"prompt-actions"},Gg=["onClick"],Zg=["onClick","disabled"],Qg={class:"settings-group"},ep={class:"settings-item"},tp={class:"settings-item"},op={class:"prompt-editor-actions"},np=["disabled"],sp=je({__name:"PromptLibrary",setup(n){const t=[{label:"ç¿»è¯‘æç¤ºè¯",value:"translate"},{label:"æ–‡æœ¬æ¡†æç¤ºè¯",value:"textbox"},{label:"AIè§†è§‰OCRæç¤ºè¯",value:"ai_vision_ocr"},{label:"é«˜è´¨é‡ç¿»è¯‘æç¤ºè¯",value:"hq_translate"},{label:"æ ¡å¯¹æç¤ºè¯",value:"proofreading"}],s=[{label:"æ™®é€šæ¨¡å¼",value:"false"},{label:"JSONæ ¼å¼æ¨¡å¼",value:"true"}],o=ct(),l=ze(),u=w("translate"),a=w([]),c=w(""),m=w(""),p=w(""),_=w(!1),T=w(!1),M=X(()=>u.value==="translate"||u.value==="ai_vision_ocr"),R=X(()=>T.value?"é€‚ç”¨äºéœ€è¦ç»“æ„åŒ–è¾“å‡ºçš„åœºæ™¯":"é€‚ç”¨äºæ™®é€šç¿»è¯‘åœºæ™¯");async function I(){_.value=!0;try{let k;u.value==="textbox"?k=await qe.getTextboxPrompts():k=await qe.getPrompts(u.value);const $=k.prompt_names||[];a.value=$.map(N=>({name:N}))}catch(k){const $=k instanceof Error?k.message:"åŠ è½½æç¤ºè¯åˆ—è¡¨å¤±è´¥";o.error($)}finally{_.value=!1}}async function E(k){c.value=k,m.value=k,await H(k)}async function H(k){try{let $;u.value==="textbox"?$=await qe.getTextboxPromptContent(k):$=await qe.getPromptContent(u.value,k),m.value=k,p.value=$.prompt_content||"",c.value=k,o.success("å·²åŠ è½½æç¤ºè¯")}catch($){const N=$ instanceof Error?$.message:"åŠ è½½æç¤ºè¯å†…å®¹å¤±è´¥";o.error(N)}}async function V(){if(!m.value||!p.value){o.warning("è¯·è¾“å…¥æç¤ºè¯åç§°å’Œå†…å®¹");return}try{u.value==="textbox"?await qe.saveTextboxPrompt(m.value,p.value):await qe.savePrompt(u.value,m.value,p.value),o.success("æç¤ºè¯ä¿å­˜æˆåŠŸ"),m.value="",p.value="",await I()}catch(k){const $=k instanceof Error?k.message:"ä¿å­˜æç¤ºè¯å¤±è´¥";o.error($)}}async function F(k){if(k==="default"){o.warning("é»˜è®¤æç¤ºè¯ä¸èƒ½åˆ é™¤");return}try{u.value==="textbox"?await qe.deleteTextboxPrompt(k):await qe.deletePrompt(u.value,k),o.success("æç¤ºè¯åˆ é™¤æˆåŠŸ"),c.value===k&&(c.value="",m.value="",p.value=""),await I()}catch($){const N=$ instanceof Error?$.message:"åˆ é™¤æç¤ºè¯å¤±è´¥";o.error(N)}}function b(){c.value="",m.value="",p.value="",u.value==="translate"?T.value=l.settings.translation.isJsonMode:u.value==="ai_vision_ocr"?T.value=l.settings.aiVisionOcr.isJsonMode:T.value=!1,I()}function v(){u.value==="translate"?l.updateTranslationService({isJsonMode:T.value}):u.value==="ai_vision_ocr"&&l.updateAiVisionOcr({isJsonMode:T.value}),o.info(`å·²åˆ‡æ¢åˆ°${T.value?"JSONæ ¼å¼":"æ™®é€š"}æ¨¡å¼`)}return dt(()=>{T.value=l.settings.translation.isJsonMode,I()}),(k,$)=>(A(),L("div",Og,[e("div",zg,[$[6]||($[6]=e("div",{class:"settings-group-title"},"æç¤ºè¯ç®¡ç†",-1)),e("div",Ng,[$[4]||($[4]=e("label",{for:"promptType"},"æç¤ºè¯ç±»å‹:",-1)),Ce(Ke,{modelValue:u.value,"onUpdate:modelValue":$[0]||($[0]=N=>u.value=N),options:t,onChange:b},null,8,["modelValue"])]),M.value?(A(),L("div",Vg,[$[5]||($[5]=e("label",{for:"promptMode"},"æç¤ºè¯æ¨¡å¼:",-1)),Ce(Ke,{"model-value":T.value?"true":"false",options:s,onChange:$[1]||($[1]=N=>{T.value=N==="true",v()})},null,8,["model-value"]),e("span",Wg,oe(R.value),1)])):ce("",!0)]),e("div",Kg,[$[7]||($[7]=e("div",{class:"settings-group-title"},"å·²ä¿å­˜çš„æç¤ºè¯",-1)),_.value?(A(),L("div",qg,"åŠ è½½ä¸­...")):a.value.length===0?(A(),L("div",Hg,"æš‚æ— ä¿å­˜çš„æç¤ºè¯")):(A(),L("div",jg,[(A(!0),L(Ve,null,Ye(a.value,N=>(A(),L("div",{key:N.name,class:Ie(["prompt-item",{active:c.value===N.name}]),onClick:z=>E(N.name)},[e("span",Yg,oe(N.name),1),e("div",Xg,[e("button",{class:"btn btn-sm",onClick:at(z=>H(N.name),["stop"]),title:"åŠ è½½åˆ°ç¼–è¾‘å™¨"},"ğŸ“¥",8,Gg),e("button",{class:"btn btn-sm btn-danger",onClick:at(z=>F(N.name),["stop"]),title:"åˆ é™¤",disabled:N.name==="default"}," ğŸ—‘ï¸ ",8,Zg)])],10,Jg))),128))]))]),e("div",Qg,[$[10]||($[10]=e("div",{class:"settings-group-title"},"æç¤ºè¯ç¼–è¾‘",-1)),e("div",ep,[$[8]||($[8]=e("label",{for:"promptName"},"æç¤ºè¯åç§°:",-1)),ne(e("input",{type:"text",id:"promptName","onUpdate:modelValue":$[2]||($[2]=N=>m.value=N),placeholder:"è¯·è¾“å…¥æç¤ºè¯åç§°"},null,512),[[Te,m.value]])]),e("div",tp,[$[9]||($[9]=e("label",{for:"promptContent"},"æç¤ºè¯å†…å®¹:",-1)),ne(e("textarea",{id:"promptContent","onUpdate:modelValue":$[3]||($[3]=N=>p.value=N),rows:"8",placeholder:"è¯·è¾“å…¥æç¤ºè¯å†…å®¹"},null,512),[[Te,p.value]])]),e("div",op,[e("button",{class:"btn btn-primary",onClick:V,disabled:!m.value||!p.value},"ä¿å­˜æç¤ºè¯",8,np)])])]))}}),ap=He(sp,[["__scopeId","data-v-70f0ec19"]]),lp={class:"plugin-manager"},ip={class:"settings-group"},rp={key:0,class:"loading-hint"},up={key:1,class:"empty-hint"},cp={key:2,class:"plugin-list"},dp={class:"plugin-info"},gp={class:"plugin-header"},pp={class:"plugin-name"},mp={class:"plugin-version"},vp={class:"plugin-description"},fp={class:"plugin-controls"},bp={class:"switch"},hp=["checked","onChange"],xp=["onClick"],yp=["onClick"],_p={class:"settings-group"},Cp={class:"plugin-name"},Sp={class:"switch"},kp=["checked","onChange"],wp={class:"plugin-config-content"},$p={class:"plugin-config-header"},Tp={class:"plugin-config-body"},Ip=["for"],Pp=["id","onUpdate:modelValue"],Rp=["id","onUpdate:modelValue","min","max"],Dp=["id","onUpdate:modelValue","placeholder"],Mp={key:4,class:"field-description"},Ep=je({__name:"PluginManager",setup(n){const t=ct(),s=w([]),o=w({}),l=w(!1),u=w(!1),a=w(null),c=w({}),m=w({});async function p(){l.value=!0;try{const V=await Hs();s.value=V.plugins||[]}catch(V){const F=V instanceof Error?V.message:"åŠ è½½æ’ä»¶åˆ—è¡¨å¤±è´¥";t.error(F)}finally{l.value=!1}}async function _(){try{const V=await ta();o.value=V.states||{}}catch(V){console.error("åŠ è½½é»˜è®¤çŠ¶æ€å¤±è´¥:",V)}}async function T(V){try{V.enabled?(await Js(V.name),V.enabled=!1,t.success(`å·²ç¦ç”¨ ${V.display_name||V.name}`)):(await js(V.name),V.enabled=!0,t.success(`å·²å¯ç”¨ ${V.display_name||V.name}`))}catch(F){const b=F instanceof Error?F.message:"æ“ä½œå¤±è´¥";t.error(b)}}async function M(V,F){const b=F.target,v=b.checked;try{await oa(V,v),o.value[V]=v,t.success("é»˜è®¤çŠ¶æ€å·²æ›´æ–°")}catch(k){const $=k instanceof Error?k.message:"è®¾ç½®å¤±è´¥";t.error($),b.checked=!v}}async function R(V){a.value=V;try{const F=await na(V.name);c.value=F.schema||{};const b=await sa(V.name);m.value=b.config||{},u.value=!0}catch(F){const b=F instanceof Error?F.message:"åŠ è½½é…ç½®å¤±è´¥";t.error(b)}}function I(){u.value=!1,a.value=null,c.value={},m.value={}}async function E(){if(a.value)try{await aa(a.value.name,m.value),t.success("é…ç½®ä¿å­˜æˆåŠŸ"),I()}catch(V){const F=V instanceof Error?V.message:"ä¿å­˜é…ç½®å¤±è´¥";t.error(F)}}async function H(V){if(confirm(`ç¡®å®šè¦åˆ é™¤æ’ä»¶ "${V.display_name||V.name}" å—ï¼Ÿ`))try{await Ys(V.name),t.success("æ’ä»¶åˆ é™¤æˆåŠŸ"),await p()}catch(F){const b=F instanceof Error?F.message:"åˆ é™¤æ’ä»¶å¤±è´¥";t.error(b)}}return dt(()=>{p(),_()}),(V,F)=>(A(),L("div",lp,[e("div",ip,[F[1]||(F[1]=e("div",{class:"settings-group-title"},"å·²å®‰è£…æ’ä»¶",-1)),l.value?(A(),L("div",rp,"åŠ è½½ä¸­...")):s.value.length===0?(A(),L("div",up,"æš‚æ— å·²å®‰è£…çš„æ’ä»¶")):(A(),L("div",cp,[(A(!0),L(Ve,null,Ye(s.value,b=>(A(),L("div",{key:b.name,class:"plugin-item"},[e("div",dp,[e("div",gp,[e("span",pp,oe(b.display_name||b.name),1),e("span",mp,"v"+oe(b.version||"1.0.0"),1)]),e("p",vp,oe(b.description||"æš‚æ— æè¿°"),1)]),e("div",fp,[e("label",bp,[e("input",{type:"checkbox",checked:b.enabled,onChange:v=>T(b)},null,40,hp),F[0]||(F[0]=e("span",{class:"slider"},null,-1))]),b.has_config?(A(),L("button",{key:0,class:"btn btn-sm",onClick:v=>R(b),title:"é…ç½®"},"âš™ï¸",8,xp)):ce("",!0),e("button",{class:"btn btn-sm btn-danger",onClick:v=>H(b),title:"åˆ é™¤"},"ğŸ—‘ï¸",8,yp)])]))),128))]))]),e("div",_p,[F[3]||(F[3]=e("div",{class:"settings-group-title"},"é»˜è®¤å¯ç”¨çŠ¶æ€",-1)),F[4]||(F[4]=e("p",{class:"settings-hint"},"è®¾ç½®æ’ä»¶åœ¨æ–°ä¼šè¯ä¸­çš„é»˜è®¤å¯ç”¨çŠ¶æ€",-1)),(A(!0),L(Ve,null,Ye(s.value,b=>(A(),L("div",{key:"default-"+b.name,class:"default-state-item"},[e("span",Cp,oe(b.display_name||b.name),1),e("label",Sp,[e("input",{type:"checkbox",checked:o.value[b.name],onChange:v=>M(b.name,v)},null,40,kp),F[2]||(F[2]=e("span",{class:"slider"},null,-1))])]))),128))]),u.value?(A(),L("div",{key:0,class:"plugin-config-modal",onClick:at(I,["self"])},[e("div",wp,[e("div",$p,[e("h4",null,oe(a.value?.display_name||a.value?.name)+" é…ç½®",1),e("span",{class:"close-btn",onClick:I},"Ã—")]),e("div",Tp,[(A(!0),L(Ve,null,Ye(c.value,(b,v)=>(A(),L("div",{key:v,class:"config-field"},[e("label",{for:"config-"+v},oe(b.label||v)+":",9,Ip),b.type==="boolean"?ne((A(),L("input",{key:0,type:"checkbox",id:"config-"+v,"onUpdate:modelValue":k=>m.value[v]=k},null,8,Pp)),[[Qe,m.value[v]]]):b.type==="select"?(A(),ut(Ke,{key:1,"model-value":String(m.value[v]??""),options:b.options||[],onChange:k=>{m.value[v]=k}},null,8,["model-value","options","onChange"])):b.type==="number"?ne((A(),L("input",{key:2,type:"number",id:"config-"+v,"onUpdate:modelValue":k=>m.value[v]=k,min:b.min,max:b.max},null,8,Rp)),[[Te,m.value[v],void 0,{number:!0}]]):ne((A(),L("input",{key:3,type:"text",id:"config-"+v,"onUpdate:modelValue":k=>m.value[v]=k,placeholder:b.placeholder},null,8,Dp)),[[Te,m.value[v]]]),b.description?(A(),L("p",Mp,oe(b.description),1)):ce("",!0)]))),128))]),e("div",{class:"plugin-config-footer"},[e("button",{class:"btn btn-secondary",onClick:I},"å–æ¶ˆ"),e("button",{class:"btn btn-primary",onClick:E},"ä¿å­˜")])])])):ce("",!0)]))}}),Bp=He(Ep,[["__scopeId","data-v-a62393a7"]]),Ap={class:"parallel-settings"},Lp={class:"settings-group"},Fp={class:"settings-item"},Up={class:"toggle-switch"},Op={class:"number-control"},zp=["disabled"],Np=["disabled"],Vp=["disabled"],Wp={key:0,class:"settings-note"},Kp=je({__name:"ParallelSettings",setup(n){const t=ze(),s=X({get:()=>t.settings.parallel.enabled,set:l=>{t.updateSettings({parallel:{...t.settings.parallel,enabled:l}})}}),o=X({get:()=>t.settings.parallel.deepLearningLockSize,set:l=>{t.updateSettings({parallel:{...t.settings.parallel,deepLearningLockSize:Math.max(1,Math.min(4,l))}})}});return(l,u)=>(A(),L("div",Ap,[e("div",Lp,[u[10]||(u[10]=e("div",{class:"settings-group-title"},"ğŸš€ å¹¶è¡Œç¿»è¯‘",-1)),e("div",Fp,[u[5]||(u[5]=e("label",null,"å¯ç”¨å¹¶è¡Œæ¨¡å¼:",-1)),e("label",Up,[ne(e("input",{type:"checkbox","onUpdate:modelValue":u[0]||(u[0]=a=>s.value=a)},null,512),[[Qe,s.value]]),u[4]||(u[4]=e("span",{class:"toggle-slider"},null,-1))]),u[6]||(u[6]=e("div",{class:"input-hint"},"ä½¿ç”¨æµæ°´çº¿å¹¶è¡Œå¤„ç†ï¼Œå¯èƒ½æå‡æ‰¹é‡ç¿»è¯‘é€Ÿåº¦",-1))]),e("div",{class:Ie(["settings-item",{"item-disabled":!s.value}])},[u[7]||(u[7]=e("label",null,"æ·±åº¦å­¦ä¹ å¹¶å‘æ•°:",-1)),e("div",Op,[e("button",{class:"btn btn-sm",onClick:u[1]||(u[1]=a=>o.value=Math.max(1,o.value-1)),disabled:!s.value},"-",8,zp),ne(e("input",{type:"number","onUpdate:modelValue":u[2]||(u[2]=a=>o.value=a),min:"1",max:"4",disabled:!s.value,class:"number-input"},null,8,Np),[[Te,o.value,void 0,{number:!0}]]),e("button",{class:"btn btn-sm",onClick:u[3]||(u[3]=a=>o.value=Math.min(4,o.value+1)),disabled:!s.value},"+",8,Vp)]),u[8]||(u[8]=e("div",{class:"input-hint"},"æ§åˆ¶æ£€æµ‹/OCR/é¢œè‰²/ä¿®å¤çš„æœ€å¤§å¹¶å‘æ•°ï¼ˆå»ºè®®1-2ï¼‰",-1))],2),s.value?(A(),L("div",Wp,[...u[9]||(u[9]=[e("div",{class:"note-title"},"âš ï¸ æ³¨æ„äº‹é¡¹ï¼š",-1),e("ul",null,[e("li",null,"å¹¶å‘æ•°è®¾ä¸º1æ—¶ä¸ºä¸²è¡Œæ‰§è¡Œï¼Œæœ€ç¨³å®š"),e("li",null,"å¢å¤§å¹¶å‘æ•°å¯èƒ½åŠ é€Ÿå¤„ç†ï¼Œä½†ä¼šå ç”¨æ›´å¤šGPU/CPUèµ„æº"),e("li",null,"å¦‚æœé‡åˆ°æ˜¾å­˜ä¸è¶³ï¼Œè¯·å°†å¹¶å‘æ•°è®¾ä¸º1")],-1)])])):ce("",!0)])]))}}),qp=He(Kp,[["__scopeId","data-v-4a6e42d5"]]),Hp={class:"more-settings"},jp={class:"settings-group"},Jp={class:"settings-item checkbox-item"},Yp={class:"checkbox-label"},Xp={class:"settings-group"},Gp={class:"settings-item checkbox-item"},Zp={class:"checkbox-label"},Qp={class:"settings-group"},em={class:"settings-item checkbox-item"},tm={class:"checkbox-label"},om={class:"settings-group"},nm={class:"settings-item"},sm={class:"settings-group"},am={class:"settings-item"},lm=["disabled"],im={key:0,class:"font-count"},rm={class:"settings-item"},um={class:"settings-group"},cm={class:"settings-row"},dm={class:"settings-item"},gm=["disabled"],pm={class:"settings-item"},mm=["disabled"],vm=je({__name:"MoreSettings",setup(n){const t=[{label:"å‰ç«¯ pdf.js (æ¨è)",value:"frontend"},{label:"åç«¯ PyMuPDF",value:"backend"}],s=ze(),o=ct(),l=w(!1),u=w([]),a=w(!1),c=w(null),m=w({pdfProcessingMethod:s.settings.pdfProcessingMethod||"frontend",autoSaveInBookshelfMode:s.settings.autoSaveInBookshelfMode||!1,removeTextWithOcr:s.settings.removeTextWithOcr||!1,enableVerboseLogs:s.settings.enableVerboseLogs||!1});Se(()=>m.value.pdfProcessingMethod,R=>{s.setPdfProcessingMethod(R)}),Se(()=>m.value.autoSaveInBookshelfMode,R=>{s.setAutoSaveInBookshelfMode(R)}),Se(()=>m.value.removeTextWithOcr,R=>{s.setRemoveTextWithOcr(R)}),Se(()=>m.value.enableVerboseLogs,R=>{s.setEnableVerboseLogs(R)});async function p(){l.value=!0;try{const R=await qe.getFontList();u.value=R.fonts||[],o.success(`è·å–åˆ° ${u.value.length} ä¸ªå­—ä½“`)}catch(R){const I=R instanceof Error?R.message:"è·å–å­—ä½“åˆ—è¡¨å¤±è´¥";o.error(I)}finally{l.value=!1}}async function _(R){const E=R.target.files?.[0];if(!E)return;const H=[".ttf",".ttc",".otf"],V=E.name.toLowerCase().slice(E.name.lastIndexOf("."));if(!H.includes(V)){o.error("ä¸æ”¯æŒçš„å­—ä½“æ ¼å¼ï¼Œè¯·ä¸Šä¼  .ttf, .ttc æˆ– .otf æ–‡ä»¶");return}try{const F=await qe.uploadFont(E);F.success?(o.success(`å­—ä½“ "${F.fontPath||E.name}" ä¸Šä¼ æˆåŠŸ`),await p()):o.error(F.error||"å­—ä½“ä¸Šä¼ å¤±è´¥")}catch(F){const b=F instanceof Error?F.message:"å­—ä½“ä¸Šä¼ å¤±è´¥";o.error(b)}finally{c.value&&(c.value.value="")}}async function T(){a.value=!0;try{const R=await wn();R.success?o.success(`å·²æ¸…ç† ${R.deleted_count||0} ä¸ªè°ƒè¯•æ–‡ä»¶`):o.error(R.error||"æ¸…ç†å¤±è´¥")}catch(R){const I=R instanceof Error?R.message:"æ¸…ç†å¤±è´¥";o.error(I)}finally{a.value=!1}}async function M(){a.value=!0;try{const R=await _o();R.success?o.success(`å·²æ¸…ç† ${R.deleted_count||0} ä¸ªä¸´æ—¶æ–‡ä»¶`):o.error(R.error||"æ¸…ç†å¤±è´¥")}catch(R){const I=R instanceof Error?R.message:"æ¸…ç†å¤±è´¥";o.error(I)}finally{a.value=!1}}return(R,I)=>(A(),L("div",Hp,[Ce(qp),e("div",jp,[I[6]||(I[6]=e("div",{class:"settings-group-title"},"è‡ªåŠ¨ä¿å­˜è®¾ç½®",-1)),e("div",Jp,[e("label",Yp,[ne(e("input",{type:"checkbox","onUpdate:modelValue":I[0]||(I[0]=E=>m.value.autoSaveInBookshelfMode=E)},null,512),[[Qe,m.value.autoSaveInBookshelfMode]]),I[4]||(I[4]=e("span",{class:"checkbox-text"},"ä¹¦æ¶æ¨¡å¼è‡ªåŠ¨ä¿å­˜",-1))]),I[5]||(I[5]=e("div",{class:"input-hint"},[me(" å¼€å¯åï¼Œåœ¨ä¹¦æ¶æ¨¡å¼ä¸‹ç¿»è¯‘æ—¶ä¼šè‡ªåŠ¨ä¿å­˜è¿›åº¦ï¼ˆç¿»è¯‘ä¸€å¼ ä¿å­˜ä¸€å¼ ï¼‰ï¼Œé˜²æ­¢æ„å¤–å…³é—­å¯¼è‡´æ•°æ®ä¸¢å¤±ã€‚ "),e("br"),e("span",{class:"hint-note"},"æ³¨æ„ï¼šæ­¤åŠŸèƒ½ä»…åœ¨ä¹¦æ¶æ¨¡å¼ä¸‹ç”Ÿæ•ˆï¼Œå¿«é€Ÿç¿»è¯‘æ¨¡å¼ä¸æ”¯æŒã€‚")],-1))])]),e("div",Xp,[I[9]||(I[9]=e("div",{class:"settings-group-title"},"æ¶ˆé™¤æ–‡å­—æ¨¡å¼",-1)),e("div",Gp,[e("label",Zp,[ne(e("input",{type:"checkbox","onUpdate:modelValue":I[1]||(I[1]=E=>m.value.removeTextWithOcr=E)},null,512),[[Qe,m.value.removeTextWithOcr]]),I[7]||(I[7]=e("span",{class:"checkbox-text"},"åŒæ—¶æ‰§è¡ŒOCRè¯†åˆ«",-1))]),I[8]||(I[8]=e("div",{class:"input-hint"},[me(" å¼€å¯åï¼Œæ¶ˆé™¤æ–‡å­—æ¨¡å¼ä¼šåŒæ—¶æ‰§è¡ŒOCRè¯†åˆ«ï¼Œè·å–å¸¦æœ‰åŸæ–‡çš„å¹²å‡€èƒŒæ™¯å›¾ã€‚ "),e("br"),e("span",{class:"hint-note"},"é€‚ç”¨äºéœ€è¦ä¿ç•™åŸæ–‡ä¿¡æ¯ä»¥ä¾¿åç»­ç¿»è¯‘æˆ–å‚è€ƒçš„åœºæ™¯ã€‚")],-1))])]),e("div",Qp,[I[12]||(I[12]=e("div",{class:"settings-group-title"},"è°ƒè¯•é€‰é¡¹",-1)),e("div",em,[e("label",tm,[ne(e("input",{type:"checkbox","onUpdate:modelValue":I[2]||(I[2]=E=>m.value.enableVerboseLogs=E)},null,512),[[Qe,m.value.enableVerboseLogs]]),I[10]||(I[10]=e("span",{class:"checkbox-text"},"è¯¦ç»†æ—¥å¿—",-1))]),I[11]||(I[11]=e("div",{class:"input-hint"},[me(" å¼€å¯åï¼Œåç«¯ç»ˆç«¯ä¼šæ‰“å°è¯¦ç»†çš„è¯Šæ–­æ—¥å¿—ï¼ˆåŒ…æ‹¬å®Œæ•´çš„æ¶ˆæ¯ç»“æ„ã€æ¨¡å‹å“åº”ç­‰ï¼‰ï¼Œä¾¿äºè°ƒè¯•é—®é¢˜ã€‚ "),e("br"),e("span",{class:"hint-note"},"å½±å“æ‰€æœ‰ç¿»è¯‘æ¨¡å¼ï¼Œé»˜è®¤å…³é—­ä»¥ä¿æŒæ—¥å¿—ç®€æ´ã€‚")],-1))])]),e("div",om,[I[15]||(I[15]=e("div",{class:"settings-group-title"},"PDFå¤„ç†è®¾ç½®",-1)),e("div",nm,[I[13]||(I[13]=e("label",{for:"settingsPdfProcessingMethod"},"PDFå¤„ç†æ–¹å¼:",-1)),Ce(Ke,{modelValue:m.value.pdfProcessingMethod,"onUpdate:modelValue":I[3]||(I[3]=E=>m.value.pdfProcessingMethod=E),options:t},null,8,["modelValue"]),I[14]||(I[14]=e("div",{class:"input-hint"},"å‰ç«¯å¤„ç†é€Ÿåº¦æ›´å¿«ï¼Œåç«¯å¤„ç†å…¼å®¹æ€§æ›´å¥½",-1))])]),e("div",sm,[I[19]||(I[19]=e("div",{class:"settings-group-title"},"å­—ä½“è®¾ç½®",-1)),e("div",am,[I[16]||(I[16]=e("label",null,"ç³»ç»Ÿå­—ä½“åˆ—è¡¨:",-1)),e("button",{class:"btn btn-secondary",onClick:p,disabled:l.value},oe(l.value?"åŠ è½½ä¸­...":"ğŸ”„ åˆ·æ–°å­—ä½“åˆ—è¡¨"),9,lm),u.value.length>0?(A(),L("div",im,"å…± "+oe(u.value.length)+" ä¸ªå­—ä½“",1)):ce("",!0)]),e("div",rm,[I[17]||(I[17]=e("label",null,"ä¸Šä¼ è‡ªå®šä¹‰å­—ä½“:",-1)),e("input",{type:"file",accept:".ttf,.ttc,.otf",onChange:_,ref_key:"fontInput",ref:c},null,544),I[18]||(I[18]=e("div",{class:"input-hint"},"æ”¯æŒ .ttf, .ttc, .otf æ ¼å¼",-1))])]),e("div",um,[I[22]||(I[22]=e("div",{class:"settings-group-title"},"ç¼“å­˜æ¸…ç†",-1)),e("div",cm,[e("div",dm,[e("button",{class:"btn btn-secondary",onClick:T,disabled:a.value},oe(a.value?"æ¸…ç†ä¸­...":"ğŸ—‘ï¸ æ¸…ç†è°ƒè¯•æ–‡ä»¶"),9,gm),I[20]||(I[20]=e("div",{class:"input-hint"},"æ¸…ç†è°ƒè¯•è¿‡ç¨‹ä¸­ç”Ÿæˆçš„ä¸´æ—¶æ–‡ä»¶",-1))]),e("div",pm,[e("button",{class:"btn btn-secondary",onClick:M,disabled:a.value},oe(a.value?"æ¸…ç†ä¸­...":"ğŸ—‘ï¸ æ¸…ç†ä¸´æ—¶æ–‡ä»¶"),9,mm),I[21]||(I[21]=e("div",{class:"input-hint"},"æ¸…ç†ä¸‹è½½å’Œå¤„ç†è¿‡ç¨‹ä¸­çš„ä¸´æ—¶æ–‡ä»¶",-1))])])]),I[23]||(I[23]=vo('<div class="settings-group" data-v-d2f04c1a><div class="settings-group-title" data-v-d2f04c1a>å…³äº</div><div class="about-info" data-v-d2f04c1a><p data-v-d2f04c1a><strong data-v-d2f04c1a>Saber-Translator</strong></p><p data-v-d2f04c1a>AIé©±åŠ¨çš„æ¼«ç”»ç¿»è¯‘å·¥å…·</p><p class="links" data-v-d2f04c1a><a href="http://www.mashirosaber.top" target="_blank" data-v-d2f04c1a>ğŸ“– ä½¿ç”¨æ•™ç¨‹</a><a href="https://github.com/MashiroSaber/saber-translator" target="_blank" data-v-d2f04c1a>ğŸ™ GitHub</a></p><p class="disclaimer" data-v-d2f04c1a>æœ¬é¡¹ç›®å®Œå…¨å¼€æºå…è´¹ï¼Œè¯·å‹¿ä¸Šå½“å—éª—</p></div></div>',1))]))}}),fm=He(vm,[["__scopeId","data-v-d2f04c1a"]]),bm={class:"settings-modal-content"},hm={class:"settings-tabs"},xm=["onClick"],ym={class:"settings-tab-content"},_m={class:"settings-tab-pane active"},Cm={class:"settings-tab-pane"},Sm={class:"settings-tab-pane"},km={class:"settings-tab-pane"},wm={class:"settings-tab-pane"},$m={class:"settings-tab-pane"},Tm={class:"settings-tab-pane"},Im={class:"settings-tab-pane"},Pm=je({__name:"SettingsModal",props:{modelValue:{type:Boolean},initialTab:{}},emits:["update:modelValue","save"],setup(n,{emit:t}){const s=n,o=t,l=ze(),u=w(s.modelValue),a=w("ocr"),c=[{id:"ocr",label:"OCRè¯†åˆ«"},{id:"translate",label:"ç¿»è¯‘æœåŠ¡"},{id:"detection",label:"æ£€æµ‹è®¾ç½®"},{id:"hq",label:"é«˜è´¨é‡ç¿»è¯‘"},{id:"proofreading",label:"AIæ ¡å¯¹"},{id:"prompt-library",label:"æç¤ºè¯ç®¡ç†"},{id:"plugins",label:"æ’ä»¶ç®¡ç†"},{id:"more",label:"æ›´å¤š"}];Se(()=>s.modelValue,T=>{u.value=T,T?(document.body.style.overflow="hidden",s.initialTab&&c.some(M=>M.id===s.initialTab)&&(a.value=s.initialTab)):(document.body.style.overflow="",a.value="ocr")});function m(){u.value=!1,o("update:modelValue",!1),document.body.style.overflow=""}async function p(){l.saveToStorage();try{await l.saveToBackend(),console.log("[SettingsModal] è®¾ç½®å·²ä¿å­˜åˆ°åç«¯")}catch(T){console.warn("[SettingsModal] ä¿å­˜åˆ°åç«¯å¤±è´¥ï¼Œä»…ä¿å­˜åˆ° localStorage:",T)}o("save"),m()}function _(T){T.key==="Escape"&&u.value&&m()}return dt(()=>{document.addEventListener("keydown",_)}),Nt(()=>{document.removeEventListener("keydown",_),document.body.style.overflow=""}),(T,M)=>u.value?(A(),L("div",{key:0,class:"settings-modal",onClick:at(m,["self"])},[e("div",bm,[e("div",{class:"settings-modal-header"},[M[0]||(M[0]=e("h3",null,"âš™ï¸ è®¾ç½®",-1)),e("span",{class:"settings-modal-close",onClick:m},"Ã—")]),e("div",hm,[(A(),L(Ve,null,Ye(c,R=>e("button",{key:R.id,class:Ie(["settings-tab",{active:a.value===R.id}]),onClick:I=>a.value=R.id},oe(R.label),11,xm)),64))]),e("div",ym,[ne(e("div",_m,[Ce(Vu)],512),[[Oe,a.value==="ocr"]]),ne(e("div",Cm,[Ce(Bc)],512),[[Oe,a.value==="translate"]]),ne(e("div",Sm,[Ce(od)],512),[[Oe,a.value==="detection"]]),ne(e("div",km,[Ce(Nd)],512),[[Oe,a.value==="hq"]]),ne(e("div",wm,[Ce(Ug)],512),[[Oe,a.value==="proofreading"]]),ne(e("div",$m,[Ce(ap)],512),[[Oe,a.value==="prompt-library"]]),ne(e("div",Tm,[Ce(Bp)],512),[[Oe,a.value==="plugins"]]),ne(e("div",Im,[Ce(fm)],512),[[Oe,a.value==="more"]])]),e("div",{class:"settings-modal-footer"},[e("button",{class:"btn btn-secondary",onClick:m},"å–æ¶ˆ"),e("button",{class:"btn btn-primary",onClick:p},"ä¿å­˜è®¾ç½®")])])])):ce("",!0)}}),Rm=He(Pm,[["__scopeId","data-v-e1ec20ab"]]),Dm={minScale:.1,maxScale:5,zoomSpeed:.1};function bn(n={}){const t={...Dm,...n},s=w(1),o=w(0),l=w(0),u=w(!1),a=w(0),c=w(0),m=X(()=>({transform:`translate(${o.value}px, ${l.value}px) scale(${s.value})`}));function p(j,q,Q){const W=Math.min(Math.max(s.value*Q,t.minScale),t.maxScale),se=W/s.value;o.value=j-(j-o.value)*se,l.value=q-(q-l.value)*se,s.value=W,n.onScaleChange?.(s.value),n.onTransformChange?.($())}function _(j,q=800,Q=600){p(q/2,Q/2,j)}function T(){_(1.2)}function M(){_(.8)}function R(j,q=800,Q=600){const W=j/s.value;p(q/2,Q/2,W)}function I(j,q){u.value=!0,a.value=j,c.value=q}function E(j,q){if(!u.value)return;const Q=j-a.value,W=q-c.value;o.value+=Q,l.value+=W,a.value=j,c.value=q,n.onTransformChange?.($())}function H(){u.value=!1}function V(j,q){o.value+=j,l.value+=q,n.onTransformChange?.($())}function F(){s.value=1,o.value=0,l.value=0,n.onScaleChange?.(s.value),n.onTransformChange?.($())}function b(){F()}function v(){s.value=1,o.value=0,l.value=0}function k(j,q,Q,W){if(!j||!q)return;const se=Q/j,S=W/q;s.value=Math.min(se,S)*.95,o.value=(Q-j*s.value)/2,l.value=(W-q*s.value)/2,n.onScaleChange?.(s.value),n.onTransformChange?.($())}function $(){return{scale:s.value,translateX:o.value,translateY:l.value}}function N(j){j.scale!==void 0&&(s.value=j.scale),j.translateX!==void 0&&(o.value=j.translateX),j.translateY!==void 0&&(l.value=j.translateY),n.onTransformChange?.($())}function z(j){s.value=j.scale,o.value=j.translateX,l.value=j.translateY}function ae(j,q,Q){if(!j||j.length<4)return;const[W,se,S,i]=j,P=(W+S)/2,d=(se+i)/2,g=q/2,f=Q/2;o.value=g-P*s.value,l.value=f-d*s.value,n.onTransformChange?.($())}return{scale:s,translateX:o,translateY:l,isDragging:u,transformStyle:m,zoomAt:p,zoom:_,zoomIn:T,zoomOut:M,setScale:R,startDrag:I,drag:E,endDrag:H,pan:V,reset:F,resetZoom:b,resetTransform:v,fitToScreen:k,getTransform:$,setTransform:N,syncWith:z,scrollToBubble:ae}}function Mm(n){const t=et(),s=ze(),o=w(null),l=w(Cs),u=w(!1),a=w(!1),c=w([]),m=w(0),p=w(0);let _=null,T=null,M=null;const R=X(()=>o.value!==null),I=X(()=>o.value==="repair"?{fill:"rgba(76, 175, 80, 0.4)",border:"#4CAF50"}:o.value==="restore"?{fill:"rgba(33, 150, 243, 0.4)",border:"#2196F3"}:{fill:"transparent",border:"transparent"});function E(d){o.value!==d&&(o.value=d,u.value=!0,c.value=[],console.log(`è¿›å…¥${d==="repair"?"ä¿®å¤":"è¿˜åŸ"}ç¬”åˆ·æ¨¡å¼ï¼Œç¬”åˆ·å¤§å°: ${l.value}px`))}function H(){a.value&&N();const d=o.value!==null;o.value=null,u.value=!1,a.value=!1,c.value=[],q(),d&&console.log("é€€å‡ºç¬”åˆ·æ¨¡å¼")}function V(d){o.value===d?H():E(d)}function F(d){l.value=Math.max(tn,Math.min(en,d))}function b(d){F(l.value+d)}function v(d){if(!R.value)return;d.preventDefault(),d.stopPropagation();const g=d.deltaY>0?-5:5;b(g)}function k(d,g){if(!R.value||d.button!==0)return;d.preventDefault(),d.stopPropagation(),a.value=!0,_=g,c.value=[];const f=z(d,g);f&&(c.value.push(f),j(g),Q(f)),console.log("å¼€å§‹ç¬”åˆ·æ¶‚æŠ¹")}function $(d){if(m.value=d.clientX,p.value=d.clientY,!a.value||!R.value)return;const g=z(d,_);g&&(c.value.push(g),Q(g))}function N(){if(!a.value)return;a.value=!1;const d=t.currentImage;if(!d||c.value.length===0){q(),c.value=[];return}const g=ae();if(!g){q(),c.value=[];return}const f=o.value;(async()=>{f==="restore"?await W(d,g):f==="repair"&&await se(d,g),n?.onBrushComplete?.()})(),q(),c.value=[]}function z(d,g){if(!g)return null;const f=g.querySelector(".image-canvas-wrapper"),x=f?.querySelector("img");if(!x||!x.naturalWidth)return null;const h=f.getBoundingClientRect(),D=window.getComputedStyle(f).transform;let Y=1;D&&D!=="none"&&(Y=new DOMMatrix(D).a);const Z=(d.clientX-h.left)/Y,r=(d.clientY-h.top)/Y,y=x.naturalWidth,le=x.naturalHeight;return Z<0||r<0||Z>y||r>le?null:{x:Z,y:r,scale:Y}}function ae(){if(c.value.length===0)return null;const g=c.value[0]?.scale||1,f=l.value/2/g;let x=1/0,h=1/0,D=-1/0,Y=-1/0;for(const Z of c.value)x=Math.min(x,Z.x-f),h=Math.min(h,Z.y-f),D=Math.max(D,Z.x+f),Y=Math.max(Y,Z.y+f);return{x1:Math.max(0,Math.floor(x)),y1:Math.max(0,Math.floor(h)),x2:Math.ceil(D),y2:Math.ceil(Y),path:[...c.value],radius:f}}function j(d){q();const g=d.querySelector(".image-canvas-wrapper"),f=g?.querySelector("img");if(!f)return;const x=document.createElement("canvas");x.id="brushOverlayCanvas",x.width=f.naturalWidth,x.height=f.naturalHeight,x.style.cssText="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100;",g.appendChild(x),T=x,M=x.getContext("2d")}function q(){T&&T.parentNode&&T.parentNode.removeChild(T),T=null,M=null}function Q(d){if(!M||!d)return;const g=I.value.fill,f=l.value/2/(d.scale||1);M.beginPath(),M.arc(d.x,d.y,f,0,Math.PI*2),M.fillStyle=g,M.fill()}async function W(d,g){if(!d.originalDataURL)return;let f;return d.cleanImageData?f="data:image/png;base64,"+d.cleanImageData:f=d.originalDataURL,new Promise(x=>{const h=new Image,D=new Image;let Y=0;const Z=()=>{if(Y++,Y<2)return;const r=document.createElement("canvas");r.width=h.naturalWidth,r.height=h.naturalHeight;const y=r.getContext("2d");if(!y){x();return}y.drawImage(h,0,0);const le=document.createElement("canvas");le.width=r.width,le.height=r.height;const B=le.getContext("2d");if(!B){x();return}B.fillStyle="white";for(const de of g.path)B.beginPath(),B.arc(de.x,de.y,g.radius,0,Math.PI*2),B.fill();y.globalCompositeOperation="destination-out",y.drawImage(le,0,0),y.globalCompositeOperation="destination-over",y.drawImage(D,0,0),y.globalCompositeOperation="source-over";const ee=r.toDataURL("image/png").split(",")[1];t.updateCurrentImage({cleanImageData:ee}),console.log("è¿˜åŸç¬”åˆ·åŒºåŸŸå®Œæˆ"),x()};h.onload=Z,h.onerror=()=>x(),D.onload=Z,D.onerror=()=>x(),h.src=f,D.src=d.originalDataURL})}async function se(d,g){const f=n?.getCurrentRepairSettings?.()||{inpaintMethod:"solid",fillColor:"#FFFFFF"},x=f.inpaintMethod;x==="lama_mpe"||x==="litelama"?await S(d,g,x):await i(d,g,f.fillColor)}async function S(d,g,f="lama_mpe"){let x,h;if(d.cleanImageData)x=d.cleanImageData,h="data:image/png;base64,"+d.cleanImageData;else if(d.originalDataURL)x=d.originalDataURL.split(",")[1],h=d.originalDataURL;else{console.error("æ— æ³•è·å–åŸºç¡€å›¾åƒç”¨äº LAMA ä¿®å¤");return}return new Promise(D=>{const Y=new Image;Y.onload=async()=>{const Z=Y.naturalWidth,r=Y.naturalHeight,y=document.createElement("canvas");y.width=Z,y.height=r;const le=y.getContext("2d");if(!le){console.error("æ— æ³•åˆ›å»ºæ©è†œç”»å¸ƒä¸Šä¸‹æ–‡"),D();return}le.fillStyle="black",le.fillRect(0,0,Z,r),le.fillStyle="white";for(const xe of g.path)le.beginPath(),le.arc(xe.x,xe.y,g.radius,0,Math.PI*2),le.fill();const ee=y.toDataURL("image/png").split(",")[1],de=[g.x1,g.y1,g.x2,g.y2],ve=f==="litelama"?"litelama":"lama_mpe";try{_e("LAMA ä¿®å¤ä¸­...","info");const xe=await So(x,de,{method:"lama",lamaModel:ve,maskData:ee});if(xe.success&&xe.inpainted_image)t.updateCurrentImage({cleanImageData:xe.inpainted_image}),console.log("ä¿®å¤ç¬”åˆ·åŒºåŸŸå®Œæˆï¼ˆLAMA ä¿®å¤ï¼Œç²¾ç¡®æ©è†œï¼‰"),_e("LAMA ä¿®å¤å®Œæˆ","success");else throw new Error(xe.error||"LAMA ä¿®å¤è¿”å›æ— æ•ˆæ•°æ®")}catch(xe){console.error("LAMA ä¿®å¤å¤±è´¥ï¼Œå›é€€åˆ°çº¯è‰²å¡«å……:",xe),_e("LAMA ä¿®å¤å¤±è´¥ï¼Œä½¿ç”¨çº¯è‰²å¡«å……","warning");const we=n?.getCurrentRepairSettings?.();await i(d,g,we?.fillColor)}D()},Y.onerror=()=>{console.error("åŠ è½½å›¾åƒå¤±è´¥ï¼Œæ— æ³•è¿›è¡Œ LAMA ä¿®å¤"),D()},Y.src=h})}async function i(d,g,f){const x=f||s.settings.textStyle.fillColor||"#FFFFFF";let h;if(d.cleanImageData)h="data:image/png;base64,"+d.cleanImageData;else if(d.originalDataURL)h=d.originalDataURL;else return;return new Promise(D=>{const Y=new Image;Y.onload=()=>{const Z=document.createElement("canvas");Z.width=Y.naturalWidth,Z.height=Y.naturalHeight;const r=Z.getContext("2d");if(!r){D();return}r.drawImage(Y,0,0),r.fillStyle=x;for(const le of g.path)r.beginPath(),r.arc(le.x,le.y,g.radius,0,Math.PI*2),r.fill();const y=Z.toDataURL("image/png").split(",")[1];t.updateCurrentImage({cleanImageData:y}),console.log("ä¿®å¤ç¬”åˆ·åŒºåŸŸå®Œæˆï¼ˆçº¯è‰²å¡«å……ï¼‰"),D()},Y.onerror=()=>D(),Y.src=h})}async function P(){const d=t.currentImage;if(!d)return console.warn("ensureCleanBackground: æ²¡æœ‰å½“å‰å›¾ç‰‡"),!1;if(d.cleanImageData)return console.log("ensureCleanBackground: å·²æœ‰å¹²å‡€èƒŒæ™¯"),!0;const g=n?.getCurrentRepairSettings?.();if((g?.inpaintMethod||s.settings.textStyle.inpaintMethod)!=="solid")return console.log("ensureCleanBackground: éçº¯è‰²å¡«å……æ¨¡å¼ï¼Œè·³è¿‡"),!1;if(!d.bubbleStates||d.bubbleStates.length===0)return console.warn("ensureCleanBackground: æ²¡æœ‰æ°”æ³¡æ•°æ®"),!1;if(!d.translatedDataURL&&!d.originalDataURL)return console.warn("ensureCleanBackground: æ²¡æœ‰å›¾ç‰‡æ•°æ®"),!1;console.log("ensureCleanBackground: å°è¯•ä¸ºçº¯è‰²å¡«å……æ¨¡å¼åˆ›å»ºä¸´æ—¶å¹²å‡€èƒŒæ™¯");const x=d.translatedDataURL||d.originalDataURL,h=g?.fillColor||s.settings.textStyle.fillColor||"#FFFFFF";return new Promise(D=>{const Y=new Image;Y.onload=()=>{try{const Z=document.createElement("canvas");Z.width=Y.naturalWidth,Z.height=Y.naturalHeight;const r=Z.getContext("2d");if(!r){console.error("ensureCleanBackground: æ— æ³•è·å– Canvas ä¸Šä¸‹æ–‡"),D(!1);return}r.drawImage(Y,0,0),r.fillStyle=h;for(const le of d.bubbleStates){const[B,ee,de,ve]=le.coords;r.fillRect(B,ee,de-B+1,ve-ee+1)}const y=Z.toDataURL("image/png").split(",")[1];t.updateCurrentImage({cleanImageData:y}),console.log("ensureCleanBackground: æˆåŠŸåˆ›å»ºä¸´æ—¶å¹²å‡€èƒŒæ™¯ï¼ˆçº¯è‰²å¡«å……ï¼‰"),D(!0)}catch(Z){console.error("ensureCleanBackground: Canvas æ“ä½œå¤±è´¥:",Z),D(!1)}},Y.onerror=()=>{console.error("ensureCleanBackground: åŠ è½½å›¾åƒå¤±è´¥"),D(!1)},Y.src=x})}return Nt(()=>{H()}),{brushMode:o,brushSize:l,isBrushKeyDown:u,isBrushPainting:a,mouseX:m,mouseY:p,isActive:R,brushColor:I,BRUSH_MIN_SIZE:tn,BRUSH_MAX_SIZE:en,enterBrushMode:E,exitBrushMode:H,toggleBrushMode:V,setBrushSize:F,adjustBrushSize:b,handleBrushWheel:v,startBrushPainting:k,continueBrushPainting:$,finishBrushPainting:N,getBrushPositionInImage:z,getBrushPathBounds:ae,ensureCleanBackground:P}}function Em(n){return[Math.round(n[0]),Math.round(n[1]),Math.round(n[2]),Math.round(n[3])]}function Bm(n){const t=gt(),s=et(),o=ze(),{bubbles:l,selectedIndex:u,hasSelection:a}=kt(t),{currentImage:c}=kt(s),m=w(!1),p=w(!1),_=w(null),T=w(0),M=w(0),R=w(!1);function I(r){t.selectBubble(r)}function E(r){t.toggleMultiSelect(r)}function H(){t.clearMultiSelect()}function V(r,y){console.log(`å¼€å§‹æ‹–åŠ¨æ°”æ³¡ #${r+1}`)}function F(r,y){}function b(r,y){t.updateBubble(r,{coords:y}),console.log(`æ°”æ³¡ #${r+1} æ‹–åŠ¨å®Œæˆ:`,y),f()}function v(r,y,le){console.log(`å¼€å§‹è°ƒæ•´æ°”æ³¡ #${r+1} å¤§å°ï¼Œæ‰‹æŸ„: ${y}`)}function k(r){}function $(r,y){t.updateBubble(r,{coords:y}),console.log(`æ°”æ³¡ #${r+1} è°ƒæ•´å¤§å°å®Œæˆ:`,y),f()}function N(r,y){console.log(`å¼€å§‹æ—‹è½¬æ°”æ³¡ #${r+1}`)}function z(r){}function ae(r,y){t.updateBubble(r,{rotationAngle:y}),console.log(`æ°”æ³¡ #${r+1} æ—‹è½¬å®Œæˆ: ${y}Â°`),f()}function j(){m.value=!m.value,m.value?console.log("è¿›å…¥ç»˜åˆ¶æ¨¡å¼"):console.log("é€€å‡ºç»˜åˆ¶æ¨¡å¼")}function q(r){t.addBubble(r),t.selectBubble(t.bubbleCount-1),console.log("å·²æ·»åŠ æ–°æ°”æ³¡:",r),n?.onReRender?.()}function Q(r,y){p.value=!0,T.value=r,M.value=y,_.value=[r,y,r,y]}function W(r,y){p.value&&(_.value=[T.value,M.value,r,y])}function se(){if(!p.value||!_.value)return p.value=!1,_.value=null,null;const[r,y,le,B]=_.value,ee=10;if(Math.abs(le-r)<ee||Math.abs(B-y)<ee)return p.value=!1,_.value=null,null;const de=[Math.min(r,le),Math.min(y,B),Math.max(r,le),Math.max(y,B)];return p.value=!1,_.value=null,de}function S(){p.value=!1,_.value=null,m.value=!1}function i(){if(!_.value)return{};const[r,y,le,B]=_.value;return{position:"absolute",left:`${Math.min(r,le)}px`,top:`${Math.min(y,B)}px`,width:`${Math.abs(le-r)}px`,height:`${Math.abs(B-y)}px`,border:"2px dashed #00d4ff",background:"rgba(0, 212, 255, 0.1)",pointerEvents:"none",zIndex:"25",boxSizing:"border-box"}}let P=null,d=!1;const g=150;function f(){P&&clearTimeout(P),P=setTimeout(async()=>{if(d){console.log("è·³è¿‡æ¸²æŸ“ï¼Œä¸Šä¸€æ¬¡æ¸²æŸ“ä»åœ¨è¿›è¡Œä¸­");return}console.log("è§¦å‘å»¶è¿Ÿæ¸²æŸ“é¢„è§ˆ"),d=!0;try{n?.onDelayedPreview?await n.onDelayedPreview():n?.onReRender&&await n.onReRender()}catch(r){console.error("å»¶è¿Ÿæ¸²æŸ“é¢„è§ˆå¤±è´¥:",r)}finally{d=!1}},g)}function x(r){t.updateSelectedBubble(r),f()}function h(){a.value&&(t.deleteSelected(),console.log("å·²åˆ é™¤é€‰ä¸­çš„æ°”æ³¡"),n?.onReRender?.())}async function D(){const r=u.value;if(r<0){console.warn("è¯·å…ˆé€‰ä¸­è¦ä¿®å¤çš„æ°”æ³¡æ¡†");return}const y=l.value[r],le=c.value;if(!y||!le?.originalDataURL){console.warn("æ— æ³•ä¿®å¤èƒŒæ™¯ï¼šç¼ºå°‘æ°”æ³¡æˆ–å›¾ç‰‡æ•°æ®");return}const B=y.inpaintMethod||"solid",ee=y.fillColor||"#FFFFFF",de=y.rotationAngle||0;try{console.log(`å¼€å§‹ä¿®å¤æ°”æ³¡ #${r+1} èƒŒæ™¯ï¼Œæ–¹æ³•: ${B}`);let ve;if(le.cleanImageData)ve=le.cleanImageData;else{const we=le.originalDataURL.match(/^data:image\/[^;]+;base64,(.+)$/);if(ve=we&&we[1]?we[1]:"",!ve){console.error("æ— æ³•è§£æå›¾åƒæ•°æ®");return}}if(B==="lama_mpe"||B==="litelama"){const we=B==="litelama"?"litelama":"lama_mpe",$e=Em(y.coords),ie=await So(ve,$e,{bubbleAngle:de,method:"lama",lamaModel:we});ie.success&&ie.inpainted_image?(s.updateCurrentImage({cleanImageData:ie.inpainted_image}),console.log(`æ°”æ³¡ #${r+1} LAMAèƒŒæ™¯ä¿®å¤æˆåŠŸ`),f()):(console.error("LAMAä¿®å¤å¤±è´¥:",ie.error||"æœªçŸ¥é”™è¯¯"),await Y(y.coords,ee,de),f())}else await Y(y.coords,ee,de),console.log(`æ°”æ³¡ #${r+1} çº¯è‰²å¡«å……ä¿®å¤æˆåŠŸ`),f()}catch(ve){console.error("èƒŒæ™¯ä¿®å¤å‡ºé”™:",ve)}}async function Y(r,y,le=0){const B=c.value;if(!B)return;const[ee,de,ve,xe]=r;let we;if(B.cleanImageData)we="data:image/png;base64,"+B.cleanImageData;else if(B.originalDataURL)we=B.originalDataURL;else{console.error("æ— æ³•æ‰¾åˆ°åŸºç¡€å›¾åƒç”¨äºå¡«å……");return}return new Promise($e=>{const ie=new Image;ie.onload=()=>{const C=document.createElement("canvas");C.width=ie.naturalWidth,C.height=ie.naturalHeight;const J=C.getContext("2d");if(!J){$e();return}if(J.drawImage(ie,0,0),J.fillStyle=y,Math.abs(le)<.1)J.fillRect(ee,de,ve-ee,xe-de);else{const be=(ee+ve)/2,O=(de+xe)/2,te=(ve-ee)/2,he=(xe-de)/2,ge=le*Math.PI/180,Re=Math.cos(ge),Ee=Math.sin(ge),Fe=[[-te,-he],[te,-he],[te,he],[-te,he]].map(([Be,ye])=>[be+Be*Re-ye*Ee,O+Be*Ee+ye*Re]);J.beginPath();const ke=Fe[0];if(ke){J.moveTo(ke[0],ke[1]);for(let Be=1;Be<Fe.length;Be++){const ye=Fe[Be];ye&&J.lineTo(ye[0],ye[1])}}J.closePath(),J.fill()}const fe=C.toDataURL("image/png").split(",")[1];s.updateCurrentImage({cleanImageData:fe}),console.log("å·²å¯¹æ°”æ³¡åŒºåŸŸè¿›è¡Œçº¯è‰²å¡«å……:",r,y,"è§’åº¦:",le),$e()},ie.onerror=()=>{console.error("åŠ è½½åŸºç¡€å›¾åƒå¤±è´¥"),$e()},ie.src=we})}async function Z(r){const y=l.value[r],le=c.value;if(!y||!le?.originalDataURL){console.warn("æ— æ³•è¿›è¡Œ OCR è¯†åˆ«ï¼šç¼ºå°‘æ°”æ³¡æˆ–å›¾ç‰‡æ•°æ®");return}try{console.log(`å¼€å§‹ OCR è¯†åˆ«æ°”æ³¡ #${r+1}`);const B=le.originalDataURL.split(",")[1]||"",ee=o.settings,de=ee.ocrEngine==="paddleocr_vl"?ee.paddleOcrVl?.sourceLanguage||"japanese":ee.sourceLanguage,ve=await In(B,y.coords,ee.ocrEngine||"manga_ocr",{source_language:de,baidu_ocr_api_key:ee.baiduOcr.apiKey,baidu_ocr_secret_key:ee.baiduOcr.secretKey,baidu_version:ee.baiduOcr.version,baidu_source_language:ee.baiduOcr.sourceLanguage,ai_vision_provider:ee.aiVisionOcr.provider,ai_vision_api_key:ee.aiVisionOcr.apiKey,ai_vision_model_name:ee.aiVisionOcr.modelName,ai_vision_ocr_prompt:ee.aiVisionOcr.prompt,custom_ai_vision_base_url:ee.aiVisionOcr.customBaseUrl,ai_vision_min_image_size:ee.aiVisionOcr.minImageSize});ve.success&&ve.text!==void 0?(t.updateBubble(r,{originalText:ve.text}),console.log(`OCR è¯†åˆ«æˆåŠŸ: "${ve.text}"`)):console.error("OCR è¯†åˆ«å¤±è´¥:",ve.error||"æœªçŸ¥é”™è¯¯")}catch(B){console.error("OCR è¯†åˆ«å‡ºé”™:",B)}}return{isDrawingMode:m,isDrawingBox:p,currentDrawingRect:_,isMiddleButtonDown:R,handleBubbleSelect:I,handleBubbleMultiSelect:E,handleClearMultiSelect:H,handleBubbleDragStart:V,handleBubbleDragging:F,handleBubbleDragEnd:b,handleBubbleResizeStart:v,handleBubbleResizing:k,handleBubbleResizeEnd:$,handleBubbleRotateStart:N,handleBubbleRotating:z,handleBubbleRotateEnd:ae,toggleDrawingMode:j,handleDrawBubble:q,startDrawingBox:Q,updateDrawingBox:W,finishDrawingBox:se,cancelDrawing:S,getDrawingRectStyle:i,handleBubbleUpdate:x,deleteSelectedBubbles:h,repairSelectedBubble:D,triggerDelayedPreview:f,handleOcrRecognize:Z}}function Am(n){const t=gt(),s=et(),{bubbles:o}=kt(t),{currentImage:l}=kt(s),u=w(!1),a=w("");let c=null;function m(){const T=l.value;if(!T)return null;if(T.cleanImageData)return T.cleanImageData;if(T.originalDataURL){const M=T.originalDataURL.match(/^data:image\/[^;]+;base64,(.+)$/);if(M&&M[1])return M[1]}return null}async function p(T=!1){if(!l.value)return console.warn("reRenderFullImage: æ²¡æœ‰å½“å‰å›¾ç‰‡"),!1;if(o.value.length===0){console.log("reRenderFullImage: æ²¡æœ‰æ°”æ³¡ï¼Œè·³è¿‡åç«¯æ¸²æŸ“");const E=m();if(E){const H=`data:image/png;base64,${E}`;s.updateCurrentImage({translatedDataURL:H}),T||n?.onRenderSuccess?.(H)}return!0}const R=m();if(!R)return console.error("reRenderFullImage: ç¼ºå°‘å›¾åƒæ•°æ®"),a.value="ç¼ºå°‘å›¾åƒæ•°æ®",T||n?.onRenderError?.("ç¼ºå°‘å›¾åƒæ•°æ®"),!1;const I=Symbol("render");c=I,u.value=!0,a.value="",T||n?.onRenderStart?.();try{console.log("reRenderFullImage: å¼€å§‹é‡æ–°æ¸²æŸ“ï¼Œæ°”æ³¡æ•°é‡:",o.value.length);const E=o.value,H=E.map(v=>v.translatedText||""),V=E.map(v=>v.coords.map(k=>Math.round(k))),F=E.map(v=>({translatedText:v.translatedText||"",coords:v.coords,fontSize:Number(v.fontSize)||24,fontFamily:v.fontFamily||yt,textDirection:Ut(v),textColor:v.textColor||"#231816",rotationAngle:Math.round(Number(v.rotationAngle)||0),position:v.position?{x:Math.round(v.position.x||0),y:Math.round(v.position.y||0)}:{x:0,y:0},strokeEnabled:v.strokeEnabled!==void 0?v.strokeEnabled:!0,strokeColor:v.strokeColor||"#FFFFFF",strokeWidth:Number(v.strokeWidth)||3})),b=await Co({clean_image:R,bubble_texts:H,bubble_coords:V,bubble_states:F,fontSize:Number(E[0]?.fontSize)||24,fontFamily:E[0]?.fontFamily||yt,textDirection:E[0]?Ut(E[0]):"vertical",textColor:E[0]?.textColor||"#231816",strokeEnabled:E[0]?.strokeEnabled!==void 0?E[0].strokeEnabled:!0,strokeColor:E[0]?.strokeColor||"#FFFFFF",strokeWidth:Number(E[0]?.strokeWidth)||3,use_individual_styles:!0,use_inpainting:!1,use_lama:!1,is_font_style_change:!0});if(c!==I)return console.log("reRenderFullImage: æ¸²æŸ“ç»“æœå·²è¿‡æœŸï¼Œå¿½ç•¥"),!1;if(b.rendered_image){const v=`data:image/png;base64,${b.rendered_image}`;return s.updateCurrentImage({translatedDataURL:v}),console.log("reRenderFullImage: æ¸²æŸ“æˆåŠŸ"),T||n?.onRenderSuccess?.(v),!0}else{const v=b.error||"æ¸²æŸ“å¤±è´¥";return console.error("reRenderFullImage: æ¸²æŸ“å¤±è´¥ -",v),a.value=v,T||n?.onRenderError?.(v),!1}}catch(E){if(c!==I)return!1;const H=E instanceof Error?E.message:"æ¸²æŸ“è¯·æ±‚å¤±è´¥";return console.error("reRenderFullImage: æ¸²æŸ“å‡ºé”™ -",E),a.value=H,T||n?.onRenderError?.(H),!1}finally{c===I&&(u.value=!1,T||n?.onRenderEnd?.())}}function _(){c=null,u.value=!1}return{isRendering:u,renderError:a,reRenderFullImage:p,cancelRender:_}}const Lm=["data-index","data-coords","data-rotation","onClick","onMousedown"],Fm={class:"bubble-index"},Um=["data-parent-index","onMousedown"],Om=["data-parent-index","onMousedown"],zm=["data-parent-index","onMousedown"],Nm=["data-parent-index","onMousedown"],Vm=["data-parent-index","onMousedown"],Wm=["data-parent-index","onMousedown"],Km=["data-parent-index","onMousedown"],qm=["data-parent-index","onMousedown"],Hm=["data-parent-index","onMousedown"],jm=je({__name:"BubbleOverlay",props:{bubbles:{},selectedIndex:{},selectedIndices:{},scale:{},isDrawingMode:{type:Boolean},isBrushMode:{type:Boolean},imageWidth:{},imageHeight:{}},emits:["select","multiSelect","dragStart","dragging","dragEnd","resizeStart","resizing","resizeEnd","rotateStart","rotating","rotateEnd","drawBubble"],setup(n,{emit:t}){const s=gt(),{isDragging:o,draggingIndex:l,dragOffsetX:u,dragOffsetY:a,dragInitialX:c,dragInitialY:m,isResizing:p,resizingIndex:_,resizeCurrentCoords:T,isRotating:M,rotatingIndex:R,rotateCurrentAngle:I}=kt(s),E=n,H=t,V=w(null),F=w(0),b=w(0),v=w(""),k=w(0),$=w(0),N=w(null),z=w(0),ae=w(0),j=w(0),q=w(0),Q=w(!1),W=w(0),se=w(0),S=w(null),i=w(!1);function P(C,J){let fe,be,O,te,he=C.rotationAngle||0;if(o.value&&l.value===J){const[Fe,ke,Be,ye]=C.coords;fe=c.value+u.value,be=m.value+a.value,O=fe+(Be-Fe),te=be+(ye-ke)}else p.value&&_.value===J&&T.value?[fe,be,O,te]=T.value:M.value&&R.value===J?([fe,be,O,te]=C.coords,he=I.value):[fe,be,O,te]=C.coords;const ge=O-fe,Re=te-be,Ee={left:`${fe}px`,top:`${be}px`,width:`${ge}px`,height:`${Re}px`};return he&&(Ee.transformOrigin="center center",Ee.transform=`rotate(${he}deg)`),Ee}function d(){if(!S.value)return{};const[C,J,fe,be]=S.value;return{left:`${Math.min(C,fe)}px`,top:`${Math.min(J,be)}px`,width:`${Math.abs(fe-C)}px`,height:`${Math.abs(be-J)}px`}}function g(C){if(!V.value)return null;const J=V.value.getBoundingClientRect(),fe=E.scale||1,be=(C.clientX-J.left)/fe,O=(C.clientY-J.top)/fe;return{x:be,y:O}}function f(C,J){E.isBrushMode||J.shiftKey||H("select",C)}function x(C){if(!E.isBrushMode){if(C.button===1){C.preventDefault(),i.value=!0,document.body.classList.add("middle-button-drawing"),ve(C);return}C.button===0&&E.isDrawingMode&&ve(C)}}function h(C,J){if(!E.isBrushMode&&J.button===0){if(J.preventDefault(),J.stopPropagation(),J.shiftKey){H("multiSelect",C);return}if(C!==E.selectedIndex){H("select",C);return}D(C,J)}}function D(C,J){document.removeEventListener("mousemove",$e),document.removeEventListener("mouseup",ie),o.value=!0,l.value=C,F.value=J.clientX,b.value=J.clientY,u.value=0,a.value=0;const fe=E.bubbles[C];fe&&(c.value=fe.coords[0],m.value=fe.coords[1]),H("dragStart",C,J),document.addEventListener("mousemove",$e),document.addEventListener("mouseup",ie)}function Y(C){const J=E.scale||1,fe=(C.clientX-F.value)/J,be=(C.clientY-b.value)/J;u.value=fe,a.value=be}function Z(C){const J=l.value;o.value=!1,l.value=-1,u.value=0,a.value=0;const fe=E.scale||1,be=(C.clientX-F.value)/fe,O=(C.clientY-b.value)/fe,te=E.bubbles[J];if(!te)return;const[he,ge,Re,Ee]=te.coords,Fe=Re-he,ke=Ee-ge;let Be=Math.round(c.value+be),ye=Math.round(m.value+O);const lt=E.imageWidth||2e3,Ge=E.imageHeight||2e3,Ze=Math.min(Fe,lt),nt=Math.min(ke,Ge);Be=Math.max(0,Math.min(Be,lt-Ze)),ye=Math.max(0,Math.min(ye,Ge-nt));const Ae=[Be,ye,Be+Ze,ye+nt];H("dragEnd",J,Ae)}function r(C,J,fe){if(E.isBrushMode||fe.button!==0)return;fe.preventDefault(),fe.stopPropagation(),document.removeEventListener("mousemove",$e),document.removeEventListener("mouseup",ie),p.value=!0,_.value=J,v.value=C,k.value=fe.clientX,$.value=fe.clientY;const be=E.bubbles[J];be&&(N.value=[...be.coords],T.value=[...be.coords]),H("resizeStart",J,C,fe),document.addEventListener("mousemove",$e),document.addEventListener("mouseup",ie)}function y(C){if(!N.value)return;const J=E.scale||1,fe=(C.clientX-k.value)/J,be=(C.clientY-$.value)/J;let[O,te,he,ge]=N.value;const Re=v.value;Re.includes("w")&&(O+=fe),Re.includes("e")&&(he+=fe),Re.includes("n")&&(te+=be),Re.includes("s")&&(ge+=be),O>he&&([O,he]=[he,O]),te>ge&&([te,ge]=[ge,te]);const Ee=10;he-O<Ee||ge-te<Ee||(T.value=[O,te,he,ge])}function le(C){if(!N.value)return;const J=E.scale||1,fe=(C.clientX-k.value)/J,be=(C.clientY-$.value)/J;let[O,te,he,ge]=N.value;const Re=v.value;Re.includes("w")&&(O+=fe),Re.includes("e")&&(he+=fe),Re.includes("n")&&(te+=be),Re.includes("s")&&(ge+=be),O>he&&([O,he]=[he,O]),te>ge&&([te,ge]=[ge,te]);const Ee=E.imageWidth||2e3,Fe=E.imageHeight||2e3;O=Math.max(0,Math.round(O)),te=Math.max(0,Math.round(te)),he=Math.min(Ee,Math.round(he)),ge=Math.min(Fe,Math.round(ge));const ke=10;if(he-O<ke||ge-te<ke){console.warn("è°ƒæ•´åå°ºå¯¸è¿‡å°ï¼Œå·²æ’¤é”€"),p.value=!1,_.value=-1,N.value=null;return}H("resizeEnd",_.value,[O,te,he,ge]),p.value=!1,_.value=-1,N.value=null,T.value=null}function B(C,J){if(E.isBrushMode||J.button!==0)return;J.preventDefault(),J.stopPropagation(),document.removeEventListener("mousemove",$e),document.removeEventListener("mouseup",ie),M.value=!0,R.value=C;const fe=E.bubbles[C];if(!fe||!V.value)return;const[be,O,te,he]=fe.coords,ge=E.scale||1,Re=V.value.getBoundingClientRect();j.value=Re.left+(be+te)/2*ge,q.value=Re.top+(O+he)/2*ge;const Ee=J.clientX-j.value,Fe=J.clientY-q.value;z.value=Math.atan2(Fe,Ee)*180/Math.PI,ae.value=fe.rotationAngle||0,I.value=fe.rotationAngle||0,H("rotateStart",C,J),document.body.classList.add("rotating-box"),document.addEventListener("mousemove",$e),document.addEventListener("mouseup",ie),console.log(`å¼€å§‹æ—‹è½¬æ°”æ³¡ #${C+1}ï¼Œåˆå§‹è§’åº¦: ${ae.value}Â°`)}function ee(C){const J=C.clientX-j.value,fe=C.clientY-q.value,O=Math.atan2(fe,J)*180/Math.PI-z.value;let te=ae.value+O;for(;te>180;)te-=360;for(;te<-180;)te+=360;C.shiftKey&&(te=Math.round(te/15)*15),I.value=te}function de(C){document.body.classList.remove("rotating-box");const J=R.value,fe=I.value;H("rotateEnd",J,fe),M.value=!1,R.value=-1,console.log(`æ°”æ³¡ #${J+1} æ—‹è½¬å®Œæˆï¼Œè§’åº¦: ${fe}Â°`)}function ve(C){const J=g(C);if(!J)return;const fe=E.imageWidth||2e3,be=E.imageHeight||2e3;J.x<0||J.x>fe||J.y<0||J.y>be||(Q.value=!0,W.value=J.x,se.value=J.y,S.value=[J.x,J.y,J.x,J.y],document.addEventListener("mousemove",$e),document.addEventListener("mouseup",ie),console.log("å¼€å§‹ç»˜åˆ¶æ–°æ¡†:",J.x.toFixed(1),J.y.toFixed(1)))}function xe(C){const J=g(C);!J||!S.value||(S.value=[W.value,se.value,J.x,J.y])}function we(C){const J=g(C);if(i.value&&(i.value=!1,document.body.classList.remove("middle-button-drawing")),!J||!S.value){Q.value=!1,S.value=null;return}const fe=E.imageWidth||2e3,be=E.imageHeight||2e3,O=Math.max(0,Math.round(Math.min(W.value,J.x))),te=Math.max(0,Math.round(Math.min(se.value,J.y))),he=Math.min(fe,Math.round(Math.max(W.value,J.x))),ge=Math.min(be,Math.round(Math.max(se.value,J.y))),Re=10;if(he-O<Re||ge-te<Re){console.log("ç»˜åˆ¶çš„æ¡†å¤ªå°ï¼Œå·²å¿½ç•¥"),Q.value=!1,S.value=null;return}console.log("å®Œæˆç»˜åˆ¶æ–°æ¡†:",[O,te,he,ge]),H("drawBubble",[O,te,he,ge]),Q.value=!1,S.value=null}function $e(C){o.value?Y(C):p.value?y(C):M.value?ee(C):Q.value&&xe(C)}function ie(C){document.removeEventListener("mousemove",$e),document.removeEventListener("mouseup",ie),(C.button===1||i.value)&&(i.value=!1,document.body.classList.remove("middle-button-drawing")),o.value?Z(C):p.value?le(C):M.value?de():Q.value&&we(C)}return dt(()=>{}),Nt(()=>{document.removeEventListener("mousemove",$e),document.removeEventListener("mouseup",ie),document.body.classList.remove("middle-button-drawing"),document.body.classList.remove("rotating-box")}),(C,J)=>(A(),L("div",{class:Ie(["bubble-overlay",{"brush-mode":n.isBrushMode}]),style:st({"--scale":n.scale||1}),ref_key:"overlayRef",ref:V,onMousedown:x},[(A(!0),L(Ve,null,Ye(n.bubbles,(fe,be)=>(A(),L("div",{key:be,class:Ie(["bubble-highlight-box",{selected:be===n.selectedIndex,"multi-selected":n.selectedIndices.length>1&&n.selectedIndices.includes(be)&&be!==n.selectedIndex}]),style:st(P(fe,be)),"data-index":be,"data-coords":JSON.stringify(fe.coords),"data-rotation":fe.rotationAngle||0,onClick:at(O=>f(be,O),["stop"]),onMousedown:at(O=>h(be,O),["stop"])},[e("span",Fm,oe(be+1),1),be===n.selectedIndex?(A(),L(Ve,{key:0},[e("div",{class:"resize-handle nw","data-handle":"nw","data-parent-index":be,onMousedown:at(O=>r("nw",be,O),["stop"])},null,40,Um),e("div",{class:"resize-handle n","data-handle":"n","data-parent-index":be,onMousedown:at(O=>r("n",be,O),["stop"])},null,40,Om),e("div",{class:"resize-handle ne","data-handle":"ne","data-parent-index":be,onMousedown:at(O=>r("ne",be,O),["stop"])},null,40,zm),e("div",{class:"resize-handle e","data-handle":"e","data-parent-index":be,onMousedown:at(O=>r("e",be,O),["stop"])},null,40,Nm),e("div",{class:"resize-handle se","data-handle":"se","data-parent-index":be,onMousedown:at(O=>r("se",be,O),["stop"])},null,40,Vm),e("div",{class:"resize-handle s","data-handle":"s","data-parent-index":be,onMousedown:at(O=>r("s",be,O),["stop"])},null,40,Wm),e("div",{class:"resize-handle sw","data-handle":"sw","data-parent-index":be,onMousedown:at(O=>r("sw",be,O),["stop"])},null,40,Km),e("div",{class:"resize-handle w","data-handle":"w","data-parent-index":be,onMousedown:at(O=>r("w",be,O),["stop"])},null,40,qm),J[0]||(J[0]=e("div",{class:"rotate-line"},null,-1)),e("div",{class:"rotate-handle",title:"æ‹–æ‹½æ—‹è½¬","data-parent-index":be,onMousedown:at(O=>B(be,O),["stop"])},null,40,Hm)],64)):ce("",!0)],46,Lm))),128)),S.value?(A(),L("div",{key:0,class:"drawing-rect",style:st(d())},null,4)):ce("",!0)],38))}}),hn=He(jm,[["__scopeId","data-v-8d9cb1b9"]]),Jm={key:0,class:"kana-keyboard"},Ym={class:"kana-keyboard-header"},Xm={class:"kana-keyboard-tabs"},Gm=["onClick"],Zm={class:"kana-keyboard-options"},Qm={class:"kana-mode-select"},ev={class:"kana-target-select"},tv={class:"kana-table"},ov={class:"row-label"},nv=["onClick"],sv={class:"kana-hiragana"},av={class:"kana-katakana"},lv={class:"kana-table"},iv={class:"row-label"},rv=["onClick"],uv={class:"kana-hiragana"},cv={class:"kana-katakana"},dv={class:"kana-table combo-table"},gv={class:"row-label"},pv=["onClick"],mv={class:"kana-hiragana"},vv={class:"kana-katakana"},fv={class:"special-chars-grid"},bv=["onClick"],hv={key:0,class:"char-label"},xv=je({__name:"JapaneseKeyboard",props:{visible:{type:Boolean,default:!1},defaultTarget:{default:"original"}},emits:["close","insert","delete"],setup(n,{emit:t}){const s=n,o=t,l=w("basic"),u=w("hiragana"),a=w(s.defaultTarget),c=w(null),m=[{label:"åŸæ–‡",value:"original"},{label:"è¯‘æ–‡",value:"translated"}],p=[{id:"basic",label:"åŸºæœ¬"},{id:"dakuten",label:"æµŠ/åŠæµŠéŸ³"},{id:"combo",label:"æ‹—éŸ³"},{id:"special",label:"ç‰¹æ®Š"}],_=[{label:"ã‚è¡Œ",chars:[{h:"ã‚",k:"ã‚¢"},{h:"ã„",k:"ã‚¤"},{h:"ã†",k:"ã‚¦"},{h:"ãˆ",k:"ã‚¨"},{h:"ãŠ",k:"ã‚ª"}]},{label:"ã‹è¡Œ",chars:[{h:"ã‹",k:"ã‚«"},{h:"ã",k:"ã‚­"},{h:"ã",k:"ã‚¯"},{h:"ã‘",k:"ã‚±"},{h:"ã“",k:"ã‚³"}]},{label:"ã•è¡Œ",chars:[{h:"ã•",k:"ã‚µ"},{h:"ã—",k:"ã‚·"},{h:"ã™",k:"ã‚¹"},{h:"ã›",k:"ã‚»"},{h:"ã",k:"ã‚½"}]},{label:"ãŸè¡Œ",chars:[{h:"ãŸ",k:"ã‚¿"},{h:"ã¡",k:"ãƒ"},{h:"ã¤",k:"ãƒ„"},{h:"ã¦",k:"ãƒ†"},{h:"ã¨",k:"ãƒˆ"}]},{label:"ãªè¡Œ",chars:[{h:"ãª",k:"ãƒŠ"},{h:"ã«",k:"ãƒ‹"},{h:"ã¬",k:"ãƒŒ"},{h:"ã­",k:"ãƒ"},{h:"ã®",k:"ãƒ"}]},{label:"ã¯è¡Œ",chars:[{h:"ã¯",k:"ãƒ"},{h:"ã²",k:"ãƒ’"},{h:"ãµ",k:"ãƒ•"},{h:"ã¸",k:"ãƒ˜"},{h:"ã»",k:"ãƒ›"}]},{label:"ã¾è¡Œ",chars:[{h:"ã¾",k:"ãƒ"},{h:"ã¿",k:"ãƒŸ"},{h:"ã‚€",k:"ãƒ "},{h:"ã‚",k:"ãƒ¡"},{h:"ã‚‚",k:"ãƒ¢"}]},{label:"ã‚„è¡Œ",chars:[{h:"ã‚„",k:"ãƒ¤"},null,{h:"ã‚†",k:"ãƒ¦"},null,{h:"ã‚ˆ",k:"ãƒ¨"}]},{label:"ã‚‰è¡Œ",chars:[{h:"ã‚‰",k:"ãƒ©"},{h:"ã‚Š",k:"ãƒª"},{h:"ã‚‹",k:"ãƒ«"},{h:"ã‚Œ",k:"ãƒ¬"},{h:"ã‚",k:"ãƒ­"}]},{label:"ã‚è¡Œ",chars:[{h:"ã‚",k:"ãƒ¯"},null,null,null,{h:"ã‚’",k:"ãƒ²"}]},{label:"ã‚“",chars:[{h:"ã‚“",k:"ãƒ³"},null,null,null,null]}],T=[{label:"ãŒè¡Œ",chars:[{h:"ãŒ",k:"ã‚¬"},{h:"ã",k:"ã‚®"},{h:"ã",k:"ã‚°"},{h:"ã’",k:"ã‚²"},{h:"ã”",k:"ã‚´"}]},{label:"ã–è¡Œ",chars:[{h:"ã–",k:"ã‚¶"},{h:"ã˜",k:"ã‚¸"},{h:"ãš",k:"ã‚º"},{h:"ãœ",k:"ã‚¼"},{h:"ã",k:"ã‚¾"}]},{label:"ã è¡Œ",chars:[{h:"ã ",k:"ãƒ€"},{h:"ã¢",k:"ãƒ‚"},{h:"ã¥",k:"ãƒ…"},{h:"ã§",k:"ãƒ‡"},{h:"ã©",k:"ãƒ‰"}]},{label:"ã°è¡Œ",chars:[{h:"ã°",k:"ãƒ"},{h:"ã³",k:"ãƒ“"},{h:"ã¶",k:"ãƒ–"},{h:"ã¹",k:"ãƒ™"},{h:"ã¼",k:"ãƒœ"}]},{label:"ã±è¡Œ",chars:[{h:"ã±",k:"ãƒ‘"},{h:"ã´",k:"ãƒ”"},{h:"ã·",k:"ãƒ—"},{h:"ãº",k:"ãƒš"},{h:"ã½",k:"ãƒ"}]}],M=[{label:"ãã‚ƒè¡Œ",chars:[{h:"ãã‚ƒ",k:"ã‚­ãƒ£"},{h:"ãã‚…",k:"ã‚­ãƒ¥"},{h:"ãã‚‡",k:"ã‚­ãƒ§"}]},{label:"ã—ã‚ƒè¡Œ",chars:[{h:"ã—ã‚ƒ",k:"ã‚·ãƒ£"},{h:"ã—ã‚…",k:"ã‚·ãƒ¥"},{h:"ã—ã‚‡",k:"ã‚·ãƒ§"}]},{label:"ã¡ã‚ƒè¡Œ",chars:[{h:"ã¡ã‚ƒ",k:"ãƒãƒ£"},{h:"ã¡ã‚…",k:"ãƒãƒ¥"},{h:"ã¡ã‚‡",k:"ãƒãƒ§"}]},{label:"ã«ã‚ƒè¡Œ",chars:[{h:"ã«ã‚ƒ",k:"ãƒ‹ãƒ£"},{h:"ã«ã‚…",k:"ãƒ‹ãƒ¥"},{h:"ã«ã‚‡",k:"ãƒ‹ãƒ§"}]},{label:"ã²ã‚ƒè¡Œ",chars:[{h:"ã²ã‚ƒ",k:"ãƒ’ãƒ£"},{h:"ã²ã‚…",k:"ãƒ’ãƒ¥"},{h:"ã²ã‚‡",k:"ãƒ’ãƒ§"}]},{label:"ã¿ã‚ƒè¡Œ",chars:[{h:"ã¿ã‚ƒ",k:"ãƒŸãƒ£"},{h:"ã¿ã‚…",k:"ãƒŸãƒ¥"},{h:"ã¿ã‚‡",k:"ãƒŸãƒ§"}]},{label:"ã‚Šã‚ƒè¡Œ",chars:[{h:"ã‚Šã‚ƒ",k:"ãƒªãƒ£"},{h:"ã‚Šã‚…",k:"ãƒªãƒ¥"},{h:"ã‚Šã‚‡",k:"ãƒªãƒ§"}]},{label:"ãã‚ƒè¡Œ",chars:[{h:"ãã‚ƒ",k:"ã‚®ãƒ£"},{h:"ãã‚…",k:"ã‚®ãƒ¥"},{h:"ãã‚‡",k:"ã‚®ãƒ§"}]},{label:"ã˜ã‚ƒè¡Œ",chars:[{h:"ã˜ã‚ƒ",k:"ã‚¸ãƒ£"},{h:"ã˜ã‚…",k:"ã‚¸ãƒ¥"},{h:"ã˜ã‚‡",k:"ã‚¸ãƒ§"}]},{label:"ã³ã‚ƒè¡Œ",chars:[{h:"ã³ã‚ƒ",k:"ãƒ“ãƒ£"},{h:"ã³ã‚…",k:"ãƒ“ãƒ¥"},{h:"ã³ã‚‡",k:"ãƒ“ãƒ§"}]},{label:"ã´ã‚ƒè¡Œ",chars:[{h:"ã´ã‚ƒ",k:"ãƒ”ãƒ£"},{h:"ã´ã‚…",k:"ãƒ”ãƒ¥"},{h:"ã´ã‚‡",k:"ãƒ”ãƒ§"}]}],R=[{char:"ã£",label:"ä¿ƒéŸ³"},{char:"ãƒƒ",label:"ä¿ƒéŸ³"},{char:"ãƒ¼",label:"é•¿éŸ³"},{char:"ã€œ",label:"æ³¢æµª"},{char:"ã€‚",label:"å¥å·"},{char:"ã€",label:"é¡¿å·"},{char:"ã€Œ",label:"å¼•å·"},{char:"ã€",label:"å¼•å·"},{char:"ã€",label:"åŒå¼•"},{char:"ã€",label:"åŒå¼•"},{char:"â€¦",label:"çœç•¥"},{char:"ãƒ»",label:"ä¸­ç‚¹"},{char:"ï¼",label:"æ„Ÿå¹"},{char:"ï¼Ÿ",label:"é—®å·"},{char:"â™ª",label:"éŸ³ç¬¦"},{char:"â™¡",label:"å¿ƒå½¢"},{char:"â˜…",label:"æ˜Ÿå½¢"},{char:"â˜†",label:"ç©ºæ˜Ÿ"},{char:"ã",label:"å°ã‚"},{char:"ãƒ",label:"å°ã„"},{char:"ã…",label:"å°ã†"},{char:"ã‡",label:"å°ãˆ"},{char:"ã‰",label:"å°ãŠ"},{char:"ã‚¡",label:"å°ã‚¢"},{char:"ã‚£",label:"å°ã‚¤"},{char:"ã‚¥",label:"å°ã‚¦"},{char:"ã‚§",label:"å°ã‚¨"},{char:"ã‚©",label:"å°ã‚ª"},{char:"ã‚ƒ",label:"å°ã‚„"},{char:"ã‚…",label:"å°ã‚†"},{char:"ã‚‡",label:"å°ã‚ˆ"},{char:"ãƒ£",label:"å°ãƒ¤"},{char:"ãƒ¥",label:"å°ãƒ¦"},{char:"ãƒ§",label:"å°ãƒ¨"}];function I(){o("close")}function E(F){const b=u.value==="hiragana"?F.h:F.k;c.value=F.h,setTimeout(()=>{c.value=null},100),o("insert",b,a.value)}function H(F){c.value=F,setTimeout(()=>{c.value=null},100),o("insert",F,a.value)}function V(){o("delete",a.value)}return(F,b)=>n.visible?(A(),L("div",Jm,[e("div",Ym,[b[3]||(b[3]=e("span",{class:"kana-keyboard-title"},"50éŸ³é”®ç›˜",-1)),e("div",Xm,[(A(),L(Ve,null,Ye(p,v=>e("button",{key:v.id,class:Ie(["kana-tab",{active:l.value===v.id}]),onClick:k=>l.value=v.id},oe(v.label),11,Gm)),64))]),e("button",{class:"kana-keyboard-close",onClick:I},"âœ•")]),e("div",Zm,[e("div",Qm,[e("label",null,[ne(e("input",{type:"radio",name:"kanaMode",value:"hiragana","onUpdate:modelValue":b[0]||(b[0]=v=>u.value=v)},null,512),[[rn,u.value]]),b[4]||(b[4]=me(" å¹³å‡å ",-1))]),e("label",null,[ne(e("input",{type:"radio",name:"kanaMode",value:"katakana","onUpdate:modelValue":b[1]||(b[1]=v=>u.value=v)},null,512),[[rn,u.value]]),b[5]||(b[5]=me(" ç‰‡å‡å ",-1))])]),e("div",ev,[b[6]||(b[6]=e("label",null,"è¾“å…¥åˆ°ï¼š",-1)),Ce(Ke,{modelValue:a.value,"onUpdate:modelValue":b[2]||(b[2]=v=>a.value=v),options:m},null,8,["modelValue"])])]),e("div",{class:Ie(["kana-tab-content",{active:l.value==="basic"}])},[e("table",tv,[b[7]||(b[7]=e("thead",null,[e("tr",null,[e("th"),e("th",null,"ã‚æ®µ"),e("th",null,"ã„æ®µ"),e("th",null,"ã†æ®µ"),e("th",null,"ãˆæ®µ"),e("th",null,"ãŠæ®µ")])],-1)),e("tbody",null,[(A(),L(Ve,null,Ye(_,v=>e("tr",{key:v.label},[e("td",ov,oe(v.label),1),(A(!0),L(Ve,null,Ye(v.chars,(k,$)=>(A(),L("td",{key:$},[k?(A(),L("button",{key:0,class:Ie(["kana-key",{pressed:c.value===k.h}]),onClick:N=>E(k)},[e("span",sv,oe(k.h),1),e("span",av,oe(k.k),1)],10,nv)):ce("",!0)]))),128))])),64))])])],2),e("div",{class:Ie(["kana-tab-content",{active:l.value==="dakuten"}])},[e("table",lv,[b[8]||(b[8]=e("thead",null,[e("tr",null,[e("th"),e("th",null,"ã‚æ®µ"),e("th",null,"ã„æ®µ"),e("th",null,"ã†æ®µ"),e("th",null,"ãˆæ®µ"),e("th",null,"ãŠæ®µ")])],-1)),e("tbody",null,[(A(),L(Ve,null,Ye(T,v=>e("tr",{key:v.label},[e("td",iv,oe(v.label),1),(A(!0),L(Ve,null,Ye(v.chars,(k,$)=>(A(),L("td",{key:$},[k?(A(),L("button",{key:0,class:Ie(["kana-key",{pressed:c.value===k.h}]),onClick:N=>E(k)},[e("span",uv,oe(k.h),1),e("span",cv,oe(k.k),1)],10,rv)):ce("",!0)]))),128))])),64))])])],2),e("div",{class:Ie(["kana-tab-content",{active:l.value==="combo"}])},[e("table",dv,[b[9]||(b[9]=e("thead",null,[e("tr",null,[e("th"),e("th",null,"ã‚ƒ"),e("th",null,"ã‚…"),e("th",null,"ã‚‡")])],-1)),e("tbody",null,[(A(),L(Ve,null,Ye(M,v=>e("tr",{key:v.label},[e("td",gv,oe(v.label),1),(A(!0),L(Ve,null,Ye(v.chars,(k,$)=>(A(),L("td",{key:$},[k?(A(),L("button",{key:0,class:Ie(["kana-key",{pressed:c.value===k.h}]),onClick:N=>E(k)},[e("span",mv,oe(k.h),1),e("span",vv,oe(k.k),1)],10,pv)):ce("",!0)]))),128))])),64))])])],2),e("div",{class:Ie(["kana-tab-content",{active:l.value==="special"}])},[e("div",fv,[(A(),L(Ve,null,Ye(R,v=>e("button",{key:v.char,class:Ie(["kana-key special-key",{pressed:c.value===v.char}]),onClick:k=>H(v.char)},[me(oe(v.char)+" ",1),v.label?(A(),L("span",hv,oe(v.label),1)):ce("",!0)],10,bv)),64))])],2),e("div",{class:"kana-keyboard-footer"},[e("button",{class:"kana-backspace",onClick:V},"âŒ« é€€æ ¼")])])):ce("",!0)}}),yv=He(xv,[["__scopeId","data-v-ebfc2125"]]),_v={class:"edit-panel-content"},Cv={class:"text-column original-text-column text-block"},Sv={class:"text-column-header"},kv=["disabled"],wv={class:"text-column translated-text-column text-block"},$v={class:"text-column-header"},Tv=["disabled"],Iv={class:"style-settings-section text-block"},Pv={class:"office-toolbar"},Rv={class:"toolbar-row toolbar-row-top"},Dv={class:"combo-control font-control"},Mv={class:"combo-control size-control"},Ev={class:"size-input-wrap"},Bv=["min","max","step"],Av={class:"toolbar-row toolbar-row-actions"},Lv={class:"toolbar-icon-group","aria-label":"æ’ç‰ˆæ–¹å‘"},Fv=["data-active"],Uv=["data-active"],Ov={class:"toolbar-color-group"},zv={class:"toolbar-color-picker",title:"æ–‡å­—é¢œè‰²"},Nv={class:"toolbar-inpaint-group",title:"èƒŒæ™¯ä¿®å¤æ–¹å¼"},Vv={class:"toolbar-stroke-cluster"},Wv=["data-active"],Kv={class:"toolbar-row toolbar-row-bottom"},qv={class:"toolbar-rotation-group",title:"æ—‹è½¬è§’åº¦"},Hv={class:"toolbar-position-group",title:"ä½ç½®è°ƒæ•´"},jv={class:"toolbar-position-value"},Jv={class:"fontsize-presets-panel"},Yv={class:"font-size-presets"},Xv=["onClick"],Ht=2,Gv=je({__name:"BubbleEditor",props:{bubble:{},bubbleIndex:{},isOcrLoading:{type:Boolean},isTranslateLoading:{type:Boolean}},emits:["update","reRender","ocrRecognize","reTranslate","applyBubble","resetCurrent"],setup(n,{emit:t}){const s=n,o=t,l=gt(),u={originalText:"",translatedText:"",fontSize:24,fontFamily:yt,textDirection:"vertical",textColor:"#231816",fillColor:"#FFFFFF",strokeEnabled:!0,strokeColor:"#FFFFFF",strokeWidth:3,rotationAngle:0,inpaintMethod:"solid",position:{x:0,y:0}},a=w(""),c=w(""),m=w(24),p=w(yt),_=w("vertical"),T=w("#231816"),M=w("#FFFFFF"),R=w(!0),I=w("#FFFFFF"),E=w(3),H=w(0),V=w("solid"),F=w(0),b=w(0),v=w(null),k=w(null),$=w(null),N=w(null),z=w(null),ae=w(!1),j=w("original"),q=w([{name:"æ€æºé»‘ä½“",path:yt},{name:"åæ–‡æ¥·ä½“",path:"fonts/STKAITI.TTF"},{name:"åæ–‡ç»†é»‘",path:"fonts/STXIHEI.TTF"},{name:"é»‘ä½“",path:"fonts/SIMHEI.TTF"},{name:"å®‹ä½“",path:"fonts/SIMSUN.TTC"}]),Q=w([]),W=X(()=>s.bubble?s.bubble.coords[0]+F.value:0),se=X(()=>s.bubble?s.bubble.coords[1]+b.value:0),S=X(()=>{const Ae=[{label:"ç³»ç»Ÿå­—ä½“",options:q.value.map(U=>({label:U.name,value:U.path}))}];return Q.value.length>0&&Ae.push({label:"è‡ªå®šä¹‰å­—ä½“",options:Q.value.map(U=>({label:U.name,value:U.path}))}),Ae}),i=[{label:"çº¯è‰²å¡«å……",value:"solid"},{label:"LAMAä¿®å¤(æ¼«ç”»)",value:"lama_mpe"},{label:"LAMAä¿®å¤(é€šç”¨)",value:"litelama"}];function P(Ae){const U=Ae||u;a.value=U.originalText,c.value=U.translatedText,m.value=U.fontSize,p.value=U.fontFamily,_.value=U.textDirection,T.value=U.textColor,M.value=U.fillColor,R.value=U.strokeEnabled,I.value=U.strokeColor,E.value=U.strokeWidth,H.value=U.rotationAngle,V.value=U.inpaintMethod,F.value=U.position?.x||0,b.value=U.position?.y||0}Se(()=>s.bubble,Ae=>{P(Ae)},{deep:!0,immediate:!0});function d(){o("update",{originalText:a.value})}function g(){o("update",{translatedText:c.value})}function f(){navigator.clipboard.writeText(a.value)}function x(){navigator.clipboard.writeText(c.value)}function h(){o("update",{fontSize:m.value})}function D(Ae){m.value=Ae,o("update",{fontSize:Ae})}function Y(){m.value=Math.min(on,m.value+go),o("update",{fontSize:m.value})}function Z(){m.value=Math.max(nn,m.value-go),o("update",{fontSize:m.value})}function r(){o("update",{fontFamily:p.value})}function y(Ae){_.value=Ae,o("update",{textDirection:Ae})}function le(){$.value?.click()}function B(){o("update",{textColor:T.value})}function ee(){N.value?.click()}function de(){o("update",{fillColor:M.value})}function ve(){z.value?.click()}function xe(){o("update",{strokeColor:I.value})}function we(){R.value=!R.value,o("update",{strokeEnabled:R.value})}function $e(){o("update",{strokeWidth:E.value})}function ie(){o("update",{inpaintMethod:V.value})}function C(){o("update",{rotationAngle:H.value})}function J(){H.value=Math.max(-180,H.value-5),o("update",{rotationAngle:H.value})}function fe(){H.value=Math.min(180,H.value+5),o("update",{rotationAngle:H.value})}function be(){H.value=0,o("update",{rotationAngle:0})}function O(){F.value-=Ht,o("update",{position:{x:F.value,y:b.value}})}function te(){F.value+=Ht,o("update",{position:{x:F.value,y:b.value}})}function he(){b.value-=Ht,o("update",{position:{x:F.value,y:b.value}})}function ge(){b.value+=Ht,o("update",{position:{x:F.value,y:b.value}})}function Re(){F.value=0,b.value=0,o("update",{position:{x:0,y:0}})}function Ee(){o("applyBubble",s.bubbleIndex)}function Fe(){l.updateAllBubbles({fontSize:m.value,fontFamily:p.value,textDirection:_.value,textColor:T.value,fillColor:M.value,strokeEnabled:R.value,strokeColor:I.value,strokeWidth:E.value,inpaintMethod:V.value}),console.log("æ ·å¼å·²åº”ç”¨åˆ°æ‰€æœ‰æ°”æ³¡"),o("reRender")}function ke(){o("resetCurrent",s.bubbleIndex)}function Be(){o("ocrRecognize",s.bubbleIndex)}function ye(){o("reTranslate",s.bubbleIndex)}function lt(){ae.value=!ae.value}function Ge(Ae,U){if(U==="original"){const re=v.value;if(re){const Pe=re.selectionStart||a.value.length,De=re.selectionEnd||a.value.length,tt=a.value;a.value=tt.slice(0,Pe)+Ae+tt.slice(De),pt(()=>{re.selectionStart=re.selectionEnd=Pe+Ae.length,re.focus()}),o("update",{originalText:a.value})}}else{const re=k.value;if(re){const Pe=re.selectionStart||c.value.length,De=re.selectionEnd||c.value.length,tt=c.value;c.value=tt.slice(0,Pe)+Ae+tt.slice(De),pt(()=>{re.selectionStart=re.selectionEnd=Pe+Ae.length,re.focus()}),o("update",{translatedText:c.value})}}}function Ze(Ae){if(Ae==="original"){const U=v.value;if(U&&a.value.length>0){const re=U.selectionStart||a.value.length,Pe=U.selectionEnd||a.value.length,De=a.value;re===Pe&&re>0?(a.value=De.slice(0,re-1)+De.slice(Pe),pt(()=>{U.selectionStart=U.selectionEnd=re-1,U.focus()})):re!==Pe&&(a.value=De.slice(0,re)+De.slice(Pe),pt(()=>{U.selectionStart=U.selectionEnd=re,U.focus()})),o("update",{originalText:a.value})}}else{const U=k.value;if(U&&c.value.length>0){const re=U.selectionStart||c.value.length,Pe=U.selectionEnd||c.value.length,De=c.value;re===Pe&&re>0?(c.value=De.slice(0,re-1)+De.slice(Pe),pt(()=>{U.selectionStart=U.selectionEnd=re-1,U.focus()})):re!==Pe&&(c.value=De.slice(0,re)+De.slice(Pe),pt(()=>{U.selectionStart=U.selectionEnd=re,U.focus()})),o("update",{translatedText:c.value})}}}async function nt(){try{const Ae=await Ns();if(Ae.fonts){const U=[],re=[];for(const Pe of Ae.fonts){const De={name:typeof Pe=="string"?Pe:Pe.display_name||Pe.file_name||"",path:typeof Pe=="string"?Pe:Pe.path};De.path.startsWith("fonts/")?U.push(De):re.push(De)}U.length>0&&(q.value=U),Q.value=re}}catch(Ae){console.error("åŠ è½½å­—ä½“åˆ—è¡¨å¤±è´¥:",Ae)}}return dt(()=>{nt()}),(Ae,U)=>(A(),L("div",_v,[e("div",Cv,[e("div",Sv,[U[14]||(U[14]=e("span",{class:"column-title"},"ğŸ‡¯ğŸ‡µ æ—¥è¯­åŸæ–‡ (OCRç»“æœ)",-1)),e("button",{class:Ie(["re-ocr-btn",{"is-loading":n.isOcrLoading}]),disabled:n.isOcrLoading,onClick:Be,title:"é‡æ–°OCRæ­¤æ°”æ³¡"},[...U[13]||(U[13]=[e("span",{class:"btn-icon"},"ğŸ”„",-1)])],10,kv)]),ne(e("textarea",{ref_key:"originalTextInput",ref:v,"onUpdate:modelValue":U[0]||(U[0]=re=>a.value=re),class:"text-editor original-editor",placeholder:"OCRè¯†åˆ«çš„æ—¥è¯­åŸæ–‡...",spellcheck:"false",onInput:d},null,544),[[Te,a.value]]),e("div",{class:"text-actions"},[e("button",{class:"copy-btn",onClick:f},"ğŸ“‹ å¤åˆ¶"),e("button",{class:"keyboard-toggle-btn",onClick:lt,title:"æ˜¾ç¤º/éšè—50éŸ³é”®ç›˜"}," âŒ¨ï¸ 50éŸ³ ")]),Ce(yv,{visible:ae.value,"default-target":j.value,onClose:U[1]||(U[1]=re=>ae.value=!1),onInsert:Ge,onDelete:Ze},null,8,["visible","default-target"])]),e("div",wv,[e("div",$v,[U[16]||(U[16]=e("span",{class:"column-title"},"ğŸ‡¨ğŸ‡³ ä¸­æ–‡è¯‘æ–‡",-1)),e("button",{class:Ie(["re-translate-btn",{"is-loading":n.isTranslateLoading}]),disabled:n.isTranslateLoading,onClick:ye,title:"é‡æ–°ç¿»è¯‘æ­¤æ°”æ³¡"},[...U[15]||(U[15]=[e("span",{class:"btn-icon"},"ğŸ”„",-1)])],10,Tv)]),ne(e("textarea",{ref_key:"translatedTextInput",ref:k,"onUpdate:modelValue":U[2]||(U[2]=re=>c.value=re),class:"text-editor translated-editor",placeholder:"ç¿»è¯‘åçš„ä¸­æ–‡...",spellcheck:"false",onInput:g},null,544),[[Te,c.value]]),e("div",{class:"text-actions"},[e("button",{class:"copy-btn",onClick:x},"ğŸ“‹ å¤åˆ¶"),e("button",{class:"apply-text-btn",onClick:Ee},"âœ“ åº”ç”¨æ–‡æœ¬")])]),e("div",Iv,[e("div",Pv,[e("div",Rv,[e("div",Dv,[U[17]||(U[17]=e("label",null,"å­—ä½“",-1)),Ce(Ke,{modelValue:p.value,"onUpdate:modelValue":U[3]||(U[3]=re=>p.value=re),groups:S.value,title:"å­—ä½“",onChange:r},null,8,["modelValue","groups"])]),e("div",Mv,[U[18]||(U[18]=e("label",null,"å­—å·",-1)),e("div",Ev,[ne(e("input",{type:"number","onUpdate:modelValue":U[4]||(U[4]=re=>m.value=re),class:"toolbar-fontsize-input",min:K(nn),max:K(on),step:K(go),title:"å­—å·",onChange:h},null,40,Bv),[[Te,m.value,void 0,{number:!0}]]),e("div",{class:"toolbar-fontsize-btns"},[e("button",{class:"toolbar-fontsize-btn",onClick:Y,title:"å¢å¤§å­—å·"}," A+ "),e("button",{class:"toolbar-fontsize-btn",onClick:Z,title:"å‡å°å­—å·"}," A- ")])])])]),e("div",Av,[e("div",Lv,[e("button",{class:"toolbar-btn","data-active":_.value==="vertical",onClick:U[5]||(U[5]=re=>y("vertical")),title:"ç«–å‘æ’ç‰ˆ"},[...U[19]||(U[19]=[e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("path",{d:"M8 2v12M8 2L5 5M8 2l3 3",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])],8,Fv),e("button",{class:"toolbar-btn","data-active":_.value==="horizontal",onClick:U[6]||(U[6]=re=>y("horizontal")),title:"æ¨ªå‘æ’ç‰ˆ"},[...U[20]||(U[20]=[e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("path",{d:"M2 8h12M14 8l-3-3M14 8l-3 3",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])],8,Uv)]),U[26]||(U[26]=e("div",{class:"toolbar-divider vertical"},null,-1)),e("div",Ov,[e("div",zv,[e("button",{class:"toolbar-btn toolbar-color-btn",onClick:le},[U[21]||(U[21]=e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("text",{x:"3",y:"11","font-size":"10","font-weight":"bold",fill:"currentColor"},"A")],-1)),e("span",{class:"color-indicator",style:st({background:T.value})},null,4)]),ne(e("input",{ref_key:"textColorInput",ref:$,type:"color","onUpdate:modelValue":U[7]||(U[7]=re=>T.value=re),class:"hidden-color-input",onInput:B,onChange:B},null,544),[[Te,T.value]])])]),U[27]||(U[27]=e("div",{class:"toolbar-divider vertical"},null,-1)),e("div",Nv,[Ce(Ke,{modelValue:V.value,"onUpdate:modelValue":U[8]||(U[8]=re=>V.value=re),options:i,onChange:ie},null,8,["modelValue"]),e("div",{class:Ie(["toolbar-color-picker toolbar-solid-color-options",{hidden:V.value!=="solid"}])},[e("button",{class:"toolbar-btn toolbar-color-btn",onClick:ee},[U[22]||(U[22]=e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("rect",{x:"2",y:"2",width:"12",height:"12",rx:"2",fill:"none",stroke:"currentColor","stroke-width":"1.2"}),e("rect",{x:"4",y:"4",width:"8",height:"8",rx:"1",fill:"currentColor",opacity:"0.3"})],-1)),e("span",{class:"color-indicator",style:st({background:M.value})},null,4)]),ne(e("input",{ref_key:"fillColorInput",ref:N,type:"color","onUpdate:modelValue":U[9]||(U[9]=re=>M.value=re),class:"hidden-color-input",onChange:de},null,544),[[Te,M.value]])],2)]),U[28]||(U[28]=e("div",{class:"toolbar-divider vertical"},null,-1)),e("div",Vv,[e("button",{class:"toolbar-btn","data-active":R.value,onClick:we,title:"æ–‡å­—æè¾¹"},[...U[23]||(U[23]=[e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("text",{x:"3",y:"12","font-size":"11","font-weight":"bold",stroke:"currentColor","stroke-width":"2",fill:"none"}," A "),e("text",{x:"3",y:"12","font-size":"11","font-weight":"bold",fill:"currentColor"},"A")],-1)])],8,Wv),e("div",{class:Ie(["toolbar-color-picker toolbar-stroke-options",{hidden:!R.value}]),title:"æè¾¹é¢œè‰²"},[e("button",{class:"toolbar-btn toolbar-color-btn",onClick:ve},[U[24]||(U[24]=e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("circle",{cx:"8",cy:"8",r:"5",fill:"none",stroke:"currentColor","stroke-width":"2"})],-1)),e("span",{class:"color-indicator",style:st({background:I.value})},null,4)]),ne(e("input",{ref_key:"strokeColorInput",ref:z,type:"color","onUpdate:modelValue":U[10]||(U[10]=re=>I.value=re),class:"hidden-color-input",onChange:xe},null,544),[[Te,I.value]])],2),e("div",{class:Ie(["toolbar-stroke-width toolbar-stroke-options",{hidden:!R.value}]),title:"æè¾¹å®½åº¦"},[ne(e("input",{type:"number","onUpdate:modelValue":U[11]||(U[11]=re=>E.value=re),class:"toolbar-mini-input",min:"0",max:"10",onChange:$e},null,544),[[Te,E.value,void 0,{number:!0}]]),U[25]||(U[25]=e("span",{class:"toolbar-unit"},"px",-1))],2)])]),e("div",Kv,[e("div",qv,[e("button",{class:"toolbar-btn",onClick:J,title:"é€†æ—¶é’ˆæ—‹è½¬"},[...U[29]||(U[29]=[e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("path",{d:"M2 8a6 6 0 1 1 1.5 4",stroke:"currentColor","stroke-width":"1.5",fill:"none"}),e("path",{d:"M2 5v3.5h3.5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),ne(e("input",{type:"number","onUpdate:modelValue":U[12]||(U[12]=re=>H.value=re),class:"toolbar-mini-input toolbar-rotation-input",min:"-180",max:"180",step:"5",onChange:C},null,544),[[Te,H.value,void 0,{number:!0}]]),U[31]||(U[31]=e("span",{class:"toolbar-unit"},"Â°",-1)),e("button",{class:"toolbar-btn",onClick:fe,title:"é¡ºæ—¶é’ˆæ—‹è½¬"},[...U[30]||(U[30]=[e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("path",{d:"M14 8a6 6 0 1 0-1.5 4",stroke:"currentColor","stroke-width":"1.5",fill:"none"}),e("path",{d:"M14 5v3.5h-3.5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),e("button",{class:"toolbar-btn toolbar-small-btn",onClick:be,title:"é‡ç½®æ—‹è½¬"}," 0 ")]),U[37]||(U[37]=e("div",{class:"toolbar-divider vertical"},null,-1)),e("div",Hv,[e("button",{class:"toolbar-btn",onClick:O,title:"å·¦ç§»"},[...U[32]||(U[32]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("path",{d:"M10 3L5 8l5 5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),e("button",{class:"toolbar-btn",onClick:te,title:"å³ç§»"},[...U[33]||(U[33]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("path",{d:"M6 3l5 5-5 5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),e("button",{class:"toolbar-btn",onClick:he,title:"ä¸Šç§»"},[...U[34]||(U[34]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("path",{d:"M3 10l5-5 5 5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),e("button",{class:"toolbar-btn",onClick:ge,title:"ä¸‹ç§»"},[...U[35]||(U[35]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("path",{d:"M3 6l5 5 5-5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),e("span",jv,[e("span",null,oe(W.value),1),U[36]||(U[36]=me(",",-1)),e("span",null,oe(se.value),1)]),e("button",{class:"toolbar-btn toolbar-small-btn",onClick:Re,title:"é‡ç½®ä½ç½®"}," âŒ‚ ")])])]),e("details",Jv,[U[38]||(U[38]=e("summary",null,"å­—å·é¢„è®¾",-1)),e("div",Yv,[(A(!0),L(Ve,null,Ye(K(Ss),re=>(A(),L("button",{key:re,class:Ie(["preset-btn",{active:m.value===re}]),onClick:Pe=>D(re)},oe(re),11,Xv))),128))])]),e("div",{class:"edit-action-buttons"},[e("button",{class:"btn-apply",onClick:Ee},"åº”ç”¨"),e("button",{class:"btn-apply-all",onClick:Fe},"åº”ç”¨å…¨éƒ¨"),e("button",{class:"btn-reset",onClick:ke},"é‡ç½®")])])]))}}),Zv=He(Gv,[["__scopeId","data-v-9d0b72d7"]]),Qv={class:"edit-toolbar-wrapper"},ef={class:"edit-toolbar toolbar-row-1"},tf={class:"image-navigator"},of=["disabled"],nf=["disabled"],sf={class:"bubble-navigator"},af=["disabled"],lf={class:"bubble-indicator"},rf={id:"currentBubbleNum"},uf={id:"totalBubbleNum"},cf=["disabled"],df={class:"view-controls"},gf={key:0,viewBox:"0 0 20 20",width:"16",height:"16"},pf={key:1,viewBox:"0 0 20 20",width:"16",height:"16"},mf={id:"zoomLevel"},vf={class:"edit-toolbar toolbar-row-2"},ff={class:"annotation-tools"},bf=["disabled"],hf=["disabled"],xf={key:0,class:"brush-size-indicator"},yf={key:1,class:"brush-mode-hint"},_f={class:"edit-progress-info"},Cf={class:"edit-progress-text"},Sf={class:"edit-progress-count"},kf={class:"edit-progress-bar"},wf={class:"quick-actions"},$f=je({__name:"EditToolbar",props:{currentImageIndex:{},imageCount:{},canGoPrevious:{type:Boolean},canGoNext:{type:Boolean},showThumbnails:{type:Boolean},hasBubbles:{type:Boolean},selectedBubbleIndex:{},bubbleCount:{},layoutMode:{},syncEnabled:{type:Boolean},scale:{},isDrawingMode:{type:Boolean},hasSelection:{type:Boolean},brushMode:{},brushSize:{},mouseX:{},mouseY:{},isProcessing:{type:Boolean},progressText:{},progressCurrent:{},progressTotal:{},isRepairLoading:{type:Boolean}},emits:["go-previous-image","go-next-image","toggle-thumbnails","select-previous-bubble","select-next-bubble","toggle-layout","toggle-view-mode","toggle-sync","fit-to-screen","zoom-in","zoom-out","reset-zoom","exit-edit-mode","auto-detect-bubbles","detect-all-images","translate-with-bubbles","toggle-drawing-mode","delete-selected-bubbles","repair-selected-bubble","activate-repair-brush","activate-restore-brush","apply-and-next"],setup(n){const t=n,s=X(()=>t.progressTotal===0?0:Math.round(t.progressCurrent/t.progressTotal*100)),o=X(()=>t.progressTotal>0&&t.progressCurrent>=t.progressTotal),l=X(()=>{const u=t.brushMode==="repair"?{fill:"rgba(76, 175, 80, 0.4)",border:"#4CAF50"}:{fill:"rgba(33, 150, 243, 0.4)",border:"#2196F3"};return{position:"fixed",left:`${t.mouseX}px`,top:`${t.mouseY}px`,width:`${t.brushSize}px`,height:`${t.brushSize}px`,borderRadius:"50%",border:`2px solid ${u.border}`,backgroundColor:u.fill,pointerEvents:"none",zIndex:99999,transform:"translate(-50%, -50%)",display:t.brushMode?"block":"none"}});return(u,a)=>(A(),L("div",Qv,[e("div",ef,[e("div",tf,[e("button",{class:"nav-btn",disabled:!n.canGoPrevious,onClick:a[0]||(a[0]=c=>u.$emit("go-previous-image")),title:"ä¸Šä¸€å¼ å›¾ç‰‡ (PageUp)"}," â—€â—€ ",8,of),e("span",{class:"image-indicator",onClick:a[1]||(a[1]=c=>u.$emit("toggle-thumbnails")),title:"ç‚¹å‡»å±•å¼€ç¼©ç•¥å›¾"},[a[23]||(a[23]=me(" å›¾ ",-1)),e("span",null,oe(n.currentImageIndex+1),1),a[24]||(a[24]=me(" / ",-1)),e("span",null,oe(n.imageCount),1)]),e("button",{class:"nav-btn",disabled:!n.canGoNext,onClick:a[2]||(a[2]=c=>u.$emit("go-next-image")),title:"ä¸‹ä¸€å¼ å›¾ç‰‡ (PageDown)"}," â–¶â–¶ ",8,nf),e("button",{class:Ie(["thumb-toggle-btn",{active:n.showThumbnails}]),onClick:a[3]||(a[3]=c=>u.$emit("toggle-thumbnails")),title:"æ˜¾ç¤º/éšè—ç¼©ç•¥å›¾"}," â˜· ",2)]),a[30]||(a[30]=e("div",{class:"toolbar-divider"},null,-1)),e("div",sf,[e("button",{id:"prevBubbleBtn",class:"nav-btn",disabled:!n.hasBubbles||n.selectedBubbleIndex<=0,onClick:a[4]||(a[4]=c=>u.$emit("select-previous-bubble")),title:"ä¸Šä¸€ä¸ªæ°”æ³¡ (â†)"}," â—€ ",8,af),e("span",lf,[a[25]||(a[25]=me(" æ°”æ³¡ ",-1)),e("span",rf,oe(n.selectedBubbleIndex>=0?n.selectedBubbleIndex+1:0),1),a[26]||(a[26]=me(" / ",-1)),e("span",uf,oe(n.bubbleCount),1)]),e("button",{id:"nextBubbleBtn",class:"nav-btn",disabled:!n.hasBubbles||n.selectedBubbleIndex>=n.bubbleCount-1,onClick:a[5]||(a[5]=c=>u.$emit("select-next-bubble")),title:"ä¸‹ä¸€ä¸ªæ°”æ³¡ (â†’)"}," â–¶ ",8,cf)]),a[31]||(a[31]=e("div",{class:"toolbar-divider"},null,-1)),e("div",df,[e("button",{class:"layout-toggle-btn",onClick:a[6]||(a[6]=c=>u.$emit("toggle-layout")),title:"åˆ‡æ¢å¸ƒå±€ï¼šå·¦å³/ä¸Šä¸‹"},[n.layoutMode==="horizontal"?(A(),L("svg",gf,[...a[27]||(a[27]=[e("rect",{x:"1",y:"2",width:"8",height:"16",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"},null,-1),e("rect",{x:"11",y:"2",width:"8",height:"16",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"},null,-1)])])):(A(),L("svg",pf,[...a[28]||(a[28]=[e("rect",{x:"2",y:"1",width:"16",height:"8",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"},null,-1),e("rect",{x:"2",y:"11",width:"16",height:"8",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"},null,-1)])]))]),e("button",{class:"view-mode-btn",onClick:a[7]||(a[7]=c=>u.$emit("toggle-view-mode")),title:"åˆ‡æ¢è§†å›¾æ¨¡å¼"},[...a[29]||(a[29]=[e("span",{class:"dual-icon"},"â§‰",-1)])]),e("button",{class:Ie({active:n.syncEnabled}),onClick:a[8]||(a[8]=c=>u.$emit("toggle-sync")),title:"åŒæ­¥ç¼©æ”¾/æ‹–åŠ¨",style:{"font-size":"12px"}}," ğŸ”— ",2),e("button",{onClick:a[9]||(a[9]=c=>u.$emit("fit-to-screen")),title:"é€‚åº”å±å¹• (åŒå‡»)"},"â›¶"),e("button",{onClick:a[10]||(a[10]=c=>u.$emit("zoom-in")),title:"æ”¾å¤§ (+)"},"+"),e("span",mf,oe(Math.round(n.scale*100))+"%",1),e("button",{onClick:a[11]||(a[11]=c=>u.$emit("zoom-out")),title:"ç¼©å° (-)"},"âˆ’"),e("button",{onClick:a[12]||(a[12]=c=>u.$emit("reset-zoom")),title:"åŸå§‹å¤§å°"},"1:1")]),a[32]||(a[32]=e("div",{class:"toolbar-spacer"},null,-1)),e("button",{class:"secondary-btn",onClick:a[13]||(a[13]=c=>u.$emit("exit-edit-mode"))},"é€€å‡ºç¼–è¾‘")]),e("div",vf,[e("div",ff,[e("button",{class:"annotation-btn detect-btn",onClick:a[14]||(a[14]=c=>u.$emit("auto-detect-bubbles")),title:"è‡ªåŠ¨æ£€æµ‹å½“å‰å›¾ç‰‡çš„æ–‡æœ¬æ¡†"},[...a[33]||(a[33]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("circle",{cx:"6",cy:"6",r:"4",fill:"none",stroke:"currentColor","stroke-width":"1.5"}),e("path",{d:"M9 9l4 4",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round"})],-1),e("span",null,"æ£€æµ‹",-1)])]),e("button",{class:"annotation-btn detect-btn",onClick:a[15]||(a[15]=c=>u.$emit("detect-all-images")),title:"æ‰¹é‡æ£€æµ‹æ‰€æœ‰å›¾ç‰‡"},[...a[34]||(a[34]=[vo('<svg viewBox="0 0 16 16" width="14" height="14" data-v-d94e5ff3><circle cx="5" cy="5" r="2.5" fill="none" stroke="currentColor" stroke-width="1" data-v-d94e5ff3></circle><path d="M7 7l2 2" stroke="currentColor" stroke-width="1" stroke-linecap="round" data-v-d94e5ff3></path><circle cx="10" cy="10" r="2.5" fill="none" stroke="currentColor" stroke-width="1" data-v-d94e5ff3></circle><path d="M12 12l2 2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" data-v-d94e5ff3></path></svg><span data-v-d94e5ff3>æ‰¹é‡æ£€æµ‹</span>',2)])]),e("button",{class:"annotation-btn primary-action-btn",onClick:a[16]||(a[16]=c=>u.$emit("translate-with-bubbles")),title:"ä½¿ç”¨å½“å‰æ–‡æœ¬æ¡†ç¿»è¯‘æ­¤å›¾ç‰‡"},[...a[35]||(a[35]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("path",{d:"M2 3h5M4.5 3v7M2 6h5",stroke:"currentColor","stroke-width":"1.2",fill:"none"}),e("path",{d:"M9 13l2-7 2 7M9.5 11h3",stroke:"currentColor","stroke-width":"1.2",fill:"none"})],-1),e("span",null,"ç¿»è¯‘",-1)])]),a[42]||(a[42]=e("div",{class:"toolbar-divider"},null,-1)),e("button",{class:Ie(["annotation-btn",{active:n.isDrawingMode}]),onClick:a[17]||(a[17]=c=>u.$emit("toggle-drawing-mode")),title:"æ·»åŠ æ°”æ³¡æ¡†ï¼ˆæˆ–ä¸­é”®æ‹–æ‹½ç»˜åˆ¶ï¼‰"},[...a[36]||(a[36]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("rect",{x:"3",y:"3",width:"10",height:"10",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"}),e("path",{d:"M8 5v6M5 8h6",stroke:"currentColor","stroke-width":"1.5"})],-1),e("span",null,"æ·»åŠ ",-1)])],2),e("button",{class:"annotation-btn",disabled:!n.hasSelection,onClick:a[18]||(a[18]=c=>u.$emit("delete-selected-bubbles")),title:"åˆ é™¤é€‰ä¸­æ°”æ³¡æ¡† (Delete)"},[...a[37]||(a[37]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("rect",{x:"3",y:"3",width:"10",height:"10",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"}),e("path",{d:"M5 8h6",stroke:"currentColor","stroke-width":"1.5"})],-1),e("span",null,"åˆ é™¤",-1)])],8,bf),e("button",{class:Ie(["annotation-btn",{"is-loading":n.isRepairLoading}]),disabled:!n.hasSelection||n.isRepairLoading,onClick:a[19]||(a[19]=c=>u.$emit("repair-selected-bubble")),title:"ä¿®å¤é€‰ä¸­æ°”æ³¡èƒŒæ™¯ (R)"},[(A(),L("svg",{viewBox:"0 0 16 16",width:"14",height:"14",class:Ie({"spin-icon":n.isRepairLoading})},[...a[38]||(a[38]=[e("path",{d:"M2 14l3-3m0 0l6-6 3 3-6 6m-3 0l-1 1 1-1z",fill:"none",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round"},null,-1),e("path",{d:"M11 5l-1-1 2-2 2 2-2 2-1-1z",fill:"currentColor"},null,-1)])],2)),a[39]||(a[39]=e("span",null,"ä¿®å¤",-1))],10,hf),a[43]||(a[43]=e("div",{class:"toolbar-divider"},null,-1)),e("button",{class:Ie(["annotation-btn brush-btn",{active:n.brushMode==="repair"}]),onClick:a[20]||(a[20]=c=>u.$emit("activate-repair-brush")),title:"ä¿®å¤ç¬”åˆ· (æŒ‰ä½R+å·¦é”®æ‹–æ‹½)"},[...a[40]||(a[40]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("circle",{cx:"8",cy:"8",r:"5",fill:"none",stroke:"currentColor","stroke-width":"1.5"}),e("circle",{cx:"8",cy:"8",r:"2",fill:"currentColor"})],-1),e("span",null,"ä¿®å¤ç¬”åˆ·",-1)])],2),e("button",{class:Ie(["annotation-btn brush-btn",{active:n.brushMode==="restore"}]),onClick:a[21]||(a[21]=c=>u.$emit("activate-restore-brush")),title:"è¿˜åŸç¬”åˆ· (æŒ‰ä½U+å·¦é”®æ‹–æ‹½)"},[...a[41]||(a[41]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("circle",{cx:"8",cy:"8",r:"5",fill:"none",stroke:"currentColor","stroke-width":"1.5"}),e("path",{d:"M5 8h6M8 5v6",stroke:"currentColor","stroke-width":"1",transform:"rotate(45 8 8)"})],-1),e("span",null,"è¿˜åŸç¬”åˆ·",-1)])],2),n.brushMode?(A(),L("span",xf," ç¬”åˆ·: "+oe(n.brushSize)+"px ",1)):ce("",!0),a[44]||(a[44]=vo('<div class="help-tooltip-container" data-v-d94e5ff3><button class="help-tooltip-btn" title="å¿«æ·é”®æ“ä½œå¸®åŠ©" data-v-d94e5ff3><svg viewBox="0 0 16 16" width="14" height="14" data-v-d94e5ff3><circle cx="8" cy="8" r="6.5" fill="none" stroke="currentColor" stroke-width="1.2" data-v-d94e5ff3></circle><text x="8" y="11" text-anchor="middle" font-size="9" font-weight="bold" fill="currentColor" data-v-d94e5ff3>?</text></svg><span class="help-btn-text" data-v-d94e5ff3>å¿«æ·é”®</span></button><div class="help-tooltip-popup" data-v-d94e5ff3><div class="help-section" data-v-d94e5ff3><div class="help-title" data-v-d94e5ff3>ğŸ–±ï¸ é¼ æ ‡æ“ä½œ</div><div class="help-item" data-v-d94e5ff3><span class="help-key" data-v-d94e5ff3>å·¦é”®ç‚¹å‡»æ°”æ³¡</span><span class="help-desc" data-v-d94e5ff3>é€‰æ‹©æ°”æ³¡</span></div><div class="help-item" data-v-d94e5ff3><span class="help-key" data-v-d94e5ff3>Shift+å·¦é”®ç‚¹å‡»</span><span class="help-desc" data-v-d94e5ff3>å¤šé€‰æ°”æ³¡</span></div><div class="help-item" data-v-d94e5ff3><span class="help-key" data-v-d94e5ff3>å·¦é”®æ‹–æ‹½å››è§’/è¾¹</span><span class="help-desc" data-v-d94e5ff3>è°ƒæ•´å¤§å°</span></div><div class="help-item" data-v-d94e5ff3><span class="help-key" data-v-d94e5ff3>å·¦é”®æ‹–æ‹½æ¡†å†…éƒ¨</span><span class="help-desc" data-v-d94e5ff3>ç§»åŠ¨æ°”æ³¡æ¡†</span></div><div class="help-item" data-v-d94e5ff3><span class="help-key" data-v-d94e5ff3>ä¸­é”®æ‹–æ‹½</span><span class="help-desc" data-v-d94e5ff3>ç»˜åˆ¶æ–°æ°”æ³¡æ¡†</span></div></div><div class="help-section" data-v-d94e5ff3><div class="help-title" data-v-d94e5ff3>âŒ¨ï¸ å¿«æ·é”®</div><div class="help-item" data-v-d94e5ff3><span class="help-key" data-v-d94e5ff3>A / D</span><span class="help-desc" data-v-d94e5ff3>åˆ‡æ¢ä¸Š/ä¸‹ä¸€å¼ å›¾ç‰‡</span></div><div class="help-item" data-v-d94e5ff3><span class="help-key" data-v-d94e5ff3>Ctrl+Enter</span><span class="help-desc" data-v-d94e5ff3>åº”ç”¨å¹¶è·³è½¬ä¸‹ä¸€å¼ </span></div><div class="help-item" data-v-d94e5ff3><span class="help-key" data-v-d94e5ff3>Delete / Backspace</span><span class="help-desc" data-v-d94e5ff3>åˆ é™¤é€‰ä¸­æ°”æ³¡</span></div><div class="help-item" data-v-d94e5ff3><span class="help-key" data-v-d94e5ff3>æŒ‰ä½R+å·¦é”®æ‹–æ‹½</span><span class="help-desc" data-v-d94e5ff3>ä¿®å¤ç¬”åˆ·</span></div><div class="help-item" data-v-d94e5ff3><span class="help-key" data-v-d94e5ff3>æŒ‰ä½U+å·¦é”®æ‹–æ‹½</span><span class="help-desc" data-v-d94e5ff3>è¿˜åŸç¬”åˆ·</span></div><div class="help-item" data-v-d94e5ff3><span class="help-key" data-v-d94e5ff3>ç¬”åˆ·æ¨¡å¼ä¸‹æ»šè½®</span><span class="help-desc" data-v-d94e5ff3>è°ƒæ•´ç¬”åˆ·å¤§å°</span></div></div></div></div>',1))]),n.brushMode?(A(),L("div",{key:0,class:"brush-cursor",style:st(l.value)},null,4)):ce("",!0),n.brushMode?(A(),L("div",yf,oe(n.brushMode==="repair"?"ä¿®å¤ç¬”åˆ· (R)":"è¿˜åŸç¬”åˆ· (U)")+" - æ»šè½®è°ƒæ•´å¤§å° ",1)):ce("",!0),n.isProcessing?(A(),L("div",{key:2,class:Ie(["edit-progress-container",{completed:o.value}])},[e("div",_f,[e("span",Cf,oe(n.progressText),1),e("span",Sf,oe(n.progressCurrent)+"/"+oe(n.progressTotal),1)]),e("div",kf,[e("div",{class:Ie(["edit-progress-fill",{animating:!o.value}]),style:st({width:s.value+"%"})},null,6)])],2)):ce("",!0),a[45]||(a[45]=e("div",{class:"toolbar-spacer"},null,-1)),e("div",wf,[e("button",{class:"primary-btn",onClick:a[22]||(a[22]=c=>u.$emit("apply-and-next")),title:"åº”ç”¨æ›´æ”¹å¹¶è·³è½¬ä¸‹ä¸€å¼  (Ctrl+Enter)"}," åº”ç”¨å¹¶ä¸‹ä¸€å¼  ")])])]))}}),Tf=He($f,[["__scopeId","data-v-d94e5ff3"]]),If={key:0,class:"edit-thumbnails-panel"},Pf={class:"thumbnails-scroll"},Rf=["onClick"],Df=["src","alt"],Mf={class:"thumb-index"},Ef=je({__name:"EditThumbnailPanel",props:{visible:{type:Boolean},images:{},currentImageIndex:{}},emits:["switch-to-image"],setup(n){return(t,s)=>n.visible?(A(),L("div",If,[e("div",Pf,[(A(!0),L(Ve,null,Ye(n.images,(o,l)=>(A(),L("div",{key:o.id,class:Ie(["edit-thumbnail-item",{active:l===n.currentImageIndex}]),onClick:u=>t.$emit("switch-to-image",l)},[e("img",{src:o.translatedDataURL||o.originalDataURL,alt:`å›¾ç‰‡ ${l+1}`},null,8,Df),e("span",Mf,oe(l+1),1)],10,Rf))),128))])])):ce("",!0)}}),Bf=He(Ef,[["__scopeId","data-v-9d2a43d9"]]),Af=["data-brush-mode"],Lf={class:"edit-main-layout"},Ff={class:"image-comparison-container"},Uf={class:"panel-header"},Of=["src"],zf={class:"panel-header"},Nf=["src"],Vf=je({__name:"EditWorkspace",props:{isEditModeActive:{type:Boolean}},emits:["exit"],setup(n,{emit:t}){const s=n,o=t,l=et(),u=gt(),{translateWithCurrentBubbles:a}=Eo(),{reRenderFullImage:c}=Am({onRenderStart:()=>console.log("å¼€å§‹é‡æ–°æ¸²æŸ“..."),onRenderSuccess:G=>console.log("æ¸²æŸ“æˆåŠŸ:",G.substring(0,50)+"..."),onRenderError:G=>console.error("æ¸²æŸ“å¤±è´¥:",G)}),{isDrawingMode:m,isDrawingBox:p,currentDrawingRect:_,isMiddleButtonDown:T,handleBubbleSelect:M,handleBubbleMultiSelect:R,handleClearMultiSelect:I,handleBubbleDragStart:E,handleBubbleDragging:H,handleBubbleDragEnd:V,handleBubbleResizeStart:F,handleBubbleResizing:b,handleBubbleResizeEnd:v,handleBubbleRotateStart:k,handleBubbleRotating:$,handleBubbleRotateEnd:N,toggleDrawingMode:z,handleDrawBubble:ae,getDrawingRectStyle:j,handleBubbleUpdate:q,deleteSelectedBubbles:Q,repairSelectedBubble:W,handleOcrRecognize:se}=Bm({onReRender:()=>c(),onDelayedPreview:()=>c()}),S=w(0),i=w(0),{brushMode:P,brushSize:d,mouseX:g,mouseY:f,isBrushKeyDown:x,toggleBrushMode:h,exitBrushMode:D,startBrushPainting:Y,continueBrushPainting:Z,finishBrushPainting:r,adjustBrushSize:y}=Mm({onBrushComplete:()=>c(),getCurrentRepairSettings:()=>({inpaintMethod:Ae.value,fillColor:U.value})}),{images:le,currentImageIndex:B,currentImage:ee,imageCount:de,canGoPrevious:ve,canGoNext:xe}=kt(l),{bubbles:we,selectedIndex:$e,selectedIndices:ie,selectedBubble:C,bubbleCount:J,hasBubbles:fe,hasSelection:be}=kt(u),O=X(()=>Re.value?.querySelector("img")?.naturalWidth||2e3),te=X(()=>Re.value?.querySelector("img")?.naturalHeight||2e3),he=w(null),ge=w(null),Re=w(null),Ee=w(null),Fe=w(null),ke=w(null),Be=w("dual"),ye=w("horizontal"),lt=w(!1),Ge=w(!0),Ze=w(!1),nt=w(!1),Ae=w("solid"),U=w("#FFFFFF"),re=w(!1),Pe=w("å¤„ç†ä¸­..."),De=w(0),tt=w(0),rt=w(!1),Mt=w(!1),ht=w(!1),Le=bn(),ot=bn(),Gt=X(()=>ot.scale.value),zn=X(()=>ot.translateX.value),Nn=X(()=>ot.translateY.value),Vn=X(()=>Le.scale.value),_t=w(null),Wn=X(()=>({transform:`translate(${Le.translateX.value}px, ${Le.translateY.value}px) scale(${Le.scale.value})`})),Kn=X(()=>({transform:`translate(${ot.translateX.value}px, ${ot.translateY.value}px) scale(${ot.scale.value})`}));function Bo(){ot.zoomIn(),Ge.value&&Le.setTransform(ot.getTransform())}function Ao(){ot.zoomOut(),Ge.value&&Le.setTransform(ot.getTransform())}function Lo(){ot.resetZoom(),Ge.value&&Le.setTransform(ot.getTransform())}const Zt=w(!1),qn=w(0),Qt=w(!1),Et=w({x:0,y:0,size:0});function eo(){P.value&&D(),no()}function to(){u.bubbles.length>0&&u.selectBubble(0)}function Fo(){ve.value&&(eo(),l.goToPrevious())}function oo(){xe.value&&(eo(),l.goToNext())}function Hn(G){G!==B.value&&G>=0&&G<de.value&&(eo(),l.setCurrentImageIndex(G))}function no(){if(!ee.value)return;const G=Array.isArray(ee.value.bubbleStates);we.value.length>0?(l.updateCurrentBubbleStates([...we.value]),l.setManuallyAnnotated(!0),console.log("å·²ä¿å­˜æ°”æ³¡çŠ¶æ€åˆ°å½“å‰å›¾ç‰‡ï¼Œæ ‡è®°ä¸ºæ‰‹åŠ¨æ ‡æ³¨")):G&&(l.updateCurrentBubbleStates([]),l.setManuallyAnnotated(!0),console.log("å·²ä¿å­˜ç©ºæ°”æ³¡çŠ¶æ€åˆ°å½“å‰å›¾ç‰‡ï¼ˆç”¨æˆ·ä¸»åŠ¨æ¸…ç©ºï¼Œæ ‡è®°ä¸ºæ‰‹åŠ¨æ ‡æ³¨ï¼‰"))}function Bt(){ee.value?.bubbleStates?(u.setBubbles([...ee.value.bubbleStates],!0),console.log(`å·²åŠ è½½ ${ee.value.bubbleStates.length} ä¸ªæ°”æ³¡çŠ¶æ€`)):u.clearBubblesLocal(),to()}function jn(){u.selectPrevious()}function Jn(){u.selectNext()}function Yn(){lt.value=!lt.value}function Xn(){ye.value=ye.value==="horizontal"?"vertical":"horizontal";try{localStorage.setItem(sn,ye.value)}catch(G){console.warn("ä¿å­˜å¸ƒå±€æ¨¡å¼å¤±è´¥:",G)}setTimeout(()=>{At()},300)}function Gn(){const G=["dual","original","translated"],ue=G.indexOf(Be.value),pe=G[(ue+1)%G.length];pe&&(Be.value=pe)}function Zn(){Ge.value=!Ge.value,console.log("åŒå›¾åŒæ­¥:",Ge.value?"å¼€å¯":"å…³é—­"),Ge.value&&Le.setTransform(ot.getTransform())}function At(){const G=Ee.value||ge.value,ue=Fe.value||Re.value;if(!G||!ue)return;const pe=ue.querySelector("img");if(!pe||!pe.naturalWidth)return;const Je=G.getBoundingClientRect(),Ue=Je.width/pe.naturalWidth,Me=Je.height/pe.naturalHeight,We=Math.min(Ue,Me)*.95,Ne=(Je.width-pe.naturalWidth*We)/2,xt=(Je.height-pe.naturalHeight*We)/2,Ct={scale:We,translateX:Ne,translateY:xt};ot.setTransform(Ct),Le.setTransform(Ct)}function Uo(G,ue){if(P.value){const Ne=G.deltaY>0?-5:5;y(Ne);return}const pe=G.currentTarget.getBoundingClientRect(),Je=G.clientX-pe.left,Ue=G.clientY-pe.top,Me=G.deltaY>0?.9:1.1,We=ue==="original"?Le:ot;We.zoomAt(Je,Ue,Me),Ge.value&&(ue==="original"?ot:Le).setTransform(We.getTransform())}function Oo(G,ue){if(P.value){const pe=ue==="original"?ge.value:Ee.value;pe&&Y(G,pe);return}if(G.button===1){T.value=!0,Vo(G,ue),G.preventDefault();return}if(m.value&&G.button===0){Vo(G,ue),G.preventDefault();return}if(G.button===0){if(G.target.closest(".bubble-highlight-box"))return;G.shiftKey||I(),_t.value=ue,(ue==="original"?Le:ot).startDrag(G.clientX,G.clientY),document.addEventListener("mousemove",zo),document.addEventListener("mouseup",No),G.preventDefault()}}function zo(G){if(!_t.value)return;const ue=_t.value==="original"?Le:ot;ue.drag(G.clientX,G.clientY),Ge.value&&(_t.value==="original"?ot:Le).setTransform(ue.getTransform())}function No(){_t.value&&(_t.value==="original"?Le:ot).endDrag(),_t.value=null,document.removeEventListener("mousemove",zo),document.removeEventListener("mouseup",No)}let so="translated";function Vo(G,ue="translated"){so=ue;const pe=ue==="original"?Re.value:Fe.value,Je=ue==="original"?Le:ot;if(!pe)return;const Ue=pe.getBoundingClientRect(),Me=(G.clientX-Ue.left)/Je.scale.value,We=(G.clientY-Ue.top)/Je.scale.value;S.value=Me,i.value=We,p.value=!0,_.value=[Me,We,Me,We],document.addEventListener("mousemove",ao),document.addEventListener("mouseup",lo)}function ao(G){if(!p.value)return;const ue=so==="original"?Re.value:Fe.value,pe=so==="original"?Le:ot;if(!ue)return;const Je=ue.getBoundingClientRect(),Ue=(G.clientX-Je.left)/pe.scale.value,Me=(G.clientY-Je.top)/pe.scale.value;_.value=[Math.min(S.value,Ue),Math.min(i.value,Me),Math.max(S.value,Ue),Math.max(i.value,Me)]}function lo(G){document.removeEventListener("mousemove",ao),document.removeEventListener("mouseup",lo);const ue=T.value;if(!p.value||!_.value){p.value=!1,_.value=null,T.value=!1;return}const[pe,Je,Ue,Me]=_.value,We=Ue-pe,Ne=Me-Je;We>10&&Ne>10&&(u.addBubble(_.value),u.selectBubble(u.bubbleCount-1),console.log("å·²æ·»åŠ æ–°æ°”æ³¡:",_.value)),p.value=!1,_.value=null,T.value=!1,!ue&&m.value&&(m.value=!1)}function Wo(G){console.log(`${G} å›¾ç‰‡åŠ è½½å®Œæˆ`),Gt.value===1&&zn.value===0&&Nn.value===0&&pt(()=>{At()})}function Qn(){c()}function es(G){G.inpaintMethod!==void 0&&(Ae.value=G.inpaintMethod),G.fillColor!==void 0&&(U.value=G.fillColor),$e.value>=0&&q(G)}function ts(G){_e("æ–‡æœ¬å·²åº”ç”¨","success"),c()}function os(G){const ue=u.initialStates[G];if(!ue){console.warn(`æ— æ³•é‡ç½®æ°”æ³¡ #${G+1}ï¼šæ‰¾ä¸åˆ°åˆå§‹çŠ¶æ€`),_e("æ— æ³•é‡ç½®ï¼šæ‰¾ä¸åˆ°åˆå§‹çŠ¶æ€","warning");return}const pe=JSON.parse(JSON.stringify(ue));u.updateBubble(G,pe),console.log(`æ°”æ³¡ #${G+1} å·²é‡ç½®åˆ°åˆå§‹çŠ¶æ€`),_e("æ°”æ³¡å·²é‡ç½®","success"),c()}async function ns(G){rt.value=!0;try{await se(G)}finally{rt.value=!1}}async function ss(){ht.value=!0;try{await W()}finally{ht.value=!1}}async function as(G){const ue=we.value[G];if(!ue?.originalText){console.warn("æ— æ³•é‡æ–°ç¿»è¯‘ï¼šç¼ºå°‘æ°”æ³¡æˆ–åŸæ–‡");return}Mt.value=!0;try{console.log(`å¼€å§‹é‡æ–°ç¿»è¯‘æ°”æ³¡ #${G+1}`);const{translateSingleText:pe}=await it(async()=>{const{translateSingleText:We}=await Promise.resolve().then(()=>Ks);return{translateSingleText:We}},void 0),{useSettingsStore:Je}=await it(async()=>{const{useSettingsStore:We}=await import("./system.BYrUrKi-.js").then(Ne=>Ne.s);return{useSettingsStore:We}},__vite__mapDeps([0,1,2,3,4,5])),Ue=Je().settings,Me=await pe({original_text:ue.originalText,model_provider:Ue.translation.provider,api_key:Ue.translation.apiKey,model_name:Ue.translation.modelName,custom_base_url:Ue.translation.customBaseUrl,target_language:Ue.targetLanguage,prompt_content:Ue.translatePrompt,use_json_format:Ue.translation.isJsonMode,rpm_limit_translation:Ue.translation.rpmLimit,max_retries:Ue.translation.maxRetries});Me.success&&Me.data?.translated_text?(u.updateBubble(G,{translatedText:Me.data.translated_text}),console.log(`ç¿»è¯‘æˆåŠŸ: "${Me.data.translated_text}"`),c()):console.error("ç¿»è¯‘å¤±è´¥:",Me.error||"æœªçŸ¥é”™è¯¯")}catch(pe){console.error("ç¿»è¯‘å‡ºé”™:",pe)}finally{Mt.value=!1}}function Ko(G,ue){for(G.bubbleTexts||(G.bubbleTexts=[]),G.originalTexts||(G.originalTexts=[]);G.bubbleTexts.length<ue;)G.bubbleTexts.push("");for(;G.originalTexts.length<ue;)G.originalTexts.push("")}function qo(G,ue,pe){const Je=G.auto_directions||[];return G.bubble_coords.map((Ue,Me)=>{const We=Ue[0]??0,Ne=Ue[1]??0,xt=Ue[2]??0,Ct=Ue[3]??0;let mt;return Je[Me]?mt=Je[Me]==="v"?"vertical":"horizontal":mt=Ct-Ne>xt-We?"vertical":"horizontal",{coords:Ue,originalText:ue.originalTexts?.[Me]||"",translatedText:ue.bubbleTexts?.[Me]||"",textboxText:"",fontSize:pe.fontSize,fontFamily:pe.fontFamily,textDirection:mt,autoTextDirection:mt,textColor:pe.textColor,fillColor:pe.fillColor,strokeEnabled:pe.strokeEnabled,strokeColor:pe.strokeColor,strokeWidth:pe.strokeWidth,rotationAngle:G.bubble_angles?.[Me]||0,inpaintMethod:pe.inpaintMethod,position:{x:0,y:0},polygon:[]}})}async function ls(){const G=ee.value;if(!G?.originalDataURL){_e("æ²¡æœ‰æœ‰æ•ˆçš„å›¾ç‰‡ç”¨äºæ£€æµ‹","warning");return}try{_e("æ­£åœ¨è‡ªåŠ¨æ£€æµ‹æ–‡æœ¬æ¡†...","info");const pe=G.originalDataURL.match(/^data:image\/[^;]+;base64,(.+)$/)?.[1]||"";if(!pe){_e("æ— æ³•è§£æå›¾ç‰‡æ•°æ®","error");return}const Je=ze(),{textDetector:Ue,boxExpand:Me,textStyle:We}=Je.settings,Ne=await fo(pe,Ue,{box_expand_ratio:Me.ratio,box_expand_top:Me.top,box_expand_bottom:Me.bottom,box_expand_left:Me.left,box_expand_right:Me.right});if(Ne.success&&Ne.bubble_coords){l.updateCurrentImage({bubbleCoords:Ne.bubble_coords,bubbleAngles:Ne.bubble_angles||[]}),Ko(G,Ne.bubble_coords.length);const xt={bubble_coords:Ne.bubble_coords.map(mt=>[...mt]),bubble_angles:Ne.bubble_angles,auto_directions:Ne.auto_directions},Ct=qo(xt,G,We);u.setBubbles(Ct),to(),_e(`è‡ªåŠ¨æ£€æµ‹åˆ° ${Ne.bubble_coords.length} ä¸ªæ–‡æœ¬æ¡†`,"success")}else _e(Ne.error||"æ£€æµ‹å¤±è´¥","error")}catch(ue){console.error("è‡ªåŠ¨æ£€æµ‹å¤±è´¥:",ue),_e("è‡ªåŠ¨æ£€æµ‹å¤±è´¥","error")}}async function is(){if(le.value.length<=1){_e("è‡³å°‘éœ€è¦ä¸¤å¼ å›¾ç‰‡æ‰èƒ½æ‰§è¡Œæ‰¹é‡æ£€æµ‹","warning");return}if(!confirm("æ­¤æ“ä½œå°†å¯¹æ‰€æœ‰å›¾ç‰‡è¿›è¡Œæ–‡æœ¬æ¡†æ£€æµ‹ï¼Œå¯èƒ½ä¼šè¦†ç›–å·²æœ‰çš„æ£€æµ‹ç»“æœã€‚ç¡®å®šç»§ç»­å—ï¼Ÿ"))return;const G=ze(),{textDetector:ue,boxExpand:pe,textStyle:Je}=G.settings,Ue=B.value,Me=le.value.length;re.value=!0,Pe.value="æ‰¹é‡æ£€æµ‹ä¸­",tt.value=Me,De.value=0;try{let We=0;for(let Ne=0;Ne<Me;Ne++){const xt=le.value[Ne];if(!xt?.originalDataURL)continue;De.value=Ne+1;const mt=xt.originalDataURL.match(/^data:image\/[^;]+;base64,(.+)$/)?.[1]||"";if(!mt)continue;const vt=await fo(mt,ue,{box_expand_ratio:pe.ratio,box_expand_top:pe.top,box_expand_bottom:pe.bottom,box_expand_left:pe.left,box_expand_right:pe.right});if(vt.success&&vt.bubble_coords){const wt=le.value[Ne];if(wt){wt.bubbleCoords=vt.bubble_coords,wt.bubbleAngles=vt.bubble_angles||[],Ko(wt,vt.bubble_coords.length);const ps={bubble_coords:vt.bubble_coords.map(ms=>[...ms]),bubble_angles:vt.bubble_angles,auto_directions:vt.auto_directions};wt.bubbleStates=qo(ps,wt,Je),We+=vt.bubble_coords.length,Ne===B.value&&Bt()}}}Pe.value="æ£€æµ‹å®Œæˆ",De.value=Me,Ue!==B.value&&l.setCurrentImageIndex(Ue),Bt(),_e(`æ‰¹é‡æ£€æµ‹å®Œæˆï¼å…±å¤„ç† ${Me} å¼ å›¾ç‰‡ï¼Œæ£€æµ‹åˆ° ${We} ä¸ªæ–‡æœ¬æ¡†`,"success"),setTimeout(()=>{re.value=!1},2e3)}catch(We){console.error("æ‰¹é‡æ£€æµ‹å¤±è´¥:",We),_e("æ‰¹é‡æ£€æµ‹å¤±è´¥","error"),re.value=!1}}async function rs(){if(!ee.value?.originalDataURL){_e("æ²¡æœ‰æœ‰æ•ˆçš„å›¾ç‰‡ç”¨äºç¿»è¯‘","warning");return}if(we.value.length===0){_e("æ²¡æœ‰æ–‡æœ¬æ¡†å¯ç”¨äºç¿»è¯‘ï¼Œè¯·å…ˆæ£€æµ‹æˆ–æ·»åŠ æ–‡æœ¬æ¡†","warning");return}_e("æ­£åœ¨ä½¿ç”¨å½“å‰æ–‡æœ¬æ¡†ç¿»è¯‘...","info");try{await a()&&(_e("ç¿»è¯‘æˆåŠŸï¼","success"),to())}catch(ue){console.error("ç¿»è¯‘å¤±è´¥:",ue),_e(`ç¿»è¯‘å¤±è´¥: ${ue instanceof Error?ue.message:"æœªçŸ¥é”™è¯¯"}`,"error")}}function us(){h("repair")}function cs(){h("restore")}function Ho(G){Z(G)}function jo(){r()}function ds(G){Zt.value=!0,qn.value=ye.value==="horizontal"?G.clientX:G.clientY,document.body.style.cursor=ye.value==="horizontal"?"col-resize":"row-resize",document.body.style.userSelect="none",document.addEventListener("mousemove",io),document.addEventListener("mouseup",ro),G.preventDefault()}function io(G){if(!Zt.value)return;const ue=ge.value?.parentElement?.parentElement;if(!ue)return;const pe=ue.getBoundingClientRect();if(ye.value==="horizontal"){const Je=G.clientX-pe.left,Ue=pe.width,Me=Math.max(20,Math.min(80,Je/Ue*100)),We=ue.querySelector(".original-panel"),Ne=ue.querySelector(".translated-panel");We&&Ne&&(We.style.flex=`0 0 ${Me}%`,Ne.style.flex=`0 0 ${100-Me}%`)}else{const Je=G.clientY-pe.top,Ue=pe.height,Me=Math.max(20,Math.min(80,Je/Ue*100)),We=ue.querySelector(".original-panel"),Ne=ue.querySelector(".translated-panel");We&&Ne&&(We.style.flex=`0 0 ${Me}%`,Ne.style.flex=`0 0 ${100-Me}%`)}}function ro(){Zt.value=!1,document.body.style.cursor="",document.body.style.userSelect="",document.removeEventListener("mousemove",io),document.removeEventListener("mouseup",ro)}function gs(G){Qt.value=!0;const ue=ke.value;ue&&(Et.value={x:G.clientX,y:G.clientY,size:ye.value==="horizontal"?ue.offsetWidth:ue.offsetHeight},document.body.style.cursor=ye.value==="horizontal"?"ew-resize":"ns-resize",document.body.style.userSelect="none",document.addEventListener("mousemove",uo),document.addEventListener("mouseup",co),G.preventDefault())}function uo(G){if(!(!Qt.value||!ke.value))if(ye.value==="horizontal"){const ue=Et.value.x-G.clientX;let pe=Et.value.size+ue;pe=Math.max(300,Math.min(window.innerWidth*.6,pe)),ke.value.style.flex=`0 0 ${pe}px`,ke.value.style.minWidth=`${pe}px`}else{const ue=Et.value.y-G.clientY;let pe=Et.value.size+ue;pe=Math.max(200,Math.min(window.innerHeight*.5,pe)),ke.value.style.flex=`0 0 ${pe}px`,ke.value.style.height=`${pe}px`}}function co(){Qt.value=!1,document.body.style.cursor="",document.body.style.userSelect="",document.removeEventListener("mousemove",uo),document.removeEventListener("mouseup",co)}function Jo(G){const ue=G.target,pe=G.key.toLowerCase();if(pe==="r"||pe==="u"||pe==="a"||pe==="d"){if(ue.tagName==="TEXTAREA")return;(ue.tagName==="INPUT"||ue.tagName==="SELECT"||ue.tagName==="BUTTON")&&ue.blur()}else if(ue.tagName==="INPUT"||ue.tagName==="TEXTAREA"||ue.tagName==="SELECT")return;switch(G.key){case"Escape":Go();break;case"Delete":case"Backspace":!P.value&&be.value&&(Q(),G.preventDefault());break;case"a":case"A":P.value||(Fo(),G.preventDefault());break;case"d":case"D":P.value||(oo(),G.preventDefault());break;case"Enter":G.ctrlKey&&!P.value&&(Xo(),G.preventDefault());break;case"r":case"R":x.value||(h("repair"),G.preventDefault());break;case"u":case"U":x.value||(h("restore"),G.preventDefault());break;case"+":case"=":Bo(),G.preventDefault();break;case"-":Ao(),G.preventDefault();break;case"0":Lo(),G.preventDefault();break}}function Yo(G){(G.key==="r"||G.key==="R"||G.key==="u"||G.key==="U")&&(D(),G.preventDefault())}async function Xo(){no(),await c(),xe.value?oo():_e("å·²æ˜¯æœ€åä¸€å¼ å›¾ç‰‡","info")}function Go(){no(),o("exit")}return dt(()=>{try{const G=localStorage.getItem(sn);(G==="horizontal"||G==="vertical")&&(ye.value=G)}catch(G){console.warn("åŠ è½½å¸ƒå±€æ¨¡å¼å¤±è´¥:",G)}document.addEventListener("keydown",Jo),document.addEventListener("keyup",Yo),document.addEventListener("mousemove",Ho),document.addEventListener("mouseup",jo),s.isEditModeActive&&(Bt(),pt(()=>{he.value?.focus()}))}),Nt(()=>{document.removeEventListener("keydown",Jo),document.removeEventListener("keyup",Yo),document.removeEventListener("mousemove",Ho),document.removeEventListener("mouseup",jo),document.removeEventListener("mousemove",ao),document.removeEventListener("mouseup",lo),document.removeEventListener("mousemove",io),document.removeEventListener("mouseup",ro),document.removeEventListener("mousemove",uo),document.removeEventListener("mouseup",co)}),Se(()=>s.isEditModeActive,G=>{G&&(Bt(),pt(()=>{he.value?.focus()}))}),Se(B,()=>{s.isEditModeActive&&Bt()}),Se(C,G=>{G&&(Ae.value=G.inpaintMethod||"solid",U.value=G.fillColor||"#FFFFFF")},{immediate:!0}),(G,ue)=>n.isEditModeActive?(A(),L("div",{key:0,class:Ie(["edit-workspace",[`layout-${ye.value}`,{"drawing-mode":K(m)},{"brush-mode-active":!!K(P)}]]),"data-brush-mode":K(P)||void 0,tabindex:"0",ref_key:"workspaceRef",ref:he},[Ce(Tf,{"current-image-index":K(B),"image-count":K(de),"can-go-previous":K(ve),"can-go-next":K(xe),"show-thumbnails":lt.value,"has-bubbles":K(fe),"selected-bubble-index":K($e),"bubble-count":K(J),"layout-mode":ye.value,"sync-enabled":Ge.value,scale:Gt.value,"is-drawing-mode":K(m),"has-selection":K(be),"brush-mode":K(P),"brush-size":K(d),"mouse-x":K(g),"mouse-y":K(f),"is-processing":re.value,"progress-text":Pe.value,"progress-current":De.value,"progress-total":tt.value,"is-repair-loading":ht.value,onGoPreviousImage:Fo,onGoNextImage:oo,onToggleThumbnails:Yn,onSelectPreviousBubble:jn,onSelectNextBubble:Jn,onToggleLayout:Xn,onToggleViewMode:Gn,onToggleSync:Zn,onFitToScreen:At,onZoomIn:Bo,onZoomOut:Ao,onResetZoom:Lo,onExitEditMode:Go,onAutoDetectBubbles:ls,onDetectAllImages:is,onTranslateWithBubbles:rs,onToggleDrawingMode:K(z),onDeleteSelectedBubbles:K(Q),onRepairSelectedBubble:ss,onActivateRepairBrush:us,onActivateRestoreBrush:cs,onApplyAndNext:Xo},null,8,["current-image-index","image-count","can-go-previous","can-go-next","show-thumbnails","has-bubbles","selected-bubble-index","bubble-count","layout-mode","sync-enabled","scale","is-drawing-mode","has-selection","brush-mode","brush-size","mouse-x","mouse-y","is-processing","progress-text","progress-current","progress-total","is-repair-loading","onToggleDrawingMode","onDeleteSelectedBubbles"]),Ce(Bf,{visible:lt.value,images:K(le),"current-image-index":K(B),onSwitchToImage:Hn},null,8,["visible","images","current-image-index"]),e("div",Lf,[e("div",Ff,[ne(e("div",{class:Ie(["image-panel original-panel",{collapsed:Be.value==="translated"||Ze.value}])},[e("div",Uf,[ue[8]||(ue[8]=e("span",{class:"panel-title"},"ğŸ“– åŸå›¾ (æ—¥æ–‡)",-1)),e("button",{class:"panel-toggle",onClick:ue[0]||(ue[0]=pe=>Ze.value=!Ze.value),title:"æŠ˜å /å±•å¼€"},oe(Ze.value?"+":"âˆ’"),1)]),e("div",{ref_key:"originalViewportRef",ref:ge,class:"image-viewport",onWheel:ue[2]||(ue[2]=at(pe=>Uo(pe,"original"),["prevent"])),onMousedown:ue[3]||(ue[3]=pe=>Oo(pe,"original")),onDblclick:At},[e("div",{ref_key:"originalWrapperRef",ref:Re,class:"image-canvas-wrapper",style:st(Wn.value)},[K(ee)?.originalDataURL?(A(),L("img",{key:0,src:K(ee).originalDataURL,alt:"åŸå›¾",onLoad:ue[1]||(ue[1]=pe=>Wo("original"))},null,40,Of)):ce("",!0),K(ee)?.originalDataURL?(A(),ut(hn,{key:1,bubbles:K(we),"selected-index":K($e),"selected-indices":K(ie),scale:Vn.value,"is-drawing-mode":K(m),"is-brush-mode":!!K(P),"image-width":O.value,"image-height":te.value,onSelect:K(M),onMultiSelect:K(R),onDragStart:K(E),onDragging:K(H),onDragEnd:K(V),onResizeStart:K(F),onResizing:K(b),onResizeEnd:K(v),onRotateStart:K(k),onRotating:K($),onRotateEnd:K(N),onDrawBubble:K(ae)},null,8,["bubbles","selected-index","selected-indices","scale","is-drawing-mode","is-brush-mode","image-width","image-height","onSelect","onMultiSelect","onDragStart","onDragging","onDragEnd","onResizeStart","onResizing","onResizeEnd","onRotateStart","onRotating","onRotateEnd","onDrawBubble"])):ce("",!0),K(_)?(A(),L("div",{key:2,class:"drawing-rect-edit",style:st(K(j)())},null,4)):ce("",!0)],4)],544)],2),[[Oe,Be.value!=="translated"]]),Be.value==="dual"?(A(),L("div",{key:0,class:Ie(["panel-divider",{"vertical-divider":ye.value==="vertical"}]),onMousedown:ds},null,34)):ce("",!0),ne(e("div",{class:Ie(["image-panel translated-panel",{collapsed:Be.value==="original"||nt.value}])},[e("div",zf,[ue[9]||(ue[9]=e("span",{class:"panel-title"},"ğŸ“ ç¿»è¯‘å›¾ (ä¸­æ–‡)",-1)),e("button",{class:"panel-toggle",onClick:ue[4]||(ue[4]=pe=>nt.value=!nt.value),title:"æŠ˜å /å±•å¼€"},oe(nt.value?"+":"âˆ’"),1)]),e("div",{ref_key:"translatedViewportRef",ref:Ee,class:"image-viewport",onWheel:ue[6]||(ue[6]=at(pe=>Uo(pe,"translated"),["prevent"])),onMousedown:ue[7]||(ue[7]=pe=>Oo(pe,"translated")),onDblclick:At},[e("div",{ref_key:"translatedWrapperRef",ref:Fe,class:"image-canvas-wrapper",style:st(Kn.value)},[K(ee)?.translatedDataURL||K(ee)?.originalDataURL?(A(),L("img",{key:0,src:K(ee)?.translatedDataURL||K(ee)?.originalDataURL,alt:"ç¿»è¯‘å›¾",onLoad:ue[5]||(ue[5]=pe=>Wo("translated"))},null,40,Nf)):ce("",!0),K(ee)?.translatedDataURL||K(ee)?.originalDataURL?(A(),ut(hn,{key:1,bubbles:K(we),"selected-index":K($e),"selected-indices":K(ie),scale:Gt.value,"is-drawing-mode":K(m),"is-brush-mode":!!K(P),"image-width":O.value,"image-height":te.value,onSelect:K(M),onMultiSelect:K(R),onDragStart:K(E),onDragging:K(H),onDragEnd:K(V),onResizeStart:K(F),onResizing:K(b),onResizeEnd:K(v),onRotateStart:K(k),onRotating:K($),onRotateEnd:K(N),onDrawBubble:K(ae)},null,8,["bubbles","selected-index","selected-indices","scale","is-drawing-mode","is-brush-mode","image-width","image-height","onSelect","onMultiSelect","onDragStart","onDragging","onDragEnd","onResizeStart","onResizing","onResizeEnd","onRotateStart","onRotating","onRotateEnd","onDrawBubble"])):ce("",!0),K(_)?(A(),L("div",{key:2,class:"drawing-rect-edit translated-drawing-rect",style:st(K(j)())},null,4)):ce("",!0)],4)],544)],2),[[Oe,Be.value!=="original"]])]),e("div",{ref_key:"editPanelRef",ref:ke,class:"edit-panel-container"},[e("div",{class:"panel-resize-handle vertical",onMousedown:gs}," â‹®â‹®â‹® ",32),Ce(Zv,{bubble:K(C),"bubble-index":K($e),"is-ocr-loading":rt.value,"is-translate-loading":Mt.value,onUpdate:es,onReRender:Qn,onOcrRecognize:ns,onReTranslate:as,onApplyBubble:ts,onResetCurrent:os},null,8,["bubble","bubble-index","is-ocr-loading","is-translate-loading"])],512)])],10,Af)):ce("",!0)}}),Wf=He(Vf,[["__scopeId","data-v-3dc31c4e"]]),xn="webImportDisclaimerAccepted",On=Xt("webImport",()=>{const n=w(un()),t=w("idle"),s=w(""),o=w([]),l=w(null),u=w(new Set),a=w({current:0,total:0}),c=w([]),m=w(null),p=w(!1),_=w(!1),T=w(!1),M=X(()=>t.value==="extracting"),R=X(()=>t.value==="downloading"),I=X(()=>M.value||R.value),E=X(()=>u.value.size),H=X(()=>a.value.total===0?0:Math.round(a.value.current/a.value.total*100));function V(){try{localStorage.setItem(an,JSON.stringify(n.value))}catch(h){console.error("ä¿å­˜ç½‘é¡µå¯¼å…¥è®¾ç½®å¤±è´¥:",h)}}function F(){try{const h=localStorage.getItem(an);if(h){const D=JSON.parse(h);n.value=b(un(),D)}}catch(h){console.error("åŠ è½½ç½‘é¡µå¯¼å…¥è®¾ç½®å¤±è´¥:",h)}}function b(h,D){const Y={...h};for(const Z in D)if(Object.prototype.hasOwnProperty.call(D,Z)){const r=D[Z],y=h[Z];r!==null&&typeof r=="object"&&!Array.isArray(r)&&y!==null&&typeof y=="object"&&!Array.isArray(y)?Y[Z]=b(y,r):r!==void 0&&(Y[Z]=r)}return Y}function v(){_.value?p.value=!0:T.value=!0}function k(){_.value=!0,T.value=!1,p.value=!0;try{localStorage.setItem(xn,"true")}catch(h){console.error("ä¿å­˜å…è´£å£°æ˜çŠ¶æ€å¤±è´¥:",h)}}function $(){T.value=!1}function N(){try{const h=localStorage.getItem(xn);_.value=h==="true"}catch(h){console.error("åŠ è½½å…è´£å£°æ˜çŠ¶æ€å¤±è´¥:",h)}}function z(){p.value=!1}function ae(){t.value="idle",s.value="",o.value=[],l.value=null,u.value=new Set,a.value={current:0,total:0},c.value=[],m.value=null}function j(h){s.value=h}function q(h){o.value.push(h)}function Q(){o.value=[]}function W(h){l.value&&l.value.pages.length>0?(l.value.comicTitle=h.comicTitle,l.value.chapterTitle=h.chapterTitle,l.value.totalPages=h.totalPages,l.value.sourceUrl=h.sourceUrl,l.value.referer=h.referer,l.value.engine=h.engine,l.value.success=h.success,l.value.error=h.error):(l.value=h,h.success&&h.pages&&(u.value=new Set(h.pages.map(D=>D.pageNumber))))}function se(h){u.value.has(h)?u.value.delete(h):u.value.add(h),u.value=new Set(u.value)}function S(){l.value?.pages&&(u.value.size===l.value.pages.length?u.value=new Set:u.value=new Set(l.value.pages.map(h=>h.pageNumber)))}function i(h){t.value=h}function P(h){m.value=h,h&&(t.value="error")}function d(h,D){a.value={current:h,total:D}}function g(h){c.value=h}function f(h){l.value||(l.value={success:!0,comicTitle:"",chapterTitle:"",pages:[],totalPages:0,sourceUrl:s.value,referer:"",engine:"gallery-dl"}),l.value.pages.push(h),l.value.totalPages=l.value.pages.length,u.value.add(h.pageNumber),u.value=new Set(u.value)}const x=Ws(n,V);return F(),N(),{settings:n,status:t,url:s,logs:o,extractResult:l,selectedPages:u,downloadProgress:a,downloadedImages:c,error:m,modalVisible:p,disclaimerAccepted:_,disclaimerVisible:T,isExtracting:M,isDownloading:R,isProcessing:I,selectedCount:E,downloadProgressPercent:H,saveToStorage:V,loadFromStorage:F,openModal:v,closeModal:z,resetState:ae,setUrl:j,addLog:q,clearLogs:Q,setExtractResult:W,togglePageSelection:se,toggleSelectAll:S,setStatus:i,setError:P,updateDownloadProgress:d,setDownloadedImages:g,addPageIncremental:f,acceptDisclaimer:k,rejectDisclaimer:$,...x}}),Dt="/api/web-import";async function Kf(n){return(await fetch(`${Dt}/check-support?url=${encodeURIComponent(n)}`)).json()}async function qf(){return(await fetch(`${Dt}/gallery-dl-images`)).json()}async function Hf(n,t,s,o,l,u="auto",a){const c=await fetch(`${Dt}/extract`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:n,config:t,engine:u})});if(!c.ok){const T=await c.json().catch(()=>({error:"è¯·æ±‚å¤±è´¥"}));l(T.error||`HTTP ${c.status}`);return}const m=c.body?.getReader();if(!m){l("æ— æ³•è¯»å–å“åº”æµ");return}const p=new TextDecoder;let _="";try{for(;;){const{done:T,value:M}=await m.read();if(T)break;_+=p.decode(M,{stream:!0});const R=_.split(`
`);_=R.pop()||"";let I="",E="";for(const H of R)if(H.startsWith("event:"))I=H.slice(6).trim();else if(H.startsWith("data:"))E=H.slice(5).trim();else if(H===""&&I&&E){try{const V=JSON.parse(E);I==="log"?s(V):I==="page"?a&&a(V):I==="result"?o(V):I==="error"&&l(V.error||"æœªçŸ¥é”™è¯¯")}catch(V){console.error("è§£æ SSE æ•°æ®å¤±è´¥:",V)}I="",E=""}}}finally{m.releaseLock()}}async function jf(n,t,s,o="ai-agent"){const l=await fetch(`${Dt}/download`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({pages:n,sourceUrl:t,config:s,engine:o})});if(!l.ok){const u=await l.json().catch(()=>({error:"è¯·æ±‚å¤±è´¥"}));throw new Error(u.error||`HTTP ${l.status}`)}return l.json()}async function Jf(n){return(await fetch(`${Dt}/test-firecrawl`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({apiKey:n})})).json()}async function Yf(n,t,s,o){return(await fetch(`${Dt}/test-agent`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({provider:n,apiKey:t,customBaseUrl:s,modelName:o})})).json()}const Xf={class:"modal-container"},Gf={class:"modal-body"},Zf={class:"url-section"},Qf=["disabled"],eb=["disabled"],tb=["disabled"],ob={key:0,class:"loading-spinner"},nb={key:1},sb={key:0,class:"engine-hint"},ab={key:0,class:"hint-checking"},lb={key:1,class:"hint-supported"},ib={key:2,class:"hint-unsupported"},rb={class:"settings-section"},ub={class:"settings-toggle"},cb={key:0,class:"settings-content"},db={class:"settings-tabs"},gb={class:"settings-tab-content"},pb={class:"settings-group"},mb={class:"form-row"},vb={class:"input-group"},fb=["type","value"],bb=["disabled"],hb={class:"settings-group"},xb={class:"form-row"},yb=["value"],_b=["value"],Cb={class:"form-row"},Sb={class:"input-group"},kb=["type","value"],wb={key:0,class:"form-row"},$b=["value"],Tb={class:"form-row"},Ib=["value"],Pb={class:"form-row inline"},Rb={class:"checkbox-label"},Db=["checked"],Mb={class:"checkbox-label"},Eb=["checked"],Bb={class:"form-row"},Ab=["disabled"],Lb={class:"settings-group"},Fb={class:"form-row"},Ub=["value"],Ob={class:"form-row"},zb=["value"],Nb={class:"settings-group"},Vb={class:"form-grid"},Wb={class:"form-row"},Kb=["value"],qb={class:"form-row"},Hb=["value"],jb={class:"form-row"},Jb=["value"],Yb={class:"form-row"},Xb=["value"],Gb={class:"form-row"},Zb={class:"checkbox-label"},Qb=["checked"],eh={class:"settings-group"},th={class:"form-row inline"},oh={class:"checkbox-label"},nh=["checked"],sh={class:"checkbox-label"},ah=["checked"],lh={class:"settings-tab-content"},ih={class:"settings-group"},rh={class:"form-row"},uh={class:"checkbox-label"},ch=["checked"],dh={class:"form-row"},gh={class:"checkbox-label"},ph=["checked"],mh={class:"form-row"},vh={class:"checkbox-label"},fh=["checked"],bh={key:0,class:"form-grid"},hh={class:"form-row"},xh=["value"],yh={class:"form-row"},_h=["value"],Ch={class:"form-row"},Sh=["value"],kh={class:"form-row"},wh={class:"checkbox-label"},$h=["checked"],Th={key:1,class:"form-row"},Ih=["value"],Ph={class:"settings-tab-content"},Rh={class:"settings-group"},Dh={class:"form-row"},Mh=["value"],Eh={class:"form-row"},Bh=["value"],Ah={class:"form-row"},Lh={class:"checkbox-label"},Fh=["checked"],Uh={key:1,class:"logs-section"},Oh={class:"logs-toggle"},zh={key:0,class:"extracting-hint"},Nh={key:0,class:"logs-content"},Vh={class:"log-time"},Wh={class:"log-message"},Kh={key:2,class:"error-section"},qh={class:"error-message"},Hh={key:3,class:"result-section"},jh={class:"result-header"},Jh={class:"result-title"},Yh={class:"result-meta"},Xh={class:"result-count"},Gh={key:0,class:"result-engine"},Zh={class:"select-control"},Qh={class:"select-all"},ex=["checked"],tx={class:"selected-count"},ox={class:"image-grid"},nx=["onClick"],sx={class:"image-checkbox"},ax=["checked","onChange"],lx={class:"image-preview"},ix=["src","alt"],rx={class:"image-label"},ux={key:4,class:"progress-section"},cx={class:"progress-label"},dx={class:"progress-bar"},gx={class:"modal-footer"},px=["disabled"],mx=["disabled"],vx={key:0,class:"loading-spinner"},fx={key:1},bx=je({__name:"WebImportModal",setup(n){const t=On(),s=et(),o=w(""),l=w(!0),u=w("auto"),a=w(!1),c=w(!1),m=w(!1),p=w(!1),_=w("basic"),T=w(!1),M=w(!1),R=w(!1),I=w(!1),E=X(()=>t.modalVisible),H=X(()=>t.status),V=X(()=>t.logs),F=X(()=>t.extractResult),b=X(()=>t.selectedPages),v=X(()=>t.selectedCount),k=X(()=>t.downloadProgress),$=X(()=>t.downloadProgressPercent),N=X(()=>t.error),z=X(()=>t.isProcessing),ae=X(()=>t.settings.ui.showAgentLogs),j=X(()=>F.value?.engine||null),q=X(()=>{switch(j.value){case"gallery-dl":return"Gallery-DL";case"ai-agent":return"AI Agent";default:return""}}),Q=X(()=>F.value?.pages?v.value===F.value.pages.length:!1);function W(Z){return j.value==="gallery-dl",Z}let se=null;async function S(Z){if(se&&clearTimeout(se),!Z.trim()){a.value=!1,c.value=!1;return}se=setTimeout(async()=>{m.value=!0;try{const r=await Kf(Z);a.value=r.available,c.value=r.supported}catch{a.value=!1,c.value=!1}finally{m.value=!1}},500)}function i(){z.value&&!confirm("æ­£åœ¨å¤„ç†ä¸­ï¼Œç¡®å®šè¦å…³é—­å—ï¼Ÿ")||(t.closeModal(),t.resetState(),o.value="")}async function P(){const Z=o.value.trim();if(!Z){alert("è¯·è¾“å…¥ç½‘å€");return}try{new URL(Z)}catch{alert("è¯·è¾“å…¥æœ‰æ•ˆçš„ç½‘å€");return}t.resetState(),t.setUrl(Z),t.setStatus("extracting");try{await Hf(Z,t.settings,r=>{t.addLog(r)},r=>{t.setExtractResult(r),r.success?t.setStatus("extracted"):t.setError(r.error||"æå–å¤±è´¥")},r=>{t.setError(r)},u.value,r=>{t.addPageIncremental(r)})}catch(r){t.setError(r instanceof Error?r.message:"æå–å¤±è´¥")}}function d(Z){t.togglePageSelection(Z)}function g(){t.toggleSelectAll()}async function f(){if(!F.value?.pages||v.value===0){alert("è¯·é€‰æ‹©è¦å¯¼å…¥çš„å›¾ç‰‡");return}const Z=F.value.pages.filter(y=>b.value.has(y.pageNumber));t.setStatus("downloading"),t.updateDownloadProgress(0,Z.length);const r=j.value||"ai-agent";try{if(r==="gallery-dl"){const le=await qf();if(le.success&&le.images.length>0){let B=0;const ee=Math.min(le.images.length,Z.length);for(let de=0;de<ee;de++){const ve=le.images[de];ve&&ve.filename&&ve.data&&(s.addImage(ve.filename,ve.data),B++,t.updateDownloadProgress(B,ee))}t.setStatus("completed"),alert(`æˆåŠŸå¯¼å…¥ ${B} å¼ å›¾ç‰‡`),i();return}else throw new Error(le.error||"è·å–å›¾ç‰‡å¤±è´¥")}const y=await jf(Z,F.value.sourceUrl,t.settings,r);if(y.success&&y.images.length>0){t.setDownloadedImages(y.images),t.updateDownloadProgress(y.images.length,Z.length);for(const B of y.images)s.addImage(B.filename,B.dataUrl);t.setStatus("completed");const le=y.failedCount>0?`ï¼Œ${y.failedCount} å¼ å¤±è´¥`:"";alert(`æˆåŠŸå¯¼å…¥ ${y.images.length} å¼ å›¾ç‰‡${le}`),i()}else t.setError(y.error||"ä¸‹è½½å¤±è´¥")}catch(y){t.setError(y instanceof Error?y.message:"ä¸‹è½½å¤±è´¥")}}Se(E,Z=>{Z&&setTimeout(()=>{document.querySelector(".url-input")?.focus()},100)}),Se(o,Z=>{S(Z)});const x=X(()=>t.settings.agent.provider==="custom_openai");async function h(){if(!t.settings.firecrawl.apiKey){alert("è¯·è¾“å…¥ Firecrawl API Key");return}T.value=!0;try{const Z=await Jf(t.settings.firecrawl.apiKey);Z.success?alert("âœ… Firecrawl è¿æ¥æˆåŠŸ"):alert(`âŒ è¿æ¥å¤±è´¥: ${Z.error}`)}catch(Z){alert(`âŒ è¿æ¥å¤±è´¥: ${Z instanceof Error?Z.message:"æœªçŸ¥é”™è¯¯"}`)}finally{T.value=!1}}async function D(){if(!t.settings.agent.apiKey){alert("è¯·è¾“å…¥ AI Agent API Key");return}M.value=!0;try{const Z=await Yf(t.settings.agent.provider,t.settings.agent.apiKey,t.settings.agent.customBaseUrl,t.settings.agent.modelName);Z.success?alert("âœ… AI Agent è¿æ¥æˆåŠŸ"):alert(`âŒ è¿æ¥å¤±è´¥: ${Z.error}`)}catch(Z){alert(`âŒ è¿æ¥å¤±è´¥: ${Z instanceof Error?Z.message:"æœªçŸ¥é”™è¯¯"}`)}finally{M.value=!1}}function Y(){confirm("ç¡®å®šè¦é‡ç½®ä¸ºé»˜è®¤æç¤ºè¯å—ï¼Ÿ")&&t.resetExtractionPrompt()}return(Z,r)=>(A(),ut(kn,{to:"body"},[E.value?(A(),L("div",{key:0,class:"modal-overlay",onClick:at(i,["self"])},[e("div",Xf,[e("div",{class:"modal-header"},[r[37]||(r[37]=e("h2",{class:"modal-title"},[e("span",{class:"title-icon"},"ğŸŒ"),me(" ä»ç½‘é¡µå¯¼å…¥æ¼«ç”» ")],-1)),e("button",{class:"close-btn",onClick:i,title:"å…³é—­"},"Ã—")]),e("div",Gf,[e("div",Zf,[ne(e("input",{"onUpdate:modelValue":r[0]||(r[0]=y=>o.value=y),type:"url",class:"url-input",placeholder:"è¾“å…¥æ¼«ç”»ç½‘é¡µ URLï¼Œå¦‚ https://example.com/chapter-1",disabled:z.value,onKeyup:Sn(P,["enter"])},null,40,Qf),[[Te,o.value]]),ne(e("select",{"onUpdate:modelValue":r[1]||(r[1]=y=>u.value=y),class:"engine-select",disabled:z.value},[...r[38]||(r[38]=[e("option",{value:"auto"},"è‡ªåŠ¨é€‰æ‹©",-1),e("option",{value:"gallery-dl"},"Gallery-DL",-1),e("option",{value:"ai-agent"},"AI Agent",-1)])],8,eb),[[$s,u.value]]),e("button",{class:"extract-btn",disabled:z.value||!o.value.trim(),onClick:P},[H.value==="extracting"?(A(),L("span",ob)):(A(),L("span",nb,"ğŸ”")),me(" "+oe(H.value==="extracting"?"æå–ä¸­...":"å¼€å§‹æå–"),1)],8,tb)]),o.value.trim()&&!z.value?(A(),L("div",sb,[m.value?(A(),L("span",ab,"æ£€æŸ¥ä¸­...")):c.value?(A(),L("span",lb,"âœ“ è¯¥ç½‘ç«™æ”¯æŒ Gallery-DL é«˜é€Ÿä¸‹è½½")):a.value?(A(),L("span",ib,"è¯¥ç½‘ç«™å°†ä½¿ç”¨ AI Agent æ¨¡å¼")):ce("",!0)])):ce("",!0),r[80]||(r[80]=e("div",{class:"notice"}," âš ï¸ è¯·ä»…çˆ¬å–æ‚¨æœ‰æƒè®¿é—®çš„å†…å®¹ï¼Œå¹¶éµå®ˆç›®æ ‡ç½‘ç«™çš„ä½¿ç”¨æ¡æ¬¾ã€‚ ",-1)),e("div",rb,[e("div",{class:"settings-header",onClick:r[2]||(r[2]=y=>p.value=!p.value)},[e("span",ub,oe(p.value?"â–¼":"â–¶"),1),r[39]||(r[39]=e("span",{class:"settings-title"},"âš™ï¸ è®¾ç½®",-1)),r[40]||(r[40]=e("span",{class:"settings-hint"},"ç‚¹å‡»å±•å¼€é…ç½®",-1))]),p.value?(A(),L("div",cb,[e("div",db,[e("button",{class:Ie(["settings-tab",{active:_.value==="basic"}]),onClick:r[3]||(r[3]=y=>_.value="basic")}," åŸºæœ¬è®¾ç½® ",2),e("button",{class:Ie(["settings-tab",{active:_.value==="preprocess"}]),onClick:r[4]||(r[4]=y=>_.value="preprocess")}," å›¾ç‰‡é¢„å¤„ç† ",2),e("button",{class:Ie(["settings-tab",{active:_.value==="advanced"}]),onClick:r[5]||(r[5]=y=>_.value="advanced")}," é«˜çº§è®¾ç½® ",2)]),ne(e("div",gb,[e("div",pb,[r[42]||(r[42]=e("h4",{class:"group-title"},"Firecrawl é…ç½®",-1)),e("div",mb,[r[41]||(r[41]=e("label",{class:"form-label"},"API Key",-1)),e("div",vb,[e("input",{type:R.value?"text":"password",class:"form-input",value:K(t).settings.firecrawl.apiKey,onInput:r[6]||(r[6]=y=>K(t).setFirecrawlApiKey(y.target.value)),placeholder:"fc-xxxxxxxxxxxxxxxx"},null,40,fb),e("button",{class:"toggle-btn",onClick:r[7]||(r[7]=y=>R.value=!R.value)},oe(R.value?"ğŸ‘":"ğŸ‘â€ğŸ—¨"),1),e("button",{class:"test-btn",disabled:T.value||!K(t).settings.firecrawl.apiKey,onClick:h},oe(T.value?"æµ‹è¯•ä¸­...":"æµ‹è¯•è¿æ¥"),9,bb)])])]),e("div",hb,[r[49]||(r[49]=e("h4",{class:"group-title"},"AI Agent é…ç½®",-1)),e("div",xb,[r[43]||(r[43]=e("label",{class:"form-label"},"æœåŠ¡å•†",-1)),e("select",{class:"form-select",value:K(t).settings.agent.provider,onChange:r[8]||(r[8]=y=>K(t).setAgentProvider(y.target.value))},[(A(!0),L(Ve,null,Ye(K(ks),y=>(A(),L("option",{key:y.value,value:y.value},oe(y.label),9,_b))),128))],40,yb)]),e("div",Cb,[r[44]||(r[44]=e("label",{class:"form-label"},"API Key",-1)),e("div",Sb,[e("input",{type:I.value?"text":"password",class:"form-input",value:K(t).settings.agent.apiKey,onInput:r[9]||(r[9]=y=>K(t).setAgentApiKey(y.target.value)),placeholder:"sk-xxxxxxxxxxxxxxxx"},null,40,kb),e("button",{class:"toggle-btn",onClick:r[10]||(r[10]=y=>I.value=!I.value)},oe(I.value?"ğŸ‘":"ğŸ‘â€ğŸ—¨"),1)])]),x.value?(A(),L("div",wb,[r[45]||(r[45]=e("label",{class:"form-label"},"è‡ªå®šä¹‰ API åœ°å€",-1)),e("input",{type:"url",class:"form-input",value:K(t).settings.agent.customBaseUrl,onInput:r[11]||(r[11]=y=>K(t).setAgentBaseUrl(y.target.value)),placeholder:"https://api.example.com/v1"},null,40,$b)])):ce("",!0),e("div",Tb,[r[46]||(r[46]=e("label",{class:"form-label"},"æ¨¡å‹åç§°",-1)),e("input",{type:"text",class:"form-input",value:K(t).settings.agent.modelName,onInput:r[12]||(r[12]=y=>K(t).setAgentModelName(y.target.value)),placeholder:"gpt-4o-mini"},null,40,Ib)]),e("div",Pb,[e("label",Rb,[e("input",{type:"checkbox",checked:K(t).settings.agent.forceJsonOutput,onChange:r[13]||(r[13]=y=>K(t).setAgentForceJson(y.target.checked))},null,40,Db),r[47]||(r[47]=me(" å¼ºåˆ¶ JSON æ ¼å¼ ",-1))]),e("label",Mb,[e("input",{type:"checkbox",checked:K(t).settings.agent.useStream,onChange:r[14]||(r[14]=y=>K(t).setAgentUseStream(y.target.checked))},null,40,Eb),r[48]||(r[48]=me(" æµå¼è°ƒç”¨ ",-1))])]),e("div",Bb,[e("button",{class:"test-btn full",disabled:M.value||!K(t).settings.agent.apiKey,onClick:D},oe(M.value?"æµ‹è¯•ä¸­...":"æµ‹è¯• Agent è¿æ¥"),9,Ab)])]),e("div",Lb,[e("h4",{class:"group-title"},[r[50]||(r[50]=me(" æå–è®¾ç½® ",-1)),e("button",{class:"reset-btn",onClick:Y},"é‡ç½®ä¸ºé»˜è®¤")]),e("div",Fb,[r[51]||(r[51]=e("label",{class:"form-label"},"æå–æç¤ºè¯",-1)),e("textarea",{class:"form-textarea",value:K(t).settings.extraction.prompt,onInput:r[15]||(r[15]=y=>K(t).setExtractionPrompt(y.target.value)),rows:"6",placeholder:"è¾“å…¥æå–æç¤ºè¯..."},null,40,Ub)]),e("div",Ob,[r[52]||(r[52]=e("label",{class:"form-label"},"æœ€å¤§è¿­ä»£æ¬¡æ•°",-1)),e("input",{type:"number",class:"form-input small",value:K(t).settings.extraction.maxIterations,onInput:r[16]||(r[16]=y=>K(t).setExtractionMaxIterations(Number(y.target.value))),min:"1",max:"20"},null,40,zb)])]),e("div",Nb,[r[58]||(r[58]=e("h4",{class:"group-title"},"ä¸‹è½½è®¾ç½®",-1)),e("div",Vb,[e("div",Wb,[r[53]||(r[53]=e("label",{class:"form-label"},"å¹¶å‘æ•°",-1)),e("input",{type:"number",class:"form-input small",value:K(t).settings.download.concurrency,onInput:r[17]||(r[17]=y=>K(t).setDownloadConcurrency(Number(y.target.value))),min:"1",max:"10"},null,40,Kb)]),e("div",qb,[r[54]||(r[54]=e("label",{class:"form-label"},"è¶…æ—¶ (ç§’)",-1)),e("input",{type:"number",class:"form-input small",value:K(t).settings.download.timeout,onInput:r[18]||(r[18]=y=>K(t).setDownloadTimeout(Number(y.target.value))),min:"5",max:"120"},null,40,Hb)]),e("div",jb,[r[55]||(r[55]=e("label",{class:"form-label"},"é‡è¯•æ¬¡æ•°",-1)),e("input",{type:"number",class:"form-input small",value:K(t).settings.download.retries,onInput:r[19]||(r[19]=y=>K(t).setDownloadRetries(Number(y.target.value))),min:"0",max:"5"},null,40,Jb)]),e("div",Yb,[r[56]||(r[56]=e("label",{class:"form-label"},"ä¸‹è½½é—´éš” (ms)",-1)),e("input",{type:"number",class:"form-input small",value:K(t).settings.download.delay,onInput:r[20]||(r[20]=y=>K(t).setDownloadDelay(Number(y.target.value))),min:"0",max:"2000",step:"100"},null,40,Xb)])]),e("div",Gb,[e("label",Zb,[e("input",{type:"checkbox",checked:K(t).settings.download.useReferer,onChange:r[21]||(r[21]=y=>K(t).setDownloadUseReferer(y.target.checked))},null,40,Qb),r[57]||(r[57]=me(" è‡ªåŠ¨æ·»åŠ  Referer ",-1))])])]),e("div",eh,[r[61]||(r[61]=e("h4",{class:"group-title"},"ç•Œé¢è®¾ç½®",-1)),e("div",th,[e("label",oh,[e("input",{type:"checkbox",checked:K(t).settings.ui.showAgentLogs,onChange:r[22]||(r[22]=y=>K(t).setShowAgentLogs(y.target.checked))},null,40,nh),r[59]||(r[59]=me(" æ˜¾ç¤º AI å·¥ä½œæ—¥å¿— ",-1))]),e("label",sh,[e("input",{type:"checkbox",checked:K(t).settings.ui.autoImport,onChange:r[23]||(r[23]=y=>K(t).setAutoImport(y.target.checked))},null,40,ah),r[60]||(r[60]=me(" æå–åè‡ªåŠ¨å¯¼å…¥ ",-1))])])])],512),[[Oe,_.value==="basic"]]),ne(e("div",lh,[e("div",ih,[e("div",rh,[e("label",uh,[e("input",{type:"checkbox",checked:K(t).settings.imagePreprocess.enabled,onChange:r[24]||(r[24]=y=>K(t).setImagePreprocessEnabled(y.target.checked))},null,40,ch),r[62]||(r[62]=me(" å¯ç”¨å›¾ç‰‡é¢„å¤„ç† ",-1))])]),K(t).settings.imagePreprocess.enabled?(A(),L(Ve,{key:0},[e("div",dh,[e("label",gh,[e("input",{type:"checkbox",checked:K(t).settings.imagePreprocess.autoRotate,onChange:r[25]||(r[25]=y=>K(t).setImageAutoRotate(y.target.checked))},null,40,ph),r[63]||(r[63]=me(" æ ¹æ® EXIF è‡ªåŠ¨æ—‹è½¬ ",-1))])]),r[71]||(r[71]=e("h5",{class:"subsection-title"},"å‹ç¼©è®¾ç½®",-1)),e("div",mh,[e("label",vh,[e("input",{type:"checkbox",checked:K(t).settings.imagePreprocess.compression.enabled,onChange:r[26]||(r[26]=y=>K(t).setImageCompressionEnabled(y.target.checked))},null,40,fh),r[64]||(r[64]=me(" å¯ç”¨å‹ç¼© ",-1))])]),K(t).settings.imagePreprocess.compression.enabled?(A(),L("div",bh,[e("div",hh,[r[65]||(r[65]=e("label",{class:"form-label"},"è´¨é‡ (0-100)",-1)),e("input",{type:"number",class:"form-input small",value:K(t).settings.imagePreprocess.compression.quality,onInput:r[27]||(r[27]=y=>K(t).setImageCompressionQuality(Number(y.target.value))),min:"1",max:"100"},null,40,xh)]),e("div",yh,[r[66]||(r[66]=e("label",{class:"form-label"},"æœ€å¤§å®½åº¦ (0=ä¸é™)",-1)),e("input",{type:"number",class:"form-input small",value:K(t).settings.imagePreprocess.compression.maxWidth,onInput:r[28]||(r[28]=y=>K(t).setImageMaxWidth(Number(y.target.value))),min:"0"},null,40,_h)]),e("div",Ch,[r[67]||(r[67]=e("label",{class:"form-label"},"æœ€å¤§é«˜åº¦ (0=ä¸é™)",-1)),e("input",{type:"number",class:"form-input small",value:K(t).settings.imagePreprocess.compression.maxHeight,onInput:r[29]||(r[29]=y=>K(t).setImageMaxHeight(Number(y.target.value))),min:"0"},null,40,Sh)])])):ce("",!0),r[72]||(r[72]=e("h5",{class:"subsection-title"},"æ ¼å¼è½¬æ¢",-1)),e("div",kh,[e("label",wh,[e("input",{type:"checkbox",checked:K(t).settings.imagePreprocess.formatConvert.enabled,onChange:r[30]||(r[30]=y=>K(t).setImageFormatConvertEnabled(y.target.checked))},null,40,$h),r[68]||(r[68]=me(" å¯ç”¨æ ¼å¼è½¬æ¢ ",-1))])]),K(t).settings.imagePreprocess.formatConvert.enabled?(A(),L("div",Th,[r[70]||(r[70]=e("label",{class:"form-label"},"ç›®æ ‡æ ¼å¼",-1)),e("select",{class:"form-select",value:K(t).settings.imagePreprocess.formatConvert.targetFormat,onChange:r[31]||(r[31]=y=>K(t).setImageTargetFormat(y.target.value))},[...r[69]||(r[69]=[e("option",{value:"original"},"ä¿æŒåŸæ ¼å¼",-1),e("option",{value:"jpeg"},"JPEG",-1),e("option",{value:"png"},"PNG",-1),e("option",{value:"webp"},"WebP",-1)])],40,Ih)])):ce("",!0)],64)):ce("",!0)])],512),[[Oe,_.value==="preprocess"]]),ne(e("div",Ph,[e("div",Rh,[r[76]||(r[76]=e("h4",{class:"group-title"},"è‡ªå®šä¹‰è¯·æ±‚å¤´",-1)),e("div",Dh,[r[73]||(r[73]=e("label",{class:"form-label"},"Cookie",-1)),e("input",{type:"text",class:"form-input",value:K(t).settings.advanced.customCookie,onInput:r[32]||(r[32]=y=>K(t).setCustomCookie(y.target.value)),placeholder:"name=value; name2=value2"},null,40,Mh)]),e("div",Eh,[r[74]||(r[74]=e("label",{class:"form-label"},"Headers (JSON)",-1)),e("textarea",{class:"form-textarea",value:K(t).settings.advanced.customHeaders,onInput:r[33]||(r[33]=y=>K(t).setCustomHeaders(y.target.value)),rows:"3",placeholder:'{"X-Custom-Header": "value"}'},null,40,Bh)]),e("div",Ah,[e("label",Lh,[e("input",{type:"checkbox",checked:K(t).settings.advanced.bypassProxy,onChange:r[34]||(r[34]=y=>K(t).setBypassProxy(y.target.checked))},null,40,Fh),r[75]||(r[75]=me(" ç»•è¿‡ç³»ç»Ÿä»£ç† (è¿æ¥æœ¬åœ°æœåŠ¡æ—¶ä½¿ç”¨) ",-1))])])])],512),[[Oe,_.value==="advanced"]])])):ce("",!0)]),ae.value&&V.value.length>0?(A(),L("div",Uh,[e("div",{class:"logs-header",onClick:r[35]||(r[35]=y=>l.value=!l.value)},[e("span",Oh,oe(l.value?"â–¼":"â–¶"),1),r[77]||(r[77]=e("span",null,"AI å·¥ä½œæ—¥å¿—",-1)),H.value==="extracting"?(A(),L("span",zh,"(æå–ä¸­...)")):ce("",!0)]),l.value?(A(),L("div",Nh,[(A(!0),L(Ve,null,Ye(V.value,(y,le)=>(A(),L("div",{key:le,class:Ie(["log-item",`log-${y.type}`])},[e("span",Vh,"["+oe(y.timestamp)+"]",1),e("span",Wh,oe(y.message),1)],2))),128))])):ce("",!0)])):ce("",!0),N.value?(A(),L("div",Kh,[r[78]||(r[78]=e("span",{class:"error-icon"},"âŒ",-1)),e("span",qh,oe(N.value),1)])):ce("",!0),F.value?.success?(A(),L("div",Hh,[e("div",jh,[e("span",Jh," ğŸ“– ã€Š"+oe(F.value.comicTitle)+"ã€‹- "+oe(F.value.chapterTitle),1),e("span",Yh,[e("span",Xh,"å…± "+oe(F.value.totalPages)+" å¼ ",1),q.value?(A(),L("span",Gh,"| å¼•æ“: "+oe(q.value),1)):ce("",!0)])]),e("div",Zh,[e("label",Qh,[e("input",{type:"checkbox",checked:Q.value,onChange:g},null,40,ex),r[79]||(r[79]=me(" å…¨é€‰ ",-1))]),e("span",tx,"å·²é€‰: "+oe(v.value)+" å¼ ",1)]),e("div",ox,[(A(!0),L(Ve,null,Ye(F.value.pages,y=>(A(),L("div",{key:y.pageNumber,class:Ie(["image-item",{selected:b.value.has(y.pageNumber)}]),onClick:le=>d(y.pageNumber)},[e("div",sx,[e("input",{type:"checkbox",checked:b.value.has(y.pageNumber),onClick:r[36]||(r[36]=at(()=>{},["stop"])),onChange:le=>d(y.pageNumber)},null,40,ax)]),e("div",lx,[e("img",{src:W(y.imageUrl),alt:`ç¬¬${y.pageNumber}é¡µ`,loading:"lazy"},null,8,ix)]),e("div",rx,"ç¬¬ "+oe(y.pageNumber)+" é¡µ",1)],10,nx))),128))])])):ce("",!0),H.value==="downloading"?(A(),L("div",ux,[e("div",cx," ä¸‹è½½è¿›åº¦: "+oe(k.value.current)+"/"+oe(k.value.total),1),e("div",dx,[e("div",{class:"progress-fill",style:st({width:`${$.value}%`})},null,4)])])):ce("",!0)]),e("div",gx,[e("button",{class:"cancel-btn",onClick:i,disabled:H.value==="downloading"}," å–æ¶ˆ ",8,px),e("button",{class:"import-btn",disabled:!F.value?.success||v.value===0||z.value,onClick:f},[H.value==="downloading"?(A(),L("span",vx)):(A(),L("span",fx,"ğŸ“¥")),me(" "+oe(H.value==="downloading"?"ä¸‹è½½ä¸­...":"å¯¼å…¥"),1)],8,mx)])])])):ce("",!0)]))}}),hx=He(bx,[["__scopeId","data-v-78fc5cb0"]]),xx={class:"disclaimer-container"},yx={class:"disclaimer-content"},_x={class:"confirmation-area"},Cx=["placeholder"],Sx={key:0,class:"input-error"},kx={class:"disclaimer-footer"},wx=["disabled"],jt="æˆ‘å·²é˜…è¯»å¹¶åŒæ„",$x=je({__name:"WebImportDisclaimer",setup(n){const t=On(),s=w(""),o=X(()=>t.disclaimerVisible),l=X(()=>s.value.trim()===jt);function u(){l.value&&(t.acceptDisclaimer(),s.value="")}function a(){t.rejectDisclaimer(),s.value=""}return(c,m)=>(A(),ut(kn,{to:"body"},[o.value?(A(),L("div",{key:0,class:"disclaimer-overlay",onClick:at(a,["self"])},[e("div",xx,[m[3]||(m[3]=e("div",{class:"disclaimer-header"},[e("span",{class:"warning-icon"},"âš ï¸"),e("h2",{class:"disclaimer-title"},"é‡è¦å…è´£å£°æ˜")],-1)),e("div",yx,[m[2]||(m[2]=e("div",{class:"disclaimer-text"},[e("h3",null,"ğŸ“œ ä½¿ç”¨æ¡æ¬¾ä¸æ³•å¾‹å£°æ˜"),e("div",{class:"section"},[e("h4",null,"1. åŠŸèƒ½è¯´æ˜"),e("p",null,[me(' "ä»ç½‘é¡µå¯¼å…¥"åŠŸèƒ½å…è®¸æ‚¨ä»äº’è”ç½‘ç½‘é¡µä¸­æå–å›¾ç‰‡ã€‚æ­¤åŠŸèƒ½ä»…ä¾›'),e("strong",null,"æŠ€æœ¯ç ”ç©¶ä¸ä¸ªäººå­¦ä¹ "),me("ä¹‹ç›®çš„æä¾›ã€‚ ")])]),e("div",{class:"section"},[e("h4",null,"2. ç”¨æˆ·è´£ä»»"),e("ul",null,[e("li",null,[me("æ‚¨åº”å½“ç¡®ä¿æ‹¥æœ‰"),e("strong",null,"åˆæ³•æƒåˆ©"),me("è®¿é—®å’Œä¸‹è½½ç›®æ ‡å†…å®¹")]),e("li",null,[me("æ‚¨åº”å½“éµå®ˆç›®æ ‡ç½‘ç«™çš„"),e("strong",null,"æœåŠ¡æ¡æ¬¾"),me("å’Œ"),e("strong",null,"ä½¿ç”¨åè®®")]),e("li",null,[me("æ‚¨åº”å½“å°Šé‡å†…å®¹åˆ›ä½œè€…çš„"),e("strong",null,"ç‰ˆæƒ"),me("å’Œ"),e("strong",null,"çŸ¥è¯†äº§æƒ")]),e("li",null,[me("æ‚¨"),e("strong",null,"ä¸å¾—"),me("å°†ä¸‹è½½çš„å†…å®¹ç”¨äºå•†ä¸šç›®çš„æˆ–éæ³•ä¼ æ’­")]),e("li",null,[me("æ‚¨"),e("strong",null,"ä¸å¾—"),me("ä½¿ç”¨æœ¬åŠŸèƒ½ç»•è¿‡ä»˜è´¹å†…å®¹çš„è®¿é—®é™åˆ¶")])])]),e("div",{class:"section"},[e("h4",null,"3. ä½¿ç”¨é™åˆ¶"),e("p",null,[me("æœ¬åŠŸèƒ½"),e("strong",null,"ä¸¥ç¦"),me("ç”¨äºä»¥ä¸‹ç›®çš„ï¼š")]),e("ul",null,[e("li",null,[me("ä¸‹è½½ã€å­˜å‚¨æˆ–ä¼ æ’­"),e("strong",null,"ä¾µæƒå†…å®¹")]),e("li",null,[me("ç»•è¿‡ç½‘ç«™çš„"),e("strong",null,"ä»˜è´¹å¢™"),me("æˆ–"),e("strong",null,"è®¿é—®æ§åˆ¶")]),e("li",null,[me("è¿›è¡Œ"),e("strong",null,"å•†ä¸šç”¨é€”"),me("æˆ–å¤§è§„æ¨¡"),e("strong",null,"æ‰¹é‡çˆ¬å–")]),e("li",null,[me("ä»»ä½•è¿å"),e("strong",null,"å½“åœ°æ³•å¾‹æ³•è§„"),me("çš„æ´»åŠ¨")]),e("li",null,[me("å¯¹ç›®æ ‡ç½‘ç«™é€ æˆ"),e("strong",null,"æœåŠ¡å™¨è´Ÿæ‹…"),me("æˆ–"),e("strong",null,"æ¶æ„æ”»å‡»")])])]),e("div",{class:"section"},[e("h4",null,"4. å…è´£æ¡æ¬¾"),e("p",null,[me(" æœ¬è½¯ä»¶ä½œè€…åŠè´¡çŒ®è€…"),e("strong",null,"ä¸å¯¹æ‚¨ä½¿ç”¨æœ¬åŠŸèƒ½æ‰€å¯¼è‡´çš„ä»»ä½•ç›´æ¥æˆ–é—´æ¥åæœæ‰¿æ‹…è´£ä»»"),me("ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºï¼š ")]),e("ul",null,[e("li",null,"å› ä¾µçŠ¯ç‰ˆæƒè€Œäº§ç”Ÿçš„æ³•å¾‹è´£ä»»"),e("li",null,"å› è¿åæœåŠ¡æ¡æ¬¾è€Œå¯¼è‡´çš„è´¦å·å°ç¦"),e("li",null,"å› æ•°æ®ä¸¢å¤±æˆ–æŸåè€Œé€ æˆçš„æŸå¤±"),e("li",null,"ä»»ä½•å…¶ä»–å› ä½¿ç”¨æœ¬åŠŸèƒ½è€Œäº§ç”Ÿçš„ä¸åˆ©åæœ")])]),e("div",{class:"section warning-section"},[e("h4",null,"5. ç¡®è®¤å£°æ˜"),e("p",null,[me(" ä½¿ç”¨æœ¬åŠŸèƒ½å³è¡¨ç¤ºæ‚¨"),e("strong",null,"å·²é˜…è¯»ã€ç†è§£å¹¶åŒæ„"),me("ä¸Šè¿°æ‰€æœ‰æ¡æ¬¾ï¼Œå¹¶æ‰¿è¯ºï¼š ")]),e("ul",null,[e("li",null,[me("ä»…å°†æœ¬åŠŸèƒ½ç”¨äº"),e("strong",null,"åˆæ³•ã€åˆè§„"),me("çš„ç›®çš„")]),e("li",null,[e("strong",null,"è‡ªè¡Œæ‰¿æ‹…"),me("ä½¿ç”¨æœ¬åŠŸèƒ½æ‰€å¸¦æ¥çš„ä¸€åˆ‡é£é™©å’Œè´£ä»»")]),e("li",null,[me("å¦‚å› ä½¿ç”¨æœ¬åŠŸèƒ½å¯¼è‡´ä»»ä½•äº‰è®®ï¼Œ"),e("strong",null,"ä¸æœ¬è½¯ä»¶ä½œè€…æ— å…³")])])])],-1)),e("div",_x,[m[1]||(m[1]=e("p",{class:"confirmation-prompt"}," å¦‚æœæ‚¨å·²å®Œæ•´é˜…è¯»å¹¶åŒæ„ä»¥ä¸Šæ¡æ¬¾ï¼Œè¯·åœ¨ä¸‹æ–¹è¾“å…¥æ¡†ä¸­å‡†ç¡®è¾“å…¥ï¼š ",-1)),e("p",{class:"required-text"},[e("code",null,oe(jt))]),ne(e("input",{"onUpdate:modelValue":m[0]||(m[0]=p=>s.value=p),type:"text",class:"confirmation-input",placeholder:`è¯·è¾“å…¥: ${jt}`,onKeyup:Sn(u,["enter"])},null,40,Cx),[[Te,s.value]]),s.value&&!l.value?(A(),L("p",Sx," è¾“å…¥ä¸æ­£ç¡®ï¼Œè¯·å®Œæ•´è¾“å…¥ã€Œ"+oe(jt)+"ã€ ")):ce("",!0)])]),e("div",kx,[e("button",{class:"btn-cancel",onClick:a}," æˆ‘ä¸åŒæ„ï¼Œè¿”å› "),e("button",{class:"btn-confirm",disabled:!l.value,onClick:u}," âœ“ ç¡®è®¤å¹¶ç»§ç»­ ",8,wx)])])])):ce("",!0)]))}}),Tx=He($x,[["__scopeId","data-v-3750d090"]]),Ix={class:"app-header"},Px={class:"header-content"},Rx={class:"logo-container"},Dx={class:"header-links"},Mx={class:"container"},Ex={id:"image-display-area"},Bx={id:"upload-section",class:"card upload-card"},Ax={class:"upload-actions"},Lx={key:1,class:"bookshelf-mode-hint"},Fx=je({__name:"TranslateView",setup(n){const t=Cn(),s=et(),o=ze(),l=It(),u=gt(),{validateBeforeTranslation:a,initValidation:c}=En(),m=Eo(),p=Oi(),_=w(!1),T=w(void 0),M=w(!1),R=w(!1),I=X(()=>s.currentImage),E=X(()=>s.hasImages),H=X(()=>s.isBatchTranslationInProgress),V=X(()=>s.failedImageCount>0),F=X(()=>!!t.query.book&&!!t.query.chapter),b=X(()=>t.query.book),v=X(()=>t.query.chapter),k=X(()=>p.currentBookTitle.value),$=X(()=>p.currentChapterTitle.value),N=X(()=>F.value&&$.value&&k.value?`${$.value} - ${k.value}`:"Saber-Translator");dt(async()=>{s.clearImages(),u.clearBubbles(),await p.initializeApp(),c(),window.addEventListener("keydown",C)}),Nt(()=>{window.removeEventListener("keydown",C)}),Se(()=>[t.query.book,t.query.chapter],async([O,te],[he,ge])=>{O&&te?(s.clearImages(),u.clearBubbles(),await q()):he&&ge&&!O&&!te&&(s.clearImages(),u.clearBubbles(),await p.initializeBookChapterContext(),console.log("[TranslateView] ä»ä¹¦æ¶æ¨¡å¼åˆ‡æ¢åˆ°å¿«é€Ÿç¿»è¯‘æ¨¡å¼ï¼Œå·²æ¸…ç©ºæ•°æ®"))}),Se(N,O=>{typeof document<"u"&&(document.title=O)},{immediate:!0});const z=w(!1);function ae(O){if(!O)return;const te=o.settings.textStyle;o.updateTextStyle({fontSize:O.fontSize??te.fontSize,autoFontSize:O.autoFontSize??te.autoFontSize,fontFamily:O.fontFamily??te.fontFamily,layoutDirection:O.layoutDirection??te.layoutDirection,textColor:O.textColor??te.textColor,fillColor:O.fillColor??te.fillColor,strokeEnabled:O.strokeEnabled??te.strokeEnabled,strokeColor:O.strokeColor??te.strokeColor,strokeWidth:O.strokeWidth??te.strokeWidth,inpaintMethod:O.inpaintMethod??te.inpaintMethod,useAutoTextColor:O.useAutoTextColor??te.useAutoTextColor})}function j(O){s.currentImage&&s.updateCurrentImage({fontSize:O.fontSize,autoFontSize:O.autoFontSize,fontFamily:O.fontFamily,layoutDirection:O.layoutDirection,textColor:O.textColor,fillColor:O.fillColor,strokeEnabled:O.strokeEnabled,strokeColor:O.strokeColor,strokeWidth:O.strokeWidth,inpaintMethod:O.inpaintMethod,useAutoTextColor:O.useAutoTextColor})}Se(()=>s.currentImage,O=>{if(O&&!z.value){z.value=!0;try{ae(O),console.log(`[TranslateView] å·²åŒæ­¥å›¾ç‰‡ ${s.currentImageIndex} çš„æ–‡å­—è®¾ç½®åˆ°ä¾§è¾¹æ `)}finally{z.value=!1}}},{immediate:!1}),Se(()=>o.settings.textStyle,O=>{if(s.currentImage&&!z.value){z.value=!0;try{j(O),console.log(`[TranslateView] å·²å°†ä¾§è¾¹æ è®¾ç½®åŒæ­¥åˆ°å›¾ç‰‡ ${s.currentImageIndex}`)}finally{z.value=!1}}},{deep:!0});async function q(){if(!(!b.value||!v.value))try{await p.initializeBookChapterContext()}catch(O){console.error("åŠ è½½ç« èŠ‚ä¼šè¯å¤±è´¥:",O),_e("åŠ è½½ç« èŠ‚ä¼šè¯å¤±è´¥","error")}}function Q(O){console.log(`ä¸Šä¼ å®Œæˆï¼Œå…± ${O} å¼ å›¾ç‰‡`),s.hasImages&&(s.sortImagesByFileName(),p.switchImage(0))}async function W(O){if(!Object.values(O).some(ge=>ge)){_e("è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè¦åº”ç”¨çš„è®¾ç½®é¡¹","warning");return}if(s.images.length===0){_e("æ²¡æœ‰å¯åº”ç”¨çš„å›¾ç‰‡","warning");return}if(s.images.length<=1){_e("åªæœ‰ä¸€å¼ å›¾ç‰‡ï¼Œæ— éœ€åº”ç”¨åˆ°å…¨éƒ¨","info");return}if(!s.images.some(ge=>ge.bubbleStates&&ge.bubbleStates.length>0)){_e("æ²¡æœ‰å·²ç¿»è¯‘çš„å›¾ç‰‡","warning");return}try{const{textStyle:ge}=o.settings,Re=ge.layoutDirection==="auto",Ee=ge.useAutoTextColor===!0,Fe=ge.autoFontSize===!0,ke={fontSize:ge.fontSize,fontFamily:ge.fontFamily,textDirection:ge.layoutDirection==="auto"?"vertical":ge.layoutDirection,textColor:ge.textColor,fillColor:ge.fillColor,strokeEnabled:ge.strokeEnabled,strokeColor:ge.strokeColor,strokeWidth:ge.strokeWidth},Be=U=>{if(!U||U.length!==3)return null;const[re,Pe,De]=U;return"#"+[re,Pe,De].map(tt=>{const rt=Math.max(0,Math.min(255,Math.round(tt))).toString(16);return rt.length===1?"0"+rt:rt}).join("")},ye=U=>{const re={...U};if(O.fontSize&&!Fe&&(re.fontSize=ke.fontSize),O.fontFamily&&(re.fontFamily=ke.fontFamily),O.layoutDirection)if(Re){const Pe=U.autoTextDirection;re.textDirection=Pe==="vertical"||Pe==="horizontal"?Pe:"vertical"}else re.textDirection=ke.textDirection;if(O.textColor)if(Ee&&U.autoFgColor){const Pe=Be(U.autoFgColor);re.textColor=Pe??ke.textColor}else re.textColor=ke.textColor;if(O.fillColor)if(Ee&&U.autoBgColor){const Pe=Be(U.autoBgColor);re.fillColor=Pe??ke.fillColor}else re.fillColor=ke.fillColor;return O.strokeEnabled&&(re.strokeEnabled=ke.strokeEnabled),O.strokeColor&&(re.strokeColor=ke.strokeColor),O.strokeWidth&&(re.strokeWidth=ke.strokeWidth),re};let lt=0;const Ge=s.images;for(let U=0;U<Ge.length;U++){const re=Ge[U];if(re&&re.bubbleStates&&re.bubbleStates.length>0){const De={bubbleStates:re.bubbleStates.map(ye)};O.fontSize&&(De.autoFontSize=Fe,Fe||(De.fontSize=ke.fontSize)),O.fontFamily&&(De.fontFamily=ke.fontFamily),O.layoutDirection&&(De.layoutDirection=ge.layoutDirection),(O.textColor||O.fillColor)&&(De.useAutoTextColor=Ee),O.textColor&&(Ee||(De.textColor=ke.textColor)),O.fillColor&&(Ee||(De.fillColor=ke.fillColor)),O.strokeEnabled&&(De.strokeEnabled=ke.strokeEnabled),O.strokeColor&&(De.strokeColor=ke.strokeColor),O.strokeWidth&&(De.strokeWidth=ke.strokeWidth),s.updateImageByIndex(U,De),lt++}}if(u.bubbles.length>0){const U=u.bubbles.map(ye);u.setBubbles(U)}const Ze=[];O.fontSize&&Ze.push(Fe?"è‡ªåŠ¨å­—å·":"å­—å·"),O.fontFamily&&Ze.push("å­—ä½“"),O.layoutDirection&&Ze.push(Re?"è‡ªåŠ¨æ’ç‰ˆæ–¹å‘":"æ’ç‰ˆæ–¹å‘"),O.textColor&&Ze.push(Ee?"è‡ªåŠ¨æ–‡å­—é¢œè‰²":"æ–‡å­—é¢œè‰²"),O.fillColor&&Ze.push(Ee?"è‡ªåŠ¨å¡«å……é¢œè‰²":"å¡«å……é¢œè‰²"),O.strokeEnabled&&Ze.push("æè¾¹å¼€å…³"),O.strokeColor&&Ze.push("æè¾¹é¢œè‰²"),O.strokeWidth&&Ze.push("æè¾¹å®½åº¦");const nt=[];for(let U=0;U<Ge.length;U++){const re=Ge[U];re&&re.translatedDataURL&&re.bubbleStates&&re.bubbleStates.length>0&&nt.push(U)}if(nt.length>0){m.progress.value={isInProgress:!0,current:0,total:nt.length,completed:0,failed:0,label:`åº”ç”¨è®¾ç½®ä¸­ï¼š0 / ${nt.length}`,percentage:0};const{parallelRender:U}=await it(async()=>{const{parallelRender:Pe}=await Promise.resolve().then(()=>hi);return{parallelRender:Pe}},void 0);let re=0;for(let Pe=0;Pe<nt.length;Pe++){const De=nt[Pe];if(De===void 0)continue;const tt=s.images[De];if(!(!tt||!tt.bubbleStates))try{let rt="";if(tt.cleanImageData?rt=tt.cleanImageData.includes("base64,")?tt.cleanImageData.split("base64,")[1]||"":tt.cleanImageData:tt.originalDataURL&&(rt=tt.originalDataURL.includes("base64,")?tt.originalDataURL.split("base64,")[1]||"":tt.originalDataURL,console.log(`handleApplyToAll: å›¾ç‰‡ ${De} ä½¿ç”¨åŸå›¾ä½œä¸ºèƒŒæ™¯ï¼ˆå…œåº•ï¼‰`)),!rt){console.log(`handleApplyToAll: å›¾ç‰‡ ${De} æ²¡æœ‰å¯ç”¨çš„èƒŒæ™¯å›¾ï¼Œè·³è¿‡`),m.progress.value.failed++;continue}const Mt=tt.bubbleStates.map(Le=>({originalText:Le.originalText||"",translatedText:Le.translatedText||"",textboxText:Le.textboxText||"",coords:Le.coords,polygon:Le.polygon,fontSize:Le.fontSize,fontFamily:Le.fontFamily,textDirection:Le.textDirection,autoTextDirection:Le.autoTextDirection,textColor:Le.textColor,fillColor:Le.fillColor,rotationAngle:Le.rotationAngle||0,position:Le.position||{x:0,y:0},strokeEnabled:Le.strokeEnabled,strokeColor:Le.strokeColor,strokeWidth:Le.strokeWidth,inpaintMethod:Le.inpaintMethod,autoFgColor:Le.autoFgColor,autoBgColor:Le.autoBgColor})),ht=await U({clean_image:rt,bubble_states:Mt,fontSize:ge.fontSize,fontFamily:ge.fontFamily,textDirection:ge.layoutDirection==="auto"?"vertical":ge.layoutDirection,textColor:ge.textColor,strokeEnabled:ge.strokeEnabled,strokeColor:ge.strokeColor,strokeWidth:ge.strokeWidth,autoFontSize:O.fontSize&&Fe,use_individual_styles:!0});if(ht.success&&ht.final_image){const Le=ht.bubble_states||tt.bubbleStates;s.updateImageByIndex(De,{translatedDataURL:`data:image/png;base64,${ht.final_image}`,bubbleStates:Le,hasUnsavedChanges:!0}),re++,m.progress.value.current=re,m.progress.value.label=`åº”ç”¨è®¾ç½®ä¸­ï¼š${re} / ${nt.length}`,m.progress.value.percentage=Math.round(re/nt.length*100)}else m.progress.value.failed++}catch(rt){console.error(`é‡æ¸²æŸ“å›¾ç‰‡ ${De} å¤±è´¥:`,rt),m.progress.value.failed++}}m.progress.value.isInProgress=!1}const Ae=s.currentImage;if(Ae){z.value=!0;try{ae(Ae),console.log("[TranslateView] åº”ç”¨åˆ°å…¨éƒ¨å®Œæˆï¼Œå·²åŒæ­¥å½“å‰å›¾ç‰‡è®¾ç½®åˆ°ä¾§è¾¹æ ")}finally{z.value=!1}}_e(`å·²å°† ${Ze.join("ã€")} åº”ç”¨åˆ° ${lt} å¼ å›¾ç‰‡`,"success"),console.log(`[TranslateView] åº”ç”¨è®¾ç½®åˆ°å…¨éƒ¨å®Œæˆï¼Œæ›´æ–°äº† ${lt} å¼ å›¾ç‰‡ï¼Œé‡æ¸²æŸ“äº† ${nt.length} å¼ `)}catch(ge){console.error("åº”ç”¨è®¾ç½®åˆ°å…¨éƒ¨å¤±è´¥:",ge),_e("åº”ç”¨è®¾ç½®å¤±è´¥","error")}}async function se(){I.value&&a("normal")&&await m.translateCurrentImage()}async function S(){E.value&&a("normal")&&await m.translateAllImages()}async function i(){E.value&&a("hq")&&await m.executeHqTranslation()}async function P(){E.value&&a("proofread")&&await m.executeProofreading()}async function d(){I.value&&await m.removeTextOnly()}async function g(){E.value&&await m.removeAllTexts()}async function f(O,te){E.value&&a("normal")&&await m.translateImageRange({startPage:O,endPage:te})}async function x(O,te){E.value&&a("hq")&&await m.executeHqTranslation({startPage:O,endPage:te})}async function h(O,te){E.value&&a("proofread")&&await m.executeProofreading({startPage:O,endPage:te})}async function D(O,te){E.value&&await m.removeTextRange({startPage:O,endPage:te})}function Y(){if(!I.value)return;const O=I.value.fileName||`å›¾ç‰‡ ${s.currentImageIndex+1}`;confirm(`ç¡®å®šè¦åˆ é™¤å½“å‰å›¾ç‰‡ (${O}) å—ï¼Ÿ`)&&(s.deleteCurrentImage(),_e("å›¾ç‰‡å·²åˆ é™¤","success"))}function Z(){E.value&&confirm("ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰å›¾ç‰‡å—ï¼Ÿè¿™å°†ä¸¢å¤±æ‰€æœ‰æœªä¿å­˜çš„è¿›åº¦ã€‚")&&(s.clearImages(),_e("æ‰€æœ‰å›¾ç‰‡å·²æ¸…é™¤","success"))}async function r(){try{const O=await wn(),te=await _o();if(O.success&&te.success)_e("ä¸´æ—¶æ–‡ä»¶æ¸…ç†å®Œæˆ","success");else{const he=[];O.success||he.push("è°ƒè¯•æ–‡ä»¶æ¸…ç†å¤±è´¥"),te.success||he.push("ä¸´æ—¶æ–‡ä»¶æ¸…ç†å¤±è´¥"),_e(he.join("ï¼Œ"),"warning")}}catch{_e("æ¸…ç†ä¸´æ—¶æ–‡ä»¶å¤±è´¥","error")}}function y(){p.goToPrevious()}function le(){p.goToNext()}function B(){R.value=!R.value}async function ee(){if(!V.value){_e("æ²¡æœ‰å¤±è´¥çš„å›¾ç‰‡éœ€è¦é‡æ–°ç¿»è¯‘","info");return}a("normal")&&await m.retryFailedImages()}async function de(){if(!E.value){_e("æ²¡æœ‰å¯ä¿å­˜çš„å†…å®¹","warning");return}if(!(!b.value||!v.value))try{await l.saveChapterSession(b.value,v.value)?_e("ç« èŠ‚è¿›åº¦å·²ä¿å­˜","success"):_e("ä¿å­˜å¤±è´¥","error")}catch(O){console.error("ä¿å­˜ä¼šè¯å¤±è´¥:",O),_e("ä¿å­˜å¤±è´¥: "+(O instanceof Error?O.message:"æœªçŸ¥é”™è¯¯"),"error")}}function ve(O){T.value=O,_.value=!0}function xe(){ve("plugins")}function we(){_e("è®¾ç½®å·²ä¿å­˜","success")}function $e(){M.value=!0}function ie(){_e("ğŸŒ™ è¯¥åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­ï¼Œæ•¬è¯·æœŸå¾…ï¼","info")}function C(O){const te=O.target;if(!(te instanceof HTMLInputElement||te instanceof HTMLTextAreaElement||te.getAttribute("contenteditable")==="true"||te.id==="bubbleTextEditor")&&!R.value&&O.altKey)switch(O.key){case"ArrowLeft":O.preventDefault(),y();break;case"ArrowRight":O.preventDefault(),le();break;case"ArrowUp":if(O.preventDefault(),!o.settings.textStyle.autoFontSize){const ge=o.settings.textStyle.fontSize;o.updateTextStyle({fontSize:ge+1})}break;case"ArrowDown":if(O.preventDefault(),!o.settings.textStyle.autoFontSize){const ge=o.settings.textStyle.fontSize;o.updateTextStyle({fontSize:Math.max(10,ge-1)})}break}}async function J(O){const te=I.value;if(!te||!te.translatedDataURL){console.log(`è‡ªåŠ¨å­—å·è®¾ç½®å˜æ›´: ${O} (ä»…å½±å“ä¸‹æ¬¡ç¿»è¯‘)`);return}const he=te.bubbleStates;if(!he||!Array.isArray(he)||he.length===0){console.log("å½“å‰å›¾ç‰‡æ²¡æœ‰ bubbleStatesï¼Œè·³è¿‡é‡æ¸²æŸ“");return}if(console.log(`è‡ªåŠ¨å­—å·è®¾ç½®å˜æ›´: ${O}ï¼Œå°†é‡æ–°æ¸²æŸ“...`),O){console.log("è‡ªåŠ¨å­—å·å·²å¼€å¯ï¼Œé‡æ–°è®¡ç®—å­—å·å¹¶æ¸²æŸ“...");try{const{apiClient:ge}=await it(async()=>{const{apiClient:ye}=await import("./client.Bht704G-.js");return{apiClient:ye}},__vite__mapDeps([4,5]));let Re="";if(te.cleanImageData){const ye=te.cleanImageData;Re=ye.includes("base64,")?ye.split("base64,")[1]||"":ye}else te.originalDataURL&&(Re=te.originalDataURL.includes("base64,")?te.originalDataURL.split("base64,")[1]||"":te.originalDataURL);if(!Re){console.log("æ²¡æœ‰å¯ç”¨çš„èƒŒæ™¯å›¾ï¼Œè·³è¿‡é‡æ¸²æŸ“");return}const Ee=he.map(ye=>({translatedText:ye.translatedText||"",coords:ye.coords,fontSize:ye.fontSize||o.settings.textStyle.fontSize,fontFamily:ye.fontFamily||o.settings.textStyle.fontFamily,textDirection:Ut(ye),textColor:ye.textColor||o.settings.textStyle.textColor,rotationAngle:ye.rotationAngle||0,position:ye.position||{x:0,y:0},strokeEnabled:ye.strokeEnabled??o.settings.textStyle.strokeEnabled,strokeColor:ye.strokeColor||o.settings.textStyle.strokeColor,strokeWidth:ye.strokeWidth??o.settings.textStyle.strokeWidth})),Fe=Ee.map(ye=>ye.translatedText),ke=Ee.map(ye=>ye.coords),Be=await ge.post("/api/re_render_image",{clean_image:Re,bubble_texts:Fe,bubble_coords:ke,fontSize:o.settings.textStyle.fontSize,fontFamily:o.settings.textStyle.fontFamily,textDirection:o.settings.textStyle.layoutDirection==="auto"?"vertical":o.settings.textStyle.layoutDirection,textColor:o.settings.textStyle.textColor,bubble_states:Ee,use_individual_styles:!0,use_inpainting:!1,use_lama:!1,fillColor:null,is_font_style_change:!0,autoFontSize:!0,strokeEnabled:o.settings.textStyle.strokeEnabled,strokeColor:o.settings.textStyle.strokeColor,strokeWidth:o.settings.textStyle.strokeWidth});if(Be.rendered_image){if(Be.bubble_states&&Array.isArray(Be.bubble_states)){const ye=he.map((lt,Ge)=>({...lt,fontSize:Be.bubble_states[Ge]?.fontSize??lt.fontSize}));s.updateCurrentImage({translatedDataURL:`data:image/png;base64,${Be.rendered_image}`,bubbleStates:ye,hasUnsavedChanges:!0}),u.setBubbles(ye)}else s.updateCurrentImage({translatedDataURL:`data:image/png;base64,${Be.rendered_image}`,hasUnsavedChanges:!0});console.log("è‡ªåŠ¨å­—å·æ¸²æŸ“æˆåŠŸ")}else Be.error&&(console.error("è‡ªåŠ¨å­—å·æ¸²æŸ“å¤±è´¥:",Be.error),_e("é‡æ–°æ¸²æŸ“å¤±è´¥: "+Be.error,"error"))}catch(ge){console.error("è‡ªåŠ¨å­—å·æ¸²æŸ“å‡ºé”™:",ge)}}else{const ge=o.settings.textStyle.fontSize;console.log(`è‡ªåŠ¨å­—å·å·²å…³é—­ï¼Œä½¿ç”¨å›ºå®šå­—å· ${ge} æ¸²æŸ“...`);const Re=he.map(Ee=>({...Ee,fontSize:ge}));s.updateCurrentImage({bubbleStates:Re}),u.setBubbles(Re),await fe("fontSize",ge)}}async function fe(O,te){const he=I.value;if(!he||!he.translatedDataURL||!he.bubbleStates||he.bubbleStates.length===0||!["fontSize","fontFamily","layoutDirection","textColor","strokeEnabled","strokeColor","strokeWidth","fillColor"].includes(O))return;console.log(`å…¨å±€è®¾ç½®å˜æ›´ (${O}=${te})ï¼Œå‡†å¤‡é‡æ¸²æŸ“...`);const Ee={fontSize:"fontSize",fontFamily:"fontFamily",layoutDirection:"textDirection",textColor:"textColor",strokeEnabled:"strokeEnabled",strokeColor:"strokeColor",strokeWidth:"strokeWidth",fillColor:"fillColor"}[O];if(Ee&&he.bubbleStates)if(O==="layoutDirection")if(te==="auto"){console.log("æ’ç‰ˆæ–¹å‘è®¾ç½®ä¸º 'auto'ï¼Œä» autoTextDirection æ¢å¤æ¯ä¸ªæ°”æ³¡çš„æ’ç‰ˆæ–¹å‘");const Fe=he.bubbleStates.map(ke=>({...ke,textDirection:ke.autoTextDirection==="vertical"||ke.autoTextDirection==="horizontal"?ke.autoTextDirection:"vertical"}));s.updateCurrentImage({bubbleStates:Fe}),u.setBubbles(Fe)}else{console.log(`æ’ç‰ˆæ–¹å‘è®¾ç½®ä¸º '${te}'ï¼Œåº”ç”¨åˆ°æ‰€æœ‰æ°”æ³¡`);const Fe=he.bubbleStates.map(ke=>({...ke,textDirection:te}));s.updateCurrentImage({bubbleStates:Fe}),u.setBubbles(Fe)}else{const Fe=he.bubbleStates.map(ke=>({...ke,[Ee]:te}));s.updateCurrentImage({bubbleStates:Fe}),u.setBubbles(Fe)}try{const ke=s.currentImage?.bubbleStates||he.bubbleStates||[];if(ke.length===0||!ke[0]?.coords){console.log("æ²¡æœ‰æœ‰æ•ˆçš„æ°”æ³¡åæ ‡ï¼Œè·³è¿‡é‡æ¸²æŸ“");return}const Be=o.settings.textStyle.layoutDirection,ye=ke.map(U=>({translatedText:U.translatedText||"",coords:U.coords,fontSize:U.fontSize||o.settings.textStyle.fontSize,fontFamily:U.fontFamily||o.settings.textStyle.fontFamily,textDirection:Ut(U),textColor:U.textColor||o.settings.textStyle.textColor,rotationAngle:U.rotationAngle||0,position:U.position||{x:0,y:0},strokeEnabled:U.strokeEnabled??o.settings.textStyle.strokeEnabled,strokeColor:U.strokeColor||o.settings.textStyle.strokeColor,strokeWidth:U.strokeWidth??o.settings.textStyle.strokeWidth})),lt=ye.map(U=>U.translatedText),Ge=ye.map(U=>U.coords);let Ze="";if(he.cleanImageData){const U=he.cleanImageData;Ze=U.includes("base64,")?U.split("base64,")[1]||"":U}else he.originalDataURL&&(Ze=he.originalDataURL.includes("base64,")?he.originalDataURL.split("base64,")[1]||"":he.originalDataURL,console.log("handleTextStyleChanged: ä½¿ç”¨åŸå›¾ä½œä¸ºèƒŒæ™¯ï¼ˆå…œåº•ï¼‰"));if(!Ze){console.log("æ²¡æœ‰å¯ç”¨çš„èƒŒæ™¯å›¾ï¼Œè·³è¿‡é‡æ¸²æŸ“");return}const{apiClient:nt}=await it(async()=>{const{apiClient:U}=await import("./client.Bht704G-.js");return{apiClient:U}},__vite__mapDeps([4,5])),Ae=await nt.post("/api/re_render_image",{clean_image:Ze,bubble_texts:lt,bubble_coords:Ge,fontSize:o.settings.textStyle.fontSize,fontFamily:o.settings.textStyle.fontFamily,textDirection:Be==="auto"?"vertical":Be,textColor:o.settings.textStyle.textColor,bubble_states:ye,use_individual_styles:!0,use_inpainting:!1,use_lama:!1,fillColor:null,is_font_style_change:!0,strokeEnabled:o.settings.textStyle.strokeEnabled,strokeColor:o.settings.textStyle.strokeColor,strokeWidth:o.settings.textStyle.strokeWidth});Ae.rendered_image?(s.updateCurrentImage({translatedDataURL:`data:image/png;base64,${Ae.rendered_image}`,hasUnsavedChanges:!0}),console.log("è®¾ç½®å˜æ›´åé‡æ–°æ¸²æŸ“æˆåŠŸ")):Ae.error&&console.error("é‡æ–°æ¸²æŸ“å¤±è´¥:",Ae.error)}catch(Fe){console.error("è®¾ç½®å˜æ›´åé‡æ–°æ¸²æŸ“å¤±è´¥:",Fe)}}function be(O){p.switchImage(O)}return(O,te)=>{const he=Ts("router-link");return A(),L("div",{class:Ie(["translate-page",{"edit-mode-active":R.value}])},[e("header",Ix,[e("div",Px,[e("div",Rx,[Ce(he,{to:"/",title:"è¿”å›ä¹¦æ¶"},{default:St(()=>[...te[3]||(te[3]=[e("img",{src:"/pic/logo.png",alt:"Saber-Translator Logo",class:"app-logo"},null,-1),e("span",{class:"app-name"},"Saber-Translator",-1)])]),_:1})]),e("div",Dx,[Ce(he,{to:"/",class:"back-to-shelf",title:"è¿”å›ä¹¦æ¶"},{default:St(()=>[...te[4]||(te[4]=[me("ğŸ“š",-1)])]),_:1}),F.value?(A(),L("button",{key:0,class:"save-header-btn",title:"ä¿å­˜è¿›åº¦",onClick:de}," ğŸ’¾ ")):ce("",!0),e("button",{id:"openSettingsBtn",class:"settings-header-btn",title:"æ‰“å¼€è®¾ç½®",onClick:te[0]||(te[0]=ge=>ve())},[...te[5]||(te[5]=[e("span",{class:"icon"},"âš™ï¸",-1),e("span",null,"è®¾ç½®",-1)])]),te[8]||(te[8]=e("a",{href:"http://www.mashirosaber.top",target:"_blank",class:"tutorial-link"},"ä½¿ç”¨æ•™ç¨‹",-1)),e("a",{href:"javascript:void(0)",class:"donate-link",onClick:$e},[...te[6]||(te[6]=[e("span",null,"â¤ï¸ è¯·ä½œè€…å–å¥¶èŒ¶",-1)])]),te[9]||(te[9]=e("a",{href:"https://github.com/MashiroSaber03",target:"_blank",class:"github-link"},[e("img",{src:"/pic/github.jpg",alt:"GitHub",class:"github-icon"})],-1)),e("button",{class:"theme-toggle",title:"åŠŸèƒ½å¼€å‘ä¸­",onClick:ie},[...te[7]||(te[7]=[e("span",{class:"theme-icon"},"â˜€ï¸",-1)])])])])]),e("div",Mx,[Ce(Al,{onTranslateCurrent:se,onTranslateAll:S,onTranslateRange:f,onHqTranslate:i,onHqTranslateRange:x,onProofread:P,onProofreadRange:h,onRemoveText:d,onRemoveAllText:g,onRemoveTextRange:D,onRetryFailed:ee,onDeleteCurrent:Y,onClearAll:Z,onCleanTemp:r,onOpenPlugins:xe,onOpenSettings:ve,onPrevious:y,onNext:le,onApplyToAll:W,onTextStyleChanged:fe,onAutoFontSizeChanged:J}),e("main",Ex,[e("section",Bx,[e("div",Ax,[Ce(_a,{ref:"imageUploadRef",onUploadComplete:Q},null,512)]),K(l).loadingProgress.total>0?(A(),ut(ko,{key:0,visible:!0,percentage:K(l).loadingProgress.current/K(l).loadingProgress.total*100,label:K(l).loadingProgress.message},null,8,["percentage","label"])):ce("",!0),Ce(vr,{progress:K(m).progress.value},null,8,["progress"]),H.value&&F.value?(A(),L("div",Lx,[...te[10]||(te[10]=[e("span",{style:{color:"#888","font-size":"0.85em"}}," ï¼ˆä¹¦æ¶æ¨¡å¼ä¸‹é€€å‡ºå‰è¯·ç‚¹å‡»é¡¶éƒ¨ä¿å­˜æŒ‰é’®ï¼‰ ",-1)])])):ce("",!0)]),Ce(si,{ref:"imageResultRef","is-edit-mode":R.value,onToggleEditMode:B,onRetryFailed:ee},null,8,["is-edit-mode"])]),E.value&&!R.value?(A(),ut(qr,{key:0,onSelect:be})):ce("",!0)]),I.value&&R.value?(A(),ut(Wf,{key:0,"is-edit-mode-active":R.value,onExit:B},null,8,["is-edit-mode-active"])):ce("",!0),Ce(ui,{onOpenSettings:ve}),Ce(Rm,{modelValue:_.value,"onUpdate:modelValue":te[1]||(te[1]=ge=>_.value=ge),"initial-tab":T.value,onSave:we},null,8,["modelValue","initial-tab"]),M.value?(A(),ut(br,{key:1,onClose:te[2]||(te[2]=ge=>M.value=!1)})):ce("",!0),Ce(Tx),Ce(hx)],2)}}}),jx=He(Fx,[["__scopeId","data-v-c419aa19"]]);export{jx as default};
