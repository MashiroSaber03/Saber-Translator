const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["js/system.cK6ld5_8.js","js/index.BmBTKZbD.js","js/vue-vendor.DIYfje1l.js","assets/index.BYanE9pL.css","js/client.Bht704G-.js","js/utils-vendor.B9ygI19o.js"])))=>i.map(i=>d[i]);
import{D as gn,b as go,c as po,d as mo,e as pn,f as ht,a as lt,S as No,_ as qe,g as Le,s as he,u as rt,h as rs,i as us,j as cs,k as Vo,l as Wo,m as Ko,n as qo,B as Ho,o as jo,p as ds,F as lo,q as Jo,r as Yo,t as gs,L as Xo,W as ps}from"./index.BmBTKZbD.js";import{d as Kt,r as h,c as J,a as He,e as U,h as de,f as e,t as ne,i as tt,k as E,g as st,n as De,u as pe,o as ut,v as ae,x as Ue,l as Ce,s as Go,m as _t,K as et,D as H,F as Ae,j as Je,M as vo,N as ms,L as mn,w as Se,B as gt,O as kt,z as ke,p as ot,P as uo,b as At,Q as Ct,S as Zo,A as vn,U as vs,T as fn,C as fs}from"./vue-vendor.DIYfje1l.js";import{p as bs,a as hs,b as ys,c as xs,d as _s,e as Cs,f as Ss,h as ks,i as ws,j as $s,k as fo,l as bn}from"./system.cK6ld5_8.js";import{getFontList as hn,uploadFont as Ts,getTextboxPrompts as Is,getPrompts as Ds,configApi as We,getFontListApi as Rs}from"./config.CwRcCkM9.js";import{_ as Ne}from"./CustomSelect.vue_vue_type_style_index_0_lang.BbTiIb--.js";import{apiClient as Ye}from"./client.Bht704G-.js";import{B as yn}from"./BaseModal.0UCq3rpf.js";import{getBookDetail as Ps}from"./bookshelf.B4ums9uK.js";import"./utils-vendor.B9ygI19o.js";function Qo(){return{firecrawl:{apiKey:""},agent:{provider:"openai",apiKey:"",customBaseUrl:"",modelName:"gpt-4o-mini",useStream:!1,forceJsonOutput:!0,maxRetries:3,timeout:120},extraction:{prompt:gn,maxIterations:10},download:{concurrency:3,timeout:30,retries:3,delay:100,useReferer:!0},imagePreprocess:{enabled:!1,autoRotate:!0,compression:{enabled:!1,quality:85,maxWidth:0,maxHeight:0},formatConvert:{enabled:!1,targetFormat:"original"}},advanced:{customCookie:"",customHeaders:"",bypassProxy:!1},ui:{showAgentLogs:!0,autoImport:!1}}}function Ms(s,t){function n(y){s.value.firecrawl.apiKey=y,t()}function o(y){s.value.agent.provider=y,t()}function i(y){s.value.agent.apiKey=y,t()}function r(y){s.value.agent.customBaseUrl=y,t()}function l(y){s.value.agent.modelName=y,t()}function u(y){s.value.agent.useStream=y,t()}function b(y){s.value.agent.forceJsonOutput=y,t()}function P(y){s.value.agent.timeout=y,t()}function C(y){s.value.extraction.prompt=y,t()}function B(y){s.value.extraction.maxIterations=y,t()}function O(){s.value.extraction.prompt=gn,t()}function D(y){s.value.download.concurrency=y,t()}function M(y){s.value.download.timeout=y,t()}function w(y){s.value.download.retries=y,t()}function V(y){s.value.download.delay=y,t()}function q(y){s.value.download.useReferer=y,t()}function N(y){s.value.imagePreprocess.enabled=y,t()}function m(y){s.value.imagePreprocess.autoRotate=y,t()}function d(y){s.value.imagePreprocess.compression.enabled=y,t()}function S(y){s.value.imagePreprocess.compression.quality=y,t()}function x(y){s.value.imagePreprocess.compression.maxWidth=y,t()}function K(y){s.value.imagePreprocess.compression.maxHeight=y,t()}function G(y){s.value.imagePreprocess.formatConvert.enabled=y,t()}function ie(y){s.value.imagePreprocess.formatConvert.targetFormat=y,t()}function Z(y){s.value.advanced.customCookie=y,t()}function le(y){s.value.advanced.customHeaders=y,t()}function Q(y){s.value.advanced.bypassProxy=y,t()}function T(y){s.value.ui.showAgentLogs=y,t()}function k(y){s.value.ui.autoImport=y,t()}function F(y){s.value={...s.value,...y},t()}return{setFirecrawlApiKey:n,setAgentProvider:o,setAgentApiKey:i,setAgentBaseUrl:r,setAgentModelName:l,setAgentUseStream:u,setAgentForceJson:b,setAgentTimeout:P,setExtractionPrompt:C,setExtractionMaxIterations:B,resetExtractionPrompt:O,setDownloadConcurrency:D,setDownloadTimeout:M,setDownloadRetries:w,setDownloadDelay:V,setDownloadUseReferer:q,setImagePreprocessEnabled:N,setImageAutoRotate:m,setImageCompressionEnabled:d,setImageCompressionQuality:S,setImageMaxWidth:x,setImageMaxHeight:K,setImageFormatConvertEnabled:G,setImageTargetFormat:ie,setCustomCookie:Z,setCustomHeaders:le,setBypassProxy:Q,setShowAgentLogs:T,setAutoImport:k,updateWebImportSettings:F}}async function bo(s){return Ye.post("/api/re_render_image",s)}async function Es(s){try{return{success:!0,data:await Ye.post("/api/translate_single_text",s)}}catch(t){return{success:!1,error:t instanceof Error?t.message:"ç¿»è¯‘å¤±è´¥"}}}async function Mt(s){return Ye.post("/api/hq_translate_batch",s)}async function co(s,t,n){return Ye.post("/api/detect_boxes",{image:s,detector_type:t,...n})}async function xn(s,t,n,o){return Ye.post("/api/ocr_single_bubble",{image_data:s,bubble_coords:t,ocr_engine:n,...o})}async function ho(s,t,n){return Ye.post("/api/inpaint_single_bubble",{image_data:s,bubble_coords:t,bubble_angle:n?.bubbleAngle??0,method:n?.method??"lama",lama_model:n?.lamaModel??"lama_mpe",...n?.maskData&&{mask_data:n.maskData}})}const Bs=Object.freeze(Object.defineProperty({__proto__:null,detectBoxes:co,hqTranslateBatch:Mt,inpaintSingleBubble:ho,ocrSingleBubble:xn,reRenderImage:bo,translateSingleText:Es},Symbol.toStringTag,{value:"Module"}));async function _n(s){const t=await Ye.post("/api/sessions/load_by_path",{path:s});return{success:t.success,session:t.session_data,error:t.error}}async function Cn(s,t){return Ye.post("/api/sessions/batch_save/start",{session_path:s,metadata:t})}async function Wt(s,t,n,o){return Ye.post("/api/sessions/batch_save/image",{session_folder:s,image_index:t,image_type:n,image_data:o})}async function Sn(s,t){return Ye.post("/api/sessions/batch_save/complete",{session_folder:s,images_meta:t})}const As=_n,en=Object.freeze(Object.defineProperty({__proto__:null,batchSaveCompleteApi:Sn,batchSaveImageApi:Wt,batchSaveStartApi:Cn,loadSessionByPath:_n,loadSessionByPathApi:As},Symbol.toStringTag,{value:"Module"}));async function Ls(){return Ye.get("/api/plugins")}async function Fs(s){const t=encodeURIComponent(s);return Ye.post(`/api/plugins/${t}/enable`)}async function Us(s){const t=encodeURIComponent(s);return Ye.post(`/api/plugins/${t}/disable`)}async function Os(s){const t=encodeURIComponent(s);return Ye.delete(`/api/plugins/${t}`)}async function zs(s){const t=encodeURIComponent(s);return Ye.get(`/api/plugins/${t}/config_schema`)}async function Ns(s){const t=encodeURIComponent(s);return Ye.get(`/api/plugins/${t}/config`)}async function Vs(s,t){const n=encodeURIComponent(s);return Ye.post(`/api/plugins/${n}/config`,t)}async function Ws(){return Ye.get("/api/plugins/default_states")}async function Ks(s,t){const n=encodeURIComponent(s);return Ye.post(`/api/plugins/${n}/set_default_state`,{enabled:t})}async function qs(){return{states:(await Ws()).default_states}}const Hs=Ks,js=zs,Js=Ns,Ys=Vs;function Xs(){return`img_${Date.now()}_${Math.random().toString(36).substring(2,9)}`}function tn(s,t,n){return{id:Xs(),fileName:s,originalDataURL:t,translatedDataURL:null,cleanImageData:null,bubbleStates:null,translationStatus:"pending",translationFailed:!1,fontSize:25,autoFontSize:!1,fontFamily:ht,layoutDirection:"auto",textColor:"#000000",fillColor:pn,inpaintMethod:"solid",strokeEnabled:mo,strokeColor:po,strokeWidth:go,hasUnsavedChanges:!1,...n}}const Xe=Kt("image",()=>{const s=h([]),t=h(-1),n=h(!1),o=J(()=>t.value>=0&&t.value<s.value.length?s.value[t.value]??null:null),i=J(()=>s.value.length),r=J(()=>s.value.length>0),l=J(()=>t.value>0),u=J(()=>t.value<s.value.length-1),b=J(()=>s.value.filter(y=>y.translationFailed).length),P=J(()=>s.value.filter(y=>y.translationStatus==="completed").length),C=J(()=>s.value.filter(y=>y.translationStatus==="pending").length);function B(y,p,a){const v=tn(y,p,a);return s.value.push(v),s.value.length===1&&(t.value=0),console.log(`å›¾ç‰‡å·²æ·»åŠ : ${y}ï¼Œå½“å‰å…± ${s.value.length} å¼ å›¾ç‰‡`),v}function O(y){const p=y.map(({fileName:v,originalDataURL:A,overrides:_})=>tn(v,A,_)),a=s.value.length===0;return s.value.push(...p),a&&s.value.length>0&&(t.value=0),console.log(`æ‰¹é‡æ·»åŠ äº† ${p.length} å¼ å›¾ç‰‡ï¼Œå½“å‰å…± ${s.value.length} å¼ `),p}function D(y){s.value=y.map(p=>({...p,strokeEnabled:p.strokeEnabled??mo,strokeColor:p.strokeColor||po,strokeWidth:p.strokeWidth??go,hasUnsavedChanges:p.hasUnsavedChanges||!1})),s.value.length>0?t.value=Math.min(Math.max(0,t.value),s.value.length-1):t.value=-1,console.log(`å›¾ç‰‡æ•°ç»„å·²è®¾ç½®ï¼Œå…± ${s.value.length} å¼ å›¾ç‰‡`)}function M(y){return y<0||y>=s.value.length?(console.warn(`åˆ é™¤å¤±è´¥: æ— æ•ˆçš„ç´¢å¼• ${y}`),!1):(s.value.splice(y,1),t.value===y?(t.value=Math.min(y,s.value.length-1),s.value.length===0&&(t.value=-1)):t.value>y&&t.value--,console.log(`å›¾ç‰‡å·²åˆ é™¤ï¼Œå½“å‰å…± ${s.value.length} å¼ å›¾ç‰‡`),!0)}function w(){return M(t.value)}function V(){s.value=[],t.value=-1,n.value=!1,console.log("æ‰€æœ‰å›¾ç‰‡å·²æ¸…é™¤")}function q(){const y=o.value?.id||null;if(s.value.sort((p,a)=>p.fileName.localeCompare(a.fileName,void 0,{numeric:!0,sensitivity:"base"})),y){const p=s.value.findIndex(a=>a.id===y);p>=0&&p!==t.value&&(console.log(`å›¾ç‰‡æ’åº: currentImageIndex ä» ${t.value} æ›´æ–°ä¸º ${p}`),t.value=p)}console.log("å›¾ç‰‡å·²æŒ‰æ–‡ä»¶åæ’åº")}function N(y){y>=-1&&y<s.value.length?(t.value=y,console.log(`å½“å‰å›¾ç‰‡ç´¢å¼•å·²è®¾ç½®ä¸º ${y}`)):console.warn(`è®¾ç½®ç´¢å¼•å¤±è´¥: æ— æ•ˆçš„ç´¢å¼• ${y}`)}function m(){return l.value?(t.value--,!0):!1}function d(){return u.value?(t.value++,!0):!1}function S(y){o.value?(Object.assign(o.value,y),console.log("å½“å‰å›¾ç‰‡å±æ€§å·²æ›´æ–°:",Object.keys(y))):console.warn("æ›´æ–°å¤±è´¥: å½“å‰æ²¡æœ‰é€‰ä¸­çš„å›¾ç‰‡")}function x(y,p){if(y>=0&&y<s.value.length){const a=s.value[y];a&&(Object.assign(a,p),console.log(`å›¾ç‰‡ ${y} å±æ€§å·²æ›´æ–°:`,Object.keys(p)))}else console.warn(`æ›´æ–°å¤±è´¥: æ— æ•ˆçš„ç´¢å¼• ${y}`)}function K(y){o.value&&(o.value.bubbleStates=y,o.value.hasUnsavedChanges=!0,console.log(`å½“å‰å›¾ç‰‡æ°”æ³¡çŠ¶æ€å·²æ›´æ–°ï¼Œå…± ${y?.length??0} ä¸ªæ°”æ³¡`))}function G(y){o.value&&(o.value.isManuallyAnnotated=y,o.value.hasUnsavedChanges=!0,console.log(`æ‰‹åŠ¨æ ‡æ³¨æ ‡è®°å·²è®¾ç½®ä¸º: ${y}`))}function ie(y,p){o.value?(o.value[y]=p,o.value.hasUnsavedChanges=!0,console.log(`å½“å‰å›¾ç‰‡å±æ€§ ${String(y)} å·²æ›´æ–°`)):console.warn("æ›´æ–°å¤±è´¥: å½“å‰æ²¡æœ‰é€‰ä¸­çš„å›¾ç‰‡")}function Z(y,p){o.value&&(o.value.translatedDataURL=y,p&&(o.value.cleanImageData=p),o.value.translationStatus="completed",o.value.translationFailed=!1,o.value.hasUnsavedChanges=!0,console.log("å½“å‰å›¾ç‰‡ç¿»è¯‘ç»“æœå·²æ›´æ–°"))}function le(y,p,a){if(y>=0&&y<s.value.length){const v=s.value[y];v&&(v.translationStatus=p,v.translationFailed=p==="failed",a&&(v.errorMessage=a),console.log(`å›¾ç‰‡ ${y} ç¿»è¯‘çŠ¶æ€: ${p}`))}}function Q(y){o.value&&(o.value.translationStatus="failed",o.value.translationFailed=!0,o.value.errorMessage=y,console.log(`å½“å‰å›¾ç‰‡ç¿»è¯‘å¤±è´¥: ${y}`))}function T(){s.value.forEach(y=>{y.translationStatus="pending",y.translationFailed=!1,y.errorMessage=void 0}),console.log("æ‰€æœ‰å›¾ç‰‡ç¿»è¯‘çŠ¶æ€å·²é‡ç½®")}function k(y){n.value=y,console.log(`æ‰¹é‡ç¿»è¯‘çŠ¶æ€: ${y?"è¿›è¡Œä¸­":"å·²å®Œæˆ"}`)}function F(){return s.value.map((y,p)=>y.translationFailed?p:-1).filter(y=>y!==-1)}return{images:s,currentImageIndex:t,isBatchTranslationInProgress:n,currentImage:o,imageCount:i,hasImages:r,canGoPrevious:l,canGoNext:u,failedImageCount:b,completedImageCount:P,pendingImageCount:C,addImage:B,addImages:O,setImages:D,deleteImage:M,deleteCurrentImage:w,clearImages:V,sortImagesByFileName:q,setCurrentImageIndex:N,goToPrevious:m,goToNext:d,updateCurrentImage:S,updateImageByIndex:x,updateCurrentBubbleStates:K,setManuallyAnnotated:G,updateCurrentImageProperty:ie,updateCurrentTranslationResult:Z,setTranslationStatus:le,markCurrentAsFailed:Q,resetAllTranslationStatus:T,setBatchTranslationInProgress:k,getFailedImageIndices:F}}),on=Object.freeze(Object.defineProperty({__proto__:null,useImageStore:Xe},Symbol.toStringTag,{value:"Module"})),qt=Kt("session",()=>{const s=h(null),t=h({bookId:null,chapterId:null,bookTitle:null,chapterTitle:null}),n=h([]),o=h(!1),i=h({current:0,total:0,message:""}),r=h(null),l=h(!1),u=J(()=>t.value.bookId!==null&&t.value.chapterId!==null),b=J(()=>t.value.bookId),P=J(()=>t.value.chapterId);function C(T,k,F=null,y=null){t.value={bookId:T,chapterId:k,bookTitle:F,chapterTitle:y},console.log(`ä¼šè¯ä¸Šä¸‹æ–‡å·²è®¾ç½®: ä¹¦ç±=${T}, ç« èŠ‚=${k}`)}function B(T,k,F,y){C(T,k,F,y)}function O(){t.value={bookId:null,chapterId:null,bookTitle:null,chapterTitle:null},console.log("ä¼šè¯ä¸Šä¸‹æ–‡å·²æ¸…é™¤")}function D(T){const k=T.get("book"),F=T.get("chapter");k&&F&&C(k,F)}function M(T){s.value=T,console.log(`å½“å‰ä¼šè¯åç§°: ${T}`)}function w(){s.value=null}function V(T){n.value=T,console.log(`ä¼šè¯åˆ—è¡¨å·²æ›´æ–°ï¼Œå…± ${T.length} ä¸ªä¼šè¯`)}function q(T){const k=n.value.findIndex(F=>F.name===T.name);k>=0?n.value[k]=T:n.value.unshift(T)}function N(T){const k=n.value.findIndex(F=>F.name===T);k>=0&&n.value.splice(k,1)}function m(T,k){const F=n.value.find(y=>y.name===T);F&&(F.name=k)}function d(T){o.value=T}function S(T){l.value=T}function x(T){r.value=T}function K(T,k,F,y){return{name:T,version:"2.0",savedAt:new Date().toISOString(),imageCount:k.length,ui_settings:y,images:k.map(p=>({originalDataURL:p.originalDataURL,translatedDataURL:p.translatedDataURL||void 0,cleanImageData:p.cleanImageData||void 0,bubbleStates:p.bubbleStates||void 0,isManuallyAnnotated:p.isManuallyAnnotated||void 0,relativePath:p.relativePath||void 0,folderPath:p.folderPath||void 0,fileName:p.fileName,fontSize:p.fontSize,autoFontSize:p.autoFontSize,fontFamily:p.fontFamily,layoutDirection:p.layoutDirection,useAutoTextColor:p.useAutoTextColor,textColor:p.textColor,fillColor:p.fillColor,inpaintMethod:p.inpaintMethod,strokeEnabled:p.strokeEnabled,strokeColor:p.strokeColor,strokeWidth:p.strokeWidth,translationStatus:p.translationStatus,translationFailed:p.translationFailed})),currentImageIndex:F}}function G(){s.value=null,t.value={bookId:null,chapterId:null,bookTitle:null,chapterTitle:null},n.value=[],o.value=!1,l.value=!1,r.value=null,console.log("ä¼šè¯çŠ¶æ€å·²é‡ç½®")}async function ie(T){if(!T||typeof T!="string")return null;if(T.startsWith("data:"))return T;if(!T.startsWith("/api/"))return null;try{const k=await fetch(T);if(!k.ok)return null;const F=await k.blob();return new Promise(y=>{const p=new FileReader;p.onloadend=()=>y(p.result),p.onerror=()=>y(null),p.readAsDataURL(F)})}catch(k){return console.error(`è½¬æ¢å›¾ç‰‡ URL å¤±è´¥: ${T}`,k),null}}async function Z(T,k){const F=T.length;for(let y=0;y<F;y++){const p=T[y];if(p){if(k&&k(y+1,F),p.originalDataURL&&p.originalDataURL.startsWith("/api/")){const a=await ie(p.originalDataURL);a&&(p.originalDataURL=a)}if(p.translatedDataURL&&p.translatedDataURL.startsWith("/api/")){const a=await ie(p.translatedDataURL);a&&(p.translatedDataURL=a)}if(p.cleanImageData&&p.cleanImageData.startsWith("/api/")){const a=await ie(p.cleanImageData);a&&(p.cleanImageData=a.replace(/^data:image\/\w+;base64,/,""))}}}}async function le(T){d(!0),x(null),i.value={current:0,total:0,message:"æ­£åœ¨åŠ è½½..."};try{const{useImageStore:k}=await lt(async()=>{const{useImageStore:g}=await Promise.resolve().then(()=>on);return{useImageStore:g}},void 0),{useSettingsStore:F}=await lt(async()=>{const{useSettingsStore:g}=await import("./system.cK6ld5_8.js").then(L=>L.s);return{useSettingsStore:g}},__vite__mapDeps([0,1,2,3,4,5])),{useBubbleStore:y}=await lt(async()=>{const{useBubbleStore:g}=await Promise.resolve().then(()=>Jl);return{useBubbleStore:g}},void 0),p=k(),a=F(),v=y(),{loadSessionByPathApi:A}=await lt(async()=>{const{loadSessionByPathApi:g}=await Promise.resolve().then(()=>en);return{loadSessionByPathApi:g}},void 0),_=await A(T);if(!_.success||!_.session)throw new Error(_.error||"åŠ è½½ä¼šè¯å¤±è´¥");const R=_.session;if(R.images&&R.images.length>0){const g=R.images.map((f,se)=>({id:`session-${se}-${Date.now()}`,originalDataURL:f.originalDataURL,translatedDataURL:f.translatedDataURL||null,cleanImageData:f.cleanImageData||null,bubbleStates:f.bubbleStates!==void 0&&f.bubbleStates!==null?f.bubbleStates:null,isManuallyAnnotated:!!f.isManuallyAnnotated,relativePath:f.relativePath||void 0,folderPath:f.folderPath||void 0,fileName:f.fileName||`image-${se+1}.png`,translationStatus:f.translationStatus||"pending",translationFailed:!!f.translationFailed,hasUnsavedChanges:!1,fontSize:f.fontSize||24,autoFontSize:f.autoFontSize??!1,fontFamily:f.fontFamily||"Microsoft YaHei",layoutDirection:f.layoutDirection||"auto",useAutoTextColor:f.useAutoTextColor??void 0,textColor:f.textColor||"#000000",fillColor:f.fillColor||"#FFFFFF",inpaintMethod:f.inpaintMethod||"litelama",strokeEnabled:f.strokeEnabled??!1,strokeColor:f.strokeColor||"#FFFFFF",strokeWidth:f.strokeWidth||2}));g.length>0&&(console.log("æ­£åœ¨åŠ è½½å›¾ç‰‡..."),i.value={current:0,total:g.length,message:"æ­£åœ¨åŠ è½½å›¾ç‰‡..."},await Z(g,(f,se)=>{const $=f/se*100;i.value={current:f,total:se,message:`åŠ è½½å›¾ç‰‡ ${f}/${se}...`},console.log(`åŠ è½½å›¾ç‰‡ ${f}/${se}... (${$.toFixed(0)}%)`)}),i.value={current:g.length,total:g.length,message:"åŠ è½½å®Œæˆ"},console.log("å›¾ç‰‡åŠ è½½å®Œæˆï¼Œå·²è½¬æ¢ä¸º Base64"),setTimeout(()=>{i.value={current:0,total:0,message:""}},500)),p.setImages(g);let L=0;typeof R.currentImageIndex=="number"&&(L=R.currentImageIndex,(L>=g.length||L<0)&&(L=g.length>0?0:-1)),p.setCurrentImageIndex(L);const c=g[L];c&&c.bubbleStates&&c.bubbleStates.length>0?v.setBubbles(c.bubbleStates,!0):v.clearBubblesLocal(),console.log(`æŒ‰è·¯å¾„åŠ è½½ä¼šè¯æˆåŠŸ: ${T}, å…± ${g.length} å¼ å›¾ç‰‡`)}const I=R.ui_settings;if(I){(I.targetLanguage||I.sourceLanguage)&&a.updateSettings({targetLanguage:I.targetLanguage||void 0,sourceLanguage:I.sourceLanguage||void 0});const g=I.useInpaintingMethod,c=["solid","lama_mpe","litelama"].includes(g)?g:a.settings.textStyle.inpaintMethod;a.updateTextStyle({fontSize:I.fontSize||a.settings.textStyle.fontSize,autoFontSize:I.autoFontSize??a.settings.textStyle.autoFontSize,fontFamily:I.fontFamily||a.settings.textStyle.fontFamily,layoutDirection:I.layoutDirection||a.settings.textStyle.layoutDirection,textColor:I.textColor||a.settings.textStyle.textColor,fillColor:I.fillColor||a.settings.textStyle.fillColor,inpaintMethod:c,strokeEnabled:I.strokeEnabled??a.settings.textStyle.strokeEnabled,strokeColor:I.strokeColor||a.settings.textStyle.strokeColor,strokeWidth:I.strokeWidth||a.settings.textStyle.strokeWidth,useAutoTextColor:I.useAutoTextColor??a.settings.textStyle.useAutoTextColor}),console.log("UI è®¾ç½®å·²æ¢å¤")}return M(T),!0}catch(k){const F=k instanceof Error?k.message:"åŠ è½½ä¼šè¯å¤±è´¥";throw x(F),console.error(`æŒ‰è·¯å¾„åŠ è½½ä¼šè¯å¤±è´¥: ${T}`,k),k}finally{d(!1)}}async function Q(T,k){if(!T||!k)return console.log("æœªåœ¨ä¹¦ç±/ç« èŠ‚æ¨¡å¼ï¼Œä¸æ”¯æŒä¿å­˜"),!1;console.log(`ä¿å­˜ç« èŠ‚ä¼šè¯ï¼ˆåˆ†æ‰¹ï¼‰: book=${T}, chapter=${k}`);const{useImageStore:F}=await lt(async()=>{const{useImageStore:_}=await Promise.resolve().then(()=>on);return{useImageStore:_}},void 0),{useSettingsStore:y}=await lt(async()=>{const{useSettingsStore:_}=await import("./system.cK6ld5_8.js").then(R=>R.s);return{useSettingsStore:_}},__vite__mapDeps([0,1,2,3,4,5])),p=F(),a=y(),v=Array.isArray(p.images)?p.images:[];if(!v||v.length===0)return console.log("æ²¡æœ‰å›¾ç‰‡æ•°æ®å¯ä¿å­˜"),!1;const A=`bookshelf/${T}/${k}`;S(!0),x(null),i.value={current:0,total:100,message:"å‡†å¤‡ä¿å­˜..."};try{const{batchSaveStartApi:_,batchSaveImageApi:R,batchSaveCompleteApi:I}=await lt(async()=>{const{batchSaveStartApi:z,batchSaveImageApi:te,batchSaveCompleteApi:oe}=await Promise.resolve().then(()=>en);return{batchSaveStartApi:z,batchSaveImageApi:te,batchSaveCompleteApi:oe}},void 0),g=v.length;v.some(z=>z.originalDataURL&&z.originalDataURL.startsWith("/api/")||z.translatedDataURL&&z.translatedDataURL.startsWith("/api/")||z.cleanImageData&&z.cleanImageData.startsWith("/api/"))&&(console.log("[saveChapterSession] æ£€æµ‹åˆ° /api/ URL æ ¼å¼å›¾ç‰‡ï¼Œå¼€å§‹è½¬æ¢ä¸º Base64..."),i.value={current:2,total:100,message:"è½¬æ¢å›¾ç‰‡æ ¼å¼..."},await Z(v,(z,te)=>{const oe=2+z/te*3;i.value={current:Math.round(oe),total:100,message:`è½¬æ¢å›¾ç‰‡ ${z}/${te}...`}}),console.log("[saveChapterSession] å›¾ç‰‡æ ¼å¼è½¬æ¢å®Œæˆ")),i.value={current:5,total:100,message:"æ”¶é›†å…ƒæ•°æ®..."};const{textStyle:c,targetLanguage:f,sourceLanguage:se}=a.settings,$={targetLanguage:f,sourceLanguage:se,fontSize:c.fontSize,autoFontSize:c.autoFontSize,fontFamily:c.fontFamily,layoutDirection:c.layoutDirection,textColor:c.textColor,useInpaintingMethod:c.inpaintMethod,fillColor:c.fillColor,strokeEnabled:c.strokeEnabled,strokeColor:c.strokeColor,strokeWidth:c.strokeWidth,useAutoTextColor:c.useAutoTextColor},Y=v.map(z=>{const te={};for(const oe of Object.keys(z))oe!=="originalDataURL"&&oe!=="translatedDataURL"&&oe!=="cleanImageData"&&(te[oe]=z[oe]);return te.hasOriginalData=!!z.originalDataURL,te.hasTranslatedData=!!z.translatedDataURL,te.hasCleanData=!!z.cleanImageData,te}),ce={ui_settings:$,images_meta:Y,currentImageIndex:p.currentImageIndex};i.value={current:10,total:100,message:"åˆå§‹åŒ–ä¿å­˜..."};const _e=await _(A,ce);if(!_e.success)throw new Error(_e.error||"åˆå§‹åŒ–ä¿å­˜å¤±è´¥");const we=_e.session_folder;if(!we)throw new Error("æœªè·å–åˆ°ä¼šè¯æ–‡ä»¶å¤¹è·¯å¾„");console.log(`ä¼šè¯æ–‡ä»¶å¤¹: ${we}`);let $e=0,me=0;const j=z=>!!z&&typeof z=="string"&&z.startsWith("data:");for(let z=0;z<g;z++){const te=v[z];if(!te)continue;const oe=10+z/g*80;if(i.value={current:Math.round(oe),total:100,message:`ä¿å­˜å›¾ç‰‡ ${z+1}/${g}...`},j(te.originalDataURL))try{const re=await R(we,z,"original",te.originalDataURL);re.success||(console.error(`ä¿å­˜å›¾ç‰‡ ${z} original å¤±è´¥:`,re.error),me++)}catch(re){console.error(`ä¿å­˜å›¾ç‰‡ ${z} original å‡ºé”™:`,re),me++}if(j(te.translatedDataURL))try{const re=await R(we,z,"translated",te.translatedDataURL);re.success||(console.error(`ä¿å­˜å›¾ç‰‡ ${z} translated å¤±è´¥:`,re.error),me++)}catch(re){console.error(`ä¿å­˜å›¾ç‰‡ ${z} translated å‡ºé”™:`,re),me++}if(te.cleanImageData&&typeof te.cleanImageData=="string"&&!te.cleanImageData.startsWith("/api/"))try{const re=await R(we,z,"clean",te.cleanImageData);re.success||(console.error(`ä¿å­˜å›¾ç‰‡ ${z} clean å¤±è´¥:`,re.error),me++)}catch(re){console.error(`ä¿å­˜å›¾ç‰‡ ${z} clean å‡ºé”™:`,re),me++}$e++}i.value={current:95,total:100,message:"å®Œæˆä¿å­˜..."};const W=await I(we,Y);if(!W.success)throw new Error(W.error||"å®Œæˆä¿å­˜å¤±è´¥");return i.value={current:100,total:100,message:"ä¿å­˜å®Œæˆ"},console.log(`åˆ†æ‰¹ä¿å­˜å®Œæˆ: ${$e} å¼ å›¾ç‰‡, ${me} ä¸ªå¤±è´¥`),setTimeout(()=>{i.value={current:0,total:0,message:""}},1e3),!0}catch(_){const R=_ instanceof Error?_.message:"ä¿å­˜ç« èŠ‚ä¼šè¯å¤±è´¥";return x(R),console.error("åˆ†æ‰¹ä¿å­˜å¤±è´¥:",_),i.value={current:0,total:0,message:""},!1}finally{S(!1)}}return{currentSessionName:s,context:t,sessionList:n,isLoading:o,isSaving:l,error:r,loadingProgress:i,isBookshelfMode:u,currentBookId:b,currentChapterId:P,setContext:C,clearContext:O,parseContextFromUrl:D,setSessionName:M,clearSessionName:w,setSessionList:V,addToSessionList:q,removeFromSessionList:N,renameInSessionList:m,setLoading:d,setSaving:S,setError:x,createSessionData:K,imageUrlToBase64:ie,saveChapterSession:Q,loadSessionByPath:le,setBookChapterContext:B,reset:G}}),Lt={originalText:"",translatedText:"",textboxText:"",coords:[0,0,100,100],polygon:[],fontSize:25,fontFamily:ht,textDirection:"vertical",autoTextDirection:"vertical",textColor:"#000000",fillColor:pn,rotationAngle:0,position:{x:0,y:0},strokeEnabled:mo,strokeColor:po,strokeWidth:go,inpaintMethod:"solid",autoFgColor:null,autoBgColor:null,colorConfidence:0};function Gs(s){return{...{...Lt,...s},coords:s?.coords?[...s.coords]:[...Lt.coords],polygon:s?.polygon?s.polygon.map(n=>[...n]):[],position:s?.position?{...Lt.position,...s.position}:{...Lt.position}}}function Zs(s){const[t,n,o,i]=s,r=Math.abs(o-t);return Math.abs(i-n)>r?"vertical":"horizontal"}function Ft(s){return s.map(t=>({...t,coords:[...t.coords],polygon:t.polygon?t.polygon.map(n=>[...n]):[],position:{...t.position},autoFgColor:t.autoFgColor?[...t.autoFgColor]:null,autoBgColor:t.autoBgColor?[...t.autoBgColor]:null}))}function Qs(s){if(!s||typeof s!="object")return!1;const t=s;if(!Array.isArray(t.coords)||t.coords.length!==4||!t.coords.every(i=>typeof i=="number"&&!isNaN(i))||typeof t.fontSize!="number"||t.fontSize<=0)return!1;const n=["vertical","horizontal","auto"];if(typeof t.textDirection!="string"||!n.includes(t.textDirection))return!1;const o=["solid","lama_mpe","litelama"];return!(typeof t.inpaintMethod!="string"||!o.includes(t.inpaintMethod))}function ea(s){let t=s,n=0,o=0,i=Date.now();const r=()=>t<=0?0:Math.ceil(6e4/t);return{async acquire(){if(t<=0)return;const l=Date.now(),u=r();if(l-i>=6e4&&(i=l,o=0),o>=t){const P=6e4-(l-i);P>0&&await nn(P),i=Date.now(),o=0}const b=l-n;b<u&&await nn(u-b),n=Date.now(),o++},reset(){n=0,o=0,i=Date.now()},getRpm(){return t},setRpm(l){t=l,this.reset()}}}function nn(s){return new Promise(t=>setTimeout(t,s))}function sn(s){const t=s.replace(/\\/g,"/"),n=[],o=/(\d+)/g;let i=0,r;for(;(r=o.exec(t))!==null;){if(r.index>i){const l=t.slice(i,r.index);l&&n.push([!0,l.toLowerCase()])}n.push([!1,parseInt(r[0],10)]),i=o.lastIndex}if(i<t.length){const l=t.slice(i);l&&n.push([!0,l.toLowerCase()])}return n}function ta(s,t){const n=sn(s),o=sn(t),i=Math.min(n.length,o.length);for(let r=0;r<i;r++){const[l,u]=n[r],[b,P]=o[r];if(l!==b)return l?1:-1;if(u<P)return-1;if(u>P)return 1}return n.length-o.length}function oa(s,t=n=>String(n)){return[...s].sort((n,o)=>ta(t(n),t(o)))}const an="webImportDisclaimerAccepted",yo=Kt("webImport",()=>{const s=h(Qo()),t=h("idle"),n=h(""),o=h([]),i=h(null),r=h(new Set),l=h({current:0,total:0}),u=h([]),b=h(null),P=h(!1),C=h(!1),B=h(!1),O=J(()=>t.value==="extracting"),D=J(()=>t.value==="downloading"),M=J(()=>O.value||D.value),w=J(()=>r.value.size),V=J(()=>l.value.total===0?0:Math.round(l.value.current/l.value.total*100));function q(){try{localStorage.setItem(No,JSON.stringify(s.value))}catch(R){console.error("ä¿å­˜ç½‘é¡µå¯¼å…¥è®¾ç½®å¤±è´¥:",R)}}function N(){try{const R=localStorage.getItem(No);if(R){const I=JSON.parse(R);s.value=m(Qo(),I)}}catch(R){console.error("åŠ è½½ç½‘é¡µå¯¼å…¥è®¾ç½®å¤±è´¥:",R)}}function m(R,I){const g={...R};for(const L in I)if(Object.prototype.hasOwnProperty.call(I,L)){const c=I[L],f=R[L];c!==null&&typeof c=="object"&&!Array.isArray(c)&&f!==null&&typeof f=="object"&&!Array.isArray(f)?g[L]=m(f,c):c!==void 0&&(g[L]=c)}return g}function d(){C.value?P.value=!0:B.value=!0}function S(){C.value=!0,B.value=!1,P.value=!0;try{localStorage.setItem(an,"true")}catch(R){console.error("ä¿å­˜å…è´£å£°æ˜çŠ¶æ€å¤±è´¥:",R)}}function x(){B.value=!1}function K(){try{const R=localStorage.getItem(an);C.value=R==="true"}catch(R){console.error("åŠ è½½å…è´£å£°æ˜çŠ¶æ€å¤±è´¥:",R)}}function G(){P.value=!1}function ie(){t.value="idle",n.value="",o.value=[],i.value=null,r.value=new Set,l.value={current:0,total:0},u.value=[],b.value=null}function Z(R){n.value=R}function le(R){o.value.push(R)}function Q(){o.value=[]}function T(R){i.value&&i.value.pages.length>0?(i.value.comicTitle=R.comicTitle,i.value.chapterTitle=R.chapterTitle,i.value.totalPages=R.totalPages,i.value.sourceUrl=R.sourceUrl,i.value.referer=R.referer,i.value.engine=R.engine,i.value.success=R.success,i.value.error=R.error):(i.value=R,R.success&&R.pages&&(r.value=new Set(R.pages.map(I=>I.pageNumber))))}function k(R){r.value.has(R)?r.value.delete(R):r.value.add(R),r.value=new Set(r.value)}function F(){i.value?.pages&&(r.value.size===i.value.pages.length?r.value=new Set:r.value=new Set(i.value.pages.map(R=>R.pageNumber)))}function y(R){t.value=R}function p(R){b.value=R,R&&(t.value="error")}function a(R,I){l.value={current:R,total:I}}function v(R){u.value=R}function A(R){i.value||(i.value={success:!0,comicTitle:"",chapterTitle:"",pages:[],totalPages:0,sourceUrl:n.value,referer:"",engine:"gallery-dl"}),i.value.pages.push(R),i.value.totalPages=i.value.pages.length,r.value.add(R.pageNumber),r.value=new Set(r.value)}const _=Ms(s,q);return N(),K(),{settings:s,status:t,url:n,logs:o,extractResult:i,selectedPages:r,downloadProgress:l,downloadedImages:u,error:b,modalVisible:P,disclaimerAccepted:C,disclaimerVisible:B,isExtracting:O,isDownloading:D,isProcessing:M,selectedCount:w,downloadProgressPercent:V,saveToStorage:q,loadFromStorage:N,openModal:d,closeModal:G,resetState:ie,setUrl:Z,addLog:le,clearLogs:Q,setExtractResult:T,togglePageSelection:k,toggleSelectAll:F,setStatus:y,setError:p,updateDownloadProgress:a,setDownloadedImages:v,addPageIncremental:A,acceptDisclaimer:S,rejectDisclaimer:x,..._}}),na={key:0,class:"translation-progress-bar"},sa={class:"progress-bar-label"},aa={class:"progress-bar"},la=He({__name:"ProgressBar",props:{visible:{type:Boolean,default:!0},percentage:{},label:{default:"è¿›åº¦"}},setup(s){return(t,n)=>s.visible?(E(),U("div",na,[e("div",sa,ne(s.label),1),e("div",aa,[e("div",{class:"progress",style:tt({width:`${s.percentage}%`})},null,4)])])):de("",!0)}}),xo=qe(la,[["__scopeId","data-v-f915cadf"]]),ia={class:"image-upload"},ra={class:"error-text"},ua={key:2,class:"loading-overlay"},ca=He({__name:"ImageUpload",emits:["uploadComplete"],setup(s,{expose:t,emit:n}){const o=n,i=Xe(),r=Le(),l=yo(),u=h(null),b=h(null),P=h(!1),C=h(!1),B=h(""),O=h(0),D=h(""),M=h(!1),w=J(()=>r.settings.pdfProcessingMethod);function V(){u.value?.click()}function q(){l.openModal()}function N(){b.value?.click()}async function m(p){const a=p.target;if(!a.files||a.files.length===0)return;const A=Array.from(a.files).filter(R=>R.type.startsWith("image/"));if(A.length===0){he("æ‰€é€‰æ–‡ä»¶å¤¹ä¸­æ²¡æœ‰æ‰¾åˆ°å›¾ç‰‡æ–‡ä»¶","warning"),a.value="";return}const _=oa(A,R=>R.webkitRelativePath);console.log(`ä»æ–‡ä»¶å¤¹å¯¼å…¥ ${_.length} å¼ å›¾ç‰‡`),await d(_),a.value=""}async function d(p){if(p.length!==0){P.value=!0,M.value=!0,O.value=0;try{let a=0;const v=p.length;for(let A=0;A<p.length;A++){const _=p[A];if(!_||!_.type.startsWith("image/"))continue;D.value=_.name;const R=_.webkitRelativePath||"",I=R.includes("/")?R.substring(0,R.lastIndexOf("/")):"";await new Promise((g,L)=>{const c=new FileReader;c.onload=f=>{const se=f.target?.result;i.addImage(_.name,se,{relativePath:R,folderPath:I}),g()},c.onerror=()=>L(new Error(`è¯»å–å›¾ç‰‡å¤±è´¥: ${_.name}`)),c.readAsDataURL(_)}),a++,O.value=Math.round((A+1)/v*100)}a>0&&(he(`å·²æ·»åŠ  ${a} å¼ å›¾ç‰‡`,"success"),o("uploadComplete",a))}catch(a){console.error("å¤„ç†æ–‡ä»¶å¤±è´¥:",a);const v=a instanceof Error?a.message:"å¤„ç†æ–‡ä»¶å¤±è´¥";he(v,"error")}finally{P.value=!1,M.value=!1}}}async function S(p){const a=p.target;!a.files||a.files.length===0||(await ie(Array.from(a.files)),a.value="")}async function x(p){p.preventDefault(),C.value=!1,!(!p.dataTransfer?.files||p.dataTransfer.files.length===0)&&await ie(Array.from(p.dataTransfer.files))}function K(p){p.preventDefault(),C.value=!0}function G(p){const a=p.currentTarget.getBoundingClientRect(),v=p.clientX,A=p.clientY;(v<a.left||v>a.right||A<a.top||A>a.bottom)&&(C.value=!1)}async function ie(p){if(p.length!==0){P.value=!0,B.value="",M.value=!0,O.value=0;try{let a=0;const v=p.length;for(let A=0;A<p.length;A++){const _=p[A];if(!_)continue;D.value=_.name;const R=_.type,I=_.name.toLowerCase();if(R.startsWith("image/"))await Z(_),a++;else if(R==="application/pdf"||I.endsWith(".pdf")){const g=await le(_);a+=g}else if(I.endsWith(".mobi")||I.endsWith(".azw")||I.endsWith(".azw3")){const g=await F(_);a+=g}else console.warn(`ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹: ${_.name}`),he(`ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹: ${_.name}`,"warning");O.value=Math.round((A+1)/v*100)}a>0&&(he(`å·²æ·»åŠ  ${a} å¼ å›¾ç‰‡`,"success"),o("uploadComplete",a))}catch(a){console.error("å¤„ç†æ–‡ä»¶å¤±è´¥:",a);const v=a instanceof Error?a.message:"å¤„ç†æ–‡ä»¶å¤±è´¥ï¼Œè¯·é‡è¯•";B.value=v,he(v,"error")}finally{P.value=!1,M.value=!1,D.value=""}}}async function Z(p){return new Promise((a,v)=>{const A=new FileReader;A.onload=_=>{const R=_.target?.result;i.addImage(p.name,R),a()},A.onerror=()=>v(new Error(`è¯»å–å›¾ç‰‡æ–‡ä»¶å¤±è´¥: ${p.name}`)),A.readAsDataURL(p)})}async function le(p){return w.value==="frontend"?await T(p):await k(p)}function Q(p){return new Promise((a,v)=>{const A=new FileReader;A.onload=()=>a(A.result),A.onerror=v,A.readAsDataURL(p)})}async function T(p){try{const a=await lt(()=>import("./pdf.U7tdldy2.js").then(g=>g.p),[]);a.GlobalWorkerOptions.workerSrc=`https://cdnjs.cloudflare.com/ajax/libs/pdf.js/${a.version}/pdf.worker.min.js`;const v=await p.arrayBuffer(),A=await a.getDocument({data:v}).promise,_=A.numPages;console.log(`PDF ${p.name} å…± ${_} é¡µï¼Œå¼€å§‹æœ¬åœ°æ¸²æŸ“...`),he(`æ­£åœ¨è§£æ PDFï¼Œå…± ${_} é¡µ...`,"info");const R=typeof OffscreenCanvas<"u";R&&console.log("ä½¿ç”¨ OffscreenCanvas åå°æ¸²æŸ“æ¨¡å¼");let I=0;for(let g=1;g<=_;g++){D.value=`${p.name} - ç¬¬ ${g}/${_} é¡µ`,O.value=Math.round(g/_*100);try{const L=await A.getPage(g),f=L.getViewport({scale:2});let se;if(R){const Y=new OffscreenCanvas(f.width,f.height),ce=Y.getContext("2d");await L.render({canvasContext:ce,viewport:f}).promise;const _e=await Y.convertToBlob({type:"image/jpeg",quality:1});se=await Q(_e)}else{const Y=document.createElement("canvas"),ce=Y.getContext("2d");Y.width=f.width,Y.height=f.height,await L.render({canvasContext:ce,viewport:f}).promise,se=Y.toDataURL("image/jpeg",1)}const $=`${p.name}_é¡µé¢${g}`;i.addImage($,se),I++,console.log(`  é¡µé¢ ${g}/${_} å¤„ç†å®Œæˆ`)}catch(L){console.warn(`PDF ${p.name} ç¬¬ ${g} é¡µæ¸²æŸ“å¤±è´¥:`,L)}}return console.log(`PDF ${p.name} å…¨éƒ¨ ${_} é¡µå¤„ç†å®Œæˆ`),I}catch(a){return console.error("å‰ç«¯ PDF è§£æå¤±è´¥:",a),he("å‰ç«¯ PDF è§£æå¤±è´¥ï¼Œå°è¯•ä½¿ç”¨åç«¯è§£æ...","warning"),await k(p)}}async function k(p){let v=null;try{he("æ­£åœ¨ä¸Šä¼  PDF æ–‡ä»¶...","info");const A=await bs(p,5);if(!A.success||!A.session_id)throw new Error(A.error||"PDF è§£æå¯åŠ¨å¤±è´¥");v=A.session_id;const _=A.total_pages||0;console.log(`PDF ${p.name} å…± ${_} é¡µï¼Œå¼€å§‹åç«¯åˆ†æ‰¹è§£æ...`),he(`æ­£åœ¨è§£æ PDFï¼Œå…± ${_} é¡µ...`,"info");let R=0;for(let I=0;I<_;I+=5){D.value=`${p.name} - å¤„ç†ä¸­ ${Math.min(I+5,_)}/${_} é¡µ`,O.value=_>0?Math.round(I/_*100):0;const g=await hs(v,I,5);if(!g.success){console.warn(`æ‰¹æ¬¡ ${I} è·å–å¤±è´¥:`,g.error);continue}if(g.images&&g.images.length>0)for(const L of g.images){if(!L||!L.data_url)continue;const c=`${p.name}_é¡µé¢${String(L.page_index+1).padStart(4,"0")}`;i.addImage(c,L.data_url),R++}console.log(`  å·²åŠ è½½ ${R}/${_} é¡µ`)}return console.log(`PDF ${p.name} å…¨éƒ¨ ${R} é¡µå¤„ç†å®Œæˆ`),R}catch(A){throw console.error("åç«¯ PDF è§£æå¤±è´¥:",A),A}finally{if(v)try{await ys(v)}catch(A){console.warn("PDF ä¼šè¯æ¸…ç†å¤±è´¥:",A)}}}async function F(p){let a=null;try{he("æ­£åœ¨ä¸Šä¼ ç”µå­ä¹¦æ–‡ä»¶...","info");const v=await xs(p,5);if(!v.success||!v.session_id)throw new Error(v.error||"MOBI/AZW è§£æå¯åŠ¨å¤±è´¥");a=v.session_id;const A=v.total_images||0;he(`æ­£åœ¨è§£æç”µå­ä¹¦ï¼Œå…± ${A} å¼ å›¾ç‰‡...`,"info");let _=0,R=!0;for(;R;){D.value=`${p.name} - å·²å¤„ç† ${_}/${A} å¼ `,O.value=A>0?Math.round(_/A*100):0;const I=await _s(a);if(!I.success)throw new Error(I.error||"MOBI/AZW æ‰¹æ¬¡è§£æå¤±è´¥");if(I.images&&I.images.length>0){for(let g=0;g<I.images.length;g++){const L=I.images[g];if(!L)continue;const c=_+g+1,f=`${p.name.replace(/\.(mobi|azw|azw3)$/i,"")}_image_${String(c).padStart(3,"0")}.png`,se=L.startsWith("data:")?L:`data:image/png;base64,${L}`;i.addImage(f,se)}_+=I.images.length}R=I.has_more??!1}return _}catch(v){throw console.error("MOBI/AZW è§£æå¤±è´¥:",v),v}finally{if(a)try{await Cs(a)}catch(v){console.warn("MOBI/AZW ä¼šè¯æ¸…ç†å¤±è´¥:",v)}}}function y(){B.value=""}return t({triggerFileSelect:V,triggerFolderSelect:N,processFiles:ie,clearError:y}),(p,a)=>(E(),U("div",ia,[e("div",{id:"drop-area",class:De(["drop-area",{"drag-over":C.value,loading:P.value}]),onDragover:K,onDragleave:G,onDrop:x},[e("div",{class:"drop-content"},[e("p",{class:"drop-text"},[a[0]||(a[0]=pe(" æ‹–æ‹½å›¾ç‰‡ã€PDFæˆ–MOBIæ–‡ä»¶åˆ°è¿™é‡Œï¼Œæˆ– ",-1)),e("span",{class:"select-link",onClick:V}," é€‰æ‹©æ–‡ä»¶ "),a[1]||(a[1]=e("span",{class:"separator"}," | ",-1)),e("span",{class:"select-link folder-link",onClick:N}," ğŸ“ é€‰æ‹©æ–‡ä»¶å¤¹ "),a[2]||(a[2]=e("span",{class:"separator"}," | ",-1)),e("span",{class:"select-link web-import-link",onClick:q}," ğŸŒ ä»ç½‘é¡µå¯¼å…¥ ")])]),e("input",{ref_key:"fileInputRef",ref:u,type:"file",id:"imageUpload",accept:"image/*,application/pdf,.mobi,.azw,.azw3",multiple:"",class:"file-input",onChange:S},null,544),e("input",{ref_key:"folderInputRef",ref:b,type:"file",webkitdirectory:"",class:"file-input",onChange:m},null,544)],34),M.value?(E(),st(xo,{key:0,visible:!0,percentage:O.value,label:D.value||"å¤„ç†ä¸­..."},null,8,["percentage","label"])):de("",!0),B.value?(E(),U("div",{key:1,class:"error-message",onClick:y},[a[3]||(a[3]=e("span",{class:"error-icon"},"âš ï¸",-1)),e("span",ra,ne(B.value),1),a[4]||(a[4]=e("span",{class:"error-close"},"Ã—",-1))])):de("",!0),P.value&&!M.value?(E(),U("div",ua,[...a[5]||(a[5]=[e("div",{class:"spinner"},null,-1),e("span",{class:"loading-text"},"å¤„ç†ä¸­...",-1)])])):de("",!0)]))}}),da=qe(ca,[["__scopeId","data-v-5ff3dc04"]]),ga={id:"settings-sidebar",class:"settings-sidebar"},pa={class:"card settings-card"},ma={id:"font-settings",class:"settings-card collapsible-panel"},va={class:"toggle-icon"},fa={class:"collapsible-content"},ba={class:"settings-form"},ha={class:"form-group"},ya=["value","disabled","title"],xa={class:"auto-fontSize-option",title:"å‹¾é€‰åï¼Œé¦–æ¬¡ç¿»è¯‘æ—¶è‡ªåŠ¨ä¸ºæ¯ä¸ªæ°”æ³¡è®¡ç®—åˆé€‚çš„å­—å·"},_a=["checked"],Ca={class:"form-group"},Sa={class:"form-group"},ka={class:"form-group"},wa={class:"color-with-auto"},$a={class:"auto-color-toggle",title:"ç¿»è¯‘æ—¶è‡ªåŠ¨ä½¿ç”¨è¯†åˆ«åˆ°çš„æ–‡å­—é¢œè‰²"},Ta=["checked"],Ia=["value","disabled"],Da={key:0,class:"auto-color-hint"},Ra={class:"form-group"},Pa={class:"checkbox-label"},Ma=["checked"],Ea={key:0,id:"strokeOptions",class:"stroke-options"},Ba={class:"form-group"},Aa=["value"],La={class:"form-group"},Fa=["value"],Ua={class:"form-group"},Oa={key:0,id:"solidColorOptions",class:"form-group"},za=["value"],Na={class:"apply-settings-group"},Va=["disabled"],Wa={key:0,class:"apply-options-dropdown"},Ka={class:"apply-option"},qa=["checked"],Ha={class:"apply-option"},ja={class:"apply-option"},Ja={class:"apply-option"},Ya={class:"apply-option"},Xa={class:"apply-option"},Ga={class:"apply-option"},Za={class:"apply-option"},Qa={class:"apply-option"},el={class:"action-buttons"},tl=["disabled"],ol=["disabled"],nl=["disabled"],sl=["disabled"],al=["disabled"],ll=["disabled"],il=["disabled"],rl=["disabled"],ul={class:"navigation-buttons"},cl=["disabled"],dl=["disabled"],gl=He({__name:"SettingsSidebar",emits:["translateCurrent","translateAll","hqTranslate","proofread","removeText","removeAllText","deleteCurrent","clearAll","cleanTemp","openPlugins","openSettings","previous","next","applyToAll","textStyleChanged","autoFontSizeChanged"],setup(s,{emit:t}){const n=t,o=Xe(),i=Le(),r=h(!0),l=h(!1),u=h({fontSize:!0,fontFamily:!0,layoutDirection:!0,textColor:!0,fillColor:!0,strokeEnabled:!0,strokeColor:!0,strokeWidth:!0}),b=[{label:"è‡ªåŠ¨ (æ ¹æ®æ£€æµ‹)",value:"auto"},{label:"ç«–å‘æ’ç‰ˆ",value:"vertical"},{label:"æ¨ªå‘æ’ç‰ˆ",value:"horizontal"}],P=[{label:"çº¯è‰²å¡«å……",value:"solid"},{label:"LAMAä¿®å¤ (é€Ÿåº¦ä¼˜åŒ–)",value:"lama_mpe"},{label:"LAMAä¿®å¤ (é€šç”¨)",value:"litelama"}],C=J(()=>o.currentImage),B=J(()=>o.hasImages),O=J(()=>B.value&&!o.isBatchTranslationInProgress),D=J(()=>o.canGoPrevious),M=J(()=>o.canGoNext),w=J(()=>i.textStyle),V=h([]),q=[ht,"fonts/msyh.ttc","fonts/simhei.ttf","fonts/simsun.ttc"],N=h(null),m=J(()=>{const I=V.value.map(g=>({label:ie(g),value:g}));return I.push({label:"è‡ªå®šä¹‰å­—ä½“...",value:"custom-font"}),I});ut(async()=>{await d();const I=w.value.fontFamily;I&&!V.value.includes(I)&&(V.value=[I,...V.value])});async function d(){try{const I=await hn();if(I.fonts&&Array.isArray(I.fonts)&&I.fonts.length>0){const g=I.fonts[0];if(typeof g=="object"&&"path"in g){const L=I.fonts.map(c=>typeof c=="object"?c.path:c);V.value=L}else V.value=I.fonts}else V.value=[...q]}catch(I){console.error("åŠ è½½å­—ä½“åˆ—è¡¨å¤±è´¥:",I),V.value=[...q]}}function S(){r.value=!r.value}function x(I){const g=parseInt(I.target.value);isNaN(g)||(i.updateTextStyle({fontSize:g}),n("textStyleChanged","fontSize",g))}function K(I){const g=I.target.checked;i.updateTextStyle({autoFontSize:g}),console.log(`è‡ªåŠ¨å­—å·è®¾ç½®å˜æ›´: ${g}`),n("autoFontSizeChanged",g)}async function G(I){const g=I.target,L=g.files?.[0];if(!L)return;const c=[".ttf",".ttc",".otf"],f=L.name.toLowerCase();if(!c.some($=>f.endsWith($))){he("è¯·é€‰æ‹© .ttfã€.ttc æˆ– .otf æ ¼å¼çš„å­—ä½“æ–‡ä»¶","error"),g.value="";return}try{const $=await Ts(L);$.success&&$.fontPath?(await d(),i.updateTextStyle({fontFamily:$.fontPath}),he("å­—ä½“ä¸Šä¼ æˆåŠŸ","success")):he($.error||"å­—ä½“ä¸Šä¼ å¤±è´¥","error")}catch($){console.error("å­—ä½“ä¸Šä¼ å¤±è´¥:",$),he("å­—ä½“ä¸Šä¼ å¤±è´¥","error")}finally{g.value=""}}function ie(I){const g={"fonts/STXINGKA.TTF":"åæ–‡è¡Œæ¥·","fonts/STXINWEI.TTF":"åæ–‡æ–°é­","fonts/STZHONGS.TTF":"åæ–‡ä¸­å®‹","fonts/STKAITI.TTF":"æ¥·ä½“","fonts/STLITI.TTF":"éš¶ä¹¦","fonts/æ€æºé»‘ä½“SourceHanSansK-Bold.TTF":"æ€æºé»‘ä½“","fonts/STSONG.TTF":"åæ–‡å®‹ä½“","fonts/msyh.ttc":"å¾®è½¯é›…é»‘","fonts/msyhbd.ttc":"å¾®è½¯é›…é»‘ç²—ä½“","fonts/SIMYOU.TTF":"å¹¼åœ†","fonts/STFANGSO.TTF":"ä»¿å®‹","fonts/STHUPO.TTF":"åæ–‡ç¥ç€","fonts/STXIHEI.TTF":"åæ–‡ç»†é»‘","fonts/simkai.ttf":"ä¸­æ˜“æ¥·ä½“","fonts/simfang.ttf":"ä¸­æ˜“ä»¿å®‹","fonts/simhei.ttf":"ä¸­æ˜“é»‘ä½“","fonts/SIMLI.TTF":"ä¸­æ˜“éš¶ä¹¦","fonts/simsun.ttc":"å®‹ä½“"};if(g[I])return g[I];const L=I.split("/").pop()||I;for(const[c,f]of Object.entries(g))if((c.split("/").pop()||"").toLowerCase()===L.toLowerCase())return f;return L.replace(/\.(ttf|ttc|otf)$/i,"")}function Z(I){const g=String(I);if(g==="custom-font"){N.value?.click();return}i.updateTextStyle({fontFamily:g}),n("textStyleChanged","fontFamily",g)}function le(I){const g=String(I);i.updateTextStyle({layoutDirection:g}),n("textStyleChanged","layoutDirection",g)}function Q(I){const g=String(I);i.updateTextStyle({inpaintMethod:g})}function T(I){const g=I.target.value;i.updateTextStyle({textColor:g}),n("textStyleChanged","textColor",g)}function k(I){const g=I.target.checked;i.updateTextStyle({useAutoTextColor:g})}function F(I){const g=I.target.checked;i.updateTextStyle({strokeEnabled:g}),n("textStyleChanged","strokeEnabled",g)}function y(I){const g=I.target.value;i.updateTextStyle({strokeColor:g}),n("textStyleChanged","strokeColor",g)}function p(I){const g=parseInt(I.target.value);isNaN(g)||(i.updateTextStyle({strokeWidth:g}),n("textStyleChanged","strokeWidth",g))}function a(I){const g=I.target.value;i.updateTextStyle({fillColor:g}),n("textStyleChanged","fillColor",g)}function v(){l.value=!l.value}function A(){const g=!Object.values(u.value).every(L=>L);u.value={fontSize:g,fontFamily:g,layoutDirection:g,textColor:g,fillColor:g,strokeEnabled:g,strokeColor:g,strokeWidth:g}}function _(){n("applyToAll",{...u.value}),l.value=!1}function R(I){I.target.closest(".apply-settings-group")||(l.value=!1)}return typeof window<"u"&&window.addEventListener("click",R),(I,g)=>(E(),U("aside",ga,[e("div",pa,[g[43]||(g[43]=e("h2",null,"ç¿»è¯‘è®¾ç½®",-1)),e("div",ma,[e("h3",{class:"collapsible-header",onClick:S},[g[20]||(g[20]=pe(" æ–‡å­—è®¾ç½® ",-1)),e("span",va,ne(r.value?"â–¼":"â–¶"),1)]),ae(e("div",fa,[e("div",ba,[e("div",ha,[g[22]||(g[22]=e("label",{for:"fontSize"},"å­—å·å¤§å°:",-1)),e("input",{type:"number",id:"fontSize",value:w.value.fontSize,min:"10",max:"100",disabled:w.value.autoFontSize,class:De({"disabled-input":w.value.autoFontSize}),title:w.value.autoFontSize?"å·²å¯ç”¨è‡ªåŠ¨å­—å·ï¼Œé¦–æ¬¡ç¿»è¯‘æ—¶å°†è‡ªåŠ¨è®¡ç®—":"",onInput:x},null,42,ya),e("span",xa,[e("input",{type:"checkbox",id:"autoFontSize",checked:w.value.autoFontSize,onChange:K},null,40,_a),g[21]||(g[21]=e("label",{for:"autoFontSize"},"è‡ªåŠ¨è®¡ç®—åˆå§‹å­—å·",-1))])]),e("div",Ca,[g[23]||(g[23]=e("label",{for:"fontFamily"},"æ–‡æœ¬å­—ä½“:",-1)),Ce(Ne,{"model-value":w.value.fontFamily,options:m.value,onChange:Z},null,8,["model-value","options"]),e("input",{ref_key:"fontUploadInput",ref:N,type:"file",id:"fontUpload",accept:".ttf,.ttc,.otf",style:{display:"none"},onChange:G},null,544)]),e("div",Sa,[g[24]||(g[24]=e("label",{for:"layoutDirection"},"æ’ç‰ˆè®¾ç½®:",-1)),Ce(Ne,{"model-value":w.value.layoutDirection,options:b,onChange:le},null,8,["model-value"])]),e("div",ka,[g[26]||(g[26]=e("label",{for:"textColor"},"æ–‡å­—é¢œè‰²:",-1)),e("div",wa,[e("label",$a,[e("input",{type:"checkbox",checked:w.value.useAutoTextColor,onChange:k},null,40,Ta),g[25]||(g[25]=e("span",null,"è‡ªåŠ¨",-1))]),e("input",{type:"color",id:"textColor",value:w.value.textColor,disabled:w.value.useAutoTextColor,onInput:T},null,40,Ia)]),w.value.useAutoTextColor?(E(),U("div",Da," ğŸ’¡ ç¿»è¯‘æ—¶å°†è‡ªåŠ¨ä½¿ç”¨è¯†åˆ«åˆ°çš„æ–‡å­—é¢œè‰² ")):de("",!0)]),e("div",Ra,[e("span",Pa,[e("input",{type:"checkbox",id:"strokeEnabled",checked:w.value.strokeEnabled,onChange:F},null,40,Ma),g[27]||(g[27]=e("label",{for:"strokeEnabled"},"å¯ç”¨æ–‡æœ¬æè¾¹:",-1))])]),Ce(Go,{name:"stroke-slide"},{default:_t(()=>[w.value.strokeEnabled?(E(),U("div",Ea,[e("div",Ba,[g[28]||(g[28]=e("label",{for:"strokeColor"},"æè¾¹é¢œè‰²:",-1)),e("input",{type:"color",id:"strokeColor",value:w.value.strokeColor,onInput:y},null,40,Aa)]),e("div",La,[g[29]||(g[29]=e("label",{for:"strokeWidth"},"æè¾¹å®½åº¦ (px):",-1)),e("input",{type:"number",id:"strokeWidth",value:w.value.strokeWidth,min:"0",max:"10",style:{width:"60px",padding:"5px"},onInput:p},null,40,Fa),g[30]||(g[30]=e("div",{class:"input-hint"},"0 è¡¨ç¤ºæ— æè¾¹ã€‚",-1))])])):de("",!0)]),_:1}),e("div",Ua,[g[31]||(g[31]=e("label",{for:"useInpainting"},"æ°”æ³¡å¡«å……æ–¹å¼:",-1)),Ce(Ne,{"model-value":w.value.inpaintMethod,options:P,onChange:Q},null,8,["model-value"])]),Ce(Go,{name:"slide-fade"},{default:_t(()=>[w.value.inpaintMethod==="solid"?(E(),U("div",Oa,[g[32]||(g[32]=e("label",{for:"fillColor"},"å¡«å……é¢œè‰²:",-1)),e("input",{type:"color",id:"fillColor",value:w.value.fillColor,onInput:a},null,40,za)])):de("",!0)]),_:1})]),e("div",Na,[e("button",{type:"button",class:"settings-button",disabled:!B.value,onClick:_}," åº”ç”¨åˆ°å…¨éƒ¨ ",8,Va),e("button",{type:"button",class:"settings-gear-btn",title:"é€‰æ‹©è¦åº”ç”¨çš„å‚æ•°",onClick:v}," âš™ï¸ "),l.value?(E(),U("div",Wa,[e("div",Ka,[e("input",{type:"checkbox",id:"apply_selectAll",checked:Object.values(u.value).every(L=>L),onChange:A},null,40,qa),g[33]||(g[33]=e("label",{for:"apply_selectAll"},"å…¨é€‰",-1))]),g[42]||(g[42]=e("hr",null,null,-1)),e("div",Ha,[ae(e("input",{type:"checkbox",id:"apply_fontSize","onUpdate:modelValue":g[0]||(g[0]=L=>u.value.fontSize=L)},null,512),[[et,u.value.fontSize]]),g[34]||(g[34]=e("label",{for:"apply_fontSize"},"å­—å·",-1))]),e("div",ja,[ae(e("input",{type:"checkbox",id:"apply_fontFamily","onUpdate:modelValue":g[1]||(g[1]=L=>u.value.fontFamily=L)},null,512),[[et,u.value.fontFamily]]),g[35]||(g[35]=e("label",{for:"apply_fontFamily"},"å­—ä½“",-1))]),e("div",Ja,[ae(e("input",{type:"checkbox",id:"apply_layoutDirection","onUpdate:modelValue":g[2]||(g[2]=L=>u.value.layoutDirection=L)},null,512),[[et,u.value.layoutDirection]]),g[36]||(g[36]=e("label",{for:"apply_layoutDirection"},"æ’ç‰ˆæ–¹å‘",-1))]),e("div",Ya,[ae(e("input",{type:"checkbox",id:"apply_textColor","onUpdate:modelValue":g[3]||(g[3]=L=>u.value.textColor=L)},null,512),[[et,u.value.textColor]]),g[37]||(g[37]=e("label",{for:"apply_textColor"},"æ–‡å­—é¢œè‰²",-1))]),e("div",Xa,[ae(e("input",{type:"checkbox",id:"apply_fillColor","onUpdate:modelValue":g[4]||(g[4]=L=>u.value.fillColor=L)},null,512),[[et,u.value.fillColor]]),g[38]||(g[38]=e("label",{for:"apply_fillColor"},"å¡«å……é¢œè‰²",-1))]),e("div",Ga,[ae(e("input",{type:"checkbox",id:"apply_strokeEnabled","onUpdate:modelValue":g[5]||(g[5]=L=>u.value.strokeEnabled=L)},null,512),[[et,u.value.strokeEnabled]]),g[39]||(g[39]=e("label",{for:"apply_strokeEnabled"},"æè¾¹å¼€å…³",-1))]),e("div",Za,[ae(e("input",{type:"checkbox",id:"apply_strokeColor","onUpdate:modelValue":g[6]||(g[6]=L=>u.value.strokeColor=L)},null,512),[[et,u.value.strokeColor]]),g[40]||(g[40]=e("label",{for:"apply_strokeColor"},"æè¾¹é¢œè‰²",-1))]),e("div",Qa,[ae(e("input",{type:"checkbox",id:"apply_strokeWidth","onUpdate:modelValue":g[7]||(g[7]=L=>u.value.strokeWidth=L)},null,512),[[et,u.value.strokeWidth]]),g[41]||(g[41]=e("label",{for:"apply_strokeWidth"},"æè¾¹å®½åº¦",-1))])])):de("",!0)])],512),[[Ue,r.value]])]),e("div",el,[e("button",{id:"translateButton",disabled:!O.value,onClick:g[8]||(g[8]=L=>n("translateCurrent"))}," ç¿»è¯‘å½“å‰å›¾ç‰‡ ",8,tl),e("button",{id:"translateAllButton",disabled:!O.value,onClick:g[9]||(g[9]=L=>n("translateAll"))}," ç¿»è¯‘æ‰€æœ‰å›¾ç‰‡ ",8,ol),e("button",{id:"startHqTranslationBtn",class:"settings-button purple-button",disabled:!O.value,title:"ä½¿ç”¨é«˜è´¨é‡ç¿»è¯‘æ¨¡å¼ï¼ˆéœ€åœ¨è®¾ç½®ä¸­é…ç½®ï¼‰",onClick:g[10]||(g[10]=L=>n("hqTranslate"))}," é«˜è´¨é‡ç¿»è¯‘ ",8,nl),e("button",{id:"proofreadButton",disabled:!O.value,onClick:g[11]||(g[11]=L=>n("proofread"))}," AIæ ¡å¯¹ ",8,sl),e("button",{id:"removeTextOnlyButton",disabled:!C.value,title:"æ¶ˆé™¤å›¾ç‰‡ä¸­çš„æ°”æ³¡æ–‡å­—ï¼Œæ— éœ€å¡«å†™ç¿»è¯‘æœåŠ¡å•†å’ŒAPI Key",onClick:g[12]||(g[12]=L=>n("removeText"))}," ä»…æ¶ˆé™¤æ–‡å­— ",8,al),e("button",{id:"removeAllTextButton",disabled:!B.value,title:"æ¶ˆé™¤æ‰€æœ‰å›¾ç‰‡ä¸­çš„æ°”æ³¡æ–‡å­—ï¼Œæ— éœ€å¡«å†™ç¿»è¯‘æœåŠ¡å•†å’ŒAPI Key",onClick:g[13]||(g[13]=L=>n("removeAllText"))}," æ¶ˆé™¤æ‰€æœ‰å›¾ç‰‡æ–‡å­— ",8,ll),e("button",{id:"deleteCurrentImageButton",class:"settings-button red-button",disabled:!C.value,onClick:g[14]||(g[14]=L=>n("deleteCurrent"))}," åˆ é™¤å½“å‰å›¾ç‰‡ ",8,il),e("button",{id:"clearAllImagesButton",class:"settings-button red-button",disabled:!B.value,onClick:g[15]||(g[15]=L=>n("clearAll"))}," æ¸…é™¤æ‰€æœ‰å›¾ç‰‡ ",8,rl),e("button",{id:"cleanDebugFilesButton",class:"settings-button orange-button",onClick:g[16]||(g[16]=L=>n("cleanTemp"))}," æ¸…ç†ä¸´æ—¶æ–‡ä»¶ "),e("button",{id:"managePluginsButton",class:"settings-button blue-button",onClick:g[17]||(g[17]=L=>n("openPlugins"))}," æ’ä»¶ç®¡ç† ")]),e("div",ul,[e("button",{id:"prevImageButton",disabled:!D.value,onClick:g[18]||(g[18]=L=>n("previous"))}," ä¸Šä¸€å¼  ",8,cl),e("button",{id:"nextImageButton",disabled:!M.value,onClick:g[19]||(g[19]=L=>n("next"))}," ä¸‹ä¸€å¼  ",8,dl)])])]))}}),pl=qe(gl,[["__scopeId","data-v-13df24d8"]]);function wt(s){if(s.textDirection==="vertical"||s.textDirection==="horizontal")return s.textDirection;if(s.autoTextDirection==="vertical"||s.autoTextDirection==="horizontal")return s.autoTextDirection;if(s.coords){const[t,n,o,i]=s.coords;return i-n>o-t?"vertical":"horizontal"}return"vertical"}function ml(){const s=Xe(),t=Le(),n=rt(),o=h(!1),i=h(0),r=h(""),l=h(!1),u=h(0),b=h(""),P=J(()=>s.hasImages),C=J(()=>s.hasImages),B=J(()=>s.hasImages);function O(){const m=s.images;if(m.length===0){n.warning("æ²¡æœ‰å¯å¯¼å‡ºçš„å›¾ç‰‡æ–‡æœ¬");return}const d=[];for(let le=0;le<m.length;le++){const Q=m[le];if(!Q)continue;const T=Q.bubbleStates||[],k={imageIndex:le,bubbles:[]};for(let F=0;F<T.length;F++){const y=T[F];if(!y)continue;const p=y.originalText||"",a=y.translatedText||y.textboxText||"";let v="vertical";y.textDirection&&y.textDirection!=="auto"?v=y.textDirection:y.autoTextDirection&&(v=y.autoTextDirection),k.bubbles.push({bubbleIndex:F,original:p,translated:a,textDirection:v})}d.push(k)}const S=JSON.stringify(d,null,2),x=new Blob([S],{type:"application/json"}),K=URL.createObjectURL(x),G=document.createElement("a");G.href=K;const Z=new Date().toISOString().replace(/[-:T]/g,"").slice(0,15);G.download=`translations_${Z}.json`,document.body.appendChild(G),G.click(),document.body.removeChild(G),URL.revokeObjectURL(K),n.success("æ–‡æœ¬å¯¼å‡ºæˆåŠŸï¼")}function D(){const m=s.images;if(m.length===0)return null;const d=[];for(let S=0;S<m.length;S++){const x=m[S];if(!x)continue;const K=x.bubbleStates||[],G={imageIndex:S,bubbles:[]};for(let ie=0;ie<K.length;ie++){const Z=K[ie];if(!Z)continue;const le=Z.originalText||"",Q=Z.translatedText||Z.textboxText||"";let T="vertical";Z.textDirection&&Z.textDirection!=="auto"?T=Z.textDirection:Z.autoTextDirection&&(T=Z.autoTextDirection),G.bubbles.push({bubbleIndex:ie,original:le,translated:Q,textDirection:T})}d.push(G)}return d}async function M(m){if(!m){n.warning("æœªé€‰æ‹©æ–‡ä»¶");return}l.value=!0,u.value=0,b.value="å‡†å¤‡å¯¼å…¥æ–‡æœ¬...",n.info("æ­£åœ¨å¯¼å…¥æ–‡æœ¬...",0);try{const d=await w(m);u.value=10,b.value="è§£æ JSON æ•°æ®...";const S=JSON.parse(d);if(!Array.isArray(S))throw new Error("å¯¼å…¥çš„ JSON æ ¼å¼ä¸æ­£ç¡®ï¼Œåº”ä¸ºæ•°ç»„");let x=0,K=0;const G=t.settings.textStyle,ie=G.autoFontSize?"auto":G.fontSize,Z=G.fontFamily,le=G.textColor,Q=G.fillColor;u.value=20,b.value="å¼€å§‹æ›´æ–°å›¾ç‰‡...";const T=S.length;let k=0;const F=[];for(const a of S){k++;const v=20+k/T*60;u.value=v,b.value=`å¤„ç†å›¾ç‰‡ ${k}/${T}`;const A=a.imageIndex;if(A<0||A>=s.images.length){console.warn(`è·³è¿‡æ— æ•ˆçš„å›¾ç‰‡ç´¢å¼•: ${A}`);continue}const _=s.images[A];if(!_)continue;let R=!1;_.bubbleStates||(_.bubbleStates=[]),_.bubbleTexts||(_.bubbleTexts=[]),_.originalTexts||(_.originalTexts=[]);for(const I of a.bubbles){const g=I.bubbleIndex,L=I.original,c=I.translated,f=I.textDirection,se=f==="vertical"||f==="horizontal"?f:"vertical";for(;_.bubbleTexts.length<=g;)_.bubbleTexts.push("");for(;_.originalTexts.length<=g;)_.originalTexts.push("");for(L&&(_.originalTexts[g]=L),c&&(_.bubbleTexts[g]=c);_.bubbleStates.length<=g;)_.bubbleStates.push(V(ie,Z,le,Q));const $=_.bubbleStates[g];$&&(L&&($.originalText=L),c&&($.translatedText=c,$.textboxText=c),$.textDirection=se,R=!0,K++)}R&&_.bubbleStates&&(_.bubbleTexts=_.bubbleStates.map(I=>I.translatedText||"")),R&&(x++,_.hasUnsavedChanges=!0,_.translatedDataURL&&_.bubbleStates&&_.bubbleStates.length>0&&F.push(A))}if(F.length>0){u.value=80,b.value="å¼€å§‹æ¸²æŸ“å›¾ç‰‡...",n.info("æ­£åœ¨æ¸²æŸ“å›¾ç‰‡ï¼Œè¯·ç¨å€™...",0);const a=t.settings.textStyle,v=a.layoutDirection,A=v==="auto";for(let _=0;_<F.length;_++){const R=F[_];if(R===void 0)continue;const I=s.images[R];if(!(!I||!I.bubbleStates)){u.value=80+_/F.length*20,b.value=`æ¸²æŸ“å›¾ç‰‡ ${_+1}/${F.length}`;try{let g="";if(I.cleanImageData?g=I.cleanImageData.includes("base64,")?I.cleanImageData.split("base64,")[1]||"":I.cleanImageData:I.originalDataURL&&(g=I.originalDataURL.includes("base64,")?I.originalDataURL.split("base64,")[1]||"":I.originalDataURL,console.log(`importText: å›¾ç‰‡ ${R} ä½¿ç”¨åŸå›¾ä½œä¸ºèƒŒæ™¯ï¼ˆå…œåº•ï¼‰`)),!g){console.log(`importText: å›¾ç‰‡ ${R} æ²¡æœ‰å¯ç”¨çš„èƒŒæ™¯å›¾ï¼Œè·³è¿‡`);continue}const L=I.bubbleStates.map(f=>({translatedText:f.translatedText||"",coords:f.coords,fontSize:f.fontSize||a.fontSize,fontFamily:f.fontFamily||a.fontFamily,textDirection:wt(f),textColor:f.textColor||a.textColor,rotationAngle:f.rotationAngle||0,position:f.position||{x:0,y:0},strokeEnabled:f.strokeEnabled??a.strokeEnabled,strokeColor:f.strokeColor||a.strokeColor,strokeWidth:f.strokeWidth??a.strokeWidth})),c=await bo({clean_image:g,bubble_texts:L.map(f=>f.translatedText),bubble_coords:L.map(f=>f.coords),fontSize:a.fontSize,fontFamily:a.fontFamily,textDirection:A?"vertical":v,textColor:a.textColor,bubble_states:L,use_individual_styles:!0,use_inpainting:!1,use_lama:!1,is_font_style_change:!0,strokeEnabled:a.strokeEnabled,strokeColor:a.strokeColor,strokeWidth:a.strokeWidth});c.rendered_image&&(s.updateImageByIndex(R,{translatedDataURL:`data:image/png;base64,${c.rendered_image}`,hasUnsavedChanges:!0}),console.log(`importText: å›¾ç‰‡ ${R} æ¸²æŸ“æˆåŠŸ`))}catch(g){console.error(`importText: é‡æ¸²æŸ“å›¾ç‰‡ ${R} å¤±è´¥:`,g)}}}}u.value=100,b.value="å¯¼å…¥å®Œæˆ";const y=F.length,p=y>0?`å¯¼å…¥æˆåŠŸï¼æ›´æ–°äº† ${x} å¼ å›¾ç‰‡ä¸­çš„ ${K} ä¸ªæ°”æ³¡æ–‡æœ¬ï¼Œé‡æ¸²æŸ“äº† ${y} å¼ å›¾ç‰‡`:`å¯¼å…¥æˆåŠŸï¼æ›´æ–°äº† ${x} å¼ å›¾ç‰‡ä¸­çš„ ${K} ä¸ªæ°”æ³¡æ–‡æœ¬`;n.success(p)}catch(d){console.error("å¯¼å…¥æ–‡æœ¬å‡ºé”™:",d),n.error(`å¯¼å…¥å¤±è´¥: ${d instanceof Error?d.message:String(d)}`)}finally{l.value=!1,setTimeout(()=>{u.value=0,b.value=""},2e3)}}function w(m){return new Promise((d,S)=>{const x=new FileReader;x.onload=K=>{K.target?.result?d(K.target.result):S(new Error("è¯»å–æ–‡ä»¶å¤±è´¥"))},x.onerror=()=>S(new Error("è¯»å–æ–‡ä»¶æ—¶å‡ºé”™")),x.readAsText(m)})}function V(m,d,S,x){const K=t.settings.textStyle;return{coords:[0,0,100,100],polygon:[],originalText:"",translatedText:"",textboxText:"",fontSize:typeof m=="number"?m:25,fontFamily:d,textDirection:"vertical",autoTextDirection:"vertical",textColor:S,fillColor:x,rotationAngle:0,position:{x:0,y:0},strokeEnabled:K.strokeEnabled,strokeColor:K.strokeColor,strokeWidth:K.strokeWidth,inpaintMethod:K.inpaintMethod}}function q(){const m=s.currentImage;if(!m){n.warning("æ²¡æœ‰å¯ä¸‹è½½çš„å›¾ç‰‡");return}const d=m.translatedDataURL||m.originalDataURL;if(!d){n.warning("æ²¡æœ‰å¯ä¸‹è½½çš„å›¾ç‰‡");return}o.value=!0;try{const S=d.split(",")[1];if(!S)throw new Error("æ— æ•ˆçš„å›¾ç‰‡æ•°æ®");const x=atob(S),K=[];for(let T=0;T<x.length;T+=512){const k=x.slice(T,T+512),F=new Array(k.length);for(let p=0;p<k.length;p++)F[p]=k.charCodeAt(p);const y=new Uint8Array(F);K.push(y.buffer)}const G=new Blob(K,{type:"image/png"}),ie=URL.createObjectURL(G),Z=document.createElement("a");Z.href=ie;let le=m.fileName||`image_${s.currentImageIndex}.png`;le=`${m.translatedDataURL?"translated":"original"}_${le.replace(/\.[^/.]+$/,"")}.png`,Z.download=le,document.body.appendChild(Z),Z.click(),document.body.removeChild(Z),URL.revokeObjectURL(ie),n.success(`ä¸‹è½½æˆåŠŸ: ${le}`)}catch(S){console.error("ä¸‹è½½å›¾ç‰‡æ—¶å‡ºé”™:",S),n.error("ä¸‹è½½å¤±è´¥")}finally{o.value=!1}}async function N(m="zip"){const d=s.images;if(d.length===0){n.warning("æ²¡æœ‰å¯ä¸‹è½½çš„å›¾ç‰‡");return}o.value=!0,i.value=0,r.value="å‡†å¤‡ä¸‹è½½...",n.info("ä¸‹è½½ä¸­...å¤„ç†å¯èƒ½éœ€è¦ä¸€å®šæ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…...",0);try{const S=[];let x=0,K=0;i.value=5,r.value="æ£€æŸ¥å›¾ç‰‡æ•°æ®...";for(let p=0;p<d.length;p++){const a=d[p];a&&(a.translatedDataURL?(S.push({index:p,type:"translated"}),x++):a.originalDataURL&&(S.push({index:p,type:"original"}),K++))}if(S.length===0){n.warning("æ²¡æœ‰å¯ä¸‹è½½çš„å›¾ç‰‡");return}i.value=10,r.value="åˆ›å»ºä¸‹è½½ä¼šè¯...";const G=await Ss(S.length);if(!G.success||!G.session_id)throw new Error(G.error||"åˆ›å»ºä¼šè¯å¤±è´¥");const ie=G.session_id,Z=S.length;let le=0,Q=0;for(let p=0;p<S.length;p++){const a=S[p];if(!a)continue;const v=d[a.index];if(!v)continue;const A=a.type==="translated"?v.translatedDataURL:v.originalDataURL;if(!A)continue;const _=10+p/Z*70;i.value=_,r.value=`ä¸Šä¼ å›¾ç‰‡ ${p+1}/${Z}...`;try{const R=await ks(ie,A,p);R.success?le++:(console.error(`ä¸Šä¼ å›¾ç‰‡ ${p} å¤±è´¥:`,R.error),Q++)}catch(R){console.error(`ä¸Šä¼ å›¾ç‰‡ ${p} å‡ºé”™:`,R),Q++}}if(le===0)throw new Error("æ‰€æœ‰å›¾ç‰‡ä¸Šä¼ å¤±è´¥");i.value=85,r.value="æ‰“åŒ…æ–‡ä»¶...";const T=await ws(ie,m);if(!T.success||!T.file_id)throw new Error(T.error||"æ‰“åŒ…å¤±è´¥");i.value=95,r.value="å‡†å¤‡ä¸‹è½½...";const k=$s(T.file_id,m),F=document.createElement("a");F.href=k,document.body.appendChild(F),F.click(),document.body.removeChild(F),i.value=100,r.value="ä¸‹è½½å·²å¼€å§‹";let y=`å·²æˆåŠŸå¤„ç† ${le} å¼ å›¾ç‰‡`;Q>0&&(y+=`ï¼ˆ${Q} å¼ å¤±è´¥ï¼‰`),x>0&&K>0?y+=`ï¼ˆ${x} å¼ ç¿»è¯‘å›¾ç‰‡å’Œ ${K} å¼ åŸå§‹å›¾ç‰‡ï¼‰`:x>0?y+="ï¼ˆå…¨éƒ¨ä¸ºç¿»è¯‘åå›¾ç‰‡ï¼‰":K>0&&(y+="ï¼ˆå…¨éƒ¨ä¸ºåŸå§‹å›¾ç‰‡ï¼‰"),y+="ï¼Œä¸‹è½½å³å°†å¼€å§‹",n.success(y),setTimeout(async()=>{try{const p=await fo();console.log("ä¸´æ—¶æ–‡ä»¶æ¸…ç†ç»“æœ:",p)}catch(p){console.error("æ¸…ç†ä¸´æ—¶æ–‡ä»¶å¤±è´¥:",p)}},6e4)}catch(S){console.error("ä¸‹è½½æ‰€æœ‰å›¾ç‰‡æ—¶å‡ºé”™:",S),n.error(`ä¸‹è½½å¤±è´¥: ${S instanceof Error?S.message:String(S)}`)}finally{o.value=!1,setTimeout(()=>{i.value=0,r.value=""},2e3)}}return{isDownloading:o,downloadProgress:i,downloadProgressText:r,isImporting:l,importProgress:u,importProgressText:b,canExportText:P,canImportText:C,canDownload:B,exportText:O,exportTextToJson:D,importText:M,downloadCurrentImage:q,downloadAllImages:N}}const vl={key:0,class:"result-section card result-card"},fl={class:"image-controls"},bl={class:"image-size-control"},hl=["value"],yl={id:"imageSizeValue"},xl={class:"content-container"},_l={class:"image-container"},Cl=["src"],Sl={id:"detectedTextInfo",class:"text-info"},kl={id:"detectedTextList"},wl={class:"original-text"},$l={class:"download-section"},Tl={class:"download-buttons"},Il=["disabled"],Dl={class:"download-all-container"},Rl=["disabled"],Pl={class:"download-format-selector"},Ml=["disabled"],El=["disabled"],Bl={key:1,class:"empty-state-section"},io=60,Al=He({__name:"ImageResultDisplay",props:{isEditMode:{type:Boolean,default:!1}},emits:["toggle-edit-mode","retry-failed"],setup(s,{emit:t}){const n=[{label:"ZIPå‹ç¼©åŒ…",value:"zip"},{label:"PDFæ–‡æ¡£",value:"pdf"},{label:"CBZæ¼«ç”»",value:"cbz"}],o=t,i=Xe(),r=Le(),l=ml(),u=h(100),b=J({get:()=>w.value?.showOriginal??!1,set:_=>{w.value&&i.updateCurrentImage({showOriginal:_})}}),P=h("zip"),C=h(null),B=J(()=>l.isDownloading.value),O=J(()=>l.downloadProgressText.value),D=J(()=>l.downloadProgress.value),M=J(()=>i.hasImages),w=J(()=>i.currentImage),V=J(()=>!!w.value?.translatedDataURL),q=J(()=>!!(w.value?.translatedDataURL||w.value?.originalDataURL)),N=J(()=>w.value?b.value||!w.value.translatedDataURL?w.value.originalDataURL:w.value.translatedDataURL:""),m=J(()=>i.failedImageCount>0),d=J(()=>({width:`${u.value}%`})),S=J(()=>r.settings.useTextboxPrompt),x=J(()=>{if(!w.value)return[];if(w.value.bubbleStates&&w.value.bubbleStates.length>0)return w.value.bubbleStates.map(I=>({original:I.originalText||"",translated:S.value?I.textboxText||I.translatedText||"":I.translatedText||""}));const _=w.value.originalTexts||[],R=S.value?w.value.textboxTexts||w.value.bubbleTexts||[]:w.value.bubbleTexts||[];return _.length===0?[]:_.map((I,g)=>({original:I||"",translated:R[g]||""}))}),K=J(()=>x.value.length>0);function G(_){if(!_||_.length<=io)return _;let R="",I="";for(let g=0;g<_.length;g++)if(I+=_[g],I.length>=io){let L=-1;for(let c=I.length-1;c>=0;c--){const f=I[c];if(f&&["ã€‚","ï¼","ï¼Ÿ",".","!","?","ï¼›",";","ï¼Œ",","].includes(f)){L=c+1;break}}L>io*.6?(R+=I.substring(0,L)+`
`,I=I.substring(L)):(R+=I+`
`,I="")}return I&&(R+=I),R}function ie(_){return G((_||"").trim())}function Z(_){const R=(_||"").trim();return G(R)}function le(_){return(_||"").includes("ç¿»è¯‘å¤±è´¥")}function Q(){b.value=!b.value}function T(){o("toggle-edit-mode")}function k(_){const R=_.target;u.value=parseInt(R.value,10)}function F(){o("retry-failed")}function y(){l.downloadCurrentImage()}function p(){l.downloadAllImages(P.value)}function a(){l.exportText()}function v(){C.value?.click()}async function A(_){const R=_.target,I=R.files?.[0];I&&(await l.importText(I),R.value="")}return(_,R)=>w.value?(E(),U("section",vl,[e("div",fl,[V.value?(E(),U("button",{key:0,id:"toggleImageButton",class:"control-btn",onClick:Q},ne(b.value?"æŸ¥çœ‹ç¿»è¯‘å›¾":"æŸ¥çœ‹åŸå›¾"),1)):de("",!0),e("button",{id:"toggleEditModeButton",class:De(["control-btn",{active:s.isEditMode}]),onClick:T},ne(s.isEditMode?"é€€å‡ºç¼–è¾‘":"åˆ‡æ¢ç¼–è¾‘æ¨¡å¼"),3),e("div",bl,[R[1]||(R[1]=e("label",{for:"imageSize"},"å›¾ç‰‡å¤§å°:",-1)),e("input",{type:"range",id:"imageSize",min:"50",max:"200",value:u.value,class:"slider range-slider",onInput:k},null,40,hl),e("span",yl,ne(u.value)+"%",1)]),m.value?(E(),U("button",{key:1,id:"retranslateFailedButton",class:"retry-failed-btn",onClick:F,title:"é‡æ–°ç¿»è¯‘æ‰€æœ‰å¤±è´¥çš„å›¾ç‰‡"}," é‡æ–°ç¿»è¯‘å¤±è´¥å›¾ç‰‡ ("+ne(H(i).failedImageCount)+") ",1)):de("",!0)]),e("div",xl,[e("div",_l,[e("img",{id:"translatedImageDisplay",src:N.value,alt:"ç¿»è¯‘åå›¾ç‰‡",style:tt(d.value)},null,12,Cl)])]),e("div",Sl,[R[6]||(R[6]=e("h3",null,"æ£€æµ‹åˆ°çš„æ–‡æœ¬ï¼ˆåŸæ–‡ â†’ è¯‘æ–‡ï¼‰",-1)),e("pre",kl,[K.value?(E(!0),U(Ae,{key:0},Je(x.value,(I,g)=>(E(),U("span",{key:g,class:"text-item"},[e("span",wl,ne(ie(I.original)),1),R[2]||(R[2]=pe(`
`,-1)),e("span",{class:De(["translated-text",{"translation-error":le(I.translated)}])},ne(Z(I.translated)),3),R[3]||(R[3]=pe(`
`,-1)),R[4]||(R[4]=e("span",{class:"separator"},"â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€",-1)),R[5]||(R[5]=pe(`

`,-1))]))),128)):(E(),U(Ae,{key:1},[pe("æœªæ£€æµ‹åˆ°æ–‡æœ¬æˆ–å°šæœªç¿»è¯‘")],64))])]),e("div",$l,[B.value?(E(),st(xo,{key:0,visible:!0,percentage:D.value,label:O.value||"ä¸‹è½½ä¸­ï¼Œè¯·ç¨å€™..."},null,8,["percentage","label"])):de("",!0),e("div",Tl,[e("button",{id:"downloadButton",class:"download-btn primary",disabled:!q.value,onClick:y}," ä¸‹è½½å½“å‰å›¾ç‰‡ ",8,Il),e("div",Dl,[e("button",{id:"downloadAllImagesButton",class:"download-btn primary",disabled:!M.value,onClick:p}," ä¸‹è½½æ‰€æœ‰å›¾ç‰‡ ",8,Rl),e("div",Pl,[Ce(Ne,{modelValue:P.value,"onUpdate:modelValue":R[0]||(R[0]=I=>P.value=I),options:n},null,8,["modelValue"])])]),e("button",{id:"exportTextButton",class:"download-btn success",disabled:!M.value,onClick:a}," å¯¼å‡ºæ–‡æœ¬ ",8,Ml),e("button",{id:"importTextButton",class:"download-btn success",disabled:!M.value,onClick:v}," å¯¼å…¥æ–‡æœ¬ ",8,El),e("input",{type:"file",ref_key:"importFileInput",ref:C,id:"importTextFileInput",style:{display:"none"},accept:".json",onChange:A},null,544)])])])):(E(),U("section",Bl))}}),Ll=qe(Al,[["__scopeId","data-v-a26b9c58"]]),Fl={class:"guide-content"},Ul={class:"guide-footer"},Ol={class:"dont-show-option"},Ut="saber_translator_dismiss_setup_reminder",zl=He({__name:"FirstTimeGuide",emits:["openSettings"],setup(s,{expose:t,emit:n}){const o=n,i=h(!1),r=h(!1);ut(()=>{localStorage.getItem(Ut)!=="true"&&(i.value=!0)});function l(){r.value&&localStorage.setItem(Ut,"true"),i.value=!1}function u(){localStorage.setItem(Ut,"true"),i.value=!1,o("openSettings")}function b(){localStorage.removeItem(Ut)}return t({resetGuideState:b,showGuide:i}),(P,C)=>(E(),st(yn,{"model-value":i.value,title:"æ¬¢è¿ä½¿ç”¨ Saber-Translator",onClose:l},{default:_t(()=>[e("div",Fl,[C[3]||(C[3]=e("div",{class:"guide-icon"},"ğŸ‰",-1)),C[4]||(C[4]=e("div",{class:"guide-message"},[e("p",{class:"guide-title"},"é¦–æ¬¡ä½¿ç”¨æé†’"),e("p",{class:"guide-text"}," åœ¨å¼€å§‹ç¿»è¯‘ä¹‹å‰ï¼Œè¯·å…ˆé…ç½®ç¿»è¯‘æœåŠ¡ã€‚ "),e("p",{class:"guide-text"},[pe(" ç‚¹å‡»å³ä¸Šè§’çš„ "),e("span",{class:"highlight"},"âš™ï¸ è®¾ç½®"),pe(" æŒ‰é’®ï¼Œé…ç½®ä»¥ä¸‹å†…å®¹ï¼š ")]),e("ul",{class:"guide-list"},[e("li",null,"é€‰æ‹© OCR å¼•æ“ï¼ˆæ–‡å­—è¯†åˆ«ï¼‰"),e("li",null,"é…ç½®ç¿»è¯‘æœåŠ¡å•†å’Œ API Key"),e("li",null,"ï¼ˆå¯é€‰ï¼‰é…ç½®é«˜è´¨é‡ç¿»è¯‘å’Œ AI æ ¡å¯¹")])],-1)),e("div",{class:"guide-actions"},[e("button",{class:"guide-btn primary",onClick:u},[...C[1]||(C[1]=[e("span",{class:"btn-icon"},"âš™ï¸",-1),pe(" ç«‹å³é…ç½® ",-1)])]),e("button",{class:"guide-btn secondary",onClick:l}," ç¨åé…ç½® ")]),e("div",Ul,[e("label",Ol,[ae(e("input",{type:"checkbox","onUpdate:modelValue":C[0]||(C[0]=B=>r.value=B)},null,512),[[et,r.value]]),C[2]||(C[2]=e("span",null,"ä¸å†æ˜¾ç¤ºæ­¤æé†’",-1))])])])]),_:1},8,["model-value"]))}}),Nl=qe(zl,[["__scopeId","data-v-eda18e4a"]]),ro="saber_translator_dismiss_setup_reminder",Vl=["siliconflow","deepseek","volcano","caiyun","baidu_translate","youdao_translate","gemini","custom_openai"],Wl={manga_ocr:"MangaOCR",paddle_ocr:"PaddleOCR",baidu_ocr:"ç™¾åº¦OCR",ai_vision:"AIè§†è§‰OCR"},Kl=["ollama","sakura"],ql=["custom_openai"],Hl=["custom_openai"],jl={siliconflow:"SiliconFlow",deepseek:"DeepSeek",volcano:"ç«å±±å¼•æ“",caiyun:"å½©äº‘å°è¯‘",baidu_translate:"ç™¾åº¦ç¿»è¯‘",youdao_translate:"æœ‰é“ç¿»è¯‘",gemini:"Google Gemini",custom_openai:"è‡ªå®šä¹‰ OpenAI",ollama:"Ollama",sakura:"Sakura"};function kn(){const s=Le(),t=rt(),n=h(!1),o=h(!1),i=J(()=>{try{return localStorage.getItem(ro)==="true"}catch{return!1}});function r(x){return jl[x]||x}function l(x){return Vl.includes(x)}function u(x){return Kl.includes(x)}function b(x){return ql.includes(x)}function P(x){return Hl.includes(x)}function C(x){return Wl[x]||x}function B(){const x=s.settings,K=x.ocrEngine,G=x.baiduOcr,ie=x.aiVisionOcr,Z=[];return K?(K==="baidu_ocr"&&((!G?.apiKey||G.apiKey.trim()==="")&&Z.push("ç™¾åº¦OCR çš„ API Key"),(!G?.secretKey||G.secretKey.trim()==="")&&Z.push("ç™¾åº¦OCR çš„ Secret Key")),K==="ai_vision"&&(ie?.provider||Z.push("AIè§†è§‰OCR çš„æœåŠ¡å•†"),(!ie?.apiKey||ie.apiKey.trim()==="")&&Z.push("AIè§†è§‰OCR çš„ API Key"),(!ie?.modelName||ie.modelName.trim()==="")&&Z.push("AIè§†è§‰OCR çš„æ¨¡å‹åç§°"),ie?.provider==="custom"&&(!ie?.customBaseUrl||ie.customBaseUrl.trim()==="")&&Z.push("AIè§†è§‰OCR çš„è‡ªå®šä¹‰ Base URL")),Z.length>0?{valid:!1,message:`è¯·å…ˆåœ¨é¡¶éƒ¨ âš™ï¸ è®¾ç½®èœå•ä¸­å¡«å†™ ${Z[0]}`,missingItems:Z}:{valid:!0,message:""}):{valid:!1,message:"è¯·å…ˆåœ¨é¡¶éƒ¨ âš™ï¸ è®¾ç½®èœå•ä¸­é€‰æ‹© OCR å¼•æ“",missingItems:["OCR å¼•æ“"]}}function O(){const{translation:x}=s.settings,{provider:K,apiKey:G,modelName:ie,customBaseUrl:Z}=x,le=[];return K?(l(K)&&(!G||G.trim()==="")&&le.push(`${r(K)} çš„ API Key`),(!ie||ie.trim()==="")&&(u(K)||l(K))&&le.push(`${r(K)} çš„æ¨¡å‹åç§°`),b(K)&&(!Z||Z.trim()==="")&&le.push("è‡ªå®šä¹‰ OpenAI æœåŠ¡çš„ Base URL"),le.length>0?{valid:!1,message:`è¯·å…ˆåœ¨é¡¶éƒ¨ âš™ï¸ è®¾ç½®èœå•ä¸­å¡«å†™ ${le[0]}`,missingItems:le}:{valid:!0,message:""}):{valid:!1,message:"è¯·å…ˆåœ¨é¡¶éƒ¨ âš™ï¸ è®¾ç½®èœå•ä¸­é€‰æ‹©ç¿»è¯‘æœåŠ¡å•†",missingItems:["ç¿»è¯‘æœåŠ¡å•†"]}}function D(){const{hqTranslation:x}=s.settings,{provider:K,apiKey:G,modelName:ie,customBaseUrl:Z}=x,le=[];return K?((!G||G.trim()==="")&&le.push("é«˜è´¨é‡ç¿»è¯‘çš„ API Key"),(!ie||ie.trim()==="")&&le.push("é«˜è´¨é‡ç¿»è¯‘çš„æ¨¡å‹åç§°"),P(K)&&(!Z||Z.trim()==="")&&le.push("é«˜è´¨é‡ç¿»è¯‘çš„ Base URL"),le.length>0?{valid:!1,message:`è¯·å…ˆåœ¨é¡¶éƒ¨ âš™ï¸ è®¾ç½®èœå•ä¸­å¡«å†™ ${le[0]}`,missingItems:le}:{valid:!0,message:""}):{valid:!1,message:"è¯·å…ˆåœ¨é¡¶éƒ¨ âš™ï¸ è®¾ç½®èœå•ä¸­é€‰æ‹©é«˜è´¨é‡ç¿»è¯‘çš„æœåŠ¡å•†",missingItems:["é«˜è´¨é‡ç¿»è¯‘æœåŠ¡å•†"]}}function M(x){const K=x||s.settings.proofreading.rounds,G=[];if(!K||K.length===0)return{valid:!1,message:"è¯·å…ˆåœ¨é¡¶éƒ¨ âš™ï¸ è®¾ç½®èœå•ä¸­æ·»åŠ è‡³å°‘ä¸€ä¸ªæ ¡å¯¹è½®æ¬¡",missingItems:["æ ¡å¯¹è½®æ¬¡"]};for(let ie=0;ie<K.length;ie++){const Z=K[ie];if(!Z)continue;const le=Z.name||`è½®æ¬¡${ie+1}`;if(Z.provider||G.push(`æ ¡å¯¹ ${le} çš„æœåŠ¡å•†`),(!Z.apiKey||Z.apiKey.trim()==="")&&G.push(`æ ¡å¯¹ ${le} çš„ API Key`),(!Z.modelName||Z.modelName.trim()==="")&&G.push(`æ ¡å¯¹ ${le} çš„æ¨¡å‹åç§°`),G.length>0)return{valid:!1,message:`è¯·å…ˆåœ¨é¡¶éƒ¨ âš™ï¸ è®¾ç½®èœå•ä¸­ä¸º ${G[0]}`,missingItems:G}}return{valid:!0,message:""}}function w(x="normal",K={}){let G;switch(x){case"normal":G=O();break;case"hq":G=D();break;case"proofread":G=M(K.proofreadingRounds);break;case"ocr":G=B();break;default:G=O()}return G.valid?!0:(t.error(G.message),q(),!1)}function V(){const x=B();if(!x.valid)return t.error(x.message),q(),!1;const K=O();return K.valid?!0:(t.error(K.message),q(),!1)}function q(){const x=document.getElementById("openSettingsBtn");x&&(o.value=!0,x.style.animation="settingsBtnPulse 0.5s ease-in-out 3",x.style.boxShadow="0 0 10px var(--primary-color, #4a90d9)",setTimeout(()=>{x.style.animation="",x.style.boxShadow="",o.value=!1},3e3))}function N(){if(i.value){console.log("ç”¨æˆ·å·²é€‰æ‹©ä¸å†æ˜¾ç¤ºè®¾ç½®æé†’");return}n.value=!0}function m(x=!1){if(x)try{localStorage.setItem(ro,"true"),console.log("ç”¨æˆ·é€‰æ‹©æ°¸ä¹…å…³é—­è®¾ç½®æé†’")}catch(K){console.error("ä¿å­˜è®¾ç½®æé†’çŠ¶æ€å¤±è´¥:",K)}n.value=!1}function d(){try{localStorage.removeItem(ro),console.log("è®¾ç½®æé†’çŠ¶æ€å·²é‡ç½®")}catch(x){console.error("é‡ç½®è®¾ç½®æé†’çŠ¶æ€å¤±è´¥:",x)}}function S(){setTimeout(()=>{N()},500)}return{showSetupReminder:n,isSettingsButtonHighlighted:o,isSetupReminderDismissed:i,validateOcrConfig:B,validateTranslationConfig:O,validateHqTranslationConfig:D,validateProofreadingConfig:M,validateBeforeTranslation:w,validateFullTranslationConfig:V,highlightSettingsButton:q,checkAndShowSetupReminder:N,closeSetupReminder:m,resetSetupReminderDismiss:d,initValidation:S,getProviderDisplayName:r,getOcrEngineDisplayName:C,requiresApiKey:l,isLocalProvider:u,requiresBaseUrl:b}}const ct=Kt("bubble",()=>{const s=h([]),t=h(-1),n=h([]),o=h([]),i=h(!1),r=h(-1),l=h(0),u=h(0),b=h(0),P=h(0),C=h(!1),B=h(-1),O=h(null),D=h(!1),M=h(-1),w=h(0),V=J(()=>t.value>=0&&t.value<s.value.length?s.value[t.value]??null:null),q=J(()=>s.value.length),N=J(()=>s.value.length>0),m=J(()=>t.value>=0),d=J(()=>n.value.length>1),S=J(()=>n.value.filter($=>$>=0&&$<s.value.length).map($=>s.value[$]).filter($=>$!==void 0));function x(){const Y=Xe().currentImage;Y&&(Y.bubbleStates=Ft(s.value),Y.hasUnsavedChanges=!0,console.log("æ°”æ³¡çŠ¶æ€å·²åŒæ­¥åˆ°å½“å‰å›¾ç‰‡"))}function K($,Y=!1){s.value=$,o.value=Ft($),F(),console.log(`æ°”æ³¡æ•°ç»„å·²è®¾ç½®ï¼Œå…± ${$.length} ä¸ªæ°”æ³¡`),Y||x()}function G($,Y){const ce=Zs($),we=Le().settings.textStyle,$e=we.layoutDirection,me=$e==="vertical"||$e==="horizontal"?$e:ce==="vertical"||ce==="horizontal"?ce:"vertical",j=Gs({coords:$,translatedText:"",autoTextDirection:ce,fontSize:we.fontSize,fontFamily:we.fontFamily,textDirection:me,textColor:we.textColor,fillColor:we.fillColor,inpaintMethod:we.inpaintMethod,strokeEnabled:we.strokeEnabled,strokeColor:we.strokeColor,strokeWidth:we.strokeWidth,rotationAngle:0,position:{x:0,y:0},...Y});return s.value.push(j),console.log(`å·²æ·»åŠ æ°”æ³¡ï¼Œå½“å‰å…± ${s.value.length} ä¸ª`),x(),j}function ie($){return $<0||$>=s.value.length?(console.warn(`åˆ é™¤å¤±è´¥: æ— æ•ˆçš„ç´¢å¼• ${$}`),!1):(s.value.splice($,1),t.value===$?t.value=-1:t.value>$&&t.value--,n.value=n.value.filter(Y=>Y!==$).map(Y=>Y>$?Y-1:Y),console.log(`å·²åˆ é™¤æ°”æ³¡ï¼Œå½“å‰å…± ${s.value.length} ä¸ª`),x(),!0)}function Z(){if(n.value.length===0&&t.value<0)return;const $=[...new Set([...n.value,t.value])].filter(Y=>Y>=0).sort((Y,ce)=>ce-Y);for(const Y of $)s.value.splice(Y,1);F(),console.log(`å·²åˆ é™¤ ${$.length} ä¸ªæ°”æ³¡`),x()}function le(){s.value=[],o.value=[],F(),console.log("æ‰€æœ‰æ°”æ³¡å·²æ¸…é™¤"),x()}function Q(){s.value=[],o.value=[],F(),console.log("æœ¬åœ°æ°”æ³¡çŠ¶æ€å·²æ¸…é™¤ï¼ˆä¸åŒæ­¥åˆ°imageStoreï¼‰")}function T($){$>=-1&&$<s.value.length&&(t.value=$,n.value=$>=0?[$]:[],console.log(`å·²é€‰ä¸­æ°”æ³¡ ${$}`))}function k($){if($<0||$>=s.value.length)return;const Y=n.value.indexOf($);Y>=0?(n.value.splice(Y,1),t.value===$&&(t.value=n.value[0]??-1)):(n.value.push($),t.value=$),console.log(`å¤šé€‰çŠ¶æ€: ${n.value.join(", ")}`)}function F(){t.value=-1,n.value=[]}function y(){t.value>=0?n.value=[t.value]:n.value=[]}function p(){if(s.value.length===0)return!1;const $=t.value<s.value.length-1?t.value+1:0;return T($),!0}function a(){if(s.value.length===0)return!1;const $=t.value>0?t.value-1:s.value.length-1;return T($),!0}function v($,Y){if($<0||$>=s.value.length)return console.warn(`æ›´æ–°å¤±è´¥: æ— æ•ˆçš„ç´¢å¼• ${$}`),!1;const ce=s.value[$];return ce?(Object.assign(ce,Y),console.log(`å·²æ›´æ–°æ°”æ³¡ ${$}`),x(),!0):!1}function A($){return t.value<0?(console.warn("æ›´æ–°å¤±è´¥: æ²¡æœ‰é€‰ä¸­çš„æ°”æ³¡"),!1):v(t.value,$)}function _($){const Y=n.value.length>0?n.value:t.value>=0?[t.value]:[];for(const ce of Y){const _e=s.value[ce];_e&&Object.assign(_e,$)}x(),console.log(`å·²æ‰¹é‡æ›´æ–° ${Y.length} ä¸ªæ°”æ³¡`)}function R($){for(let Y=0;Y<s.value.length;Y++){const ce=s.value[Y];ce&&Object.assign(ce,$)}x(),console.log(`å·²æ›´æ–°æ‰€æœ‰ ${s.value.length} ä¸ªæ°”æ³¡`)}function I(){if(s.value.length!==o.value.length)return!0;for(let $=0;$<s.value.length;$++){const Y=s.value[$],ce=o.value[$];if(!(!Y||!ce)&&(Y.translatedText!==ce.translatedText||Y.textboxText!==ce.textboxText||Y.fontSize!==ce.fontSize||Y.fontFamily!==ce.fontFamily||Y.textDirection!==ce.textDirection||Y.textColor!==ce.textColor||Y.fillColor!==ce.fillColor||Y.rotationAngle!==ce.rotationAngle||Y.strokeEnabled!==ce.strokeEnabled||Y.strokeColor!==ce.strokeColor||Y.strokeWidth!==ce.strokeWidth||Y.inpaintMethod!==ce.inpaintMethod||JSON.stringify(Y.coords)!==JSON.stringify(ce.coords)))return!0}return!1}function g(){s.value=Ft(o.value),F(),console.log("æ°”æ³¡çŠ¶æ€å·²é‡ç½®åˆ°åˆå§‹çŠ¶æ€")}function L(){o.value=Ft(s.value),console.log("å½“å‰çŠ¶æ€å·²ä¿å­˜ä¸ºåˆå§‹çŠ¶æ€")}function c(){return{bubble_coords:s.value.map($=>$.coords),bubble_texts:s.value.map($=>$.translatedText),textbox_texts:s.value.map($=>$.textboxText),font_sizes:s.value.map($=>$.fontSize),font_families:s.value.map($=>$.fontFamily),text_directions:s.value.map($=>$.textDirection==="vertical"||$.textDirection==="horizontal"?$.textDirection==="vertical"?"v":"h":$.autoTextDirection==="vertical"||$.autoTextDirection==="horizontal"?$.autoTextDirection==="vertical"?"v":"h":"v"),text_colors:s.value.map($=>$.textColor),fill_colors:s.value.map($=>$.fillColor),rotation_angles:s.value.map($=>$.rotationAngle),stroke_enabled:s.value.map($=>$.strokeEnabled),stroke_colors:s.value.map($=>$.strokeColor),stroke_widths:s.value.map($=>$.strokeWidth),inpaint_methods:s.value.map($=>$.inpaintMethod)}}function f(){return JSON.stringify(s.value)}function se($){try{const Y=JSON.parse($);if(!Array.isArray(Y))return console.error("ååºåˆ—åŒ–å¤±è´¥: æ•°æ®ä¸æ˜¯æ•°ç»„"),!1;const ce=[];for(const _e of Y)Qs(_e)?ce.push(_e):console.warn("è·³è¿‡æ— æ•ˆçš„æ°”æ³¡çŠ¶æ€:",_e);return K(ce),!0}catch(Y){return console.error("ååºåˆ—åŒ–å¤±è´¥:",Y),!1}}return{bubbles:s,selectedIndex:t,selectedIndices:n,initialStates:o,isDragging:i,draggingIndex:r,dragOffsetX:l,dragOffsetY:u,dragInitialX:b,dragInitialY:P,isResizing:C,resizingIndex:B,resizeCurrentCoords:O,isRotating:D,rotatingIndex:M,rotateCurrentAngle:w,selectedBubble:V,bubbleCount:q,hasBubbles:N,hasSelection:m,isMultiSelect:d,selectedBubbles:S,setBubbles:K,addBubble:G,deleteBubble:ie,deleteSelected:Z,clearBubbles:le,clearBubblesLocal:Q,selectBubble:T,toggleMultiSelect:k,clearSelection:F,clearMultiSelect:y,selectNext:p,selectPrevious:a,updateBubble:v,updateSelectedBubble:A,updateAllSelected:_,updateAllBubbles:R,hasChanges:I,resetToInitial:g,saveAsInitial:L,toApiRequest:c,serialize:f,deserialize:se}}),Jl=Object.freeze(Object.defineProperty({__proto__:null,useBubbleStore:ct},Symbol.toStringTag,{value:"Module"}));function Yl(){const s=h({current:0,total:0,completed:0,failed:0,isInProgress:!1,label:"",percentage:0});return{progress:s,reporter:{init(n,o){s.value={current:0,total:n,completed:0,failed:0,isInProgress:!0,label:o||"å‡†å¤‡ä¸­...",percentage:0}},update(n,o){s.value.current=n,o!==void 0&&(s.value.label=o),s.value.total>0&&(s.value.percentage=Math.round(n/s.value.total*100))},setPercentage(n,o){s.value.percentage=Math.min(100,Math.max(0,n)),o!==void 0&&(s.value.label=o)},incrementCompleted(){s.value.completed++},incrementFailed(){s.value.failed++},finish(){s.value.isInProgress=!1,s.value.percentage=100},getProgress(){return{...s.value}}}}}async function wn(s){return Ye.post("/api/parallel/detect",s)}async function $n(s){return Ye.post("/api/parallel/ocr",s)}async function Tn(s){return Ye.post("/api/parallel/color",s)}async function In(s){return Ye.post("/api/parallel/translate",s)}async function Dn(s){return Ye.post("/api/parallel/inpaint",s)}async function Rn(s){return Ye.post("/api/parallel/render",s)}let dt=null,Et=!1;function $t(){const s=qt();return Le().settings.autoSaveInBookshelfMode&&s.isBookshelfMode}function Xl(){const s=qt(),t=s.currentBookId,n=s.currentChapterId;return!t||!n?null:`bookshelf/${t}/${n}`}async function Pn(s){const t=Xe(),n=Le();if(!$t())return console.log("[AutoSave] è‡ªåŠ¨ä¿å­˜æœªå¯ç”¨æˆ–éä¹¦æ¶æ¨¡å¼ï¼Œè·³è¿‡é¢„ä¿å­˜"),!0;const o=Xl();if(!o)return console.warn("[AutoSave] ç¼ºå°‘ä¹¦ç±/ç« èŠ‚IDï¼Œè·³è¿‡é¢„ä¿å­˜"),s?.onError?.("ç¼ºå°‘ä¹¦ç±/ç« èŠ‚ID"),!1;const i=t.images;if(i.length===0)return console.warn("[AutoSave] æ²¡æœ‰å›¾ç‰‡ï¼Œè·³è¿‡é¢„ä¿å­˜"),s?.onError?.("æ²¡æœ‰å›¾ç‰‡"),!1;console.log(`[AutoSave] é¢„ä¿å­˜å¼€å§‹ï¼š${i.length} å¼ åŸå›¾`),s?.onStart?.(i.length);try{const r=i.map((B,O)=>{const D={};for(const M of Object.keys(B))["originalDataURL","translatedDataURL","cleanImageData"].includes(M)||(D[M]=B[M]);return D.hasOriginalData=!!B.originalDataURL,D.hasTranslatedData=!!B.translatedDataURL,D.hasCleanData=!!B.cleanImageData,D}),{textStyle:l,targetLanguage:u,sourceLanguage:b}=n.settings,P={targetLanguage:u,sourceLanguage:b,fontSize:l.fontSize,autoFontSize:l.autoFontSize,fontFamily:l.fontFamily,layoutDirection:l.layoutDirection,textColor:l.textColor,useInpaintingMethod:l.inpaintMethod,fillColor:l.fillColor,strokeEnabled:l.strokeEnabled,strokeColor:l.strokeColor,strokeWidth:l.strokeWidth,useAutoTextColor:l.useAutoTextColor},C=await Cn(o,{ui_settings:P,images_meta:r,currentImageIndex:t.currentImageIndex});if(!C.success||!C.session_folder)throw new Error(C.error||"åˆå§‹åŒ–ä¿å­˜å¤±è´¥");dt=C.session_folder,console.log(`[AutoSave] ä¼šè¯æ–‡ä»¶å¤¹ï¼š${dt}`);for(let B=0;B<i.length;B++){const O=i[B];if(O?.originalDataURL?.startsWith("data:"))try{await Wt(dt,B,"original",O.originalDataURL),console.log(`[AutoSave] åŸå›¾ ${B+1}/${i.length} å·²ä¿å­˜`),s?.onProgress?.(B+1,i.length)}catch(D){console.error(`[AutoSave] ä¿å­˜åŸå›¾ ${B+1} å¤±è´¥:`,D),s?.onProgress?.(B+1,i.length)}else s?.onProgress?.(B+1,i.length)}return Et=!0,console.log("[AutoSave] é¢„ä¿å­˜å®Œæˆ"),s?.onComplete?.(),!0}catch(r){console.error("[AutoSave] é¢„ä¿å­˜å¤±è´¥:",r);const l=r instanceof Error?r.message:"é¢„ä¿å­˜å¤±è´¥";return s?.onError?.(l),dt=null,Et=!1,!1}}async function Mn(s){if(!$t())return;if(!dt){console.warn("[AutoSave] ä¼šè¯æ–‡ä»¶å¤¹æœªåˆå§‹åŒ–ï¼Œè·³è¿‡ä¿å­˜");return}const t=Xe(),n=t.images[s];if(!n){console.warn(`[AutoSave] å›¾ç‰‡ ${s} ä¸å­˜åœ¨`);return}try{if(n.translatedDataURL?.startsWith("data:")&&await Wt(dt,s,"translated",n.translatedDataURL),n.cleanImageData&&!n.cleanImageData.startsWith("/api/")){const o=n.cleanImageData.startsWith("data:")?n.cleanImageData:`data:image/png;base64,${n.cleanImageData}`;await Wt(dt,s,"clean",o)}t.updateImageByIndex(s,{hasUnsavedChanges:!1})}catch(o){throw console.error(`[AutoSave] ä¿å­˜è¯‘å›¾ ${s+1} å¤±è´¥:`,o),o}}async function En(){if(!$t())return;if(!dt||!Et){console.log("[AutoSave] æœªæ‰§è¡Œé¢„ä¿å­˜æˆ–ä¼šè¯æ–‡ä»¶å¤¹ä¸å­˜åœ¨ï¼Œè·³è¿‡å®Œæˆä¿å­˜");return}console.log("[AutoSave] å®Œæˆä¿å­˜...");const s=Xe();try{const t=s.images.map(n=>{const o={};for(const i of Object.keys(n))["originalDataURL","translatedDataURL","cleanImageData"].includes(i)||(o[i]=n[i]);return o.hasOriginalData=!!n.originalDataURL,o.hasTranslatedData=!!n.translatedDataURL,o.hasCleanData=!!n.cleanImageData,o});await Sn(dt,t),console.log("[AutoSave] ä¼šè¯ä¿å­˜å®Œæˆ")}catch(t){console.error("[AutoSave] å®Œæˆä¿å­˜å¤±è´¥:",t)}finally{dt=null,Et=!1}}function Bn(){dt=null,Et=!1,console.log("[AutoSave] ä¿å­˜çŠ¶æ€å·²é‡ç½®")}const ln={standard:["detection","ocr","color","translate","inpaint","render"],hq:["detection","ocr","color","aiTranslate","inpaint","render"],proofread:["aiTranslate","render"],removeText:["detection","inpaint","render"]},Ot={detection:"æ°”æ³¡æ£€æµ‹",ocr:"æ–‡å­—è¯†åˆ«",color:"é¢œè‰²æå–",translate:"ç¿»è¯‘",aiTranslate:"AIç¿»è¯‘",inpaint:"èƒŒæ™¯ä¿®å¤",render:"æ¸²æŸ“",save:"ä¿å­˜"};function Gl(){const s=Xe(),t=ct(),n=Le(),o=kn(),i=rt(),{progress:r,reporter:l}=Yl(),u=h(!1),b=h(null);let P=null,C="standard";const B=J(()=>u.value||s.isBatchTranslationInProgress),O=J(()=>r.value.percentage||0);function D(){const a=n.settings.translation.rpmLimit;b.value?b.value.setRpm(a):b.value=ea(a)}function M(a){const v=a.mode==="hq"?"hq":a.mode==="proofread"?"proofread":a.mode==="removeText"?"ocr":"normal";return o.validateBeforeTranslation(v)}function w(){const{textStyle:a}=n.settings,v=a.layoutDirection;P={fontFamily:a.fontFamily,fontSize:a.fontSize,autoFontSize:a.autoFontSize,autoTextDirection:v==="auto",textDirection:v==="auto"?"vertical":v,layoutDirection:v,fillColor:a.fillColor,textColor:a.textColor,rotationAngle:0,strokeEnabled:a.strokeEnabled,strokeColor:a.strokeColor,strokeWidth:a.strokeWidth,useAutoTextColor:a.useAutoTextColor}}function V(a){return a.includes("base64,")?a.split("base64,")[1]||"":a}function q(a){const v=s.images;if(a.scope==="current"){const A=s.currentImage;return A?[{image:A,index:s.currentImageIndex}]:[]}return a.scope==="failed"?s.getFailedImageIndices().map(A=>({image:v[A],index:A})).filter(A=>A.image!==void 0):v.map((A,_)=>({image:A,index:_}))}async function N(a){const v=n.settings,A=V(a.image.originalDataURL),_=await wn({image:A,detector_type:v.textDetector,box_expand_ratio:v.boxExpand.ratio,box_expand_top:v.boxExpand.top,box_expand_bottom:v.boxExpand.bottom,box_expand_left:v.boxExpand.left,box_expand_right:v.boxExpand.right});if(!_.success)throw new Error(_.error||"æ£€æµ‹å¤±è´¥");a.bubbleCoords=_.bubble_coords||[],a.bubbleAngles=_.bubble_angles||[],a.bubblePolygons=_.bubble_polygons||[],a.autoDirections=_.auto_directions||[],a.rawMask=_.raw_mask,a.textlinesPerBubble=_.textlines_per_bubble||[]}async function m(a){if(a.bubbleCoords.length===0){a.originalTexts=[];return}const v=n.settings,A=V(a.image.originalDataURL),_=await $n({image:A,bubble_coords:a.bubbleCoords,source_language:v.sourceLanguage,ocr_engine:v.ocrEngine,baidu_api_key:v.baiduOcr?.apiKey,baidu_secret_key:v.baiduOcr?.secretKey,baidu_version:v.baiduOcr?.version,baidu_ocr_language:v.baiduOcr?.sourceLanguage,ai_vision_provider:v.aiVisionOcr?.provider,ai_vision_api_key:v.aiVisionOcr?.apiKey,ai_vision_model_name:v.aiVisionOcr?.modelName,ai_vision_ocr_prompt:v.aiVisionOcr?.prompt,custom_ai_vision_base_url:v.aiVisionOcr?.customBaseUrl,textlines_per_bubble:a.textlinesPerBubble});if(!_.success)throw new Error(_.error||"OCRå¤±è´¥");a.originalTexts=_.original_texts||[]}async function d(a){if(a.bubbleCoords.length===0){a.colors=[];return}const v=V(a.image.originalDataURL),A=await Tn({image:v,bubble_coords:a.bubbleCoords,textlines_per_bubble:a.textlinesPerBubble});if(!A.success)throw new Error(A.error||"é¢œè‰²æå–å¤±è´¥");a.colors=A.colors||[]}async function S(a){if(a.originalTexts.length===0){a.translatedTexts=[],a.textboxTexts=[];return}const v=n.settings,A=await In({original_texts:a.originalTexts,target_language:v.targetLanguage,source_language:v.sourceLanguage,model_provider:v.translation.provider,model_name:v.translation.modelName,api_key:v.translation.apiKey,custom_base_url:v.translation.customBaseUrl,prompt_content:v.translatePrompt,textbox_prompt_content:v.textboxPrompt,use_textbox_prompt:v.useTextboxPrompt,rpm_limit:v.translation.rpmLimit,max_retries:v.translation.maxRetries,use_json_format:v.translation.isJsonMode});if(!A.success)throw new Error(A.error||"ç¿»è¯‘å¤±è´¥");a.translatedTexts=A.translated_texts||[],a.textboxTexts=A.textbox_texts||[]}async function x(a){const v=n.settings,A=C==="proofread",_=a.map(me=>A?{imageIndex:me.imageIndex,bubbles:(me.image.bubbleStates||[]).map((j,W)=>({bubbleIndex:W,original:j.originalText||"",translated:v.useTextboxPrompt?j.textboxText||j.translatedText||"":j.translatedText||"",textDirection:j.textDirection==="vertical"||j.textDirection==="horizontal"?j.textDirection:j.autoTextDirection==="vertical"||j.autoTextDirection==="horizontal"?j.autoTextDirection:"vertical"}))}:{imageIndex:me.imageIndex,bubbles:me.originalTexts.map((j,W)=>({bubbleIndex:W,original:j,translated:"",textDirection:me.autoDirections[W]||"vertical"}))}),R=a.map(me=>{const j=A&&me.image.translatedDataURL||me.image.originalDataURL;return V(j)}),I=A?v.proofreading.rounds[0]:v.hqTranslation,g=A?I?.prompt:v.hqTranslation.prompt,L=A?"ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ¼«ç”»ç¿»è¯‘æ ¡å¯¹åŠ©æ‰‹ï¼Œèƒ½å¤Ÿæ ¹æ®æ¼«ç”»å›¾åƒå†…å®¹æ£€æŸ¥å’Œä¿®æ­£ç¿»è¯‘ã€‚":"ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ¼«ç”»ç¿»è¯‘åŠ©æ‰‹ï¼Œèƒ½å¤Ÿæ ¹æ®æ¼«ç”»å›¾åƒå†…å®¹å’Œä¸Šä¸‹æ–‡æä¾›é«˜è´¨é‡çš„ç¿»è¯‘ã€‚",c=JSON.stringify(_,null,2),f=[{type:"text",text:(g||"")+`

ä»¥ä¸‹æ˜¯JSONæ•°æ®:
\`\`\`json
`+c+"\n```"}];for(const me of R)f.push({type:"image_url",image_url:{url:`data:image/png;base64,${me}`}});const se=[{role:"system",content:L},{role:"user",content:f}],$=v.hqTranslation,Y=A?I:null,ce=await Mt({provider:(A?Y?.provider:$.provider)||"openai",api_key:(A?Y?.apiKey:$.apiKey)||"",model_name:(A?Y?.modelName:$.modelName)||"",custom_base_url:A?Y?.customBaseUrl:$.customBaseUrl,messages:se,low_reasoning:A?Y?.lowReasoning:$.lowReasoning,force_json_output:A?Y?.forceJsonOutput:$.forceJsonOutput,no_thinking_method:A?Y?.noThinkingMethod:$.noThinkingMethod,use_stream:A?!1:$.useStream,max_retries:A?v.proofreading.maxRetries||2:$.maxRetries||2}),_e=A?Y?.forceJsonOutput||!1:$.forceJsonOutput;let $e=Z(ce,_e)||_;if(A&&v.proofreading.rounds.length>1)for(let me=1;me<v.proofreading.rounds.length;me++){const j=v.proofreading.rounds[me],W=JSON.stringify($e,null,2),z=[{type:"text",text:j.prompt+`

ä»¥ä¸‹æ˜¯JSONæ•°æ®:
\`\`\`json
`+W+"\n```"}];for(const ve of R)z.push({type:"image_url",image_url:{url:`data:image/png;base64,${ve}`}});const te=[{role:"system",content:L},{role:"user",content:z}],oe=await Mt({provider:j.provider,api_key:j.apiKey,model_name:j.modelName,custom_base_url:j.customBaseUrl,messages:te,low_reasoning:j.lowReasoning,force_json_output:j.forceJsonOutput,no_thinking_method:j.noThinkingMethod,use_stream:!1,max_retries:j.maxRetries||v.proofreading.maxRetries||2}),re=Z(oe,j.forceJsonOutput);re&&($e=re)}for(const me of a){const j=$e?.find(W=>W.imageIndex===me.imageIndex);j?me.translatedTexts=j.bubbles.map(W=>W.translated):me.translatedTexts=[],me.textboxTexts=[]}}async function K(a){if(a.bubbleCoords.length===0){a.cleanImage=V(a.image.originalDataURL);return}const v=n.settings,{textStyle:A,preciseMask:_}=v,R=V(a.image.originalDataURL),I=await Dn({image:R,bubble_coords:a.bubbleCoords,bubble_polygons:a.bubblePolygons,raw_mask:a.rawMask,method:A.inpaintMethod==="solid"?"solid":"lama",lama_model:A.inpaintMethod==="litelama"?"litelama":"lama_mpe",fill_color:A.fillColor,mask_dilate_size:_.dilateSize,mask_box_expand_ratio:_.boxExpandRatio});if(!I.success)throw new Error(I.error||"èƒŒæ™¯ä¿®å¤å¤±è´¥");a.cleanImage=I.clean_image}async function G(a){if(!a.cleanImage)throw C==="proofread"?new Error("æ­¤å›¾ç‰‡å°šæœªç¿»è¯‘ï¼Œè¯·å…ˆç¿»è¯‘åå†è¿›è¡Œæ ¡å¯¹"):new Error("ç¼ºå°‘å¹²å‡€èƒŒæ™¯å›¾ç‰‡");const{textStyle:v}=n.settings,A=P?.autoTextDirection?"auto":P?.textDirection||v.layoutDirection,_=a.bubbleCoords.map((I,g)=>{const L=a.autoDirections[g]||"vertical",c=L==="v"?"vertical":L==="h"?"horizontal":L==="vertical"||L==="horizontal"?L:"vertical",f=A==="vertical"||A==="horizontal"?A:c,se=P?.useAutoTextColor??v.useAutoTextColor;let $=P?.textColor||v.textColor,Y=P?.fillColor||v.fillColor;const ce=a.colors[g];return se&&ce&&(ce.textColor&&($=ce.textColor),ce.bgColor&&(Y=ce.bgColor)),{coords:I,polygon:[],position:{x:0,y:0},rotationAngle:a.bubbleAngles[g]||0,originalText:a.originalTexts[g]||"",translatedText:a.translatedTexts[g]||"",textboxText:a.textboxTexts[g]||"",textDirection:f,autoTextDirection:c,fontSize:P?.fontSize||v.fontSize,fontFamily:P?.fontFamily||v.fontFamily,autoFontSize:P?.autoFontSize??v.autoFontSize,textColor:$,fillColor:Y,strokeEnabled:P?.strokeEnabled??v.strokeEnabled,strokeColor:P?.strokeColor||v.strokeColor,strokeWidth:P?.strokeWidth||v.strokeWidth,inpaintMethod:v.inpaintMethod,autoFgColor:a.colors[g]?.autoFgColor||null,autoBgColor:a.colors[g]?.autoBgColor||null}}),R=await Rn({clean_image:a.cleanImage,bubble_states:_,fontSize:P?.fontSize||v.fontSize,fontFamily:P?.fontFamily||v.fontFamily,textDirection:P?.textDirection||v.layoutDirection,textColor:P?.textColor||v.textColor,strokeEnabled:P?.strokeEnabled??v.strokeEnabled,strokeColor:P?.strokeColor||v.strokeColor,strokeWidth:P?.strokeWidth||v.strokeWidth,autoFontSize:P?.autoFontSize??v.autoFontSize,use_individual_styles:!0});if(!R.success)throw new Error(R.error||"æ¸²æŸ“å¤±è´¥");a.finalImage=R.final_image,a.bubbleStates=R.bubble_states||_}async function ie(a,v){switch(a){case"detection":await N(v);break;case"ocr":await m(v);break;case"color":await d(v);break;case"translate":await S(v);break;case"inpaint":await K(v);break;case"render":await G(v);break;case"save":await Mn(v.imageIndex);break;case"aiTranslate":throw new Error("aiTranslate åº”é€šè¿‡æ‰¹é‡å¤„ç†é€»è¾‘è°ƒç”¨")}}function Z(a,v){if(!a.success)return console.error("APIè°ƒç”¨å¤±è´¥:",a.error),null;if(a.results&&a.results.length>0){const _=a.results[0];if(_&&"imageIndex"in _&&"bubbles"in _)return a.results}const A=a.content;if(A)if(v)try{return JSON.parse(A)}catch{return null}else{const _=A.match(/```json\s*([\s\S]*?)\s*```/);if(_?.[1])try{return JSON.parse(_[1])}catch{return null}}return null}function le(a){const v=a.finalImage?`data:image/png;base64,${a.finalImage}`:a.cleanImage?`data:image/png;base64,${a.cleanImage}`:null;s.updateImageByIndex(a.imageIndex,{translatedDataURL:v,cleanImageData:a.cleanImage||null,bubbleStates:a.bubbleStates,bubbleCoords:a.bubbleCoords,bubbleAngles:a.bubbleAngles,originalTexts:a.originalTexts,textboxTexts:a.textboxTexts,bubbleTexts:a.translatedTexts,translationStatus:"completed",translationFailed:!1,showOriginal:!1,hasUnsavedChanges:!0,layoutDirection:P?.layoutDirection,autoFontSize:P?.autoFontSize??!1,useAutoTextColor:P?.useAutoTextColor??!1}),a.imageIndex===s.currentImageIndex&&a.bubbleStates&&t.setBubbles(a.bubbleStates)}function Q(a){return a==="standard"||a==="removeText"}function T(a){const v=n.settings;return a==="hq"?v.hqTranslation.batchSize||5:a==="proofread"?v.proofreading.rounds[0]?.batchSize||5:1}async function k(a,v,A,_){let R=0,I=0;for(let g=0;g<a.length;g++){const L=a[g];if(A.scope==="all"&&!s.isBatchTranslationInProgress){console.log("â¹ï¸ æ‰¹é‡ç¿»è¯‘å·²å–æ¶ˆï¼Œåœæ­¢å¤„ç†");break}const c=Math.floor(g/a.length*90);l.setPercentage(c,`å¤„ç†å›¾ç‰‡ ${g+1}/${a.length}`),i.info(`å¤„ç†å›¾ç‰‡ ${g+1}/${a.length}...`),s.setTranslationStatus(L.imageIndex,"processing");let f=!1;for(let se=0;se<v.length;se++){const $=v[se];if(f)break;b.value&&await b.value.acquire();try{const Y=c+Math.floor(se/v.length*(90/a.length));l.setPercentage(Y,`å›¾ç‰‡ ${g+1}: ${Ot[$]}`),await ie($,L)}catch(Y){const ce=Y instanceof Error?Y.message:"æœªçŸ¥é”™è¯¯";_.push(`å›¾ç‰‡ ${L.imageIndex+1}: ${$} - ${ce}`),s.setTranslationStatus(L.imageIndex,"failed",ce),f=!0,I++}}f||(le(L),R++,console.log(`âœ… å›¾ç‰‡ ${g+1}/${a.length} å¤„ç†å®Œæˆ`))}return{completed:R,failed:I}}async function F(a,v,A,_){let R=0,I=0;const g=T(A.mode),L=Math.ceil(a.length/g),c=v.indexOf("aiTranslate"),f=c>=0?v.slice(0,c):v,se=c>=0?v.slice(c+1):[];console.log(`ğŸ“¦ æ‰¹æ¬¡å¤„ç†æ¨¡å¼ï¼šå…± ${a.length} å¼ å›¾ç‰‡ï¼Œæ¯æ‰¹ ${g} å¼ ï¼Œå…± ${L} æ‰¹`),console.log(`   AIç¿»è¯‘å‰æ­¥éª¤: [${f.join(" â†’ ")}]`),console.log(`   AIç¿»è¯‘åæ­¥éª¤: [${se.join(" â†’ ")}]`);for(let $=0;$<L;$++){if(A.scope==="all"&&!s.isBatchTranslationInProgress){console.log("â¹ï¸ æ‰¹é‡ç¿»è¯‘å·²å–æ¶ˆï¼Œåœæ­¢å¤„ç†");break}const Y=$*g,ce=Math.min(Y+g,a.length),_e=a.slice(Y,ce),we=Math.floor($/L*90);l.setPercentage(we,`å¤„ç†æ‰¹æ¬¡ ${$+1}/${L}`),i.info(`å¤„ç†æ‰¹æ¬¡ ${$+1}/${L}ï¼ˆå›¾ç‰‡ ${Y+1}-${ce}ï¼‰...`);for(const me of _e)s.setTranslationStatus(me.imageIndex,"processing");const $e=new Set;for(let me=0;me<_e.length;me++){const j=_e[me];for(const W of f){if($e.has(j.imageIndex))break;b.value&&await b.value.acquire();try{const z=we+Math.floor(me/_e.length*30);l.setPercentage(z,`å›¾ç‰‡ ${Y+me+1}: ${Ot[W]}`),await ie(W,j)}catch(z){const te=z instanceof Error?z.message:"æœªçŸ¥é”™è¯¯";_.push(`å›¾ç‰‡ ${j.imageIndex+1}: ${W} - ${te}`),s.setTranslationStatus(j.imageIndex,"failed",te),$e.add(j.imageIndex)}}}if(c>=0){const me=we+40;l.setPercentage(me,`æ‰¹æ¬¡ ${$+1}: ${Ot.aiTranslate}`);try{const j=_e.filter(W=>!$e.has(W.imageIndex));j.length>0&&await x(j)}catch(j){const W=j instanceof Error?j.message:"æœªçŸ¥é”™è¯¯";_.push(`æ‰¹æ¬¡ ${$+1} AIç¿»è¯‘å¤±è´¥: ${W}`);for(const z of _e)$e.has(z.imageIndex)||(s.setTranslationStatus(z.imageIndex,"failed",W),$e.add(z.imageIndex))}}for(let me=0;me<_e.length;me++){const j=_e[me];if(!$e.has(j.imageIndex)){for(const W of se){if($e.has(j.imageIndex))break;b.value&&await b.value.acquire();try{const z=we+50+Math.floor(me/_e.length*40);l.setPercentage(z,`å›¾ç‰‡ ${Y+me+1}: ${Ot[W]}`),await ie(W,j)}catch(z){const te=z instanceof Error?z.message:"æœªçŸ¥é”™è¯¯";_.push(`å›¾ç‰‡ ${j.imageIndex+1}: ${W} - ${te}`),s.setTranslationStatus(j.imageIndex,"failed",te),$e.add(j.imageIndex)}}$e.has(j.imageIndex)||(le(j),R++,console.log(`âœ… å›¾ç‰‡ ${Y+me+1} å¤„ç†å®Œæˆ`))}}I+=$e.size,console.log(`âœ… æ‰¹æ¬¡ ${$+1}/${L} å¤„ç†å®Œæˆ`)}return{completed:R,failed:I}}async function y(a){if(!M(a))return{success:!1,completed:0,failed:0,errors:["é…ç½®éªŒè¯å¤±è´¥"]};if(s.images.length===0)return i.error("è¯·å…ˆä¸Šä¼ å›¾ç‰‡"),{success:!1,completed:0,failed:0,errors:["æ²¡æœ‰å›¾ç‰‡"]};C=a.mode;const A=Q(a.mode);u.value=!0,(a.scope==="all"||a.scope==="failed")&&s.setBatchTranslationInProgress(!0),D(),w();const _=q(a),R=[],I=$t(),g=[...ln[a.mode]];I&&g.push("save"),console.log("ğŸš€ é¡ºåºç®¡çº¿å¯åŠ¨"),console.log(`   æ¨¡å¼: ${a.mode}`),console.log(`   å¤„ç†æ–¹å¼: ${A?"é€å¼ å¤„ç†":"æ‰¹æ¬¡å¤„ç†"}`),console.log(`   æ­¥éª¤é“¾: [${g.join(" â†’ ")}]`),console.log(`   è‡ªåŠ¨ä¿å­˜: ${I?"å¯ç”¨":"ç¦ç”¨"}`);const L=_.map(({image:c,index:f})=>{const se={imageIndex:f,image:c,bubbleCoords:[],bubbleAngles:[],bubblePolygons:[],autoDirections:[],textlinesPerBubble:[],originalTexts:[],colors:[],translatedTexts:[],textboxTexts:[]};return a.mode==="proofread"&&c.bubbleStates&&c.bubbleStates.length>0&&(se.bubbleCoords=c.bubbleStates.map($=>$.coords),se.bubbleAngles=c.bubbleStates.map($=>$.rotationAngle||0),se.autoDirections=c.bubbleStates.map($=>$.autoTextDirection||$.textDirection||"vertical"),se.originalTexts=c.bubbleStates.map($=>$.originalText||""),se.translatedTexts=c.bubbleStates.map($=>$.translatedText||""),se.textboxTexts=c.bubbleStates.map($=>$.textboxText||""),se.colors=c.bubbleStates.map($=>({textColor:$.textColor||"",bgColor:$.fillColor||"",autoFgColor:$.autoFgColor||null,autoBgColor:$.autoBgColor||null})),c.cleanImageData&&(se.cleanImage=c.cleanImageData)),se});try{l.init(_.length,`${a.mode} æ¨¡å¼å¯åŠ¨...`),I&&(l.setPercentage(2,"é¢„ä¿å­˜åŸå§‹å›¾ç‰‡..."),await Pn()||i.warning("é¢„ä¿å­˜å¤±è´¥ï¼Œç¿»è¯‘å®Œæˆåè¯·æ‰‹åŠ¨ä¿å­˜"));let c;A?c=await k(L,g,a,R):c=await F(L,g,a,R),l.setPercentage(100,"å®Œæˆï¼");const f={standard:"ç¿»è¯‘",hq:"é«˜è´¨é‡ç¿»è¯‘",proofread:"AIæ ¡å¯¹",removeText:"æ¶ˆé™¤æ–‡å­—"};return i.success(`${f[a.mode]}å®Œæˆï¼`),{success:c.failed===0,completed:c.completed,failed:c.failed,errors:R.length>0?R:void 0}}catch(c){const f=c instanceof Error?c.message:"æ‰§è¡Œå¤±è´¥";return i.error(f),R.push(f),{success:!1,completed:0,failed:_.length,errors:R}}finally{u.value=!1,s.setBatchTranslationInProgress(!1),I&&await En();const c=s.currentImageIndex,f=s.images[c];f?.bubbleStates&&f.bubbleStates.length>0&&t.setBubbles(f.bubbleStates),setTimeout(()=>l.finish(),1e3)}}function p(){s.isBatchTranslationInProgress&&(s.setBatchTranslationInProgress(!1),Bn(),i.info("æ“ä½œå·²å–æ¶ˆ"))}return{progress:r,isExecuting:u,isTranslating:B,progressPercent:O,execute:y,cancel:p,STEP_CHAIN_CONFIGS:ln}}class Zl{currentCount=0;maxCount;waitQueue=[];holders=[];constructor(t=1){this.maxCount=Math.max(1,t)}setSize(t){this.maxCount=Math.max(1,t),this.tryWakeUp()}getSize(){return this.maxCount}async acquire(t){if(this.currentCount<this.maxCount){this.currentCount++,this.holders.push(t);return}return new Promise(n=>{this.waitQueue.push({resolve:n,poolName:t})})}release(t){const n=this.holders.indexOf(t);n>=0&&(this.holders.splice(n,1),this.currentCount--),this.tryWakeUp()}tryWakeUp(){for(;this.currentCount<this.maxCount&&this.waitQueue.length>0;){const t=this.waitQueue.shift();this.currentCount++,this.holders.push(t.poolName),t.resolve()}}async withLock(t,n){await this.acquire(t);try{return await n()}finally{this.release(t)}}getStatus(){return{isLocked:this.currentCount>=this.maxCount,currentCount:this.currentCount,maxCount:this.maxCount,holders:[...this.holders],waitingCount:this.waitQueue.length,waitingPools:this.waitQueue.map(t=>t.poolName)}}isWaiting(t){return this.waitQueue.some(n=>n.poolName===t)}isHolding(t){return this.holders.includes(t)}reset(){this.currentCount=0,this.holders=[];for(const t of this.waitQueue)t.resolve();this.waitQueue=[]}}class Tt{queue=[];currentTask=null;isRunning=!1;isCancelled=!1;completedCount=0;nextPool;name;icon;lock;progressTracker;onTaskComplete;constructor(t,n,o,i,r,l){this.name=t,this.icon=n,this.nextPool=o,this.lock=i,this.progressTracker=r,this.onTaskComplete=l}getName(){return this.name}getIcon(){return this.icon}setNextPool(t){this.nextPool=t}enqueue(t){this.isCancelled||(this.queue.push(t),this.progressTracker.updatePool(this.name,{waiting:this.queue.length}),this.tryProcessNext())}enqueueBatch(t){if(!this.isCancelled){for(const n of t)this.queue.push(n);this.progressTracker.updatePool(this.name,{waiting:this.queue.length}),this.tryProcessNext()}}async tryProcessNext(){if(!(this.isRunning||this.isCancelled||this.queue.length===0)){this.isRunning=!0,this.currentTask=this.queue.shift(),this.progressTracker.updatePool(this.name,{waiting:this.queue.length,isProcessing:!0,currentPage:this.currentTask.imageIndex+1,isWaitingLock:!1});try{let t;this.lock?(this.progressTracker.updatePool(this.name,{isWaitingLock:!0}),t=await this.lock.withLock(this.name,async()=>(this.progressTracker.updatePool(this.name,{isWaitingLock:!1}),await this.process(this.currentTask)))):t=await this.process(this.currentTask),this.completedCount++,this.progressTracker.updatePool(this.name,{completed:this.completedCount}),this.nextPool&&t.status!=="failed"&&t.status!=="buffered"&&this.nextPool.enqueue(t),this.onTaskComplete?.(t)}catch(t){this.currentTask.status="failed",this.currentTask.error=t.message,console.error(`[${this.name}] å¤„ç†ä»»åŠ¡å¤±è´¥:`,t),this.onTaskComplete?.(this.currentTask)}finally{this.currentTask=null,this.isRunning=!1,this.progressTracker.updatePool(this.name,{isProcessing:!1,currentPage:void 0}),this.tryProcessNext()}}}getStatus(){return{name:this.name,icon:this.icon,waiting:this.queue.length,processing:this.isRunning,currentPage:this.currentTask?.imageIndex,completed:this.completedCount,isWaitingLock:this.lock?.isWaiting(this.name)??!1}}cancel(){this.isCancelled=!0,this.queue=[]}reset(){this.isCancelled=!1,this.queue=[],this.currentTask=null,this.isRunning=!1,this.completedCount=0}getCompletedCount(){return this.completedCount}getWaitingCount(){return this.queue.length}isProcessing(){return this.isRunning}}const Ql=[{name:"æ£€æµ‹",icon:"ğŸ“"},{name:"OCR",icon:"ğŸ“–"},{name:"é¢œè‰²",icon:"ğŸ¨"},{name:"ç¿»è¯‘",icon:"ğŸŒ"},{name:"ä¿®å¤",icon:"ğŸ–Œï¸"},{name:"æ¸²æŸ“",icon:"âœ¨"}];class ei{poolStatuses=new Map;totalPages=0;startTime=0;progress=vo({pools:[],totalCompleted:0,totalFailed:0,totalPages:0,estimatedTimeRemaining:0});constructor(){this.initPools()}initPools(){for(const t of Ql){const n={name:t.name,icon:t.icon,waiting:0,processing:!1,completed:0,isWaitingLock:!1};this.poolStatuses.set(t.name,n)}this.syncToReactive()}init(t){this.totalPages=t,this.startTime=Date.now();for(const n of this.poolStatuses.values())n.waiting=0,n.processing=!1,n.currentPage=void 0,n.completed=0,n.isWaitingLock=!1;this.progress.totalCompleted=0,this.progress.totalFailed=0,this.progress.totalPages=t,this.progress.estimatedTimeRemaining=0,this.syncToReactive()}updatePool(t,n){const o=this.poolStatuses.get(t);o&&(n.waiting!==void 0&&(o.waiting=n.waiting),n.isProcessing!==void 0&&(o.processing=n.isProcessing),n.currentPage!==void 0&&(o.currentPage=n.currentPage),n.completed!==void 0&&(o.completed=n.completed),n.isWaitingLock!==void 0&&(o.isWaitingLock=n.isWaitingLock),this.syncToReactive(),this.updateEstimatedTime())}incrementCompleted(){this.progress.totalCompleted++,this.updateEstimatedTime()}incrementFailed(){this.progress.totalFailed++}updateEstimatedTime(){if(this.progress.totalCompleted===0){this.progress.estimatedTimeRemaining=0;return}const n=(Date.now()-this.startTime)/1e3/this.progress.totalCompleted,o=this.totalPages-this.progress.totalCompleted-this.progress.totalFailed;this.progress.estimatedTimeRemaining=Math.ceil(n*o)}syncToReactive(){this.progress.pools=Array.from(this.poolStatuses.values()).map(t=>({...t}))}getPoolStatus(t){return this.poolStatuses.get(t)}getAllPoolStatuses(){return Array.from(this.poolStatuses.values())}getProgress(){return{...this.progress}}reset(){this.totalPages=0,this.startTime=0,this.initPools()}formatRemainingTime(){const t=this.progress.estimatedTimeRemaining;if(t<=0)return"--";const n=Math.floor(t/60),o=t%60;return n>0?`${n}åˆ†${o}ç§’`:`${o}ç§’`}}class ti{results=new Map;totalExpected=0;completedCount=0;failedCount=0;resolveWaitAll=null;init(t){this.results.clear(),this.totalExpected=t,this.completedCount=0,this.failedCount=0,this.resolveWaitAll=null}add(t){this.results.set(t.imageIndex,t),t.status==="completed"?this.completedCount++:t.status==="failed"&&this.failedCount++,this.completedCount+this.failedCount>=this.totalExpected&&this.resolveWaitAll&&(this.resolveWaitAll({success:this.completedCount,failed:this.failedCount}),this.resolveWaitAll=null)}waitForAll(t){return this.totalExpected=t,this.completedCount+this.failedCount>=t?Promise.resolve({success:this.completedCount,failed:this.failedCount}):new Promise(n=>{this.resolveWaitAll=n})}get(t){return this.results.get(t)}getAll(){return Array.from(this.results.values()).sort((t,n)=>t.imageIndex-n.imageIndex)}getSuccessful(){return this.getAll().filter(t=>t.status==="completed")}getFailed(){return this.getAll().filter(t=>t.status==="failed")}getStats(){return{total:this.totalExpected,completed:this.completedCount,failed:this.failedCount,pending:this.totalExpected-this.completedCount-this.failedCount}}reset(){this.results.clear(),this.totalExpected=0,this.completedCount=0,this.failedCount=0,this.resolveWaitAll=null}}class oi extends Tt{constructor(t,n,o,i){super("æ£€æµ‹","ğŸ“",t,n,o,i)}async process(t){const{imageData:n}=t,i=Le().settings,r=this.extractBase64(n.originalDataURL),l=await wn({image:r,detector_type:i.textDetector,box_expand_ratio:i.boxExpand.ratio,box_expand_top:i.boxExpand.top,box_expand_bottom:i.boxExpand.bottom,box_expand_left:i.boxExpand.left,box_expand_right:i.boxExpand.right});if(!l.success)throw new Error(l.error||"æ£€æµ‹å¤±è´¥");return t.detectionResult={bubbleCoords:l.bubble_coords||[],bubbleAngles:l.bubble_angles||[],bubblePolygons:l.bubble_polygons||[],autoDirections:l.auto_directions||[],rawMask:l.raw_mask,textlinesPerBubble:l.textlines_per_bubble||[]},t.status="processing",t}extractBase64(t){return t.includes("base64,")?t.split("base64,")[1]||"":t}}class ni extends Tt{constructor(t,n,o,i){super("OCR","ğŸ“–",t,n,o,i)}async process(t){const{imageData:n,detectionResult:o}=t,r=Le().settings;if(!o||o.bubbleCoords.length===0)return t.ocrResult={originalTexts:[],textlinesPerBubble:[]},t.status="processing",t;const l=this.extractBase64(n.originalDataURL),u=await $n({image:l,bubble_coords:o.bubbleCoords,source_language:r.sourceLanguage,ocr_engine:r.ocrEngine,baidu_api_key:r.baiduOcr?.apiKey,baidu_secret_key:r.baiduOcr?.secretKey,baidu_version:r.baiduOcr?.version,baidu_ocr_language:r.baiduOcr?.sourceLanguage,ai_vision_provider:r.aiVisionOcr?.provider,ai_vision_api_key:r.aiVisionOcr?.apiKey,ai_vision_model_name:r.aiVisionOcr?.modelName,ai_vision_ocr_prompt:r.aiVisionOcr?.prompt,custom_ai_vision_base_url:r.aiVisionOcr?.customBaseUrl,ai_vision_min_image_size:r.aiVisionOcr?.minImageSize??rs,textlines_per_bubble:o.textlinesPerBubble});if(!u.success)throw new Error(u.error||"OCRå¤±è´¥");return t.ocrResult={originalTexts:u.original_texts||[],textlinesPerBubble:u.textlines_per_bubble||[]},t.status="processing",t}extractBase64(t){return t.includes("base64,")?t.split("base64,")[1]||"":t}}class si extends Tt{constructor(t,n,o,i){super("é¢œè‰²","ğŸ¨",t,n,o,i)}async process(t){const{imageData:n,detectionResult:o,ocrResult:i}=t;if(!o||o.bubbleCoords.length===0)return t.colorResult={colors:[]},t.status="processing",t;const r=this.extractBase64(n.originalDataURL),l=await Tn({image:r,bubble_coords:o.bubbleCoords,textlines_per_bubble:i?.textlinesPerBubble||o.textlinesPerBubble});if(!l.success)throw new Error(l.error||"é¢œè‰²æå–å¤±è´¥");return t.colorResult={colors:l.colors||[]},t.status="processing",t}extractBase64(t){return t.includes("base64,")?t.split("base64,")[1]||"":t}}class ai extends Tt{mode="standard";batchBuffer=[];totalTasks=0;processedCount=0;constructor(t,n,o){super("ç¿»è¯‘","ğŸŒ",t,null,n,o)}setMode(t,n,o){this.mode=t,this.totalTasks=n,this.batchBuffer=[],this.processedCount=0,this.nextPool=o}async process(t){switch(this.mode){case"standard":return this.handleStandardTranslate(t);case"hq":return this.handleHqTranslate(t);case"proofread":return this.handleProofread(t);case"removeText":return this.handleRemoveTextOnly(t);default:return t}}async handleStandardTranslate(t){const o=Le().settings;if(!t.ocrResult||t.ocrResult.originalTexts.length===0)return t.translateResult={translatedTexts:[],textboxTexts:[]},t.status="processing",t;const i=await In({original_texts:t.ocrResult.originalTexts,target_language:o.targetLanguage,source_language:o.sourceLanguage,model_provider:o.translation.provider,model_name:o.translation.modelName,api_key:o.translation.apiKey,custom_base_url:o.translation.customBaseUrl,prompt_content:o.translatePrompt,textbox_prompt_content:o.textboxPrompt,use_textbox_prompt:o.useTextboxPrompt,rpm_limit:o.translation.rpmLimit,max_retries:o.translation.maxRetries,use_json_format:o.translation.isJsonMode});if(!i.success)throw new Error(i.error||"ç¿»è¯‘å¤±è´¥");return t.translateResult={translatedTexts:i.translated_texts||[],textboxTexts:i.textbox_texts||[]},t.status="processing",t}async handleHqTranslate(t){this.batchBuffer.push(t),this.processedCount++;const n=Le(),{hqTranslation:o}=n.settings,i=o.batchSize||3,r=this.processedCount>=this.totalTasks;if(!(this.batchBuffer.length>=i||r))return t.status="buffered",t;const u=[...this.batchBuffer];this.batchBuffer=[];const b=u.map(w=>({imageIndex:w.imageIndex,bubbles:(w.ocrResult?.originalTexts||[]).map((V,q)=>({bubbleIndex:q,original:V,translated:"",textDirection:w.detectionResult?.autoDirections[q]||"vertical"}))})),P=u.map(w=>this.extractBase64(w.imageData.originalDataURL)),C=JSON.stringify(b,null,2),B=[{type:"text",text:o.prompt+`

ä»¥ä¸‹æ˜¯JSONæ•°æ®:
\`\`\`json
`+C+"\n```"}];for(const w of P)B.push({type:"image_url",image_url:{url:`data:image/png;base64,${w}`}});const O=[{role:"system",content:"ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ¼«ç”»ç¿»è¯‘åŠ©æ‰‹ï¼Œèƒ½å¤Ÿæ ¹æ®æ¼«ç”»å›¾åƒå†…å®¹å’Œä¸Šä¸‹æ–‡æä¾›é«˜è´¨é‡çš„ç¿»è¯‘ã€‚"},{role:"user",content:B}],D=await Mt({provider:o.provider,api_key:o.apiKey,model_name:o.modelName,custom_base_url:o.customBaseUrl,messages:O,low_reasoning:o.lowReasoning,force_json_output:o.forceJsonOutput,no_thinking_method:o.noThinkingMethod,use_stream:o.useStream,max_retries:o.maxRetries||2}),M=this.parseHqResponse(D,o.forceJsonOutput);for(const w of u){const V=M?.find(q=>q.imageIndex===w.imageIndex);V?w.translateResult={translatedTexts:V.bubbles.map(q=>q.translated),textboxTexts:[]}:w.translateResult={translatedTexts:[],textboxTexts:[]},w.status="processing",this.nextPool&&this.nextPool.enqueue(w)}return t}async handleProofread(t){this.batchBuffer.push(t),this.processedCount++;const n=Le(),{proofreading:o,useTextboxPrompt:i}=n.settings,r=o.rounds[0]?.batchSize||3,l=this.processedCount>=this.totalTasks;if(!(this.batchBuffer.length>=r||l))return t.status="buffered",t;const b=[...this.batchBuffer];this.batchBuffer=[];const P=b.map(O=>({imageIndex:O.imageIndex,bubbles:(O.imageData.bubbleStates||[]).map((D,M)=>({bubbleIndex:M,original:D.originalText||"",translated:i?D.textboxText||D.translatedText||"":D.translatedText||"",textDirection:D.textDirection==="vertical"||D.textDirection==="horizontal"?D.textDirection:D.autoTextDirection==="vertical"||D.autoTextDirection==="horizontal"?D.autoTextDirection:"vertical"}))})),C=b.map(O=>{const D=O.imageData.translatedDataURL||O.imageData.originalDataURL;return this.extractBase64(D)});let B=P;for(const O of o.rounds){const D=JSON.stringify(B,null,2),M=[{type:"text",text:O.prompt+`

ä»¥ä¸‹æ˜¯JSONæ•°æ®:
\`\`\`json
`+D+"\n```"}];for(const N of C)M.push({type:"image_url",image_url:{url:`data:image/png;base64,${N}`}});const w=[{role:"system",content:"ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ¼«ç”»ç¿»è¯‘æ ¡å¯¹åŠ©æ‰‹ï¼Œèƒ½å¤Ÿæ ¹æ®æ¼«ç”»å›¾åƒå†…å®¹æ£€æŸ¥å’Œä¿®æ­£ç¿»è¯‘ã€‚"},{role:"user",content:M}],V=await Mt({provider:O.provider,api_key:O.apiKey,model_name:O.modelName,custom_base_url:O.customBaseUrl,messages:w,low_reasoning:O.lowReasoning,force_json_output:O.forceJsonOutput,no_thinking_method:O.noThinkingMethod,use_stream:!1,max_retries:O.maxRetries||o.maxRetries||2}),q=this.parseHqResponse(V,O.forceJsonOutput);q&&(B=q)}for(const O of b){const D=B.find(M=>M.imageIndex===O.imageIndex);D?O.translateResult={translatedTexts:D.bubbles.map(M=>M.translated),textboxTexts:[]}:O.translateResult={translatedTexts:[],textboxTexts:[]},O.status="processing",this.nextPool&&this.nextPool.enqueue(O)}return t}async handleRemoveTextOnly(t){return t.translateResult={translatedTexts:[],textboxTexts:[]},t.status="processing",t}extractBase64(t){return t.includes("base64,")?t.split("base64,")[1]||"":t}parseHqResponse(t,n){if(!t.success)return console.error("APIè°ƒç”¨å¤±è´¥:",t.error),null;if(t.results&&t.results.length>0){const i=t.results[0];if(i&&"imageIndex"in i&&"bubbles"in i)return t.results}const o=t.content;if(o)if(n)try{return JSON.parse(o)}catch(i){return console.error("è§£æAIå¼ºåˆ¶JSONè¿”å›çš„å†…å®¹å¤±è´¥:",i),null}else{const i=o.match(/```json\s*([\s\S]*?)\s*```/);if(i?.[1])try{return JSON.parse(i[1])}catch(r){return console.error("è§£æAIè¿”å›çš„JSONå¤±è´¥:",r),null}}return null}}class li extends Tt{constructor(t,n,o,i){super("ä¿®å¤","ğŸ–Œï¸",t,n,o,i)}async process(t){const{imageData:n,detectionResult:o}=t,r=Le().settings;if(!o||o.bubbleCoords.length===0)return t.inpaintResult={cleanImage:this.extractBase64(n.originalDataURL)},t.status="processing",t;const l=this.extractBase64(n.originalDataURL),u=r.textStyle.inpaintMethod,b=u==="lama_mpe"||u==="litelama",P=await Dn({image:l,bubble_coords:o.bubbleCoords,bubble_polygons:o.bubblePolygons,raw_mask:o.rawMask,method:b?"lama":"solid",lama_model:b?u:void 0,fill_color:r.textStyle.fillColor,mask_dilate_size:r.preciseMask.dilateSize,mask_box_expand_ratio:r.preciseMask.boxExpandRatio});if(!P.success)throw new Error(P.error||"ä¿®å¤å¤±è´¥");return t.inpaintResult={cleanImage:P.clean_image||""},t.status="processing",t}extractBase64(t){return t.includes("base64,")?t.split("base64,")[1]||"":t}}const vt=vo({pools:[{name:"æ£€æµ‹",icon:"ğŸ“",waiting:0,processing:!1,completed:0,isWaitingLock:!1},{name:"OCR",icon:"ğŸ“–",waiting:0,processing:!1,completed:0,isWaitingLock:!1},{name:"é¢œè‰²",icon:"ğŸ¨",waiting:0,processing:!1,completed:0,isWaitingLock:!1},{name:"ç¿»è¯‘",icon:"ğŸŒ",waiting:0,processing:!1,completed:0,isWaitingLock:!1},{name:"ä¿®å¤",icon:"ğŸ–Œï¸",waiting:0,processing:!1,completed:0,isWaitingLock:!1},{name:"æ¸²æŸ“",icon:"âœ¨",waiting:0,processing:!1,completed:0,isWaitingLock:!1}],totalCompleted:0,totalFailed:0,totalPages:0,estimatedTimeRemaining:0,preSave:void 0,save:void 0}),ii=h(!1);function _o(){const s=Xe(),t=Le(),n=ms(null),o=J(()=>t.settings.parallel),i=J(()=>o.value?.enabled??!1),r=ii,l=J(()=>vt);function u(){const O=t.settings;return O.proofreading?.enabled&&O.proofreading.rounds.length>0?"proofread":["gemini","openai","claude","deepseek"].includes(O.hqTranslation?.provider||"")&&O.hqTranslation?.apiKey?"hq":"standard"}function b(){if(!n.value)return;const O=n.value.progress;O&&(vt.pools=O.pools.map(D=>({...D})),vt.totalCompleted=O.totalCompleted,vt.totalFailed=O.totalFailed,vt.totalPages=O.totalPages,vt.estimatedTimeRemaining=O.estimatedTimeRemaining)}async function P(O){if(r.value)return{success:0,failed:0,errors:["ç¿»è¯‘æ­£åœ¨è¿›è¡Œä¸­"]};const D=s.images;if(D.length===0)return{success:0,failed:0,errors:["æ²¡æœ‰å›¾ç‰‡"]};r.value=!0,vt.totalPages=D.length,vt.totalCompleted=0,vt.totalFailed=0;const M=setInterval(b,200);try{n.value=ci({enabled:!0,deepLearningLockSize:o.value?.deepLearningLockSize??1});const w=O??u();console.log(`ğŸš€ å¼€å§‹å¹¶è¡Œç¿»è¯‘ï¼Œæ¨¡å¼: ${w}ï¼Œå›¾ç‰‡æ•°: ${D.length}`);const V=await n.value.execute(D,w);return b(),console.log(`âœ… å¹¶è¡Œç¿»è¯‘å®Œæˆï¼ŒæˆåŠŸ: ${V.success}ï¼Œå¤±è´¥: ${V.failed}`),V}catch(w){return console.error("å¹¶è¡Œç¿»è¯‘å‡ºé”™:",w),{success:0,failed:D.length,errors:[w.message]}}finally{clearInterval(M),r.value=!1}}function C(){n.value&&n.value.cancel(),r.value=!1}function B(){n.value=null,r.value=!1}return{isEnabled:i,isRunning:r,progress:l,executeParallel:P,cancel:C,reset:B,determineMode:u}}class ri extends Tt{resultCollector;constructor(t,n,o){super("æ¸²æŸ“","âœ¨",null,null,t,o),this.resultCollector=n}async process(t){const n=Xe(),o=ct(),i=Le(),r=this.buildBubbleStates(t,i);if(r.length===0){const b=t.inpaintResult?.cleanImage||t.imageData.cleanImageData||this.extractBase64(t.imageData.originalDataURL);return t.renderResult={finalImage:b,bubbleStates:[]},t.status="completed",this.updateImageToUI(t,n,o,i),this.resultCollector.add(t),t}const l=t.inpaintResult?.cleanImage||t.imageData.cleanImageData||this.extractBase64(t.imageData.translatedDataURL||t.imageData.originalDataURL),u=await Rn({clean_image:l,bubble_states:r,fontSize:i.settings.textStyle.fontSize,fontFamily:i.settings.textStyle.fontFamily,textDirection:i.settings.textStyle.layoutDirection,textColor:i.settings.textStyle.textColor,strokeEnabled:i.settings.textStyle.strokeEnabled,strokeColor:i.settings.textStyle.strokeColor,strokeWidth:i.settings.textStyle.strokeWidth,autoFontSize:i.settings.textStyle.autoFontSize,use_individual_styles:!0});if(!u.success)throw new Error(u.error||"æ¸²æŸ“å¤±è´¥");return t.renderResult={finalImage:u.final_image||"",bubbleStates:u.bubble_states||r},t.status="completed",this.updateImageToUI(t,n,o,i),this.resultCollector.add(t),t}updateImageToUI(t,n,o,i){const r=t.imageIndex,l=(t.detectionResult?.bubbleCoords||[]).map(u=>u.length>=4?[u[0],u[1],u[2],u[3]]:[0,0,0,0]);n.updateImageByIndex(r,{translatedDataURL:`data:image/png;base64,${t.renderResult.finalImage}`,cleanImageData:t.inpaintResult?.cleanImage||null,bubbleStates:t.renderResult.bubbleStates,bubbleCoords:l,bubbleAngles:t.detectionResult?.bubbleAngles||[],originalTexts:t.ocrResult?.originalTexts||[],bubbleTexts:t.translateResult?.translatedTexts||[],textboxTexts:t.translateResult?.textboxTexts||[],translationStatus:"completed",translationFailed:!1,showOriginal:!1,hasUnsavedChanges:!0,layoutDirection:i.settings.textStyle.layoutDirection,autoFontSize:i.settings.textStyle.autoFontSize,useAutoTextColor:i.settings.textStyle.useAutoTextColor}),r===n.currentImageIndex&&t.renderResult?.bubbleStates&&o.setBubbles(t.renderResult.bubbleStates),this.progressTracker.incrementCompleted(),$t()&&Mn(r).catch(u=>{console.error(`[RenderPool] è‡ªåŠ¨ä¿å­˜å›¾ç‰‡ ${r+1} å¤±è´¥:`,u)}).finally(()=>{const{progress:u}=_o(),b=u.value;b.save&&(b.save.completed=(b.save.completed||0)+1)}),console.log(`âœ… å›¾ç‰‡ ${r+1} æ¸²æŸ“å®Œæˆ`)}buildBubbleStates(t,n){if(!t.detectionResult&&t.imageData.bubbleStates&&t.imageData.bubbleStates.length>0){const B=t.translateResult?.translatedTexts||[];return t.imageData.bubbleStates.map((O,D)=>({...O,translatedText:B[D]||O.translatedText||""}))}if(t.detectionResult&&!t.translateResult)return console.log(`[æ¸²æŸ“æ± ] å›¾ç‰‡ ${t.imageIndex+1}: æ£€æµ‹åˆ°æ¶ˆé™¤æ–‡å­—æ¨¡å¼ï¼ˆæ— ç¿»è¯‘ç»“æœï¼‰ï¼Œè·³è¿‡æ¸²æŸ“`),[];const o=t.detectionResult?.bubbleCoords||[],i=t.translateResult?.translatedTexts||[],r=t.ocrResult?.originalTexts||[],l=t.colorResult?.colors||[],u=t.detectionResult?.bubbleAngles||[],b=t.detectionResult?.autoDirections||[],P=t.detectionResult?.bubblePolygons||[],C=n.settings;return o.map((B,O)=>{const D=b[O],M=D==="v"?"vertical":D==="h"?"horizontal":"vertical",w=C.textStyle.layoutDirection,V=w==="vertical"||w==="horizontal"?w:M;let q=C.textStyle.textColor,N=C.textStyle.fillColor;const m=l[O];return C.textStyle.useAutoTextColor&&m&&(m.textColor&&(q=m.textColor),m.bgColor&&(N=m.bgColor)),{originalText:r[O]||"",translatedText:i[O]||"",textboxText:"",coords:B.length>=4?[B[0],B[1],B[2],B[3]]:[0,0,0,0],polygon:P[O]||[],fontSize:C.textStyle.fontSize,fontFamily:C.textStyle.fontFamily,textDirection:V,autoTextDirection:M,textColor:q,fillColor:N,rotationAngle:u[O]||0,position:{x:0,y:0},strokeEnabled:C.textStyle.strokeEnabled,strokeColor:C.textStyle.strokeColor,strokeWidth:C.textStyle.strokeWidth,inpaintMethod:C.textStyle.inpaintMethod,autoFgColor:m?.autoFgColor||null,autoBgColor:m?.autoBgColor||null}})}extractBase64(t){return t.includes("base64,")?t.split("base64,")[1]||"":t}}const rn={standard:["detection","ocr","color","translate","inpaint","render"],hq:["detection","ocr","color","translate","inpaint","render"],proofread:["translate","render"],removeText:["detection","inpaint","render"]};class ui{lock;progressTracker;resultCollector;detectionPool;ocrPool;colorPool;translatePool;inpaintPool;renderPool;isCancelled=!1;config;constructor(t){this.config=t,this.lock=new Zl(t.deepLearningLockSize),this.progressTracker=new ei,this.resultCollector=new ti,this.renderPool=new ri(this.progressTracker,this.resultCollector),this.inpaintPool=new li(this.renderPool,this.lock,this.progressTracker),this.translatePool=new ai(this.inpaintPool,this.progressTracker),this.colorPool=new si(this.translatePool,this.lock,this.progressTracker),this.ocrPool=new ni(this.colorPool,this.lock,this.progressTracker),this.detectionPool=new oi(this.ocrPool,this.lock,this.progressTracker)}updateConfig(t){t.deepLearningLockSize!==void 0&&(this.lock.setSize(t.deepLearningLockSize),this.config.deepLearningLockSize=t.deepLearningLockSize),t.enabled!==void 0&&(this.config.enabled=t.enabled)}async execute(t,n){this.reset(),this.progressTracker.init(t.length),this.resultCollector.init(t.length),this.setupPoolChain(n,t.length);const o=t.map((l,u)=>({id:`task-${u}`,imageIndex:u,imageData:l,status:"pending"})),i=this.getEntryPool(n);for(const l of o)i.enqueue(l);const r=await this.resultCollector.waitForAll(t.length);return{success:r.success,failed:r.failed,errors:this.resultCollector.getFailed().map(l=>l.error||"æœªçŸ¥é”™è¯¯")}}setupPoolChain(t,n){const o=rn[t],i=this.getPoolMap();for(let b=0;b<o.length-1;b++){const P=o[b],C=o[b+1],B=i[P],O=i[C];B&&O&&B.setNextPool(O)}const r=o[o.length-1],l=i[r];l&&l.setNextPool(null);const u=o.indexOf("translate");if(u>=0&&u<o.length-1){const b=o[u+1];this.translatePool.setMode(t,n,i[b]||null)}else u===o.length-1&&this.translatePool.setMode(t,n,null)}getPoolMap(){return{detection:this.detectionPool,ocr:this.ocrPool,color:this.colorPool,translate:this.translatePool,inpaint:this.inpaintPool,render:this.renderPool}}getEntryPool(t){const o=rn[t][0];return this.getPoolMap()[o]||this.detectionPool}cancel(){this.isCancelled=!0,this.detectionPool.cancel(),this.ocrPool.cancel(),this.colorPool.cancel(),this.translatePool.cancel(),this.inpaintPool.cancel(),this.renderPool.cancel(),this.lock.reset()}reset(){this.isCancelled=!1,this.detectionPool.reset(),this.ocrPool.reset(),this.colorPool.reset(),this.translatePool.reset(),this.inpaintPool.reset(),this.renderPool.reset(),this.resultCollector.reset(),this.progressTracker.reset()}get progress(){return this.progressTracker.progress}getProgressTracker(){return this.progressTracker}getLockStatus(){return this.lock.getStatus()}get cancelled(){return this.isCancelled}}function ci(s){return new ui(s)}function di(){const s=Xe(),t=Le(),n=rt(),o=Gl(),i=_o(),r=J(()=>o.isTranslating.value||s.isBatchTranslationInProgress),l=J(()=>o.progressPercent.value);async function u(C){return s.images.length===0?(n.error("è¯·å…ˆä¸Šä¼ å›¾ç‰‡"),{success:!1,completed:0,failed:0,errors:["æ²¡æœ‰å›¾ç‰‡"]}):t.settings.parallel?.enabled&&C.scope==="all"?(console.log(`ğŸš€ ä½¿ç”¨å¹¶è¡Œç®¡çº¿ï¼Œæ¨¡å¼: ${C.mode}`),b(C)):(console.log(`ğŸš€ ä½¿ç”¨é¡ºåºç®¡çº¿ï¼Œæ¨¡å¼: ${C.mode}`),o.execute(C))}async function b(C){const B=s.images,O=$t();try{if(O&&(console.log("[ParallelPipeline] æ‰§è¡Œé¢„ä¿å­˜..."),n.info("å¼€å§‹é¢„ä¿å­˜åŸå§‹å›¾ç‰‡..."),!await Pn({onStart:V=>{const q=i.progress.value;q.preSave={isRunning:!0,current:0,total:V}},onProgress:(V,q)=>{const N=i.progress.value;N.preSave&&(N.preSave.current=V,N.preSave.total=q)},onComplete:()=>{const V=i.progress.value;V.preSave&&(V.preSave.isRunning=!1),n.success("é¢„ä¿å­˜å®Œæˆï¼Œå¼€å§‹ç¿»è¯‘...")},onError:V=>{const q=i.progress.value;q.preSave=void 0,n.warning(`é¢„ä¿å­˜å¤±è´¥ï¼š${V}ï¼Œç¿»è¯‘å®Œæˆåè¯·æ‰‹åŠ¨ä¿å­˜`)}}))){const V=i.progress.value;V.preSave=void 0}const D=C.mode;if(console.log(`ğŸš€ å¯åŠ¨å¹¶è¡Œç¿»è¯‘æ¨¡å¼: ${D}`),console.log(`   è‡ªåŠ¨ä¿å­˜: ${O?"å¯ç”¨":"ç¦ç”¨"}`),O){const w=i.progress.value;w.save={completed:0,total:B.length}}const M=await i.executeParallel(D);return M.success>0&&M.failed===0?n.success(`å¹¶è¡Œç¿»è¯‘å®Œæˆï¼ŒæˆåŠŸå¤„ç† ${M.success} å¼ å›¾ç‰‡`):M.success>0&&M.failed>0?n.warning(`å¹¶è¡Œç¿»è¯‘å®Œæˆï¼ŒæˆåŠŸ ${M.success} å¼ ï¼Œå¤±è´¥ ${M.failed} å¼ `):n.error("å¹¶è¡Œç¿»è¯‘å¤±è´¥"),{success:M.failed===0,completed:M.success,failed:M.failed,errors:M.errors}}catch(D){const M=D instanceof Error?D.message:"å¹¶è¡Œç¿»è¯‘å‡ºé”™";return n.error(M),{success:!1,completed:0,failed:B.length,errors:[M]}}finally{const D=i.progress.value;D.preSave=void 0,D.save=void 0,O&&(console.log("[ParallelPipeline] å®Œæˆä¿å­˜..."),await En())}}function P(){o.cancel(),i.cancel(),Bn()}return{progress:o.progress,isExecuting:o.isExecuting,isTranslating:r,progressPercent:l,execute:u,cancel:P,STEP_CHAIN_CONFIGS:o.STEP_CHAIN_CONFIGS}}function zt(s="current"){return{mode:"standard",scope:s}}function gi(s){return{mode:"hq",scope:"all",batchOptions:{batchSize:3,maxRetries:2,rpmLimit:10,sessionResetFrequency:5}}}function pi(s){return{mode:"proofread",scope:"all",batchOptions:{batchSize:3,maxRetries:2,rpmLimit:10,sessionResetFrequency:5}}}function un(s="current"){return{mode:"removeText",scope:s}}function Co(){const s=Xe(),t=ct(),n=rt(),o=di(),i=o.progress,r=o.isExecuting,l=o.isTranslating,u=o.progressPercent,b=J(()=>o.isExecuting.value),P=J(()=>o.isExecuting.value);async function C(){return(await o.execute(zt("current"))).success}async function B(d){const S=s.currentImageIndex;s.setCurrentImageIndex(d);const x=await o.execute(zt("current"));return s.setCurrentImageIndex(S),x.success}async function O(){return(await o.execute(zt("all"))).success}function D(){o.cancel()}async function M(){return(await o.execute(un("current"))).success}async function w(){return(await o.execute(un("all"))).success}async function V(){return s.getFailedImageIndices().length===0?(n.info("æ²¡æœ‰å¤±è´¥çš„å›¾ç‰‡éœ€è¦é‡æ–°ç¿»è¯‘"),!0):(await o.execute(zt("failed"))).success}async function q(){return(await o.execute(gi())).success}async function N(){return(await o.execute(pi())).success}async function m(){if(!s.currentImage)return n.error("è¯·å…ˆä¸Šä¼ å›¾ç‰‡"),!1;const S=t.bubbles;return!S||S.length===0?(n.error("å½“å‰å›¾ç‰‡æ²¡æœ‰æ°”æ³¡æ¡†ï¼Œè¯·å…ˆæ£€æµ‹æˆ–æ‰‹åŠ¨æ·»åŠ "),!1):(s.setManuallyAnnotated(!0),C())}return{progress:i,isTranslatingSingle:r,isHqTranslating:b,isProofreading:P,isTranslating:l,progressPercent:u,translateCurrentImage:C,translateImageByIndex:B,translateAllImages:O,cancelBatchTranslation:D,removeTextOnly:M,removeAllTexts:w,retryFailedImages:V,executeHqTranslation:q,executeProofreading:N,translateWithCurrentBubbles:m}}function mi(){const s=ct(),t=Xe(),n=h(!1);function o(){if(!n.value)return;const i=t.currentImage;s.bubbleCount>0?t.updateCurrentBubbleStates([...s.bubbles]):i&&Array.isArray(i.bubbleStates)&&i.bubbleStates.length>0&&(t.updateCurrentBubbleStates([]),console.log("é€€å‡ºç¼–è¾‘æ¨¡å¼ï¼ˆæ— é‡æ¸²æŸ“ï¼‰ï¼Œç”¨æˆ·å·²åˆ é™¤æ‰€æœ‰æ°”æ³¡")),n.value=!1,s.clearSelection(),console.log("å·²é€€å‡ºç¼–è¾‘æ¨¡å¼ï¼ˆæ— é‡æ¸²æŸ“ï¼‰")}return{isActive:n,exitEditModeWithoutRender:o}}function vi(){const s=mn(),t=Le(),n=Xe(),o=qt(),i=ct(),r=mi(),l=h(!1),u=h(!1),b=h(null),P=h([]),C=h([]),B=h([]),O=h(null),D=h(null),M=h(null),w=h(null),V=h(!1);async function q(Q=!1){if(!Q&&(l.value||u.value)){console.log("[TranslateInit] å·²ç»åˆå§‹åŒ–ï¼Œä»…é‡æ–°åŠ è½½ä¸Šä¸‹æ–‡"),await x();return}console.log("[TranslateInit] å¼€å§‹åˆå§‹åŒ–åº”ç”¨..."),l.value=!0,b.value=null;try{await N(),await m(),await d(),await S(),await x(),console.log("[TranslateInit] åº”ç”¨åˆå§‹åŒ–å®Œæˆ"),u.value=!0}catch(T){console.error("[TranslateInit] åº”ç”¨åˆå§‹åŒ–å¤±è´¥:",T),b.value=T instanceof Error?T.message:"åˆå§‹åŒ–å¤±è´¥"}finally{l.value=!1}}async function N(){console.log("[TranslateInit] åˆå§‹åŒ–è®¾ç½®..."),t.initSettings();try{const Q=await t.loadFromBackend();console.log(Q?"[TranslateInit] å·²ä»åç«¯åŠ è½½è®¾ç½®":"[TranslateInit] åç«¯æ— è®¾ç½®ï¼Œä½¿ç”¨ localStorage æ•°æ®")}catch(Q){console.warn("[TranslateInit] ä»åç«¯åŠ è½½è®¾ç½®å¤±è´¥ï¼Œä½¿ç”¨ localStorage æ•°æ®:",Q)}console.log("[TranslateInit] è®¾ç½®åˆå§‹åŒ–å®Œæˆ")}async function m(){console.log("[TranslateInit] åˆå§‹åŒ–å­—ä½“åˆ—è¡¨...");try{const Q=await hn();Q.fonts&&Q.fonts.length>0?(P.value=Q.fonts,console.log(`[TranslateInit] å·²åŠ è½½ ${Q.fonts.length} ä¸ªå­—ä½“`)):Q.error?console.warn("[TranslateInit] è·å–å­—ä½“åˆ—è¡¨å¤±è´¥:",Q.error):console.warn("[TranslateInit] å­—ä½“åˆ—è¡¨ä¸ºç©º")}catch(Q){console.error("[TranslateInit] è·å–å­—ä½“åˆ—è¡¨å¤±è´¥:",Q)}}async function d(){console.log("[TranslateInit] åˆå§‹åŒ–ç¿»è¯‘æç¤ºè¯è®¾ç½®...");try{const Q=await Ds();Q.prompt_names!==void 0?(C.value=Q.prompt_names||[],!t.settings.translatePrompt&&Q.default_prompt_content&&t.setTranslatePrompt(Q.default_prompt_content),console.log(`[TranslateInit] å·²åŠ è½½ ${C.value.length} ä¸ªç¿»è¯‘æç¤ºè¯`)):Q.error&&console.warn("[TranslateInit] è·å–ç¿»è¯‘æç¤ºè¯å¤±è´¥:",Q.error)}catch(Q){console.error("[TranslateInit] è·å–ç¿»è¯‘æç¤ºè¯å¤±è´¥:",Q)}}async function S(){console.log("[TranslateInit] åˆå§‹åŒ–æ–‡æœ¬æ¡†æç¤ºè¯è®¾ç½®...");try{const Q=await Is();Q.prompt_names!==void 0?(B.value=Q.prompt_names||[],!t.settings.textboxPrompt&&Q.default_prompt_content&&t.setTextboxPrompt(Q.default_prompt_content),console.log(`[TranslateInit] å·²åŠ è½½ ${B.value.length} ä¸ªæ–‡æœ¬æ¡†æç¤ºè¯`)):Q.error&&console.warn("[TranslateInit] è·å–æ–‡æœ¬æ¡†æç¤ºè¯å¤±è´¥:",Q.error)}catch(Q){console.error("[TranslateInit] è·å–æ–‡æœ¬æ¡†æç¤ºè¯å¤±è´¥:",Q)}}async function x(){const Q=s.query.book,T=s.query.chapter;if(!Q||!T){console.log("[TranslateInit] æœªæŒ‡å®šä¹¦ç±/ç« èŠ‚å‚æ•°ï¼Œä½¿ç”¨ç‹¬ç«‹æ¨¡å¼"),V.value=!1,O.value=null,D.value=null,M.value=null,w.value=null,o.clearContext();return}console.log(`[TranslateInit] æ£€æµ‹åˆ°ä¹¦ç±/ç« èŠ‚å‚æ•°: book=${Q}, chapter=${T}`),V.value=!0,O.value=Q,D.value=T;try{const k=await Ps(Q);if(!k.success||!k.book){console.warn("[TranslateInit] ä¹¦ç±ä¸å­˜åœ¨:",Q),he("ä¹¦ç±ä¸å­˜åœ¨","warning");return}const F=k.book,y=F.chapters?.find(p=>p.id===T);if(!y){console.warn("[TranslateInit] ç« èŠ‚ä¸å­˜åœ¨:",T),he("ç« èŠ‚ä¸å­˜åœ¨","warning");return}if(M.value=F.title,w.value=y.title,o.setBookChapterContext(Q,T,F.title,y.title),typeof document<"u"&&(document.title=`${y.title} - ${F.title} - Saber-Translator`),y.session_path){console.log(`[TranslateInit] å°è¯•åŠ è½½ç« èŠ‚ä¼šè¯: ${y.session_path}`);try{await o.loadSessionByPath(y.session_path),he(`å·²åŠ è½½ç« èŠ‚: ${y.title}`,"success")}catch{console.log("[TranslateInit] ç« èŠ‚ä¼šè¯æ•°æ®ä¸å­˜åœ¨æˆ–åŠ è½½å¤±è´¥ï¼Œå°†åˆ›å»ºæ–°ä¼šè¯")}}}catch(k){console.error("[TranslateInit] åŠ è½½ä¹¦ç±/ç« èŠ‚ä¿¡æ¯å¤±è´¥:",k),he("åŠ è½½ä¹¦ç±ä¿¡æ¯å¤±è´¥","error")}}function K(Q){if(Q<0||Q>=n.imageCount){console.warn(`[TranslateInit] æ— æ•ˆçš„å›¾ç‰‡ç´¢å¼•: ${Q}`);return}window._isChangingFromSwitchImage=!0,r.isActive.value&&r.exitEditModeWithoutRender(),n.currentImage&&i.bubbles.length>0&&n.updateCurrentImageProperty("bubbleStates",i.bubbles),n.setCurrentImageIndex(Q);const k=n.currentImage;if(!k){console.warn("[TranslateInit] åˆ‡æ¢åˆ°çš„å›¾ç‰‡ä¸å­˜åœ¨"),window._isChangingFromSwitchImage=!1;return}console.log(`[TranslateInit] åˆ‡æ¢åˆ°å›¾ç‰‡: ${Q}, ${k.fileName}`),k.bubbleStates&&k.bubbleStates.length>0?i.setBubbles(k.bubbleStates,!0):i.clearBubblesLocal(),G(k),setTimeout(()=>{window._isChangingFromSwitchImage=!1,console.log("[TranslateInit] å·²é‡ç½®åˆ‡æ¢å›¾ç‰‡æ“ä½œæ ‡è®°")},100)}function G(Q){if(!Q)return;const T=Q.bubbleStates?.[0];T&&t.updateTextStyle({fontSize:T.fontSize||t.settings.textStyle.fontSize,fontFamily:T.fontFamily||t.settings.textStyle.fontFamily,layoutDirection:Q.layoutDirection||t.settings.textStyle.layoutDirection,textColor:T.textColor||t.settings.textStyle.textColor,fillColor:T.fillColor||t.settings.textStyle.fillColor,strokeEnabled:T.strokeEnabled??t.settings.textStyle.strokeEnabled,strokeColor:T.strokeColor||t.settings.textStyle.strokeColor,strokeWidth:T.strokeWidth||t.settings.textStyle.strokeWidth,inpaintMethod:T.inpaintMethod||t.settings.textStyle.inpaintMethod,autoFontSize:Q.autoFontSize??t.settings.textStyle.autoFontSize,useAutoTextColor:Q.useAutoTextColor??t.settings.textStyle.useAutoTextColor})}function ie(){n.canGoPrevious&&K(n.currentImageIndex-1)}function Z(){n.canGoNext&&K(n.currentImageIndex+1)}function le(){ut(async()=>{await q()})}return{isInitializing:l,isInitialized:u,initError:b,fontList:P,promptNames:C,textboxPromptNames:B,currentBookId:O,currentChapterId:D,currentBookTitle:M,currentChapterTitle:w,isBookshelfMode:V,initializeApp:q,initializeSettings:N,initializeFontList:m,initializePromptSettings:d,initializeTextboxPromptSettings:S,initializeBookChapterContext:x,switchImage:K,goToPrevious:ie,goToNext:Z,loadImageSettingsToStore:G,editMode:r,setupAutoInit:le}}const fi={key:0,id:"translationProgressBar",class:"translation-progress-bar"},bi={class:"parallel-header"},hi={class:"header-title"},yi={key:0,class:"presave-section"},xi={class:"presave-label"},_i={class:"presave-progress-bar"},Ci={class:"pools-list"},Si={class:"pool-label"},ki={class:"pool-icon"},wi={class:"pool-name"},$i={class:"pool-progress-bar"},Ti={class:"pool-stats"},Ii={class:"completed-count"},Di={class:"total-count"},Ri={key:0,class:"waiting-badge"},Pi={key:1,class:"lock-indicator",title:"ç­‰å¾…æ·±åº¦å­¦ä¹ é”"},Mi={key:0,class:"pool-row save-row"},Ei={class:"pool-progress-bar"},Bi={class:"pool-stats"},Ai={class:"completed-count"},Li={class:"total-count"},Fi={class:"overall-section"},Ui={class:"overall-label"},Oi={key:0,class:"failed-text"},zi={class:"overall-progress-bar"},Ni={class:"progress-bar-label"},Vi={key:0,class:"failed-count"},Wi={class:"progress-bar"},Ki=He({__name:"TranslationProgress",props:{progress:{}},setup(s){const t=s,n=Xe(),o=Le(),i=Co(),r=_o(),l=J(()=>o.settings.parallel?.enabled&&r.isRunning.value),u=J(()=>r.progress.value),b=J(()=>{const d=u.value;return!d||d.totalPages===0?0:Math.round(d.totalCompleted/d.totalPages*100)});function P(d){const S=u.value?.totalPages||0;return S===0?0:Math.round(d.completed/S*100)}function C(){const d=u.value?.totalPages||0;return d===0?0:Math.max(3,Math.round(1/d*100))}function B(){const d=u.value?.preSave;return!d||d.total===0?0:Math.round(d.current/d.total*100)}function O(){const d=u.value?.save;return!d||d.total===0?0:Math.round(d.completed/d.total*100)}const D=J(()=>t.progress||i.progress.value),M=J(()=>D.value.isInProgress||n.isBatchTranslationInProgress||l.value),w=J(()=>D.value.current),V=J(()=>D.value.total),q=J(()=>D.value.failed),N=J(()=>D.value.percentage!==void 0?D.value.percentage:V.value===0?0:Math.round(w.value/V.value*100)),m=J(()=>D.value.label?D.value.label:`ç¿»è¯‘ä¸­ï¼š${w.value} / ${V.value}`);return(d,S)=>M.value?(E(),U("div",fi,[l.value&&u.value?(E(),U(Ae,{key:0},[e("div",bi,[e("span",hi,"ğŸš€ å¹¶è¡Œç¿»è¯‘ä¸­ï¼š"+ne(u.value.totalCompleted)+"/"+ne(u.value.totalPages),1)]),u.value.preSave?.isRunning?(E(),U("div",yi,[e("div",xi," ğŸ“¥ é¢„ä¿å­˜åŸå§‹å›¾ç‰‡ï¼š"+ne(u.value.preSave.current)+"/"+ne(u.value.preSave.total),1),e("div",_i,[e("div",{class:"presave-progress-fill",style:tt({width:B()+"%"})},null,4)])])):de("",!0),e("div",Ci,[(E(!0),U(Ae,null,Je(u.value.pools,x=>(E(),U("div",{key:x.name,class:De(["pool-row",{"pool-processing":x.processing,"pool-waiting-lock":x.isWaitingLock}])},[e("div",Si,[e("span",ki,ne(x.icon),1),e("span",wi,ne(x.name),1)]),e("div",$i,[e("div",{class:"progress-completed",style:tt({width:P(x)+"%"})},null,4),x.processing?(E(),U("div",{key:0,class:"progress-processing",style:tt({left:P(x)+"%",width:C()+"%"})},null,4)):de("",!0)]),e("div",Ti,[e("span",Ii,ne(x.completed),1),e("span",Di,"/ "+ne(u.value.totalPages),1),x.waiting>0?(E(),U("span",Ri,"+"+ne(x.waiting),1)):de("",!0),x.isWaitingLock?(E(),U("span",Pi,"ğŸ”’")):de("",!0)])],2))),128)),u.value.save?(E(),U("div",Mi,[S[0]||(S[0]=e("div",{class:"pool-label"},[e("span",{class:"pool-icon"},"ğŸ’¾"),e("span",{class:"pool-name"},"ä¿å­˜")],-1)),e("div",Ei,[e("div",{class:"progress-completed save-progress",style:tt({width:O()+"%"})},null,4)]),e("div",Bi,[e("span",Ai,ne(u.value.save.completed),1),e("span",Li,"/ "+ne(u.value.save.total),1)])])):de("",!0)]),S[1]||(S[1]=e("div",{class:"divider"},null,-1)),e("div",Fi,[e("div",Ui,[pe(" æ€»è¿›åº¦ï¼š"+ne(b.value)+"% ",1),u.value.totalFailed>0?(E(),U("span",Oi," ï¼ˆ"+ne(u.value.totalFailed)+" å¤±è´¥ï¼‰ ",1)):de("",!0)]),e("div",zi,[e("div",{class:"overall-progress-fill",style:tt({width:b.value+"%"})},null,4)])])],64)):(E(),U(Ae,{key:1},[e("div",Ni,[pe(ne(m.value)+" ",1),q.value>0?(E(),U("span",Vi,"ï¼ˆ"+ne(q.value)+" å¼ å¤±è´¥ï¼‰",1)):de("",!0)]),e("div",Wi,[e("div",{class:"progress",style:tt({width:`${N.value}%`})},null,4)])],64))])):de("",!0)}}),qi=qe(Ki,[["__scopeId","data-v-f25371f6"]]),Hi=He({__name:"SponsorModal",emits:["close"],setup(s,{emit:t}){const n=t;return(o,i)=>(E(),st(yn,{title:"æ”¯æŒä½œè€…",onClose:i[1]||(i[1]=r=>n("close"))},{footer:_t(()=>[e("button",{type:"button",class:"btn btn-primary",onClick:i[0]||(i[0]=r=>n("close"))},"å…³é—­")]),default:_t(()=>[i[2]||(i[2]=e("div",{class:"sponsor-content"},[e("p",{class:"sponsor-message"}," å¦‚æœè¿™ä¸ªé¡¹ç›®å¯¹ä½ æœ‰å¸®åŠ©ï¼Œæ¬¢è¿è¯·ä½œè€…å–æ¯å’–å•¡ â˜• "),e("div",{class:"qr-codes"},[e("div",{class:"qr-item"},[e("div",{class:"qr-image"},[e("img",{src:"/pic/wechat_qrcode.png",alt:"å¾®ä¿¡æ”¯ä»˜"})]),e("span",{class:"qr-label"},"å¾®ä¿¡æ”¯ä»˜")]),e("div",{class:"qr-item"},[e("div",{class:"qr-image"},[e("img",{src:"/pic/alipay_qrcode.png",alt:"æ”¯ä»˜å®"})]),e("span",{class:"qr-label"},"æ”¯ä»˜å®")])]),e("p",{class:"sponsor-thanks"},"æ„Ÿè°¢æ‚¨çš„æ”¯æŒï¼ğŸ™")],-1))]),_:1}))}}),ji=qe(Hi,[["__scopeId","data-v-02b6948e"]]);function Ji(s){const t=h(""),n=J(()=>s.value.some(D=>D.folderPath)),o=J(()=>{if(!n.value)return null;const D={name:"æ ¹ç›®å½•",path:"",images:[],subfolders:[]},M=new Map;M.set("",D);for(const w of s.value){const V=w.folderPath||"";if(V&&!M.has(V)){const q=V.split("/");let N="";for(const m of q){const d=N;if(N=N?`${N}/${m}`:m,!M.has(N)){const S={name:m,path:N,images:[],subfolders:[]};M.set(N,S),M.has(d)&&M.get(d).subfolders.push(S)}}}M.has(V)&&M.get(V).images.push(w)}return D}),i=J(()=>{if(!t.value)return[{name:"æ ¹ç›®å½•",path:""}];const D=t.value.split("/"),M=[{name:"æ ¹ç›®å½•",path:""}];let w="";for(const V of D)w=w?`${w}/${V}`:V,M.push({name:V,path:w});return M}),r=J(()=>{if(!o.value)return null;if(!t.value)return o.value;const D=(M,w)=>{if(M.path===w)return M;for(const V of M.subfolders){const q=D(V,w);if(q)return q}return null};return D(o.value,t.value)}),l=J(()=>r.value?.subfolders||[]),u=J(()=>r.value?.images||[]);function b(D){t.value=D}function P(){if(!t.value)return;const D=t.value.lastIndexOf("/");t.value=D>0?t.value.substring(0,D):""}function C(D){t.value=D}function B(D){let M=D.images.length;for(const w of D.subfolders)M+=B(w);return M}function O(){t.value=""}return{currentFolderPath:t,useTreeMode:n,folderTree:o,breadcrumbs:i,currentFolder:r,currentSubfolders:l,currentImages:u,enterFolder:b,goUp:P,navigateTo:C,getFolderImageCount:B,resetToRoot:O}}const Yi={id:"thumbnail-sidebar",class:"thumbnail-sidebar"},Xi={class:"card thumbnail-card"},Gi={class:"breadcrumb-nav"},Zi=["onClick"],Qi={key:0,class:"breadcrumb-sep"},er=["onClick"],tr={class:"folder-info"},or=["title"],nr={class:"folder-count"},sr=["title","onClick"],ar=["src","alt"],lr={key:1,class:"translation-failed-indicator"},ir={key:2,class:"labeled-indicator"},rr={key:3,class:"thumbnail-processing-indicator"},ur={key:0,class:"empty-folder"},cr=["title","data-index","onClick"],dr=["src","alt"],gr={key:1,class:"translation-failed-indicator"},pr={key:2,class:"labeled-indicator"},mr={key:3,class:"thumbnail-processing-indicator"},vr={key:2,class:"empty-state"},fr=He({__name:"ThumbnailSidebar",emits:["select"],setup(s,{emit:t}){const n=t,o=Xe(),i=h(null),r=h([]),l=J(()=>o.images),u=J(()=>o.currentImageIndex),b=J(()=>o.hasImages),{useTreeMode:P,breadcrumbs:C,currentSubfolders:B,currentImages:O,currentFolderPath:D,enterFolder:M,goUp:w,navigateTo:V,getFolderImageCount:q,folderTree:N,resetToRoot:m}=Ji(l);Se(()=>l.value.length,(T,k)=>{(T===0||k===0&&T>0)&&m()});function d(T){return l.value.findIndex(k=>k.id===T.id)}function S(T){return T.translationFailed?"failed":T.isManuallyAnnotated?"labeled":T.translationStatus==="processing"?"processing":null}function x(T){n("select",T)}function K(T){M(T.path)}function G(T){V(T)}function ie(){gt(()=>{const T=r.value[u.value];if(T&&i.value){const k=i.value,F=T.offsetTop-k.clientHeight/2+T.clientHeight/2;k.scrollTo({top:Math.max(0,F),behavior:"smooth"})}})}function Z(T,k){r.value[k]=T}function le(T){const k=[];return T.translationFailed&&k.push("translation-failed"),T.isManuallyAnnotated&&k.push("has-manual-labels"),k}function Q(T){return T.translationFailed?"ç¿»è¯‘å¤±è´¥ï¼Œç‚¹å‡»å¯é‡è¯•":T.isManuallyAnnotated?"åŒ…å«æ‰‹åŠ¨æ ‡æ³¨":T.fileName||""}return Se(u,()=>{ie()}),ut(()=>{b.value&&ie()}),(T,k)=>(E(),U("aside",Yi,[e("div",Xi,[k[5]||(k[5]=e("h2",null,"å›¾ç‰‡æ¦‚è§ˆ",-1)),b.value&&H(P)&&H(N)?(E(),U(Ae,{key:0},[e("div",Gi,[(E(!0),U(Ae,null,Je(H(C),(F,y)=>(E(),U(Ae,{key:F.path},[e("span",{class:De(["breadcrumb-item",{active:y===H(C).length-1}]),onClick:p=>y<H(C).length-1&&G(F.path)},ne(y===0?"ğŸ“":"")+ne(F.name),11,Zi),y<H(C).length-1?(E(),U("span",Qi,"/")):de("",!0)],64))),128))]),H(D)?(E(),U("div",{key:0,class:"folder-back-btn",onClick:k[0]||(k[0]=(...F)=>H(w)&&H(w)(...F))},[...k[1]||(k[1]=[e("span",{class:"back-icon"},"â¬…ï¸",-1),e("span",null,"è¿”å›ä¸Šçº§",-1)])])):de("",!0),e("div",{ref_key:"containerRef",ref:i,class:"folder-content-list"},[(E(!0),U(Ae,null,Je(H(B),F=>(E(),U("div",{key:F.path,class:"folder-item",onClick:y=>K(F)},[k[2]||(k[2]=e("span",{class:"folder-icon"},"ğŸ“",-1)),e("div",tr,[e("span",{class:"folder-name",title:F.name},ne(F.name),9,or),e("span",nr,"("+ne(H(q)(F))+")",1)])],8,er))),128)),(E(!0),U(Ae,null,Je(H(O),F=>(E(),U("div",{key:F.id,ref_for:!0,ref:y=>Z(y,d(F)),class:De(["thumbnail-item",[{active:d(F)===u.value},...le(F)]]),title:Q(F),onClick:y=>x(d(F))},[F.originalDataURL?(E(),U("img",{key:0,src:F.originalDataURL,alt:F.fileName,class:"thumbnail-image"},null,8,ar)):de("",!0),S(F)==="failed"?(E(),U("span",lr,"!")):S(F)==="labeled"?(E(),U("span",ir,"âœï¸")):de("",!0),S(F)==="processing"?(E(),U("div",rr,"âŸ³")):de("",!0)],10,sr))),128)),H(B).length===0&&H(O).length===0?(E(),U("div",ur,[...k[3]||(k[3]=[e("p",null,"æ­¤æ–‡ä»¶å¤¹ä¸ºç©º",-1)])])):de("",!0)],512)],64)):b.value?(E(),U("ul",{key:1,ref_key:"containerRef",ref:i,id:"thumbnailList",class:"thumbnail-list"},[(E(!0),U(Ae,null,Je(l.value,(F,y)=>(E(),U("li",{key:F.id,ref_for:!0,ref:p=>Z(p,y),class:De(["thumbnail-item",[{active:y===u.value},...le(F)]]),title:Q(F),"data-index":y,onClick:p=>x(y)},[F.originalDataURL?(E(),U("img",{key:0,src:F.originalDataURL,alt:F.fileName,class:"thumbnail-image"},null,8,dr)):de("",!0),S(F)==="failed"?(E(),U("span",gr,"!")):S(F)==="labeled"?(E(),U("span",pr,"âœï¸")):de("",!0),S(F)==="processing"?(E(),U("div",mr," âŸ³ ")):de("",!0)],10,cr))),128))],512)):(E(),U("div",vr,[...k[4]||(k[4]=[e("p",null,"æš‚æ— å›¾ç‰‡",-1)])]))])]))}}),br=qe(fr,[["__scopeId","data-v-6aa1c6be"]]),hr={class:"saved-prompts-picker"},yr={class:"prompts-chips-container"},xr={key:0,class:"empty-hint"},_r={key:1,class:"empty-hint"},Cr=["title","onClick"],Sr=He({__name:"SavedPromptsPicker",props:{promptType:{}},emits:["select"],setup(s,{expose:t,emit:n}){const o=s,i=n,r=h([]),l=h(!1);async function u(){l.value=!0;try{let P;o.promptType==="textbox"?P=await We.getTextboxPrompts():P=await We.getPrompts(o.promptType);const C=P.prompt_names||[];r.value=C.map(B=>({name:B}))}catch(P){console.error("åŠ è½½æç¤ºè¯åˆ—è¡¨å¤±è´¥:",P),r.value=[]}finally{l.value=!1}}async function b(P){try{let C;o.promptType==="textbox"?C=await We.getTextboxPromptContent(P):C=await We.getPromptContent(o.promptType,P),C.prompt_content&&i("select",C.prompt_content,P)}catch(C){console.error("åŠ è½½æç¤ºè¯å†…å®¹å¤±è´¥:",C)}}return Se(()=>o.promptType,()=>{u()}),ut(()=>{u()}),t({refresh:u}),(P,C)=>(E(),U("div",hr,[C[1]||(C[1]=e("span",{class:"picker-label"},"ğŸ“‘ å¿«é€Ÿé€‰æ‹©:",-1)),e("div",yr,[l.value?(E(),U("span",xr,"åŠ è½½ä¸­...")):r.value.length===0?(E(),U("span",_r,"æš‚æ— ä¿å­˜çš„æç¤ºè¯")):(E(!0),U(Ae,{key:2},Je(r.value,B=>(E(),U("button",{key:B.name,type:"button",class:"prompt-chip",title:B.name,onClick:O=>b(B.name)},[C[0]||(C[0]=e("span",{class:"chip-icon"},"ğŸ“",-1)),pe(" "+ne(B.name),1)],8,Cr))),128))])]))}}),Bt=qe(Sr,[["__scopeId","data-v-2ebbb8b3"]]),kr={class:"ocr-settings"},wr={class:"settings-group"},$r={class:"settings-item"},Tr={class:"settings-item"},Ir={class:"input-hint"},Dr={class:"settings-group"},Rr={class:"settings-row"},Pr={class:"settings-item"},Mr={class:"password-input-wrapper"},Er=["type"],Br={key:0,class:"eye-icon"},Ar={key:1,class:"eye-off-icon"},Lr={class:"settings-item"},Fr={class:"password-input-wrapper"},Ur=["type"],Or={key:0,class:"eye-icon"},zr={key:1,class:"eye-off-icon"},Nr={class:"settings-row"},Vr={class:"settings-item"},Wr={class:"settings-item"},Kr=["disabled"],qr={class:"settings-group"},Hr={class:"settings-row"},jr={class:"settings-item"},Jr={class:"settings-item"},Yr={class:"password-input-wrapper"},Xr=["type"],Gr={key:0,class:"eye-icon"},Zr={key:1,class:"eye-off-icon"},Qr={class:"settings-item"},eu={class:"settings-item"},tu={class:"model-input-with-fetch"},ou=["disabled"],nu={class:"fetch-text"},su={key:0,class:"model-select-container"},au={class:"model-count"},lu={class:"settings-item"},iu={class:"prompt-format-selector"},ru={class:"settings-item"},uu={class:"settings-item"},cu=["disabled"],du=He({__name:"OcrSettings",setup(s){const t=[{label:"MangaOCR (æ—¥è¯­ä¸“ç”¨)",value:"manga_ocr"},{label:"PaddleOCR (å¤šè¯­è¨€)",value:"paddle_ocr"},{label:"PaddleOCR-VL (æ—¥æ¼«ä¸“ç”¨)",value:"paddleocr_vl"},{label:"ç™¾åº¦OCR",value:"baidu_ocr"},{label:"48px OCR",value:"48px_ocr"},{label:"AIè§†è§‰OCR",value:"ai_vision"}],n=[{label:"æ ‡å‡†ç‰ˆ",value:"standard"},{label:"é«˜ç²¾åº¦ç‰ˆ",value:"high_precision"}],o=[{label:"è‡ªåŠ¨æ£€æµ‹",value:"auto_detect"},{label:"ä¸­è‹±æ–‡æ··åˆ",value:"CHN_ENG"},{label:"è‹±æ–‡",value:"ENG"},{label:"æ—¥è¯­",value:"JAP"},{label:"éŸ©è¯­",value:"KOR"},{label:"æ³•è¯­",value:"FRE"},{label:"å¾·è¯­",value:"GER"},{label:"ä¿„è¯­",value:"RUS"}],i=[{label:"SiliconFlow (ç¡…åŸºæµåŠ¨)",value:"siliconflow"},{label:"ç«å±±å¼•æ“",value:"volcano"},{label:"Google Gemini",value:"gemini"},{label:"è‡ªå®šä¹‰ OpenAI å…¼å®¹æœåŠ¡",value:"custom_openai_vision"}],r=[{label:"æ™®é€šæç¤ºè¯",value:"false"},{label:"JSONæç¤ºè¯",value:"true"}],l=[{label:"ğŸš€ å¸¸ç”¨è¯­è¨€",options:[{label:"æ—¥è¯­",value:"japanese"},{label:"è‹±è¯­",value:"en"},{label:"ç®€ä½“ä¸­æ–‡",value:"chinese"},{label:"ç¹ä½“ä¸­æ–‡",value:"chinese_cht"},{label:"éŸ©è¯­",value:"korean"}]},{label:"ğŸŒ æ‹‰ä¸è¯­ç³»",options:[{label:"æ³•è¯­",value:"french"},{label:"å¾·è¯­",value:"german"},{label:"è¥¿ç­ç‰™è¯­",value:"spanish"},{label:"æ„å¤§åˆ©è¯­",value:"italian"},{label:"è‘¡è„ç‰™è¯­",value:"portuguese"}]},{label:"ğŸŒ å…¶ä»–è¯­ç³»",options:[{label:"ä¿„è¯­",value:"russian"}]}],u=Le(),b=rt(),P=h({apiKey:u.settings.baiduOcr.apiKey,secretKey:u.settings.baiduOcr.secretKey,version:u.settings.baiduOcr.version,sourceLanguage:u.settings.baiduOcr.sourceLanguage}),C=h({apiKey:u.settings.aiVisionOcr.apiKey,modelName:u.settings.aiVisionOcr.modelName,customBaseUrl:u.settings.aiVisionOcr.customBaseUrl,prompt:u.settings.aiVisionOcr.prompt,rpmLimit:u.settings.aiVisionOcr.rpmLimit,minImageSize:u.settings.aiVisionOcr.minImageSize}),B=J(()=>u.settings);Se(()=>P.value.apiKey,T=>{u.updateBaiduOcr({apiKey:T})}),Se(()=>P.value.secretKey,T=>{u.updateBaiduOcr({secretKey:T})}),Se(()=>P.value.version,T=>{u.updateBaiduOcr({version:T})}),Se(()=>P.value.sourceLanguage,T=>{u.updateBaiduOcr({sourceLanguage:T})}),Se(()=>C.value.apiKey,T=>{u.updateAiVisionOcr({apiKey:T})}),Se(()=>C.value.modelName,T=>{u.updateAiVisionOcr({modelName:T})}),Se(()=>C.value.customBaseUrl,T=>{u.updateAiVisionOcr({customBaseUrl:T})}),Se(()=>C.value.prompt,T=>{u.updateAiVisionOcr({prompt:T})}),Se(()=>C.value.rpmLimit,T=>{u.updateAiVisionOcr({rpmLimit:T})}),Se(()=>C.value.minImageSize,T=>{u.updateAiVisionOcr({minImageSize:T})});const O=h(!1),D=h(!1),M=h(!1),w=h(!1),V=h(!1),q=h([]),N=J(()=>{const T=[{label:"-- é€‰æ‹©æ¨¡å‹ --",value:""}];return q.value.forEach(k=>{T.push({label:k,value:k})}),T});function m(){u.saveToStorage()}function d(){u.saveToStorage()}function S(){switch(u.settings.ocrEngine){case"manga_ocr":return"MangaOCR ä¸“ä¸ºæ—¥è¯­æ¼«ç”»ä¼˜åŒ–ï¼Œæºè¯­è¨€è®¾ç½®ä¸å½±å“è¯†åˆ«";case"paddle_ocr":return"PaddleOCR ä¼šæ ¹æ®æºè¯­è¨€åŠ è½½å¯¹åº”çš„è¯†åˆ«æ¨¡å‹";case"paddleocr_vl":return"PaddleOCR-VL åŸºäº VLM å¾®è°ƒï¼Œä¸“ä¸ºæ—¥è¯­æ¼«ç”»ä¼˜åŒ–ï¼Œå‡†ç¡®ç‡é«˜è¾¾ 70%";case"baidu_ocr":return"ç™¾åº¦OCR ä½¿ç”¨ç‹¬ç«‹çš„æºè¯­è¨€è®¾ç½®ï¼ˆè§ä¸‹æ–¹ï¼‰";case"ai_vision":return"AIè§†è§‰OCR é€šè¿‡æç¤ºè¯æŒ‡å®šè¯†åˆ«è¯­è¨€";case"48px_ocr":return"48px OCR æ”¯æŒæ—¥ä¸­è‹±éŸ©ç­‰å¤šè¯­è¨€ï¼Œæºè¯­è¨€è®¾ç½®ä¸å½±å“è¯†åˆ«";default:return"é€‰æ‹©è¦è¯†åˆ«çš„åŸæ–‡è¯­è¨€"}}function x(T){u.setAiVisionOcrProvider(T),q.value=[],K()}function K(){C.value.apiKey=u.settings.aiVisionOcr.apiKey,C.value.modelName=u.settings.aiVisionOcr.modelName,C.value.customBaseUrl=u.settings.aiVisionOcr.customBaseUrl,C.value.prompt=u.settings.aiVisionOcr.prompt,C.value.rpmLimit=u.settings.aiVisionOcr.rpmLimit,C.value.minImageSize=u.settings.aiVisionOcr.minImageSize}function G(){const T=u.settings.aiVisionOcr.isJsonMode?us:cs;u.updateAiVisionOcr({prompt:T}),C.value.prompt=T}async function ie(){const T=P.value.apiKey?.trim(),k=P.value.secretKey?.trim();if(!T||!k){b.warning("è¯·å¡«å†™ç™¾åº¦OCRçš„API Keyå’ŒSecret Key");return}w.value=!0,b.info("æ­£åœ¨æµ‹è¯•ç™¾åº¦OCRè¿æ¥...");try{const F=await We.testBaiduOcrConnection(T,k);F.success?b.success(F.message||"ç™¾åº¦OCRè¿æ¥æˆåŠŸ!"):b.error(F.message||F.error||"ç™¾åº¦OCRè¿æ¥å¤±è´¥")}catch(F){const y=F instanceof Error?F.message:"è¿æ¥æµ‹è¯•å¤±è´¥";b.error(y)}finally{w.value=!1}}async function Z(){w.value=!0;try{const T=await We.testAiVisionOcrConnection({provider:u.settings.aiVisionOcr.provider,apiKey:C.value.apiKey,modelName:C.value.modelName,customBaseUrl:C.value.customBaseUrl,prompt:C.value.prompt});T.success?b.success("AIè§†è§‰OCRè¿æ¥æˆåŠŸ"):b.error(`AIè§†è§‰OCRè¿æ¥å¤±è´¥: ${T.error||"æœªçŸ¥é”™è¯¯"}`)}catch(T){const k=T instanceof Error?T.message:"è¿æ¥æµ‹è¯•å¤±è´¥";b.error(k)}finally{w.value=!1}}async function le(){const T=u.settings.aiVisionOcr.provider,k=C.value.apiKey?.trim(),F=C.value.customBaseUrl?.trim();if(!k){b.warning("è¯·å…ˆå¡«å†™ API Key");return}if(!["siliconflow","volcano","gemini","custom_openai_vision"].includes(T)){b.warning("å½“å‰æœåŠ¡å•†ä¸æ”¯æŒè‡ªåŠ¨è·å–æ¨¡å‹åˆ—è¡¨");return}if(T==="custom_openai_vision"&&!F){b.warning("è‡ªå®šä¹‰æœåŠ¡éœ€è¦å…ˆå¡«å†™ Base URL");return}V.value=!0;try{const p=await We.fetchModels(T,k,F);p.success&&p.models&&p.models.length>0?(q.value=p.models.map(a=>a.id),b.success(`è·å–åˆ° ${p.models.length} ä¸ªæ¨¡å‹`)):b.warning(p.message||"æœªè·å–åˆ°å¯ç”¨æ¨¡å‹")}catch(p){const a=p instanceof Error?p.message:"è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥";b.error(a)}finally{V.value=!1}}function Q(T,k){u.updateAiVisionOcr({prompt:T}),C.value.prompt=T,b.success(`å·²åº”ç”¨æç¤ºè¯: ${k}`)}return(T,k)=>(E(),U("div",kr,[e("div",wr,[k[20]||(k[20]=e("div",{class:"settings-group-title"},"OCRå¼•æ“é€‰æ‹©",-1)),e("div",$r,[k[18]||(k[18]=e("label",{for:"settingsOcrEngine"},"OCRå¼•æ“:",-1)),Ce(Ne,{"model-value":B.value.ocrEngine,options:t,onChange:k[0]||(k[0]=F=>{B.value.ocrEngine=F,m()})},null,8,["model-value"])]),ae(e("div",Tr,[k[19]||(k[19]=e("label",{for:"settingsSourceLanguage"},"æºè¯­è¨€:",-1)),Ce(Ne,{"model-value":B.value.sourceLanguage,groups:l,onChange:k[1]||(k[1]=F=>{B.value.sourceLanguage=F,d()})},null,8,["model-value"]),e("div",Ir,ne(S()),1)],512),[[Ue,B.value.ocrEngine==="paddle_ocr"]])]),ae(e("div",Dr,[k[25]||(k[25]=e("div",{class:"settings-group-title"},"ç™¾åº¦OCR è®¾ç½®",-1)),e("div",Rr,[e("div",Pr,[k[21]||(k[21]=e("label",{for:"settingsBaiduApiKey"},"API Key:",-1)),e("div",Mr,[ae(e("input",{type:O.value?"text":"password",id:"settingsBaiduApiKey","onUpdate:modelValue":k[2]||(k[2]=F=>P.value.apiKey=F),class:"secure-input",placeholder:"è¯·è¾“å…¥ç™¾åº¦OCR API Key",autocomplete:"off"},null,8,Er),[[kt,P.value.apiKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:k[3]||(k[3]=F=>O.value=!O.value)},[O.value?(E(),U("span",Ar,"ğŸ‘â€ğŸ—¨")):(E(),U("span",Br,"ğŸ‘"))])])]),e("div",Lr,[k[22]||(k[22]=e("label",{for:"settingsBaiduSecretKey"},"Secret Key:",-1)),e("div",Fr,[ae(e("input",{type:D.value?"text":"password",id:"settingsBaiduSecretKey","onUpdate:modelValue":k[4]||(k[4]=F=>P.value.secretKey=F),class:"secure-input",placeholder:"è¯·è¾“å…¥Secret Key",autocomplete:"off"},null,8,Ur),[[kt,P.value.secretKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:k[5]||(k[5]=F=>D.value=!D.value)},[D.value?(E(),U("span",zr,"ğŸ‘â€ğŸ—¨")):(E(),U("span",Or,"ğŸ‘"))])])])]),e("div",Nr,[e("div",Vr,[k[23]||(k[23]=e("label",{for:"settingsBaiduVersion"},"è¯†åˆ«ç‰ˆæœ¬:",-1)),Ce(Ne,{modelValue:P.value.version,"onUpdate:modelValue":k[6]||(k[6]=F=>P.value.version=F),options:n},null,8,["modelValue"])]),e("div",Wr,[k[24]||(k[24]=e("label",{for:"settingsBaiduSourceLanguage"},"æºè¯­è¨€:",-1)),Ce(Ne,{modelValue:P.value.sourceLanguage,"onUpdate:modelValue":k[7]||(k[7]=F=>P.value.sourceLanguage=F),options:o},null,8,["modelValue"])])]),e("button",{class:"settings-test-btn",onClick:ie,disabled:w.value},ne(w.value?"æµ‹è¯•ä¸­...":"ğŸ”— æµ‹è¯•è¿æ¥"),9,Kr)],512),[[Ue,B.value.ocrEngine==="baidu_ocr"]]),ae(e("div",qr,[k[37]||(k[37]=e("div",{class:"settings-group-title"},"AIè§†è§‰OCR è®¾ç½®",-1)),e("div",Hr,[e("div",jr,[k[26]||(k[26]=e("label",{for:"settingsAiVisionProvider"},"æœåŠ¡å•†:",-1)),Ce(Ne,{"model-value":B.value.aiVisionOcr.provider,options:i,onChange:k[8]||(k[8]=F=>x(F))},null,8,["model-value"])]),e("div",Jr,[k[27]||(k[27]=e("label",{for:"settingsAiVisionApiKey"},"API Key:",-1)),e("div",Yr,[ae(e("input",{type:M.value?"text":"password",id:"settingsAiVisionApiKey","onUpdate:modelValue":k[9]||(k[9]=F=>C.value.apiKey=F),class:"secure-input",placeholder:"è¯·è¾“å…¥API Key",autocomplete:"off"},null,8,Xr),[[kt,C.value.apiKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:k[10]||(k[10]=F=>M.value=!M.value)},[M.value?(E(),U("span",Zr,"ğŸ‘â€ğŸ—¨")):(E(),U("span",Gr,"ğŸ‘"))])])])]),ae(e("div",Qr,[k[28]||(k[28]=e("label",{for:"settingsCustomAiVisionBaseUrl"},"Base URL:",-1)),ae(e("input",{type:"text",id:"settingsCustomAiVisionBaseUrl","onUpdate:modelValue":k[11]||(k[11]=F=>C.value.customBaseUrl=F),placeholder:"ä¾‹å¦‚: https://api.example.com/v1"},null,512),[[ke,C.value.customBaseUrl]])],512),[[Ue,B.value.aiVisionOcr.provider==="custom_openai_vision"]]),e("div",eu,[k[30]||(k[30]=e("label",{for:"settingsAiVisionModelName"},"æ¨¡å‹åç§°:",-1)),e("div",tu,[ae(e("input",{type:"text",id:"settingsAiVisionModelName","onUpdate:modelValue":k[12]||(k[12]=F=>C.value.modelName=F),placeholder:"å¦‚: silicon-llava2-34b"},null,512),[[ke,C.value.modelName]]),e("button",{type:"button",class:"fetch-models-btn",title:"è·å–å¯ç”¨æ¨¡å‹åˆ—è¡¨",onClick:le,disabled:V.value},[k[29]||(k[29]=e("span",{class:"fetch-icon"},"ğŸ”",-1)),e("span",nu,ne(V.value?"è·å–ä¸­...":"è·å–æ¨¡å‹"),1)],8,ou)]),q.value.length>0?(E(),U("div",su,[Ce(Ne,{modelValue:C.value.modelName,"onUpdate:modelValue":k[13]||(k[13]=F=>C.value.modelName=F),options:N.value},null,8,["modelValue","options"]),e("span",au,"å…± "+ne(q.value.length)+" ä¸ªæ¨¡å‹",1)])):de("",!0)]),e("div",lu,[k[32]||(k[32]=e("label",{for:"settingsAiVisionOcrPrompt"},"OCRæç¤ºè¯:",-1)),ae(e("textarea",{id:"settingsAiVisionOcrPrompt","onUpdate:modelValue":k[14]||(k[14]=F=>C.value.prompt=F),rows:"3",placeholder:"AIè§†è§‰OCRæç¤ºè¯"},null,512),[[ke,C.value.prompt]]),Ce(Bt,{"prompt-type":"ai_vision_ocr",onSelect:Q}),e("div",iu,[Ce(Ne,{"model-value":B.value.aiVisionOcr.isJsonMode?"true":"false",options:r,onChange:k[15]||(k[15]=F=>{B.value.aiVisionOcr.isJsonMode=F==="true",G()})},null,8,["model-value"]),k[31]||(k[31]=e("span",{class:"input-hint"},"JSONæ ¼å¼è¾“å‡ºæ›´ç»“æ„åŒ–",-1))])]),e("div",ru,[k[33]||(k[33]=e("label",{for:"settingsRpmAiVisionOcr"},"RPMé™åˆ¶ (æ¯åˆ†é’Ÿè¯·æ±‚æ•°):",-1)),ae(e("input",{type:"number",id:"settingsRpmAiVisionOcr","onUpdate:modelValue":k[16]||(k[16]=F=>C.value.rpmLimit=F),min:"0",step:"1"},null,512),[[ke,C.value.rpmLimit,void 0,{number:!0}]]),k[34]||(k[34]=e("div",{class:"input-hint"},"0 è¡¨ç¤ºæ— é™åˆ¶",-1))]),e("div",uu,[k[35]||(k[35]=e("label",{for:"settingsMinImageSize"},"æœ€å°å›¾ç‰‡å°ºå¯¸ (åƒç´ ):",-1)),ae(e("input",{type:"number",id:"settingsMinImageSize","onUpdate:modelValue":k[17]||(k[17]=F=>C.value.minImageSize=F),min:"0",step:"1"},null,512),[[ke,C.value.minImageSize,void 0,{number:!0}]]),k[36]||(k[36]=e("div",{class:"input-hint"},"VLMæ¨¡å‹é€šå¸¸è¦æ±‚å›¾ç‰‡å°ºå¯¸ â‰¥28pxï¼Œè®¾ä¸º0åˆ™ä¸è‡ªåŠ¨æ”¾å¤§å°å›¾",-1))]),e("button",{class:"settings-test-btn",onClick:Z,disabled:w.value},ne(w.value?"æµ‹è¯•ä¸­...":"ğŸ”— æµ‹è¯•è¿æ¥"),9,cu)],512),[[Ue,B.value.ocrEngine==="ai_vision"]])]))}}),gu=qe(du,[["__scopeId","data-v-7aa08d65"]]),pu={class:"translation-settings"},mu={class:"settings-group"},vu={class:"settings-row"},fu={class:"settings-item"},bu={class:"settings-item"},hu={for:"settingsApiKey"},yu={class:"password-input-wrapper"},xu=["type","placeholder"],_u={key:0,class:"eye-icon"},Cu={key:1,class:"eye-off-icon"},Su={class:"settings-item"},ku={class:"settings-item"},wu={for:"settingsModelName"},$u={class:"model-input-with-fetch"},Tu=["placeholder"],Iu=["disabled"],Du={class:"fetch-text"},Ru={key:0,class:"model-select-container"},Pu={class:"model-count"},Mu={class:"settings-item"},Eu={class:"local-model-list"},Bu={key:0,class:"model-list-container"},Au=["disabled"],Lu={key:1,class:"model-hint"},Fu={key:1,class:"model-list-container"},Uu=["disabled"],Ou={key:1,class:"model-hint"},zu={class:"settings-row"},Nu={class:"settings-item"},Vu={class:"settings-item"},Wu={class:"settings-item"},Ku=["disabled"],qu={class:"settings-item"},Hu=["disabled"],ju={class:"settings-group"},Ju={class:"settings-item"},Yu={class:"prompt-format-selector"},Xu={class:"settings-item"},Gu={class:"checkbox-label"},Zu={class:"settings-item"},Qu=He({__name:"TranslationSettings",setup(s){const t=[{label:"SiliconFlow",value:"siliconflow"},{label:"DeepSeek",value:"deepseek"},{label:"ç«å±±å¼•æ“",value:"volcano"},{label:"å½©äº‘å°è¯‘",value:"caiyun"},{label:"ç™¾åº¦ç¿»è¯‘",value:"baidu_translate"},{label:"æœ‰é“ç¿»è¯‘",value:"youdao_translate"},{label:"Google Gemini",value:"gemini"},{label:"Ollama (æœ¬åœ°)",value:"ollama"},{label:"Sakura (æœ¬åœ°)",value:"sakura"},{label:"è‡ªå®šä¹‰ OpenAI å…¼å®¹æœåŠ¡",value:"custom_openai"}],n=[{label:"æ™®é€šæç¤ºè¯",value:"normal"},{label:"JSONæç¤ºè¯",value:"json"}],o=Le(),i=rt(),r=h({modelProvider:o.settings.translation.provider,apiKey:o.settings.translation.apiKey,modelName:o.settings.translation.modelName,customBaseUrl:o.settings.translation.customBaseUrl,rpmTranslation:o.settings.translation.rpmLimit,translationMaxRetries:o.settings.translation.maxRetries,promptContent:o.settings.translatePrompt,translatePromptMode:o.settings.translation.isJsonMode?"json":"normal",enableTextboxPrompt:o.settings.useTextboxPrompt,textboxPromptContent:o.settings.textboxPrompt}),l=h(!1),u=h(!1),b=h(!1),P=h([]),C=h([]),B=h([]),O=J(()=>{const p=[{label:"-- é€‰æ‹©æ¨¡å‹ --",value:""}];return P.value.forEach(a=>p.push({label:a,value:a})),p}),D=J(()=>{const p=[{label:"-- é€‰æ‹©æ¨¡å‹ --",value:""}];return C.value.forEach(a=>p.push({label:a,value:a})),p}),M=J(()=>{const p=[{label:"-- é€‰æ‹©æ¨¡å‹ --",value:""}];return B.value.forEach(a=>p.push({label:a,value:a})),p}),w=J(()=>["ollama","sakura"].includes(r.value.modelProvider)),V=J(()=>!["ollama","sakura","caiyun","baidu_translate","youdao_translate"].includes(r.value.modelProvider)),q=J(()=>["siliconflow","deepseek","volcano","gemini","custom_openai"].includes(r.value.modelProvider)),N=J(()=>{switch(r.value.modelProvider){case"baidu_translate":return"App ID";case"youdao_translate":return"App Key";case"caiyun":return"API Token";default:return"API Key"}}),m=J(()=>{switch(r.value.modelProvider){case"baidu_translate":return"è¯·è¾“å…¥ç™¾åº¦ç¿»è¯‘App ID";case"youdao_translate":return"è¯·è¾“å…¥æœ‰é“ç¿»è¯‘åº”ç”¨ID";case"caiyun":return"è¯·è¾“å…¥å½©äº‘å°è¯‘Token";default:return"è¯·è¾“å…¥API Key"}}),d=J(()=>{switch(r.value.modelProvider){case"baidu_translate":return"App Key";case"youdao_translate":return"App Secret";case"caiyun":return"æºè¯­è¨€ (å¯é€‰)";default:return"æ¨¡å‹åç§°"}}),S=J(()=>{switch(r.value.modelProvider){case"baidu_translate":return"è¯·è¾“å…¥ç™¾åº¦ç¿»è¯‘App Key";case"youdao_translate":return"è¯·è¾“å…¥æœ‰é“ç¿»è¯‘åº”ç”¨å¯†é’¥";case"caiyun":return"å¯é€‰: auto/æ—¥è¯­/è‹±è¯­";default:return"è¯·è¾“å…¥æ¨¡å‹åç§°"}});function x(){const p=r.value.modelProvider;o.setTranslationProvider(p),r.value.apiKey=o.settings.translation.apiKey,r.value.modelName=o.settings.translation.modelName,r.value.customBaseUrl=o.settings.translation.customBaseUrl,r.value.rpmTranslation=o.settings.translation.rpmLimit,r.value.translationMaxRetries=o.settings.translation.maxRetries,P.value=[]}function K(){const p=r.value.translatePromptMode==="json";p?r.value.promptContent=Vo:r.value.promptContent=Wo,o.updateTranslationService({isJsonMode:p}),o.setTranslatePrompt(r.value.promptContent)}Se(()=>r.value.apiKey,p=>{o.updateTranslationService({apiKey:p})}),Se(()=>r.value.modelName,p=>{o.updateTranslationService({modelName:p})}),Se(()=>r.value.customBaseUrl,p=>{o.updateTranslationService({customBaseUrl:p})}),Se(()=>r.value.rpmTranslation,p=>{o.updateTranslationService({rpmLimit:p})}),Se(()=>r.value.translationMaxRetries,p=>{o.updateTranslationService({maxRetries:p})}),Se(()=>r.value.promptContent,p=>{o.setTranslatePrompt(p)}),Se(()=>r.value.enableTextboxPrompt,p=>{o.setUseTextboxPrompt(p)}),Se(()=>r.value.textboxPromptContent,p=>{o.setTextboxPrompt(p)});async function G(){const p=r.value.modelProvider,a=r.value.apiKey?.trim(),v=r.value.customBaseUrl?.trim();if(!a){i.warning("è¯·å…ˆå¡«å†™ API Key");return}if(!["siliconflow","deepseek","volcano","gemini","custom_openai"].includes(p)){i.warning(`${ie(p)} ä¸æ”¯æŒè‡ªåŠ¨è·å–æ¨¡å‹åˆ—è¡¨`);return}if(p==="custom_openai"&&!v){i.warning("è‡ªå®šä¹‰æœåŠ¡éœ€è¦å…ˆå¡«å†™ Base URL");return}b.value=!0;try{const _=await We.fetchModels(p,a,v);_.success&&_.models&&_.models.length>0?(P.value=_.models.map(R=>R.id),i.success(`è·å–åˆ° ${_.models.length} ä¸ªæ¨¡å‹`)):i.warning(_.message||"æœªè·å–åˆ°å¯ç”¨æ¨¡å‹")}catch(_){const R=_ instanceof Error?_.message:"è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥";i.error(R)}finally{b.value=!1}}function ie(p){return{siliconflow:"SiliconFlow",deepseek:"DeepSeek",volcano:"ç«å±±å¼•æ“",gemini:"Google Gemini",custom_openai:"è‡ªå®šä¹‰OpenAI",ollama:"Ollama",sakura:"Sakura",caiyun:"å½©äº‘å°è¯‘",baidu_translate:"ç™¾åº¦ç¿»è¯‘",youdao_translate:"æœ‰é“ç¿»è¯‘"}[p]||p}async function Z(){b.value=!0;try{const p=await We.testOllamaConnection();p.success&&p.models?(C.value=p.models,i.success(`è·å–åˆ° ${p.models.length} ä¸ªOllamaæ¨¡å‹`)):i.error(p.error||"Ollamaè¿æ¥å¤±è´¥")}catch(p){const a=p instanceof Error?p.message:"è·å–Ollamaæ¨¡å‹å¤±è´¥";i.error(a)}finally{b.value=!1}}async function le(){b.value=!0;try{const p=await We.testSakuraConnection();p.success&&p.models?(B.value=p.models,i.success(`è·å–åˆ° ${p.models.length} ä¸ªSakuraæ¨¡å‹`)):i.error(p.error||"Sakuraè¿æ¥å¤±è´¥")}catch(p){const a=p instanceof Error?p.message:"è·å–Sakuraæ¨¡å‹å¤±è´¥";i.error(a)}finally{b.value=!1}}async function Q(){u.value=!0;try{let p;r.value.modelProvider==="ollama"?p=await We.testOllamaConnection():p=await We.testSakuraConnection(),p.success?i.success(`${r.value.modelProvider==="ollama"?"Ollama":"Sakura"} è¿æ¥æˆåŠŸ`):i.error(p.error||"è¿æ¥å¤±è´¥")}catch(p){const a=p instanceof Error?p.message:"è¿æ¥æµ‹è¯•å¤±è´¥";i.error(a)}finally{u.value=!1}}async function T(){const p=r.value.modelProvider,a=r.value.apiKey?.trim(),v=r.value.modelName?.trim(),A=r.value.customBaseUrl?.trim();if(!a){i.warning("è¯·å…ˆå¡«å†™ API Key");return}if(p!=="caiyun"&&!v){i.warning("è¯·å¡«å†™æ¨¡å‹åç§°");return}if(p==="custom_openai"&&!A){i.warning("è‡ªå®šä¹‰æœåŠ¡éœ€è¦å¡«å†™ Base URL");return}u.value=!0,i.info("æ­£åœ¨æµ‹è¯•è¿æ¥...");try{let _;switch(p){case"baidu_translate":_=await We.testBaiduTranslateConnection(a,v);break;case"youdao_translate":_=await We.testYoudaoTranslateConnection(a,v);break;default:_=await We.testAiTranslateConnection({provider:p,apiKey:a,modelName:v,baseUrl:A})}_.success?i.success(_.message||`${ie(p)} è¿æ¥æˆåŠŸ!`):i.error(_.message||_.error||"è¿æ¥å¤±è´¥")}catch(_){const R=_ instanceof Error?_.message:"è¿æ¥æµ‹è¯•å¤±è´¥";i.error(R)}finally{u.value=!1}}function k(p,a){r.value.promptContent=p,i.success(`å·²åº”ç”¨æç¤ºè¯: ${a}`)}function F(p,a){r.value.textboxPromptContent=p,i.success(`å·²åº”ç”¨æç¤ºè¯: ${a}`)}function y(){r.value.translatePromptMode==="json"?r.value.promptContent=Vo:r.value.promptContent=Wo,i.success("å·²é‡ç½®ä¸ºé»˜è®¤æç¤ºè¯")}return(p,a)=>(E(),U("div",pu,[e("div",mu,[a[21]||(a[21]=e("div",{class:"settings-group-title"},"ç¿»è¯‘æœåŠ¡é…ç½®",-1)),e("div",vu,[e("div",fu,[a[14]||(a[14]=e("label",{for:"settingsModelProvider"},"ç¿»è¯‘æœåŠ¡å•†:",-1)),Ce(Ne,{"model-value":r.value.modelProvider,options:t,onChange:a[0]||(a[0]=v=>{r.value.modelProvider=v,x()})},null,8,["model-value"])]),ae(e("div",bu,[e("label",hu,ne(N.value)+":",1),e("div",yu,[ae(e("input",{type:l.value?"text":"password",id:"settingsApiKey","onUpdate:modelValue":a[1]||(a[1]=v=>r.value.apiKey=v),class:"secure-input",placeholder:m.value,autocomplete:"off"},null,8,xu),[[kt,r.value.apiKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:a[2]||(a[2]=v=>l.value=!l.value)},[l.value?(E(),U("span",Cu,"ğŸ‘â€ğŸ—¨")):(E(),U("span",_u,"ğŸ‘"))])])],512),[[Ue,!w.value]])]),ae(e("div",Su,[a[15]||(a[15]=e("label",{for:"settingsCustomBaseUrl"},"Base URL:",-1)),ae(e("input",{type:"text",id:"settingsCustomBaseUrl","onUpdate:modelValue":a[3]||(a[3]=v=>r.value.customBaseUrl=v),placeholder:"ä¾‹å¦‚: https://api.example.com/v1"},null,512),[[ke,r.value.customBaseUrl]])],512),[[Ue,r.value.modelProvider==="custom_openai"]]),ae(e("div",ku,[e("label",wu,ne(d.value)+":",1),e("div",$u,[ae(e("input",{type:"text",id:"settingsModelName","onUpdate:modelValue":a[4]||(a[4]=v=>r.value.modelName=v),placeholder:S.value},null,8,Tu),[[ke,r.value.modelName]]),ae(e("button",{type:"button",class:"fetch-models-btn",title:"è·å–å¯ç”¨æ¨¡å‹åˆ—è¡¨",onClick:G,disabled:b.value},[a[16]||(a[16]=e("span",{class:"fetch-icon"},"ğŸ”",-1)),e("span",Du,ne(b.value?"è·å–ä¸­...":"è·å–æ¨¡å‹"),1)],8,Iu),[[Ue,q.value]])]),P.value.length>0?(E(),U("div",Ru,[Ce(Ne,{"model-value":r.value.modelName,options:O.value,onChange:a[5]||(a[5]=v=>{r.value.modelName=v})},null,8,["model-value","options"]),e("span",Pu,"å…± "+ne(P.value.length)+" ä¸ªæ¨¡å‹",1)])):de("",!0)],512),[[Ue,!w.value]]),ae(e("div",Mu,[a[17]||(a[17]=e("label",null,"æœ¬åœ°æ¨¡å‹:",-1)),e("div",Eu,[r.value.modelProvider==="ollama"?(E(),U("div",Bu,[e("button",{class:"settings-test-btn",onClick:Z,disabled:b.value},ne(b.value?"è·å–ä¸­...":"ğŸ”„ åˆ·æ–°æ¨¡å‹åˆ—è¡¨"),9,Au),C.value.length>0?(E(),st(Ne,{key:0,"model-value":r.value.modelName,options:D.value,onChange:a[6]||(a[6]=v=>r.value.modelName=v)},null,8,["model-value","options"])):(E(),U("p",Lu,"ç‚¹å‡»åˆ·æ–°è·å–å¯ç”¨æ¨¡å‹"))])):r.value.modelProvider==="sakura"?(E(),U("div",Fu,[e("button",{class:"settings-test-btn",onClick:le,disabled:b.value},ne(b.value?"è·å–ä¸­...":"ğŸ”„ åˆ·æ–°æ¨¡å‹åˆ—è¡¨"),9,Uu),B.value.length>0?(E(),st(Ne,{key:0,"model-value":r.value.modelName,options:M.value,onChange:a[7]||(a[7]=v=>r.value.modelName=v)},null,8,["model-value","options"])):(E(),U("p",Ou,"ç‚¹å‡»åˆ·æ–°è·å–å¯ç”¨æ¨¡å‹"))])):de("",!0)])],512),[[Ue,w.value]]),ae(e("div",zu,[e("div",Nu,[a[18]||(a[18]=e("label",{for:"settingsRpmTranslation"},"RPMé™åˆ¶:",-1)),ae(e("input",{type:"number",id:"settingsRpmTranslation","onUpdate:modelValue":a[8]||(a[8]=v=>r.value.rpmTranslation=v),min:"0",step:"1"},null,512),[[ke,r.value.rpmTranslation,void 0,{number:!0}]]),a[19]||(a[19]=e("div",{class:"input-hint"},"æ¯åˆ†é’Ÿè¯·æ±‚æ•°ï¼Œ0è¡¨ç¤ºæ— é™åˆ¶",-1))]),e("div",Vu,[a[20]||(a[20]=e("label",{for:"settingsTranslationMaxRetries"},"é‡è¯•æ¬¡æ•°:",-1)),ae(e("input",{type:"number",id:"settingsTranslationMaxRetries","onUpdate:modelValue":a[9]||(a[9]=v=>r.value.translationMaxRetries=v),min:"0",max:"10",step:"1"},null,512),[[ke,r.value.translationMaxRetries,void 0,{number:!0}]])])],512),[[Ue,V.value]]),ae(e("div",Wu,[e("button",{class:"settings-test-btn",onClick:Q,disabled:u.value},ne(u.value?"æµ‹è¯•ä¸­...":"ğŸ”— æµ‹è¯•è¿æ¥"),9,Ku)],512),[[Ue,w.value]]),ae(e("div",qu,[e("button",{class:"settings-test-btn",onClick:T,disabled:u.value},ne(u.value?"æµ‹è¯•ä¸­...":"ğŸ”— æµ‹è¯•è¿æ¥"),9,Hu)],512),[[Ue,!w.value]])]),e("div",ju,[a[26]||(a[26]=e("div",{class:"settings-group-title"},"æç¤ºè¯è®¾ç½®",-1)),e("div",Ju,[a[23]||(a[23]=e("label",{for:"settingsPromptContent"},"ç¿»è¯‘æç¤ºè¯:",-1)),ae(e("textarea",{id:"settingsPromptContent","onUpdate:modelValue":a[10]||(a[10]=v=>r.value.promptContent=v),rows:"4",placeholder:"ç¿»è¯‘æç¤ºè¯"},null,512),[[ke,r.value.promptContent]]),e("div",Yu,[Ce(Ne,{"model-value":r.value.translatePromptMode,options:n,onChange:a[11]||(a[11]=v=>{r.value.translatePromptMode=v,K()})},null,8,["model-value"]),a[22]||(a[22]=e("span",{class:"input-hint"},"JSONæ ¼å¼è¾“å‡ºæ›´ç»“æ„åŒ–",-1))]),Ce(Bt,{"prompt-type":"translate",onSelect:k}),e("button",{type:"button",class:"reset-btn",onClick:y}," é‡ç½®ä¸ºé»˜è®¤ ")]),e("div",Xu,[e("label",Gu,[ae(e("input",{type:"checkbox","onUpdate:modelValue":a[12]||(a[12]=v=>r.value.enableTextboxPrompt=v)},null,512),[[et,r.value.enableTextboxPrompt]]),a[24]||(a[24]=pe(" å¯ç”¨æ–‡æœ¬æ¡†æç¤ºè¯ ",-1))])]),ae(e("div",Zu,[a[25]||(a[25]=e("label",{for:"settingsTextboxPromptContent"},"æ–‡æœ¬æ¡†æç¤ºè¯:",-1)),ae(e("textarea",{id:"settingsTextboxPromptContent","onUpdate:modelValue":a[13]||(a[13]=v=>r.value.textboxPromptContent=v),rows:"3",placeholder:"æ–‡æœ¬æ¡†æç¤ºè¯"},null,512),[[ke,r.value.textboxPromptContent]]),Ce(Bt,{"prompt-type":"textbox",onSelect:F})],512),[[Ue,r.value.enableTextboxPrompt]])])]))}}),ec=qe(Qu,[["__scopeId","data-v-1eaa2d97"]]),tc={class:"detection-settings"},oc={class:"settings-group"},nc={class:"settings-item"},sc={class:"settings-group"},ac={class:"settings-item"},lc={class:"settings-row"},ic={class:"settings-item"},rc={class:"settings-item"},uc={class:"settings-row"},cc={class:"settings-item"},dc={class:"settings-item"},gc={class:"settings-group"},pc={class:"settings-item"},mc={class:"checkbox-label"},vc={class:"settings-row"},fc={class:"settings-item"},bc={class:"settings-item"},hc={class:"settings-group"},yc={class:"settings-item"},xc={class:"checkbox-label"},_c=He({__name:"DetectionSettings",setup(s){const t=[{label:"CTD (Comic Text Detector)",value:"ctd"},{label:"YOLO",value:"yolo"},{label:"YOLOv5",value:"yolov5"},{label:"Default (DBNet)",value:"default"}],n=Le(),o=vo({textDetector:n.settings.textDetector,boxExpandRatio:n.settings.boxExpand.ratio,boxExpandTop:n.settings.boxExpand.top,boxExpandBottom:n.settings.boxExpand.bottom,boxExpandLeft:n.settings.boxExpand.left,boxExpandRight:n.settings.boxExpand.right,usePreciseMask:n.settings.preciseMask.enabled,maskDilateSize:n.settings.preciseMask.dilateSize,maskBoxExpandRatio:n.settings.preciseMask.boxExpandRatio,showDetectionDebug:n.settings.showDetectionDebug}),i=J(()=>["ctd","default"].includes(o.textDetector));Se(()=>o.textDetector,l=>{n.setTextDetector(l)}),Se(()=>o.boxExpandRatio,l=>{n.updateBoxExpand({ratio:l})}),Se(()=>o.boxExpandTop,l=>{n.updateBoxExpand({top:l})}),Se(()=>o.boxExpandBottom,l=>{n.updateBoxExpand({bottom:l})}),Se(()=>o.boxExpandLeft,l=>{n.updateBoxExpand({left:l})}),Se(()=>o.boxExpandRight,l=>{n.updateBoxExpand({right:l})}),Se(()=>o.usePreciseMask,l=>{n.updatePreciseMask({enabled:l})}),Se(()=>o.maskDilateSize,l=>{n.updatePreciseMask({dilateSize:l})}),Se(()=>o.maskBoxExpandRatio,l=>{n.updatePreciseMask({boxExpandRatio:l})}),Se(()=>o.showDetectionDebug,l=>{n.setShowDetectionDebug(l)});function r(){i.value||(o.usePreciseMask=!1)}return(l,u)=>(E(),U("div",tc,[e("div",oc,[u[11]||(u[11]=e("div",{class:"settings-group-title"},"æ–‡å­—æ£€æµ‹å™¨",-1)),e("div",nc,[u[10]||(u[10]=e("label",{for:"settingsTextDetector"},"æ£€æµ‹å™¨ç±»å‹:",-1)),Ce(Ne,{modelValue:o.textDetector,"onUpdate:modelValue":u[0]||(u[0]=b=>o.textDetector=b),options:t,onChange:r},null,8,["modelValue"])])]),e("div",sc,[u[18]||(u[18]=e("div",{class:"settings-group-title"},"æ–‡æœ¬æ¡†æ‰©å±•å‚æ•°",-1)),e("div",ac,[u[12]||(u[12]=e("label",{for:"settingsBoxExpandRatio"},"æ•´ä½“æ‰©å±• (%):",-1)),ae(e("input",{type:"number",id:"settingsBoxExpandRatio","onUpdate:modelValue":u[1]||(u[1]=b=>o.boxExpandRatio=b),min:"0",max:"50",step:"1"},null,512),[[ke,o.boxExpandRatio,void 0,{number:!0}]]),u[13]||(u[13]=e("div",{class:"input-hint"},"å‘å››å‘¨å‡åŒ€æ‰©å±•çš„ç™¾åˆ†æ¯” (0-50%)",-1))]),e("div",lc,[e("div",ic,[u[14]||(u[14]=e("label",{for:"settingsBoxExpandTop"},"ä¸Šæ–¹æ‰©å±• (%):",-1)),ae(e("input",{type:"number",id:"settingsBoxExpandTop","onUpdate:modelValue":u[2]||(u[2]=b=>o.boxExpandTop=b),min:"0",max:"50",step:"1"},null,512),[[ke,o.boxExpandTop,void 0,{number:!0}]])]),e("div",rc,[u[15]||(u[15]=e("label",{for:"settingsBoxExpandBottom"},"ä¸‹æ–¹æ‰©å±• (%):",-1)),ae(e("input",{type:"number",id:"settingsBoxExpandBottom","onUpdate:modelValue":u[3]||(u[3]=b=>o.boxExpandBottom=b),min:"0",max:"50",step:"1"},null,512),[[ke,o.boxExpandBottom,void 0,{number:!0}]])])]),e("div",uc,[e("div",cc,[u[16]||(u[16]=e("label",{for:"settingsBoxExpandLeft"},"å·¦ä¾§æ‰©å±• (%):",-1)),ae(e("input",{type:"number",id:"settingsBoxExpandLeft","onUpdate:modelValue":u[4]||(u[4]=b=>o.boxExpandLeft=b),min:"0",max:"50",step:"1"},null,512),[[ke,o.boxExpandLeft,void 0,{number:!0}]])]),e("div",dc,[u[17]||(u[17]=e("label",{for:"settingsBoxExpandRight"},"å³ä¾§æ‰©å±• (%):",-1)),ae(e("input",{type:"number",id:"settingsBoxExpandRight","onUpdate:modelValue":u[5]||(u[5]=b=>o.boxExpandRight=b),min:"0",max:"50",step:"1"},null,512),[[ke,o.boxExpandRight,void 0,{number:!0}]])])])]),ae(e("div",gc,[u[25]||(u[25]=e("div",{class:"settings-group-title"},"ç²¾ç¡®æ–‡å­—æ©è†œ",-1)),e("div",pc,[e("label",mc,[ae(e("input",{type:"checkbox","onUpdate:modelValue":u[6]||(u[6]=b=>o.usePreciseMask=b)},null,512),[[et,o.usePreciseMask]]),u[19]||(u[19]=pe(" å¯ç”¨ç²¾ç¡®æ–‡å­—æ©è†œ ",-1))]),u[20]||(u[20]=e("div",{class:"input-hint"},"ä½¿ç”¨æ›´ç²¾ç¡®çš„æ–‡å­—åŒºåŸŸæ©è†œè¿›è¡Œä¿®å¤",-1))]),ae(e("div",vc,[e("div",fc,[u[21]||(u[21]=e("label",{for:"settingsMaskDilateSize"},"è†¨èƒ€å¤§å°:",-1)),ae(e("input",{type:"number",id:"settingsMaskDilateSize","onUpdate:modelValue":u[7]||(u[7]=b=>o.maskDilateSize=b),min:"0",step:"1"},null,512),[[ke,o.maskDilateSize,void 0,{number:!0}]]),u[22]||(u[22]=e("div",{class:"input-hint"},"æ©è†œè†¨èƒ€åƒç´ æ•°",-1))]),e("div",bc,[u[23]||(u[23]=e("label",{for:"settingsMaskBoxExpandRatio"},"æ ‡æ³¨æ¡†æ‰©å¤§æ¯”ä¾‹ (%):",-1)),ae(e("input",{type:"number",id:"settingsMaskBoxExpandRatio","onUpdate:modelValue":u[8]||(u[8]=b=>o.maskBoxExpandRatio=b),min:"0",max:"100",step:"1"},null,512),[[ke,o.maskBoxExpandRatio,void 0,{number:!0}]]),u[24]||(u[24]=e("div",{class:"input-hint"},"æ ‡æ³¨æ¡†åŒºåŸŸæ‰©å¤§ç™¾åˆ†æ¯”",-1))])],512),[[Ue,o.usePreciseMask]])],512),[[Ue,i.value]]),e("div",hc,[u[28]||(u[28]=e("div",{class:"settings-group-title"},"è°ƒè¯•é€‰é¡¹",-1)),e("div",yc,[e("label",xc,[ae(e("input",{type:"checkbox","onUpdate:modelValue":u[9]||(u[9]=b=>o.showDetectionDebug=b)},null,512),[[et,o.showDetectionDebug]]),u[26]||(u[26]=pe(" æ˜¾ç¤ºæ£€æµ‹æ¡†è°ƒè¯•ä¿¡æ¯ ",-1))]),u[27]||(u[27]=e("div",{class:"input-hint"},"åœ¨ç¿»è¯‘ç»“æœä¸­æ˜¾ç¤ºæ°”æ³¡æ£€æµ‹æ¡†ï¼Œç”¨äºè°ƒè¯•",-1))])])]))}}),Cc=qe(_c,[["__scopeId","data-v-c12c43ee"]]),Sc={class:"hq-translation-settings"},kc={class:"settings-group"},wc={class:"settings-row"},$c={class:"settings-item"},Tc={class:"settings-item"},Ic={class:"password-input-wrapper"},Dc=["type"],Rc={key:0,class:"eye-icon"},Pc={key:1,class:"eye-off-icon"},Mc={class:"settings-item"},Ec={class:"settings-item"},Bc={class:"model-input-with-fetch"},Ac=["disabled"],Lc={class:"fetch-text"},Fc={key:0,class:"model-select-container"},Uc={class:"model-count"},Oc={class:"settings-item"},zc=["disabled"],Nc={class:"settings-group"},Vc={class:"settings-row"},Wc={class:"settings-item"},Kc={class:"settings-item"},qc={class:"settings-row"},Hc={class:"settings-item"},jc={class:"settings-item"},Jc={class:"settings-group"},Yc={class:"settings-row"},Xc={class:"settings-item"},Gc={class:"checkbox-label"},Zc={class:"settings-item"},Qc={class:"settings-row"},ed={class:"settings-item"},td={class:"checkbox-label"},od={class:"settings-item"},nd={class:"checkbox-label"},sd={class:"settings-group"},ad={class:"settings-item"},ld=He({__name:"HqTranslationSettings",setup(s){const t=[{label:"SiliconFlow",value:"siliconflow"},{label:"DeepSeek",value:"deepseek"},{label:"ç«å±±å¼•æ“",value:"volcano"},{label:"Google Gemini",value:"gemini"},{label:"è‡ªå®šä¹‰ OpenAI å…¼å®¹æœåŠ¡",value:"custom_openai"}],n=[{label:"Geminié£æ ¼ (reasoning_effort=low)",value:"gemini"},{label:"ç«å±±å¼•æ“é£æ ¼ (thinking=null)",value:"volcano"}],o=Le(),i=rt(),r=J(()=>o.settings.hqTranslation),l=h({apiKey:o.settings.hqTranslation.apiKey,modelName:o.settings.hqTranslation.modelName,customBaseUrl:o.settings.hqTranslation.customBaseUrl,batchSize:o.settings.hqTranslation.batchSize,sessionReset:o.settings.hqTranslation.sessionReset,rpmLimit:o.settings.hqTranslation.rpmLimit,maxRetries:o.settings.hqTranslation.maxRetries,lowReasoning:o.settings.hqTranslation.lowReasoning,noThinkingMethod:o.settings.hqTranslation.noThinkingMethod,forceJsonOutput:o.settings.hqTranslation.forceJsonOutput,useStream:o.settings.hqTranslation.useStream,prompt:o.settings.hqTranslation.prompt});Se(()=>l.value.apiKey,m=>{o.updateHqTranslation({apiKey:m})}),Se(()=>l.value.modelName,m=>{o.updateHqTranslation({modelName:m})}),Se(()=>l.value.customBaseUrl,m=>{o.updateHqTranslation({customBaseUrl:m})}),Se(()=>l.value.batchSize,m=>{o.updateHqTranslation({batchSize:m})}),Se(()=>l.value.sessionReset,m=>{o.updateHqTranslation({sessionReset:m})}),Se(()=>l.value.rpmLimit,m=>{o.updateHqTranslation({rpmLimit:m})}),Se(()=>l.value.maxRetries,m=>{o.updateHqTranslation({maxRetries:m})}),Se(()=>l.value.lowReasoning,m=>{o.updateHqTranslation({lowReasoning:m})}),Se(()=>l.value.noThinkingMethod,m=>{o.updateHqTranslation({noThinkingMethod:m})}),Se(()=>l.value.forceJsonOutput,m=>{o.updateHqTranslation({forceJsonOutput:m})}),Se(()=>l.value.useStream,m=>{o.updateHqTranslation({useStream:m})}),Se(()=>l.value.prompt,m=>{o.updateHqTranslation({prompt:m})});const u=h(!1),b=h(!1),P=h([]),C=h(!1),B=J(()=>{const m=[{label:"-- é€‰æ‹©æ¨¡å‹ --",value:""}];return P.value.forEach(d=>m.push({label:d,value:d})),m});function O(m){o.setHqProvider(m),P.value=[],D()}function D(){const m=o.settings.hqTranslation;l.value.apiKey=m.apiKey,l.value.modelName=m.modelName,l.value.customBaseUrl=m.customBaseUrl,l.value.batchSize=m.batchSize,l.value.sessionReset=m.sessionReset,l.value.rpmLimit=m.rpmLimit,l.value.maxRetries=m.maxRetries,l.value.lowReasoning=m.lowReasoning,l.value.noThinkingMethod=m.noThinkingMethod,l.value.forceJsonOutput=m.forceJsonOutput,l.value.useStream=m.useStream,l.value.prompt=m.prompt}function M(m){return{siliconflow:"SiliconFlow",deepseek:"DeepSeek",volcano:"ç«å±±å¼•æ“",gemini:"Google Gemini",custom_openai:"è‡ªå®šä¹‰OpenAI"}[m]||m}async function w(){const m=r.value.provider,d=l.value.apiKey?.trim(),S=l.value.customBaseUrl?.trim();if(!d){i.warning("è¯·å…ˆå¡«å†™ API Key");return}if(!["siliconflow","deepseek","volcano","gemini","custom_openai"].includes(m)){i.warning(`${M(m)} ä¸æ”¯æŒè‡ªåŠ¨è·å–æ¨¡å‹åˆ—è¡¨`);return}if(m==="custom_openai"&&!S){i.warning("è‡ªå®šä¹‰æœåŠ¡éœ€è¦å…ˆå¡«å†™ Base URL");return}b.value=!0;try{const K=await We.fetchModels(m,d,S);K.success&&K.models&&K.models.length>0?(P.value=K.models.map(G=>G.id),i.success(`è·å–åˆ° ${K.models.length} ä¸ªæ¨¡å‹`)):i.warning(K.message||"æœªè·å–åˆ°å¯ç”¨æ¨¡å‹")}catch(K){const G=K instanceof Error?K.message:"è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥";i.error(G)}finally{b.value=!1}}async function V(){const m=r.value.provider,d=l.value.apiKey?.trim(),S=l.value.modelName?.trim(),x=l.value.customBaseUrl?.trim();if(!d){i.warning("è¯·å…ˆå¡«å†™ API Key");return}if(!S){i.warning("è¯·å¡«å†™æ¨¡å‹åç§°");return}if(m==="custom_openai"&&!x){i.warning("è‡ªå®šä¹‰æœåŠ¡éœ€è¦å¡«å†™ Base URL");return}C.value=!0,i.info("æ­£åœ¨æµ‹è¯•è¿æ¥...");try{const K=await We.testAiTranslateConnection({provider:m,apiKey:d,modelName:S,baseUrl:x});K.success?i.success(K.message||`${M(m)} è¿æ¥æˆåŠŸ!`):i.error(K.message||K.error||"è¿æ¥å¤±è´¥")}catch(K){const G=K instanceof Error?K.message:"è¿æ¥æµ‹è¯•å¤±è´¥";i.error(G)}finally{C.value=!1}}function q(){o.updateHqTranslation({prompt:Ko}),l.value.prompt=Ko,i.success("å·²é‡ç½®ä¸ºé»˜è®¤æç¤ºè¯")}function N(m,d){o.updateHqTranslation({prompt:m}),l.value.prompt=m,i.success(`å·²åº”ç”¨æç¤ºè¯: ${d}`)}return(m,d)=>(E(),U("div",Sc,[e("div",kc,[d[20]||(d[20]=e("div",{class:"settings-group-title"},"é«˜è´¨é‡ç¿»è¯‘æœåŠ¡é…ç½®",-1)),e("div",wc,[e("div",$c,[d[15]||(d[15]=e("label",{for:"settingsHqTranslateProvider"},"æœåŠ¡å•†:",-1)),Ce(Ne,{"model-value":r.value.provider,options:t,onChange:d[0]||(d[0]=S=>O(S))},null,8,["model-value"])]),e("div",Tc,[d[16]||(d[16]=e("label",{for:"settingsHqApiKey"},"API Key:",-1)),e("div",Ic,[ae(e("input",{type:u.value?"text":"password",id:"settingsHqApiKey","onUpdate:modelValue":d[1]||(d[1]=S=>l.value.apiKey=S),class:"secure-input",placeholder:"è¯·è¾“å…¥API Key",autocomplete:"off"},null,8,Dc),[[kt,l.value.apiKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:d[2]||(d[2]=S=>u.value=!u.value)},[u.value?(E(),U("span",Pc,"ğŸ‘â€ğŸ—¨")):(E(),U("span",Rc,"ğŸ‘"))])])])]),ae(e("div",Mc,[d[17]||(d[17]=e("label",{for:"settingsHqCustomBaseUrl"},"Base URL:",-1)),ae(e("input",{type:"text",id:"settingsHqCustomBaseUrl","onUpdate:modelValue":d[3]||(d[3]=S=>l.value.customBaseUrl=S),placeholder:"ä¾‹å¦‚: https://api.example.com/v1"},null,512),[[ke,l.value.customBaseUrl]])],512),[[Ue,r.value.provider==="custom_openai"]]),e("div",Ec,[d[19]||(d[19]=e("label",{for:"settingsHqModelName"},"æ¨¡å‹åç§°:",-1)),e("div",Bc,[ae(e("input",{type:"text",id:"settingsHqModelName","onUpdate:modelValue":d[4]||(d[4]=S=>l.value.modelName=S),placeholder:"è¯·è¾“å…¥æ¨¡å‹åç§°"},null,512),[[ke,l.value.modelName]]),e("button",{type:"button",class:"fetch-models-btn",title:"è·å–å¯ç”¨æ¨¡å‹åˆ—è¡¨",onClick:w,disabled:b.value},[d[18]||(d[18]=e("span",{class:"fetch-icon"},"ğŸ”",-1)),e("span",Lc,ne(b.value?"è·å–ä¸­...":"è·å–æ¨¡å‹"),1)],8,Ac)]),P.value.length>0?(E(),U("div",Fc,[Ce(Ne,{modelValue:l.value.modelName,"onUpdate:modelValue":d[5]||(d[5]=S=>l.value.modelName=S),options:B.value},null,8,["modelValue","options"]),e("span",Uc,"å…± "+ne(P.value.length)+" ä¸ªæ¨¡å‹",1)])):de("",!0)]),e("div",Oc,[e("button",{class:"settings-test-btn",onClick:V,disabled:C.value},ne(C.value?"æµ‹è¯•ä¸­...":"ğŸ”— æµ‹è¯•è¿æ¥"),9,zc)])]),e("div",Nc,[d[28]||(d[28]=e("div",{class:"settings-group-title"},"æ‰¹å¤„ç†è®¾ç½®",-1)),e("div",Vc,[e("div",Wc,[d[21]||(d[21]=e("label",{for:"settingsHqBatchSize"},"æ‰¹æ¬¡å¤§å°:",-1)),ae(e("input",{type:"number",id:"settingsHqBatchSize","onUpdate:modelValue":d[6]||(d[6]=S=>l.value.batchSize=S),min:"1",max:"10",step:"1"},null,512),[[ke,l.value.batchSize,void 0,{number:!0}]]),d[22]||(d[22]=e("div",{class:"input-hint"},"æ¯æ‰¹å¤„ç†çš„å›¾ç‰‡æ•°é‡ (æ¨è3-5å¼ )",-1))]),e("div",Kc,[d[23]||(d[23]=e("label",{for:"settingsHqSessionReset"},"ä¼šè¯é‡ç½®é¢‘ç‡:",-1)),ae(e("input",{type:"number",id:"settingsHqSessionReset","onUpdate:modelValue":d[7]||(d[7]=S=>l.value.sessionReset=S),min:"1",step:"1"},null,512),[[ke,l.value.sessionReset,void 0,{number:!0}]]),d[24]||(d[24]=e("div",{class:"input-hint"},"å¤šå°‘æ‰¹æ¬¡åé‡ç½®ä¸Šä¸‹æ–‡",-1))])]),e("div",qc,[e("div",Hc,[d[25]||(d[25]=e("label",{for:"settingsHqRpmLimit"},"RPMé™åˆ¶:",-1)),ae(e("input",{type:"number",id:"settingsHqRpmLimit","onUpdate:modelValue":d[8]||(d[8]=S=>l.value.rpmLimit=S),min:"0",step:"1"},null,512),[[ke,l.value.rpmLimit,void 0,{number:!0}]]),d[26]||(d[26]=e("div",{class:"input-hint"},"æ¯åˆ†é’Ÿè¯·æ±‚æ•°ï¼Œ0è¡¨ç¤ºæ— é™åˆ¶",-1))]),e("div",jc,[d[27]||(d[27]=e("label",{for:"settingsHqMaxRetries"},"é‡è¯•æ¬¡æ•°:",-1)),ae(e("input",{type:"number",id:"settingsHqMaxRetries","onUpdate:modelValue":d[9]||(d[9]=S=>l.value.maxRetries=S),min:"0",max:"10",step:"1"},null,512),[[ke,l.value.maxRetries,void 0,{number:!0}]])])])]),e("div",Jc,[d[36]||(d[36]=e("div",{class:"settings-group-title"},"é«˜çº§é€‰é¡¹",-1)),e("div",Yc,[e("div",Xc,[e("label",Gc,[ae(e("input",{type:"checkbox","onUpdate:modelValue":d[10]||(d[10]=S=>l.value.lowReasoning=S)},null,512),[[et,l.value.lowReasoning]]),d[29]||(d[29]=pe(" ä½æ¨ç†æ¨¡å¼ ",-1))]),d[30]||(d[30]=e("div",{class:"input-hint"},"å‡å°‘æ¨¡å‹æ¨ç†æ·±åº¦ï¼Œæé«˜é€Ÿåº¦",-1))]),e("div",Zc,[d[31]||(d[31]=e("label",{for:"settingsHqNoThinkingMethod"},"å–æ¶ˆæ€è€ƒæ–¹æ³•:",-1)),Ce(Ne,{modelValue:l.value.noThinkingMethod,"onUpdate:modelValue":d[11]||(d[11]=S=>l.value.noThinkingMethod=S),options:n},null,8,["modelValue"])])]),e("div",Qc,[e("div",ed,[e("label",td,[ae(e("input",{type:"checkbox","onUpdate:modelValue":d[12]||(d[12]=S=>l.value.forceJsonOutput=S)},null,512),[[et,l.value.forceJsonOutput]]),d[32]||(d[32]=pe(" å¼ºåˆ¶JSONè¾“å‡º ",-1))]),d[33]||(d[33]=e("div",{class:"input-hint"},"ä½¿ç”¨ response_format: json_object",-1))]),e("div",od,[e("label",nd,[ae(e("input",{type:"checkbox","onUpdate:modelValue":d[13]||(d[13]=S=>l.value.useStream=S)},null,512),[[et,l.value.useStream]]),d[34]||(d[34]=pe(" æµå¼è°ƒç”¨ ",-1))]),d[35]||(d[35]=e("div",{class:"input-hint"},"ä½¿ç”¨æµå¼APIè°ƒç”¨",-1))])])]),e("div",sd,[d[37]||(d[37]=e("div",{class:"settings-group-title"},"é«˜è´¨é‡ç¿»è¯‘æç¤ºè¯",-1)),e("div",ad,[ae(e("textarea",{id:"settingsHqPrompt","onUpdate:modelValue":d[14]||(d[14]=S=>l.value.prompt=S),rows:"6",placeholder:"é«˜è´¨é‡ç¿»è¯‘æç¤ºè¯"},null,512),[[ke,l.value.prompt]]),Ce(Bt,{"prompt-type":"hq_translate",onSelect:N}),e("button",{class:"btn btn-secondary btn-sm",onClick:q},"é‡ç½®ä¸ºé»˜è®¤")])])]))}}),id=qe(ld,[["__scopeId","data-v-23f4a3f7"]]),rd={class:"proofreading-settings"},ud={class:"settings-group"},cd={class:"settings-item"},dd={class:"checkbox-label"},gd={class:"settings-item"},pd={class:"settings-group"},md={class:"round-header"},vd={class:"round-title"},fd=["onClick","disabled"],bd={class:"round-content"},hd={class:"settings-item"},yd=["onUpdate:modelValue"],xd={class:"settings-row"},_d={class:"settings-item"},Cd={class:"settings-item"},Sd={class:"password-input-wrapper"},kd=["type","onUpdate:modelValue"],wd=["onClick"],$d={key:0,class:"eye-icon"},Td={key:1,class:"eye-off-icon"},Id={class:"settings-item"},Dd=["onUpdate:modelValue"],Rd={class:"settings-item"},Pd={class:"model-input-with-fetch"},Md=["onUpdate:modelValue"],Ed=["onClick","disabled"],Bd={class:"fetch-text"},Ad={key:0,class:"model-select-container"},Ld={class:"model-count"},Fd={class:"settings-item"},Ud=["onClick","disabled"],Od={class:"settings-row"},zd={class:"settings-item"},Nd=["onUpdate:modelValue"],Vd={class:"settings-item"},Wd=["onUpdate:modelValue"],Kd={class:"settings-item"},qd=["onUpdate:modelValue"],Hd={class:"settings-row"},jd={class:"settings-item"},Jd={class:"checkbox-label"},Yd=["onUpdate:modelValue"],Xd={class:"settings-item"},Gd={class:"settings-item"},Zd={class:"checkbox-label"},Qd=["onUpdate:modelValue"],eg={class:"settings-item"},tg=["onUpdate:modelValue"],og=["onClick"],ng=He({__name:"ProofreadingSettings",setup(s){const t=[{label:"SiliconFlow",value:"siliconflow"},{label:"DeepSeek",value:"deepseek"},{label:"ç«å±±å¼•æ“",value:"volcano"},{label:"Google Gemini",value:"gemini"},{label:"è‡ªå®šä¹‰ OpenAI å…¼å®¹æœåŠ¡",value:"custom_openai"}],n=[{label:"Geminié£æ ¼",value:"gemini"},{label:"ç«å±±å¼•æ“é£æ ¼",value:"volcano"}],o=Le(),i=rt(),r=h({}),l=h({}),u=h({}),b=J(()=>o.settings.proofreading.rounds),P=J({get:()=>o.settings.proofreading.maxRetries,set:N=>o.setProofreadingMaxRetries(N)}),C=J({get:()=>o.settings.proofreading.enabled,set:N=>o.setProofreadingEnabled(N)});Se(()=>o.settings.proofreading.rounds,()=>{o.saveToStorage()},{deep:!0});function B(N){const m=u.value[N]||[],d=[{label:"-- é€‰æ‹©æ¨¡å‹ --",value:""}];return m.forEach(S=>d.push({label:S,value:S})),d}async function O(N){const m=b.value[N];if(!m)return;const d=m.provider,S=m.apiKey?.trim(),x=m.customBaseUrl?.trim();if(!S){i.warning("è¯·å…ˆå¡«å†™ API Key");return}if(!["siliconflow","deepseek","volcano","gemini","custom_openai"].includes(d)){i.warning("å½“å‰æœåŠ¡å•†ä¸æ”¯æŒè·å–æ¨¡å‹åˆ—è¡¨");return}r.value[N]=!0;try{const G=await We.fetchModels(d,S,x);G.success&&G.models&&G.models.length>0?(u.value[N]=G.models.map(ie=>ie.id),i.success(`è½®æ¬¡ ${N+1}: è·å–åˆ° ${G.models.length} ä¸ªæ¨¡å‹`)):i.warning(G.message||"æœªè·å–åˆ°å¯ç”¨æ¨¡å‹")}catch(G){const ie=G instanceof Error?G.message:"è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥";i.error(ie)}finally{r.value[N]=!1}}async function D(N){const m=b.value[N];if(!m)return;const d=m.provider,S=m.apiKey?.trim(),x=m.modelName?.trim(),K=m.customBaseUrl?.trim();if(!S){i.warning("è¯·å…ˆå¡«å†™ API Key");return}if(!x){i.warning("è¯·å¡«å†™æ¨¡å‹åç§°");return}l.value[N]=!0,i.info(`æ­£åœ¨æµ‹è¯•è½®æ¬¡ ${N+1} çš„è¿æ¥...`);try{const G=await We.testAiTranslateConnection({provider:d,apiKey:S,modelName:x,baseUrl:K});G.success?i.success(G.message||"è¿æ¥æˆåŠŸ!"):i.error(G.message||G.error||"è¿æ¥å¤±è´¥")}catch(G){const ie=G instanceof Error?G.message:"è¿æ¥æµ‹è¯•å¤±è´¥";i.error(ie)}finally{l.value[N]=!1}}function M(){const N={name:`ç¬¬${b.value.length+1}è½®æ ¡å¯¹`,provider:"siliconflow",apiKey:"",modelName:"",customBaseUrl:"",batchSize:3,sessionReset:20,rpmLimit:7,lowReasoning:!1,noThinkingMethod:"gemini",forceJsonOutput:!0,prompt:qo,showApiKey:!1};o.addProofreadingRound(N),i.success("å·²æ·»åŠ æ–°çš„æ ¡å¯¹è½®æ¬¡")}function w(N){if(b.value.length<=1){i.warning("è‡³å°‘éœ€è¦ä¿ç•™ä¸€ä¸ªæ ¡å¯¹è½®æ¬¡");return}o.removeProofreadingRound(N),i.success("å·²åˆ é™¤æ ¡å¯¹è½®æ¬¡")}function V(N){o.updateProofreadingRound(N,{prompt:qo}),i.success("å·²é‡ç½®ä¸ºé»˜è®¤æç¤ºè¯")}function q(N,m,d){o.updateProofreadingRound(N,{prompt:m}),i.success(`å·²åº”ç”¨æç¤ºè¯: ${d}`)}return(N,m)=>(E(),U("div",rd,[e("div",ud,[m[5]||(m[5]=e("div",{class:"settings-group-title"},"AIæ ¡å¯¹è®¾ç½®",-1)),e("div",cd,[e("label",dd,[ae(e("input",{type:"checkbox","onUpdate:modelValue":m[0]||(m[0]=d=>C.value=d)},null,512),[[et,C.value]]),m[2]||(m[2]=pe(" å¯ç”¨AIæ ¡å¯¹ ",-1))]),m[3]||(m[3]=e("div",{class:"input-hint"},"ç¿»è¯‘å®Œæˆåè‡ªåŠ¨è¿›è¡ŒAIæ ¡å¯¹",-1))]),e("div",gd,[m[4]||(m[4]=e("label",{for:"settingsProofreadingMaxRetries"},"å…¨å±€é‡è¯•æ¬¡æ•°:",-1)),ae(e("input",{type:"number",id:"settingsProofreadingMaxRetries","onUpdate:modelValue":m[1]||(m[1]=d=>P.value=d),min:"0",max:"10",step:"1"},null,512),[[ke,P.value,void 0,{number:!0}]])])]),ae(e("div",pd,[e("div",{class:"settings-group-title"},[m[6]||(m[6]=pe(" æ ¡å¯¹è½®æ¬¡é…ç½® ",-1)),e("button",{class:"btn btn-secondary btn-sm",onClick:M},"+ æ·»åŠ è½®æ¬¡")]),(E(!0),U(Ae,null,Je(b.value,(d,S)=>(E(),U("div",{key:S,class:"proofreading-round"},[e("div",md,[e("span",vd,"è½®æ¬¡ "+ne(S+1)+": "+ne(d.name||"æœªå‘½å"),1),e("button",{class:"btn btn-danger btn-sm",onClick:x=>w(S),disabled:b.value.length<=1}," åˆ é™¤ ",8,fd)]),e("div",bd,[e("div",hd,[m[7]||(m[7]=e("label",null,"è½®æ¬¡åç§°:",-1)),ae(e("input",{type:"text","onUpdate:modelValue":x=>d.name=x,placeholder:"å¦‚: ç¬¬ä¸€è½®æ ¡å¯¹"},null,8,yd),[[ke,d.name]])]),e("div",xd,[e("div",_d,[m[8]||(m[8]=e("label",null,"æœåŠ¡å•†:",-1)),Ce(Ne,{modelValue:d.provider,"onUpdate:modelValue":x=>d.provider=x,options:t},null,8,["modelValue","onUpdate:modelValue"])]),e("div",Cd,[m[9]||(m[9]=e("label",null,"API Key:",-1)),e("div",Sd,[ae(e("input",{type:d.showApiKey?"text":"password","onUpdate:modelValue":x=>d.apiKey=x,class:"secure-input",placeholder:"è¯·è¾“å…¥API Key",autocomplete:"off"},null,8,kd),[[kt,d.apiKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:x=>d.showApiKey=!d.showApiKey},[d.showApiKey?(E(),U("span",Td,"ğŸ‘â€ğŸ—¨")):(E(),U("span",$d,"ğŸ‘"))],8,wd)])])]),ae(e("div",Id,[m[10]||(m[10]=e("label",null,"Base URL:",-1)),ae(e("input",{type:"text","onUpdate:modelValue":x=>d.customBaseUrl=x,placeholder:"ä¾‹å¦‚: https://api.example.com/v1"},null,8,Dd),[[ke,d.customBaseUrl]])],512),[[Ue,d.provider==="custom_openai"]]),e("div",Rd,[m[12]||(m[12]=e("label",null,"æ¨¡å‹åç§°:",-1)),e("div",Pd,[ae(e("input",{type:"text","onUpdate:modelValue":x=>d.modelName=x,placeholder:"è¯·è¾“å…¥æ¨¡å‹åç§°"},null,8,Md),[[ke,d.modelName]]),e("button",{type:"button",class:"fetch-models-btn",title:"è·å–å¯ç”¨æ¨¡å‹åˆ—è¡¨",onClick:x=>O(S),disabled:r.value[S]},[m[11]||(m[11]=e("span",{class:"fetch-icon"},"ğŸ”",-1)),e("span",Bd,ne(r.value[S]?"è·å–ä¸­...":"è·å–æ¨¡å‹"),1)],8,Ed)]),u.value[S]&&u.value[S].length>0?(E(),U("div",Ad,[Ce(Ne,{modelValue:d.modelName,"onUpdate:modelValue":x=>d.modelName=x,options:B(S)},null,8,["modelValue","onUpdate:modelValue","options"]),e("span",Ld,"å…± "+ne(u.value[S].length)+" ä¸ªæ¨¡å‹",1)])):de("",!0)]),e("div",Fd,[e("button",{class:"settings-test-btn",onClick:x=>D(S),disabled:l.value[S]},ne(l.value[S]?"æµ‹è¯•ä¸­...":"ğŸ”— æµ‹è¯•è¿æ¥"),9,Ud)]),e("div",Od,[e("div",zd,[m[13]||(m[13]=e("label",null,"æ‰¹æ¬¡å¤§å°:",-1)),ae(e("input",{type:"number","onUpdate:modelValue":x=>d.batchSize=x,min:"1",max:"10",step:"1"},null,8,Nd),[[ke,d.batchSize,void 0,{number:!0}]])]),e("div",Vd,[m[14]||(m[14]=e("label",null,"ä¼šè¯é‡ç½®é¢‘ç‡:",-1)),ae(e("input",{type:"number","onUpdate:modelValue":x=>d.sessionReset=x,min:"1",step:"1"},null,8,Wd),[[ke,d.sessionReset,void 0,{number:!0}]])]),e("div",Kd,[m[15]||(m[15]=e("label",null,"RPMé™åˆ¶:",-1)),ae(e("input",{type:"number","onUpdate:modelValue":x=>d.rpmLimit=x,min:"0",step:"1"},null,8,qd),[[ke,d.rpmLimit,void 0,{number:!0}]])])]),e("div",Hd,[e("div",jd,[e("label",Jd,[ae(e("input",{type:"checkbox","onUpdate:modelValue":x=>d.lowReasoning=x},null,8,Yd),[[et,d.lowReasoning]]),m[16]||(m[16]=pe(" ä½æ¨ç†æ¨¡å¼ ",-1))])]),e("div",Xd,[m[17]||(m[17]=e("label",null,"å–æ¶ˆæ€è€ƒæ–¹æ³•:",-1)),Ce(Ne,{modelValue:d.noThinkingMethod,"onUpdate:modelValue":x=>d.noThinkingMethod=x,options:n},null,8,["modelValue","onUpdate:modelValue"])]),e("div",Gd,[e("label",Zd,[ae(e("input",{type:"checkbox","onUpdate:modelValue":x=>d.forceJsonOutput=x},null,8,Qd),[[et,d.forceJsonOutput]]),m[18]||(m[18]=pe(" å¼ºåˆ¶JSONè¾“å‡º ",-1))])])]),e("div",eg,[m[19]||(m[19]=e("label",null,"æ ¡å¯¹æç¤ºè¯:",-1)),ae(e("textarea",{"onUpdate:modelValue":x=>d.prompt=x,rows:"4",placeholder:"æ ¡å¯¹æç¤ºè¯"},null,8,tg),[[ke,d.prompt]]),Ce(Bt,{"prompt-type":"proofreading",onSelect:(x,K)=>q(S,x,K)},null,8,["onSelect"]),e("button",{class:"btn btn-secondary btn-sm",onClick:x=>V(S)},"é‡ç½®ä¸ºé»˜è®¤",8,og)])])]))),128))],512),[[Ue,C.value]])]))}}),sg=qe(ng,[["__scopeId","data-v-663a7972"]]),ag={class:"prompt-library"},lg={class:"settings-group"},ig={class:"settings-item"},rg={key:0,class:"settings-item"},ug={class:"mode-hint"},cg={class:"settings-group"},dg={key:0,class:"loading-hint"},gg={key:1,class:"empty-hint"},pg={key:2,class:"prompt-list"},mg=["onClick"],vg={class:"prompt-name"},fg={class:"prompt-actions"},bg=["onClick"],hg=["onClick","disabled"],yg={class:"settings-group"},xg={class:"settings-item"},_g={class:"settings-item"},Cg={class:"prompt-editor-actions"},Sg=["disabled"],kg=He({__name:"PromptLibrary",setup(s){const t=[{label:"ç¿»è¯‘æç¤ºè¯",value:"translate"},{label:"æ–‡æœ¬æ¡†æç¤ºè¯",value:"textbox"},{label:"AIè§†è§‰OCRæç¤ºè¯",value:"ai_vision_ocr"},{label:"é«˜è´¨é‡ç¿»è¯‘æç¤ºè¯",value:"hq_translate"},{label:"æ ¡å¯¹æç¤ºè¯",value:"proofreading"}],n=[{label:"æ™®é€šæ¨¡å¼",value:"false"},{label:"JSONæ ¼å¼æ¨¡å¼",value:"true"}],o=rt(),i=Le(),r=h("translate"),l=h([]),u=h(""),b=h(""),P=h(""),C=h(!1),B=h(!1),O=J(()=>r.value==="translate"||r.value==="ai_vision_ocr"),D=J(()=>B.value?"é€‚ç”¨äºéœ€è¦ç»“æ„åŒ–è¾“å‡ºçš„åœºæ™¯":"é€‚ç”¨äºæ™®é€šç¿»è¯‘åœºæ™¯");async function M(){C.value=!0;try{let S;r.value==="textbox"?S=await We.getTextboxPrompts():S=await We.getPrompts(r.value);const x=S.prompt_names||[];l.value=x.map(K=>({name:K}))}catch(S){const x=S instanceof Error?S.message:"åŠ è½½æç¤ºè¯åˆ—è¡¨å¤±è´¥";o.error(x)}finally{C.value=!1}}async function w(S){u.value=S,b.value=S,await V(S)}async function V(S){try{let x;r.value==="textbox"?x=await We.getTextboxPromptContent(S):x=await We.getPromptContent(r.value,S),b.value=S,P.value=x.prompt_content||"",u.value=S,o.success("å·²åŠ è½½æç¤ºè¯")}catch(x){const K=x instanceof Error?x.message:"åŠ è½½æç¤ºè¯å†…å®¹å¤±è´¥";o.error(K)}}async function q(){if(!b.value||!P.value){o.warning("è¯·è¾“å…¥æç¤ºè¯åç§°å’Œå†…å®¹");return}try{r.value==="textbox"?await We.saveTextboxPrompt(b.value,P.value):await We.savePrompt(r.value,b.value,P.value),o.success("æç¤ºè¯ä¿å­˜æˆåŠŸ"),b.value="",P.value="",await M()}catch(S){const x=S instanceof Error?S.message:"ä¿å­˜æç¤ºè¯å¤±è´¥";o.error(x)}}async function N(S){if(S==="default"){o.warning("é»˜è®¤æç¤ºè¯ä¸èƒ½åˆ é™¤");return}try{r.value==="textbox"?await We.deleteTextboxPrompt(S):await We.deletePrompt(r.value,S),o.success("æç¤ºè¯åˆ é™¤æˆåŠŸ"),u.value===S&&(u.value="",b.value="",P.value=""),await M()}catch(x){const K=x instanceof Error?x.message:"åˆ é™¤æç¤ºè¯å¤±è´¥";o.error(K)}}function m(){u.value="",b.value="",P.value="",r.value==="translate"?B.value=i.settings.translation.isJsonMode:r.value==="ai_vision_ocr"?B.value=i.settings.aiVisionOcr.isJsonMode:B.value=!1,M()}function d(){r.value==="translate"?i.updateTranslationService({isJsonMode:B.value}):r.value==="ai_vision_ocr"&&i.updateAiVisionOcr({isJsonMode:B.value}),o.info(`å·²åˆ‡æ¢åˆ°${B.value?"JSONæ ¼å¼":"æ™®é€š"}æ¨¡å¼`)}return ut(()=>{B.value=i.settings.translation.isJsonMode,M()}),(S,x)=>(E(),U("div",ag,[e("div",lg,[x[6]||(x[6]=e("div",{class:"settings-group-title"},"æç¤ºè¯ç®¡ç†",-1)),e("div",ig,[x[4]||(x[4]=e("label",{for:"promptType"},"æç¤ºè¯ç±»å‹:",-1)),Ce(Ne,{modelValue:r.value,"onUpdate:modelValue":x[0]||(x[0]=K=>r.value=K),options:t,onChange:m},null,8,["modelValue"])]),O.value?(E(),U("div",rg,[x[5]||(x[5]=e("label",{for:"promptMode"},"æç¤ºè¯æ¨¡å¼:",-1)),Ce(Ne,{"model-value":B.value?"true":"false",options:n,onChange:x[1]||(x[1]=K=>{B.value=K==="true",d()})},null,8,["model-value"]),e("span",ug,ne(D.value),1)])):de("",!0)]),e("div",cg,[x[7]||(x[7]=e("div",{class:"settings-group-title"},"å·²ä¿å­˜çš„æç¤ºè¯",-1)),C.value?(E(),U("div",dg,"åŠ è½½ä¸­...")):l.value.length===0?(E(),U("div",gg,"æš‚æ— ä¿å­˜çš„æç¤ºè¯")):(E(),U("div",pg,[(E(!0),U(Ae,null,Je(l.value,K=>(E(),U("div",{key:K.name,class:De(["prompt-item",{active:u.value===K.name}]),onClick:G=>w(K.name)},[e("span",vg,ne(K.name),1),e("div",fg,[e("button",{class:"btn btn-sm",onClick:ot(G=>V(K.name),["stop"]),title:"åŠ è½½åˆ°ç¼–è¾‘å™¨"},"ğŸ“¥",8,bg),e("button",{class:"btn btn-sm btn-danger",onClick:ot(G=>N(K.name),["stop"]),title:"åˆ é™¤",disabled:K.name==="default"}," ğŸ—‘ï¸ ",8,hg)])],10,mg))),128))]))]),e("div",yg,[x[10]||(x[10]=e("div",{class:"settings-group-title"},"æç¤ºè¯ç¼–è¾‘",-1)),e("div",xg,[x[8]||(x[8]=e("label",{for:"promptName"},"æç¤ºè¯åç§°:",-1)),ae(e("input",{type:"text",id:"promptName","onUpdate:modelValue":x[2]||(x[2]=K=>b.value=K),placeholder:"è¯·è¾“å…¥æç¤ºè¯åç§°"},null,512),[[ke,b.value]])]),e("div",_g,[x[9]||(x[9]=e("label",{for:"promptContent"},"æç¤ºè¯å†…å®¹:",-1)),ae(e("textarea",{id:"promptContent","onUpdate:modelValue":x[3]||(x[3]=K=>P.value=K),rows:"8",placeholder:"è¯·è¾“å…¥æç¤ºè¯å†…å®¹"},null,512),[[ke,P.value]])]),e("div",Cg,[e("button",{class:"btn btn-primary",onClick:q,disabled:!b.value||!P.value},"ä¿å­˜æç¤ºè¯",8,Sg)])])]))}}),wg=qe(kg,[["__scopeId","data-v-70f0ec19"]]),$g={class:"plugin-manager"},Tg={class:"settings-group"},Ig={key:0,class:"loading-hint"},Dg={key:1,class:"empty-hint"},Rg={key:2,class:"plugin-list"},Pg={class:"plugin-info"},Mg={class:"plugin-header"},Eg={class:"plugin-name"},Bg={class:"plugin-version"},Ag={class:"plugin-description"},Lg={class:"plugin-controls"},Fg={class:"switch"},Ug=["checked","onChange"],Og=["onClick"],zg=["onClick"],Ng={class:"settings-group"},Vg={class:"plugin-name"},Wg={class:"switch"},Kg=["checked","onChange"],qg={class:"plugin-config-content"},Hg={class:"plugin-config-header"},jg={class:"plugin-config-body"},Jg=["for"],Yg=["id","onUpdate:modelValue"],Xg=["id","onUpdate:modelValue","min","max"],Gg=["id","onUpdate:modelValue","placeholder"],Zg={key:4,class:"field-description"},Qg=He({__name:"PluginManager",setup(s){const t=rt(),n=h([]),o=h({}),i=h(!1),r=h(!1),l=h(null),u=h({}),b=h({});async function P(){i.value=!0;try{const q=await Ls();n.value=q.plugins||[]}catch(q){const N=q instanceof Error?q.message:"åŠ è½½æ’ä»¶åˆ—è¡¨å¤±è´¥";t.error(N)}finally{i.value=!1}}async function C(){try{const q=await qs();o.value=q.states||{}}catch(q){console.error("åŠ è½½é»˜è®¤çŠ¶æ€å¤±è´¥:",q)}}async function B(q){try{q.enabled?(await Us(q.name),q.enabled=!1,t.success(`å·²ç¦ç”¨ ${q.display_name||q.name}`)):(await Fs(q.name),q.enabled=!0,t.success(`å·²å¯ç”¨ ${q.display_name||q.name}`))}catch(N){const m=N instanceof Error?N.message:"æ“ä½œå¤±è´¥";t.error(m)}}async function O(q,N){const m=N.target,d=m.checked;try{await Hs(q,d),o.value[q]=d,t.success("é»˜è®¤çŠ¶æ€å·²æ›´æ–°")}catch(S){const x=S instanceof Error?S.message:"è®¾ç½®å¤±è´¥";t.error(x),m.checked=!d}}async function D(q){l.value=q;try{const N=await js(q.name);u.value=N.schema||{};const m=await Js(q.name);b.value=m.config||{},r.value=!0}catch(N){const m=N instanceof Error?N.message:"åŠ è½½é…ç½®å¤±è´¥";t.error(m)}}function M(){r.value=!1,l.value=null,u.value={},b.value={}}async function w(){if(l.value)try{await Ys(l.value.name,b.value),t.success("é…ç½®ä¿å­˜æˆåŠŸ"),M()}catch(q){const N=q instanceof Error?q.message:"ä¿å­˜é…ç½®å¤±è´¥";t.error(N)}}async function V(q){if(confirm(`ç¡®å®šè¦åˆ é™¤æ’ä»¶ "${q.display_name||q.name}" å—ï¼Ÿ`))try{await Os(q.name),t.success("æ’ä»¶åˆ é™¤æˆåŠŸ"),await P()}catch(N){const m=N instanceof Error?N.message:"åˆ é™¤æ’ä»¶å¤±è´¥";t.error(m)}}return ut(()=>{P(),C()}),(q,N)=>(E(),U("div",$g,[e("div",Tg,[N[1]||(N[1]=e("div",{class:"settings-group-title"},"å·²å®‰è£…æ’ä»¶",-1)),i.value?(E(),U("div",Ig,"åŠ è½½ä¸­...")):n.value.length===0?(E(),U("div",Dg,"æš‚æ— å·²å®‰è£…çš„æ’ä»¶")):(E(),U("div",Rg,[(E(!0),U(Ae,null,Je(n.value,m=>(E(),U("div",{key:m.name,class:"plugin-item"},[e("div",Pg,[e("div",Mg,[e("span",Eg,ne(m.display_name||m.name),1),e("span",Bg,"v"+ne(m.version||"1.0.0"),1)]),e("p",Ag,ne(m.description||"æš‚æ— æè¿°"),1)]),e("div",Lg,[e("label",Fg,[e("input",{type:"checkbox",checked:m.enabled,onChange:d=>B(m)},null,40,Ug),N[0]||(N[0]=e("span",{class:"slider"},null,-1))]),m.has_config?(E(),U("button",{key:0,class:"btn btn-sm",onClick:d=>D(m),title:"é…ç½®"},"âš™ï¸",8,Og)):de("",!0),e("button",{class:"btn btn-sm btn-danger",onClick:d=>V(m),title:"åˆ é™¤"},"ğŸ—‘ï¸",8,zg)])]))),128))]))]),e("div",Ng,[N[3]||(N[3]=e("div",{class:"settings-group-title"},"é»˜è®¤å¯ç”¨çŠ¶æ€",-1)),N[4]||(N[4]=e("p",{class:"settings-hint"},"è®¾ç½®æ’ä»¶åœ¨æ–°ä¼šè¯ä¸­çš„é»˜è®¤å¯ç”¨çŠ¶æ€",-1)),(E(!0),U(Ae,null,Je(n.value,m=>(E(),U("div",{key:"default-"+m.name,class:"default-state-item"},[e("span",Vg,ne(m.display_name||m.name),1),e("label",Wg,[e("input",{type:"checkbox",checked:o.value[m.name],onChange:d=>O(m.name,d)},null,40,Kg),N[2]||(N[2]=e("span",{class:"slider"},null,-1))])]))),128))]),r.value?(E(),U("div",{key:0,class:"plugin-config-modal",onClick:ot(M,["self"])},[e("div",qg,[e("div",Hg,[e("h4",null,ne(l.value?.display_name||l.value?.name)+" é…ç½®",1),e("span",{class:"close-btn",onClick:M},"Ã—")]),e("div",jg,[(E(!0),U(Ae,null,Je(u.value,(m,d)=>(E(),U("div",{key:d,class:"config-field"},[e("label",{for:"config-"+d},ne(m.label||d)+":",9,Jg),m.type==="boolean"?ae((E(),U("input",{key:0,type:"checkbox",id:"config-"+d,"onUpdate:modelValue":S=>b.value[d]=S},null,8,Yg)),[[et,b.value[d]]]):m.type==="select"?(E(),st(Ne,{key:1,"model-value":String(b.value[d]??""),options:m.options||[],onChange:S=>{b.value[d]=S}},null,8,["model-value","options","onChange"])):m.type==="number"?ae((E(),U("input",{key:2,type:"number",id:"config-"+d,"onUpdate:modelValue":S=>b.value[d]=S,min:m.min,max:m.max},null,8,Xg)),[[ke,b.value[d],void 0,{number:!0}]]):ae((E(),U("input",{key:3,type:"text",id:"config-"+d,"onUpdate:modelValue":S=>b.value[d]=S,placeholder:m.placeholder},null,8,Gg)),[[ke,b.value[d]]]),m.description?(E(),U("p",Zg,ne(m.description),1)):de("",!0)]))),128))]),e("div",{class:"plugin-config-footer"},[e("button",{class:"btn btn-secondary",onClick:M},"å–æ¶ˆ"),e("button",{class:"btn btn-primary",onClick:w},"ä¿å­˜")])])])):de("",!0)]))}}),ep=qe(Qg,[["__scopeId","data-v-a62393a7"]]),tp={class:"parallel-settings"},op={class:"settings-group"},np={class:"settings-item"},sp={class:"toggle-switch"},ap={class:"number-control"},lp=["disabled"],ip=["disabled"],rp=["disabled"],up={key:0,class:"settings-note"},cp=He({__name:"ParallelSettings",setup(s){const t=Le(),n=J({get:()=>t.settings.parallel.enabled,set:i=>{t.updateSettings({parallel:{...t.settings.parallel,enabled:i}})}}),o=J({get:()=>t.settings.parallel.deepLearningLockSize,set:i=>{t.updateSettings({parallel:{...t.settings.parallel,deepLearningLockSize:Math.max(1,Math.min(4,i))}})}});return(i,r)=>(E(),U("div",tp,[e("div",op,[r[10]||(r[10]=e("div",{class:"settings-group-title"},"ğŸš€ å¹¶è¡Œç¿»è¯‘",-1)),e("div",np,[r[5]||(r[5]=e("label",null,"å¯ç”¨å¹¶è¡Œæ¨¡å¼:",-1)),e("label",sp,[ae(e("input",{type:"checkbox","onUpdate:modelValue":r[0]||(r[0]=l=>n.value=l)},null,512),[[et,n.value]]),r[4]||(r[4]=e("span",{class:"toggle-slider"},null,-1))]),r[6]||(r[6]=e("div",{class:"input-hint"},"ä½¿ç”¨æµæ°´çº¿å¹¶è¡Œå¤„ç†ï¼Œå¯èƒ½æå‡æ‰¹é‡ç¿»è¯‘é€Ÿåº¦",-1))]),e("div",{class:De(["settings-item",{"item-disabled":!n.value}])},[r[7]||(r[7]=e("label",null,"æ·±åº¦å­¦ä¹ å¹¶å‘æ•°:",-1)),e("div",ap,[e("button",{class:"btn btn-sm",onClick:r[1]||(r[1]=l=>o.value=Math.max(1,o.value-1)),disabled:!n.value},"-",8,lp),ae(e("input",{type:"number","onUpdate:modelValue":r[2]||(r[2]=l=>o.value=l),min:"1",max:"4",disabled:!n.value,class:"number-input"},null,8,ip),[[ke,o.value,void 0,{number:!0}]]),e("button",{class:"btn btn-sm",onClick:r[3]||(r[3]=l=>o.value=Math.min(4,o.value+1)),disabled:!n.value},"+",8,rp)]),r[8]||(r[8]=e("div",{class:"input-hint"},"æ§åˆ¶æ£€æµ‹/OCR/é¢œè‰²/ä¿®å¤çš„æœ€å¤§å¹¶å‘æ•°ï¼ˆå»ºè®®1-2ï¼‰",-1))],2),n.value?(E(),U("div",up,[...r[9]||(r[9]=[e("div",{class:"note-title"},"âš ï¸ æ³¨æ„äº‹é¡¹ï¼š",-1),e("ul",null,[e("li",null,"å¹¶å‘æ•°è®¾ä¸º1æ—¶ä¸ºä¸²è¡Œæ‰§è¡Œï¼Œæœ€ç¨³å®š"),e("li",null,"å¢å¤§å¹¶å‘æ•°å¯èƒ½åŠ é€Ÿå¤„ç†ï¼Œä½†ä¼šå ç”¨æ›´å¤šGPU/CPUèµ„æº"),e("li",null,"å¦‚æœé‡åˆ°æ˜¾å­˜ä¸è¶³ï¼Œè¯·å°†å¹¶å‘æ•°è®¾ä¸º1")],-1)])])):de("",!0)])]))}}),dp=qe(cp,[["__scopeId","data-v-4a6e42d5"]]),gp={class:"more-settings"},pp={class:"settings-group"},mp={class:"settings-item checkbox-item"},vp={class:"checkbox-label"},fp={class:"settings-group"},bp={class:"settings-item"},hp={class:"settings-group"},yp={class:"settings-item"},xp=["disabled"],_p={key:0,class:"font-count"},Cp={class:"settings-item"},Sp={class:"settings-group"},kp={class:"settings-row"},wp={class:"settings-item"},$p=["disabled"],Tp={class:"settings-item"},Ip=["disabled"],Dp=He({__name:"MoreSettings",setup(s){const t=[{label:"å‰ç«¯ pdf.js (æ¨è)",value:"frontend"},{label:"åç«¯ PyMuPDF",value:"backend"}],n=Le(),o=rt(),i=h(!1),r=h([]),l=h(!1),u=h(null),b=h({pdfProcessingMethod:n.settings.pdfProcessingMethod||"frontend",autoSaveInBookshelfMode:n.settings.autoSaveInBookshelfMode||!1});Se(()=>b.value.pdfProcessingMethod,D=>{n.setPdfProcessingMethod(D)}),Se(()=>b.value.autoSaveInBookshelfMode,D=>{n.setAutoSaveInBookshelfMode(D)});async function P(){i.value=!0;try{const D=await We.getFontList();r.value=D.fonts||[],o.success(`è·å–åˆ° ${r.value.length} ä¸ªå­—ä½“`)}catch(D){const M=D instanceof Error?D.message:"è·å–å­—ä½“åˆ—è¡¨å¤±è´¥";o.error(M)}finally{i.value=!1}}async function C(D){const w=D.target.files?.[0];if(!w)return;const V=[".ttf",".ttc",".otf"],q=w.name.toLowerCase().slice(w.name.lastIndexOf("."));if(!V.includes(q)){o.error("ä¸æ”¯æŒçš„å­—ä½“æ ¼å¼ï¼Œè¯·ä¸Šä¼  .ttf, .ttc æˆ– .otf æ–‡ä»¶");return}try{const N=await We.uploadFont(w);N.success?(o.success(`å­—ä½“ "${N.fontPath||w.name}" ä¸Šä¼ æˆåŠŸ`),await P()):o.error(N.error||"å­—ä½“ä¸Šä¼ å¤±è´¥")}catch(N){const m=N instanceof Error?N.message:"å­—ä½“ä¸Šä¼ å¤±è´¥";o.error(m)}finally{u.value&&(u.value.value="")}}async function B(){l.value=!0;try{const D=await bn();D.success?o.success(`å·²æ¸…ç† ${D.deleted_count||0} ä¸ªè°ƒè¯•æ–‡ä»¶`):o.error(D.error||"æ¸…ç†å¤±è´¥")}catch(D){const M=D instanceof Error?D.message:"æ¸…ç†å¤±è´¥";o.error(M)}finally{l.value=!1}}async function O(){l.value=!0;try{const D=await fo();D.success?o.success(`å·²æ¸…ç† ${D.deleted_count||0} ä¸ªä¸´æ—¶æ–‡ä»¶`):o.error(D.error||"æ¸…ç†å¤±è´¥")}catch(D){const M=D instanceof Error?D.message:"æ¸…ç†å¤±è´¥";o.error(M)}finally{l.value=!1}}return(D,M)=>(E(),U("div",gp,[Ce(dp),e("div",pp,[M[4]||(M[4]=e("div",{class:"settings-group-title"},"è‡ªåŠ¨ä¿å­˜è®¾ç½®",-1)),e("div",mp,[e("label",vp,[ae(e("input",{type:"checkbox","onUpdate:modelValue":M[0]||(M[0]=w=>b.value.autoSaveInBookshelfMode=w)},null,512),[[et,b.value.autoSaveInBookshelfMode]]),M[2]||(M[2]=e("span",{class:"checkbox-text"},"ä¹¦æ¶æ¨¡å¼è‡ªåŠ¨ä¿å­˜",-1))]),M[3]||(M[3]=e("div",{class:"input-hint"},[pe(" å¼€å¯åï¼Œåœ¨ä¹¦æ¶æ¨¡å¼ä¸‹ç¿»è¯‘æ—¶ä¼šè‡ªåŠ¨ä¿å­˜è¿›åº¦ï¼ˆç¿»è¯‘ä¸€å¼ ä¿å­˜ä¸€å¼ ï¼‰ï¼Œé˜²æ­¢æ„å¤–å…³é—­å¯¼è‡´æ•°æ®ä¸¢å¤±ã€‚ "),e("br"),e("span",{class:"hint-note"},"æ³¨æ„ï¼šæ­¤åŠŸèƒ½ä»…åœ¨ä¹¦æ¶æ¨¡å¼ä¸‹ç”Ÿæ•ˆï¼Œå¿«é€Ÿç¿»è¯‘æ¨¡å¼ä¸æ”¯æŒã€‚")],-1))])]),e("div",fp,[M[7]||(M[7]=e("div",{class:"settings-group-title"},"PDFå¤„ç†è®¾ç½®",-1)),e("div",bp,[M[5]||(M[5]=e("label",{for:"settingsPdfProcessingMethod"},"PDFå¤„ç†æ–¹å¼:",-1)),Ce(Ne,{modelValue:b.value.pdfProcessingMethod,"onUpdate:modelValue":M[1]||(M[1]=w=>b.value.pdfProcessingMethod=w),options:t},null,8,["modelValue"]),M[6]||(M[6]=e("div",{class:"input-hint"},"å‰ç«¯å¤„ç†é€Ÿåº¦æ›´å¿«ï¼Œåç«¯å¤„ç†å…¼å®¹æ€§æ›´å¥½",-1))])]),e("div",hp,[M[11]||(M[11]=e("div",{class:"settings-group-title"},"å­—ä½“è®¾ç½®",-1)),e("div",yp,[M[8]||(M[8]=e("label",null,"ç³»ç»Ÿå­—ä½“åˆ—è¡¨:",-1)),e("button",{class:"btn btn-secondary",onClick:P,disabled:i.value},ne(i.value?"åŠ è½½ä¸­...":"ğŸ”„ åˆ·æ–°å­—ä½“åˆ—è¡¨"),9,xp),r.value.length>0?(E(),U("div",_p,"å…± "+ne(r.value.length)+" ä¸ªå­—ä½“",1)):de("",!0)]),e("div",Cp,[M[9]||(M[9]=e("label",null,"ä¸Šä¼ è‡ªå®šä¹‰å­—ä½“:",-1)),e("input",{type:"file",accept:".ttf,.ttc,.otf",onChange:C,ref_key:"fontInput",ref:u},null,544),M[10]||(M[10]=e("div",{class:"input-hint"},"æ”¯æŒ .ttf, .ttc, .otf æ ¼å¼",-1))])]),e("div",Sp,[M[14]||(M[14]=e("div",{class:"settings-group-title"},"ç¼“å­˜æ¸…ç†",-1)),e("div",kp,[e("div",wp,[e("button",{class:"btn btn-secondary",onClick:B,disabled:l.value},ne(l.value?"æ¸…ç†ä¸­...":"ğŸ—‘ï¸ æ¸…ç†è°ƒè¯•æ–‡ä»¶"),9,$p),M[12]||(M[12]=e("div",{class:"input-hint"},"æ¸…ç†è°ƒè¯•è¿‡ç¨‹ä¸­ç”Ÿæˆçš„ä¸´æ—¶æ–‡ä»¶",-1))]),e("div",Tp,[e("button",{class:"btn btn-secondary",onClick:O,disabled:l.value},ne(l.value?"æ¸…ç†ä¸­...":"ğŸ—‘ï¸ æ¸…ç†ä¸´æ—¶æ–‡ä»¶"),9,Ip),M[13]||(M[13]=e("div",{class:"input-hint"},"æ¸…ç†ä¸‹è½½å’Œå¤„ç†è¿‡ç¨‹ä¸­çš„ä¸´æ—¶æ–‡ä»¶",-1))])])]),M[15]||(M[15]=uo('<div class="settings-group" data-v-8667f80e><div class="settings-group-title" data-v-8667f80e>å…³äº</div><div class="about-info" data-v-8667f80e><p data-v-8667f80e><strong data-v-8667f80e>Saber-Translator</strong></p><p data-v-8667f80e>AIé©±åŠ¨çš„æ¼«ç”»ç¿»è¯‘å·¥å…·</p><p class="links" data-v-8667f80e><a href="http://www.mashirosaber.top" target="_blank" data-v-8667f80e>ğŸ“– ä½¿ç”¨æ•™ç¨‹</a><a href="https://github.com/MashiroSaber/saber-translator" target="_blank" data-v-8667f80e>ğŸ™ GitHub</a></p><p class="disclaimer" data-v-8667f80e>æœ¬é¡¹ç›®å®Œå…¨å¼€æºå…è´¹ï¼Œè¯·å‹¿ä¸Šå½“å—éª—</p></div></div>',1))]))}}),Rp=qe(Dp,[["__scopeId","data-v-8667f80e"]]),Pp={class:"settings-modal-content"},Mp={class:"settings-tabs"},Ep=["onClick"],Bp={class:"settings-tab-content"},Ap={class:"settings-tab-pane active"},Lp={class:"settings-tab-pane"},Fp={class:"settings-tab-pane"},Up={class:"settings-tab-pane"},Op={class:"settings-tab-pane"},zp={class:"settings-tab-pane"},Np={class:"settings-tab-pane"},Vp={class:"settings-tab-pane"},Wp=He({__name:"SettingsModal",props:{modelValue:{type:Boolean},initialTab:{}},emits:["update:modelValue","save"],setup(s,{emit:t}){const n=s,o=t,i=Le(),r=h(n.modelValue),l=h("ocr"),u=[{id:"ocr",label:"OCRè¯†åˆ«"},{id:"translate",label:"ç¿»è¯‘æœåŠ¡"},{id:"detection",label:"æ£€æµ‹è®¾ç½®"},{id:"hq",label:"é«˜è´¨é‡ç¿»è¯‘"},{id:"proofreading",label:"AIæ ¡å¯¹"},{id:"prompt-library",label:"æç¤ºè¯ç®¡ç†"},{id:"plugins",label:"æ’ä»¶ç®¡ç†"},{id:"more",label:"æ›´å¤š"}];Se(()=>n.modelValue,B=>{r.value=B,B?(document.body.style.overflow="hidden",n.initialTab&&u.some(O=>O.id===n.initialTab)&&(l.value=n.initialTab)):(document.body.style.overflow="",l.value="ocr")});function b(){r.value=!1,o("update:modelValue",!1),document.body.style.overflow=""}async function P(){i.saveToStorage();try{await i.saveToBackend(),console.log("[SettingsModal] è®¾ç½®å·²ä¿å­˜åˆ°åç«¯")}catch(B){console.warn("[SettingsModal] ä¿å­˜åˆ°åç«¯å¤±è´¥ï¼Œä»…ä¿å­˜åˆ° localStorage:",B)}o("save"),b()}function C(B){B.key==="Escape"&&r.value&&b()}return ut(()=>{document.addEventListener("keydown",C)}),At(()=>{document.removeEventListener("keydown",C),document.body.style.overflow=""}),(B,O)=>r.value?(E(),U("div",{key:0,class:"settings-modal",onClick:ot(b,["self"])},[e("div",Pp,[e("div",{class:"settings-modal-header"},[O[0]||(O[0]=e("h3",null,"âš™ï¸ è®¾ç½®",-1)),e("span",{class:"settings-modal-close",onClick:b},"Ã—")]),e("div",Mp,[(E(),U(Ae,null,Je(u,D=>e("button",{key:D.id,class:De(["settings-tab",{active:l.value===D.id}]),onClick:M=>l.value=D.id},ne(D.label),11,Ep)),64))]),e("div",Bp,[ae(e("div",Ap,[Ce(gu)],512),[[Ue,l.value==="ocr"]]),ae(e("div",Lp,[Ce(ec)],512),[[Ue,l.value==="translate"]]),ae(e("div",Fp,[Ce(Cc)],512),[[Ue,l.value==="detection"]]),ae(e("div",Up,[Ce(id)],512),[[Ue,l.value==="hq"]]),ae(e("div",Op,[Ce(sg)],512),[[Ue,l.value==="proofreading"]]),ae(e("div",zp,[Ce(wg)],512),[[Ue,l.value==="prompt-library"]]),ae(e("div",Np,[Ce(ep)],512),[[Ue,l.value==="plugins"]]),ae(e("div",Vp,[Ce(Rp)],512),[[Ue,l.value==="more"]])]),e("div",{class:"settings-modal-footer"},[e("button",{class:"btn btn-secondary",onClick:b},"å–æ¶ˆ"),e("button",{class:"btn btn-primary",onClick:P},"ä¿å­˜è®¾ç½®")])])])):de("",!0)}}),Kp=qe(Wp,[["__scopeId","data-v-e1ec20ab"]]),qp={minScale:.1,maxScale:5,zoomSpeed:.1};function cn(s={}){const t={...qp,...s},n=h(1),o=h(0),i=h(0),r=h(!1),l=h(0),u=h(0),b=J(()=>({transform:`translate(${o.value}px, ${i.value}px) scale(${n.value})`}));function P(Z,le,Q){const T=Math.min(Math.max(n.value*Q,t.minScale),t.maxScale),k=T/n.value;o.value=Z-(Z-o.value)*k,i.value=le-(le-i.value)*k,n.value=T,s.onScaleChange?.(n.value),s.onTransformChange?.(x())}function C(Z,le=800,Q=600){P(le/2,Q/2,Z)}function B(){C(1.2)}function O(){C(.8)}function D(Z,le=800,Q=600){const T=Z/n.value;P(le/2,Q/2,T)}function M(Z,le){r.value=!0,l.value=Z,u.value=le}function w(Z,le){if(!r.value)return;const Q=Z-l.value,T=le-u.value;o.value+=Q,i.value+=T,l.value=Z,u.value=le,s.onTransformChange?.(x())}function V(){r.value=!1}function q(Z,le){o.value+=Z,i.value+=le,s.onTransformChange?.(x())}function N(){n.value=1,o.value=0,i.value=0,s.onScaleChange?.(n.value),s.onTransformChange?.(x())}function m(){N()}function d(){n.value=1,o.value=0,i.value=0}function S(Z,le,Q,T){if(!Z||!le)return;const k=Q/Z,F=T/le;n.value=Math.min(k,F)*.95,o.value=(Q-Z*n.value)/2,i.value=(T-le*n.value)/2,s.onScaleChange?.(n.value),s.onTransformChange?.(x())}function x(){return{scale:n.value,translateX:o.value,translateY:i.value}}function K(Z){Z.scale!==void 0&&(n.value=Z.scale),Z.translateX!==void 0&&(o.value=Z.translateX),Z.translateY!==void 0&&(i.value=Z.translateY),s.onTransformChange?.(x())}function G(Z){n.value=Z.scale,o.value=Z.translateX,i.value=Z.translateY}function ie(Z,le,Q){if(!Z||Z.length<4)return;const[T,k,F,y]=Z,p=(T+F)/2,a=(k+y)/2,v=le/2,A=Q/2;o.value=v-p*n.value,i.value=A-a*n.value,s.onTransformChange?.(x())}return{scale:n,translateX:o,translateY:i,isDragging:r,transformStyle:b,zoomAt:P,zoom:C,zoomIn:B,zoomOut:O,setScale:D,startDrag:M,drag:w,endDrag:V,pan:q,reset:N,resetZoom:m,resetTransform:d,fitToScreen:S,getTransform:x,setTransform:K,syncWith:G,scrollToBubble:ie}}function Hp(s){const t=Xe(),n=Le(),o=h(null),i=h(ds),r=h(!1),l=h(!1),u=h([]),b=h(0),P=h(0);let C=null,B=null,O=null;const D=J(()=>o.value!==null),M=J(()=>o.value==="repair"?{fill:"rgba(76, 175, 80, 0.4)",border:"#4CAF50"}:o.value==="restore"?{fill:"rgba(33, 150, 243, 0.4)",border:"#2196F3"}:{fill:"transparent",border:"transparent"});function w(a){o.value!==a&&(o.value=a,r.value=!0,u.value=[],console.log(`è¿›å…¥${a==="repair"?"ä¿®å¤":"è¿˜åŸ"}ç¬”åˆ·æ¨¡å¼ï¼Œç¬”åˆ·å¤§å°: ${i.value}px`))}function V(){l.value&&K();const a=o.value!==null;o.value=null,r.value=!1,l.value=!1,u.value=[],le(),a&&console.log("é€€å‡ºç¬”åˆ·æ¨¡å¼")}function q(a){o.value===a?V():w(a)}function N(a){i.value=Math.max(jo,Math.min(Ho,a))}function m(a){N(i.value+a)}function d(a){if(!D.value)return;a.preventDefault(),a.stopPropagation();const v=a.deltaY>0?-5:5;m(v)}function S(a,v){if(!D.value||a.button!==0)return;a.preventDefault(),a.stopPropagation(),l.value=!0,C=v,u.value=[];const A=G(a,v);A&&(u.value.push(A),Z(v),Q(A)),console.log("å¼€å§‹ç¬”åˆ·æ¶‚æŠ¹")}function x(a){if(b.value=a.clientX,P.value=a.clientY,!l.value||!D.value)return;const v=G(a,C);v&&(u.value.push(v),Q(v))}function K(){if(!l.value)return;l.value=!1;const a=t.currentImage;if(!a||u.value.length===0){le(),u.value=[];return}const v=ie();if(!v){le(),u.value=[];return}const A=o.value;(async()=>{A==="restore"?await T(a,v):A==="repair"&&await k(a,v),s?.onBrushComplete?.()})(),le(),u.value=[]}function G(a,v){if(!v)return null;const A=v.querySelector(".image-canvas-wrapper"),_=A?.querySelector("img");if(!_||!_.naturalWidth)return null;const R=A.getBoundingClientRect(),I=window.getComputedStyle(A).transform;let g=1;I&&I!=="none"&&(g=new DOMMatrix(I).a);const L=(a.clientX-R.left)/g,c=(a.clientY-R.top)/g,f=_.naturalWidth,se=_.naturalHeight;return L<0||c<0||L>f||c>se?null:{x:L,y:c,scale:g}}function ie(){if(u.value.length===0)return null;const v=u.value[0]?.scale||1,A=i.value/2/v;let _=1/0,R=1/0,I=-1/0,g=-1/0;for(const L of u.value)_=Math.min(_,L.x-A),R=Math.min(R,L.y-A),I=Math.max(I,L.x+A),g=Math.max(g,L.y+A);return{x1:Math.max(0,Math.floor(_)),y1:Math.max(0,Math.floor(R)),x2:Math.ceil(I),y2:Math.ceil(g),path:[...u.value],radius:A}}function Z(a){le();const v=a.querySelector(".image-canvas-wrapper"),A=v?.querySelector("img");if(!A)return;const _=document.createElement("canvas");_.id="brushOverlayCanvas",_.width=A.naturalWidth,_.height=A.naturalHeight,_.style.cssText="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100;",v.appendChild(_),B=_,O=_.getContext("2d")}function le(){B&&B.parentNode&&B.parentNode.removeChild(B),B=null,O=null}function Q(a){if(!O||!a)return;const v=M.value.fill,A=i.value/2/(a.scale||1);O.beginPath(),O.arc(a.x,a.y,A,0,Math.PI*2),O.fillStyle=v,O.fill()}async function T(a,v){if(!a.originalDataURL)return;let A;return a.cleanImageData?A="data:image/png;base64,"+a.cleanImageData:A=a.originalDataURL,new Promise(_=>{const R=new Image,I=new Image;let g=0;const L=()=>{if(g++,g<2)return;const c=document.createElement("canvas");c.width=R.naturalWidth,c.height=R.naturalHeight;const f=c.getContext("2d");if(!f){_();return}f.drawImage(R,0,0);const se=document.createElement("canvas");se.width=c.width,se.height=c.height;const $=se.getContext("2d");if(!$){_();return}$.fillStyle="white";for(const ce of v.path)$.beginPath(),$.arc(ce.x,ce.y,v.radius,0,Math.PI*2),$.fill();f.globalCompositeOperation="destination-out",f.drawImage(se,0,0),f.globalCompositeOperation="destination-over",f.drawImage(I,0,0),f.globalCompositeOperation="source-over";const Y=c.toDataURL("image/png").split(",")[1];t.updateCurrentImage({cleanImageData:Y}),console.log("è¿˜åŸç¬”åˆ·åŒºåŸŸå®Œæˆ"),_()};R.onload=L,R.onerror=()=>_(),I.onload=L,I.onerror=()=>_(),R.src=A,I.src=a.originalDataURL})}async function k(a,v){const A=s?.getCurrentRepairSettings?.()||{inpaintMethod:"solid",fillColor:"#FFFFFF"},_=A.inpaintMethod;_==="lama_mpe"||_==="litelama"?await F(a,v,_):await y(a,v,A.fillColor)}async function F(a,v,A="lama_mpe"){let _,R;if(a.cleanImageData)_=a.cleanImageData,R="data:image/png;base64,"+a.cleanImageData;else if(a.originalDataURL)_=a.originalDataURL.split(",")[1],R=a.originalDataURL;else{console.error("æ— æ³•è·å–åŸºç¡€å›¾åƒç”¨äº LAMA ä¿®å¤");return}return new Promise(I=>{const g=new Image;g.onload=async()=>{const L=g.naturalWidth,c=g.naturalHeight,f=document.createElement("canvas");f.width=L,f.height=c;const se=f.getContext("2d");if(!se){console.error("æ— æ³•åˆ›å»ºæ©è†œç”»å¸ƒä¸Šä¸‹æ–‡"),I();return}se.fillStyle="black",se.fillRect(0,0,L,c),se.fillStyle="white";for(const we of v.path)se.beginPath(),se.arc(we.x,we.y,v.radius,0,Math.PI*2),se.fill();const Y=f.toDataURL("image/png").split(",")[1],ce=[v.x1,v.y1,v.x2,v.y2],_e=A==="litelama"?"litelama":"lama_mpe";try{he("LAMA ä¿®å¤ä¸­...","info");const we=await ho(_,ce,{method:"lama",lamaModel:_e,maskData:Y});if(we.success&&we.inpainted_image)t.updateCurrentImage({cleanImageData:we.inpainted_image}),console.log("ä¿®å¤ç¬”åˆ·åŒºåŸŸå®Œæˆï¼ˆLAMA ä¿®å¤ï¼Œç²¾ç¡®æ©è†œï¼‰"),he("LAMA ä¿®å¤å®Œæˆ","success");else throw new Error(we.error||"LAMA ä¿®å¤è¿”å›æ— æ•ˆæ•°æ®")}catch(we){console.error("LAMA ä¿®å¤å¤±è´¥ï¼Œå›é€€åˆ°çº¯è‰²å¡«å……:",we),he("LAMA ä¿®å¤å¤±è´¥ï¼Œä½¿ç”¨çº¯è‰²å¡«å……","warning");const $e=s?.getCurrentRepairSettings?.();await y(a,v,$e?.fillColor)}I()},g.onerror=()=>{console.error("åŠ è½½å›¾åƒå¤±è´¥ï¼Œæ— æ³•è¿›è¡Œ LAMA ä¿®å¤"),I()},g.src=R})}async function y(a,v,A){const _=A||n.settings.textStyle.fillColor||"#FFFFFF";let R;if(a.cleanImageData)R="data:image/png;base64,"+a.cleanImageData;else if(a.originalDataURL)R=a.originalDataURL;else return;return new Promise(I=>{const g=new Image;g.onload=()=>{const L=document.createElement("canvas");L.width=g.naturalWidth,L.height=g.naturalHeight;const c=L.getContext("2d");if(!c){I();return}c.drawImage(g,0,0),c.fillStyle=_;for(const se of v.path)c.beginPath(),c.arc(se.x,se.y,v.radius,0,Math.PI*2),c.fill();const f=L.toDataURL("image/png").split(",")[1];t.updateCurrentImage({cleanImageData:f}),console.log("ä¿®å¤ç¬”åˆ·åŒºåŸŸå®Œæˆï¼ˆçº¯è‰²å¡«å……ï¼‰"),I()},g.onerror=()=>I(),g.src=R})}async function p(){const a=t.currentImage;if(!a)return console.warn("ensureCleanBackground: æ²¡æœ‰å½“å‰å›¾ç‰‡"),!1;if(a.cleanImageData)return console.log("ensureCleanBackground: å·²æœ‰å¹²å‡€èƒŒæ™¯"),!0;const v=s?.getCurrentRepairSettings?.();if((v?.inpaintMethod||n.settings.textStyle.inpaintMethod)!=="solid")return console.log("ensureCleanBackground: éçº¯è‰²å¡«å……æ¨¡å¼ï¼Œè·³è¿‡"),!1;if(!a.bubbleStates||a.bubbleStates.length===0)return console.warn("ensureCleanBackground: æ²¡æœ‰æ°”æ³¡æ•°æ®"),!1;if(!a.translatedDataURL&&!a.originalDataURL)return console.warn("ensureCleanBackground: æ²¡æœ‰å›¾ç‰‡æ•°æ®"),!1;console.log("ensureCleanBackground: å°è¯•ä¸ºçº¯è‰²å¡«å……æ¨¡å¼åˆ›å»ºä¸´æ—¶å¹²å‡€èƒŒæ™¯");const _=a.translatedDataURL||a.originalDataURL,R=v?.fillColor||n.settings.textStyle.fillColor||"#FFFFFF";return new Promise(I=>{const g=new Image;g.onload=()=>{try{const L=document.createElement("canvas");L.width=g.naturalWidth,L.height=g.naturalHeight;const c=L.getContext("2d");if(!c){console.error("ensureCleanBackground: æ— æ³•è·å– Canvas ä¸Šä¸‹æ–‡"),I(!1);return}c.drawImage(g,0,0),c.fillStyle=R;for(const se of a.bubbleStates){const[$,Y,ce,_e]=se.coords;c.fillRect($,Y,ce-$+1,_e-Y+1)}const f=L.toDataURL("image/png").split(",")[1];t.updateCurrentImage({cleanImageData:f}),console.log("ensureCleanBackground: æˆåŠŸåˆ›å»ºä¸´æ—¶å¹²å‡€èƒŒæ™¯ï¼ˆçº¯è‰²å¡«å……ï¼‰"),I(!0)}catch(L){console.error("ensureCleanBackground: Canvas æ“ä½œå¤±è´¥:",L),I(!1)}},g.onerror=()=>{console.error("ensureCleanBackground: åŠ è½½å›¾åƒå¤±è´¥"),I(!1)},g.src=_})}return At(()=>{V()}),{brushMode:o,brushSize:i,isBrushKeyDown:r,isBrushPainting:l,mouseX:b,mouseY:P,isActive:D,brushColor:M,BRUSH_MIN_SIZE:jo,BRUSH_MAX_SIZE:Ho,enterBrushMode:w,exitBrushMode:V,toggleBrushMode:q,setBrushSize:N,adjustBrushSize:m,handleBrushWheel:d,startBrushPainting:S,continueBrushPainting:x,finishBrushPainting:K,getBrushPositionInImage:G,getBrushPathBounds:ie,ensureCleanBackground:p}}function jp(s){return[Math.round(s[0]),Math.round(s[1]),Math.round(s[2]),Math.round(s[3])]}function Jp(s){const t=ct(),n=Xe(),o=Le(),{bubbles:i,selectedIndex:r,hasSelection:l}=Ct(t),{currentImage:u}=Ct(n),b=h(!1),P=h(!1),C=h(null),B=h(0),O=h(0),D=h(!1);function M(c){t.selectBubble(c)}function w(c){t.toggleMultiSelect(c)}function V(){t.clearMultiSelect()}function q(c,f){console.log(`å¼€å§‹æ‹–åŠ¨æ°”æ³¡ #${c+1}`)}function N(c,f){}function m(c,f){t.updateBubble(c,{coords:f}),console.log(`æ°”æ³¡ #${c+1} æ‹–åŠ¨å®Œæˆ:`,f),A()}function d(c,f,se){console.log(`å¼€å§‹è°ƒæ•´æ°”æ³¡ #${c+1} å¤§å°ï¼Œæ‰‹æŸ„: ${f}`)}function S(c){}function x(c,f){t.updateBubble(c,{coords:f}),console.log(`æ°”æ³¡ #${c+1} è°ƒæ•´å¤§å°å®Œæˆ:`,f),A()}function K(c,f){console.log(`å¼€å§‹æ—‹è½¬æ°”æ³¡ #${c+1}`)}function G(c){}function ie(c,f){t.updateBubble(c,{rotationAngle:f}),console.log(`æ°”æ³¡ #${c+1} æ—‹è½¬å®Œæˆ: ${f}Â°`),A()}function Z(){b.value=!b.value,b.value?console.log("è¿›å…¥ç»˜åˆ¶æ¨¡å¼"):console.log("é€€å‡ºç»˜åˆ¶æ¨¡å¼")}function le(c){t.addBubble(c),t.selectBubble(t.bubbleCount-1),console.log("å·²æ·»åŠ æ–°æ°”æ³¡:",c),s?.onReRender?.()}function Q(c,f){P.value=!0,B.value=c,O.value=f,C.value=[c,f,c,f]}function T(c,f){P.value&&(C.value=[B.value,O.value,c,f])}function k(){if(!P.value||!C.value)return P.value=!1,C.value=null,null;const[c,f,se,$]=C.value,Y=10;if(Math.abs(se-c)<Y||Math.abs($-f)<Y)return P.value=!1,C.value=null,null;const ce=[Math.min(c,se),Math.min(f,$),Math.max(c,se),Math.max(f,$)];return P.value=!1,C.value=null,ce}function F(){P.value=!1,C.value=null,b.value=!1}function y(){if(!C.value)return{};const[c,f,se,$]=C.value;return{position:"absolute",left:`${Math.min(c,se)}px`,top:`${Math.min(f,$)}px`,width:`${Math.abs(se-c)}px`,height:`${Math.abs($-f)}px`,border:"2px dashed #00d4ff",background:"rgba(0, 212, 255, 0.1)",pointerEvents:"none",zIndex:"25",boxSizing:"border-box"}}let p=null,a=!1;const v=150;function A(){p&&clearTimeout(p),p=setTimeout(async()=>{if(a){console.log("è·³è¿‡æ¸²æŸ“ï¼Œä¸Šä¸€æ¬¡æ¸²æŸ“ä»åœ¨è¿›è¡Œä¸­");return}console.log("è§¦å‘å»¶è¿Ÿæ¸²æŸ“é¢„è§ˆ"),a=!0;try{s?.onDelayedPreview?await s.onDelayedPreview():s?.onReRender&&await s.onReRender()}catch(c){console.error("å»¶è¿Ÿæ¸²æŸ“é¢„è§ˆå¤±è´¥:",c)}finally{a=!1}},v)}function _(c){t.updateSelectedBubble(c),A()}function R(){l.value&&(t.deleteSelected(),console.log("å·²åˆ é™¤é€‰ä¸­çš„æ°”æ³¡"),s?.onReRender?.())}async function I(){const c=r.value;if(c<0){console.warn("è¯·å…ˆé€‰ä¸­è¦ä¿®å¤çš„æ°”æ³¡æ¡†");return}const f=i.value[c],se=u.value;if(!f||!se?.originalDataURL){console.warn("æ— æ³•ä¿®å¤èƒŒæ™¯ï¼šç¼ºå°‘æ°”æ³¡æˆ–å›¾ç‰‡æ•°æ®");return}const $=f.inpaintMethod||"solid",Y=f.fillColor||"#FFFFFF",ce=f.rotationAngle||0;try{console.log(`å¼€å§‹ä¿®å¤æ°”æ³¡ #${c+1} èƒŒæ™¯ï¼Œæ–¹æ³•: ${$}`);let _e;if(se.cleanImageData)_e=se.cleanImageData;else{const $e=se.originalDataURL.match(/^data:image\/[^;]+;base64,(.+)$/);if(_e=$e&&$e[1]?$e[1]:"",!_e){console.error("æ— æ³•è§£æå›¾åƒæ•°æ®");return}}if($==="lama_mpe"||$==="litelama"){const $e=$==="litelama"?"litelama":"lama_mpe",me=jp(f.coords),j=await ho(_e,me,{bubbleAngle:ce,method:"lama",lamaModel:$e});j.success&&j.inpainted_image?(n.updateCurrentImage({cleanImageData:j.inpainted_image}),console.log(`æ°”æ³¡ #${c+1} LAMAèƒŒæ™¯ä¿®å¤æˆåŠŸ`),A()):(console.error("LAMAä¿®å¤å¤±è´¥:",j.error||"æœªçŸ¥é”™è¯¯"),await g(f.coords,Y,ce),A())}else await g(f.coords,Y,ce),console.log(`æ°”æ³¡ #${c+1} çº¯è‰²å¡«å……ä¿®å¤æˆåŠŸ`),A()}catch(_e){console.error("èƒŒæ™¯ä¿®å¤å‡ºé”™:",_e)}}async function g(c,f,se=0){const $=u.value;if(!$)return;const[Y,ce,_e,we]=c;let $e;if($.cleanImageData)$e="data:image/png;base64,"+$.cleanImageData;else if($.originalDataURL)$e=$.originalDataURL;else{console.error("æ— æ³•æ‰¾åˆ°åŸºç¡€å›¾åƒç”¨äºå¡«å……");return}return new Promise(me=>{const j=new Image;j.onload=()=>{const W=document.createElement("canvas");W.width=j.naturalWidth,W.height=j.naturalHeight;const z=W.getContext("2d");if(!z){me();return}if(z.drawImage(j,0,0),z.fillStyle=f,Math.abs(se)<.1)z.fillRect(Y,ce,_e-Y,we-ce);else{const oe=(Y+_e)/2,re=(ce+we)/2,ve=(_e-Y)/2,xe=(we-ce)/2,ye=se*Math.PI/180,fe=Math.cos(ye),Re=Math.sin(ye),Ie=[[-ve,-xe],[ve,-xe],[ve,xe],[-ve,xe]].map(([Oe,Me])=>[oe+Oe*fe-Me*Re,re+Oe*Re+Me*fe]);z.beginPath();const Ve=Ie[0];if(Ve){z.moveTo(Ve[0],Ve[1]);for(let Oe=1;Oe<Ie.length;Oe++){const Me=Ie[Oe];Me&&z.lineTo(Me[0],Me[1])}}z.closePath(),z.fill()}const te=W.toDataURL("image/png").split(",")[1];n.updateCurrentImage({cleanImageData:te}),console.log("å·²å¯¹æ°”æ³¡åŒºåŸŸè¿›è¡Œçº¯è‰²å¡«å……:",c,f,"è§’åº¦:",se),me()},j.onerror=()=>{console.error("åŠ è½½åŸºç¡€å›¾åƒå¤±è´¥"),me()},j.src=$e})}async function L(c){const f=i.value[c],se=u.value;if(!f||!se?.originalDataURL){console.warn("æ— æ³•è¿›è¡Œ OCR è¯†åˆ«ï¼šç¼ºå°‘æ°”æ³¡æˆ–å›¾ç‰‡æ•°æ®");return}try{console.log(`å¼€å§‹ OCR è¯†åˆ«æ°”æ³¡ #${c+1}`);const $=se.originalDataURL.split(",")[1]||"",Y=o.settings,ce=await xn($,f.coords,Y.ocrEngine||"manga_ocr",{source_language:Y.sourceLanguage,baidu_ocr_api_key:Y.baiduOcr.apiKey,baidu_ocr_secret_key:Y.baiduOcr.secretKey,baidu_version:Y.baiduOcr.version,baidu_source_language:Y.baiduOcr.sourceLanguage,ai_vision_provider:Y.aiVisionOcr.provider,ai_vision_api_key:Y.aiVisionOcr.apiKey,ai_vision_model_name:Y.aiVisionOcr.modelName,ai_vision_ocr_prompt:Y.aiVisionOcr.prompt,custom_ai_vision_base_url:Y.aiVisionOcr.customBaseUrl,ai_vision_min_image_size:Y.aiVisionOcr.minImageSize});ce.success&&ce.text!==void 0?(t.updateBubble(c,{originalText:ce.text}),console.log(`OCR è¯†åˆ«æˆåŠŸ: "${ce.text}"`)):console.error("OCR è¯†åˆ«å¤±è´¥:",ce.error||"æœªçŸ¥é”™è¯¯")}catch($){console.error("OCR è¯†åˆ«å‡ºé”™:",$)}}return{isDrawingMode:b,isDrawingBox:P,currentDrawingRect:C,isMiddleButtonDown:D,handleBubbleSelect:M,handleBubbleMultiSelect:w,handleClearMultiSelect:V,handleBubbleDragStart:q,handleBubbleDragging:N,handleBubbleDragEnd:m,handleBubbleResizeStart:d,handleBubbleResizing:S,handleBubbleResizeEnd:x,handleBubbleRotateStart:K,handleBubbleRotating:G,handleBubbleRotateEnd:ie,toggleDrawingMode:Z,handleDrawBubble:le,startDrawingBox:Q,updateDrawingBox:T,finishDrawingBox:k,cancelDrawing:F,getDrawingRectStyle:y,handleBubbleUpdate:_,deleteSelectedBubbles:R,repairSelectedBubble:I,triggerDelayedPreview:A,handleOcrRecognize:L}}function Yp(s){const t=ct(),n=Xe(),{bubbles:o}=Ct(t),{currentImage:i}=Ct(n),r=h(!1),l=h("");let u=null;function b(){const B=i.value;if(!B)return null;if(B.cleanImageData)return B.cleanImageData;if(B.originalDataURL){const O=B.originalDataURL.match(/^data:image\/[^;]+;base64,(.+)$/);if(O&&O[1])return O[1]}return null}async function P(B=!1){if(!i.value)return console.warn("reRenderFullImage: æ²¡æœ‰å½“å‰å›¾ç‰‡"),!1;if(o.value.length===0){console.log("reRenderFullImage: æ²¡æœ‰æ°”æ³¡ï¼Œè·³è¿‡åç«¯æ¸²æŸ“");const w=b();if(w){const V=`data:image/png;base64,${w}`;n.updateCurrentImage({translatedDataURL:V}),B||s?.onRenderSuccess?.(V)}return!0}const D=b();if(!D)return console.error("reRenderFullImage: ç¼ºå°‘å›¾åƒæ•°æ®"),l.value="ç¼ºå°‘å›¾åƒæ•°æ®",B||s?.onRenderError?.("ç¼ºå°‘å›¾åƒæ•°æ®"),!1;const M=Symbol("render");u=M,r.value=!0,l.value="",B||s?.onRenderStart?.();try{console.log("reRenderFullImage: å¼€å§‹é‡æ–°æ¸²æŸ“ï¼Œæ°”æ³¡æ•°é‡:",o.value.length);const w=o.value,V=w.map(d=>d.translatedText||""),q=w.map(d=>d.coords.map(S=>Math.round(S))),N=w.map(d=>({translatedText:d.translatedText||"",coords:d.coords,fontSize:Number(d.fontSize)||24,fontFamily:d.fontFamily||ht,textDirection:wt(d),textColor:d.textColor||"#231816",rotationAngle:Math.round(Number(d.rotationAngle)||0),position:d.position?{x:Math.round(d.position.x||0),y:Math.round(d.position.y||0)}:{x:0,y:0},strokeEnabled:d.strokeEnabled!==void 0?d.strokeEnabled:!0,strokeColor:d.strokeColor||"#FFFFFF",strokeWidth:Number(d.strokeWidth)||3})),m=await bo({clean_image:D,bubble_texts:V,bubble_coords:q,bubble_states:N,fontSize:Number(w[0]?.fontSize)||24,fontFamily:w[0]?.fontFamily||ht,textDirection:w[0]?wt(w[0]):"vertical",textColor:w[0]?.textColor||"#231816",strokeEnabled:w[0]?.strokeEnabled!==void 0?w[0].strokeEnabled:!0,strokeColor:w[0]?.strokeColor||"#FFFFFF",strokeWidth:Number(w[0]?.strokeWidth)||3,use_individual_styles:!0,use_inpainting:!1,use_lama:!1,is_font_style_change:!0});if(u!==M)return console.log("reRenderFullImage: æ¸²æŸ“ç»“æœå·²è¿‡æœŸï¼Œå¿½ç•¥"),!1;if(m.rendered_image){const d=`data:image/png;base64,${m.rendered_image}`;return n.updateCurrentImage({translatedDataURL:d}),console.log("reRenderFullImage: æ¸²æŸ“æˆåŠŸ"),B||s?.onRenderSuccess?.(d),!0}else{const d=m.error||"æ¸²æŸ“å¤±è´¥";return console.error("reRenderFullImage: æ¸²æŸ“å¤±è´¥ -",d),l.value=d,B||s?.onRenderError?.(d),!1}}catch(w){if(u!==M)return!1;const V=w instanceof Error?w.message:"æ¸²æŸ“è¯·æ±‚å¤±è´¥";return console.error("reRenderFullImage: æ¸²æŸ“å‡ºé”™ -",w),l.value=V,B||s?.onRenderError?.(V),!1}finally{u===M&&(r.value=!1,B||s?.onRenderEnd?.())}}function C(){u=null,r.value=!1}return{isRendering:r,renderError:l,reRenderFullImage:P,cancelRender:C}}const Xp=["data-index","data-coords","data-rotation","onClick","onMousedown"],Gp={class:"bubble-index"},Zp=["data-parent-index","onMousedown"],Qp=["data-parent-index","onMousedown"],em=["data-parent-index","onMousedown"],tm=["data-parent-index","onMousedown"],om=["data-parent-index","onMousedown"],nm=["data-parent-index","onMousedown"],sm=["data-parent-index","onMousedown"],am=["data-parent-index","onMousedown"],lm=["data-parent-index","onMousedown"],im=He({__name:"BubbleOverlay",props:{bubbles:{},selectedIndex:{},selectedIndices:{},scale:{},isDrawingMode:{type:Boolean},isBrushMode:{type:Boolean},imageWidth:{},imageHeight:{}},emits:["select","multiSelect","dragStart","dragging","dragEnd","resizeStart","resizing","resizeEnd","rotateStart","rotating","rotateEnd","drawBubble"],setup(s,{emit:t}){const n=ct(),{isDragging:o,draggingIndex:i,dragOffsetX:r,dragOffsetY:l,dragInitialX:u,dragInitialY:b,isResizing:P,resizingIndex:C,resizeCurrentCoords:B,isRotating:O,rotatingIndex:D,rotateCurrentAngle:M}=Ct(n),w=s,V=t,q=h(null),N=h(0),m=h(0),d=h(""),S=h(0),x=h(0),K=h(null),G=h(0),ie=h(0),Z=h(0),le=h(0),Q=h(!1),T=h(0),k=h(0),F=h(null),y=h(!1);function p(W,z){let te,oe,re,ve,xe=W.rotationAngle||0;if(o.value&&i.value===z){const[Ie,Ve,Oe,Me]=W.coords;te=u.value+r.value,oe=b.value+l.value,re=te+(Oe-Ie),ve=oe+(Me-Ve)}else P.value&&C.value===z&&B.value?[te,oe,re,ve]=B.value:O.value&&D.value===z?([te,oe,re,ve]=W.coords,xe=M.value):[te,oe,re,ve]=W.coords;const ye=re-te,fe=ve-oe,Re={left:`${te}px`,top:`${oe}px`,width:`${ye}px`,height:`${fe}px`};return xe&&(Re.transformOrigin="center center",Re.transform=`rotate(${xe}deg)`),Re}function a(){if(!F.value)return{};const[W,z,te,oe]=F.value;return{left:`${Math.min(W,te)}px`,top:`${Math.min(z,oe)}px`,width:`${Math.abs(te-W)}px`,height:`${Math.abs(oe-z)}px`}}function v(W){if(!q.value)return null;const z=q.value.getBoundingClientRect(),te=w.scale||1,oe=(W.clientX-z.left)/te,re=(W.clientY-z.top)/te;return{x:oe,y:re}}function A(W,z){w.isBrushMode||z.shiftKey||V("select",W)}function _(W){if(!w.isBrushMode){if(W.button===1){W.preventDefault(),y.value=!0,document.body.classList.add("middle-button-drawing"),_e(W);return}W.button===0&&w.isDrawingMode&&_e(W)}}function R(W,z){if(!w.isBrushMode&&z.button===0){if(z.preventDefault(),z.stopPropagation(),z.shiftKey){V("multiSelect",W);return}if(W!==w.selectedIndex){V("select",W);return}I(W,z)}}function I(W,z){document.removeEventListener("mousemove",me),document.removeEventListener("mouseup",j),o.value=!0,i.value=W,N.value=z.clientX,m.value=z.clientY,r.value=0,l.value=0;const te=w.bubbles[W];te&&(u.value=te.coords[0],b.value=te.coords[1]),V("dragStart",W,z),document.addEventListener("mousemove",me),document.addEventListener("mouseup",j)}function g(W){const z=w.scale||1,te=(W.clientX-N.value)/z,oe=(W.clientY-m.value)/z;r.value=te,l.value=oe}function L(W){const z=i.value;o.value=!1,i.value=-1,r.value=0,l.value=0;const te=w.scale||1,oe=(W.clientX-N.value)/te,re=(W.clientY-m.value)/te,ve=w.bubbles[z];if(!ve)return;const[xe,ye,fe,Re]=ve.coords,Ie=fe-xe,Ve=Re-ye;let Oe=Math.round(u.value+oe),Me=Math.round(b.value+re);const Pe=w.imageWidth||2e3,Ge=w.imageHeight||2e3,at=Math.min(Ie,Pe),it=Math.min(Ve,Ge);Oe=Math.max(0,Math.min(Oe,Pe-at)),Me=Math.max(0,Math.min(Me,Ge-it));const Te=[Oe,Me,Oe+at,Me+it];V("dragEnd",z,Te)}function c(W,z,te){if(w.isBrushMode||te.button!==0)return;te.preventDefault(),te.stopPropagation(),document.removeEventListener("mousemove",me),document.removeEventListener("mouseup",j),P.value=!0,C.value=z,d.value=W,S.value=te.clientX,x.value=te.clientY;const oe=w.bubbles[z];oe&&(K.value=[...oe.coords],B.value=[...oe.coords]),V("resizeStart",z,W,te),document.addEventListener("mousemove",me),document.addEventListener("mouseup",j)}function f(W){if(!K.value)return;const z=w.scale||1,te=(W.clientX-S.value)/z,oe=(W.clientY-x.value)/z;let[re,ve,xe,ye]=K.value;const fe=d.value;fe.includes("w")&&(re+=te),fe.includes("e")&&(xe+=te),fe.includes("n")&&(ve+=oe),fe.includes("s")&&(ye+=oe),re>xe&&([re,xe]=[xe,re]),ve>ye&&([ve,ye]=[ye,ve]);const Re=10;xe-re<Re||ye-ve<Re||(B.value=[re,ve,xe,ye])}function se(W){if(!K.value)return;const z=w.scale||1,te=(W.clientX-S.value)/z,oe=(W.clientY-x.value)/z;let[re,ve,xe,ye]=K.value;const fe=d.value;fe.includes("w")&&(re+=te),fe.includes("e")&&(xe+=te),fe.includes("n")&&(ve+=oe),fe.includes("s")&&(ye+=oe),re>xe&&([re,xe]=[xe,re]),ve>ye&&([ve,ye]=[ye,ve]);const Re=w.imageWidth||2e3,Ie=w.imageHeight||2e3;re=Math.max(0,Math.round(re)),ve=Math.max(0,Math.round(ve)),xe=Math.min(Re,Math.round(xe)),ye=Math.min(Ie,Math.round(ye));const Ve=10;if(xe-re<Ve||ye-ve<Ve){console.warn("è°ƒæ•´åå°ºå¯¸è¿‡å°ï¼Œå·²æ’¤é”€"),P.value=!1,C.value=-1,K.value=null;return}V("resizeEnd",C.value,[re,ve,xe,ye]),P.value=!1,C.value=-1,K.value=null,B.value=null}function $(W,z){if(w.isBrushMode||z.button!==0)return;z.preventDefault(),z.stopPropagation(),document.removeEventListener("mousemove",me),document.removeEventListener("mouseup",j),O.value=!0,D.value=W;const te=w.bubbles[W];if(!te||!q.value)return;const[oe,re,ve,xe]=te.coords,ye=w.scale||1,fe=q.value.getBoundingClientRect();Z.value=fe.left+(oe+ve)/2*ye,le.value=fe.top+(re+xe)/2*ye;const Re=z.clientX-Z.value,Ie=z.clientY-le.value;G.value=Math.atan2(Ie,Re)*180/Math.PI,ie.value=te.rotationAngle||0,M.value=te.rotationAngle||0,V("rotateStart",W,z),document.body.classList.add("rotating-box"),document.addEventListener("mousemove",me),document.addEventListener("mouseup",j),console.log(`å¼€å§‹æ—‹è½¬æ°”æ³¡ #${W+1}ï¼Œåˆå§‹è§’åº¦: ${ie.value}Â°`)}function Y(W){const z=W.clientX-Z.value,te=W.clientY-le.value,re=Math.atan2(te,z)*180/Math.PI-G.value;let ve=ie.value+re;for(;ve>180;)ve-=360;for(;ve<-180;)ve+=360;W.shiftKey&&(ve=Math.round(ve/15)*15),M.value=ve}function ce(W){document.body.classList.remove("rotating-box");const z=D.value,te=M.value;V("rotateEnd",z,te),O.value=!1,D.value=-1,console.log(`æ°”æ³¡ #${z+1} æ—‹è½¬å®Œæˆï¼Œè§’åº¦: ${te}Â°`)}function _e(W){const z=v(W);if(!z)return;const te=w.imageWidth||2e3,oe=w.imageHeight||2e3;z.x<0||z.x>te||z.y<0||z.y>oe||(Q.value=!0,T.value=z.x,k.value=z.y,F.value=[z.x,z.y,z.x,z.y],document.addEventListener("mousemove",me),document.addEventListener("mouseup",j),console.log("å¼€å§‹ç»˜åˆ¶æ–°æ¡†:",z.x.toFixed(1),z.y.toFixed(1)))}function we(W){const z=v(W);!z||!F.value||(F.value=[T.value,k.value,z.x,z.y])}function $e(W){const z=v(W);if(y.value&&(y.value=!1,document.body.classList.remove("middle-button-drawing")),!z||!F.value){Q.value=!1,F.value=null;return}const te=w.imageWidth||2e3,oe=w.imageHeight||2e3,re=Math.max(0,Math.round(Math.min(T.value,z.x))),ve=Math.max(0,Math.round(Math.min(k.value,z.y))),xe=Math.min(te,Math.round(Math.max(T.value,z.x))),ye=Math.min(oe,Math.round(Math.max(k.value,z.y))),fe=10;if(xe-re<fe||ye-ve<fe){console.log("ç»˜åˆ¶çš„æ¡†å¤ªå°ï¼Œå·²å¿½ç•¥"),Q.value=!1,F.value=null;return}console.log("å®Œæˆç»˜åˆ¶æ–°æ¡†:",[re,ve,xe,ye]),V("drawBubble",[re,ve,xe,ye]),Q.value=!1,F.value=null}function me(W){o.value?g(W):P.value?f(W):O.value?Y(W):Q.value&&we(W)}function j(W){document.removeEventListener("mousemove",me),document.removeEventListener("mouseup",j),(W.button===1||y.value)&&(y.value=!1,document.body.classList.remove("middle-button-drawing")),o.value?L(W):P.value?se(W):O.value?ce():Q.value&&$e(W)}return ut(()=>{}),At(()=>{document.removeEventListener("mousemove",me),document.removeEventListener("mouseup",j),document.body.classList.remove("middle-button-drawing"),document.body.classList.remove("rotating-box")}),(W,z)=>(E(),U("div",{class:De(["bubble-overlay",{"brush-mode":s.isBrushMode}]),style:tt({"--scale":s.scale||1}),ref_key:"overlayRef",ref:q,onMousedown:_},[(E(!0),U(Ae,null,Je(s.bubbles,(te,oe)=>(E(),U("div",{key:oe,class:De(["bubble-highlight-box",{selected:oe===s.selectedIndex,"multi-selected":s.selectedIndices.length>1&&s.selectedIndices.includes(oe)&&oe!==s.selectedIndex}]),style:tt(p(te,oe)),"data-index":oe,"data-coords":JSON.stringify(te.coords),"data-rotation":te.rotationAngle||0,onClick:ot(re=>A(oe,re),["stop"]),onMousedown:ot(re=>R(oe,re),["stop"])},[e("span",Gp,ne(oe+1),1),oe===s.selectedIndex?(E(),U(Ae,{key:0},[e("div",{class:"resize-handle nw","data-handle":"nw","data-parent-index":oe,onMousedown:ot(re=>c("nw",oe,re),["stop"])},null,40,Zp),e("div",{class:"resize-handle n","data-handle":"n","data-parent-index":oe,onMousedown:ot(re=>c("n",oe,re),["stop"])},null,40,Qp),e("div",{class:"resize-handle ne","data-handle":"ne","data-parent-index":oe,onMousedown:ot(re=>c("ne",oe,re),["stop"])},null,40,em),e("div",{class:"resize-handle e","data-handle":"e","data-parent-index":oe,onMousedown:ot(re=>c("e",oe,re),["stop"])},null,40,tm),e("div",{class:"resize-handle se","data-handle":"se","data-parent-index":oe,onMousedown:ot(re=>c("se",oe,re),["stop"])},null,40,om),e("div",{class:"resize-handle s","data-handle":"s","data-parent-index":oe,onMousedown:ot(re=>c("s",oe,re),["stop"])},null,40,nm),e("div",{class:"resize-handle sw","data-handle":"sw","data-parent-index":oe,onMousedown:ot(re=>c("sw",oe,re),["stop"])},null,40,sm),e("div",{class:"resize-handle w","data-handle":"w","data-parent-index":oe,onMousedown:ot(re=>c("w",oe,re),["stop"])},null,40,am),z[0]||(z[0]=e("div",{class:"rotate-line"},null,-1)),e("div",{class:"rotate-handle",title:"æ‹–æ‹½æ—‹è½¬","data-parent-index":oe,onMousedown:ot(re=>$(oe,re),["stop"])},null,40,lm)],64)):de("",!0)],46,Xp))),128)),F.value?(E(),U("div",{key:0,class:"drawing-rect",style:tt(a())},null,4)):de("",!0)],38))}}),dn=qe(im,[["__scopeId","data-v-8d9cb1b9"]]),rm={key:0,class:"kana-keyboard"},um={class:"kana-keyboard-header"},cm={class:"kana-keyboard-tabs"},dm=["onClick"],gm={class:"kana-keyboard-options"},pm={class:"kana-mode-select"},mm={class:"kana-target-select"},vm={class:"kana-table"},fm={class:"row-label"},bm=["onClick"],hm={class:"kana-hiragana"},ym={class:"kana-katakana"},xm={class:"kana-table"},_m={class:"row-label"},Cm=["onClick"],Sm={class:"kana-hiragana"},km={class:"kana-katakana"},wm={class:"kana-table combo-table"},$m={class:"row-label"},Tm=["onClick"],Im={class:"kana-hiragana"},Dm={class:"kana-katakana"},Rm={class:"special-chars-grid"},Pm=["onClick"],Mm={key:0,class:"char-label"},Em=He({__name:"JapaneseKeyboard",props:{visible:{type:Boolean,default:!1},defaultTarget:{default:"original"}},emits:["close","insert","delete"],setup(s,{emit:t}){const n=s,o=t,i=h("basic"),r=h("hiragana"),l=h(n.defaultTarget),u=h(null),b=[{label:"åŸæ–‡",value:"original"},{label:"è¯‘æ–‡",value:"translated"}],P=[{id:"basic",label:"åŸºæœ¬"},{id:"dakuten",label:"æµŠ/åŠæµŠéŸ³"},{id:"combo",label:"æ‹—éŸ³"},{id:"special",label:"ç‰¹æ®Š"}],C=[{label:"ã‚è¡Œ",chars:[{h:"ã‚",k:"ã‚¢"},{h:"ã„",k:"ã‚¤"},{h:"ã†",k:"ã‚¦"},{h:"ãˆ",k:"ã‚¨"},{h:"ãŠ",k:"ã‚ª"}]},{label:"ã‹è¡Œ",chars:[{h:"ã‹",k:"ã‚«"},{h:"ã",k:"ã‚­"},{h:"ã",k:"ã‚¯"},{h:"ã‘",k:"ã‚±"},{h:"ã“",k:"ã‚³"}]},{label:"ã•è¡Œ",chars:[{h:"ã•",k:"ã‚µ"},{h:"ã—",k:"ã‚·"},{h:"ã™",k:"ã‚¹"},{h:"ã›",k:"ã‚»"},{h:"ã",k:"ã‚½"}]},{label:"ãŸè¡Œ",chars:[{h:"ãŸ",k:"ã‚¿"},{h:"ã¡",k:"ãƒ"},{h:"ã¤",k:"ãƒ„"},{h:"ã¦",k:"ãƒ†"},{h:"ã¨",k:"ãƒˆ"}]},{label:"ãªè¡Œ",chars:[{h:"ãª",k:"ãƒŠ"},{h:"ã«",k:"ãƒ‹"},{h:"ã¬",k:"ãƒŒ"},{h:"ã­",k:"ãƒ"},{h:"ã®",k:"ãƒ"}]},{label:"ã¯è¡Œ",chars:[{h:"ã¯",k:"ãƒ"},{h:"ã²",k:"ãƒ’"},{h:"ãµ",k:"ãƒ•"},{h:"ã¸",k:"ãƒ˜"},{h:"ã»",k:"ãƒ›"}]},{label:"ã¾è¡Œ",chars:[{h:"ã¾",k:"ãƒ"},{h:"ã¿",k:"ãƒŸ"},{h:"ã‚€",k:"ãƒ "},{h:"ã‚",k:"ãƒ¡"},{h:"ã‚‚",k:"ãƒ¢"}]},{label:"ã‚„è¡Œ",chars:[{h:"ã‚„",k:"ãƒ¤"},null,{h:"ã‚†",k:"ãƒ¦"},null,{h:"ã‚ˆ",k:"ãƒ¨"}]},{label:"ã‚‰è¡Œ",chars:[{h:"ã‚‰",k:"ãƒ©"},{h:"ã‚Š",k:"ãƒª"},{h:"ã‚‹",k:"ãƒ«"},{h:"ã‚Œ",k:"ãƒ¬"},{h:"ã‚",k:"ãƒ­"}]},{label:"ã‚è¡Œ",chars:[{h:"ã‚",k:"ãƒ¯"},null,null,null,{h:"ã‚’",k:"ãƒ²"}]},{label:"ã‚“",chars:[{h:"ã‚“",k:"ãƒ³"},null,null,null,null]}],B=[{label:"ãŒè¡Œ",chars:[{h:"ãŒ",k:"ã‚¬"},{h:"ã",k:"ã‚®"},{h:"ã",k:"ã‚°"},{h:"ã’",k:"ã‚²"},{h:"ã”",k:"ã‚´"}]},{label:"ã–è¡Œ",chars:[{h:"ã–",k:"ã‚¶"},{h:"ã˜",k:"ã‚¸"},{h:"ãš",k:"ã‚º"},{h:"ãœ",k:"ã‚¼"},{h:"ã",k:"ã‚¾"}]},{label:"ã è¡Œ",chars:[{h:"ã ",k:"ãƒ€"},{h:"ã¢",k:"ãƒ‚"},{h:"ã¥",k:"ãƒ…"},{h:"ã§",k:"ãƒ‡"},{h:"ã©",k:"ãƒ‰"}]},{label:"ã°è¡Œ",chars:[{h:"ã°",k:"ãƒ"},{h:"ã³",k:"ãƒ“"},{h:"ã¶",k:"ãƒ–"},{h:"ã¹",k:"ãƒ™"},{h:"ã¼",k:"ãƒœ"}]},{label:"ã±è¡Œ",chars:[{h:"ã±",k:"ãƒ‘"},{h:"ã´",k:"ãƒ”"},{h:"ã·",k:"ãƒ—"},{h:"ãº",k:"ãƒš"},{h:"ã½",k:"ãƒ"}]}],O=[{label:"ãã‚ƒè¡Œ",chars:[{h:"ãã‚ƒ",k:"ã‚­ãƒ£"},{h:"ãã‚…",k:"ã‚­ãƒ¥"},{h:"ãã‚‡",k:"ã‚­ãƒ§"}]},{label:"ã—ã‚ƒè¡Œ",chars:[{h:"ã—ã‚ƒ",k:"ã‚·ãƒ£"},{h:"ã—ã‚…",k:"ã‚·ãƒ¥"},{h:"ã—ã‚‡",k:"ã‚·ãƒ§"}]},{label:"ã¡ã‚ƒè¡Œ",chars:[{h:"ã¡ã‚ƒ",k:"ãƒãƒ£"},{h:"ã¡ã‚…",k:"ãƒãƒ¥"},{h:"ã¡ã‚‡",k:"ãƒãƒ§"}]},{label:"ã«ã‚ƒè¡Œ",chars:[{h:"ã«ã‚ƒ",k:"ãƒ‹ãƒ£"},{h:"ã«ã‚…",k:"ãƒ‹ãƒ¥"},{h:"ã«ã‚‡",k:"ãƒ‹ãƒ§"}]},{label:"ã²ã‚ƒè¡Œ",chars:[{h:"ã²ã‚ƒ",k:"ãƒ’ãƒ£"},{h:"ã²ã‚…",k:"ãƒ’ãƒ¥"},{h:"ã²ã‚‡",k:"ãƒ’ãƒ§"}]},{label:"ã¿ã‚ƒè¡Œ",chars:[{h:"ã¿ã‚ƒ",k:"ãƒŸãƒ£"},{h:"ã¿ã‚…",k:"ãƒŸãƒ¥"},{h:"ã¿ã‚‡",k:"ãƒŸãƒ§"}]},{label:"ã‚Šã‚ƒè¡Œ",chars:[{h:"ã‚Šã‚ƒ",k:"ãƒªãƒ£"},{h:"ã‚Šã‚…",k:"ãƒªãƒ¥"},{h:"ã‚Šã‚‡",k:"ãƒªãƒ§"}]},{label:"ãã‚ƒè¡Œ",chars:[{h:"ãã‚ƒ",k:"ã‚®ãƒ£"},{h:"ãã‚…",k:"ã‚®ãƒ¥"},{h:"ãã‚‡",k:"ã‚®ãƒ§"}]},{label:"ã˜ã‚ƒè¡Œ",chars:[{h:"ã˜ã‚ƒ",k:"ã‚¸ãƒ£"},{h:"ã˜ã‚…",k:"ã‚¸ãƒ¥"},{h:"ã˜ã‚‡",k:"ã‚¸ãƒ§"}]},{label:"ã³ã‚ƒè¡Œ",chars:[{h:"ã³ã‚ƒ",k:"ãƒ“ãƒ£"},{h:"ã³ã‚…",k:"ãƒ“ãƒ¥"},{h:"ã³ã‚‡",k:"ãƒ“ãƒ§"}]},{label:"ã´ã‚ƒè¡Œ",chars:[{h:"ã´ã‚ƒ",k:"ãƒ”ãƒ£"},{h:"ã´ã‚…",k:"ãƒ”ãƒ¥"},{h:"ã´ã‚‡",k:"ãƒ”ãƒ§"}]}],D=[{char:"ã£",label:"ä¿ƒéŸ³"},{char:"ãƒƒ",label:"ä¿ƒéŸ³"},{char:"ãƒ¼",label:"é•¿éŸ³"},{char:"ã€œ",label:"æ³¢æµª"},{char:"ã€‚",label:"å¥å·"},{char:"ã€",label:"é¡¿å·"},{char:"ã€Œ",label:"å¼•å·"},{char:"ã€",label:"å¼•å·"},{char:"ã€",label:"åŒå¼•"},{char:"ã€",label:"åŒå¼•"},{char:"â€¦",label:"çœç•¥"},{char:"ãƒ»",label:"ä¸­ç‚¹"},{char:"ï¼",label:"æ„Ÿå¹"},{char:"ï¼Ÿ",label:"é—®å·"},{char:"â™ª",label:"éŸ³ç¬¦"},{char:"â™¡",label:"å¿ƒå½¢"},{char:"â˜…",label:"æ˜Ÿå½¢"},{char:"â˜†",label:"ç©ºæ˜Ÿ"},{char:"ã",label:"å°ã‚"},{char:"ãƒ",label:"å°ã„"},{char:"ã…",label:"å°ã†"},{char:"ã‡",label:"å°ãˆ"},{char:"ã‰",label:"å°ãŠ"},{char:"ã‚¡",label:"å°ã‚¢"},{char:"ã‚£",label:"å°ã‚¤"},{char:"ã‚¥",label:"å°ã‚¦"},{char:"ã‚§",label:"å°ã‚¨"},{char:"ã‚©",label:"å°ã‚ª"},{char:"ã‚ƒ",label:"å°ã‚„"},{char:"ã‚…",label:"å°ã‚†"},{char:"ã‚‡",label:"å°ã‚ˆ"},{char:"ãƒ£",label:"å°ãƒ¤"},{char:"ãƒ¥",label:"å°ãƒ¦"},{char:"ãƒ§",label:"å°ãƒ¨"}];function M(){o("close")}function w(N){const m=r.value==="hiragana"?N.h:N.k;u.value=N.h,setTimeout(()=>{u.value=null},100),o("insert",m,l.value)}function V(N){u.value=N,setTimeout(()=>{u.value=null},100),o("insert",N,l.value)}function q(){o("delete",l.value)}return(N,m)=>s.visible?(E(),U("div",rm,[e("div",um,[m[3]||(m[3]=e("span",{class:"kana-keyboard-title"},"50éŸ³é”®ç›˜",-1)),e("div",cm,[(E(),U(Ae,null,Je(P,d=>e("button",{key:d.id,class:De(["kana-tab",{active:i.value===d.id}]),onClick:S=>i.value=d.id},ne(d.label),11,dm)),64))]),e("button",{class:"kana-keyboard-close",onClick:M},"âœ•")]),e("div",gm,[e("div",pm,[e("label",null,[ae(e("input",{type:"radio",name:"kanaMode",value:"hiragana","onUpdate:modelValue":m[0]||(m[0]=d=>r.value=d)},null,512),[[Zo,r.value]]),m[4]||(m[4]=pe(" å¹³å‡å ",-1))]),e("label",null,[ae(e("input",{type:"radio",name:"kanaMode",value:"katakana","onUpdate:modelValue":m[1]||(m[1]=d=>r.value=d)},null,512),[[Zo,r.value]]),m[5]||(m[5]=pe(" ç‰‡å‡å ",-1))])]),e("div",mm,[m[6]||(m[6]=e("label",null,"è¾“å…¥åˆ°ï¼š",-1)),Ce(Ne,{modelValue:l.value,"onUpdate:modelValue":m[2]||(m[2]=d=>l.value=d),options:b},null,8,["modelValue"])])]),e("div",{class:De(["kana-tab-content",{active:i.value==="basic"}])},[e("table",vm,[m[7]||(m[7]=e("thead",null,[e("tr",null,[e("th"),e("th",null,"ã‚æ®µ"),e("th",null,"ã„æ®µ"),e("th",null,"ã†æ®µ"),e("th",null,"ãˆæ®µ"),e("th",null,"ãŠæ®µ")])],-1)),e("tbody",null,[(E(),U(Ae,null,Je(C,d=>e("tr",{key:d.label},[e("td",fm,ne(d.label),1),(E(!0),U(Ae,null,Je(d.chars,(S,x)=>(E(),U("td",{key:x},[S?(E(),U("button",{key:0,class:De(["kana-key",{pressed:u.value===S.h}]),onClick:K=>w(S)},[e("span",hm,ne(S.h),1),e("span",ym,ne(S.k),1)],10,bm)):de("",!0)]))),128))])),64))])])],2),e("div",{class:De(["kana-tab-content",{active:i.value==="dakuten"}])},[e("table",xm,[m[8]||(m[8]=e("thead",null,[e("tr",null,[e("th"),e("th",null,"ã‚æ®µ"),e("th",null,"ã„æ®µ"),e("th",null,"ã†æ®µ"),e("th",null,"ãˆæ®µ"),e("th",null,"ãŠæ®µ")])],-1)),e("tbody",null,[(E(),U(Ae,null,Je(B,d=>e("tr",{key:d.label},[e("td",_m,ne(d.label),1),(E(!0),U(Ae,null,Je(d.chars,(S,x)=>(E(),U("td",{key:x},[S?(E(),U("button",{key:0,class:De(["kana-key",{pressed:u.value===S.h}]),onClick:K=>w(S)},[e("span",Sm,ne(S.h),1),e("span",km,ne(S.k),1)],10,Cm)):de("",!0)]))),128))])),64))])])],2),e("div",{class:De(["kana-tab-content",{active:i.value==="combo"}])},[e("table",wm,[m[9]||(m[9]=e("thead",null,[e("tr",null,[e("th"),e("th",null,"ã‚ƒ"),e("th",null,"ã‚…"),e("th",null,"ã‚‡")])],-1)),e("tbody",null,[(E(),U(Ae,null,Je(O,d=>e("tr",{key:d.label},[e("td",$m,ne(d.label),1),(E(!0),U(Ae,null,Je(d.chars,(S,x)=>(E(),U("td",{key:x},[S?(E(),U("button",{key:0,class:De(["kana-key",{pressed:u.value===S.h}]),onClick:K=>w(S)},[e("span",Im,ne(S.h),1),e("span",Dm,ne(S.k),1)],10,Tm)):de("",!0)]))),128))])),64))])])],2),e("div",{class:De(["kana-tab-content",{active:i.value==="special"}])},[e("div",Rm,[(E(),U(Ae,null,Je(D,d=>e("button",{key:d.char,class:De(["kana-key special-key",{pressed:u.value===d.char}]),onClick:S=>V(d.char)},[pe(ne(d.char)+" ",1),d.label?(E(),U("span",Mm,ne(d.label),1)):de("",!0)],10,Pm)),64))])],2),e("div",{class:"kana-keyboard-footer"},[e("button",{class:"kana-backspace",onClick:q},"âŒ« é€€æ ¼")])])):de("",!0)}}),Bm=qe(Em,[["__scopeId","data-v-ebfc2125"]]),Am={class:"edit-panel-content"},Lm={class:"text-column original-text-column text-block"},Fm={class:"text-column translated-text-column text-block"},Um={class:"style-settings-section text-block"},Om={class:"office-toolbar"},zm={class:"toolbar-row toolbar-row-top"},Nm={class:"combo-control font-control"},Vm={class:"combo-control size-control"},Wm={class:"size-input-wrap"},Km=["min","max","step"],qm={class:"toolbar-row toolbar-row-actions"},Hm={class:"toolbar-icon-group","aria-label":"æ’ç‰ˆæ–¹å‘"},jm=["data-active"],Jm=["data-active"],Ym={class:"toolbar-color-group"},Xm={class:"toolbar-color-picker",title:"æ–‡å­—é¢œè‰²"},Gm={class:"toolbar-inpaint-group",title:"èƒŒæ™¯ä¿®å¤æ–¹å¼"},Zm={class:"toolbar-stroke-cluster"},Qm=["data-active"],ev={class:"toolbar-row toolbar-row-bottom"},tv={class:"toolbar-rotation-group",title:"æ—‹è½¬è§’åº¦"},ov={class:"toolbar-position-group",title:"ä½ç½®è°ƒæ•´"},nv={class:"toolbar-position-value"},sv={class:"fontsize-presets-panel"},av={class:"font-size-presets"},lv=["onClick"],Nt=2,iv=He({__name:"BubbleEditor",props:{bubble:{},bubbleIndex:{}},emits:["update","reRender","ocrRecognize","reTranslate","applyBubble","resetCurrent"],setup(s,{emit:t}){const n=s,o=t,i=ct(),r={originalText:"",translatedText:"",fontSize:24,fontFamily:ht,textDirection:"vertical",textColor:"#231816",fillColor:"#FFFFFF",strokeEnabled:!0,strokeColor:"#FFFFFF",strokeWidth:3,rotationAngle:0,inpaintMethod:"solid",position:{x:0,y:0}},l=h(""),u=h(""),b=h(24),P=h(ht),C=h("vertical"),B=h("#231816"),O=h("#FFFFFF"),D=h(!0),M=h("#FFFFFF"),w=h(3),V=h(0),q=h("solid"),N=h(0),m=h(0),d=h(null),S=h(null),x=h(null),K=h(null),G=h(null),ie=h(!1),Z=h("original"),le=h([{name:"æ€æºé»‘ä½“",path:ht},{name:"åæ–‡æ¥·ä½“",path:"fonts/STKAITI.TTF"},{name:"åæ–‡ç»†é»‘",path:"fonts/STXIHEI.TTF"},{name:"é»‘ä½“",path:"fonts/SIMHEI.TTF"},{name:"å®‹ä½“",path:"fonts/SIMSUN.TTC"}]),Q=h([]),T=J(()=>n.bubble?n.bubble.coords[0]+N.value:0),k=J(()=>n.bubble?n.bubble.coords[1]+m.value:0),F=J(()=>{const Te=[{label:"ç³»ç»Ÿå­—ä½“",options:le.value.map(ee=>({label:ee.name,value:ee.path}))}];return Q.value.length>0&&Te.push({label:"è‡ªå®šä¹‰å­—ä½“",options:Q.value.map(ee=>({label:ee.name,value:ee.path}))}),Te}),y=[{label:"çº¯è‰²å¡«å……",value:"solid"},{label:"LAMAä¿®å¤(æ¼«ç”»)",value:"lama_mpe"},{label:"LAMAä¿®å¤(é€šç”¨)",value:"litelama"}];function p(Te){const ee=Te||r;l.value=ee.originalText,u.value=ee.translatedText,b.value=ee.fontSize,P.value=ee.fontFamily,C.value=ee.textDirection,B.value=ee.textColor,O.value=ee.fillColor,D.value=ee.strokeEnabled,M.value=ee.strokeColor,w.value=ee.strokeWidth,V.value=ee.rotationAngle,q.value=ee.inpaintMethod,N.value=ee.position?.x||0,m.value=ee.position?.y||0}Se(()=>n.bubble,Te=>{p(Te)},{deep:!0,immediate:!0});function a(){o("update",{originalText:l.value})}function v(){o("update",{translatedText:u.value})}function A(){navigator.clipboard.writeText(l.value)}function _(){navigator.clipboard.writeText(u.value)}function R(){o("update",{fontSize:b.value})}function I(Te){b.value=Te,o("update",{fontSize:Te})}function g(){b.value=Math.min(Jo,b.value+lo),o("update",{fontSize:b.value})}function L(){b.value=Math.max(Yo,b.value-lo),o("update",{fontSize:b.value})}function c(){o("update",{fontFamily:P.value})}function f(Te){C.value=Te,o("update",{textDirection:Te})}function se(){x.value?.click()}function $(){o("update",{textColor:B.value})}function Y(){K.value?.click()}function ce(){o("update",{fillColor:O.value})}function _e(){G.value?.click()}function we(){o("update",{strokeColor:M.value})}function $e(){D.value=!D.value,o("update",{strokeEnabled:D.value})}function me(){o("update",{strokeWidth:w.value})}function j(){o("update",{inpaintMethod:q.value})}function W(){o("update",{rotationAngle:V.value})}function z(){V.value=Math.max(-180,V.value-5),o("update",{rotationAngle:V.value})}function te(){V.value=Math.min(180,V.value+5),o("update",{rotationAngle:V.value})}function oe(){V.value=0,o("update",{rotationAngle:0})}function re(){N.value-=Nt,o("update",{position:{x:N.value,y:m.value}})}function ve(){N.value+=Nt,o("update",{position:{x:N.value,y:m.value}})}function xe(){m.value-=Nt,o("update",{position:{x:N.value,y:m.value}})}function ye(){m.value+=Nt,o("update",{position:{x:N.value,y:m.value}})}function fe(){N.value=0,m.value=0,o("update",{position:{x:0,y:0}})}function Re(){o("applyBubble",n.bubbleIndex)}function Ie(){i.updateAllBubbles({fontSize:b.value,fontFamily:P.value,textDirection:C.value,textColor:B.value,fillColor:O.value,strokeEnabled:D.value,strokeColor:M.value,strokeWidth:w.value,inpaintMethod:q.value}),console.log("æ ·å¼å·²åº”ç”¨åˆ°æ‰€æœ‰æ°”æ³¡"),o("reRender")}function Ve(){o("resetCurrent",n.bubbleIndex)}function Oe(){o("ocrRecognize",n.bubbleIndex)}function Me(){o("reTranslate",n.bubbleIndex)}function Pe(){ie.value=!ie.value}function Ge(Te,ee){if(ee==="original"){const be=d.value;if(be){const Ke=be.selectionStart||l.value.length,Ze=be.selectionEnd||l.value.length,ft=l.value;l.value=ft.slice(0,Ke)+Te+ft.slice(Ze),gt(()=>{be.selectionStart=be.selectionEnd=Ke+Te.length,be.focus()}),o("update",{originalText:l.value})}}else{const be=S.value;if(be){const Ke=be.selectionStart||u.value.length,Ze=be.selectionEnd||u.value.length,ft=u.value;u.value=ft.slice(0,Ke)+Te+ft.slice(Ze),gt(()=>{be.selectionStart=be.selectionEnd=Ke+Te.length,be.focus()}),o("update",{translatedText:u.value})}}}function at(Te){if(Te==="original"){const ee=d.value;if(ee&&l.value.length>0){const be=ee.selectionStart||l.value.length,Ke=ee.selectionEnd||l.value.length,Ze=l.value;be===Ke&&be>0?(l.value=Ze.slice(0,be-1)+Ze.slice(Ke),gt(()=>{ee.selectionStart=ee.selectionEnd=be-1,ee.focus()})):be!==Ke&&(l.value=Ze.slice(0,be)+Ze.slice(Ke),gt(()=>{ee.selectionStart=ee.selectionEnd=be,ee.focus()})),o("update",{originalText:l.value})}}else{const ee=S.value;if(ee&&u.value.length>0){const be=ee.selectionStart||u.value.length,Ke=ee.selectionEnd||u.value.length,Ze=u.value;be===Ke&&be>0?(u.value=Ze.slice(0,be-1)+Ze.slice(Ke),gt(()=>{ee.selectionStart=ee.selectionEnd=be-1,ee.focus()})):be!==Ke&&(u.value=Ze.slice(0,be)+Ze.slice(Ke),gt(()=>{ee.selectionStart=ee.selectionEnd=be,ee.focus()})),o("update",{translatedText:u.value})}}}async function it(){try{const Te=await Rs();if(Te.fonts){const ee=[],be=[];for(const Ke of Te.fonts){const Ze={name:typeof Ke=="string"?Ke:Ke.display_name||Ke.file_name||"",path:typeof Ke=="string"?Ke:Ke.path};Ze.path.startsWith("fonts/")?ee.push(Ze):be.push(Ze)}ee.length>0&&(le.value=ee),Q.value=be}}catch(Te){console.error("åŠ è½½å­—ä½“åˆ—è¡¨å¤±è´¥:",Te)}}return ut(()=>{it()}),(Te,ee)=>(E(),U("div",Am,[e("div",Lm,[e("div",{class:"text-column-header"},[ee[13]||(ee[13]=e("span",{class:"column-title"},"ğŸ‡¯ğŸ‡µ æ—¥è¯­åŸæ–‡ (OCRç»“æœ)",-1)),e("button",{class:"re-ocr-btn",onClick:Oe,title:"é‡æ–°OCRæ­¤æ°”æ³¡"},"ğŸ”„")]),ae(e("textarea",{ref_key:"originalTextInput",ref:d,"onUpdate:modelValue":ee[0]||(ee[0]=be=>l.value=be),class:"text-editor original-editor",placeholder:"OCRè¯†åˆ«çš„æ—¥è¯­åŸæ–‡...",spellcheck:"false",onInput:a},null,544),[[ke,l.value]]),e("div",{class:"text-actions"},[e("button",{class:"copy-btn",onClick:A},"ğŸ“‹ å¤åˆ¶"),e("button",{class:"keyboard-toggle-btn",onClick:Pe,title:"æ˜¾ç¤º/éšè—50éŸ³é”®ç›˜"}," âŒ¨ï¸ 50éŸ³ ")]),Ce(Bm,{visible:ie.value,"default-target":Z.value,onClose:ee[1]||(ee[1]=be=>ie.value=!1),onInsert:Ge,onDelete:at},null,8,["visible","default-target"])]),e("div",Fm,[e("div",{class:"text-column-header"},[ee[14]||(ee[14]=e("span",{class:"column-title"},"ğŸ‡¨ğŸ‡³ ä¸­æ–‡è¯‘æ–‡",-1)),e("button",{class:"re-translate-btn",onClick:Me,title:"é‡æ–°ç¿»è¯‘æ­¤æ°”æ³¡"}," ğŸ”„ ")]),ae(e("textarea",{ref_key:"translatedTextInput",ref:S,"onUpdate:modelValue":ee[2]||(ee[2]=be=>u.value=be),class:"text-editor translated-editor",placeholder:"ç¿»è¯‘åçš„ä¸­æ–‡...",spellcheck:"false",onInput:v},null,544),[[ke,u.value]]),e("div",{class:"text-actions"},[e("button",{class:"copy-btn",onClick:_},"ğŸ“‹ å¤åˆ¶"),e("button",{class:"apply-text-btn",onClick:Re},"âœ“ åº”ç”¨æ–‡æœ¬")])]),e("div",Um,[e("div",Om,[e("div",zm,[e("div",Nm,[ee[15]||(ee[15]=e("label",null,"å­—ä½“",-1)),Ce(Ne,{modelValue:P.value,"onUpdate:modelValue":ee[3]||(ee[3]=be=>P.value=be),groups:F.value,title:"å­—ä½“",onChange:c},null,8,["modelValue","groups"])]),e("div",Vm,[ee[16]||(ee[16]=e("label",null,"å­—å·",-1)),e("div",Wm,[ae(e("input",{type:"number","onUpdate:modelValue":ee[4]||(ee[4]=be=>b.value=be),class:"toolbar-fontsize-input",min:H(Yo),max:H(Jo),step:H(lo),title:"å­—å·",onChange:R},null,40,Km),[[ke,b.value,void 0,{number:!0}]]),e("div",{class:"toolbar-fontsize-btns"},[e("button",{class:"toolbar-fontsize-btn",onClick:g,title:"å¢å¤§å­—å·"}," A+ "),e("button",{class:"toolbar-fontsize-btn",onClick:L,title:"å‡å°å­—å·"}," A- ")])])])]),e("div",qm,[e("div",Hm,[e("button",{class:"toolbar-btn","data-active":C.value==="vertical",onClick:ee[5]||(ee[5]=be=>f("vertical")),title:"ç«–å‘æ’ç‰ˆ"},[...ee[17]||(ee[17]=[e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("path",{d:"M8 2v12M8 2L5 5M8 2l3 3",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])],8,jm),e("button",{class:"toolbar-btn","data-active":C.value==="horizontal",onClick:ee[6]||(ee[6]=be=>f("horizontal")),title:"æ¨ªå‘æ’ç‰ˆ"},[...ee[18]||(ee[18]=[e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("path",{d:"M2 8h12M14 8l-3-3M14 8l-3 3",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])],8,Jm)]),ee[24]||(ee[24]=e("div",{class:"toolbar-divider vertical"},null,-1)),e("div",Ym,[e("div",Xm,[e("button",{class:"toolbar-btn toolbar-color-btn",onClick:se},[ee[19]||(ee[19]=e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("text",{x:"3",y:"11","font-size":"10","font-weight":"bold",fill:"currentColor"},"A")],-1)),e("span",{class:"color-indicator",style:tt({background:B.value})},null,4)]),ae(e("input",{ref_key:"textColorInput",ref:x,type:"color","onUpdate:modelValue":ee[7]||(ee[7]=be=>B.value=be),class:"hidden-color-input",onInput:$,onChange:$},null,544),[[ke,B.value]])])]),ee[25]||(ee[25]=e("div",{class:"toolbar-divider vertical"},null,-1)),e("div",Gm,[Ce(Ne,{modelValue:q.value,"onUpdate:modelValue":ee[8]||(ee[8]=be=>q.value=be),options:y,onChange:j},null,8,["modelValue"]),e("div",{class:De(["toolbar-color-picker toolbar-solid-color-options",{hidden:q.value!=="solid"}])},[e("button",{class:"toolbar-btn toolbar-color-btn",onClick:Y},[ee[20]||(ee[20]=e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("rect",{x:"2",y:"2",width:"12",height:"12",rx:"2",fill:"none",stroke:"currentColor","stroke-width":"1.2"}),e("rect",{x:"4",y:"4",width:"8",height:"8",rx:"1",fill:"currentColor",opacity:"0.3"})],-1)),e("span",{class:"color-indicator",style:tt({background:O.value})},null,4)]),ae(e("input",{ref_key:"fillColorInput",ref:K,type:"color","onUpdate:modelValue":ee[9]||(ee[9]=be=>O.value=be),class:"hidden-color-input",onChange:ce},null,544),[[ke,O.value]])],2)]),ee[26]||(ee[26]=e("div",{class:"toolbar-divider vertical"},null,-1)),e("div",Zm,[e("button",{class:"toolbar-btn","data-active":D.value,onClick:$e,title:"æ–‡å­—æè¾¹"},[...ee[21]||(ee[21]=[e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("text",{x:"3",y:"12","font-size":"11","font-weight":"bold",stroke:"currentColor","stroke-width":"2",fill:"none"}," A "),e("text",{x:"3",y:"12","font-size":"11","font-weight":"bold",fill:"currentColor"},"A")],-1)])],8,Qm),e("div",{class:De(["toolbar-color-picker toolbar-stroke-options",{hidden:!D.value}]),title:"æè¾¹é¢œè‰²"},[e("button",{class:"toolbar-btn toolbar-color-btn",onClick:_e},[ee[22]||(ee[22]=e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("circle",{cx:"8",cy:"8",r:"5",fill:"none",stroke:"currentColor","stroke-width":"2"})],-1)),e("span",{class:"color-indicator",style:tt({background:M.value})},null,4)]),ae(e("input",{ref_key:"strokeColorInput",ref:G,type:"color","onUpdate:modelValue":ee[10]||(ee[10]=be=>M.value=be),class:"hidden-color-input",onChange:we},null,544),[[ke,M.value]])],2),e("div",{class:De(["toolbar-stroke-width toolbar-stroke-options",{hidden:!D.value}]),title:"æè¾¹å®½åº¦"},[ae(e("input",{type:"number","onUpdate:modelValue":ee[11]||(ee[11]=be=>w.value=be),class:"toolbar-mini-input",min:"0",max:"10",onChange:me},null,544),[[ke,w.value,void 0,{number:!0}]]),ee[23]||(ee[23]=e("span",{class:"toolbar-unit"},"px",-1))],2)])]),e("div",ev,[e("div",tv,[e("button",{class:"toolbar-btn",onClick:z,title:"é€†æ—¶é’ˆæ—‹è½¬"},[...ee[27]||(ee[27]=[e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("path",{d:"M2 8a6 6 0 1 1 1.5 4",stroke:"currentColor","stroke-width":"1.5",fill:"none"}),e("path",{d:"M2 5v3.5h3.5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),ae(e("input",{type:"number","onUpdate:modelValue":ee[12]||(ee[12]=be=>V.value=be),class:"toolbar-mini-input toolbar-rotation-input",min:"-180",max:"180",step:"5",onChange:W},null,544),[[ke,V.value,void 0,{number:!0}]]),ee[29]||(ee[29]=e("span",{class:"toolbar-unit"},"Â°",-1)),e("button",{class:"toolbar-btn",onClick:te,title:"é¡ºæ—¶é’ˆæ—‹è½¬"},[...ee[28]||(ee[28]=[e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("path",{d:"M14 8a6 6 0 1 0-1.5 4",stroke:"currentColor","stroke-width":"1.5",fill:"none"}),e("path",{d:"M14 5v3.5h-3.5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),e("button",{class:"toolbar-btn toolbar-small-btn",onClick:oe,title:"é‡ç½®æ—‹è½¬"}," 0 ")]),ee[35]||(ee[35]=e("div",{class:"toolbar-divider vertical"},null,-1)),e("div",ov,[e("button",{class:"toolbar-btn",onClick:re,title:"å·¦ç§»"},[...ee[30]||(ee[30]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("path",{d:"M10 3L5 8l5 5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),e("button",{class:"toolbar-btn",onClick:ve,title:"å³ç§»"},[...ee[31]||(ee[31]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("path",{d:"M6 3l5 5-5 5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),e("button",{class:"toolbar-btn",onClick:xe,title:"ä¸Šç§»"},[...ee[32]||(ee[32]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("path",{d:"M3 10l5-5 5 5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),e("button",{class:"toolbar-btn",onClick:ye,title:"ä¸‹ç§»"},[...ee[33]||(ee[33]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("path",{d:"M3 6l5 5 5-5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),e("span",nv,[e("span",null,ne(T.value),1),ee[34]||(ee[34]=pe(",",-1)),e("span",null,ne(k.value),1)]),e("button",{class:"toolbar-btn toolbar-small-btn",onClick:fe,title:"é‡ç½®ä½ç½®"}," âŒ‚ ")])])]),e("details",sv,[ee[36]||(ee[36]=e("summary",null,"å­—å·é¢„è®¾",-1)),e("div",av,[(E(!0),U(Ae,null,Je(H(gs),be=>(E(),U("button",{key:be,class:De(["preset-btn",{active:b.value===be}]),onClick:Ke=>I(be)},ne(be),11,lv))),128))])]),e("div",{class:"edit-action-buttons"},[e("button",{class:"btn-apply",onClick:Re},"åº”ç”¨"),e("button",{class:"btn-apply-all",onClick:Ie},"åº”ç”¨å…¨éƒ¨"),e("button",{class:"btn-reset",onClick:Ve},"é‡ç½®")])])]))}}),rv=qe(iv,[["__scopeId","data-v-edcb1ca9"]]),uv={class:"edit-toolbar-wrapper"},cv={class:"edit-toolbar toolbar-row-1"},dv={class:"image-navigator"},gv=["disabled"],pv=["disabled"],mv={class:"bubble-navigator"},vv=["disabled"],fv={class:"bubble-indicator"},bv={id:"currentBubbleNum"},hv={id:"totalBubbleNum"},yv=["disabled"],xv={class:"view-controls"},_v={key:0,viewBox:"0 0 20 20",width:"16",height:"16"},Cv={key:1,viewBox:"0 0 20 20",width:"16",height:"16"},Sv={id:"zoomLevel"},kv={class:"edit-toolbar toolbar-row-2"},wv={class:"annotation-tools"},$v=["disabled"],Tv=["disabled"],Iv={key:0,class:"brush-size-indicator"},Dv={key:1,class:"brush-mode-hint"},Rv={class:"edit-progress-info"},Pv={class:"edit-progress-text"},Mv={class:"edit-progress-count"},Ev={class:"edit-progress-bar"},Bv={class:"quick-actions"},Av=He({__name:"EditToolbar",props:{currentImageIndex:{},imageCount:{},canGoPrevious:{type:Boolean},canGoNext:{type:Boolean},showThumbnails:{type:Boolean},hasBubbles:{type:Boolean},selectedBubbleIndex:{},bubbleCount:{},layoutMode:{},syncEnabled:{type:Boolean},scale:{},isDrawingMode:{type:Boolean},hasSelection:{type:Boolean},brushMode:{},brushSize:{},mouseX:{},mouseY:{},isProcessing:{type:Boolean},progressText:{},progressCurrent:{},progressTotal:{}},emits:["go-previous-image","go-next-image","toggle-thumbnails","select-previous-bubble","select-next-bubble","toggle-layout","toggle-view-mode","toggle-sync","fit-to-screen","zoom-in","zoom-out","reset-zoom","exit-edit-mode","auto-detect-bubbles","detect-all-images","translate-with-bubbles","toggle-drawing-mode","delete-selected-bubbles","repair-selected-bubble","activate-repair-brush","activate-restore-brush","apply-and-next"],setup(s){const t=s,n=J(()=>t.progressTotal===0?0:Math.round(t.progressCurrent/t.progressTotal*100)),o=J(()=>t.progressTotal>0&&t.progressCurrent>=t.progressTotal),i=J(()=>{const r=t.brushMode==="repair"?{fill:"rgba(76, 175, 80, 0.4)",border:"#4CAF50"}:{fill:"rgba(33, 150, 243, 0.4)",border:"#2196F3"};return{position:"fixed",left:`${t.mouseX}px`,top:`${t.mouseY}px`,width:`${t.brushSize}px`,height:`${t.brushSize}px`,borderRadius:"50%",border:`2px solid ${r.border}`,backgroundColor:r.fill,pointerEvents:"none",zIndex:99999,transform:"translate(-50%, -50%)",display:t.brushMode?"block":"none"}});return(r,l)=>(E(),U("div",uv,[e("div",cv,[e("div",dv,[e("button",{class:"nav-btn",disabled:!s.canGoPrevious,onClick:l[0]||(l[0]=u=>r.$emit("go-previous-image")),title:"ä¸Šä¸€å¼ å›¾ç‰‡ (PageUp)"}," â—€â—€ ",8,gv),e("span",{class:"image-indicator",onClick:l[1]||(l[1]=u=>r.$emit("toggle-thumbnails")),title:"ç‚¹å‡»å±•å¼€ç¼©ç•¥å›¾"},[l[23]||(l[23]=pe(" å›¾ ",-1)),e("span",null,ne(s.currentImageIndex+1),1),l[24]||(l[24]=pe(" / ",-1)),e("span",null,ne(s.imageCount),1)]),e("button",{class:"nav-btn",disabled:!s.canGoNext,onClick:l[2]||(l[2]=u=>r.$emit("go-next-image")),title:"ä¸‹ä¸€å¼ å›¾ç‰‡ (PageDown)"}," â–¶â–¶ ",8,pv),e("button",{class:De(["thumb-toggle-btn",{active:s.showThumbnails}]),onClick:l[3]||(l[3]=u=>r.$emit("toggle-thumbnails")),title:"æ˜¾ç¤º/éšè—ç¼©ç•¥å›¾"}," â˜· ",2)]),l[30]||(l[30]=e("div",{class:"toolbar-divider"},null,-1)),e("div",mv,[e("button",{id:"prevBubbleBtn",class:"nav-btn",disabled:!s.hasBubbles||s.selectedBubbleIndex<=0,onClick:l[4]||(l[4]=u=>r.$emit("select-previous-bubble")),title:"ä¸Šä¸€ä¸ªæ°”æ³¡ (â†)"}," â—€ ",8,vv),e("span",fv,[l[25]||(l[25]=pe(" æ°”æ³¡ ",-1)),e("span",bv,ne(s.selectedBubbleIndex>=0?s.selectedBubbleIndex+1:0),1),l[26]||(l[26]=pe(" / ",-1)),e("span",hv,ne(s.bubbleCount),1)]),e("button",{id:"nextBubbleBtn",class:"nav-btn",disabled:!s.hasBubbles||s.selectedBubbleIndex>=s.bubbleCount-1,onClick:l[5]||(l[5]=u=>r.$emit("select-next-bubble")),title:"ä¸‹ä¸€ä¸ªæ°”æ³¡ (â†’)"}," â–¶ ",8,yv)]),l[31]||(l[31]=e("div",{class:"toolbar-divider"},null,-1)),e("div",xv,[e("button",{class:"layout-toggle-btn",onClick:l[6]||(l[6]=u=>r.$emit("toggle-layout")),title:"åˆ‡æ¢å¸ƒå±€ï¼šå·¦å³/ä¸Šä¸‹"},[s.layoutMode==="horizontal"?(E(),U("svg",_v,[...l[27]||(l[27]=[e("rect",{x:"1",y:"2",width:"8",height:"16",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"},null,-1),e("rect",{x:"11",y:"2",width:"8",height:"16",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"},null,-1)])])):(E(),U("svg",Cv,[...l[28]||(l[28]=[e("rect",{x:"2",y:"1",width:"16",height:"8",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"},null,-1),e("rect",{x:"2",y:"11",width:"16",height:"8",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"},null,-1)])]))]),e("button",{class:"view-mode-btn",onClick:l[7]||(l[7]=u=>r.$emit("toggle-view-mode")),title:"åˆ‡æ¢è§†å›¾æ¨¡å¼"},[...l[29]||(l[29]=[e("span",{class:"dual-icon"},"â§‰",-1)])]),e("button",{class:De({active:s.syncEnabled}),onClick:l[8]||(l[8]=u=>r.$emit("toggle-sync")),title:"åŒæ­¥ç¼©æ”¾/æ‹–åŠ¨",style:{"font-size":"12px"}}," ğŸ”— ",2),e("button",{onClick:l[9]||(l[9]=u=>r.$emit("fit-to-screen")),title:"é€‚åº”å±å¹• (åŒå‡»)"},"â›¶"),e("button",{onClick:l[10]||(l[10]=u=>r.$emit("zoom-in")),title:"æ”¾å¤§ (+)"},"+"),e("span",Sv,ne(Math.round(s.scale*100))+"%",1),e("button",{onClick:l[11]||(l[11]=u=>r.$emit("zoom-out")),title:"ç¼©å° (-)"},"âˆ’"),e("button",{onClick:l[12]||(l[12]=u=>r.$emit("reset-zoom")),title:"åŸå§‹å¤§å°"},"1:1")]),l[32]||(l[32]=e("div",{class:"toolbar-spacer"},null,-1)),e("button",{class:"secondary-btn",onClick:l[13]||(l[13]=u=>r.$emit("exit-edit-mode"))},"é€€å‡ºç¼–è¾‘")]),e("div",kv,[e("div",wv,[e("button",{class:"annotation-btn detect-btn",onClick:l[14]||(l[14]=u=>r.$emit("auto-detect-bubbles")),title:"è‡ªåŠ¨æ£€æµ‹å½“å‰å›¾ç‰‡çš„æ–‡æœ¬æ¡†"},[...l[33]||(l[33]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("circle",{cx:"6",cy:"6",r:"4",fill:"none",stroke:"currentColor","stroke-width":"1.5"}),e("path",{d:"M9 9l4 4",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round"})],-1),e("span",null,"æ£€æµ‹",-1)])]),e("button",{class:"annotation-btn detect-btn",onClick:l[15]||(l[15]=u=>r.$emit("detect-all-images")),title:"æ‰¹é‡æ£€æµ‹æ‰€æœ‰å›¾ç‰‡"},[...l[34]||(l[34]=[uo('<svg viewBox="0 0 16 16" width="14" height="14" data-v-b7164359><circle cx="5" cy="5" r="2.5" fill="none" stroke="currentColor" stroke-width="1" data-v-b7164359></circle><path d="M7 7l2 2" stroke="currentColor" stroke-width="1" stroke-linecap="round" data-v-b7164359></path><circle cx="10" cy="10" r="2.5" fill="none" stroke="currentColor" stroke-width="1" data-v-b7164359></circle><path d="M12 12l2 2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" data-v-b7164359></path></svg><span data-v-b7164359>æ‰¹é‡æ£€æµ‹</span>',2)])]),e("button",{class:"annotation-btn primary-action-btn",onClick:l[16]||(l[16]=u=>r.$emit("translate-with-bubbles")),title:"ä½¿ç”¨å½“å‰æ–‡æœ¬æ¡†ç¿»è¯‘æ­¤å›¾ç‰‡"},[...l[35]||(l[35]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("path",{d:"M2 3h5M4.5 3v7M2 6h5",stroke:"currentColor","stroke-width":"1.2",fill:"none"}),e("path",{d:"M9 13l2-7 2 7M9.5 11h3",stroke:"currentColor","stroke-width":"1.2",fill:"none"})],-1),e("span",null,"ç¿»è¯‘",-1)])]),l[41]||(l[41]=e("div",{class:"toolbar-divider"},null,-1)),e("button",{class:De(["annotation-btn",{active:s.isDrawingMode}]),onClick:l[17]||(l[17]=u=>r.$emit("toggle-drawing-mode")),title:"æ·»åŠ æ°”æ³¡æ¡†ï¼ˆæˆ–ä¸­é”®æ‹–æ‹½ç»˜åˆ¶ï¼‰"},[...l[36]||(l[36]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("rect",{x:"3",y:"3",width:"10",height:"10",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"}),e("path",{d:"M8 5v6M5 8h6",stroke:"currentColor","stroke-width":"1.5"})],-1),e("span",null,"æ·»åŠ ",-1)])],2),e("button",{class:"annotation-btn",disabled:!s.hasSelection,onClick:l[18]||(l[18]=u=>r.$emit("delete-selected-bubbles")),title:"åˆ é™¤é€‰ä¸­æ°”æ³¡æ¡† (Delete)"},[...l[37]||(l[37]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("rect",{x:"3",y:"3",width:"10",height:"10",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"}),e("path",{d:"M5 8h6",stroke:"currentColor","stroke-width":"1.5"})],-1),e("span",null,"åˆ é™¤",-1)])],8,$v),e("button",{class:"annotation-btn",disabled:!s.hasSelection,onClick:l[19]||(l[19]=u=>r.$emit("repair-selected-bubble")),title:"ä¿®å¤é€‰ä¸­æ°”æ³¡èƒŒæ™¯ (R)"},[...l[38]||(l[38]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("path",{d:"M2 14l3-3m0 0l6-6 3 3-6 6m-3 0l-1 1 1-1z",fill:"none",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round"}),e("path",{d:"M11 5l-1-1 2-2 2 2-2 2-1-1z",fill:"currentColor"})],-1),e("span",null,"ä¿®å¤",-1)])],8,Tv),l[42]||(l[42]=e("div",{class:"toolbar-divider"},null,-1)),e("button",{class:De(["annotation-btn brush-btn",{active:s.brushMode==="repair"}]),onClick:l[20]||(l[20]=u=>r.$emit("activate-repair-brush")),title:"ä¿®å¤ç¬”åˆ· (æŒ‰ä½R+å·¦é”®æ‹–æ‹½)"},[...l[39]||(l[39]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("circle",{cx:"8",cy:"8",r:"5",fill:"none",stroke:"currentColor","stroke-width":"1.5"}),e("circle",{cx:"8",cy:"8",r:"2",fill:"currentColor"})],-1),e("span",null,"ä¿®å¤ç¬”åˆ·",-1)])],2),e("button",{class:De(["annotation-btn brush-btn",{active:s.brushMode==="restore"}]),onClick:l[21]||(l[21]=u=>r.$emit("activate-restore-brush")),title:"è¿˜åŸç¬”åˆ· (æŒ‰ä½U+å·¦é”®æ‹–æ‹½)"},[...l[40]||(l[40]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("circle",{cx:"8",cy:"8",r:"5",fill:"none",stroke:"currentColor","stroke-width":"1.5"}),e("path",{d:"M5 8h6M8 5v6",stroke:"currentColor","stroke-width":"1",transform:"rotate(45 8 8)"})],-1),e("span",null,"è¿˜åŸç¬”åˆ·",-1)])],2),s.brushMode?(E(),U("span",Iv," ç¬”åˆ·: "+ne(s.brushSize)+"px ",1)):de("",!0),l[43]||(l[43]=uo('<div class="help-tooltip-container" data-v-b7164359><button class="help-tooltip-btn" title="å¿«æ·é”®æ“ä½œå¸®åŠ©" data-v-b7164359><svg viewBox="0 0 16 16" width="14" height="14" data-v-b7164359><circle cx="8" cy="8" r="6.5" fill="none" stroke="currentColor" stroke-width="1.2" data-v-b7164359></circle><text x="8" y="11" text-anchor="middle" font-size="9" font-weight="bold" fill="currentColor" data-v-b7164359>?</text></svg><span class="help-btn-text" data-v-b7164359>å¿«æ·é”®</span></button><div class="help-tooltip-popup" data-v-b7164359><div class="help-section" data-v-b7164359><div class="help-title" data-v-b7164359>ğŸ–±ï¸ é¼ æ ‡æ“ä½œ</div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>å·¦é”®ç‚¹å‡»æ°”æ³¡</span><span class="help-desc" data-v-b7164359>é€‰æ‹©æ°”æ³¡</span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>Shift+å·¦é”®ç‚¹å‡»</span><span class="help-desc" data-v-b7164359>å¤šé€‰æ°”æ³¡</span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>å·¦é”®æ‹–æ‹½å››è§’/è¾¹</span><span class="help-desc" data-v-b7164359>è°ƒæ•´å¤§å°</span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>å·¦é”®æ‹–æ‹½æ¡†å†…éƒ¨</span><span class="help-desc" data-v-b7164359>ç§»åŠ¨æ°”æ³¡æ¡†</span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>ä¸­é”®æ‹–æ‹½</span><span class="help-desc" data-v-b7164359>ç»˜åˆ¶æ–°æ°”æ³¡æ¡†</span></div></div><div class="help-section" data-v-b7164359><div class="help-title" data-v-b7164359>âŒ¨ï¸ å¿«æ·é”®</div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>A / D</span><span class="help-desc" data-v-b7164359>åˆ‡æ¢ä¸Š/ä¸‹ä¸€å¼ å›¾ç‰‡</span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>Ctrl+Enter</span><span class="help-desc" data-v-b7164359>åº”ç”¨å¹¶è·³è½¬ä¸‹ä¸€å¼ </span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>Delete / Backspace</span><span class="help-desc" data-v-b7164359>åˆ é™¤é€‰ä¸­æ°”æ³¡</span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>æŒ‰ä½R+å·¦é”®æ‹–æ‹½</span><span class="help-desc" data-v-b7164359>ä¿®å¤ç¬”åˆ·</span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>æŒ‰ä½U+å·¦é”®æ‹–æ‹½</span><span class="help-desc" data-v-b7164359>è¿˜åŸç¬”åˆ·</span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>ç¬”åˆ·æ¨¡å¼ä¸‹æ»šè½®</span><span class="help-desc" data-v-b7164359>è°ƒæ•´ç¬”åˆ·å¤§å°</span></div></div></div></div>',1))]),s.brushMode?(E(),U("div",{key:0,class:"brush-cursor",style:tt(i.value)},null,4)):de("",!0),s.brushMode?(E(),U("div",Dv,ne(s.brushMode==="repair"?"ä¿®å¤ç¬”åˆ· (R)":"è¿˜åŸç¬”åˆ· (U)")+" - æ»šè½®è°ƒæ•´å¤§å° ",1)):de("",!0),s.isProcessing?(E(),U("div",{key:2,class:De(["edit-progress-container",{completed:o.value}])},[e("div",Rv,[e("span",Pv,ne(s.progressText),1),e("span",Mv,ne(s.progressCurrent)+"/"+ne(s.progressTotal),1)]),e("div",Ev,[e("div",{class:De(["edit-progress-fill",{animating:!o.value}]),style:tt({width:n.value+"%"})},null,6)])],2)):de("",!0),l[44]||(l[44]=e("div",{class:"toolbar-spacer"},null,-1)),e("div",Bv,[e("button",{class:"primary-btn",onClick:l[22]||(l[22]=u=>r.$emit("apply-and-next")),title:"åº”ç”¨æ›´æ”¹å¹¶è·³è½¬ä¸‹ä¸€å¼  (Ctrl+Enter)"}," åº”ç”¨å¹¶ä¸‹ä¸€å¼  ")])])]))}}),Lv=qe(Av,[["__scopeId","data-v-b7164359"]]),Fv={key:0,class:"edit-thumbnails-panel"},Uv={class:"thumbnails-scroll"},Ov=["onClick"],zv=["src","alt"],Nv={class:"thumb-index"},Vv=He({__name:"EditThumbnailPanel",props:{visible:{type:Boolean},images:{},currentImageIndex:{}},emits:["switch-to-image"],setup(s){return(t,n)=>s.visible?(E(),U("div",Fv,[e("div",Uv,[(E(!0),U(Ae,null,Je(s.images,(o,i)=>(E(),U("div",{key:o.id,class:De(["edit-thumbnail-item",{active:i===s.currentImageIndex}]),onClick:r=>t.$emit("switch-to-image",i)},[e("img",{src:o.translatedDataURL||o.originalDataURL,alt:`å›¾ç‰‡ ${i+1}`},null,8,zv),e("span",Nv,ne(i+1),1)],10,Ov))),128))])])):de("",!0)}}),Wv=qe(Vv,[["__scopeId","data-v-9d2a43d9"]]),Kv=["data-brush-mode"],qv={class:"edit-main-layout"},Hv={class:"image-comparison-container"},jv={class:"panel-header"},Jv=["src"],Yv={class:"panel-header"},Xv=["src"],Gv=He({__name:"EditWorkspace",props:{isEditModeActive:{type:Boolean}},emits:["exit"],setup(s,{emit:t}){const n=s,o=t,i=Xe(),r=ct(),{translateWithCurrentBubbles:l}=Co(),{reRenderFullImage:u}=Yp({onRenderStart:()=>console.log("å¼€å§‹é‡æ–°æ¸²æŸ“..."),onRenderSuccess:X=>console.log("æ¸²æŸ“æˆåŠŸ:",X.substring(0,50)+"..."),onRenderError:X=>console.error("æ¸²æŸ“å¤±è´¥:",X)}),{isDrawingMode:b,isDrawingBox:P,currentDrawingRect:C,isMiddleButtonDown:B,handleBubbleSelect:O,handleBubbleMultiSelect:D,handleClearMultiSelect:M,handleBubbleDragStart:w,handleBubbleDragging:V,handleBubbleDragEnd:q,handleBubbleResizeStart:N,handleBubbleResizing:m,handleBubbleResizeEnd:d,handleBubbleRotateStart:S,handleBubbleRotating:x,handleBubbleRotateEnd:K,toggleDrawingMode:G,handleDrawBubble:ie,getDrawingRectStyle:Z,handleBubbleUpdate:le,deleteSelectedBubbles:Q,repairSelectedBubble:T,handleOcrRecognize:k}=Jp({onReRender:()=>u(),onDelayedPreview:()=>u()}),F=h(0),y=h(0),{brushMode:p,brushSize:a,mouseX:v,mouseY:A,isBrushKeyDown:_,toggleBrushMode:R,exitBrushMode:I,startBrushPainting:g,continueBrushPainting:L,finishBrushPainting:c,adjustBrushSize:f}=Hp({onBrushComplete:()=>u(),getCurrentRepairSettings:()=>({inpaintMethod:Te.value,fillColor:ee.value})}),{images:se,currentImageIndex:$,currentImage:Y,imageCount:ce,canGoPrevious:_e,canGoNext:we}=Ct(i),{bubbles:$e,selectedIndex:me,selectedIndices:j,selectedBubble:W,bubbleCount:z,hasBubbles:te,hasSelection:oe}=Ct(r),re=J(()=>fe.value?.querySelector("img")?.naturalWidth||2e3),ve=J(()=>fe.value?.querySelector("img")?.naturalHeight||2e3),xe=h(null),ye=h(null),fe=h(null),Re=h(null),Ie=h(null),Ve=h(null),Oe=h("dual"),Me=h("horizontal"),Pe=h(!1),Ge=h(!0),at=h(!1),it=h(!1),Te=h("solid"),ee=h("#FFFFFF"),be=h(!1),Ke=h("å¤„ç†ä¸­..."),Ze=h(0),ft=h(0),nt=cn(),Qe=cn(),Ht=J(()=>Qe.scale.value),An=J(()=>Qe.translateX.value),Ln=J(()=>Qe.translateY.value),Fn=J(()=>nt.scale.value),yt=h(null),Un=J(()=>({transform:`translate(${nt.translateX.value}px, ${nt.translateY.value}px) scale(${nt.scale.value})`})),On=J(()=>({transform:`translate(${Qe.translateX.value}px, ${Qe.translateY.value}px) scale(${Qe.scale.value})`}));function So(){Qe.zoomIn(),Ge.value&&nt.setTransform(Qe.getTransform())}function ko(){Qe.zoomOut(),Ge.value&&nt.setTransform(Qe.getTransform())}function wo(){Qe.resetZoom(),Ge.value&&nt.setTransform(Qe.getTransform())}const jt=h(!1),zn=h(0),Jt=h(!1),Dt=h({x:0,y:0,size:0});function Yt(){p.value&&I(),Zt()}function Xt(){r.bubbles.length>0&&r.selectBubble(0)}function $o(){_e.value&&(Yt(),i.goToPrevious())}function Gt(){we.value&&(Yt(),i.goToNext())}function Nn(X){X!==$.value&&X>=0&&X<ce.value&&(Yt(),i.setCurrentImageIndex(X))}function Zt(){if(!Y.value)return;const X=Array.isArray(Y.value.bubbleStates);$e.value.length>0?(i.updateCurrentBubbleStates([...$e.value]),i.setManuallyAnnotated(!0),console.log("å·²ä¿å­˜æ°”æ³¡çŠ¶æ€åˆ°å½“å‰å›¾ç‰‡ï¼Œæ ‡è®°ä¸ºæ‰‹åŠ¨æ ‡æ³¨")):X&&(i.updateCurrentBubbleStates([]),i.setManuallyAnnotated(!0),console.log("å·²ä¿å­˜ç©ºæ°”æ³¡çŠ¶æ€åˆ°å½“å‰å›¾ç‰‡ï¼ˆç”¨æˆ·ä¸»åŠ¨æ¸…ç©ºï¼Œæ ‡è®°ä¸ºæ‰‹åŠ¨æ ‡æ³¨ï¼‰"))}function Rt(){Y.value?.bubbleStates?(r.setBubbles([...Y.value.bubbleStates],!0),console.log(`å·²åŠ è½½ ${Y.value.bubbleStates.length} ä¸ªæ°”æ³¡çŠ¶æ€`)):r.clearBubblesLocal(),Xt()}function Vn(){r.selectPrevious()}function Wn(){r.selectNext()}function Kn(){Pe.value=!Pe.value}function qn(){Me.value=Me.value==="horizontal"?"vertical":"horizontal";try{localStorage.setItem(Xo,Me.value)}catch(X){console.warn("ä¿å­˜å¸ƒå±€æ¨¡å¼å¤±è´¥:",X)}setTimeout(()=>{Pt()},300)}function Hn(){const X=["dual","original","translated"],ue=X.indexOf(Oe.value),ge=X[(ue+1)%X.length];ge&&(Oe.value=ge)}function jn(){Ge.value=!Ge.value,console.log("åŒå›¾åŒæ­¥:",Ge.value?"å¼€å¯":"å…³é—­"),Ge.value&&nt.setTransform(Qe.getTransform())}function Pt(){const X=Re.value||ye.value,ue=Ie.value||fe.value;if(!X||!ue)return;const ge=ue.querySelector("img");if(!ge||!ge.naturalWidth)return;const je=X.getBoundingClientRect(),Fe=je.width/ge.naturalWidth,Ee=je.height/ge.naturalHeight,ze=Math.min(Fe,Ee)*.95,Be=(je.width-ge.naturalWidth*ze)/2,bt=(je.height-ge.naturalHeight*ze)/2,xt={scale:ze,translateX:Be,translateY:bt};Qe.setTransform(xt),nt.setTransform(xt)}function To(X,ue){if(p.value){const Be=X.deltaY>0?-5:5;f(Be);return}const ge=X.currentTarget.getBoundingClientRect(),je=X.clientX-ge.left,Fe=X.clientY-ge.top,Ee=X.deltaY>0?.9:1.1,ze=ue==="original"?nt:Qe;ze.zoomAt(je,Fe,Ee),Ge.value&&(ue==="original"?Qe:nt).setTransform(ze.getTransform())}function Io(X,ue){if(p.value){const ge=ue==="original"?ye.value:Re.value;ge&&g(X,ge);return}if(X.button===1){B.value=!0,Po(X,ue),X.preventDefault();return}if(b.value&&X.button===0){Po(X,ue),X.preventDefault();return}if(X.button===0){if(X.target.closest(".bubble-highlight-box"))return;X.shiftKey||M(),yt.value=ue,(ue==="original"?nt:Qe).startDrag(X.clientX,X.clientY),document.addEventListener("mousemove",Do),document.addEventListener("mouseup",Ro),X.preventDefault()}}function Do(X){if(!yt.value)return;const ue=yt.value==="original"?nt:Qe;ue.drag(X.clientX,X.clientY),Ge.value&&(yt.value==="original"?Qe:nt).setTransform(ue.getTransform())}function Ro(){yt.value&&(yt.value==="original"?nt:Qe).endDrag(),yt.value=null,document.removeEventListener("mousemove",Do),document.removeEventListener("mouseup",Ro)}let Qt="translated";function Po(X,ue="translated"){Qt=ue;const ge=ue==="original"?fe.value:Ie.value,je=ue==="original"?nt:Qe;if(!ge)return;const Fe=ge.getBoundingClientRect(),Ee=(X.clientX-Fe.left)/je.scale.value,ze=(X.clientY-Fe.top)/je.scale.value;F.value=Ee,y.value=ze,P.value=!0,C.value=[Ee,ze,Ee,ze],document.addEventListener("mousemove",eo),document.addEventListener("mouseup",to)}function eo(X){if(!P.value)return;const ue=Qt==="original"?fe.value:Ie.value,ge=Qt==="original"?nt:Qe;if(!ue)return;const je=ue.getBoundingClientRect(),Fe=(X.clientX-je.left)/ge.scale.value,Ee=(X.clientY-je.top)/ge.scale.value;C.value=[Math.min(F.value,Fe),Math.min(y.value,Ee),Math.max(F.value,Fe),Math.max(y.value,Ee)]}function to(X){document.removeEventListener("mousemove",eo),document.removeEventListener("mouseup",to);const ue=B.value;if(!P.value||!C.value){P.value=!1,C.value=null,B.value=!1;return}const[ge,je,Fe,Ee]=C.value,ze=Fe-ge,Be=Ee-je;ze>10&&Be>10&&(r.addBubble(C.value),r.selectBubble(r.bubbleCount-1),console.log("å·²æ·»åŠ æ–°æ°”æ³¡:",C.value)),P.value=!1,C.value=null,B.value=!1,!ue&&b.value&&(b.value=!1)}function Mo(X){console.log(`${X} å›¾ç‰‡åŠ è½½å®Œæˆ`),Ht.value===1&&An.value===0&&Ln.value===0&&gt(()=>{Pt()})}function Jn(){u()}function Yn(X){X.inpaintMethod!==void 0&&(Te.value=X.inpaintMethod),X.fillColor!==void 0&&(ee.value=X.fillColor),me.value>=0&&le(X)}function Xn(X){he("æ–‡æœ¬å·²åº”ç”¨","success"),u()}function Gn(X){const ue=r.initialStates[X];if(!ue){console.warn(`æ— æ³•é‡ç½®æ°”æ³¡ #${X+1}ï¼šæ‰¾ä¸åˆ°åˆå§‹çŠ¶æ€`),he("æ— æ³•é‡ç½®ï¼šæ‰¾ä¸åˆ°åˆå§‹çŠ¶æ€","warning");return}const ge=JSON.parse(JSON.stringify(ue));r.updateBubble(X,ge),console.log(`æ°”æ³¡ #${X+1} å·²é‡ç½®åˆ°åˆå§‹çŠ¶æ€`),he("æ°”æ³¡å·²é‡ç½®","success"),u()}async function Zn(X){const ue=$e.value[X];if(!ue?.originalText){console.warn("æ— æ³•é‡æ–°ç¿»è¯‘ï¼šç¼ºå°‘æ°”æ³¡æˆ–åŸæ–‡");return}try{console.log(`å¼€å§‹é‡æ–°ç¿»è¯‘æ°”æ³¡ #${X+1}`);const{translateSingleText:ge}=await lt(async()=>{const{translateSingleText:ze}=await Promise.resolve().then(()=>Bs);return{translateSingleText:ze}},void 0),{useSettingsStore:je}=await lt(async()=>{const{useSettingsStore:ze}=await import("./system.cK6ld5_8.js").then(Be=>Be.s);return{useSettingsStore:ze}},__vite__mapDeps([0,1,2,3,4,5])),Fe=je().settings,Ee=await ge({original_text:ue.originalText,model_provider:Fe.translation.provider,api_key:Fe.translation.apiKey,model_name:Fe.translation.modelName,custom_base_url:Fe.translation.customBaseUrl,target_language:Fe.targetLanguage,prompt_content:void 0});Ee.success&&Ee.data?.translated_text?(r.updateBubble(X,{translatedText:Ee.data.translated_text}),console.log(`ç¿»è¯‘æˆåŠŸ: "${Ee.data.translated_text}"`),u()):console.error("ç¿»è¯‘å¤±è´¥:",Ee.error||"æœªçŸ¥é”™è¯¯")}catch(ge){console.error("ç¿»è¯‘å‡ºé”™:",ge)}}function Eo(X,ue){for(X.bubbleTexts||(X.bubbleTexts=[]),X.originalTexts||(X.originalTexts=[]);X.bubbleTexts.length<ue;)X.bubbleTexts.push("");for(;X.originalTexts.length<ue;)X.originalTexts.push("")}function Bo(X,ue,ge){const je=X.auto_directions||[];return X.bubble_coords.map((Fe,Ee)=>{const ze=Fe[0]??0,Be=Fe[1]??0,bt=Fe[2]??0,xt=Fe[3]??0;let pt;return je[Ee]?pt=je[Ee]==="v"?"vertical":"horizontal":pt=xt-Be>bt-ze?"vertical":"horizontal",{coords:Fe,originalText:ue.originalTexts?.[Ee]||"",translatedText:ue.bubbleTexts?.[Ee]||"",textboxText:"",fontSize:ge.fontSize,fontFamily:ge.fontFamily,textDirection:pt,autoTextDirection:pt,textColor:ge.textColor,fillColor:ge.fillColor,strokeEnabled:ge.strokeEnabled,strokeColor:ge.strokeColor,strokeWidth:ge.strokeWidth,rotationAngle:X.bubble_angles?.[Ee]||0,inpaintMethod:ge.inpaintMethod,position:{x:0,y:0},polygon:[]}})}async function Qn(){const X=Y.value;if(!X?.originalDataURL){he("æ²¡æœ‰æœ‰æ•ˆçš„å›¾ç‰‡ç”¨äºæ£€æµ‹","warning");return}try{he("æ­£åœ¨è‡ªåŠ¨æ£€æµ‹æ–‡æœ¬æ¡†...","info");const ge=X.originalDataURL.match(/^data:image\/[^;]+;base64,(.+)$/)?.[1]||"";if(!ge){he("æ— æ³•è§£æå›¾ç‰‡æ•°æ®","error");return}const je=Le(),{textDetector:Fe,boxExpand:Ee,textStyle:ze}=je.settings,Be=await co(ge,Fe,{box_expand_ratio:Ee.ratio,box_expand_top:Ee.top,box_expand_bottom:Ee.bottom,box_expand_left:Ee.left,box_expand_right:Ee.right});if(Be.success&&Be.bubble_coords){i.updateCurrentImage({bubbleCoords:Be.bubble_coords,bubbleAngles:Be.bubble_angles||[]}),Eo(X,Be.bubble_coords.length);const bt={bubble_coords:Be.bubble_coords.map(pt=>[...pt]),bubble_angles:Be.bubble_angles,auto_directions:Be.auto_directions},xt=Bo(bt,X,ze);r.setBubbles(xt),Xt(),he(`è‡ªåŠ¨æ£€æµ‹åˆ° ${Be.bubble_coords.length} ä¸ªæ–‡æœ¬æ¡†`,"success")}else he(Be.error||"æ£€æµ‹å¤±è´¥","error")}catch(ue){console.error("è‡ªåŠ¨æ£€æµ‹å¤±è´¥:",ue),he("è‡ªåŠ¨æ£€æµ‹å¤±è´¥","error")}}async function es(){if(se.value.length<=1){he("è‡³å°‘éœ€è¦ä¸¤å¼ å›¾ç‰‡æ‰èƒ½æ‰§è¡Œæ‰¹é‡æ£€æµ‹","warning");return}if(!confirm("æ­¤æ“ä½œå°†å¯¹æ‰€æœ‰å›¾ç‰‡è¿›è¡Œæ–‡æœ¬æ¡†æ£€æµ‹ï¼Œå¯èƒ½ä¼šè¦†ç›–å·²æœ‰çš„æ£€æµ‹ç»“æœã€‚ç¡®å®šç»§ç»­å—ï¼Ÿ"))return;const X=Le(),{textDetector:ue,boxExpand:ge,textStyle:je}=X.settings,Fe=$.value,Ee=se.value.length;be.value=!0,Ke.value="æ‰¹é‡æ£€æµ‹ä¸­",ft.value=Ee,Ze.value=0;try{let ze=0;for(let Be=0;Be<Ee;Be++){const bt=se.value[Be];if(!bt?.originalDataURL)continue;Ze.value=Be+1;const pt=bt.originalDataURL.match(/^data:image\/[^;]+;base64,(.+)$/)?.[1]||"";if(!pt)continue;const mt=await co(pt,ue,{box_expand_ratio:ge.ratio,box_expand_top:ge.top,box_expand_bottom:ge.bottom,box_expand_left:ge.left,box_expand_right:ge.right});if(mt.success&&mt.bubble_coords){const St=se.value[Be];if(St){St.bubbleCoords=mt.bubble_coords,St.bubbleAngles=mt.bubble_angles||[],Eo(St,mt.bubble_coords.length);const ls={bubble_coords:mt.bubble_coords.map(is=>[...is]),bubble_angles:mt.bubble_angles,auto_directions:mt.auto_directions};St.bubbleStates=Bo(ls,St,je),ze+=mt.bubble_coords.length,Be===$.value&&Rt()}}}Ke.value="æ£€æµ‹å®Œæˆ",Ze.value=Ee,Fe!==$.value&&i.setCurrentImageIndex(Fe),Rt(),he(`æ‰¹é‡æ£€æµ‹å®Œæˆï¼å…±å¤„ç† ${Ee} å¼ å›¾ç‰‡ï¼Œæ£€æµ‹åˆ° ${ze} ä¸ªæ–‡æœ¬æ¡†`,"success"),setTimeout(()=>{be.value=!1},2e3)}catch(ze){console.error("æ‰¹é‡æ£€æµ‹å¤±è´¥:",ze),he("æ‰¹é‡æ£€æµ‹å¤±è´¥","error"),be.value=!1}}async function ts(){if(!Y.value?.originalDataURL){he("æ²¡æœ‰æœ‰æ•ˆçš„å›¾ç‰‡ç”¨äºç¿»è¯‘","warning");return}if($e.value.length===0){he("æ²¡æœ‰æ–‡æœ¬æ¡†å¯ç”¨äºç¿»è¯‘ï¼Œè¯·å…ˆæ£€æµ‹æˆ–æ·»åŠ æ–‡æœ¬æ¡†","warning");return}he("æ­£åœ¨ä½¿ç”¨å½“å‰æ–‡æœ¬æ¡†ç¿»è¯‘...","info");try{await l()&&(he("ç¿»è¯‘æˆåŠŸï¼","success"),Xt())}catch(ue){console.error("ç¿»è¯‘å¤±è´¥:",ue),he(`ç¿»è¯‘å¤±è´¥: ${ue instanceof Error?ue.message:"æœªçŸ¥é”™è¯¯"}`,"error")}}function os(){R("repair")}function ns(){R("restore")}function Ao(X){L(X)}function Lo(){c()}function ss(X){jt.value=!0,zn.value=Me.value==="horizontal"?X.clientX:X.clientY,document.body.style.cursor=Me.value==="horizontal"?"col-resize":"row-resize",document.body.style.userSelect="none",document.addEventListener("mousemove",oo),document.addEventListener("mouseup",no),X.preventDefault()}function oo(X){if(!jt.value)return;const ue=ye.value?.parentElement?.parentElement;if(!ue)return;const ge=ue.getBoundingClientRect();if(Me.value==="horizontal"){const je=X.clientX-ge.left,Fe=ge.width,Ee=Math.max(20,Math.min(80,je/Fe*100)),ze=ue.querySelector(".original-panel"),Be=ue.querySelector(".translated-panel");ze&&Be&&(ze.style.flex=`0 0 ${Ee}%`,Be.style.flex=`0 0 ${100-Ee}%`)}else{const je=X.clientY-ge.top,Fe=ge.height,Ee=Math.max(20,Math.min(80,je/Fe*100)),ze=ue.querySelector(".original-panel"),Be=ue.querySelector(".translated-panel");ze&&Be&&(ze.style.flex=`0 0 ${Ee}%`,Be.style.flex=`0 0 ${100-Ee}%`)}}function no(){jt.value=!1,document.body.style.cursor="",document.body.style.userSelect="",document.removeEventListener("mousemove",oo),document.removeEventListener("mouseup",no)}function as(X){Jt.value=!0;const ue=Ve.value;ue&&(Dt.value={x:X.clientX,y:X.clientY,size:Me.value==="horizontal"?ue.offsetWidth:ue.offsetHeight},document.body.style.cursor=Me.value==="horizontal"?"ew-resize":"ns-resize",document.body.style.userSelect="none",document.addEventListener("mousemove",so),document.addEventListener("mouseup",ao),X.preventDefault())}function so(X){if(!(!Jt.value||!Ve.value))if(Me.value==="horizontal"){const ue=Dt.value.x-X.clientX;let ge=Dt.value.size+ue;ge=Math.max(300,Math.min(window.innerWidth*.6,ge)),Ve.value.style.flex=`0 0 ${ge}px`,Ve.value.style.minWidth=`${ge}px`}else{const ue=Dt.value.y-X.clientY;let ge=Dt.value.size+ue;ge=Math.max(200,Math.min(window.innerHeight*.5,ge)),Ve.value.style.flex=`0 0 ${ge}px`,Ve.value.style.height=`${ge}px`}}function ao(){Jt.value=!1,document.body.style.cursor="",document.body.style.userSelect="",document.removeEventListener("mousemove",so),document.removeEventListener("mouseup",ao)}function Fo(X){const ue=X.target,ge=X.key.toLowerCase();if(ge==="r"||ge==="u"||ge==="a"||ge==="d"){if(ue.tagName==="TEXTAREA")return;(ue.tagName==="INPUT"||ue.tagName==="SELECT"||ue.tagName==="BUTTON")&&ue.blur()}else if(ue.tagName==="INPUT"||ue.tagName==="TEXTAREA"||ue.tagName==="SELECT")return;switch(X.key){case"Escape":zo();break;case"Delete":case"Backspace":!p.value&&oe.value&&(Q(),X.preventDefault());break;case"a":case"A":p.value||($o(),X.preventDefault());break;case"d":case"D":p.value||(Gt(),X.preventDefault());break;case"Enter":X.ctrlKey&&!p.value&&(Oo(),X.preventDefault());break;case"r":case"R":_.value||(R("repair"),X.preventDefault());break;case"u":case"U":_.value||(R("restore"),X.preventDefault());break;case"+":case"=":So(),X.preventDefault();break;case"-":ko(),X.preventDefault();break;case"0":wo(),X.preventDefault();break}}function Uo(X){(X.key==="r"||X.key==="R"||X.key==="u"||X.key==="U")&&(I(),X.preventDefault())}async function Oo(){Zt(),await u(),we.value?Gt():he("å·²æ˜¯æœ€åä¸€å¼ å›¾ç‰‡","info")}function zo(){Zt(),o("exit")}return ut(()=>{try{const X=localStorage.getItem(Xo);(X==="horizontal"||X==="vertical")&&(Me.value=X)}catch(X){console.warn("åŠ è½½å¸ƒå±€æ¨¡å¼å¤±è´¥:",X)}document.addEventListener("keydown",Fo),document.addEventListener("keyup",Uo),document.addEventListener("mousemove",Ao),document.addEventListener("mouseup",Lo),n.isEditModeActive&&(Rt(),gt(()=>{xe.value?.focus()}))}),At(()=>{document.removeEventListener("keydown",Fo),document.removeEventListener("keyup",Uo),document.removeEventListener("mousemove",Ao),document.removeEventListener("mouseup",Lo),document.removeEventListener("mousemove",eo),document.removeEventListener("mouseup",to),document.removeEventListener("mousemove",oo),document.removeEventListener("mouseup",no),document.removeEventListener("mousemove",so),document.removeEventListener("mouseup",ao)}),Se(()=>n.isEditModeActive,X=>{X&&(Rt(),gt(()=>{xe.value?.focus()}))}),Se($,()=>{n.isEditModeActive&&Rt()}),Se(W,X=>{X&&(Te.value=X.inpaintMethod||"solid",ee.value=X.fillColor||"#FFFFFF")},{immediate:!0}),(X,ue)=>s.isEditModeActive?(E(),U("div",{key:0,class:De(["edit-workspace",[`layout-${Me.value}`,{"drawing-mode":H(b)},{"brush-mode-active":!!H(p)}]]),"data-brush-mode":H(p)||void 0,tabindex:"0",ref_key:"workspaceRef",ref:xe},[Ce(Lv,{"current-image-index":H($),"image-count":H(ce),"can-go-previous":H(_e),"can-go-next":H(we),"show-thumbnails":Pe.value,"has-bubbles":H(te),"selected-bubble-index":H(me),"bubble-count":H(z),"layout-mode":Me.value,"sync-enabled":Ge.value,scale:Ht.value,"is-drawing-mode":H(b),"has-selection":H(oe),"brush-mode":H(p),"brush-size":H(a),"mouse-x":H(v),"mouse-y":H(A),"is-processing":be.value,"progress-text":Ke.value,"progress-current":Ze.value,"progress-total":ft.value,onGoPreviousImage:$o,onGoNextImage:Gt,onToggleThumbnails:Kn,onSelectPreviousBubble:Vn,onSelectNextBubble:Wn,onToggleLayout:qn,onToggleViewMode:Hn,onToggleSync:jn,onFitToScreen:Pt,onZoomIn:So,onZoomOut:ko,onResetZoom:wo,onExitEditMode:zo,onAutoDetectBubbles:Qn,onDetectAllImages:es,onTranslateWithBubbles:ts,onToggleDrawingMode:H(G),onDeleteSelectedBubbles:H(Q),onRepairSelectedBubble:H(T),onActivateRepairBrush:os,onActivateRestoreBrush:ns,onApplyAndNext:Oo},null,8,["current-image-index","image-count","can-go-previous","can-go-next","show-thumbnails","has-bubbles","selected-bubble-index","bubble-count","layout-mode","sync-enabled","scale","is-drawing-mode","has-selection","brush-mode","brush-size","mouse-x","mouse-y","is-processing","progress-text","progress-current","progress-total","onToggleDrawingMode","onDeleteSelectedBubbles","onRepairSelectedBubble"]),Ce(Wv,{visible:Pe.value,images:H(se),"current-image-index":H($),onSwitchToImage:Nn},null,8,["visible","images","current-image-index"]),e("div",qv,[e("div",Hv,[ae(e("div",{class:De(["image-panel original-panel",{collapsed:Oe.value==="translated"||at.value}])},[e("div",jv,[ue[8]||(ue[8]=e("span",{class:"panel-title"},"ğŸ“– åŸå›¾ (æ—¥æ–‡)",-1)),e("button",{class:"panel-toggle",onClick:ue[0]||(ue[0]=ge=>at.value=!at.value),title:"æŠ˜å /å±•å¼€"},ne(at.value?"+":"âˆ’"),1)]),e("div",{ref_key:"originalViewportRef",ref:ye,class:"image-viewport",onWheel:ue[2]||(ue[2]=ot(ge=>To(ge,"original"),["prevent"])),onMousedown:ue[3]||(ue[3]=ge=>Io(ge,"original")),onDblclick:Pt},[e("div",{ref_key:"originalWrapperRef",ref:fe,class:"image-canvas-wrapper",style:tt(Un.value)},[H(Y)?.originalDataURL?(E(),U("img",{key:0,src:H(Y).originalDataURL,alt:"åŸå›¾",onLoad:ue[1]||(ue[1]=ge=>Mo("original"))},null,40,Jv)):de("",!0),H(Y)?.originalDataURL?(E(),st(dn,{key:1,bubbles:H($e),"selected-index":H(me),"selected-indices":H(j),scale:Fn.value,"is-drawing-mode":H(b),"is-brush-mode":!!H(p),"image-width":re.value,"image-height":ve.value,onSelect:H(O),onMultiSelect:H(D),onDragStart:H(w),onDragging:H(V),onDragEnd:H(q),onResizeStart:H(N),onResizing:H(m),onResizeEnd:H(d),onRotateStart:H(S),onRotating:H(x),onRotateEnd:H(K),onDrawBubble:H(ie)},null,8,["bubbles","selected-index","selected-indices","scale","is-drawing-mode","is-brush-mode","image-width","image-height","onSelect","onMultiSelect","onDragStart","onDragging","onDragEnd","onResizeStart","onResizing","onResizeEnd","onRotateStart","onRotating","onRotateEnd","onDrawBubble"])):de("",!0),H(C)?(E(),U("div",{key:2,class:"drawing-rect-edit",style:tt(H(Z)())},null,4)):de("",!0)],4)],544)],2),[[Ue,Oe.value!=="translated"]]),Oe.value==="dual"?(E(),U("div",{key:0,class:De(["panel-divider",{"vertical-divider":Me.value==="vertical"}]),onMousedown:ss},null,34)):de("",!0),ae(e("div",{class:De(["image-panel translated-panel",{collapsed:Oe.value==="original"||it.value}])},[e("div",Yv,[ue[9]||(ue[9]=e("span",{class:"panel-title"},"ğŸ“ ç¿»è¯‘å›¾ (ä¸­æ–‡)",-1)),e("button",{class:"panel-toggle",onClick:ue[4]||(ue[4]=ge=>it.value=!it.value),title:"æŠ˜å /å±•å¼€"},ne(it.value?"+":"âˆ’"),1)]),e("div",{ref_key:"translatedViewportRef",ref:Re,class:"image-viewport",onWheel:ue[6]||(ue[6]=ot(ge=>To(ge,"translated"),["prevent"])),onMousedown:ue[7]||(ue[7]=ge=>Io(ge,"translated")),onDblclick:Pt},[e("div",{ref_key:"translatedWrapperRef",ref:Ie,class:"image-canvas-wrapper",style:tt(On.value)},[H(Y)?.translatedDataURL||H(Y)?.originalDataURL?(E(),U("img",{key:0,src:H(Y)?.translatedDataURL||H(Y)?.originalDataURL,alt:"ç¿»è¯‘å›¾",onLoad:ue[5]||(ue[5]=ge=>Mo("translated"))},null,40,Xv)):de("",!0),H(Y)?.translatedDataURL||H(Y)?.originalDataURL?(E(),st(dn,{key:1,bubbles:H($e),"selected-index":H(me),"selected-indices":H(j),scale:Ht.value,"is-drawing-mode":H(b),"is-brush-mode":!!H(p),"image-width":re.value,"image-height":ve.value,onSelect:H(O),onMultiSelect:H(D),onDragStart:H(w),onDragging:H(V),onDragEnd:H(q),onResizeStart:H(N),onResizing:H(m),onResizeEnd:H(d),onRotateStart:H(S),onRotating:H(x),onRotateEnd:H(K),onDrawBubble:H(ie)},null,8,["bubbles","selected-index","selected-indices","scale","is-drawing-mode","is-brush-mode","image-width","image-height","onSelect","onMultiSelect","onDragStart","onDragging","onDragEnd","onResizeStart","onResizing","onResizeEnd","onRotateStart","onRotating","onRotateEnd","onDrawBubble"])):de("",!0),H(C)?(E(),U("div",{key:2,class:"drawing-rect-edit translated-drawing-rect",style:tt(H(Z)())},null,4)):de("",!0)],4)],544)],2),[[Ue,Oe.value!=="original"]])]),e("div",{ref_key:"editPanelRef",ref:Ve,class:"edit-panel-container"},[e("div",{class:"panel-resize-handle vertical",onMousedown:as}," â‹®â‹®â‹® ",32),Ce(rv,{bubble:H(W),"bubble-index":H(me),onUpdate:Yn,onReRender:Jn,onOcrRecognize:H(k),onReTranslate:Zn,onApplyBubble:Xn,onResetCurrent:Gn},null,8,["bubble","bubble-index","onOcrRecognize"])],512)])],10,Kv)):de("",!0)}}),Zv=qe(Gv,[["__scopeId","data-v-7cf83f19"]]),It="/api/web-import";async function Qv(s){return(await fetch(`${It}/check-support?url=${encodeURIComponent(s)}`)).json()}async function ef(){return(await fetch(`${It}/gallery-dl-images`)).json()}async function tf(s,t,n,o,i,r="auto",l){const u=await fetch(`${It}/extract`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:s,config:t,engine:r})});if(!u.ok){const B=await u.json().catch(()=>({error:"è¯·æ±‚å¤±è´¥"}));i(B.error||`HTTP ${u.status}`);return}const b=u.body?.getReader();if(!b){i("æ— æ³•è¯»å–å“åº”æµ");return}const P=new TextDecoder;let C="";try{for(;;){const{done:B,value:O}=await b.read();if(B)break;C+=P.decode(O,{stream:!0});const D=C.split(`
`);C=D.pop()||"";let M="",w="";for(const V of D)if(V.startsWith("event:"))M=V.slice(6).trim();else if(V.startsWith("data:"))w=V.slice(5).trim();else if(V===""&&M&&w){try{const q=JSON.parse(w);M==="log"?n(q):M==="page"?l&&l(q):M==="result"?o(q):M==="error"&&i(q.error||"æœªçŸ¥é”™è¯¯")}catch(q){console.error("è§£æ SSE æ•°æ®å¤±è´¥:",q)}M="",w=""}}}finally{b.releaseLock()}}async function of(s,t,n,o="ai-agent"){const i=await fetch(`${It}/download`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({pages:s,sourceUrl:t,config:n,engine:o})});if(!i.ok){const r=await i.json().catch(()=>({error:"è¯·æ±‚å¤±è´¥"}));throw new Error(r.error||`HTTP ${i.status}`)}return i.json()}async function nf(s){return(await fetch(`${It}/test-firecrawl`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({apiKey:s})})).json()}async function sf(s,t,n,o){return(await fetch(`${It}/test-agent`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({provider:s,apiKey:t,customBaseUrl:n,modelName:o})})).json()}const af={class:"modal-container"},lf={class:"modal-body"},rf={class:"url-section"},uf=["disabled"],cf=["disabled"],df=["disabled"],gf={key:0,class:"loading-spinner"},pf={key:1},mf={key:0,class:"engine-hint"},vf={key:0,class:"hint-checking"},ff={key:1,class:"hint-supported"},bf={key:2,class:"hint-unsupported"},hf={class:"settings-section"},yf={class:"settings-toggle"},xf={key:0,class:"settings-content"},_f={class:"settings-tabs"},Cf={class:"settings-tab-content"},Sf={class:"settings-group"},kf={class:"form-row"},wf={class:"input-group"},$f=["type","value"],Tf=["disabled"],If={class:"settings-group"},Df={class:"form-row"},Rf=["value"],Pf=["value"],Mf={class:"form-row"},Ef={class:"input-group"},Bf=["type","value"],Af={key:0,class:"form-row"},Lf=["value"],Ff={class:"form-row"},Uf=["value"],Of={class:"form-row inline"},zf={class:"checkbox-label"},Nf=["checked"],Vf={class:"checkbox-label"},Wf=["checked"],Kf={class:"form-row"},qf=["disabled"],Hf={class:"settings-group"},jf={class:"form-row"},Jf=["value"],Yf={class:"form-row"},Xf=["value"],Gf={class:"settings-group"},Zf={class:"form-grid"},Qf={class:"form-row"},eb=["value"],tb={class:"form-row"},ob=["value"],nb={class:"form-row"},sb=["value"],ab={class:"form-row"},lb=["value"],ib={class:"form-row"},rb={class:"checkbox-label"},ub=["checked"],cb={class:"settings-group"},db={class:"form-row inline"},gb={class:"checkbox-label"},pb=["checked"],mb={class:"checkbox-label"},vb=["checked"],fb={class:"settings-tab-content"},bb={class:"settings-group"},hb={class:"form-row"},yb={class:"checkbox-label"},xb=["checked"],_b={class:"form-row"},Cb={class:"checkbox-label"},Sb=["checked"],kb={class:"form-row"},wb={class:"checkbox-label"},$b=["checked"],Tb={key:0,class:"form-grid"},Ib={class:"form-row"},Db=["value"],Rb={class:"form-row"},Pb=["value"],Mb={class:"form-row"},Eb=["value"],Bb={class:"form-row"},Ab={class:"checkbox-label"},Lb=["checked"],Fb={key:1,class:"form-row"},Ub=["value"],Ob={class:"settings-tab-content"},zb={class:"settings-group"},Nb={class:"form-row"},Vb=["value"],Wb={class:"form-row"},Kb=["value"],qb={class:"form-row"},Hb={class:"checkbox-label"},jb=["checked"],Jb={key:1,class:"logs-section"},Yb={class:"logs-toggle"},Xb={key:0,class:"extracting-hint"},Gb={key:0,class:"logs-content"},Zb={class:"log-time"},Qb={class:"log-message"},eh={key:2,class:"error-section"},th={class:"error-message"},oh={key:3,class:"result-section"},nh={class:"result-header"},sh={class:"result-title"},ah={class:"result-meta"},lh={class:"result-count"},ih={key:0,class:"result-engine"},rh={class:"select-control"},uh={class:"select-all"},ch=["checked"],dh={class:"selected-count"},gh={class:"image-grid"},ph=["onClick"],mh={class:"image-checkbox"},vh=["checked","onChange"],fh={class:"image-preview"},bh=["src","alt"],hh={class:"image-label"},yh={key:4,class:"progress-section"},xh={class:"progress-label"},_h={class:"progress-bar"},Ch={class:"modal-footer"},Sh=["disabled"],kh=["disabled"],wh={key:0,class:"loading-spinner"},$h={key:1},Th=He({__name:"WebImportModal",setup(s){const t=yo(),n=Xe(),o=h(""),i=h(!0),r=h("auto"),l=h(!1),u=h(!1),b=h(!1),P=h(!1),C=h("basic"),B=h(!1),O=h(!1),D=h(!1),M=h(!1),w=J(()=>t.modalVisible),V=J(()=>t.status),q=J(()=>t.logs),N=J(()=>t.extractResult),m=J(()=>t.selectedPages),d=J(()=>t.selectedCount),S=J(()=>t.downloadProgress),x=J(()=>t.downloadProgressPercent),K=J(()=>t.error),G=J(()=>t.isProcessing),ie=J(()=>t.settings.ui.showAgentLogs),Z=J(()=>N.value?.engine||null),le=J(()=>{switch(Z.value){case"gallery-dl":return"Gallery-DL";case"ai-agent":return"AI Agent";default:return""}}),Q=J(()=>N.value?.pages?d.value===N.value.pages.length:!1);function T(L){return Z.value==="gallery-dl",L}let k=null;async function F(L){if(k&&clearTimeout(k),!L.trim()){l.value=!1,u.value=!1;return}k=setTimeout(async()=>{b.value=!0;try{const c=await Qv(L);l.value=c.available,u.value=c.supported}catch{l.value=!1,u.value=!1}finally{b.value=!1}},500)}function y(){G.value&&!confirm("æ­£åœ¨å¤„ç†ä¸­ï¼Œç¡®å®šè¦å…³é—­å—ï¼Ÿ")||(t.closeModal(),t.resetState(),o.value="")}async function p(){const L=o.value.trim();if(!L){alert("è¯·è¾“å…¥ç½‘å€");return}try{new URL(L)}catch{alert("è¯·è¾“å…¥æœ‰æ•ˆçš„ç½‘å€");return}t.resetState(),t.setUrl(L),t.setStatus("extracting");try{await tf(L,t.settings,c=>{t.addLog(c)},c=>{t.setExtractResult(c),c.success?t.setStatus("extracted"):t.setError(c.error||"æå–å¤±è´¥")},c=>{t.setError(c)},r.value,c=>{t.addPageIncremental(c)})}catch(c){t.setError(c instanceof Error?c.message:"æå–å¤±è´¥")}}function a(L){t.togglePageSelection(L)}function v(){t.toggleSelectAll()}async function A(){if(!N.value?.pages||d.value===0){alert("è¯·é€‰æ‹©è¦å¯¼å…¥çš„å›¾ç‰‡");return}const L=N.value.pages.filter(f=>m.value.has(f.pageNumber));t.setStatus("downloading"),t.updateDownloadProgress(0,L.length);const c=Z.value||"ai-agent";try{if(c==="gallery-dl"){const se=await ef();if(se.success&&se.images.length>0){let $=0;const Y=Math.min(se.images.length,L.length);for(let ce=0;ce<Y;ce++){const _e=se.images[ce];_e&&_e.filename&&_e.data&&(n.addImage(_e.filename,_e.data),$++,t.updateDownloadProgress($,Y))}t.setStatus("completed"),alert(`æˆåŠŸå¯¼å…¥ ${$} å¼ å›¾ç‰‡`),y();return}else throw new Error(se.error||"è·å–å›¾ç‰‡å¤±è´¥")}const f=await of(L,N.value.sourceUrl,t.settings,c);if(f.success&&f.images.length>0){t.setDownloadedImages(f.images),t.updateDownloadProgress(f.images.length,L.length);for(const $ of f.images)n.addImage($.filename,$.dataUrl);t.setStatus("completed");const se=f.failedCount>0?`ï¼Œ${f.failedCount} å¼ å¤±è´¥`:"";alert(`æˆåŠŸå¯¼å…¥ ${f.images.length} å¼ å›¾ç‰‡${se}`),y()}else t.setError(f.error||"ä¸‹è½½å¤±è´¥")}catch(f){t.setError(f instanceof Error?f.message:"ä¸‹è½½å¤±è´¥")}}Se(w,L=>{L&&setTimeout(()=>{document.querySelector(".url-input")?.focus()},100)}),Se(o,L=>{F(L)});const _=J(()=>t.settings.agent.provider==="custom_openai");async function R(){if(!t.settings.firecrawl.apiKey){alert("è¯·è¾“å…¥ Firecrawl API Key");return}B.value=!0;try{const L=await nf(t.settings.firecrawl.apiKey);L.success?alert("âœ… Firecrawl è¿æ¥æˆåŠŸ"):alert(`âŒ è¿æ¥å¤±è´¥: ${L.error}`)}catch(L){alert(`âŒ è¿æ¥å¤±è´¥: ${L instanceof Error?L.message:"æœªçŸ¥é”™è¯¯"}`)}finally{B.value=!1}}async function I(){if(!t.settings.agent.apiKey){alert("è¯·è¾“å…¥ AI Agent API Key");return}O.value=!0;try{const L=await sf(t.settings.agent.provider,t.settings.agent.apiKey,t.settings.agent.customBaseUrl,t.settings.agent.modelName);L.success?alert("âœ… AI Agent è¿æ¥æˆåŠŸ"):alert(`âŒ è¿æ¥å¤±è´¥: ${L.error}`)}catch(L){alert(`âŒ è¿æ¥å¤±è´¥: ${L instanceof Error?L.message:"æœªçŸ¥é”™è¯¯"}`)}finally{O.value=!1}}function g(){confirm("ç¡®å®šè¦é‡ç½®ä¸ºé»˜è®¤æç¤ºè¯å—ï¼Ÿ")&&t.resetExtractionPrompt()}return(L,c)=>(E(),st(fn,{to:"body"},[w.value?(E(),U("div",{key:0,class:"modal-overlay",onClick:ot(y,["self"])},[e("div",af,[e("div",{class:"modal-header"},[c[37]||(c[37]=e("h2",{class:"modal-title"},[e("span",{class:"title-icon"},"ğŸŒ"),pe(" ä»ç½‘é¡µå¯¼å…¥æ¼«ç”» ")],-1)),e("button",{class:"close-btn",onClick:y,title:"å…³é—­"},"Ã—")]),e("div",lf,[e("div",rf,[ae(e("input",{"onUpdate:modelValue":c[0]||(c[0]=f=>o.value=f),type:"url",class:"url-input",placeholder:"è¾“å…¥æ¼«ç”»ç½‘é¡µ URLï¼Œå¦‚ https://example.com/chapter-1",disabled:G.value,onKeyup:vn(p,["enter"])},null,40,uf),[[ke,o.value]]),ae(e("select",{"onUpdate:modelValue":c[1]||(c[1]=f=>r.value=f),class:"engine-select",disabled:G.value},[...c[38]||(c[38]=[e("option",{value:"auto"},"è‡ªåŠ¨é€‰æ‹©",-1),e("option",{value:"gallery-dl"},"Gallery-DL",-1),e("option",{value:"ai-agent"},"AI Agent",-1)])],8,cf),[[vs,r.value]]),e("button",{class:"extract-btn",disabled:G.value||!o.value.trim(),onClick:p},[V.value==="extracting"?(E(),U("span",gf)):(E(),U("span",pf,"ğŸ”")),pe(" "+ne(V.value==="extracting"?"æå–ä¸­...":"å¼€å§‹æå–"),1)],8,df)]),o.value.trim()&&!G.value?(E(),U("div",mf,[b.value?(E(),U("span",vf,"æ£€æŸ¥ä¸­...")):u.value?(E(),U("span",ff,"âœ“ è¯¥ç½‘ç«™æ”¯æŒ Gallery-DL é«˜é€Ÿä¸‹è½½")):l.value?(E(),U("span",bf,"è¯¥ç½‘ç«™å°†ä½¿ç”¨ AI Agent æ¨¡å¼")):de("",!0)])):de("",!0),c[80]||(c[80]=e("div",{class:"notice"}," âš ï¸ è¯·ä»…çˆ¬å–æ‚¨æœ‰æƒè®¿é—®çš„å†…å®¹ï¼Œå¹¶éµå®ˆç›®æ ‡ç½‘ç«™çš„ä½¿ç”¨æ¡æ¬¾ã€‚ ",-1)),e("div",hf,[e("div",{class:"settings-header",onClick:c[2]||(c[2]=f=>P.value=!P.value)},[e("span",yf,ne(P.value?"â–¼":"â–¶"),1),c[39]||(c[39]=e("span",{class:"settings-title"},"âš™ï¸ è®¾ç½®",-1)),c[40]||(c[40]=e("span",{class:"settings-hint"},"ç‚¹å‡»å±•å¼€é…ç½®",-1))]),P.value?(E(),U("div",xf,[e("div",_f,[e("button",{class:De(["settings-tab",{active:C.value==="basic"}]),onClick:c[3]||(c[3]=f=>C.value="basic")}," åŸºæœ¬è®¾ç½® ",2),e("button",{class:De(["settings-tab",{active:C.value==="preprocess"}]),onClick:c[4]||(c[4]=f=>C.value="preprocess")}," å›¾ç‰‡é¢„å¤„ç† ",2),e("button",{class:De(["settings-tab",{active:C.value==="advanced"}]),onClick:c[5]||(c[5]=f=>C.value="advanced")}," é«˜çº§è®¾ç½® ",2)]),ae(e("div",Cf,[e("div",Sf,[c[42]||(c[42]=e("h4",{class:"group-title"},"Firecrawl é…ç½®",-1)),e("div",kf,[c[41]||(c[41]=e("label",{class:"form-label"},"API Key",-1)),e("div",wf,[e("input",{type:D.value?"text":"password",class:"form-input",value:H(t).settings.firecrawl.apiKey,onInput:c[6]||(c[6]=f=>H(t).setFirecrawlApiKey(f.target.value)),placeholder:"fc-xxxxxxxxxxxxxxxx"},null,40,$f),e("button",{class:"toggle-btn",onClick:c[7]||(c[7]=f=>D.value=!D.value)},ne(D.value?"ğŸ‘":"ğŸ‘â€ğŸ—¨"),1),e("button",{class:"test-btn",disabled:B.value||!H(t).settings.firecrawl.apiKey,onClick:R},ne(B.value?"æµ‹è¯•ä¸­...":"æµ‹è¯•è¿æ¥"),9,Tf)])])]),e("div",If,[c[49]||(c[49]=e("h4",{class:"group-title"},"AI Agent é…ç½®",-1)),e("div",Df,[c[43]||(c[43]=e("label",{class:"form-label"},"æœåŠ¡å•†",-1)),e("select",{class:"form-select",value:H(t).settings.agent.provider,onChange:c[8]||(c[8]=f=>H(t).setAgentProvider(f.target.value))},[(E(!0),U(Ae,null,Je(H(ps),f=>(E(),U("option",{key:f.value,value:f.value},ne(f.label),9,Pf))),128))],40,Rf)]),e("div",Mf,[c[44]||(c[44]=e("label",{class:"form-label"},"API Key",-1)),e("div",Ef,[e("input",{type:M.value?"text":"password",class:"form-input",value:H(t).settings.agent.apiKey,onInput:c[9]||(c[9]=f=>H(t).setAgentApiKey(f.target.value)),placeholder:"sk-xxxxxxxxxxxxxxxx"},null,40,Bf),e("button",{class:"toggle-btn",onClick:c[10]||(c[10]=f=>M.value=!M.value)},ne(M.value?"ğŸ‘":"ğŸ‘â€ğŸ—¨"),1)])]),_.value?(E(),U("div",Af,[c[45]||(c[45]=e("label",{class:"form-label"},"è‡ªå®šä¹‰ API åœ°å€",-1)),e("input",{type:"url",class:"form-input",value:H(t).settings.agent.customBaseUrl,onInput:c[11]||(c[11]=f=>H(t).setAgentBaseUrl(f.target.value)),placeholder:"https://api.example.com/v1"},null,40,Lf)])):de("",!0),e("div",Ff,[c[46]||(c[46]=e("label",{class:"form-label"},"æ¨¡å‹åç§°",-1)),e("input",{type:"text",class:"form-input",value:H(t).settings.agent.modelName,onInput:c[12]||(c[12]=f=>H(t).setAgentModelName(f.target.value)),placeholder:"gpt-4o-mini"},null,40,Uf)]),e("div",Of,[e("label",zf,[e("input",{type:"checkbox",checked:H(t).settings.agent.forceJsonOutput,onChange:c[13]||(c[13]=f=>H(t).setAgentForceJson(f.target.checked))},null,40,Nf),c[47]||(c[47]=pe(" å¼ºåˆ¶ JSON æ ¼å¼ ",-1))]),e("label",Vf,[e("input",{type:"checkbox",checked:H(t).settings.agent.useStream,onChange:c[14]||(c[14]=f=>H(t).setAgentUseStream(f.target.checked))},null,40,Wf),c[48]||(c[48]=pe(" æµå¼è°ƒç”¨ ",-1))])]),e("div",Kf,[e("button",{class:"test-btn full",disabled:O.value||!H(t).settings.agent.apiKey,onClick:I},ne(O.value?"æµ‹è¯•ä¸­...":"æµ‹è¯• Agent è¿æ¥"),9,qf)])]),e("div",Hf,[e("h4",{class:"group-title"},[c[50]||(c[50]=pe(" æå–è®¾ç½® ",-1)),e("button",{class:"reset-btn",onClick:g},"é‡ç½®ä¸ºé»˜è®¤")]),e("div",jf,[c[51]||(c[51]=e("label",{class:"form-label"},"æå–æç¤ºè¯",-1)),e("textarea",{class:"form-textarea",value:H(t).settings.extraction.prompt,onInput:c[15]||(c[15]=f=>H(t).setExtractionPrompt(f.target.value)),rows:"6",placeholder:"è¾“å…¥æå–æç¤ºè¯..."},null,40,Jf)]),e("div",Yf,[c[52]||(c[52]=e("label",{class:"form-label"},"æœ€å¤§è¿­ä»£æ¬¡æ•°",-1)),e("input",{type:"number",class:"form-input small",value:H(t).settings.extraction.maxIterations,onInput:c[16]||(c[16]=f=>H(t).setExtractionMaxIterations(Number(f.target.value))),min:"1",max:"20"},null,40,Xf)])]),e("div",Gf,[c[58]||(c[58]=e("h4",{class:"group-title"},"ä¸‹è½½è®¾ç½®",-1)),e("div",Zf,[e("div",Qf,[c[53]||(c[53]=e("label",{class:"form-label"},"å¹¶å‘æ•°",-1)),e("input",{type:"number",class:"form-input small",value:H(t).settings.download.concurrency,onInput:c[17]||(c[17]=f=>H(t).setDownloadConcurrency(Number(f.target.value))),min:"1",max:"10"},null,40,eb)]),e("div",tb,[c[54]||(c[54]=e("label",{class:"form-label"},"è¶…æ—¶ (ç§’)",-1)),e("input",{type:"number",class:"form-input small",value:H(t).settings.download.timeout,onInput:c[18]||(c[18]=f=>H(t).setDownloadTimeout(Number(f.target.value))),min:"5",max:"120"},null,40,ob)]),e("div",nb,[c[55]||(c[55]=e("label",{class:"form-label"},"é‡è¯•æ¬¡æ•°",-1)),e("input",{type:"number",class:"form-input small",value:H(t).settings.download.retries,onInput:c[19]||(c[19]=f=>H(t).setDownloadRetries(Number(f.target.value))),min:"0",max:"5"},null,40,sb)]),e("div",ab,[c[56]||(c[56]=e("label",{class:"form-label"},"ä¸‹è½½é—´éš” (ms)",-1)),e("input",{type:"number",class:"form-input small",value:H(t).settings.download.delay,onInput:c[20]||(c[20]=f=>H(t).setDownloadDelay(Number(f.target.value))),min:"0",max:"2000",step:"100"},null,40,lb)])]),e("div",ib,[e("label",rb,[e("input",{type:"checkbox",checked:H(t).settings.download.useReferer,onChange:c[21]||(c[21]=f=>H(t).setDownloadUseReferer(f.target.checked))},null,40,ub),c[57]||(c[57]=pe(" è‡ªåŠ¨æ·»åŠ  Referer ",-1))])])]),e("div",cb,[c[61]||(c[61]=e("h4",{class:"group-title"},"ç•Œé¢è®¾ç½®",-1)),e("div",db,[e("label",gb,[e("input",{type:"checkbox",checked:H(t).settings.ui.showAgentLogs,onChange:c[22]||(c[22]=f=>H(t).setShowAgentLogs(f.target.checked))},null,40,pb),c[59]||(c[59]=pe(" æ˜¾ç¤º AI å·¥ä½œæ—¥å¿— ",-1))]),e("label",mb,[e("input",{type:"checkbox",checked:H(t).settings.ui.autoImport,onChange:c[23]||(c[23]=f=>H(t).setAutoImport(f.target.checked))},null,40,vb),c[60]||(c[60]=pe(" æå–åè‡ªåŠ¨å¯¼å…¥ ",-1))])])])],512),[[Ue,C.value==="basic"]]),ae(e("div",fb,[e("div",bb,[e("div",hb,[e("label",yb,[e("input",{type:"checkbox",checked:H(t).settings.imagePreprocess.enabled,onChange:c[24]||(c[24]=f=>H(t).setImagePreprocessEnabled(f.target.checked))},null,40,xb),c[62]||(c[62]=pe(" å¯ç”¨å›¾ç‰‡é¢„å¤„ç† ",-1))])]),H(t).settings.imagePreprocess.enabled?(E(),U(Ae,{key:0},[e("div",_b,[e("label",Cb,[e("input",{type:"checkbox",checked:H(t).settings.imagePreprocess.autoRotate,onChange:c[25]||(c[25]=f=>H(t).setImageAutoRotate(f.target.checked))},null,40,Sb),c[63]||(c[63]=pe(" æ ¹æ® EXIF è‡ªåŠ¨æ—‹è½¬ ",-1))])]),c[71]||(c[71]=e("h5",{class:"subsection-title"},"å‹ç¼©è®¾ç½®",-1)),e("div",kb,[e("label",wb,[e("input",{type:"checkbox",checked:H(t).settings.imagePreprocess.compression.enabled,onChange:c[26]||(c[26]=f=>H(t).setImageCompressionEnabled(f.target.checked))},null,40,$b),c[64]||(c[64]=pe(" å¯ç”¨å‹ç¼© ",-1))])]),H(t).settings.imagePreprocess.compression.enabled?(E(),U("div",Tb,[e("div",Ib,[c[65]||(c[65]=e("label",{class:"form-label"},"è´¨é‡ (0-100)",-1)),e("input",{type:"number",class:"form-input small",value:H(t).settings.imagePreprocess.compression.quality,onInput:c[27]||(c[27]=f=>H(t).setImageCompressionQuality(Number(f.target.value))),min:"1",max:"100"},null,40,Db)]),e("div",Rb,[c[66]||(c[66]=e("label",{class:"form-label"},"æœ€å¤§å®½åº¦ (0=ä¸é™)",-1)),e("input",{type:"number",class:"form-input small",value:H(t).settings.imagePreprocess.compression.maxWidth,onInput:c[28]||(c[28]=f=>H(t).setImageMaxWidth(Number(f.target.value))),min:"0"},null,40,Pb)]),e("div",Mb,[c[67]||(c[67]=e("label",{class:"form-label"},"æœ€å¤§é«˜åº¦ (0=ä¸é™)",-1)),e("input",{type:"number",class:"form-input small",value:H(t).settings.imagePreprocess.compression.maxHeight,onInput:c[29]||(c[29]=f=>H(t).setImageMaxHeight(Number(f.target.value))),min:"0"},null,40,Eb)])])):de("",!0),c[72]||(c[72]=e("h5",{class:"subsection-title"},"æ ¼å¼è½¬æ¢",-1)),e("div",Bb,[e("label",Ab,[e("input",{type:"checkbox",checked:H(t).settings.imagePreprocess.formatConvert.enabled,onChange:c[30]||(c[30]=f=>H(t).setImageFormatConvertEnabled(f.target.checked))},null,40,Lb),c[68]||(c[68]=pe(" å¯ç”¨æ ¼å¼è½¬æ¢ ",-1))])]),H(t).settings.imagePreprocess.formatConvert.enabled?(E(),U("div",Fb,[c[70]||(c[70]=e("label",{class:"form-label"},"ç›®æ ‡æ ¼å¼",-1)),e("select",{class:"form-select",value:H(t).settings.imagePreprocess.formatConvert.targetFormat,onChange:c[31]||(c[31]=f=>H(t).setImageTargetFormat(f.target.value))},[...c[69]||(c[69]=[e("option",{value:"original"},"ä¿æŒåŸæ ¼å¼",-1),e("option",{value:"jpeg"},"JPEG",-1),e("option",{value:"png"},"PNG",-1),e("option",{value:"webp"},"WebP",-1)])],40,Ub)])):de("",!0)],64)):de("",!0)])],512),[[Ue,C.value==="preprocess"]]),ae(e("div",Ob,[e("div",zb,[c[76]||(c[76]=e("h4",{class:"group-title"},"è‡ªå®šä¹‰è¯·æ±‚å¤´",-1)),e("div",Nb,[c[73]||(c[73]=e("label",{class:"form-label"},"Cookie",-1)),e("input",{type:"text",class:"form-input",value:H(t).settings.advanced.customCookie,onInput:c[32]||(c[32]=f=>H(t).setCustomCookie(f.target.value)),placeholder:"name=value; name2=value2"},null,40,Vb)]),e("div",Wb,[c[74]||(c[74]=e("label",{class:"form-label"},"Headers (JSON)",-1)),e("textarea",{class:"form-textarea",value:H(t).settings.advanced.customHeaders,onInput:c[33]||(c[33]=f=>H(t).setCustomHeaders(f.target.value)),rows:"3",placeholder:'{"X-Custom-Header": "value"}'},null,40,Kb)]),e("div",qb,[e("label",Hb,[e("input",{type:"checkbox",checked:H(t).settings.advanced.bypassProxy,onChange:c[34]||(c[34]=f=>H(t).setBypassProxy(f.target.checked))},null,40,jb),c[75]||(c[75]=pe(" ç»•è¿‡ç³»ç»Ÿä»£ç† (è¿æ¥æœ¬åœ°æœåŠ¡æ—¶ä½¿ç”¨) ",-1))])])])],512),[[Ue,C.value==="advanced"]])])):de("",!0)]),ie.value&&q.value.length>0?(E(),U("div",Jb,[e("div",{class:"logs-header",onClick:c[35]||(c[35]=f=>i.value=!i.value)},[e("span",Yb,ne(i.value?"â–¼":"â–¶"),1),c[77]||(c[77]=e("span",null,"AI å·¥ä½œæ—¥å¿—",-1)),V.value==="extracting"?(E(),U("span",Xb,"(æå–ä¸­...)")):de("",!0)]),i.value?(E(),U("div",Gb,[(E(!0),U(Ae,null,Je(q.value,(f,se)=>(E(),U("div",{key:se,class:De(["log-item",`log-${f.type}`])},[e("span",Zb,"["+ne(f.timestamp)+"]",1),e("span",Qb,ne(f.message),1)],2))),128))])):de("",!0)])):de("",!0),K.value?(E(),U("div",eh,[c[78]||(c[78]=e("span",{class:"error-icon"},"âŒ",-1)),e("span",th,ne(K.value),1)])):de("",!0),N.value?.success?(E(),U("div",oh,[e("div",nh,[e("span",sh," ğŸ“– ã€Š"+ne(N.value.comicTitle)+"ã€‹- "+ne(N.value.chapterTitle),1),e("span",ah,[e("span",lh,"å…± "+ne(N.value.totalPages)+" å¼ ",1),le.value?(E(),U("span",ih,"| å¼•æ“: "+ne(le.value),1)):de("",!0)])]),e("div",rh,[e("label",uh,[e("input",{type:"checkbox",checked:Q.value,onChange:v},null,40,ch),c[79]||(c[79]=pe(" å…¨é€‰ ",-1))]),e("span",dh,"å·²é€‰: "+ne(d.value)+" å¼ ",1)]),e("div",gh,[(E(!0),U(Ae,null,Je(N.value.pages,f=>(E(),U("div",{key:f.pageNumber,class:De(["image-item",{selected:m.value.has(f.pageNumber)}]),onClick:se=>a(f.pageNumber)},[e("div",mh,[e("input",{type:"checkbox",checked:m.value.has(f.pageNumber),onClick:c[36]||(c[36]=ot(()=>{},["stop"])),onChange:se=>a(f.pageNumber)},null,40,vh)]),e("div",fh,[e("img",{src:T(f.imageUrl),alt:`ç¬¬${f.pageNumber}é¡µ`,loading:"lazy"},null,8,bh)]),e("div",hh,"ç¬¬ "+ne(f.pageNumber)+" é¡µ",1)],10,ph))),128))])])):de("",!0),V.value==="downloading"?(E(),U("div",yh,[e("div",xh," ä¸‹è½½è¿›åº¦: "+ne(S.value.current)+"/"+ne(S.value.total),1),e("div",_h,[e("div",{class:"progress-fill",style:tt({width:`${x.value}%`})},null,4)])])):de("",!0)]),e("div",Ch,[e("button",{class:"cancel-btn",onClick:y,disabled:V.value==="downloading"}," å–æ¶ˆ ",8,Sh),e("button",{class:"import-btn",disabled:!N.value?.success||d.value===0||G.value,onClick:A},[V.value==="downloading"?(E(),U("span",wh)):(E(),U("span",$h,"ğŸ“¥")),pe(" "+ne(V.value==="downloading"?"ä¸‹è½½ä¸­...":"å¯¼å…¥"),1)],8,kh)])])])):de("",!0)]))}}),Ih=qe(Th,[["__scopeId","data-v-78fc5cb0"]]),Dh={class:"disclaimer-container"},Rh={class:"disclaimer-content"},Ph={class:"confirmation-area"},Mh=["placeholder"],Eh={key:0,class:"input-error"},Bh={class:"disclaimer-footer"},Ah=["disabled"],Vt="æˆ‘å·²é˜…è¯»å¹¶åŒæ„",Lh=He({__name:"WebImportDisclaimer",setup(s){const t=yo(),n=h(""),o=J(()=>t.disclaimerVisible),i=J(()=>n.value.trim()===Vt);function r(){i.value&&(t.acceptDisclaimer(),n.value="")}function l(){t.rejectDisclaimer(),n.value=""}return(u,b)=>(E(),st(fn,{to:"body"},[o.value?(E(),U("div",{key:0,class:"disclaimer-overlay",onClick:ot(l,["self"])},[e("div",Dh,[b[3]||(b[3]=e("div",{class:"disclaimer-header"},[e("span",{class:"warning-icon"},"âš ï¸"),e("h2",{class:"disclaimer-title"},"é‡è¦å…è´£å£°æ˜")],-1)),e("div",Rh,[b[2]||(b[2]=e("div",{class:"disclaimer-text"},[e("h3",null,"ğŸ“œ ä½¿ç”¨æ¡æ¬¾ä¸æ³•å¾‹å£°æ˜"),e("div",{class:"section"},[e("h4",null,"1. åŠŸèƒ½è¯´æ˜"),e("p",null,[pe(' "ä»ç½‘é¡µå¯¼å…¥"åŠŸèƒ½å…è®¸æ‚¨ä»äº’è”ç½‘ç½‘é¡µä¸­æå–å›¾ç‰‡ã€‚æ­¤åŠŸèƒ½ä»…ä¾›'),e("strong",null,"æŠ€æœ¯ç ”ç©¶ä¸ä¸ªäººå­¦ä¹ "),pe("ä¹‹ç›®çš„æä¾›ã€‚ ")])]),e("div",{class:"section"},[e("h4",null,"2. ç”¨æˆ·è´£ä»»"),e("ul",null,[e("li",null,[pe("æ‚¨åº”å½“ç¡®ä¿æ‹¥æœ‰"),e("strong",null,"åˆæ³•æƒåˆ©"),pe("è®¿é—®å’Œä¸‹è½½ç›®æ ‡å†…å®¹")]),e("li",null,[pe("æ‚¨åº”å½“éµå®ˆç›®æ ‡ç½‘ç«™çš„"),e("strong",null,"æœåŠ¡æ¡æ¬¾"),pe("å’Œ"),e("strong",null,"ä½¿ç”¨åè®®")]),e("li",null,[pe("æ‚¨åº”å½“å°Šé‡å†…å®¹åˆ›ä½œè€…çš„"),e("strong",null,"ç‰ˆæƒ"),pe("å’Œ"),e("strong",null,"çŸ¥è¯†äº§æƒ")]),e("li",null,[pe("æ‚¨"),e("strong",null,"ä¸å¾—"),pe("å°†ä¸‹è½½çš„å†…å®¹ç”¨äºå•†ä¸šç›®çš„æˆ–éæ³•ä¼ æ’­")]),e("li",null,[pe("æ‚¨"),e("strong",null,"ä¸å¾—"),pe("ä½¿ç”¨æœ¬åŠŸèƒ½ç»•è¿‡ä»˜è´¹å†…å®¹çš„è®¿é—®é™åˆ¶")])])]),e("div",{class:"section"},[e("h4",null,"3. ä½¿ç”¨é™åˆ¶"),e("p",null,[pe("æœ¬åŠŸèƒ½"),e("strong",null,"ä¸¥ç¦"),pe("ç”¨äºä»¥ä¸‹ç›®çš„ï¼š")]),e("ul",null,[e("li",null,[pe("ä¸‹è½½ã€å­˜å‚¨æˆ–ä¼ æ’­"),e("strong",null,"ä¾µæƒå†…å®¹")]),e("li",null,[pe("ç»•è¿‡ç½‘ç«™çš„"),e("strong",null,"ä»˜è´¹å¢™"),pe("æˆ–"),e("strong",null,"è®¿é—®æ§åˆ¶")]),e("li",null,[pe("è¿›è¡Œ"),e("strong",null,"å•†ä¸šç”¨é€”"),pe("æˆ–å¤§è§„æ¨¡"),e("strong",null,"æ‰¹é‡çˆ¬å–")]),e("li",null,[pe("ä»»ä½•è¿å"),e("strong",null,"å½“åœ°æ³•å¾‹æ³•è§„"),pe("çš„æ´»åŠ¨")]),e("li",null,[pe("å¯¹ç›®æ ‡ç½‘ç«™é€ æˆ"),e("strong",null,"æœåŠ¡å™¨è´Ÿæ‹…"),pe("æˆ–"),e("strong",null,"æ¶æ„æ”»å‡»")])])]),e("div",{class:"section"},[e("h4",null,"4. å…è´£æ¡æ¬¾"),e("p",null,[pe(" æœ¬è½¯ä»¶ä½œè€…åŠè´¡çŒ®è€…"),e("strong",null,"ä¸å¯¹æ‚¨ä½¿ç”¨æœ¬åŠŸèƒ½æ‰€å¯¼è‡´çš„ä»»ä½•ç›´æ¥æˆ–é—´æ¥åæœæ‰¿æ‹…è´£ä»»"),pe("ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºï¼š ")]),e("ul",null,[e("li",null,"å› ä¾µçŠ¯ç‰ˆæƒè€Œäº§ç”Ÿçš„æ³•å¾‹è´£ä»»"),e("li",null,"å› è¿åæœåŠ¡æ¡æ¬¾è€Œå¯¼è‡´çš„è´¦å·å°ç¦"),e("li",null,"å› æ•°æ®ä¸¢å¤±æˆ–æŸåè€Œé€ æˆçš„æŸå¤±"),e("li",null,"ä»»ä½•å…¶ä»–å› ä½¿ç”¨æœ¬åŠŸèƒ½è€Œäº§ç”Ÿçš„ä¸åˆ©åæœ")])]),e("div",{class:"section warning-section"},[e("h4",null,"5. ç¡®è®¤å£°æ˜"),e("p",null,[pe(" ä½¿ç”¨æœ¬åŠŸèƒ½å³è¡¨ç¤ºæ‚¨"),e("strong",null,"å·²é˜…è¯»ã€ç†è§£å¹¶åŒæ„"),pe("ä¸Šè¿°æ‰€æœ‰æ¡æ¬¾ï¼Œå¹¶æ‰¿è¯ºï¼š ")]),e("ul",null,[e("li",null,[pe("ä»…å°†æœ¬åŠŸèƒ½ç”¨äº"),e("strong",null,"åˆæ³•ã€åˆè§„"),pe("çš„ç›®çš„")]),e("li",null,[e("strong",null,"è‡ªè¡Œæ‰¿æ‹…"),pe("ä½¿ç”¨æœ¬åŠŸèƒ½æ‰€å¸¦æ¥çš„ä¸€åˆ‡é£é™©å’Œè´£ä»»")]),e("li",null,[pe("å¦‚å› ä½¿ç”¨æœ¬åŠŸèƒ½å¯¼è‡´ä»»ä½•äº‰è®®ï¼Œ"),e("strong",null,"ä¸æœ¬è½¯ä»¶ä½œè€…æ— å…³")])])])],-1)),e("div",Ph,[b[1]||(b[1]=e("p",{class:"confirmation-prompt"}," å¦‚æœæ‚¨å·²å®Œæ•´é˜…è¯»å¹¶åŒæ„ä»¥ä¸Šæ¡æ¬¾ï¼Œè¯·åœ¨ä¸‹æ–¹è¾“å…¥æ¡†ä¸­å‡†ç¡®è¾“å…¥ï¼š ",-1)),e("p",{class:"required-text"},[e("code",null,ne(Vt))]),ae(e("input",{"onUpdate:modelValue":b[0]||(b[0]=P=>n.value=P),type:"text",class:"confirmation-input",placeholder:`è¯·è¾“å…¥: ${Vt}`,onKeyup:vn(r,["enter"])},null,40,Mh),[[ke,n.value]]),n.value&&!i.value?(E(),U("p",Eh," è¾“å…¥ä¸æ­£ç¡®ï¼Œè¯·å®Œæ•´è¾“å…¥ã€Œ"+ne(Vt)+"ã€ ")):de("",!0)])]),e("div",Bh,[e("button",{class:"btn-cancel",onClick:l}," æˆ‘ä¸åŒæ„ï¼Œè¿”å› "),e("button",{class:"btn-confirm",disabled:!i.value,onClick:r}," âœ“ ç¡®è®¤å¹¶ç»§ç»­ ",8,Ah)])])])):de("",!0)]))}}),Fh=qe(Lh,[["__scopeId","data-v-3750d090"]]),Uh={class:"app-header"},Oh={class:"header-content"},zh={class:"logo-container"},Nh={class:"header-links"},Vh={class:"container"},Wh={id:"image-display-area"},Kh={id:"upload-section",class:"card upload-card"},qh={class:"upload-actions"},Hh={key:1,class:"bookshelf-mode-hint"},jh=He({__name:"TranslateView",setup(s){const t=mn(),n=Xe(),o=Le(),i=qt(),r=ct(),{validateBeforeTranslation:l,initValidation:u}=kn(),b=Co(),P=vi(),C=h(!1),B=h(void 0),O=h(!1),D=h(!1),M=h(null),w=h(null),V=J(()=>n.currentImage),q=J(()=>n.hasImages);J(()=>n.imageCount),J(()=>n.currentImageIndex+1),J(()=>q.value&&!n.isBatchTranslationInProgress),J(()=>n.canGoPrevious),J(()=>n.canGoNext);const N=J(()=>n.isBatchTranslationInProgress);J(()=>{if(!N.value)return 0;const j=n.completedImageCount,W=n.imageCount;return W>0?Math.round(j/W*100):0}),J(()=>`${n.completedImageCount}/${n.imageCount}`);const m=J(()=>n.failedImageCount>0),d=J(()=>!!t.query.book&&!!t.query.chapter),S=J(()=>t.query.book),x=J(()=>t.query.chapter),K=J(()=>P.currentBookTitle.value),G=J(()=>P.currentChapterTitle.value),ie=J(()=>d.value&&G.value&&K.value?`${G.value} - ${K.value}`:"Saber-Translator");ut(async()=>{n.clearImages(),r.clearBubbles(),await P.initializeApp(),u(),window.addEventListener("keydown",_e)}),At(()=>{window.removeEventListener("keydown",_e)}),Se(()=>[t.query.book,t.query.chapter],async([j,W],[z,te])=>{j&&W?(n.clearImages(),r.clearBubbles(),await Z()):z&&te&&!j&&!W&&(n.clearImages(),r.clearBubbles(),await P.initializeBookChapterContext(),console.log("[TranslateView] ä»ä¹¦æ¶æ¨¡å¼åˆ‡æ¢åˆ°å¿«é€Ÿç¿»è¯‘æ¨¡å¼ï¼Œå·²æ¸…ç©ºæ•°æ®"))}),Se(ie,j=>{typeof document<"u"&&(document.title=j)},{immediate:!0});async function Z(){if(!(!S.value||!x.value))try{await P.initializeBookChapterContext()}catch(j){console.error("åŠ è½½ç« èŠ‚ä¼šè¯å¤±è´¥:",j),he("åŠ è½½ç« èŠ‚ä¼šè¯å¤±è´¥","error")}}function le(j){console.log(`ä¸Šä¼ å®Œæˆï¼Œå…± ${j} å¼ å›¾ç‰‡`),n.hasImages&&(n.sortImagesByFileName(),P.switchImage(0))}async function Q(j){const W=V.value;if(!W||!W.bubbleStates||W.bubbleStates.length===0){he("è¯·å…ˆé€‰æ‹©ä¸€å¼ å·²ç¿»è¯‘çš„å›¾ç‰‡","warning");return}if(n.images.length<=1){he("åªæœ‰ä¸€å¼ å›¾ç‰‡ï¼Œæ— éœ€åº”ç”¨åˆ°å…¨éƒ¨","info");return}if(!Object.values(j).some(te=>te)){he("è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè¦åº”ç”¨çš„è®¾ç½®é¡¹","warning");return}try{const te=W.bubbleStates[0],oe={};j.fontSize&&(oe.fontSize=te.fontSize),j.fontFamily&&(oe.fontFamily=te.fontFamily),j.layoutDirection&&(oe.textDirection=te.textDirection==="auto"?"vertical":te.textDirection),j.textColor&&(oe.textColor=te.textColor),j.fillColor&&(oe.fillColor=te.fillColor),j.strokeEnabled&&(oe.strokeEnabled=te.strokeEnabled),j.strokeColor&&(oe.strokeColor=te.strokeColor),j.strokeWidth&&(oe.strokeWidth=te.strokeWidth);const re=Re=>{const Ie={...Re};return j.fontSize&&oe.fontSize!==void 0&&(Ie.fontSize=oe.fontSize),j.fontFamily&&oe.fontFamily!==void 0&&(Ie.fontFamily=oe.fontFamily),j.layoutDirection&&oe.textDirection!==void 0&&(Ie.textDirection=oe.textDirection),j.textColor&&oe.textColor!==void 0&&(Ie.textColor=oe.textColor),j.fillColor&&oe.fillColor!==void 0&&(Ie.fillColor=oe.fillColor),j.strokeEnabled&&oe.strokeEnabled!==void 0&&(Ie.strokeEnabled=oe.strokeEnabled),j.strokeColor&&oe.strokeColor!==void 0&&(Ie.strokeColor=oe.strokeColor),j.strokeWidth&&oe.strokeWidth!==void 0&&(Ie.strokeWidth=oe.strokeWidth),Ie};let ve=0;const xe=n.images;for(let Re=0;Re<xe.length;Re++){const Ie=xe[Re];if(Ie&&Ie.bubbleStates&&Ie.bubbleStates.length>0){const Ve=Ie.bubbleStates.map(re);n.updateImageByIndex(Re,{bubbleStates:Ve}),ve++}}if(r.bubbles.length>0){const Re=r.bubbles.map(re);r.setBubbles(Re)}const ye=[];j.fontSize&&ye.push("å­—å·"),j.fontFamily&&ye.push("å­—ä½“"),j.layoutDirection&&ye.push("æ’ç‰ˆæ–¹å‘"),j.textColor&&ye.push("æ–‡å­—é¢œè‰²"),j.fillColor&&ye.push("å¡«å……é¢œè‰²"),j.strokeEnabled&&ye.push("æè¾¹å¼€å…³"),j.strokeColor&&ye.push("æè¾¹é¢œè‰²"),j.strokeWidth&&ye.push("æè¾¹å®½åº¦");const fe=[];for(let Re=0;Re<xe.length;Re++){const Ie=xe[Re];Ie&&Ie.translatedDataURL&&Ie.bubbleStates&&Ie.bubbleStates.length>0&&fe.push(Re)}if(fe.length>0){const{apiClient:Re}=await lt(async()=>{const{apiClient:Oe}=await import("./client.Bht704G-.js");return{apiClient:Oe}},__vite__mapDeps([4,5])),Ie=o.settings.textStyle.layoutDirection,Ve=Ie==="auto";for(let Oe=0;Oe<fe.length;Oe++){const Me=fe[Oe];if(Me===void 0)continue;const Pe=n.images[Me];if(!(!Pe||!Pe.bubbleStates))try{let Ge="";if(Pe.cleanImageData?Ge=Pe.cleanImageData.includes("base64,")?Pe.cleanImageData.split("base64,")[1]||"":Pe.cleanImageData:Pe.originalDataURL&&(Ge=Pe.originalDataURL.includes("base64,")?Pe.originalDataURL.split("base64,")[1]||"":Pe.originalDataURL,console.log(`handleApplyToAll: å›¾ç‰‡ ${Me} ä½¿ç”¨åŸå›¾ä½œä¸ºèƒŒæ™¯ï¼ˆå…œåº•ï¼‰`)),!Ge){console.log(`handleApplyToAll: å›¾ç‰‡ ${Me} æ²¡æœ‰å¯ç”¨çš„èƒŒæ™¯å›¾ï¼Œè·³è¿‡`);continue}const at=Pe.bubbleStates.map(Te=>({translatedText:Te.translatedText||"",coords:Te.coords,fontSize:Te.fontSize||o.settings.textStyle.fontSize,fontFamily:Te.fontFamily||o.settings.textStyle.fontFamily,textDirection:wt(Te),textColor:Te.textColor||o.settings.textStyle.textColor,rotationAngle:Te.rotationAngle||0,position:Te.position||{x:0,y:0},strokeEnabled:Te.strokeEnabled??o.settings.textStyle.strokeEnabled,strokeColor:Te.strokeColor||o.settings.textStyle.strokeColor,strokeWidth:Te.strokeWidth??o.settings.textStyle.strokeWidth})),it=await Re.post("/api/re_render_image",{clean_image:Ge,bubble_texts:at.map(Te=>Te.translatedText),bubble_coords:at.map(Te=>Te.coords),fontSize:o.settings.textStyle.fontSize,fontFamily:o.settings.textStyle.fontFamily,textDirection:Ve?"vertical":Ie,textColor:o.settings.textStyle.textColor,bubble_states:at,use_individual_styles:!0,use_inpainting:!1,use_lama:!1,fillColor:null,is_font_style_change:!0,strokeEnabled:o.settings.textStyle.strokeEnabled,strokeColor:o.settings.textStyle.strokeColor,strokeWidth:o.settings.textStyle.strokeWidth});it.rendered_image&&n.updateImageByIndex(Me,{translatedDataURL:`data:image/png;base64,${it.rendered_image}`,hasUnsavedChanges:!0})}catch(Ge){console.error(`é‡æ¸²æŸ“å›¾ç‰‡ ${Me} å¤±è´¥:`,Ge)}}}he(`å·²å°† ${ye.join("ã€")} åº”ç”¨åˆ° ${ve} å¼ å›¾ç‰‡`,"success"),console.log(`[TranslateView] åº”ç”¨è®¾ç½®åˆ°å…¨éƒ¨å®Œæˆï¼Œæ›´æ–°äº† ${ve} å¼ å›¾ç‰‡ï¼Œé‡æ¸²æŸ“äº† ${fe.length} å¼ `)}catch(te){console.error("åº”ç”¨è®¾ç½®åˆ°å…¨éƒ¨å¤±è´¥:",te),he("åº”ç”¨è®¾ç½®å¤±è´¥","error")}}async function T(){V.value&&l("normal")&&await b.translateCurrentImage()}async function k(){q.value&&l("normal")&&await b.translateAllImages()}async function F(){q.value&&l("hq")&&await b.executeHqTranslation()}async function y(){q.value&&l("proofread")&&await b.executeProofreading()}async function p(){V.value&&await b.removeTextOnly()}async function a(){q.value&&await b.removeAllTexts()}function v(){if(!V.value)return;const j=V.value.fileName||`å›¾ç‰‡ ${n.currentImageIndex+1}`;confirm(`ç¡®å®šè¦åˆ é™¤å½“å‰å›¾ç‰‡ (${j}) å—ï¼Ÿ`)&&(n.deleteCurrentImage(),he("å›¾ç‰‡å·²åˆ é™¤","success"))}function A(){q.value&&confirm("ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰å›¾ç‰‡å—ï¼Ÿè¿™å°†ä¸¢å¤±æ‰€æœ‰æœªä¿å­˜çš„è¿›åº¦ã€‚")&&(n.clearImages(),he("æ‰€æœ‰å›¾ç‰‡å·²æ¸…é™¤","success"))}async function _(){try{const j=await bn(),W=await fo();if(j.success&&W.success)he("ä¸´æ—¶æ–‡ä»¶æ¸…ç†å®Œæˆ","success");else{const z=[];j.success||z.push("è°ƒè¯•æ–‡ä»¶æ¸…ç†å¤±è´¥"),W.success||z.push("ä¸´æ—¶æ–‡ä»¶æ¸…ç†å¤±è´¥"),he(z.join("ï¼Œ"),"warning")}}catch{he("æ¸…ç†ä¸´æ—¶æ–‡ä»¶å¤±è´¥","error")}}function R(){P.goToPrevious()}function I(){P.goToNext()}function g(){D.value=!D.value}async function L(){if(!m.value){he("æ²¡æœ‰å¤±è´¥çš„å›¾ç‰‡éœ€è¦é‡æ–°ç¿»è¯‘","info");return}l("normal")&&await b.retryFailedImages()}async function c(){if(!q.value){he("æ²¡æœ‰å¯ä¿å­˜çš„å†…å®¹","warning");return}if(!(!S.value||!x.value))try{await i.saveChapterSession(S.value,x.value)?he("ç« èŠ‚è¿›åº¦å·²ä¿å­˜","success"):he("ä¿å­˜å¤±è´¥","error")}catch(j){console.error("ä¿å­˜ä¼šè¯å¤±è´¥:",j),he("ä¿å­˜å¤±è´¥: "+(j instanceof Error?j.message:"æœªçŸ¥é”™è¯¯"),"error")}}function f(j){B.value=j,C.value=!0}function se(){f("plugins")}function $(){he("è®¾ç½®å·²ä¿å­˜","success")}function Y(){O.value=!0}function ce(){he("ğŸŒ™ è¯¥åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­ï¼Œæ•¬è¯·æœŸå¾…ï¼","info")}function _e(j){const W=j.target;if(!(W instanceof HTMLInputElement||W instanceof HTMLTextAreaElement||W.getAttribute("contenteditable")==="true"||W.id==="bubbleTextEditor")&&!D.value&&j.altKey)switch(j.key){case"ArrowLeft":j.preventDefault(),R();break;case"ArrowRight":j.preventDefault(),I();break;case"ArrowUp":if(j.preventDefault(),!o.settings.textStyle.autoFontSize){const te=o.settings.textStyle.fontSize;o.updateTextStyle({fontSize:te+1})}break;case"ArrowDown":if(j.preventDefault(),!o.settings.textStyle.autoFontSize){const te=o.settings.textStyle.fontSize;o.updateTextStyle({fontSize:Math.max(10,te-1)})}break}}async function we(j){const W=V.value;if(!W||!W.translatedDataURL){console.log(`è‡ªåŠ¨å­—å·è®¾ç½®å˜æ›´: ${j} (ä»…å½±å“ä¸‹æ¬¡ç¿»è¯‘)`);return}const z=W.bubbleStates;if(!z||!Array.isArray(z)||z.length===0){console.log("å½“å‰å›¾ç‰‡æ²¡æœ‰ bubbleStatesï¼Œè·³è¿‡é‡æ¸²æŸ“");return}if(console.log(`è‡ªåŠ¨å­—å·è®¾ç½®å˜æ›´: ${j}ï¼Œå°†é‡æ–°æ¸²æŸ“...`),j){console.log("è‡ªåŠ¨å­—å·å·²å¼€å¯ï¼Œé‡æ–°è®¡ç®—å­—å·å¹¶æ¸²æŸ“...");try{const{apiClient:te}=await lt(async()=>{const{apiClient:fe}=await import("./client.Bht704G-.js");return{apiClient:fe}},__vite__mapDeps([4,5]));let oe="";if(W.cleanImageData){const fe=W.cleanImageData;oe=fe.includes("base64,")?fe.split("base64,")[1]||"":fe}else W.originalDataURL&&(oe=W.originalDataURL.includes("base64,")?W.originalDataURL.split("base64,")[1]||"":W.originalDataURL);if(!oe){console.log("æ²¡æœ‰å¯ç”¨çš„èƒŒæ™¯å›¾ï¼Œè·³è¿‡é‡æ¸²æŸ“");return}const re=z.map(fe=>({translatedText:fe.translatedText||"",coords:fe.coords,fontSize:fe.fontSize||o.settings.textStyle.fontSize,fontFamily:fe.fontFamily||o.settings.textStyle.fontFamily,textDirection:wt(fe),textColor:fe.textColor||o.settings.textStyle.textColor,rotationAngle:fe.rotationAngle||0,position:fe.position||{x:0,y:0},strokeEnabled:fe.strokeEnabled??o.settings.textStyle.strokeEnabled,strokeColor:fe.strokeColor||o.settings.textStyle.strokeColor,strokeWidth:fe.strokeWidth??o.settings.textStyle.strokeWidth})),ve=re.map(fe=>fe.translatedText),xe=re.map(fe=>fe.coords),ye=await te.post("/api/re_render_image",{clean_image:oe,bubble_texts:ve,bubble_coords:xe,fontSize:o.settings.textStyle.fontSize,fontFamily:o.settings.textStyle.fontFamily,textDirection:o.settings.textStyle.layoutDirection==="auto"?"vertical":o.settings.textStyle.layoutDirection,textColor:o.settings.textStyle.textColor,bubble_states:re,use_individual_styles:!0,use_inpainting:!1,use_lama:!1,fillColor:null,is_font_style_change:!0,autoFontSize:!0,strokeEnabled:o.settings.textStyle.strokeEnabled,strokeColor:o.settings.textStyle.strokeColor,strokeWidth:o.settings.textStyle.strokeWidth});if(ye.rendered_image){if(ye.bubble_states&&Array.isArray(ye.bubble_states)){const fe=z.map((Re,Ie)=>({...Re,fontSize:ye.bubble_states[Ie]?.fontSize??Re.fontSize}));n.updateCurrentImage({translatedDataURL:`data:image/png;base64,${ye.rendered_image}`,bubbleStates:fe,hasUnsavedChanges:!0}),r.setBubbles(fe)}else n.updateCurrentImage({translatedDataURL:`data:image/png;base64,${ye.rendered_image}`,hasUnsavedChanges:!0});console.log("è‡ªåŠ¨å­—å·æ¸²æŸ“æˆåŠŸ")}else ye.error&&(console.error("è‡ªåŠ¨å­—å·æ¸²æŸ“å¤±è´¥:",ye.error),he("é‡æ–°æ¸²æŸ“å¤±è´¥: "+ye.error,"error"))}catch(te){console.error("è‡ªåŠ¨å­—å·æ¸²æŸ“å‡ºé”™:",te)}}else{const te=o.settings.textStyle.fontSize;console.log(`è‡ªåŠ¨å­—å·å·²å…³é—­ï¼Œä½¿ç”¨å›ºå®šå­—å· ${te} æ¸²æŸ“...`);const oe=z.map(re=>({...re,fontSize:te}));n.updateCurrentImage({bubbleStates:oe}),r.setBubbles(oe),await $e("fontSize",te)}}async function $e(j,W){const z=V.value;if(!z||!z.translatedDataURL||!z.bubbleStates||z.bubbleStates.length===0||!["fontSize","fontFamily","layoutDirection","textColor","strokeEnabled","strokeColor","strokeWidth","fillColor"].includes(j))return;console.log(`å…¨å±€è®¾ç½®å˜æ›´ (${j}=${W})ï¼Œå‡†å¤‡é‡æ¸²æŸ“...`);const re={fontSize:"fontSize",fontFamily:"fontFamily",layoutDirection:"textDirection",textColor:"textColor",strokeEnabled:"strokeEnabled",strokeColor:"strokeColor",strokeWidth:"strokeWidth",fillColor:"fillColor"}[j];if(re&&z.bubbleStates)if(j==="layoutDirection")if(W==="auto"){console.log("æ’ç‰ˆæ–¹å‘è®¾ç½®ä¸º 'auto'ï¼Œä» autoTextDirection æ¢å¤æ¯ä¸ªæ°”æ³¡çš„æ’ç‰ˆæ–¹å‘");const ve=z.bubbleStates.map(xe=>({...xe,textDirection:xe.autoTextDirection==="vertical"||xe.autoTextDirection==="horizontal"?xe.autoTextDirection:"vertical"}));n.updateCurrentImage({bubbleStates:ve}),r.setBubbles(ve)}else{console.log(`æ’ç‰ˆæ–¹å‘è®¾ç½®ä¸º '${W}'ï¼Œåº”ç”¨åˆ°æ‰€æœ‰æ°”æ³¡`);const ve=z.bubbleStates.map(xe=>({...xe,textDirection:W}));n.updateCurrentImage({bubbleStates:ve}),r.setBubbles(ve)}else{const ve=z.bubbleStates.map(xe=>({...xe,[re]:W}));n.updateCurrentImage({bubbleStates:ve}),r.setBubbles(ve)}try{const xe=n.currentImage?.bubbleStates||z.bubbleStates||[];if(xe.length===0||!xe[0]?.coords){console.log("æ²¡æœ‰æœ‰æ•ˆçš„æ°”æ³¡åæ ‡ï¼Œè·³è¿‡é‡æ¸²æŸ“");return}const ye=o.settings.textStyle.layoutDirection,fe=xe.map(Pe=>({translatedText:Pe.translatedText||"",coords:Pe.coords,fontSize:Pe.fontSize||o.settings.textStyle.fontSize,fontFamily:Pe.fontFamily||o.settings.textStyle.fontFamily,textDirection:wt(Pe),textColor:Pe.textColor||o.settings.textStyle.textColor,rotationAngle:Pe.rotationAngle||0,position:Pe.position||{x:0,y:0},strokeEnabled:Pe.strokeEnabled??o.settings.textStyle.strokeEnabled,strokeColor:Pe.strokeColor||o.settings.textStyle.strokeColor,strokeWidth:Pe.strokeWidth??o.settings.textStyle.strokeWidth})),Re=fe.map(Pe=>Pe.translatedText),Ie=fe.map(Pe=>Pe.coords);let Ve="";if(z.cleanImageData){const Pe=z.cleanImageData;Ve=Pe.includes("base64,")?Pe.split("base64,")[1]||"":Pe}else z.originalDataURL&&(Ve=z.originalDataURL.includes("base64,")?z.originalDataURL.split("base64,")[1]||"":z.originalDataURL,console.log("handleTextStyleChanged: ä½¿ç”¨åŸå›¾ä½œä¸ºèƒŒæ™¯ï¼ˆå…œåº•ï¼‰"));if(!Ve){console.log("æ²¡æœ‰å¯ç”¨çš„èƒŒæ™¯å›¾ï¼Œè·³è¿‡é‡æ¸²æŸ“");return}const{apiClient:Oe}=await lt(async()=>{const{apiClient:Pe}=await import("./client.Bht704G-.js");return{apiClient:Pe}},__vite__mapDeps([4,5])),Me=await Oe.post("/api/re_render_image",{clean_image:Ve,bubble_texts:Re,bubble_coords:Ie,fontSize:o.settings.textStyle.fontSize,fontFamily:o.settings.textStyle.fontFamily,textDirection:ye==="auto"?"vertical":ye,textColor:o.settings.textStyle.textColor,bubble_states:fe,use_individual_styles:!0,use_inpainting:!1,use_lama:!1,fillColor:null,is_font_style_change:!0,strokeEnabled:o.settings.textStyle.strokeEnabled,strokeColor:o.settings.textStyle.strokeColor,strokeWidth:o.settings.textStyle.strokeWidth});Me.rendered_image?(n.updateCurrentImage({translatedDataURL:`data:image/png;base64,${Me.rendered_image}`,hasUnsavedChanges:!0}),console.log("è®¾ç½®å˜æ›´åé‡æ–°æ¸²æŸ“æˆåŠŸ")):Me.error&&console.error("é‡æ–°æ¸²æŸ“å¤±è´¥:",Me.error)}catch(ve){console.error("è®¾ç½®å˜æ›´åé‡æ–°æ¸²æŸ“å¤±è´¥:",ve)}}function me(j){P.switchImage(j)}return(j,W)=>{const z=fs("router-link");return E(),U("div",{class:De(["translate-page",{"edit-mode-active":D.value}])},[e("header",Uh,[e("div",Oh,[e("div",zh,[Ce(z,{to:"/",title:"è¿”å›ä¹¦æ¶"},{default:_t(()=>[...W[3]||(W[3]=[e("img",{src:"/pic/logo.png",alt:"Saber-Translator Logo",class:"app-logo"},null,-1),e("span",{class:"app-name"},"Saber-Translator",-1)])]),_:1})]),e("div",Nh,[Ce(z,{to:"/",class:"back-to-shelf",title:"è¿”å›ä¹¦æ¶"},{default:_t(()=>[...W[4]||(W[4]=[pe("ğŸ“š",-1)])]),_:1}),d.value?(E(),U("button",{key:0,class:"save-header-btn",title:"ä¿å­˜è¿›åº¦",onClick:c}," ğŸ’¾ ")):de("",!0),e("button",{id:"openSettingsBtn",class:"settings-header-btn",title:"æ‰“å¼€è®¾ç½®",onClick:W[0]||(W[0]=te=>f())},[...W[5]||(W[5]=[e("span",{class:"icon"},"âš™ï¸",-1),e("span",null,"è®¾ç½®",-1)])]),W[8]||(W[8]=e("a",{href:"http://www.mashirosaber.top",target:"_blank",class:"tutorial-link"},"ä½¿ç”¨æ•™ç¨‹",-1)),e("a",{href:"javascript:void(0)",class:"donate-link",onClick:Y},[...W[6]||(W[6]=[e("span",null,"â¤ï¸ è¯·ä½œè€…å–å¥¶èŒ¶",-1)])]),W[9]||(W[9]=e("a",{href:"https://github.com/MashiroSaber03",target:"_blank",class:"github-link"},[e("img",{src:"/pic/github.jpg",alt:"GitHub",class:"github-icon"})],-1)),e("button",{class:"theme-toggle",title:"åŠŸèƒ½å¼€å‘ä¸­",onClick:ce},[...W[7]||(W[7]=[e("span",{class:"theme-icon"},"â˜€ï¸",-1)])])])])]),e("div",Vh,[Ce(pl,{onTranslateCurrent:T,onTranslateAll:k,onHqTranslate:F,onProofread:y,onRemoveText:p,onRemoveAllText:a,onRetryFailed:L,onDeleteCurrent:v,onClearAll:A,onCleanTemp:_,onOpenPlugins:se,onOpenSettings:f,onPrevious:R,onNext:I,onApplyToAll:Q,onTextStyleChanged:$e,onAutoFontSizeChanged:we}),e("main",Wh,[e("section",Kh,[e("div",qh,[Ce(da,{ref_key:"imageUploadRef",ref:M,onUploadComplete:le},null,512)]),H(i).loadingProgress.total>0?(E(),st(xo,{key:0,visible:!0,percentage:H(i).loadingProgress.current/H(i).loadingProgress.total*100,label:H(i).loadingProgress.message},null,8,["percentage","label"])):de("",!0),Ce(qi,{progress:H(b).progress.value},null,8,["progress"]),N.value&&d.value?(E(),U("div",Hh,[...W[10]||(W[10]=[e("span",{style:{color:"#888","font-size":"0.85em"}}," ï¼ˆä¹¦æ¶æ¨¡å¼ä¸‹é€€å‡ºå‰è¯·ç‚¹å‡»é¡¶éƒ¨ä¿å­˜æŒ‰é’®ï¼‰ ",-1)])])):de("",!0)]),Ce(Ll,{ref_key:"imageResultRef",ref:w,"is-edit-mode":D.value,onToggleEditMode:g,onRetryFailed:L},null,8,["is-edit-mode"])]),q.value&&!D.value?(E(),st(br,{key:0,onSelect:me})):de("",!0)]),V.value&&D.value?(E(),st(Zv,{key:0,"is-edit-mode-active":D.value,onExit:g},null,8,["is-edit-mode-active"])):de("",!0),Ce(Nl,{onOpenSettings:f}),Ce(Kp,{modelValue:C.value,"onUpdate:modelValue":W[1]||(W[1]=te=>C.value=te),"initial-tab":B.value,onSave:$},null,8,["modelValue","initial-tab"]),O.value?(E(),st(ji,{key:1,onClose:W[2]||(W[2]=te=>O.value=!1)})):de("",!0),Ce(Fh),Ce(Ih)],2)}}}),ny=qe(jh,[["__scopeId","data-v-00bc0059"]]);export{ny as default};
