const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["js/system.B3KD2uF9.js","js/index.Dwmqb8Lh.js","js/vue-vendor.DIYfje1l.js","assets/index.BYanE9pL.css","js/client.Bht704G-.js","js/utils-vendor.B9ygI19o.js","js/session.C_VZSWrV.js"])))=>i.map(i=>d[i]);
import{D as xn,b as vo,c as fo,d as bo,e as yn,f as yt,a as rt,S as Go,_ as He,g as Ne,s as _e,u as ct,h as cs,i as ds,j as gs,k as ps,l as ms,m as vs,n as fs,o as Zo,p as Qo,B as en,q as tn,r as bs,F as uo,t as on,v as nn,w as hs,L as sn,W as xs}from"./index.Dwmqb8Lh.js";import{d as Yt,r as w,c as Z,a as je,e as F,h as de,f as e,t as ne,i as at,k as B,g as ut,n as Ie,u as me,o as dt,v as le,x as Ue,l as Ce,s as an,m as St,K as nt,D as H,F as ze,j as Ye,M as ho,N as ys,L as _n,w as Se,B as pt,O as $t,z as we,p as lt,P as po,b as zt,Q as kt,S as ln,A as Cn,U as _s,T as Sn,C as Cs}from"./vue-vendor.DIYfje1l.js";import{p as Ss,a as ks,b as ws,c as $s,d as Ts,e as Is,f as Ps,h as Rs,i as Ds,j as Ms,k as xo,l as kn}from"./system.B3KD2uF9.js";import{getFontList as wn,uploadFont as Es,getTextboxPrompts as Bs,getPrompts as As,configApi as Ke,getFontListApi as Ls}from"./config.CwRcCkM9.js";import{_ as Ve}from"./CustomSelect.vue_vue_type_style_index_0_lang.BbTiIb--.js";import{apiClient as Xe}from"./client.Bht704G-.js";import{B as $n}from"./BaseModal.C6CmZdsd.js";import{getBookDetail as Fs}from"./bookshelf.B4ums9uK.js";import"./utils-vendor.B9ygI19o.js";function rn(){return{firecrawl:{apiKey:""},agent:{provider:"openai",apiKey:"",customBaseUrl:"",modelName:"gpt-4o-mini",useStream:!1,forceJsonOutput:!0,maxRetries:3,timeout:120},extraction:{prompt:xn,maxIterations:10},download:{concurrency:3,timeout:30,retries:3,delay:100,useReferer:!0},imagePreprocess:{enabled:!1,autoRotate:!0,compression:{enabled:!1,quality:85,maxWidth:0,maxHeight:0},formatConvert:{enabled:!1,targetFormat:"original"}},advanced:{customCookie:"",customHeaders:"",bypassProxy:!1},ui:{showAgentLogs:!0,autoImport:!1}}}function Us(n,t){function s(d){n.value.firecrawl.apiKey=d,t()}function o(d){n.value.agent.provider=d,t()}function l(d){n.value.agent.apiKey=d,t()}function u(d){n.value.agent.customBaseUrl=d,t()}function a(d){n.value.agent.modelName=d,t()}function c(d){n.value.agent.useStream=d,t()}function v(d){n.value.agent.forceJsonOutput=d,t()}function p(d){n.value.agent.timeout=d,t()}function _(d){n.value.extraction.prompt=d,t()}function S(d){n.value.extraction.maxIterations=d,t()}function D(){n.value.extraction.prompt=xn,t()}function M(d){n.value.download.concurrency=d,t()}function E(d){n.value.download.timeout=d,t()}function P(d){n.value.download.retries=d,t()}function q(d){n.value.download.delay=d,t()}function V(d){n.value.download.useReferer=d,t()}function U(d){n.value.imagePreprocess.enabled=d,t()}function f(d){n.value.imagePreprocess.autoRotate=d,t()}function m(d){n.value.imagePreprocess.compression.enabled=d,t()}function C(d){n.value.imagePreprocess.compression.quality=d,t()}function k(d){n.value.imagePreprocess.compression.maxWidth=d,t()}function K(d){n.value.imagePreprocess.compression.maxHeight=d,t()}function N(d){n.value.imagePreprocess.formatConvert.enabled=d,t()}function se(d){n.value.imagePreprocess.formatConvert.targetFormat=d,t()}function G(d){n.value.advanced.customCookie=d,t()}function J(d){n.value.advanced.customHeaders=d,t()}function ee(d){n.value.advanced.bypassProxy=d,t()}function j(d){n.value.ui.showAgentLogs=d,t()}function ae(d){n.value.ui.autoImport=d,t()}function A(d){n.value={...n.value,...d},t()}return{setFirecrawlApiKey:s,setAgentProvider:o,setAgentApiKey:l,setAgentBaseUrl:u,setAgentModelName:a,setAgentUseStream:c,setAgentForceJson:v,setAgentTimeout:p,setExtractionPrompt:_,setExtractionMaxIterations:S,resetExtractionPrompt:D,setDownloadConcurrency:M,setDownloadTimeout:E,setDownloadRetries:P,setDownloadDelay:q,setDownloadUseReferer:V,setImagePreprocessEnabled:U,setImageAutoRotate:f,setImageCompressionEnabled:m,setImageCompressionQuality:C,setImageMaxWidth:k,setImageMaxHeight:K,setImageFormatConvertEnabled:N,setImageTargetFormat:se,setCustomCookie:G,setCustomHeaders:J,setBypassProxy:ee,setShowAgentLogs:j,setAutoImport:ae,updateWebImportSettings:A}}async function yo(n){return Xe.post("/api/re_render_image",n)}async function At(n){try{return{success:!0,data:await Xe.post("/api/translate_single_text",n)}}catch(t){return{success:!1,error:t instanceof Error?t.message:"ç¿»è¯‘å¤±è´¥"}}}async function Lt(n){return Xe.post("/api/hq_translate_batch",n)}async function mo(n,t,s){return Xe.post("/api/detect_boxes",{image:n,detector_type:t,...s})}async function Tn(n,t,s,o){return Xe.post("/api/ocr_single_bubble",{image_data:n,bubble_coords:t,ocr_engine:s,...o})}async function _o(n,t,s){return Xe.post("/api/inpaint_single_bubble",{image_data:n,bubble_coords:t,bubble_angle:s?.bubbleAngle??0,method:s?.method??"lama",lama_model:s?.lamaModel??"lama_mpe",...s?.maskData&&{mask_data:s.maskData}})}const Os=Object.freeze(Object.defineProperty({__proto__:null,detectBoxes:mo,hqTranslateBatch:Lt,inpaintSingleBubble:_o,ocrSingleBubble:Tn,reRenderImage:yo,translateSingleText:At},Symbol.toStringTag,{value:"Module"}));async function In(n,t){return Xe.post(`/api/sessions/meta/${n}`,t)}async function jt(n,t,s,o){return Xe.post(`/api/sessions/page/${n}/${t}/${s}`,{data:o})}async function Pn(n,t,s){return Xe.post(`/api/sessions/page/${n}/${t}/meta`,s)}async function Rn(n,t,s){return Xe.post(`/api/sessions/save_translated/${n}/${t}`,s)}function Jt(n){if(!n||typeof n!="string"||n.startsWith("/api/"))return null;if(n.startsWith("data:")){const t=n.split(",");return t.length>1?t[1]??null:null}return n}async function zs(n,t,s){const o=t.length;let l=0;for(let u=0;u<o;u++){const a=t[u];if(a){s?.onProgress?.(u+1,o);try{const c=Jt(a.originalDataURL);c&&await jt(n,u,"original",c);const v=Jt(a.translatedDataURL);v&&await jt(n,u,"translated",v);const p=Jt(a.cleanImageData);p&&await jt(n,u,"clean",p);const _={fileName:a.fileName,translationStatus:a.translationStatus,translationFailed:a.translationFailed,bubbleStates:a.bubbleStates,isManuallyAnnotated:a.isManuallyAnnotated,relativePath:a.relativePath,folderPath:a.folderPath,fontSize:a.fontSize,autoFontSize:a.autoFontSize,fontFamily:a.fontFamily,layoutDirection:a.layoutDirection,useAutoTextColor:a.useAutoTextColor,textColor:a.textColor,fillColor:a.fillColor,inpaintMethod:a.inpaintMethod,strokeEnabled:a.strokeEnabled,strokeColor:a.strokeColor,strokeWidth:a.strokeWidth};await Pn(n,u,_),l++}catch(c){console.error(`ä¿å­˜ç¬¬ ${u+1} é¡µå¤±è´¥:`,c)}}}return l}const Dn=Object.freeze(Object.defineProperty({__proto__:null,extractBase64:Jt,saveAllPagesSequentially:zs,savePageImage:jt,savePageMeta:Pn,saveSessionMeta:In,saveTranslatedPage:Rn},Symbol.toStringTag,{value:"Module"}));async function Ns(){return Xe.get("/api/plugins")}async function Vs(n){const t=encodeURIComponent(n);return Xe.post(`/api/plugins/${t}/enable`)}async function Ws(n){const t=encodeURIComponent(n);return Xe.post(`/api/plugins/${t}/disable`)}async function Ks(n){const t=encodeURIComponent(n);return Xe.delete(`/api/plugins/${t}`)}async function qs(n){const t=encodeURIComponent(n);return Xe.get(`/api/plugins/${t}/config_schema`)}async function Hs(n){const t=encodeURIComponent(n);return Xe.get(`/api/plugins/${t}/config`)}async function js(n,t){const s=encodeURIComponent(n);return Xe.post(`/api/plugins/${s}/config`,t)}async function Js(){return Xe.get("/api/plugins/default_states")}async function Ys(n,t){const s=encodeURIComponent(n);return Xe.post(`/api/plugins/${s}/set_default_state`,{enabled:t})}async function Xs(){return{states:(await Js()).default_states}}const Gs=Ys,Zs=qs,Qs=Hs,ea=js;function ta(){return`img_${Date.now()}_${Math.random().toString(36).substring(2,9)}`}function un(n,t,s){return{id:ta(),fileName:n,originalDataURL:t,translatedDataURL:null,cleanImageData:null,bubbleStates:null,translationStatus:"pending",translationFailed:!1,fontSize:25,autoFontSize:!1,fontFamily:yt,layoutDirection:"auto",textColor:"#000000",fillColor:yn,inpaintMethod:"solid",strokeEnabled:bo,strokeColor:fo,strokeWidth:vo,hasUnsavedChanges:!1,...s}}const et=Yt("image",()=>{const n=w([]),t=w(-1),s=w(!1),o=Z(()=>t.value>=0&&t.value<n.value.length?n.value[t.value]??null:null),l=Z(()=>n.value.length),u=Z(()=>n.value.length>0),a=Z(()=>t.value>0),c=Z(()=>t.value<n.value.length-1),v=Z(()=>n.value.filter(d=>d.translationFailed).length),p=Z(()=>n.value.filter(d=>d.translationStatus==="completed").length),_=Z(()=>n.value.filter(d=>d.translationStatus==="pending").length);function S(d,$,r){const h=un(d,$,r);return n.value.push(h),n.value.length===1&&(t.value=0),console.log(`å›¾ç‰‡å·²æ·»åŠ : ${d}ï¼Œå½“å‰å…± ${n.value.length} å¼ å›¾ç‰‡`),h}function D(d){const $=d.map(({fileName:h,originalDataURL:I,overrides:T})=>un(h,I,T)),r=n.value.length===0;return n.value.push(...$),r&&n.value.length>0&&(t.value=0),console.log(`æ‰¹é‡æ·»åŠ äº† ${$.length} å¼ å›¾ç‰‡ï¼Œå½“å‰å…± ${n.value.length} å¼ `),$}function M(d){n.value=d.map($=>({...$,strokeEnabled:$.strokeEnabled??bo,strokeColor:$.strokeColor||fo,strokeWidth:$.strokeWidth??vo,hasUnsavedChanges:$.hasUnsavedChanges||!1})),n.value.length>0?t.value=Math.min(Math.max(0,t.value),n.value.length-1):t.value=-1,console.log(`å›¾ç‰‡æ•°ç»„å·²è®¾ç½®ï¼Œå…± ${n.value.length} å¼ å›¾ç‰‡`)}function E(d){return d<0||d>=n.value.length?(console.warn(`åˆ é™¤å¤±è´¥: æ— æ•ˆçš„ç´¢å¼• ${d}`),!1):(n.value.splice(d,1),t.value===d?(t.value=Math.min(d,n.value.length-1),n.value.length===0&&(t.value=-1)):t.value>d&&t.value--,console.log(`å›¾ç‰‡å·²åˆ é™¤ï¼Œå½“å‰å…± ${n.value.length} å¼ å›¾ç‰‡`),!0)}function P(){return E(t.value)}function q(){n.value=[],t.value=-1,s.value=!1,console.log("æ‰€æœ‰å›¾ç‰‡å·²æ¸…é™¤")}function V(){const d=o.value?.id||null;if(n.value.sort(($,r)=>$.fileName.localeCompare(r.fileName,void 0,{numeric:!0,sensitivity:"base"})),d){const $=n.value.findIndex(r=>r.id===d);$>=0&&$!==t.value&&(console.log(`å›¾ç‰‡æ’åº: currentImageIndex ä» ${t.value} æ›´æ–°ä¸º ${$}`),t.value=$)}console.log("å›¾ç‰‡å·²æŒ‰æ–‡ä»¶åæ’åº")}function U(d){d>=-1&&d<n.value.length?(t.value=d,console.log(`å½“å‰å›¾ç‰‡ç´¢å¼•å·²è®¾ç½®ä¸º ${d}`)):console.warn(`è®¾ç½®ç´¢å¼•å¤±è´¥: æ— æ•ˆçš„ç´¢å¼• ${d}`)}function f(){return a.value?(t.value--,!0):!1}function m(){return c.value?(t.value++,!0):!1}function C(d){o.value?(Object.assign(o.value,d),console.log("å½“å‰å›¾ç‰‡å±æ€§å·²æ›´æ–°:",Object.keys(d))):console.warn("æ›´æ–°å¤±è´¥: å½“å‰æ²¡æœ‰é€‰ä¸­çš„å›¾ç‰‡")}function k(d,$){if(d>=0&&d<n.value.length){const r=n.value[d];r&&(Object.assign(r,$),console.log(`å›¾ç‰‡ ${d} å±æ€§å·²æ›´æ–°:`,Object.keys($)))}else console.warn(`æ›´æ–°å¤±è´¥: æ— æ•ˆçš„ç´¢å¼• ${d}`)}function K(d){o.value&&(o.value.bubbleStates=d,o.value.hasUnsavedChanges=!0,console.log(`å½“å‰å›¾ç‰‡æ°”æ³¡çŠ¶æ€å·²æ›´æ–°ï¼Œå…± ${d?.length??0} ä¸ªæ°”æ³¡`))}function N(d){o.value&&(o.value.isManuallyAnnotated=d,o.value.hasUnsavedChanges=!0,console.log(`æ‰‹åŠ¨æ ‡æ³¨æ ‡è®°å·²è®¾ç½®ä¸º: ${d}`))}function se(d,$){o.value?(o.value[d]=$,o.value.hasUnsavedChanges=!0,console.log(`å½“å‰å›¾ç‰‡å±æ€§ ${String(d)} å·²æ›´æ–°`)):console.warn("æ›´æ–°å¤±è´¥: å½“å‰æ²¡æœ‰é€‰ä¸­çš„å›¾ç‰‡")}function G(d,$){o.value&&(o.value.translatedDataURL=d,$&&(o.value.cleanImageData=$),o.value.translationStatus="completed",o.value.translationFailed=!1,o.value.hasUnsavedChanges=!0,console.log("å½“å‰å›¾ç‰‡ç¿»è¯‘ç»“æœå·²æ›´æ–°"))}function J(d,$,r){if(d>=0&&d<n.value.length){const h=n.value[d];h&&(h.translationStatus=$,h.translationFailed=$==="failed",r&&(h.errorMessage=r),console.log(`å›¾ç‰‡ ${d} ç¿»è¯‘çŠ¶æ€: ${$}`))}}function ee(d){o.value&&(o.value.translationStatus="failed",o.value.translationFailed=!0,o.value.errorMessage=d,console.log(`å½“å‰å›¾ç‰‡ç¿»è¯‘å¤±è´¥: ${d}`))}function j(){n.value.forEach(d=>{d.translationStatus="pending",d.translationFailed=!1,d.errorMessage=void 0}),console.log("æ‰€æœ‰å›¾ç‰‡ç¿»è¯‘çŠ¶æ€å·²é‡ç½®")}function ae(d){s.value=d,console.log(`æ‰¹é‡ç¿»è¯‘çŠ¶æ€: ${d?"è¿›è¡Œä¸­":"å·²å®Œæˆ"}`)}function A(){return n.value.map((d,$)=>d.translationFailed?$:-1).filter(d=>d!==-1)}return{images:n,currentImageIndex:t,isBatchTranslationInProgress:s,currentImage:o,imageCount:l,hasImages:u,canGoPrevious:a,canGoNext:c,failedImageCount:v,completedImageCount:p,pendingImageCount:_,addImage:S,addImages:D,setImages:M,deleteImage:E,deleteCurrentImage:P,clearImages:q,sortImagesByFileName:V,setCurrentImageIndex:U,goToPrevious:f,goToNext:m,updateCurrentImage:C,updateImageByIndex:k,updateCurrentBubbleStates:K,setManuallyAnnotated:N,updateCurrentImageProperty:se,updateCurrentTranslationResult:G,setTranslationStatus:J,markCurrentAsFailed:ee,resetAllTranslationStatus:j,setBatchTranslationInProgress:ae,getFailedImageIndices:A}}),cn=Object.freeze(Object.defineProperty({__proto__:null,useImageStore:et},Symbol.toStringTag,{value:"Module"})),It=Yt("session",()=>{const n=w(null),t=w({bookId:null,chapterId:null,bookTitle:null,chapterTitle:null}),s=w([]),o=w(!1),l=w({current:0,total:0,message:""}),u=w(null),a=w(!1),c=Z(()=>t.value.bookId!==null&&t.value.chapterId!==null),v=Z(()=>t.value.bookId),p=Z(()=>t.value.chapterId);function _(ee,j,ae=null,A=null){t.value={bookId:ee,chapterId:j,bookTitle:ae,chapterTitle:A},console.log(`ä¼šè¯ä¸Šä¸‹æ–‡å·²è®¾ç½®: ä¹¦ç±=${ee}, ç« èŠ‚=${j}`)}function S(ee,j,ae,A){_(ee,j,ae,A)}function D(){t.value={bookId:null,chapterId:null,bookTitle:null,chapterTitle:null},console.log("ä¼šè¯ä¸Šä¸‹æ–‡å·²æ¸…é™¤")}function M(ee){const j=ee.get("book"),ae=ee.get("chapter");j&&ae&&_(j,ae)}function E(ee){n.value=ee,console.log(`å½“å‰ä¼šè¯åç§°: ${ee}`)}function P(){n.value=null}function q(ee){s.value=ee,console.log(`ä¼šè¯åˆ—è¡¨å·²æ›´æ–°ï¼Œå…± ${ee.length} ä¸ªä¼šè¯`)}function V(ee){const j=s.value.findIndex(ae=>ae.name===ee.name);j>=0?s.value[j]=ee:s.value.unshift(ee)}function U(ee){const j=s.value.findIndex(ae=>ae.name===ee);j>=0&&s.value.splice(j,1)}function f(ee,j){const ae=s.value.find(A=>A.name===ee);ae&&(ae.name=j)}function m(ee){o.value=ee}function C(ee){a.value=ee}function k(ee){u.value=ee}function K(){n.value=null,t.value={bookId:null,chapterId:null,bookTitle:null,chapterTitle:null},s.value=[],o.value=!1,a.value=!1,u.value=null,console.log("ä¼šè¯çŠ¶æ€å·²é‡ç½®")}async function N(ee){if(!ee||typeof ee!="string")return null;if(ee.startsWith("data:"))return ee;if(!ee.startsWith("/api/"))return null;try{const j=await fetch(ee);if(!j.ok)return null;const ae=await j.blob();return new Promise(A=>{const d=new FileReader;d.onloadend=()=>A(d.result),d.onerror=()=>A(null),d.readAsDataURL(ae)})}catch(j){return console.error(`è½¬æ¢å›¾ç‰‡ URL å¤±è´¥: ${ee}`,j),null}}async function se(ee,j){const ae=ee.length;for(let A=0;A<ae;A++){const d=ee[A];if(d){if(j&&j(A+1,ae),d.originalDataURL&&d.originalDataURL.startsWith("/api/")){const $=await N(d.originalDataURL);$&&(d.originalDataURL=$)}if(d.translatedDataURL&&d.translatedDataURL.startsWith("/api/")){const $=await N(d.translatedDataURL);$&&(d.translatedDataURL=$)}if(d.cleanImageData&&d.cleanImageData.startsWith("/api/")){const $=await N(d.cleanImageData);$&&(d.cleanImageData=$.replace(/^data:image\/\w+;base64,/,""))}}}}async function G(ee){m(!0),k(null),l.value={current:0,total:0,message:"æ­£åœ¨åŠ è½½..."};try{const{useImageStore:j}=await rt(async()=>{const{useImageStore:b}=await Promise.resolve().then(()=>cn);return{useImageStore:b}},void 0),{useSettingsStore:ae}=await rt(async()=>{const{useSettingsStore:b}=await import("./system.B3KD2uF9.js").then(L=>L.s);return{useSettingsStore:b}},__vite__mapDeps([0,1,2,3,4,5])),{useBubbleStore:A}=await rt(async()=>{const{useBubbleStore:b}=await Promise.resolve().then(()=>di);return{useBubbleStore:b}},void 0),d=j(),$=ae(),r=A(),{loadSessionByPathApi:h}=await rt(async()=>{const{loadSessionByPathApi:b}=await import("./session.C_VZSWrV.js");return{loadSessionByPathApi:b}},__vite__mapDeps([6,4,5])),I=await h(ee);if(!I.success||!I.session)throw new Error(I.error||"åŠ è½½ä¼šè¯å¤±è´¥");const T=I.session;if(T.images&&T.images.length>0){const b=T.images.map((i,x)=>({id:`session-${x}-${Date.now()}`,originalDataURL:i.originalDataURL,translatedDataURL:i.translatedDataURL||null,cleanImageData:i.cleanImageData||null,bubbleStates:i.bubbleStates!==void 0&&i.bubbleStates!==null?i.bubbleStates:null,isManuallyAnnotated:!!i.isManuallyAnnotated,relativePath:i.relativePath||void 0,folderPath:i.folderPath||void 0,fileName:i.fileName||`image-${x+1}.png`,translationStatus:i.translationStatus||"pending",translationFailed:!!i.translationFailed,hasUnsavedChanges:!1,fontSize:i.fontSize||24,autoFontSize:i.autoFontSize??!1,fontFamily:i.fontFamily||"Microsoft YaHei",layoutDirection:i.layoutDirection||"auto",useAutoTextColor:i.useAutoTextColor??void 0,textColor:i.textColor||"#000000",fillColor:i.fillColor||"#FFFFFF",inpaintMethod:i.inpaintMethod||"litelama",strokeEnabled:i.strokeEnabled??!1,strokeColor:i.strokeColor||"#FFFFFF",strokeWidth:i.strokeWidth||2}));b.length>0&&(console.log("æ­£åœ¨åŠ è½½å›¾ç‰‡..."),l.value={current:0,total:b.length,message:"æ­£åœ¨åŠ è½½å›¾ç‰‡..."},await se(b,(i,x)=>{const ie=i/x*100;l.value={current:i,total:x,message:`åŠ è½½å›¾ç‰‡ ${i}/${x}...`},console.log(`åŠ è½½å›¾ç‰‡ ${i}/${x}... (${ie.toFixed(0)}%)`)}),l.value={current:b.length,total:b.length,message:"åŠ è½½å®Œæˆ"},console.log("å›¾ç‰‡åŠ è½½å®Œæˆï¼Œå·²è½¬æ¢ä¸º Base64"),setTimeout(()=>{l.value={current:0,total:0,message:""}},500)),d.setImages(b);let L=0;typeof T.currentImageIndex=="number"&&(L=T.currentImageIndex,(L>=b.length||L<0)&&(L=b.length>0?0:-1)),d.setCurrentImageIndex(L);const W=b[L];W&&W.bubbleStates&&W.bubbleStates.length>0?r.setBubbles(W.bubbleStates,!0):r.clearBubblesLocal(),console.log(`æŒ‰è·¯å¾„åŠ è½½ä¼šè¯æˆåŠŸ: ${ee}, å…± ${b.length} å¼ å›¾ç‰‡`)}const g=T.ui_settings;if(g){(g.targetLanguage||g.sourceLanguage)&&$.updateSettings({targetLanguage:g.targetLanguage||void 0,sourceLanguage:g.sourceLanguage||void 0});const b=g.useInpaintingMethod,W=["solid","lama_mpe","litelama"].includes(b)?b:$.settings.textStyle.inpaintMethod;$.updateTextStyle({fontSize:g.fontSize||$.settings.textStyle.fontSize,autoFontSize:g.autoFontSize??$.settings.textStyle.autoFontSize,fontFamily:g.fontFamily||$.settings.textStyle.fontFamily,layoutDirection:g.layoutDirection||$.settings.textStyle.layoutDirection,textColor:g.textColor||$.settings.textStyle.textColor,fillColor:g.fillColor||$.settings.textStyle.fillColor,inpaintMethod:W,strokeEnabled:g.strokeEnabled??$.settings.textStyle.strokeEnabled,strokeColor:g.strokeColor||$.settings.textStyle.strokeColor,strokeWidth:g.strokeWidth||$.settings.textStyle.strokeWidth,useAutoTextColor:g.useAutoTextColor??$.settings.textStyle.useAutoTextColor}),console.log("UI è®¾ç½®å·²æ¢å¤")}return E(ee),!0}catch(j){const ae=j instanceof Error?j.message:"åŠ è½½ä¼šè¯å¤±è´¥";throw k(ae),console.error(`æŒ‰è·¯å¾„åŠ è½½ä¼šè¯å¤±è´¥: ${ee}`,j),j}finally{m(!1)}}async function J(ee,j){if(!ee||!j)return console.log("æœªåœ¨ä¹¦ç±/ç« èŠ‚æ¨¡å¼ï¼Œä¸æ”¯æŒä¿å­˜"),!1;console.log(`ä¿å­˜ç« èŠ‚ä¼šè¯: book=${ee}, chapter=${j}`);const{useImageStore:ae}=await rt(async()=>{const{useImageStore:T}=await Promise.resolve().then(()=>cn);return{useImageStore:T}},void 0),{useSettingsStore:A}=await rt(async()=>{const{useSettingsStore:T}=await import("./system.B3KD2uF9.js").then(g=>g.s);return{useSettingsStore:T}},__vite__mapDeps([0,1,2,3,4,5])),d=ae(),$=A(),r=Array.isArray(d.images)?d.images:[];if(!r||r.length===0)return console.log("æ²¡æœ‰å›¾ç‰‡æ•°æ®å¯ä¿å­˜"),!1;const h=`bookshelf/${ee}/${j}`;C(!0),k(null);const I=r.length;l.value={current:0,total:I,message:`å‡†å¤‡ä¿å­˜ ${I} å¼ å›¾ç‰‡...`};try{r.some(x=>x.originalDataURL&&x.originalDataURL.startsWith("/api/")||x.translatedDataURL&&x.translatedDataURL.startsWith("/api/")||x.cleanImageData&&x.cleanImageData.startsWith("/api/"))&&(console.log("[saveChapterSession] æ£€æµ‹åˆ° /api/ URL æ ¼å¼å›¾ç‰‡ï¼Œå¼€å§‹è½¬æ¢ä¸º Base64..."),l.value={current:0,total:I,message:"è½¬æ¢å›¾ç‰‡æ ¼å¼..."},await se(r,(x,ie)=>{l.value={current:0,total:I,message:`è½¬æ¢å›¾ç‰‡ ${x}/${ie}...`}}),console.log("[saveChapterSession] å›¾ç‰‡æ ¼å¼è½¬æ¢å®Œæˆ"));const{textStyle:g}=$.settings,b={fontSize:g.fontSize,autoFontSize:g.autoFontSize,fontFamily:g.fontFamily,layoutDirection:g.layoutDirection,textColor:g.textColor,useInpaintingMethod:g.inpaintMethod,fillColor:g.fillColor,strokeEnabled:g.strokeEnabled,strokeColor:g.strokeColor,strokeWidth:g.strokeWidth,useAutoTextColor:g.useAutoTextColor},{saveAllPagesSequentially:L,saveSessionMeta:W}=await rt(async()=>{const{saveAllPagesSequentially:x,saveSessionMeta:ie}=await Promise.resolve().then(()=>Dn);return{saveAllPagesSequentially:x,saveSessionMeta:ie}},void 0),i=await L(h,r,{onProgress:(x,ie)=>{l.value={current:x,total:ie,message:`ä¿å­˜å›¾ç‰‡ ${x}/${ie}...`}}});l.value={current:I,total:I,message:"å®Œæˆä¿å­˜..."},await W(h,{ui_settings:b,total_pages:I,currentImageIndex:d.currentImageIndex}),console.log(`ç« èŠ‚ä¿å­˜å®Œæˆ: ${i}/${I} å¼ å›¾ç‰‡`);try{const{apiClient:x}=await rt(async()=>{const{apiClient:ie}=await import("./client.Bht704G-.js");return{apiClient:ie}},__vite__mapDeps([4,5]));await x.put(`/api/bookshelf/books/${ee}/chapters/${j}/image-count`,{count:I})}catch(x){console.warn("æ›´æ–°ç« èŠ‚å›¾ç‰‡æ•°é‡å¤±è´¥ï¼ˆéè‡´å‘½ï¼‰:",x)}return l.value={current:I,total:I,message:"ä¿å­˜å®Œæˆ"},setTimeout(()=>{l.value={current:0,total:0,message:""}},1e3),!0}catch(T){const g=T instanceof Error?T.message:"ä¿å­˜ç« èŠ‚ä¼šè¯å¤±è´¥";return k(g),console.error("ä¿å­˜å¤±è´¥:",T),l.value={current:0,total:0,message:""},!1}finally{C(!1)}}return{currentSessionName:n,context:t,sessionList:s,isLoading:o,isSaving:a,error:u,loadingProgress:l,isBookshelfMode:c,currentBookId:v,currentChapterId:p,setContext:_,clearContext:D,parseContextFromUrl:M,setSessionName:E,clearSessionName:P,setSessionList:q,addToSessionList:V,removeFromSessionList:U,renameInSessionList:f,setLoading:m,setSaving:C,setError:k,imageUrlToBase64:N,saveChapterSession:J,loadSessionByPath:G,setBookChapterContext:S,reset:K}}),Nt={originalText:"",translatedText:"",textboxText:"",coords:[0,0,100,100],polygon:[],fontSize:25,fontFamily:yt,textDirection:"vertical",autoTextDirection:"vertical",textColor:"#000000",fillColor:yn,rotationAngle:0,position:{x:0,y:0},strokeEnabled:bo,strokeColor:fo,strokeWidth:vo,inpaintMethod:"solid",autoFgColor:null,autoBgColor:null,colorConfidence:0};function oa(n){return{...{...Nt,...n},coords:n?.coords?[...n.coords]:[...Nt.coords],polygon:n?.polygon?n.polygon.map(s=>[...s]):[],position:n?.position?{...Nt.position,...n.position}:{...Nt.position}}}function na(n){const[t,s,o,l]=n,u=Math.abs(o-t);return Math.abs(l-s)>u?"vertical":"horizontal"}function Vt(n){return n.map(t=>({...t,coords:[...t.coords],polygon:t.polygon?t.polygon.map(s=>[...s]):[],position:{...t.position},autoFgColor:t.autoFgColor?[...t.autoFgColor]:null,autoBgColor:t.autoBgColor?[...t.autoBgColor]:null}))}function sa(n){if(!n||typeof n!="object")return!1;const t=n;if(!Array.isArray(t.coords)||t.coords.length!==4||!t.coords.every(l=>typeof l=="number"&&!isNaN(l))||typeof t.fontSize!="number"||t.fontSize<=0)return!1;const s=["vertical","horizontal","auto"];if(typeof t.textDirection!="string"||!s.includes(t.textDirection))return!1;const o=["solid","lama_mpe","litelama"];return!(typeof t.inpaintMethod!="string"||!o.includes(t.inpaintMethod))}function aa(n){let t=n,s=0,o=0,l=Date.now();const u=()=>t<=0?0:Math.ceil(6e4/t);return{async acquire(){if(t<=0)return;const a=Date.now(),c=u();if(a-l>=6e4&&(l=a,o=0),o>=t){const p=6e4-(a-l);p>0&&await dn(p),l=Date.now(),o=0}const v=a-s;v<c&&await dn(c-v),s=Date.now(),o++},reset(){s=0,o=0,l=Date.now()},getRpm(){return t},setRpm(a){t=a,this.reset()}}}function dn(n){return new Promise(t=>setTimeout(t,n))}function gn(n){const t=n.replace(/\\/g,"/"),s=[],o=/(\d+)/g;let l=0,u;for(;(u=o.exec(t))!==null;){if(u.index>l){const a=t.slice(l,u.index);a&&s.push([!0,a.toLowerCase()])}s.push([!1,parseInt(u[0],10)]),l=o.lastIndex}if(l<t.length){const a=t.slice(l);a&&s.push([!0,a.toLowerCase()])}return s}function la(n,t){const s=gn(n),o=gn(t),l=Math.min(s.length,o.length);for(let u=0;u<l;u++){const[a,c]=s[u],[v,p]=o[u];if(a!==v)return a?1:-1;if(c<p)return-1;if(c>p)return 1}return s.length-o.length}function ia(n,t=s=>String(s)){return[...n].sort((s,o)=>la(t(s),t(o)))}const pn="webImportDisclaimerAccepted",Co=Yt("webImport",()=>{const n=w(rn()),t=w("idle"),s=w(""),o=w([]),l=w(null),u=w(new Set),a=w({current:0,total:0}),c=w([]),v=w(null),p=w(!1),_=w(!1),S=w(!1),D=Z(()=>t.value==="extracting"),M=Z(()=>t.value==="downloading"),E=Z(()=>D.value||M.value),P=Z(()=>u.value.size),q=Z(()=>a.value.total===0?0:Math.round(a.value.current/a.value.total*100));function V(){try{localStorage.setItem(Go,JSON.stringify(n.value))}catch(g){console.error("ä¿å­˜ç½‘é¡µå¯¼å…¥è®¾ç½®å¤±è´¥:",g)}}function U(){try{const g=localStorage.getItem(Go);if(g){const b=JSON.parse(g);n.value=f(rn(),b)}}catch(g){console.error("åŠ è½½ç½‘é¡µå¯¼å…¥è®¾ç½®å¤±è´¥:",g)}}function f(g,b){const L={...g};for(const W in b)if(Object.prototype.hasOwnProperty.call(b,W)){const i=b[W],x=g[W];i!==null&&typeof i=="object"&&!Array.isArray(i)&&x!==null&&typeof x=="object"&&!Array.isArray(x)?L[W]=f(x,i):i!==void 0&&(L[W]=i)}return L}function m(){_.value?p.value=!0:S.value=!0}function C(){_.value=!0,S.value=!1,p.value=!0;try{localStorage.setItem(pn,"true")}catch(g){console.error("ä¿å­˜å…è´£å£°æ˜çŠ¶æ€å¤±è´¥:",g)}}function k(){S.value=!1}function K(){try{const g=localStorage.getItem(pn);_.value=g==="true"}catch(g){console.error("åŠ è½½å…è´£å£°æ˜çŠ¶æ€å¤±è´¥:",g)}}function N(){p.value=!1}function se(){t.value="idle",s.value="",o.value=[],l.value=null,u.value=new Set,a.value={current:0,total:0},c.value=[],v.value=null}function G(g){s.value=g}function J(g){o.value.push(g)}function ee(){o.value=[]}function j(g){l.value&&l.value.pages.length>0?(l.value.comicTitle=g.comicTitle,l.value.chapterTitle=g.chapterTitle,l.value.totalPages=g.totalPages,l.value.sourceUrl=g.sourceUrl,l.value.referer=g.referer,l.value.engine=g.engine,l.value.success=g.success,l.value.error=g.error):(l.value=g,g.success&&g.pages&&(u.value=new Set(g.pages.map(b=>b.pageNumber))))}function ae(g){u.value.has(g)?u.value.delete(g):u.value.add(g),u.value=new Set(u.value)}function A(){l.value?.pages&&(u.value.size===l.value.pages.length?u.value=new Set:u.value=new Set(l.value.pages.map(g=>g.pageNumber)))}function d(g){t.value=g}function $(g){v.value=g,g&&(t.value="error")}function r(g,b){a.value={current:g,total:b}}function h(g){c.value=g}function I(g){l.value||(l.value={success:!0,comicTitle:"",chapterTitle:"",pages:[],totalPages:0,sourceUrl:s.value,referer:"",engine:"gallery-dl"}),l.value.pages.push(g),l.value.totalPages=l.value.pages.length,u.value.add(g.pageNumber),u.value=new Set(u.value)}const T=Us(n,V);return U(),K(),{settings:n,status:t,url:s,logs:o,extractResult:l,selectedPages:u,downloadProgress:a,downloadedImages:c,error:v,modalVisible:p,disclaimerAccepted:_,disclaimerVisible:S,isExtracting:D,isDownloading:M,isProcessing:E,selectedCount:P,downloadProgressPercent:q,saveToStorage:V,loadFromStorage:U,openModal:m,closeModal:N,resetState:se,setUrl:G,addLog:J,clearLogs:ee,setExtractResult:j,togglePageSelection:ae,toggleSelectAll:A,setStatus:d,setError:$,updateDownloadProgress:r,setDownloadedImages:h,addPageIncremental:I,acceptDisclaimer:C,rejectDisclaimer:k,...T}}),ra={key:0,class:"translation-progress-bar"},ua={class:"progress-bar-label"},ca={class:"progress-bar"},da=je({__name:"ProgressBar",props:{visible:{type:Boolean,default:!0},percentage:{},label:{default:"è¿›åº¦"}},setup(n){return(t,s)=>n.visible?(B(),F("div",ra,[e("div",ua,ne(n.label),1),e("div",ca,[e("div",{class:"progress",style:at({width:`${n.percentage}%`})},null,4)])])):de("",!0)}}),So=He(da,[["__scopeId","data-v-f915cadf"]]),ga={class:"image-upload"},pa={class:"error-text"},ma={key:2,class:"loading-overlay"},va=je({__name:"ImageUpload",emits:["uploadComplete"],setup(n,{expose:t,emit:s}){const o=s,l=et(),u=Ne(),a=Co(),c=w(null),v=w(null),p=w(!1),_=w(!1),S=w(""),D=w(0),M=w(""),E=w(!1),P=Z(()=>u.settings.pdfProcessingMethod);function q(){c.value?.click()}function V(){a.openModal()}function U(){v.value?.click()}async function f($){const r=$.target;if(!r.files||r.files.length===0)return;const I=Array.from(r.files).filter(g=>g.type.startsWith("image/"));if(I.length===0){_e("æ‰€é€‰æ–‡ä»¶å¤¹ä¸­æ²¡æœ‰æ‰¾åˆ°å›¾ç‰‡æ–‡ä»¶","warning"),r.value="";return}const T=ia(I,g=>g.webkitRelativePath);console.log(`ä»æ–‡ä»¶å¤¹å¯¼å…¥ ${T.length} å¼ å›¾ç‰‡`),await m(T),r.value=""}async function m($){if($.length!==0){p.value=!0,E.value=!0,D.value=0;try{let r=0;const h=$.length;for(let I=0;I<$.length;I++){const T=$[I];if(!T||!T.type.startsWith("image/"))continue;M.value=T.name;const g=T.webkitRelativePath||"",b=g.includes("/")?g.substring(0,g.lastIndexOf("/")):"";await new Promise((L,W)=>{const i=new FileReader;i.onload=x=>{const ie=x.target?.result;l.addImage(T.name,ie,{relativePath:g,folderPath:b}),L()},i.onerror=()=>W(new Error(`è¯»å–å›¾ç‰‡å¤±è´¥: ${T.name}`)),i.readAsDataURL(T)}),r++,D.value=Math.round((I+1)/h*100)}r>0&&(_e(`å·²æ·»åŠ  ${r} å¼ å›¾ç‰‡`,"success"),o("uploadComplete",r))}catch(r){console.error("å¤„ç†æ–‡ä»¶å¤±è´¥:",r);const h=r instanceof Error?r.message:"å¤„ç†æ–‡ä»¶å¤±è´¥";_e(h,"error")}finally{p.value=!1,E.value=!1}}}async function C($){const r=$.target;!r.files||r.files.length===0||(await se(Array.from(r.files)),r.value="")}async function k($){$.preventDefault(),_.value=!1,!(!$.dataTransfer?.files||$.dataTransfer.files.length===0)&&await se(Array.from($.dataTransfer.files))}function K($){$.preventDefault(),_.value=!0}function N($){const r=$.currentTarget.getBoundingClientRect(),h=$.clientX,I=$.clientY;(h<r.left||h>r.right||I<r.top||I>r.bottom)&&(_.value=!1)}async function se($){if($.length!==0){p.value=!0,S.value="",E.value=!0,D.value=0;try{let r=0;const h=$.length;for(let I=0;I<$.length;I++){const T=$[I];if(!T)continue;M.value=T.name;const g=T.type,b=T.name.toLowerCase();if(g.startsWith("image/"))await G(T),r++;else if(g==="application/pdf"||b.endsWith(".pdf")){const L=await J(T);r+=L}else if(b.endsWith(".mobi")||b.endsWith(".azw")||b.endsWith(".azw3")){const L=await A(T);r+=L}else console.warn(`ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹: ${T.name}`),_e(`ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹: ${T.name}`,"warning");D.value=Math.round((I+1)/h*100)}r>0&&(_e(`å·²æ·»åŠ  ${r} å¼ å›¾ç‰‡`,"success"),o("uploadComplete",r))}catch(r){console.error("å¤„ç†æ–‡ä»¶å¤±è´¥:",r);const h=r instanceof Error?r.message:"å¤„ç†æ–‡ä»¶å¤±è´¥ï¼Œè¯·é‡è¯•";S.value=h,_e(h,"error")}finally{p.value=!1,E.value=!1,M.value=""}}}async function G($){return new Promise((r,h)=>{const I=new FileReader;I.onload=T=>{const g=T.target?.result;l.addImage($.name,g),r()},I.onerror=()=>h(new Error(`è¯»å–å›¾ç‰‡æ–‡ä»¶å¤±è´¥: ${$.name}`)),I.readAsDataURL($)})}async function J($){return P.value==="frontend"?await j($):await ae($)}function ee($){return new Promise((r,h)=>{const I=new FileReader;I.onload=()=>r(I.result),I.onerror=h,I.readAsDataURL($)})}async function j($){try{const r=await rt(()=>import("./pdf.U7tdldy2.js").then(L=>L.p),[]);r.GlobalWorkerOptions.workerSrc=`https://cdnjs.cloudflare.com/ajax/libs/pdf.js/${r.version}/pdf.worker.min.js`;const h=await $.arrayBuffer(),I=await r.getDocument({data:h}).promise,T=I.numPages;console.log(`PDF ${$.name} å…± ${T} é¡µï¼Œå¼€å§‹æœ¬åœ°æ¸²æŸ“...`),_e(`æ­£åœ¨è§£æ PDFï¼Œå…± ${T} é¡µ...`,"info");const g=typeof OffscreenCanvas<"u";g&&console.log("ä½¿ç”¨ OffscreenCanvas åå°æ¸²æŸ“æ¨¡å¼");let b=0;for(let L=1;L<=T;L++){M.value=`${$.name} - ç¬¬ ${L}/${T} é¡µ`,D.value=Math.round(L/T*100);try{const W=await I.getPage(L),x=W.getViewport({scale:2});let ie;if(g){const Y=new OffscreenCanvas(x.width,x.height),ce=Y.getContext("2d");await W.render({canvasContext:ce,viewport:x}).promise;const xe=await Y.convertToBlob({type:"image/jpeg",quality:1});ie=await ee(xe)}else{const Y=document.createElement("canvas"),ce=Y.getContext("2d");Y.width=x.width,Y.height=x.height,await W.render({canvasContext:ce,viewport:x}).promise,ie=Y.toDataURL("image/jpeg",1)}const R=`${$.name}_é¡µé¢${L}`;l.addImage(R,ie),b++,console.log(`  é¡µé¢ ${L}/${T} å¤„ç†å®Œæˆ`)}catch(W){console.warn(`PDF ${$.name} ç¬¬ ${L} é¡µæ¸²æŸ“å¤±è´¥:`,W)}}return console.log(`PDF ${$.name} å…¨éƒ¨ ${T} é¡µå¤„ç†å®Œæˆ`),b}catch(r){return console.error("å‰ç«¯ PDF è§£æå¤±è´¥:",r),_e("å‰ç«¯ PDF è§£æå¤±è´¥ï¼Œå°è¯•ä½¿ç”¨åç«¯è§£æ...","warning"),await ae($)}}async function ae($){let h=null;try{_e("æ­£åœ¨ä¸Šä¼  PDF æ–‡ä»¶...","info");const I=await Ss($,5);if(!I.success||!I.session_id)throw new Error(I.error||"PDF è§£æå¯åŠ¨å¤±è´¥");h=I.session_id;const T=I.total_pages||0;console.log(`PDF ${$.name} å…± ${T} é¡µï¼Œå¼€å§‹åç«¯åˆ†æ‰¹è§£æ...`),_e(`æ­£åœ¨è§£æ PDFï¼Œå…± ${T} é¡µ...`,"info");let g=0;for(let b=0;b<T;b+=5){M.value=`${$.name} - å¤„ç†ä¸­ ${Math.min(b+5,T)}/${T} é¡µ`,D.value=T>0?Math.round(b/T*100):0;const L=await ks(h,b,5);if(!L.success){console.warn(`æ‰¹æ¬¡ ${b} è·å–å¤±è´¥:`,L.error);continue}if(L.images&&L.images.length>0)for(const W of L.images){if(!W||!W.data_url)continue;const i=`${$.name}_é¡µé¢${String(W.page_index+1).padStart(4,"0")}`;l.addImage(i,W.data_url),g++}console.log(`  å·²åŠ è½½ ${g}/${T} é¡µ`)}return console.log(`PDF ${$.name} å…¨éƒ¨ ${g} é¡µå¤„ç†å®Œæˆ`),g}catch(I){throw console.error("åç«¯ PDF è§£æå¤±è´¥:",I),I}finally{if(h)try{await ws(h)}catch(I){console.warn("PDF ä¼šè¯æ¸…ç†å¤±è´¥:",I)}}}async function A($){let r=null;try{_e("æ­£åœ¨ä¸Šä¼ ç”µå­ä¹¦æ–‡ä»¶...","info");const h=await $s($,5);if(!h.success||!h.session_id)throw new Error(h.error||"MOBI/AZW è§£æå¯åŠ¨å¤±è´¥");r=h.session_id;const I=h.total_images||0;_e(`æ­£åœ¨è§£æç”µå­ä¹¦ï¼Œå…± ${I} å¼ å›¾ç‰‡...`,"info");let T=0,g=!0;for(;g;){M.value=`${$.name} - å·²å¤„ç† ${T}/${I} å¼ `,D.value=I>0?Math.round(T/I*100):0;const b=await Ts(r);if(!b.success)throw new Error(b.error||"MOBI/AZW æ‰¹æ¬¡è§£æå¤±è´¥");if(b.images&&b.images.length>0){for(let L=0;L<b.images.length;L++){const W=b.images[L];if(!W)continue;const i=T+L+1,x=`${$.name.replace(/\.(mobi|azw|azw3)$/i,"")}_image_${String(i).padStart(3,"0")}.png`,ie=W.startsWith("data:")?W:`data:image/png;base64,${W}`;l.addImage(x,ie)}T+=b.images.length}g=b.has_more??!1}return T}catch(h){throw console.error("MOBI/AZW è§£æå¤±è´¥:",h),h}finally{if(r)try{await Is(r)}catch(h){console.warn("MOBI/AZW ä¼šè¯æ¸…ç†å¤±è´¥:",h)}}}function d(){S.value=""}return t({triggerFileSelect:q,triggerFolderSelect:U,processFiles:se,clearError:d}),($,r)=>(B(),F("div",ga,[e("div",{id:"drop-area",class:Ie(["drop-area",{"drag-over":_.value,loading:p.value}]),onDragover:K,onDragleave:N,onDrop:k},[e("div",{class:"drop-content"},[e("p",{class:"drop-text"},[r[0]||(r[0]=me(" æ‹–æ‹½å›¾ç‰‡ã€PDFæˆ–MOBIæ–‡ä»¶åˆ°è¿™é‡Œï¼Œæˆ– ",-1)),e("span",{class:"select-link",onClick:q}," é€‰æ‹©æ–‡ä»¶ "),r[1]||(r[1]=e("span",{class:"separator"}," | ",-1)),e("span",{class:"select-link folder-link",onClick:U}," ğŸ“ é€‰æ‹©æ–‡ä»¶å¤¹ "),r[2]||(r[2]=e("span",{class:"separator"}," | ",-1)),e("span",{class:"select-link web-import-link",onClick:V}," ğŸŒ ä»ç½‘é¡µå¯¼å…¥ ")])]),e("input",{ref_key:"fileInputRef",ref:c,type:"file",id:"imageUpload",accept:"image/*,application/pdf,.mobi,.azw,.azw3",multiple:"",class:"file-input",onChange:C},null,544),e("input",{ref_key:"folderInputRef",ref:v,type:"file",webkitdirectory:"",class:"file-input",onChange:f},null,544)],34),E.value?(B(),ut(So,{key:0,visible:!0,percentage:D.value,label:M.value||"å¤„ç†ä¸­..."},null,8,["percentage","label"])):de("",!0),S.value?(B(),F("div",{key:1,class:"error-message",onClick:d},[r[3]||(r[3]=e("span",{class:"error-icon"},"âš ï¸",-1)),e("span",pa,ne(S.value),1),r[4]||(r[4]=e("span",{class:"error-close"},"Ã—",-1))])):de("",!0),p.value&&!E.value?(B(),F("div",ma,[...r[5]||(r[5]=[e("div",{class:"spinner"},null,-1),e("span",{class:"loading-text"},"å¤„ç†ä¸­...",-1)])])):de("",!0)]))}}),fa=He(va,[["__scopeId","data-v-5ff3dc04"]]),ba={id:"settings-sidebar",class:"settings-sidebar"},ha={class:"card settings-card"},xa={id:"font-settings",class:"settings-card collapsible-panel"},ya={class:"toggle-icon"},_a={class:"collapsible-content"},Ca={class:"settings-form"},Sa={class:"form-group"},ka=["value","disabled","title"],wa={class:"auto-fontSize-option",title:"å‹¾é€‰åï¼Œé¦–æ¬¡ç¿»è¯‘æ—¶è‡ªåŠ¨ä¸ºæ¯ä¸ªæ°”æ³¡è®¡ç®—åˆé€‚çš„å­—å·"},$a=["checked"],Ta={class:"form-group"},Ia={class:"form-group"},Pa={class:"form-group"},Ra={class:"color-with-auto"},Da={class:"auto-color-toggle",title:"ç¿»è¯‘æ—¶è‡ªåŠ¨ä½¿ç”¨è¯†åˆ«åˆ°çš„æ–‡å­—é¢œè‰²"},Ma=["checked"],Ea=["value","disabled"],Ba={key:0,class:"auto-color-hint"},Aa={class:"form-group"},La={class:"checkbox-label"},Fa=["checked"],Ua={key:0,id:"strokeOptions",class:"stroke-options"},Oa={class:"form-group"},za=["value"],Na={class:"form-group"},Va=["value"],Wa={class:"form-group"},Ka={key:0,id:"solidColorOptions",class:"form-group"},qa=["value"],Ha={class:"apply-settings-group"},ja=["disabled"],Ja={key:0,class:"apply-options-dropdown"},Ya={class:"apply-option"},Xa=["checked"],Ga={class:"apply-option"},Za={class:"apply-option"},Qa={class:"apply-option"},el={class:"apply-option"},tl={class:"apply-option"},ol={class:"apply-option"},nl={class:"apply-option"},sl={class:"apply-option"},al={id:"page-range-settings",class:"settings-card collapsible-panel"},ll={class:"toggle-icon"},il={class:"collapsible-content"},rl={class:"settings-form page-range-form"},ul={class:"range-header-row"},cl={class:"range-toggle-compact"},dl=["disabled"],gl={class:"total-count"},pl={class:"page-range-inputs-compact"},ml=["value","max"],vl=["value","max"],fl={key:0,class:"range-error-compact"},bl={class:"action-buttons"},hl=["disabled"],xl=["disabled","title"],yl=["disabled","title"],_l=["disabled","title"],Cl=["disabled"],Sl=["disabled","title"],kl=["disabled"],wl=["disabled"],$l={class:"navigation-buttons"},Tl=["disabled"],Il=["disabled"],Pl=je({__name:"SettingsSidebar",emits:["translateCurrent","translateAll","translateRange","hqTranslate","hqTranslateRange","proofread","proofreadRange","removeText","removeAllText","removeTextRange","deleteCurrent","clearAll","cleanTemp","openPlugins","openSettings","previous","next","applyToAll","textStyleChanged","autoFontSizeChanged"],setup(n,{emit:t}){const s=t,o=et(),l=Ne(),u=w(!0),a=w(!1),c=w({fontSize:!0,fontFamily:!0,layoutDirection:!0,textColor:!0,fillColor:!0,strokeEnabled:!0,strokeColor:!0,strokeWidth:!0}),v=w(!1),p=w(!1),_=w(1),S=w(1),D=[{label:"è‡ªåŠ¨ (æ ¹æ®æ£€æµ‹)",value:"auto"},{label:"ç«–å‘æ’ç‰ˆ",value:"vertical"},{label:"æ¨ªå‘æ’ç‰ˆ",value:"horizontal"}],M=[{label:"çº¯è‰²å¡«å……",value:"solid"},{label:"LAMAä¿®å¤ (é€Ÿåº¦ä¼˜åŒ–)",value:"lama_mpe"},{label:"LAMAä¿®å¤ (é€šç”¨)",value:"litelama"}],E=Z(()=>o.currentImage),P=Z(()=>o.hasImages),q=Z(()=>o.images.length),V=Z(()=>_.value>=1&&S.value<=q.value&&_.value<=S.value),U=Z(()=>P.value&&!o.isBatchTranslationInProgress),f=Z(()=>o.canGoPrevious),m=Z(()=>o.canGoNext),C=Z(()=>l.textStyle),k=w([]),K=[yt,"fonts/msyh.ttc","fonts/simhei.ttf","fonts/simsun.ttc"],N=w(null),se=Z(()=>{const te=k.value.map(y=>({label:A(y),value:y}));return te.push({label:"è‡ªå®šä¹‰å­—ä½“...",value:"custom-font"}),te});dt(async()=>{await G();const te=C.value.fontFamily;te&&!k.value.includes(te)&&(k.value=[te,...k.value])});async function G(){try{const te=await wn();if(te.fonts&&Array.isArray(te.fonts)&&te.fonts.length>0){const y=te.fonts[0];if(typeof y=="object"&&"path"in y){const X=te.fonts.map(ve=>typeof ve=="object"?ve.path:ve);k.value=X}else k.value=te.fonts}else k.value=[...K]}catch(te){console.error("åŠ è½½å­—ä½“åˆ—è¡¨å¤±è´¥:",te),k.value=[...K]}}function J(){u.value=!u.value}function ee(te){const y=parseInt(te.target.value);isNaN(y)||(l.updateTextStyle({fontSize:y}),s("textStyleChanged","fontSize",y))}function j(te){const y=te.target.checked;l.updateTextStyle({autoFontSize:y}),console.log(`è‡ªåŠ¨å­—å·è®¾ç½®å˜æ›´: ${y}`),s("autoFontSizeChanged",y)}async function ae(te){const y=te.target,X=y.files?.[0];if(!X)return;const ve=[".ttf",".ttc",".otf"],fe=X.name.toLowerCase();if(!ve.some(oe=>fe.endsWith(oe))){_e("è¯·é€‰æ‹© .ttfã€.ttc æˆ– .otf æ ¼å¼çš„å­—ä½“æ–‡ä»¶","error"),y.value="";return}try{const oe=await Es(X);oe.success&&oe.fontPath?(await G(),l.updateTextStyle({fontFamily:oe.fontPath}),_e("å­—ä½“ä¸Šä¼ æˆåŠŸ","success")):_e(oe.error||"å­—ä½“ä¸Šä¼ å¤±è´¥","error")}catch(oe){console.error("å­—ä½“ä¸Šä¼ å¤±è´¥:",oe),_e("å­—ä½“ä¸Šä¼ å¤±è´¥","error")}finally{y.value=""}}function A(te){const y={"fonts/STXINGKA.TTF":"åæ–‡è¡Œæ¥·","fonts/STXINWEI.TTF":"åæ–‡æ–°é­","fonts/STZHONGS.TTF":"åæ–‡ä¸­å®‹","fonts/STKAITI.TTF":"æ¥·ä½“","fonts/STLITI.TTF":"éš¶ä¹¦","fonts/æ€æºé»‘ä½“SourceHanSansK-Bold.TTF":"æ€æºé»‘ä½“","fonts/STSONG.TTF":"åæ–‡å®‹ä½“","fonts/msyh.ttc":"å¾®è½¯é›…é»‘","fonts/msyhbd.ttc":"å¾®è½¯é›…é»‘ç²—ä½“","fonts/SIMYOU.TTF":"å¹¼åœ†","fonts/STFANGSO.TTF":"ä»¿å®‹","fonts/STHUPO.TTF":"åæ–‡ç¥ç€","fonts/STXIHEI.TTF":"åæ–‡ç»†é»‘","fonts/simkai.ttf":"ä¸­æ˜“æ¥·ä½“","fonts/simfang.ttf":"ä¸­æ˜“ä»¿å®‹","fonts/simhei.ttf":"ä¸­æ˜“é»‘ä½“","fonts/SIMLI.TTF":"ä¸­æ˜“éš¶ä¹¦","fonts/simsun.ttc":"å®‹ä½“"};if(y[te])return y[te];const X=te.split("/").pop()||te;for(const[ve,fe]of Object.entries(y))if((ve.split("/").pop()||"").toLowerCase()===X.toLowerCase())return fe;return X.replace(/\.(ttf|ttc|otf)$/i,"")}function d(te){const y=String(te);if(y==="custom-font"){N.value?.click();return}l.updateTextStyle({fontFamily:y}),s("textStyleChanged","fontFamily",y)}function $(te){const y=String(te);l.updateTextStyle({layoutDirection:y}),s("textStyleChanged","layoutDirection",y)}function r(te){const y=String(te);l.updateTextStyle({inpaintMethod:y})}function h(te){const y=te.target.value;l.updateTextStyle({textColor:y}),s("textStyleChanged","textColor",y)}function I(te){const y=te.target.checked;l.updateTextStyle({useAutoTextColor:y})}function T(te){const y=te.target.checked;l.updateTextStyle({strokeEnabled:y}),s("textStyleChanged","strokeEnabled",y)}function g(te){const y=te.target.value;l.updateTextStyle({strokeColor:y}),s("textStyleChanged","strokeColor",y)}function b(te){const y=parseInt(te.target.value);isNaN(y)||(l.updateTextStyle({strokeWidth:y}),s("textStyleChanged","strokeWidth",y))}function L(te){const y=te.target.value;l.updateTextStyle({fillColor:y}),s("textStyleChanged","fillColor",y)}function W(){a.value=!a.value}function i(){const y=!Object.values(c.value).every(X=>X);c.value={fontSize:y,fontFamily:y,layoutDirection:y,textColor:y,fillColor:y,strokeEnabled:y,strokeColor:y,strokeWidth:y}}function x(){s("applyToAll",{...c.value}),a.value=!1}function ie(te){te.target.closest(".apply-settings-group")||(a.value=!1)}function R(){v.value=!v.value,v.value&&q.value>0&&(_.value=1,S.value=q.value)}function Y(te){const y=parseInt(te.target.value);isNaN(y)||(_.value=Math.max(1,Math.min(y,q.value)),_.value>S.value&&(S.value=_.value))}function ce(te){const y=parseInt(te.target.value);isNaN(y)||(S.value=Math.max(1,Math.min(y,q.value)),S.value<_.value&&(_.value=S.value))}function xe(){p.value&&V.value?s("translateRange",_.value,S.value):s("translateAll")}function De(){p.value&&V.value?s("hqTranslateRange",_.value,S.value):s("hqTranslate")}function $e(){p.value&&V.value?s("proofreadRange",_.value,S.value):s("proofread")}function he(){p.value&&V.value?s("removeTextRange",_.value,S.value):s("removeAllText")}return typeof window<"u"&&window.addEventListener("click",ie),(te,y)=>(B(),F("aside",ba,[e("div",ha,[y[43]||(y[43]=e("h2",null,"ç¿»è¯‘è®¾ç½®",-1)),e("div",xa,[e("h3",{class:"collapsible-header",onClick:J},[y[17]||(y[17]=me(" æ–‡å­—è®¾ç½® ",-1)),e("span",ya,ne(u.value?"â–¼":"â–¶"),1)]),le(e("div",_a,[e("div",Ca,[e("div",Sa,[y[19]||(y[19]=e("label",{for:"fontSize"},"å­—å·å¤§å°:",-1)),e("input",{type:"number",id:"fontSize",value:C.value.fontSize,min:"10",disabled:C.value.autoFontSize,class:Ie({"disabled-input":C.value.autoFontSize}),title:C.value.autoFontSize?"å·²å¯ç”¨è‡ªåŠ¨å­—å·ï¼Œé¦–æ¬¡ç¿»è¯‘æ—¶å°†è‡ªåŠ¨è®¡ç®—":"",onInput:ee},null,42,ka),e("span",wa,[e("input",{type:"checkbox",id:"autoFontSize",checked:C.value.autoFontSize,onChange:j},null,40,$a),y[18]||(y[18]=e("label",{for:"autoFontSize"},"è‡ªåŠ¨è®¡ç®—åˆå§‹å­—å·",-1))])]),e("div",Ta,[y[20]||(y[20]=e("label",{for:"fontFamily"},"æ–‡æœ¬å­—ä½“:",-1)),Ce(Ve,{"model-value":C.value.fontFamily,options:se.value,onChange:d},null,8,["model-value","options"]),e("input",{ref_key:"fontUploadInput",ref:N,type:"file",id:"fontUpload",accept:".ttf,.ttc,.otf",style:{display:"none"},onChange:ae},null,544)]),e("div",Ia,[y[21]||(y[21]=e("label",{for:"layoutDirection"},"æ’ç‰ˆè®¾ç½®:",-1)),Ce(Ve,{"model-value":C.value.layoutDirection,options:D,onChange:$},null,8,["model-value"])]),e("div",Pa,[y[23]||(y[23]=e("label",{for:"textColor"},"æ–‡å­—é¢œè‰²:",-1)),e("div",Ra,[e("label",Da,[e("input",{type:"checkbox",checked:C.value.useAutoTextColor,onChange:I},null,40,Ma),y[22]||(y[22]=e("span",null,"è‡ªåŠ¨",-1))]),e("input",{type:"color",id:"textColor",value:C.value.textColor,disabled:C.value.useAutoTextColor,onInput:h},null,40,Ea)]),C.value.useAutoTextColor?(B(),F("div",Ba," ğŸ’¡ ç¿»è¯‘æ—¶å°†è‡ªåŠ¨ä½¿ç”¨è¯†åˆ«åˆ°çš„æ–‡å­—é¢œè‰² ")):de("",!0)]),e("div",Aa,[e("span",La,[e("input",{type:"checkbox",id:"strokeEnabled",checked:C.value.strokeEnabled,onChange:T},null,40,Fa),y[24]||(y[24]=e("label",{for:"strokeEnabled"},"å¯ç”¨æ–‡æœ¬æè¾¹:",-1))])]),Ce(an,{name:"stroke-slide"},{default:St(()=>[C.value.strokeEnabled?(B(),F("div",Ua,[e("div",Oa,[y[25]||(y[25]=e("label",{for:"strokeColor"},"æè¾¹é¢œè‰²:",-1)),e("input",{type:"color",id:"strokeColor",value:C.value.strokeColor,onInput:g},null,40,za)]),e("div",Na,[y[26]||(y[26]=e("label",{for:"strokeWidth"},"æè¾¹å®½åº¦ (px):",-1)),e("input",{type:"number",id:"strokeWidth",value:C.value.strokeWidth,min:"0",max:"10",style:{width:"60px",padding:"5px"},onInput:b},null,40,Va),y[27]||(y[27]=e("div",{class:"input-hint"},"0 è¡¨ç¤ºæ— æè¾¹ã€‚",-1))])])):de("",!0)]),_:1}),e("div",Wa,[y[28]||(y[28]=e("label",{for:"useInpainting"},"æ°”æ³¡å¡«å……æ–¹å¼:",-1)),Ce(Ve,{"model-value":C.value.inpaintMethod,options:M,onChange:r},null,8,["model-value"])]),Ce(an,{name:"slide-fade"},{default:St(()=>[C.value.inpaintMethod==="solid"?(B(),F("div",Ka,[y[29]||(y[29]=e("label",{for:"fillColor"},"å¡«å……é¢œè‰²:",-1)),e("input",{type:"color",id:"fillColor",value:C.value.fillColor,onInput:L},null,40,qa)])):de("",!0)]),_:1})]),e("div",Ha,[e("button",{type:"button",class:"settings-button",disabled:!P.value,onClick:x}," åº”ç”¨åˆ°å…¨éƒ¨ ",8,ja),e("button",{type:"button",class:"settings-gear-btn",title:"é€‰æ‹©è¦åº”ç”¨çš„å‚æ•°",onClick:W}," âš™ï¸ "),a.value?(B(),F("div",Ja,[e("div",Ya,[e("input",{type:"checkbox",id:"apply_selectAll",checked:Object.values(c.value).every(X=>X),onChange:i},null,40,Xa),y[30]||(y[30]=e("label",{for:"apply_selectAll"},"å…¨é€‰",-1))]),y[39]||(y[39]=e("hr",null,null,-1)),e("div",Ga,[le(e("input",{type:"checkbox",id:"apply_fontSize","onUpdate:modelValue":y[0]||(y[0]=X=>c.value.fontSize=X)},null,512),[[nt,c.value.fontSize]]),y[31]||(y[31]=e("label",{for:"apply_fontSize"},"å­—å·",-1))]),e("div",Za,[le(e("input",{type:"checkbox",id:"apply_fontFamily","onUpdate:modelValue":y[1]||(y[1]=X=>c.value.fontFamily=X)},null,512),[[nt,c.value.fontFamily]]),y[32]||(y[32]=e("label",{for:"apply_fontFamily"},"å­—ä½“",-1))]),e("div",Qa,[le(e("input",{type:"checkbox",id:"apply_layoutDirection","onUpdate:modelValue":y[2]||(y[2]=X=>c.value.layoutDirection=X)},null,512),[[nt,c.value.layoutDirection]]),y[33]||(y[33]=e("label",{for:"apply_layoutDirection"},"æ’ç‰ˆæ–¹å‘",-1))]),e("div",el,[le(e("input",{type:"checkbox",id:"apply_textColor","onUpdate:modelValue":y[3]||(y[3]=X=>c.value.textColor=X)},null,512),[[nt,c.value.textColor]]),y[34]||(y[34]=e("label",{for:"apply_textColor"},"æ–‡å­—é¢œè‰²",-1))]),e("div",tl,[le(e("input",{type:"checkbox",id:"apply_fillColor","onUpdate:modelValue":y[4]||(y[4]=X=>c.value.fillColor=X)},null,512),[[nt,c.value.fillColor]]),y[35]||(y[35]=e("label",{for:"apply_fillColor"},"å¡«å……é¢œè‰²",-1))]),e("div",ol,[le(e("input",{type:"checkbox",id:"apply_strokeEnabled","onUpdate:modelValue":y[5]||(y[5]=X=>c.value.strokeEnabled=X)},null,512),[[nt,c.value.strokeEnabled]]),y[36]||(y[36]=e("label",{for:"apply_strokeEnabled"},"æè¾¹å¼€å…³",-1))]),e("div",nl,[le(e("input",{type:"checkbox",id:"apply_strokeColor","onUpdate:modelValue":y[6]||(y[6]=X=>c.value.strokeColor=X)},null,512),[[nt,c.value.strokeColor]]),y[37]||(y[37]=e("label",{for:"apply_strokeColor"},"æè¾¹é¢œè‰²",-1))]),e("div",sl,[le(e("input",{type:"checkbox",id:"apply_strokeWidth","onUpdate:modelValue":y[7]||(y[7]=X=>c.value.strokeWidth=X)},null,512),[[nt,c.value.strokeWidth]]),y[38]||(y[38]=e("label",{for:"apply_strokeWidth"},"æè¾¹å®½åº¦",-1))])])):de("",!0)])],512),[[Ue,u.value]])]),e("div",al,[e("h3",{class:"collapsible-header",onClick:R},[y[40]||(y[40]=me(" æŒ‡å®šèŒƒå›´ ",-1)),e("span",ll,ne(v.value?"â–¼":"â–¶"),1)]),le(e("div",il,[e("div",rl,[e("div",ul,[e("label",cl,[le(e("input",{type:"checkbox","onUpdate:modelValue":y[8]||(y[8]=X=>p.value=X),disabled:q.value===0},null,8,dl),[[nt,p.value]]),y[41]||(y[41]=e("span",null,"å¯ç”¨",-1))]),e("span",gl,"å…± "+ne(q.value)+" å¼ ",1)]),le(e("div",pl,[e("input",{type:"number",id:"pageRangeStart",value:_.value,min:"1",max:q.value,onInput:Y,placeholder:"èµ·å§‹"},null,40,ml),y[42]||(y[42]=e("span",{class:"range-sep"},"~",-1)),e("input",{type:"number",id:"pageRangeEnd",value:S.value,min:"1",max:q.value,onInput:ce,placeholder:"ç»“æŸ"},null,40,vl)],512),[[Ue,p.value]]),p.value&&!V.value&&q.value>0?(B(),F("div",fl," èŒƒå›´æ— æ•ˆ ")):de("",!0)])],512),[[Ue,v.value]])]),e("div",bl,[e("button",{id:"translateButton",disabled:!U.value,onClick:y[9]||(y[9]=X=>s("translateCurrent"))}," ç¿»è¯‘å½“å‰å›¾ç‰‡ ",8,hl),e("button",{id:"translateAllButton",disabled:!U.value||p.value&&!V.value,title:p.value?`ç¿»è¯‘ç¬¬ ${_.value}-${S.value} é¡µ`:"ç¿»è¯‘æ‰€æœ‰å›¾ç‰‡",onClick:xe},ne(p.value?`ç¿»è¯‘ ${_.value}-${S.value} é¡µ`:"ç¿»è¯‘æ‰€æœ‰å›¾ç‰‡"),9,xl),e("button",{id:"startHqTranslationBtn",class:"settings-button purple-button",disabled:!U.value||p.value&&!V.value,title:p.value?`é«˜è´¨é‡ç¿»è¯‘ç¬¬ ${_.value}-${S.value} é¡µ`:"ä½¿ç”¨é«˜è´¨é‡ç¿»è¯‘æ¨¡å¼ï¼ˆéœ€åœ¨è®¾ç½®ä¸­é…ç½®ï¼‰",onClick:De},ne(p.value?`é«˜è´¨é‡ç¿»è¯‘ ${_.value}-${S.value}`:"é«˜è´¨é‡ç¿»è¯‘"),9,yl),e("button",{id:"proofreadButton",disabled:!U.value||p.value&&!V.value,title:p.value?`AIæ ¡å¯¹ç¬¬ ${_.value}-${S.value} é¡µ`:"AIæ ¡å¯¹",onClick:$e},ne(p.value?`AIæ ¡å¯¹ ${_.value}-${S.value}`:"AIæ ¡å¯¹"),9,_l),e("button",{id:"removeTextOnlyButton",disabled:!E.value,title:"æ¶ˆé™¤å›¾ç‰‡ä¸­çš„æ°”æ³¡æ–‡å­—ï¼Œæ— éœ€å¡«å†™ç¿»è¯‘æœåŠ¡å•†å’ŒAPI Key",onClick:y[10]||(y[10]=X=>s("removeText"))}," ä»…æ¶ˆé™¤æ–‡å­— ",8,Cl),e("button",{id:"removeAllTextButton",disabled:!P.value||p.value&&!V.value,title:p.value?`æ¶ˆé™¤ç¬¬ ${_.value}-${S.value} é¡µçš„æ–‡å­—`:"æ¶ˆé™¤æ‰€æœ‰å›¾ç‰‡ä¸­çš„æ°”æ³¡æ–‡å­—",onClick:he},ne(p.value?`æ¶ˆé™¤ ${_.value}-${S.value} é¡µæ–‡å­—`:"æ¶ˆé™¤æ‰€æœ‰å›¾ç‰‡æ–‡å­—"),9,Sl),e("button",{id:"deleteCurrentImageButton",class:"settings-button red-button",disabled:!E.value,onClick:y[11]||(y[11]=X=>s("deleteCurrent"))}," åˆ é™¤å½“å‰å›¾ç‰‡ ",8,kl),e("button",{id:"clearAllImagesButton",class:"settings-button red-button",disabled:!P.value,onClick:y[12]||(y[12]=X=>s("clearAll"))}," æ¸…é™¤æ‰€æœ‰å›¾ç‰‡ ",8,wl),e("button",{id:"cleanDebugFilesButton",class:"settings-button orange-button",onClick:y[13]||(y[13]=X=>s("cleanTemp"))}," æ¸…ç†ä¸´æ—¶æ–‡ä»¶ "),e("button",{id:"managePluginsButton",class:"settings-button blue-button",onClick:y[14]||(y[14]=X=>s("openPlugins"))}," æ’ä»¶ç®¡ç† ")]),e("div",$l,[e("button",{id:"prevImageButton",disabled:!f.value,onClick:y[15]||(y[15]=X=>s("previous"))}," ä¸Šä¸€å¼  ",8,Tl),e("button",{id:"nextImageButton",disabled:!m.value,onClick:y[16]||(y[16]=X=>s("next"))}," ä¸‹ä¸€å¼  ",8,Il)])])]))}}),Rl=He(Pl,[["__scopeId","data-v-fb2b28e9"]]);function Ft(n){if(n.textDirection==="vertical"||n.textDirection==="horizontal")return n.textDirection;if(n.autoTextDirection==="vertical"||n.autoTextDirection==="horizontal")return n.autoTextDirection;if(n.coords){const[t,s,o,l]=n.coords;return l-s>o-t?"vertical":"horizontal"}return"vertical"}function Dl(){const n=et(),t=Ne(),s=ct(),o=w(!1),l=w(0),u=w(""),a=w(!1),c=w(0),v=w(""),p=Z(()=>n.hasImages),_=Z(()=>n.hasImages),S=Z(()=>n.hasImages);function D(){const f=n.images;if(f.length===0){s.warning("æ²¡æœ‰å¯å¯¼å‡ºçš„å›¾ç‰‡æ–‡æœ¬");return}const m=[];for(let J=0;J<f.length;J++){const ee=f[J];if(!ee)continue;const j=ee.bubbleStates||[],ae={imageIndex:J,bubbles:[]};for(let A=0;A<j.length;A++){const d=j[A];if(!d)continue;const $=d.originalText||"",r=d.translatedText||d.textboxText||"";let h="vertical";d.textDirection&&d.textDirection!=="auto"?h=d.textDirection:d.autoTextDirection&&(h=d.autoTextDirection),ae.bubbles.push({bubbleIndex:A,original:$,translated:r,textDirection:h})}m.push(ae)}const C=JSON.stringify(m,null,2),k=new Blob([C],{type:"application/json"}),K=URL.createObjectURL(k),N=document.createElement("a");N.href=K;const G=new Date().toISOString().replace(/[-:T]/g,"").slice(0,15);N.download=`translations_${G}.json`,document.body.appendChild(N),N.click(),document.body.removeChild(N),URL.revokeObjectURL(K),s.success("æ–‡æœ¬å¯¼å‡ºæˆåŠŸï¼")}function M(){const f=n.images;if(f.length===0)return null;const m=[];for(let C=0;C<f.length;C++){const k=f[C];if(!k)continue;const K=k.bubbleStates||[],N={imageIndex:C,bubbles:[]};for(let se=0;se<K.length;se++){const G=K[se];if(!G)continue;const J=G.originalText||"",ee=G.translatedText||G.textboxText||"";let j="vertical";G.textDirection&&G.textDirection!=="auto"?j=G.textDirection:G.autoTextDirection&&(j=G.autoTextDirection),N.bubbles.push({bubbleIndex:se,original:J,translated:ee,textDirection:j})}m.push(N)}return m}async function E(f){if(!f){s.warning("æœªé€‰æ‹©æ–‡ä»¶");return}a.value=!0,c.value=0,v.value="å‡†å¤‡å¯¼å…¥æ–‡æœ¬...",s.info("æ­£åœ¨å¯¼å…¥æ–‡æœ¬...",0);try{const m=await P(f);c.value=10,v.value="è§£æ JSON æ•°æ®...";const C=JSON.parse(m);if(!Array.isArray(C))throw new Error("å¯¼å…¥çš„ JSON æ ¼å¼ä¸æ­£ç¡®ï¼Œåº”ä¸ºæ•°ç»„");let k=0,K=0;const N=t.settings.textStyle,se=N.autoFontSize?"auto":N.fontSize,G=N.fontFamily,J=N.textColor,ee=N.fillColor;c.value=20,v.value="å¼€å§‹æ›´æ–°å›¾ç‰‡...";const j=C.length;let ae=0;const A=[];for(const r of C){ae++;const h=20+ae/j*60;c.value=h,v.value=`å¤„ç†å›¾ç‰‡ ${ae}/${j}`;const I=r.imageIndex;if(I<0||I>=n.images.length){console.warn(`è·³è¿‡æ— æ•ˆçš„å›¾ç‰‡ç´¢å¼•: ${I}`);continue}const T=n.images[I];if(!T)continue;let g=!1;T.bubbleStates||(T.bubbleStates=[]),T.bubbleTexts||(T.bubbleTexts=[]),T.originalTexts||(T.originalTexts=[]);for(const b of r.bubbles){const L=b.bubbleIndex,W=b.original,i=b.translated,x=b.textDirection,ie=x==="vertical"||x==="horizontal"?x:"vertical";for(;T.bubbleTexts.length<=L;)T.bubbleTexts.push("");for(;T.originalTexts.length<=L;)T.originalTexts.push("");for(W&&(T.originalTexts[L]=W),i&&(T.bubbleTexts[L]=i);T.bubbleStates.length<=L;)T.bubbleStates.push(q(se,G,J,ee));const R=T.bubbleStates[L];R&&(W&&(R.originalText=W),i&&(R.translatedText=i,R.textboxText=i),R.textDirection=ie,g=!0,K++)}g&&T.bubbleStates&&(T.bubbleTexts=T.bubbleStates.map(b=>b.translatedText||"")),g&&(k++,T.hasUnsavedChanges=!0,T.translatedDataURL&&T.bubbleStates&&T.bubbleStates.length>0&&A.push(I))}if(A.length>0){c.value=80,v.value="å¼€å§‹æ¸²æŸ“å›¾ç‰‡...",s.info("æ­£åœ¨æ¸²æŸ“å›¾ç‰‡ï¼Œè¯·ç¨å€™...",0);const r=t.settings.textStyle,h=r.layoutDirection,I=h==="auto";for(let T=0;T<A.length;T++){const g=A[T];if(g===void 0)continue;const b=n.images[g];if(!(!b||!b.bubbleStates)){c.value=80+T/A.length*20,v.value=`æ¸²æŸ“å›¾ç‰‡ ${T+1}/${A.length}`;try{let L="";if(b.cleanImageData?L=b.cleanImageData.includes("base64,")?b.cleanImageData.split("base64,")[1]||"":b.cleanImageData:b.originalDataURL&&(L=b.originalDataURL.includes("base64,")?b.originalDataURL.split("base64,")[1]||"":b.originalDataURL,console.log(`importText: å›¾ç‰‡ ${g} ä½¿ç”¨åŸå›¾ä½œä¸ºèƒŒæ™¯ï¼ˆå…œåº•ï¼‰`)),!L){console.log(`importText: å›¾ç‰‡ ${g} æ²¡æœ‰å¯ç”¨çš„èƒŒæ™¯å›¾ï¼Œè·³è¿‡`);continue}const W=b.bubbleStates.map(x=>({translatedText:x.translatedText||"",coords:x.coords,fontSize:x.fontSize||r.fontSize,fontFamily:x.fontFamily||r.fontFamily,textDirection:Ft(x),textColor:x.textColor||r.textColor,rotationAngle:x.rotationAngle||0,position:x.position||{x:0,y:0},strokeEnabled:x.strokeEnabled??r.strokeEnabled,strokeColor:x.strokeColor||r.strokeColor,strokeWidth:x.strokeWidth??r.strokeWidth})),i=await yo({clean_image:L,bubble_texts:W.map(x=>x.translatedText),bubble_coords:W.map(x=>x.coords),fontSize:r.fontSize,fontFamily:r.fontFamily,textDirection:I?"vertical":h,textColor:r.textColor,bubble_states:W,use_individual_styles:!0,use_inpainting:!1,use_lama:!1,is_font_style_change:!0,strokeEnabled:r.strokeEnabled,strokeColor:r.strokeColor,strokeWidth:r.strokeWidth});i.rendered_image&&(n.updateImageByIndex(g,{translatedDataURL:`data:image/png;base64,${i.rendered_image}`,hasUnsavedChanges:!0}),console.log(`importText: å›¾ç‰‡ ${g} æ¸²æŸ“æˆåŠŸ`))}catch(L){console.error(`importText: é‡æ¸²æŸ“å›¾ç‰‡ ${g} å¤±è´¥:`,L)}}}}c.value=100,v.value="å¯¼å…¥å®Œæˆ";const d=A.length,$=d>0?`å¯¼å…¥æˆåŠŸï¼æ›´æ–°äº† ${k} å¼ å›¾ç‰‡ä¸­çš„ ${K} ä¸ªæ°”æ³¡æ–‡æœ¬ï¼Œé‡æ¸²æŸ“äº† ${d} å¼ å›¾ç‰‡`:`å¯¼å…¥æˆåŠŸï¼æ›´æ–°äº† ${k} å¼ å›¾ç‰‡ä¸­çš„ ${K} ä¸ªæ°”æ³¡æ–‡æœ¬`;s.success($)}catch(m){console.error("å¯¼å…¥æ–‡æœ¬å‡ºé”™:",m),s.error(`å¯¼å…¥å¤±è´¥: ${m instanceof Error?m.message:String(m)}`)}finally{a.value=!1,setTimeout(()=>{c.value=0,v.value=""},2e3)}}function P(f){return new Promise((m,C)=>{const k=new FileReader;k.onload=K=>{K.target?.result?m(K.target.result):C(new Error("è¯»å–æ–‡ä»¶å¤±è´¥"))},k.onerror=()=>C(new Error("è¯»å–æ–‡ä»¶æ—¶å‡ºé”™")),k.readAsText(f)})}function q(f,m,C,k){const K=t.settings.textStyle;return{coords:[0,0,100,100],polygon:[],originalText:"",translatedText:"",textboxText:"",fontSize:typeof f=="number"?f:25,fontFamily:m,textDirection:"vertical",autoTextDirection:"vertical",textColor:C,fillColor:k,rotationAngle:0,position:{x:0,y:0},strokeEnabled:K.strokeEnabled,strokeColor:K.strokeColor,strokeWidth:K.strokeWidth,inpaintMethod:K.inpaintMethod}}function V(){const f=n.currentImage;if(!f){s.warning("æ²¡æœ‰å¯ä¸‹è½½çš„å›¾ç‰‡");return}const m=f.translatedDataURL||f.originalDataURL;if(!m){s.warning("æ²¡æœ‰å¯ä¸‹è½½çš„å›¾ç‰‡");return}o.value=!0;try{const C=m.split(",")[1];if(!C)throw new Error("æ— æ•ˆçš„å›¾ç‰‡æ•°æ®");const k=atob(C),K=[];for(let j=0;j<k.length;j+=512){const ae=k.slice(j,j+512),A=new Array(ae.length);for(let $=0;$<ae.length;$++)A[$]=ae.charCodeAt($);const d=new Uint8Array(A);K.push(d.buffer)}const N=new Blob(K,{type:"image/png"}),se=URL.createObjectURL(N),G=document.createElement("a");G.href=se;let J=f.fileName||`image_${n.currentImageIndex}.png`;J=`${f.translatedDataURL?"translated":"original"}_${J.replace(/\.[^/.]+$/,"")}.png`,G.download=J,document.body.appendChild(G),G.click(),document.body.removeChild(G),URL.revokeObjectURL(se),s.success(`ä¸‹è½½æˆåŠŸ: ${J}`)}catch(C){console.error("ä¸‹è½½å›¾ç‰‡æ—¶å‡ºé”™:",C),s.error("ä¸‹è½½å¤±è´¥")}finally{o.value=!1}}async function U(f="zip"){const m=n.images;if(m.length===0){s.warning("æ²¡æœ‰å¯ä¸‹è½½çš„å›¾ç‰‡");return}o.value=!0,l.value=0,u.value="å‡†å¤‡ä¸‹è½½...",s.info("ä¸‹è½½ä¸­...å¤„ç†å¯èƒ½éœ€è¦ä¸€å®šæ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…...",0);try{const C=[];let k=0,K=0;l.value=5,u.value="æ£€æŸ¥å›¾ç‰‡æ•°æ®...";for(let $=0;$<m.length;$++){const r=m[$];r&&(r.translatedDataURL?(C.push({index:$,type:"translated"}),k++):r.originalDataURL&&(C.push({index:$,type:"original"}),K++))}if(C.length===0){s.warning("æ²¡æœ‰å¯ä¸‹è½½çš„å›¾ç‰‡");return}l.value=10,u.value="åˆ›å»ºä¸‹è½½ä¼šè¯...";const N=await Ps(C.length);if(!N.success||!N.session_id)throw new Error(N.error||"åˆ›å»ºä¼šè¯å¤±è´¥");const se=N.session_id,G=C.length;let J=0,ee=0;for(let $=0;$<C.length;$++){const r=C[$];if(!r)continue;const h=m[r.index];if(!h)continue;const I=r.type==="translated"?h.translatedDataURL:h.originalDataURL;if(!I)continue;const T=10+$/G*70;l.value=T,u.value=`ä¸Šä¼ å›¾ç‰‡ ${$+1}/${G}...`;try{const g=await Rs(se,I,$);g.success?J++:(console.error(`ä¸Šä¼ å›¾ç‰‡ ${$} å¤±è´¥:`,g.error),ee++)}catch(g){console.error(`ä¸Šä¼ å›¾ç‰‡ ${$} å‡ºé”™:`,g),ee++}}if(J===0)throw new Error("æ‰€æœ‰å›¾ç‰‡ä¸Šä¼ å¤±è´¥");l.value=85,u.value="æ‰“åŒ…æ–‡ä»¶...";const j=await Ds(se,f);if(!j.success||!j.file_id)throw new Error(j.error||"æ‰“åŒ…å¤±è´¥");l.value=95,u.value="å‡†å¤‡ä¸‹è½½...";const ae=Ms(j.file_id,f),A=document.createElement("a");A.href=ae,document.body.appendChild(A),A.click(),document.body.removeChild(A),l.value=100,u.value="ä¸‹è½½å·²å¼€å§‹";let d=`å·²æˆåŠŸå¤„ç† ${J} å¼ å›¾ç‰‡`;ee>0&&(d+=`ï¼ˆ${ee} å¼ å¤±è´¥ï¼‰`),k>0&&K>0?d+=`ï¼ˆ${k} å¼ ç¿»è¯‘å›¾ç‰‡å’Œ ${K} å¼ åŸå§‹å›¾ç‰‡ï¼‰`:k>0?d+="ï¼ˆå…¨éƒ¨ä¸ºç¿»è¯‘åå›¾ç‰‡ï¼‰":K>0&&(d+="ï¼ˆå…¨éƒ¨ä¸ºåŸå§‹å›¾ç‰‡ï¼‰"),d+="ï¼Œä¸‹è½½å³å°†å¼€å§‹",s.success(d),setTimeout(async()=>{try{const $=await xo();console.log("ä¸´æ—¶æ–‡ä»¶æ¸…ç†ç»“æœ:",$)}catch($){console.error("æ¸…ç†ä¸´æ—¶æ–‡ä»¶å¤±è´¥:",$)}},6e4)}catch(C){console.error("ä¸‹è½½æ‰€æœ‰å›¾ç‰‡æ—¶å‡ºé”™:",C),s.error(`ä¸‹è½½å¤±è´¥: ${C instanceof Error?C.message:String(C)}`)}finally{o.value=!1,setTimeout(()=>{l.value=0,u.value=""},2e3)}}return{isDownloading:o,downloadProgress:l,downloadProgressText:u,isImporting:a,importProgress:c,importProgressText:v,canExportText:p,canImportText:_,canDownload:S,exportText:D,exportTextToJson:M,importText:E,downloadCurrentImage:V,downloadAllImages:U}}const Ml={key:0,class:"result-section card result-card"},El={class:"image-controls"},Bl={class:"image-size-control"},Al=["value"],Ll={id:"imageSizeValue"},Fl={class:"content-container"},Ul={class:"image-container"},Ol=["src"],zl={id:"detectedTextInfo",class:"text-info"},Nl={id:"detectedTextList"},Vl={class:"original-text"},Wl={class:"download-section"},Kl={class:"download-buttons"},ql=["disabled"],Hl={class:"download-all-container"},jl=["disabled"],Jl={class:"download-format-selector"},Yl=["disabled"],Xl=["disabled"],Gl={key:1,class:"empty-state-section"},co=60,Zl=je({__name:"ImageResultDisplay",props:{isEditMode:{type:Boolean,default:!1}},emits:["toggle-edit-mode","retry-failed"],setup(n,{emit:t}){const s=[{label:"ZIPå‹ç¼©åŒ…",value:"zip"},{label:"PDFæ–‡æ¡£",value:"pdf"},{label:"CBZæ¼«ç”»",value:"cbz"}],o=t,l=et(),u=Ne(),a=Dl(),c=w(100),v=Z({get:()=>P.value?.showOriginal??!1,set:T=>{P.value&&l.updateCurrentImage({showOriginal:T})}}),p=w("zip"),_=w(null),S=Z(()=>a.isDownloading.value),D=Z(()=>a.downloadProgressText.value),M=Z(()=>a.downloadProgress.value),E=Z(()=>l.hasImages),P=Z(()=>l.currentImage),q=Z(()=>!!P.value?.translatedDataURL),V=Z(()=>!!(P.value?.translatedDataURL||P.value?.originalDataURL)),U=Z(()=>P.value?v.value||!P.value.translatedDataURL?P.value.originalDataURL:P.value.translatedDataURL:""),f=Z(()=>l.failedImageCount>0),m=Z(()=>({width:`${c.value}%`})),C=Z(()=>u.settings.useTextboxPrompt),k=Z(()=>{if(!P.value)return[];if(P.value.bubbleStates&&P.value.bubbleStates.length>0)return P.value.bubbleStates.map(b=>({original:b.originalText||"",translated:C.value?b.textboxText||b.translatedText||"":b.translatedText||""}));const T=P.value.originalTexts||[],g=C.value?P.value.textboxTexts||P.value.bubbleTexts||[]:P.value.bubbleTexts||[];return T.length===0?[]:T.map((b,L)=>({original:b||"",translated:g[L]||""}))}),K=Z(()=>k.value.length>0);function N(T){if(!T||T.length<=co)return T;let g="",b="";for(let L=0;L<T.length;L++)if(b+=T[L],b.length>=co){let W=-1;for(let i=b.length-1;i>=0;i--){const x=b[i];if(x&&["ã€‚","ï¼","ï¼Ÿ",".","!","?","ï¼›",";","ï¼Œ",","].includes(x)){W=i+1;break}}W>co*.6?(g+=b.substring(0,W)+`
`,b=b.substring(W)):(g+=b+`
`,b="")}return b&&(g+=b),g}function se(T){return N((T||"").trim())}function G(T){const g=(T||"").trim();return N(g)}function J(T){return(T||"").includes("ç¿»è¯‘å¤±è´¥")}function ee(){v.value=!v.value}function j(){o("toggle-edit-mode")}function ae(T){const g=T.target;c.value=parseInt(g.value,10)}function A(){o("retry-failed")}function d(){a.downloadCurrentImage()}function $(){a.downloadAllImages(p.value)}function r(){a.exportText()}function h(){_.value?.click()}async function I(T){const g=T.target,b=g.files?.[0];b&&(await a.importText(b),g.value="")}return(T,g)=>P.value?(B(),F("section",Ml,[e("div",El,[q.value?(B(),F("button",{key:0,id:"toggleImageButton",class:"control-btn",onClick:ee},ne(v.value?"æŸ¥çœ‹ç¿»è¯‘å›¾":"æŸ¥çœ‹åŸå›¾"),1)):de("",!0),e("button",{id:"toggleEditModeButton",class:Ie(["control-btn",{active:n.isEditMode}]),onClick:j},ne(n.isEditMode?"é€€å‡ºç¼–è¾‘":"åˆ‡æ¢ç¼–è¾‘æ¨¡å¼"),3),e("div",Bl,[g[1]||(g[1]=e("label",{for:"imageSize"},"å›¾ç‰‡å¤§å°:",-1)),e("input",{type:"range",id:"imageSize",min:"50",max:"200",value:c.value,class:"slider range-slider",onInput:ae},null,40,Al),e("span",Ll,ne(c.value)+"%",1)]),f.value?(B(),F("button",{key:1,id:"retranslateFailedButton",class:"retry-failed-btn",onClick:A,title:"é‡æ–°ç¿»è¯‘æ‰€æœ‰å¤±è´¥çš„å›¾ç‰‡"}," é‡æ–°ç¿»è¯‘å¤±è´¥å›¾ç‰‡ ("+ne(H(l).failedImageCount)+") ",1)):de("",!0)]),e("div",Fl,[e("div",Ul,[e("img",{id:"translatedImageDisplay",src:U.value,alt:"ç¿»è¯‘åå›¾ç‰‡",style:at(m.value)},null,12,Ol)])]),e("div",zl,[g[6]||(g[6]=e("h3",null,"æ£€æµ‹åˆ°çš„æ–‡æœ¬ï¼ˆåŸæ–‡ â†’ è¯‘æ–‡ï¼‰",-1)),e("pre",Nl,[K.value?(B(!0),F(ze,{key:0},Ye(k.value,(b,L)=>(B(),F("span",{key:L,class:"text-item"},[e("span",Vl,ne(se(b.original)),1),g[2]||(g[2]=me(`
`,-1)),e("span",{class:Ie(["translated-text",{"translation-error":J(b.translated)}])},ne(G(b.translated)),3),g[3]||(g[3]=me(`
`,-1)),g[4]||(g[4]=e("span",{class:"separator"},"â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€",-1)),g[5]||(g[5]=me(`

`,-1))]))),128)):(B(),F(ze,{key:1},[me("æœªæ£€æµ‹åˆ°æ–‡æœ¬æˆ–å°šæœªç¿»è¯‘")],64))])]),e("div",Wl,[S.value?(B(),ut(So,{key:0,visible:!0,percentage:M.value,label:D.value||"ä¸‹è½½ä¸­ï¼Œè¯·ç¨å€™..."},null,8,["percentage","label"])):de("",!0),e("div",Kl,[e("button",{id:"downloadButton",class:"download-btn primary",disabled:!V.value,onClick:d}," ä¸‹è½½å½“å‰å›¾ç‰‡ ",8,ql),e("div",Hl,[e("button",{id:"downloadAllImagesButton",class:"download-btn primary",disabled:!E.value,onClick:$}," ä¸‹è½½æ‰€æœ‰å›¾ç‰‡ ",8,jl),e("div",Jl,[Ce(Ve,{modelValue:p.value,"onUpdate:modelValue":g[0]||(g[0]=b=>p.value=b),options:s},null,8,["modelValue"])])]),e("button",{id:"exportTextButton",class:"download-btn success",disabled:!E.value,onClick:r}," å¯¼å‡ºæ–‡æœ¬ ",8,Yl),e("button",{id:"importTextButton",class:"download-btn success",disabled:!E.value,onClick:h}," å¯¼å…¥æ–‡æœ¬ ",8,Xl),e("input",{type:"file",ref_key:"importFileInput",ref:_,id:"importTextFileInput",style:{display:"none"},accept:".json",onChange:I},null,544)])])])):(B(),F("section",Gl))}}),Ql=He(Zl,[["__scopeId","data-v-a26b9c58"]]),ei={class:"guide-content"},ti={class:"guide-footer"},oi={class:"dont-show-option"},Wt="saber_translator_dismiss_setup_reminder",ni=je({__name:"FirstTimeGuide",emits:["openSettings"],setup(n,{expose:t,emit:s}){const o=s,l=w(!1),u=w(!1);dt(()=>{localStorage.getItem(Wt)!=="true"&&(l.value=!0)});function a(){u.value&&localStorage.setItem(Wt,"true"),l.value=!1}function c(){localStorage.setItem(Wt,"true"),l.value=!1,o("openSettings")}function v(){localStorage.removeItem(Wt)}return t({resetGuideState:v,showGuide:l}),(p,_)=>(B(),ut($n,{"model-value":l.value,title:"æ¬¢è¿ä½¿ç”¨ Saber-Translator",onClose:a},{default:St(()=>[e("div",ei,[_[3]||(_[3]=e("div",{class:"guide-icon"},"ğŸ‰",-1)),_[4]||(_[4]=e("div",{class:"guide-message"},[e("p",{class:"guide-title"},"é¦–æ¬¡ä½¿ç”¨æé†’"),e("p",{class:"guide-text"}," åœ¨å¼€å§‹ç¿»è¯‘ä¹‹å‰ï¼Œè¯·å…ˆé…ç½®ç¿»è¯‘æœåŠ¡ã€‚ "),e("p",{class:"guide-text"},[me(" ç‚¹å‡»å³ä¸Šè§’çš„ "),e("span",{class:"highlight"},"âš™ï¸ è®¾ç½®"),me(" æŒ‰é’®ï¼Œé…ç½®ä»¥ä¸‹å†…å®¹ï¼š ")]),e("ul",{class:"guide-list"},[e("li",null,"é€‰æ‹© OCR å¼•æ“ï¼ˆæ–‡å­—è¯†åˆ«ï¼‰"),e("li",null,"é…ç½®ç¿»è¯‘æœåŠ¡å•†å’Œ API Key"),e("li",null,"ï¼ˆå¯é€‰ï¼‰é…ç½®é«˜è´¨é‡ç¿»è¯‘å’Œ AI æ ¡å¯¹")])],-1)),e("div",{class:"guide-actions"},[e("button",{class:"guide-btn primary",onClick:c},[..._[1]||(_[1]=[e("span",{class:"btn-icon"},"âš™ï¸",-1),me(" ç«‹å³é…ç½® ",-1)])]),e("button",{class:"guide-btn secondary",onClick:a}," ç¨åé…ç½® ")]),e("div",ti,[e("label",oi,[le(e("input",{type:"checkbox","onUpdate:modelValue":_[0]||(_[0]=S=>u.value=S)},null,512),[[nt,u.value]]),_[2]||(_[2]=e("span",null,"ä¸å†æ˜¾ç¤ºæ­¤æé†’",-1))])])])]),_:1},8,["model-value"]))}}),si=He(ni,[["__scopeId","data-v-eda18e4a"]]),go="saber_translator_dismiss_setup_reminder",ai=["siliconflow","deepseek","volcano","caiyun","baidu_translate","youdao_translate","gemini","custom_openai"],li={manga_ocr:"MangaOCR",paddle_ocr:"PaddleOCR",baidu_ocr:"ç™¾åº¦OCR",ai_vision:"AIè§†è§‰OCR"},ii=["ollama","sakura"],ri=["custom_openai"],ui=["custom_openai"],ci={siliconflow:"SiliconFlow",deepseek:"DeepSeek",volcano:"ç«å±±å¼•æ“",caiyun:"å½©äº‘å°è¯‘",baidu_translate:"ç™¾åº¦ç¿»è¯‘",youdao_translate:"æœ‰é“ç¿»è¯‘",gemini:"Google Gemini",custom_openai:"è‡ªå®šä¹‰ OpenAI",ollama:"Ollama",sakura:"Sakura"};function Mn(){const n=Ne(),t=ct(),s=w(!1),o=w(!1),l=Z(()=>{try{return localStorage.getItem(go)==="true"}catch{return!1}});function u(k){return ci[k]||k}function a(k){return ai.includes(k)}function c(k){return ii.includes(k)}function v(k){return ri.includes(k)}function p(k){return ui.includes(k)}function _(k){return li[k]||k}function S(){const k=n.settings,K=k.ocrEngine,N=k.baiduOcr,se=k.aiVisionOcr,G=[];return K?(K==="baidu_ocr"&&((!N?.apiKey||N.apiKey.trim()==="")&&G.push("ç™¾åº¦OCR çš„ API Key"),(!N?.secretKey||N.secretKey.trim()==="")&&G.push("ç™¾åº¦OCR çš„ Secret Key")),K==="ai_vision"&&(se?.provider||G.push("AIè§†è§‰OCR çš„æœåŠ¡å•†"),(!se?.apiKey||se.apiKey.trim()==="")&&G.push("AIè§†è§‰OCR çš„ API Key"),(!se?.modelName||se.modelName.trim()==="")&&G.push("AIè§†è§‰OCR çš„æ¨¡å‹åç§°"),se?.provider==="custom"&&(!se?.customBaseUrl||se.customBaseUrl.trim()==="")&&G.push("AIè§†è§‰OCR çš„è‡ªå®šä¹‰ Base URL")),G.length>0?{valid:!1,message:`è¯·å…ˆåœ¨é¡¶éƒ¨ âš™ï¸ è®¾ç½®èœå•ä¸­å¡«å†™ ${G[0]}`,missingItems:G}:{valid:!0,message:""}):{valid:!1,message:"è¯·å…ˆåœ¨é¡¶éƒ¨ âš™ï¸ è®¾ç½®èœå•ä¸­é€‰æ‹© OCR å¼•æ“",missingItems:["OCR å¼•æ“"]}}function D(){const{translation:k}=n.settings,{provider:K,apiKey:N,modelName:se,customBaseUrl:G}=k,J=[];return K?(a(K)&&(!N||N.trim()==="")&&J.push(`${u(K)} çš„ API Key`),(!se||se.trim()==="")&&(c(K)||a(K))&&J.push(`${u(K)} çš„æ¨¡å‹åç§°`),v(K)&&(!G||G.trim()==="")&&J.push("è‡ªå®šä¹‰ OpenAI æœåŠ¡çš„ Base URL"),J.length>0?{valid:!1,message:`è¯·å…ˆåœ¨é¡¶éƒ¨ âš™ï¸ è®¾ç½®èœå•ä¸­å¡«å†™ ${J[0]}`,missingItems:J}:{valid:!0,message:""}):{valid:!1,message:"è¯·å…ˆåœ¨é¡¶éƒ¨ âš™ï¸ è®¾ç½®èœå•ä¸­é€‰æ‹©ç¿»è¯‘æœåŠ¡å•†",missingItems:["ç¿»è¯‘æœåŠ¡å•†"]}}function M(){const{hqTranslation:k}=n.settings,{provider:K,apiKey:N,modelName:se,customBaseUrl:G}=k,J=[];return K?((!N||N.trim()==="")&&J.push("é«˜è´¨é‡ç¿»è¯‘çš„ API Key"),(!se||se.trim()==="")&&J.push("é«˜è´¨é‡ç¿»è¯‘çš„æ¨¡å‹åç§°"),p(K)&&(!G||G.trim()==="")&&J.push("é«˜è´¨é‡ç¿»è¯‘çš„ Base URL"),J.length>0?{valid:!1,message:`è¯·å…ˆåœ¨é¡¶éƒ¨ âš™ï¸ è®¾ç½®èœå•ä¸­å¡«å†™ ${J[0]}`,missingItems:J}:{valid:!0,message:""}):{valid:!1,message:"è¯·å…ˆåœ¨é¡¶éƒ¨ âš™ï¸ è®¾ç½®èœå•ä¸­é€‰æ‹©é«˜è´¨é‡ç¿»è¯‘çš„æœåŠ¡å•†",missingItems:["é«˜è´¨é‡ç¿»è¯‘æœåŠ¡å•†"]}}function E(k){const K=k||n.settings.proofreading.rounds,N=[];if(!K||K.length===0)return{valid:!1,message:"è¯·å…ˆåœ¨é¡¶éƒ¨ âš™ï¸ è®¾ç½®èœå•ä¸­æ·»åŠ è‡³å°‘ä¸€ä¸ªæ ¡å¯¹è½®æ¬¡",missingItems:["æ ¡å¯¹è½®æ¬¡"]};for(let se=0;se<K.length;se++){const G=K[se];if(!G)continue;const J=G.name||`è½®æ¬¡${se+1}`;if(G.provider||N.push(`æ ¡å¯¹ ${J} çš„æœåŠ¡å•†`),(!G.apiKey||G.apiKey.trim()==="")&&N.push(`æ ¡å¯¹ ${J} çš„ API Key`),(!G.modelName||G.modelName.trim()==="")&&N.push(`æ ¡å¯¹ ${J} çš„æ¨¡å‹åç§°`),N.length>0)return{valid:!1,message:`è¯·å…ˆåœ¨é¡¶éƒ¨ âš™ï¸ è®¾ç½®èœå•ä¸­ä¸º ${N[0]}`,missingItems:N}}return{valid:!0,message:""}}function P(k="normal",K={}){let N;switch(k){case"normal":N=D();break;case"hq":N=M();break;case"proofread":N=E(K.proofreadingRounds);break;case"ocr":N=S();break;default:N=D()}return N.valid?!0:(t.error(N.message),V(),!1)}function q(){const k=S();if(!k.valid)return t.error(k.message),V(),!1;const K=D();return K.valid?!0:(t.error(K.message),V(),!1)}function V(){const k=document.getElementById("openSettingsBtn");k&&(o.value=!0,k.style.animation="settingsBtnPulse 0.5s ease-in-out 3",k.style.boxShadow="0 0 10px var(--primary-color, #4a90d9)",setTimeout(()=>{k.style.animation="",k.style.boxShadow="",o.value=!1},3e3))}function U(){if(l.value){console.log("ç”¨æˆ·å·²é€‰æ‹©ä¸å†æ˜¾ç¤ºè®¾ç½®æé†’");return}s.value=!0}function f(k=!1){if(k)try{localStorage.setItem(go,"true"),console.log("ç”¨æˆ·é€‰æ‹©æ°¸ä¹…å…³é—­è®¾ç½®æé†’")}catch(K){console.error("ä¿å­˜è®¾ç½®æé†’çŠ¶æ€å¤±è´¥:",K)}s.value=!1}function m(){try{localStorage.removeItem(go),console.log("è®¾ç½®æé†’çŠ¶æ€å·²é‡ç½®")}catch(k){console.error("é‡ç½®è®¾ç½®æé†’çŠ¶æ€å¤±è´¥:",k)}}function C(){setTimeout(()=>{U()},500)}return{showSetupReminder:s,isSettingsButtonHighlighted:o,isSetupReminderDismissed:l,validateOcrConfig:S,validateTranslationConfig:D,validateHqTranslationConfig:M,validateProofreadingConfig:E,validateBeforeTranslation:P,validateFullTranslationConfig:q,highlightSettingsButton:V,checkAndShowSetupReminder:U,closeSetupReminder:f,resetSetupReminderDismiss:m,initValidation:C,getProviderDisplayName:u,getOcrEngineDisplayName:_,requiresApiKey:a,isLocalProvider:c,requiresBaseUrl:v}}const gt=Yt("bubble",()=>{const n=w([]),t=w(-1),s=w([]),o=w([]),l=w(!1),u=w(-1),a=w(0),c=w(0),v=w(0),p=w(0),_=w(!1),S=w(-1),D=w(null),M=w(!1),E=w(-1),P=w(0),q=Z(()=>t.value>=0&&t.value<n.value.length?n.value[t.value]??null:null),V=Z(()=>n.value.length),U=Z(()=>n.value.length>0),f=Z(()=>t.value>=0),m=Z(()=>s.value.length>1),C=Z(()=>s.value.filter(R=>R>=0&&R<n.value.length).map(R=>n.value[R]).filter(R=>R!==void 0));function k(){const Y=et().currentImage;Y&&(Y.bubbleStates=Vt(n.value),Y.hasUnsavedChanges=!0,console.log("æ°”æ³¡çŠ¶æ€å·²åŒæ­¥åˆ°å½“å‰å›¾ç‰‡"))}function K(R,Y=!1){n.value=R,o.value=Vt(R),A(),console.log(`æ°”æ³¡æ•°ç»„å·²è®¾ç½®ï¼Œå…± ${R.length} ä¸ªæ°”æ³¡`),Y||k()}function N(R,Y){const ce=na(R),De=Ne().settings.textStyle,$e=De.layoutDirection,he=$e==="vertical"||$e==="horizontal"?$e:ce==="vertical"||ce==="horizontal"?ce:"vertical",te=oa({coords:R,translatedText:"",autoTextDirection:ce,fontSize:De.fontSize,fontFamily:De.fontFamily,textDirection:he,textColor:De.textColor,fillColor:De.fillColor,inpaintMethod:De.inpaintMethod,strokeEnabled:De.strokeEnabled,strokeColor:De.strokeColor,strokeWidth:De.strokeWidth,rotationAngle:0,position:{x:0,y:0},...Y});return n.value.push(te),console.log(`å·²æ·»åŠ æ°”æ³¡ï¼Œå½“å‰å…± ${n.value.length} ä¸ª`),k(),te}function se(R){return R<0||R>=n.value.length?(console.warn(`åˆ é™¤å¤±è´¥: æ— æ•ˆçš„ç´¢å¼• ${R}`),!1):(n.value.splice(R,1),t.value===R?t.value=-1:t.value>R&&t.value--,s.value=s.value.filter(Y=>Y!==R).map(Y=>Y>R?Y-1:Y),console.log(`å·²åˆ é™¤æ°”æ³¡ï¼Œå½“å‰å…± ${n.value.length} ä¸ª`),k(),!0)}function G(){if(s.value.length===0&&t.value<0)return;const R=[...new Set([...s.value,t.value])].filter(Y=>Y>=0).sort((Y,ce)=>ce-Y);for(const Y of R)n.value.splice(Y,1);A(),console.log(`å·²åˆ é™¤ ${R.length} ä¸ªæ°”æ³¡`),k()}function J(){n.value=[],o.value=[],A(),console.log("æ‰€æœ‰æ°”æ³¡å·²æ¸…é™¤"),k()}function ee(){n.value=[],o.value=[],A(),console.log("æœ¬åœ°æ°”æ³¡çŠ¶æ€å·²æ¸…é™¤ï¼ˆä¸åŒæ­¥åˆ°imageStoreï¼‰")}function j(R){R>=-1&&R<n.value.length&&(t.value=R,s.value=R>=0?[R]:[],console.log(`å·²é€‰ä¸­æ°”æ³¡ ${R}`))}function ae(R){if(R<0||R>=n.value.length)return;const Y=s.value.indexOf(R);Y>=0?(s.value.splice(Y,1),t.value===R&&(t.value=s.value[0]??-1)):(s.value.push(R),t.value=R),console.log(`å¤šé€‰çŠ¶æ€: ${s.value.join(", ")}`)}function A(){t.value=-1,s.value=[]}function d(){t.value>=0?s.value=[t.value]:s.value=[]}function $(){if(n.value.length===0)return!1;const R=t.value<n.value.length-1?t.value+1:0;return j(R),!0}function r(){if(n.value.length===0)return!1;const R=t.value>0?t.value-1:n.value.length-1;return j(R),!0}function h(R,Y){if(R<0||R>=n.value.length)return console.warn(`æ›´æ–°å¤±è´¥: æ— æ•ˆçš„ç´¢å¼• ${R}`),!1;const ce=n.value[R];return ce?(Object.assign(ce,Y),console.log(`å·²æ›´æ–°æ°”æ³¡ ${R}`),k(),!0):!1}function I(R){return t.value<0?(console.warn("æ›´æ–°å¤±è´¥: æ²¡æœ‰é€‰ä¸­çš„æ°”æ³¡"),!1):h(t.value,R)}function T(R){const Y=s.value.length>0?s.value:t.value>=0?[t.value]:[];for(const ce of Y){const xe=n.value[ce];xe&&Object.assign(xe,R)}k(),console.log(`å·²æ‰¹é‡æ›´æ–° ${Y.length} ä¸ªæ°”æ³¡`)}function g(R){for(let Y=0;Y<n.value.length;Y++){const ce=n.value[Y];ce&&Object.assign(ce,R)}k(),console.log(`å·²æ›´æ–°æ‰€æœ‰ ${n.value.length} ä¸ªæ°”æ³¡`)}function b(){if(n.value.length!==o.value.length)return!0;for(let R=0;R<n.value.length;R++){const Y=n.value[R],ce=o.value[R];if(!(!Y||!ce)&&(Y.translatedText!==ce.translatedText||Y.textboxText!==ce.textboxText||Y.fontSize!==ce.fontSize||Y.fontFamily!==ce.fontFamily||Y.textDirection!==ce.textDirection||Y.textColor!==ce.textColor||Y.fillColor!==ce.fillColor||Y.rotationAngle!==ce.rotationAngle||Y.strokeEnabled!==ce.strokeEnabled||Y.strokeColor!==ce.strokeColor||Y.strokeWidth!==ce.strokeWidth||Y.inpaintMethod!==ce.inpaintMethod||JSON.stringify(Y.coords)!==JSON.stringify(ce.coords)))return!0}return!1}function L(){n.value=Vt(o.value),A(),console.log("æ°”æ³¡çŠ¶æ€å·²é‡ç½®åˆ°åˆå§‹çŠ¶æ€")}function W(){o.value=Vt(n.value),console.log("å½“å‰çŠ¶æ€å·²ä¿å­˜ä¸ºåˆå§‹çŠ¶æ€")}function i(){return{bubble_coords:n.value.map(R=>R.coords),bubble_texts:n.value.map(R=>R.translatedText),textbox_texts:n.value.map(R=>R.textboxText),font_sizes:n.value.map(R=>R.fontSize),font_families:n.value.map(R=>R.fontFamily),text_directions:n.value.map(R=>R.textDirection==="vertical"||R.textDirection==="horizontal"?R.textDirection==="vertical"?"v":"h":R.autoTextDirection==="vertical"||R.autoTextDirection==="horizontal"?R.autoTextDirection==="vertical"?"v":"h":"v"),text_colors:n.value.map(R=>R.textColor),fill_colors:n.value.map(R=>R.fillColor),rotation_angles:n.value.map(R=>R.rotationAngle),stroke_enabled:n.value.map(R=>R.strokeEnabled),stroke_colors:n.value.map(R=>R.strokeColor),stroke_widths:n.value.map(R=>R.strokeWidth),inpaint_methods:n.value.map(R=>R.inpaintMethod)}}function x(){return JSON.stringify(n.value)}function ie(R){try{const Y=JSON.parse(R);if(!Array.isArray(Y))return console.error("ååºåˆ—åŒ–å¤±è´¥: æ•°æ®ä¸æ˜¯æ•°ç»„"),!1;const ce=[];for(const xe of Y)sa(xe)?ce.push(xe):console.warn("è·³è¿‡æ— æ•ˆçš„æ°”æ³¡çŠ¶æ€:",xe);return K(ce),!0}catch(Y){return console.error("ååºåˆ—åŒ–å¤±è´¥:",Y),!1}}return{bubbles:n,selectedIndex:t,selectedIndices:s,initialStates:o,isDragging:l,draggingIndex:u,dragOffsetX:a,dragOffsetY:c,dragInitialX:v,dragInitialY:p,isResizing:_,resizingIndex:S,resizeCurrentCoords:D,isRotating:M,rotatingIndex:E,rotateCurrentAngle:P,selectedBubble:q,bubbleCount:V,hasBubbles:U,hasSelection:f,isMultiSelect:m,selectedBubbles:C,setBubbles:K,addBubble:N,deleteBubble:se,deleteSelected:G,clearBubbles:J,clearBubblesLocal:ee,selectBubble:j,toggleMultiSelect:ae,clearSelection:A,clearMultiSelect:d,selectNext:$,selectPrevious:r,updateBubble:h,updateSelectedBubble:I,updateAllSelected:T,updateAllBubbles:g,hasChanges:b,resetToInitial:L,saveAsInitial:W,toApiRequest:i,serialize:x,deserialize:ie}}),di=Object.freeze(Object.defineProperty({__proto__:null,useBubbleStore:gt},Symbol.toStringTag,{value:"Module"}));function gi(){const n=w({current:0,total:0,completed:0,failed:0,isInProgress:!1,label:"",percentage:0});return{progress:n,reporter:{init(s,o){n.value={current:0,total:s,completed:0,failed:0,isInProgress:!0,label:o||"å‡†å¤‡ä¸­...",percentage:0}},update(s,o){n.value.current=s,o!==void 0&&(n.value.label=o),n.value.total>0&&(n.value.percentage=Math.round(s/n.value.total*100))},setPercentage(s,o){n.value.percentage=Math.min(100,Math.max(0,s)),o!==void 0&&(n.value.label=o)},incrementCompleted(){n.value.completed++},incrementFailed(){n.value.failed++},finish(){n.value.isInProgress=!1,n.value.percentage=100},getProgress(){return{...n.value}}}}}async function ko(n){return Xe.post("/api/parallel/detect",n)}async function wo(n){return Xe.post("/api/parallel/ocr",n)}async function $o(n){return Xe.post("/api/parallel/color",n)}async function To(n){return Xe.post("/api/parallel/translate",n)}async function Io(n){return Xe.post("/api/parallel/inpaint",n)}async function Po(n){return Xe.post("/api/parallel/render",n)}const pi=Object.freeze(Object.defineProperty({__proto__:null,parallelColor:$o,parallelDetect:ko,parallelInpaint:Io,parallelOcr:wo,parallelRender:Po,parallelTranslate:To},Symbol.toStringTag,{value:"Module"}));let Tt=null,Ut=!1;function Pt(){const n=It();return Ne().settings.autoSaveInBookshelfMode&&n.isBookshelfMode}function Ro(){const n=It(),t=n.currentBookId,s=n.currentChapterId;return!t||!s?null:`bookshelf/${t}/${s}`}function En(){const n=Ne(),{textStyle:t}=n.settings;return{fontSize:t.fontSize,autoFontSize:t.autoFontSize,fontFamily:t.fontFamily,layoutDirection:t.layoutDirection,textColor:t.textColor,useInpaintingMethod:t.inpaintMethod,fillColor:t.fillColor,strokeEnabled:t.strokeEnabled,strokeColor:t.strokeColor,strokeWidth:t.strokeWidth,useAutoTextColor:t.useAutoTextColor}}async function Bn(n){const t=et();if(!Pt())return console.log("[AutoSave] è‡ªåŠ¨ä¿å­˜æœªå¯ç”¨æˆ–éä¹¦æ¶æ¨¡å¼ï¼Œè·³è¿‡é¢„ä¿å­˜"),!0;const s=Ro();if(!s)return console.warn("[AutoSave] ç¼ºå°‘ä¹¦ç±/ç« èŠ‚IDï¼Œè·³è¿‡é¢„ä¿å­˜"),n?.onError?.("ç¼ºå°‘ä¹¦ç±/ç« èŠ‚ID"),!1;const o=t.images,l=o.length;if(l===0)return console.warn("[AutoSave] æ²¡æœ‰å›¾ç‰‡ï¼Œè·³è¿‡é¢„ä¿å­˜"),n?.onError?.("æ²¡æœ‰å›¾ç‰‡"),!1;console.log(`[AutoSave] é¢„ä¿å­˜å¼€å§‹ï¼š${l} é¡µï¼ˆé€é¡µä¿å­˜ï¼‰`),n?.onStart?.(l);try{const{saveAllPagesSequentially:u,saveSessionMeta:a}=await rt(async()=>{const{saveAllPagesSequentially:D,saveSessionMeta:M}=await Promise.resolve().then(()=>Dn);return{saveAllPagesSequentially:D,saveSessionMeta:M}},void 0),c=En(),v=await u(s,o,{onProgress:(D,M)=>{n?.onProgress?.(D,M)}});await a(s,{ui_settings:c,total_pages:l,currentImageIndex:t.currentImageIndex});const p=It(),_=p.currentBookId,S=p.currentChapterId;if(_&&S)try{const{apiClient:D}=await rt(async()=>{const{apiClient:M}=await import("./client.Bht704G-.js");return{apiClient:M}},__vite__mapDeps([4,5]));await D.put(`/api/bookshelf/books/${_}/chapters/${S}/image-count`,{count:l}),console.log(`[AutoSave] å·²æ›´æ–°ç« èŠ‚å›¾ç‰‡æ•°é‡ä¸º ${l}`)}catch(D){console.warn("[AutoSave] æ›´æ–°ç« èŠ‚å›¾ç‰‡æ•°é‡å¤±è´¥ï¼ˆéè‡´å‘½ï¼‰:",D)}return Tt=s,Ut=!0,console.log(`[AutoSave] é¢„ä¿å­˜å®Œæˆï¼Œå…±ä¿å­˜ ${v}/${l} é¡µ`),n?.onComplete?.(),!0}catch(u){console.error("[AutoSave] é¢„ä¿å­˜å¤±è´¥:",u);const a=u instanceof Error?u.message:"é¢„ä¿å­˜å¤±è´¥";return n?.onError?.(a),Tt=null,Ut=!1,!1}}async function An(n){if(!Pt())return;const t=Tt||Ro();if(!t){console.warn("[AutoSave] ä¼šè¯è·¯å¾„ä¸å­˜åœ¨ï¼Œè·³è¿‡ä¿å­˜");return}const s=et(),o=s.images[n];if(!o){console.warn(`[AutoSave] é¡µé¢ ${n} ä¸å­˜åœ¨`);return}try{const l={};o.translatedDataURL?.startsWith("data:")&&(l.translated=o.translatedDataURL),o.cleanImageData&&typeof o.cleanImageData=="string"&&!o.cleanImageData.startsWith("/api/")&&(l.clean=o.cleanImageData.startsWith("data:")?o.cleanImageData:`data:image/png;base64,${o.cleanImageData}`);const u={};for(const c of Object.keys(o))["originalDataURL","translatedDataURL","cleanImageData"].includes(c)||(u[c]=o[c]);l.meta=u;const a=await Rn(t,n,l);if(!a.success)throw new Error(a.error||"ä¿å­˜å¤±è´¥");s.updateImageByIndex(n,{hasUnsavedChanges:!1}),console.log(`[AutoSave] é¡µé¢ ${n+1} å·²ä¿å­˜`)}catch(l){throw console.error(`[AutoSave] ä¿å­˜é¡µé¢ ${n+1} å¤±è´¥:`,l),l}}async function Ln(){if(!Pt())return;const n=Tt||Ro();if(!n||!Ut){console.log("[AutoSave] æœªæ‰§è¡Œé¢„ä¿å­˜ï¼Œè·³è¿‡å®Œæˆä¿å­˜");return}console.log("[AutoSave] å®Œæˆä¿å­˜...");const t=et(),s=It(),o=t.images.length;try{await In(n,{ui_settings:En(),total_pages:o,currentImageIndex:t.currentImageIndex});const l=s.currentBookId,u=s.currentChapterId;if(l&&u)try{const{apiClient:a}=await rt(async()=>{const{apiClient:c}=await import("./client.Bht704G-.js");return{apiClient:c}},__vite__mapDeps([4,5]));await a.put(`/api/bookshelf/books/${l}/chapters/${u}/image-count`,{count:o}),console.log(`[AutoSave] å·²æ›´æ–°ç« èŠ‚å›¾ç‰‡æ•°é‡ä¸º ${o}`)}catch(a){console.warn("[AutoSave] æ›´æ–°ç« èŠ‚å›¾ç‰‡æ•°é‡å¤±è´¥ï¼ˆéè‡´å‘½ï¼‰:",a)}console.log("[AutoSave] ä¼šè¯ä¿å­˜å®Œæˆ")}catch(l){console.error("[AutoSave] å®Œæˆä¿å­˜å¤±è´¥:",l)}finally{Tt=null,Ut=!1}}function Fn(){Tt=null,Ut=!1,console.log("[AutoSave] ä¿å­˜çŠ¶æ€å·²é‡ç½®")}const mn={standard:["detection","ocr","color","translate","inpaint","render"],hq:["detection","ocr","color","aiTranslate","inpaint","render"],proofread:["aiTranslate","render"],removeText:["detection","inpaint","render"]},Kt={detection:"æ°”æ³¡æ£€æµ‹",ocr:"æ–‡å­—è¯†åˆ«",color:"é¢œè‰²æå–",translate:"ç¿»è¯‘",aiTranslate:"AIç¿»è¯‘",inpaint:"èƒŒæ™¯ä¿®å¤",render:"æ¸²æŸ“",save:"ä¿å­˜"};function mi(){const n=et(),t=gt(),s=Ne(),o=Mn(),l=ct(),{progress:u,reporter:a}=gi(),c=w(!1),v=w(null);let p=null,_="standard";const S=Z(()=>c.value||n.isBatchTranslationInProgress),D=Z(()=>u.value.percentage||0);function M(){const r=s.settings.translation.rpmLimit;v.value?v.value.setRpm(r):v.value=aa(r)}function E(r){const h=r.mode==="hq"?"hq":r.mode==="proofread"?"proofread":r.mode==="removeText"?"ocr":"normal";return o.validateBeforeTranslation(h)}function P(){const{textStyle:r}=s.settings,h=r.layoutDirection;p={fontFamily:r.fontFamily,fontSize:r.fontSize,autoFontSize:r.autoFontSize,autoTextDirection:h==="auto",textDirection:h==="auto"?"vertical":h,layoutDirection:h,fillColor:r.fillColor,textColor:r.textColor,rotationAngle:0,strokeEnabled:r.strokeEnabled,strokeColor:r.strokeColor,strokeWidth:r.strokeWidth,useAutoTextColor:r.useAutoTextColor,inpaintMethod:r.inpaintMethod}}function q(r){return r.includes("base64,")?r.split("base64,")[1]||"":r}function V(r){const h=n.images;if(r.scope==="current"){const I=n.currentImage;return I?[{image:I,index:n.currentImageIndex}]:[]}if(r.scope==="failed")return n.getFailedImageIndices().map(I=>({image:h[I],index:I})).filter(I=>I.image!==void 0);if(r.scope==="range"&&r.pageRange){const I=Math.max(0,r.pageRange.startPage-1),T=Math.min(h.length-1,r.pageRange.endPage-1);return I>T||I>=h.length?[]:h.slice(I,T+1).map((g,b)=>({image:g,index:I+b}))}return h.map((I,T)=>({image:I,index:T}))}async function U(r){const h=r.image.bubbleStates;if(h!=null){h.length>0?(console.log(`å›¾ç‰‡ ${r.imageIndex+1} å·²æœ‰ ${h.length} ä¸ªæ°”æ³¡ï¼Œè·³è¿‡æ£€æµ‹`),r.bubbleCoords=h.map(b=>b.coords.map(L=>Math.round(L))),r.bubbleAngles=h.map(b=>b.rotationAngle||0),r.bubblePolygons=h.map(b=>b.polygon||[]),r.autoDirections=h.map(b=>b.autoTextDirection||b.textDirection||"vertical"),r.originalTexts=h.map(b=>b.originalText||"")):(console.log(`å›¾ç‰‡ ${r.imageIndex+1} æ°”æ³¡å·²è¢«æ¸…ç©ºï¼Œè·³è¿‡æ£€æµ‹`),r.bubbleCoords=[],r.bubbleAngles=[],r.bubblePolygons=[],r.autoDirections=[],r.originalTexts=[]);return}const I=s.settings,T=q(r.image.originalDataURL),g=await ko({image:T,detector_type:I.textDetector,box_expand_ratio:I.boxExpand.ratio,box_expand_top:I.boxExpand.top,box_expand_bottom:I.boxExpand.bottom,box_expand_left:I.boxExpand.left,box_expand_right:I.boxExpand.right});if(!g.success)throw new Error(g.error||"æ£€æµ‹å¤±è´¥");r.bubbleCoords=g.bubble_coords||[],r.bubbleAngles=g.bubble_angles||[],r.bubblePolygons=g.bubble_polygons||[],r.autoDirections=g.auto_directions||[],r.rawMask=g.raw_mask,r.textlinesPerBubble=g.textlines_per_bubble||[]}async function f(r){if(r.bubbleCoords.length===0){r.originalTexts=[];return}const h=s.settings,I=q(r.image.originalDataURL),T=h.ocrEngine==="paddleocr_vl"?h.paddleOcrVl?.sourceLanguage||"japanese":h.sourceLanguage,g=await wo({image:I,bubble_coords:r.bubbleCoords,source_language:T,ocr_engine:h.ocrEngine,baidu_api_key:h.baiduOcr?.apiKey,baidu_secret_key:h.baiduOcr?.secretKey,baidu_version:h.baiduOcr?.version,baidu_ocr_language:h.baiduOcr?.sourceLanguage,ai_vision_provider:h.aiVisionOcr?.provider,ai_vision_api_key:h.aiVisionOcr?.apiKey,ai_vision_model_name:h.aiVisionOcr?.modelName,ai_vision_ocr_prompt:h.aiVisionOcr?.prompt,custom_ai_vision_base_url:h.aiVisionOcr?.customBaseUrl,textlines_per_bubble:r.textlinesPerBubble});if(!g.success)throw new Error(g.error||"OCRå¤±è´¥");r.originalTexts=g.original_texts||[]}async function m(r){if(r.bubbleCoords.length===0){r.colors=[];return}const h=q(r.image.originalDataURL),I=await $o({image:h,bubble_coords:r.bubbleCoords,textlines_per_bubble:r.textlinesPerBubble});if(!I.success)throw new Error(I.error||"é¢œè‰²æå–å¤±è´¥");r.colors=I.colors||[]}async function C(r){if(r.originalTexts.length===0){r.translatedTexts=[],r.textboxTexts=[];return}const h=s.settings;if((h.translation.translationMode||"batch")==="single"){console.log(`[ç¿»è¯‘] ä½¿ç”¨é€æ°”æ³¡ç¿»è¯‘æ¨¡å¼ï¼Œå…± ${r.originalTexts.length} ä¸ªæ°”æ³¡`),r.translatedTexts=[],r.textboxTexts=[];for(let T=0;T<r.originalTexts.length;T++){const g=r.originalTexts[T];if(!g||g.trim()===""){r.translatedTexts.push(""),h.useTextboxPrompt&&r.textboxTexts.push("");continue}try{const b=await At({original_text:g,model_provider:h.translation.provider,model_name:h.translation.modelName,api_key:h.translation.apiKey,custom_base_url:h.translation.customBaseUrl,target_language:h.targetLanguage,prompt_content:h.translatePrompt,use_json_format:h.translation.isJsonMode,rpm_limit_translation:h.translation.rpmLimit,max_retries:h.translation.maxRetries});if(b.success&&b.data?r.translatedTexts.push(b.data.translated_text||""):(console.warn(`[ç¿»è¯‘] æ°”æ³¡ ${T+1} ç¿»è¯‘å¤±è´¥: ${b.error}`),r.translatedTexts.push("[ç¿»è¯‘å¤±è´¥]")),h.useTextboxPrompt&&h.textboxPrompt){const L=await At({original_text:g,model_provider:h.translation.provider,model_name:h.translation.modelName,api_key:h.translation.apiKey,custom_base_url:h.translation.customBaseUrl,target_language:h.targetLanguage,prompt_content:h.textboxPrompt,rpm_limit_translation:h.translation.rpmLimit,max_retries:h.translation.maxRetries});L.success&&L.data?r.textboxTexts.push(L.data.translated_text||""):r.textboxTexts.push("")}v.value&&T<r.originalTexts.length-1&&await v.value.acquire()}catch(b){console.error(`[ç¿»è¯‘] æ°”æ³¡ ${T+1} ç¿»è¯‘å‡ºé”™:`,b),r.translatedTexts.push("[ç¿»è¯‘å‡ºé”™]"),h.useTextboxPrompt&&r.textboxTexts.push("")}}console.log(`[ç¿»è¯‘] é€æ°”æ³¡ç¿»è¯‘å®Œæˆï¼ŒæˆåŠŸ ${r.translatedTexts.filter(T=>T&&!T.startsWith("[ç¿»è¯‘")).length}/${r.originalTexts.length}`)}else{console.log(`[ç¿»è¯‘] ä½¿ç”¨æ•´é¡µæ‰¹é‡ç¿»è¯‘æ¨¡å¼ï¼Œå…± ${r.originalTexts.length} ä¸ªæ°”æ³¡`);const T=await To({original_texts:r.originalTexts,target_language:h.targetLanguage,source_language:h.sourceLanguage,model_provider:h.translation.provider,model_name:h.translation.modelName,api_key:h.translation.apiKey,custom_base_url:h.translation.customBaseUrl,prompt_content:h.translatePrompt,textbox_prompt_content:h.textboxPrompt,use_textbox_prompt:h.useTextboxPrompt,rpm_limit:h.translation.rpmLimit,max_retries:h.translation.maxRetries,use_json_format:h.translation.isJsonMode});if(!T.success)throw new Error(T.error||"ç¿»è¯‘å¤±è´¥");r.translatedTexts=T.translated_texts||[],r.textboxTexts=T.textbox_texts||[]}}async function k(r){const h=s.settings,I=_==="proofread",T=r.map(he=>I?{imageIndex:he.imageIndex,bubbles:(he.image.bubbleStates||[]).map((te,y)=>({bubbleIndex:y,original:te.originalText||"",translated:h.useTextboxPrompt?te.textboxText||te.translatedText||"":te.translatedText||"",textDirection:te.textDirection==="vertical"||te.textDirection==="horizontal"?te.textDirection:te.autoTextDirection==="vertical"||te.autoTextDirection==="horizontal"?te.autoTextDirection:"vertical"}))}:{imageIndex:he.imageIndex,bubbles:he.originalTexts.map((te,y)=>({bubbleIndex:y,original:te,translated:"",textDirection:he.autoDirections[y]||"vertical"}))}),g=r.map(he=>{const te=I&&he.image.translatedDataURL||he.image.originalDataURL;return q(te)}),b=I?h.proofreading.rounds[0]:h.hqTranslation,L=I?b?.prompt:h.hqTranslation.prompt,W=I?"ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ¼«ç”»ç¿»è¯‘æ ¡å¯¹åŠ©æ‰‹ï¼Œèƒ½å¤Ÿæ ¹æ®æ¼«ç”»å›¾åƒå†…å®¹æ£€æŸ¥å’Œä¿®æ­£ç¿»è¯‘ã€‚":"ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ¼«ç”»ç¿»è¯‘åŠ©æ‰‹ï¼Œèƒ½å¤Ÿæ ¹æ®æ¼«ç”»å›¾åƒå†…å®¹å’Œä¸Šä¸‹æ–‡æä¾›é«˜è´¨é‡çš„ç¿»è¯‘ã€‚",i=JSON.stringify(T,null,2),x=[{type:"text",text:(L||"")+`

ä»¥ä¸‹æ˜¯JSONæ•°æ®:
\`\`\`json
`+i+"\n```"}];for(const he of g)x.push({type:"image_url",image_url:{url:`data:image/png;base64,${he}`}});const ie=[{role:"system",content:W},{role:"user",content:x}],R=h.hqTranslation,Y=I?b:null,ce=await Lt({provider:(I?Y?.provider:R.provider)||"openai",api_key:(I?Y?.apiKey:R.apiKey)||"",model_name:(I?Y?.modelName:R.modelName)||"",custom_base_url:I?Y?.customBaseUrl:R.customBaseUrl,messages:ie,low_reasoning:I?Y?.lowReasoning:R.lowReasoning,force_json_output:I?Y?.forceJsonOutput:R.forceJsonOutput,no_thinking_method:I?Y?.noThinkingMethod:R.noThinkingMethod,use_stream:I?!1:R.useStream,max_retries:I?h.proofreading.maxRetries||2:R.maxRetries||2}),xe=I?Y?.forceJsonOutput||!1:R.forceJsonOutput;let $e=G(ce,xe)||T;if(I&&h.proofreading.rounds.length>1)for(let he=1;he<h.proofreading.rounds.length;he++){const te=h.proofreading.rounds[he],y=JSON.stringify($e,null,2),X=[{type:"text",text:te.prompt+`

ä»¥ä¸‹æ˜¯JSONæ•°æ®:
\`\`\`json
`+y+"\n```"}];for(const oe of g)X.push({type:"image_url",image_url:{url:`data:image/png;base64,${oe}`}});const ve=[{role:"system",content:W},{role:"user",content:X}],fe=await Lt({provider:te.provider,api_key:te.apiKey,model_name:te.modelName,custom_base_url:te.customBaseUrl,messages:ve,low_reasoning:te.lowReasoning,force_json_output:te.forceJsonOutput,no_thinking_method:te.noThinkingMethod,use_stream:!1,max_retries:te.maxRetries||h.proofreading.maxRetries||2}),O=G(fe,te.forceJsonOutput);O&&($e=O)}for(const he of r){const te=$e?.find(y=>y.imageIndex===he.imageIndex);te?he.translatedTexts=te.bubbles.map(y=>y.translated):he.translatedTexts=[],he.textboxTexts=[]}}async function K(r){if(r.bubbleCoords.length===0){r.cleanImage=q(r.image.originalDataURL);return}const h=s.settings,{textStyle:I,preciseMask:T}=h,g=q(r.image.originalDataURL),b=await Io({image:g,bubble_coords:r.bubbleCoords,bubble_polygons:r.bubblePolygons,raw_mask:r.rawMask,method:I.inpaintMethod==="solid"?"solid":"lama",lama_model:I.inpaintMethod==="litelama"?"litelama":"lama_mpe",fill_color:I.fillColor,mask_dilate_size:T.dilateSize,mask_box_expand_ratio:T.boxExpandRatio});if(!b.success)throw new Error(b.error||"èƒŒæ™¯ä¿®å¤å¤±è´¥");r.cleanImage=b.clean_image}async function N(r){if(!r.cleanImage)throw _==="proofread"?new Error("æ­¤å›¾ç‰‡å°šæœªç¿»è¯‘ï¼Œè¯·å…ˆç¿»è¯‘åå†è¿›è¡Œæ ¡å¯¹"):new Error("ç¼ºå°‘å¹²å‡€èƒŒæ™¯å›¾ç‰‡");const{textStyle:h}=s.settings,I=p?.autoTextDirection?"auto":p?.textDirection||h.layoutDirection,T=r.bubbleCoords.map((b,L)=>{const W=r.autoDirections[L]||"vertical",i=W==="v"?"vertical":W==="h"?"horizontal":W==="vertical"||W==="horizontal"?W:"vertical",x=I==="vertical"||I==="horizontal"?I:i,ie=p?.useAutoTextColor??h.useAutoTextColor;let R=p?.textColor||h.textColor,Y=p?.fillColor||h.fillColor;const ce=r.colors[L];return ie&&ce&&(ce.textColor&&(R=ce.textColor),ce.bgColor&&(Y=ce.bgColor)),{coords:b,polygon:[],position:{x:0,y:0},rotationAngle:r.bubbleAngles[L]||0,originalText:r.originalTexts[L]||"",translatedText:r.translatedTexts[L]||"",textboxText:r.textboxTexts[L]||"",textDirection:x,autoTextDirection:i,fontSize:p?.fontSize||h.fontSize,fontFamily:p?.fontFamily||h.fontFamily,autoFontSize:p?.autoFontSize??h.autoFontSize,textColor:R,fillColor:Y,strokeEnabled:p?.strokeEnabled??h.strokeEnabled,strokeColor:p?.strokeColor||h.strokeColor,strokeWidth:p?.strokeWidth||h.strokeWidth,inpaintMethod:p?.inpaintMethod||h.inpaintMethod,autoFgColor:r.colors[L]?.autoFgColor||null,autoBgColor:r.colors[L]?.autoBgColor||null}}),g=await Po({clean_image:r.cleanImage,bubble_states:T,fontSize:p?.fontSize||h.fontSize,fontFamily:p?.fontFamily||h.fontFamily,textDirection:p?.textDirection||h.layoutDirection,textColor:p?.textColor||h.textColor,strokeEnabled:p?.strokeEnabled??h.strokeEnabled,strokeColor:p?.strokeColor||h.strokeColor,strokeWidth:p?.strokeWidth||h.strokeWidth,autoFontSize:p?.autoFontSize??h.autoFontSize,use_individual_styles:!0});if(!g.success)throw new Error(g.error||"æ¸²æŸ“å¤±è´¥");r.finalImage=g.final_image,r.bubbleStates=g.bubble_states||T}async function se(r,h){switch(r){case"detection":await U(h);break;case"ocr":await f(h);break;case"color":await m(h);break;case"translate":await C(h);break;case"inpaint":await K(h);break;case"render":await N(h);break;case"save":await An(h.imageIndex);break;case"aiTranslate":throw new Error("aiTranslate åº”é€šè¿‡æ‰¹é‡å¤„ç†é€»è¾‘è°ƒç”¨")}}function G(r,h){if(!r.success)return console.error("APIè°ƒç”¨å¤±è´¥:",r.error),null;if(r.results&&r.results.length>0){const T=r.results[0];if(T&&"imageIndex"in T&&"bubbles"in T)return r.results}const I=r.content;if(I)if(h)try{return JSON.parse(I)}catch{return null}else{const T=I.match(/```json\s*([\s\S]*?)\s*```/);if(T?.[1])try{return JSON.parse(T[1])}catch{return null}}return null}function J(r){const h=r.finalImage?`data:image/png;base64,${r.finalImage}`:r.cleanImage?`data:image/png;base64,${r.cleanImage}`:null,{textStyle:I}=s.settings;n.updateImageByIndex(r.imageIndex,{translatedDataURL:h,cleanImageData:r.cleanImage||null,bubbleStates:r.bubbleStates,bubbleCoords:r.bubbleCoords,bubbleAngles:r.bubbleAngles,originalTexts:r.originalTexts,textboxTexts:r.textboxTexts,bubbleTexts:r.translatedTexts,translationStatus:"completed",translationFailed:!1,showOriginal:!1,hasUnsavedChanges:!0,fontSize:p?.fontSize??I.fontSize,autoFontSize:p?.autoFontSize??I.autoFontSize,fontFamily:p?.fontFamily??I.fontFamily,layoutDirection:p?.layoutDirection??I.layoutDirection,textColor:p?.textColor??I.textColor,fillColor:p?.fillColor??I.fillColor,strokeEnabled:p?.strokeEnabled??I.strokeEnabled,strokeColor:p?.strokeColor??I.strokeColor,strokeWidth:p?.strokeWidth??I.strokeWidth,inpaintMethod:p?.inpaintMethod??I.inpaintMethod,useAutoTextColor:p?.useAutoTextColor??I.useAutoTextColor}),r.imageIndex===n.currentImageIndex&&r.bubbleStates&&t.setBubbles(r.bubbleStates)}function ee(r){return r==="standard"||r==="removeText"}function j(r){const h=s.settings;return r==="hq"?h.hqTranslation.batchSize||5:r==="proofread"?h.proofreading.rounds[0]?.batchSize||5:1}async function ae(r,h,I,T){let g=0,b=0;for(let L=0;L<r.length;L++){const W=r[L];if(I.scope==="all"&&!n.isBatchTranslationInProgress){console.log("â¹ï¸ æ‰¹é‡ç¿»è¯‘å·²å–æ¶ˆï¼Œåœæ­¢å¤„ç†");break}const i=Math.floor(L/r.length*90);a.setPercentage(i,`å¤„ç†å›¾ç‰‡ ${L+1}/${r.length}`),l.info(`å¤„ç†å›¾ç‰‡ ${L+1}/${r.length}...`),n.setTranslationStatus(W.imageIndex,"processing");let x=!1;for(let ie=0;ie<h.length;ie++){const R=h[ie];if(x)break;v.value&&await v.value.acquire();try{const Y=i+Math.floor(ie/h.length*(90/r.length));a.setPercentage(Y,`å›¾ç‰‡ ${L+1}: ${Kt[R]}`),await se(R,W)}catch(Y){const ce=Y instanceof Error?Y.message:"æœªçŸ¥é”™è¯¯";T.push(`å›¾ç‰‡ ${W.imageIndex+1}: ${R} - ${ce}`),n.setTranslationStatus(W.imageIndex,"failed",ce),x=!0,b++}}x||(J(W),g++,console.log(`âœ… å›¾ç‰‡ ${L+1}/${r.length} å¤„ç†å®Œæˆ`))}return{completed:g,failed:b}}async function A(r,h,I,T){let g=0,b=0;const L=j(I.mode),W=Math.ceil(r.length/L),i=h.indexOf("aiTranslate"),x=i>=0?h.slice(0,i):h,ie=i>=0?h.slice(i+1):[];console.log(`ğŸ“¦ æ‰¹æ¬¡å¤„ç†æ¨¡å¼ï¼šå…± ${r.length} å¼ å›¾ç‰‡ï¼Œæ¯æ‰¹ ${L} å¼ ï¼Œå…± ${W} æ‰¹`),console.log(`   AIç¿»è¯‘å‰æ­¥éª¤: [${x.join(" â†’ ")}]`),console.log(`   AIç¿»è¯‘åæ­¥éª¤: [${ie.join(" â†’ ")}]`);for(let R=0;R<W;R++){if(I.scope==="all"&&!n.isBatchTranslationInProgress){console.log("â¹ï¸ æ‰¹é‡ç¿»è¯‘å·²å–æ¶ˆï¼Œåœæ­¢å¤„ç†");break}const Y=R*L,ce=Math.min(Y+L,r.length),xe=r.slice(Y,ce),De=Math.floor(R/W*90);a.setPercentage(De,`å¤„ç†æ‰¹æ¬¡ ${R+1}/${W}`),l.info(`å¤„ç†æ‰¹æ¬¡ ${R+1}/${W}ï¼ˆå›¾ç‰‡ ${Y+1}-${ce}ï¼‰...`);for(const he of xe)n.setTranslationStatus(he.imageIndex,"processing");const $e=new Set;for(let he=0;he<xe.length;he++){const te=xe[he];for(const y of x){if($e.has(te.imageIndex))break;v.value&&await v.value.acquire();try{const X=De+Math.floor(he/xe.length*30);a.setPercentage(X,`å›¾ç‰‡ ${Y+he+1}: ${Kt[y]}`),await se(y,te)}catch(X){const ve=X instanceof Error?X.message:"æœªçŸ¥é”™è¯¯";T.push(`å›¾ç‰‡ ${te.imageIndex+1}: ${y} - ${ve}`),n.setTranslationStatus(te.imageIndex,"failed",ve),$e.add(te.imageIndex)}}}if(i>=0){const he=De+40;a.setPercentage(he,`æ‰¹æ¬¡ ${R+1}: ${Kt.aiTranslate}`);try{const te=xe.filter(y=>!$e.has(y.imageIndex));te.length>0&&await k(te)}catch(te){const y=te instanceof Error?te.message:"æœªçŸ¥é”™è¯¯";T.push(`æ‰¹æ¬¡ ${R+1} AIç¿»è¯‘å¤±è´¥: ${y}`);for(const X of xe)$e.has(X.imageIndex)||(n.setTranslationStatus(X.imageIndex,"failed",y),$e.add(X.imageIndex))}}for(let he=0;he<xe.length;he++){const te=xe[he];if(!$e.has(te.imageIndex)){for(const y of ie){if($e.has(te.imageIndex))break;v.value&&await v.value.acquire();try{const X=De+50+Math.floor(he/xe.length*40);a.setPercentage(X,`å›¾ç‰‡ ${Y+he+1}: ${Kt[y]}`),await se(y,te)}catch(X){const ve=X instanceof Error?X.message:"æœªçŸ¥é”™è¯¯";T.push(`å›¾ç‰‡ ${te.imageIndex+1}: ${y} - ${ve}`),n.setTranslationStatus(te.imageIndex,"failed",ve),$e.add(te.imageIndex)}}$e.has(te.imageIndex)||(J(te),g++,console.log(`âœ… å›¾ç‰‡ ${Y+he+1} å¤„ç†å®Œæˆ`))}}b+=$e.size,console.log(`âœ… æ‰¹æ¬¡ ${R+1}/${W} å¤„ç†å®Œæˆ`)}return{completed:g,failed:b}}async function d(r){if(!E(r))return{success:!1,completed:0,failed:0,errors:["é…ç½®éªŒè¯å¤±è´¥"]};if(n.images.length===0)return l.error("è¯·å…ˆä¸Šä¼ å›¾ç‰‡"),{success:!1,completed:0,failed:0,errors:["æ²¡æœ‰å›¾ç‰‡"]};_=r.mode;const I=ee(r.mode);c.value=!0,(r.scope==="all"||r.scope==="failed")&&n.setBatchTranslationInProgress(!0),M(),P();const T=V(r),g=[],b=Pt(),L=[...mn[r.mode]];b&&L.push("save"),console.log("ğŸš€ é¡ºåºç®¡çº¿å¯åŠ¨"),console.log(`   æ¨¡å¼: ${r.mode}`),console.log(`   å¤„ç†æ–¹å¼: ${I?"é€å¼ å¤„ç†":"æ‰¹æ¬¡å¤„ç†"}`),console.log(`   æ­¥éª¤é“¾: [${L.join(" â†’ ")}]`),console.log(`   è‡ªåŠ¨ä¿å­˜: ${b?"å¯ç”¨":"ç¦ç”¨"}`);const W=T.map(({image:i,index:x})=>{const ie={imageIndex:x,image:i,bubbleCoords:[],bubbleAngles:[],bubblePolygons:[],autoDirections:[],textlinesPerBubble:[],originalTexts:[],colors:[],translatedTexts:[],textboxTexts:[]};return r.mode==="proofread"&&i.bubbleStates&&i.bubbleStates.length>0&&(ie.bubbleCoords=i.bubbleStates.map(R=>R.coords),ie.bubbleAngles=i.bubbleStates.map(R=>R.rotationAngle||0),ie.autoDirections=i.bubbleStates.map(R=>R.autoTextDirection||R.textDirection||"vertical"),ie.originalTexts=i.bubbleStates.map(R=>R.originalText||""),ie.translatedTexts=i.bubbleStates.map(R=>R.translatedText||""),ie.textboxTexts=i.bubbleStates.map(R=>R.textboxText||""),ie.colors=i.bubbleStates.map(R=>({textColor:R.textColor||"",bgColor:R.fillColor||"",autoFgColor:R.autoFgColor||null,autoBgColor:R.autoBgColor||null})),i.cleanImageData&&(ie.cleanImage=i.cleanImageData)),ie});try{a.init(T.length,`${r.mode} æ¨¡å¼å¯åŠ¨...`),b&&(a.setPercentage(0,"é¢„ä¿å­˜åŸå§‹å›¾ç‰‡..."),await Bn({onStart:R=>{a.setPercentage(0,`é¢„ä¿å­˜åŸå§‹å›¾ç‰‡ 0/${R}...`)},onProgress:(R,Y)=>{const ce=Math.round(R/Y*10);a.setPercentage(ce,`é¢„ä¿å­˜åŸå§‹å›¾ç‰‡ ${R}/${Y}...`)},onComplete:()=>{a.setPercentage(10,"é¢„ä¿å­˜å®Œæˆï¼Œå¼€å§‹ç¿»è¯‘...")},onError:R=>{a.setPercentage(0,`é¢„ä¿å­˜å¤±è´¥: ${R}`)}})||l.warning("é¢„ä¿å­˜å¤±è´¥ï¼Œç¿»è¯‘å®Œæˆåè¯·æ‰‹åŠ¨ä¿å­˜"));let i;I?i=await ae(W,L,r,g):i=await A(W,L,r,g),a.setPercentage(100,"å®Œæˆï¼");const x={standard:"ç¿»è¯‘",hq:"é«˜è´¨é‡ç¿»è¯‘",proofread:"AIæ ¡å¯¹",removeText:"æ¶ˆé™¤æ–‡å­—"};return l.success(`${x[r.mode]}å®Œæˆï¼`),{success:i.failed===0,completed:i.completed,failed:i.failed,errors:g.length>0?g:void 0}}catch(i){const x=i instanceof Error?i.message:"æ‰§è¡Œå¤±è´¥";return l.error(x),g.push(x),{success:!1,completed:0,failed:T.length,errors:g}}finally{c.value=!1,n.setBatchTranslationInProgress(!1),b&&await Ln();const i=n.currentImageIndex,x=n.images[i];x?.bubbleStates&&x.bubbleStates.length>0&&t.setBubbles(x.bubbleStates),setTimeout(()=>a.finish(),1e3)}}function $(){n.isBatchTranslationInProgress&&(n.setBatchTranslationInProgress(!1),Fn(),l.info("æ“ä½œå·²å–æ¶ˆ"))}return{progress:u,isExecuting:c,isTranslating:S,progressPercent:D,execute:d,cancel:$,STEP_CHAIN_CONFIGS:mn}}class vi{currentCount=0;maxCount;waitQueue=[];holders=[];constructor(t=1){this.maxCount=Math.max(1,t)}setSize(t){this.maxCount=Math.max(1,t),this.tryWakeUp()}getSize(){return this.maxCount}async acquire(t){if(this.currentCount<this.maxCount){this.currentCount++,this.holders.push(t);return}return new Promise(s=>{this.waitQueue.push({resolve:s,poolName:t})})}release(t){const s=this.holders.indexOf(t);s>=0&&(this.holders.splice(s,1),this.currentCount--),this.tryWakeUp()}tryWakeUp(){for(;this.currentCount<this.maxCount&&this.waitQueue.length>0;){const t=this.waitQueue.shift();this.currentCount++,this.holders.push(t.poolName),t.resolve()}}async withLock(t,s){await this.acquire(t);try{return await s()}finally{this.release(t)}}getStatus(){return{isLocked:this.currentCount>=this.maxCount,currentCount:this.currentCount,maxCount:this.maxCount,holders:[...this.holders],waitingCount:this.waitQueue.length,waitingPools:this.waitQueue.map(t=>t.poolName)}}isWaiting(t){return this.waitQueue.some(s=>s.poolName===t)}isHolding(t){return this.holders.includes(t)}reset(){this.currentCount=0,this.holders=[];for(const t of this.waitQueue)t.resolve();this.waitQueue=[]}}class Rt{queue=[];currentTask=null;isRunning=!1;isCancelled=!1;completedCount=0;nextPool;name;icon;lock;progressTracker;onTaskComplete;constructor(t,s,o,l,u,a){this.name=t,this.icon=s,this.nextPool=o,this.lock=l,this.progressTracker=u,this.onTaskComplete=a}getName(){return this.name}getIcon(){return this.icon}setNextPool(t){this.nextPool=t}enqueue(t){this.isCancelled||(this.queue.push(t),this.progressTracker.updatePool(this.name,{waiting:this.queue.length}),this.tryProcessNext())}enqueueBatch(t){if(!this.isCancelled){for(const s of t)this.queue.push(s);this.progressTracker.updatePool(this.name,{waiting:this.queue.length}),this.tryProcessNext()}}async tryProcessNext(){if(!(this.isRunning||this.isCancelled||this.queue.length===0)){this.isRunning=!0,this.currentTask=this.queue.shift(),this.progressTracker.updatePool(this.name,{waiting:this.queue.length,isProcessing:!0,currentPage:this.currentTask.imageIndex+1,isWaitingLock:!1});try{let t;this.lock?(this.progressTracker.updatePool(this.name,{isWaitingLock:!0}),t=await this.lock.withLock(this.name,async()=>(this.progressTracker.updatePool(this.name,{isWaitingLock:!1}),await this.process(this.currentTask)))):t=await this.process(this.currentTask),this.completedCount++,this.progressTracker.updatePool(this.name,{completed:this.completedCount}),this.nextPool&&t.status!=="failed"&&t.status!=="buffered"&&this.nextPool.enqueue(t),this.onTaskComplete?.(t)}catch(t){this.currentTask.status="failed",this.currentTask.error=t.message,console.error(`[${this.name}] å¤„ç†ä»»åŠ¡å¤±è´¥:`,t),this.onTaskComplete?.(this.currentTask)}finally{this.currentTask=null,this.isRunning=!1,this.progressTracker.updatePool(this.name,{isProcessing:!1,currentPage:void 0}),this.tryProcessNext()}}}getStatus(){return{name:this.name,icon:this.icon,waiting:this.queue.length,processing:this.isRunning,currentPage:this.currentTask?.imageIndex,completed:this.completedCount,isWaitingLock:this.lock?.isWaiting(this.name)??!1}}cancel(){this.isCancelled=!0,this.queue=[]}reset(){this.isCancelled=!1,this.queue=[],this.currentTask=null,this.isRunning=!1,this.completedCount=0}getCompletedCount(){return this.completedCount}getWaitingCount(){return this.queue.length}isProcessing(){return this.isRunning}}const fi=[{name:"æ£€æµ‹",icon:"ğŸ“"},{name:"OCR",icon:"ğŸ“–"},{name:"é¢œè‰²",icon:"ğŸ¨"},{name:"ç¿»è¯‘",icon:"ğŸŒ"},{name:"ä¿®å¤",icon:"ğŸ–Œï¸"},{name:"æ¸²æŸ“",icon:"âœ¨"}];class bi{poolStatuses=new Map;totalPages=0;startTime=0;progress=ho({pools:[],totalCompleted:0,totalFailed:0,totalPages:0,estimatedTimeRemaining:0});constructor(){this.initPools()}initPools(){for(const t of fi){const s={name:t.name,icon:t.icon,waiting:0,processing:!1,completed:0,isWaitingLock:!1};this.poolStatuses.set(t.name,s)}this.syncToReactive()}init(t){this.totalPages=t,this.startTime=Date.now();for(const s of this.poolStatuses.values())s.waiting=0,s.processing=!1,s.currentPage=void 0,s.completed=0,s.isWaitingLock=!1;this.progress.totalCompleted=0,this.progress.totalFailed=0,this.progress.totalPages=t,this.progress.estimatedTimeRemaining=0,this.syncToReactive()}updatePool(t,s){const o=this.poolStatuses.get(t);o&&(s.waiting!==void 0&&(o.waiting=s.waiting),s.isProcessing!==void 0&&(o.processing=s.isProcessing),s.currentPage!==void 0&&(o.currentPage=s.currentPage),s.completed!==void 0&&(o.completed=s.completed),s.isWaitingLock!==void 0&&(o.isWaitingLock=s.isWaitingLock),this.syncToReactive(),this.updateEstimatedTime())}incrementCompleted(){this.progress.totalCompleted++,this.updateEstimatedTime()}incrementFailed(){this.progress.totalFailed++}updateEstimatedTime(){if(this.progress.totalCompleted===0){this.progress.estimatedTimeRemaining=0;return}const s=(Date.now()-this.startTime)/1e3/this.progress.totalCompleted,o=this.totalPages-this.progress.totalCompleted-this.progress.totalFailed;this.progress.estimatedTimeRemaining=Math.ceil(s*o)}syncToReactive(){this.progress.pools=Array.from(this.poolStatuses.values()).map(t=>({...t}))}getPoolStatus(t){return this.poolStatuses.get(t)}getAllPoolStatuses(){return Array.from(this.poolStatuses.values())}getProgress(){return{...this.progress}}reset(){this.totalPages=0,this.startTime=0,this.initPools()}formatRemainingTime(){const t=this.progress.estimatedTimeRemaining;if(t<=0)return"--";const s=Math.floor(t/60),o=t%60;return s>0?`${s}åˆ†${o}ç§’`:`${o}ç§’`}}class hi{results=new Map;totalExpected=0;completedCount=0;failedCount=0;resolveWaitAll=null;init(t){this.results.clear(),this.totalExpected=t,this.completedCount=0,this.failedCount=0,this.resolveWaitAll=null}add(t){this.results.set(t.imageIndex,t),t.status==="completed"?this.completedCount++:t.status==="failed"&&this.failedCount++,this.completedCount+this.failedCount>=this.totalExpected&&this.resolveWaitAll&&(this.resolveWaitAll({success:this.completedCount,failed:this.failedCount}),this.resolveWaitAll=null)}waitForAll(t){return this.totalExpected=t,this.completedCount+this.failedCount>=t?Promise.resolve({success:this.completedCount,failed:this.failedCount}):new Promise(s=>{this.resolveWaitAll=s})}get(t){return this.results.get(t)}getAll(){return Array.from(this.results.values()).sort((t,s)=>t.imageIndex-s.imageIndex)}getSuccessful(){return this.getAll().filter(t=>t.status==="completed")}getFailed(){return this.getAll().filter(t=>t.status==="failed")}getStats(){return{total:this.totalExpected,completed:this.completedCount,failed:this.failedCount,pending:this.totalExpected-this.completedCount-this.failedCount}}reset(){this.results.clear(),this.totalExpected=0,this.completedCount=0,this.failedCount=0,this.resolveWaitAll=null}}class xi extends Rt{constructor(t,s,o,l){super("æ£€æµ‹","ğŸ“",t,s,o,l)}async process(t){const{imageData:s}=t,l=Ne().settings,u=s.bubbleStates;if(u!=null)return u.length>0?(console.log(`[æ£€æµ‹æ± ] å›¾ç‰‡ ${t.imageIndex+1} å·²æœ‰ ${u.length} ä¸ªæ°”æ³¡ï¼Œè·³è¿‡æ£€æµ‹`),t.detectionResult={bubbleCoords:u.map(v=>v.coords.map(p=>Math.round(p))),bubbleAngles:u.map(v=>v.rotationAngle||0),bubblePolygons:u.map(v=>v.polygon||[]),autoDirections:u.map(v=>v.autoTextDirection||v.textDirection||"vertical"),rawMask:void 0,textlinesPerBubble:[]}):(console.log(`[æ£€æµ‹æ± ] å›¾ç‰‡ ${t.imageIndex+1} æ°”æ³¡å·²è¢«æ¸…ç©ºï¼Œè·³è¿‡æ£€æµ‹`),t.detectionResult={bubbleCoords:[],bubbleAngles:[],bubblePolygons:[],autoDirections:[],rawMask:void 0,textlinesPerBubble:[]}),t.status="processing",t;const a=this.extractBase64(s.originalDataURL),c=await ko({image:a,detector_type:l.textDetector,box_expand_ratio:l.boxExpand.ratio,box_expand_top:l.boxExpand.top,box_expand_bottom:l.boxExpand.bottom,box_expand_left:l.boxExpand.left,box_expand_right:l.boxExpand.right});if(!c.success)throw new Error(c.error||"æ£€æµ‹å¤±è´¥");return t.detectionResult={bubbleCoords:c.bubble_coords||[],bubbleAngles:c.bubble_angles||[],bubblePolygons:c.bubble_polygons||[],autoDirections:c.auto_directions||[],rawMask:c.raw_mask,textlinesPerBubble:c.textlines_per_bubble||[]},t.status="processing",t}extractBase64(t){return t.includes("base64,")?t.split("base64,")[1]||"":t}}class yi extends Rt{constructor(t,s,o,l){super("OCR","ğŸ“–",t,s,o,l)}async process(t){const{imageData:s,detectionResult:o}=t,u=Ne().settings;if(!o||o.bubbleCoords.length===0)return t.ocrResult={originalTexts:[],textlinesPerBubble:[]},t.status="processing",t;const a=this.extractBase64(s.originalDataURL),c=u.ocrEngine==="paddleocr_vl"?u.paddleOcrVl?.sourceLanguage||"japanese":u.sourceLanguage,v=await wo({image:a,bubble_coords:o.bubbleCoords,source_language:c,ocr_engine:u.ocrEngine,baidu_api_key:u.baiduOcr?.apiKey,baidu_secret_key:u.baiduOcr?.secretKey,baidu_version:u.baiduOcr?.version,baidu_ocr_language:u.baiduOcr?.sourceLanguage,ai_vision_provider:u.aiVisionOcr?.provider,ai_vision_api_key:u.aiVisionOcr?.apiKey,ai_vision_model_name:u.aiVisionOcr?.modelName,ai_vision_ocr_prompt:u.aiVisionOcr?.prompt,custom_ai_vision_base_url:u.aiVisionOcr?.customBaseUrl,ai_vision_min_image_size:u.aiVisionOcr?.minImageSize??cs,textlines_per_bubble:o.textlinesPerBubble});if(!v.success)throw new Error(v.error||"OCRå¤±è´¥");return t.ocrResult={originalTexts:v.original_texts||[],textlinesPerBubble:v.textlines_per_bubble||[]},t.status="processing",t}extractBase64(t){return t.includes("base64,")?t.split("base64,")[1]||"":t}}class _i extends Rt{constructor(t,s,o,l){super("é¢œè‰²","ğŸ¨",t,s,o,l)}async process(t){const{imageData:s,detectionResult:o,ocrResult:l}=t;if(!o||o.bubbleCoords.length===0)return t.colorResult={colors:[]},t.status="processing",t;const u=this.extractBase64(s.originalDataURL),a=await $o({image:u,bubble_coords:o.bubbleCoords,textlines_per_bubble:l?.textlinesPerBubble||o.textlinesPerBubble});if(!a.success)throw new Error(a.error||"é¢œè‰²æå–å¤±è´¥");return t.colorResult={colors:a.colors||[]},t.status="processing",t}extractBase64(t){return t.includes("base64,")?t.split("base64,")[1]||"":t}}class Ci extends Rt{mode="standard";batchBuffer=[];totalTasks=0;processedCount=0;constructor(t,s,o){super("ç¿»è¯‘","ğŸŒ",t,null,s,o)}setMode(t,s,o){this.mode=t,this.totalTasks=s,this.batchBuffer=[],this.processedCount=0,this.nextPool=o}async process(t){switch(this.mode){case"standard":return this.handleStandardTranslate(t);case"hq":return this.handleHqTranslate(t);case"proofread":return this.handleProofread(t);case"removeText":return this.handleRemoveTextOnly(t);default:return t}}async handleStandardTranslate(t){const o=Ne().settings;if(!t.ocrResult||t.ocrResult.originalTexts.length===0)return t.translateResult={translatedTexts:[],textboxTexts:[]},t.status="processing",t;const l=o.translation.translationMode||"batch",u=t.ocrResult.originalTexts;if(l==="single"){console.log(`[å¹¶è¡Œç¿»è¯‘æ± ] ä½¿ç”¨é€æ°”æ³¡ç¿»è¯‘æ¨¡å¼ï¼Œå›¾ç‰‡ ${t.imageIndex}ï¼Œå…± ${u.length} ä¸ªæ°”æ³¡`);const a=[],c=[];for(let v=0;v<u.length;v++){const p=u[v];if(!p||p.trim()===""){a.push(""),o.useTextboxPrompt&&c.push("");continue}try{const _=await At({original_text:p,model_provider:o.translation.provider,model_name:o.translation.modelName,api_key:o.translation.apiKey,custom_base_url:o.translation.customBaseUrl,target_language:o.targetLanguage,prompt_content:o.translatePrompt,use_json_format:o.translation.isJsonMode,rpm_limit_translation:o.translation.rpmLimit,max_retries:o.translation.maxRetries});if(_.success&&_.data?a.push(_.data.translated_text||""):(console.warn(`[å¹¶è¡Œç¿»è¯‘æ± ] æ°”æ³¡ ${v+1} ç¿»è¯‘å¤±è´¥: ${_.error}`),a.push("[ç¿»è¯‘å¤±è´¥]")),o.useTextboxPrompt&&o.textboxPrompt){const S=await At({original_text:p,model_provider:o.translation.provider,model_name:o.translation.modelName,api_key:o.translation.apiKey,custom_base_url:o.translation.customBaseUrl,target_language:o.targetLanguage,prompt_content:o.textboxPrompt,rpm_limit_translation:o.translation.rpmLimit,max_retries:o.translation.maxRetries});S.success&&S.data?c.push(S.data.translated_text||""):c.push("")}}catch(_){console.error(`[å¹¶è¡Œç¿»è¯‘æ± ] æ°”æ³¡ ${v+1} ç¿»è¯‘å‡ºé”™:`,_),a.push("[ç¿»è¯‘å‡ºé”™]"),o.useTextboxPrompt&&c.push("")}}t.translateResult={translatedTexts:a,textboxTexts:c}}else{console.log(`[å¹¶è¡Œç¿»è¯‘æ± ] ä½¿ç”¨æ•´é¡µæ‰¹é‡ç¿»è¯‘æ¨¡å¼ï¼Œå›¾ç‰‡ ${t.imageIndex}ï¼Œå…± ${u.length} ä¸ªæ°”æ³¡`);const a=await To({original_texts:u,target_language:o.targetLanguage,source_language:o.sourceLanguage,model_provider:o.translation.provider,model_name:o.translation.modelName,api_key:o.translation.apiKey,custom_base_url:o.translation.customBaseUrl,prompt_content:o.translatePrompt,textbox_prompt_content:o.textboxPrompt,use_textbox_prompt:o.useTextboxPrompt,rpm_limit:o.translation.rpmLimit,max_retries:o.translation.maxRetries,use_json_format:o.translation.isJsonMode});if(!a.success)throw new Error(a.error||"ç¿»è¯‘å¤±è´¥");t.translateResult={translatedTexts:a.translated_texts||[],textboxTexts:a.textbox_texts||[]}}return t.status="processing",t}async handleHqTranslate(t){this.batchBuffer.push(t),this.processedCount++;const s=Ne(),{hqTranslation:o}=s.settings,l=o.batchSize||3,u=this.processedCount>=this.totalTasks;if(!(this.batchBuffer.length>=l||u))return t.status="buffered",t;const c=[...this.batchBuffer];this.batchBuffer=[];const v=c.map(P=>({imageIndex:P.imageIndex,bubbles:(P.ocrResult?.originalTexts||[]).map((q,V)=>({bubbleIndex:V,original:q,translated:"",textDirection:P.detectionResult?.autoDirections[V]||"vertical"}))})),p=c.map(P=>this.extractBase64(P.imageData.originalDataURL)),_=JSON.stringify(v,null,2),S=[{type:"text",text:o.prompt+`

ä»¥ä¸‹æ˜¯JSONæ•°æ®:
\`\`\`json
`+_+"\n```"}];for(const P of p)S.push({type:"image_url",image_url:{url:`data:image/png;base64,${P}`}});const D=[{role:"system",content:"ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ¼«ç”»ç¿»è¯‘åŠ©æ‰‹ï¼Œèƒ½å¤Ÿæ ¹æ®æ¼«ç”»å›¾åƒå†…å®¹å’Œä¸Šä¸‹æ–‡æä¾›é«˜è´¨é‡çš„ç¿»è¯‘ã€‚"},{role:"user",content:S}],M=await Lt({provider:o.provider,api_key:o.apiKey,model_name:o.modelName,custom_base_url:o.customBaseUrl,messages:D,low_reasoning:o.lowReasoning,force_json_output:o.forceJsonOutput,no_thinking_method:o.noThinkingMethod,use_stream:o.useStream,max_retries:o.maxRetries||2}),E=this.parseHqResponse(M,o.forceJsonOutput);for(const P of c){const q=E?.find(V=>V.imageIndex===P.imageIndex);q?P.translateResult={translatedTexts:q.bubbles.map(V=>V.translated),textboxTexts:[]}:P.translateResult={translatedTexts:[],textboxTexts:[]},P.status="processing",this.nextPool&&this.nextPool.enqueue(P)}return t}async handleProofread(t){this.batchBuffer.push(t),this.processedCount++;const s=Ne(),{proofreading:o,useTextboxPrompt:l}=s.settings,u=o.rounds[0]?.batchSize||3,a=this.processedCount>=this.totalTasks;if(!(this.batchBuffer.length>=u||a))return t.status="buffered",t;const v=[...this.batchBuffer];this.batchBuffer=[];const p=v.map(D=>({imageIndex:D.imageIndex,bubbles:(D.imageData.bubbleStates||[]).map((M,E)=>({bubbleIndex:E,original:M.originalText||"",translated:l?M.textboxText||M.translatedText||"":M.translatedText||"",textDirection:M.textDirection==="vertical"||M.textDirection==="horizontal"?M.textDirection:M.autoTextDirection==="vertical"||M.autoTextDirection==="horizontal"?M.autoTextDirection:"vertical"}))})),_=v.map(D=>{const M=D.imageData.translatedDataURL||D.imageData.originalDataURL;return this.extractBase64(M)});let S=p;for(const D of o.rounds){const M=JSON.stringify(S,null,2),E=[{type:"text",text:D.prompt+`

ä»¥ä¸‹æ˜¯JSONæ•°æ®:
\`\`\`json
`+M+"\n```"}];for(const U of _)E.push({type:"image_url",image_url:{url:`data:image/png;base64,${U}`}});const P=[{role:"system",content:"ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ¼«ç”»ç¿»è¯‘æ ¡å¯¹åŠ©æ‰‹ï¼Œèƒ½å¤Ÿæ ¹æ®æ¼«ç”»å›¾åƒå†…å®¹æ£€æŸ¥å’Œä¿®æ­£ç¿»è¯‘ã€‚"},{role:"user",content:E}],q=await Lt({provider:D.provider,api_key:D.apiKey,model_name:D.modelName,custom_base_url:D.customBaseUrl,messages:P,low_reasoning:D.lowReasoning,force_json_output:D.forceJsonOutput,no_thinking_method:D.noThinkingMethod,use_stream:!1,max_retries:D.maxRetries||o.maxRetries||2}),V=this.parseHqResponse(q,D.forceJsonOutput);V&&(S=V)}for(const D of v){const M=S.find(E=>E.imageIndex===D.imageIndex);M?D.translateResult={translatedTexts:M.bubbles.map(E=>E.translated),textboxTexts:[]}:D.translateResult={translatedTexts:[],textboxTexts:[]},D.status="processing",this.nextPool&&this.nextPool.enqueue(D)}return t}async handleRemoveTextOnly(t){return t.translateResult={translatedTexts:[],textboxTexts:[]},t.status="processing",t}extractBase64(t){return t.includes("base64,")?t.split("base64,")[1]||"":t}parseHqResponse(t,s){if(!t.success)return console.error("APIè°ƒç”¨å¤±è´¥:",t.error),null;if(t.results&&t.results.length>0){const l=t.results[0];if(l&&"imageIndex"in l&&"bubbles"in l)return t.results}const o=t.content;if(o)if(s)try{return JSON.parse(o)}catch(l){return console.error("è§£æAIå¼ºåˆ¶JSONè¿”å›çš„å†…å®¹å¤±è´¥:",l),null}else{const l=o.match(/```json\s*([\s\S]*?)\s*```/);if(l?.[1])try{return JSON.parse(l[1])}catch(u){return console.error("è§£æAIè¿”å›çš„JSONå¤±è´¥:",u),null}}return null}}class Si extends Rt{constructor(t,s,o,l){super("ä¿®å¤","ğŸ–Œï¸",t,s,o,l)}async process(t){const{imageData:s,detectionResult:o}=t,u=Ne().settings;if(!o||o.bubbleCoords.length===0)return t.inpaintResult={cleanImage:this.extractBase64(s.originalDataURL)},t.status="processing",t;const a=this.extractBase64(s.originalDataURL),c=u.textStyle.inpaintMethod,v=c==="lama_mpe"||c==="litelama",p=await Io({image:a,bubble_coords:o.bubbleCoords,bubble_polygons:o.bubblePolygons,raw_mask:o.rawMask,method:v?"lama":"solid",lama_model:v?c:void 0,fill_color:u.textStyle.fillColor,mask_dilate_size:u.preciseMask.dilateSize,mask_box_expand_ratio:u.preciseMask.boxExpandRatio});if(!p.success)throw new Error(p.error||"ä¿®å¤å¤±è´¥");return t.inpaintResult={cleanImage:p.clean_image||""},t.status="processing",t}extractBase64(t){return t.includes("base64,")?t.split("base64,")[1]||"":t}}const ft=ho({pools:[{name:"æ£€æµ‹",icon:"ğŸ“",waiting:0,processing:!1,completed:0,isWaitingLock:!1},{name:"OCR",icon:"ğŸ“–",waiting:0,processing:!1,completed:0,isWaitingLock:!1},{name:"é¢œè‰²",icon:"ğŸ¨",waiting:0,processing:!1,completed:0,isWaitingLock:!1},{name:"ç¿»è¯‘",icon:"ğŸŒ",waiting:0,processing:!1,completed:0,isWaitingLock:!1},{name:"ä¿®å¤",icon:"ğŸ–Œï¸",waiting:0,processing:!1,completed:0,isWaitingLock:!1},{name:"æ¸²æŸ“",icon:"âœ¨",waiting:0,processing:!1,completed:0,isWaitingLock:!1}],totalCompleted:0,totalFailed:0,totalPages:0,estimatedTimeRemaining:0,preSave:void 0,save:void 0}),ki=w(!1);function Do(){const n=et(),t=Ne(),s=ys(null),o=Z(()=>t.settings.parallel),l=Z(()=>o.value?.enabled??!1),u=ki,a=Z(()=>ft);function c(){const D=t.settings;return D.proofreading?.enabled&&D.proofreading.rounds.length>0?"proofread":["gemini","openai","claude","deepseek"].includes(D.hqTranslation?.provider||"")&&D.hqTranslation?.apiKey?"hq":"standard"}function v(){if(!s.value)return;const D=s.value.progress;D&&(ft.pools=D.pools.map(M=>({...M})),ft.totalCompleted=D.totalCompleted,ft.totalFailed=D.totalFailed,ft.totalPages=D.totalPages,ft.estimatedTimeRemaining=D.estimatedTimeRemaining)}async function p(D,M,E=0){if(u.value)return{success:0,failed:0,errors:["ç¿»è¯‘æ­£åœ¨è¿›è¡Œä¸­"]};const P=M??n.images;if(P.length===0)return{success:0,failed:0,errors:["æ²¡æœ‰å›¾ç‰‡"]};u.value=!0,ft.totalPages=P.length,ft.totalCompleted=0,ft.totalFailed=0;const q=setInterval(v,200);try{s.value=Ti({enabled:!0,deepLearningLockSize:o.value?.deepLearningLockSize??1});const V=D??c();console.log(`ğŸš€ å¼€å§‹å¹¶è¡Œç¿»è¯‘ï¼Œæ¨¡å¼: ${V}ï¼Œå›¾ç‰‡æ•°: ${P.length}ï¼Œèµ·å§‹ç´¢å¼•: ${E}`);const U=await s.value.execute(P,V,E);return v(),console.log(`âœ… å¹¶è¡Œç¿»è¯‘å®Œæˆï¼ŒæˆåŠŸ: ${U.success}ï¼Œå¤±è´¥: ${U.failed}`),U}catch(V){return console.error("å¹¶è¡Œç¿»è¯‘å‡ºé”™:",V),{success:0,failed:P.length,errors:[V.message]}}finally{clearInterval(q),u.value=!1}}function _(){s.value&&s.value.cancel(),u.value=!1}function S(){s.value=null,u.value=!1}return{isEnabled:l,isRunning:u,progress:a,executeParallel:p,cancel:_,reset:S,determineMode:c}}class wi extends Rt{resultCollector;constructor(t,s,o){super("æ¸²æŸ“","âœ¨",null,null,t,o),this.resultCollector=s}async process(t){const s=et(),o=gt(),l=Ne(),u=this.buildBubbleStates(t,l);if(u.length===0){const v=t.inpaintResult?.cleanImage||t.imageData.cleanImageData||this.extractBase64(t.imageData.originalDataURL);return t.renderResult={finalImage:v,bubbleStates:[]},t.status="completed",this.updateImageToUI(t,s,o,l),this.resultCollector.add(t),t}const a=t.inpaintResult?.cleanImage||t.imageData.cleanImageData||this.extractBase64(t.imageData.translatedDataURL||t.imageData.originalDataURL),c=await Po({clean_image:a,bubble_states:u,fontSize:l.settings.textStyle.fontSize,fontFamily:l.settings.textStyle.fontFamily,textDirection:l.settings.textStyle.layoutDirection,textColor:l.settings.textStyle.textColor,strokeEnabled:l.settings.textStyle.strokeEnabled,strokeColor:l.settings.textStyle.strokeColor,strokeWidth:l.settings.textStyle.strokeWidth,autoFontSize:l.settings.textStyle.autoFontSize,use_individual_styles:!0});if(!c.success)throw new Error(c.error||"æ¸²æŸ“å¤±è´¥");return t.renderResult={finalImage:c.final_image||"",bubbleStates:c.bubble_states||u},t.status="completed",this.updateImageToUI(t,s,o,l),this.resultCollector.add(t),t}updateImageToUI(t,s,o,l){const u=t.imageIndex,a=(t.detectionResult?.bubbleCoords||[]).map(c=>c.length>=4?[c[0],c[1],c[2],c[3]]:[0,0,0,0]);s.updateImageByIndex(u,{translatedDataURL:`data:image/png;base64,${t.renderResult.finalImage}`,cleanImageData:t.inpaintResult?.cleanImage||null,bubbleStates:t.renderResult.bubbleStates,bubbleCoords:a,bubbleAngles:t.detectionResult?.bubbleAngles||[],originalTexts:t.ocrResult?.originalTexts||[],bubbleTexts:t.translateResult?.translatedTexts||[],textboxTexts:t.translateResult?.textboxTexts||[],translationStatus:"completed",translationFailed:!1,showOriginal:!1,hasUnsavedChanges:!0,fontSize:l.settings.textStyle.fontSize,autoFontSize:l.settings.textStyle.autoFontSize,fontFamily:l.settings.textStyle.fontFamily,layoutDirection:l.settings.textStyle.layoutDirection,textColor:l.settings.textStyle.textColor,fillColor:l.settings.textStyle.fillColor,strokeEnabled:l.settings.textStyle.strokeEnabled,strokeColor:l.settings.textStyle.strokeColor,strokeWidth:l.settings.textStyle.strokeWidth,inpaintMethod:l.settings.textStyle.inpaintMethod,useAutoTextColor:l.settings.textStyle.useAutoTextColor}),u===s.currentImageIndex&&t.renderResult?.bubbleStates&&o.setBubbles(t.renderResult.bubbleStates),this.progressTracker.incrementCompleted(),Pt()&&An(u).catch(c=>{console.error(`[RenderPool] è‡ªåŠ¨ä¿å­˜å›¾ç‰‡ ${u+1} å¤±è´¥:`,c)}).finally(()=>{const{progress:c}=Do(),v=c.value;v.save&&(v.save.completed=(v.save.completed||0)+1)}),console.log(`âœ… å›¾ç‰‡ ${u+1} æ¸²æŸ“å®Œæˆ`)}buildBubbleStates(t,s){if(!t.detectionResult&&t.imageData.bubbleStates&&t.imageData.bubbleStates.length>0){const S=t.translateResult?.translatedTexts||[];return t.imageData.bubbleStates.map((D,M)=>({...D,translatedText:S[M]||D.translatedText||""}))}if(t.detectionResult&&!t.translateResult)return console.log(`[æ¸²æŸ“æ± ] å›¾ç‰‡ ${t.imageIndex+1}: æ£€æµ‹åˆ°æ¶ˆé™¤æ–‡å­—æ¨¡å¼ï¼ˆæ— ç¿»è¯‘ç»“æœï¼‰ï¼Œè·³è¿‡æ¸²æŸ“`),[];const o=t.detectionResult?.bubbleCoords||[],l=t.translateResult?.translatedTexts||[],u=t.ocrResult?.originalTexts||[],a=t.colorResult?.colors||[],c=t.detectionResult?.bubbleAngles||[],v=t.detectionResult?.autoDirections||[],p=t.detectionResult?.bubblePolygons||[],_=s.settings;return o.map((S,D)=>{const M=v[D],E=M==="v"?"vertical":M==="h"?"horizontal":"vertical",P=_.textStyle.layoutDirection,q=P==="vertical"||P==="horizontal"?P:E;let V=_.textStyle.textColor,U=_.textStyle.fillColor;const f=a[D];return _.textStyle.useAutoTextColor&&f&&(f.textColor&&(V=f.textColor),f.bgColor&&(U=f.bgColor)),{originalText:u[D]||"",translatedText:l[D]||"",textboxText:"",coords:S.length>=4?[S[0],S[1],S[2],S[3]]:[0,0,0,0],polygon:p[D]||[],fontSize:_.textStyle.fontSize,fontFamily:_.textStyle.fontFamily,textDirection:q,autoTextDirection:E,textColor:V,fillColor:U,rotationAngle:c[D]||0,position:{x:0,y:0},strokeEnabled:_.textStyle.strokeEnabled,strokeColor:_.textStyle.strokeColor,strokeWidth:_.textStyle.strokeWidth,inpaintMethod:_.textStyle.inpaintMethod,autoFgColor:f?.autoFgColor||null,autoBgColor:f?.autoBgColor||null}})}extractBase64(t){return t.includes("base64,")?t.split("base64,")[1]||"":t}}const vn={standard:["detection","ocr","color","translate","inpaint","render"],hq:["detection","ocr","color","translate","inpaint","render"],proofread:["translate","render"],removeText:["detection","inpaint","render"]};class $i{lock;progressTracker;resultCollector;detectionPool;ocrPool;colorPool;translatePool;inpaintPool;renderPool;isCancelled=!1;config;constructor(t){this.config=t,this.lock=new vi(t.deepLearningLockSize),this.progressTracker=new bi,this.resultCollector=new hi,this.renderPool=new wi(this.progressTracker,this.resultCollector),this.inpaintPool=new Si(this.renderPool,this.lock,this.progressTracker),this.translatePool=new Ci(this.inpaintPool,this.progressTracker),this.colorPool=new _i(this.translatePool,this.lock,this.progressTracker),this.ocrPool=new yi(this.colorPool,this.lock,this.progressTracker),this.detectionPool=new xi(this.ocrPool,this.lock,this.progressTracker)}updateConfig(t){t.deepLearningLockSize!==void 0&&(this.lock.setSize(t.deepLearningLockSize),this.config.deepLearningLockSize=t.deepLearningLockSize),t.enabled!==void 0&&(this.config.enabled=t.enabled)}async execute(t,s,o=0){this.reset(),this.progressTracker.init(t.length),this.resultCollector.init(t.length),this.setupPoolChain(s,t.length);const l=t.map((c,v)=>({id:`task-${o+v}`,imageIndex:o+v,imageData:c,status:"pending"})),u=this.getEntryPool(s);for(const c of l)u.enqueue(c);const a=await this.resultCollector.waitForAll(t.length);return{success:a.success,failed:a.failed,errors:this.resultCollector.getFailed().map(c=>c.error||"æœªçŸ¥é”™è¯¯")}}setupPoolChain(t,s){const o=vn[t],l=this.getPoolMap();for(let v=0;v<o.length-1;v++){const p=o[v],_=o[v+1],S=l[p],D=l[_];S&&D&&S.setNextPool(D)}const u=o[o.length-1],a=l[u];a&&a.setNextPool(null);const c=o.indexOf("translate");if(c>=0&&c<o.length-1){const v=o[c+1];this.translatePool.setMode(t,s,l[v]||null)}else c===o.length-1&&this.translatePool.setMode(t,s,null)}getPoolMap(){return{detection:this.detectionPool,ocr:this.ocrPool,color:this.colorPool,translate:this.translatePool,inpaint:this.inpaintPool,render:this.renderPool}}getEntryPool(t){const o=vn[t][0];return this.getPoolMap()[o]||this.detectionPool}cancel(){this.isCancelled=!0,this.detectionPool.cancel(),this.ocrPool.cancel(),this.colorPool.cancel(),this.translatePool.cancel(),this.inpaintPool.cancel(),this.renderPool.cancel(),this.lock.reset()}reset(){this.isCancelled=!1,this.detectionPool.reset(),this.ocrPool.reset(),this.colorPool.reset(),this.translatePool.reset(),this.inpaintPool.reset(),this.renderPool.reset(),this.resultCollector.reset(),this.progressTracker.reset()}get progress(){return this.progressTracker.progress}getProgressTracker(){return this.progressTracker}getLockStatus(){return this.lock.getStatus()}get cancelled(){return this.isCancelled}}function Ti(n){return new $i(n)}function Ii(){const n=et(),t=Ne(),s=ct(),o=mi(),l=Do(),u=Z(()=>o.isTranslating.value||n.isBatchTranslationInProgress),a=Z(()=>o.progressPercent.value);async function c(_){if(n.images.length===0)return s.error("è¯·å…ˆä¸Šä¼ å›¾ç‰‡"),{success:!1,completed:0,failed:0,errors:["æ²¡æœ‰å›¾ç‰‡"]};const S=t.settings.parallel,D=_.scope==="all"||_.scope==="range";return S?.enabled&&D?(console.log(`ğŸš€ ä½¿ç”¨å¹¶è¡Œç®¡çº¿ï¼Œæ¨¡å¼: ${_.mode}, èŒƒå›´: ${_.scope}`),v(_)):(console.log(`ğŸš€ ä½¿ç”¨é¡ºåºç®¡çº¿ï¼Œæ¨¡å¼: ${_.mode}`),o.execute(_))}async function v(_){let S=n.images,D=0;if(_.scope==="range"&&_.pageRange){D=Math.max(0,_.pageRange.startPage-1);const E=Math.min(n.images.length-1,_.pageRange.endPage-1);if(D<=E&&D<n.images.length)S=n.images.slice(D,E+1),console.log(`ğŸ¯ å¹¶è¡Œç¿»è¯‘èŒƒå›´: ç¬¬ ${_.pageRange.startPage} è‡³ ${_.pageRange.endPage} é¡µï¼Œå…± ${S.length} å¼ ï¼Œèµ·å§‹ç´¢å¼• ${D}`);else return s.error("æ— æ•ˆçš„é¡µé¢èŒƒå›´"),{success:!1,completed:0,failed:0,errors:["æ— æ•ˆçš„é¡µé¢èŒƒå›´"]}}const M=Pt();try{if(l.progress.value.totalPages=S.length,l.progress.value.totalCompleted=0,l.progress.value.totalFailed=0,M&&(console.log("[ParallelPipeline] æ‰§è¡Œé¢„ä¿å­˜..."),s.info("å¼€å§‹é¢„ä¿å­˜åŸå§‹å›¾ç‰‡..."),!await Bn({onStart:V=>{const U=l.progress.value;U.preSave={isRunning:!0,current:0,total:V}},onProgress:(V,U)=>{const f=l.progress.value;f.preSave&&(f.preSave.current=V,f.preSave.total=U)},onComplete:()=>{const V=l.progress.value;V.preSave&&(V.preSave.isRunning=!1),s.success("é¢„ä¿å­˜å®Œæˆï¼Œå¼€å§‹ç¿»è¯‘...")},onError:V=>{const U=l.progress.value;U.preSave=void 0,s.warning(`é¢„ä¿å­˜å¤±è´¥ï¼š${V}ï¼Œç¿»è¯‘å®Œæˆåè¯·æ‰‹åŠ¨ä¿å­˜`)}}))){const V=l.progress.value;V.preSave=void 0}const E=_.mode;if(console.log(`ğŸš€ å¯åŠ¨å¹¶è¡Œç¿»è¯‘æ¨¡å¼: ${E}`),console.log(`   å›¾ç‰‡æ•°é‡: ${S.length}`),console.log(`   èµ·å§‹ç´¢å¼•: ${D}`),console.log(`   è‡ªåŠ¨ä¿å­˜: ${M?"å¯ç”¨":"ç¦ç”¨"}`),M){const q=l.progress.value;q.save={completed:0,total:S.length}}const P=await l.executeParallel(E,S,D);return P.success>0&&P.failed===0?s.success(`å¹¶è¡Œç¿»è¯‘å®Œæˆï¼ŒæˆåŠŸå¤„ç† ${P.success} å¼ å›¾ç‰‡`):P.success>0&&P.failed>0?s.warning(`å¹¶è¡Œç¿»è¯‘å®Œæˆï¼ŒæˆåŠŸ ${P.success} å¼ ï¼Œå¤±è´¥ ${P.failed} å¼ `):s.error("å¹¶è¡Œç¿»è¯‘å¤±è´¥"),{success:P.failed===0,completed:P.success,failed:P.failed,errors:P.errors}}catch(E){const P=E instanceof Error?E.message:"å¹¶è¡Œç¿»è¯‘å‡ºé”™";return s.error(P),{success:!1,completed:0,failed:S.length,errors:[P]}}finally{const E=l.progress.value;E.preSave=void 0,E.save=void 0,M&&(console.log("[ParallelPipeline] å®Œæˆä¿å­˜..."),await Ln())}}function p(){o.cancel(),l.cancel(),Fn()}return{progress:o.progress,isExecuting:o.isExecuting,isTranslating:u,progressPercent:a,execute:c,cancel:p,STEP_CHAIN_CONFIGS:o.STEP_CHAIN_CONFIGS}}function fn(n="current",t){return{mode:"standard",scope:n,pageRange:t?.pageRange}}function Pi(n="all",t){return{mode:"hq",scope:n,pageRange:t?.pageRange,batchOptions:{batchSize:t?.batchSize??3,maxRetries:t?.maxRetries??2,rpmLimit:t?.rpmLimit??10,sessionResetFrequency:t?.sessionResetFrequency??5}}}function Ri(n="all",t){return{mode:"proofread",scope:n,pageRange:t?.pageRange,batchOptions:{batchSize:t?.batchSize??3,maxRetries:t?.maxRetries??2,rpmLimit:t?.rpmLimit??10,sessionResetFrequency:t?.sessionResetFrequency??5}}}function Di(n="current",t){return{mode:"removeText",scope:n,pageRange:t?.pageRange}}function Mi(n){if(n.length===0)return{startPage:1,endPage:0};const t=[...n].sort((l,u)=>l-u),s=t[0],o=t[t.length-1];return{startPage:(s??0)+1,endPage:(o??0)+1}}function bt(n,t){const s=[];for(let o=n;o<t;o++)s.push(o);return s}function Mo(){const n=et(),t=gt(),s=ct(),o=Ii(),l=o.progress,u=o.isExecuting,a=o.isTranslating,c=o.progressPercent,v=Z(()=>o.isExecuting.value),p=Z(()=>o.isExecuting.value);async function _(N,se){if(N.length===0)return s.error("æ²¡æœ‰æŒ‡å®šè¦ç¿»è¯‘çš„é¡µé¢"),{success:!1,completed:0,failed:0,errors:["æ²¡æœ‰æŒ‡å®šè¦ç¿»è¯‘çš„é¡µé¢"]};const G=n.images.length;if(G===0)return s.error("è¯·å…ˆä¸Šä¼ å›¾ç‰‡"),{success:!1,completed:0,failed:0,errors:["è¯·å…ˆä¸Šä¼ å›¾ç‰‡"]};for(const A of N)if(A<0||A>=G)return s.error(`æ— æ•ˆçš„é¡µé¢ç´¢å¼•: ${A}`),{success:!1,completed:0,failed:0,errors:[`æ— æ•ˆçš„é¡µé¢ç´¢å¼•: ${A}`]};const J=N.length===1,ee=N.length===G;let j;if(J){const A=n.currentImageIndex,d=N[0];d!==void 0&&n.setCurrentImageIndex(d),j=S(se,"current");const $=await o.execute(j);return n.setCurrentImageIndex(A),{success:$.success,completed:$.completed,failed:$.failed,errors:$.errors??[]}}else if(ee)j=S(se,"all");else{const A=Mi(N);j=S(se,"range",A)}const ae=await o.execute(j);return{success:ae.success,completed:ae.completed,failed:ae.failed,errors:ae.errors??[]}}function S(N,se,G){switch(N){case"standard":return fn(se,G?{pageRange:G}:void 0);case"hq":return Pi(se,G?{pageRange:G}:void 0);case"proofread":return Ri(se,G?{pageRange:G}:void 0);case"removeText":return Di(se,G?{pageRange:G}:void 0);default:return fn(se,G?{pageRange:G}:void 0)}}async function D(){return(await _([n.currentImageIndex],"standard")).success}async function M(N){return(await _([N],"standard")).success}async function E(){return(await _(bt(0,n.images.length),"standard")).success}async function P(N){const se=bt(N.startPage-1,N.endPage);return(await _(se,"standard")).success}function q(){o.cancel()}async function V(){return(await _([n.currentImageIndex],"removeText")).success}async function U(){return(await _(bt(0,n.images.length),"removeText")).success}async function f(N){const se=bt(N.startPage-1,N.endPage);return(await _(se,"removeText")).success}async function m(){const N=n.getFailedImageIndices();return N.length===0?(s.info("æ²¡æœ‰å¤±è´¥çš„å›¾ç‰‡éœ€è¦é‡æ–°ç¿»è¯‘"),!0):(await _(N,"standard")).success}async function C(N){const se=N?bt(N.startPage-1,N.endPage):bt(0,n.images.length);return(await _(se,"hq")).success}async function k(N){const se=N?bt(N.startPage-1,N.endPage):bt(0,n.images.length);return(await _(se,"proofread")).success}async function K(){if(!n.currentImage)return s.error("è¯·å…ˆä¸Šä¼ å›¾ç‰‡"),!1;const se=t.bubbles;return!se||se.length===0?(s.error("å½“å‰å›¾ç‰‡æ²¡æœ‰æ°”æ³¡æ¡†ï¼Œè¯·å…ˆæ£€æµ‹æˆ–æ‰‹åŠ¨æ·»åŠ "),!1):(n.setManuallyAnnotated(!0),D())}return{progress:l,isTranslatingSingle:u,isHqTranslating:v,isProofreading:p,isTranslating:a,progressPercent:c,translatePages:_,range:bt,translateCurrentImage:D,translateImageByIndex:M,translateAllImages:E,translateImageRange:P,cancelBatchTranslation:q,removeTextOnly:V,removeAllTexts:U,removeTextRange:f,retryFailedImages:m,executeHqTranslation:C,executeProofreading:k,translateWithCurrentBubbles:K}}function Ei(){const n=gt(),t=et(),s=w(!1);function o(){if(!s.value)return;const l=t.currentImage;n.bubbleCount>0?t.updateCurrentBubbleStates([...n.bubbles]):l&&Array.isArray(l.bubbleStates)&&l.bubbleStates.length>0&&(t.updateCurrentBubbleStates([]),console.log("é€€å‡ºç¼–è¾‘æ¨¡å¼ï¼ˆæ— é‡æ¸²æŸ“ï¼‰ï¼Œç”¨æˆ·å·²åˆ é™¤æ‰€æœ‰æ°”æ³¡")),s.value=!1,n.clearSelection(),console.log("å·²é€€å‡ºç¼–è¾‘æ¨¡å¼ï¼ˆæ— é‡æ¸²æŸ“ï¼‰")}return{isActive:s,exitEditModeWithoutRender:o}}function Bi(){const n=_n(),t=Ne(),s=et(),o=It(),l=gt(),u=Ei(),a=w(!1),c=w(!1),v=w(null),p=w([]),_=w([]),S=w([]),D=w(null),M=w(null),E=w(null),P=w(null),q=w(!1);async function V(J=!1){if(!J&&(a.value||c.value)){console.log("[TranslateInit] å·²ç»åˆå§‹åŒ–ï¼Œä»…é‡æ–°åŠ è½½ä¸Šä¸‹æ–‡"),await k();return}console.log("[TranslateInit] å¼€å§‹åˆå§‹åŒ–åº”ç”¨..."),a.value=!0,v.value=null;try{await U(),await f(),await m(),await C(),await k(),console.log("[TranslateInit] åº”ç”¨åˆå§‹åŒ–å®Œæˆ"),c.value=!0}catch(ee){console.error("[TranslateInit] åº”ç”¨åˆå§‹åŒ–å¤±è´¥:",ee),v.value=ee instanceof Error?ee.message:"åˆå§‹åŒ–å¤±è´¥"}finally{a.value=!1}}async function U(){console.log("[TranslateInit] åˆå§‹åŒ–è®¾ç½®..."),t.initSettings();try{const J=await t.loadFromBackend();console.log(J?"[TranslateInit] å·²ä»åç«¯åŠ è½½è®¾ç½®":"[TranslateInit] åç«¯æ— è®¾ç½®ï¼Œä½¿ç”¨ localStorage æ•°æ®")}catch(J){console.warn("[TranslateInit] ä»åç«¯åŠ è½½è®¾ç½®å¤±è´¥ï¼Œä½¿ç”¨ localStorage æ•°æ®:",J)}console.log("[TranslateInit] è®¾ç½®åˆå§‹åŒ–å®Œæˆ")}async function f(){console.log("[TranslateInit] åˆå§‹åŒ–å­—ä½“åˆ—è¡¨...");try{const J=await wn();J.fonts&&J.fonts.length>0?(p.value=J.fonts,console.log(`[TranslateInit] å·²åŠ è½½ ${J.fonts.length} ä¸ªå­—ä½“`)):J.error?console.warn("[TranslateInit] è·å–å­—ä½“åˆ—è¡¨å¤±è´¥:",J.error):console.warn("[TranslateInit] å­—ä½“åˆ—è¡¨ä¸ºç©º")}catch(J){console.error("[TranslateInit] è·å–å­—ä½“åˆ—è¡¨å¤±è´¥:",J)}}async function m(){console.log("[TranslateInit] åˆå§‹åŒ–ç¿»è¯‘æç¤ºè¯è®¾ç½®...");try{const J=await As();J.prompt_names!==void 0?(_.value=J.prompt_names||[],!t.settings.translatePrompt&&J.default_prompt_content&&t.setTranslatePrompt(J.default_prompt_content),console.log(`[TranslateInit] å·²åŠ è½½ ${_.value.length} ä¸ªç¿»è¯‘æç¤ºè¯`)):J.error&&console.warn("[TranslateInit] è·å–ç¿»è¯‘æç¤ºè¯å¤±è´¥:",J.error)}catch(J){console.error("[TranslateInit] è·å–ç¿»è¯‘æç¤ºè¯å¤±è´¥:",J)}}async function C(){console.log("[TranslateInit] åˆå§‹åŒ–æ–‡æœ¬æ¡†æç¤ºè¯è®¾ç½®...");try{const J=await Bs();J.prompt_names!==void 0?(S.value=J.prompt_names||[],!t.settings.textboxPrompt&&J.default_prompt_content&&t.setTextboxPrompt(J.default_prompt_content),console.log(`[TranslateInit] å·²åŠ è½½ ${S.value.length} ä¸ªæ–‡æœ¬æ¡†æç¤ºè¯`)):J.error&&console.warn("[TranslateInit] è·å–æ–‡æœ¬æ¡†æç¤ºè¯å¤±è´¥:",J.error)}catch(J){console.error("[TranslateInit] è·å–æ–‡æœ¬æ¡†æç¤ºè¯å¤±è´¥:",J)}}async function k(){const J=n.query.book,ee=n.query.chapter;if(!J||!ee){console.log("[TranslateInit] æœªæŒ‡å®šä¹¦ç±/ç« èŠ‚å‚æ•°ï¼Œä½¿ç”¨ç‹¬ç«‹æ¨¡å¼"),q.value=!1,D.value=null,M.value=null,E.value=null,P.value=null,o.clearContext();return}console.log(`[TranslateInit] æ£€æµ‹åˆ°ä¹¦ç±/ç« èŠ‚å‚æ•°: book=${J}, chapter=${ee}`),q.value=!0,D.value=J,M.value=ee;try{const j=await Fs(J);if(!j.success||!j.book){console.warn("[TranslateInit] ä¹¦ç±ä¸å­˜åœ¨:",J),_e("ä¹¦ç±ä¸å­˜åœ¨","warning");return}const ae=j.book,A=ae.chapters?.find(d=>d.id===ee);if(!A){console.warn("[TranslateInit] ç« èŠ‚ä¸å­˜åœ¨:",ee),_e("ç« èŠ‚ä¸å­˜åœ¨","warning");return}if(E.value=ae.title,P.value=A.title,o.setBookChapterContext(J,ee,ae.title,A.title),typeof document<"u"&&(document.title=`${A.title} - ${ae.title} - Saber-Translator`),A.session_path){console.log(`[TranslateInit] å°è¯•åŠ è½½ç« èŠ‚ä¼šè¯: ${A.session_path}`);try{await o.loadSessionByPath(A.session_path),_e(`å·²åŠ è½½ç« èŠ‚: ${A.title}`,"success")}catch{console.log("[TranslateInit] ç« èŠ‚ä¼šè¯æ•°æ®ä¸å­˜åœ¨æˆ–åŠ è½½å¤±è´¥ï¼Œå°†åˆ›å»ºæ–°ä¼šè¯")}}}catch(j){console.error("[TranslateInit] åŠ è½½ä¹¦ç±/ç« èŠ‚ä¿¡æ¯å¤±è´¥:",j),_e("åŠ è½½ä¹¦ç±ä¿¡æ¯å¤±è´¥","error")}}function K(J){if(J<0||J>=s.imageCount){console.warn(`[TranslateInit] æ— æ•ˆçš„å›¾ç‰‡ç´¢å¼•: ${J}`);return}window._isChangingFromSwitchImage=!0,u.isActive.value&&u.exitEditModeWithoutRender(),s.currentImage&&l.bubbles.length>0&&s.updateCurrentImageProperty("bubbleStates",l.bubbles),s.setCurrentImageIndex(J);const j=s.currentImage;if(!j){console.warn("[TranslateInit] åˆ‡æ¢åˆ°çš„å›¾ç‰‡ä¸å­˜åœ¨"),window._isChangingFromSwitchImage=!1;return}console.log(`[TranslateInit] åˆ‡æ¢åˆ°å›¾ç‰‡: ${J}, ${j.fileName}`),j.bubbleStates&&j.bubbleStates.length>0?l.setBubbles(j.bubbleStates,!0):l.clearBubblesLocal(),setTimeout(()=>{window._isChangingFromSwitchImage=!1,console.log("[TranslateInit] å·²é‡ç½®åˆ‡æ¢å›¾ç‰‡æ“ä½œæ ‡è®°")},100)}function N(){s.canGoPrevious&&K(s.currentImageIndex-1)}function se(){s.canGoNext&&K(s.currentImageIndex+1)}function G(){dt(async()=>{await V()})}return{isInitializing:a,isInitialized:c,initError:v,fontList:p,promptNames:_,textboxPromptNames:S,currentBookId:D,currentChapterId:M,currentBookTitle:E,currentChapterTitle:P,isBookshelfMode:q,initializeApp:V,initializeSettings:U,initializeFontList:f,initializePromptSettings:m,initializeTextboxPromptSettings:C,initializeBookChapterContext:k,switchImage:K,goToPrevious:N,goToNext:se,editMode:u,setupAutoInit:G}}const Ai={key:0,id:"translationProgressBar",class:"translation-progress-bar"},Li={class:"parallel-header"},Fi={class:"header-title"},Ui={key:0,class:"presave-section"},Oi={class:"presave-label"},zi={class:"presave-progress-bar"},Ni={class:"pools-list"},Vi={class:"pool-label"},Wi={class:"pool-icon"},Ki={class:"pool-name"},qi={class:"pool-progress-bar"},Hi={class:"pool-stats"},ji={class:"completed-count"},Ji={class:"total-count"},Yi={key:0,class:"waiting-badge"},Xi={key:1,class:"lock-indicator",title:"ç­‰å¾…æ·±åº¦å­¦ä¹ é”"},Gi={key:0,class:"pool-row save-row"},Zi={class:"pool-progress-bar"},Qi={class:"pool-stats"},er={class:"completed-count"},tr={class:"total-count"},or={class:"overall-section"},nr={class:"overall-label"},sr={key:0,class:"failed-text"},ar={class:"overall-progress-bar"},lr={class:"progress-bar-label"},ir={key:0,class:"failed-count"},rr={class:"progress-bar"},ur=je({__name:"TranslationProgress",props:{progress:{}},setup(n){const t=n,s=et(),o=Ne(),l=Mo(),u=Do(),a=Z(()=>{const m=u.progress.value?.preSave?.isRunning;return o.settings.parallel?.enabled&&(u.isRunning.value||m)}),c=Z(()=>u.progress.value),v=Z(()=>{const m=c.value;return!m||m.totalPages===0?0:Math.round(m.totalCompleted/m.totalPages*100)});function p(m){const C=c.value?.totalPages||0;return C===0?0:Math.round(m.completed/C*100)}function _(){const m=c.value?.totalPages||0;return m===0?0:Math.max(3,Math.round(1/m*100))}function S(){const m=c.value?.preSave;return!m||m.total===0?0:Math.round(m.current/m.total*100)}function D(){const m=c.value?.save;return!m||m.total===0?0:Math.round(m.completed/m.total*100)}const M=Z(()=>t.progress||l.progress.value),E=Z(()=>M.value.isInProgress||s.isBatchTranslationInProgress||a.value),P=Z(()=>M.value.current),q=Z(()=>M.value.total),V=Z(()=>M.value.failed),U=Z(()=>M.value.percentage!==void 0?M.value.percentage:q.value===0?0:Math.round(P.value/q.value*100)),f=Z(()=>M.value.label?M.value.label:`ç¿»è¯‘ä¸­ï¼š${P.value} / ${q.value}`);return(m,C)=>E.value?(B(),F("div",Ai,[a.value&&c.value?(B(),F(ze,{key:0},[e("div",Li,[e("span",Fi,"ğŸš€ å¹¶è¡Œç¿»è¯‘ä¸­ï¼š"+ne(c.value.totalCompleted)+"/"+ne(c.value.totalPages),1)]),c.value.preSave?.isRunning?(B(),F("div",Ui,[e("div",Oi," ğŸ“¥ é¢„ä¿å­˜åŸå§‹å›¾ç‰‡ï¼š"+ne(c.value.preSave.current)+"/"+ne(c.value.preSave.total),1),e("div",zi,[e("div",{class:"presave-progress-fill",style:at({width:S()+"%"})},null,4)])])):de("",!0),e("div",Ni,[(B(!0),F(ze,null,Ye(c.value.pools,k=>(B(),F("div",{key:k.name,class:Ie(["pool-row",{"pool-processing":k.processing,"pool-waiting-lock":k.isWaitingLock}])},[e("div",Vi,[e("span",Wi,ne(k.icon),1),e("span",Ki,ne(k.name),1)]),e("div",qi,[e("div",{class:"progress-completed",style:at({width:p(k)+"%"})},null,4),k.processing?(B(),F("div",{key:0,class:"progress-processing",style:at({left:p(k)+"%",width:_()+"%"})},null,4)):de("",!0)]),e("div",Hi,[e("span",ji,ne(k.completed),1),e("span",Ji,"/ "+ne(c.value.totalPages),1),k.waiting>0?(B(),F("span",Yi,"+"+ne(k.waiting),1)):de("",!0),k.isWaitingLock?(B(),F("span",Xi,"ğŸ”’")):de("",!0)])],2))),128)),c.value.save?(B(),F("div",Gi,[C[0]||(C[0]=e("div",{class:"pool-label"},[e("span",{class:"pool-icon"},"ğŸ’¾"),e("span",{class:"pool-name"},"ä¿å­˜")],-1)),e("div",Zi,[e("div",{class:"progress-completed save-progress",style:at({width:D()+"%"})},null,4)]),e("div",Qi,[e("span",er,ne(c.value.save.completed),1),e("span",tr,"/ "+ne(c.value.save.total),1)])])):de("",!0)]),C[1]||(C[1]=e("div",{class:"divider"},null,-1)),e("div",or,[e("div",nr,[me(" æ€»è¿›åº¦ï¼š"+ne(v.value)+"% ",1),c.value.totalFailed>0?(B(),F("span",sr," ï¼ˆ"+ne(c.value.totalFailed)+" å¤±è´¥ï¼‰ ",1)):de("",!0)]),e("div",ar,[e("div",{class:"overall-progress-fill progress-stripe",style:at({width:v.value+"%"})},null,4)])])],64)):(B(),F(ze,{key:1},[e("div",lr,[me(ne(f.value)+" ",1),V.value>0?(B(),F("span",ir,"ï¼ˆ"+ne(V.value)+" å¼ å¤±è´¥ï¼‰",1)):de("",!0)]),e("div",rr,[e("div",{class:"progress progress-stripe",style:at({width:`${U.value}%`})},null,4)])],64))])):de("",!0)}}),cr=He(ur,[["__scopeId","data-v-532ece5f"]]),dr=je({__name:"SponsorModal",emits:["close"],setup(n,{emit:t}){const s=t;return(o,l)=>(B(),ut($n,{title:"æ”¯æŒä½œè€…",onClose:l[1]||(l[1]=u=>s("close"))},{footer:St(()=>[e("button",{type:"button",class:"btn btn-primary",onClick:l[0]||(l[0]=u=>s("close"))},"å…³é—­")]),default:St(()=>[l[2]||(l[2]=e("div",{class:"sponsor-content"},[e("p",{class:"sponsor-message"}," å¦‚æœè¿™ä¸ªé¡¹ç›®å¯¹ä½ æœ‰å¸®åŠ©ï¼Œæ¬¢è¿è¯·ä½œè€…å–æ¯å’–å•¡ â˜• "),e("div",{class:"qr-codes"},[e("div",{class:"qr-item"},[e("div",{class:"qr-image"},[e("img",{src:"/pic/wechat_qrcode.png",alt:"å¾®ä¿¡æ”¯ä»˜"})]),e("span",{class:"qr-label"},"å¾®ä¿¡æ”¯ä»˜")]),e("div",{class:"qr-item"},[e("div",{class:"qr-image"},[e("img",{src:"/pic/alipay_qrcode.png",alt:"æ”¯ä»˜å®"})]),e("span",{class:"qr-label"},"æ”¯ä»˜å®")])]),e("p",{class:"sponsor-thanks"},"æ„Ÿè°¢æ‚¨çš„æ”¯æŒï¼ğŸ™")],-1))]),_:1}))}}),gr=He(dr,[["__scopeId","data-v-02b6948e"]]);function pr(n){const t=w(""),s=Z(()=>n.value.some(M=>M.folderPath)),o=Z(()=>{if(!s.value)return null;const M={name:"æ ¹ç›®å½•",path:"",images:[],subfolders:[]},E=new Map;E.set("",M);for(const P of n.value){const q=P.folderPath||"";if(q&&!E.has(q)){const V=q.split("/");let U="";for(const f of V){const m=U;if(U=U?`${U}/${f}`:f,!E.has(U)){const C={name:f,path:U,images:[],subfolders:[]};E.set(U,C),E.has(m)&&E.get(m).subfolders.push(C)}}}E.has(q)&&E.get(q).images.push(P)}return M}),l=Z(()=>{if(!t.value)return[{name:"æ ¹ç›®å½•",path:""}];const M=t.value.split("/"),E=[{name:"æ ¹ç›®å½•",path:""}];let P="";for(const q of M)P=P?`${P}/${q}`:q,E.push({name:q,path:P});return E}),u=Z(()=>{if(!o.value)return null;if(!t.value)return o.value;const M=(E,P)=>{if(E.path===P)return E;for(const q of E.subfolders){const V=M(q,P);if(V)return V}return null};return M(o.value,t.value)}),a=Z(()=>u.value?.subfolders||[]),c=Z(()=>u.value?.images||[]);function v(M){t.value=M}function p(){if(!t.value)return;const M=t.value.lastIndexOf("/");t.value=M>0?t.value.substring(0,M):""}function _(M){t.value=M}function S(M){let E=M.images.length;for(const P of M.subfolders)E+=S(P);return E}function D(){t.value=""}return{currentFolderPath:t,useTreeMode:s,folderTree:o,breadcrumbs:l,currentFolder:u,currentSubfolders:a,currentImages:c,enterFolder:v,goUp:p,navigateTo:_,getFolderImageCount:S,resetToRoot:D}}const mr={id:"thumbnail-sidebar",class:"thumbnail-sidebar"},vr={class:"card thumbnail-card"},fr={class:"breadcrumb-nav"},br=["onClick"],hr={key:0,class:"breadcrumb-sep"},xr=["onClick"],yr={class:"folder-info"},_r=["title"],Cr={class:"folder-count"},Sr=["title","onClick"],kr=["src","alt"],wr={class:"page-number-indicator"},$r={key:1,class:"translated-indicator"},Tr={key:2,class:"translation-failed-indicator"},Ir={key:3,class:"labeled-indicator"},Pr={key:4,class:"thumbnail-processing-indicator"},Rr={key:0,class:"empty-folder"},Dr=["title","data-index","onClick"],Mr=["src","alt"],Er={class:"page-number-indicator"},Br={key:1,class:"translated-indicator"},Ar={key:2,class:"translation-failed-indicator"},Lr={key:3,class:"labeled-indicator"},Fr={key:4,class:"thumbnail-processing-indicator"},Ur={key:2,class:"empty-state"},Or=je({__name:"ThumbnailSidebar",emits:["select"],setup(n,{emit:t}){const s=t,o=et(),l=w(null),u=w([]),a=Z(()=>o.images),c=Z(()=>o.currentImageIndex),v=Z(()=>o.hasImages),{useTreeMode:p,breadcrumbs:_,currentSubfolders:S,currentImages:D,currentFolderPath:M,enterFolder:E,goUp:P,navigateTo:q,getFolderImageCount:V,folderTree:U,resetToRoot:f}=pr(a);Se(()=>a.value.length,(j,ae)=>{(j===0||ae===0&&j>0)&&f()});function m(j){return a.value.findIndex(ae=>ae.id===j.id)}function C(j){return j.translationFailed?"failed":j.isManuallyAnnotated?"labeled":j.translationStatus==="processing"?"processing":null}function k(j){return j.translationStatus==="completed"}function K(j){s("select",j)}function N(j){E(j.path)}function se(j){q(j)}function G(){pt(()=>{const j=u.value[c.value];if(j&&l.value){const ae=l.value,A=j.offsetTop-ae.clientHeight/2+j.clientHeight/2;ae.scrollTo({top:Math.max(0,A),behavior:"smooth"})}})}function J(j,ae){u.value[ae]=j}function ee(j){return j.translationFailed?"ç¿»è¯‘å¤±è´¥ï¼Œç‚¹å‡»å¯é‡è¯•":j.isManuallyAnnotated?"åŒ…å«æ‰‹åŠ¨æ ‡æ³¨":j.translationStatus==="completed"?"å·²å®Œæˆç¿»è¯‘":j.fileName||""}return Se(c,()=>{G()}),dt(()=>{v.value&&G()}),(j,ae)=>(B(),F("aside",mr,[e("div",vr,[ae[5]||(ae[5]=e("h2",null,"å›¾ç‰‡æ¦‚è§ˆ",-1)),v.value&&H(p)&&H(U)?(B(),F(ze,{key:0},[e("div",fr,[(B(!0),F(ze,null,Ye(H(_),(A,d)=>(B(),F(ze,{key:A.path},[e("span",{class:Ie(["breadcrumb-item",{active:d===H(_).length-1}]),onClick:$=>d<H(_).length-1&&se(A.path)},ne(d===0?"ğŸ“":"")+ne(A.name),11,br),d<H(_).length-1?(B(),F("span",hr,"/")):de("",!0)],64))),128))]),H(M)?(B(),F("div",{key:0,class:"folder-back-btn",onClick:ae[0]||(ae[0]=(...A)=>H(P)&&H(P)(...A))},[...ae[1]||(ae[1]=[e("span",{class:"back-icon"},"â¬…ï¸",-1),e("span",null,"è¿”å›ä¸Šçº§",-1)])])):de("",!0),e("div",{ref_key:"containerRef",ref:l,class:"folder-content-list"},[(B(!0),F(ze,null,Ye(H(S),A=>(B(),F("div",{key:A.path,class:"folder-item",onClick:d=>N(A)},[ae[2]||(ae[2]=e("span",{class:"folder-icon"},"ğŸ“",-1)),e("div",yr,[e("span",{class:"folder-name",title:A.name},ne(A.name),9,_r),e("span",Cr,"("+ne(H(V)(A))+")",1)])],8,xr))),128)),(B(!0),F(ze,null,Ye(H(D),A=>(B(),F("div",{key:A.id,ref_for:!0,ref:d=>J(d,m(A)),class:Ie(["thumbnail-item",{active:m(A)===c.value}]),title:ee(A),onClick:d=>K(m(A))},[A.originalDataURL?(B(),F("img",{key:0,src:A.originalDataURL,alt:A.fileName,class:"thumbnail-image"},null,8,kr)):de("",!0),e("span",wr,ne(m(A)+1),1),k(A)?(B(),F("span",$r,"âœ“")):de("",!0),C(A)==="failed"?(B(),F("span",Tr,"!")):C(A)==="labeled"?(B(),F("span",Ir,"âœï¸")):de("",!0),C(A)==="processing"?(B(),F("div",Pr,"âŸ³")):de("",!0)],10,Sr))),128)),H(S).length===0&&H(D).length===0?(B(),F("div",Rr,[...ae[3]||(ae[3]=[e("p",null,"æ­¤æ–‡ä»¶å¤¹ä¸ºç©º",-1)])])):de("",!0)],512)],64)):v.value?(B(),F("ul",{key:1,ref_key:"containerRef",ref:l,id:"thumbnailList",class:"thumbnail-list"},[(B(!0),F(ze,null,Ye(a.value,(A,d)=>(B(),F("li",{key:A.id,ref_for:!0,ref:$=>J($,d),class:Ie(["thumbnail-item",{active:d===c.value}]),title:ee(A),"data-index":d,onClick:$=>K(d)},[A.originalDataURL?(B(),F("img",{key:0,src:A.originalDataURL,alt:A.fileName,class:"thumbnail-image"},null,8,Mr)):de("",!0),e("span",Er,ne(d+1),1),k(A)?(B(),F("span",Br,"âœ“")):de("",!0),C(A)==="failed"?(B(),F("span",Ar,"!")):C(A)==="labeled"?(B(),F("span",Lr,"âœï¸")):de("",!0),C(A)==="processing"?(B(),F("div",Fr," âŸ³ ")):de("",!0)],10,Dr))),128))],512)):(B(),F("div",Ur,[...ae[4]||(ae[4]=[e("p",null,"æš‚æ— å›¾ç‰‡",-1)])]))])]))}}),zr=He(Or,[["__scopeId","data-v-4c1f4f1b"]]),Nr={class:"saved-prompts-picker"},Vr={class:"prompts-chips-container"},Wr={key:0,class:"empty-hint"},Kr={key:1,class:"empty-hint"},qr=["title","onClick"],Hr=je({__name:"SavedPromptsPicker",props:{promptType:{}},emits:["select"],setup(n,{expose:t,emit:s}){const o=n,l=s,u=w([]),a=w(!1);async function c(){a.value=!0;try{let p;o.promptType==="textbox"?p=await Ke.getTextboxPrompts():p=await Ke.getPrompts(o.promptType);const _=p.prompt_names||[];u.value=_.map(S=>({name:S}))}catch(p){console.error("åŠ è½½æç¤ºè¯åˆ—è¡¨å¤±è´¥:",p),u.value=[]}finally{a.value=!1}}async function v(p){try{let _;o.promptType==="textbox"?_=await Ke.getTextboxPromptContent(p):_=await Ke.getPromptContent(o.promptType,p),_.prompt_content&&l("select",_.prompt_content,p)}catch(_){console.error("åŠ è½½æç¤ºè¯å†…å®¹å¤±è´¥:",_)}}return Se(()=>o.promptType,()=>{c()}),dt(()=>{c()}),t({refresh:c}),(p,_)=>(B(),F("div",Nr,[_[1]||(_[1]=e("span",{class:"picker-label"},"ğŸ“‘ å¿«é€Ÿé€‰æ‹©:",-1)),e("div",Vr,[a.value?(B(),F("span",Wr,"åŠ è½½ä¸­...")):u.value.length===0?(B(),F("span",Kr,"æš‚æ— ä¿å­˜çš„æç¤ºè¯")):(B(!0),F(ze,{key:2},Ye(u.value,S=>(B(),F("button",{key:S.name,type:"button",class:"prompt-chip",title:S.name,onClick:D=>v(S.name)},[_[0]||(_[0]=e("span",{class:"chip-icon"},"ğŸ“",-1)),me(" "+ne(S.name),1)],8,qr))),128))])]))}}),Ot=He(Hr,[["__scopeId","data-v-2ebbb8b3"]]),jr={class:"ocr-settings"},Jr={class:"settings-group"},Yr={class:"settings-item"},Xr={class:"settings-item"},Gr={class:"input-hint"},Zr={class:"settings-group"},Qr={class:"settings-item"},eu={class:"settings-group"},tu={class:"settings-row"},ou={class:"settings-item"},nu={class:"password-input-wrapper"},su=["type"],au={key:0,class:"eye-icon"},lu={key:1,class:"eye-off-icon"},iu={class:"settings-item"},ru={class:"password-input-wrapper"},uu=["type"],cu={key:0,class:"eye-icon"},du={key:1,class:"eye-off-icon"},gu={class:"settings-row"},pu={class:"settings-item"},mu={class:"settings-item"},vu=["disabled"],fu={class:"settings-group"},bu={class:"settings-row"},hu={class:"settings-item"},xu={class:"settings-item"},yu={class:"password-input-wrapper"},_u=["type"],Cu={key:0,class:"eye-icon"},Su={key:1,class:"eye-off-icon"},ku={class:"settings-item"},wu={class:"settings-item"},$u={class:"model-input-with-fetch"},Tu=["disabled"],Iu={class:"fetch-text"},Pu={key:0,class:"model-select-container"},Ru={class:"model-count"},Du={class:"settings-item"},Mu={class:"prompt-format-selector"},Eu={class:"settings-item"},Bu={class:"settings-item"},Au=["disabled"],Lu=je({__name:"OcrSettings",setup(n){const t=[{label:"MangaOCR (æ—¥è¯­ä¸“ç”¨)",value:"manga_ocr"},{label:"PaddleOCR (å¤šè¯­è¨€)",value:"paddle_ocr"},{label:"PaddleOCR-VL",value:"paddleocr_vl"},{label:"ç™¾åº¦OCR",value:"baidu_ocr"},{label:"48px OCR",value:"48px_ocr"},{label:"AIè§†è§‰OCR",value:"ai_vision"}],s=[{label:"æ ‡å‡†ç‰ˆ",value:"standard"},{label:"é«˜ç²¾åº¦ç‰ˆ",value:"high_precision"}],o=[{label:"è‡ªåŠ¨æ£€æµ‹",value:"auto_detect"},{label:"ä¸­è‹±æ–‡æ··åˆ",value:"CHN_ENG"},{label:"è‹±æ–‡",value:"ENG"},{label:"æ—¥è¯­",value:"JAP"},{label:"éŸ©è¯­",value:"KOR"},{label:"æ³•è¯­",value:"FRE"},{label:"å¾·è¯­",value:"GER"},{label:"ä¿„è¯­",value:"RUS"}],l=[{label:"SiliconFlow (ç¡…åŸºæµåŠ¨)",value:"siliconflow"},{label:"ç«å±±å¼•æ“",value:"volcano"},{label:"Google Gemini",value:"gemini"},{label:"è‡ªå®šä¹‰ OpenAI å…¼å®¹æœåŠ¡",value:"custom_openai_vision"}],u=[{label:"æ—¥è¯­",value:"japanese"},{label:"ç®€ä½“ä¸­æ–‡",value:"chinese"},{label:"ç¹ä½“ä¸­æ–‡",value:"chinese_cht"},{label:"è‹±è¯­",value:"english"},{label:"éŸ©è¯­",value:"korean"}],a=[{label:"æ™®é€šæç¤ºè¯",value:"false"},{label:"JSONæç¤ºè¯",value:"true"}],c=[{label:"ğŸš€ å¸¸ç”¨è¯­è¨€",options:[{label:"æ—¥è¯­",value:"japanese"},{label:"è‹±è¯­",value:"en"},{label:"ç®€ä½“ä¸­æ–‡",value:"chinese"},{label:"ç¹ä½“ä¸­æ–‡",value:"chinese_cht"},{label:"éŸ©è¯­",value:"korean"}]},{label:"ğŸŒ æ‹‰ä¸è¯­ç³»",options:[{label:"æ³•è¯­",value:"french"},{label:"å¾·è¯­",value:"german"},{label:"è¥¿ç­ç‰™è¯­",value:"spanish"},{label:"æ„å¤§åˆ©è¯­",value:"italian"},{label:"è‘¡è„ç‰™è¯­",value:"portuguese"}]},{label:"ğŸŒ å…¶ä»–è¯­ç³»",options:[{label:"ä¿„è¯­",value:"russian"}]}],v=Ne(),p=ct(),_=w({apiKey:v.settings.baiduOcr.apiKey,secretKey:v.settings.baiduOcr.secretKey,version:v.settings.baiduOcr.version,sourceLanguage:v.settings.baiduOcr.sourceLanguage}),S=w({apiKey:v.settings.aiVisionOcr.apiKey,modelName:v.settings.aiVisionOcr.modelName,customBaseUrl:v.settings.aiVisionOcr.customBaseUrl,prompt:v.settings.aiVisionOcr.prompt,rpmLimit:v.settings.aiVisionOcr.rpmLimit,minImageSize:v.settings.aiVisionOcr.minImageSize}),D=Z(()=>v.settings);Se(()=>_.value.apiKey,A=>{v.updateBaiduOcr({apiKey:A})}),Se(()=>_.value.secretKey,A=>{v.updateBaiduOcr({secretKey:A})}),Se(()=>_.value.version,A=>{v.updateBaiduOcr({version:A})}),Se(()=>_.value.sourceLanguage,A=>{v.updateBaiduOcr({sourceLanguage:A})}),Se(()=>S.value.apiKey,A=>{v.updateAiVisionOcr({apiKey:A})}),Se(()=>S.value.modelName,A=>{v.updateAiVisionOcr({modelName:A})}),Se(()=>S.value.customBaseUrl,A=>{v.updateAiVisionOcr({customBaseUrl:A})}),Se(()=>S.value.prompt,A=>{v.updateAiVisionOcr({prompt:A})}),Se(()=>S.value.rpmLimit,A=>{v.updateAiVisionOcr({rpmLimit:A})}),Se(()=>S.value.minImageSize,A=>{v.updateAiVisionOcr({minImageSize:A})});const M=w(!1),E=w(!1),P=w(!1),q=w(!1),V=w(!1),U=w([]),f=Z(()=>{const A=[{label:"-- é€‰æ‹©æ¨¡å‹ --",value:""}];return U.value.forEach(d=>{A.push({label:d,value:d})}),A});function m(){v.saveToStorage()}function C(){v.saveToStorage()}function k(A){v.updatePaddleOcrVl({sourceLanguage:A})}function K(){switch(v.settings.ocrEngine){case"manga_ocr":return"MangaOCR ä¸“ä¸ºæ—¥è¯­æ¼«ç”»ä¼˜åŒ–ï¼Œæºè¯­è¨€è®¾ç½®ä¸å½±å“è¯†åˆ«";case"paddle_ocr":return"PaddleOCR ä¼šæ ¹æ®æºè¯­è¨€åŠ è½½å¯¹åº”çš„è¯†åˆ«æ¨¡å‹";case"paddleocr_vl":return"PaddleOCR-VL åŸºäº VLM å¾®è°ƒï¼Œä¸“ä¸ºæ—¥è¯­æ¼«ç”»ä¼˜åŒ–ï¼Œå‡†ç¡®ç‡é«˜è¾¾ 70%";case"baidu_ocr":return"ç™¾åº¦OCR ä½¿ç”¨ç‹¬ç«‹çš„æºè¯­è¨€è®¾ç½®ï¼ˆè§ä¸‹æ–¹ï¼‰";case"ai_vision":return"AIè§†è§‰OCR é€šè¿‡æç¤ºè¯æŒ‡å®šè¯†åˆ«è¯­è¨€";case"48px_ocr":return"48px OCR æ”¯æŒæ—¥ä¸­è‹±éŸ©ç­‰å¤šè¯­è¨€ï¼Œæºè¯­è¨€è®¾ç½®ä¸å½±å“è¯†åˆ«";default:return"é€‰æ‹©è¦è¯†åˆ«çš„åŸæ–‡è¯­è¨€"}}function N(A){v.setAiVisionOcrProvider(A),U.value=[],se()}function se(){S.value.apiKey=v.settings.aiVisionOcr.apiKey,S.value.modelName=v.settings.aiVisionOcr.modelName,S.value.customBaseUrl=v.settings.aiVisionOcr.customBaseUrl,S.value.prompt=v.settings.aiVisionOcr.prompt,S.value.rpmLimit=v.settings.aiVisionOcr.rpmLimit,S.value.minImageSize=v.settings.aiVisionOcr.minImageSize}function G(){const A=v.settings.aiVisionOcr.isJsonMode?ds:gs;v.updateAiVisionOcr({prompt:A}),S.value.prompt=A}async function J(){const A=_.value.apiKey?.trim(),d=_.value.secretKey?.trim();if(!A||!d){p.warning("è¯·å¡«å†™ç™¾åº¦OCRçš„API Keyå’ŒSecret Key");return}q.value=!0,p.info("æ­£åœ¨æµ‹è¯•ç™¾åº¦OCRè¿æ¥...");try{const $=await Ke.testBaiduOcrConnection(A,d);$.success?p.success($.message||"ç™¾åº¦OCRè¿æ¥æˆåŠŸ!"):p.error($.message||$.error||"ç™¾åº¦OCRè¿æ¥å¤±è´¥")}catch($){const r=$ instanceof Error?$.message:"è¿æ¥æµ‹è¯•å¤±è´¥";p.error(r)}finally{q.value=!1}}async function ee(){q.value=!0;try{const A=await Ke.testAiVisionOcrConnection({provider:v.settings.aiVisionOcr.provider,apiKey:S.value.apiKey,modelName:S.value.modelName,customBaseUrl:S.value.customBaseUrl,prompt:S.value.prompt});A.success?p.success("AIè§†è§‰OCRè¿æ¥æˆåŠŸ"):p.error(`AIè§†è§‰OCRè¿æ¥å¤±è´¥: ${A.error||"æœªçŸ¥é”™è¯¯"}`)}catch(A){const d=A instanceof Error?A.message:"è¿æ¥æµ‹è¯•å¤±è´¥";p.error(d)}finally{q.value=!1}}async function j(){const A=v.settings.aiVisionOcr.provider,d=S.value.apiKey?.trim(),$=S.value.customBaseUrl?.trim();if(!d){p.warning("è¯·å…ˆå¡«å†™ API Key");return}if(!["siliconflow","volcano","gemini","custom_openai_vision"].includes(A)){p.warning("å½“å‰æœåŠ¡å•†ä¸æ”¯æŒè‡ªåŠ¨è·å–æ¨¡å‹åˆ—è¡¨");return}if(A==="custom_openai_vision"&&!$){p.warning("è‡ªå®šä¹‰æœåŠ¡éœ€è¦å…ˆå¡«å†™ Base URL");return}V.value=!0;try{const h=await Ke.fetchModels(A,d,$);h.success&&h.models&&h.models.length>0?(U.value=h.models.map(I=>I.id),p.success(`è·å–åˆ° ${h.models.length} ä¸ªæ¨¡å‹`)):p.warning(h.message||"æœªè·å–åˆ°å¯ç”¨æ¨¡å‹")}catch(h){const I=h instanceof Error?h.message:"è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥";p.error(I)}finally{V.value=!1}}function ae(A,d){v.updateAiVisionOcr({prompt:A}),S.value.prompt=A,p.success(`å·²åº”ç”¨æç¤ºè¯: ${d}`)}return(A,d)=>(B(),F("div",jr,[e("div",Jr,[d[21]||(d[21]=e("div",{class:"settings-group-title"},"OCRå¼•æ“é€‰æ‹©",-1)),e("div",Yr,[d[19]||(d[19]=e("label",{for:"settingsOcrEngine"},"OCRå¼•æ“:",-1)),Ce(Ve,{"model-value":D.value.ocrEngine,options:t,onChange:d[0]||(d[0]=$=>{D.value.ocrEngine=$,m()})},null,8,["model-value"])]),le(e("div",Xr,[d[20]||(d[20]=e("label",{for:"settingsSourceLanguage"},"æºè¯­è¨€:",-1)),Ce(Ve,{"model-value":D.value.sourceLanguage,groups:c,onChange:d[1]||(d[1]=$=>{D.value.sourceLanguage=$,C()})},null,8,["model-value"]),e("div",Gr,ne(K()),1)],512),[[Ue,D.value.ocrEngine==="paddle_ocr"]])]),le(e("div",Zr,[d[24]||(d[24]=e("div",{class:"settings-group-title"},"PaddleOCR-VL è®¾ç½®",-1)),e("div",Qr,[d[22]||(d[22]=e("label",{for:"settingsPaddleOcrVlSourceLanguage"},"æºè¯­è¨€:",-1)),Ce(Ve,{"model-value":D.value.paddleOcrVl.sourceLanguage,options:u,onChange:d[2]||(d[2]=$=>k($))},null,8,["model-value"]),d[23]||(d[23]=e("div",{class:"input-hint"}," é€‰æ‹©å›¾åƒä¸­çš„æºè¯­è¨€ï¼Œç”¨äºä¼˜åŒ– OCR è¯†åˆ«æ•ˆæœ ",-1))])],512),[[Ue,D.value.ocrEngine==="paddleocr_vl"]]),le(e("div",eu,[d[29]||(d[29]=e("div",{class:"settings-group-title"},"ç™¾åº¦OCR è®¾ç½®",-1)),e("div",tu,[e("div",ou,[d[25]||(d[25]=e("label",{for:"settingsBaiduApiKey"},"API Key:",-1)),e("div",nu,[le(e("input",{type:M.value?"text":"password",id:"settingsBaiduApiKey","onUpdate:modelValue":d[3]||(d[3]=$=>_.value.apiKey=$),class:"secure-input",placeholder:"è¯·è¾“å…¥ç™¾åº¦OCR API Key",autocomplete:"off"},null,8,su),[[$t,_.value.apiKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:d[4]||(d[4]=$=>M.value=!M.value)},[M.value?(B(),F("span",lu,"ğŸ‘â€ğŸ—¨")):(B(),F("span",au,"ğŸ‘"))])])]),e("div",iu,[d[26]||(d[26]=e("label",{for:"settingsBaiduSecretKey"},"Secret Key:",-1)),e("div",ru,[le(e("input",{type:E.value?"text":"password",id:"settingsBaiduSecretKey","onUpdate:modelValue":d[5]||(d[5]=$=>_.value.secretKey=$),class:"secure-input",placeholder:"è¯·è¾“å…¥Secret Key",autocomplete:"off"},null,8,uu),[[$t,_.value.secretKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:d[6]||(d[6]=$=>E.value=!E.value)},[E.value?(B(),F("span",du,"ğŸ‘â€ğŸ—¨")):(B(),F("span",cu,"ğŸ‘"))])])])]),e("div",gu,[e("div",pu,[d[27]||(d[27]=e("label",{for:"settingsBaiduVersion"},"è¯†åˆ«ç‰ˆæœ¬:",-1)),Ce(Ve,{modelValue:_.value.version,"onUpdate:modelValue":d[7]||(d[7]=$=>_.value.version=$),options:s},null,8,["modelValue"])]),e("div",mu,[d[28]||(d[28]=e("label",{for:"settingsBaiduSourceLanguage"},"æºè¯­è¨€:",-1)),Ce(Ve,{modelValue:_.value.sourceLanguage,"onUpdate:modelValue":d[8]||(d[8]=$=>_.value.sourceLanguage=$),options:o},null,8,["modelValue"])])]),e("button",{class:"settings-test-btn",onClick:J,disabled:q.value},ne(q.value?"æµ‹è¯•ä¸­...":"ğŸ”— æµ‹è¯•è¿æ¥"),9,vu)],512),[[Ue,D.value.ocrEngine==="baidu_ocr"]]),le(e("div",fu,[d[41]||(d[41]=e("div",{class:"settings-group-title"},"AIè§†è§‰OCR è®¾ç½®",-1)),e("div",bu,[e("div",hu,[d[30]||(d[30]=e("label",{for:"settingsAiVisionProvider"},"æœåŠ¡å•†:",-1)),Ce(Ve,{"model-value":D.value.aiVisionOcr.provider,options:l,onChange:d[9]||(d[9]=$=>N($))},null,8,["model-value"])]),e("div",xu,[d[31]||(d[31]=e("label",{for:"settingsAiVisionApiKey"},"API Key:",-1)),e("div",yu,[le(e("input",{type:P.value?"text":"password",id:"settingsAiVisionApiKey","onUpdate:modelValue":d[10]||(d[10]=$=>S.value.apiKey=$),class:"secure-input",placeholder:"è¯·è¾“å…¥API Key",autocomplete:"off"},null,8,_u),[[$t,S.value.apiKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:d[11]||(d[11]=$=>P.value=!P.value)},[P.value?(B(),F("span",Su,"ğŸ‘â€ğŸ—¨")):(B(),F("span",Cu,"ğŸ‘"))])])])]),le(e("div",ku,[d[32]||(d[32]=e("label",{for:"settingsCustomAiVisionBaseUrl"},"Base URL:",-1)),le(e("input",{type:"text",id:"settingsCustomAiVisionBaseUrl","onUpdate:modelValue":d[12]||(d[12]=$=>S.value.customBaseUrl=$),placeholder:"ä¾‹å¦‚: https://api.example.com/v1"},null,512),[[we,S.value.customBaseUrl]])],512),[[Ue,D.value.aiVisionOcr.provider==="custom_openai_vision"]]),e("div",wu,[d[34]||(d[34]=e("label",{for:"settingsAiVisionModelName"},"æ¨¡å‹åç§°:",-1)),e("div",$u,[le(e("input",{type:"text",id:"settingsAiVisionModelName","onUpdate:modelValue":d[13]||(d[13]=$=>S.value.modelName=$),placeholder:"å¦‚: silicon-llava2-34b"},null,512),[[we,S.value.modelName]]),e("button",{type:"button",class:"fetch-models-btn",title:"è·å–å¯ç”¨æ¨¡å‹åˆ—è¡¨",onClick:j,disabled:V.value},[d[33]||(d[33]=e("span",{class:"fetch-icon"},"ğŸ”",-1)),e("span",Iu,ne(V.value?"è·å–ä¸­...":"è·å–æ¨¡å‹"),1)],8,Tu)]),U.value.length>0?(B(),F("div",Pu,[Ce(Ve,{modelValue:S.value.modelName,"onUpdate:modelValue":d[14]||(d[14]=$=>S.value.modelName=$),options:f.value},null,8,["modelValue","options"]),e("span",Ru,"å…± "+ne(U.value.length)+" ä¸ªæ¨¡å‹",1)])):de("",!0)]),e("div",Du,[d[36]||(d[36]=e("label",{for:"settingsAiVisionOcrPrompt"},"OCRæç¤ºè¯:",-1)),le(e("textarea",{id:"settingsAiVisionOcrPrompt","onUpdate:modelValue":d[15]||(d[15]=$=>S.value.prompt=$),rows:"3",placeholder:"AIè§†è§‰OCRæç¤ºè¯"},null,512),[[we,S.value.prompt]]),Ce(Ot,{"prompt-type":"ai_vision_ocr",onSelect:ae}),e("div",Mu,[Ce(Ve,{"model-value":D.value.aiVisionOcr.isJsonMode?"true":"false",options:a,onChange:d[16]||(d[16]=$=>{D.value.aiVisionOcr.isJsonMode=$==="true",G()})},null,8,["model-value"]),d[35]||(d[35]=e("span",{class:"input-hint"},"JSONæ ¼å¼è¾“å‡ºæ›´ç»“æ„åŒ–",-1))])]),e("div",Eu,[d[37]||(d[37]=e("label",{for:"settingsRpmAiVisionOcr"},"RPMé™åˆ¶ (æ¯åˆ†é’Ÿè¯·æ±‚æ•°):",-1)),le(e("input",{type:"number",id:"settingsRpmAiVisionOcr","onUpdate:modelValue":d[17]||(d[17]=$=>S.value.rpmLimit=$),min:"0",step:"1"},null,512),[[we,S.value.rpmLimit,void 0,{number:!0}]]),d[38]||(d[38]=e("div",{class:"input-hint"},"0 è¡¨ç¤ºæ— é™åˆ¶",-1))]),e("div",Bu,[d[39]||(d[39]=e("label",{for:"settingsMinImageSize"},"æœ€å°å›¾ç‰‡å°ºå¯¸ (åƒç´ ):",-1)),le(e("input",{type:"number",id:"settingsMinImageSize","onUpdate:modelValue":d[18]||(d[18]=$=>S.value.minImageSize=$),min:"0",step:"1"},null,512),[[we,S.value.minImageSize,void 0,{number:!0}]]),d[40]||(d[40]=e("div",{class:"input-hint"},"VLMæ¨¡å‹é€šå¸¸è¦æ±‚å›¾ç‰‡å°ºå¯¸ â‰¥28pxï¼Œè®¾ä¸º0åˆ™ä¸è‡ªåŠ¨æ”¾å¤§å°å›¾",-1))]),e("button",{class:"settings-test-btn",onClick:ee,disabled:q.value},ne(q.value?"æµ‹è¯•ä¸­...":"ğŸ”— æµ‹è¯•è¿æ¥"),9,Au)],512),[[Ue,D.value.ocrEngine==="ai_vision"]])]))}}),Fu=He(Lu,[["__scopeId","data-v-60d41103"]]),Uu={class:"translation-settings"},Ou={class:"settings-group"},zu={class:"settings-row"},Nu={class:"settings-item"},Vu={class:"settings-item"},Wu={for:"settingsApiKey"},Ku={class:"password-input-wrapper"},qu=["type","placeholder"],Hu={key:0,class:"eye-icon"},ju={key:1,class:"eye-off-icon"},Ju={class:"settings-item"},Yu={class:"settings-item"},Xu={for:"settingsModelName"},Gu={class:"model-input-with-fetch"},Zu=["placeholder"],Qu=["disabled"],ec={class:"fetch-text"},tc={key:0,class:"model-select-container"},oc={class:"model-count"},nc={class:"settings-item"},sc={class:"local-model-list"},ac={key:0,class:"model-list-container"},lc=["disabled"],ic={key:1,class:"model-hint"},rc={key:1,class:"model-list-container"},uc=["disabled"],cc={key:1,class:"model-hint"},dc={class:"settings-row"},gc={class:"settings-item"},pc={class:"settings-item"},mc={class:"settings-item"},vc={class:"input-hint translation-mode-hint"},fc={key:0},bc={key:1},hc={class:"settings-item"},xc=["disabled"],yc={class:"settings-item"},_c=["disabled"],Cc={class:"settings-group"},Sc={class:"settings-item"},kc={class:"prompt-format-selector"},wc={class:"settings-item"},$c={class:"checkbox-label"},Tc={class:"settings-item"},Ic=je({__name:"TranslationSettings",setup(n){const t=[{label:"SiliconFlow",value:"siliconflow"},{label:"DeepSeek",value:"deepseek"},{label:"ç«å±±å¼•æ“",value:"volcano"},{label:"å½©äº‘å°è¯‘",value:"caiyun"},{label:"ç™¾åº¦ç¿»è¯‘",value:"baidu_translate"},{label:"æœ‰é“ç¿»è¯‘",value:"youdao_translate"},{label:"Google Gemini",value:"gemini"},{label:"Ollama (æœ¬åœ°)",value:"ollama"},{label:"Sakura (æœ¬åœ°)",value:"sakura"},{label:"è‡ªå®šä¹‰ OpenAI å…¼å®¹æœåŠ¡",value:"custom_openai"}],s=[{label:"æ™®é€šæç¤ºè¯",value:"normal"},{label:"JSONæç¤ºè¯",value:"json"}],o=[{label:"æ•´é¡µæ‰¹é‡ç¿»è¯‘ (æ¨è)",value:"batch"},{label:"é€æ°”æ³¡ç¿»è¯‘ (é€‚åˆå°æ¨¡å‹)",value:"single"}],l=Ne(),u=ct(),a=l.settings.translation.translationMode||"batch",c=l.settings.translation.isJsonMode||!1,v=()=>{const g=l.settings.translation;return a==="single"?c?g.singleJsonPrompt:g.singleNormalPrompt:c?g.batchJsonPrompt:g.batchNormalPrompt},p=w({modelProvider:l.settings.translation.provider,apiKey:l.settings.translation.apiKey,modelName:l.settings.translation.modelName,customBaseUrl:l.settings.translation.customBaseUrl,rpmTranslation:l.settings.translation.rpmLimit,translationMaxRetries:l.settings.translation.maxRetries,translationMode:a,promptContent:v(),translatePromptMode:c?"json":"normal",enableTextboxPrompt:l.settings.useTextboxPrompt,textboxPromptContent:l.settings.textboxPrompt}),_=w(!1),S=w(!1),D=w(!1),M=w([]),E=w([]),P=w([]),q=Z(()=>{const g=[{label:"-- é€‰æ‹©æ¨¡å‹ --",value:""}];return M.value.forEach(b=>g.push({label:b,value:b})),g}),V=Z(()=>{const g=[{label:"-- é€‰æ‹©æ¨¡å‹ --",value:""}];return E.value.forEach(b=>g.push({label:b,value:b})),g}),U=Z(()=>{const g=[{label:"-- é€‰æ‹©æ¨¡å‹ --",value:""}];return P.value.forEach(b=>g.push({label:b,value:b})),g}),f=Z(()=>["ollama","sakura"].includes(p.value.modelProvider)),m=Z(()=>!["ollama","sakura","caiyun","baidu_translate","youdao_translate"].includes(p.value.modelProvider)),C=Z(()=>["siliconflow","deepseek","volcano","gemini","custom_openai"].includes(p.value.modelProvider)),k=Z(()=>{switch(p.value.modelProvider){case"baidu_translate":return"App ID";case"youdao_translate":return"App Key";case"caiyun":return"API Token";default:return"API Key"}}),K=Z(()=>{switch(p.value.modelProvider){case"baidu_translate":return"è¯·è¾“å…¥ç™¾åº¦ç¿»è¯‘App ID";case"youdao_translate":return"è¯·è¾“å…¥æœ‰é“ç¿»è¯‘åº”ç”¨ID";case"caiyun":return"è¯·è¾“å…¥å½©äº‘å°è¯‘Token";default:return"è¯·è¾“å…¥API Key"}}),N=Z(()=>{switch(p.value.modelProvider){case"baidu_translate":return"App Key";case"youdao_translate":return"App Secret";case"caiyun":return"æºè¯­è¨€ (å¯é€‰)";default:return"æ¨¡å‹åç§°"}}),se=Z(()=>{switch(p.value.modelProvider){case"baidu_translate":return"è¯·è¾“å…¥ç™¾åº¦ç¿»è¯‘App Key";case"youdao_translate":return"è¯·è¾“å…¥æœ‰é“ç¿»è¯‘åº”ç”¨å¯†é’¥";case"caiyun":return"å¯é€‰: auto/æ—¥è¯­/è‹±è¯­";default:return"è¯·è¾“å…¥æ¨¡å‹åç§°"}});function G(){const g=p.value.modelProvider;l.setTranslationProvider(g),p.value.apiKey=l.settings.translation.apiKey,p.value.modelName=l.settings.translation.modelName,p.value.customBaseUrl=l.settings.translation.customBaseUrl,p.value.rpmTranslation=l.settings.translation.rpmLimit,p.value.translationMaxRetries=l.settings.translation.maxRetries,p.value.translationMode=l.settings.translation.translationMode||"batch",M.value=[]}function J(){const g=p.value.translatePromptMode==="json",b=!g,L=p.value.translationMode==="single";L?b?l.updateTranslationService({singleJsonPrompt:p.value.promptContent}):l.updateTranslationService({singleNormalPrompt:p.value.promptContent}):b?l.updateTranslationService({batchJsonPrompt:p.value.promptContent}):l.updateTranslationService({batchNormalPrompt:p.value.promptContent});const W=l.settings.translation;let i;L?i=g?W.singleJsonPrompt:W.singleNormalPrompt:i=g?W.batchJsonPrompt:W.batchNormalPrompt,p.value.promptContent=i,l.updateTranslationService({isJsonMode:g}),l.setTranslatePrompt(i)}function ee(g){const b=String(g),L=p.value.translationMode,W=p.value.translatePromptMode==="json";if(b===L)return;L==="batch"?W?l.updateTranslationService({batchJsonPrompt:p.value.promptContent}):l.updateTranslationService({batchNormalPrompt:p.value.promptContent}):W?l.updateTranslationService({singleJsonPrompt:p.value.promptContent}):l.updateTranslationService({singleNormalPrompt:p.value.promptContent}),p.value.translationMode=b,l.updateTranslationService({translationMode:b});const i=l.settings.translation;let x;b==="single"?x=W?i.singleJsonPrompt:i.singleNormalPrompt:x=W?i.batchJsonPrompt:i.batchNormalPrompt,p.value.promptContent=x,l.setTranslatePrompt(x),console.log(`ç¿»è¯‘æ¨¡å¼å·²åˆ‡æ¢ä¸º: ${b==="batch"?"æ•´é¡µæ‰¹é‡ç¿»è¯‘":"é€æ°”æ³¡ç¿»è¯‘"}`)}Se(()=>p.value.apiKey,g=>{l.updateTranslationService({apiKey:g})}),Se(()=>p.value.modelName,g=>{l.updateTranslationService({modelName:g})}),Se(()=>p.value.customBaseUrl,g=>{l.updateTranslationService({customBaseUrl:g})}),Se(()=>p.value.rpmTranslation,g=>{l.updateTranslationService({rpmLimit:g})}),Se(()=>p.value.translationMaxRetries,g=>{l.updateTranslationService({maxRetries:g})}),Se(()=>p.value.promptContent,g=>{l.setTranslatePrompt(g);const b=p.value.translationMode==="batch",L=p.value.translatePromptMode==="json";b?L?l.updateTranslationService({batchJsonPrompt:g}):l.updateTranslationService({batchNormalPrompt:g}):L?l.updateTranslationService({singleJsonPrompt:g}):l.updateTranslationService({singleNormalPrompt:g})}),Se(()=>p.value.enableTextboxPrompt,g=>{l.setUseTextboxPrompt(g)}),Se(()=>p.value.textboxPromptContent,g=>{l.setTextboxPrompt(g)});async function j(){const g=p.value.modelProvider,b=p.value.apiKey?.trim(),L=p.value.customBaseUrl?.trim();if(!b){u.warning("è¯·å…ˆå¡«å†™ API Key");return}if(!["siliconflow","deepseek","volcano","gemini","custom_openai"].includes(g)){u.warning(`${ae(g)} ä¸æ”¯æŒè‡ªåŠ¨è·å–æ¨¡å‹åˆ—è¡¨`);return}if(g==="custom_openai"&&!L){u.warning("è‡ªå®šä¹‰æœåŠ¡éœ€è¦å…ˆå¡«å†™ Base URL");return}D.value=!0;try{const i=await Ke.fetchModels(g,b,L);i.success&&i.models&&i.models.length>0?(M.value=i.models.map(x=>x.id),u.success(`è·å–åˆ° ${i.models.length} ä¸ªæ¨¡å‹`)):u.warning(i.message||"æœªè·å–åˆ°å¯ç”¨æ¨¡å‹")}catch(i){const x=i instanceof Error?i.message:"è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥";u.error(x)}finally{D.value=!1}}function ae(g){return{siliconflow:"SiliconFlow",deepseek:"DeepSeek",volcano:"ç«å±±å¼•æ“",gemini:"Google Gemini",custom_openai:"è‡ªå®šä¹‰OpenAI",ollama:"Ollama",sakura:"Sakura",caiyun:"å½©äº‘å°è¯‘",baidu_translate:"ç™¾åº¦ç¿»è¯‘",youdao_translate:"æœ‰é“ç¿»è¯‘"}[g]||g}async function A(){D.value=!0;try{const g=await Ke.testOllamaConnection();g.success&&g.models?(E.value=g.models,u.success(`è·å–åˆ° ${g.models.length} ä¸ªOllamaæ¨¡å‹`)):u.error(g.error||"Ollamaè¿æ¥å¤±è´¥")}catch(g){const b=g instanceof Error?g.message:"è·å–Ollamaæ¨¡å‹å¤±è´¥";u.error(b)}finally{D.value=!1}}async function d(){D.value=!0;try{const g=await Ke.testSakuraConnection();g.success&&g.models?(P.value=g.models,u.success(`è·å–åˆ° ${g.models.length} ä¸ªSakuraæ¨¡å‹`)):u.error(g.error||"Sakuraè¿æ¥å¤±è´¥")}catch(g){const b=g instanceof Error?g.message:"è·å–Sakuraæ¨¡å‹å¤±è´¥";u.error(b)}finally{D.value=!1}}async function $(){S.value=!0;try{let g;p.value.modelProvider==="ollama"?g=await Ke.testOllamaConnection():g=await Ke.testSakuraConnection(),g.success?u.success(`${p.value.modelProvider==="ollama"?"Ollama":"Sakura"} è¿æ¥æˆåŠŸ`):u.error(g.error||"è¿æ¥å¤±è´¥")}catch(g){const b=g instanceof Error?g.message:"è¿æ¥æµ‹è¯•å¤±è´¥";u.error(b)}finally{S.value=!1}}async function r(){const g=p.value.modelProvider,b=p.value.apiKey?.trim(),L=p.value.modelName?.trim(),W=p.value.customBaseUrl?.trim();if(!b){u.warning("è¯·å…ˆå¡«å†™ API Key");return}if(g!=="caiyun"&&!L){u.warning("è¯·å¡«å†™æ¨¡å‹åç§°");return}if(g==="custom_openai"&&!W){u.warning("è‡ªå®šä¹‰æœåŠ¡éœ€è¦å¡«å†™ Base URL");return}S.value=!0,u.info("æ­£åœ¨æµ‹è¯•è¿æ¥...");try{let i;switch(g){case"baidu_translate":i=await Ke.testBaiduTranslateConnection(b,L);break;case"youdao_translate":i=await Ke.testYoudaoTranslateConnection(b,L);break;default:i=await Ke.testAiTranslateConnection({provider:g,apiKey:b,modelName:L,baseUrl:W})}i.success?u.success(i.message||`${ae(g)} è¿æ¥æˆåŠŸ!`):u.error(i.message||i.error||"è¿æ¥å¤±è´¥")}catch(i){const x=i instanceof Error?i.message:"è¿æ¥æµ‹è¯•å¤±è´¥";u.error(x)}finally{S.value=!1}}function h(g,b){p.value.promptContent=g,u.success(`å·²åº”ç”¨æç¤ºè¯: ${b}`)}function I(g,b){p.value.textboxPromptContent=g,u.success(`å·²åº”ç”¨æç¤ºè¯: ${b}`)}function T(){const g=p.value.translatePromptMode==="json";p.value.translationMode==="single"?p.value.promptContent=g?ps:ms:p.value.promptContent=g?vs:fs,u.success("å·²é‡ç½®ä¸ºé»˜è®¤æç¤ºè¯")}return(g,b)=>(B(),F("div",Uu,[e("div",Ou,[b[22]||(b[22]=e("div",{class:"settings-group-title"},"ç¿»è¯‘æœåŠ¡é…ç½®",-1)),e("div",zu,[e("div",Nu,[b[14]||(b[14]=e("label",{for:"settingsModelProvider"},"ç¿»è¯‘æœåŠ¡å•†:",-1)),Ce(Ve,{"model-value":p.value.modelProvider,options:t,onChange:b[0]||(b[0]=L=>{p.value.modelProvider=L,G()})},null,8,["model-value"])]),le(e("div",Vu,[e("label",Wu,ne(k.value)+":",1),e("div",Ku,[le(e("input",{type:_.value?"text":"password",id:"settingsApiKey","onUpdate:modelValue":b[1]||(b[1]=L=>p.value.apiKey=L),class:"secure-input",placeholder:K.value,autocomplete:"off"},null,8,qu),[[$t,p.value.apiKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:b[2]||(b[2]=L=>_.value=!_.value)},[_.value?(B(),F("span",ju,"ğŸ‘â€ğŸ—¨")):(B(),F("span",Hu,"ğŸ‘"))])])],512),[[Ue,!f.value]])]),le(e("div",Ju,[b[15]||(b[15]=e("label",{for:"settingsCustomBaseUrl"},"Base URL:",-1)),le(e("input",{type:"text",id:"settingsCustomBaseUrl","onUpdate:modelValue":b[3]||(b[3]=L=>p.value.customBaseUrl=L),placeholder:"ä¾‹å¦‚: https://api.example.com/v1"},null,512),[[we,p.value.customBaseUrl]])],512),[[Ue,p.value.modelProvider==="custom_openai"]]),le(e("div",Yu,[e("label",Xu,ne(N.value)+":",1),e("div",Gu,[le(e("input",{type:"text",id:"settingsModelName","onUpdate:modelValue":b[4]||(b[4]=L=>p.value.modelName=L),placeholder:se.value},null,8,Zu),[[we,p.value.modelName]]),le(e("button",{type:"button",class:"fetch-models-btn",title:"è·å–å¯ç”¨æ¨¡å‹åˆ—è¡¨",onClick:j,disabled:D.value},[b[16]||(b[16]=e("span",{class:"fetch-icon"},"ğŸ”",-1)),e("span",ec,ne(D.value?"è·å–ä¸­...":"è·å–æ¨¡å‹"),1)],8,Qu),[[Ue,C.value]])]),M.value.length>0?(B(),F("div",tc,[Ce(Ve,{"model-value":p.value.modelName,options:q.value,onChange:b[5]||(b[5]=L=>{p.value.modelName=L})},null,8,["model-value","options"]),e("span",oc,"å…± "+ne(M.value.length)+" ä¸ªæ¨¡å‹",1)])):de("",!0)],512),[[Ue,!f.value]]),le(e("div",nc,[b[17]||(b[17]=e("label",null,"æœ¬åœ°æ¨¡å‹:",-1)),e("div",sc,[p.value.modelProvider==="ollama"?(B(),F("div",ac,[e("button",{class:"settings-test-btn",onClick:A,disabled:D.value},ne(D.value?"è·å–ä¸­...":"ğŸ”„ åˆ·æ–°æ¨¡å‹åˆ—è¡¨"),9,lc),E.value.length>0?(B(),ut(Ve,{key:0,"model-value":p.value.modelName,options:V.value,onChange:b[6]||(b[6]=L=>p.value.modelName=L)},null,8,["model-value","options"])):(B(),F("p",ic,"ç‚¹å‡»åˆ·æ–°è·å–å¯ç”¨æ¨¡å‹"))])):p.value.modelProvider==="sakura"?(B(),F("div",rc,[e("button",{class:"settings-test-btn",onClick:d,disabled:D.value},ne(D.value?"è·å–ä¸­...":"ğŸ”„ åˆ·æ–°æ¨¡å‹åˆ—è¡¨"),9,uc),P.value.length>0?(B(),ut(Ve,{key:0,"model-value":p.value.modelName,options:U.value,onChange:b[7]||(b[7]=L=>p.value.modelName=L)},null,8,["model-value","options"])):(B(),F("p",cc,"ç‚¹å‡»åˆ·æ–°è·å–å¯ç”¨æ¨¡å‹"))])):de("",!0)])],512),[[Ue,f.value]]),le(e("div",dc,[e("div",gc,[b[18]||(b[18]=e("label",{for:"settingsRpmTranslation"},"RPMé™åˆ¶:",-1)),le(e("input",{type:"number",id:"settingsRpmTranslation","onUpdate:modelValue":b[8]||(b[8]=L=>p.value.rpmTranslation=L),min:"0",step:"1"},null,512),[[we,p.value.rpmTranslation,void 0,{number:!0}]]),b[19]||(b[19]=e("div",{class:"input-hint"},"æ¯åˆ†é’Ÿè¯·æ±‚æ•°ï¼Œ0è¡¨ç¤ºæ— é™åˆ¶",-1))]),e("div",pc,[b[20]||(b[20]=e("label",{for:"settingsTranslationMaxRetries"},"é‡è¯•æ¬¡æ•°:",-1)),le(e("input",{type:"number",id:"settingsTranslationMaxRetries","onUpdate:modelValue":b[9]||(b[9]=L=>p.value.translationMaxRetries=L),min:"0",max:"10",step:"1"},null,512),[[we,p.value.translationMaxRetries,void 0,{number:!0}]])])],512),[[Ue,m.value]]),e("div",mc,[b[21]||(b[21]=e("label",{for:"settingsTranslationMode"},"ç¿»è¯‘æ¨¡å¼:",-1)),Ce(Ve,{"model-value":p.value.translationMode,options:o,onChange:ee},null,8,["model-value"]),e("div",vc,[p.value.translationMode==="batch"?(B(),F("span",fc," ğŸ’¡ æ•´é¡µæ‰¹é‡ç¿»è¯‘ï¼šä¸€æ¬¡å‘é€å…¨éƒ¨æ°”æ³¡ï¼Œæ•ˆç‡é«˜ï¼Œéœ€è¦æ¨¡å‹æ”¯æŒå¤æ‚æŒ‡ä»¤ ")):(B(),F("span",bc," ğŸ’¡ é€æ°”æ³¡ç¿»è¯‘ï¼šæ¯ä¸ªæ°”æ³¡å•ç‹¬ç¿»è¯‘ï¼Œæ›´ç¨³å®šï¼Œé€‚åˆå°æ¨¡å‹æˆ–æ ¼å¼æ•æ„Ÿåœºæ™¯ "))])]),le(e("div",hc,[e("button",{class:"settings-test-btn",onClick:$,disabled:S.value},ne(S.value?"æµ‹è¯•ä¸­...":"ğŸ”— æµ‹è¯•è¿æ¥"),9,xc)],512),[[Ue,f.value]]),le(e("div",yc,[e("button",{class:"settings-test-btn",onClick:r,disabled:S.value},ne(S.value?"æµ‹è¯•ä¸­...":"ğŸ”— æµ‹è¯•è¿æ¥"),9,_c)],512),[[Ue,!f.value]])]),e("div",Cc,[b[27]||(b[27]=e("div",{class:"settings-group-title"},"æç¤ºè¯è®¾ç½®",-1)),e("div",Sc,[b[24]||(b[24]=e("label",{for:"settingsPromptContent"},"ç¿»è¯‘æç¤ºè¯:",-1)),le(e("textarea",{id:"settingsPromptContent","onUpdate:modelValue":b[10]||(b[10]=L=>p.value.promptContent=L),rows:"4",placeholder:"ç¿»è¯‘æç¤ºè¯"},null,512),[[we,p.value.promptContent]]),e("div",kc,[Ce(Ve,{"model-value":p.value.translatePromptMode,options:s,onChange:b[11]||(b[11]=L=>{p.value.translatePromptMode=L,J()})},null,8,["model-value"]),b[23]||(b[23]=e("span",{class:"input-hint"},"JSONæ ¼å¼è¾“å‡ºæ›´ç»“æ„åŒ–",-1))]),Ce(Ot,{"prompt-type":"translate",onSelect:h}),e("button",{type:"button",class:"reset-btn",onClick:T}," é‡ç½®ä¸ºé»˜è®¤ ")]),e("div",wc,[e("label",$c,[le(e("input",{type:"checkbox","onUpdate:modelValue":b[12]||(b[12]=L=>p.value.enableTextboxPrompt=L)},null,512),[[nt,p.value.enableTextboxPrompt]]),b[25]||(b[25]=me(" å¯ç”¨æ–‡æœ¬æ¡†æç¤ºè¯ ",-1))])]),le(e("div",Tc,[b[26]||(b[26]=e("label",{for:"settingsTextboxPromptContent"},"æ–‡æœ¬æ¡†æç¤ºè¯:",-1)),le(e("textarea",{id:"settingsTextboxPromptContent","onUpdate:modelValue":b[13]||(b[13]=L=>p.value.textboxPromptContent=L),rows:"3",placeholder:"æ–‡æœ¬æ¡†æç¤ºè¯"},null,512),[[we,p.value.textboxPromptContent]]),Ce(Ot,{"prompt-type":"textbox",onSelect:I})],512),[[Ue,p.value.enableTextboxPrompt]])])]))}}),Pc=He(Ic,[["__scopeId","data-v-77166b20"]]),Rc={class:"detection-settings"},Dc={class:"settings-group"},Mc={class:"settings-item"},Ec={class:"settings-group"},Bc={class:"settings-item"},Ac={class:"settings-row"},Lc={class:"settings-item"},Fc={class:"settings-item"},Uc={class:"settings-row"},Oc={class:"settings-item"},zc={class:"settings-item"},Nc={class:"settings-group"},Vc={class:"settings-item"},Wc={class:"checkbox-label"},Kc={class:"settings-row"},qc={class:"settings-item"},Hc={class:"settings-item"},jc={class:"settings-group"},Jc={class:"settings-item"},Yc={class:"checkbox-label"},Xc=je({__name:"DetectionSettings",setup(n){const t=[{label:"CTD (Comic Text Detector)",value:"ctd"},{label:"YOLO",value:"yolo"},{label:"YOLOv5",value:"yolov5"},{label:"Default (DBNet)",value:"default"}],s=Ne(),o=ho({textDetector:s.settings.textDetector,boxExpandRatio:s.settings.boxExpand.ratio,boxExpandTop:s.settings.boxExpand.top,boxExpandBottom:s.settings.boxExpand.bottom,boxExpandLeft:s.settings.boxExpand.left,boxExpandRight:s.settings.boxExpand.right,usePreciseMask:s.settings.preciseMask.enabled,maskDilateSize:s.settings.preciseMask.dilateSize,maskBoxExpandRatio:s.settings.preciseMask.boxExpandRatio,showDetectionDebug:s.settings.showDetectionDebug}),l=Z(()=>["ctd","default"].includes(o.textDetector));Se(()=>o.textDetector,a=>{s.setTextDetector(a)}),Se(()=>o.boxExpandRatio,a=>{s.updateBoxExpand({ratio:a})}),Se(()=>o.boxExpandTop,a=>{s.updateBoxExpand({top:a})}),Se(()=>o.boxExpandBottom,a=>{s.updateBoxExpand({bottom:a})}),Se(()=>o.boxExpandLeft,a=>{s.updateBoxExpand({left:a})}),Se(()=>o.boxExpandRight,a=>{s.updateBoxExpand({right:a})}),Se(()=>o.usePreciseMask,a=>{s.updatePreciseMask({enabled:a})}),Se(()=>o.maskDilateSize,a=>{s.updatePreciseMask({dilateSize:a})}),Se(()=>o.maskBoxExpandRatio,a=>{s.updatePreciseMask({boxExpandRatio:a})}),Se(()=>o.showDetectionDebug,a=>{s.setShowDetectionDebug(a)});function u(){l.value||(o.usePreciseMask=!1)}return(a,c)=>(B(),F("div",Rc,[e("div",Dc,[c[11]||(c[11]=e("div",{class:"settings-group-title"},"æ–‡å­—æ£€æµ‹å™¨",-1)),e("div",Mc,[c[10]||(c[10]=e("label",{for:"settingsTextDetector"},"æ£€æµ‹å™¨ç±»å‹:",-1)),Ce(Ve,{modelValue:o.textDetector,"onUpdate:modelValue":c[0]||(c[0]=v=>o.textDetector=v),options:t,onChange:u},null,8,["modelValue"])])]),e("div",Ec,[c[18]||(c[18]=e("div",{class:"settings-group-title"},"æ–‡æœ¬æ¡†æ‰©å±•å‚æ•°",-1)),e("div",Bc,[c[12]||(c[12]=e("label",{for:"settingsBoxExpandRatio"},"æ•´ä½“æ‰©å±• (%):",-1)),le(e("input",{type:"number",id:"settingsBoxExpandRatio","onUpdate:modelValue":c[1]||(c[1]=v=>o.boxExpandRatio=v),min:"0",max:"50",step:"1"},null,512),[[we,o.boxExpandRatio,void 0,{number:!0}]]),c[13]||(c[13]=e("div",{class:"input-hint"},"å‘å››å‘¨å‡åŒ€æ‰©å±•çš„ç™¾åˆ†æ¯” (0-50%)",-1))]),e("div",Ac,[e("div",Lc,[c[14]||(c[14]=e("label",{for:"settingsBoxExpandTop"},"ä¸Šæ–¹æ‰©å±• (%):",-1)),le(e("input",{type:"number",id:"settingsBoxExpandTop","onUpdate:modelValue":c[2]||(c[2]=v=>o.boxExpandTop=v),min:"0",max:"50",step:"1"},null,512),[[we,o.boxExpandTop,void 0,{number:!0}]])]),e("div",Fc,[c[15]||(c[15]=e("label",{for:"settingsBoxExpandBottom"},"ä¸‹æ–¹æ‰©å±• (%):",-1)),le(e("input",{type:"number",id:"settingsBoxExpandBottom","onUpdate:modelValue":c[3]||(c[3]=v=>o.boxExpandBottom=v),min:"0",max:"50",step:"1"},null,512),[[we,o.boxExpandBottom,void 0,{number:!0}]])])]),e("div",Uc,[e("div",Oc,[c[16]||(c[16]=e("label",{for:"settingsBoxExpandLeft"},"å·¦ä¾§æ‰©å±• (%):",-1)),le(e("input",{type:"number",id:"settingsBoxExpandLeft","onUpdate:modelValue":c[4]||(c[4]=v=>o.boxExpandLeft=v),min:"0",max:"50",step:"1"},null,512),[[we,o.boxExpandLeft,void 0,{number:!0}]])]),e("div",zc,[c[17]||(c[17]=e("label",{for:"settingsBoxExpandRight"},"å³ä¾§æ‰©å±• (%):",-1)),le(e("input",{type:"number",id:"settingsBoxExpandRight","onUpdate:modelValue":c[5]||(c[5]=v=>o.boxExpandRight=v),min:"0",max:"50",step:"1"},null,512),[[we,o.boxExpandRight,void 0,{number:!0}]])])])]),le(e("div",Nc,[c[25]||(c[25]=e("div",{class:"settings-group-title"},"ç²¾ç¡®æ–‡å­—æ©è†œ",-1)),e("div",Vc,[e("label",Wc,[le(e("input",{type:"checkbox","onUpdate:modelValue":c[6]||(c[6]=v=>o.usePreciseMask=v)},null,512),[[nt,o.usePreciseMask]]),c[19]||(c[19]=me(" å¯ç”¨ç²¾ç¡®æ–‡å­—æ©è†œ ",-1))]),c[20]||(c[20]=e("div",{class:"input-hint"},"ä½¿ç”¨æ›´ç²¾ç¡®çš„æ–‡å­—åŒºåŸŸæ©è†œè¿›è¡Œä¿®å¤",-1))]),le(e("div",Kc,[e("div",qc,[c[21]||(c[21]=e("label",{for:"settingsMaskDilateSize"},"è†¨èƒ€å¤§å°:",-1)),le(e("input",{type:"number",id:"settingsMaskDilateSize","onUpdate:modelValue":c[7]||(c[7]=v=>o.maskDilateSize=v),min:"0",step:"1"},null,512),[[we,o.maskDilateSize,void 0,{number:!0}]]),c[22]||(c[22]=e("div",{class:"input-hint"},"æ©è†œè†¨èƒ€åƒç´ æ•°",-1))]),e("div",Hc,[c[23]||(c[23]=e("label",{for:"settingsMaskBoxExpandRatio"},"æ ‡æ³¨æ¡†æ‰©å¤§æ¯”ä¾‹ (%):",-1)),le(e("input",{type:"number",id:"settingsMaskBoxExpandRatio","onUpdate:modelValue":c[8]||(c[8]=v=>o.maskBoxExpandRatio=v),min:"0",max:"100",step:"1"},null,512),[[we,o.maskBoxExpandRatio,void 0,{number:!0}]]),c[24]||(c[24]=e("div",{class:"input-hint"},"æ ‡æ³¨æ¡†åŒºåŸŸæ‰©å¤§ç™¾åˆ†æ¯”",-1))])],512),[[Ue,o.usePreciseMask]])],512),[[Ue,l.value]]),e("div",jc,[c[28]||(c[28]=e("div",{class:"settings-group-title"},"è°ƒè¯•é€‰é¡¹",-1)),e("div",Jc,[e("label",Yc,[le(e("input",{type:"checkbox","onUpdate:modelValue":c[9]||(c[9]=v=>o.showDetectionDebug=v)},null,512),[[nt,o.showDetectionDebug]]),c[26]||(c[26]=me(" æ˜¾ç¤ºæ£€æµ‹æ¡†è°ƒè¯•ä¿¡æ¯ ",-1))]),c[27]||(c[27]=e("div",{class:"input-hint"},"åœ¨ç¿»è¯‘ç»“æœä¸­æ˜¾ç¤ºæ°”æ³¡æ£€æµ‹æ¡†ï¼Œç”¨äºè°ƒè¯•",-1))])])]))}}),Gc=He(Xc,[["__scopeId","data-v-c12c43ee"]]),Zc={class:"hq-translation-settings"},Qc={class:"settings-group"},ed={class:"settings-row"},td={class:"settings-item"},od={class:"settings-item"},nd={class:"password-input-wrapper"},sd=["type"],ad={key:0,class:"eye-icon"},ld={key:1,class:"eye-off-icon"},id={class:"settings-item"},rd={class:"settings-item"},ud={class:"model-input-with-fetch"},cd=["disabled"],dd={class:"fetch-text"},gd={key:0,class:"model-select-container"},pd={class:"model-count"},md={class:"settings-item"},vd=["disabled"],fd={class:"settings-group"},bd={class:"settings-row"},hd={class:"settings-item"},xd={class:"settings-item"},yd={class:"settings-row"},_d={class:"settings-item"},Cd={class:"settings-item"},Sd={class:"settings-group"},kd={class:"settings-row"},wd={class:"settings-item"},$d={class:"checkbox-label"},Td={class:"settings-item"},Id={class:"settings-row"},Pd={class:"settings-item"},Rd={class:"checkbox-label"},Dd={class:"settings-item"},Md={class:"checkbox-label"},Ed={class:"settings-group"},Bd={class:"settings-item"},Ad=je({__name:"HqTranslationSettings",setup(n){const t=[{label:"SiliconFlow",value:"siliconflow"},{label:"DeepSeek",value:"deepseek"},{label:"ç«å±±å¼•æ“",value:"volcano"},{label:"Google Gemini",value:"gemini"},{label:"è‡ªå®šä¹‰ OpenAI å…¼å®¹æœåŠ¡",value:"custom_openai"}],s=[{label:"Geminié£æ ¼ (reasoning_effort=low)",value:"gemini"},{label:"ç«å±±å¼•æ“é£æ ¼ (thinking=null)",value:"volcano"}],o=Ne(),l=ct(),u=Z(()=>o.settings.hqTranslation),a=w({apiKey:o.settings.hqTranslation.apiKey,modelName:o.settings.hqTranslation.modelName,customBaseUrl:o.settings.hqTranslation.customBaseUrl,batchSize:o.settings.hqTranslation.batchSize,sessionReset:o.settings.hqTranslation.sessionReset,rpmLimit:o.settings.hqTranslation.rpmLimit,maxRetries:o.settings.hqTranslation.maxRetries,lowReasoning:o.settings.hqTranslation.lowReasoning,noThinkingMethod:o.settings.hqTranslation.noThinkingMethod,forceJsonOutput:o.settings.hqTranslation.forceJsonOutput,useStream:o.settings.hqTranslation.useStream,prompt:o.settings.hqTranslation.prompt});Se(()=>a.value.apiKey,f=>{o.updateHqTranslation({apiKey:f})}),Se(()=>a.value.modelName,f=>{o.updateHqTranslation({modelName:f})}),Se(()=>a.value.customBaseUrl,f=>{o.updateHqTranslation({customBaseUrl:f})}),Se(()=>a.value.batchSize,f=>{o.updateHqTranslation({batchSize:f})}),Se(()=>a.value.sessionReset,f=>{o.updateHqTranslation({sessionReset:f})}),Se(()=>a.value.rpmLimit,f=>{o.updateHqTranslation({rpmLimit:f})}),Se(()=>a.value.maxRetries,f=>{o.updateHqTranslation({maxRetries:f})}),Se(()=>a.value.lowReasoning,f=>{o.updateHqTranslation({lowReasoning:f})}),Se(()=>a.value.noThinkingMethod,f=>{o.updateHqTranslation({noThinkingMethod:f})}),Se(()=>a.value.forceJsonOutput,f=>{o.updateHqTranslation({forceJsonOutput:f})}),Se(()=>a.value.useStream,f=>{o.updateHqTranslation({useStream:f})}),Se(()=>a.value.prompt,f=>{o.updateHqTranslation({prompt:f})});const c=w(!1),v=w(!1),p=w([]),_=w(!1),S=Z(()=>{const f=[{label:"-- é€‰æ‹©æ¨¡å‹ --",value:""}];return p.value.forEach(m=>f.push({label:m,value:m})),f});function D(f){o.setHqProvider(f),p.value=[],M()}function M(){const f=o.settings.hqTranslation;a.value.apiKey=f.apiKey,a.value.modelName=f.modelName,a.value.customBaseUrl=f.customBaseUrl,a.value.batchSize=f.batchSize,a.value.sessionReset=f.sessionReset,a.value.rpmLimit=f.rpmLimit,a.value.maxRetries=f.maxRetries,a.value.lowReasoning=f.lowReasoning,a.value.noThinkingMethod=f.noThinkingMethod,a.value.forceJsonOutput=f.forceJsonOutput,a.value.useStream=f.useStream,a.value.prompt=f.prompt}function E(f){return{siliconflow:"SiliconFlow",deepseek:"DeepSeek",volcano:"ç«å±±å¼•æ“",gemini:"Google Gemini",custom_openai:"è‡ªå®šä¹‰OpenAI"}[f]||f}async function P(){const f=u.value.provider,m=a.value.apiKey?.trim(),C=a.value.customBaseUrl?.trim();if(!m){l.warning("è¯·å…ˆå¡«å†™ API Key");return}if(!["siliconflow","deepseek","volcano","gemini","custom_openai"].includes(f)){l.warning(`${E(f)} ä¸æ”¯æŒè‡ªåŠ¨è·å–æ¨¡å‹åˆ—è¡¨`);return}if(f==="custom_openai"&&!C){l.warning("è‡ªå®šä¹‰æœåŠ¡éœ€è¦å…ˆå¡«å†™ Base URL");return}v.value=!0;try{const K=await Ke.fetchModels(f,m,C);K.success&&K.models&&K.models.length>0?(p.value=K.models.map(N=>N.id),l.success(`è·å–åˆ° ${K.models.length} ä¸ªæ¨¡å‹`)):l.warning(K.message||"æœªè·å–åˆ°å¯ç”¨æ¨¡å‹")}catch(K){const N=K instanceof Error?K.message:"è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥";l.error(N)}finally{v.value=!1}}async function q(){const f=u.value.provider,m=a.value.apiKey?.trim(),C=a.value.modelName?.trim(),k=a.value.customBaseUrl?.trim();if(!m){l.warning("è¯·å…ˆå¡«å†™ API Key");return}if(!C){l.warning("è¯·å¡«å†™æ¨¡å‹åç§°");return}if(f==="custom_openai"&&!k){l.warning("è‡ªå®šä¹‰æœåŠ¡éœ€è¦å¡«å†™ Base URL");return}_.value=!0,l.info("æ­£åœ¨æµ‹è¯•è¿æ¥...");try{const K=await Ke.testAiTranslateConnection({provider:f,apiKey:m,modelName:C,baseUrl:k});K.success?l.success(K.message||`${E(f)} è¿æ¥æˆåŠŸ!`):l.error(K.message||K.error||"è¿æ¥å¤±è´¥")}catch(K){const N=K instanceof Error?K.message:"è¿æ¥æµ‹è¯•å¤±è´¥";l.error(N)}finally{_.value=!1}}function V(){o.updateHqTranslation({prompt:Zo}),a.value.prompt=Zo,l.success("å·²é‡ç½®ä¸ºé»˜è®¤æç¤ºè¯")}function U(f,m){o.updateHqTranslation({prompt:f}),a.value.prompt=f,l.success(`å·²åº”ç”¨æç¤ºè¯: ${m}`)}return(f,m)=>(B(),F("div",Zc,[e("div",Qc,[m[20]||(m[20]=e("div",{class:"settings-group-title"},"é«˜è´¨é‡ç¿»è¯‘æœåŠ¡é…ç½®",-1)),e("div",ed,[e("div",td,[m[15]||(m[15]=e("label",{for:"settingsHqTranslateProvider"},"æœåŠ¡å•†:",-1)),Ce(Ve,{"model-value":u.value.provider,options:t,onChange:m[0]||(m[0]=C=>D(C))},null,8,["model-value"])]),e("div",od,[m[16]||(m[16]=e("label",{for:"settingsHqApiKey"},"API Key:",-1)),e("div",nd,[le(e("input",{type:c.value?"text":"password",id:"settingsHqApiKey","onUpdate:modelValue":m[1]||(m[1]=C=>a.value.apiKey=C),class:"secure-input",placeholder:"è¯·è¾“å…¥API Key",autocomplete:"off"},null,8,sd),[[$t,a.value.apiKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:m[2]||(m[2]=C=>c.value=!c.value)},[c.value?(B(),F("span",ld,"ğŸ‘â€ğŸ—¨")):(B(),F("span",ad,"ğŸ‘"))])])])]),le(e("div",id,[m[17]||(m[17]=e("label",{for:"settingsHqCustomBaseUrl"},"Base URL:",-1)),le(e("input",{type:"text",id:"settingsHqCustomBaseUrl","onUpdate:modelValue":m[3]||(m[3]=C=>a.value.customBaseUrl=C),placeholder:"ä¾‹å¦‚: https://api.example.com/v1"},null,512),[[we,a.value.customBaseUrl]])],512),[[Ue,u.value.provider==="custom_openai"]]),e("div",rd,[m[19]||(m[19]=e("label",{for:"settingsHqModelName"},"æ¨¡å‹åç§°:",-1)),e("div",ud,[le(e("input",{type:"text",id:"settingsHqModelName","onUpdate:modelValue":m[4]||(m[4]=C=>a.value.modelName=C),placeholder:"è¯·è¾“å…¥æ¨¡å‹åç§°"},null,512),[[we,a.value.modelName]]),e("button",{type:"button",class:"fetch-models-btn",title:"è·å–å¯ç”¨æ¨¡å‹åˆ—è¡¨",onClick:P,disabled:v.value},[m[18]||(m[18]=e("span",{class:"fetch-icon"},"ğŸ”",-1)),e("span",dd,ne(v.value?"è·å–ä¸­...":"è·å–æ¨¡å‹"),1)],8,cd)]),p.value.length>0?(B(),F("div",gd,[Ce(Ve,{modelValue:a.value.modelName,"onUpdate:modelValue":m[5]||(m[5]=C=>a.value.modelName=C),options:S.value},null,8,["modelValue","options"]),e("span",pd,"å…± "+ne(p.value.length)+" ä¸ªæ¨¡å‹",1)])):de("",!0)]),e("div",md,[e("button",{class:"settings-test-btn",onClick:q,disabled:_.value},ne(_.value?"æµ‹è¯•ä¸­...":"ğŸ”— æµ‹è¯•è¿æ¥"),9,vd)])]),e("div",fd,[m[28]||(m[28]=e("div",{class:"settings-group-title"},"æ‰¹å¤„ç†è®¾ç½®",-1)),e("div",bd,[e("div",hd,[m[21]||(m[21]=e("label",{for:"settingsHqBatchSize"},"æ‰¹æ¬¡å¤§å°:",-1)),le(e("input",{type:"number",id:"settingsHqBatchSize","onUpdate:modelValue":m[6]||(m[6]=C=>a.value.batchSize=C),min:"1",max:"10",step:"1"},null,512),[[we,a.value.batchSize,void 0,{number:!0}]]),m[22]||(m[22]=e("div",{class:"input-hint"},"æ¯æ‰¹å¤„ç†çš„å›¾ç‰‡æ•°é‡ (æ¨è3-5å¼ )",-1))]),e("div",xd,[m[23]||(m[23]=e("label",{for:"settingsHqSessionReset"},"ä¼šè¯é‡ç½®é¢‘ç‡:",-1)),le(e("input",{type:"number",id:"settingsHqSessionReset","onUpdate:modelValue":m[7]||(m[7]=C=>a.value.sessionReset=C),min:"1",step:"1"},null,512),[[we,a.value.sessionReset,void 0,{number:!0}]]),m[24]||(m[24]=e("div",{class:"input-hint"},"å¤šå°‘æ‰¹æ¬¡åé‡ç½®ä¸Šä¸‹æ–‡",-1))])]),e("div",yd,[e("div",_d,[m[25]||(m[25]=e("label",{for:"settingsHqRpmLimit"},"RPMé™åˆ¶:",-1)),le(e("input",{type:"number",id:"settingsHqRpmLimit","onUpdate:modelValue":m[8]||(m[8]=C=>a.value.rpmLimit=C),min:"0",step:"1"},null,512),[[we,a.value.rpmLimit,void 0,{number:!0}]]),m[26]||(m[26]=e("div",{class:"input-hint"},"æ¯åˆ†é’Ÿè¯·æ±‚æ•°ï¼Œ0è¡¨ç¤ºæ— é™åˆ¶",-1))]),e("div",Cd,[m[27]||(m[27]=e("label",{for:"settingsHqMaxRetries"},"é‡è¯•æ¬¡æ•°:",-1)),le(e("input",{type:"number",id:"settingsHqMaxRetries","onUpdate:modelValue":m[9]||(m[9]=C=>a.value.maxRetries=C),min:"0",max:"10",step:"1"},null,512),[[we,a.value.maxRetries,void 0,{number:!0}]])])])]),e("div",Sd,[m[36]||(m[36]=e("div",{class:"settings-group-title"},"é«˜çº§é€‰é¡¹",-1)),e("div",kd,[e("div",wd,[e("label",$d,[le(e("input",{type:"checkbox","onUpdate:modelValue":m[10]||(m[10]=C=>a.value.lowReasoning=C)},null,512),[[nt,a.value.lowReasoning]]),m[29]||(m[29]=me(" ä½æ¨ç†æ¨¡å¼ ",-1))]),m[30]||(m[30]=e("div",{class:"input-hint"},"å‡å°‘æ¨¡å‹æ¨ç†æ·±åº¦ï¼Œæé«˜é€Ÿåº¦",-1))]),e("div",Td,[m[31]||(m[31]=e("label",{for:"settingsHqNoThinkingMethod"},"å–æ¶ˆæ€è€ƒæ–¹æ³•:",-1)),Ce(Ve,{modelValue:a.value.noThinkingMethod,"onUpdate:modelValue":m[11]||(m[11]=C=>a.value.noThinkingMethod=C),options:s},null,8,["modelValue"])])]),e("div",Id,[e("div",Pd,[e("label",Rd,[le(e("input",{type:"checkbox","onUpdate:modelValue":m[12]||(m[12]=C=>a.value.forceJsonOutput=C)},null,512),[[nt,a.value.forceJsonOutput]]),m[32]||(m[32]=me(" å¼ºåˆ¶JSONè¾“å‡º ",-1))]),m[33]||(m[33]=e("div",{class:"input-hint"},"ä½¿ç”¨ response_format: json_object",-1))]),e("div",Dd,[e("label",Md,[le(e("input",{type:"checkbox","onUpdate:modelValue":m[13]||(m[13]=C=>a.value.useStream=C)},null,512),[[nt,a.value.useStream]]),m[34]||(m[34]=me(" æµå¼è°ƒç”¨ ",-1))]),m[35]||(m[35]=e("div",{class:"input-hint"},"ä½¿ç”¨æµå¼APIè°ƒç”¨",-1))])])]),e("div",Ed,[m[37]||(m[37]=e("div",{class:"settings-group-title"},"é«˜è´¨é‡ç¿»è¯‘æç¤ºè¯",-1)),e("div",Bd,[le(e("textarea",{id:"settingsHqPrompt","onUpdate:modelValue":m[14]||(m[14]=C=>a.value.prompt=C),rows:"6",placeholder:"é«˜è´¨é‡ç¿»è¯‘æç¤ºè¯"},null,512),[[we,a.value.prompt]]),Ce(Ot,{"prompt-type":"hq_translate",onSelect:U}),e("button",{class:"btn btn-secondary btn-sm",onClick:V},"é‡ç½®ä¸ºé»˜è®¤")])])]))}}),Ld=He(Ad,[["__scopeId","data-v-23f4a3f7"]]),Fd={class:"proofreading-settings"},Ud={class:"settings-group"},Od={class:"settings-item"},zd={class:"checkbox-label"},Nd={class:"settings-item"},Vd={class:"settings-group"},Wd={class:"round-header"},Kd={class:"round-title"},qd=["onClick","disabled"],Hd={class:"round-content"},jd={class:"settings-item"},Jd=["onUpdate:modelValue"],Yd={class:"settings-row"},Xd={class:"settings-item"},Gd={class:"settings-item"},Zd={class:"password-input-wrapper"},Qd=["type","onUpdate:modelValue"],eg=["onClick"],tg={key:0,class:"eye-icon"},og={key:1,class:"eye-off-icon"},ng={class:"settings-item"},sg=["onUpdate:modelValue"],ag={class:"settings-item"},lg={class:"model-input-with-fetch"},ig=["onUpdate:modelValue"],rg=["onClick","disabled"],ug={class:"fetch-text"},cg={key:0,class:"model-select-container"},dg={class:"model-count"},gg={class:"settings-item"},pg=["onClick","disabled"],mg={class:"settings-row"},vg={class:"settings-item"},fg=["onUpdate:modelValue"],bg={class:"settings-item"},hg=["onUpdate:modelValue"],xg={class:"settings-item"},yg=["onUpdate:modelValue"],_g={class:"settings-row"},Cg={class:"settings-item"},Sg={class:"checkbox-label"},kg=["onUpdate:modelValue"],wg={class:"settings-item"},$g={class:"settings-item"},Tg={class:"checkbox-label"},Ig=["onUpdate:modelValue"],Pg={class:"settings-item"},Rg=["onUpdate:modelValue"],Dg=["onClick"],Mg=je({__name:"ProofreadingSettings",setup(n){const t=[{label:"SiliconFlow",value:"siliconflow"},{label:"DeepSeek",value:"deepseek"},{label:"ç«å±±å¼•æ“",value:"volcano"},{label:"Google Gemini",value:"gemini"},{label:"è‡ªå®šä¹‰ OpenAI å…¼å®¹æœåŠ¡",value:"custom_openai"}],s=[{label:"Geminié£æ ¼",value:"gemini"},{label:"ç«å±±å¼•æ“é£æ ¼",value:"volcano"}],o=Ne(),l=ct(),u=w({}),a=w({}),c=w({}),v=Z(()=>o.settings.proofreading.rounds),p=Z({get:()=>o.settings.proofreading.maxRetries,set:U=>o.setProofreadingMaxRetries(U)}),_=Z({get:()=>o.settings.proofreading.enabled,set:U=>o.setProofreadingEnabled(U)});Se(()=>o.settings.proofreading.rounds,()=>{o.saveToStorage()},{deep:!0});function S(U){const f=c.value[U]||[],m=[{label:"-- é€‰æ‹©æ¨¡å‹ --",value:""}];return f.forEach(C=>m.push({label:C,value:C})),m}async function D(U){const f=v.value[U];if(!f)return;const m=f.provider,C=f.apiKey?.trim(),k=f.customBaseUrl?.trim();if(!C){l.warning("è¯·å…ˆå¡«å†™ API Key");return}if(!["siliconflow","deepseek","volcano","gemini","custom_openai"].includes(m)){l.warning("å½“å‰æœåŠ¡å•†ä¸æ”¯æŒè·å–æ¨¡å‹åˆ—è¡¨");return}u.value[U]=!0;try{const N=await Ke.fetchModels(m,C,k);N.success&&N.models&&N.models.length>0?(c.value[U]=N.models.map(se=>se.id),l.success(`è½®æ¬¡ ${U+1}: è·å–åˆ° ${N.models.length} ä¸ªæ¨¡å‹`)):l.warning(N.message||"æœªè·å–åˆ°å¯ç”¨æ¨¡å‹")}catch(N){const se=N instanceof Error?N.message:"è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥";l.error(se)}finally{u.value[U]=!1}}async function M(U){const f=v.value[U];if(!f)return;const m=f.provider,C=f.apiKey?.trim(),k=f.modelName?.trim(),K=f.customBaseUrl?.trim();if(!C){l.warning("è¯·å…ˆå¡«å†™ API Key");return}if(!k){l.warning("è¯·å¡«å†™æ¨¡å‹åç§°");return}a.value[U]=!0,l.info(`æ­£åœ¨æµ‹è¯•è½®æ¬¡ ${U+1} çš„è¿æ¥...`);try{const N=await Ke.testAiTranslateConnection({provider:m,apiKey:C,modelName:k,baseUrl:K});N.success?l.success(N.message||"è¿æ¥æˆåŠŸ!"):l.error(N.message||N.error||"è¿æ¥å¤±è´¥")}catch(N){const se=N instanceof Error?N.message:"è¿æ¥æµ‹è¯•å¤±è´¥";l.error(se)}finally{a.value[U]=!1}}function E(){const U={name:`ç¬¬${v.value.length+1}è½®æ ¡å¯¹`,provider:"siliconflow",apiKey:"",modelName:"",customBaseUrl:"",batchSize:3,sessionReset:20,rpmLimit:7,lowReasoning:!1,noThinkingMethod:"gemini",forceJsonOutput:!0,prompt:Qo,showApiKey:!1};o.addProofreadingRound(U),l.success("å·²æ·»åŠ æ–°çš„æ ¡å¯¹è½®æ¬¡")}function P(U){if(v.value.length<=1){l.warning("è‡³å°‘éœ€è¦ä¿ç•™ä¸€ä¸ªæ ¡å¯¹è½®æ¬¡");return}o.removeProofreadingRound(U),l.success("å·²åˆ é™¤æ ¡å¯¹è½®æ¬¡")}function q(U){o.updateProofreadingRound(U,{prompt:Qo}),l.success("å·²é‡ç½®ä¸ºé»˜è®¤æç¤ºè¯")}function V(U,f,m){o.updateProofreadingRound(U,{prompt:f}),l.success(`å·²åº”ç”¨æç¤ºè¯: ${m}`)}return(U,f)=>(B(),F("div",Fd,[e("div",Ud,[f[5]||(f[5]=e("div",{class:"settings-group-title"},"AIæ ¡å¯¹è®¾ç½®",-1)),e("div",Od,[e("label",zd,[le(e("input",{type:"checkbox","onUpdate:modelValue":f[0]||(f[0]=m=>_.value=m)},null,512),[[nt,_.value]]),f[2]||(f[2]=me(" å¯ç”¨AIæ ¡å¯¹ ",-1))]),f[3]||(f[3]=e("div",{class:"input-hint"},"ç¿»è¯‘å®Œæˆåè‡ªåŠ¨è¿›è¡ŒAIæ ¡å¯¹",-1))]),e("div",Nd,[f[4]||(f[4]=e("label",{for:"settingsProofreadingMaxRetries"},"å…¨å±€é‡è¯•æ¬¡æ•°:",-1)),le(e("input",{type:"number",id:"settingsProofreadingMaxRetries","onUpdate:modelValue":f[1]||(f[1]=m=>p.value=m),min:"0",max:"10",step:"1"},null,512),[[we,p.value,void 0,{number:!0}]])])]),le(e("div",Vd,[e("div",{class:"settings-group-title"},[f[6]||(f[6]=me(" æ ¡å¯¹è½®æ¬¡é…ç½® ",-1)),e("button",{class:"btn btn-secondary btn-sm",onClick:E},"+ æ·»åŠ è½®æ¬¡")]),(B(!0),F(ze,null,Ye(v.value,(m,C)=>(B(),F("div",{key:C,class:"proofreading-round"},[e("div",Wd,[e("span",Kd,"è½®æ¬¡ "+ne(C+1)+": "+ne(m.name||"æœªå‘½å"),1),e("button",{class:"btn btn-danger btn-sm",onClick:k=>P(C),disabled:v.value.length<=1}," åˆ é™¤ ",8,qd)]),e("div",Hd,[e("div",jd,[f[7]||(f[7]=e("label",null,"è½®æ¬¡åç§°:",-1)),le(e("input",{type:"text","onUpdate:modelValue":k=>m.name=k,placeholder:"å¦‚: ç¬¬ä¸€è½®æ ¡å¯¹"},null,8,Jd),[[we,m.name]])]),e("div",Yd,[e("div",Xd,[f[8]||(f[8]=e("label",null,"æœåŠ¡å•†:",-1)),Ce(Ve,{modelValue:m.provider,"onUpdate:modelValue":k=>m.provider=k,options:t},null,8,["modelValue","onUpdate:modelValue"])]),e("div",Gd,[f[9]||(f[9]=e("label",null,"API Key:",-1)),e("div",Zd,[le(e("input",{type:m.showApiKey?"text":"password","onUpdate:modelValue":k=>m.apiKey=k,class:"secure-input",placeholder:"è¯·è¾“å…¥API Key",autocomplete:"off"},null,8,Qd),[[$t,m.apiKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:k=>m.showApiKey=!m.showApiKey},[m.showApiKey?(B(),F("span",og,"ğŸ‘â€ğŸ—¨")):(B(),F("span",tg,"ğŸ‘"))],8,eg)])])]),le(e("div",ng,[f[10]||(f[10]=e("label",null,"Base URL:",-1)),le(e("input",{type:"text","onUpdate:modelValue":k=>m.customBaseUrl=k,placeholder:"ä¾‹å¦‚: https://api.example.com/v1"},null,8,sg),[[we,m.customBaseUrl]])],512),[[Ue,m.provider==="custom_openai"]]),e("div",ag,[f[12]||(f[12]=e("label",null,"æ¨¡å‹åç§°:",-1)),e("div",lg,[le(e("input",{type:"text","onUpdate:modelValue":k=>m.modelName=k,placeholder:"è¯·è¾“å…¥æ¨¡å‹åç§°"},null,8,ig),[[we,m.modelName]]),e("button",{type:"button",class:"fetch-models-btn",title:"è·å–å¯ç”¨æ¨¡å‹åˆ—è¡¨",onClick:k=>D(C),disabled:u.value[C]},[f[11]||(f[11]=e("span",{class:"fetch-icon"},"ğŸ”",-1)),e("span",ug,ne(u.value[C]?"è·å–ä¸­...":"è·å–æ¨¡å‹"),1)],8,rg)]),c.value[C]&&c.value[C].length>0?(B(),F("div",cg,[Ce(Ve,{modelValue:m.modelName,"onUpdate:modelValue":k=>m.modelName=k,options:S(C)},null,8,["modelValue","onUpdate:modelValue","options"]),e("span",dg,"å…± "+ne(c.value[C].length)+" ä¸ªæ¨¡å‹",1)])):de("",!0)]),e("div",gg,[e("button",{class:"settings-test-btn",onClick:k=>M(C),disabled:a.value[C]},ne(a.value[C]?"æµ‹è¯•ä¸­...":"ğŸ”— æµ‹è¯•è¿æ¥"),9,pg)]),e("div",mg,[e("div",vg,[f[13]||(f[13]=e("label",null,"æ‰¹æ¬¡å¤§å°:",-1)),le(e("input",{type:"number","onUpdate:modelValue":k=>m.batchSize=k,min:"1",max:"10",step:"1"},null,8,fg),[[we,m.batchSize,void 0,{number:!0}]])]),e("div",bg,[f[14]||(f[14]=e("label",null,"ä¼šè¯é‡ç½®é¢‘ç‡:",-1)),le(e("input",{type:"number","onUpdate:modelValue":k=>m.sessionReset=k,min:"1",step:"1"},null,8,hg),[[we,m.sessionReset,void 0,{number:!0}]])]),e("div",xg,[f[15]||(f[15]=e("label",null,"RPMé™åˆ¶:",-1)),le(e("input",{type:"number","onUpdate:modelValue":k=>m.rpmLimit=k,min:"0",step:"1"},null,8,yg),[[we,m.rpmLimit,void 0,{number:!0}]])])]),e("div",_g,[e("div",Cg,[e("label",Sg,[le(e("input",{type:"checkbox","onUpdate:modelValue":k=>m.lowReasoning=k},null,8,kg),[[nt,m.lowReasoning]]),f[16]||(f[16]=me(" ä½æ¨ç†æ¨¡å¼ ",-1))])]),e("div",wg,[f[17]||(f[17]=e("label",null,"å–æ¶ˆæ€è€ƒæ–¹æ³•:",-1)),Ce(Ve,{modelValue:m.noThinkingMethod,"onUpdate:modelValue":k=>m.noThinkingMethod=k,options:s},null,8,["modelValue","onUpdate:modelValue"])]),e("div",$g,[e("label",Tg,[le(e("input",{type:"checkbox","onUpdate:modelValue":k=>m.forceJsonOutput=k},null,8,Ig),[[nt,m.forceJsonOutput]]),f[18]||(f[18]=me(" å¼ºåˆ¶JSONè¾“å‡º ",-1))])])]),e("div",Pg,[f[19]||(f[19]=e("label",null,"æ ¡å¯¹æç¤ºè¯:",-1)),le(e("textarea",{"onUpdate:modelValue":k=>m.prompt=k,rows:"4",placeholder:"æ ¡å¯¹æç¤ºè¯"},null,8,Rg),[[we,m.prompt]]),Ce(Ot,{"prompt-type":"proofreading",onSelect:(k,K)=>V(C,k,K)},null,8,["onSelect"]),e("button",{class:"btn btn-secondary btn-sm",onClick:k=>q(C)},"é‡ç½®ä¸ºé»˜è®¤",8,Dg)])])]))),128))],512),[[Ue,_.value]])]))}}),Eg=He(Mg,[["__scopeId","data-v-663a7972"]]),Bg={class:"prompt-library"},Ag={class:"settings-group"},Lg={class:"settings-item"},Fg={key:0,class:"settings-item"},Ug={class:"mode-hint"},Og={class:"settings-group"},zg={key:0,class:"loading-hint"},Ng={key:1,class:"empty-hint"},Vg={key:2,class:"prompt-list"},Wg=["onClick"],Kg={class:"prompt-name"},qg={class:"prompt-actions"},Hg=["onClick"],jg=["onClick","disabled"],Jg={class:"settings-group"},Yg={class:"settings-item"},Xg={class:"settings-item"},Gg={class:"prompt-editor-actions"},Zg=["disabled"],Qg=je({__name:"PromptLibrary",setup(n){const t=[{label:"ç¿»è¯‘æç¤ºè¯",value:"translate"},{label:"æ–‡æœ¬æ¡†æç¤ºè¯",value:"textbox"},{label:"AIè§†è§‰OCRæç¤ºè¯",value:"ai_vision_ocr"},{label:"é«˜è´¨é‡ç¿»è¯‘æç¤ºè¯",value:"hq_translate"},{label:"æ ¡å¯¹æç¤ºè¯",value:"proofreading"}],s=[{label:"æ™®é€šæ¨¡å¼",value:"false"},{label:"JSONæ ¼å¼æ¨¡å¼",value:"true"}],o=ct(),l=Ne(),u=w("translate"),a=w([]),c=w(""),v=w(""),p=w(""),_=w(!1),S=w(!1),D=Z(()=>u.value==="translate"||u.value==="ai_vision_ocr"),M=Z(()=>S.value?"é€‚ç”¨äºéœ€è¦ç»“æ„åŒ–è¾“å‡ºçš„åœºæ™¯":"é€‚ç”¨äºæ™®é€šç¿»è¯‘åœºæ™¯");async function E(){_.value=!0;try{let C;u.value==="textbox"?C=await Ke.getTextboxPrompts():C=await Ke.getPrompts(u.value);const k=C.prompt_names||[];a.value=k.map(K=>({name:K}))}catch(C){const k=C instanceof Error?C.message:"åŠ è½½æç¤ºè¯åˆ—è¡¨å¤±è´¥";o.error(k)}finally{_.value=!1}}async function P(C){c.value=C,v.value=C,await q(C)}async function q(C){try{let k;u.value==="textbox"?k=await Ke.getTextboxPromptContent(C):k=await Ke.getPromptContent(u.value,C),v.value=C,p.value=k.prompt_content||"",c.value=C,o.success("å·²åŠ è½½æç¤ºè¯")}catch(k){const K=k instanceof Error?k.message:"åŠ è½½æç¤ºè¯å†…å®¹å¤±è´¥";o.error(K)}}async function V(){if(!v.value||!p.value){o.warning("è¯·è¾“å…¥æç¤ºè¯åç§°å’Œå†…å®¹");return}try{u.value==="textbox"?await Ke.saveTextboxPrompt(v.value,p.value):await Ke.savePrompt(u.value,v.value,p.value),o.success("æç¤ºè¯ä¿å­˜æˆåŠŸ"),v.value="",p.value="",await E()}catch(C){const k=C instanceof Error?C.message:"ä¿å­˜æç¤ºè¯å¤±è´¥";o.error(k)}}async function U(C){if(C==="default"){o.warning("é»˜è®¤æç¤ºè¯ä¸èƒ½åˆ é™¤");return}try{u.value==="textbox"?await Ke.deleteTextboxPrompt(C):await Ke.deletePrompt(u.value,C),o.success("æç¤ºè¯åˆ é™¤æˆåŠŸ"),c.value===C&&(c.value="",v.value="",p.value=""),await E()}catch(k){const K=k instanceof Error?k.message:"åˆ é™¤æç¤ºè¯å¤±è´¥";o.error(K)}}function f(){c.value="",v.value="",p.value="",u.value==="translate"?S.value=l.settings.translation.isJsonMode:u.value==="ai_vision_ocr"?S.value=l.settings.aiVisionOcr.isJsonMode:S.value=!1,E()}function m(){u.value==="translate"?l.updateTranslationService({isJsonMode:S.value}):u.value==="ai_vision_ocr"&&l.updateAiVisionOcr({isJsonMode:S.value}),o.info(`å·²åˆ‡æ¢åˆ°${S.value?"JSONæ ¼å¼":"æ™®é€š"}æ¨¡å¼`)}return dt(()=>{S.value=l.settings.translation.isJsonMode,E()}),(C,k)=>(B(),F("div",Bg,[e("div",Ag,[k[6]||(k[6]=e("div",{class:"settings-group-title"},"æç¤ºè¯ç®¡ç†",-1)),e("div",Lg,[k[4]||(k[4]=e("label",{for:"promptType"},"æç¤ºè¯ç±»å‹:",-1)),Ce(Ve,{modelValue:u.value,"onUpdate:modelValue":k[0]||(k[0]=K=>u.value=K),options:t,onChange:f},null,8,["modelValue"])]),D.value?(B(),F("div",Fg,[k[5]||(k[5]=e("label",{for:"promptMode"},"æç¤ºè¯æ¨¡å¼:",-1)),Ce(Ve,{"model-value":S.value?"true":"false",options:s,onChange:k[1]||(k[1]=K=>{S.value=K==="true",m()})},null,8,["model-value"]),e("span",Ug,ne(M.value),1)])):de("",!0)]),e("div",Og,[k[7]||(k[7]=e("div",{class:"settings-group-title"},"å·²ä¿å­˜çš„æç¤ºè¯",-1)),_.value?(B(),F("div",zg,"åŠ è½½ä¸­...")):a.value.length===0?(B(),F("div",Ng,"æš‚æ— ä¿å­˜çš„æç¤ºè¯")):(B(),F("div",Vg,[(B(!0),F(ze,null,Ye(a.value,K=>(B(),F("div",{key:K.name,class:Ie(["prompt-item",{active:c.value===K.name}]),onClick:N=>P(K.name)},[e("span",Kg,ne(K.name),1),e("div",qg,[e("button",{class:"btn btn-sm",onClick:lt(N=>q(K.name),["stop"]),title:"åŠ è½½åˆ°ç¼–è¾‘å™¨"},"ğŸ“¥",8,Hg),e("button",{class:"btn btn-sm btn-danger",onClick:lt(N=>U(K.name),["stop"]),title:"åˆ é™¤",disabled:K.name==="default"}," ğŸ—‘ï¸ ",8,jg)])],10,Wg))),128))]))]),e("div",Jg,[k[10]||(k[10]=e("div",{class:"settings-group-title"},"æç¤ºè¯ç¼–è¾‘",-1)),e("div",Yg,[k[8]||(k[8]=e("label",{for:"promptName"},"æç¤ºè¯åç§°:",-1)),le(e("input",{type:"text",id:"promptName","onUpdate:modelValue":k[2]||(k[2]=K=>v.value=K),placeholder:"è¯·è¾“å…¥æç¤ºè¯åç§°"},null,512),[[we,v.value]])]),e("div",Xg,[k[9]||(k[9]=e("label",{for:"promptContent"},"æç¤ºè¯å†…å®¹:",-1)),le(e("textarea",{id:"promptContent","onUpdate:modelValue":k[3]||(k[3]=K=>p.value=K),rows:"8",placeholder:"è¯·è¾“å…¥æç¤ºè¯å†…å®¹"},null,512),[[we,p.value]])]),e("div",Gg,[e("button",{class:"btn btn-primary",onClick:V,disabled:!v.value||!p.value},"ä¿å­˜æç¤ºè¯",8,Zg)])])]))}}),ep=He(Qg,[["__scopeId","data-v-70f0ec19"]]),tp={class:"plugin-manager"},op={class:"settings-group"},np={key:0,class:"loading-hint"},sp={key:1,class:"empty-hint"},ap={key:2,class:"plugin-list"},lp={class:"plugin-info"},ip={class:"plugin-header"},rp={class:"plugin-name"},up={class:"plugin-version"},cp={class:"plugin-description"},dp={class:"plugin-controls"},gp={class:"switch"},pp=["checked","onChange"],mp=["onClick"],vp=["onClick"],fp={class:"settings-group"},bp={class:"plugin-name"},hp={class:"switch"},xp=["checked","onChange"],yp={class:"plugin-config-content"},_p={class:"plugin-config-header"},Cp={class:"plugin-config-body"},Sp=["for"],kp=["id","onUpdate:modelValue"],wp=["id","onUpdate:modelValue","min","max"],$p=["id","onUpdate:modelValue","placeholder"],Tp={key:4,class:"field-description"},Ip=je({__name:"PluginManager",setup(n){const t=ct(),s=w([]),o=w({}),l=w(!1),u=w(!1),a=w(null),c=w({}),v=w({});async function p(){l.value=!0;try{const V=await Ns();s.value=V.plugins||[]}catch(V){const U=V instanceof Error?V.message:"åŠ è½½æ’ä»¶åˆ—è¡¨å¤±è´¥";t.error(U)}finally{l.value=!1}}async function _(){try{const V=await Xs();o.value=V.states||{}}catch(V){console.error("åŠ è½½é»˜è®¤çŠ¶æ€å¤±è´¥:",V)}}async function S(V){try{V.enabled?(await Ws(V.name),V.enabled=!1,t.success(`å·²ç¦ç”¨ ${V.display_name||V.name}`)):(await Vs(V.name),V.enabled=!0,t.success(`å·²å¯ç”¨ ${V.display_name||V.name}`))}catch(U){const f=U instanceof Error?U.message:"æ“ä½œå¤±è´¥";t.error(f)}}async function D(V,U){const f=U.target,m=f.checked;try{await Gs(V,m),o.value[V]=m,t.success("é»˜è®¤çŠ¶æ€å·²æ›´æ–°")}catch(C){const k=C instanceof Error?C.message:"è®¾ç½®å¤±è´¥";t.error(k),f.checked=!m}}async function M(V){a.value=V;try{const U=await Zs(V.name);c.value=U.schema||{};const f=await Qs(V.name);v.value=f.config||{},u.value=!0}catch(U){const f=U instanceof Error?U.message:"åŠ è½½é…ç½®å¤±è´¥";t.error(f)}}function E(){u.value=!1,a.value=null,c.value={},v.value={}}async function P(){if(a.value)try{await ea(a.value.name,v.value),t.success("é…ç½®ä¿å­˜æˆåŠŸ"),E()}catch(V){const U=V instanceof Error?V.message:"ä¿å­˜é…ç½®å¤±è´¥";t.error(U)}}async function q(V){if(confirm(`ç¡®å®šè¦åˆ é™¤æ’ä»¶ "${V.display_name||V.name}" å—ï¼Ÿ`))try{await Ks(V.name),t.success("æ’ä»¶åˆ é™¤æˆåŠŸ"),await p()}catch(U){const f=U instanceof Error?U.message:"åˆ é™¤æ’ä»¶å¤±è´¥";t.error(f)}}return dt(()=>{p(),_()}),(V,U)=>(B(),F("div",tp,[e("div",op,[U[1]||(U[1]=e("div",{class:"settings-group-title"},"å·²å®‰è£…æ’ä»¶",-1)),l.value?(B(),F("div",np,"åŠ è½½ä¸­...")):s.value.length===0?(B(),F("div",sp,"æš‚æ— å·²å®‰è£…çš„æ’ä»¶")):(B(),F("div",ap,[(B(!0),F(ze,null,Ye(s.value,f=>(B(),F("div",{key:f.name,class:"plugin-item"},[e("div",lp,[e("div",ip,[e("span",rp,ne(f.display_name||f.name),1),e("span",up,"v"+ne(f.version||"1.0.0"),1)]),e("p",cp,ne(f.description||"æš‚æ— æè¿°"),1)]),e("div",dp,[e("label",gp,[e("input",{type:"checkbox",checked:f.enabled,onChange:m=>S(f)},null,40,pp),U[0]||(U[0]=e("span",{class:"slider"},null,-1))]),f.has_config?(B(),F("button",{key:0,class:"btn btn-sm",onClick:m=>M(f),title:"é…ç½®"},"âš™ï¸",8,mp)):de("",!0),e("button",{class:"btn btn-sm btn-danger",onClick:m=>q(f),title:"åˆ é™¤"},"ğŸ—‘ï¸",8,vp)])]))),128))]))]),e("div",fp,[U[3]||(U[3]=e("div",{class:"settings-group-title"},"é»˜è®¤å¯ç”¨çŠ¶æ€",-1)),U[4]||(U[4]=e("p",{class:"settings-hint"},"è®¾ç½®æ’ä»¶åœ¨æ–°ä¼šè¯ä¸­çš„é»˜è®¤å¯ç”¨çŠ¶æ€",-1)),(B(!0),F(ze,null,Ye(s.value,f=>(B(),F("div",{key:"default-"+f.name,class:"default-state-item"},[e("span",bp,ne(f.display_name||f.name),1),e("label",hp,[e("input",{type:"checkbox",checked:o.value[f.name],onChange:m=>D(f.name,m)},null,40,xp),U[2]||(U[2]=e("span",{class:"slider"},null,-1))])]))),128))]),u.value?(B(),F("div",{key:0,class:"plugin-config-modal",onClick:lt(E,["self"])},[e("div",yp,[e("div",_p,[e("h4",null,ne(a.value?.display_name||a.value?.name)+" é…ç½®",1),e("span",{class:"close-btn",onClick:E},"Ã—")]),e("div",Cp,[(B(!0),F(ze,null,Ye(c.value,(f,m)=>(B(),F("div",{key:m,class:"config-field"},[e("label",{for:"config-"+m},ne(f.label||m)+":",9,Sp),f.type==="boolean"?le((B(),F("input",{key:0,type:"checkbox",id:"config-"+m,"onUpdate:modelValue":C=>v.value[m]=C},null,8,kp)),[[nt,v.value[m]]]):f.type==="select"?(B(),ut(Ve,{key:1,"model-value":String(v.value[m]??""),options:f.options||[],onChange:C=>{v.value[m]=C}},null,8,["model-value","options","onChange"])):f.type==="number"?le((B(),F("input",{key:2,type:"number",id:"config-"+m,"onUpdate:modelValue":C=>v.value[m]=C,min:f.min,max:f.max},null,8,wp)),[[we,v.value[m],void 0,{number:!0}]]):le((B(),F("input",{key:3,type:"text",id:"config-"+m,"onUpdate:modelValue":C=>v.value[m]=C,placeholder:f.placeholder},null,8,$p)),[[we,v.value[m]]]),f.description?(B(),F("p",Tp,ne(f.description),1)):de("",!0)]))),128))]),e("div",{class:"plugin-config-footer"},[e("button",{class:"btn btn-secondary",onClick:E},"å–æ¶ˆ"),e("button",{class:"btn btn-primary",onClick:P},"ä¿å­˜")])])])):de("",!0)]))}}),Pp=He(Ip,[["__scopeId","data-v-a62393a7"]]),Rp={class:"parallel-settings"},Dp={class:"settings-group"},Mp={class:"settings-item"},Ep={class:"toggle-switch"},Bp={class:"number-control"},Ap=["disabled"],Lp=["disabled"],Fp=["disabled"],Up={key:0,class:"settings-note"},Op=je({__name:"ParallelSettings",setup(n){const t=Ne(),s=Z({get:()=>t.settings.parallel.enabled,set:l=>{t.updateSettings({parallel:{...t.settings.parallel,enabled:l}})}}),o=Z({get:()=>t.settings.parallel.deepLearningLockSize,set:l=>{t.updateSettings({parallel:{...t.settings.parallel,deepLearningLockSize:Math.max(1,Math.min(4,l))}})}});return(l,u)=>(B(),F("div",Rp,[e("div",Dp,[u[10]||(u[10]=e("div",{class:"settings-group-title"},"ğŸš€ å¹¶è¡Œç¿»è¯‘",-1)),e("div",Mp,[u[5]||(u[5]=e("label",null,"å¯ç”¨å¹¶è¡Œæ¨¡å¼:",-1)),e("label",Ep,[le(e("input",{type:"checkbox","onUpdate:modelValue":u[0]||(u[0]=a=>s.value=a)},null,512),[[nt,s.value]]),u[4]||(u[4]=e("span",{class:"toggle-slider"},null,-1))]),u[6]||(u[6]=e("div",{class:"input-hint"},"ä½¿ç”¨æµæ°´çº¿å¹¶è¡Œå¤„ç†ï¼Œå¯èƒ½æå‡æ‰¹é‡ç¿»è¯‘é€Ÿåº¦",-1))]),e("div",{class:Ie(["settings-item",{"item-disabled":!s.value}])},[u[7]||(u[7]=e("label",null,"æ·±åº¦å­¦ä¹ å¹¶å‘æ•°:",-1)),e("div",Bp,[e("button",{class:"btn btn-sm",onClick:u[1]||(u[1]=a=>o.value=Math.max(1,o.value-1)),disabled:!s.value},"-",8,Ap),le(e("input",{type:"number","onUpdate:modelValue":u[2]||(u[2]=a=>o.value=a),min:"1",max:"4",disabled:!s.value,class:"number-input"},null,8,Lp),[[we,o.value,void 0,{number:!0}]]),e("button",{class:"btn btn-sm",onClick:u[3]||(u[3]=a=>o.value=Math.min(4,o.value+1)),disabled:!s.value},"+",8,Fp)]),u[8]||(u[8]=e("div",{class:"input-hint"},"æ§åˆ¶æ£€æµ‹/OCR/é¢œè‰²/ä¿®å¤çš„æœ€å¤§å¹¶å‘æ•°ï¼ˆå»ºè®®1-2ï¼‰",-1))],2),s.value?(B(),F("div",Up,[...u[9]||(u[9]=[e("div",{class:"note-title"},"âš ï¸ æ³¨æ„äº‹é¡¹ï¼š",-1),e("ul",null,[e("li",null,"å¹¶å‘æ•°è®¾ä¸º1æ—¶ä¸ºä¸²è¡Œæ‰§è¡Œï¼Œæœ€ç¨³å®š"),e("li",null,"å¢å¤§å¹¶å‘æ•°å¯èƒ½åŠ é€Ÿå¤„ç†ï¼Œä½†ä¼šå ç”¨æ›´å¤šGPU/CPUèµ„æº"),e("li",null,"å¦‚æœé‡åˆ°æ˜¾å­˜ä¸è¶³ï¼Œè¯·å°†å¹¶å‘æ•°è®¾ä¸º1")],-1)])])):de("",!0)])]))}}),zp=He(Op,[["__scopeId","data-v-4a6e42d5"]]),Np={class:"more-settings"},Vp={class:"settings-group"},Wp={class:"settings-item checkbox-item"},Kp={class:"checkbox-label"},qp={class:"settings-group"},Hp={class:"settings-item"},jp={class:"settings-group"},Jp={class:"settings-item"},Yp=["disabled"],Xp={key:0,class:"font-count"},Gp={class:"settings-item"},Zp={class:"settings-group"},Qp={class:"settings-row"},em={class:"settings-item"},tm=["disabled"],om={class:"settings-item"},nm=["disabled"],sm=je({__name:"MoreSettings",setup(n){const t=[{label:"å‰ç«¯ pdf.js (æ¨è)",value:"frontend"},{label:"åç«¯ PyMuPDF",value:"backend"}],s=Ne(),o=ct(),l=w(!1),u=w([]),a=w(!1),c=w(null),v=w({pdfProcessingMethod:s.settings.pdfProcessingMethod||"frontend",autoSaveInBookshelfMode:s.settings.autoSaveInBookshelfMode||!1});Se(()=>v.value.pdfProcessingMethod,M=>{s.setPdfProcessingMethod(M)}),Se(()=>v.value.autoSaveInBookshelfMode,M=>{s.setAutoSaveInBookshelfMode(M)});async function p(){l.value=!0;try{const M=await Ke.getFontList();u.value=M.fonts||[],o.success(`è·å–åˆ° ${u.value.length} ä¸ªå­—ä½“`)}catch(M){const E=M instanceof Error?M.message:"è·å–å­—ä½“åˆ—è¡¨å¤±è´¥";o.error(E)}finally{l.value=!1}}async function _(M){const P=M.target.files?.[0];if(!P)return;const q=[".ttf",".ttc",".otf"],V=P.name.toLowerCase().slice(P.name.lastIndexOf("."));if(!q.includes(V)){o.error("ä¸æ”¯æŒçš„å­—ä½“æ ¼å¼ï¼Œè¯·ä¸Šä¼  .ttf, .ttc æˆ– .otf æ–‡ä»¶");return}try{const U=await Ke.uploadFont(P);U.success?(o.success(`å­—ä½“ "${U.fontPath||P.name}" ä¸Šä¼ æˆåŠŸ`),await p()):o.error(U.error||"å­—ä½“ä¸Šä¼ å¤±è´¥")}catch(U){const f=U instanceof Error?U.message:"å­—ä½“ä¸Šä¼ å¤±è´¥";o.error(f)}finally{c.value&&(c.value.value="")}}async function S(){a.value=!0;try{const M=await kn();M.success?o.success(`å·²æ¸…ç† ${M.deleted_count||0} ä¸ªè°ƒè¯•æ–‡ä»¶`):o.error(M.error||"æ¸…ç†å¤±è´¥")}catch(M){const E=M instanceof Error?M.message:"æ¸…ç†å¤±è´¥";o.error(E)}finally{a.value=!1}}async function D(){a.value=!0;try{const M=await xo();M.success?o.success(`å·²æ¸…ç† ${M.deleted_count||0} ä¸ªä¸´æ—¶æ–‡ä»¶`):o.error(M.error||"æ¸…ç†å¤±è´¥")}catch(M){const E=M instanceof Error?M.message:"æ¸…ç†å¤±è´¥";o.error(E)}finally{a.value=!1}}return(M,E)=>(B(),F("div",Np,[Ce(zp),e("div",Vp,[E[4]||(E[4]=e("div",{class:"settings-group-title"},"è‡ªåŠ¨ä¿å­˜è®¾ç½®",-1)),e("div",Wp,[e("label",Kp,[le(e("input",{type:"checkbox","onUpdate:modelValue":E[0]||(E[0]=P=>v.value.autoSaveInBookshelfMode=P)},null,512),[[nt,v.value.autoSaveInBookshelfMode]]),E[2]||(E[2]=e("span",{class:"checkbox-text"},"ä¹¦æ¶æ¨¡å¼è‡ªåŠ¨ä¿å­˜",-1))]),E[3]||(E[3]=e("div",{class:"input-hint"},[me(" å¼€å¯åï¼Œåœ¨ä¹¦æ¶æ¨¡å¼ä¸‹ç¿»è¯‘æ—¶ä¼šè‡ªåŠ¨ä¿å­˜è¿›åº¦ï¼ˆç¿»è¯‘ä¸€å¼ ä¿å­˜ä¸€å¼ ï¼‰ï¼Œé˜²æ­¢æ„å¤–å…³é—­å¯¼è‡´æ•°æ®ä¸¢å¤±ã€‚ "),e("br"),e("span",{class:"hint-note"},"æ³¨æ„ï¼šæ­¤åŠŸèƒ½ä»…åœ¨ä¹¦æ¶æ¨¡å¼ä¸‹ç”Ÿæ•ˆï¼Œå¿«é€Ÿç¿»è¯‘æ¨¡å¼ä¸æ”¯æŒã€‚")],-1))])]),e("div",qp,[E[7]||(E[7]=e("div",{class:"settings-group-title"},"PDFå¤„ç†è®¾ç½®",-1)),e("div",Hp,[E[5]||(E[5]=e("label",{for:"settingsPdfProcessingMethod"},"PDFå¤„ç†æ–¹å¼:",-1)),Ce(Ve,{modelValue:v.value.pdfProcessingMethod,"onUpdate:modelValue":E[1]||(E[1]=P=>v.value.pdfProcessingMethod=P),options:t},null,8,["modelValue"]),E[6]||(E[6]=e("div",{class:"input-hint"},"å‰ç«¯å¤„ç†é€Ÿåº¦æ›´å¿«ï¼Œåç«¯å¤„ç†å…¼å®¹æ€§æ›´å¥½",-1))])]),e("div",jp,[E[11]||(E[11]=e("div",{class:"settings-group-title"},"å­—ä½“è®¾ç½®",-1)),e("div",Jp,[E[8]||(E[8]=e("label",null,"ç³»ç»Ÿå­—ä½“åˆ—è¡¨:",-1)),e("button",{class:"btn btn-secondary",onClick:p,disabled:l.value},ne(l.value?"åŠ è½½ä¸­...":"ğŸ”„ åˆ·æ–°å­—ä½“åˆ—è¡¨"),9,Yp),u.value.length>0?(B(),F("div",Xp,"å…± "+ne(u.value.length)+" ä¸ªå­—ä½“",1)):de("",!0)]),e("div",Gp,[E[9]||(E[9]=e("label",null,"ä¸Šä¼ è‡ªå®šä¹‰å­—ä½“:",-1)),e("input",{type:"file",accept:".ttf,.ttc,.otf",onChange:_,ref_key:"fontInput",ref:c},null,544),E[10]||(E[10]=e("div",{class:"input-hint"},"æ”¯æŒ .ttf, .ttc, .otf æ ¼å¼",-1))])]),e("div",Zp,[E[14]||(E[14]=e("div",{class:"settings-group-title"},"ç¼“å­˜æ¸…ç†",-1)),e("div",Qp,[e("div",em,[e("button",{class:"btn btn-secondary",onClick:S,disabled:a.value},ne(a.value?"æ¸…ç†ä¸­...":"ğŸ—‘ï¸ æ¸…ç†è°ƒè¯•æ–‡ä»¶"),9,tm),E[12]||(E[12]=e("div",{class:"input-hint"},"æ¸…ç†è°ƒè¯•è¿‡ç¨‹ä¸­ç”Ÿæˆçš„ä¸´æ—¶æ–‡ä»¶",-1))]),e("div",om,[e("button",{class:"btn btn-secondary",onClick:D,disabled:a.value},ne(a.value?"æ¸…ç†ä¸­...":"ğŸ—‘ï¸ æ¸…ç†ä¸´æ—¶æ–‡ä»¶"),9,nm),E[13]||(E[13]=e("div",{class:"input-hint"},"æ¸…ç†ä¸‹è½½å’Œå¤„ç†è¿‡ç¨‹ä¸­çš„ä¸´æ—¶æ–‡ä»¶",-1))])])]),E[15]||(E[15]=po('<div class="settings-group" data-v-8667f80e><div class="settings-group-title" data-v-8667f80e>å…³äº</div><div class="about-info" data-v-8667f80e><p data-v-8667f80e><strong data-v-8667f80e>Saber-Translator</strong></p><p data-v-8667f80e>AIé©±åŠ¨çš„æ¼«ç”»ç¿»è¯‘å·¥å…·</p><p class="links" data-v-8667f80e><a href="http://www.mashirosaber.top" target="_blank" data-v-8667f80e>ğŸ“– ä½¿ç”¨æ•™ç¨‹</a><a href="https://github.com/MashiroSaber/saber-translator" target="_blank" data-v-8667f80e>ğŸ™ GitHub</a></p><p class="disclaimer" data-v-8667f80e>æœ¬é¡¹ç›®å®Œå…¨å¼€æºå…è´¹ï¼Œè¯·å‹¿ä¸Šå½“å—éª—</p></div></div>',1))]))}}),am=He(sm,[["__scopeId","data-v-8667f80e"]]),lm={class:"settings-modal-content"},im={class:"settings-tabs"},rm=["onClick"],um={class:"settings-tab-content"},cm={class:"settings-tab-pane active"},dm={class:"settings-tab-pane"},gm={class:"settings-tab-pane"},pm={class:"settings-tab-pane"},mm={class:"settings-tab-pane"},vm={class:"settings-tab-pane"},fm={class:"settings-tab-pane"},bm={class:"settings-tab-pane"},hm=je({__name:"SettingsModal",props:{modelValue:{type:Boolean},initialTab:{}},emits:["update:modelValue","save"],setup(n,{emit:t}){const s=n,o=t,l=Ne(),u=w(s.modelValue),a=w("ocr"),c=[{id:"ocr",label:"OCRè¯†åˆ«"},{id:"translate",label:"ç¿»è¯‘æœåŠ¡"},{id:"detection",label:"æ£€æµ‹è®¾ç½®"},{id:"hq",label:"é«˜è´¨é‡ç¿»è¯‘"},{id:"proofreading",label:"AIæ ¡å¯¹"},{id:"prompt-library",label:"æç¤ºè¯ç®¡ç†"},{id:"plugins",label:"æ’ä»¶ç®¡ç†"},{id:"more",label:"æ›´å¤š"}];Se(()=>s.modelValue,S=>{u.value=S,S?(document.body.style.overflow="hidden",s.initialTab&&c.some(D=>D.id===s.initialTab)&&(a.value=s.initialTab)):(document.body.style.overflow="",a.value="ocr")});function v(){u.value=!1,o("update:modelValue",!1),document.body.style.overflow=""}async function p(){l.saveToStorage();try{await l.saveToBackend(),console.log("[SettingsModal] è®¾ç½®å·²ä¿å­˜åˆ°åç«¯")}catch(S){console.warn("[SettingsModal] ä¿å­˜åˆ°åç«¯å¤±è´¥ï¼Œä»…ä¿å­˜åˆ° localStorage:",S)}o("save"),v()}function _(S){S.key==="Escape"&&u.value&&v()}return dt(()=>{document.addEventListener("keydown",_)}),zt(()=>{document.removeEventListener("keydown",_),document.body.style.overflow=""}),(S,D)=>u.value?(B(),F("div",{key:0,class:"settings-modal",onClick:lt(v,["self"])},[e("div",lm,[e("div",{class:"settings-modal-header"},[D[0]||(D[0]=e("h3",null,"âš™ï¸ è®¾ç½®",-1)),e("span",{class:"settings-modal-close",onClick:v},"Ã—")]),e("div",im,[(B(),F(ze,null,Ye(c,M=>e("button",{key:M.id,class:Ie(["settings-tab",{active:a.value===M.id}]),onClick:E=>a.value=M.id},ne(M.label),11,rm)),64))]),e("div",um,[le(e("div",cm,[Ce(Fu)],512),[[Ue,a.value==="ocr"]]),le(e("div",dm,[Ce(Pc)],512),[[Ue,a.value==="translate"]]),le(e("div",gm,[Ce(Gc)],512),[[Ue,a.value==="detection"]]),le(e("div",pm,[Ce(Ld)],512),[[Ue,a.value==="hq"]]),le(e("div",mm,[Ce(Eg)],512),[[Ue,a.value==="proofreading"]]),le(e("div",vm,[Ce(ep)],512),[[Ue,a.value==="prompt-library"]]),le(e("div",fm,[Ce(Pp)],512),[[Ue,a.value==="plugins"]]),le(e("div",bm,[Ce(am)],512),[[Ue,a.value==="more"]])]),e("div",{class:"settings-modal-footer"},[e("button",{class:"btn btn-secondary",onClick:v},"å–æ¶ˆ"),e("button",{class:"btn btn-primary",onClick:p},"ä¿å­˜è®¾ç½®")])])])):de("",!0)}}),xm=He(hm,[["__scopeId","data-v-e1ec20ab"]]),ym={minScale:.1,maxScale:5,zoomSpeed:.1};function bn(n={}){const t={...ym,...n},s=w(1),o=w(0),l=w(0),u=w(!1),a=w(0),c=w(0),v=Z(()=>({transform:`translate(${o.value}px, ${l.value}px) scale(${s.value})`}));function p(G,J,ee){const j=Math.min(Math.max(s.value*ee,t.minScale),t.maxScale),ae=j/s.value;o.value=G-(G-o.value)*ae,l.value=J-(J-l.value)*ae,s.value=j,n.onScaleChange?.(s.value),n.onTransformChange?.(k())}function _(G,J=800,ee=600){p(J/2,ee/2,G)}function S(){_(1.2)}function D(){_(.8)}function M(G,J=800,ee=600){const j=G/s.value;p(J/2,ee/2,j)}function E(G,J){u.value=!0,a.value=G,c.value=J}function P(G,J){if(!u.value)return;const ee=G-a.value,j=J-c.value;o.value+=ee,l.value+=j,a.value=G,c.value=J,n.onTransformChange?.(k())}function q(){u.value=!1}function V(G,J){o.value+=G,l.value+=J,n.onTransformChange?.(k())}function U(){s.value=1,o.value=0,l.value=0,n.onScaleChange?.(s.value),n.onTransformChange?.(k())}function f(){U()}function m(){s.value=1,o.value=0,l.value=0}function C(G,J,ee,j){if(!G||!J)return;const ae=ee/G,A=j/J;s.value=Math.min(ae,A)*.95,o.value=(ee-G*s.value)/2,l.value=(j-J*s.value)/2,n.onScaleChange?.(s.value),n.onTransformChange?.(k())}function k(){return{scale:s.value,translateX:o.value,translateY:l.value}}function K(G){G.scale!==void 0&&(s.value=G.scale),G.translateX!==void 0&&(o.value=G.translateX),G.translateY!==void 0&&(l.value=G.translateY),n.onTransformChange?.(k())}function N(G){s.value=G.scale,o.value=G.translateX,l.value=G.translateY}function se(G,J,ee){if(!G||G.length<4)return;const[j,ae,A,d]=G,$=(j+A)/2,r=(ae+d)/2,h=J/2,I=ee/2;o.value=h-$*s.value,l.value=I-r*s.value,n.onTransformChange?.(k())}return{scale:s,translateX:o,translateY:l,isDragging:u,transformStyle:v,zoomAt:p,zoom:_,zoomIn:S,zoomOut:D,setScale:M,startDrag:E,drag:P,endDrag:q,pan:V,reset:U,resetZoom:f,resetTransform:m,fitToScreen:C,getTransform:k,setTransform:K,syncWith:N,scrollToBubble:se}}function _m(n){const t=et(),s=Ne(),o=w(null),l=w(bs),u=w(!1),a=w(!1),c=w([]),v=w(0),p=w(0);let _=null,S=null,D=null;const M=Z(()=>o.value!==null),E=Z(()=>o.value==="repair"?{fill:"rgba(76, 175, 80, 0.4)",border:"#4CAF50"}:o.value==="restore"?{fill:"rgba(33, 150, 243, 0.4)",border:"#2196F3"}:{fill:"transparent",border:"transparent"});function P(r){o.value!==r&&(o.value=r,u.value=!0,c.value=[],console.log(`è¿›å…¥${r==="repair"?"ä¿®å¤":"è¿˜åŸ"}ç¬”åˆ·æ¨¡å¼ï¼Œç¬”åˆ·å¤§å°: ${l.value}px`))}function q(){a.value&&K();const r=o.value!==null;o.value=null,u.value=!1,a.value=!1,c.value=[],J(),r&&console.log("é€€å‡ºç¬”åˆ·æ¨¡å¼")}function V(r){o.value===r?q():P(r)}function U(r){l.value=Math.max(tn,Math.min(en,r))}function f(r){U(l.value+r)}function m(r){if(!M.value)return;r.preventDefault(),r.stopPropagation();const h=r.deltaY>0?-5:5;f(h)}function C(r,h){if(!M.value||r.button!==0)return;r.preventDefault(),r.stopPropagation(),a.value=!0,_=h,c.value=[];const I=N(r,h);I&&(c.value.push(I),G(h),ee(I)),console.log("å¼€å§‹ç¬”åˆ·æ¶‚æŠ¹")}function k(r){if(v.value=r.clientX,p.value=r.clientY,!a.value||!M.value)return;const h=N(r,_);h&&(c.value.push(h),ee(h))}function K(){if(!a.value)return;a.value=!1;const r=t.currentImage;if(!r||c.value.length===0){J(),c.value=[];return}const h=se();if(!h){J(),c.value=[];return}const I=o.value;(async()=>{I==="restore"?await j(r,h):I==="repair"&&await ae(r,h),n?.onBrushComplete?.()})(),J(),c.value=[]}function N(r,h){if(!h)return null;const I=h.querySelector(".image-canvas-wrapper"),T=I?.querySelector("img");if(!T||!T.naturalWidth)return null;const g=I.getBoundingClientRect(),b=window.getComputedStyle(I).transform;let L=1;b&&b!=="none"&&(L=new DOMMatrix(b).a);const W=(r.clientX-g.left)/L,i=(r.clientY-g.top)/L,x=T.naturalWidth,ie=T.naturalHeight;return W<0||i<0||W>x||i>ie?null:{x:W,y:i,scale:L}}function se(){if(c.value.length===0)return null;const h=c.value[0]?.scale||1,I=l.value/2/h;let T=1/0,g=1/0,b=-1/0,L=-1/0;for(const W of c.value)T=Math.min(T,W.x-I),g=Math.min(g,W.y-I),b=Math.max(b,W.x+I),L=Math.max(L,W.y+I);return{x1:Math.max(0,Math.floor(T)),y1:Math.max(0,Math.floor(g)),x2:Math.ceil(b),y2:Math.ceil(L),path:[...c.value],radius:I}}function G(r){J();const h=r.querySelector(".image-canvas-wrapper"),I=h?.querySelector("img");if(!I)return;const T=document.createElement("canvas");T.id="brushOverlayCanvas",T.width=I.naturalWidth,T.height=I.naturalHeight,T.style.cssText="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100;",h.appendChild(T),S=T,D=T.getContext("2d")}function J(){S&&S.parentNode&&S.parentNode.removeChild(S),S=null,D=null}function ee(r){if(!D||!r)return;const h=E.value.fill,I=l.value/2/(r.scale||1);D.beginPath(),D.arc(r.x,r.y,I,0,Math.PI*2),D.fillStyle=h,D.fill()}async function j(r,h){if(!r.originalDataURL)return;let I;return r.cleanImageData?I="data:image/png;base64,"+r.cleanImageData:I=r.originalDataURL,new Promise(T=>{const g=new Image,b=new Image;let L=0;const W=()=>{if(L++,L<2)return;const i=document.createElement("canvas");i.width=g.naturalWidth,i.height=g.naturalHeight;const x=i.getContext("2d");if(!x){T();return}x.drawImage(g,0,0);const ie=document.createElement("canvas");ie.width=i.width,ie.height=i.height;const R=ie.getContext("2d");if(!R){T();return}R.fillStyle="white";for(const ce of h.path)R.beginPath(),R.arc(ce.x,ce.y,h.radius,0,Math.PI*2),R.fill();x.globalCompositeOperation="destination-out",x.drawImage(ie,0,0),x.globalCompositeOperation="destination-over",x.drawImage(b,0,0),x.globalCompositeOperation="source-over";const Y=i.toDataURL("image/png").split(",")[1];t.updateCurrentImage({cleanImageData:Y}),console.log("è¿˜åŸç¬”åˆ·åŒºåŸŸå®Œæˆ"),T()};g.onload=W,g.onerror=()=>T(),b.onload=W,b.onerror=()=>T(),g.src=I,b.src=r.originalDataURL})}async function ae(r,h){const I=n?.getCurrentRepairSettings?.()||{inpaintMethod:"solid",fillColor:"#FFFFFF"},T=I.inpaintMethod;T==="lama_mpe"||T==="litelama"?await A(r,h,T):await d(r,h,I.fillColor)}async function A(r,h,I="lama_mpe"){let T,g;if(r.cleanImageData)T=r.cleanImageData,g="data:image/png;base64,"+r.cleanImageData;else if(r.originalDataURL)T=r.originalDataURL.split(",")[1],g=r.originalDataURL;else{console.error("æ— æ³•è·å–åŸºç¡€å›¾åƒç”¨äº LAMA ä¿®å¤");return}return new Promise(b=>{const L=new Image;L.onload=async()=>{const W=L.naturalWidth,i=L.naturalHeight,x=document.createElement("canvas");x.width=W,x.height=i;const ie=x.getContext("2d");if(!ie){console.error("æ— æ³•åˆ›å»ºæ©è†œç”»å¸ƒä¸Šä¸‹æ–‡"),b();return}ie.fillStyle="black",ie.fillRect(0,0,W,i),ie.fillStyle="white";for(const De of h.path)ie.beginPath(),ie.arc(De.x,De.y,h.radius,0,Math.PI*2),ie.fill();const Y=x.toDataURL("image/png").split(",")[1],ce=[h.x1,h.y1,h.x2,h.y2],xe=I==="litelama"?"litelama":"lama_mpe";try{_e("LAMA ä¿®å¤ä¸­...","info");const De=await _o(T,ce,{method:"lama",lamaModel:xe,maskData:Y});if(De.success&&De.inpainted_image)t.updateCurrentImage({cleanImageData:De.inpainted_image}),console.log("ä¿®å¤ç¬”åˆ·åŒºåŸŸå®Œæˆï¼ˆLAMA ä¿®å¤ï¼Œç²¾ç¡®æ©è†œï¼‰"),_e("LAMA ä¿®å¤å®Œæˆ","success");else throw new Error(De.error||"LAMA ä¿®å¤è¿”å›æ— æ•ˆæ•°æ®")}catch(De){console.error("LAMA ä¿®å¤å¤±è´¥ï¼Œå›é€€åˆ°çº¯è‰²å¡«å……:",De),_e("LAMA ä¿®å¤å¤±è´¥ï¼Œä½¿ç”¨çº¯è‰²å¡«å……","warning");const $e=n?.getCurrentRepairSettings?.();await d(r,h,$e?.fillColor)}b()},L.onerror=()=>{console.error("åŠ è½½å›¾åƒå¤±è´¥ï¼Œæ— æ³•è¿›è¡Œ LAMA ä¿®å¤"),b()},L.src=g})}async function d(r,h,I){const T=I||s.settings.textStyle.fillColor||"#FFFFFF";let g;if(r.cleanImageData)g="data:image/png;base64,"+r.cleanImageData;else if(r.originalDataURL)g=r.originalDataURL;else return;return new Promise(b=>{const L=new Image;L.onload=()=>{const W=document.createElement("canvas");W.width=L.naturalWidth,W.height=L.naturalHeight;const i=W.getContext("2d");if(!i){b();return}i.drawImage(L,0,0),i.fillStyle=T;for(const ie of h.path)i.beginPath(),i.arc(ie.x,ie.y,h.radius,0,Math.PI*2),i.fill();const x=W.toDataURL("image/png").split(",")[1];t.updateCurrentImage({cleanImageData:x}),console.log("ä¿®å¤ç¬”åˆ·åŒºåŸŸå®Œæˆï¼ˆçº¯è‰²å¡«å……ï¼‰"),b()},L.onerror=()=>b(),L.src=g})}async function $(){const r=t.currentImage;if(!r)return console.warn("ensureCleanBackground: æ²¡æœ‰å½“å‰å›¾ç‰‡"),!1;if(r.cleanImageData)return console.log("ensureCleanBackground: å·²æœ‰å¹²å‡€èƒŒæ™¯"),!0;const h=n?.getCurrentRepairSettings?.();if((h?.inpaintMethod||s.settings.textStyle.inpaintMethod)!=="solid")return console.log("ensureCleanBackground: éçº¯è‰²å¡«å……æ¨¡å¼ï¼Œè·³è¿‡"),!1;if(!r.bubbleStates||r.bubbleStates.length===0)return console.warn("ensureCleanBackground: æ²¡æœ‰æ°”æ³¡æ•°æ®"),!1;if(!r.translatedDataURL&&!r.originalDataURL)return console.warn("ensureCleanBackground: æ²¡æœ‰å›¾ç‰‡æ•°æ®"),!1;console.log("ensureCleanBackground: å°è¯•ä¸ºçº¯è‰²å¡«å……æ¨¡å¼åˆ›å»ºä¸´æ—¶å¹²å‡€èƒŒæ™¯");const T=r.translatedDataURL||r.originalDataURL,g=h?.fillColor||s.settings.textStyle.fillColor||"#FFFFFF";return new Promise(b=>{const L=new Image;L.onload=()=>{try{const W=document.createElement("canvas");W.width=L.naturalWidth,W.height=L.naturalHeight;const i=W.getContext("2d");if(!i){console.error("ensureCleanBackground: æ— æ³•è·å– Canvas ä¸Šä¸‹æ–‡"),b(!1);return}i.drawImage(L,0,0),i.fillStyle=g;for(const ie of r.bubbleStates){const[R,Y,ce,xe]=ie.coords;i.fillRect(R,Y,ce-R+1,xe-Y+1)}const x=W.toDataURL("image/png").split(",")[1];t.updateCurrentImage({cleanImageData:x}),console.log("ensureCleanBackground: æˆåŠŸåˆ›å»ºä¸´æ—¶å¹²å‡€èƒŒæ™¯ï¼ˆçº¯è‰²å¡«å……ï¼‰"),b(!0)}catch(W){console.error("ensureCleanBackground: Canvas æ“ä½œå¤±è´¥:",W),b(!1)}},L.onerror=()=>{console.error("ensureCleanBackground: åŠ è½½å›¾åƒå¤±è´¥"),b(!1)},L.src=T})}return zt(()=>{q()}),{brushMode:o,brushSize:l,isBrushKeyDown:u,isBrushPainting:a,mouseX:v,mouseY:p,isActive:M,brushColor:E,BRUSH_MIN_SIZE:tn,BRUSH_MAX_SIZE:en,enterBrushMode:P,exitBrushMode:q,toggleBrushMode:V,setBrushSize:U,adjustBrushSize:f,handleBrushWheel:m,startBrushPainting:C,continueBrushPainting:k,finishBrushPainting:K,getBrushPositionInImage:N,getBrushPathBounds:se,ensureCleanBackground:$}}function Cm(n){return[Math.round(n[0]),Math.round(n[1]),Math.round(n[2]),Math.round(n[3])]}function Sm(n){const t=gt(),s=et(),o=Ne(),{bubbles:l,selectedIndex:u,hasSelection:a}=kt(t),{currentImage:c}=kt(s),v=w(!1),p=w(!1),_=w(null),S=w(0),D=w(0),M=w(!1);function E(i){t.selectBubble(i)}function P(i){t.toggleMultiSelect(i)}function q(){t.clearMultiSelect()}function V(i,x){console.log(`å¼€å§‹æ‹–åŠ¨æ°”æ³¡ #${i+1}`)}function U(i,x){}function f(i,x){t.updateBubble(i,{coords:x}),console.log(`æ°”æ³¡ #${i+1} æ‹–åŠ¨å®Œæˆ:`,x),I()}function m(i,x,ie){console.log(`å¼€å§‹è°ƒæ•´æ°”æ³¡ #${i+1} å¤§å°ï¼Œæ‰‹æŸ„: ${x}`)}function C(i){}function k(i,x){t.updateBubble(i,{coords:x}),console.log(`æ°”æ³¡ #${i+1} è°ƒæ•´å¤§å°å®Œæˆ:`,x),I()}function K(i,x){console.log(`å¼€å§‹æ—‹è½¬æ°”æ³¡ #${i+1}`)}function N(i){}function se(i,x){t.updateBubble(i,{rotationAngle:x}),console.log(`æ°”æ³¡ #${i+1} æ—‹è½¬å®Œæˆ: ${x}Â°`),I()}function G(){v.value=!v.value,v.value?console.log("è¿›å…¥ç»˜åˆ¶æ¨¡å¼"):console.log("é€€å‡ºç»˜åˆ¶æ¨¡å¼")}function J(i){t.addBubble(i),t.selectBubble(t.bubbleCount-1),console.log("å·²æ·»åŠ æ–°æ°”æ³¡:",i),n?.onReRender?.()}function ee(i,x){p.value=!0,S.value=i,D.value=x,_.value=[i,x,i,x]}function j(i,x){p.value&&(_.value=[S.value,D.value,i,x])}function ae(){if(!p.value||!_.value)return p.value=!1,_.value=null,null;const[i,x,ie,R]=_.value,Y=10;if(Math.abs(ie-i)<Y||Math.abs(R-x)<Y)return p.value=!1,_.value=null,null;const ce=[Math.min(i,ie),Math.min(x,R),Math.max(i,ie),Math.max(x,R)];return p.value=!1,_.value=null,ce}function A(){p.value=!1,_.value=null,v.value=!1}function d(){if(!_.value)return{};const[i,x,ie,R]=_.value;return{position:"absolute",left:`${Math.min(i,ie)}px`,top:`${Math.min(x,R)}px`,width:`${Math.abs(ie-i)}px`,height:`${Math.abs(R-x)}px`,border:"2px dashed #00d4ff",background:"rgba(0, 212, 255, 0.1)",pointerEvents:"none",zIndex:"25",boxSizing:"border-box"}}let $=null,r=!1;const h=150;function I(){$&&clearTimeout($),$=setTimeout(async()=>{if(r){console.log("è·³è¿‡æ¸²æŸ“ï¼Œä¸Šä¸€æ¬¡æ¸²æŸ“ä»åœ¨è¿›è¡Œä¸­");return}console.log("è§¦å‘å»¶è¿Ÿæ¸²æŸ“é¢„è§ˆ"),r=!0;try{n?.onDelayedPreview?await n.onDelayedPreview():n?.onReRender&&await n.onReRender()}catch(i){console.error("å»¶è¿Ÿæ¸²æŸ“é¢„è§ˆå¤±è´¥:",i)}finally{r=!1}},h)}function T(i){t.updateSelectedBubble(i),I()}function g(){a.value&&(t.deleteSelected(),console.log("å·²åˆ é™¤é€‰ä¸­çš„æ°”æ³¡"),n?.onReRender?.())}async function b(){const i=u.value;if(i<0){console.warn("è¯·å…ˆé€‰ä¸­è¦ä¿®å¤çš„æ°”æ³¡æ¡†");return}const x=l.value[i],ie=c.value;if(!x||!ie?.originalDataURL){console.warn("æ— æ³•ä¿®å¤èƒŒæ™¯ï¼šç¼ºå°‘æ°”æ³¡æˆ–å›¾ç‰‡æ•°æ®");return}const R=x.inpaintMethod||"solid",Y=x.fillColor||"#FFFFFF",ce=x.rotationAngle||0;try{console.log(`å¼€å§‹ä¿®å¤æ°”æ³¡ #${i+1} èƒŒæ™¯ï¼Œæ–¹æ³•: ${R}`);let xe;if(ie.cleanImageData)xe=ie.cleanImageData;else{const $e=ie.originalDataURL.match(/^data:image\/[^;]+;base64,(.+)$/);if(xe=$e&&$e[1]?$e[1]:"",!xe){console.error("æ— æ³•è§£æå›¾åƒæ•°æ®");return}}if(R==="lama_mpe"||R==="litelama"){const $e=R==="litelama"?"litelama":"lama_mpe",he=Cm(x.coords),te=await _o(xe,he,{bubbleAngle:ce,method:"lama",lamaModel:$e});te.success&&te.inpainted_image?(s.updateCurrentImage({cleanImageData:te.inpainted_image}),console.log(`æ°”æ³¡ #${i+1} LAMAèƒŒæ™¯ä¿®å¤æˆåŠŸ`),I()):(console.error("LAMAä¿®å¤å¤±è´¥:",te.error||"æœªçŸ¥é”™è¯¯"),await L(x.coords,Y,ce),I())}else await L(x.coords,Y,ce),console.log(`æ°”æ³¡ #${i+1} çº¯è‰²å¡«å……ä¿®å¤æˆåŠŸ`),I()}catch(xe){console.error("èƒŒæ™¯ä¿®å¤å‡ºé”™:",xe)}}async function L(i,x,ie=0){const R=c.value;if(!R)return;const[Y,ce,xe,De]=i;let $e;if(R.cleanImageData)$e="data:image/png;base64,"+R.cleanImageData;else if(R.originalDataURL)$e=R.originalDataURL;else{console.error("æ— æ³•æ‰¾åˆ°åŸºç¡€å›¾åƒç”¨äºå¡«å……");return}return new Promise(he=>{const te=new Image;te.onload=()=>{const y=document.createElement("canvas");y.width=te.naturalWidth,y.height=te.naturalHeight;const X=y.getContext("2d");if(!X){he();return}if(X.drawImage(te,0,0),X.fillStyle=x,Math.abs(ie)<.1)X.fillRect(Y,ce,xe-Y,De-ce);else{const fe=(Y+xe)/2,O=(ce+De)/2,oe=(xe-Y)/2,be=(De-ce)/2,ge=ie*Math.PI/180,Pe=Math.cos(ge),Ee=Math.sin(ge),Le=[[-oe,-be],[oe,-be],[oe,be],[-oe,be]].map(([Be,ye])=>[fe+Be*Pe-ye*Ee,O+Be*Ee+ye*Pe]);X.beginPath();const ke=Le[0];if(ke){X.moveTo(ke[0],ke[1]);for(let Be=1;Be<Le.length;Be++){const ye=Le[Be];ye&&X.lineTo(ye[0],ye[1])}}X.closePath(),X.fill()}const ve=y.toDataURL("image/png").split(",")[1];s.updateCurrentImage({cleanImageData:ve}),console.log("å·²å¯¹æ°”æ³¡åŒºåŸŸè¿›è¡Œçº¯è‰²å¡«å……:",i,x,"è§’åº¦:",ie),he()},te.onerror=()=>{console.error("åŠ è½½åŸºç¡€å›¾åƒå¤±è´¥"),he()},te.src=$e})}async function W(i){const x=l.value[i],ie=c.value;if(!x||!ie?.originalDataURL){console.warn("æ— æ³•è¿›è¡Œ OCR è¯†åˆ«ï¼šç¼ºå°‘æ°”æ³¡æˆ–å›¾ç‰‡æ•°æ®");return}try{console.log(`å¼€å§‹ OCR è¯†åˆ«æ°”æ³¡ #${i+1}`);const R=ie.originalDataURL.split(",")[1]||"",Y=o.settings,ce=Y.ocrEngine==="paddleocr_vl"?Y.paddleOcrVl?.sourceLanguage||"japanese":Y.sourceLanguage,xe=await Tn(R,x.coords,Y.ocrEngine||"manga_ocr",{source_language:ce,baidu_ocr_api_key:Y.baiduOcr.apiKey,baidu_ocr_secret_key:Y.baiduOcr.secretKey,baidu_version:Y.baiduOcr.version,baidu_source_language:Y.baiduOcr.sourceLanguage,ai_vision_provider:Y.aiVisionOcr.provider,ai_vision_api_key:Y.aiVisionOcr.apiKey,ai_vision_model_name:Y.aiVisionOcr.modelName,ai_vision_ocr_prompt:Y.aiVisionOcr.prompt,custom_ai_vision_base_url:Y.aiVisionOcr.customBaseUrl,ai_vision_min_image_size:Y.aiVisionOcr.minImageSize});xe.success&&xe.text!==void 0?(t.updateBubble(i,{originalText:xe.text}),console.log(`OCR è¯†åˆ«æˆåŠŸ: "${xe.text}"`)):console.error("OCR è¯†åˆ«å¤±è´¥:",xe.error||"æœªçŸ¥é”™è¯¯")}catch(R){console.error("OCR è¯†åˆ«å‡ºé”™:",R)}}return{isDrawingMode:v,isDrawingBox:p,currentDrawingRect:_,isMiddleButtonDown:M,handleBubbleSelect:E,handleBubbleMultiSelect:P,handleClearMultiSelect:q,handleBubbleDragStart:V,handleBubbleDragging:U,handleBubbleDragEnd:f,handleBubbleResizeStart:m,handleBubbleResizing:C,handleBubbleResizeEnd:k,handleBubbleRotateStart:K,handleBubbleRotating:N,handleBubbleRotateEnd:se,toggleDrawingMode:G,handleDrawBubble:J,startDrawingBox:ee,updateDrawingBox:j,finishDrawingBox:ae,cancelDrawing:A,getDrawingRectStyle:d,handleBubbleUpdate:T,deleteSelectedBubbles:g,repairSelectedBubble:b,triggerDelayedPreview:I,handleOcrRecognize:W}}function km(n){const t=gt(),s=et(),{bubbles:o}=kt(t),{currentImage:l}=kt(s),u=w(!1),a=w("");let c=null;function v(){const S=l.value;if(!S)return null;if(S.cleanImageData)return S.cleanImageData;if(S.originalDataURL){const D=S.originalDataURL.match(/^data:image\/[^;]+;base64,(.+)$/);if(D&&D[1])return D[1]}return null}async function p(S=!1){if(!l.value)return console.warn("reRenderFullImage: æ²¡æœ‰å½“å‰å›¾ç‰‡"),!1;if(o.value.length===0){console.log("reRenderFullImage: æ²¡æœ‰æ°”æ³¡ï¼Œè·³è¿‡åç«¯æ¸²æŸ“");const P=v();if(P){const q=`data:image/png;base64,${P}`;s.updateCurrentImage({translatedDataURL:q}),S||n?.onRenderSuccess?.(q)}return!0}const M=v();if(!M)return console.error("reRenderFullImage: ç¼ºå°‘å›¾åƒæ•°æ®"),a.value="ç¼ºå°‘å›¾åƒæ•°æ®",S||n?.onRenderError?.("ç¼ºå°‘å›¾åƒæ•°æ®"),!1;const E=Symbol("render");c=E,u.value=!0,a.value="",S||n?.onRenderStart?.();try{console.log("reRenderFullImage: å¼€å§‹é‡æ–°æ¸²æŸ“ï¼Œæ°”æ³¡æ•°é‡:",o.value.length);const P=o.value,q=P.map(m=>m.translatedText||""),V=P.map(m=>m.coords.map(C=>Math.round(C))),U=P.map(m=>({translatedText:m.translatedText||"",coords:m.coords,fontSize:Number(m.fontSize)||24,fontFamily:m.fontFamily||yt,textDirection:Ft(m),textColor:m.textColor||"#231816",rotationAngle:Math.round(Number(m.rotationAngle)||0),position:m.position?{x:Math.round(m.position.x||0),y:Math.round(m.position.y||0)}:{x:0,y:0},strokeEnabled:m.strokeEnabled!==void 0?m.strokeEnabled:!0,strokeColor:m.strokeColor||"#FFFFFF",strokeWidth:Number(m.strokeWidth)||3})),f=await yo({clean_image:M,bubble_texts:q,bubble_coords:V,bubble_states:U,fontSize:Number(P[0]?.fontSize)||24,fontFamily:P[0]?.fontFamily||yt,textDirection:P[0]?Ft(P[0]):"vertical",textColor:P[0]?.textColor||"#231816",strokeEnabled:P[0]?.strokeEnabled!==void 0?P[0].strokeEnabled:!0,strokeColor:P[0]?.strokeColor||"#FFFFFF",strokeWidth:Number(P[0]?.strokeWidth)||3,use_individual_styles:!0,use_inpainting:!1,use_lama:!1,is_font_style_change:!0});if(c!==E)return console.log("reRenderFullImage: æ¸²æŸ“ç»“æœå·²è¿‡æœŸï¼Œå¿½ç•¥"),!1;if(f.rendered_image){const m=`data:image/png;base64,${f.rendered_image}`;return s.updateCurrentImage({translatedDataURL:m}),console.log("reRenderFullImage: æ¸²æŸ“æˆåŠŸ"),S||n?.onRenderSuccess?.(m),!0}else{const m=f.error||"æ¸²æŸ“å¤±è´¥";return console.error("reRenderFullImage: æ¸²æŸ“å¤±è´¥ -",m),a.value=m,S||n?.onRenderError?.(m),!1}}catch(P){if(c!==E)return!1;const q=P instanceof Error?P.message:"æ¸²æŸ“è¯·æ±‚å¤±è´¥";return console.error("reRenderFullImage: æ¸²æŸ“å‡ºé”™ -",P),a.value=q,S||n?.onRenderError?.(q),!1}finally{c===E&&(u.value=!1,S||n?.onRenderEnd?.())}}function _(){c=null,u.value=!1}return{isRendering:u,renderError:a,reRenderFullImage:p,cancelRender:_}}const wm=["data-index","data-coords","data-rotation","onClick","onMousedown"],$m={class:"bubble-index"},Tm=["data-parent-index","onMousedown"],Im=["data-parent-index","onMousedown"],Pm=["data-parent-index","onMousedown"],Rm=["data-parent-index","onMousedown"],Dm=["data-parent-index","onMousedown"],Mm=["data-parent-index","onMousedown"],Em=["data-parent-index","onMousedown"],Bm=["data-parent-index","onMousedown"],Am=["data-parent-index","onMousedown"],Lm=je({__name:"BubbleOverlay",props:{bubbles:{},selectedIndex:{},selectedIndices:{},scale:{},isDrawingMode:{type:Boolean},isBrushMode:{type:Boolean},imageWidth:{},imageHeight:{}},emits:["select","multiSelect","dragStart","dragging","dragEnd","resizeStart","resizing","resizeEnd","rotateStart","rotating","rotateEnd","drawBubble"],setup(n,{emit:t}){const s=gt(),{isDragging:o,draggingIndex:l,dragOffsetX:u,dragOffsetY:a,dragInitialX:c,dragInitialY:v,isResizing:p,resizingIndex:_,resizeCurrentCoords:S,isRotating:D,rotatingIndex:M,rotateCurrentAngle:E}=kt(s),P=n,q=t,V=w(null),U=w(0),f=w(0),m=w(""),C=w(0),k=w(0),K=w(null),N=w(0),se=w(0),G=w(0),J=w(0),ee=w(!1),j=w(0),ae=w(0),A=w(null),d=w(!1);function $(y,X){let ve,fe,O,oe,be=y.rotationAngle||0;if(o.value&&l.value===X){const[Le,ke,Be,ye]=y.coords;ve=c.value+u.value,fe=v.value+a.value,O=ve+(Be-Le),oe=fe+(ye-ke)}else p.value&&_.value===X&&S.value?[ve,fe,O,oe]=S.value:D.value&&M.value===X?([ve,fe,O,oe]=y.coords,be=E.value):[ve,fe,O,oe]=y.coords;const ge=O-ve,Pe=oe-fe,Ee={left:`${ve}px`,top:`${fe}px`,width:`${ge}px`,height:`${Pe}px`};return be&&(Ee.transformOrigin="center center",Ee.transform=`rotate(${be}deg)`),Ee}function r(){if(!A.value)return{};const[y,X,ve,fe]=A.value;return{left:`${Math.min(y,ve)}px`,top:`${Math.min(X,fe)}px`,width:`${Math.abs(ve-y)}px`,height:`${Math.abs(fe-X)}px`}}function h(y){if(!V.value)return null;const X=V.value.getBoundingClientRect(),ve=P.scale||1,fe=(y.clientX-X.left)/ve,O=(y.clientY-X.top)/ve;return{x:fe,y:O}}function I(y,X){P.isBrushMode||X.shiftKey||q("select",y)}function T(y){if(!P.isBrushMode){if(y.button===1){y.preventDefault(),d.value=!0,document.body.classList.add("middle-button-drawing"),xe(y);return}y.button===0&&P.isDrawingMode&&xe(y)}}function g(y,X){if(!P.isBrushMode&&X.button===0){if(X.preventDefault(),X.stopPropagation(),X.shiftKey){q("multiSelect",y);return}if(y!==P.selectedIndex){q("select",y);return}b(y,X)}}function b(y,X){document.removeEventListener("mousemove",he),document.removeEventListener("mouseup",te),o.value=!0,l.value=y,U.value=X.clientX,f.value=X.clientY,u.value=0,a.value=0;const ve=P.bubbles[y];ve&&(c.value=ve.coords[0],v.value=ve.coords[1]),q("dragStart",y,X),document.addEventListener("mousemove",he),document.addEventListener("mouseup",te)}function L(y){const X=P.scale||1,ve=(y.clientX-U.value)/X,fe=(y.clientY-f.value)/X;u.value=ve,a.value=fe}function W(y){const X=l.value;o.value=!1,l.value=-1,u.value=0,a.value=0;const ve=P.scale||1,fe=(y.clientX-U.value)/ve,O=(y.clientY-f.value)/ve,oe=P.bubbles[X];if(!oe)return;const[be,ge,Pe,Ee]=oe.coords,Le=Pe-be,ke=Ee-ge;let Be=Math.round(c.value+fe),ye=Math.round(v.value+O);const it=P.imageWidth||2e3,Ge=P.imageHeight||2e3,Ze=Math.min(Le,it),st=Math.min(ke,Ge);Be=Math.max(0,Math.min(Be,it-Ze)),ye=Math.max(0,Math.min(ye,Ge-st));const Ae=[Be,ye,Be+Ze,ye+st];q("dragEnd",X,Ae)}function i(y,X,ve){if(P.isBrushMode||ve.button!==0)return;ve.preventDefault(),ve.stopPropagation(),document.removeEventListener("mousemove",he),document.removeEventListener("mouseup",te),p.value=!0,_.value=X,m.value=y,C.value=ve.clientX,k.value=ve.clientY;const fe=P.bubbles[X];fe&&(K.value=[...fe.coords],S.value=[...fe.coords]),q("resizeStart",X,y,ve),document.addEventListener("mousemove",he),document.addEventListener("mouseup",te)}function x(y){if(!K.value)return;const X=P.scale||1,ve=(y.clientX-C.value)/X,fe=(y.clientY-k.value)/X;let[O,oe,be,ge]=K.value;const Pe=m.value;Pe.includes("w")&&(O+=ve),Pe.includes("e")&&(be+=ve),Pe.includes("n")&&(oe+=fe),Pe.includes("s")&&(ge+=fe),O>be&&([O,be]=[be,O]),oe>ge&&([oe,ge]=[ge,oe]);const Ee=10;be-O<Ee||ge-oe<Ee||(S.value=[O,oe,be,ge])}function ie(y){if(!K.value)return;const X=P.scale||1,ve=(y.clientX-C.value)/X,fe=(y.clientY-k.value)/X;let[O,oe,be,ge]=K.value;const Pe=m.value;Pe.includes("w")&&(O+=ve),Pe.includes("e")&&(be+=ve),Pe.includes("n")&&(oe+=fe),Pe.includes("s")&&(ge+=fe),O>be&&([O,be]=[be,O]),oe>ge&&([oe,ge]=[ge,oe]);const Ee=P.imageWidth||2e3,Le=P.imageHeight||2e3;O=Math.max(0,Math.round(O)),oe=Math.max(0,Math.round(oe)),be=Math.min(Ee,Math.round(be)),ge=Math.min(Le,Math.round(ge));const ke=10;if(be-O<ke||ge-oe<ke){console.warn("è°ƒæ•´åå°ºå¯¸è¿‡å°ï¼Œå·²æ’¤é”€"),p.value=!1,_.value=-1,K.value=null;return}q("resizeEnd",_.value,[O,oe,be,ge]),p.value=!1,_.value=-1,K.value=null,S.value=null}function R(y,X){if(P.isBrushMode||X.button!==0)return;X.preventDefault(),X.stopPropagation(),document.removeEventListener("mousemove",he),document.removeEventListener("mouseup",te),D.value=!0,M.value=y;const ve=P.bubbles[y];if(!ve||!V.value)return;const[fe,O,oe,be]=ve.coords,ge=P.scale||1,Pe=V.value.getBoundingClientRect();G.value=Pe.left+(fe+oe)/2*ge,J.value=Pe.top+(O+be)/2*ge;const Ee=X.clientX-G.value,Le=X.clientY-J.value;N.value=Math.atan2(Le,Ee)*180/Math.PI,se.value=ve.rotationAngle||0,E.value=ve.rotationAngle||0,q("rotateStart",y,X),document.body.classList.add("rotating-box"),document.addEventListener("mousemove",he),document.addEventListener("mouseup",te),console.log(`å¼€å§‹æ—‹è½¬æ°”æ³¡ #${y+1}ï¼Œåˆå§‹è§’åº¦: ${se.value}Â°`)}function Y(y){const X=y.clientX-G.value,ve=y.clientY-J.value,O=Math.atan2(ve,X)*180/Math.PI-N.value;let oe=se.value+O;for(;oe>180;)oe-=360;for(;oe<-180;)oe+=360;y.shiftKey&&(oe=Math.round(oe/15)*15),E.value=oe}function ce(y){document.body.classList.remove("rotating-box");const X=M.value,ve=E.value;q("rotateEnd",X,ve),D.value=!1,M.value=-1,console.log(`æ°”æ³¡ #${X+1} æ—‹è½¬å®Œæˆï¼Œè§’åº¦: ${ve}Â°`)}function xe(y){const X=h(y);if(!X)return;const ve=P.imageWidth||2e3,fe=P.imageHeight||2e3;X.x<0||X.x>ve||X.y<0||X.y>fe||(ee.value=!0,j.value=X.x,ae.value=X.y,A.value=[X.x,X.y,X.x,X.y],document.addEventListener("mousemove",he),document.addEventListener("mouseup",te),console.log("å¼€å§‹ç»˜åˆ¶æ–°æ¡†:",X.x.toFixed(1),X.y.toFixed(1)))}function De(y){const X=h(y);!X||!A.value||(A.value=[j.value,ae.value,X.x,X.y])}function $e(y){const X=h(y);if(d.value&&(d.value=!1,document.body.classList.remove("middle-button-drawing")),!X||!A.value){ee.value=!1,A.value=null;return}const ve=P.imageWidth||2e3,fe=P.imageHeight||2e3,O=Math.max(0,Math.round(Math.min(j.value,X.x))),oe=Math.max(0,Math.round(Math.min(ae.value,X.y))),be=Math.min(ve,Math.round(Math.max(j.value,X.x))),ge=Math.min(fe,Math.round(Math.max(ae.value,X.y))),Pe=10;if(be-O<Pe||ge-oe<Pe){console.log("ç»˜åˆ¶çš„æ¡†å¤ªå°ï¼Œå·²å¿½ç•¥"),ee.value=!1,A.value=null;return}console.log("å®Œæˆç»˜åˆ¶æ–°æ¡†:",[O,oe,be,ge]),q("drawBubble",[O,oe,be,ge]),ee.value=!1,A.value=null}function he(y){o.value?L(y):p.value?x(y):D.value?Y(y):ee.value&&De(y)}function te(y){document.removeEventListener("mousemove",he),document.removeEventListener("mouseup",te),(y.button===1||d.value)&&(d.value=!1,document.body.classList.remove("middle-button-drawing")),o.value?W(y):p.value?ie(y):D.value?ce():ee.value&&$e(y)}return dt(()=>{}),zt(()=>{document.removeEventListener("mousemove",he),document.removeEventListener("mouseup",te),document.body.classList.remove("middle-button-drawing"),document.body.classList.remove("rotating-box")}),(y,X)=>(B(),F("div",{class:Ie(["bubble-overlay",{"brush-mode":n.isBrushMode}]),style:at({"--scale":n.scale||1}),ref_key:"overlayRef",ref:V,onMousedown:T},[(B(!0),F(ze,null,Ye(n.bubbles,(ve,fe)=>(B(),F("div",{key:fe,class:Ie(["bubble-highlight-box",{selected:fe===n.selectedIndex,"multi-selected":n.selectedIndices.length>1&&n.selectedIndices.includes(fe)&&fe!==n.selectedIndex}]),style:at($(ve,fe)),"data-index":fe,"data-coords":JSON.stringify(ve.coords),"data-rotation":ve.rotationAngle||0,onClick:lt(O=>I(fe,O),["stop"]),onMousedown:lt(O=>g(fe,O),["stop"])},[e("span",$m,ne(fe+1),1),fe===n.selectedIndex?(B(),F(ze,{key:0},[e("div",{class:"resize-handle nw","data-handle":"nw","data-parent-index":fe,onMousedown:lt(O=>i("nw",fe,O),["stop"])},null,40,Tm),e("div",{class:"resize-handle n","data-handle":"n","data-parent-index":fe,onMousedown:lt(O=>i("n",fe,O),["stop"])},null,40,Im),e("div",{class:"resize-handle ne","data-handle":"ne","data-parent-index":fe,onMousedown:lt(O=>i("ne",fe,O),["stop"])},null,40,Pm),e("div",{class:"resize-handle e","data-handle":"e","data-parent-index":fe,onMousedown:lt(O=>i("e",fe,O),["stop"])},null,40,Rm),e("div",{class:"resize-handle se","data-handle":"se","data-parent-index":fe,onMousedown:lt(O=>i("se",fe,O),["stop"])},null,40,Dm),e("div",{class:"resize-handle s","data-handle":"s","data-parent-index":fe,onMousedown:lt(O=>i("s",fe,O),["stop"])},null,40,Mm),e("div",{class:"resize-handle sw","data-handle":"sw","data-parent-index":fe,onMousedown:lt(O=>i("sw",fe,O),["stop"])},null,40,Em),e("div",{class:"resize-handle w","data-handle":"w","data-parent-index":fe,onMousedown:lt(O=>i("w",fe,O),["stop"])},null,40,Bm),X[0]||(X[0]=e("div",{class:"rotate-line"},null,-1)),e("div",{class:"rotate-handle",title:"æ‹–æ‹½æ—‹è½¬","data-parent-index":fe,onMousedown:lt(O=>R(fe,O),["stop"])},null,40,Am)],64)):de("",!0)],46,wm))),128)),A.value?(B(),F("div",{key:0,class:"drawing-rect",style:at(r())},null,4)):de("",!0)],38))}}),hn=He(Lm,[["__scopeId","data-v-8d9cb1b9"]]),Fm={key:0,class:"kana-keyboard"},Um={class:"kana-keyboard-header"},Om={class:"kana-keyboard-tabs"},zm=["onClick"],Nm={class:"kana-keyboard-options"},Vm={class:"kana-mode-select"},Wm={class:"kana-target-select"},Km={class:"kana-table"},qm={class:"row-label"},Hm=["onClick"],jm={class:"kana-hiragana"},Jm={class:"kana-katakana"},Ym={class:"kana-table"},Xm={class:"row-label"},Gm=["onClick"],Zm={class:"kana-hiragana"},Qm={class:"kana-katakana"},ev={class:"kana-table combo-table"},tv={class:"row-label"},ov=["onClick"],nv={class:"kana-hiragana"},sv={class:"kana-katakana"},av={class:"special-chars-grid"},lv=["onClick"],iv={key:0,class:"char-label"},rv=je({__name:"JapaneseKeyboard",props:{visible:{type:Boolean,default:!1},defaultTarget:{default:"original"}},emits:["close","insert","delete"],setup(n,{emit:t}){const s=n,o=t,l=w("basic"),u=w("hiragana"),a=w(s.defaultTarget),c=w(null),v=[{label:"åŸæ–‡",value:"original"},{label:"è¯‘æ–‡",value:"translated"}],p=[{id:"basic",label:"åŸºæœ¬"},{id:"dakuten",label:"æµŠ/åŠæµŠéŸ³"},{id:"combo",label:"æ‹—éŸ³"},{id:"special",label:"ç‰¹æ®Š"}],_=[{label:"ã‚è¡Œ",chars:[{h:"ã‚",k:"ã‚¢"},{h:"ã„",k:"ã‚¤"},{h:"ã†",k:"ã‚¦"},{h:"ãˆ",k:"ã‚¨"},{h:"ãŠ",k:"ã‚ª"}]},{label:"ã‹è¡Œ",chars:[{h:"ã‹",k:"ã‚«"},{h:"ã",k:"ã‚­"},{h:"ã",k:"ã‚¯"},{h:"ã‘",k:"ã‚±"},{h:"ã“",k:"ã‚³"}]},{label:"ã•è¡Œ",chars:[{h:"ã•",k:"ã‚µ"},{h:"ã—",k:"ã‚·"},{h:"ã™",k:"ã‚¹"},{h:"ã›",k:"ã‚»"},{h:"ã",k:"ã‚½"}]},{label:"ãŸè¡Œ",chars:[{h:"ãŸ",k:"ã‚¿"},{h:"ã¡",k:"ãƒ"},{h:"ã¤",k:"ãƒ„"},{h:"ã¦",k:"ãƒ†"},{h:"ã¨",k:"ãƒˆ"}]},{label:"ãªè¡Œ",chars:[{h:"ãª",k:"ãƒŠ"},{h:"ã«",k:"ãƒ‹"},{h:"ã¬",k:"ãƒŒ"},{h:"ã­",k:"ãƒ"},{h:"ã®",k:"ãƒ"}]},{label:"ã¯è¡Œ",chars:[{h:"ã¯",k:"ãƒ"},{h:"ã²",k:"ãƒ’"},{h:"ãµ",k:"ãƒ•"},{h:"ã¸",k:"ãƒ˜"},{h:"ã»",k:"ãƒ›"}]},{label:"ã¾è¡Œ",chars:[{h:"ã¾",k:"ãƒ"},{h:"ã¿",k:"ãƒŸ"},{h:"ã‚€",k:"ãƒ "},{h:"ã‚",k:"ãƒ¡"},{h:"ã‚‚",k:"ãƒ¢"}]},{label:"ã‚„è¡Œ",chars:[{h:"ã‚„",k:"ãƒ¤"},null,{h:"ã‚†",k:"ãƒ¦"},null,{h:"ã‚ˆ",k:"ãƒ¨"}]},{label:"ã‚‰è¡Œ",chars:[{h:"ã‚‰",k:"ãƒ©"},{h:"ã‚Š",k:"ãƒª"},{h:"ã‚‹",k:"ãƒ«"},{h:"ã‚Œ",k:"ãƒ¬"},{h:"ã‚",k:"ãƒ­"}]},{label:"ã‚è¡Œ",chars:[{h:"ã‚",k:"ãƒ¯"},null,null,null,{h:"ã‚’",k:"ãƒ²"}]},{label:"ã‚“",chars:[{h:"ã‚“",k:"ãƒ³"},null,null,null,null]}],S=[{label:"ãŒè¡Œ",chars:[{h:"ãŒ",k:"ã‚¬"},{h:"ã",k:"ã‚®"},{h:"ã",k:"ã‚°"},{h:"ã’",k:"ã‚²"},{h:"ã”",k:"ã‚´"}]},{label:"ã–è¡Œ",chars:[{h:"ã–",k:"ã‚¶"},{h:"ã˜",k:"ã‚¸"},{h:"ãš",k:"ã‚º"},{h:"ãœ",k:"ã‚¼"},{h:"ã",k:"ã‚¾"}]},{label:"ã è¡Œ",chars:[{h:"ã ",k:"ãƒ€"},{h:"ã¢",k:"ãƒ‚"},{h:"ã¥",k:"ãƒ…"},{h:"ã§",k:"ãƒ‡"},{h:"ã©",k:"ãƒ‰"}]},{label:"ã°è¡Œ",chars:[{h:"ã°",k:"ãƒ"},{h:"ã³",k:"ãƒ“"},{h:"ã¶",k:"ãƒ–"},{h:"ã¹",k:"ãƒ™"},{h:"ã¼",k:"ãƒœ"}]},{label:"ã±è¡Œ",chars:[{h:"ã±",k:"ãƒ‘"},{h:"ã´",k:"ãƒ”"},{h:"ã·",k:"ãƒ—"},{h:"ãº",k:"ãƒš"},{h:"ã½",k:"ãƒ"}]}],D=[{label:"ãã‚ƒè¡Œ",chars:[{h:"ãã‚ƒ",k:"ã‚­ãƒ£"},{h:"ãã‚…",k:"ã‚­ãƒ¥"},{h:"ãã‚‡",k:"ã‚­ãƒ§"}]},{label:"ã—ã‚ƒè¡Œ",chars:[{h:"ã—ã‚ƒ",k:"ã‚·ãƒ£"},{h:"ã—ã‚…",k:"ã‚·ãƒ¥"},{h:"ã—ã‚‡",k:"ã‚·ãƒ§"}]},{label:"ã¡ã‚ƒè¡Œ",chars:[{h:"ã¡ã‚ƒ",k:"ãƒãƒ£"},{h:"ã¡ã‚…",k:"ãƒãƒ¥"},{h:"ã¡ã‚‡",k:"ãƒãƒ§"}]},{label:"ã«ã‚ƒè¡Œ",chars:[{h:"ã«ã‚ƒ",k:"ãƒ‹ãƒ£"},{h:"ã«ã‚…",k:"ãƒ‹ãƒ¥"},{h:"ã«ã‚‡",k:"ãƒ‹ãƒ§"}]},{label:"ã²ã‚ƒè¡Œ",chars:[{h:"ã²ã‚ƒ",k:"ãƒ’ãƒ£"},{h:"ã²ã‚…",k:"ãƒ’ãƒ¥"},{h:"ã²ã‚‡",k:"ãƒ’ãƒ§"}]},{label:"ã¿ã‚ƒè¡Œ",chars:[{h:"ã¿ã‚ƒ",k:"ãƒŸãƒ£"},{h:"ã¿ã‚…",k:"ãƒŸãƒ¥"},{h:"ã¿ã‚‡",k:"ãƒŸãƒ§"}]},{label:"ã‚Šã‚ƒè¡Œ",chars:[{h:"ã‚Šã‚ƒ",k:"ãƒªãƒ£"},{h:"ã‚Šã‚…",k:"ãƒªãƒ¥"},{h:"ã‚Šã‚‡",k:"ãƒªãƒ§"}]},{label:"ãã‚ƒè¡Œ",chars:[{h:"ãã‚ƒ",k:"ã‚®ãƒ£"},{h:"ãã‚…",k:"ã‚®ãƒ¥"},{h:"ãã‚‡",k:"ã‚®ãƒ§"}]},{label:"ã˜ã‚ƒè¡Œ",chars:[{h:"ã˜ã‚ƒ",k:"ã‚¸ãƒ£"},{h:"ã˜ã‚…",k:"ã‚¸ãƒ¥"},{h:"ã˜ã‚‡",k:"ã‚¸ãƒ§"}]},{label:"ã³ã‚ƒè¡Œ",chars:[{h:"ã³ã‚ƒ",k:"ãƒ“ãƒ£"},{h:"ã³ã‚…",k:"ãƒ“ãƒ¥"},{h:"ã³ã‚‡",k:"ãƒ“ãƒ§"}]},{label:"ã´ã‚ƒè¡Œ",chars:[{h:"ã´ã‚ƒ",k:"ãƒ”ãƒ£"},{h:"ã´ã‚…",k:"ãƒ”ãƒ¥"},{h:"ã´ã‚‡",k:"ãƒ”ãƒ§"}]}],M=[{char:"ã£",label:"ä¿ƒéŸ³"},{char:"ãƒƒ",label:"ä¿ƒéŸ³"},{char:"ãƒ¼",label:"é•¿éŸ³"},{char:"ã€œ",label:"æ³¢æµª"},{char:"ã€‚",label:"å¥å·"},{char:"ã€",label:"é¡¿å·"},{char:"ã€Œ",label:"å¼•å·"},{char:"ã€",label:"å¼•å·"},{char:"ã€",label:"åŒå¼•"},{char:"ã€",label:"åŒå¼•"},{char:"â€¦",label:"çœç•¥"},{char:"ãƒ»",label:"ä¸­ç‚¹"},{char:"ï¼",label:"æ„Ÿå¹"},{char:"ï¼Ÿ",label:"é—®å·"},{char:"â™ª",label:"éŸ³ç¬¦"},{char:"â™¡",label:"å¿ƒå½¢"},{char:"â˜…",label:"æ˜Ÿå½¢"},{char:"â˜†",label:"ç©ºæ˜Ÿ"},{char:"ã",label:"å°ã‚"},{char:"ãƒ",label:"å°ã„"},{char:"ã…",label:"å°ã†"},{char:"ã‡",label:"å°ãˆ"},{char:"ã‰",label:"å°ãŠ"},{char:"ã‚¡",label:"å°ã‚¢"},{char:"ã‚£",label:"å°ã‚¤"},{char:"ã‚¥",label:"å°ã‚¦"},{char:"ã‚§",label:"å°ã‚¨"},{char:"ã‚©",label:"å°ã‚ª"},{char:"ã‚ƒ",label:"å°ã‚„"},{char:"ã‚…",label:"å°ã‚†"},{char:"ã‚‡",label:"å°ã‚ˆ"},{char:"ãƒ£",label:"å°ãƒ¤"},{char:"ãƒ¥",label:"å°ãƒ¦"},{char:"ãƒ§",label:"å°ãƒ¨"}];function E(){o("close")}function P(U){const f=u.value==="hiragana"?U.h:U.k;c.value=U.h,setTimeout(()=>{c.value=null},100),o("insert",f,a.value)}function q(U){c.value=U,setTimeout(()=>{c.value=null},100),o("insert",U,a.value)}function V(){o("delete",a.value)}return(U,f)=>n.visible?(B(),F("div",Fm,[e("div",Um,[f[3]||(f[3]=e("span",{class:"kana-keyboard-title"},"50éŸ³é”®ç›˜",-1)),e("div",Om,[(B(),F(ze,null,Ye(p,m=>e("button",{key:m.id,class:Ie(["kana-tab",{active:l.value===m.id}]),onClick:C=>l.value=m.id},ne(m.label),11,zm)),64))]),e("button",{class:"kana-keyboard-close",onClick:E},"âœ•")]),e("div",Nm,[e("div",Vm,[e("label",null,[le(e("input",{type:"radio",name:"kanaMode",value:"hiragana","onUpdate:modelValue":f[0]||(f[0]=m=>u.value=m)},null,512),[[ln,u.value]]),f[4]||(f[4]=me(" å¹³å‡å ",-1))]),e("label",null,[le(e("input",{type:"radio",name:"kanaMode",value:"katakana","onUpdate:modelValue":f[1]||(f[1]=m=>u.value=m)},null,512),[[ln,u.value]]),f[5]||(f[5]=me(" ç‰‡å‡å ",-1))])]),e("div",Wm,[f[6]||(f[6]=e("label",null,"è¾“å…¥åˆ°ï¼š",-1)),Ce(Ve,{modelValue:a.value,"onUpdate:modelValue":f[2]||(f[2]=m=>a.value=m),options:v},null,8,["modelValue"])])]),e("div",{class:Ie(["kana-tab-content",{active:l.value==="basic"}])},[e("table",Km,[f[7]||(f[7]=e("thead",null,[e("tr",null,[e("th"),e("th",null,"ã‚æ®µ"),e("th",null,"ã„æ®µ"),e("th",null,"ã†æ®µ"),e("th",null,"ãˆæ®µ"),e("th",null,"ãŠæ®µ")])],-1)),e("tbody",null,[(B(),F(ze,null,Ye(_,m=>e("tr",{key:m.label},[e("td",qm,ne(m.label),1),(B(!0),F(ze,null,Ye(m.chars,(C,k)=>(B(),F("td",{key:k},[C?(B(),F("button",{key:0,class:Ie(["kana-key",{pressed:c.value===C.h}]),onClick:K=>P(C)},[e("span",jm,ne(C.h),1),e("span",Jm,ne(C.k),1)],10,Hm)):de("",!0)]))),128))])),64))])])],2),e("div",{class:Ie(["kana-tab-content",{active:l.value==="dakuten"}])},[e("table",Ym,[f[8]||(f[8]=e("thead",null,[e("tr",null,[e("th"),e("th",null,"ã‚æ®µ"),e("th",null,"ã„æ®µ"),e("th",null,"ã†æ®µ"),e("th",null,"ãˆæ®µ"),e("th",null,"ãŠæ®µ")])],-1)),e("tbody",null,[(B(),F(ze,null,Ye(S,m=>e("tr",{key:m.label},[e("td",Xm,ne(m.label),1),(B(!0),F(ze,null,Ye(m.chars,(C,k)=>(B(),F("td",{key:k},[C?(B(),F("button",{key:0,class:Ie(["kana-key",{pressed:c.value===C.h}]),onClick:K=>P(C)},[e("span",Zm,ne(C.h),1),e("span",Qm,ne(C.k),1)],10,Gm)):de("",!0)]))),128))])),64))])])],2),e("div",{class:Ie(["kana-tab-content",{active:l.value==="combo"}])},[e("table",ev,[f[9]||(f[9]=e("thead",null,[e("tr",null,[e("th"),e("th",null,"ã‚ƒ"),e("th",null,"ã‚…"),e("th",null,"ã‚‡")])],-1)),e("tbody",null,[(B(),F(ze,null,Ye(D,m=>e("tr",{key:m.label},[e("td",tv,ne(m.label),1),(B(!0),F(ze,null,Ye(m.chars,(C,k)=>(B(),F("td",{key:k},[C?(B(),F("button",{key:0,class:Ie(["kana-key",{pressed:c.value===C.h}]),onClick:K=>P(C)},[e("span",nv,ne(C.h),1),e("span",sv,ne(C.k),1)],10,ov)):de("",!0)]))),128))])),64))])])],2),e("div",{class:Ie(["kana-tab-content",{active:l.value==="special"}])},[e("div",av,[(B(),F(ze,null,Ye(M,m=>e("button",{key:m.char,class:Ie(["kana-key special-key",{pressed:c.value===m.char}]),onClick:C=>q(m.char)},[me(ne(m.char)+" ",1),m.label?(B(),F("span",iv,ne(m.label),1)):de("",!0)],10,lv)),64))])],2),e("div",{class:"kana-keyboard-footer"},[e("button",{class:"kana-backspace",onClick:V},"âŒ« é€€æ ¼")])])):de("",!0)}}),uv=He(rv,[["__scopeId","data-v-ebfc2125"]]),cv={class:"edit-panel-content"},dv={class:"text-column original-text-column text-block"},gv={class:"text-column translated-text-column text-block"},pv={class:"style-settings-section text-block"},mv={class:"office-toolbar"},vv={class:"toolbar-row toolbar-row-top"},fv={class:"combo-control font-control"},bv={class:"combo-control size-control"},hv={class:"size-input-wrap"},xv=["min","max","step"],yv={class:"toolbar-row toolbar-row-actions"},_v={class:"toolbar-icon-group","aria-label":"æ’ç‰ˆæ–¹å‘"},Cv=["data-active"],Sv=["data-active"],kv={class:"toolbar-color-group"},wv={class:"toolbar-color-picker",title:"æ–‡å­—é¢œè‰²"},$v={class:"toolbar-inpaint-group",title:"èƒŒæ™¯ä¿®å¤æ–¹å¼"},Tv={class:"toolbar-stroke-cluster"},Iv=["data-active"],Pv={class:"toolbar-row toolbar-row-bottom"},Rv={class:"toolbar-rotation-group",title:"æ—‹è½¬è§’åº¦"},Dv={class:"toolbar-position-group",title:"ä½ç½®è°ƒæ•´"},Mv={class:"toolbar-position-value"},Ev={class:"fontsize-presets-panel"},Bv={class:"font-size-presets"},Av=["onClick"],qt=2,Lv=je({__name:"BubbleEditor",props:{bubble:{},bubbleIndex:{}},emits:["update","reRender","ocrRecognize","reTranslate","applyBubble","resetCurrent"],setup(n,{emit:t}){const s=n,o=t,l=gt(),u={originalText:"",translatedText:"",fontSize:24,fontFamily:yt,textDirection:"vertical",textColor:"#231816",fillColor:"#FFFFFF",strokeEnabled:!0,strokeColor:"#FFFFFF",strokeWidth:3,rotationAngle:0,inpaintMethod:"solid",position:{x:0,y:0}},a=w(""),c=w(""),v=w(24),p=w(yt),_=w("vertical"),S=w("#231816"),D=w("#FFFFFF"),M=w(!0),E=w("#FFFFFF"),P=w(3),q=w(0),V=w("solid"),U=w(0),f=w(0),m=w(null),C=w(null),k=w(null),K=w(null),N=w(null),se=w(!1),G=w("original"),J=w([{name:"æ€æºé»‘ä½“",path:yt},{name:"åæ–‡æ¥·ä½“",path:"fonts/STKAITI.TTF"},{name:"åæ–‡ç»†é»‘",path:"fonts/STXIHEI.TTF"},{name:"é»‘ä½“",path:"fonts/SIMHEI.TTF"},{name:"å®‹ä½“",path:"fonts/SIMSUN.TTC"}]),ee=w([]),j=Z(()=>s.bubble?s.bubble.coords[0]+U.value:0),ae=Z(()=>s.bubble?s.bubble.coords[1]+f.value:0),A=Z(()=>{const Ae=[{label:"ç³»ç»Ÿå­—ä½“",options:J.value.map(z=>({label:z.name,value:z.path}))}];return ee.value.length>0&&Ae.push({label:"è‡ªå®šä¹‰å­—ä½“",options:ee.value.map(z=>({label:z.name,value:z.path}))}),Ae}),d=[{label:"çº¯è‰²å¡«å……",value:"solid"},{label:"LAMAä¿®å¤(æ¼«ç”»)",value:"lama_mpe"},{label:"LAMAä¿®å¤(é€šç”¨)",value:"litelama"}];function $(Ae){const z=Ae||u;a.value=z.originalText,c.value=z.translatedText,v.value=z.fontSize,p.value=z.fontFamily,_.value=z.textDirection,S.value=z.textColor,D.value=z.fillColor,M.value=z.strokeEnabled,E.value=z.strokeColor,P.value=z.strokeWidth,q.value=z.rotationAngle,V.value=z.inpaintMethod,U.value=z.position?.x||0,f.value=z.position?.y||0}Se(()=>s.bubble,Ae=>{$(Ae)},{deep:!0,immediate:!0});function r(){o("update",{originalText:a.value})}function h(){o("update",{translatedText:c.value})}function I(){navigator.clipboard.writeText(a.value)}function T(){navigator.clipboard.writeText(c.value)}function g(){o("update",{fontSize:v.value})}function b(Ae){v.value=Ae,o("update",{fontSize:Ae})}function L(){v.value=Math.min(on,v.value+uo),o("update",{fontSize:v.value})}function W(){v.value=Math.max(nn,v.value-uo),o("update",{fontSize:v.value})}function i(){o("update",{fontFamily:p.value})}function x(Ae){_.value=Ae,o("update",{textDirection:Ae})}function ie(){k.value?.click()}function R(){o("update",{textColor:S.value})}function Y(){K.value?.click()}function ce(){o("update",{fillColor:D.value})}function xe(){N.value?.click()}function De(){o("update",{strokeColor:E.value})}function $e(){M.value=!M.value,o("update",{strokeEnabled:M.value})}function he(){o("update",{strokeWidth:P.value})}function te(){o("update",{inpaintMethod:V.value})}function y(){o("update",{rotationAngle:q.value})}function X(){q.value=Math.max(-180,q.value-5),o("update",{rotationAngle:q.value})}function ve(){q.value=Math.min(180,q.value+5),o("update",{rotationAngle:q.value})}function fe(){q.value=0,o("update",{rotationAngle:0})}function O(){U.value-=qt,o("update",{position:{x:U.value,y:f.value}})}function oe(){U.value+=qt,o("update",{position:{x:U.value,y:f.value}})}function be(){f.value-=qt,o("update",{position:{x:U.value,y:f.value}})}function ge(){f.value+=qt,o("update",{position:{x:U.value,y:f.value}})}function Pe(){U.value=0,f.value=0,o("update",{position:{x:0,y:0}})}function Ee(){o("applyBubble",s.bubbleIndex)}function Le(){l.updateAllBubbles({fontSize:v.value,fontFamily:p.value,textDirection:_.value,textColor:S.value,fillColor:D.value,strokeEnabled:M.value,strokeColor:E.value,strokeWidth:P.value,inpaintMethod:V.value}),console.log("æ ·å¼å·²åº”ç”¨åˆ°æ‰€æœ‰æ°”æ³¡"),o("reRender")}function ke(){o("resetCurrent",s.bubbleIndex)}function Be(){o("ocrRecognize",s.bubbleIndex)}function ye(){o("reTranslate",s.bubbleIndex)}function it(){se.value=!se.value}function Ge(Ae,z){if(z==="original"){const re=m.value;if(re){const Te=re.selectionStart||a.value.length,Re=re.selectionEnd||a.value.length,tt=a.value;a.value=tt.slice(0,Te)+Ae+tt.slice(Re),pt(()=>{re.selectionStart=re.selectionEnd=Te+Ae.length,re.focus()}),o("update",{originalText:a.value})}}else{const re=C.value;if(re){const Te=re.selectionStart||c.value.length,Re=re.selectionEnd||c.value.length,tt=c.value;c.value=tt.slice(0,Te)+Ae+tt.slice(Re),pt(()=>{re.selectionStart=re.selectionEnd=Te+Ae.length,re.focus()}),o("update",{translatedText:c.value})}}}function Ze(Ae){if(Ae==="original"){const z=m.value;if(z&&a.value.length>0){const re=z.selectionStart||a.value.length,Te=z.selectionEnd||a.value.length,Re=a.value;re===Te&&re>0?(a.value=Re.slice(0,re-1)+Re.slice(Te),pt(()=>{z.selectionStart=z.selectionEnd=re-1,z.focus()})):re!==Te&&(a.value=Re.slice(0,re)+Re.slice(Te),pt(()=>{z.selectionStart=z.selectionEnd=re,z.focus()})),o("update",{originalText:a.value})}}else{const z=C.value;if(z&&c.value.length>0){const re=z.selectionStart||c.value.length,Te=z.selectionEnd||c.value.length,Re=c.value;re===Te&&re>0?(c.value=Re.slice(0,re-1)+Re.slice(Te),pt(()=>{z.selectionStart=z.selectionEnd=re-1,z.focus()})):re!==Te&&(c.value=Re.slice(0,re)+Re.slice(Te),pt(()=>{z.selectionStart=z.selectionEnd=re,z.focus()})),o("update",{translatedText:c.value})}}}async function st(){try{const Ae=await Ls();if(Ae.fonts){const z=[],re=[];for(const Te of Ae.fonts){const Re={name:typeof Te=="string"?Te:Te.display_name||Te.file_name||"",path:typeof Te=="string"?Te:Te.path};Re.path.startsWith("fonts/")?z.push(Re):re.push(Re)}z.length>0&&(J.value=z),ee.value=re}}catch(Ae){console.error("åŠ è½½å­—ä½“åˆ—è¡¨å¤±è´¥:",Ae)}}return dt(()=>{st()}),(Ae,z)=>(B(),F("div",cv,[e("div",dv,[e("div",{class:"text-column-header"},[z[13]||(z[13]=e("span",{class:"column-title"},"ğŸ‡¯ğŸ‡µ æ—¥è¯­åŸæ–‡ (OCRç»“æœ)",-1)),e("button",{class:"re-ocr-btn",onClick:Be,title:"é‡æ–°OCRæ­¤æ°”æ³¡"},"ğŸ”„")]),le(e("textarea",{ref_key:"originalTextInput",ref:m,"onUpdate:modelValue":z[0]||(z[0]=re=>a.value=re),class:"text-editor original-editor",placeholder:"OCRè¯†åˆ«çš„æ—¥è¯­åŸæ–‡...",spellcheck:"false",onInput:r},null,544),[[we,a.value]]),e("div",{class:"text-actions"},[e("button",{class:"copy-btn",onClick:I},"ğŸ“‹ å¤åˆ¶"),e("button",{class:"keyboard-toggle-btn",onClick:it,title:"æ˜¾ç¤º/éšè—50éŸ³é”®ç›˜"}," âŒ¨ï¸ 50éŸ³ ")]),Ce(uv,{visible:se.value,"default-target":G.value,onClose:z[1]||(z[1]=re=>se.value=!1),onInsert:Ge,onDelete:Ze},null,8,["visible","default-target"])]),e("div",gv,[e("div",{class:"text-column-header"},[z[14]||(z[14]=e("span",{class:"column-title"},"ğŸ‡¨ğŸ‡³ ä¸­æ–‡è¯‘æ–‡",-1)),e("button",{class:"re-translate-btn",onClick:ye,title:"é‡æ–°ç¿»è¯‘æ­¤æ°”æ³¡"}," ğŸ”„ ")]),le(e("textarea",{ref_key:"translatedTextInput",ref:C,"onUpdate:modelValue":z[2]||(z[2]=re=>c.value=re),class:"text-editor translated-editor",placeholder:"ç¿»è¯‘åçš„ä¸­æ–‡...",spellcheck:"false",onInput:h},null,544),[[we,c.value]]),e("div",{class:"text-actions"},[e("button",{class:"copy-btn",onClick:T},"ğŸ“‹ å¤åˆ¶"),e("button",{class:"apply-text-btn",onClick:Ee},"âœ“ åº”ç”¨æ–‡æœ¬")])]),e("div",pv,[e("div",mv,[e("div",vv,[e("div",fv,[z[15]||(z[15]=e("label",null,"å­—ä½“",-1)),Ce(Ve,{modelValue:p.value,"onUpdate:modelValue":z[3]||(z[3]=re=>p.value=re),groups:A.value,title:"å­—ä½“",onChange:i},null,8,["modelValue","groups"])]),e("div",bv,[z[16]||(z[16]=e("label",null,"å­—å·",-1)),e("div",hv,[le(e("input",{type:"number","onUpdate:modelValue":z[4]||(z[4]=re=>v.value=re),class:"toolbar-fontsize-input",min:H(nn),max:H(on),step:H(uo),title:"å­—å·",onChange:g},null,40,xv),[[we,v.value,void 0,{number:!0}]]),e("div",{class:"toolbar-fontsize-btns"},[e("button",{class:"toolbar-fontsize-btn",onClick:L,title:"å¢å¤§å­—å·"}," A+ "),e("button",{class:"toolbar-fontsize-btn",onClick:W,title:"å‡å°å­—å·"}," A- ")])])])]),e("div",yv,[e("div",_v,[e("button",{class:"toolbar-btn","data-active":_.value==="vertical",onClick:z[5]||(z[5]=re=>x("vertical")),title:"ç«–å‘æ’ç‰ˆ"},[...z[17]||(z[17]=[e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("path",{d:"M8 2v12M8 2L5 5M8 2l3 3",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])],8,Cv),e("button",{class:"toolbar-btn","data-active":_.value==="horizontal",onClick:z[6]||(z[6]=re=>x("horizontal")),title:"æ¨ªå‘æ’ç‰ˆ"},[...z[18]||(z[18]=[e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("path",{d:"M2 8h12M14 8l-3-3M14 8l-3 3",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])],8,Sv)]),z[24]||(z[24]=e("div",{class:"toolbar-divider vertical"},null,-1)),e("div",kv,[e("div",wv,[e("button",{class:"toolbar-btn toolbar-color-btn",onClick:ie},[z[19]||(z[19]=e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("text",{x:"3",y:"11","font-size":"10","font-weight":"bold",fill:"currentColor"},"A")],-1)),e("span",{class:"color-indicator",style:at({background:S.value})},null,4)]),le(e("input",{ref_key:"textColorInput",ref:k,type:"color","onUpdate:modelValue":z[7]||(z[7]=re=>S.value=re),class:"hidden-color-input",onInput:R,onChange:R},null,544),[[we,S.value]])])]),z[25]||(z[25]=e("div",{class:"toolbar-divider vertical"},null,-1)),e("div",$v,[Ce(Ve,{modelValue:V.value,"onUpdate:modelValue":z[8]||(z[8]=re=>V.value=re),options:d,onChange:te},null,8,["modelValue"]),e("div",{class:Ie(["toolbar-color-picker toolbar-solid-color-options",{hidden:V.value!=="solid"}])},[e("button",{class:"toolbar-btn toolbar-color-btn",onClick:Y},[z[20]||(z[20]=e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("rect",{x:"2",y:"2",width:"12",height:"12",rx:"2",fill:"none",stroke:"currentColor","stroke-width":"1.2"}),e("rect",{x:"4",y:"4",width:"8",height:"8",rx:"1",fill:"currentColor",opacity:"0.3"})],-1)),e("span",{class:"color-indicator",style:at({background:D.value})},null,4)]),le(e("input",{ref_key:"fillColorInput",ref:K,type:"color","onUpdate:modelValue":z[9]||(z[9]=re=>D.value=re),class:"hidden-color-input",onChange:ce},null,544),[[we,D.value]])],2)]),z[26]||(z[26]=e("div",{class:"toolbar-divider vertical"},null,-1)),e("div",Tv,[e("button",{class:"toolbar-btn","data-active":M.value,onClick:$e,title:"æ–‡å­—æè¾¹"},[...z[21]||(z[21]=[e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("text",{x:"3",y:"12","font-size":"11","font-weight":"bold",stroke:"currentColor","stroke-width":"2",fill:"none"}," A "),e("text",{x:"3",y:"12","font-size":"11","font-weight":"bold",fill:"currentColor"},"A")],-1)])],8,Iv),e("div",{class:Ie(["toolbar-color-picker toolbar-stroke-options",{hidden:!M.value}]),title:"æè¾¹é¢œè‰²"},[e("button",{class:"toolbar-btn toolbar-color-btn",onClick:xe},[z[22]||(z[22]=e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("circle",{cx:"8",cy:"8",r:"5",fill:"none",stroke:"currentColor","stroke-width":"2"})],-1)),e("span",{class:"color-indicator",style:at({background:E.value})},null,4)]),le(e("input",{ref_key:"strokeColorInput",ref:N,type:"color","onUpdate:modelValue":z[10]||(z[10]=re=>E.value=re),class:"hidden-color-input",onChange:De},null,544),[[we,E.value]])],2),e("div",{class:Ie(["toolbar-stroke-width toolbar-stroke-options",{hidden:!M.value}]),title:"æè¾¹å®½åº¦"},[le(e("input",{type:"number","onUpdate:modelValue":z[11]||(z[11]=re=>P.value=re),class:"toolbar-mini-input",min:"0",max:"10",onChange:he},null,544),[[we,P.value,void 0,{number:!0}]]),z[23]||(z[23]=e("span",{class:"toolbar-unit"},"px",-1))],2)])]),e("div",Pv,[e("div",Rv,[e("button",{class:"toolbar-btn",onClick:X,title:"é€†æ—¶é’ˆæ—‹è½¬"},[...z[27]||(z[27]=[e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("path",{d:"M2 8a6 6 0 1 1 1.5 4",stroke:"currentColor","stroke-width":"1.5",fill:"none"}),e("path",{d:"M2 5v3.5h3.5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),le(e("input",{type:"number","onUpdate:modelValue":z[12]||(z[12]=re=>q.value=re),class:"toolbar-mini-input toolbar-rotation-input",min:"-180",max:"180",step:"5",onChange:y},null,544),[[we,q.value,void 0,{number:!0}]]),z[29]||(z[29]=e("span",{class:"toolbar-unit"},"Â°",-1)),e("button",{class:"toolbar-btn",onClick:ve,title:"é¡ºæ—¶é’ˆæ—‹è½¬"},[...z[28]||(z[28]=[e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("path",{d:"M14 8a6 6 0 1 0-1.5 4",stroke:"currentColor","stroke-width":"1.5",fill:"none"}),e("path",{d:"M14 5v3.5h-3.5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),e("button",{class:"toolbar-btn toolbar-small-btn",onClick:fe,title:"é‡ç½®æ—‹è½¬"}," 0 ")]),z[35]||(z[35]=e("div",{class:"toolbar-divider vertical"},null,-1)),e("div",Dv,[e("button",{class:"toolbar-btn",onClick:O,title:"å·¦ç§»"},[...z[30]||(z[30]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("path",{d:"M10 3L5 8l5 5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),e("button",{class:"toolbar-btn",onClick:oe,title:"å³ç§»"},[...z[31]||(z[31]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("path",{d:"M6 3l5 5-5 5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),e("button",{class:"toolbar-btn",onClick:be,title:"ä¸Šç§»"},[...z[32]||(z[32]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("path",{d:"M3 10l5-5 5 5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),e("button",{class:"toolbar-btn",onClick:ge,title:"ä¸‹ç§»"},[...z[33]||(z[33]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("path",{d:"M3 6l5 5 5-5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),e("span",Mv,[e("span",null,ne(j.value),1),z[34]||(z[34]=me(",",-1)),e("span",null,ne(ae.value),1)]),e("button",{class:"toolbar-btn toolbar-small-btn",onClick:Pe,title:"é‡ç½®ä½ç½®"}," âŒ‚ ")])])]),e("details",Ev,[z[36]||(z[36]=e("summary",null,"å­—å·é¢„è®¾",-1)),e("div",Bv,[(B(!0),F(ze,null,Ye(H(hs),re=>(B(),F("button",{key:re,class:Ie(["preset-btn",{active:v.value===re}]),onClick:Te=>b(re)},ne(re),11,Av))),128))])]),e("div",{class:"edit-action-buttons"},[e("button",{class:"btn-apply",onClick:Ee},"åº”ç”¨"),e("button",{class:"btn-apply-all",onClick:Le},"åº”ç”¨å…¨éƒ¨"),e("button",{class:"btn-reset",onClick:ke},"é‡ç½®")])])]))}}),Fv=He(Lv,[["__scopeId","data-v-edcb1ca9"]]),Uv={class:"edit-toolbar-wrapper"},Ov={class:"edit-toolbar toolbar-row-1"},zv={class:"image-navigator"},Nv=["disabled"],Vv=["disabled"],Wv={class:"bubble-navigator"},Kv=["disabled"],qv={class:"bubble-indicator"},Hv={id:"currentBubbleNum"},jv={id:"totalBubbleNum"},Jv=["disabled"],Yv={class:"view-controls"},Xv={key:0,viewBox:"0 0 20 20",width:"16",height:"16"},Gv={key:1,viewBox:"0 0 20 20",width:"16",height:"16"},Zv={id:"zoomLevel"},Qv={class:"edit-toolbar toolbar-row-2"},ef={class:"annotation-tools"},tf=["disabled"],of=["disabled"],nf={key:0,class:"brush-size-indicator"},sf={key:1,class:"brush-mode-hint"},af={class:"edit-progress-info"},lf={class:"edit-progress-text"},rf={class:"edit-progress-count"},uf={class:"edit-progress-bar"},cf={class:"quick-actions"},df=je({__name:"EditToolbar",props:{currentImageIndex:{},imageCount:{},canGoPrevious:{type:Boolean},canGoNext:{type:Boolean},showThumbnails:{type:Boolean},hasBubbles:{type:Boolean},selectedBubbleIndex:{},bubbleCount:{},layoutMode:{},syncEnabled:{type:Boolean},scale:{},isDrawingMode:{type:Boolean},hasSelection:{type:Boolean},brushMode:{},brushSize:{},mouseX:{},mouseY:{},isProcessing:{type:Boolean},progressText:{},progressCurrent:{},progressTotal:{}},emits:["go-previous-image","go-next-image","toggle-thumbnails","select-previous-bubble","select-next-bubble","toggle-layout","toggle-view-mode","toggle-sync","fit-to-screen","zoom-in","zoom-out","reset-zoom","exit-edit-mode","auto-detect-bubbles","detect-all-images","translate-with-bubbles","toggle-drawing-mode","delete-selected-bubbles","repair-selected-bubble","activate-repair-brush","activate-restore-brush","apply-and-next"],setup(n){const t=n,s=Z(()=>t.progressTotal===0?0:Math.round(t.progressCurrent/t.progressTotal*100)),o=Z(()=>t.progressTotal>0&&t.progressCurrent>=t.progressTotal),l=Z(()=>{const u=t.brushMode==="repair"?{fill:"rgba(76, 175, 80, 0.4)",border:"#4CAF50"}:{fill:"rgba(33, 150, 243, 0.4)",border:"#2196F3"};return{position:"fixed",left:`${t.mouseX}px`,top:`${t.mouseY}px`,width:`${t.brushSize}px`,height:`${t.brushSize}px`,borderRadius:"50%",border:`2px solid ${u.border}`,backgroundColor:u.fill,pointerEvents:"none",zIndex:99999,transform:"translate(-50%, -50%)",display:t.brushMode?"block":"none"}});return(u,a)=>(B(),F("div",Uv,[e("div",Ov,[e("div",zv,[e("button",{class:"nav-btn",disabled:!n.canGoPrevious,onClick:a[0]||(a[0]=c=>u.$emit("go-previous-image")),title:"ä¸Šä¸€å¼ å›¾ç‰‡ (PageUp)"}," â—€â—€ ",8,Nv),e("span",{class:"image-indicator",onClick:a[1]||(a[1]=c=>u.$emit("toggle-thumbnails")),title:"ç‚¹å‡»å±•å¼€ç¼©ç•¥å›¾"},[a[23]||(a[23]=me(" å›¾ ",-1)),e("span",null,ne(n.currentImageIndex+1),1),a[24]||(a[24]=me(" / ",-1)),e("span",null,ne(n.imageCount),1)]),e("button",{class:"nav-btn",disabled:!n.canGoNext,onClick:a[2]||(a[2]=c=>u.$emit("go-next-image")),title:"ä¸‹ä¸€å¼ å›¾ç‰‡ (PageDown)"}," â–¶â–¶ ",8,Vv),e("button",{class:Ie(["thumb-toggle-btn",{active:n.showThumbnails}]),onClick:a[3]||(a[3]=c=>u.$emit("toggle-thumbnails")),title:"æ˜¾ç¤º/éšè—ç¼©ç•¥å›¾"}," â˜· ",2)]),a[30]||(a[30]=e("div",{class:"toolbar-divider"},null,-1)),e("div",Wv,[e("button",{id:"prevBubbleBtn",class:"nav-btn",disabled:!n.hasBubbles||n.selectedBubbleIndex<=0,onClick:a[4]||(a[4]=c=>u.$emit("select-previous-bubble")),title:"ä¸Šä¸€ä¸ªæ°”æ³¡ (â†)"}," â—€ ",8,Kv),e("span",qv,[a[25]||(a[25]=me(" æ°”æ³¡ ",-1)),e("span",Hv,ne(n.selectedBubbleIndex>=0?n.selectedBubbleIndex+1:0),1),a[26]||(a[26]=me(" / ",-1)),e("span",jv,ne(n.bubbleCount),1)]),e("button",{id:"nextBubbleBtn",class:"nav-btn",disabled:!n.hasBubbles||n.selectedBubbleIndex>=n.bubbleCount-1,onClick:a[5]||(a[5]=c=>u.$emit("select-next-bubble")),title:"ä¸‹ä¸€ä¸ªæ°”æ³¡ (â†’)"}," â–¶ ",8,Jv)]),a[31]||(a[31]=e("div",{class:"toolbar-divider"},null,-1)),e("div",Yv,[e("button",{class:"layout-toggle-btn",onClick:a[6]||(a[6]=c=>u.$emit("toggle-layout")),title:"åˆ‡æ¢å¸ƒå±€ï¼šå·¦å³/ä¸Šä¸‹"},[n.layoutMode==="horizontal"?(B(),F("svg",Xv,[...a[27]||(a[27]=[e("rect",{x:"1",y:"2",width:"8",height:"16",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"},null,-1),e("rect",{x:"11",y:"2",width:"8",height:"16",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"},null,-1)])])):(B(),F("svg",Gv,[...a[28]||(a[28]=[e("rect",{x:"2",y:"1",width:"16",height:"8",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"},null,-1),e("rect",{x:"2",y:"11",width:"16",height:"8",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"},null,-1)])]))]),e("button",{class:"view-mode-btn",onClick:a[7]||(a[7]=c=>u.$emit("toggle-view-mode")),title:"åˆ‡æ¢è§†å›¾æ¨¡å¼"},[...a[29]||(a[29]=[e("span",{class:"dual-icon"},"â§‰",-1)])]),e("button",{class:Ie({active:n.syncEnabled}),onClick:a[8]||(a[8]=c=>u.$emit("toggle-sync")),title:"åŒæ­¥ç¼©æ”¾/æ‹–åŠ¨",style:{"font-size":"12px"}}," ğŸ”— ",2),e("button",{onClick:a[9]||(a[9]=c=>u.$emit("fit-to-screen")),title:"é€‚åº”å±å¹• (åŒå‡»)"},"â›¶"),e("button",{onClick:a[10]||(a[10]=c=>u.$emit("zoom-in")),title:"æ”¾å¤§ (+)"},"+"),e("span",Zv,ne(Math.round(n.scale*100))+"%",1),e("button",{onClick:a[11]||(a[11]=c=>u.$emit("zoom-out")),title:"ç¼©å° (-)"},"âˆ’"),e("button",{onClick:a[12]||(a[12]=c=>u.$emit("reset-zoom")),title:"åŸå§‹å¤§å°"},"1:1")]),a[32]||(a[32]=e("div",{class:"toolbar-spacer"},null,-1)),e("button",{class:"secondary-btn",onClick:a[13]||(a[13]=c=>u.$emit("exit-edit-mode"))},"é€€å‡ºç¼–è¾‘")]),e("div",Qv,[e("div",ef,[e("button",{class:"annotation-btn detect-btn",onClick:a[14]||(a[14]=c=>u.$emit("auto-detect-bubbles")),title:"è‡ªåŠ¨æ£€æµ‹å½“å‰å›¾ç‰‡çš„æ–‡æœ¬æ¡†"},[...a[33]||(a[33]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("circle",{cx:"6",cy:"6",r:"4",fill:"none",stroke:"currentColor","stroke-width":"1.5"}),e("path",{d:"M9 9l4 4",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round"})],-1),e("span",null,"æ£€æµ‹",-1)])]),e("button",{class:"annotation-btn detect-btn",onClick:a[15]||(a[15]=c=>u.$emit("detect-all-images")),title:"æ‰¹é‡æ£€æµ‹æ‰€æœ‰å›¾ç‰‡"},[...a[34]||(a[34]=[po('<svg viewBox="0 0 16 16" width="14" height="14" data-v-b7164359><circle cx="5" cy="5" r="2.5" fill="none" stroke="currentColor" stroke-width="1" data-v-b7164359></circle><path d="M7 7l2 2" stroke="currentColor" stroke-width="1" stroke-linecap="round" data-v-b7164359></path><circle cx="10" cy="10" r="2.5" fill="none" stroke="currentColor" stroke-width="1" data-v-b7164359></circle><path d="M12 12l2 2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" data-v-b7164359></path></svg><span data-v-b7164359>æ‰¹é‡æ£€æµ‹</span>',2)])]),e("button",{class:"annotation-btn primary-action-btn",onClick:a[16]||(a[16]=c=>u.$emit("translate-with-bubbles")),title:"ä½¿ç”¨å½“å‰æ–‡æœ¬æ¡†ç¿»è¯‘æ­¤å›¾ç‰‡"},[...a[35]||(a[35]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("path",{d:"M2 3h5M4.5 3v7M2 6h5",stroke:"currentColor","stroke-width":"1.2",fill:"none"}),e("path",{d:"M9 13l2-7 2 7M9.5 11h3",stroke:"currentColor","stroke-width":"1.2",fill:"none"})],-1),e("span",null,"ç¿»è¯‘",-1)])]),a[41]||(a[41]=e("div",{class:"toolbar-divider"},null,-1)),e("button",{class:Ie(["annotation-btn",{active:n.isDrawingMode}]),onClick:a[17]||(a[17]=c=>u.$emit("toggle-drawing-mode")),title:"æ·»åŠ æ°”æ³¡æ¡†ï¼ˆæˆ–ä¸­é”®æ‹–æ‹½ç»˜åˆ¶ï¼‰"},[...a[36]||(a[36]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("rect",{x:"3",y:"3",width:"10",height:"10",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"}),e("path",{d:"M8 5v6M5 8h6",stroke:"currentColor","stroke-width":"1.5"})],-1),e("span",null,"æ·»åŠ ",-1)])],2),e("button",{class:"annotation-btn",disabled:!n.hasSelection,onClick:a[18]||(a[18]=c=>u.$emit("delete-selected-bubbles")),title:"åˆ é™¤é€‰ä¸­æ°”æ³¡æ¡† (Delete)"},[...a[37]||(a[37]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("rect",{x:"3",y:"3",width:"10",height:"10",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"}),e("path",{d:"M5 8h6",stroke:"currentColor","stroke-width":"1.5"})],-1),e("span",null,"åˆ é™¤",-1)])],8,tf),e("button",{class:"annotation-btn",disabled:!n.hasSelection,onClick:a[19]||(a[19]=c=>u.$emit("repair-selected-bubble")),title:"ä¿®å¤é€‰ä¸­æ°”æ³¡èƒŒæ™¯ (R)"},[...a[38]||(a[38]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("path",{d:"M2 14l3-3m0 0l6-6 3 3-6 6m-3 0l-1 1 1-1z",fill:"none",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round"}),e("path",{d:"M11 5l-1-1 2-2 2 2-2 2-1-1z",fill:"currentColor"})],-1),e("span",null,"ä¿®å¤",-1)])],8,of),a[42]||(a[42]=e("div",{class:"toolbar-divider"},null,-1)),e("button",{class:Ie(["annotation-btn brush-btn",{active:n.brushMode==="repair"}]),onClick:a[20]||(a[20]=c=>u.$emit("activate-repair-brush")),title:"ä¿®å¤ç¬”åˆ· (æŒ‰ä½R+å·¦é”®æ‹–æ‹½)"},[...a[39]||(a[39]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("circle",{cx:"8",cy:"8",r:"5",fill:"none",stroke:"currentColor","stroke-width":"1.5"}),e("circle",{cx:"8",cy:"8",r:"2",fill:"currentColor"})],-1),e("span",null,"ä¿®å¤ç¬”åˆ·",-1)])],2),e("button",{class:Ie(["annotation-btn brush-btn",{active:n.brushMode==="restore"}]),onClick:a[21]||(a[21]=c=>u.$emit("activate-restore-brush")),title:"è¿˜åŸç¬”åˆ· (æŒ‰ä½U+å·¦é”®æ‹–æ‹½)"},[...a[40]||(a[40]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("circle",{cx:"8",cy:"8",r:"5",fill:"none",stroke:"currentColor","stroke-width":"1.5"}),e("path",{d:"M5 8h6M8 5v6",stroke:"currentColor","stroke-width":"1",transform:"rotate(45 8 8)"})],-1),e("span",null,"è¿˜åŸç¬”åˆ·",-1)])],2),n.brushMode?(B(),F("span",nf," ç¬”åˆ·: "+ne(n.brushSize)+"px ",1)):de("",!0),a[43]||(a[43]=po('<div class="help-tooltip-container" data-v-b7164359><button class="help-tooltip-btn" title="å¿«æ·é”®æ“ä½œå¸®åŠ©" data-v-b7164359><svg viewBox="0 0 16 16" width="14" height="14" data-v-b7164359><circle cx="8" cy="8" r="6.5" fill="none" stroke="currentColor" stroke-width="1.2" data-v-b7164359></circle><text x="8" y="11" text-anchor="middle" font-size="9" font-weight="bold" fill="currentColor" data-v-b7164359>?</text></svg><span class="help-btn-text" data-v-b7164359>å¿«æ·é”®</span></button><div class="help-tooltip-popup" data-v-b7164359><div class="help-section" data-v-b7164359><div class="help-title" data-v-b7164359>ğŸ–±ï¸ é¼ æ ‡æ“ä½œ</div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>å·¦é”®ç‚¹å‡»æ°”æ³¡</span><span class="help-desc" data-v-b7164359>é€‰æ‹©æ°”æ³¡</span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>Shift+å·¦é”®ç‚¹å‡»</span><span class="help-desc" data-v-b7164359>å¤šé€‰æ°”æ³¡</span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>å·¦é”®æ‹–æ‹½å››è§’/è¾¹</span><span class="help-desc" data-v-b7164359>è°ƒæ•´å¤§å°</span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>å·¦é”®æ‹–æ‹½æ¡†å†…éƒ¨</span><span class="help-desc" data-v-b7164359>ç§»åŠ¨æ°”æ³¡æ¡†</span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>ä¸­é”®æ‹–æ‹½</span><span class="help-desc" data-v-b7164359>ç»˜åˆ¶æ–°æ°”æ³¡æ¡†</span></div></div><div class="help-section" data-v-b7164359><div class="help-title" data-v-b7164359>âŒ¨ï¸ å¿«æ·é”®</div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>A / D</span><span class="help-desc" data-v-b7164359>åˆ‡æ¢ä¸Š/ä¸‹ä¸€å¼ å›¾ç‰‡</span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>Ctrl+Enter</span><span class="help-desc" data-v-b7164359>åº”ç”¨å¹¶è·³è½¬ä¸‹ä¸€å¼ </span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>Delete / Backspace</span><span class="help-desc" data-v-b7164359>åˆ é™¤é€‰ä¸­æ°”æ³¡</span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>æŒ‰ä½R+å·¦é”®æ‹–æ‹½</span><span class="help-desc" data-v-b7164359>ä¿®å¤ç¬”åˆ·</span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>æŒ‰ä½U+å·¦é”®æ‹–æ‹½</span><span class="help-desc" data-v-b7164359>è¿˜åŸç¬”åˆ·</span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>ç¬”åˆ·æ¨¡å¼ä¸‹æ»šè½®</span><span class="help-desc" data-v-b7164359>è°ƒæ•´ç¬”åˆ·å¤§å°</span></div></div></div></div>',1))]),n.brushMode?(B(),F("div",{key:0,class:"brush-cursor",style:at(l.value)},null,4)):de("",!0),n.brushMode?(B(),F("div",sf,ne(n.brushMode==="repair"?"ä¿®å¤ç¬”åˆ· (R)":"è¿˜åŸç¬”åˆ· (U)")+" - æ»šè½®è°ƒæ•´å¤§å° ",1)):de("",!0),n.isProcessing?(B(),F("div",{key:2,class:Ie(["edit-progress-container",{completed:o.value}])},[e("div",af,[e("span",lf,ne(n.progressText),1),e("span",rf,ne(n.progressCurrent)+"/"+ne(n.progressTotal),1)]),e("div",uf,[e("div",{class:Ie(["edit-progress-fill",{animating:!o.value}]),style:at({width:s.value+"%"})},null,6)])],2)):de("",!0),a[44]||(a[44]=e("div",{class:"toolbar-spacer"},null,-1)),e("div",cf,[e("button",{class:"primary-btn",onClick:a[22]||(a[22]=c=>u.$emit("apply-and-next")),title:"åº”ç”¨æ›´æ”¹å¹¶è·³è½¬ä¸‹ä¸€å¼  (Ctrl+Enter)"}," åº”ç”¨å¹¶ä¸‹ä¸€å¼  ")])])]))}}),gf=He(df,[["__scopeId","data-v-b7164359"]]),pf={key:0,class:"edit-thumbnails-panel"},mf={class:"thumbnails-scroll"},vf=["onClick"],ff=["src","alt"],bf={class:"thumb-index"},hf=je({__name:"EditThumbnailPanel",props:{visible:{type:Boolean},images:{},currentImageIndex:{}},emits:["switch-to-image"],setup(n){return(t,s)=>n.visible?(B(),F("div",pf,[e("div",mf,[(B(!0),F(ze,null,Ye(n.images,(o,l)=>(B(),F("div",{key:o.id,class:Ie(["edit-thumbnail-item",{active:l===n.currentImageIndex}]),onClick:u=>t.$emit("switch-to-image",l)},[e("img",{src:o.translatedDataURL||o.originalDataURL,alt:`å›¾ç‰‡ ${l+1}`},null,8,ff),e("span",bf,ne(l+1),1)],10,vf))),128))])])):de("",!0)}}),xf=He(hf,[["__scopeId","data-v-9d2a43d9"]]),yf=["data-brush-mode"],_f={class:"edit-main-layout"},Cf={class:"image-comparison-container"},Sf={class:"panel-header"},kf=["src"],wf={class:"panel-header"},$f=["src"],Tf=je({__name:"EditWorkspace",props:{isEditModeActive:{type:Boolean}},emits:["exit"],setup(n,{emit:t}){const s=n,o=t,l=et(),u=gt(),{translateWithCurrentBubbles:a}=Mo(),{reRenderFullImage:c}=km({onRenderStart:()=>console.log("å¼€å§‹é‡æ–°æ¸²æŸ“..."),onRenderSuccess:Q=>console.log("æ¸²æŸ“æˆåŠŸ:",Q.substring(0,50)+"..."),onRenderError:Q=>console.error("æ¸²æŸ“å¤±è´¥:",Q)}),{isDrawingMode:v,isDrawingBox:p,currentDrawingRect:_,isMiddleButtonDown:S,handleBubbleSelect:D,handleBubbleMultiSelect:M,handleClearMultiSelect:E,handleBubbleDragStart:P,handleBubbleDragging:q,handleBubbleDragEnd:V,handleBubbleResizeStart:U,handleBubbleResizing:f,handleBubbleResizeEnd:m,handleBubbleRotateStart:C,handleBubbleRotating:k,handleBubbleRotateEnd:K,toggleDrawingMode:N,handleDrawBubble:se,getDrawingRectStyle:G,handleBubbleUpdate:J,deleteSelectedBubbles:ee,repairSelectedBubble:j,handleOcrRecognize:ae}=Sm({onReRender:()=>c(),onDelayedPreview:()=>c()}),A=w(0),d=w(0),{brushMode:$,brushSize:r,mouseX:h,mouseY:I,isBrushKeyDown:T,toggleBrushMode:g,exitBrushMode:b,startBrushPainting:L,continueBrushPainting:W,finishBrushPainting:i,adjustBrushSize:x}=_m({onBrushComplete:()=>c(),getCurrentRepairSettings:()=>({inpaintMethod:Ae.value,fillColor:z.value})}),{images:ie,currentImageIndex:R,currentImage:Y,imageCount:ce,canGoPrevious:xe,canGoNext:De}=kt(l),{bubbles:$e,selectedIndex:he,selectedIndices:te,selectedBubble:y,bubbleCount:X,hasBubbles:ve,hasSelection:fe}=kt(u),O=Z(()=>Pe.value?.querySelector("img")?.naturalWidth||2e3),oe=Z(()=>Pe.value?.querySelector("img")?.naturalHeight||2e3),be=w(null),ge=w(null),Pe=w(null),Ee=w(null),Le=w(null),ke=w(null),Be=w("dual"),ye=w("horizontal"),it=w(!1),Ge=w(!0),Ze=w(!1),st=w(!1),Ae=w("solid"),z=w("#FFFFFF"),re=w(!1),Te=w("å¤„ç†ä¸­..."),Re=w(0),tt=w(0),qe=bn(),Qe=bn(),ht=Z(()=>Qe.scale.value),ot=Z(()=>Qe.translateX.value),Un=Z(()=>Qe.translateY.value),On=Z(()=>qe.scale.value),_t=w(null),zn=Z(()=>({transform:`translate(${qe.translateX.value}px, ${qe.translateY.value}px) scale(${qe.scale.value})`})),Nn=Z(()=>({transform:`translate(${Qe.translateX.value}px, ${Qe.translateY.value}px) scale(${Qe.scale.value})`}));function Eo(){Qe.zoomIn(),Ge.value&&qe.setTransform(Qe.getTransform())}function Bo(){Qe.zoomOut(),Ge.value&&qe.setTransform(Qe.getTransform())}function Ao(){Qe.resetZoom(),Ge.value&&qe.setTransform(Qe.getTransform())}const Xt=w(!1),Vn=w(0),Gt=w(!1),Mt=w({x:0,y:0,size:0});function Zt(){$.value&&b(),to()}function Qt(){u.bubbles.length>0&&u.selectBubble(0)}function Lo(){xe.value&&(Zt(),l.goToPrevious())}function eo(){De.value&&(Zt(),l.goToNext())}function Wn(Q){Q!==R.value&&Q>=0&&Q<ce.value&&(Zt(),l.setCurrentImageIndex(Q))}function to(){if(!Y.value)return;const Q=Array.isArray(Y.value.bubbleStates);$e.value.length>0?(l.updateCurrentBubbleStates([...$e.value]),l.setManuallyAnnotated(!0),console.log("å·²ä¿å­˜æ°”æ³¡çŠ¶æ€åˆ°å½“å‰å›¾ç‰‡ï¼Œæ ‡è®°ä¸ºæ‰‹åŠ¨æ ‡æ³¨")):Q&&(l.updateCurrentBubbleStates([]),l.setManuallyAnnotated(!0),console.log("å·²ä¿å­˜ç©ºæ°”æ³¡çŠ¶æ€åˆ°å½“å‰å›¾ç‰‡ï¼ˆç”¨æˆ·ä¸»åŠ¨æ¸…ç©ºï¼Œæ ‡è®°ä¸ºæ‰‹åŠ¨æ ‡æ³¨ï¼‰"))}function Et(){Y.value?.bubbleStates?(u.setBubbles([...Y.value.bubbleStates],!0),console.log(`å·²åŠ è½½ ${Y.value.bubbleStates.length} ä¸ªæ°”æ³¡çŠ¶æ€`)):u.clearBubblesLocal(),Qt()}function Kn(){u.selectPrevious()}function qn(){u.selectNext()}function Hn(){it.value=!it.value}function jn(){ye.value=ye.value==="horizontal"?"vertical":"horizontal";try{localStorage.setItem(sn,ye.value)}catch(Q){console.warn("ä¿å­˜å¸ƒå±€æ¨¡å¼å¤±è´¥:",Q)}setTimeout(()=>{Bt()},300)}function Jn(){const Q=["dual","original","translated"],ue=Q.indexOf(Be.value),pe=Q[(ue+1)%Q.length];pe&&(Be.value=pe)}function Yn(){Ge.value=!Ge.value,console.log("åŒå›¾åŒæ­¥:",Ge.value?"å¼€å¯":"å…³é—­"),Ge.value&&qe.setTransform(Qe.getTransform())}function Bt(){const Q=Ee.value||ge.value,ue=Le.value||Pe.value;if(!Q||!ue)return;const pe=ue.querySelector("img");if(!pe||!pe.naturalWidth)return;const Je=Q.getBoundingClientRect(),Fe=Je.width/pe.naturalWidth,Me=Je.height/pe.naturalHeight,We=Math.min(Fe,Me)*.95,Oe=(Je.width-pe.naturalWidth*We)/2,xt=(Je.height-pe.naturalHeight*We)/2,Ct={scale:We,translateX:Oe,translateY:xt};Qe.setTransform(Ct),qe.setTransform(Ct)}function Fo(Q,ue){if($.value){const Oe=Q.deltaY>0?-5:5;x(Oe);return}const pe=Q.currentTarget.getBoundingClientRect(),Je=Q.clientX-pe.left,Fe=Q.clientY-pe.top,Me=Q.deltaY>0?.9:1.1,We=ue==="original"?qe:Qe;We.zoomAt(Je,Fe,Me),Ge.value&&(ue==="original"?Qe:qe).setTransform(We.getTransform())}function Uo(Q,ue){if($.value){const pe=ue==="original"?ge.value:Ee.value;pe&&L(Q,pe);return}if(Q.button===1){S.value=!0,No(Q,ue),Q.preventDefault();return}if(v.value&&Q.button===0){No(Q,ue),Q.preventDefault();return}if(Q.button===0){if(Q.target.closest(".bubble-highlight-box"))return;Q.shiftKey||E(),_t.value=ue,(ue==="original"?qe:Qe).startDrag(Q.clientX,Q.clientY),document.addEventListener("mousemove",Oo),document.addEventListener("mouseup",zo),Q.preventDefault()}}function Oo(Q){if(!_t.value)return;const ue=_t.value==="original"?qe:Qe;ue.drag(Q.clientX,Q.clientY),Ge.value&&(_t.value==="original"?Qe:qe).setTransform(ue.getTransform())}function zo(){_t.value&&(_t.value==="original"?qe:Qe).endDrag(),_t.value=null,document.removeEventListener("mousemove",Oo),document.removeEventListener("mouseup",zo)}let oo="translated";function No(Q,ue="translated"){oo=ue;const pe=ue==="original"?Pe.value:Le.value,Je=ue==="original"?qe:Qe;if(!pe)return;const Fe=pe.getBoundingClientRect(),Me=(Q.clientX-Fe.left)/Je.scale.value,We=(Q.clientY-Fe.top)/Je.scale.value;A.value=Me,d.value=We,p.value=!0,_.value=[Me,We,Me,We],document.addEventListener("mousemove",no),document.addEventListener("mouseup",so)}function no(Q){if(!p.value)return;const ue=oo==="original"?Pe.value:Le.value,pe=oo==="original"?qe:Qe;if(!ue)return;const Je=ue.getBoundingClientRect(),Fe=(Q.clientX-Je.left)/pe.scale.value,Me=(Q.clientY-Je.top)/pe.scale.value;_.value=[Math.min(A.value,Fe),Math.min(d.value,Me),Math.max(A.value,Fe),Math.max(d.value,Me)]}function so(Q){document.removeEventListener("mousemove",no),document.removeEventListener("mouseup",so);const ue=S.value;if(!p.value||!_.value){p.value=!1,_.value=null,S.value=!1;return}const[pe,Je,Fe,Me]=_.value,We=Fe-pe,Oe=Me-Je;We>10&&Oe>10&&(u.addBubble(_.value),u.selectBubble(u.bubbleCount-1),console.log("å·²æ·»åŠ æ–°æ°”æ³¡:",_.value)),p.value=!1,_.value=null,S.value=!1,!ue&&v.value&&(v.value=!1)}function Vo(Q){console.log(`${Q} å›¾ç‰‡åŠ è½½å®Œæˆ`),ht.value===1&&ot.value===0&&Un.value===0&&pt(()=>{Bt()})}function Xn(){c()}function Gn(Q){Q.inpaintMethod!==void 0&&(Ae.value=Q.inpaintMethod),Q.fillColor!==void 0&&(z.value=Q.fillColor),he.value>=0&&J(Q)}function Zn(Q){_e("æ–‡æœ¬å·²åº”ç”¨","success"),c()}function Qn(Q){const ue=u.initialStates[Q];if(!ue){console.warn(`æ— æ³•é‡ç½®æ°”æ³¡ #${Q+1}ï¼šæ‰¾ä¸åˆ°åˆå§‹çŠ¶æ€`),_e("æ— æ³•é‡ç½®ï¼šæ‰¾ä¸åˆ°åˆå§‹çŠ¶æ€","warning");return}const pe=JSON.parse(JSON.stringify(ue));u.updateBubble(Q,pe),console.log(`æ°”æ³¡ #${Q+1} å·²é‡ç½®åˆ°åˆå§‹çŠ¶æ€`),_e("æ°”æ³¡å·²é‡ç½®","success"),c()}async function es(Q){const ue=$e.value[Q];if(!ue?.originalText){console.warn("æ— æ³•é‡æ–°ç¿»è¯‘ï¼šç¼ºå°‘æ°”æ³¡æˆ–åŸæ–‡");return}try{console.log(`å¼€å§‹é‡æ–°ç¿»è¯‘æ°”æ³¡ #${Q+1}`);const{translateSingleText:pe}=await rt(async()=>{const{translateSingleText:We}=await Promise.resolve().then(()=>Os);return{translateSingleText:We}},void 0),{useSettingsStore:Je}=await rt(async()=>{const{useSettingsStore:We}=await import("./system.B3KD2uF9.js").then(Oe=>Oe.s);return{useSettingsStore:We}},__vite__mapDeps([0,1,2,3,4,5])),Fe=Je().settings,Me=await pe({original_text:ue.originalText,model_provider:Fe.translation.provider,api_key:Fe.translation.apiKey,model_name:Fe.translation.modelName,custom_base_url:Fe.translation.customBaseUrl,target_language:Fe.targetLanguage,prompt_content:Fe.translatePrompt,use_json_format:Fe.translation.isJsonMode,rpm_limit_translation:Fe.translation.rpmLimit,max_retries:Fe.translation.maxRetries});Me.success&&Me.data?.translated_text?(u.updateBubble(Q,{translatedText:Me.data.translated_text}),console.log(`ç¿»è¯‘æˆåŠŸ: "${Me.data.translated_text}"`),c()):console.error("ç¿»è¯‘å¤±è´¥:",Me.error||"æœªçŸ¥é”™è¯¯")}catch(pe){console.error("ç¿»è¯‘å‡ºé”™:",pe)}}function Wo(Q,ue){for(Q.bubbleTexts||(Q.bubbleTexts=[]),Q.originalTexts||(Q.originalTexts=[]);Q.bubbleTexts.length<ue;)Q.bubbleTexts.push("");for(;Q.originalTexts.length<ue;)Q.originalTexts.push("")}function Ko(Q,ue,pe){const Je=Q.auto_directions||[];return Q.bubble_coords.map((Fe,Me)=>{const We=Fe[0]??0,Oe=Fe[1]??0,xt=Fe[2]??0,Ct=Fe[3]??0;let mt;return Je[Me]?mt=Je[Me]==="v"?"vertical":"horizontal":mt=Ct-Oe>xt-We?"vertical":"horizontal",{coords:Fe,originalText:ue.originalTexts?.[Me]||"",translatedText:ue.bubbleTexts?.[Me]||"",textboxText:"",fontSize:pe.fontSize,fontFamily:pe.fontFamily,textDirection:mt,autoTextDirection:mt,textColor:pe.textColor,fillColor:pe.fillColor,strokeEnabled:pe.strokeEnabled,strokeColor:pe.strokeColor,strokeWidth:pe.strokeWidth,rotationAngle:Q.bubble_angles?.[Me]||0,inpaintMethod:pe.inpaintMethod,position:{x:0,y:0},polygon:[]}})}async function ts(){const Q=Y.value;if(!Q?.originalDataURL){_e("æ²¡æœ‰æœ‰æ•ˆçš„å›¾ç‰‡ç”¨äºæ£€æµ‹","warning");return}try{_e("æ­£åœ¨è‡ªåŠ¨æ£€æµ‹æ–‡æœ¬æ¡†...","info");const pe=Q.originalDataURL.match(/^data:image\/[^;]+;base64,(.+)$/)?.[1]||"";if(!pe){_e("æ— æ³•è§£æå›¾ç‰‡æ•°æ®","error");return}const Je=Ne(),{textDetector:Fe,boxExpand:Me,textStyle:We}=Je.settings,Oe=await mo(pe,Fe,{box_expand_ratio:Me.ratio,box_expand_top:Me.top,box_expand_bottom:Me.bottom,box_expand_left:Me.left,box_expand_right:Me.right});if(Oe.success&&Oe.bubble_coords){l.updateCurrentImage({bubbleCoords:Oe.bubble_coords,bubbleAngles:Oe.bubble_angles||[]}),Wo(Q,Oe.bubble_coords.length);const xt={bubble_coords:Oe.bubble_coords.map(mt=>[...mt]),bubble_angles:Oe.bubble_angles,auto_directions:Oe.auto_directions},Ct=Ko(xt,Q,We);u.setBubbles(Ct),Qt(),_e(`è‡ªåŠ¨æ£€æµ‹åˆ° ${Oe.bubble_coords.length} ä¸ªæ–‡æœ¬æ¡†`,"success")}else _e(Oe.error||"æ£€æµ‹å¤±è´¥","error")}catch(ue){console.error("è‡ªåŠ¨æ£€æµ‹å¤±è´¥:",ue),_e("è‡ªåŠ¨æ£€æµ‹å¤±è´¥","error")}}async function os(){if(ie.value.length<=1){_e("è‡³å°‘éœ€è¦ä¸¤å¼ å›¾ç‰‡æ‰èƒ½æ‰§è¡Œæ‰¹é‡æ£€æµ‹","warning");return}if(!confirm("æ­¤æ“ä½œå°†å¯¹æ‰€æœ‰å›¾ç‰‡è¿›è¡Œæ–‡æœ¬æ¡†æ£€æµ‹ï¼Œå¯èƒ½ä¼šè¦†ç›–å·²æœ‰çš„æ£€æµ‹ç»“æœã€‚ç¡®å®šç»§ç»­å—ï¼Ÿ"))return;const Q=Ne(),{textDetector:ue,boxExpand:pe,textStyle:Je}=Q.settings,Fe=R.value,Me=ie.value.length;re.value=!0,Te.value="æ‰¹é‡æ£€æµ‹ä¸­",tt.value=Me,Re.value=0;try{let We=0;for(let Oe=0;Oe<Me;Oe++){const xt=ie.value[Oe];if(!xt?.originalDataURL)continue;Re.value=Oe+1;const mt=xt.originalDataURL.match(/^data:image\/[^;]+;base64,(.+)$/)?.[1]||"";if(!mt)continue;const vt=await mo(mt,ue,{box_expand_ratio:pe.ratio,box_expand_top:pe.top,box_expand_bottom:pe.bottom,box_expand_left:pe.left,box_expand_right:pe.right});if(vt.success&&vt.bubble_coords){const wt=ie.value[Oe];if(wt){wt.bubbleCoords=vt.bubble_coords,wt.bubbleAngles=vt.bubble_angles||[],Wo(wt,vt.bubble_coords.length);const rs={bubble_coords:vt.bubble_coords.map(us=>[...us]),bubble_angles:vt.bubble_angles,auto_directions:vt.auto_directions};wt.bubbleStates=Ko(rs,wt,Je),We+=vt.bubble_coords.length,Oe===R.value&&Et()}}}Te.value="æ£€æµ‹å®Œæˆ",Re.value=Me,Fe!==R.value&&l.setCurrentImageIndex(Fe),Et(),_e(`æ‰¹é‡æ£€æµ‹å®Œæˆï¼å…±å¤„ç† ${Me} å¼ å›¾ç‰‡ï¼Œæ£€æµ‹åˆ° ${We} ä¸ªæ–‡æœ¬æ¡†`,"success"),setTimeout(()=>{re.value=!1},2e3)}catch(We){console.error("æ‰¹é‡æ£€æµ‹å¤±è´¥:",We),_e("æ‰¹é‡æ£€æµ‹å¤±è´¥","error"),re.value=!1}}async function ns(){if(!Y.value?.originalDataURL){_e("æ²¡æœ‰æœ‰æ•ˆçš„å›¾ç‰‡ç”¨äºç¿»è¯‘","warning");return}if($e.value.length===0){_e("æ²¡æœ‰æ–‡æœ¬æ¡†å¯ç”¨äºç¿»è¯‘ï¼Œè¯·å…ˆæ£€æµ‹æˆ–æ·»åŠ æ–‡æœ¬æ¡†","warning");return}_e("æ­£åœ¨ä½¿ç”¨å½“å‰æ–‡æœ¬æ¡†ç¿»è¯‘...","info");try{await a()&&(_e("ç¿»è¯‘æˆåŠŸï¼","success"),Qt())}catch(ue){console.error("ç¿»è¯‘å¤±è´¥:",ue),_e(`ç¿»è¯‘å¤±è´¥: ${ue instanceof Error?ue.message:"æœªçŸ¥é”™è¯¯"}`,"error")}}function ss(){g("repair")}function as(){g("restore")}function qo(Q){W(Q)}function Ho(){i()}function ls(Q){Xt.value=!0,Vn.value=ye.value==="horizontal"?Q.clientX:Q.clientY,document.body.style.cursor=ye.value==="horizontal"?"col-resize":"row-resize",document.body.style.userSelect="none",document.addEventListener("mousemove",ao),document.addEventListener("mouseup",lo),Q.preventDefault()}function ao(Q){if(!Xt.value)return;const ue=ge.value?.parentElement?.parentElement;if(!ue)return;const pe=ue.getBoundingClientRect();if(ye.value==="horizontal"){const Je=Q.clientX-pe.left,Fe=pe.width,Me=Math.max(20,Math.min(80,Je/Fe*100)),We=ue.querySelector(".original-panel"),Oe=ue.querySelector(".translated-panel");We&&Oe&&(We.style.flex=`0 0 ${Me}%`,Oe.style.flex=`0 0 ${100-Me}%`)}else{const Je=Q.clientY-pe.top,Fe=pe.height,Me=Math.max(20,Math.min(80,Je/Fe*100)),We=ue.querySelector(".original-panel"),Oe=ue.querySelector(".translated-panel");We&&Oe&&(We.style.flex=`0 0 ${Me}%`,Oe.style.flex=`0 0 ${100-Me}%`)}}function lo(){Xt.value=!1,document.body.style.cursor="",document.body.style.userSelect="",document.removeEventListener("mousemove",ao),document.removeEventListener("mouseup",lo)}function is(Q){Gt.value=!0;const ue=ke.value;ue&&(Mt.value={x:Q.clientX,y:Q.clientY,size:ye.value==="horizontal"?ue.offsetWidth:ue.offsetHeight},document.body.style.cursor=ye.value==="horizontal"?"ew-resize":"ns-resize",document.body.style.userSelect="none",document.addEventListener("mousemove",io),document.addEventListener("mouseup",ro),Q.preventDefault())}function io(Q){if(!(!Gt.value||!ke.value))if(ye.value==="horizontal"){const ue=Mt.value.x-Q.clientX;let pe=Mt.value.size+ue;pe=Math.max(300,Math.min(window.innerWidth*.6,pe)),ke.value.style.flex=`0 0 ${pe}px`,ke.value.style.minWidth=`${pe}px`}else{const ue=Mt.value.y-Q.clientY;let pe=Mt.value.size+ue;pe=Math.max(200,Math.min(window.innerHeight*.5,pe)),ke.value.style.flex=`0 0 ${pe}px`,ke.value.style.height=`${pe}px`}}function ro(){Gt.value=!1,document.body.style.cursor="",document.body.style.userSelect="",document.removeEventListener("mousemove",io),document.removeEventListener("mouseup",ro)}function jo(Q){const ue=Q.target,pe=Q.key.toLowerCase();if(pe==="r"||pe==="u"||pe==="a"||pe==="d"){if(ue.tagName==="TEXTAREA")return;(ue.tagName==="INPUT"||ue.tagName==="SELECT"||ue.tagName==="BUTTON")&&ue.blur()}else if(ue.tagName==="INPUT"||ue.tagName==="TEXTAREA"||ue.tagName==="SELECT")return;switch(Q.key){case"Escape":Xo();break;case"Delete":case"Backspace":!$.value&&fe.value&&(ee(),Q.preventDefault());break;case"a":case"A":$.value||(Lo(),Q.preventDefault());break;case"d":case"D":$.value||(eo(),Q.preventDefault());break;case"Enter":Q.ctrlKey&&!$.value&&(Yo(),Q.preventDefault());break;case"r":case"R":T.value||(g("repair"),Q.preventDefault());break;case"u":case"U":T.value||(g("restore"),Q.preventDefault());break;case"+":case"=":Eo(),Q.preventDefault();break;case"-":Bo(),Q.preventDefault();break;case"0":Ao(),Q.preventDefault();break}}function Jo(Q){(Q.key==="r"||Q.key==="R"||Q.key==="u"||Q.key==="U")&&(b(),Q.preventDefault())}async function Yo(){to(),await c(),De.value?eo():_e("å·²æ˜¯æœ€åä¸€å¼ å›¾ç‰‡","info")}function Xo(){to(),o("exit")}return dt(()=>{try{const Q=localStorage.getItem(sn);(Q==="horizontal"||Q==="vertical")&&(ye.value=Q)}catch(Q){console.warn("åŠ è½½å¸ƒå±€æ¨¡å¼å¤±è´¥:",Q)}document.addEventListener("keydown",jo),document.addEventListener("keyup",Jo),document.addEventListener("mousemove",qo),document.addEventListener("mouseup",Ho),s.isEditModeActive&&(Et(),pt(()=>{be.value?.focus()}))}),zt(()=>{document.removeEventListener("keydown",jo),document.removeEventListener("keyup",Jo),document.removeEventListener("mousemove",qo),document.removeEventListener("mouseup",Ho),document.removeEventListener("mousemove",no),document.removeEventListener("mouseup",so),document.removeEventListener("mousemove",ao),document.removeEventListener("mouseup",lo),document.removeEventListener("mousemove",io),document.removeEventListener("mouseup",ro)}),Se(()=>s.isEditModeActive,Q=>{Q&&(Et(),pt(()=>{be.value?.focus()}))}),Se(R,()=>{s.isEditModeActive&&Et()}),Se(y,Q=>{Q&&(Ae.value=Q.inpaintMethod||"solid",z.value=Q.fillColor||"#FFFFFF")},{immediate:!0}),(Q,ue)=>n.isEditModeActive?(B(),F("div",{key:0,class:Ie(["edit-workspace",[`layout-${ye.value}`,{"drawing-mode":H(v)},{"brush-mode-active":!!H($)}]]),"data-brush-mode":H($)||void 0,tabindex:"0",ref_key:"workspaceRef",ref:be},[Ce(gf,{"current-image-index":H(R),"image-count":H(ce),"can-go-previous":H(xe),"can-go-next":H(De),"show-thumbnails":it.value,"has-bubbles":H(ve),"selected-bubble-index":H(he),"bubble-count":H(X),"layout-mode":ye.value,"sync-enabled":Ge.value,scale:ht.value,"is-drawing-mode":H(v),"has-selection":H(fe),"brush-mode":H($),"brush-size":H(r),"mouse-x":H(h),"mouse-y":H(I),"is-processing":re.value,"progress-text":Te.value,"progress-current":Re.value,"progress-total":tt.value,onGoPreviousImage:Lo,onGoNextImage:eo,onToggleThumbnails:Hn,onSelectPreviousBubble:Kn,onSelectNextBubble:qn,onToggleLayout:jn,onToggleViewMode:Jn,onToggleSync:Yn,onFitToScreen:Bt,onZoomIn:Eo,onZoomOut:Bo,onResetZoom:Ao,onExitEditMode:Xo,onAutoDetectBubbles:ts,onDetectAllImages:os,onTranslateWithBubbles:ns,onToggleDrawingMode:H(N),onDeleteSelectedBubbles:H(ee),onRepairSelectedBubble:H(j),onActivateRepairBrush:ss,onActivateRestoreBrush:as,onApplyAndNext:Yo},null,8,["current-image-index","image-count","can-go-previous","can-go-next","show-thumbnails","has-bubbles","selected-bubble-index","bubble-count","layout-mode","sync-enabled","scale","is-drawing-mode","has-selection","brush-mode","brush-size","mouse-x","mouse-y","is-processing","progress-text","progress-current","progress-total","onToggleDrawingMode","onDeleteSelectedBubbles","onRepairSelectedBubble"]),Ce(xf,{visible:it.value,images:H(ie),"current-image-index":H(R),onSwitchToImage:Wn},null,8,["visible","images","current-image-index"]),e("div",_f,[e("div",Cf,[le(e("div",{class:Ie(["image-panel original-panel",{collapsed:Be.value==="translated"||Ze.value}])},[e("div",Sf,[ue[8]||(ue[8]=e("span",{class:"panel-title"},"ğŸ“– åŸå›¾ (æ—¥æ–‡)",-1)),e("button",{class:"panel-toggle",onClick:ue[0]||(ue[0]=pe=>Ze.value=!Ze.value),title:"æŠ˜å /å±•å¼€"},ne(Ze.value?"+":"âˆ’"),1)]),e("div",{ref_key:"originalViewportRef",ref:ge,class:"image-viewport",onWheel:ue[2]||(ue[2]=lt(pe=>Fo(pe,"original"),["prevent"])),onMousedown:ue[3]||(ue[3]=pe=>Uo(pe,"original")),onDblclick:Bt},[e("div",{ref_key:"originalWrapperRef",ref:Pe,class:"image-canvas-wrapper",style:at(zn.value)},[H(Y)?.originalDataURL?(B(),F("img",{key:0,src:H(Y).originalDataURL,alt:"åŸå›¾",onLoad:ue[1]||(ue[1]=pe=>Vo("original"))},null,40,kf)):de("",!0),H(Y)?.originalDataURL?(B(),ut(hn,{key:1,bubbles:H($e),"selected-index":H(he),"selected-indices":H(te),scale:On.value,"is-drawing-mode":H(v),"is-brush-mode":!!H($),"image-width":O.value,"image-height":oe.value,onSelect:H(D),onMultiSelect:H(M),onDragStart:H(P),onDragging:H(q),onDragEnd:H(V),onResizeStart:H(U),onResizing:H(f),onResizeEnd:H(m),onRotateStart:H(C),onRotating:H(k),onRotateEnd:H(K),onDrawBubble:H(se)},null,8,["bubbles","selected-index","selected-indices","scale","is-drawing-mode","is-brush-mode","image-width","image-height","onSelect","onMultiSelect","onDragStart","onDragging","onDragEnd","onResizeStart","onResizing","onResizeEnd","onRotateStart","onRotating","onRotateEnd","onDrawBubble"])):de("",!0),H(_)?(B(),F("div",{key:2,class:"drawing-rect-edit",style:at(H(G)())},null,4)):de("",!0)],4)],544)],2),[[Ue,Be.value!=="translated"]]),Be.value==="dual"?(B(),F("div",{key:0,class:Ie(["panel-divider",{"vertical-divider":ye.value==="vertical"}]),onMousedown:ls},null,34)):de("",!0),le(e("div",{class:Ie(["image-panel translated-panel",{collapsed:Be.value==="original"||st.value}])},[e("div",wf,[ue[9]||(ue[9]=e("span",{class:"panel-title"},"ğŸ“ ç¿»è¯‘å›¾ (ä¸­æ–‡)",-1)),e("button",{class:"panel-toggle",onClick:ue[4]||(ue[4]=pe=>st.value=!st.value),title:"æŠ˜å /å±•å¼€"},ne(st.value?"+":"âˆ’"),1)]),e("div",{ref_key:"translatedViewportRef",ref:Ee,class:"image-viewport",onWheel:ue[6]||(ue[6]=lt(pe=>Fo(pe,"translated"),["prevent"])),onMousedown:ue[7]||(ue[7]=pe=>Uo(pe,"translated")),onDblclick:Bt},[e("div",{ref_key:"translatedWrapperRef",ref:Le,class:"image-canvas-wrapper",style:at(Nn.value)},[H(Y)?.translatedDataURL||H(Y)?.originalDataURL?(B(),F("img",{key:0,src:H(Y)?.translatedDataURL||H(Y)?.originalDataURL,alt:"ç¿»è¯‘å›¾",onLoad:ue[5]||(ue[5]=pe=>Vo("translated"))},null,40,$f)):de("",!0),H(Y)?.translatedDataURL||H(Y)?.originalDataURL?(B(),ut(hn,{key:1,bubbles:H($e),"selected-index":H(he),"selected-indices":H(te),scale:ht.value,"is-drawing-mode":H(v),"is-brush-mode":!!H($),"image-width":O.value,"image-height":oe.value,onSelect:H(D),onMultiSelect:H(M),onDragStart:H(P),onDragging:H(q),onDragEnd:H(V),onResizeStart:H(U),onResizing:H(f),onResizeEnd:H(m),onRotateStart:H(C),onRotating:H(k),onRotateEnd:H(K),onDrawBubble:H(se)},null,8,["bubbles","selected-index","selected-indices","scale","is-drawing-mode","is-brush-mode","image-width","image-height","onSelect","onMultiSelect","onDragStart","onDragging","onDragEnd","onResizeStart","onResizing","onResizeEnd","onRotateStart","onRotating","onRotateEnd","onDrawBubble"])):de("",!0),H(_)?(B(),F("div",{key:2,class:"drawing-rect-edit translated-drawing-rect",style:at(H(G)())},null,4)):de("",!0)],4)],544)],2),[[Ue,Be.value!=="original"]])]),e("div",{ref_key:"editPanelRef",ref:ke,class:"edit-panel-container"},[e("div",{class:"panel-resize-handle vertical",onMousedown:is}," â‹®â‹®â‹® ",32),Ce(Fv,{bubble:H(y),"bubble-index":H(he),onUpdate:Gn,onReRender:Xn,onOcrRecognize:H(ae),onReTranslate:es,onApplyBubble:Zn,onResetCurrent:Qn},null,8,["bubble","bubble-index","onOcrRecognize"])],512)])],10,yf)):de("",!0)}}),If=He(Tf,[["__scopeId","data-v-518434b1"]]),Dt="/api/web-import";async function Pf(n){return(await fetch(`${Dt}/check-support?url=${encodeURIComponent(n)}`)).json()}async function Rf(){return(await fetch(`${Dt}/gallery-dl-images`)).json()}async function Df(n,t,s,o,l,u="auto",a){const c=await fetch(`${Dt}/extract`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:n,config:t,engine:u})});if(!c.ok){const S=await c.json().catch(()=>({error:"è¯·æ±‚å¤±è´¥"}));l(S.error||`HTTP ${c.status}`);return}const v=c.body?.getReader();if(!v){l("æ— æ³•è¯»å–å“åº”æµ");return}const p=new TextDecoder;let _="";try{for(;;){const{done:S,value:D}=await v.read();if(S)break;_+=p.decode(D,{stream:!0});const M=_.split(`
`);_=M.pop()||"";let E="",P="";for(const q of M)if(q.startsWith("event:"))E=q.slice(6).trim();else if(q.startsWith("data:"))P=q.slice(5).trim();else if(q===""&&E&&P){try{const V=JSON.parse(P);E==="log"?s(V):E==="page"?a&&a(V):E==="result"?o(V):E==="error"&&l(V.error||"æœªçŸ¥é”™è¯¯")}catch(V){console.error("è§£æ SSE æ•°æ®å¤±è´¥:",V)}E="",P=""}}}finally{v.releaseLock()}}async function Mf(n,t,s,o="ai-agent"){const l=await fetch(`${Dt}/download`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({pages:n,sourceUrl:t,config:s,engine:o})});if(!l.ok){const u=await l.json().catch(()=>({error:"è¯·æ±‚å¤±è´¥"}));throw new Error(u.error||`HTTP ${l.status}`)}return l.json()}async function Ef(n){return(await fetch(`${Dt}/test-firecrawl`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({apiKey:n})})).json()}async function Bf(n,t,s,o){return(await fetch(`${Dt}/test-agent`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({provider:n,apiKey:t,customBaseUrl:s,modelName:o})})).json()}const Af={class:"modal-container"},Lf={class:"modal-body"},Ff={class:"url-section"},Uf=["disabled"],Of=["disabled"],zf=["disabled"],Nf={key:0,class:"loading-spinner"},Vf={key:1},Wf={key:0,class:"engine-hint"},Kf={key:0,class:"hint-checking"},qf={key:1,class:"hint-supported"},Hf={key:2,class:"hint-unsupported"},jf={class:"settings-section"},Jf={class:"settings-toggle"},Yf={key:0,class:"settings-content"},Xf={class:"settings-tabs"},Gf={class:"settings-tab-content"},Zf={class:"settings-group"},Qf={class:"form-row"},eb={class:"input-group"},tb=["type","value"],ob=["disabled"],nb={class:"settings-group"},sb={class:"form-row"},ab=["value"],lb=["value"],ib={class:"form-row"},rb={class:"input-group"},ub=["type","value"],cb={key:0,class:"form-row"},db=["value"],gb={class:"form-row"},pb=["value"],mb={class:"form-row inline"},vb={class:"checkbox-label"},fb=["checked"],bb={class:"checkbox-label"},hb=["checked"],xb={class:"form-row"},yb=["disabled"],_b={class:"settings-group"},Cb={class:"form-row"},Sb=["value"],kb={class:"form-row"},wb=["value"],$b={class:"settings-group"},Tb={class:"form-grid"},Ib={class:"form-row"},Pb=["value"],Rb={class:"form-row"},Db=["value"],Mb={class:"form-row"},Eb=["value"],Bb={class:"form-row"},Ab=["value"],Lb={class:"form-row"},Fb={class:"checkbox-label"},Ub=["checked"],Ob={class:"settings-group"},zb={class:"form-row inline"},Nb={class:"checkbox-label"},Vb=["checked"],Wb={class:"checkbox-label"},Kb=["checked"],qb={class:"settings-tab-content"},Hb={class:"settings-group"},jb={class:"form-row"},Jb={class:"checkbox-label"},Yb=["checked"],Xb={class:"form-row"},Gb={class:"checkbox-label"},Zb=["checked"],Qb={class:"form-row"},eh={class:"checkbox-label"},th=["checked"],oh={key:0,class:"form-grid"},nh={class:"form-row"},sh=["value"],ah={class:"form-row"},lh=["value"],ih={class:"form-row"},rh=["value"],uh={class:"form-row"},ch={class:"checkbox-label"},dh=["checked"],gh={key:1,class:"form-row"},ph=["value"],mh={class:"settings-tab-content"},vh={class:"settings-group"},fh={class:"form-row"},bh=["value"],hh={class:"form-row"},xh=["value"],yh={class:"form-row"},_h={class:"checkbox-label"},Ch=["checked"],Sh={key:1,class:"logs-section"},kh={class:"logs-toggle"},wh={key:0,class:"extracting-hint"},$h={key:0,class:"logs-content"},Th={class:"log-time"},Ih={class:"log-message"},Ph={key:2,class:"error-section"},Rh={class:"error-message"},Dh={key:3,class:"result-section"},Mh={class:"result-header"},Eh={class:"result-title"},Bh={class:"result-meta"},Ah={class:"result-count"},Lh={key:0,class:"result-engine"},Fh={class:"select-control"},Uh={class:"select-all"},Oh=["checked"],zh={class:"selected-count"},Nh={class:"image-grid"},Vh=["onClick"],Wh={class:"image-checkbox"},Kh=["checked","onChange"],qh={class:"image-preview"},Hh=["src","alt"],jh={class:"image-label"},Jh={key:4,class:"progress-section"},Yh={class:"progress-label"},Xh={class:"progress-bar"},Gh={class:"modal-footer"},Zh=["disabled"],Qh=["disabled"],ex={key:0,class:"loading-spinner"},tx={key:1},ox=je({__name:"WebImportModal",setup(n){const t=Co(),s=et(),o=w(""),l=w(!0),u=w("auto"),a=w(!1),c=w(!1),v=w(!1),p=w(!1),_=w("basic"),S=w(!1),D=w(!1),M=w(!1),E=w(!1),P=Z(()=>t.modalVisible),q=Z(()=>t.status),V=Z(()=>t.logs),U=Z(()=>t.extractResult),f=Z(()=>t.selectedPages),m=Z(()=>t.selectedCount),C=Z(()=>t.downloadProgress),k=Z(()=>t.downloadProgressPercent),K=Z(()=>t.error),N=Z(()=>t.isProcessing),se=Z(()=>t.settings.ui.showAgentLogs),G=Z(()=>U.value?.engine||null),J=Z(()=>{switch(G.value){case"gallery-dl":return"Gallery-DL";case"ai-agent":return"AI Agent";default:return""}}),ee=Z(()=>U.value?.pages?m.value===U.value.pages.length:!1);function j(W){return G.value==="gallery-dl",W}let ae=null;async function A(W){if(ae&&clearTimeout(ae),!W.trim()){a.value=!1,c.value=!1;return}ae=setTimeout(async()=>{v.value=!0;try{const i=await Pf(W);a.value=i.available,c.value=i.supported}catch{a.value=!1,c.value=!1}finally{v.value=!1}},500)}function d(){N.value&&!confirm("æ­£åœ¨å¤„ç†ä¸­ï¼Œç¡®å®šè¦å…³é—­å—ï¼Ÿ")||(t.closeModal(),t.resetState(),o.value="")}async function $(){const W=o.value.trim();if(!W){alert("è¯·è¾“å…¥ç½‘å€");return}try{new URL(W)}catch{alert("è¯·è¾“å…¥æœ‰æ•ˆçš„ç½‘å€");return}t.resetState(),t.setUrl(W),t.setStatus("extracting");try{await Df(W,t.settings,i=>{t.addLog(i)},i=>{t.setExtractResult(i),i.success?t.setStatus("extracted"):t.setError(i.error||"æå–å¤±è´¥")},i=>{t.setError(i)},u.value,i=>{t.addPageIncremental(i)})}catch(i){t.setError(i instanceof Error?i.message:"æå–å¤±è´¥")}}function r(W){t.togglePageSelection(W)}function h(){t.toggleSelectAll()}async function I(){if(!U.value?.pages||m.value===0){alert("è¯·é€‰æ‹©è¦å¯¼å…¥çš„å›¾ç‰‡");return}const W=U.value.pages.filter(x=>f.value.has(x.pageNumber));t.setStatus("downloading"),t.updateDownloadProgress(0,W.length);const i=G.value||"ai-agent";try{if(i==="gallery-dl"){const ie=await Rf();if(ie.success&&ie.images.length>0){let R=0;const Y=Math.min(ie.images.length,W.length);for(let ce=0;ce<Y;ce++){const xe=ie.images[ce];xe&&xe.filename&&xe.data&&(s.addImage(xe.filename,xe.data),R++,t.updateDownloadProgress(R,Y))}t.setStatus("completed"),alert(`æˆåŠŸå¯¼å…¥ ${R} å¼ å›¾ç‰‡`),d();return}else throw new Error(ie.error||"è·å–å›¾ç‰‡å¤±è´¥")}const x=await Mf(W,U.value.sourceUrl,t.settings,i);if(x.success&&x.images.length>0){t.setDownloadedImages(x.images),t.updateDownloadProgress(x.images.length,W.length);for(const R of x.images)s.addImage(R.filename,R.dataUrl);t.setStatus("completed");const ie=x.failedCount>0?`ï¼Œ${x.failedCount} å¼ å¤±è´¥`:"";alert(`æˆåŠŸå¯¼å…¥ ${x.images.length} å¼ å›¾ç‰‡${ie}`),d()}else t.setError(x.error||"ä¸‹è½½å¤±è´¥")}catch(x){t.setError(x instanceof Error?x.message:"ä¸‹è½½å¤±è´¥")}}Se(P,W=>{W&&setTimeout(()=>{document.querySelector(".url-input")?.focus()},100)}),Se(o,W=>{A(W)});const T=Z(()=>t.settings.agent.provider==="custom_openai");async function g(){if(!t.settings.firecrawl.apiKey){alert("è¯·è¾“å…¥ Firecrawl API Key");return}S.value=!0;try{const W=await Ef(t.settings.firecrawl.apiKey);W.success?alert("âœ… Firecrawl è¿æ¥æˆåŠŸ"):alert(`âŒ è¿æ¥å¤±è´¥: ${W.error}`)}catch(W){alert(`âŒ è¿æ¥å¤±è´¥: ${W instanceof Error?W.message:"æœªçŸ¥é”™è¯¯"}`)}finally{S.value=!1}}async function b(){if(!t.settings.agent.apiKey){alert("è¯·è¾“å…¥ AI Agent API Key");return}D.value=!0;try{const W=await Bf(t.settings.agent.provider,t.settings.agent.apiKey,t.settings.agent.customBaseUrl,t.settings.agent.modelName);W.success?alert("âœ… AI Agent è¿æ¥æˆåŠŸ"):alert(`âŒ è¿æ¥å¤±è´¥: ${W.error}`)}catch(W){alert(`âŒ è¿æ¥å¤±è´¥: ${W instanceof Error?W.message:"æœªçŸ¥é”™è¯¯"}`)}finally{D.value=!1}}function L(){confirm("ç¡®å®šè¦é‡ç½®ä¸ºé»˜è®¤æç¤ºè¯å—ï¼Ÿ")&&t.resetExtractionPrompt()}return(W,i)=>(B(),ut(Sn,{to:"body"},[P.value?(B(),F("div",{key:0,class:"modal-overlay",onClick:lt(d,["self"])},[e("div",Af,[e("div",{class:"modal-header"},[i[37]||(i[37]=e("h2",{class:"modal-title"},[e("span",{class:"title-icon"},"ğŸŒ"),me(" ä»ç½‘é¡µå¯¼å…¥æ¼«ç”» ")],-1)),e("button",{class:"close-btn",onClick:d,title:"å…³é—­"},"Ã—")]),e("div",Lf,[e("div",Ff,[le(e("input",{"onUpdate:modelValue":i[0]||(i[0]=x=>o.value=x),type:"url",class:"url-input",placeholder:"è¾“å…¥æ¼«ç”»ç½‘é¡µ URLï¼Œå¦‚ https://example.com/chapter-1",disabled:N.value,onKeyup:Cn($,["enter"])},null,40,Uf),[[we,o.value]]),le(e("select",{"onUpdate:modelValue":i[1]||(i[1]=x=>u.value=x),class:"engine-select",disabled:N.value},[...i[38]||(i[38]=[e("option",{value:"auto"},"è‡ªåŠ¨é€‰æ‹©",-1),e("option",{value:"gallery-dl"},"Gallery-DL",-1),e("option",{value:"ai-agent"},"AI Agent",-1)])],8,Of),[[_s,u.value]]),e("button",{class:"extract-btn",disabled:N.value||!o.value.trim(),onClick:$},[q.value==="extracting"?(B(),F("span",Nf)):(B(),F("span",Vf,"ğŸ”")),me(" "+ne(q.value==="extracting"?"æå–ä¸­...":"å¼€å§‹æå–"),1)],8,zf)]),o.value.trim()&&!N.value?(B(),F("div",Wf,[v.value?(B(),F("span",Kf,"æ£€æŸ¥ä¸­...")):c.value?(B(),F("span",qf,"âœ“ è¯¥ç½‘ç«™æ”¯æŒ Gallery-DL é«˜é€Ÿä¸‹è½½")):a.value?(B(),F("span",Hf,"è¯¥ç½‘ç«™å°†ä½¿ç”¨ AI Agent æ¨¡å¼")):de("",!0)])):de("",!0),i[80]||(i[80]=e("div",{class:"notice"}," âš ï¸ è¯·ä»…çˆ¬å–æ‚¨æœ‰æƒè®¿é—®çš„å†…å®¹ï¼Œå¹¶éµå®ˆç›®æ ‡ç½‘ç«™çš„ä½¿ç”¨æ¡æ¬¾ã€‚ ",-1)),e("div",jf,[e("div",{class:"settings-header",onClick:i[2]||(i[2]=x=>p.value=!p.value)},[e("span",Jf,ne(p.value?"â–¼":"â–¶"),1),i[39]||(i[39]=e("span",{class:"settings-title"},"âš™ï¸ è®¾ç½®",-1)),i[40]||(i[40]=e("span",{class:"settings-hint"},"ç‚¹å‡»å±•å¼€é…ç½®",-1))]),p.value?(B(),F("div",Yf,[e("div",Xf,[e("button",{class:Ie(["settings-tab",{active:_.value==="basic"}]),onClick:i[3]||(i[3]=x=>_.value="basic")}," åŸºæœ¬è®¾ç½® ",2),e("button",{class:Ie(["settings-tab",{active:_.value==="preprocess"}]),onClick:i[4]||(i[4]=x=>_.value="preprocess")}," å›¾ç‰‡é¢„å¤„ç† ",2),e("button",{class:Ie(["settings-tab",{active:_.value==="advanced"}]),onClick:i[5]||(i[5]=x=>_.value="advanced")}," é«˜çº§è®¾ç½® ",2)]),le(e("div",Gf,[e("div",Zf,[i[42]||(i[42]=e("h4",{class:"group-title"},"Firecrawl é…ç½®",-1)),e("div",Qf,[i[41]||(i[41]=e("label",{class:"form-label"},"API Key",-1)),e("div",eb,[e("input",{type:M.value?"text":"password",class:"form-input",value:H(t).settings.firecrawl.apiKey,onInput:i[6]||(i[6]=x=>H(t).setFirecrawlApiKey(x.target.value)),placeholder:"fc-xxxxxxxxxxxxxxxx"},null,40,tb),e("button",{class:"toggle-btn",onClick:i[7]||(i[7]=x=>M.value=!M.value)},ne(M.value?"ğŸ‘":"ğŸ‘â€ğŸ—¨"),1),e("button",{class:"test-btn",disabled:S.value||!H(t).settings.firecrawl.apiKey,onClick:g},ne(S.value?"æµ‹è¯•ä¸­...":"æµ‹è¯•è¿æ¥"),9,ob)])])]),e("div",nb,[i[49]||(i[49]=e("h4",{class:"group-title"},"AI Agent é…ç½®",-1)),e("div",sb,[i[43]||(i[43]=e("label",{class:"form-label"},"æœåŠ¡å•†",-1)),e("select",{class:"form-select",value:H(t).settings.agent.provider,onChange:i[8]||(i[8]=x=>H(t).setAgentProvider(x.target.value))},[(B(!0),F(ze,null,Ye(H(xs),x=>(B(),F("option",{key:x.value,value:x.value},ne(x.label),9,lb))),128))],40,ab)]),e("div",ib,[i[44]||(i[44]=e("label",{class:"form-label"},"API Key",-1)),e("div",rb,[e("input",{type:E.value?"text":"password",class:"form-input",value:H(t).settings.agent.apiKey,onInput:i[9]||(i[9]=x=>H(t).setAgentApiKey(x.target.value)),placeholder:"sk-xxxxxxxxxxxxxxxx"},null,40,ub),e("button",{class:"toggle-btn",onClick:i[10]||(i[10]=x=>E.value=!E.value)},ne(E.value?"ğŸ‘":"ğŸ‘â€ğŸ—¨"),1)])]),T.value?(B(),F("div",cb,[i[45]||(i[45]=e("label",{class:"form-label"},"è‡ªå®šä¹‰ API åœ°å€",-1)),e("input",{type:"url",class:"form-input",value:H(t).settings.agent.customBaseUrl,onInput:i[11]||(i[11]=x=>H(t).setAgentBaseUrl(x.target.value)),placeholder:"https://api.example.com/v1"},null,40,db)])):de("",!0),e("div",gb,[i[46]||(i[46]=e("label",{class:"form-label"},"æ¨¡å‹åç§°",-1)),e("input",{type:"text",class:"form-input",value:H(t).settings.agent.modelName,onInput:i[12]||(i[12]=x=>H(t).setAgentModelName(x.target.value)),placeholder:"gpt-4o-mini"},null,40,pb)]),e("div",mb,[e("label",vb,[e("input",{type:"checkbox",checked:H(t).settings.agent.forceJsonOutput,onChange:i[13]||(i[13]=x=>H(t).setAgentForceJson(x.target.checked))},null,40,fb),i[47]||(i[47]=me(" å¼ºåˆ¶ JSON æ ¼å¼ ",-1))]),e("label",bb,[e("input",{type:"checkbox",checked:H(t).settings.agent.useStream,onChange:i[14]||(i[14]=x=>H(t).setAgentUseStream(x.target.checked))},null,40,hb),i[48]||(i[48]=me(" æµå¼è°ƒç”¨ ",-1))])]),e("div",xb,[e("button",{class:"test-btn full",disabled:D.value||!H(t).settings.agent.apiKey,onClick:b},ne(D.value?"æµ‹è¯•ä¸­...":"æµ‹è¯• Agent è¿æ¥"),9,yb)])]),e("div",_b,[e("h4",{class:"group-title"},[i[50]||(i[50]=me(" æå–è®¾ç½® ",-1)),e("button",{class:"reset-btn",onClick:L},"é‡ç½®ä¸ºé»˜è®¤")]),e("div",Cb,[i[51]||(i[51]=e("label",{class:"form-label"},"æå–æç¤ºè¯",-1)),e("textarea",{class:"form-textarea",value:H(t).settings.extraction.prompt,onInput:i[15]||(i[15]=x=>H(t).setExtractionPrompt(x.target.value)),rows:"6",placeholder:"è¾“å…¥æå–æç¤ºè¯..."},null,40,Sb)]),e("div",kb,[i[52]||(i[52]=e("label",{class:"form-label"},"æœ€å¤§è¿­ä»£æ¬¡æ•°",-1)),e("input",{type:"number",class:"form-input small",value:H(t).settings.extraction.maxIterations,onInput:i[16]||(i[16]=x=>H(t).setExtractionMaxIterations(Number(x.target.value))),min:"1",max:"20"},null,40,wb)])]),e("div",$b,[i[58]||(i[58]=e("h4",{class:"group-title"},"ä¸‹è½½è®¾ç½®",-1)),e("div",Tb,[e("div",Ib,[i[53]||(i[53]=e("label",{class:"form-label"},"å¹¶å‘æ•°",-1)),e("input",{type:"number",class:"form-input small",value:H(t).settings.download.concurrency,onInput:i[17]||(i[17]=x=>H(t).setDownloadConcurrency(Number(x.target.value))),min:"1",max:"10"},null,40,Pb)]),e("div",Rb,[i[54]||(i[54]=e("label",{class:"form-label"},"è¶…æ—¶ (ç§’)",-1)),e("input",{type:"number",class:"form-input small",value:H(t).settings.download.timeout,onInput:i[18]||(i[18]=x=>H(t).setDownloadTimeout(Number(x.target.value))),min:"5",max:"120"},null,40,Db)]),e("div",Mb,[i[55]||(i[55]=e("label",{class:"form-label"},"é‡è¯•æ¬¡æ•°",-1)),e("input",{type:"number",class:"form-input small",value:H(t).settings.download.retries,onInput:i[19]||(i[19]=x=>H(t).setDownloadRetries(Number(x.target.value))),min:"0",max:"5"},null,40,Eb)]),e("div",Bb,[i[56]||(i[56]=e("label",{class:"form-label"},"ä¸‹è½½é—´éš” (ms)",-1)),e("input",{type:"number",class:"form-input small",value:H(t).settings.download.delay,onInput:i[20]||(i[20]=x=>H(t).setDownloadDelay(Number(x.target.value))),min:"0",max:"2000",step:"100"},null,40,Ab)])]),e("div",Lb,[e("label",Fb,[e("input",{type:"checkbox",checked:H(t).settings.download.useReferer,onChange:i[21]||(i[21]=x=>H(t).setDownloadUseReferer(x.target.checked))},null,40,Ub),i[57]||(i[57]=me(" è‡ªåŠ¨æ·»åŠ  Referer ",-1))])])]),e("div",Ob,[i[61]||(i[61]=e("h4",{class:"group-title"},"ç•Œé¢è®¾ç½®",-1)),e("div",zb,[e("label",Nb,[e("input",{type:"checkbox",checked:H(t).settings.ui.showAgentLogs,onChange:i[22]||(i[22]=x=>H(t).setShowAgentLogs(x.target.checked))},null,40,Vb),i[59]||(i[59]=me(" æ˜¾ç¤º AI å·¥ä½œæ—¥å¿— ",-1))]),e("label",Wb,[e("input",{type:"checkbox",checked:H(t).settings.ui.autoImport,onChange:i[23]||(i[23]=x=>H(t).setAutoImport(x.target.checked))},null,40,Kb),i[60]||(i[60]=me(" æå–åè‡ªåŠ¨å¯¼å…¥ ",-1))])])])],512),[[Ue,_.value==="basic"]]),le(e("div",qb,[e("div",Hb,[e("div",jb,[e("label",Jb,[e("input",{type:"checkbox",checked:H(t).settings.imagePreprocess.enabled,onChange:i[24]||(i[24]=x=>H(t).setImagePreprocessEnabled(x.target.checked))},null,40,Yb),i[62]||(i[62]=me(" å¯ç”¨å›¾ç‰‡é¢„å¤„ç† ",-1))])]),H(t).settings.imagePreprocess.enabled?(B(),F(ze,{key:0},[e("div",Xb,[e("label",Gb,[e("input",{type:"checkbox",checked:H(t).settings.imagePreprocess.autoRotate,onChange:i[25]||(i[25]=x=>H(t).setImageAutoRotate(x.target.checked))},null,40,Zb),i[63]||(i[63]=me(" æ ¹æ® EXIF è‡ªåŠ¨æ—‹è½¬ ",-1))])]),i[71]||(i[71]=e("h5",{class:"subsection-title"},"å‹ç¼©è®¾ç½®",-1)),e("div",Qb,[e("label",eh,[e("input",{type:"checkbox",checked:H(t).settings.imagePreprocess.compression.enabled,onChange:i[26]||(i[26]=x=>H(t).setImageCompressionEnabled(x.target.checked))},null,40,th),i[64]||(i[64]=me(" å¯ç”¨å‹ç¼© ",-1))])]),H(t).settings.imagePreprocess.compression.enabled?(B(),F("div",oh,[e("div",nh,[i[65]||(i[65]=e("label",{class:"form-label"},"è´¨é‡ (0-100)",-1)),e("input",{type:"number",class:"form-input small",value:H(t).settings.imagePreprocess.compression.quality,onInput:i[27]||(i[27]=x=>H(t).setImageCompressionQuality(Number(x.target.value))),min:"1",max:"100"},null,40,sh)]),e("div",ah,[i[66]||(i[66]=e("label",{class:"form-label"},"æœ€å¤§å®½åº¦ (0=ä¸é™)",-1)),e("input",{type:"number",class:"form-input small",value:H(t).settings.imagePreprocess.compression.maxWidth,onInput:i[28]||(i[28]=x=>H(t).setImageMaxWidth(Number(x.target.value))),min:"0"},null,40,lh)]),e("div",ih,[i[67]||(i[67]=e("label",{class:"form-label"},"æœ€å¤§é«˜åº¦ (0=ä¸é™)",-1)),e("input",{type:"number",class:"form-input small",value:H(t).settings.imagePreprocess.compression.maxHeight,onInput:i[29]||(i[29]=x=>H(t).setImageMaxHeight(Number(x.target.value))),min:"0"},null,40,rh)])])):de("",!0),i[72]||(i[72]=e("h5",{class:"subsection-title"},"æ ¼å¼è½¬æ¢",-1)),e("div",uh,[e("label",ch,[e("input",{type:"checkbox",checked:H(t).settings.imagePreprocess.formatConvert.enabled,onChange:i[30]||(i[30]=x=>H(t).setImageFormatConvertEnabled(x.target.checked))},null,40,dh),i[68]||(i[68]=me(" å¯ç”¨æ ¼å¼è½¬æ¢ ",-1))])]),H(t).settings.imagePreprocess.formatConvert.enabled?(B(),F("div",gh,[i[70]||(i[70]=e("label",{class:"form-label"},"ç›®æ ‡æ ¼å¼",-1)),e("select",{class:"form-select",value:H(t).settings.imagePreprocess.formatConvert.targetFormat,onChange:i[31]||(i[31]=x=>H(t).setImageTargetFormat(x.target.value))},[...i[69]||(i[69]=[e("option",{value:"original"},"ä¿æŒåŸæ ¼å¼",-1),e("option",{value:"jpeg"},"JPEG",-1),e("option",{value:"png"},"PNG",-1),e("option",{value:"webp"},"WebP",-1)])],40,ph)])):de("",!0)],64)):de("",!0)])],512),[[Ue,_.value==="preprocess"]]),le(e("div",mh,[e("div",vh,[i[76]||(i[76]=e("h4",{class:"group-title"},"è‡ªå®šä¹‰è¯·æ±‚å¤´",-1)),e("div",fh,[i[73]||(i[73]=e("label",{class:"form-label"},"Cookie",-1)),e("input",{type:"text",class:"form-input",value:H(t).settings.advanced.customCookie,onInput:i[32]||(i[32]=x=>H(t).setCustomCookie(x.target.value)),placeholder:"name=value; name2=value2"},null,40,bh)]),e("div",hh,[i[74]||(i[74]=e("label",{class:"form-label"},"Headers (JSON)",-1)),e("textarea",{class:"form-textarea",value:H(t).settings.advanced.customHeaders,onInput:i[33]||(i[33]=x=>H(t).setCustomHeaders(x.target.value)),rows:"3",placeholder:'{"X-Custom-Header": "value"}'},null,40,xh)]),e("div",yh,[e("label",_h,[e("input",{type:"checkbox",checked:H(t).settings.advanced.bypassProxy,onChange:i[34]||(i[34]=x=>H(t).setBypassProxy(x.target.checked))},null,40,Ch),i[75]||(i[75]=me(" ç»•è¿‡ç³»ç»Ÿä»£ç† (è¿æ¥æœ¬åœ°æœåŠ¡æ—¶ä½¿ç”¨) ",-1))])])])],512),[[Ue,_.value==="advanced"]])])):de("",!0)]),se.value&&V.value.length>0?(B(),F("div",Sh,[e("div",{class:"logs-header",onClick:i[35]||(i[35]=x=>l.value=!l.value)},[e("span",kh,ne(l.value?"â–¼":"â–¶"),1),i[77]||(i[77]=e("span",null,"AI å·¥ä½œæ—¥å¿—",-1)),q.value==="extracting"?(B(),F("span",wh,"(æå–ä¸­...)")):de("",!0)]),l.value?(B(),F("div",$h,[(B(!0),F(ze,null,Ye(V.value,(x,ie)=>(B(),F("div",{key:ie,class:Ie(["log-item",`log-${x.type}`])},[e("span",Th,"["+ne(x.timestamp)+"]",1),e("span",Ih,ne(x.message),1)],2))),128))])):de("",!0)])):de("",!0),K.value?(B(),F("div",Ph,[i[78]||(i[78]=e("span",{class:"error-icon"},"âŒ",-1)),e("span",Rh,ne(K.value),1)])):de("",!0),U.value?.success?(B(),F("div",Dh,[e("div",Mh,[e("span",Eh," ğŸ“– ã€Š"+ne(U.value.comicTitle)+"ã€‹- "+ne(U.value.chapterTitle),1),e("span",Bh,[e("span",Ah,"å…± "+ne(U.value.totalPages)+" å¼ ",1),J.value?(B(),F("span",Lh,"| å¼•æ“: "+ne(J.value),1)):de("",!0)])]),e("div",Fh,[e("label",Uh,[e("input",{type:"checkbox",checked:ee.value,onChange:h},null,40,Oh),i[79]||(i[79]=me(" å…¨é€‰ ",-1))]),e("span",zh,"å·²é€‰: "+ne(m.value)+" å¼ ",1)]),e("div",Nh,[(B(!0),F(ze,null,Ye(U.value.pages,x=>(B(),F("div",{key:x.pageNumber,class:Ie(["image-item",{selected:f.value.has(x.pageNumber)}]),onClick:ie=>r(x.pageNumber)},[e("div",Wh,[e("input",{type:"checkbox",checked:f.value.has(x.pageNumber),onClick:i[36]||(i[36]=lt(()=>{},["stop"])),onChange:ie=>r(x.pageNumber)},null,40,Kh)]),e("div",qh,[e("img",{src:j(x.imageUrl),alt:`ç¬¬${x.pageNumber}é¡µ`,loading:"lazy"},null,8,Hh)]),e("div",jh,"ç¬¬ "+ne(x.pageNumber)+" é¡µ",1)],10,Vh))),128))])])):de("",!0),q.value==="downloading"?(B(),F("div",Jh,[e("div",Yh," ä¸‹è½½è¿›åº¦: "+ne(C.value.current)+"/"+ne(C.value.total),1),e("div",Xh,[e("div",{class:"progress-fill",style:at({width:`${k.value}%`})},null,4)])])):de("",!0)]),e("div",Gh,[e("button",{class:"cancel-btn",onClick:d,disabled:q.value==="downloading"}," å–æ¶ˆ ",8,Zh),e("button",{class:"import-btn",disabled:!U.value?.success||m.value===0||N.value,onClick:I},[q.value==="downloading"?(B(),F("span",ex)):(B(),F("span",tx,"ğŸ“¥")),me(" "+ne(q.value==="downloading"?"ä¸‹è½½ä¸­...":"å¯¼å…¥"),1)],8,Qh)])])])):de("",!0)]))}}),nx=He(ox,[["__scopeId","data-v-78fc5cb0"]]),sx={class:"disclaimer-container"},ax={class:"disclaimer-content"},lx={class:"confirmation-area"},ix=["placeholder"],rx={key:0,class:"input-error"},ux={class:"disclaimer-footer"},cx=["disabled"],Ht="æˆ‘å·²é˜…è¯»å¹¶åŒæ„",dx=je({__name:"WebImportDisclaimer",setup(n){const t=Co(),s=w(""),o=Z(()=>t.disclaimerVisible),l=Z(()=>s.value.trim()===Ht);function u(){l.value&&(t.acceptDisclaimer(),s.value="")}function a(){t.rejectDisclaimer(),s.value=""}return(c,v)=>(B(),ut(Sn,{to:"body"},[o.value?(B(),F("div",{key:0,class:"disclaimer-overlay",onClick:lt(a,["self"])},[e("div",sx,[v[3]||(v[3]=e("div",{class:"disclaimer-header"},[e("span",{class:"warning-icon"},"âš ï¸"),e("h2",{class:"disclaimer-title"},"é‡è¦å…è´£å£°æ˜")],-1)),e("div",ax,[v[2]||(v[2]=e("div",{class:"disclaimer-text"},[e("h3",null,"ğŸ“œ ä½¿ç”¨æ¡æ¬¾ä¸æ³•å¾‹å£°æ˜"),e("div",{class:"section"},[e("h4",null,"1. åŠŸèƒ½è¯´æ˜"),e("p",null,[me(' "ä»ç½‘é¡µå¯¼å…¥"åŠŸèƒ½å…è®¸æ‚¨ä»äº’è”ç½‘ç½‘é¡µä¸­æå–å›¾ç‰‡ã€‚æ­¤åŠŸèƒ½ä»…ä¾›'),e("strong",null,"æŠ€æœ¯ç ”ç©¶ä¸ä¸ªäººå­¦ä¹ "),me("ä¹‹ç›®çš„æä¾›ã€‚ ")])]),e("div",{class:"section"},[e("h4",null,"2. ç”¨æˆ·è´£ä»»"),e("ul",null,[e("li",null,[me("æ‚¨åº”å½“ç¡®ä¿æ‹¥æœ‰"),e("strong",null,"åˆæ³•æƒåˆ©"),me("è®¿é—®å’Œä¸‹è½½ç›®æ ‡å†…å®¹")]),e("li",null,[me("æ‚¨åº”å½“éµå®ˆç›®æ ‡ç½‘ç«™çš„"),e("strong",null,"æœåŠ¡æ¡æ¬¾"),me("å’Œ"),e("strong",null,"ä½¿ç”¨åè®®")]),e("li",null,[me("æ‚¨åº”å½“å°Šé‡å†…å®¹åˆ›ä½œè€…çš„"),e("strong",null,"ç‰ˆæƒ"),me("å’Œ"),e("strong",null,"çŸ¥è¯†äº§æƒ")]),e("li",null,[me("æ‚¨"),e("strong",null,"ä¸å¾—"),me("å°†ä¸‹è½½çš„å†…å®¹ç”¨äºå•†ä¸šç›®çš„æˆ–éæ³•ä¼ æ’­")]),e("li",null,[me("æ‚¨"),e("strong",null,"ä¸å¾—"),me("ä½¿ç”¨æœ¬åŠŸèƒ½ç»•è¿‡ä»˜è´¹å†…å®¹çš„è®¿é—®é™åˆ¶")])])]),e("div",{class:"section"},[e("h4",null,"3. ä½¿ç”¨é™åˆ¶"),e("p",null,[me("æœ¬åŠŸèƒ½"),e("strong",null,"ä¸¥ç¦"),me("ç”¨äºä»¥ä¸‹ç›®çš„ï¼š")]),e("ul",null,[e("li",null,[me("ä¸‹è½½ã€å­˜å‚¨æˆ–ä¼ æ’­"),e("strong",null,"ä¾µæƒå†…å®¹")]),e("li",null,[me("ç»•è¿‡ç½‘ç«™çš„"),e("strong",null,"ä»˜è´¹å¢™"),me("æˆ–"),e("strong",null,"è®¿é—®æ§åˆ¶")]),e("li",null,[me("è¿›è¡Œ"),e("strong",null,"å•†ä¸šç”¨é€”"),me("æˆ–å¤§è§„æ¨¡"),e("strong",null,"æ‰¹é‡çˆ¬å–")]),e("li",null,[me("ä»»ä½•è¿å"),e("strong",null,"å½“åœ°æ³•å¾‹æ³•è§„"),me("çš„æ´»åŠ¨")]),e("li",null,[me("å¯¹ç›®æ ‡ç½‘ç«™é€ æˆ"),e("strong",null,"æœåŠ¡å™¨è´Ÿæ‹…"),me("æˆ–"),e("strong",null,"æ¶æ„æ”»å‡»")])])]),e("div",{class:"section"},[e("h4",null,"4. å…è´£æ¡æ¬¾"),e("p",null,[me(" æœ¬è½¯ä»¶ä½œè€…åŠè´¡çŒ®è€…"),e("strong",null,"ä¸å¯¹æ‚¨ä½¿ç”¨æœ¬åŠŸèƒ½æ‰€å¯¼è‡´çš„ä»»ä½•ç›´æ¥æˆ–é—´æ¥åæœæ‰¿æ‹…è´£ä»»"),me("ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºï¼š ")]),e("ul",null,[e("li",null,"å› ä¾µçŠ¯ç‰ˆæƒè€Œäº§ç”Ÿçš„æ³•å¾‹è´£ä»»"),e("li",null,"å› è¿åæœåŠ¡æ¡æ¬¾è€Œå¯¼è‡´çš„è´¦å·å°ç¦"),e("li",null,"å› æ•°æ®ä¸¢å¤±æˆ–æŸåè€Œé€ æˆçš„æŸå¤±"),e("li",null,"ä»»ä½•å…¶ä»–å› ä½¿ç”¨æœ¬åŠŸèƒ½è€Œäº§ç”Ÿçš„ä¸åˆ©åæœ")])]),e("div",{class:"section warning-section"},[e("h4",null,"5. ç¡®è®¤å£°æ˜"),e("p",null,[me(" ä½¿ç”¨æœ¬åŠŸèƒ½å³è¡¨ç¤ºæ‚¨"),e("strong",null,"å·²é˜…è¯»ã€ç†è§£å¹¶åŒæ„"),me("ä¸Šè¿°æ‰€æœ‰æ¡æ¬¾ï¼Œå¹¶æ‰¿è¯ºï¼š ")]),e("ul",null,[e("li",null,[me("ä»…å°†æœ¬åŠŸèƒ½ç”¨äº"),e("strong",null,"åˆæ³•ã€åˆè§„"),me("çš„ç›®çš„")]),e("li",null,[e("strong",null,"è‡ªè¡Œæ‰¿æ‹…"),me("ä½¿ç”¨æœ¬åŠŸèƒ½æ‰€å¸¦æ¥çš„ä¸€åˆ‡é£é™©å’Œè´£ä»»")]),e("li",null,[me("å¦‚å› ä½¿ç”¨æœ¬åŠŸèƒ½å¯¼è‡´ä»»ä½•äº‰è®®ï¼Œ"),e("strong",null,"ä¸æœ¬è½¯ä»¶ä½œè€…æ— å…³")])])])],-1)),e("div",lx,[v[1]||(v[1]=e("p",{class:"confirmation-prompt"}," å¦‚æœæ‚¨å·²å®Œæ•´é˜…è¯»å¹¶åŒæ„ä»¥ä¸Šæ¡æ¬¾ï¼Œè¯·åœ¨ä¸‹æ–¹è¾“å…¥æ¡†ä¸­å‡†ç¡®è¾“å…¥ï¼š ",-1)),e("p",{class:"required-text"},[e("code",null,ne(Ht))]),le(e("input",{"onUpdate:modelValue":v[0]||(v[0]=p=>s.value=p),type:"text",class:"confirmation-input",placeholder:`è¯·è¾“å…¥: ${Ht}`,onKeyup:Cn(u,["enter"])},null,40,ix),[[we,s.value]]),s.value&&!l.value?(B(),F("p",rx," è¾“å…¥ä¸æ­£ç¡®ï¼Œè¯·å®Œæ•´è¾“å…¥ã€Œ"+ne(Ht)+"ã€ ")):de("",!0)])]),e("div",ux,[e("button",{class:"btn-cancel",onClick:a}," æˆ‘ä¸åŒæ„ï¼Œè¿”å› "),e("button",{class:"btn-confirm",disabled:!l.value,onClick:u}," âœ“ ç¡®è®¤å¹¶ç»§ç»­ ",8,cx)])])])):de("",!0)]))}}),gx=He(dx,[["__scopeId","data-v-3750d090"]]),px={class:"app-header"},mx={class:"header-content"},vx={class:"logo-container"},fx={class:"header-links"},bx={class:"container"},hx={id:"image-display-area"},xx={id:"upload-section",class:"card upload-card"},yx={class:"upload-actions"},_x={key:1,class:"bookshelf-mode-hint"},Cx=je({__name:"TranslateView",setup(n){const t=_n(),s=et(),o=Ne(),l=It(),u=gt(),{validateBeforeTranslation:a,initValidation:c}=Mn(),v=Mo(),p=Bi(),_=w(!1),S=w(void 0),D=w(!1),M=w(!1),E=Z(()=>s.currentImage),P=Z(()=>s.hasImages),q=Z(()=>s.isBatchTranslationInProgress),V=Z(()=>s.failedImageCount>0),U=Z(()=>!!t.query.book&&!!t.query.chapter),f=Z(()=>t.query.book),m=Z(()=>t.query.chapter),C=Z(()=>p.currentBookTitle.value),k=Z(()=>p.currentChapterTitle.value),K=Z(()=>U.value&&k.value&&C.value?`${k.value} - ${C.value}`:"Saber-Translator");dt(async()=>{s.clearImages(),u.clearBubbles(),await p.initializeApp(),c(),window.addEventListener("keydown",y)}),zt(()=>{window.removeEventListener("keydown",y)}),Se(()=>[t.query.book,t.query.chapter],async([O,oe],[be,ge])=>{O&&oe?(s.clearImages(),u.clearBubbles(),await J()):be&&ge&&!O&&!oe&&(s.clearImages(),u.clearBubbles(),await p.initializeBookChapterContext(),console.log("[TranslateView] ä»ä¹¦æ¶æ¨¡å¼åˆ‡æ¢åˆ°å¿«é€Ÿç¿»è¯‘æ¨¡å¼ï¼Œå·²æ¸…ç©ºæ•°æ®"))}),Se(K,O=>{typeof document<"u"&&(document.title=O)},{immediate:!0});const N=w(!1);function se(O){if(!O)return;const oe=o.settings.textStyle;o.updateTextStyle({fontSize:O.fontSize??oe.fontSize,autoFontSize:O.autoFontSize??oe.autoFontSize,fontFamily:O.fontFamily??oe.fontFamily,layoutDirection:O.layoutDirection??oe.layoutDirection,textColor:O.textColor??oe.textColor,fillColor:O.fillColor??oe.fillColor,strokeEnabled:O.strokeEnabled??oe.strokeEnabled,strokeColor:O.strokeColor??oe.strokeColor,strokeWidth:O.strokeWidth??oe.strokeWidth,inpaintMethod:O.inpaintMethod??oe.inpaintMethod,useAutoTextColor:O.useAutoTextColor??oe.useAutoTextColor})}function G(O){s.currentImage&&s.updateCurrentImage({fontSize:O.fontSize,autoFontSize:O.autoFontSize,fontFamily:O.fontFamily,layoutDirection:O.layoutDirection,textColor:O.textColor,fillColor:O.fillColor,strokeEnabled:O.strokeEnabled,strokeColor:O.strokeColor,strokeWidth:O.strokeWidth,inpaintMethod:O.inpaintMethod,useAutoTextColor:O.useAutoTextColor})}Se(()=>s.currentImage,O=>{if(O&&!N.value){N.value=!0;try{se(O),console.log(`[TranslateView] å·²åŒæ­¥å›¾ç‰‡ ${s.currentImageIndex} çš„æ–‡å­—è®¾ç½®åˆ°ä¾§è¾¹æ `)}finally{N.value=!1}}},{immediate:!1}),Se(()=>o.settings.textStyle,O=>{if(s.currentImage&&!N.value){N.value=!0;try{G(O),console.log(`[TranslateView] å·²å°†ä¾§è¾¹æ è®¾ç½®åŒæ­¥åˆ°å›¾ç‰‡ ${s.currentImageIndex}`)}finally{N.value=!1}}},{deep:!0});async function J(){if(!(!f.value||!m.value))try{await p.initializeBookChapterContext()}catch(O){console.error("åŠ è½½ç« èŠ‚ä¼šè¯å¤±è´¥:",O),_e("åŠ è½½ç« èŠ‚ä¼šè¯å¤±è´¥","error")}}function ee(O){console.log(`ä¸Šä¼ å®Œæˆï¼Œå…± ${O} å¼ å›¾ç‰‡`),s.hasImages&&(s.sortImagesByFileName(),p.switchImage(0))}async function j(O){if(!Object.values(O).some(ge=>ge)){_e("è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè¦åº”ç”¨çš„è®¾ç½®é¡¹","warning");return}if(s.images.length===0){_e("æ²¡æœ‰å¯åº”ç”¨çš„å›¾ç‰‡","warning");return}if(s.images.length<=1){_e("åªæœ‰ä¸€å¼ å›¾ç‰‡ï¼Œæ— éœ€åº”ç”¨åˆ°å…¨éƒ¨","info");return}if(!s.images.some(ge=>ge.bubbleStates&&ge.bubbleStates.length>0)){_e("æ²¡æœ‰å·²ç¿»è¯‘çš„å›¾ç‰‡","warning");return}try{const{textStyle:ge}=o.settings,Pe=ge.layoutDirection==="auto",Ee=ge.useAutoTextColor===!0,Le=ge.autoFontSize===!0,ke={fontSize:ge.fontSize,fontFamily:ge.fontFamily,textDirection:ge.layoutDirection==="auto"?"vertical":ge.layoutDirection,textColor:ge.textColor,fillColor:ge.fillColor,strokeEnabled:ge.strokeEnabled,strokeColor:ge.strokeColor,strokeWidth:ge.strokeWidth},Be=z=>{if(!z||z.length!==3)return null;const[re,Te,Re]=z;return"#"+[re,Te,Re].map(tt=>{const qe=Math.max(0,Math.min(255,Math.round(tt))).toString(16);return qe.length===1?"0"+qe:qe}).join("")},ye=z=>{const re={...z};if(O.fontSize&&!Le&&(re.fontSize=ke.fontSize),O.fontFamily&&(re.fontFamily=ke.fontFamily),O.layoutDirection)if(Pe){const Te=z.autoTextDirection;re.textDirection=Te==="vertical"||Te==="horizontal"?Te:"vertical"}else re.textDirection=ke.textDirection;if(O.textColor)if(Ee&&z.autoFgColor){const Te=Be(z.autoFgColor);re.textColor=Te??ke.textColor}else re.textColor=ke.textColor;if(O.fillColor)if(Ee&&z.autoBgColor){const Te=Be(z.autoBgColor);re.fillColor=Te??ke.fillColor}else re.fillColor=ke.fillColor;return O.strokeEnabled&&(re.strokeEnabled=ke.strokeEnabled),O.strokeColor&&(re.strokeColor=ke.strokeColor),O.strokeWidth&&(re.strokeWidth=ke.strokeWidth),re};let it=0;const Ge=s.images;for(let z=0;z<Ge.length;z++){const re=Ge[z];if(re&&re.bubbleStates&&re.bubbleStates.length>0){const Re={bubbleStates:re.bubbleStates.map(ye)};O.fontSize&&(Re.autoFontSize=Le,Le||(Re.fontSize=ke.fontSize)),O.fontFamily&&(Re.fontFamily=ke.fontFamily),O.layoutDirection&&(Re.layoutDirection=ge.layoutDirection),(O.textColor||O.fillColor)&&(Re.useAutoTextColor=Ee),O.textColor&&(Ee||(Re.textColor=ke.textColor)),O.fillColor&&(Ee||(Re.fillColor=ke.fillColor)),O.strokeEnabled&&(Re.strokeEnabled=ke.strokeEnabled),O.strokeColor&&(Re.strokeColor=ke.strokeColor),O.strokeWidth&&(Re.strokeWidth=ke.strokeWidth),s.updateImageByIndex(z,Re),it++}}if(u.bubbles.length>0){const z=u.bubbles.map(ye);u.setBubbles(z)}const Ze=[];O.fontSize&&Ze.push(Le?"è‡ªåŠ¨å­—å·":"å­—å·"),O.fontFamily&&Ze.push("å­—ä½“"),O.layoutDirection&&Ze.push(Pe?"è‡ªåŠ¨æ’ç‰ˆæ–¹å‘":"æ’ç‰ˆæ–¹å‘"),O.textColor&&Ze.push(Ee?"è‡ªåŠ¨æ–‡å­—é¢œè‰²":"æ–‡å­—é¢œè‰²"),O.fillColor&&Ze.push(Ee?"è‡ªåŠ¨å¡«å……é¢œè‰²":"å¡«å……é¢œè‰²"),O.strokeEnabled&&Ze.push("æè¾¹å¼€å…³"),O.strokeColor&&Ze.push("æè¾¹é¢œè‰²"),O.strokeWidth&&Ze.push("æè¾¹å®½åº¦");const st=[];for(let z=0;z<Ge.length;z++){const re=Ge[z];re&&re.translatedDataURL&&re.bubbleStates&&re.bubbleStates.length>0&&st.push(z)}if(st.length>0){v.progress.value={isInProgress:!0,current:0,total:st.length,completed:0,failed:0,label:`åº”ç”¨è®¾ç½®ä¸­ï¼š0 / ${st.length}`,percentage:0};const{parallelRender:z}=await rt(async()=>{const{parallelRender:Te}=await Promise.resolve().then(()=>pi);return{parallelRender:Te}},void 0);let re=0;for(let Te=0;Te<st.length;Te++){const Re=st[Te];if(Re===void 0)continue;const tt=s.images[Re];if(!(!tt||!tt.bubbleStates))try{let qe="";if(tt.cleanImageData?qe=tt.cleanImageData.includes("base64,")?tt.cleanImageData.split("base64,")[1]||"":tt.cleanImageData:tt.originalDataURL&&(qe=tt.originalDataURL.includes("base64,")?tt.originalDataURL.split("base64,")[1]||"":tt.originalDataURL,console.log(`handleApplyToAll: å›¾ç‰‡ ${Re} ä½¿ç”¨åŸå›¾ä½œä¸ºèƒŒæ™¯ï¼ˆå…œåº•ï¼‰`)),!qe){console.log(`handleApplyToAll: å›¾ç‰‡ ${Re} æ²¡æœ‰å¯ç”¨çš„èƒŒæ™¯å›¾ï¼Œè·³è¿‡`),v.progress.value.failed++;continue}const Qe=tt.bubbleStates.map(ot=>({originalText:ot.originalText||"",translatedText:ot.translatedText||"",textboxText:ot.textboxText||"",coords:ot.coords,polygon:ot.polygon,fontSize:ot.fontSize,fontFamily:ot.fontFamily,textDirection:ot.textDirection,autoTextDirection:ot.autoTextDirection,textColor:ot.textColor,fillColor:ot.fillColor,rotationAngle:ot.rotationAngle||0,position:ot.position||{x:0,y:0},strokeEnabled:ot.strokeEnabled,strokeColor:ot.strokeColor,strokeWidth:ot.strokeWidth,inpaintMethod:ot.inpaintMethod,autoFgColor:ot.autoFgColor,autoBgColor:ot.autoBgColor})),ht=await z({clean_image:qe,bubble_states:Qe,fontSize:ge.fontSize,fontFamily:ge.fontFamily,textDirection:ge.layoutDirection==="auto"?"vertical":ge.layoutDirection,textColor:ge.textColor,strokeEnabled:ge.strokeEnabled,strokeColor:ge.strokeColor,strokeWidth:ge.strokeWidth,autoFontSize:O.fontSize&&Le,use_individual_styles:!0});if(ht.success&&ht.final_image){const ot=ht.bubble_states||tt.bubbleStates;s.updateImageByIndex(Re,{translatedDataURL:`data:image/png;base64,${ht.final_image}`,bubbleStates:ot,hasUnsavedChanges:!0}),re++,v.progress.value.current=re,v.progress.value.label=`åº”ç”¨è®¾ç½®ä¸­ï¼š${re} / ${st.length}`,v.progress.value.percentage=Math.round(re/st.length*100)}else v.progress.value.failed++}catch(qe){console.error(`é‡æ¸²æŸ“å›¾ç‰‡ ${Re} å¤±è´¥:`,qe),v.progress.value.failed++}}v.progress.value.isInProgress=!1}const Ae=s.currentImage;if(Ae){N.value=!0;try{se(Ae),console.log("[TranslateView] åº”ç”¨åˆ°å…¨éƒ¨å®Œæˆï¼Œå·²åŒæ­¥å½“å‰å›¾ç‰‡è®¾ç½®åˆ°ä¾§è¾¹æ ")}finally{N.value=!1}}_e(`å·²å°† ${Ze.join("ã€")} åº”ç”¨åˆ° ${it} å¼ å›¾ç‰‡`,"success"),console.log(`[TranslateView] åº”ç”¨è®¾ç½®åˆ°å…¨éƒ¨å®Œæˆï¼Œæ›´æ–°äº† ${it} å¼ å›¾ç‰‡ï¼Œé‡æ¸²æŸ“äº† ${st.length} å¼ `)}catch(ge){console.error("åº”ç”¨è®¾ç½®åˆ°å…¨éƒ¨å¤±è´¥:",ge),_e("åº”ç”¨è®¾ç½®å¤±è´¥","error")}}async function ae(){E.value&&a("normal")&&await v.translateCurrentImage()}async function A(){P.value&&a("normal")&&await v.translateAllImages()}async function d(){P.value&&a("hq")&&await v.executeHqTranslation()}async function $(){P.value&&a("proofread")&&await v.executeProofreading()}async function r(){E.value&&await v.removeTextOnly()}async function h(){P.value&&await v.removeAllTexts()}async function I(O,oe){P.value&&a("normal")&&await v.translateImageRange({startPage:O,endPage:oe})}async function T(O,oe){P.value&&a("hq")&&await v.executeHqTranslation({startPage:O,endPage:oe})}async function g(O,oe){P.value&&a("proofread")&&await v.executeProofreading({startPage:O,endPage:oe})}async function b(O,oe){P.value&&await v.removeTextRange({startPage:O,endPage:oe})}function L(){if(!E.value)return;const O=E.value.fileName||`å›¾ç‰‡ ${s.currentImageIndex+1}`;confirm(`ç¡®å®šè¦åˆ é™¤å½“å‰å›¾ç‰‡ (${O}) å—ï¼Ÿ`)&&(s.deleteCurrentImage(),_e("å›¾ç‰‡å·²åˆ é™¤","success"))}function W(){P.value&&confirm("ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰å›¾ç‰‡å—ï¼Ÿè¿™å°†ä¸¢å¤±æ‰€æœ‰æœªä¿å­˜çš„è¿›åº¦ã€‚")&&(s.clearImages(),_e("æ‰€æœ‰å›¾ç‰‡å·²æ¸…é™¤","success"))}async function i(){try{const O=await kn(),oe=await xo();if(O.success&&oe.success)_e("ä¸´æ—¶æ–‡ä»¶æ¸…ç†å®Œæˆ","success");else{const be=[];O.success||be.push("è°ƒè¯•æ–‡ä»¶æ¸…ç†å¤±è´¥"),oe.success||be.push("ä¸´æ—¶æ–‡ä»¶æ¸…ç†å¤±è´¥"),_e(be.join("ï¼Œ"),"warning")}}catch{_e("æ¸…ç†ä¸´æ—¶æ–‡ä»¶å¤±è´¥","error")}}function x(){p.goToPrevious()}function ie(){p.goToNext()}function R(){M.value=!M.value}async function Y(){if(!V.value){_e("æ²¡æœ‰å¤±è´¥çš„å›¾ç‰‡éœ€è¦é‡æ–°ç¿»è¯‘","info");return}a("normal")&&await v.retryFailedImages()}async function ce(){if(!P.value){_e("æ²¡æœ‰å¯ä¿å­˜çš„å†…å®¹","warning");return}if(!(!f.value||!m.value))try{await l.saveChapterSession(f.value,m.value)?_e("ç« èŠ‚è¿›åº¦å·²ä¿å­˜","success"):_e("ä¿å­˜å¤±è´¥","error")}catch(O){console.error("ä¿å­˜ä¼šè¯å¤±è´¥:",O),_e("ä¿å­˜å¤±è´¥: "+(O instanceof Error?O.message:"æœªçŸ¥é”™è¯¯"),"error")}}function xe(O){S.value=O,_.value=!0}function De(){xe("plugins")}function $e(){_e("è®¾ç½®å·²ä¿å­˜","success")}function he(){D.value=!0}function te(){_e("ğŸŒ™ è¯¥åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­ï¼Œæ•¬è¯·æœŸå¾…ï¼","info")}function y(O){const oe=O.target;if(!(oe instanceof HTMLInputElement||oe instanceof HTMLTextAreaElement||oe.getAttribute("contenteditable")==="true"||oe.id==="bubbleTextEditor")&&!M.value&&O.altKey)switch(O.key){case"ArrowLeft":O.preventDefault(),x();break;case"ArrowRight":O.preventDefault(),ie();break;case"ArrowUp":if(O.preventDefault(),!o.settings.textStyle.autoFontSize){const ge=o.settings.textStyle.fontSize;o.updateTextStyle({fontSize:ge+1})}break;case"ArrowDown":if(O.preventDefault(),!o.settings.textStyle.autoFontSize){const ge=o.settings.textStyle.fontSize;o.updateTextStyle({fontSize:Math.max(10,ge-1)})}break}}async function X(O){const oe=E.value;if(!oe||!oe.translatedDataURL){console.log(`è‡ªåŠ¨å­—å·è®¾ç½®å˜æ›´: ${O} (ä»…å½±å“ä¸‹æ¬¡ç¿»è¯‘)`);return}const be=oe.bubbleStates;if(!be||!Array.isArray(be)||be.length===0){console.log("å½“å‰å›¾ç‰‡æ²¡æœ‰ bubbleStatesï¼Œè·³è¿‡é‡æ¸²æŸ“");return}if(console.log(`è‡ªåŠ¨å­—å·è®¾ç½®å˜æ›´: ${O}ï¼Œå°†é‡æ–°æ¸²æŸ“...`),O){console.log("è‡ªåŠ¨å­—å·å·²å¼€å¯ï¼Œé‡æ–°è®¡ç®—å­—å·å¹¶æ¸²æŸ“...");try{const{apiClient:ge}=await rt(async()=>{const{apiClient:ye}=await import("./client.Bht704G-.js");return{apiClient:ye}},__vite__mapDeps([4,5]));let Pe="";if(oe.cleanImageData){const ye=oe.cleanImageData;Pe=ye.includes("base64,")?ye.split("base64,")[1]||"":ye}else oe.originalDataURL&&(Pe=oe.originalDataURL.includes("base64,")?oe.originalDataURL.split("base64,")[1]||"":oe.originalDataURL);if(!Pe){console.log("æ²¡æœ‰å¯ç”¨çš„èƒŒæ™¯å›¾ï¼Œè·³è¿‡é‡æ¸²æŸ“");return}const Ee=be.map(ye=>({translatedText:ye.translatedText||"",coords:ye.coords,fontSize:ye.fontSize||o.settings.textStyle.fontSize,fontFamily:ye.fontFamily||o.settings.textStyle.fontFamily,textDirection:Ft(ye),textColor:ye.textColor||o.settings.textStyle.textColor,rotationAngle:ye.rotationAngle||0,position:ye.position||{x:0,y:0},strokeEnabled:ye.strokeEnabled??o.settings.textStyle.strokeEnabled,strokeColor:ye.strokeColor||o.settings.textStyle.strokeColor,strokeWidth:ye.strokeWidth??o.settings.textStyle.strokeWidth})),Le=Ee.map(ye=>ye.translatedText),ke=Ee.map(ye=>ye.coords),Be=await ge.post("/api/re_render_image",{clean_image:Pe,bubble_texts:Le,bubble_coords:ke,fontSize:o.settings.textStyle.fontSize,fontFamily:o.settings.textStyle.fontFamily,textDirection:o.settings.textStyle.layoutDirection==="auto"?"vertical":o.settings.textStyle.layoutDirection,textColor:o.settings.textStyle.textColor,bubble_states:Ee,use_individual_styles:!0,use_inpainting:!1,use_lama:!1,fillColor:null,is_font_style_change:!0,autoFontSize:!0,strokeEnabled:o.settings.textStyle.strokeEnabled,strokeColor:o.settings.textStyle.strokeColor,strokeWidth:o.settings.textStyle.strokeWidth});if(Be.rendered_image){if(Be.bubble_states&&Array.isArray(Be.bubble_states)){const ye=be.map((it,Ge)=>({...it,fontSize:Be.bubble_states[Ge]?.fontSize??it.fontSize}));s.updateCurrentImage({translatedDataURL:`data:image/png;base64,${Be.rendered_image}`,bubbleStates:ye,hasUnsavedChanges:!0}),u.setBubbles(ye)}else s.updateCurrentImage({translatedDataURL:`data:image/png;base64,${Be.rendered_image}`,hasUnsavedChanges:!0});console.log("è‡ªåŠ¨å­—å·æ¸²æŸ“æˆåŠŸ")}else Be.error&&(console.error("è‡ªåŠ¨å­—å·æ¸²æŸ“å¤±è´¥:",Be.error),_e("é‡æ–°æ¸²æŸ“å¤±è´¥: "+Be.error,"error"))}catch(ge){console.error("è‡ªåŠ¨å­—å·æ¸²æŸ“å‡ºé”™:",ge)}}else{const ge=o.settings.textStyle.fontSize;console.log(`è‡ªåŠ¨å­—å·å·²å…³é—­ï¼Œä½¿ç”¨å›ºå®šå­—å· ${ge} æ¸²æŸ“...`);const Pe=be.map(Ee=>({...Ee,fontSize:ge}));s.updateCurrentImage({bubbleStates:Pe}),u.setBubbles(Pe),await ve("fontSize",ge)}}async function ve(O,oe){const be=E.value;if(!be||!be.translatedDataURL||!be.bubbleStates||be.bubbleStates.length===0||!["fontSize","fontFamily","layoutDirection","textColor","strokeEnabled","strokeColor","strokeWidth","fillColor"].includes(O))return;console.log(`å…¨å±€è®¾ç½®å˜æ›´ (${O}=${oe})ï¼Œå‡†å¤‡é‡æ¸²æŸ“...`);const Ee={fontSize:"fontSize",fontFamily:"fontFamily",layoutDirection:"textDirection",textColor:"textColor",strokeEnabled:"strokeEnabled",strokeColor:"strokeColor",strokeWidth:"strokeWidth",fillColor:"fillColor"}[O];if(Ee&&be.bubbleStates)if(O==="layoutDirection")if(oe==="auto"){console.log("æ’ç‰ˆæ–¹å‘è®¾ç½®ä¸º 'auto'ï¼Œä» autoTextDirection æ¢å¤æ¯ä¸ªæ°”æ³¡çš„æ’ç‰ˆæ–¹å‘");const Le=be.bubbleStates.map(ke=>({...ke,textDirection:ke.autoTextDirection==="vertical"||ke.autoTextDirection==="horizontal"?ke.autoTextDirection:"vertical"}));s.updateCurrentImage({bubbleStates:Le}),u.setBubbles(Le)}else{console.log(`æ’ç‰ˆæ–¹å‘è®¾ç½®ä¸º '${oe}'ï¼Œåº”ç”¨åˆ°æ‰€æœ‰æ°”æ³¡`);const Le=be.bubbleStates.map(ke=>({...ke,textDirection:oe}));s.updateCurrentImage({bubbleStates:Le}),u.setBubbles(Le)}else{const Le=be.bubbleStates.map(ke=>({...ke,[Ee]:oe}));s.updateCurrentImage({bubbleStates:Le}),u.setBubbles(Le)}try{const ke=s.currentImage?.bubbleStates||be.bubbleStates||[];if(ke.length===0||!ke[0]?.coords){console.log("æ²¡æœ‰æœ‰æ•ˆçš„æ°”æ³¡åæ ‡ï¼Œè·³è¿‡é‡æ¸²æŸ“");return}const Be=o.settings.textStyle.layoutDirection,ye=ke.map(z=>({translatedText:z.translatedText||"",coords:z.coords,fontSize:z.fontSize||o.settings.textStyle.fontSize,fontFamily:z.fontFamily||o.settings.textStyle.fontFamily,textDirection:Ft(z),textColor:z.textColor||o.settings.textStyle.textColor,rotationAngle:z.rotationAngle||0,position:z.position||{x:0,y:0},strokeEnabled:z.strokeEnabled??o.settings.textStyle.strokeEnabled,strokeColor:z.strokeColor||o.settings.textStyle.strokeColor,strokeWidth:z.strokeWidth??o.settings.textStyle.strokeWidth})),it=ye.map(z=>z.translatedText),Ge=ye.map(z=>z.coords);let Ze="";if(be.cleanImageData){const z=be.cleanImageData;Ze=z.includes("base64,")?z.split("base64,")[1]||"":z}else be.originalDataURL&&(Ze=be.originalDataURL.includes("base64,")?be.originalDataURL.split("base64,")[1]||"":be.originalDataURL,console.log("handleTextStyleChanged: ä½¿ç”¨åŸå›¾ä½œä¸ºèƒŒæ™¯ï¼ˆå…œåº•ï¼‰"));if(!Ze){console.log("æ²¡æœ‰å¯ç”¨çš„èƒŒæ™¯å›¾ï¼Œè·³è¿‡é‡æ¸²æŸ“");return}const{apiClient:st}=await rt(async()=>{const{apiClient:z}=await import("./client.Bht704G-.js");return{apiClient:z}},__vite__mapDeps([4,5])),Ae=await st.post("/api/re_render_image",{clean_image:Ze,bubble_texts:it,bubble_coords:Ge,fontSize:o.settings.textStyle.fontSize,fontFamily:o.settings.textStyle.fontFamily,textDirection:Be==="auto"?"vertical":Be,textColor:o.settings.textStyle.textColor,bubble_states:ye,use_individual_styles:!0,use_inpainting:!1,use_lama:!1,fillColor:null,is_font_style_change:!0,strokeEnabled:o.settings.textStyle.strokeEnabled,strokeColor:o.settings.textStyle.strokeColor,strokeWidth:o.settings.textStyle.strokeWidth});Ae.rendered_image?(s.updateCurrentImage({translatedDataURL:`data:image/png;base64,${Ae.rendered_image}`,hasUnsavedChanges:!0}),console.log("è®¾ç½®å˜æ›´åé‡æ–°æ¸²æŸ“æˆåŠŸ")):Ae.error&&console.error("é‡æ–°æ¸²æŸ“å¤±è´¥:",Ae.error)}catch(Le){console.error("è®¾ç½®å˜æ›´åé‡æ–°æ¸²æŸ“å¤±è´¥:",Le)}}function fe(O){p.switchImage(O)}return(O,oe)=>{const be=Cs("router-link");return B(),F("div",{class:Ie(["translate-page",{"edit-mode-active":M.value}])},[e("header",px,[e("div",mx,[e("div",vx,[Ce(be,{to:"/",title:"è¿”å›ä¹¦æ¶"},{default:St(()=>[...oe[3]||(oe[3]=[e("img",{src:"/pic/logo.png",alt:"Saber-Translator Logo",class:"app-logo"},null,-1),e("span",{class:"app-name"},"Saber-Translator",-1)])]),_:1})]),e("div",fx,[Ce(be,{to:"/",class:"back-to-shelf",title:"è¿”å›ä¹¦æ¶"},{default:St(()=>[...oe[4]||(oe[4]=[me("ğŸ“š",-1)])]),_:1}),U.value?(B(),F("button",{key:0,class:"save-header-btn",title:"ä¿å­˜è¿›åº¦",onClick:ce}," ğŸ’¾ ")):de("",!0),e("button",{id:"openSettingsBtn",class:"settings-header-btn",title:"æ‰“å¼€è®¾ç½®",onClick:oe[0]||(oe[0]=ge=>xe())},[...oe[5]||(oe[5]=[e("span",{class:"icon"},"âš™ï¸",-1),e("span",null,"è®¾ç½®",-1)])]),oe[8]||(oe[8]=e("a",{href:"http://www.mashirosaber.top",target:"_blank",class:"tutorial-link"},"ä½¿ç”¨æ•™ç¨‹",-1)),e("a",{href:"javascript:void(0)",class:"donate-link",onClick:he},[...oe[6]||(oe[6]=[e("span",null,"â¤ï¸ è¯·ä½œè€…å–å¥¶èŒ¶",-1)])]),oe[9]||(oe[9]=e("a",{href:"https://github.com/MashiroSaber03",target:"_blank",class:"github-link"},[e("img",{src:"/pic/github.jpg",alt:"GitHub",class:"github-icon"})],-1)),e("button",{class:"theme-toggle",title:"åŠŸèƒ½å¼€å‘ä¸­",onClick:te},[...oe[7]||(oe[7]=[e("span",{class:"theme-icon"},"â˜€ï¸",-1)])])])])]),e("div",bx,[Ce(Rl,{onTranslateCurrent:ae,onTranslateAll:A,onTranslateRange:I,onHqTranslate:d,onHqTranslateRange:T,onProofread:$,onProofreadRange:g,onRemoveText:r,onRemoveAllText:h,onRemoveTextRange:b,onRetryFailed:Y,onDeleteCurrent:L,onClearAll:W,onCleanTemp:i,onOpenPlugins:De,onOpenSettings:xe,onPrevious:x,onNext:ie,onApplyToAll:j,onTextStyleChanged:ve,onAutoFontSizeChanged:X}),e("main",hx,[e("section",xx,[e("div",yx,[Ce(fa,{ref:"imageUploadRef",onUploadComplete:ee},null,512)]),H(l).loadingProgress.total>0?(B(),ut(So,{key:0,visible:!0,percentage:H(l).loadingProgress.current/H(l).loadingProgress.total*100,label:H(l).loadingProgress.message},null,8,["percentage","label"])):de("",!0),Ce(cr,{progress:H(v).progress.value},null,8,["progress"]),q.value&&U.value?(B(),F("div",_x,[...oe[10]||(oe[10]=[e("span",{style:{color:"#888","font-size":"0.85em"}}," ï¼ˆä¹¦æ¶æ¨¡å¼ä¸‹é€€å‡ºå‰è¯·ç‚¹å‡»é¡¶éƒ¨ä¿å­˜æŒ‰é’®ï¼‰ ",-1)])])):de("",!0)]),Ce(Ql,{ref:"imageResultRef","is-edit-mode":M.value,onToggleEditMode:R,onRetryFailed:Y},null,8,["is-edit-mode"])]),P.value&&!M.value?(B(),ut(zr,{key:0,onSelect:fe})):de("",!0)]),E.value&&M.value?(B(),ut(If,{key:0,"is-edit-mode-active":M.value,onExit:R},null,8,["is-edit-mode-active"])):de("",!0),Ce(si,{onOpenSettings:xe}),Ce(xm,{modelValue:_.value,"onUpdate:modelValue":oe[1]||(oe[1]=ge=>_.value=ge),"initial-tab":S.value,onSave:$e},null,8,["modelValue","initial-tab"]),D.value?(B(),ut(gr,{key:1,onClose:oe[2]||(oe[2]=ge=>D.value=!1)})):de("",!0),Ce(gx),Ce(nx)],2)}}}),Mx=He(Cx,[["__scopeId","data-v-c419aa19"]]);export{Mx as default};
