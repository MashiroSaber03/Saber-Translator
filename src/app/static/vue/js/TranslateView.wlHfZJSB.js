const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["js/session.C_VZSWrV.js","js/client.Bht704G-.js","js/utils-vendor.B9ygI19o.js"])))=>i.map(i=>d[i]);
import{D as $n,b as Co,c as _o,d as ko,e as Tn,f as ft,a as it,S as en,_ as Je,g as Ee,s as Ce,u as ct,h as ys,i as Cs,j as _s,k as ks,l as Ss,m as ws,n as tn,o as on,B as nn,p as sn,q as $s,F as vo,r as an,t as ln,v as Ts,L as rn,W as Is}from"./index.CivuH8Tm.js";import{d as eo,r as w,c as Y,a as Ye,e as L,h as ce,f as e,t as te,i as ot,k as A,g as ut,n as Re,u as de,o as dt,v as oe,x as Oe,l as ke,s as un,m as xt,K as Xe,D as H,F as ze,j as Ge,M as So,N as Ps,L as In,w as Se,B as pt,O as kt,z as Pe,p as nt,P as ho,b as Wt,Q as yt,S as cn,U as Rs,A as Pn,V as Ds,T as Rn,C as Ms}from"./vue-vendor.J6rApW3j.js";import{p as Bs,a as As,b as Es,c as Ls,d as Fs,e as Us,f as Os,h as zs,i as Ns,j as Vs,k as wo,l as Ws,m as Dn}from"./system.p5OBdgDJ.js";import{getFontList as Mn,uploadFont as Ks,getTextboxPrompts as qs,getPrompts as Hs,configApi as He,getFontListApi as js}from"./config.CwRcCkM9.js";import{_ as Ve}from"./CustomSelect.vue_vue_type_style_index_0_lang.Dil26xem.js";import{apiClient as et}from"./client.Bht704G-.js";import{B as Bn}from"./BaseModal.DT67EPCc.js";import{getBookDetail as Js}from"./bookshelf.B4ums9uK.js";import"./utils-vendor.B9ygI19o.js";function dn(){return{firecrawl:{apiKey:""},agent:{provider:"openai",apiKey:"",customBaseUrl:"",modelName:"gpt-4o-mini",useStream:!1,forceJsonOutput:!0,maxRetries:3,timeout:120},extraction:{prompt:$n,maxIterations:10},download:{concurrency:3,timeout:30,retries:3,delay:100,useReferer:!0},imagePreprocess:{enabled:!1,autoRotate:!0,compression:{enabled:!1,quality:85,maxWidth:0,maxHeight:0},formatConvert:{enabled:!1,targetFormat:"original"}},advanced:{customCookie:"",customHeaders:"",bypassProxy:!1},ui:{showAgentLogs:!0,autoImport:!1}}}function Ys(n,t){function s(r){n.value.firecrawl.apiKey=r,t()}function o(r){n.value.agent.provider=r,t()}function a(r){n.value.agent.apiKey=r,t()}function i(r){n.value.agent.customBaseUrl=r,t()}function l(r){n.value.agent.modelName=r,t()}function m(r){n.value.agent.useStream=r,t()}function g(r){n.value.agent.forceJsonOutput=r,t()}function u(r){n.value.agent.timeout=r,t()}function b(r){n.value.extraction.prompt=r,t()}function _(r){n.value.extraction.maxIterations=r,t()}function S(){n.value.extraction.prompt=$n,t()}function R(r){n.value.download.concurrency=r,t()}function y(r){n.value.download.timeout=r,t()}function D(r){n.value.download.retries=r,t()}function V(r){n.value.download.delay=r,t()}function M(r){n.value.download.useReferer=r,t()}function B(r){n.value.imagePreprocess.enabled=r,t()}function v(r){n.value.imagePreprocess.autoRotate=r,t()}function p(r){n.value.imagePreprocess.compression.enabled=r,t()}function $(r){n.value.imagePreprocess.compression.quality=r,t()}function k(r){n.value.imagePreprocess.compression.maxWidth=r,t()}function F(r){n.value.imagePreprocess.compression.maxHeight=r,t()}function z(r){n.value.imagePreprocess.formatConvert.enabled=r,t()}function ee(r){n.value.imagePreprocess.formatConvert.targetFormat=r,t()}function J(r){n.value.advanced.customCookie=r,t()}function se(r){n.value.advanced.customHeaders=r,t()}function O(r){n.value.advanced.bypassProxy=r,t()}function Q(r){n.value.ui.showAgentLogs=r,t()}function ae(r){n.value.ui.autoImport=r,t()}function U(r){n.value={...n.value,...r},t()}return{setFirecrawlApiKey:s,setAgentProvider:o,setAgentApiKey:a,setAgentBaseUrl:i,setAgentModelName:l,setAgentUseStream:m,setAgentForceJson:g,setAgentTimeout:u,setExtractionPrompt:b,setExtractionMaxIterations:_,resetExtractionPrompt:S,setDownloadConcurrency:R,setDownloadTimeout:y,setDownloadRetries:D,setDownloadDelay:V,setDownloadUseReferer:M,setImagePreprocessEnabled:B,setImageAutoRotate:v,setImageCompressionEnabled:p,setImageCompressionQuality:$,setImageMaxWidth:k,setImageMaxHeight:F,setImageFormatConvertEnabled:z,setImageTargetFormat:ee,setCustomCookie:J,setCustomHeaders:se,setBypassProxy:O,setShowAgentLogs:Q,setAutoImport:ae,updateWebImportSettings:U}}const xo=Object.freeze(Object.defineProperty({__proto__:null,useSettingsStore:Ee},Symbol.toStringTag,{value:"Module"}));async function $o(n){return et.post("/api/re_render_image",n)}async function Ft(n){try{return{success:!0,data:await et.post("/api/translate_single_text",n)}}catch(t){return{success:!1,error:t instanceof Error?t.message:"ç¿»è¯‘å¤±è´¥"}}}async function Ut(n){return et.post("/api/hq_translate_batch",n)}async function An(n,t,s,o){return et.post("/api/ocr_single_bubble",{image_data:n,bubble_coords:t,ocr_engine:s,...o})}async function To(n,t,s){return et.post("/api/inpaint_single_bubble",{image_data:n,bubble_coords:t,bubble_angle:s?.bubbleAngle??0,method:s?.method??"lama",lama_model:s?.lamaModel??"lama_mpe",...s?.maskData&&{mask_data:s.maskData}})}const Gs=Object.freeze(Object.defineProperty({__proto__:null,hqTranslateBatch:Ut,inpaintSingleBubble:To,ocrSingleBubble:An,reRenderImage:$o,translateSingleText:Ft},Symbol.toStringTag,{value:"Module"}));async function En(n,t){return et.post(`/api/sessions/meta/${n}`,t)}async function Xt(n,t,s,o){return et.post(`/api/sessions/page/${n}/${t}/${s}`,{data:o})}async function Ln(n,t,s){return et.post(`/api/sessions/page/${n}/${t}/meta`,s)}async function Fn(n,t,s){return et.post(`/api/sessions/save_translated/${n}/${t}`,s)}function Zt(n){if(!n||typeof n!="string"||n.startsWith("/api/"))return null;if(n.startsWith("data:")){const t=n.split(",");return t.length>1?t[1]??null:null}return n}async function Xs(n,t,s){const o=t.length;let a=0;for(let i=0;i<o;i++){const l=t[i];if(l){s?.onProgress?.(i+1,o);try{const m=Zt(l.originalDataURL);m&&await Xt(n,i,"original",m);const g=Zt(l.translatedDataURL);g&&await Xt(n,i,"translated",g);const u=Zt(l.cleanImageData);u&&await Xt(n,i,"clean",u);const b={fileName:l.fileName,translationStatus:l.translationStatus,translationFailed:l.translationFailed,bubbleStates:l.bubbleStates,isManuallyAnnotated:l.isManuallyAnnotated,relativePath:l.relativePath,folderPath:l.folderPath,fontSize:l.fontSize,autoFontSize:l.autoFontSize,fontFamily:l.fontFamily,layoutDirection:l.layoutDirection,useAutoTextColor:l.useAutoTextColor,textColor:l.textColor,fillColor:l.fillColor,inpaintMethod:l.inpaintMethod,strokeEnabled:l.strokeEnabled,strokeColor:l.strokeColor,strokeWidth:l.strokeWidth,textMask:l.textMask,userMask:l.userMask};await Ln(n,i,b),a++}catch(m){console.error(`ä¿å­˜ç¬¬ ${i+1} é¡µå¤±è´¥:`,m)}}}return a}const Un=Object.freeze(Object.defineProperty({__proto__:null,extractBase64:Zt,saveAllPagesSequentially:Xs,savePageImage:Xt,savePageMeta:Ln,saveSessionMeta:En,saveTranslatedPage:Fn},Symbol.toStringTag,{value:"Module"}));async function Zs(){return et.get("/api/plugins")}async function Qs(n){const t=encodeURIComponent(n);return et.post(`/api/plugins/${t}/enable`)}async function ea(n){const t=encodeURIComponent(n);return et.post(`/api/plugins/${t}/disable`)}async function ta(n){const t=encodeURIComponent(n);return et.delete(`/api/plugins/${t}`)}async function oa(n){const t=encodeURIComponent(n);return et.get(`/api/plugins/${t}/config_schema`)}async function na(n){const t=encodeURIComponent(n);return et.get(`/api/plugins/${t}/config`)}async function sa(n,t){const s=encodeURIComponent(n);return et.post(`/api/plugins/${s}/config`,t)}async function aa(){return et.get("/api/plugins/default_states")}async function la(n,t){const s=encodeURIComponent(n);return et.post(`/api/plugins/${s}/set_default_state`,{enabled:t})}async function ia(){return{states:(await aa()).default_states}}const ra=la,ua=oa,ca=na,da=sa;function ga(){return`img_${Date.now()}_${Math.random().toString(36).substring(2,9)}`}function gn(n,t,s){return{id:ga(),fileName:n,width:0,height:0,originalDataURL:t,translatedDataURL:null,cleanImageData:null,bubbleStates:null,translationStatus:"pending",translationFailed:!1,fontSize:25,autoFontSize:!1,fontFamily:ft,layoutDirection:"auto",textColor:"#000000",fillColor:Tn,inpaintMethod:"solid",strokeEnabled:ko,strokeColor:_o,strokeWidth:Co,hasUnsavedChanges:!1,...s}}const Ze=eo("image",()=>{const n=w([]),t=w(-1),s=w(!1),o=Y(()=>t.value>=0&&t.value<n.value.length?n.value[t.value]??null:null),a=Y(()=>n.value.length),i=Y(()=>n.value.length>0),l=Y(()=>t.value>0),m=Y(()=>t.value<n.value.length-1),g=Y(()=>n.value.filter(d=>d.translationFailed).length),u=Y(()=>n.value.filter(d=>d.translationStatus==="completed").length),b=Y(()=>n.value.filter(d=>d.translationStatus==="pending").length);function _(d,f,C){const x=gn(d,f,C);return n.value.push(x),n.value.length===1&&(t.value=0),console.log(`å›¾ç‰‡å·²æ·»åŠ : ${d}ï¼Œå½“å‰å…± ${n.value.length} å¼ å›¾ç‰‡`),x}function S(d){const f=d.map(({fileName:x,originalDataURL:P,overrides:I})=>gn(x,P,I)),C=n.value.length===0;return n.value.push(...f),C&&n.value.length>0&&(t.value=0),console.log(`æ‰¹é‡æ·»åŠ äº† ${f.length} å¼ å›¾ç‰‡ï¼Œå½“å‰å…± ${n.value.length} å¼ `),f}function R(d){n.value=d.map(f=>({...f,width:f.width||0,height:f.height||0,strokeEnabled:f.strokeEnabled??ko,strokeColor:f.strokeColor||_o,strokeWidth:f.strokeWidth??Co,hasUnsavedChanges:f.hasUnsavedChanges||!1})),n.value.length>0?t.value=Math.min(Math.max(0,t.value),n.value.length-1):t.value=-1,console.log(`å›¾ç‰‡æ•°ç»„å·²è®¾ç½®ï¼Œå…± ${n.value.length} å¼ å›¾ç‰‡`)}function y(d){return d<0||d>=n.value.length?(console.warn(`åˆ é™¤å¤±è´¥: æ— æ•ˆçš„ç´¢å¼• ${d}`),!1):(n.value.splice(d,1),t.value===d?(t.value=Math.min(d,n.value.length-1),n.value.length===0&&(t.value=-1)):t.value>d&&t.value--,console.log(`å›¾ç‰‡å·²åˆ é™¤ï¼Œå½“å‰å…± ${n.value.length} å¼ å›¾ç‰‡`),!0)}function D(){return y(t.value)}function V(){n.value=[],t.value=-1,s.value=!1,console.log("æ‰€æœ‰å›¾ç‰‡å·²æ¸…é™¤")}function M(){const d=o.value?.id||null;if(n.value.sort((f,C)=>f.fileName.localeCompare(C.fileName,void 0,{numeric:!0,sensitivity:"base"})),d){const f=n.value.findIndex(C=>C.id===d);f>=0&&f!==t.value&&(console.log(`å›¾ç‰‡æ’åº: currentImageIndex ä» ${t.value} æ›´æ–°ä¸º ${f}`),t.value=f)}console.log("å›¾ç‰‡å·²æŒ‰æ–‡ä»¶åæ’åº")}function B(d){d>=-1&&d<n.value.length?(t.value=d,console.log(`å½“å‰å›¾ç‰‡ç´¢å¼•å·²è®¾ç½®ä¸º ${d}`)):console.warn(`è®¾ç½®ç´¢å¼•å¤±è´¥: æ— æ•ˆçš„ç´¢å¼• ${d}`)}function v(){return l.value?(t.value--,!0):!1}function p(){return m.value?(t.value++,!0):!1}function $(d){o.value?(Object.assign(o.value,d),console.log("å½“å‰å›¾ç‰‡å±æ€§å·²æ›´æ–°:",Object.keys(d))):console.warn("æ›´æ–°å¤±è´¥: å½“å‰æ²¡æœ‰é€‰ä¸­çš„å›¾ç‰‡")}function k(d,f){if(d>=0&&d<n.value.length){const C=n.value[d];C&&(Object.assign(C,f),console.log(`å›¾ç‰‡ ${d} å±æ€§å·²æ›´æ–°:`,Object.keys(f)))}else console.warn(`æ›´æ–°å¤±è´¥: æ— æ•ˆçš„ç´¢å¼• ${d}`)}function F(d){o.value&&(o.value.bubbleStates=d,o.value.hasUnsavedChanges=!0,console.log(`å½“å‰å›¾ç‰‡æ°”æ³¡çŠ¶æ€å·²æ›´æ–°ï¼Œå…± ${d?.length??0} ä¸ªæ°”æ³¡`))}function z(d){o.value&&(o.value.isManuallyAnnotated=d,o.value.hasUnsavedChanges=!0,console.log(`æ‰‹åŠ¨æ ‡æ³¨æ ‡è®°å·²è®¾ç½®ä¸º: ${d}`))}function ee(d,f){o.value?(o.value[d]=f,o.value.hasUnsavedChanges=!0,console.log(`å½“å‰å›¾ç‰‡å±æ€§ ${String(d)} å·²æ›´æ–°`)):console.warn("æ›´æ–°å¤±è´¥: å½“å‰æ²¡æœ‰é€‰ä¸­çš„å›¾ç‰‡")}function J(d,f){o.value&&(o.value.translatedDataURL=d,f&&(o.value.cleanImageData=f),o.value.translationStatus="completed",o.value.translationFailed=!1,o.value.hasUnsavedChanges=!0,console.log("å½“å‰å›¾ç‰‡ç¿»è¯‘ç»“æœå·²æ›´æ–°"))}function se(d,f){o.value&&(o.value.width=d,o.value.height=f,console.log(`å½“å‰å›¾ç‰‡å°ºå¯¸å·²æ›´æ–°: ${d} x ${f}`))}function O(d,f,C){if(d>=0&&d<n.value.length){const x=n.value[d];x&&(x.translationStatus=f,x.translationFailed=f==="failed",C&&(x.errorMessage=C),console.log(`å›¾ç‰‡ ${d} ç¿»è¯‘çŠ¶æ€: ${f}`))}}function Q(d){o.value&&(o.value.translationStatus="failed",o.value.translationFailed=!0,o.value.errorMessage=d,console.log(`å½“å‰å›¾ç‰‡ç¿»è¯‘å¤±è´¥: ${d}`))}function ae(){n.value.forEach(d=>{d.translationStatus="pending",d.translationFailed=!1,d.errorMessage=void 0}),console.log("æ‰€æœ‰å›¾ç‰‡ç¿»è¯‘çŠ¶æ€å·²é‡ç½®")}function U(d){s.value=d,console.log(`æ‰¹é‡ç¿»è¯‘çŠ¶æ€: ${d?"è¿›è¡Œä¸­":"å·²å®Œæˆ"}`)}function r(){return n.value.map((d,f)=>d.translationFailed?f:-1).filter(d=>d!==-1)}return{images:n,currentImageIndex:t,isBatchTranslationInProgress:s,currentImage:o,imageCount:a,hasImages:i,canGoPrevious:l,canGoNext:m,failedImageCount:g,completedImageCount:u,pendingImageCount:b,addImage:_,addImages:S,setImages:R,deleteImage:y,deleteCurrentImage:D,clearImages:V,sortImagesByFileName:M,setCurrentImageIndex:B,goToPrevious:v,goToNext:p,updateCurrentImage:$,updateImageByIndex:k,updateCurrentBubbleStates:F,setManuallyAnnotated:z,updateCurrentImageProperty:ee,updateCurrentTranslationResult:J,updateCurrentImageDimensions:se,setTranslationStatus:O,markCurrentAsFailed:Q,resetAllTranslationStatus:ae,setBatchTranslationInProgress:U,getFailedImageIndices:r}}),pn=Object.freeze(Object.defineProperty({__proto__:null,useImageStore:Ze},Symbol.toStringTag,{value:"Module"})),wt=eo("session",()=>{const n=w(null),t=w({bookId:null,chapterId:null,bookTitle:null,chapterTitle:null}),s=w([]),o=w(!1),a=w({current:0,total:0,message:""}),i=w(null),l=w(!1),m=Y(()=>t.value.bookId!==null&&t.value.chapterId!==null),g=Y(()=>t.value.bookId),u=Y(()=>t.value.chapterId);function b(O,Q,ae=null,U=null){t.value={bookId:O,chapterId:Q,bookTitle:ae,chapterTitle:U},console.log(`ä¼šè¯ä¸Šä¸‹æ–‡å·²è®¾ç½®: ä¹¦ç±=${O}, ç« èŠ‚=${Q}`)}function _(O,Q,ae,U){b(O,Q,ae,U)}function S(){t.value={bookId:null,chapterId:null,bookTitle:null,chapterTitle:null},console.log("ä¼šè¯ä¸Šä¸‹æ–‡å·²æ¸…é™¤")}function R(O){const Q=O.get("book"),ae=O.get("chapter");Q&&ae&&b(Q,ae)}function y(O){n.value=O,console.log(`å½“å‰ä¼šè¯åç§°: ${O}`)}function D(){n.value=null}function V(O){s.value=O,console.log(`ä¼šè¯åˆ—è¡¨å·²æ›´æ–°ï¼Œå…± ${O.length} ä¸ªä¼šè¯`)}function M(O){const Q=s.value.findIndex(ae=>ae.name===O.name);Q>=0?s.value[Q]=O:s.value.unshift(O)}function B(O){const Q=s.value.findIndex(ae=>ae.name===O);Q>=0&&s.value.splice(Q,1)}function v(O,Q){const ae=s.value.find(U=>U.name===O);ae&&(ae.name=Q)}function p(O){o.value=O}function $(O){l.value=O}function k(O){i.value=O}function F(){n.value=null,t.value={bookId:null,chapterId:null,bookTitle:null,chapterTitle:null},s.value=[],o.value=!1,l.value=!1,i.value=null,console.log("ä¼šè¯çŠ¶æ€å·²é‡ç½®")}async function z(O){if(!O||typeof O!="string")return null;if(O.startsWith("data:"))return O;if(!O.startsWith("/api/"))return null;try{const Q=await fetch(O);if(!Q.ok)return null;const ae=await Q.blob();return new Promise(U=>{const r=new FileReader;r.onloadend=()=>U(r.result),r.onerror=()=>U(null),r.readAsDataURL(ae)})}catch(Q){return console.error(`è½¬æ¢å›¾ç‰‡ URL å¤±è´¥: ${O}`,Q),null}}async function ee(O,Q){const ae=O.length;for(let U=0;U<ae;U++){const r=O[U];if(r){if(Q&&Q(U+1,ae),r.originalDataURL&&r.originalDataURL.startsWith("/api/")){const d=await z(r.originalDataURL);d&&(r.originalDataURL=d)}if(r.translatedDataURL&&r.translatedDataURL.startsWith("/api/")){const d=await z(r.translatedDataURL);d&&(r.translatedDataURL=d)}if(r.cleanImageData&&r.cleanImageData.startsWith("/api/")){const d=await z(r.cleanImageData);d&&(r.cleanImageData=d.replace(/^data:image\/\w+;base64,/,""))}}}}async function J(O){p(!0),k(null),a.value={current:0,total:0,message:"æ­£åœ¨åŠ è½½..."};try{const{useImageStore:Q}=await it(async()=>{const{useImageStore:E}=await Promise.resolve().then(()=>pn);return{useImageStore:E}},void 0),{useSettingsStore:ae}=await it(async()=>{const{useSettingsStore:E}=await Promise.resolve().then(()=>xo);return{useSettingsStore:E}},void 0),{useBubbleStore:U}=await it(async()=>{const{useBubbleStore:E}=await Promise.resolve().then(()=>_i);return{useBubbleStore:E}},void 0),r=Q(),d=ae(),f=U(),{loadSessionByPathApi:C}=await it(async()=>{const{loadSessionByPathApi:E}=await import("./session.C_VZSWrV.js");return{loadSessionByPathApi:E}},__vite__mapDeps([0,1,2])),x=await C(O);if(!x.success||!x.session)throw new Error(x.error||"åŠ è½½ä¼šè¯å¤±è´¥");const P=x.session;if(P.images&&P.images.length>0){const E=P.images.map((c,h)=>({id:`session-${h}-${Date.now()}`,originalDataURL:c.originalDataURL,translatedDataURL:c.translatedDataURL||null,cleanImageData:c.cleanImageData||null,width:c.width||void 0,height:c.height||void 0,bubbleStates:c.bubbleStates!==void 0&&c.bubbleStates!==null?c.bubbleStates:null,isManuallyAnnotated:!!c.isManuallyAnnotated,relativePath:c.relativePath||void 0,folderPath:c.folderPath||void 0,fileName:c.fileName||`image-${h+1}.png`,translationStatus:c.translationStatus||"pending",translationFailed:!!c.translationFailed,hasUnsavedChanges:!1,fontSize:c.fontSize||24,autoFontSize:c.autoFontSize??!1,fontFamily:c.fontFamily||"Microsoft YaHei",layoutDirection:c.layoutDirection||"auto",useAutoTextColor:c.useAutoTextColor??void 0,textColor:c.textColor||"#000000",fillColor:c.fillColor||"#FFFFFF",inpaintMethod:c.inpaintMethod||"litelama",strokeEnabled:c.strokeEnabled??!1,strokeColor:c.strokeColor||"#FFFFFF",strokeWidth:c.strokeWidth||2,textMask:c.textMask||null,userMask:c.userMask||null}));E.length>0&&(console.log("æ­£åœ¨åŠ è½½å›¾ç‰‡..."),a.value={current:0,total:E.length,message:"æ­£åœ¨åŠ è½½å›¾ç‰‡..."},await ee(E,(c,h)=>{const le=c/h*100;a.value={current:c,total:h,message:`åŠ è½½å›¾ç‰‡ ${c}/${h}...`},console.log(`åŠ è½½å›¾ç‰‡ ${c}/${h}... (${le.toFixed(0)}%)`)}),a.value={current:E.length,total:E.length,message:"åŠ è½½å®Œæˆ"},console.log("å›¾ç‰‡åŠ è½½å®Œæˆï¼Œå·²è½¬æ¢ä¸º Base64"),setTimeout(()=>{a.value={current:0,total:0,message:""}},500)),r.setImages(E);let K=0;typeof P.currentImageIndex=="number"&&(K=P.currentImageIndex,(K>=E.length||K<0)&&(K=E.length>0?0:-1)),r.setCurrentImageIndex(K);const G=E[K];G&&G.bubbleStates&&G.bubbleStates.length>0?f.setBubbles(G.bubbleStates,!0):f.clearBubblesLocal(),console.log(`æŒ‰è·¯å¾„åŠ è½½ä¼šè¯æˆåŠŸ: ${O}, å…± ${E.length} å¼ å›¾ç‰‡`)}const I=P.ui_settings;if(I){(I.targetLanguage||I.sourceLanguage)&&d.updateSettings({targetLanguage:I.targetLanguage||void 0,sourceLanguage:I.sourceLanguage||void 0});const E=I.useInpaintingMethod,G=["solid","lama_mpe","litelama"].includes(E)?E:d.settings.textStyle.inpaintMethod;d.updateTextStyle({fontSize:I.fontSize||d.settings.textStyle.fontSize,autoFontSize:I.autoFontSize??d.settings.textStyle.autoFontSize,fontFamily:I.fontFamily||d.settings.textStyle.fontFamily,layoutDirection:I.layoutDirection||d.settings.textStyle.layoutDirection,textColor:I.textColor||d.settings.textStyle.textColor,fillColor:I.fillColor||d.settings.textStyle.fillColor,inpaintMethod:G,strokeEnabled:I.strokeEnabled??d.settings.textStyle.strokeEnabled,strokeColor:I.strokeColor||d.settings.textStyle.strokeColor,strokeWidth:I.strokeWidth||d.settings.textStyle.strokeWidth,useAutoTextColor:I.useAutoTextColor??d.settings.textStyle.useAutoTextColor}),console.log("UI è®¾ç½®å·²æ¢å¤")}return y(O),!0}catch(Q){const ae=Q instanceof Error?Q.message:"åŠ è½½ä¼šè¯å¤±è´¥";throw k(ae),console.error(`æŒ‰è·¯å¾„åŠ è½½ä¼šè¯å¤±è´¥: ${O}`,Q),Q}finally{p(!1)}}async function se(O,Q){if(!O||!Q)return console.log("æœªåœ¨ä¹¦ç±/ç« èŠ‚æ¨¡å¼ï¼Œä¸æ”¯æŒä¿å­˜"),!1;console.log(`ä¿å­˜ç« èŠ‚ä¼šè¯: book=${O}, chapter=${Q}`);const{useImageStore:ae}=await it(async()=>{const{useImageStore:P}=await Promise.resolve().then(()=>pn);return{useImageStore:P}},void 0),{useSettingsStore:U}=await it(async()=>{const{useSettingsStore:P}=await Promise.resolve().then(()=>xo);return{useSettingsStore:P}},void 0),r=ae(),d=U(),f=Array.isArray(r.images)?r.images:[];if(!f||f.length===0)return console.log("æ²¡æœ‰å›¾ç‰‡æ•°æ®å¯ä¿å­˜"),!1;const C=`bookshelf/${O}/${Q}`;$(!0),k(null);const x=f.length;a.value={current:0,total:x,message:`å‡†å¤‡ä¿å­˜ ${x} å¼ å›¾ç‰‡...`};try{f.some(h=>h.originalDataURL&&h.originalDataURL.startsWith("/api/")||h.translatedDataURL&&h.translatedDataURL.startsWith("/api/")||h.cleanImageData&&h.cleanImageData.startsWith("/api/"))&&(console.log("[saveChapterSession] æ£€æµ‹åˆ° /api/ URL æ ¼å¼å›¾ç‰‡ï¼Œå¼€å§‹è½¬æ¢ä¸º Base64..."),a.value={current:0,total:x,message:"è½¬æ¢å›¾ç‰‡æ ¼å¼..."},await ee(f,(h,le)=>{a.value={current:0,total:x,message:`è½¬æ¢å›¾ç‰‡ ${h}/${le}...`}}),console.log("[saveChapterSession] å›¾ç‰‡æ ¼å¼è½¬æ¢å®Œæˆ"));const{textStyle:I}=d.settings,E={fontSize:I.fontSize,autoFontSize:I.autoFontSize,fontFamily:I.fontFamily,layoutDirection:I.layoutDirection,textColor:I.textColor,useInpaintingMethod:I.inpaintMethod,fillColor:I.fillColor,strokeEnabled:I.strokeEnabled,strokeColor:I.strokeColor,strokeWidth:I.strokeWidth,useAutoTextColor:I.useAutoTextColor},{saveAllPagesSequentially:K,saveSessionMeta:G}=await it(async()=>{const{saveAllPagesSequentially:h,saveSessionMeta:le}=await Promise.resolve().then(()=>Un);return{saveAllPagesSequentially:h,saveSessionMeta:le}},void 0),c=await K(C,f,{onProgress:(h,le)=>{a.value={current:h,total:le,message:`ä¿å­˜å›¾ç‰‡ ${h}/${le}...`}}});a.value={current:x,total:x,message:"å®Œæˆä¿å­˜..."},await G(C,{ui_settings:E,total_pages:x,currentImageIndex:r.currentImageIndex}),console.log(`ç« èŠ‚ä¿å­˜å®Œæˆ: ${c}/${x} å¼ å›¾ç‰‡`);try{const{apiClient:h}=await it(async()=>{const{apiClient:le}=await import("./client.Bht704G-.js");return{apiClient:le}},__vite__mapDeps([1,2]));await h.put(`/api/bookshelf/books/${O}/chapters/${Q}/image-count`,{count:x})}catch(h){console.warn("æ›´æ–°ç« èŠ‚å›¾ç‰‡æ•°é‡å¤±è´¥ï¼ˆéè‡´å‘½ï¼‰:",h)}return a.value={current:x,total:x,message:"ä¿å­˜å®Œæˆ"},setTimeout(()=>{a.value={current:0,total:0,message:""}},1e3),!0}catch(P){const I=P instanceof Error?P.message:"ä¿å­˜ç« èŠ‚ä¼šè¯å¤±è´¥";return k(I),console.error("ä¿å­˜å¤±è´¥:",P),a.value={current:0,total:0,message:""},!1}finally{$(!1)}}return{currentSessionName:n,context:t,sessionList:s,isLoading:o,isSaving:l,error:i,loadingProgress:a,isBookshelfMode:m,currentBookId:g,currentChapterId:u,setContext:b,clearContext:S,parseContextFromUrl:R,setSessionName:y,clearSessionName:D,setSessionList:V,addToSessionList:M,removeFromSessionList:B,renameInSessionList:v,setLoading:p,setSaving:$,setError:k,imageUrlToBase64:z,saveChapterSession:se,loadSessionByPath:J,setBookChapterContext:_,reset:F}}),qt={originalText:"",translatedText:"",textboxText:"",coords:[0,0,100,100],polygon:[],fontSize:25,fontFamily:ft,textDirection:"vertical",autoTextDirection:"vertical",textColor:"#000000",fillColor:Tn,rotationAngle:0,position:{x:0,y:0},strokeEnabled:ko,strokeColor:_o,strokeWidth:Co,inpaintMethod:"solid",autoFgColor:null,autoBgColor:null,colorConfidence:0};function pa(n){return{...{...qt,...n},coords:n?.coords?[...n.coords]:[...qt.coords],polygon:n?.polygon?n.polygon.map(s=>[...s]):[],position:n?.position?{...qt.position,...n.position}:{...qt.position}}}function ma(n){const[t,s,o,a]=n,i=Math.abs(o-t);return Math.abs(a-s)>i?"vertical":"horizontal"}function Ht(n){return n.map(t=>({...t,coords:[...t.coords],polygon:t.polygon?t.polygon.map(s=>[...s]):[],position:{...t.position},autoFgColor:t.autoFgColor?[...t.autoFgColor]:null,autoBgColor:t.autoBgColor?[...t.autoBgColor]:null}))}function va(n){if(!n||typeof n!="object")return!1;const t=n;if(!Array.isArray(t.coords)||t.coords.length!==4||!t.coords.every(a=>typeof a=="number"&&!isNaN(a))||typeof t.fontSize!="number"||t.fontSize<=0)return!1;const s=["vertical","horizontal","auto"];if(typeof t.textDirection!="string"||!s.includes(t.textDirection))return!1;const o=["solid","lama_mpe","litelama"];return!(typeof t.inpaintMethod!="string"||!o.includes(t.inpaintMethod))}function fa(n){let t=n,s=0,o=0,a=Date.now();const i=()=>t<=0?0:Math.ceil(6e4/t);return{async acquire(){if(t<=0)return;const l=Date.now(),m=i();if(l-a>=6e4&&(a=l,o=0),o>=t){const u=6e4-(l-a);u>0&&await mn(u),a=Date.now(),o=0}const g=l-s;g<m&&await mn(m-g),s=Date.now(),o++},reset(){s=0,o=0,a=Date.now()},getRpm(){return t},setRpm(l){t=l,this.reset()}}}function mn(n){return new Promise(t=>setTimeout(t,n))}function vn(n){const t=n.replace(/\\/g,"/"),s=[],o=/(\d+)/g;let a=0,i;for(;(i=o.exec(t))!==null;){if(i.index>a){const l=t.slice(a,i.index);l&&s.push([!0,l.toLowerCase()])}s.push([!1,parseInt(i[0],10)]),a=o.lastIndex}if(a<t.length){const l=t.slice(a);l&&s.push([!0,l.toLowerCase()])}return s}function ba(n,t){const s=vn(n),o=vn(t),a=Math.min(s.length,o.length);for(let i=0;i<a;i++){const[l,m]=s[i],[g,u]=o[i];if(l!==g)return l?1:-1;if(m<u)return-1;if(m>u)return 1}return s.length-o.length}function ha(n,t=s=>String(s)){return[...n].sort((s,o)=>ba(t(s),t(o)))}const fn="webImportDisclaimerAccepted",Io=eo("webImport",()=>{const n=w(dn()),t=w("idle"),s=w(""),o=w([]),a=w(null),i=w(new Set),l=w({current:0,total:0}),m=w([]),g=w(null),u=w(!1),b=w(!1),_=w(!1),S=Y(()=>t.value==="extracting"),R=Y(()=>t.value==="downloading"),y=Y(()=>S.value||R.value),D=Y(()=>i.value.size),V=Y(()=>l.value.total===0?0:Math.round(l.value.current/l.value.total*100));function M(){try{localStorage.setItem(en,JSON.stringify(n.value))}catch(I){console.error("ä¿å­˜ç½‘é¡µå¯¼å…¥è®¾ç½®å¤±è´¥:",I)}}function B(){try{const I=localStorage.getItem(en);if(I){const E=JSON.parse(I);n.value=v(dn(),E)}}catch(I){console.error("åŠ è½½ç½‘é¡µå¯¼å…¥è®¾ç½®å¤±è´¥:",I)}}function v(I,E){const K={...I};for(const G in E)if(Object.prototype.hasOwnProperty.call(E,G)){const c=E[G],h=I[G];c!==null&&typeof c=="object"&&!Array.isArray(c)&&h!==null&&typeof h=="object"&&!Array.isArray(h)?K[G]=v(h,c):c!==void 0&&(K[G]=c)}return K}function p(){b.value?u.value=!0:_.value=!0}function $(){b.value=!0,_.value=!1,u.value=!0;try{localStorage.setItem(fn,"true")}catch(I){console.error("ä¿å­˜å…è´£å£°æ˜çŠ¶æ€å¤±è´¥:",I)}}function k(){_.value=!1}function F(){try{const I=localStorage.getItem(fn);b.value=I==="true"}catch(I){console.error("åŠ è½½å…è´£å£°æ˜çŠ¶æ€å¤±è´¥:",I)}}function z(){u.value=!1}function ee(){t.value="idle",s.value="",o.value=[],a.value=null,i.value=new Set,l.value={current:0,total:0},m.value=[],g.value=null}function J(I){s.value=I}function se(I){o.value.push(I)}function O(){o.value=[]}function Q(I){a.value&&a.value.pages.length>0?(a.value.comicTitle=I.comicTitle,a.value.chapterTitle=I.chapterTitle,a.value.totalPages=I.totalPages,a.value.sourceUrl=I.sourceUrl,a.value.referer=I.referer,a.value.engine=I.engine,a.value.success=I.success,a.value.error=I.error):(a.value=I,I.success&&I.pages&&(i.value=new Set(I.pages.map(E=>E.pageNumber))))}function ae(I){i.value.has(I)?i.value.delete(I):i.value.add(I),i.value=new Set(i.value)}function U(){a.value?.pages&&(i.value.size===a.value.pages.length?i.value=new Set:i.value=new Set(a.value.pages.map(I=>I.pageNumber)))}function r(I){t.value=I}function d(I){g.value=I,I&&(t.value="error")}function f(I,E){l.value={current:I,total:E}}function C(I){m.value=I}function x(I){a.value||(a.value={success:!0,comicTitle:"",chapterTitle:"",pages:[],totalPages:0,sourceUrl:s.value,referer:"",engine:"gallery-dl"}),a.value.pages.push(I),a.value.totalPages=a.value.pages.length,i.value.add(I.pageNumber),i.value=new Set(i.value)}const P=Ys(n,M);return B(),F(),{settings:n,status:t,url:s,logs:o,extractResult:a,selectedPages:i,downloadProgress:l,downloadedImages:m,error:g,modalVisible:u,disclaimerAccepted:b,disclaimerVisible:_,isExtracting:S,isDownloading:R,isProcessing:y,selectedCount:D,downloadProgressPercent:V,saveToStorage:M,loadFromStorage:B,openModal:p,closeModal:z,resetState:ee,setUrl:J,addLog:se,clearLogs:O,setExtractResult:Q,togglePageSelection:ae,toggleSelectAll:U,setStatus:r,setError:d,updateDownloadProgress:f,setDownloadedImages:C,addPageIncremental:x,acceptDisclaimer:$,rejectDisclaimer:k,...P}}),xa={key:0,class:"translation-progress-bar"},ya={class:"progress-bar-label"},Ca={class:"progress-bar"},_a=Ye({__name:"ProgressBar",props:{visible:{type:Boolean,default:!0},percentage:{},label:{default:"è¿›åº¦"}},setup(n){return(t,s)=>n.visible?(A(),L("div",xa,[e("div",ya,te(n.label),1),e("div",Ca,[e("div",{class:"progress",style:ot({width:`${n.percentage}%`})},null,4)])])):ce("",!0)}}),Po=Je(_a,[["__scopeId","data-v-f915cadf"]]),ka={class:"image-upload"},Sa={class:"error-text"},wa={key:2,class:"loading-overlay"},$a=Ye({__name:"ImageUpload",emits:["uploadComplete"],setup(n,{expose:t,emit:s}){const o=s,a=Ze(),i=Ee(),l=Io(),m=w(null),g=w(null),u=w(!1),b=w(!1),_=w(""),S=w(0),R=w(""),y=w(!1),D=Y(()=>i.settings.pdfProcessingMethod);function V(){m.value?.click()}function M(){l.openModal()}function B(){g.value?.click()}async function v(d){const f=d.target;if(!f.files||f.files.length===0)return;const x=Array.from(f.files).filter(I=>I.type.startsWith("image/"));if(x.length===0){Ce("æ‰€é€‰æ–‡ä»¶å¤¹ä¸­æ²¡æœ‰æ‰¾åˆ°å›¾ç‰‡æ–‡ä»¶","warning"),f.value="";return}const P=ha(x,I=>I.webkitRelativePath);console.log(`ä»æ–‡ä»¶å¤¹å¯¼å…¥ ${P.length} å¼ å›¾ç‰‡`),await p(P),f.value=""}async function p(d){if(d.length!==0){u.value=!0,y.value=!0,S.value=0;try{let f=0;const C=d.length;for(let x=0;x<d.length;x++){const P=d[x];if(!P||!P.type.startsWith("image/"))continue;R.value=P.name;const I=P.webkitRelativePath||"",E=I.includes("/")?I.substring(0,I.lastIndexOf("/")):"";await new Promise((K,G)=>{const c=new FileReader;c.onload=h=>{const le=h.target?.result;a.addImage(P.name,le,{relativePath:I,folderPath:E}),K()},c.onerror=()=>G(new Error(`è¯»å–å›¾ç‰‡å¤±è´¥: ${P.name}`)),c.readAsDataURL(P)}),f++,S.value=Math.round((x+1)/C*100)}f>0&&(Ce(`å·²æ·»åŠ  ${f} å¼ å›¾ç‰‡`,"success"),o("uploadComplete",f))}catch(f){console.error("å¤„ç†æ–‡ä»¶å¤±è´¥:",f);const C=f instanceof Error?f.message:"å¤„ç†æ–‡ä»¶å¤±è´¥";Ce(C,"error")}finally{u.value=!1,y.value=!1}}}async function $(d){const f=d.target;!f.files||f.files.length===0||(await ee(Array.from(f.files)),f.value="")}async function k(d){d.preventDefault(),b.value=!1,!(!d.dataTransfer?.files||d.dataTransfer.files.length===0)&&await ee(Array.from(d.dataTransfer.files))}function F(d){d.preventDefault(),b.value=!0}function z(d){const f=d.currentTarget.getBoundingClientRect(),C=d.clientX,x=d.clientY;(C<f.left||C>f.right||x<f.top||x>f.bottom)&&(b.value=!1)}async function ee(d){if(d.length!==0){u.value=!0,_.value="",y.value=!0,S.value=0;try{let f=0;const C=d.length;for(let x=0;x<d.length;x++){const P=d[x];if(!P)continue;R.value=P.name;const I=P.type,E=P.name.toLowerCase();if(I.startsWith("image/"))await J(P),f++;else if(I==="application/pdf"||E.endsWith(".pdf")){const K=await se(P);f+=K}else if(E.endsWith(".mobi")||E.endsWith(".azw")||E.endsWith(".azw3")){const K=await U(P);f+=K}else console.warn(`ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹: ${P.name}`),Ce(`ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹: ${P.name}`,"warning");S.value=Math.round((x+1)/C*100)}f>0&&(Ce(`å·²æ·»åŠ  ${f} å¼ å›¾ç‰‡`,"success"),o("uploadComplete",f))}catch(f){console.error("å¤„ç†æ–‡ä»¶å¤±è´¥:",f);const C=f instanceof Error?f.message:"å¤„ç†æ–‡ä»¶å¤±è´¥ï¼Œè¯·é‡è¯•";_.value=C,Ce(C,"error")}finally{u.value=!1,y.value=!1,R.value=""}}}async function J(d){return new Promise((f,C)=>{const x=new FileReader;x.onload=P=>{const I=P.target?.result;a.addImage(d.name,I),f()},x.onerror=()=>C(new Error(`è¯»å–å›¾ç‰‡æ–‡ä»¶å¤±è´¥: ${d.name}`)),x.readAsDataURL(d)})}async function se(d){return D.value==="frontend"?await Q(d):await ae(d)}function O(d){return new Promise((f,C)=>{const x=new FileReader;x.onload=()=>f(x.result),x.onerror=C,x.readAsDataURL(d)})}async function Q(d){try{const f=await it(()=>import("./pdf.U7tdldy2.js").then(K=>K.p),[]);f.GlobalWorkerOptions.workerSrc=`https://cdnjs.cloudflare.com/ajax/libs/pdf.js/${f.version}/pdf.worker.min.js`;const C=await d.arrayBuffer(),x=await f.getDocument({data:C}).promise,P=x.numPages;console.log(`PDF ${d.name} å…± ${P} é¡µï¼Œå¼€å§‹æœ¬åœ°æ¸²æŸ“...`),Ce(`æ­£åœ¨è§£æ PDFï¼Œå…± ${P} é¡µ...`,"info");const I=typeof OffscreenCanvas<"u";I&&console.log("ä½¿ç”¨ OffscreenCanvas åå°æ¸²æŸ“æ¨¡å¼");let E=0;for(let K=1;K<=P;K++){R.value=`${d.name} - ç¬¬ ${K}/${P} é¡µ`,S.value=Math.round(K/P*100);try{const G=await x.getPage(K),h=G.getViewport({scale:2});let le;if(I){const X=new OffscreenCanvas(h.width,h.height),pe=X.getContext("2d");await G.render({canvasContext:pe,viewport:h}).promise;const ye=await X.convertToBlob({type:"image/jpeg",quality:1});le=await O(ye)}else{const X=document.createElement("canvas"),pe=X.getContext("2d");X.width=h.width,X.height=h.height,await G.render({canvasContext:pe,viewport:h}).promise,le=X.toDataURL("image/jpeg",1)}const N=`${d.name}_é¡µé¢${K}`;a.addImage(N,le),E++,console.log(`  é¡µé¢ ${K}/${P} å¤„ç†å®Œæˆ`)}catch(G){console.warn(`PDF ${d.name} ç¬¬ ${K} é¡µæ¸²æŸ“å¤±è´¥:`,G)}}return console.log(`PDF ${d.name} å…¨éƒ¨ ${P} é¡µå¤„ç†å®Œæˆ`),E}catch(f){return console.error("å‰ç«¯ PDF è§£æå¤±è´¥:",f),Ce("å‰ç«¯ PDF è§£æå¤±è´¥ï¼Œå°è¯•ä½¿ç”¨åç«¯è§£æ...","warning"),await ae(d)}}async function ae(d){let C=null;try{Ce("æ­£åœ¨ä¸Šä¼  PDF æ–‡ä»¶...","info");const x=await Bs(d,5);if(!x.success||!x.session_id)throw new Error(x.error||"PDF è§£æå¯åŠ¨å¤±è´¥");C=x.session_id;const P=x.total_pages||0;console.log(`PDF ${d.name} å…± ${P} é¡µï¼Œå¼€å§‹åç«¯åˆ†æ‰¹è§£æ...`),Ce(`æ­£åœ¨è§£æ PDFï¼Œå…± ${P} é¡µ...`,"info");let I=0;for(let E=0;E<P;E+=5){R.value=`${d.name} - å¤„ç†ä¸­ ${Math.min(E+5,P)}/${P} é¡µ`,S.value=P>0?Math.round(E/P*100):0;const K=await As(C,E,5);if(!K.success){console.warn(`æ‰¹æ¬¡ ${E} è·å–å¤±è´¥:`,K.error);continue}if(K.images&&K.images.length>0)for(const G of K.images){if(!G||!G.data_url)continue;const c=`${d.name}_é¡µé¢${String(G.page_index+1).padStart(4,"0")}`;a.addImage(c,G.data_url),I++}console.log(`  å·²åŠ è½½ ${I}/${P} é¡µ`)}return console.log(`PDF ${d.name} å…¨éƒ¨ ${I} é¡µå¤„ç†å®Œæˆ`),I}catch(x){throw console.error("åç«¯ PDF è§£æå¤±è´¥:",x),x}finally{if(C)try{await Es(C)}catch(x){console.warn("PDF ä¼šè¯æ¸…ç†å¤±è´¥:",x)}}}async function U(d){let f=null;try{Ce("æ­£åœ¨ä¸Šä¼ ç”µå­ä¹¦æ–‡ä»¶...","info");const C=await Ls(d,5);if(!C.success||!C.session_id)throw new Error(C.error||"MOBI/AZW è§£æå¯åŠ¨å¤±è´¥");f=C.session_id;const x=C.total_images||0;Ce(`æ­£åœ¨è§£æç”µå­ä¹¦ï¼Œå…± ${x} å¼ å›¾ç‰‡...`,"info");let P=0,I=!0;for(;I;){R.value=`${d.name} - å·²å¤„ç† ${P}/${x} å¼ `,S.value=x>0?Math.round(P/x*100):0;const E=await Fs(f);if(!E.success)throw new Error(E.error||"MOBI/AZW æ‰¹æ¬¡è§£æå¤±è´¥");if(E.images&&E.images.length>0){for(let K=0;K<E.images.length;K++){const G=E.images[K];if(!G)continue;const c=P+K+1,h=`${d.name.replace(/\.(mobi|azw|azw3)$/i,"")}_image_${String(c).padStart(3,"0")}.png`,le=G.startsWith("data:")?G:`data:image/png;base64,${G}`;a.addImage(h,le)}P+=E.images.length}I=E.has_more??!1}return P}catch(C){throw console.error("MOBI/AZW è§£æå¤±è´¥:",C),C}finally{if(f)try{await Us(f)}catch(C){console.warn("MOBI/AZW ä¼šè¯æ¸…ç†å¤±è´¥:",C)}}}function r(){_.value=""}return t({triggerFileSelect:V,triggerFolderSelect:B,processFiles:ee,clearError:r}),(d,f)=>(A(),L("div",ka,[e("div",{id:"drop-area",class:Re(["drop-area",{"drag-over":b.value,loading:u.value}]),onDragover:F,onDragleave:z,onDrop:k},[e("div",{class:"drop-content"},[e("p",{class:"drop-text"},[f[0]||(f[0]=de(" æ‹–æ‹½å›¾ç‰‡ã€PDFæˆ–MOBIæ–‡ä»¶åˆ°è¿™é‡Œï¼Œæˆ– ",-1)),e("span",{class:"select-link",onClick:V}," é€‰æ‹©æ–‡ä»¶ "),f[1]||(f[1]=e("span",{class:"separator"}," | ",-1)),e("span",{class:"select-link folder-link",onClick:B}," ğŸ“ é€‰æ‹©æ–‡ä»¶å¤¹ "),f[2]||(f[2]=e("span",{class:"separator"}," | ",-1)),e("span",{class:"select-link web-import-link",onClick:M}," ğŸŒ ä»ç½‘é¡µå¯¼å…¥ ")])]),e("input",{ref_key:"fileInputRef",ref:m,type:"file",id:"imageUpload",accept:"image/*,application/pdf,.mobi,.azw,.azw3",multiple:"",class:"file-input",onChange:$},null,544),e("input",{ref_key:"folderInputRef",ref:g,type:"file",webkitdirectory:"",class:"file-input",onChange:v},null,544)],34),y.value?(A(),ut(Po,{key:0,visible:!0,percentage:S.value,label:R.value||"å¤„ç†ä¸­..."},null,8,["percentage","label"])):ce("",!0),_.value?(A(),L("div",{key:1,class:"error-message",onClick:r},[f[3]||(f[3]=e("span",{class:"error-icon"},"âš ï¸",-1)),e("span",Sa,te(_.value),1),f[4]||(f[4]=e("span",{class:"error-close"},"Ã—",-1))])):ce("",!0),u.value&&!y.value?(A(),L("div",wa,[...f[5]||(f[5]=[e("div",{class:"spinner"},null,-1),e("span",{class:"loading-text"},"å¤„ç†ä¸­...",-1)])])):ce("",!0)]))}}),Ta=Je($a,[["__scopeId","data-v-5ff3dc04"]]),Ia={id:"settings-sidebar",class:"settings-sidebar"},Pa={class:"card settings-card"},Ra={id:"font-settings",class:"settings-card collapsible-panel"},Da={class:"toggle-icon"},Ma={class:"collapsible-content"},Ba={class:"settings-form"},Aa={class:"form-group"},Ea=["value","disabled","title"],La={class:"auto-fontSize-option",title:"å‹¾é€‰åï¼Œé¦–æ¬¡ç¿»è¯‘æ—¶è‡ªåŠ¨ä¸ºæ¯ä¸ªæ°”æ³¡è®¡ç®—åˆé€‚çš„å­—å·"},Fa=["checked"],Ua={class:"form-group"},Oa={class:"form-group"},za={class:"form-group"},Na={class:"color-with-auto"},Va={class:"auto-color-toggle",title:"ç¿»è¯‘æ—¶è‡ªåŠ¨ä½¿ç”¨è¯†åˆ«åˆ°çš„æ–‡å­—é¢œè‰²"},Wa=["checked"],Ka=["value","disabled"],qa={key:0,class:"auto-color-hint"},Ha={class:"form-group"},ja={class:"checkbox-label"},Ja=["checked"],Ya={key:0,id:"strokeOptions",class:"stroke-options"},Ga={class:"form-group"},Xa=["value"],Za={class:"form-group"},Qa=["value"],el={class:"form-group"},tl={key:0,id:"solidColorOptions",class:"form-group"},ol=["value"],nl={class:"apply-settings-group"},sl=["disabled"],al={key:0,class:"apply-options-dropdown"},ll={class:"apply-option"},il=["checked"],rl={class:"apply-option"},ul={class:"apply-option"},cl={class:"apply-option"},dl={class:"apply-option"},gl={class:"apply-option"},pl={class:"apply-option"},ml={class:"apply-option"},vl={class:"apply-option"},fl={id:"page-range-settings",class:"settings-card collapsible-panel"},bl={class:"toggle-icon"},hl={class:"collapsible-content"},xl={class:"settings-form page-range-form"},yl={class:"range-header-row"},Cl={class:"range-toggle-compact"},_l=["disabled"],kl={class:"total-count"},Sl={class:"page-range-inputs-compact"},wl=["value"],$l=["value"],Tl={key:0,class:"range-error-compact"},Il={class:"action-buttons"},Pl=["disabled"],Rl=["disabled","title"],Dl=["disabled","title"],Ml=["disabled","title"],Bl=["disabled"],Al=["disabled","title"],El=["disabled"],Ll=["disabled"],Fl={class:"navigation-buttons"},Ul=["disabled"],Ol=["disabled"],zl=Ye({__name:"SettingsSidebar",emits:["translateCurrent","translateAll","translateRange","hqTranslate","hqTranslateRange","proofread","proofreadRange","removeText","removeAllText","removeTextRange","deleteCurrent","clearAll","cleanTemp","openPlugins","openSettings","previous","next","applyToAll","textStyleChanged","autoFontSizeChanged"],setup(n,{emit:t}){const s=t,o=Ze(),a=Ee(),i=w(!0),l=w(!1),m=w({fontSize:!0,fontFamily:!0,layoutDirection:!0,textColor:!0,fillColor:!0,strokeEnabled:!0,strokeColor:!0,strokeWidth:!0}),g=w(!1),u=w(!1),b=w(1),_=w(1),S=[{label:"è‡ªåŠ¨ (æ ¹æ®æ£€æµ‹)",value:"auto"},{label:"ç«–å‘æ’ç‰ˆ",value:"vertical"},{label:"æ¨ªå‘æ’ç‰ˆ",value:"horizontal"}],R=[{label:"çº¯è‰²å¡«å……",value:"solid"},{label:"LAMAä¿®å¤ (é€Ÿåº¦ä¼˜åŒ–)",value:"lama_mpe"},{label:"LAMAä¿®å¤ (é€šç”¨)",value:"litelama"}],y=Y(()=>o.currentImage),D=Y(()=>o.hasImages),V=Y(()=>o.images.length),M=Y(()=>b.value>=1&&_.value<=V.value&&b.value<=_.value),B=Y(()=>D.value&&!o.isBatchTranslationInProgress),v=Y(()=>o.canGoPrevious),p=Y(()=>o.canGoNext),$=Y(()=>a.textStyle),k=w([]),F=[ft,"fonts/msyh.ttc","fonts/simhei.ttf","fonts/simsun.ttc"],z=w(null),ee=Y(()=>{const re=k.value.map(T=>({label:U(T),value:T}));return re.push({label:"è‡ªå®šä¹‰å­—ä½“...",value:"custom-font"}),re});dt(async()=>{await J();const re=$.value.fontFamily;re&&!k.value.includes(re)&&(k.value=[re,...k.value])});async function J(){try{const re=await Mn();if(re.fonts&&Array.isArray(re.fonts)&&re.fonts.length>0){const T=re.fonts[0];if(typeof T=="object"&&"path"in T){const Z=re.fonts.map(he=>typeof he=="object"?he.path:he);k.value=Z}else k.value=re.fonts}else k.value=[...F]}catch(re){console.error("åŠ è½½å­—ä½“åˆ—è¡¨å¤±è´¥:",re),k.value=[...F]}}function se(){i.value=!i.value}function O(re){const T=parseInt(re.target.value);isNaN(T)||(a.updateTextStyle({fontSize:T}),s("textStyleChanged","fontSize",T))}function Q(re){const T=re.target.checked;a.updateTextStyle({autoFontSize:T}),console.log(`è‡ªåŠ¨å­—å·è®¾ç½®å˜æ›´: ${T}`),s("autoFontSizeChanged",T)}async function ae(re){const T=re.target,Z=T.files?.[0];if(!Z)return;const he=[".ttf",".ttc",".otf"],me=Z.name.toLowerCase();if(!he.some(W=>me.endsWith(W))){Ce("è¯·é€‰æ‹© .ttfã€.ttc æˆ– .otf æ ¼å¼çš„å­—ä½“æ–‡ä»¶","error"),T.value="";return}try{const W=await Ks(Z);W.success&&W.fontPath?(await J(),a.updateTextStyle({fontFamily:W.fontPath}),Ce("å­—ä½“ä¸Šä¼ æˆåŠŸ","success")):Ce(W.error||"å­—ä½“ä¸Šä¼ å¤±è´¥","error")}catch(W){console.error("å­—ä½“ä¸Šä¼ å¤±è´¥:",W),Ce("å­—ä½“ä¸Šä¼ å¤±è´¥","error")}finally{T.value=""}}function U(re){const T={"fonts/STXINGKA.TTF":"åæ–‡è¡Œæ¥·","fonts/STXINWEI.TTF":"åæ–‡æ–°é­","fonts/STZHONGS.TTF":"åæ–‡ä¸­å®‹","fonts/STKAITI.TTF":"æ¥·ä½“","fonts/STLITI.TTF":"éš¶ä¹¦","fonts/æ€æºé»‘ä½“SourceHanSansK-Bold.TTF":"æ€æºé»‘ä½“","fonts/STSONG.TTF":"åæ–‡å®‹ä½“","fonts/msyh.ttc":"å¾®è½¯é›…é»‘","fonts/msyhbd.ttc":"å¾®è½¯é›…é»‘ç²—ä½“","fonts/SIMYOU.TTF":"å¹¼åœ†","fonts/STFANGSO.TTF":"ä»¿å®‹","fonts/STHUPO.TTF":"åæ–‡ç¥ç€","fonts/STXIHEI.TTF":"åæ–‡ç»†é»‘","fonts/simkai.ttf":"ä¸­æ˜“æ¥·ä½“","fonts/simfang.ttf":"ä¸­æ˜“ä»¿å®‹","fonts/simhei.ttf":"ä¸­æ˜“é»‘ä½“","fonts/SIMLI.TTF":"ä¸­æ˜“éš¶ä¹¦","fonts/simsun.ttc":"å®‹ä½“"};if(T[re])return T[re];const Z=re.split("/").pop()||re;for(const[he,me]of Object.entries(T))if((he.split("/").pop()||"").toLowerCase()===Z.toLowerCase())return me;return Z.replace(/\.(ttf|ttc|otf)$/i,"")}function r(re){const T=String(re);if(T==="custom-font"){z.value?.click();return}a.updateTextStyle({fontFamily:T}),s("textStyleChanged","fontFamily",T)}function d(re){const T=String(re);a.updateTextStyle({layoutDirection:T}),s("textStyleChanged","layoutDirection",T)}function f(re){const T=String(re);a.updateTextStyle({inpaintMethod:T})}function C(re){const T=re.target.value;a.updateTextStyle({textColor:T}),s("textStyleChanged","textColor",T)}function x(re){const T=re.target.checked;a.updateTextStyle({useAutoTextColor:T})}function P(re){const T=re.target.checked;a.updateTextStyle({strokeEnabled:T}),s("textStyleChanged","strokeEnabled",T)}function I(re){const T=re.target.value;a.updateTextStyle({strokeColor:T}),s("textStyleChanged","strokeColor",T)}function E(re){const T=parseInt(re.target.value);isNaN(T)||(a.updateTextStyle({strokeWidth:T}),s("textStyleChanged","strokeWidth",T))}function K(re){const T=re.target.value;a.updateTextStyle({fillColor:T}),s("textStyleChanged","fillColor",T)}function G(){l.value=!l.value}function c(){const T=!Object.values(m.value).every(Z=>Z);m.value={fontSize:T,fontFamily:T,layoutDirection:T,textColor:T,fillColor:T,strokeEnabled:T,strokeColor:T,strokeWidth:T}}function h(){s("applyToAll",{...m.value}),l.value=!1}function le(re){re.target.closest(".apply-settings-group")||(l.value=!1)}function N(){g.value=!g.value,g.value&&V.value>0&&(!M.value||b.value===1&&_.value===1)&&(b.value=1,_.value=V.value)}function X(re){const T=parseInt(re.target.value);isNaN(T)||(b.value=Math.max(1,Math.min(T,V.value)))}function pe(re){const T=parseInt(re.target.value);isNaN(T)||(_.value=Math.max(1,Math.min(T,V.value)))}function ye(){u.value&&M.value?s("translateRange",b.value,_.value):s("translateAll")}function _e(){u.value&&M.value?s("hqTranslateRange",b.value,_.value):s("hqTranslate")}function $e(){u.value&&M.value?s("proofreadRange",b.value,_.value):s("proofread")}function De(){u.value&&M.value?s("removeTextRange",b.value,_.value):s("removeAllText")}return typeof window<"u"&&window.addEventListener("click",le),(re,T)=>(A(),L("aside",Ia,[e("div",Pa,[T[43]||(T[43]=e("h2",null,"ç¿»è¯‘è®¾ç½®",-1)),e("div",Ra,[e("h3",{class:"collapsible-header",onClick:se},[T[17]||(T[17]=de(" æ–‡å­—è®¾ç½® ",-1)),e("span",Da,te(i.value?"â–¼":"â–¶"),1)]),oe(e("div",Ma,[e("div",Ba,[e("div",Aa,[T[19]||(T[19]=e("label",{for:"fontSize"},"å­—å·å¤§å°:",-1)),e("input",{type:"number",id:"fontSize",value:$.value.fontSize,min:"10",disabled:$.value.autoFontSize,class:Re({"disabled-input":$.value.autoFontSize}),title:$.value.autoFontSize?"å·²å¯ç”¨è‡ªåŠ¨å­—å·ï¼Œé¦–æ¬¡ç¿»è¯‘æ—¶å°†è‡ªåŠ¨è®¡ç®—":"",onInput:O},null,42,Ea),e("span",La,[e("input",{type:"checkbox",id:"autoFontSize",checked:$.value.autoFontSize,onChange:Q},null,40,Fa),T[18]||(T[18]=e("label",{for:"autoFontSize"},"è‡ªåŠ¨è®¡ç®—åˆå§‹å­—å·",-1))])]),e("div",Ua,[T[20]||(T[20]=e("label",{for:"fontFamily"},"æ–‡æœ¬å­—ä½“:",-1)),ke(Ve,{"model-value":$.value.fontFamily,options:ee.value,onChange:r},null,8,["model-value","options"]),e("input",{ref_key:"fontUploadInput",ref:z,type:"file",id:"fontUpload",accept:".ttf,.ttc,.otf",style:{display:"none"},onChange:ae},null,544)]),e("div",Oa,[T[21]||(T[21]=e("label",{for:"layoutDirection"},"æ’ç‰ˆè®¾ç½®:",-1)),ke(Ve,{"model-value":$.value.layoutDirection,options:S,onChange:d},null,8,["model-value"])]),e("div",za,[T[23]||(T[23]=e("label",{for:"textColor"},"æ–‡å­—é¢œè‰²:",-1)),e("div",Na,[e("label",Va,[e("input",{type:"checkbox",checked:$.value.useAutoTextColor,onChange:x},null,40,Wa),T[22]||(T[22]=e("span",null,"è‡ªåŠ¨",-1))]),e("input",{type:"color",id:"textColor",value:$.value.textColor,disabled:$.value.useAutoTextColor,onInput:C},null,40,Ka)]),$.value.useAutoTextColor?(A(),L("div",qa," ğŸ’¡ ç¿»è¯‘æ—¶å°†è‡ªåŠ¨ä½¿ç”¨è¯†åˆ«åˆ°çš„æ–‡å­—é¢œè‰² ")):ce("",!0)]),e("div",Ha,[e("span",ja,[e("input",{type:"checkbox",id:"strokeEnabled",checked:$.value.strokeEnabled,onChange:P},null,40,Ja),T[24]||(T[24]=e("label",{for:"strokeEnabled"},"å¯ç”¨æ–‡æœ¬æè¾¹:",-1))])]),ke(un,{name:"stroke-slide"},{default:xt(()=>[$.value.strokeEnabled?(A(),L("div",Ya,[e("div",Ga,[T[25]||(T[25]=e("label",{for:"strokeColor"},"æè¾¹é¢œè‰²:",-1)),e("input",{type:"color",id:"strokeColor",value:$.value.strokeColor,onInput:I},null,40,Xa)]),e("div",Za,[T[26]||(T[26]=e("label",{for:"strokeWidth"},"æè¾¹å®½åº¦ (px):",-1)),e("input",{type:"number",id:"strokeWidth",value:$.value.strokeWidth,min:"0",max:"10",style:{width:"60px",padding:"5px"},onInput:E},null,40,Qa),T[27]||(T[27]=e("div",{class:"input-hint"},"0 è¡¨ç¤ºæ— æè¾¹ã€‚",-1))])])):ce("",!0)]),_:1}),e("div",el,[T[28]||(T[28]=e("label",{for:"useInpainting"},"æ°”æ³¡å¡«å……æ–¹å¼:",-1)),ke(Ve,{"model-value":$.value.inpaintMethod,options:R,onChange:f},null,8,["model-value"])]),ke(un,{name:"slide-fade"},{default:xt(()=>[$.value.inpaintMethod==="solid"?(A(),L("div",tl,[T[29]||(T[29]=e("label",{for:"fillColor"},"å¡«å……é¢œè‰²:",-1)),e("input",{type:"color",id:"fillColor",value:$.value.fillColor,onInput:K},null,40,ol)])):ce("",!0)]),_:1})]),e("div",nl,[e("button",{type:"button",class:"settings-button",disabled:!D.value,onClick:h}," åº”ç”¨åˆ°å…¨éƒ¨ ",8,sl),e("button",{type:"button",class:"settings-gear-btn",title:"é€‰æ‹©è¦åº”ç”¨çš„å‚æ•°",onClick:G}," âš™ï¸ "),l.value?(A(),L("div",al,[e("div",ll,[e("input",{type:"checkbox",id:"apply_selectAll",checked:Object.values(m.value).every(Z=>Z),onChange:c},null,40,il),T[30]||(T[30]=e("label",{for:"apply_selectAll"},"å…¨é€‰",-1))]),T[39]||(T[39]=e("hr",null,null,-1)),e("div",rl,[oe(e("input",{type:"checkbox",id:"apply_fontSize","onUpdate:modelValue":T[0]||(T[0]=Z=>m.value.fontSize=Z)},null,512),[[Xe,m.value.fontSize]]),T[31]||(T[31]=e("label",{for:"apply_fontSize"},"å­—å·",-1))]),e("div",ul,[oe(e("input",{type:"checkbox",id:"apply_fontFamily","onUpdate:modelValue":T[1]||(T[1]=Z=>m.value.fontFamily=Z)},null,512),[[Xe,m.value.fontFamily]]),T[32]||(T[32]=e("label",{for:"apply_fontFamily"},"å­—ä½“",-1))]),e("div",cl,[oe(e("input",{type:"checkbox",id:"apply_layoutDirection","onUpdate:modelValue":T[2]||(T[2]=Z=>m.value.layoutDirection=Z)},null,512),[[Xe,m.value.layoutDirection]]),T[33]||(T[33]=e("label",{for:"apply_layoutDirection"},"æ’ç‰ˆæ–¹å‘",-1))]),e("div",dl,[oe(e("input",{type:"checkbox",id:"apply_textColor","onUpdate:modelValue":T[3]||(T[3]=Z=>m.value.textColor=Z)},null,512),[[Xe,m.value.textColor]]),T[34]||(T[34]=e("label",{for:"apply_textColor"},"æ–‡å­—é¢œè‰²",-1))]),e("div",gl,[oe(e("input",{type:"checkbox",id:"apply_fillColor","onUpdate:modelValue":T[4]||(T[4]=Z=>m.value.fillColor=Z)},null,512),[[Xe,m.value.fillColor]]),T[35]||(T[35]=e("label",{for:"apply_fillColor"},"å¡«å……é¢œè‰²",-1))]),e("div",pl,[oe(e("input",{type:"checkbox",id:"apply_strokeEnabled","onUpdate:modelValue":T[5]||(T[5]=Z=>m.value.strokeEnabled=Z)},null,512),[[Xe,m.value.strokeEnabled]]),T[36]||(T[36]=e("label",{for:"apply_strokeEnabled"},"æè¾¹å¼€å…³",-1))]),e("div",ml,[oe(e("input",{type:"checkbox",id:"apply_strokeColor","onUpdate:modelValue":T[6]||(T[6]=Z=>m.value.strokeColor=Z)},null,512),[[Xe,m.value.strokeColor]]),T[37]||(T[37]=e("label",{for:"apply_strokeColor"},"æè¾¹é¢œè‰²",-1))]),e("div",vl,[oe(e("input",{type:"checkbox",id:"apply_strokeWidth","onUpdate:modelValue":T[7]||(T[7]=Z=>m.value.strokeWidth=Z)},null,512),[[Xe,m.value.strokeWidth]]),T[38]||(T[38]=e("label",{for:"apply_strokeWidth"},"æè¾¹å®½åº¦",-1))])])):ce("",!0)])],512),[[Oe,i.value]])]),e("div",fl,[e("h3",{class:"collapsible-header",onClick:N},[T[40]||(T[40]=de(" æŒ‡å®šèŒƒå›´ ",-1)),e("span",bl,te(g.value?"â–¼":"â–¶"),1)]),oe(e("div",hl,[e("div",xl,[e("div",yl,[e("label",Cl,[oe(e("input",{type:"checkbox","onUpdate:modelValue":T[8]||(T[8]=Z=>u.value=Z),disabled:V.value===0},null,8,_l),[[Xe,u.value]]),T[41]||(T[41]=e("span",null,"å¯ç”¨",-1))]),e("span",kl,"å…± "+te(V.value)+" å¼ ",1)]),oe(e("div",Sl,[e("input",{type:"number",id:"pageRangeStart",value:b.value,onInput:X,placeholder:"èµ·å§‹"},null,40,wl),T[42]||(T[42]=e("span",{class:"range-sep"},"~",-1)),e("input",{type:"number",id:"pageRangeEnd",value:_.value,onInput:pe,placeholder:"ç»“æŸ"},null,40,$l)],512),[[Oe,u.value]]),u.value&&!M.value&&V.value>0?(A(),L("div",Tl," èŒƒå›´æ— æ•ˆ ")):ce("",!0)])],512),[[Oe,g.value]])]),e("div",Il,[e("button",{id:"translateButton",disabled:!B.value,onClick:T[9]||(T[9]=Z=>s("translateCurrent"))}," ç¿»è¯‘å½“å‰å›¾ç‰‡ ",8,Pl),e("button",{id:"translateAllButton",disabled:!B.value||u.value&&!M.value,title:u.value?`ç¿»è¯‘ç¬¬ ${b.value}-${_.value} é¡µ`:"ç¿»è¯‘æ‰€æœ‰å›¾ç‰‡",onClick:ye},te(u.value?`ç¿»è¯‘ ${b.value}-${_.value} é¡µ`:"ç¿»è¯‘æ‰€æœ‰å›¾ç‰‡"),9,Rl),e("button",{id:"startHqTranslationBtn",class:"settings-button purple-button",disabled:!B.value||u.value&&!M.value,title:u.value?`é«˜è´¨é‡ç¿»è¯‘ç¬¬ ${b.value}-${_.value} é¡µ`:"ä½¿ç”¨é«˜è´¨é‡ç¿»è¯‘æ¨¡å¼ï¼ˆéœ€åœ¨è®¾ç½®ä¸­é…ç½®ï¼‰",onClick:_e},te(u.value?`é«˜è´¨é‡ç¿»è¯‘ ${b.value}-${_.value}`:"é«˜è´¨é‡ç¿»è¯‘"),9,Dl),e("button",{id:"proofreadButton",disabled:!B.value||u.value&&!M.value,title:u.value?`AIæ ¡å¯¹ç¬¬ ${b.value}-${_.value} é¡µ`:"AIæ ¡å¯¹",onClick:$e},te(u.value?`AIæ ¡å¯¹ ${b.value}-${_.value}`:"AIæ ¡å¯¹"),9,Ml),e("button",{id:"removeTextOnlyButton",disabled:!y.value,title:"æ¶ˆé™¤å›¾ç‰‡ä¸­çš„æ°”æ³¡æ–‡å­—ï¼Œæ— éœ€å¡«å†™ç¿»è¯‘æœåŠ¡å•†å’ŒAPI Key",onClick:T[10]||(T[10]=Z=>s("removeText"))}," ä»…æ¶ˆé™¤æ–‡å­— ",8,Bl),e("button",{id:"removeAllTextButton",disabled:!D.value||u.value&&!M.value,title:u.value?`æ¶ˆé™¤ç¬¬ ${b.value}-${_.value} é¡µçš„æ–‡å­—`:"æ¶ˆé™¤æ‰€æœ‰å›¾ç‰‡ä¸­çš„æ°”æ³¡æ–‡å­—",onClick:De},te(u.value?`æ¶ˆé™¤ ${b.value}-${_.value} é¡µæ–‡å­—`:"æ¶ˆé™¤æ‰€æœ‰å›¾ç‰‡æ–‡å­—"),9,Al),e("button",{id:"deleteCurrentImageButton",class:"settings-button red-button",disabled:!y.value,onClick:T[11]||(T[11]=Z=>s("deleteCurrent"))}," åˆ é™¤å½“å‰å›¾ç‰‡ ",8,El),e("button",{id:"clearAllImagesButton",class:"settings-button red-button",disabled:!D.value,onClick:T[12]||(T[12]=Z=>s("clearAll"))}," æ¸…é™¤æ‰€æœ‰å›¾ç‰‡ ",8,Ll),e("button",{id:"cleanDebugFilesButton",class:"settings-button orange-button",onClick:T[13]||(T[13]=Z=>s("cleanTemp"))}," æ¸…ç†ä¸´æ—¶æ–‡ä»¶ "),e("button",{id:"managePluginsButton",class:"settings-button blue-button",onClick:T[14]||(T[14]=Z=>s("openPlugins"))}," æ’ä»¶ç®¡ç† ")]),e("div",Fl,[e("button",{id:"prevImageButton",disabled:!v.value,onClick:T[15]||(T[15]=Z=>s("previous"))}," ä¸Šä¸€å¼  ",8,Ul),e("button",{id:"nextImageButton",disabled:!p.value,onClick:T[16]||(T[16]=Z=>s("next"))}," ä¸‹ä¸€å¼  ",8,Ol)])])]))}}),Nl=Je(zl,[["__scopeId","data-v-cf679ea9"]]);function Ot(n){if(n.textDirection==="vertical"||n.textDirection==="horizontal")return n.textDirection;if(n.autoTextDirection==="vertical"||n.autoTextDirection==="horizontal")return n.autoTextDirection;if(n.coords){const[t,s,o,a]=n.coords;return a-s>o-t?"vertical":"horizontal"}return"vertical"}function Vl(){const n=Ze(),t=Ee(),s=ct(),o=w(!1),a=w(0),i=w(""),l=w(!1),m=w(0),g=w(""),u=Y(()=>n.hasImages),b=Y(()=>n.hasImages),_=Y(()=>n.hasImages);function S(){const v=n.images;if(v.length===0){s.warning("æ²¡æœ‰å¯å¯¼å‡ºçš„å›¾ç‰‡æ–‡æœ¬");return}const p=[];for(let se=0;se<v.length;se++){const O=v[se];if(!O)continue;const Q=O.bubbleStates||[],ae={imageIndex:se,bubbles:[]};for(let U=0;U<Q.length;U++){const r=Q[U];if(!r)continue;const d=r.originalText||"",f=r.translatedText||r.textboxText||"";let C="vertical";r.textDirection&&r.textDirection!=="auto"?C=r.textDirection:r.autoTextDirection&&(C=r.autoTextDirection),ae.bubbles.push({bubbleIndex:U,original:d,translated:f,textDirection:C})}p.push(ae)}const $=JSON.stringify(p,null,2),k=new Blob([$],{type:"application/json"}),F=URL.createObjectURL(k),z=document.createElement("a");z.href=F;const J=new Date().toISOString().replace(/[-:T]/g,"").slice(0,15);z.download=`translations_${J}.json`,document.body.appendChild(z),z.click(),document.body.removeChild(z),URL.revokeObjectURL(F),s.success("æ–‡æœ¬å¯¼å‡ºæˆåŠŸï¼")}function R(){const v=n.images;if(v.length===0)return null;const p=[];for(let $=0;$<v.length;$++){const k=v[$];if(!k)continue;const F=k.bubbleStates||[],z={imageIndex:$,bubbles:[]};for(let ee=0;ee<F.length;ee++){const J=F[ee];if(!J)continue;const se=J.originalText||"",O=J.translatedText||J.textboxText||"";let Q="vertical";J.textDirection&&J.textDirection!=="auto"?Q=J.textDirection:J.autoTextDirection&&(Q=J.autoTextDirection),z.bubbles.push({bubbleIndex:ee,original:se,translated:O,textDirection:Q})}p.push(z)}return p}async function y(v){if(!v){s.warning("æœªé€‰æ‹©æ–‡ä»¶");return}l.value=!0,m.value=0,g.value="å‡†å¤‡å¯¼å…¥æ–‡æœ¬...",s.info("æ­£åœ¨å¯¼å…¥æ–‡æœ¬...",0);try{const p=await D(v);m.value=10,g.value="è§£æ JSON æ•°æ®...";const $=JSON.parse(p);if(!Array.isArray($))throw new Error("å¯¼å…¥çš„ JSON æ ¼å¼ä¸æ­£ç¡®ï¼Œåº”ä¸ºæ•°ç»„");let k=0,F=0;const z=t.settings.textStyle,ee=z.autoFontSize?"auto":z.fontSize,J=z.fontFamily,se=z.textColor,O=z.fillColor;m.value=20,g.value="å¼€å§‹æ›´æ–°å›¾ç‰‡...";const Q=$.length;let ae=0;const U=[];for(const f of $){ae++;const C=20+ae/Q*60;m.value=C,g.value=`å¤„ç†å›¾ç‰‡ ${ae}/${Q}`;const x=f.imageIndex;if(x<0||x>=n.images.length){console.warn(`è·³è¿‡æ— æ•ˆçš„å›¾ç‰‡ç´¢å¼•: ${x}`);continue}const P=n.images[x];if(!P)continue;let I=!1;P.bubbleStates||(P.bubbleStates=[]),P.bubbleTexts||(P.bubbleTexts=[]),P.originalTexts||(P.originalTexts=[]);for(const E of f.bubbles){const K=E.bubbleIndex,G=E.original,c=E.translated,h=E.textDirection,le=h==="vertical"||h==="horizontal"?h:"vertical";for(;P.bubbleTexts.length<=K;)P.bubbleTexts.push("");for(;P.originalTexts.length<=K;)P.originalTexts.push("");for(G&&(P.originalTexts[K]=G),c&&(P.bubbleTexts[K]=c);P.bubbleStates.length<=K;)P.bubbleStates.push(V(ee,J,se,O));const N=P.bubbleStates[K];N&&(G&&(N.originalText=G),c&&(N.translatedText=c,N.textboxText=c),N.textDirection=le,I=!0,F++)}I&&P.bubbleStates&&(P.bubbleTexts=P.bubbleStates.map(E=>E.translatedText||"")),I&&(k++,P.hasUnsavedChanges=!0,P.translatedDataURL&&P.bubbleStates&&P.bubbleStates.length>0&&U.push(x))}if(U.length>0){m.value=80,g.value="å¼€å§‹æ¸²æŸ“å›¾ç‰‡...",s.info("æ­£åœ¨æ¸²æŸ“å›¾ç‰‡ï¼Œè¯·ç¨å€™...",0);const f=t.settings.textStyle,C=f.layoutDirection,x=C==="auto";for(let P=0;P<U.length;P++){const I=U[P];if(I===void 0)continue;const E=n.images[I];if(!(!E||!E.bubbleStates)){m.value=80+P/U.length*20,g.value=`æ¸²æŸ“å›¾ç‰‡ ${P+1}/${U.length}`;try{let K="";if(E.cleanImageData?K=E.cleanImageData.includes("base64,")?E.cleanImageData.split("base64,")[1]||"":E.cleanImageData:E.originalDataURL&&(K=E.originalDataURL.includes("base64,")?E.originalDataURL.split("base64,")[1]||"":E.originalDataURL,console.log(`importText: å›¾ç‰‡ ${I} ä½¿ç”¨åŸå›¾ä½œä¸ºèƒŒæ™¯ï¼ˆå…œåº•ï¼‰`)),!K){console.log(`importText: å›¾ç‰‡ ${I} æ²¡æœ‰å¯ç”¨çš„èƒŒæ™¯å›¾ï¼Œè·³è¿‡`);continue}const G=E.bubbleStates.map(h=>({translatedText:h.translatedText||"",coords:h.coords,fontSize:h.fontSize||f.fontSize,fontFamily:h.fontFamily||f.fontFamily,textDirection:Ot(h),textColor:h.textColor||f.textColor,rotationAngle:h.rotationAngle||0,position:h.position||{x:0,y:0},strokeEnabled:h.strokeEnabled??f.strokeEnabled,strokeColor:h.strokeColor||f.strokeColor,strokeWidth:h.strokeWidth??f.strokeWidth})),c=await $o({clean_image:K,bubble_texts:G.map(h=>h.translatedText),bubble_coords:G.map(h=>h.coords),fontSize:f.fontSize,fontFamily:f.fontFamily,textDirection:x?"vertical":C,textColor:f.textColor,bubble_states:G,use_individual_styles:!0,use_inpainting:!1,use_lama:!1,is_font_style_change:!0,strokeEnabled:f.strokeEnabled,strokeColor:f.strokeColor,strokeWidth:f.strokeWidth});c.rendered_image&&(n.updateImageByIndex(I,{translatedDataURL:`data:image/png;base64,${c.rendered_image}`,hasUnsavedChanges:!0}),console.log(`importText: å›¾ç‰‡ ${I} æ¸²æŸ“æˆåŠŸ`))}catch(K){console.error(`importText: é‡æ¸²æŸ“å›¾ç‰‡ ${I} å¤±è´¥:`,K)}}}}m.value=100,g.value="å¯¼å…¥å®Œæˆ";const r=U.length,d=r>0?`å¯¼å…¥æˆåŠŸï¼æ›´æ–°äº† ${k} å¼ å›¾ç‰‡ä¸­çš„ ${F} ä¸ªæ°”æ³¡æ–‡æœ¬ï¼Œé‡æ¸²æŸ“äº† ${r} å¼ å›¾ç‰‡`:`å¯¼å…¥æˆåŠŸï¼æ›´æ–°äº† ${k} å¼ å›¾ç‰‡ä¸­çš„ ${F} ä¸ªæ°”æ³¡æ–‡æœ¬`;s.success(d)}catch(p){console.error("å¯¼å…¥æ–‡æœ¬å‡ºé”™:",p),s.error(`å¯¼å…¥å¤±è´¥: ${p instanceof Error?p.message:String(p)}`)}finally{l.value=!1,setTimeout(()=>{m.value=0,g.value=""},2e3)}}function D(v){return new Promise((p,$)=>{const k=new FileReader;k.onload=F=>{F.target?.result?p(F.target.result):$(new Error("è¯»å–æ–‡ä»¶å¤±è´¥"))},k.onerror=()=>$(new Error("è¯»å–æ–‡ä»¶æ—¶å‡ºé”™")),k.readAsText(v)})}function V(v,p,$,k){const F=t.settings.textStyle;return{coords:[0,0,100,100],polygon:[],originalText:"",translatedText:"",textboxText:"",fontSize:typeof v=="number"?v:25,fontFamily:p,textDirection:"vertical",autoTextDirection:"vertical",textColor:$,fillColor:k,rotationAngle:0,position:{x:0,y:0},strokeEnabled:F.strokeEnabled,strokeColor:F.strokeColor,strokeWidth:F.strokeWidth,inpaintMethod:F.inpaintMethod}}function M(){const v=n.currentImage;if(!v){s.warning("æ²¡æœ‰å¯ä¸‹è½½çš„å›¾ç‰‡");return}const p=v.translatedDataURL||v.originalDataURL;if(!p){s.warning("æ²¡æœ‰å¯ä¸‹è½½çš„å›¾ç‰‡");return}o.value=!0;try{const $=p.split(",")[1];if(!$)throw new Error("æ— æ•ˆçš„å›¾ç‰‡æ•°æ®");const k=atob($),F=[];for(let Q=0;Q<k.length;Q+=512){const ae=k.slice(Q,Q+512),U=new Array(ae.length);for(let d=0;d<ae.length;d++)U[d]=ae.charCodeAt(d);const r=new Uint8Array(U);F.push(r.buffer)}const z=new Blob(F,{type:"image/png"}),ee=URL.createObjectURL(z),J=document.createElement("a");J.href=ee;let se=v.fileName||`image_${n.currentImageIndex}.png`;se=`${v.translatedDataURL?"translated":"original"}_${se.replace(/\.[^/.]+$/,"")}.png`,J.download=se,document.body.appendChild(J),J.click(),document.body.removeChild(J),URL.revokeObjectURL(ee),s.success(`ä¸‹è½½æˆåŠŸ: ${se}`)}catch($){console.error("ä¸‹è½½å›¾ç‰‡æ—¶å‡ºé”™:",$),s.error("ä¸‹è½½å¤±è´¥")}finally{o.value=!1}}async function B(v="zip"){const p=n.images;if(p.length===0){s.warning("æ²¡æœ‰å¯ä¸‹è½½çš„å›¾ç‰‡");return}o.value=!0,a.value=0,i.value="å‡†å¤‡ä¸‹è½½...",s.info("ä¸‹è½½ä¸­...å¤„ç†å¯èƒ½éœ€è¦ä¸€å®šæ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…...",0);try{const $=[];let k=0,F=0;a.value=5,i.value="æ£€æŸ¥å›¾ç‰‡æ•°æ®...";for(let d=0;d<p.length;d++){const f=p[d];f&&(f.translatedDataURL?($.push({index:d,type:"translated"}),k++):f.originalDataURL&&($.push({index:d,type:"original"}),F++))}if($.length===0){s.warning("æ²¡æœ‰å¯ä¸‹è½½çš„å›¾ç‰‡");return}a.value=10,i.value="åˆ›å»ºä¸‹è½½ä¼šè¯...";const z=await Os($.length);if(!z.success||!z.session_id)throw new Error(z.error||"åˆ›å»ºä¼šè¯å¤±è´¥");const ee=z.session_id,J=$.length;let se=0,O=0;for(let d=0;d<$.length;d++){const f=$[d];if(!f)continue;const C=p[f.index];if(!C)continue;const x=f.type==="translated"?C.translatedDataURL:C.originalDataURL;if(!x)continue;const P=10+d/J*70;a.value=P,i.value=`ä¸Šä¼ å›¾ç‰‡ ${d+1}/${J}...`;try{const I=await zs(ee,x,d);I.success?se++:(console.error(`ä¸Šä¼ å›¾ç‰‡ ${d} å¤±è´¥:`,I.error),O++)}catch(I){console.error(`ä¸Šä¼ å›¾ç‰‡ ${d} å‡ºé”™:`,I),O++}}if(se===0)throw new Error("æ‰€æœ‰å›¾ç‰‡ä¸Šä¼ å¤±è´¥");a.value=85,i.value="æ‰“åŒ…æ–‡ä»¶...";const Q=await Ns(ee,v);if(!Q.success||!Q.file_id)throw new Error(Q.error||"æ‰“åŒ…å¤±è´¥");a.value=95,i.value="å‡†å¤‡ä¸‹è½½...";const ae=Vs(Q.file_id,v),U=document.createElement("a");U.href=ae,document.body.appendChild(U),U.click(),document.body.removeChild(U),a.value=100,i.value="ä¸‹è½½å·²å¼€å§‹";let r=`å·²æˆåŠŸå¤„ç† ${se} å¼ å›¾ç‰‡`;O>0&&(r+=`ï¼ˆ${O} å¼ å¤±è´¥ï¼‰`),k>0&&F>0?r+=`ï¼ˆ${k} å¼ ç¿»è¯‘å›¾ç‰‡å’Œ ${F} å¼ åŸå§‹å›¾ç‰‡ï¼‰`:k>0?r+="ï¼ˆå…¨éƒ¨ä¸ºç¿»è¯‘åå›¾ç‰‡ï¼‰":F>0&&(r+="ï¼ˆå…¨éƒ¨ä¸ºåŸå§‹å›¾ç‰‡ï¼‰"),r+="ï¼Œä¸‹è½½å³å°†å¼€å§‹",s.success(r),setTimeout(async()=>{try{const d=await wo();console.log("ä¸´æ—¶æ–‡ä»¶æ¸…ç†ç»“æœ:",d)}catch(d){console.error("æ¸…ç†ä¸´æ—¶æ–‡ä»¶å¤±è´¥:",d)}},6e4)}catch($){console.error("ä¸‹è½½æ‰€æœ‰å›¾ç‰‡æ—¶å‡ºé”™:",$),s.error(`ä¸‹è½½å¤±è´¥: ${$ instanceof Error?$.message:String($)}`)}finally{o.value=!1,setTimeout(()=>{a.value=0,i.value=""},2e3)}}return{isDownloading:o,downloadProgress:a,downloadProgressText:i,isImporting:l,importProgress:m,importProgressText:g,canExportText:u,canImportText:b,canDownload:_,exportText:S,exportTextToJson:R,importText:y,downloadCurrentImage:M,downloadAllImages:B}}const Wl={key:0,class:"result-section card result-card"},Kl={class:"image-controls"},ql={class:"image-size-control"},Hl=["value"],jl={id:"imageSizeValue"},Jl={class:"content-container"},Yl={class:"image-container"},Gl=["src"],Xl={id:"detectedTextInfo",class:"text-info"},Zl={id:"detectedTextList"},Ql={class:"original-text"},ei={class:"download-section"},ti={class:"download-buttons"},oi=["disabled"],ni={class:"download-all-container"},si=["disabled"],ai={class:"download-format-selector"},li=["disabled"],ii=["disabled"],ri={key:1,class:"empty-state-section"},fo=60,ui=Ye({__name:"ImageResultDisplay",props:{isEditMode:{type:Boolean,default:!1}},emits:["toggle-edit-mode","retry-failed"],setup(n,{emit:t}){const s=[{label:"ZIPå‹ç¼©åŒ…",value:"zip"},{label:"PDFæ–‡æ¡£",value:"pdf"},{label:"CBZæ¼«ç”»",value:"cbz"}],o=t,a=Ze(),i=Ee(),l=Vl(),m=w(100),g=Y({get:()=>D.value?.showOriginal??!1,set:P=>{D.value&&a.updateCurrentImage({showOriginal:P})}}),u=w("zip"),b=w(null),_=Y(()=>l.isDownloading.value),S=Y(()=>l.downloadProgressText.value),R=Y(()=>l.downloadProgress.value),y=Y(()=>a.hasImages),D=Y(()=>a.currentImage),V=Y(()=>!!D.value?.translatedDataURL),M=Y(()=>!!(D.value?.translatedDataURL||D.value?.originalDataURL)),B=Y(()=>D.value?g.value||!D.value.translatedDataURL?D.value.originalDataURL:D.value.translatedDataURL:""),v=Y(()=>a.failedImageCount>0),p=Y(()=>({width:`${m.value}%`})),$=Y(()=>i.settings.useTextboxPrompt),k=Y(()=>{if(!D.value)return[];if(D.value.bubbleStates&&D.value.bubbleStates.length>0)return D.value.bubbleStates.map(E=>({original:E.originalText||"",translated:$.value?E.textboxText||E.translatedText||"":E.translatedText||""}));const P=D.value.originalTexts||[],I=$.value?D.value.textboxTexts||D.value.bubbleTexts||[]:D.value.bubbleTexts||[];return P.length===0?[]:P.map((E,K)=>({original:E||"",translated:I[K]||""}))}),F=Y(()=>k.value.length>0);function z(P){if(!P||P.length<=fo)return P;let I="",E="";for(let K=0;K<P.length;K++)if(E+=P[K],E.length>=fo){let G=-1;for(let c=E.length-1;c>=0;c--){const h=E[c];if(h&&["ã€‚","ï¼","ï¼Ÿ",".","!","?","ï¼›",";","ï¼Œ",","].includes(h)){G=c+1;break}}G>fo*.6?(I+=E.substring(0,G)+`
`,E=E.substring(G)):(I+=E+`
`,E="")}return E&&(I+=E),I}function ee(P){return z((P||"").trim())}function J(P){const I=(P||"").trim();return z(I)}function se(P){const I=P||"";return I.includes("ã€ç¿»è¯‘å¤±è´¥ã€‘")||I.includes("[ç¿»è¯‘å¤±è´¥]")||I.includes("ç¿»è¯‘å¤±è´¥")}function O(){g.value=!g.value}function Q(){o("toggle-edit-mode")}function ae(P){const I=P.target;m.value=parseInt(I.value,10)}function U(){o("retry-failed")}function r(){l.downloadCurrentImage()}function d(){l.downloadAllImages(u.value)}function f(){l.exportText()}function C(){b.value?.click()}async function x(P){const I=P.target,E=I.files?.[0];E&&(await l.importText(E),I.value="")}return(P,I)=>D.value?(A(),L("section",Wl,[e("div",Kl,[V.value?(A(),L("button",{key:0,id:"toggleImageButton",class:"control-btn",onClick:O},te(g.value?"æŸ¥çœ‹ç¿»è¯‘å›¾":"æŸ¥çœ‹åŸå›¾"),1)):ce("",!0),e("button",{id:"toggleEditModeButton",class:Re(["control-btn",{active:n.isEditMode}]),onClick:Q},te(n.isEditMode?"é€€å‡ºç¼–è¾‘":"åˆ‡æ¢ç¼–è¾‘æ¨¡å¼"),3),e("div",ql,[I[1]||(I[1]=e("label",{for:"imageSize"},"å›¾ç‰‡å¤§å°:",-1)),e("input",{type:"range",id:"imageSize",min:"50",max:"200",value:m.value,class:"slider range-slider",onInput:ae},null,40,Hl),e("span",jl,te(m.value)+"%",1)]),v.value?(A(),L("button",{key:1,id:"retranslateFailedButton",class:"retry-failed-btn",onClick:U,title:"é‡æ–°ç¿»è¯‘æ‰€æœ‰å¤±è´¥çš„å›¾ç‰‡"}," é‡æ–°ç¿»è¯‘å¤±è´¥å›¾ç‰‡ ("+te(H(a).failedImageCount)+") ",1)):ce("",!0)]),e("div",Jl,[e("div",Yl,[e("img",{id:"translatedImageDisplay",src:B.value,alt:"ç¿»è¯‘åå›¾ç‰‡",style:ot(p.value)},null,12,Gl)])]),e("div",Xl,[I[6]||(I[6]=e("h3",null,"æ£€æµ‹åˆ°çš„æ–‡æœ¬ï¼ˆåŸæ–‡ â†’ è¯‘æ–‡ï¼‰",-1)),e("pre",Zl,[F.value?(A(!0),L(ze,{key:0},Ge(k.value,(E,K)=>(A(),L("span",{key:K,class:"text-item"},[e("span",Ql,te(ee(E.original)),1),I[2]||(I[2]=de(`
`,-1)),e("span",{class:Re(["translated-text",{"translation-error":se(E.translated)}])},te(J(E.translated)),3),I[3]||(I[3]=de(`
`,-1)),I[4]||(I[4]=e("span",{class:"separator"},"â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€",-1)),I[5]||(I[5]=de(`

`,-1))]))),128)):(A(),L(ze,{key:1},[de("æœªæ£€æµ‹åˆ°æ–‡æœ¬æˆ–å°šæœªç¿»è¯‘")],64))])]),e("div",ei,[_.value?(A(),ut(Po,{key:0,visible:!0,percentage:R.value,label:S.value||"ä¸‹è½½ä¸­ï¼Œè¯·ç¨å€™..."},null,8,["percentage","label"])):ce("",!0),e("div",ti,[e("button",{id:"downloadButton",class:"download-btn primary",disabled:!M.value,onClick:r}," ä¸‹è½½å½“å‰å›¾ç‰‡ ",8,oi),e("div",ni,[e("button",{id:"downloadAllImagesButton",class:"download-btn primary",disabled:!y.value,onClick:d}," ä¸‹è½½æ‰€æœ‰å›¾ç‰‡ ",8,si),e("div",ai,[ke(Ve,{modelValue:u.value,"onUpdate:modelValue":I[0]||(I[0]=E=>u.value=E),options:s},null,8,["modelValue"])])]),e("button",{id:"exportTextButton",class:"download-btn success",disabled:!y.value,onClick:f}," å¯¼å‡ºæ–‡æœ¬ ",8,li),e("button",{id:"importTextButton",class:"download-btn success",disabled:!y.value,onClick:C}," å¯¼å…¥æ–‡æœ¬ ",8,ii),e("input",{type:"file",ref_key:"importFileInput",ref:b,id:"importTextFileInput",style:{display:"none"},accept:".json",onChange:x},null,544)])])])):(A(),L("section",ri))}}),ci=Je(ui,[["__scopeId","data-v-7a09e8a5"]]),di={class:"guide-content"},gi={class:"guide-footer"},pi={class:"dont-show-option"},jt="saber_translator_dismiss_setup_reminder",mi=Ye({__name:"FirstTimeGuide",emits:["openSettings"],setup(n,{expose:t,emit:s}){const o=s,a=w(!1),i=w(!1);dt(()=>{localStorage.getItem(jt)!=="true"&&(a.value=!0)});function l(){i.value&&localStorage.setItem(jt,"true"),a.value=!1}function m(){localStorage.setItem(jt,"true"),a.value=!1,o("openSettings")}function g(){localStorage.removeItem(jt)}return t({resetGuideState:g,showGuide:a}),(u,b)=>(A(),ut(Bn,{"model-value":a.value,title:"æ¬¢è¿ä½¿ç”¨ Saber-Translator",onClose:l},{default:xt(()=>[e("div",di,[b[3]||(b[3]=e("div",{class:"guide-icon"},"ğŸ‰",-1)),b[4]||(b[4]=e("div",{class:"guide-message"},[e("p",{class:"guide-title"},"é¦–æ¬¡ä½¿ç”¨æé†’"),e("p",{class:"guide-text"}," åœ¨å¼€å§‹ç¿»è¯‘ä¹‹å‰ï¼Œè¯·å…ˆé…ç½®ç¿»è¯‘æœåŠ¡ã€‚ "),e("p",{class:"guide-text"},[de(" ç‚¹å‡»å³ä¸Šè§’çš„ "),e("span",{class:"highlight"},"âš™ï¸ è®¾ç½®"),de(" æŒ‰é’®ï¼Œé…ç½®ä»¥ä¸‹å†…å®¹ï¼š ")]),e("ul",{class:"guide-list"},[e("li",null,"é€‰æ‹© OCR å¼•æ“ï¼ˆæ–‡å­—è¯†åˆ«ï¼‰"),e("li",null,"é…ç½®ç¿»è¯‘æœåŠ¡å•†å’Œ API Key"),e("li",null,"ï¼ˆå¯é€‰ï¼‰é…ç½®é«˜è´¨é‡ç¿»è¯‘å’Œ AI æ ¡å¯¹")])],-1)),e("div",{class:"guide-actions"},[e("button",{class:"guide-btn primary",onClick:m},[...b[1]||(b[1]=[e("span",{class:"btn-icon"},"âš™ï¸",-1),de(" ç«‹å³é…ç½® ",-1)])]),e("button",{class:"guide-btn secondary",onClick:l}," ç¨åé…ç½® ")]),e("div",gi,[e("label",pi,[oe(e("input",{type:"checkbox","onUpdate:modelValue":b[0]||(b[0]=_=>i.value=_)},null,512),[[Xe,i.value]]),b[2]||(b[2]=e("span",null,"ä¸å†æ˜¾ç¤ºæ­¤æé†’",-1))])])])]),_:1},8,["model-value"]))}}),vi=Je(mi,[["__scopeId","data-v-eda18e4a"]]),bo="saber_translator_dismiss_setup_reminder",fi=["siliconflow","deepseek","volcano","caiyun","baidu_translate","youdao_translate","gemini","custom_openai"],bi={manga_ocr:"MangaOCR",paddle_ocr:"PaddleOCR",baidu_ocr:"ç™¾åº¦OCR",ai_vision:"AIè§†è§‰OCR"},hi=["ollama","sakura"],xi=["custom_openai"],yi=["custom_openai"],Ci={siliconflow:"SiliconFlow",deepseek:"DeepSeek",volcano:"ç«å±±å¼•æ“",caiyun:"å½©äº‘å°è¯‘",baidu_translate:"ç™¾åº¦ç¿»è¯‘",youdao_translate:"æœ‰é“ç¿»è¯‘",gemini:"Google Gemini",custom_openai:"è‡ªå®šä¹‰ OpenAI",ollama:"Ollama",sakura:"Sakura"};function On(){const n=Ee(),t=ct(),s=w(!1),o=w(!1),a=Y(()=>{try{return localStorage.getItem(bo)==="true"}catch{return!1}});function i(k){return Ci[k]||k}function l(k){return fi.includes(k)}function m(k){return hi.includes(k)}function g(k){return xi.includes(k)}function u(k){return yi.includes(k)}function b(k){return bi[k]||k}function _(){const k=n.settings,F=k.ocrEngine,z=k.baiduOcr,ee=k.aiVisionOcr,J=[];return F?(F==="baidu_ocr"&&((!z?.apiKey||z.apiKey.trim()==="")&&J.push("ç™¾åº¦OCR çš„ API Key"),(!z?.secretKey||z.secretKey.trim()==="")&&J.push("ç™¾åº¦OCR çš„ Secret Key")),F==="ai_vision"&&(ee?.provider||J.push("AIè§†è§‰OCR çš„æœåŠ¡å•†"),(!ee?.apiKey||ee.apiKey.trim()==="")&&J.push("AIè§†è§‰OCR çš„ API Key"),(!ee?.modelName||ee.modelName.trim()==="")&&J.push("AIè§†è§‰OCR çš„æ¨¡å‹åç§°"),ee?.provider==="custom"&&(!ee?.customBaseUrl||ee.customBaseUrl.trim()==="")&&J.push("AIè§†è§‰OCR çš„è‡ªå®šä¹‰ Base URL")),J.length>0?{valid:!1,message:`è¯·å…ˆåœ¨é¡¶éƒ¨ âš™ï¸ è®¾ç½®èœå•ä¸­å¡«å†™ ${J[0]}`,missingItems:J}:{valid:!0,message:""}):{valid:!1,message:"è¯·å…ˆåœ¨é¡¶éƒ¨ âš™ï¸ è®¾ç½®èœå•ä¸­é€‰æ‹© OCR å¼•æ“",missingItems:["OCR å¼•æ“"]}}function S(){const{translation:k}=n.settings,{provider:F,apiKey:z,modelName:ee,customBaseUrl:J}=k,se=[];return F?(l(F)&&(!z||z.trim()==="")&&se.push(`${i(F)} çš„ API Key`),(!ee||ee.trim()==="")&&(m(F)||l(F))&&se.push(`${i(F)} çš„æ¨¡å‹åç§°`),g(F)&&(!J||J.trim()==="")&&se.push("è‡ªå®šä¹‰ OpenAI æœåŠ¡çš„ Base URL"),se.length>0?{valid:!1,message:`è¯·å…ˆåœ¨é¡¶éƒ¨ âš™ï¸ è®¾ç½®èœå•ä¸­å¡«å†™ ${se[0]}`,missingItems:se}:{valid:!0,message:""}):{valid:!1,message:"è¯·å…ˆåœ¨é¡¶éƒ¨ âš™ï¸ è®¾ç½®èœå•ä¸­é€‰æ‹©ç¿»è¯‘æœåŠ¡å•†",missingItems:["ç¿»è¯‘æœåŠ¡å•†"]}}function R(){const{hqTranslation:k}=n.settings,{provider:F,apiKey:z,modelName:ee,customBaseUrl:J}=k,se=[];return F?((!z||z.trim()==="")&&se.push("é«˜è´¨é‡ç¿»è¯‘çš„ API Key"),(!ee||ee.trim()==="")&&se.push("é«˜è´¨é‡ç¿»è¯‘çš„æ¨¡å‹åç§°"),u(F)&&(!J||J.trim()==="")&&se.push("é«˜è´¨é‡ç¿»è¯‘çš„ Base URL"),se.length>0?{valid:!1,message:`è¯·å…ˆåœ¨é¡¶éƒ¨ âš™ï¸ è®¾ç½®èœå•ä¸­å¡«å†™ ${se[0]}`,missingItems:se}:{valid:!0,message:""}):{valid:!1,message:"è¯·å…ˆåœ¨é¡¶éƒ¨ âš™ï¸ è®¾ç½®èœå•ä¸­é€‰æ‹©é«˜è´¨é‡ç¿»è¯‘çš„æœåŠ¡å•†",missingItems:["é«˜è´¨é‡ç¿»è¯‘æœåŠ¡å•†"]}}function y(k){const F=k||n.settings.proofreading.rounds,z=[];if(!F||F.length===0)return{valid:!1,message:"è¯·å…ˆåœ¨é¡¶éƒ¨ âš™ï¸ è®¾ç½®èœå•ä¸­æ·»åŠ è‡³å°‘ä¸€ä¸ªæ ¡å¯¹è½®æ¬¡",missingItems:["æ ¡å¯¹è½®æ¬¡"]};for(let ee=0;ee<F.length;ee++){const J=F[ee];if(!J)continue;const se=J.name||`è½®æ¬¡${ee+1}`;if(J.provider||z.push(`æ ¡å¯¹ ${se} çš„æœåŠ¡å•†`),(!J.apiKey||J.apiKey.trim()==="")&&z.push(`æ ¡å¯¹ ${se} çš„ API Key`),(!J.modelName||J.modelName.trim()==="")&&z.push(`æ ¡å¯¹ ${se} çš„æ¨¡å‹åç§°`),z.length>0)return{valid:!1,message:`è¯·å…ˆåœ¨é¡¶éƒ¨ âš™ï¸ è®¾ç½®èœå•ä¸­ä¸º ${z[0]}`,missingItems:z}}return{valid:!0,message:""}}function D(k="normal",F={}){let z;switch(k){case"normal":z=S();break;case"hq":z=R();break;case"proofread":z=y(F.proofreadingRounds);break;case"ocr":z=_();break;default:z=S()}return z.valid?!0:(t.error(z.message),M(),!1)}function V(){const k=_();if(!k.valid)return t.error(k.message),M(),!1;const F=S();return F.valid?!0:(t.error(F.message),M(),!1)}function M(){const k=document.getElementById("openSettingsBtn");k&&(o.value=!0,k.style.animation="settingsBtnPulse 0.5s ease-in-out 3",k.style.boxShadow="0 0 10px var(--primary-color, #4a90d9)",setTimeout(()=>{k.style.animation="",k.style.boxShadow="",o.value=!1},3e3))}function B(){if(a.value){console.log("ç”¨æˆ·å·²é€‰æ‹©ä¸å†æ˜¾ç¤ºè®¾ç½®æé†’");return}s.value=!0}function v(k=!1){if(k)try{localStorage.setItem(bo,"true"),console.log("ç”¨æˆ·é€‰æ‹©æ°¸ä¹…å…³é—­è®¾ç½®æé†’")}catch(F){console.error("ä¿å­˜è®¾ç½®æé†’çŠ¶æ€å¤±è´¥:",F)}s.value=!1}function p(){try{localStorage.removeItem(bo),console.log("è®¾ç½®æé†’çŠ¶æ€å·²é‡ç½®")}catch(k){console.error("é‡ç½®è®¾ç½®æé†’çŠ¶æ€å¤±è´¥:",k)}}function $(){setTimeout(()=>{B()},500)}return{showSetupReminder:s,isSettingsButtonHighlighted:o,isSetupReminderDismissed:a,validateOcrConfig:_,validateTranslationConfig:S,validateHqTranslationConfig:R,validateProofreadingConfig:y,validateBeforeTranslation:D,validateFullTranslationConfig:V,highlightSettingsButton:M,checkAndShowSetupReminder:B,closeSetupReminder:v,resetSetupReminderDismiss:p,initValidation:$,getProviderDisplayName:i,getOcrEngineDisplayName:b,requiresApiKey:l,isLocalProvider:m,requiresBaseUrl:g}}const gt=eo("bubble",()=>{const n=w([]),t=w(-1),s=w([]),o=w([]),a=w(!1),i=w(-1),l=w(0),m=w(0),g=w(0),u=w(0),b=w(!1),_=w(-1),S=w(null),R=w(!1),y=w(-1),D=w(0),V=Y(()=>t.value>=0&&t.value<n.value.length?n.value[t.value]??null:null),M=Y(()=>n.value.length),B=Y(()=>n.value.length>0),v=Y(()=>t.value>=0),p=Y(()=>s.value.length>1),$=Y(()=>s.value.filter(N=>N>=0&&N<n.value.length).map(N=>n.value[N]).filter(N=>N!==void 0));function k(){const X=Ze().currentImage;X&&(X.bubbleStates=Ht(n.value),X.hasUnsavedChanges=!0,console.log("æ°”æ³¡çŠ¶æ€å·²åŒæ­¥åˆ°å½“å‰å›¾ç‰‡"))}function F(N,X=!1){n.value=N,o.value=Ht(N),U(),console.log(`æ°”æ³¡æ•°ç»„å·²è®¾ç½®ï¼Œå…± ${N.length} ä¸ªæ°”æ³¡`),X||k()}function z(N,X){const pe=ma(N),_e=Ee().settings.textStyle,$e=_e.layoutDirection,De=$e==="vertical"||$e==="horizontal"?$e:pe==="vertical"||pe==="horizontal"?pe:"vertical",re=pa({coords:N,translatedText:"",autoTextDirection:pe,fontSize:_e.fontSize,fontFamily:_e.fontFamily,textDirection:De,textColor:_e.textColor,fillColor:_e.fillColor,inpaintMethod:_e.inpaintMethod,strokeEnabled:_e.strokeEnabled,strokeColor:_e.strokeColor,strokeWidth:_e.strokeWidth,rotationAngle:0,position:{x:0,y:0},...X});return n.value.push(re),console.log(`å·²æ·»åŠ æ°”æ³¡ï¼Œå½“å‰å…± ${n.value.length} ä¸ª`),k(),re}function ee(N){return N<0||N>=n.value.length?(console.warn(`åˆ é™¤å¤±è´¥: æ— æ•ˆçš„ç´¢å¼• ${N}`),!1):(n.value.splice(N,1),t.value===N?t.value=-1:t.value>N&&t.value--,s.value=s.value.filter(X=>X!==N).map(X=>X>N?X-1:X),console.log(`å·²åˆ é™¤æ°”æ³¡ï¼Œå½“å‰å…± ${n.value.length} ä¸ª`),k(),!0)}function J(){if(s.value.length===0&&t.value<0)return;const N=[...new Set([...s.value,t.value])].filter(X=>X>=0).sort((X,pe)=>pe-X);for(const X of N)n.value.splice(X,1);U(),console.log(`å·²åˆ é™¤ ${N.length} ä¸ªæ°”æ³¡`),k()}function se(){n.value=[],o.value=[],U(),console.log("æ‰€æœ‰æ°”æ³¡å·²æ¸…é™¤"),k()}function O(){n.value=[],o.value=[],U(),console.log("æœ¬åœ°æ°”æ³¡çŠ¶æ€å·²æ¸…é™¤ï¼ˆä¸åŒæ­¥åˆ°imageStoreï¼‰")}function Q(N){N>=-1&&N<n.value.length&&(t.value=N,s.value=N>=0?[N]:[],console.log(`å·²é€‰ä¸­æ°”æ³¡ ${N}`))}function ae(N){if(N<0||N>=n.value.length)return;const X=s.value.indexOf(N);X>=0?(s.value.splice(X,1),t.value===N&&(t.value=s.value[0]??-1)):(s.value.push(N),t.value=N),console.log(`å¤šé€‰çŠ¶æ€: ${s.value.join(", ")}`)}function U(){t.value=-1,s.value=[]}function r(){t.value>=0?s.value=[t.value]:s.value=[]}function d(){if(n.value.length===0)return!1;const N=t.value<n.value.length-1?t.value+1:0;return Q(N),!0}function f(){if(n.value.length===0)return!1;const N=t.value>0?t.value-1:n.value.length-1;return Q(N),!0}function C(N,X){if(N<0||N>=n.value.length)return console.warn(`æ›´æ–°å¤±è´¥: æ— æ•ˆçš„ç´¢å¼• ${N}`),!1;const pe=n.value[N];return pe?(Object.assign(pe,X),console.log(`å·²æ›´æ–°æ°”æ³¡ ${N}`),k(),!0):!1}function x(N){return t.value<0?(console.warn("æ›´æ–°å¤±è´¥: æ²¡æœ‰é€‰ä¸­çš„æ°”æ³¡"),!1):C(t.value,N)}function P(N){const X=s.value.length>0?s.value:t.value>=0?[t.value]:[];for(const pe of X){const ye=n.value[pe];ye&&Object.assign(ye,N)}k(),console.log(`å·²æ‰¹é‡æ›´æ–° ${X.length} ä¸ªæ°”æ³¡`)}function I(N){for(let X=0;X<n.value.length;X++){const pe=n.value[X];pe&&Object.assign(pe,N)}k(),console.log(`å·²æ›´æ–°æ‰€æœ‰ ${n.value.length} ä¸ªæ°”æ³¡`)}function E(){if(n.value.length!==o.value.length)return!0;for(let N=0;N<n.value.length;N++){const X=n.value[N],pe=o.value[N];if(!(!X||!pe)&&(X.translatedText!==pe.translatedText||X.textboxText!==pe.textboxText||X.fontSize!==pe.fontSize||X.fontFamily!==pe.fontFamily||X.textDirection!==pe.textDirection||X.textColor!==pe.textColor||X.fillColor!==pe.fillColor||X.rotationAngle!==pe.rotationAngle||X.strokeEnabled!==pe.strokeEnabled||X.strokeColor!==pe.strokeColor||X.strokeWidth!==pe.strokeWidth||X.inpaintMethod!==pe.inpaintMethod||JSON.stringify(X.coords)!==JSON.stringify(pe.coords)))return!0}return!1}function K(){n.value=Ht(o.value),U(),console.log("æ°”æ³¡çŠ¶æ€å·²é‡ç½®åˆ°åˆå§‹çŠ¶æ€")}function G(){o.value=Ht(n.value),console.log("å½“å‰çŠ¶æ€å·²ä¿å­˜ä¸ºåˆå§‹çŠ¶æ€")}function c(){return{bubble_coords:n.value.map(N=>N.coords),bubble_texts:n.value.map(N=>N.translatedText),textbox_texts:n.value.map(N=>N.textboxText),font_sizes:n.value.map(N=>N.fontSize),font_families:n.value.map(N=>N.fontFamily),text_directions:n.value.map(N=>N.textDirection==="vertical"||N.textDirection==="horizontal"?N.textDirection==="vertical"?"v":"h":N.autoTextDirection==="vertical"||N.autoTextDirection==="horizontal"?N.autoTextDirection==="vertical"?"v":"h":"v"),text_colors:n.value.map(N=>N.textColor),fill_colors:n.value.map(N=>N.fillColor),rotation_angles:n.value.map(N=>N.rotationAngle),stroke_enabled:n.value.map(N=>N.strokeEnabled),stroke_colors:n.value.map(N=>N.strokeColor),stroke_widths:n.value.map(N=>N.strokeWidth),inpaint_methods:n.value.map(N=>N.inpaintMethod)}}function h(){return JSON.stringify(n.value)}function le(N){try{const X=JSON.parse(N);if(!Array.isArray(X))return console.error("ååºåˆ—åŒ–å¤±è´¥: æ•°æ®ä¸æ˜¯æ•°ç»„"),!1;const pe=[];for(const ye of X)va(ye)?pe.push(ye):console.warn("è·³è¿‡æ— æ•ˆçš„æ°”æ³¡çŠ¶æ€:",ye);return F(pe),!0}catch(X){return console.error("ååºåˆ—åŒ–å¤±è´¥:",X),!1}}return{bubbles:n,selectedIndex:t,selectedIndices:s,initialStates:o,isDragging:a,draggingIndex:i,dragOffsetX:l,dragOffsetY:m,dragInitialX:g,dragInitialY:u,isResizing:b,resizingIndex:_,resizeCurrentCoords:S,isRotating:R,rotatingIndex:y,rotateCurrentAngle:D,selectedBubble:V,bubbleCount:M,hasBubbles:B,hasSelection:v,isMultiSelect:p,selectedBubbles:$,setBubbles:F,addBubble:z,deleteBubble:ee,deleteSelected:J,clearBubbles:se,clearBubblesLocal:O,selectBubble:Q,toggleMultiSelect:ae,clearSelection:U,clearMultiSelect:r,selectNext:d,selectPrevious:f,updateBubble:C,updateSelectedBubble:x,updateAllSelected:P,updateAllBubbles:I,hasChanges:E,resetToInitial:K,saveAsInitial:G,toApiRequest:c,serialize:h,deserialize:le}}),_i=Object.freeze(Object.defineProperty({__proto__:null,useBubbleStore:gt},Symbol.toStringTag,{value:"Module"}));function ki(){const n=w({current:0,total:0,completed:0,failed:0,isInProgress:!1,label:"",percentage:0});return{progress:n,reporter:{init(s,o){n.value={current:0,total:s,completed:0,failed:0,isInProgress:!0,label:o||"å‡†å¤‡ä¸­...",percentage:0}},update(s,o){n.value.current=s,o!==void 0&&(n.value.label=o),n.value.total>0&&(n.value.percentage=Math.round(s/n.value.total*100))},setPercentage(s,o){n.value.percentage=Math.min(100,Math.max(0,s)),o!==void 0&&(n.value.label=o)},incrementCompleted(){n.value.completed++},incrementFailed(){n.value.failed++},finish(){n.value.isInProgress=!1,n.value.percentage=100},getProgress(){return{...n.value}}}}}async function bn(n){return et.post("/api/parallel/detect",n)}async function Si(n){return et.post("/api/parallel/ocr",n)}async function wi(n){return et.post("/api/parallel/color",n)}async function zn(n){return et.post("/api/parallel/translate",n)}async function $i(n){return et.post("/api/parallel/inpaint",n)}async function Ti(n){return et.post("/api/parallel/render",n)}async function zt(n){const{imageIndex:t,image:s,forceDetect:o=!1}=n,a=Ee(),i=s.bubbleStates;if(!o&&i!==null&&i!==void 0)return i.length>0?(console.log(`å›¾ç‰‡ ${t+1} å·²æœ‰ ${i.length} ä¸ªæ°”æ³¡ï¼Œè·³è¿‡æ£€æµ‹`),{bubbleCoords:i.map(b=>b.coords.map(_=>Math.round(_))),bubbleAngles:i.map(b=>b.rotationAngle||0),bubblePolygons:i.map(b=>b.polygon||[]),autoDirections:i.map(b=>b.autoTextDirection||b.textDirection||"vertical"),textMask:s.textMask??void 0,textlinesPerBubble:[],originalTexts:i.map(b=>b.originalText||"")}):(console.log(`å›¾ç‰‡ ${t+1} æ°”æ³¡å·²è¢«æ¸…ç©ºï¼Œè·³è¿‡æ£€æµ‹`),{bubbleCoords:[],bubbleAngles:[],bubblePolygons:[],autoDirections:[],textMask:void 0,textlinesPerBubble:[],originalTexts:[]});const l=a.settings,m=Ii(s.originalDataURL),g=await bn({image:m,detector_type:l.textDetector,box_expand_ratio:l.boxExpand.ratio,box_expand_top:l.boxExpand.top,box_expand_bottom:l.boxExpand.bottom,box_expand_left:l.boxExpand.left,box_expand_right:l.boxExpand.right});if(!g.success)throw new Error(g.error||"æ£€æµ‹å¤±è´¥");let u;console.log("ä½¿ç”¨ Default æ£€æµ‹å™¨ç”Ÿæˆç²¾ç¡®æ–‡å­—æ©è†œ...");try{const b=await bn({image:m,detector_type:"default",box_expand_ratio:0,box_expand_top:0,box_expand_bottom:0,box_expand_left:0,box_expand_right:0});b.success&&b.raw_mask?(u=b.raw_mask,console.log("âœ… ç²¾ç¡®æ–‡å­—æ©è†œç”ŸæˆæˆåŠŸ")):console.warn("âš ï¸ Default æ£€æµ‹å™¨æœªèƒ½ç”Ÿæˆæ©è†œ")}catch(b){console.error("âŒ ç”Ÿæˆç²¾ç¡®æ–‡å­—æ©è†œå¤±è´¥:",b)}return{bubbleCoords:g.bubble_coords||[],bubbleAngles:g.bubble_angles||[],bubblePolygons:g.bubble_polygons||[],autoDirections:g.auto_directions||[],textMask:u,textlinesPerBubble:g.textlines_per_bubble||[]}}function Ii(n){return n.includes("base64,")?n.split("base64,")[1]||"":n}function yo(n,t,s){const o=Ze(),a={bubbleCoords:t.bubbleCoords,bubbleAngles:t.bubbleAngles,textMask:t.textMask||null};s?.updateBubbleStates&&s.bubbleStates&&(a.bubbleStates=s.bubbleStates),o.updateImageByIndex(n,a)}async function Ro(n){const{image:t,bubbleCoords:s,textlinesPerBubble:o}=n;if(s.length===0)return{originalTexts:[]};const i=Ee().settings,l=Pi(t.originalDataURL),m=i.ocrEngine==="paddleocr_vl"?i.paddleOcrVl?.sourceLanguage||"japanese":i.sourceLanguage,g=await Si({image:l,bubble_coords:s,source_language:m,ocr_engine:i.ocrEngine,baidu_api_key:i.baiduOcr?.apiKey,baidu_secret_key:i.baiduOcr?.secretKey,baidu_version:i.baiduOcr?.version,baidu_ocr_language:i.baiduOcr?.sourceLanguage,ai_vision_provider:i.aiVisionOcr?.provider,ai_vision_api_key:i.aiVisionOcr?.apiKey,ai_vision_model_name:i.aiVisionOcr?.modelName,ai_vision_ocr_prompt:i.aiVisionOcr?.prompt,custom_ai_vision_base_url:i.aiVisionOcr?.customBaseUrl,textlines_per_bubble:o});if(!g.success)throw new Error(g.error||"OCRå¤±è´¥");return{originalTexts:g.original_texts||[]}}function Pi(n){return n.includes("base64,")?n.split("base64,")[1]||"":n}async function Do(n){const{image:t,bubbleCoords:s,textlinesPerBubble:o}=n;if(s.length===0)return{colors:[]};const a=Ri(t.originalDataURL),i=await wi({image:a,bubble_coords:s,textlines_per_bubble:o});if(!i.success)throw new Error(i.error||"é¢œè‰²æå–å¤±è´¥");return{colors:i.colors||[]}}function Ri(n){return n.includes("base64,")?n.split("base64,")[1]||"":n}async function Nn(n){const{originalTexts:t,rateLimiter:s=null}=n;if(t.length===0)return{translatedTexts:[],textboxTexts:[]};const a=Ee().settings;if((a.translation.translationMode||"batch")==="single"){console.log(`[ç¿»è¯‘] ä½¿ç”¨é€æ°”æ³¡ç¿»è¯‘æ¨¡å¼ï¼Œå…± ${t.length} ä¸ªæ°”æ³¡`);const l=[],m=[];for(let g=0;g<t.length;g++){const u=t[g];if(!u||u.trim()===""){l.push(""),a.useTextboxPrompt&&m.push("");continue}try{const b=a.translation.isJsonMode?a.translation.singleJsonPrompt:a.translation.singleNormalPrompt,_=await Ft({original_text:u,model_provider:a.translation.provider,model_name:a.translation.modelName,api_key:a.translation.apiKey,custom_base_url:a.translation.customBaseUrl,target_language:a.targetLanguage,prompt_content:b,use_json_format:a.translation.isJsonMode,rpm_limit_translation:a.translation.rpmLimit,max_retries:a.translation.maxRetries});if(_.success&&_.data?l.push(_.data.translated_text||""):(console.warn(`[ç¿»è¯‘] æ°”æ³¡ ${g+1} ç¿»è¯‘å¤±è´¥: ${_.error}`),l.push("ã€ç¿»è¯‘å¤±è´¥ã€‘è¯·æ£€æŸ¥ç»ˆç«¯ä¸­çš„é”™è¯¯æ—¥å¿—")),a.useTextboxPrompt&&a.textboxPrompt){const S=await Ft({original_text:u,model_provider:a.translation.provider,model_name:a.translation.modelName,api_key:a.translation.apiKey,custom_base_url:a.translation.customBaseUrl,target_language:a.targetLanguage,prompt_content:a.textboxPrompt,rpm_limit_translation:a.translation.rpmLimit,max_retries:a.translation.maxRetries});S.success&&S.data?m.push(S.data.translated_text||""):m.push("")}s&&g<t.length-1&&await s.acquire()}catch(b){console.error(`[ç¿»è¯‘] æ°”æ³¡ ${g+1} ç¿»è¯‘å‡ºé”™:`,b),l.push("ã€ç¿»è¯‘å¤±è´¥ã€‘è¯·æ£€æŸ¥ç»ˆç«¯ä¸­çš„é”™è¯¯æ—¥å¿—"),a.useTextboxPrompt&&m.push("")}}return console.log(`[ç¿»è¯‘] é€æ°”æ³¡ç¿»è¯‘å®Œæˆï¼ŒæˆåŠŸ ${l.filter(g=>g&&!g.startsWith("[ç¿»è¯‘")).length}/${t.length}`),{translatedTexts:l,textboxTexts:m}}else{console.log(`[ç¿»è¯‘] ä½¿ç”¨æ•´é¡µæ‰¹é‡ç¿»è¯‘æ¨¡å¼ï¼Œå…± ${t.length} ä¸ªæ°”æ³¡`);const l=await zn({original_texts:t,target_language:a.targetLanguage,source_language:a.sourceLanguage,model_provider:a.translation.provider,model_name:a.translation.modelName,api_key:a.translation.apiKey,custom_base_url:a.translation.customBaseUrl,prompt_content:a.translatePrompt,textbox_prompt_content:a.textboxPrompt,use_textbox_prompt:a.useTextboxPrompt,rpm_limit:a.translation.rpmLimit,max_retries:a.translation.maxRetries,use_json_format:a.translation.isJsonMode});if(!l.success)throw new Error(l.error||"ç¿»è¯‘å¤±è´¥");return{translatedTexts:l.translated_texts||[],textboxTexts:l.textbox_texts||[]}}}async function Vn(n){const s=Ee().settings,o=n.mode==="proofread",a=n.tasks.map(V=>o?{imageIndex:V.imageIndex,bubbles:(V.image.bubbleStates||[]).map((M,B)=>({bubbleIndex:B,original:M.originalText||"",translated:s.useTextboxPrompt?M.textboxText||M.translatedText||"":M.translatedText||"",textDirection:M.textDirection==="vertical"||M.textDirection==="horizontal"?M.textDirection:M.autoTextDirection==="vertical"||M.autoTextDirection==="horizontal"?M.autoTextDirection:"vertical"}))}:{imageIndex:V.imageIndex,bubbles:(V.originalTexts||[]).map((M,B)=>({bubbleIndex:B,original:M,translated:"",textDirection:V.autoDirections?.[B]||"vertical"}))}),i=n.tasks.map(V=>{const M=o&&V.image.translatedDataURL||V.image.originalDataURL;return Di(M)}),l=o?s.proofreading.rounds[0]:s.hqTranslation,m=o?l?.prompt:s.hqTranslation.prompt,g=o?"ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ¼«ç”»ç¿»è¯‘æ ¡å¯¹åŠ©æ‰‹ï¼Œèƒ½å¤Ÿæ ¹æ®æ¼«ç”»å›¾åƒå†…å®¹æ£€æŸ¥å’Œä¿®æ­£ç¿»è¯‘ã€‚":"ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ¼«ç”»ç¿»è¯‘åŠ©æ‰‹ï¼Œèƒ½å¤Ÿæ ¹æ®æ¼«ç”»å›¾åƒå†…å®¹å’Œä¸Šä¸‹æ–‡æä¾›é«˜è´¨é‡çš„ç¿»è¯‘ã€‚",u=s.hqTranslation,b=o?l:null,_=await Ut({provider:(o?b?.provider:u.provider)||"openai",api_key:(o?b?.apiKey:u.apiKey)||"",model_name:(o?b?.modelName:u.modelName)||"",custom_base_url:o?b?.customBaseUrl:u.customBaseUrl,jsonData:a,imageBase64Array:i,prompt:m||"",systemPrompt:g,isProofreading:o,enableDebugLogs:s.enableVerboseLogs,low_reasoning:o?b?.lowReasoning:u.lowReasoning,force_json_output:o?b?.forceJsonOutput:u.forceJsonOutput,no_thinking_method:o?b?.noThinkingMethod:u.noThinkingMethod,use_stream:o?b?.useStream??!0:u.useStream,max_retries:o?s.proofreading.maxRetries||2:u.maxRetries||2}),S=o?b?.forceJsonOutput||!1:u.forceJsonOutput;let y=hn(_,S)||a;if(o&&s.proofreading.rounds.length>1)for(let V=1;V<s.proofreading.rounds.length;V++){const M=s.proofreading.rounds[V],B=await Ut({provider:M.provider,api_key:M.apiKey,model_name:M.modelName,custom_base_url:M.customBaseUrl,jsonData:y,imageBase64Array:i,prompt:M.prompt,systemPrompt:g,isProofreading:!0,enableDebugLogs:s.enableVerboseLogs,low_reasoning:M.lowReasoning,force_json_output:M.forceJsonOutput,no_thinking_method:M.noThinkingMethod,use_stream:M.useStream??!0,max_retries:M.maxRetries||s.proofreading.maxRetries||2}),v=hn(B,M.forceJsonOutput);v&&(y=v)}return{results:n.tasks.map(V=>{const M=y?.find(B=>B.imageIndex===V.imageIndex);return M?{imageIndex:V.imageIndex,translatedTexts:M.bubbles.map(B=>B.translated),textboxTexts:[]}:{imageIndex:V.imageIndex,translatedTexts:[],textboxTexts:[]}})}}function Di(n){return n.includes("base64,")?n.split("base64,")[1]||"":n}function hn(n,t){if(!n.success)return console.error("APIè°ƒç”¨å¤±è´¥:",n.error),null;if(n.results&&n.results.length>0){const o=n.results[0];if(o&&"imageIndex"in o&&"bubbles"in o)return n.results}const s=n.content;if(s){let o=null;if(t)try{o=JSON.parse(s)}catch{return null}else{const a=s.match(/```json\s*([\s\S]*?)\s*```/);if(a?.[1])try{o=JSON.parse(a[1])}catch{return null}}if(o){if(Array.isArray(o))return o;if(typeof o=="object"&&"imageIndex"in o&&"bubbles"in o)return console.log("[executeAiTranslate] æ£€æµ‹åˆ°å•å¼ å›¾ç‰‡æ ¼å¼ï¼Œè‡ªåŠ¨åŒ…è£…ä¸ºæ•°ç»„"),[o]}}return null}async function Mo(n){const{image:t,bubbleCoords:s,bubblePolygons:o,textMask:a,userMask:i}=n;if(s.length===0)return{cleanImage:xn(t.originalDataURL)};const m=Ee().settings,{textStyle:g,preciseMask:u}=m,b=xn(t.originalDataURL);console.log(`ä¿®å¤æ­¥éª¤ - textMask: ${a?"âœ…":"âŒ"}, userMask: ${i?"âœ…":"âŒ"}`);const _=await $i({image:b,bubble_coords:s,bubble_polygons:o,raw_mask:a||void 0,user_mask:i||void 0,method:g.inpaintMethod==="solid"?"solid":"lama",lama_model:g.inpaintMethod==="litelama"?"litelama":"lama_mpe",fill_color:g.fillColor,mask_dilate_size:u.dilateSize,mask_box_expand_ratio:u.boxExpandRatio});if(!_.success)throw new Error(_.error||"èƒŒæ™¯ä¿®å¤å¤±è´¥");return{cleanImage:_.clean_image||""}}function xn(n){return n.includes("base64,")?n.split("base64,")[1]||"":n}async function Qt(n){const{cleanImage:t,bubbleCoords:s,bubbleAngles:o,autoDirections:a,originalTexts:i,translatedTexts:l,textboxTexts:m,colors:g,savedTextStyles:u,currentMode:b}=n;if(!t)throw b==="proofread"?new Error("æ­¤å›¾ç‰‡å°šæœªç¿»è¯‘ï¼Œè¯·å…ˆç¿»è¯‘åå†è¿›è¡Œæ ¡å¯¹"):new Error("ç¼ºå°‘å¹²å‡€èƒŒæ™¯å›¾ç‰‡");const _=Ee(),{textStyle:S}=_.settings,R=u?.autoTextDirection?"auto":u?.textDirection||S.layoutDirection,y=s.map((V,M)=>{const B=a[M]||"vertical",v=B==="v"?"vertical":B==="h"?"horizontal":B==="vertical"||B==="horizontal"?B:"vertical",p=R==="vertical"||R==="horizontal"?R:v,$=u?.useAutoTextColor??S.useAutoTextColor;let k=u?.textColor||S.textColor,F=u?.fillColor||S.fillColor;const z=g[M];return $&&z&&(z.textColor&&(k=z.textColor),z.bgColor&&(F=z.bgColor)),{coords:V,polygon:[],position:{x:0,y:0},rotationAngle:o[M]||0,originalText:i[M]||"",translatedText:l[M]||"",textboxText:m[M]||"",textDirection:p,autoTextDirection:v,fontSize:u?.fontSize||S.fontSize,fontFamily:u?.fontFamily||S.fontFamily,autoFontSize:u?.autoFontSize??S.autoFontSize,textColor:k,fillColor:F,strokeEnabled:u?.strokeEnabled??S.strokeEnabled,strokeColor:u?.strokeColor||S.strokeColor,strokeWidth:u?.strokeWidth||S.strokeWidth,inpaintMethod:u?.inpaintMethod||S.inpaintMethod,autoFgColor:g[M]?.autoFgColor||null,autoBgColor:g[M]?.autoBgColor||null}}),D=await Ti({clean_image:t,bubble_states:y,fontSize:u?.fontSize||S.fontSize,fontFamily:u?.fontFamily||S.fontFamily,textDirection:u?.textDirection||S.layoutDirection,textColor:u?.textColor||S.textColor,strokeEnabled:u?.strokeEnabled??S.strokeEnabled,strokeColor:u?.strokeColor||S.strokeColor,strokeWidth:u?.strokeWidth||S.strokeWidth,autoFontSize:u?.autoFontSize??S.autoFontSize,use_individual_styles:!0});if(!D.success)throw new Error(D.error||"æ¸²æŸ“å¤±è´¥");return{finalImage:D.final_image||"",bubbleStates:D.bubble_states||y}}const Mi=Object.freeze(Object.defineProperty({__proto__:null,executeAiTranslate:Vn,executeColor:Do,executeDetection:zt,executeInpaint:Mo,executeOcr:Ro,executeRender:Qt,executeTranslate:Nn,saveDetectionResultToImage:yo},Symbol.toStringTag,{value:"Module"}));let St=null,Nt=!1;function $t(){const n=wt();return Ee().settings.autoSaveInBookshelfMode&&n.isBookshelfMode}function Bo(){const n=wt(),t=n.currentBookId,s=n.currentChapterId;return!t||!s?null:`bookshelf/${t}/${s}`}function Wn(){const n=Ee(),{textStyle:t}=n.settings;return{fontSize:t.fontSize,autoFontSize:t.autoFontSize,fontFamily:t.fontFamily,layoutDirection:t.layoutDirection,textColor:t.textColor,useInpaintingMethod:t.inpaintMethod,fillColor:t.fillColor,strokeEnabled:t.strokeEnabled,strokeColor:t.strokeColor,strokeWidth:t.strokeWidth,useAutoTextColor:t.useAutoTextColor}}async function Kn(n){const t=Ze();if(!$t())return console.log("[AutoSave] è‡ªåŠ¨ä¿å­˜æœªå¯ç”¨æˆ–éä¹¦æ¶æ¨¡å¼ï¼Œè·³è¿‡é¢„ä¿å­˜"),!0;const s=Bo();if(!s)return console.warn("[AutoSave] ç¼ºå°‘ä¹¦ç±/ç« èŠ‚IDï¼Œè·³è¿‡é¢„ä¿å­˜"),n?.onError?.("ç¼ºå°‘ä¹¦ç±/ç« èŠ‚ID"),!1;const o=t.images,a=o.length;if(a===0)return console.warn("[AutoSave] æ²¡æœ‰å›¾ç‰‡ï¼Œè·³è¿‡é¢„ä¿å­˜"),n?.onError?.("æ²¡æœ‰å›¾ç‰‡"),!1;console.log(`[AutoSave] é¢„ä¿å­˜å¼€å§‹ï¼š${a} é¡µï¼ˆé€é¡µä¿å­˜ï¼‰`),n?.onStart?.(a);try{const{saveAllPagesSequentially:i,saveSessionMeta:l}=await it(async()=>{const{saveAllPagesSequentially:S,saveSessionMeta:R}=await Promise.resolve().then(()=>Un);return{saveAllPagesSequentially:S,saveSessionMeta:R}},void 0),m=Wn(),g=await i(s,o,{onProgress:(S,R)=>{n?.onProgress?.(S,R)}});await l(s,{ui_settings:m,total_pages:a,currentImageIndex:t.currentImageIndex});const u=wt(),b=u.currentBookId,_=u.currentChapterId;if(b&&_)try{const{apiClient:S}=await it(async()=>{const{apiClient:R}=await import("./client.Bht704G-.js");return{apiClient:R}},__vite__mapDeps([1,2]));await S.put(`/api/bookshelf/books/${b}/chapters/${_}/image-count`,{count:a}),console.log(`[AutoSave] å·²æ›´æ–°ç« èŠ‚å›¾ç‰‡æ•°é‡ä¸º ${a}`)}catch(S){console.warn("[AutoSave] æ›´æ–°ç« èŠ‚å›¾ç‰‡æ•°é‡å¤±è´¥ï¼ˆéè‡´å‘½ï¼‰:",S)}return St=s,Nt=!0,console.log(`[AutoSave] é¢„ä¿å­˜å®Œæˆï¼Œå…±ä¿å­˜ ${g}/${a} é¡µ`),n?.onComplete?.(),!0}catch(i){console.error("[AutoSave] é¢„ä¿å­˜å¤±è´¥:",i);const l=i instanceof Error?i.message:"é¢„ä¿å­˜å¤±è´¥";return n?.onError?.(l),St=null,Nt=!1,!1}}async function qn(n){if(!$t())return;const t=St||Bo();if(!t){console.warn("[AutoSave] ä¼šè¯è·¯å¾„ä¸å­˜åœ¨ï¼Œè·³è¿‡ä¿å­˜");return}const s=Ze(),o=s.images[n];if(!o){console.warn(`[AutoSave] é¡µé¢ ${n} ä¸å­˜åœ¨`);return}try{const a={};o.translatedDataURL?.startsWith("data:")&&(a.translated=o.translatedDataURL),o.cleanImageData&&typeof o.cleanImageData=="string"&&!o.cleanImageData.startsWith("/api/")&&(a.clean=o.cleanImageData.startsWith("data:")?o.cleanImageData:`data:image/png;base64,${o.cleanImageData}`);const i={};for(const m of Object.keys(o))["originalDataURL","translatedDataURL","cleanImageData"].includes(m)||(i[m]=o[m]);a.meta=i;const l=await Fn(t,n,a);if(!l.success)throw new Error(l.error||"ä¿å­˜å¤±è´¥");s.updateImageByIndex(n,{hasUnsavedChanges:!1}),console.log(`[AutoSave] é¡µé¢ ${n+1} å·²ä¿å­˜`)}catch(a){throw console.error(`[AutoSave] ä¿å­˜é¡µé¢ ${n+1} å¤±è´¥:`,a),a}}async function Hn(){if(!$t())return;const n=St||Bo();if(!n||!Nt){console.log("[AutoSave] æœªæ‰§è¡Œé¢„ä¿å­˜ï¼Œè·³è¿‡å®Œæˆä¿å­˜");return}console.log("[AutoSave] å®Œæˆä¿å­˜...");const t=Ze(),s=wt(),o=t.images.length;try{await En(n,{ui_settings:Wn(),total_pages:o,currentImageIndex:t.currentImageIndex});const a=s.currentBookId,i=s.currentChapterId;if(a&&i)try{const{apiClient:l}=await it(async()=>{const{apiClient:m}=await import("./client.Bht704G-.js");return{apiClient:m}},__vite__mapDeps([1,2]));await l.put(`/api/bookshelf/books/${a}/chapters/${i}/image-count`,{count:o}),console.log(`[AutoSave] å·²æ›´æ–°ç« èŠ‚å›¾ç‰‡æ•°é‡ä¸º ${o}`)}catch(l){console.warn("[AutoSave] æ›´æ–°ç« èŠ‚å›¾ç‰‡æ•°é‡å¤±è´¥ï¼ˆéè‡´å‘½ï¼‰:",l)}console.log("[AutoSave] ä¼šè¯ä¿å­˜å®Œæˆ")}catch(a){console.error("[AutoSave] å®Œæˆä¿å­˜å¤±è´¥:",a)}finally{St=null,Nt=!1}}function jn(){St=null,Nt=!1,console.log("[AutoSave] ä¿å­˜çŠ¶æ€å·²é‡ç½®")}const yn={standard:["detection","ocr","color","translate","inpaint","render"],hq:["detection","ocr","color","aiTranslate","inpaint","render"],proofread:["aiTranslate","render"],removeText:["detection","inpaint","render"]},Jt={detection:"æ°”æ³¡æ£€æµ‹",ocr:"æ–‡å­—è¯†åˆ«",color:"é¢œè‰²æå–",translate:"ç¿»è¯‘",aiTranslate:"AIç¿»è¯‘",inpaint:"èƒŒæ™¯ä¿®å¤",render:"æ¸²æŸ“",save:"ä¿å­˜"};function Bi(){const n=Ze(),t=gt(),s=Ee(),o=On(),a=ct(),{progress:i,reporter:l}=ki(),m=w(!1),g=w(null);let u=null,b="standard";const _=Y(()=>m.value||n.isBatchTranslationInProgress),S=Y(()=>i.value.percentage||0);function R(){const r=s.settings.translation.rpmLimit;g.value?g.value.setRpm(r):g.value=fa(r)}function y(r){const d=r.mode==="hq"?"hq":r.mode==="proofread"?"proofread":r.mode==="removeText"?"ocr":"normal";return o.validateBeforeTranslation(d)}function D(){const{textStyle:r}=s.settings,d=r.layoutDirection;u={fontFamily:r.fontFamily,fontSize:r.fontSize,autoFontSize:r.autoFontSize,autoTextDirection:d==="auto",textDirection:d==="auto"?"vertical":d,layoutDirection:d,fillColor:r.fillColor,textColor:r.textColor,rotationAngle:0,strokeEnabled:r.strokeEnabled,strokeColor:r.strokeColor,strokeWidth:r.strokeWidth,useAutoTextColor:r.useAutoTextColor,inpaintMethod:r.inpaintMethod}}function V(r){const d=n.images;if(r.scope==="current"){const f=n.currentImage;return f?[{image:f,index:n.currentImageIndex}]:[]}if(r.scope==="failed")return n.getFailedImageIndices().map(f=>({image:d[f],index:f})).filter(f=>f.image!==void 0);if(r.scope==="range"&&r.pageRange){const f=Math.max(0,r.pageRange.startPage-1),C=Math.min(d.length-1,r.pageRange.endPage-1);return f>C||f>=d.length?[]:d.slice(f,C+1).map((x,P)=>({image:x,index:f+P}))}return d.map((f,C)=>({image:f,index:C}))}async function M(r){const d=await zt({imageIndex:r.imageIndex,image:r.image,forceDetect:!1});r.bubbleCoords=d.bubbleCoords,r.bubbleAngles=d.bubbleAngles,r.bubblePolygons=d.bubblePolygons,r.autoDirections=d.autoDirections,r.textMask=d.textMask,r.textlinesPerBubble=d.textlinesPerBubble,d.originalTexts&&(r.originalTexts=d.originalTexts)}async function B(r){const d=await Ro({imageIndex:r.imageIndex,image:r.image,bubbleCoords:r.bubbleCoords,textlinesPerBubble:r.textlinesPerBubble});r.originalTexts=d.originalTexts}async function v(r){const d=await Do({imageIndex:r.imageIndex,image:r.image,bubbleCoords:r.bubbleCoords,textlinesPerBubble:r.textlinesPerBubble});r.colors=d.colors}async function p(r){const d=await Nn({imageIndex:r.imageIndex,originalTexts:r.originalTexts,rateLimiter:g.value});r.translatedTexts=d.translatedTexts,r.textboxTexts=d.textboxTexts}async function $(r){const f=await Vn({mode:b==="proofread"?"proofread":"hq",tasks:r.map(C=>({imageIndex:C.imageIndex,image:C.image,originalTexts:C.originalTexts,autoDirections:C.autoDirections}))});for(const C of r){const x=f.results.find(P=>P.imageIndex===C.imageIndex);x?(C.translatedTexts=x.translatedTexts,C.textboxTexts=x.textboxTexts):(C.translatedTexts=[],C.textboxTexts=[])}}async function k(r){const d=await Mo({imageIndex:r.imageIndex,image:r.image,bubbleCoords:r.bubbleCoords,bubblePolygons:r.bubblePolygons,textMask:r.textMask,userMask:r.image.userMask||void 0});r.cleanImage=d.cleanImage}async function F(r){const d=await Qt({imageIndex:r.imageIndex,cleanImage:r.cleanImage,bubbleCoords:r.bubbleCoords,bubbleAngles:r.bubbleAngles,autoDirections:r.autoDirections,originalTexts:r.originalTexts,translatedTexts:r.translatedTexts,textboxTexts:r.textboxTexts,colors:r.colors,savedTextStyles:u,currentMode:b});r.finalImage=d.finalImage,r.bubbleStates=d.bubbleStates}async function z(r,d){switch(r){case"detection":await M(d);break;case"ocr":await B(d);break;case"color":await v(d);break;case"translate":await p(d);break;case"inpaint":await k(d);break;case"render":await F(d);break;case"save":await qn(d.imageIndex);break;case"aiTranslate":throw new Error("aiTranslate åº”é€šè¿‡æ‰¹é‡å¤„ç†é€»è¾‘è°ƒç”¨")}}function ee(r){const d=r.finalImage?`data:image/png;base64,${r.finalImage}`:r.cleanImage?`data:image/png;base64,${r.cleanImage}`:null,{textStyle:f}=s.settings;n.updateImageByIndex(r.imageIndex,{translatedDataURL:d,cleanImageData:r.cleanImage||null,bubbleStates:r.bubbleStates,bubbleCoords:r.bubbleCoords,bubbleAngles:r.bubbleAngles,originalTexts:r.originalTexts,textboxTexts:r.textboxTexts,bubbleTexts:r.translatedTexts,textMask:r.textMask||null,userMask:r.image.userMask||null,translationStatus:"completed",translationFailed:!1,showOriginal:!1,hasUnsavedChanges:!0,fontSize:u?.fontSize??f.fontSize,autoFontSize:u?.autoFontSize??f.autoFontSize,fontFamily:u?.fontFamily??f.fontFamily,layoutDirection:u?.layoutDirection??f.layoutDirection,textColor:u?.textColor??f.textColor,fillColor:u?.fillColor??f.fillColor,strokeEnabled:u?.strokeEnabled??f.strokeEnabled,strokeColor:u?.strokeColor??f.strokeColor,strokeWidth:u?.strokeWidth??f.strokeWidth,inpaintMethod:u?.inpaintMethod??f.inpaintMethod,useAutoTextColor:u?.useAutoTextColor??f.useAutoTextColor}),r.imageIndex===n.currentImageIndex&&r.bubbleStates&&t.setBubbles(r.bubbleStates)}function J(r){return r==="standard"||r==="removeText"}function se(r){const d=s.settings;return r==="hq"?d.hqTranslation.batchSize||5:r==="proofread"?d.proofreading.rounds[0]?.batchSize||5:1}async function O(r,d,f,C){let x=0,P=0;for(let I=0;I<r.length;I++){const E=r[I];if(f.scope==="all"&&!n.isBatchTranslationInProgress){console.log("â¹ï¸ æ‰¹é‡ç¿»è¯‘å·²å–æ¶ˆï¼Œåœæ­¢å¤„ç†");break}const K=Math.floor(I/r.length*90);l.setPercentage(K,`å¤„ç†å›¾ç‰‡ ${I+1}/${r.length}`),a.info(`å¤„ç†å›¾ç‰‡ ${I+1}/${r.length}...`),n.setTranslationStatus(E.imageIndex,"processing");let G=!1;for(let c=0;c<d.length;c++){const h=d[c];if(G)break;g.value&&await g.value.acquire();try{const le=K+Math.floor(c/d.length*(90/r.length));l.setPercentage(le,`å›¾ç‰‡ ${I+1}: ${Jt[h]}`),await z(h,E)}catch(le){const N=le instanceof Error?le.message:"æœªçŸ¥é”™è¯¯";C.push(`å›¾ç‰‡ ${E.imageIndex+1}: ${h} - ${N}`),n.setTranslationStatus(E.imageIndex,"failed",N),G=!0,P++}}G||(ee(E),x++,console.log(`âœ… å›¾ç‰‡ ${I+1}/${r.length} å¤„ç†å®Œæˆ`))}return{completed:x,failed:P}}async function Q(r,d,f,C){let x=0,P=0;const I=se(f.mode),E=Math.ceil(r.length/I),K=d.indexOf("aiTranslate"),G=K>=0?d.slice(0,K):d,c=K>=0?d.slice(K+1):[];console.log(`ğŸ“¦ æ‰¹æ¬¡å¤„ç†æ¨¡å¼ï¼šå…± ${r.length} å¼ å›¾ç‰‡ï¼Œæ¯æ‰¹ ${I} å¼ ï¼Œå…± ${E} æ‰¹`),console.log(`   AIç¿»è¯‘å‰æ­¥éª¤: [${G.join(" â†’ ")}]`),console.log(`   AIç¿»è¯‘åæ­¥éª¤: [${c.join(" â†’ ")}]`);for(let h=0;h<E;h++){if(f.scope==="all"&&!n.isBatchTranslationInProgress){console.log("â¹ï¸ æ‰¹é‡ç¿»è¯‘å·²å–æ¶ˆï¼Œåœæ­¢å¤„ç†");break}const le=h*I,N=Math.min(le+I,r.length),X=r.slice(le,N),pe=Math.floor(h/E*90);l.setPercentage(pe,`å¤„ç†æ‰¹æ¬¡ ${h+1}/${E}`),a.info(`å¤„ç†æ‰¹æ¬¡ ${h+1}/${E}ï¼ˆå›¾ç‰‡ ${le+1}-${N}ï¼‰...`);for(const _e of X)n.setTranslationStatus(_e.imageIndex,"processing");const ye=new Set;for(let _e=0;_e<X.length;_e++){const $e=X[_e];for(const De of G){if(ye.has($e.imageIndex))break;g.value&&await g.value.acquire();try{const re=pe+Math.floor(_e/X.length*30);l.setPercentage(re,`å›¾ç‰‡ ${le+_e+1}: ${Jt[De]}`),await z(De,$e)}catch(re){const T=re instanceof Error?re.message:"æœªçŸ¥é”™è¯¯";C.push(`å›¾ç‰‡ ${$e.imageIndex+1}: ${De} - ${T}`),n.setTranslationStatus($e.imageIndex,"failed",T),ye.add($e.imageIndex)}}}if(K>=0){const _e=pe+40;l.setPercentage(_e,`æ‰¹æ¬¡ ${h+1}: ${Jt.aiTranslate}`);try{const $e=X.filter(De=>!ye.has(De.imageIndex));$e.length>0&&await $($e)}catch($e){const De=$e instanceof Error?$e.message:"æœªçŸ¥é”™è¯¯";C.push(`æ‰¹æ¬¡ ${h+1} AIç¿»è¯‘å¤±è´¥: ${De}`);for(const re of X)ye.has(re.imageIndex)||(n.setTranslationStatus(re.imageIndex,"failed",De),ye.add(re.imageIndex))}}for(let _e=0;_e<X.length;_e++){const $e=X[_e];if(!ye.has($e.imageIndex)){for(const De of c){if(ye.has($e.imageIndex))break;g.value&&await g.value.acquire();try{const re=pe+50+Math.floor(_e/X.length*40);l.setPercentage(re,`å›¾ç‰‡ ${le+_e+1}: ${Jt[De]}`),await z(De,$e)}catch(re){const T=re instanceof Error?re.message:"æœªçŸ¥é”™è¯¯";C.push(`å›¾ç‰‡ ${$e.imageIndex+1}: ${De} - ${T}`),n.setTranslationStatus($e.imageIndex,"failed",T),ye.add($e.imageIndex)}}ye.has($e.imageIndex)||(ee($e),x++,console.log(`âœ… å›¾ç‰‡ ${le+_e+1} å¤„ç†å®Œæˆ`))}}P+=ye.size,console.log(`âœ… æ‰¹æ¬¡ ${h+1}/${E} å¤„ç†å®Œæˆ`)}return{completed:x,failed:P}}async function ae(r){if(!y(r))return{success:!1,completed:0,failed:0,errors:["é…ç½®éªŒè¯å¤±è´¥"]};if(n.images.length===0)return a.error("è¯·å…ˆä¸Šä¼ å›¾ç‰‡"),{success:!1,completed:0,failed:0,errors:["æ²¡æœ‰å›¾ç‰‡"]};b=r.mode;const f=J(r.mode);m.value=!0,(r.scope==="all"||r.scope==="failed")&&n.setBatchTranslationInProgress(!0),R(),D();const C=V(r),x=[];if(u&&C.length>1){console.log(`ğŸ“ é¢„åˆ†å‘æ–‡å­—è®¾ç½®åˆ° ${C.length} å¼ å¾…ç¿»è¯‘å›¾ç‰‡...`);for(const{index:K}of C)n.updateImageByIndex(K,{fontSize:u.fontSize,autoFontSize:u.autoFontSize,fontFamily:u.fontFamily,layoutDirection:u.layoutDirection,textColor:u.textColor,fillColor:u.fillColor,strokeEnabled:u.strokeEnabled,strokeColor:u.strokeColor,strokeWidth:u.strokeWidth,inpaintMethod:u.inpaintMethod,useAutoTextColor:u.useAutoTextColor})}const P=$t();let I=[...yn[r.mode]];if(r.mode==="removeText"&&s.settings.removeTextWithOcr){const K=I.indexOf("detection");K!==-1&&I.splice(K+1,0,"ocr")}P&&I.push("save"),console.log("ğŸš€ é¡ºåºç®¡çº¿å¯åŠ¨"),console.log(`   æ¨¡å¼: ${r.mode}`),console.log(`   å¤„ç†æ–¹å¼: ${f?"é€å¼ å¤„ç†":"æ‰¹æ¬¡å¤„ç†"}`),console.log(`   æ­¥éª¤é“¾: [${I.join(" â†’ ")}]`),console.log(`   è‡ªåŠ¨ä¿å­˜: ${P?"å¯ç”¨":"ç¦ç”¨"}`);const E=C.map(({image:K,index:G})=>{const c={imageIndex:G,image:K,bubbleCoords:[],bubbleAngles:[],bubblePolygons:[],autoDirections:[],textMask:K.textMask||void 0,textlinesPerBubble:[],originalTexts:[],colors:[],translatedTexts:[],textboxTexts:[]};return r.mode==="proofread"&&K.bubbleStates&&K.bubbleStates.length>0&&(c.bubbleCoords=K.bubbleStates.map(h=>h.coords),c.bubbleAngles=K.bubbleStates.map(h=>h.rotationAngle||0),c.autoDirections=K.bubbleStates.map(h=>h.autoTextDirection||h.textDirection||"vertical"),c.originalTexts=K.bubbleStates.map(h=>h.originalText||""),c.translatedTexts=K.bubbleStates.map(h=>h.translatedText||""),c.textboxTexts=K.bubbleStates.map(h=>h.textboxText||""),c.colors=K.bubbleStates.map(h=>({textColor:h.textColor||"",bgColor:h.fillColor||"",autoFgColor:h.autoFgColor||null,autoBgColor:h.autoBgColor||null})),K.cleanImageData&&(c.cleanImage=K.cleanImageData)),c});try{l.init(C.length,`${r.mode} æ¨¡å¼å¯åŠ¨...`),P&&(l.setPercentage(0,"é¢„ä¿å­˜åŸå§‹å›¾ç‰‡..."),await Kn({onStart:h=>{l.setPercentage(0,`é¢„ä¿å­˜åŸå§‹å›¾ç‰‡ 0/${h}...`)},onProgress:(h,le)=>{const N=Math.round(h/le*10);l.setPercentage(N,`é¢„ä¿å­˜åŸå§‹å›¾ç‰‡ ${h}/${le}...`)},onComplete:()=>{l.setPercentage(10,"é¢„ä¿å­˜å®Œæˆï¼Œå¼€å§‹ç¿»è¯‘...")},onError:h=>{l.setPercentage(0,`é¢„ä¿å­˜å¤±è´¥: ${h}`)}})||a.warning("é¢„ä¿å­˜å¤±è´¥ï¼Œç¿»è¯‘å®Œæˆåè¯·æ‰‹åŠ¨ä¿å­˜"));let K;f?K=await O(E,I,r,x):K=await Q(E,I,r,x),l.setPercentage(100,"å®Œæˆï¼");const G={standard:"ç¿»è¯‘",hq:"é«˜è´¨é‡ç¿»è¯‘",proofread:"AIæ ¡å¯¹",removeText:"æ¶ˆé™¤æ–‡å­—"};return a.success(`${G[r.mode]}å®Œæˆï¼`),{success:K.failed===0,completed:K.completed,failed:K.failed,errors:x.length>0?x:void 0}}catch(K){const G=K instanceof Error?K.message:"æ‰§è¡Œå¤±è´¥";return a.error(G),x.push(G),{success:!1,completed:0,failed:C.length,errors:x}}finally{m.value=!1,n.setBatchTranslationInProgress(!1),P&&await Hn();const K=n.currentImageIndex,G=n.images[K];G?.bubbleStates&&G.bubbleStates.length>0&&t.setBubbles(G.bubbleStates),setTimeout(()=>l.finish(),1e3)}}function U(){n.isBatchTranslationInProgress&&(n.setBatchTranslationInProgress(!1),jn(),a.info("æ“ä½œå·²å–æ¶ˆ"))}return{progress:i,isExecuting:m,isTranslating:_,progressPercent:S,execute:ae,cancel:U,STEP_CHAIN_CONFIGS:yn}}class Ai{currentCount=0;maxCount;waitQueue=[];holders=[];constructor(t=1){this.maxCount=Math.max(1,t)}setSize(t){this.maxCount=Math.max(1,t),this.tryWakeUp()}getSize(){return this.maxCount}async acquire(t){if(this.currentCount<this.maxCount){this.currentCount++,this.holders.push(t);return}return new Promise(s=>{this.waitQueue.push({resolve:s,poolName:t})})}release(t){const s=this.holders.indexOf(t);s>=0&&(this.holders.splice(s,1),this.currentCount--),this.tryWakeUp()}tryWakeUp(){for(;this.currentCount<this.maxCount&&this.waitQueue.length>0;){const t=this.waitQueue.shift();this.currentCount++,this.holders.push(t.poolName),t.resolve()}}async withLock(t,s){await this.acquire(t);try{return await s()}finally{this.release(t)}}getStatus(){return{isLocked:this.currentCount>=this.maxCount,currentCount:this.currentCount,maxCount:this.maxCount,holders:[...this.holders],waitingCount:this.waitQueue.length,waitingPools:this.waitQueue.map(t=>t.poolName)}}isWaiting(t){return this.waitQueue.some(s=>s.poolName===t)}isHolding(t){return this.holders.includes(t)}reset(){this.currentCount=0,this.holders=[];for(const t of this.waitQueue)t.resolve();this.waitQueue=[]}}class Tt{queue=[];currentTask=null;isRunning=!1;isCancelled=!1;completedCount=0;nextPool;name;icon;lock;progressTracker;onTaskComplete;constructor(t,s,o,a,i,l){this.name=t,this.icon=s,this.nextPool=o,this.lock=a,this.progressTracker=i,this.onTaskComplete=l}getName(){return this.name}getIcon(){return this.icon}setNextPool(t){this.nextPool=t}enqueue(t){this.isCancelled||(this.queue.push(t),this.progressTracker.updatePool(this.name,{waiting:this.queue.length}),this.tryProcessNext())}enqueueBatch(t){if(!this.isCancelled){for(const s of t)this.queue.push(s);this.progressTracker.updatePool(this.name,{waiting:this.queue.length}),this.tryProcessNext()}}async tryProcessNext(){if(!(this.isRunning||this.isCancelled||this.queue.length===0)){this.isRunning=!0,this.currentTask=this.queue.shift(),this.progressTracker.updatePool(this.name,{waiting:this.queue.length,isProcessing:!0,currentPage:this.currentTask.imageIndex+1,isWaitingLock:!1});try{let t;this.lock?(this.progressTracker.updatePool(this.name,{isWaitingLock:!0}),t=await this.lock.withLock(this.name,async()=>(this.progressTracker.updatePool(this.name,{isWaitingLock:!1}),await this.process(this.currentTask)))):t=await this.process(this.currentTask),this.completedCount++,this.progressTracker.updatePool(this.name,{completed:this.completedCount}),this.nextPool&&t.status!=="failed"&&t.status!=="buffered"&&this.nextPool.enqueue(t),this.onTaskComplete?.(t)}catch(t){this.currentTask.status="failed",this.currentTask.error=t.message,console.error(`[${this.name}] å¤„ç†ä»»åŠ¡å¤±è´¥:`,t),this.onTaskComplete?.(this.currentTask)}finally{this.currentTask=null,this.isRunning=!1,this.progressTracker.updatePool(this.name,{isProcessing:!1,currentPage:void 0}),this.tryProcessNext()}}}getStatus(){return{name:this.name,icon:this.icon,waiting:this.queue.length,processing:this.isRunning,currentPage:this.currentTask?.imageIndex,completed:this.completedCount,isWaitingLock:this.lock?.isWaiting(this.name)??!1}}cancel(){this.isCancelled=!0,this.queue=[]}reset(){this.isCancelled=!1,this.queue=[],this.currentTask=null,this.isRunning=!1,this.completedCount=0}getCompletedCount(){return this.completedCount}getWaitingCount(){return this.queue.length}isProcessing(){return this.isRunning}}const Ei=[{name:"æ£€æµ‹",icon:"ğŸ“"},{name:"OCR",icon:"ğŸ“–"},{name:"é¢œè‰²",icon:"ğŸ¨"},{name:"ç¿»è¯‘",icon:"ğŸŒ"},{name:"ä¿®å¤",icon:"ğŸ–Œï¸"},{name:"æ¸²æŸ“",icon:"âœ¨"}];class Li{poolStatuses=new Map;totalPages=0;startTime=0;progress=So({pools:[],totalCompleted:0,totalFailed:0,totalPages:0,estimatedTimeRemaining:0});constructor(){this.initPools()}initPools(){for(const t of Ei){const s={name:t.name,icon:t.icon,waiting:0,processing:!1,completed:0,isWaitingLock:!1};this.poolStatuses.set(t.name,s)}this.syncToReactive()}init(t){this.totalPages=t,this.startTime=Date.now();for(const s of this.poolStatuses.values())s.waiting=0,s.processing=!1,s.currentPage=void 0,s.completed=0,s.isWaitingLock=!1;this.progress.totalCompleted=0,this.progress.totalFailed=0,this.progress.totalPages=t,this.progress.estimatedTimeRemaining=0,this.syncToReactive()}updatePool(t,s){const o=this.poolStatuses.get(t);o&&(s.waiting!==void 0&&(o.waiting=s.waiting),s.isProcessing!==void 0&&(o.processing=s.isProcessing),s.currentPage!==void 0&&(o.currentPage=s.currentPage),s.completed!==void 0&&(o.completed=s.completed),s.isWaitingLock!==void 0&&(o.isWaitingLock=s.isWaitingLock),this.syncToReactive(),this.updateEstimatedTime())}incrementCompleted(){this.progress.totalCompleted++,this.updateEstimatedTime()}incrementFailed(){this.progress.totalFailed++}updateEstimatedTime(){if(this.progress.totalCompleted===0){this.progress.estimatedTimeRemaining=0;return}const s=(Date.now()-this.startTime)/1e3/this.progress.totalCompleted,o=this.totalPages-this.progress.totalCompleted-this.progress.totalFailed;this.progress.estimatedTimeRemaining=Math.ceil(s*o)}syncToReactive(){this.progress.pools=Array.from(this.poolStatuses.values()).map(t=>({...t}))}getPoolStatus(t){return this.poolStatuses.get(t)}getAllPoolStatuses(){return Array.from(this.poolStatuses.values())}getProgress(){return{...this.progress}}reset(){this.totalPages=0,this.startTime=0,this.initPools()}formatRemainingTime(){const t=this.progress.estimatedTimeRemaining;if(t<=0)return"--";const s=Math.floor(t/60),o=t%60;return s>0?`${s}åˆ†${o}ç§’`:`${o}ç§’`}}class Fi{results=new Map;totalExpected=0;completedCount=0;failedCount=0;resolveWaitAll=null;init(t){this.results.clear(),this.totalExpected=t,this.completedCount=0,this.failedCount=0,this.resolveWaitAll=null}add(t){this.results.has(t.imageIndex)||(this.results.set(t.imageIndex,t),t.status==="completed"?this.completedCount++:t.status==="failed"&&this.failedCount++,this.completedCount+this.failedCount>=this.totalExpected&&this.resolveWaitAll&&(this.resolveWaitAll({success:this.completedCount,failed:this.failedCount}),this.resolveWaitAll=null))}waitForAll(t){return this.totalExpected=t,this.completedCount+this.failedCount>=t?Promise.resolve({success:this.completedCount,failed:this.failedCount}):new Promise(s=>{this.resolveWaitAll=s})}get(t){return this.results.get(t)}getAll(){return Array.from(this.results.values()).sort((t,s)=>t.imageIndex-s.imageIndex)}getSuccessful(){return this.getAll().filter(t=>t.status==="completed")}getFailed(){return this.getAll().filter(t=>t.status==="failed")}getStats(){return{total:this.totalExpected,completed:this.completedCount,failed:this.failedCount,pending:this.totalExpected-this.completedCount-this.failedCount}}reset(){this.results.clear(),this.totalExpected=0,this.completedCount=0,this.failedCount=0,this.resolveWaitAll=null}}class Ui extends Tt{constructor(t,s,o,a){super("æ£€æµ‹","ğŸ“",t,s,o,a)}async process(t){const{imageData:s}=t,o=await zt({imageIndex:t.imageIndex,image:s,forceDetect:!1});return t.detectionResult={bubbleCoords:o.bubbleCoords,bubbleAngles:o.bubbleAngles,bubblePolygons:o.bubblePolygons,autoDirections:o.autoDirections,textMask:o.textMask,textlinesPerBubble:o.textlinesPerBubble},t.status="processing",t}}class Oi extends Tt{constructor(t,s,o,a){super("OCR","ğŸ“–",t,s,o,a)}async process(t){const{imageData:s,detectionResult:o}=t;if(!o||o.bubbleCoords.length===0)return t.ocrResult={originalTexts:[],textlinesPerBubble:[]},t.status="processing",t;const a=await Ro({imageIndex:t.imageIndex,image:s,bubbleCoords:o.bubbleCoords,textlinesPerBubble:o.textlinesPerBubble||[]});return t.ocrResult={originalTexts:a.originalTexts,textlinesPerBubble:o.textlinesPerBubble||[]},t.status="processing",t}}class zi extends Tt{constructor(t,s,o,a){super("é¢œè‰²","ğŸ¨",t,s,o,a)}async process(t){const{imageData:s,detectionResult:o,ocrResult:a}=t;if(!o||o.bubbleCoords.length===0)return t.colorResult={colors:[]},t.status="processing",t;const i=await Do({imageIndex:t.imageIndex,image:s,bubbleCoords:o.bubbleCoords,textlinesPerBubble:a?.textlinesPerBubble||o.textlinesPerBubble||[]});return t.colorResult={colors:i.colors},t.status="processing",t}}class Ni extends Tt{mode="standard";batchBuffer=[];totalTasks=0;processedCount=0;constructor(t,s,o){super("ç¿»è¯‘","ğŸŒ",t,null,s,o)}setMode(t,s,o){this.mode=t,this.totalTasks=s,this.batchBuffer=[],this.processedCount=0,this.nextPool=o}async process(t){switch(this.mode){case"standard":return this.handleStandardTranslate(t);case"hq":return this.handleHqTranslate(t);case"proofread":return this.handleProofread(t);case"removeText":return this.handleRemoveTextOnly(t);default:return t}}async handleStandardTranslate(t){const o=Ee().settings;if(!t.ocrResult||t.ocrResult.originalTexts.length===0)return t.translateResult={translatedTexts:[],textboxTexts:[]},t.status="processing",t;const a=o.translation.translationMode||"batch",i=t.ocrResult.originalTexts;if(a==="single"){console.log(`[å¹¶è¡Œç¿»è¯‘æ± ] ä½¿ç”¨é€æ°”æ³¡ç¿»è¯‘æ¨¡å¼ï¼Œå›¾ç‰‡ ${t.imageIndex}ï¼Œå…± ${i.length} ä¸ªæ°”æ³¡`);const l=[],m=[];for(let g=0;g<i.length;g++){const u=i[g];if(!u||u.trim()===""){l.push(""),o.useTextboxPrompt&&m.push("");continue}try{const b=o.translation.isJsonMode?o.translation.singleJsonPrompt:o.translation.singleNormalPrompt,_=await Ft({original_text:u,model_provider:o.translation.provider,model_name:o.translation.modelName,api_key:o.translation.apiKey,custom_base_url:o.translation.customBaseUrl,target_language:o.targetLanguage,prompt_content:b,use_json_format:o.translation.isJsonMode,rpm_limit_translation:o.translation.rpmLimit,max_retries:o.translation.maxRetries});if(_.success&&_.data?l.push(_.data.translated_text||""):(console.warn(`[å¹¶è¡Œç¿»è¯‘æ± ] æ°”æ³¡ ${g+1} ç¿»è¯‘å¤±è´¥: ${_.error}`),l.push("ã€ç¿»è¯‘å¤±è´¥ã€‘è¯·æ£€æŸ¥ç»ˆç«¯ä¸­çš„é”™è¯¯æ—¥å¿—")),o.useTextboxPrompt&&o.textboxPrompt){const S=await Ft({original_text:u,model_provider:o.translation.provider,model_name:o.translation.modelName,api_key:o.translation.apiKey,custom_base_url:o.translation.customBaseUrl,target_language:o.targetLanguage,prompt_content:o.textboxPrompt,rpm_limit_translation:o.translation.rpmLimit,max_retries:o.translation.maxRetries});S.success&&S.data?m.push(S.data.translated_text||""):m.push("")}}catch(b){console.error(`[å¹¶è¡Œç¿»è¯‘æ± ] æ°”æ³¡ ${g+1} ç¿»è¯‘å‡ºé”™:`,b),l.push("ã€ç¿»è¯‘å¤±è´¥ã€‘è¯·æ£€æŸ¥ç»ˆç«¯ä¸­çš„é”™è¯¯æ—¥å¿—"),o.useTextboxPrompt&&m.push("")}}t.translateResult={translatedTexts:l,textboxTexts:m}}else{console.log(`[å¹¶è¡Œç¿»è¯‘æ± ] ä½¿ç”¨æ•´é¡µæ‰¹é‡ç¿»è¯‘æ¨¡å¼ï¼Œå›¾ç‰‡ ${t.imageIndex}ï¼Œå…± ${i.length} ä¸ªæ°”æ³¡`);const l=await zn({original_texts:i,target_language:o.targetLanguage,source_language:o.sourceLanguage,model_provider:o.translation.provider,model_name:o.translation.modelName,api_key:o.translation.apiKey,custom_base_url:o.translation.customBaseUrl,prompt_content:o.translatePrompt,textbox_prompt_content:o.textboxPrompt,use_textbox_prompt:o.useTextboxPrompt,rpm_limit:o.translation.rpmLimit,max_retries:o.translation.maxRetries,use_json_format:o.translation.isJsonMode});if(!l.success)throw new Error(l.error||"ç¿»è¯‘å¤±è´¥");t.translateResult={translatedTexts:l.translated_texts||[],textboxTexts:l.textbox_texts||[]}}return t.status="processing",t}async handleHqTranslate(t){this.batchBuffer.push(t),this.processedCount++;const s=Ee(),{hqTranslation:o}=s.settings,a=o.batchSize||3,i=this.processedCount>=this.totalTasks;if(!(this.batchBuffer.length>=a||i))return t.status="buffered",t;const m=[...this.batchBuffer];this.batchBuffer=[];const g=m.map(S=>({imageIndex:S.imageIndex,bubbles:(S.ocrResult?.originalTexts||[]).map((R,y)=>({bubbleIndex:y,original:R,translated:"",textDirection:S.detectionResult?.autoDirections[y]||"vertical"}))})),u=m.map(S=>this.extractBase64(S.imageData.originalDataURL)),b=await Ut({provider:o.provider,api_key:o.apiKey,model_name:o.modelName,custom_base_url:o.customBaseUrl,jsonData:g,imageBase64Array:u,prompt:o.prompt,systemPrompt:"ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ¼«ç”»ç¿»è¯‘åŠ©æ‰‹ï¼Œèƒ½å¤Ÿæ ¹æ®æ¼«ç”»å›¾åƒå†…å®¹å’Œä¸Šä¸‹æ–‡æä¾›é«˜è´¨é‡çš„ç¿»è¯‘ã€‚",isProofreading:!1,enableDebugLogs:s.settings.enableVerboseLogs,low_reasoning:o.lowReasoning,force_json_output:o.forceJsonOutput,no_thinking_method:o.noThinkingMethod,use_stream:o.useStream,max_retries:o.maxRetries||2}),_=this.parseHqResponse(b,o.forceJsonOutput);for(const S of m){const R=_?.find(y=>y.imageIndex===S.imageIndex);R?S.translateResult={translatedTexts:R.bubbles.map(y=>y.translated),textboxTexts:[]}:S.translateResult={translatedTexts:[],textboxTexts:[]},S.status="processing",this.nextPool&&this.nextPool.enqueue(S)}return t.status="buffered",t}async handleProofread(t){this.batchBuffer.push(t),this.processedCount++;const s=Ee(),{proofreading:o,useTextboxPrompt:a}=s.settings,i=o.rounds[0]?.batchSize||3,l=this.processedCount>=this.totalTasks;if(!(this.batchBuffer.length>=i||l))return t.status="buffered",t;const g=[...this.batchBuffer];this.batchBuffer=[];const u=g.map(S=>({imageIndex:S.imageIndex,bubbles:(S.imageData.bubbleStates||[]).map((R,y)=>({bubbleIndex:y,original:R.originalText||"",translated:a?R.textboxText||R.translatedText||"":R.translatedText||"",textDirection:R.textDirection==="vertical"||R.textDirection==="horizontal"?R.textDirection:R.autoTextDirection==="vertical"||R.autoTextDirection==="horizontal"?R.autoTextDirection:"vertical"}))})),b=g.map(S=>{const R=S.imageData.translatedDataURL||S.imageData.originalDataURL;return this.extractBase64(R)});let _=u;for(const S of o.rounds){const R=await Ut({provider:S.provider,api_key:S.apiKey,model_name:S.modelName,custom_base_url:S.customBaseUrl,jsonData:_,imageBase64Array:b,prompt:S.prompt,systemPrompt:"ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ¼«ç”»ç¿»è¯‘æ ¡å¯¹åŠ©æ‰‹ï¼Œèƒ½å¤Ÿæ ¹æ®æ¼«ç”»å›¾åƒå†…å®¹æ£€æŸ¥å’Œä¿®æ­£ç¿»è¯‘ã€‚",isProofreading:!0,enableDebugLogs:s.settings.enableVerboseLogs,low_reasoning:S.lowReasoning,force_json_output:S.forceJsonOutput,no_thinking_method:S.noThinkingMethod,use_stream:S.useStream??!0,max_retries:S.maxRetries||o.maxRetries||2}),y=this.parseHqResponse(R,S.forceJsonOutput);y&&(_=y)}for(const S of g){const R=_.find(y=>y.imageIndex===S.imageIndex);R?S.translateResult={translatedTexts:R.bubbles.map(y=>y.translated),textboxTexts:[]}:S.translateResult={translatedTexts:[],textboxTexts:[]},S.status="processing",this.nextPool&&this.nextPool.enqueue(S)}return t.status="buffered",t}async handleRemoveTextOnly(t){return t.translateResult={translatedTexts:[],textboxTexts:[]},t.status="processing",t}extractBase64(t){return t.includes("base64,")?t.split("base64,")[1]||"":t}parseHqResponse(t,s){if(!t.success)return console.error("APIè°ƒç”¨å¤±è´¥:",t.error),null;if(t.results&&t.results.length>0){const a=t.results[0];if(a&&"imageIndex"in a&&"bubbles"in a)return t.results}const o=t.content;if(o){let a=null;if(s)try{a=JSON.parse(o)}catch(i){return console.error("è§£æAIå¼ºåˆ¶JSONè¿”å›çš„å†…å®¹å¤±è´¥:",i),null}else{const i=o.match(/```json\s*([\s\S]*?)\s*```/);if(i?.[1])try{a=JSON.parse(i[1])}catch(l){return console.error("è§£æAIè¿”å›çš„JSONå¤±è´¥:",l),null}}if(a){if(Array.isArray(a))return a;if(typeof a=="object"&&"imageIndex"in a&&"bubbles"in a)return console.log("[TranslatePool.parseHqResponse] æ£€æµ‹åˆ°å•å¼ å›¾ç‰‡æ ¼å¼ï¼Œè‡ªåŠ¨åŒ…è£…ä¸ºæ•°ç»„"),[a]}}return null}}class Vi extends Tt{constructor(t,s,o,a){super("ä¿®å¤","ğŸ–Œï¸",t,s,o,a)}async process(t){const{imageData:s,detectionResult:o}=t;if(!o||o.bubbleCoords.length===0){const i=l=>l.includes("base64,")?l.split("base64,")[1]||"":l;return t.inpaintResult={cleanImage:i(s.originalDataURL)},t.status="processing",t}const a=await Mo({imageIndex:t.imageIndex,image:s,bubbleCoords:o.bubbleCoords,bubblePolygons:o.bubblePolygons,textMask:o.textMask,userMask:s.userMask||void 0});return t.inpaintResult={cleanImage:a.cleanImage},t.status="processing",t}}const mt=So({pools:[{name:"æ£€æµ‹",icon:"ğŸ“",waiting:0,processing:!1,completed:0,isWaitingLock:!1},{name:"OCR",icon:"ğŸ“–",waiting:0,processing:!1,completed:0,isWaitingLock:!1},{name:"é¢œè‰²",icon:"ğŸ¨",waiting:0,processing:!1,completed:0,isWaitingLock:!1},{name:"ç¿»è¯‘",icon:"ğŸŒ",waiting:0,processing:!1,completed:0,isWaitingLock:!1},{name:"ä¿®å¤",icon:"ğŸ–Œï¸",waiting:0,processing:!1,completed:0,isWaitingLock:!1},{name:"æ¸²æŸ“",icon:"âœ¨",waiting:0,processing:!1,completed:0,isWaitingLock:!1}],totalCompleted:0,totalFailed:0,totalPages:0,estimatedTimeRemaining:0,preSave:void 0,save:void 0}),Wi=w(!1);function Ao(){const n=Ze(),t=Ee(),s=Ps(null),o=Y(()=>t.settings.parallel),a=Y(()=>o.value?.enabled??!1),i=Wi,l=Y(()=>mt);function m(){const S=t.settings;return S.proofreading?.enabled&&S.proofreading.rounds.length>0?"proofread":["gemini","openai","claude","deepseek"].includes(S.hqTranslation?.provider||"")&&S.hqTranslation?.apiKey?"hq":"standard"}function g(){if(!s.value)return;const S=s.value.progress;S&&(mt.pools=S.pools.map(R=>({...R})),mt.totalCompleted=S.totalCompleted,mt.totalFailed=S.totalFailed,mt.totalPages=S.totalPages,mt.estimatedTimeRemaining=S.estimatedTimeRemaining)}async function u(S,R,y=0){if(i.value)return{success:0,failed:0,errors:["ç¿»è¯‘æ­£åœ¨è¿›è¡Œä¸­"]};const D=R??n.images;if(D.length===0)return{success:0,failed:0,errors:["æ²¡æœ‰å›¾ç‰‡"]};i.value=!0,mt.totalPages=D.length,mt.totalCompleted=0,mt.totalFailed=0;const V=setInterval(g,200);try{s.value=Hi({enabled:!0,deepLearningLockSize:o.value?.deepLearningLockSize??1});const M=S??m();console.log(`ğŸš€ å¼€å§‹å¹¶è¡Œç¿»è¯‘ï¼Œæ¨¡å¼: ${M}ï¼Œå›¾ç‰‡æ•°: ${D.length}ï¼Œèµ·å§‹ç´¢å¼•: ${y}`);const B=await s.value.execute(D,M,y);return g(),console.log(`âœ… å¹¶è¡Œç¿»è¯‘å®Œæˆï¼ŒæˆåŠŸ: ${B.success}ï¼Œå¤±è´¥: ${B.failed}`),B}catch(M){return console.error("å¹¶è¡Œç¿»è¯‘å‡ºé”™:",M),{success:0,failed:D.length,errors:[M.message]}}finally{clearInterval(V),i.value=!1}}function b(){s.value&&s.value.cancel(),i.value=!1}function _(){s.value=null,i.value=!1}return{isEnabled:a,isRunning:i,progress:l,executeParallel:u,cancel:b,reset:_,determineMode:m}}class Ki extends Tt{resultCollector;constructor(t,s,o){super("æ¸²æŸ“","âœ¨",null,null,t,o),this.resultCollector=s}async process(t){const s=Ze(),o=gt(),a=Ee(),i=t.inpaintResult?.cleanImage||t.imageData.cleanImageData||this.extractBase64(t.imageData.translatedDataURL||t.imageData.originalDataURL),l=t.detectionResult?.bubbleCoords||[],m=t.translateResult?.translatedTexts||[],g=t.ocrResult?.originalTexts||[],u=t.colorResult?.colors||[],b=t.detectionResult?.bubbleAngles||[],_=t.detectionResult?.autoDirections||[],S=t.translateResult?.textboxTexts||[];if(l.length===0)return t.renderResult={finalImage:i,bubbleStates:[]},t.status="completed",this.updateImageToUI(t,s,o,a),this.resultCollector.add(t),t;if(!t.detectionResult&&t.imageData.bubbleStates&&t.imageData.bubbleStates.length>0){const y=t.imageData.bubbleStates,D=y.map(F=>F.coords),V=y.map(F=>F.rotationAngle||0),M=y.map(F=>F.autoTextDirection||"vertical"),B=y.map(F=>F.originalText||""),v=y.map((F,z)=>m[z]||F.translatedText||""),p=y.map(F=>F.textboxText||""),$=y.map(F=>({textColor:F.textColor||"#000000",bgColor:F.fillColor||"#FFFFFF",autoFgColor:F.autoFgColor||null,autoBgColor:F.autoBgColor||null})),k=await Qt({imageIndex:t.imageIndex,cleanImage:i,bubbleCoords:D,bubbleAngles:V,autoDirections:M,originalTexts:B,translatedTexts:v,textboxTexts:p,colors:$,savedTextStyles:null,currentMode:"proofread"});return t.renderResult={finalImage:k.finalImage,bubbleStates:k.bubbleStates},t.status="completed",this.updateImageToUI(t,s,o,a),this.resultCollector.add(t),t}if(t.detectionResult&&!t.translateResult){console.log(`[æ¸²æŸ“æ± ] å›¾ç‰‡ ${t.imageIndex+1}: æ£€æµ‹åˆ°æ¶ˆé™¤æ–‡å­—æ¨¡å¼ï¼ˆæ— ç¿»è¯‘ç»“æœï¼‰ï¼Œæ„å»ºåŸºæœ¬bubbleStates`);const{textStyle:y}=a.settings,D=l.map((V,M)=>{const B=_[M]||"vertical",v=B==="v"?"vertical":B==="h"?"horizontal":B==="vertical"||B==="horizontal"?B:"vertical";return{coords:V.length>=4?[V[0],V[1],V[2],V[3]]:[0,0,0,0],polygon:[],position:{x:0,y:0},rotationAngle:b[M]||0,originalText:g[M]||"",translatedText:"",textboxText:"",textDirection:v,autoTextDirection:v,fontSize:y.fontSize,fontFamily:y.fontFamily,autoFontSize:y.autoFontSize,textColor:y.textColor,fillColor:y.fillColor,strokeEnabled:y.strokeEnabled,strokeColor:y.strokeColor,strokeWidth:y.strokeWidth,inpaintMethod:y.inpaintMethod,autoFgColor:null,autoBgColor:null}});return t.renderResult={finalImage:i,bubbleStates:D},t.status="completed",this.updateImageToUI(t,s,o,a),this.resultCollector.add(t),t}const R=await Qt({imageIndex:t.imageIndex,cleanImage:i,bubbleCoords:l,bubbleAngles:b,autoDirections:_,originalTexts:g,translatedTexts:m,textboxTexts:S,colors:u,savedTextStyles:null,currentMode:"standard"});return t.renderResult={finalImage:R.finalImage,bubbleStates:R.bubbleStates},t.status="completed",this.updateImageToUI(t,s,o,a),this.resultCollector.add(t),t}updateImageToUI(t,s,o,a){const i=t.imageIndex,l=(t.detectionResult?.bubbleCoords||[]).map(m=>m.length>=4?[m[0],m[1],m[2],m[3]]:[0,0,0,0]);s.updateImageByIndex(i,{translatedDataURL:`data:image/png;base64,${t.renderResult.finalImage}`,cleanImageData:t.inpaintResult?.cleanImage||null,bubbleStates:t.renderResult.bubbleStates,bubbleCoords:l,bubbleAngles:t.detectionResult?.bubbleAngles||[],originalTexts:t.ocrResult?.originalTexts||[],bubbleTexts:t.translateResult?.translatedTexts||[],textboxTexts:t.translateResult?.textboxTexts||[],textMask:t.detectionResult?.textMask||null,userMask:t.imageData.userMask||null,translationStatus:"completed",translationFailed:!1,showOriginal:!1,hasUnsavedChanges:!0,fontSize:t.imageData.fontSize??a.settings.textStyle.fontSize,autoFontSize:t.imageData.autoFontSize??a.settings.textStyle.autoFontSize,fontFamily:t.imageData.fontFamily??a.settings.textStyle.fontFamily,layoutDirection:t.imageData.layoutDirection??a.settings.textStyle.layoutDirection,textColor:t.imageData.textColor??a.settings.textStyle.textColor,fillColor:t.imageData.fillColor??a.settings.textStyle.fillColor,strokeEnabled:t.imageData.strokeEnabled??a.settings.textStyle.strokeEnabled,strokeColor:t.imageData.strokeColor??a.settings.textStyle.strokeColor,strokeWidth:t.imageData.strokeWidth??a.settings.textStyle.strokeWidth,inpaintMethod:t.imageData.inpaintMethod??a.settings.textStyle.inpaintMethod,useAutoTextColor:t.imageData.useAutoTextColor??a.settings.textStyle.useAutoTextColor}),i===s.currentImageIndex&&t.renderResult?.bubbleStates&&o.setBubbles(t.renderResult.bubbleStates),this.progressTracker.incrementCompleted(),$t()&&qn(i).catch(m=>{console.error(`[RenderPool] è‡ªåŠ¨ä¿å­˜å›¾ç‰‡ ${i+1} å¤±è´¥:`,m)}).finally(()=>{const{progress:m}=Ao(),g=m.value;g.save&&(g.save.completed=(g.save.completed||0)+1)}),console.log(`âœ… å›¾ç‰‡ ${i+1} æ¸²æŸ“å®Œæˆ`)}extractBase64(t){return t.includes("base64,")?t.split("base64,")[1]||"":t}}const Cn={standard:["detection","ocr","color","translate","inpaint","render"],hq:["detection","ocr","color","translate","inpaint","render"],proofread:["translate","render"],removeText:["detection","inpaint","render"]};class qi{lock;progressTracker;resultCollector;detectionPool;ocrPool;colorPool;translatePool;inpaintPool;renderPool;isCancelled=!1;config;constructor(t){this.config=t,this.lock=new Ai(t.deepLearningLockSize),this.progressTracker=new Li,this.resultCollector=new Fi,this.renderPool=new Ki(this.progressTracker,this.resultCollector),this.inpaintPool=new Vi(this.renderPool,this.lock,this.progressTracker),this.translatePool=new Ni(this.inpaintPool,this.progressTracker),this.colorPool=new zi(this.translatePool,this.lock,this.progressTracker),this.ocrPool=new Oi(this.colorPool,this.lock,this.progressTracker),this.detectionPool=new Ui(this.ocrPool,this.lock,this.progressTracker)}updateConfig(t){t.deepLearningLockSize!==void 0&&(this.lock.setSize(t.deepLearningLockSize),this.config.deepLearningLockSize=t.deepLearningLockSize),t.enabled!==void 0&&(this.config.enabled=t.enabled)}async execute(t,s,o=0){this.reset(),this.progressTracker.init(t.length),this.resultCollector.init(t.length),this.setupPoolChain(s,t.length);const a=t.map((m,g)=>({id:`task-${o+g}`,imageIndex:o+g,imageData:m,status:"pending"})),i=this.getEntryPool(s);for(const m of a)i.enqueue(m);const l=await this.resultCollector.waitForAll(t.length);return{success:l.success,failed:l.failed,errors:this.resultCollector.getFailed().map(m=>m.error||"æœªçŸ¥é”™è¯¯")}}setupPoolChain(t,s){let o=[...Cn[t]];if(t==="removeText")try{if(Ee().settings.removeTextWithOcr){const u=o.indexOf("detection");u!==-1&&!o.includes("ocr")&&o.splice(u+1,0,"ocr")}}catch{}const a=this.getPoolMap();for(let g=0;g<o.length-1;g++){const u=o[g],b=o[g+1],_=a[u],S=a[b];_&&S&&_.setNextPool(S)}const i=o[o.length-1],l=a[i];l&&l.setNextPool(null);const m=o.indexOf("translate");if(m>=0&&m<o.length-1){const g=o[m+1];this.translatePool.setMode(t,s,a[g]||null)}else m===o.length-1&&this.translatePool.setMode(t,s,null)}getPoolMap(){return{detection:this.detectionPool,ocr:this.ocrPool,color:this.colorPool,translate:this.translatePool,inpaint:this.inpaintPool,render:this.renderPool}}getEntryPool(t){const o=Cn[t][0];return this.getPoolMap()[o]||this.detectionPool}cancel(){this.isCancelled=!0,this.detectionPool.cancel(),this.ocrPool.cancel(),this.colorPool.cancel(),this.translatePool.cancel(),this.inpaintPool.cancel(),this.renderPool.cancel(),this.lock.reset()}reset(){this.isCancelled=!1,this.detectionPool.reset(),this.ocrPool.reset(),this.colorPool.reset(),this.translatePool.reset(),this.inpaintPool.reset(),this.renderPool.reset(),this.resultCollector.reset(),this.progressTracker.reset()}get progress(){return this.progressTracker.progress}getProgressTracker(){return this.progressTracker}getLockStatus(){return this.lock.getStatus()}get cancelled(){return this.isCancelled}}function Hi(n){return new qi(n)}function ji(){const n=Ze(),t=Ee(),s=ct(),o=Bi(),a=Ao(),i=Y(()=>o.isTranslating.value||n.isBatchTranslationInProgress),l=Y(()=>o.progressPercent.value);async function m(b){if(n.images.length===0)return s.error("è¯·å…ˆä¸Šä¼ å›¾ç‰‡"),{success:!1,completed:0,failed:0,errors:["æ²¡æœ‰å›¾ç‰‡"]};const _=t.settings.parallel,S=b.scope==="all"||b.scope==="range";return _?.enabled&&S?(console.log(`ğŸš€ ä½¿ç”¨å¹¶è¡Œç®¡çº¿ï¼Œæ¨¡å¼: ${b.mode}, èŒƒå›´: ${b.scope}`),g(b)):(console.log(`ğŸš€ ä½¿ç”¨é¡ºåºç®¡çº¿ï¼Œæ¨¡å¼: ${b.mode}`),o.execute(b))}async function g(b){let _=n.images,S=0;if(b.scope==="range"&&b.pageRange){S=Math.max(0,b.pageRange.startPage-1);const y=Math.min(n.images.length-1,b.pageRange.endPage-1);if(S<=y&&S<n.images.length)_=n.images.slice(S,y+1),console.log(`ğŸ¯ å¹¶è¡Œç¿»è¯‘èŒƒå›´: ç¬¬ ${b.pageRange.startPage} è‡³ ${b.pageRange.endPage} é¡µï¼Œå…± ${_.length} å¼ ï¼Œèµ·å§‹ç´¢å¼• ${S}`);else return s.error("æ— æ•ˆçš„é¡µé¢èŒƒå›´"),{success:!1,completed:0,failed:0,errors:["æ— æ•ˆçš„é¡µé¢èŒƒå›´"]}}if(_.length>1){const{textStyle:y}=t.settings;console.log(`ğŸ“ [å¹¶è¡Œæ¨¡å¼] é¢„åˆ†å‘æ–‡å­—è®¾ç½®åˆ° ${_.length} å¼ å¾…ç¿»è¯‘å›¾ç‰‡...`);for(let D=0;D<_.length;D++){const V=S+D;n.updateImageByIndex(V,{fontSize:y.fontSize,autoFontSize:y.autoFontSize,fontFamily:y.fontFamily,layoutDirection:y.layoutDirection,textColor:y.textColor,fillColor:y.fillColor,strokeEnabled:y.strokeEnabled,strokeColor:y.strokeColor,strokeWidth:y.strokeWidth,inpaintMethod:y.inpaintMethod,useAutoTextColor:y.useAutoTextColor})}}const R=$t();try{if(a.progress.value.totalPages=_.length,a.progress.value.totalCompleted=0,a.progress.value.totalFailed=0,R&&(console.log("[ParallelPipeline] æ‰§è¡Œé¢„ä¿å­˜..."),s.info("å¼€å§‹é¢„ä¿å­˜åŸå§‹å›¾ç‰‡..."),!await Kn({onStart:M=>{const B=a.progress.value;B.preSave={isRunning:!0,current:0,total:M}},onProgress:(M,B)=>{const v=a.progress.value;v.preSave&&(v.preSave.current=M,v.preSave.total=B)},onComplete:()=>{const M=a.progress.value;M.preSave&&(M.preSave.isRunning=!1),s.success("é¢„ä¿å­˜å®Œæˆï¼Œå¼€å§‹ç¿»è¯‘...")},onError:M=>{const B=a.progress.value;B.preSave=void 0,s.warning(`é¢„ä¿å­˜å¤±è´¥ï¼š${M}ï¼Œç¿»è¯‘å®Œæˆåè¯·æ‰‹åŠ¨ä¿å­˜`)}}))){const M=a.progress.value;M.preSave=void 0}const y=b.mode;if(console.log(`ğŸš€ å¯åŠ¨å¹¶è¡Œç¿»è¯‘æ¨¡å¼: ${y}`),console.log(`   å›¾ç‰‡æ•°é‡: ${_.length}`),console.log(`   èµ·å§‹ç´¢å¼•: ${S}`),console.log(`   è‡ªåŠ¨ä¿å­˜: ${R?"å¯ç”¨":"ç¦ç”¨"}`),R){const V=a.progress.value;V.save={completed:0,total:_.length}}const D=await a.executeParallel(y,_,S);return D.success>0&&D.failed===0?s.success(`å¹¶è¡Œç¿»è¯‘å®Œæˆï¼ŒæˆåŠŸå¤„ç† ${D.success} å¼ å›¾ç‰‡`):D.success>0&&D.failed>0?s.warning(`å¹¶è¡Œç¿»è¯‘å®Œæˆï¼ŒæˆåŠŸ ${D.success} å¼ ï¼Œå¤±è´¥ ${D.failed} å¼ `):s.error("å¹¶è¡Œç¿»è¯‘å¤±è´¥"),{success:D.failed===0,completed:D.success,failed:D.failed,errors:D.errors}}catch(y){const D=y instanceof Error?y.message:"å¹¶è¡Œç¿»è¯‘å‡ºé”™";return s.error(D),{success:!1,completed:0,failed:_.length,errors:[D]}}finally{const y=a.progress.value;y.preSave=void 0,y.save=void 0,R&&(console.log("[ParallelPipeline] å®Œæˆä¿å­˜..."),await Hn())}}function u(){o.cancel(),a.cancel(),jn()}return{progress:o.progress,isExecuting:o.isExecuting,isTranslating:i,progressPercent:l,execute:m,cancel:u,STEP_CHAIN_CONFIGS:o.STEP_CHAIN_CONFIGS}}function _n(n="current",t){return{mode:"standard",scope:n,pageRange:t?.pageRange}}function Ji(n="all",t){return{mode:"hq",scope:n,pageRange:t?.pageRange,batchOptions:{batchSize:t?.batchSize??3,maxRetries:t?.maxRetries??2,rpmLimit:t?.rpmLimit??10,sessionResetFrequency:t?.sessionResetFrequency??5}}}function Yi(n="all",t){return{mode:"proofread",scope:n,pageRange:t?.pageRange,batchOptions:{batchSize:t?.batchSize??3,maxRetries:t?.maxRetries??2,rpmLimit:t?.rpmLimit??10,sessionResetFrequency:t?.sessionResetFrequency??5}}}function Gi(n="current",t){return{mode:"removeText",scope:n,pageRange:t?.pageRange}}function Xi(n){if(n.length===0)return{startPage:1,endPage:0};const t=[...n].sort((a,i)=>a-i),s=t[0],o=t[t.length-1];return{startPage:(s??0)+1,endPage:(o??0)+1}}function vt(n,t){const s=[];for(let o=n;o<t;o++)s.push(o);return s}function Eo(){const n=Ze(),t=gt(),s=ct(),o=ji(),a=o.progress,i=o.isExecuting,l=o.isTranslating,m=o.progressPercent,g=Y(()=>o.isExecuting.value),u=Y(()=>o.isExecuting.value);async function b(z,ee){if(z.length===0)return s.error("æ²¡æœ‰æŒ‡å®šè¦ç¿»è¯‘çš„é¡µé¢"),{success:!1,completed:0,failed:0,errors:["æ²¡æœ‰æŒ‡å®šè¦ç¿»è¯‘çš„é¡µé¢"]};const J=n.images.length;if(J===0)return s.error("è¯·å…ˆä¸Šä¼ å›¾ç‰‡"),{success:!1,completed:0,failed:0,errors:["è¯·å…ˆä¸Šä¼ å›¾ç‰‡"]};for(const U of z)if(U<0||U>=J)return s.error(`æ— æ•ˆçš„é¡µé¢ç´¢å¼•: ${U}`),{success:!1,completed:0,failed:0,errors:[`æ— æ•ˆçš„é¡µé¢ç´¢å¼•: ${U}`]};const se=z.length===1,O=z.length===J;let Q;if(se){const U=n.currentImageIndex,r=z[0];r!==void 0&&n.setCurrentImageIndex(r),Q=_(ee,"current");const d=await o.execute(Q);return n.setCurrentImageIndex(U),{success:d.success,completed:d.completed,failed:d.failed,errors:d.errors??[]}}else if(O)Q=_(ee,"all");else{const U=Xi(z);Q=_(ee,"range",U)}const ae=await o.execute(Q);return{success:ae.success,completed:ae.completed,failed:ae.failed,errors:ae.errors??[]}}function _(z,ee,J){switch(z){case"standard":return _n(ee,J?{pageRange:J}:void 0);case"hq":return Ji(ee,J?{pageRange:J}:void 0);case"proofread":return Yi(ee,J?{pageRange:J}:void 0);case"removeText":return Gi(ee,J?{pageRange:J}:void 0);default:return _n(ee,J?{pageRange:J}:void 0)}}async function S(){return(await b([n.currentImageIndex],"standard")).success}async function R(z){return(await b([z],"standard")).success}async function y(){return(await b(vt(0,n.images.length),"standard")).success}async function D(z){const ee=vt(z.startPage-1,z.endPage);return(await b(ee,"standard")).success}function V(){o.cancel()}async function M(){return(await b([n.currentImageIndex],"removeText")).success}async function B(){return(await b(vt(0,n.images.length),"removeText")).success}async function v(z){const ee=vt(z.startPage-1,z.endPage);return(await b(ee,"removeText")).success}async function p(){const z=n.getFailedImageIndices();return z.length===0?(s.info("æ²¡æœ‰å¤±è´¥çš„å›¾ç‰‡éœ€è¦é‡æ–°ç¿»è¯‘"),!0):(await b(z,"standard")).success}async function $(z){const ee=z?vt(z.startPage-1,z.endPage):vt(0,n.images.length);return(await b(ee,"hq")).success}async function k(z){const ee=z?vt(z.startPage-1,z.endPage):vt(0,n.images.length);return(await b(ee,"proofread")).success}async function F(){if(!n.currentImage)return s.error("è¯·å…ˆä¸Šä¼ å›¾ç‰‡"),!1;const ee=t.bubbles;return!ee||ee.length===0?(s.error("å½“å‰å›¾ç‰‡æ²¡æœ‰æ°”æ³¡æ¡†ï¼Œè¯·å…ˆæ£€æµ‹æˆ–æ‰‹åŠ¨æ·»åŠ "),!1):(n.setManuallyAnnotated(!0),S())}return{progress:a,isTranslatingSingle:i,isHqTranslating:g,isProofreading:u,isTranslating:l,progressPercent:m,translatePages:b,range:vt,translateCurrentImage:S,translateImageByIndex:R,translateAllImages:y,translateImageRange:D,cancelBatchTranslation:V,removeTextOnly:M,removeAllTexts:B,removeTextRange:v,retryFailedImages:p,executeHqTranslation:$,executeProofreading:k,translateWithCurrentBubbles:F}}function Zi(){const n=gt(),t=Ze(),s=w(!1);function o(){if(!s.value)return;const a=t.currentImage;n.bubbleCount>0?t.updateCurrentBubbleStates([...n.bubbles]):a&&Array.isArray(a.bubbleStates)&&a.bubbleStates.length>0&&(t.updateCurrentBubbleStates([]),console.log("é€€å‡ºç¼–è¾‘æ¨¡å¼ï¼ˆæ— é‡æ¸²æŸ“ï¼‰ï¼Œç”¨æˆ·å·²åˆ é™¤æ‰€æœ‰æ°”æ³¡")),s.value=!1,n.clearSelection(),console.log("å·²é€€å‡ºç¼–è¾‘æ¨¡å¼ï¼ˆæ— é‡æ¸²æŸ“ï¼‰")}return{isActive:s,exitEditModeWithoutRender:o}}function Qi(){const n=In(),t=Ee(),s=Ze(),o=wt(),a=gt(),i=Zi(),l=w(!1),m=w(!1),g=w(null),u=w([]),b=w([]),_=w([]),S=w(null),R=w(null),y=w(null),D=w(null),V=w(!1);async function M(O=!1){if(!O&&(l.value||m.value)){console.log("[TranslateInit] å·²ç»åˆå§‹åŒ–ï¼Œä»…é‡æ–°åŠ è½½ä¸Šä¸‹æ–‡"),await F();return}console.log("[TranslateInit] å¼€å§‹åˆå§‹åŒ–åº”ç”¨..."),l.value=!0,g.value=null;try{await B(),await v(),await p(),await $(),await k(),await F(),console.log("[TranslateInit] åº”ç”¨åˆå§‹åŒ–å®Œæˆ"),m.value=!0}catch(Q){console.error("[TranslateInit] åº”ç”¨åˆå§‹åŒ–å¤±è´¥:",Q),g.value=Q instanceof Error?Q.message:"åˆå§‹åŒ–å¤±è´¥"}finally{l.value=!1}}async function B(){console.log("[TranslateInit] åˆå§‹åŒ–è®¾ç½®..."),t.initSettings();try{const O=await t.loadFromBackend();console.log(O?"[TranslateInit] å·²ä»åç«¯åŠ è½½è®¾ç½®":"[TranslateInit] åç«¯æ— è®¾ç½®ï¼Œä½¿ç”¨ localStorage æ•°æ®")}catch(O){console.warn("[TranslateInit] ä»åç«¯åŠ è½½è®¾ç½®å¤±è´¥ï¼Œä½¿ç”¨ localStorage æ•°æ®:",O)}console.log("[TranslateInit] è®¾ç½®åˆå§‹åŒ–å®Œæˆ")}async function v(){console.log("[TranslateInit] åˆå§‹åŒ–å­—ä½“åˆ—è¡¨...");try{const O=await Mn();O.fonts&&O.fonts.length>0?(u.value=O.fonts,console.log(`[TranslateInit] å·²åŠ è½½ ${O.fonts.length} ä¸ªå­—ä½“`)):O.error?console.warn("[TranslateInit] è·å–å­—ä½“åˆ—è¡¨å¤±è´¥:",O.error):console.warn("[TranslateInit] å­—ä½“åˆ—è¡¨ä¸ºç©º")}catch(O){console.error("[TranslateInit] è·å–å­—ä½“åˆ—è¡¨å¤±è´¥:",O)}}async function p(){console.log("[TranslateInit] åˆå§‹åŒ–ç¿»è¯‘æç¤ºè¯è®¾ç½®...");try{const O=await Hs();O.prompt_names!==void 0?(b.value=O.prompt_names||[],!t.settings.translatePrompt&&O.default_prompt_content&&t.setTranslatePrompt(O.default_prompt_content),console.log(`[TranslateInit] å·²åŠ è½½ ${b.value.length} ä¸ªç¿»è¯‘æç¤ºè¯`)):O.error&&console.warn("[TranslateInit] è·å–ç¿»è¯‘æç¤ºè¯å¤±è´¥:",O.error)}catch(O){console.error("[TranslateInit] è·å–ç¿»è¯‘æç¤ºè¯å¤±è´¥:",O)}}async function $(){console.log("[TranslateInit] åˆå§‹åŒ–æ–‡æœ¬æ¡†æç¤ºè¯è®¾ç½®...");try{const O=await qs();O.prompt_names!==void 0?(_.value=O.prompt_names||[],!t.settings.textboxPrompt&&O.default_prompt_content&&t.setTextboxPrompt(O.default_prompt_content),console.log(`[TranslateInit] å·²åŠ è½½ ${_.value.length} ä¸ªæ–‡æœ¬æ¡†æç¤ºè¯`)):O.error&&console.warn("[TranslateInit] è·å–æ–‡æœ¬æ¡†æç¤ºè¯å¤±è´¥:",O.error)}catch(O){console.error("[TranslateInit] è·å–æ–‡æœ¬æ¡†æç¤ºè¯å¤±è´¥:",O)}}async function k(){console.log("[TranslateInit] æ¸…ç† GPU èµ„æº...");try{const O=await Ws();if(O.success){const Q=O.unloaded_models||[];Q.length>0&&console.log(`[TranslateInit] å·²å¸è½½æ¨¡å‹: ${Q.join(", ")}`),console.log(`[TranslateInit] GPU æ¸…ç†å®Œæˆ - å·²åˆ†é…: ${O.memory_allocated_mb}MB, å·²é¢„ç•™: ${O.memory_reserved_mb}MB`)}else console.warn("[TranslateInit] GPU æ¸…ç†å¤±è´¥:",O.error)}catch(O){console.warn("[TranslateInit] GPU æ¸…ç†å¤±è´¥:",O)}}async function F(){const O=n.query.book,Q=n.query.chapter;if(!O||!Q){console.log("[TranslateInit] æœªæŒ‡å®šä¹¦ç±/ç« èŠ‚å‚æ•°ï¼Œä½¿ç”¨ç‹¬ç«‹æ¨¡å¼"),V.value=!1,S.value=null,R.value=null,y.value=null,D.value=null,o.clearContext();return}console.log(`[TranslateInit] æ£€æµ‹åˆ°ä¹¦ç±/ç« èŠ‚å‚æ•°: book=${O}, chapter=${Q}`),V.value=!0,S.value=O,R.value=Q;try{const ae=await Js(O);if(!ae.success||!ae.book){console.warn("[TranslateInit] ä¹¦ç±ä¸å­˜åœ¨:",O),Ce("ä¹¦ç±ä¸å­˜åœ¨","warning");return}const U=ae.book,r=U.chapters?.find(d=>d.id===Q);if(!r){console.warn("[TranslateInit] ç« èŠ‚ä¸å­˜åœ¨:",Q),Ce("ç« èŠ‚ä¸å­˜åœ¨","warning");return}if(y.value=U.title,D.value=r.title,o.setBookChapterContext(O,Q,U.title,r.title),typeof document<"u"&&(document.title=`${r.title} - ${U.title} - Saber-Translator`),r.session_path){console.log(`[TranslateInit] å°è¯•åŠ è½½ç« èŠ‚ä¼šè¯: ${r.session_path}`);try{await o.loadSessionByPath(r.session_path),Ce(`å·²åŠ è½½ç« èŠ‚: ${r.title}`,"success")}catch{console.log("[TranslateInit] ç« èŠ‚ä¼šè¯æ•°æ®ä¸å­˜åœ¨æˆ–åŠ è½½å¤±è´¥ï¼Œå°†åˆ›å»ºæ–°ä¼šè¯")}}}catch(ae){console.error("[TranslateInit] åŠ è½½ä¹¦ç±/ç« èŠ‚ä¿¡æ¯å¤±è´¥:",ae),Ce("åŠ è½½ä¹¦ç±ä¿¡æ¯å¤±è´¥","error")}}function z(O){if(O<0||O>=s.imageCount){console.warn(`[TranslateInit] æ— æ•ˆçš„å›¾ç‰‡ç´¢å¼•: ${O}`);return}window._isChangingFromSwitchImage=!0,i.isActive.value&&i.exitEditModeWithoutRender(),s.currentImage&&a.bubbles.length>0&&s.updateCurrentImageProperty("bubbleStates",a.bubbles),s.setCurrentImageIndex(O);const ae=s.currentImage;if(!ae){console.warn("[TranslateInit] åˆ‡æ¢åˆ°çš„å›¾ç‰‡ä¸å­˜åœ¨"),window._isChangingFromSwitchImage=!1;return}console.log(`[TranslateInit] åˆ‡æ¢åˆ°å›¾ç‰‡: ${O}, ${ae.fileName}`),ae.bubbleStates&&ae.bubbleStates.length>0?a.setBubbles(ae.bubbleStates,!0):a.clearBubblesLocal(),setTimeout(()=>{window._isChangingFromSwitchImage=!1,console.log("[TranslateInit] å·²é‡ç½®åˆ‡æ¢å›¾ç‰‡æ“ä½œæ ‡è®°")},100)}function ee(){s.canGoPrevious&&z(s.currentImageIndex-1)}function J(){s.canGoNext&&z(s.currentImageIndex+1)}function se(){dt(async()=>{await M()})}return{isInitializing:l,isInitialized:m,initError:g,fontList:u,promptNames:b,textboxPromptNames:_,currentBookId:S,currentChapterId:R,currentBookTitle:y,currentChapterTitle:D,isBookshelfMode:V,initializeApp:M,initializeSettings:B,initializeFontList:v,initializePromptSettings:p,initializeTextboxPromptSettings:$,initializeBookChapterContext:F,switchImage:z,goToPrevious:ee,goToNext:J,editMode:i,setupAutoInit:se}}const er={key:0,id:"translationProgressBar",class:"translation-progress-bar"},tr={class:"parallel-header"},or={class:"header-title"},nr={key:0,class:"presave-section"},sr={class:"presave-label"},ar={class:"presave-progress-bar"},lr={class:"pools-list"},ir={class:"pool-label"},rr={class:"pool-icon"},ur={class:"pool-name"},cr={class:"pool-progress-bar"},dr={class:"pool-stats"},gr={class:"completed-count"},pr={class:"total-count"},mr={key:0,class:"waiting-badge"},vr={key:1,class:"lock-indicator",title:"ç­‰å¾…æ·±åº¦å­¦ä¹ é”"},fr={key:0,class:"pool-row save-row"},br={class:"pool-progress-bar"},hr={class:"pool-stats"},xr={class:"completed-count"},yr={class:"total-count"},Cr={class:"overall-section"},_r={class:"overall-label"},kr={key:0,class:"failed-text"},Sr={class:"overall-progress-bar"},wr={class:"progress-bar-label"},$r={key:0,class:"failed-count"},Tr={class:"progress-bar"},Ir=Ye({__name:"TranslationProgress",props:{progress:{}},setup(n){const t=n,s=Ze(),o=Ee(),a=Eo(),i=Ao(),l=Y(()=>{const p=i.progress.value?.preSave?.isRunning;return o.settings.parallel?.enabled&&(i.isRunning.value||p)}),m=Y(()=>i.progress.value),g=Y(()=>{const p=m.value;return!p||p.totalPages===0?0:Math.round(p.totalCompleted/p.totalPages*100)});function u(p){const $=m.value?.totalPages||0;return $===0?0:Math.round(p.completed/$*100)}function b(){const p=m.value?.totalPages||0;return p===0?0:Math.max(3,Math.round(1/p*100))}function _(){const p=m.value?.preSave;return!p||p.total===0?0:Math.round(p.current/p.total*100)}function S(){const p=m.value?.save;return!p||p.total===0?0:Math.round(p.completed/p.total*100)}const R=Y(()=>t.progress||a.progress.value),y=Y(()=>R.value.isInProgress||s.isBatchTranslationInProgress||l.value),D=Y(()=>R.value.current),V=Y(()=>R.value.total),M=Y(()=>R.value.failed),B=Y(()=>R.value.percentage!==void 0?R.value.percentage:V.value===0?0:Math.round(D.value/V.value*100)),v=Y(()=>R.value.label?R.value.label:`ç¿»è¯‘ä¸­ï¼š${D.value} / ${V.value}`);return(p,$)=>y.value?(A(),L("div",er,[l.value&&m.value?(A(),L(ze,{key:0},[e("div",tr,[e("span",or,"ğŸš€ å¹¶è¡Œç¿»è¯‘ä¸­ï¼š"+te(m.value.totalCompleted)+"/"+te(m.value.totalPages),1)]),m.value.preSave?.isRunning?(A(),L("div",nr,[e("div",sr," ğŸ“¥ é¢„ä¿å­˜åŸå§‹å›¾ç‰‡ï¼š"+te(m.value.preSave.current)+"/"+te(m.value.preSave.total),1),e("div",ar,[e("div",{class:"presave-progress-fill",style:ot({width:_()+"%"})},null,4)])])):ce("",!0),e("div",lr,[(A(!0),L(ze,null,Ge(m.value.pools,k=>(A(),L("div",{key:k.name,class:Re(["pool-row",{"pool-processing":k.processing,"pool-waiting-lock":k.isWaitingLock}])},[e("div",ir,[e("span",rr,te(k.icon),1),e("span",ur,te(k.name),1)]),e("div",cr,[e("div",{class:"progress-completed",style:ot({width:u(k)+"%"})},null,4),k.processing?(A(),L("div",{key:0,class:"progress-processing",style:ot({left:u(k)+"%",width:b()+"%"})},null,4)):ce("",!0)]),e("div",dr,[e("span",gr,te(k.completed),1),e("span",pr,"/ "+te(m.value.totalPages),1),k.waiting>0?(A(),L("span",mr,"+"+te(k.waiting),1)):ce("",!0),k.isWaitingLock?(A(),L("span",vr,"ğŸ”’")):ce("",!0)])],2))),128)),m.value.save?(A(),L("div",fr,[$[0]||($[0]=e("div",{class:"pool-label"},[e("span",{class:"pool-icon"},"ğŸ’¾"),e("span",{class:"pool-name"},"ä¿å­˜")],-1)),e("div",br,[e("div",{class:"progress-completed save-progress",style:ot({width:S()+"%"})},null,4)]),e("div",hr,[e("span",xr,te(m.value.save.completed),1),e("span",yr,"/ "+te(m.value.save.total),1)])])):ce("",!0)]),$[1]||($[1]=e("div",{class:"divider"},null,-1)),e("div",Cr,[e("div",_r,[de(" æ€»è¿›åº¦ï¼š"+te(g.value)+"% ",1),m.value.totalFailed>0?(A(),L("span",kr," ï¼ˆ"+te(m.value.totalFailed)+" å¤±è´¥ï¼‰ ",1)):ce("",!0)]),e("div",Sr,[e("div",{class:"overall-progress-fill progress-stripe",style:ot({width:g.value+"%"})},null,4)])])],64)):(A(),L(ze,{key:1},[e("div",wr,[de(te(v.value)+" ",1),M.value>0?(A(),L("span",$r,"ï¼ˆ"+te(M.value)+" å¼ å¤±è´¥ï¼‰",1)):ce("",!0)]),e("div",Tr,[e("div",{class:"progress progress-stripe",style:ot({width:`${B.value}%`})},null,4)])],64))])):ce("",!0)}}),Pr=Je(Ir,[["__scopeId","data-v-532ece5f"]]),Rr=Ye({__name:"SponsorModal",emits:["close"],setup(n,{emit:t}){const s=t;return(o,a)=>(A(),ut(Bn,{title:"æ”¯æŒä½œè€…",onClose:a[1]||(a[1]=i=>s("close"))},{footer:xt(()=>[e("button",{type:"button",class:"btn btn-primary",onClick:a[0]||(a[0]=i=>s("close"))},"å…³é—­")]),default:xt(()=>[a[2]||(a[2]=e("div",{class:"sponsor-content"},[e("p",{class:"sponsor-message"}," å¦‚æœè¿™ä¸ªé¡¹ç›®å¯¹ä½ æœ‰å¸®åŠ©ï¼Œæ¬¢è¿è¯·ä½œè€…å–æ¯å’–å•¡ â˜• "),e("div",{class:"qr-codes"},[e("div",{class:"qr-item"},[e("div",{class:"qr-image"},[e("img",{src:"/pic/wechat_qrcode.png",alt:"å¾®ä¿¡æ”¯ä»˜"})]),e("span",{class:"qr-label"},"å¾®ä¿¡æ”¯ä»˜")]),e("div",{class:"qr-item"},[e("div",{class:"qr-image"},[e("img",{src:"/pic/alipay_qrcode.png",alt:"æ”¯ä»˜å®"})]),e("span",{class:"qr-label"},"æ”¯ä»˜å®")])]),e("p",{class:"sponsor-thanks"},"æ„Ÿè°¢æ‚¨çš„æ”¯æŒï¼ğŸ™")],-1))]),_:1}))}}),Dr=Je(Rr,[["__scopeId","data-v-02b6948e"]]);function Mr(n){const t=w(""),s=Y(()=>n.value.some(R=>R.folderPath)),o=Y(()=>{if(!s.value)return null;const R={name:"æ ¹ç›®å½•",path:"",images:[],subfolders:[]},y=new Map;y.set("",R);for(const D of n.value){const V=D.folderPath||"";if(V&&!y.has(V)){const M=V.split("/");let B="";for(const v of M){const p=B;if(B=B?`${B}/${v}`:v,!y.has(B)){const $={name:v,path:B,images:[],subfolders:[]};y.set(B,$),y.has(p)&&y.get(p).subfolders.push($)}}}y.has(V)&&y.get(V).images.push(D)}return R}),a=Y(()=>{if(!t.value)return[{name:"æ ¹ç›®å½•",path:""}];const R=t.value.split("/"),y=[{name:"æ ¹ç›®å½•",path:""}];let D="";for(const V of R)D=D?`${D}/${V}`:V,y.push({name:V,path:D});return y}),i=Y(()=>{if(!o.value)return null;if(!t.value)return o.value;const R=(y,D)=>{if(y.path===D)return y;for(const V of y.subfolders){const M=R(V,D);if(M)return M}return null};return R(o.value,t.value)}),l=Y(()=>i.value?.subfolders||[]),m=Y(()=>i.value?.images||[]);function g(R){t.value=R}function u(){if(!t.value)return;const R=t.value.lastIndexOf("/");t.value=R>0?t.value.substring(0,R):""}function b(R){t.value=R}function _(R){let y=R.images.length;for(const D of R.subfolders)y+=_(D);return y}function S(){t.value=""}return{currentFolderPath:t,useTreeMode:s,folderTree:o,breadcrumbs:a,currentFolder:i,currentSubfolders:l,currentImages:m,enterFolder:g,goUp:u,navigateTo:b,getFolderImageCount:_,resetToRoot:S}}const Br={class:"card thumbnail-card"},Ar={class:"breadcrumb-nav"},Er=["onClick"],Lr={key:0,class:"breadcrumb-sep"},Fr=["onClick"],Ur={class:"folder-info"},Or=["title"],zr={class:"folder-count"},Nr=["title","onClick"],Vr=["src","alt"],Wr={class:"page-number-indicator"},Kr={key:1,class:"translated-indicator"},qr={key:2,class:"translation-failed-indicator"},Hr={key:3,class:"labeled-indicator"},jr={key:4,class:"thumbnail-processing-indicator"},Jr={key:0,class:"empty-folder"},Yr=["title","data-index","onClick"],Gr=["src","alt"],Xr={class:"page-number-indicator"},Zr={key:1,class:"translated-indicator"},Qr={key:2,class:"translation-failed-indicator"},eu={key:3,class:"labeled-indicator"},tu={key:4,class:"thumbnail-processing-indicator"},ou={key:2,class:"empty-state"},nu=Ye({__name:"ThumbnailSidebar",props:{isVisible:{type:Boolean}},emits:["select"],setup(n,{emit:t}){const s=n,o=t,a=Ze(),i=w(null),l=w(null),m=w([]),g=Y(()=>a.images),u=Y(()=>a.currentImageIndex),b=Y(()=>a.hasImages),{useTreeMode:_,breadcrumbs:S,currentSubfolders:R,currentImages:y,currentFolderPath:D,enterFolder:V,goUp:M,navigateTo:B,getFolderImageCount:v,folderTree:p,resetToRoot:$}=Mr(g);Se(()=>g.value.length,(U,r)=>{(U===0||r===0&&U>0)&&$()});function k(U){return g.value.findIndex(r=>r.id===U.id)}function F(U){return U.translationFailed?"failed":U.isManuallyAnnotated?"labeled":U.translationStatus==="processing"?"processing":null}function z(U){return U.translationStatus==="completed"}function ee(U){o("select",U)}function J(U){V(U.path)}function se(U){B(U)}function O(){pt(()=>{const U=m.value[u.value],r=_.value&&l.value?l.value:i.value;if(U&&r){const d=U.getBoundingClientRect(),f=r.getBoundingClientRect(),C=d.top+d.height/2,x=f.top+f.height/2,P=C-x;r.scrollTo({top:r.scrollTop+P,behavior:"smooth"})}})}function Q(U,r){m.value[r]=U}function ae(U){return U.translationFailed?"ç¿»è¯‘å¤±è´¥ï¼Œç‚¹å‡»å¯é‡è¯•":U.isManuallyAnnotated?"åŒ…å«æ‰‹åŠ¨æ ‡æ³¨":U.translationStatus==="completed"?"å·²å®Œæˆç¿»è¯‘":U.fileName||""}return Se(u,()=>{O()}),Se(()=>s.isVisible,(U,r)=>{U&&!r&&O()}),dt(()=>{b.value&&O()}),(U,r)=>(A(),L("aside",{ref_key:"sidebarRef",ref:i,id:"thumbnail-sidebar",class:"thumbnail-sidebar"},[e("div",Br,[r[5]||(r[5]=e("h2",null,"å›¾ç‰‡æ¦‚è§ˆ",-1)),b.value&&H(_)&&H(p)?(A(),L(ze,{key:0},[e("div",Ar,[(A(!0),L(ze,null,Ge(H(S),(d,f)=>(A(),L(ze,{key:d.path},[e("span",{class:Re(["breadcrumb-item",{active:f===H(S).length-1}]),onClick:C=>f<H(S).length-1&&se(d.path)},te(f===0?"ğŸ“":"")+te(d.name),11,Er),f<H(S).length-1?(A(),L("span",Lr,"/")):ce("",!0)],64))),128))]),H(D)?(A(),L("div",{key:0,class:"folder-back-btn",onClick:r[0]||(r[0]=(...d)=>H(M)&&H(M)(...d))},[...r[1]||(r[1]=[e("span",{class:"back-icon"},"â¬…ï¸",-1),e("span",null,"è¿”å›ä¸Šçº§",-1)])])):ce("",!0),e("div",{ref_key:"containerRef",ref:l,class:"folder-content-list"},[(A(!0),L(ze,null,Ge(H(R),d=>(A(),L("div",{key:d.path,class:"folder-item",onClick:f=>J(d)},[r[2]||(r[2]=e("span",{class:"folder-icon"},"ğŸ“",-1)),e("div",Ur,[e("span",{class:"folder-name",title:d.name},te(d.name),9,Or),e("span",zr,"("+te(H(v)(d))+")",1)])],8,Fr))),128)),(A(!0),L(ze,null,Ge(H(y),d=>(A(),L("div",{key:d.id,ref_for:!0,ref:f=>Q(f,k(d)),class:Re(["thumbnail-item",{active:k(d)===u.value}]),title:ae(d),onClick:f=>ee(k(d))},[d.originalDataURL?(A(),L("img",{key:0,src:d.originalDataURL,alt:d.fileName,class:"thumbnail-image"},null,8,Vr)):ce("",!0),e("span",Wr,te(k(d)+1),1),z(d)?(A(),L("span",Kr,"âœ“")):ce("",!0),F(d)==="failed"?(A(),L("span",qr,"!")):F(d)==="labeled"?(A(),L("span",Hr,"âœï¸")):ce("",!0),F(d)==="processing"?(A(),L("div",jr,"âŸ³")):ce("",!0)],10,Nr))),128)),H(R).length===0&&H(y).length===0?(A(),L("div",Jr,[...r[3]||(r[3]=[e("p",null,"æ­¤æ–‡ä»¶å¤¹ä¸ºç©º",-1)])])):ce("",!0)],512)],64)):b.value?(A(),L("ul",{key:1,ref_key:"containerRef",ref:l,id:"thumbnailList",class:"thumbnail-list"},[(A(!0),L(ze,null,Ge(g.value,(d,f)=>(A(),L("li",{key:d.id,ref_for:!0,ref:C=>Q(C,f),class:Re(["thumbnail-item",{active:f===u.value}]),title:ae(d),"data-index":f,onClick:C=>ee(f)},[d.originalDataURL?(A(),L("img",{key:0,src:d.originalDataURL,alt:d.fileName,class:"thumbnail-image"},null,8,Gr)):ce("",!0),e("span",Xr,te(f+1),1),z(d)?(A(),L("span",Zr,"âœ“")):ce("",!0),F(d)==="failed"?(A(),L("span",Qr,"!")):F(d)==="labeled"?(A(),L("span",eu,"âœï¸")):ce("",!0),F(d)==="processing"?(A(),L("div",tu," âŸ³ ")):ce("",!0)],10,Yr))),128))],512)):(A(),L("div",ou,[...r[4]||(r[4]=[e("p",null,"æš‚æ— å›¾ç‰‡",-1)])]))])],512))}}),su=Je(nu,[["__scopeId","data-v-fe7c0b49"]]),au={class:"saved-prompts-picker"},lu={class:"prompts-chips-container"},iu={key:0,class:"empty-hint"},ru={key:1,class:"empty-hint"},uu=["title","onClick"],cu=Ye({__name:"SavedPromptsPicker",props:{promptType:{}},emits:["select"],setup(n,{expose:t,emit:s}){const o=n,a=s,i=w([]),l=w(!1);async function m(){l.value=!0;try{let u;o.promptType==="textbox"?u=await He.getTextboxPrompts():u=await He.getPrompts(o.promptType);const b=u.prompt_names||[];i.value=b.map(_=>({name:_}))}catch(u){console.error("åŠ è½½æç¤ºè¯åˆ—è¡¨å¤±è´¥:",u),i.value=[]}finally{l.value=!1}}async function g(u){try{let b;o.promptType==="textbox"?b=await He.getTextboxPromptContent(u):b=await He.getPromptContent(o.promptType,u),b.prompt_content&&a("select",b.prompt_content,u)}catch(b){console.error("åŠ è½½æç¤ºè¯å†…å®¹å¤±è´¥:",b)}}return Se(()=>o.promptType,()=>{m()}),dt(()=>{m()}),t({refresh:m}),(u,b)=>(A(),L("div",au,[b[1]||(b[1]=e("span",{class:"picker-label"},"ğŸ“‘ å¿«é€Ÿé€‰æ‹©:",-1)),e("div",lu,[l.value?(A(),L("span",iu,"åŠ è½½ä¸­...")):i.value.length===0?(A(),L("span",ru,"æš‚æ— ä¿å­˜çš„æç¤ºè¯")):(A(!0),L(ze,{key:2},Ge(i.value,_=>(A(),L("button",{key:_.name,type:"button",class:"prompt-chip",title:_.name,onClick:S=>g(_.name)},[b[0]||(b[0]=e("span",{class:"chip-icon"},"ğŸ“",-1)),de(" "+te(_.name),1)],8,uu))),128))])]))}}),Vt=Je(cu,[["__scopeId","data-v-2ebbb8b3"]]),du={class:"ocr-settings"},gu={class:"settings-group"},pu={class:"settings-item"},mu={class:"settings-item"},vu={class:"input-hint"},fu={class:"settings-group"},bu={class:"settings-item"},hu={class:"settings-group"},xu={class:"settings-row"},yu={class:"settings-item"},Cu={class:"password-input-wrapper"},_u=["type"],ku={key:0,class:"eye-icon"},Su={key:1,class:"eye-off-icon"},wu={class:"settings-item"},$u={class:"password-input-wrapper"},Tu=["type"],Iu={key:0,class:"eye-icon"},Pu={key:1,class:"eye-off-icon"},Ru={class:"settings-row"},Du={class:"settings-item"},Mu={class:"settings-item"},Bu=["disabled"],Au={class:"settings-group"},Eu={class:"settings-row"},Lu={class:"settings-item"},Fu={class:"settings-item"},Uu={class:"password-input-wrapper"},Ou=["type"],zu={key:0,class:"eye-icon"},Nu={key:1,class:"eye-off-icon"},Vu={class:"settings-item"},Wu={class:"settings-item"},Ku={class:"model-input-with-fetch"},qu=["disabled"],Hu={class:"fetch-text"},ju={key:0,class:"model-select-container"},Ju={class:"model-count"},Yu={class:"settings-item"},Gu={class:"prompt-format-selector"},Xu={class:"settings-item"},Zu={class:"settings-item"},Qu=["disabled"],ec=Ye({__name:"OcrSettings",setup(n){const t=[{label:"MangaOCR (æ—¥è¯­ä¸“ç”¨)",value:"manga_ocr"},{label:"PaddleOCR (å¤šè¯­è¨€)",value:"paddle_ocr"},{label:"PaddleOCR-VL",value:"paddleocr_vl"},{label:"ç™¾åº¦OCR",value:"baidu_ocr"},{label:"48px OCR",value:"48px_ocr"},{label:"AIè§†è§‰OCR",value:"ai_vision"}],s=[{label:"æ ‡å‡†ç‰ˆ",value:"standard"},{label:"é«˜ç²¾åº¦ç‰ˆ",value:"high_precision"}],o=[{label:"è‡ªåŠ¨æ£€æµ‹",value:"auto_detect"},{label:"ä¸­è‹±æ–‡æ··åˆ",value:"CHN_ENG"},{label:"è‹±æ–‡",value:"ENG"},{label:"æ—¥è¯­",value:"JAP"},{label:"éŸ©è¯­",value:"KOR"},{label:"æ³•è¯­",value:"FRE"},{label:"å¾·è¯­",value:"GER"},{label:"ä¿„è¯­",value:"RUS"}],a=[{label:"SiliconFlow (ç¡…åŸºæµåŠ¨)",value:"siliconflow"},{label:"ç«å±±å¼•æ“",value:"volcano"},{label:"Google Gemini",value:"gemini"},{label:"è‡ªå®šä¹‰ OpenAI å…¼å®¹æœåŠ¡",value:"custom_openai_vision"}],i=[{label:"ğŸŒ ä¸œäºšè¯­è¨€",options:[{label:"æ—¥è¯­",value:"japanese"},{label:"ç®€ä½“ä¸­æ–‡",value:"chinese"},{label:"ç¹ä½“ä¸­æ–‡",value:"chinese_cht"},{label:"éŸ©è¯­",value:"korean"}]},{label:"ğŸŒ æ‹‰ä¸è¯­ç³»",options:[{label:"è‹±è¯­",value:"english"},{label:"æ³•è¯­",value:"french"},{label:"å¾·è¯­",value:"german"},{label:"è¥¿ç­ç‰™è¯­",value:"spanish"},{label:"æ„å¤§åˆ©è¯­",value:"italian"},{label:"è‘¡è„ç‰™è¯­",value:"portuguese"},{label:"è·å…°è¯­",value:"dutch"},{label:"æ³¢å…°è¯­",value:"polish"}]},{label:"ğŸŒ ä¸œå—äºšè¯­è¨€",options:[{label:"æ³°è¯­",value:"thai"},{label:"è¶Šå—è¯­",value:"vietnamese"},{label:"å°å°¼è¯­",value:"indonesian"},{label:"é©¬æ¥è¯­",value:"malay"}]},{label:"ğŸŒ å…¶ä»–è¯­ç³»",options:[{label:"ä¿„è¯­",value:"russian"},{label:"é˜¿æ‹‰ä¼¯è¯­",value:"arabic"},{label:"å°åœ°è¯­",value:"hindi"},{label:"åœŸè€³å…¶è¯­",value:"turkish"},{label:"å¸Œè…Šè¯­",value:"greek"},{label:"å¸Œä¼¯æ¥è¯­",value:"hebrew"}]}],l=[{label:"æ™®é€šæç¤ºè¯",value:"false"},{label:"JSONæç¤ºè¯",value:"true"}],m=[{label:"ğŸš€ å¸¸ç”¨è¯­è¨€",options:[{label:"æ—¥è¯­",value:"japanese"},{label:"è‹±è¯­",value:"en"},{label:"ç®€ä½“ä¸­æ–‡",value:"chinese"},{label:"ç¹ä½“ä¸­æ–‡",value:"chinese_cht"},{label:"éŸ©è¯­",value:"korean"}]},{label:"ğŸŒ æ‹‰ä¸è¯­ç³»",options:[{label:"æ³•è¯­",value:"french"},{label:"å¾·è¯­",value:"german"},{label:"è¥¿ç­ç‰™è¯­",value:"spanish"},{label:"æ„å¤§åˆ©è¯­",value:"italian"},{label:"è‘¡è„ç‰™è¯­",value:"portuguese"}]},{label:"ğŸŒ å…¶ä»–è¯­ç³»",options:[{label:"ä¿„è¯­",value:"russian"}]}],g=Ee(),u=ct(),b=w({apiKey:g.settings.baiduOcr.apiKey,secretKey:g.settings.baiduOcr.secretKey,version:g.settings.baiduOcr.version,sourceLanguage:g.settings.baiduOcr.sourceLanguage}),_=w({apiKey:g.settings.aiVisionOcr.apiKey,modelName:g.settings.aiVisionOcr.modelName,customBaseUrl:g.settings.aiVisionOcr.customBaseUrl,prompt:g.settings.aiVisionOcr.prompt,rpmLimit:g.settings.aiVisionOcr.rpmLimit,minImageSize:g.settings.aiVisionOcr.minImageSize}),S=Y(()=>g.settings);Se(()=>b.value.apiKey,U=>{g.updateBaiduOcr({apiKey:U})}),Se(()=>b.value.secretKey,U=>{g.updateBaiduOcr({secretKey:U})}),Se(()=>b.value.version,U=>{g.updateBaiduOcr({version:U})}),Se(()=>b.value.sourceLanguage,U=>{g.updateBaiduOcr({sourceLanguage:U})}),Se(()=>_.value.apiKey,U=>{g.updateAiVisionOcr({apiKey:U})}),Se(()=>_.value.modelName,U=>{g.updateAiVisionOcr({modelName:U})}),Se(()=>_.value.customBaseUrl,U=>{g.updateAiVisionOcr({customBaseUrl:U})}),Se(()=>_.value.prompt,U=>{g.updateAiVisionOcr({prompt:U})}),Se(()=>_.value.rpmLimit,U=>{g.updateAiVisionOcr({rpmLimit:U})}),Se(()=>_.value.minImageSize,U=>{g.updateAiVisionOcr({minImageSize:U})});const R=w(!1),y=w(!1),D=w(!1),V=w(!1),M=w(!1),B=w([]),v=Y(()=>{const U=[{label:"-- é€‰æ‹©æ¨¡å‹ --",value:""}];return B.value.forEach(r=>{U.push({label:r,value:r})}),U});function p(){g.saveToStorage()}function $(){g.saveToStorage()}function k(U){g.updatePaddleOcrVl({sourceLanguage:U})}function F(){switch(g.settings.ocrEngine){case"manga_ocr":return"MangaOCR ä¸“ä¸ºæ—¥è¯­æ¼«ç”»ä¼˜åŒ–ï¼Œæºè¯­è¨€è®¾ç½®ä¸å½±å“è¯†åˆ«";case"paddle_ocr":return"PaddleOCR ä¼šæ ¹æ®æºè¯­è¨€åŠ è½½å¯¹åº”çš„è¯†åˆ«æ¨¡å‹";case"paddleocr_vl":return"PaddleOCR-VL åŸºäº VLM å¾®è°ƒï¼Œä¸“ä¸ºæ—¥è¯­æ¼«ç”»ä¼˜åŒ–ï¼Œå‡†ç¡®ç‡é«˜è¾¾ 70%";case"baidu_ocr":return"ç™¾åº¦OCR ä½¿ç”¨ç‹¬ç«‹çš„æºè¯­è¨€è®¾ç½®ï¼ˆè§ä¸‹æ–¹ï¼‰";case"ai_vision":return"AIè§†è§‰OCR é€šè¿‡æç¤ºè¯æŒ‡å®šè¯†åˆ«è¯­è¨€";case"48px_ocr":return"48px OCR æ”¯æŒæ—¥ä¸­è‹±éŸ©ç­‰å¤šè¯­è¨€ï¼Œæºè¯­è¨€è®¾ç½®ä¸å½±å“è¯†åˆ«";default:return"é€‰æ‹©è¦è¯†åˆ«çš„åŸæ–‡è¯­è¨€"}}function z(U){g.setAiVisionOcrProvider(U),B.value=[],ee()}function ee(){_.value.apiKey=g.settings.aiVisionOcr.apiKey,_.value.modelName=g.settings.aiVisionOcr.modelName,_.value.customBaseUrl=g.settings.aiVisionOcr.customBaseUrl,_.value.prompt=g.settings.aiVisionOcr.prompt,_.value.rpmLimit=g.settings.aiVisionOcr.rpmLimit,_.value.minImageSize=g.settings.aiVisionOcr.minImageSize}function J(){const U=g.settings.aiVisionOcr.isJsonMode?ys:Cs;g.updateAiVisionOcr({prompt:U}),_.value.prompt=U}async function se(){const U=b.value.apiKey?.trim(),r=b.value.secretKey?.trim();if(!U||!r){u.warning("è¯·å¡«å†™ç™¾åº¦OCRçš„API Keyå’ŒSecret Key");return}V.value=!0,u.info("æ­£åœ¨æµ‹è¯•ç™¾åº¦OCRè¿æ¥...");try{const d=await He.testBaiduOcrConnection(U,r);d.success?u.success(d.message||"ç™¾åº¦OCRè¿æ¥æˆåŠŸ!"):u.error(d.message||d.error||"ç™¾åº¦OCRè¿æ¥å¤±è´¥")}catch(d){const f=d instanceof Error?d.message:"è¿æ¥æµ‹è¯•å¤±è´¥";u.error(f)}finally{V.value=!1}}async function O(){V.value=!0;try{const U=await He.testAiVisionOcrConnection({provider:g.settings.aiVisionOcr.provider,apiKey:_.value.apiKey,modelName:_.value.modelName,customBaseUrl:_.value.customBaseUrl,prompt:_.value.prompt});U.success?u.success("AIè§†è§‰OCRè¿æ¥æˆåŠŸ"):u.error(`AIè§†è§‰OCRè¿æ¥å¤±è´¥: ${U.error||"æœªçŸ¥é”™è¯¯"}`)}catch(U){const r=U instanceof Error?U.message:"è¿æ¥æµ‹è¯•å¤±è´¥";u.error(r)}finally{V.value=!1}}async function Q(){const U=g.settings.aiVisionOcr.provider,r=_.value.apiKey?.trim(),d=_.value.customBaseUrl?.trim();if(!r){u.warning("è¯·å…ˆå¡«å†™ API Key");return}if(!["siliconflow","volcano","gemini","custom_openai_vision"].includes(U)){u.warning("å½“å‰æœåŠ¡å•†ä¸æ”¯æŒè‡ªåŠ¨è·å–æ¨¡å‹åˆ—è¡¨");return}if(U==="custom_openai_vision"&&!d){u.warning("è‡ªå®šä¹‰æœåŠ¡éœ€è¦å…ˆå¡«å†™ Base URL");return}M.value=!0;try{const C=await He.fetchModels(U,r,d);C.success&&C.models&&C.models.length>0?(B.value=C.models.map(x=>x.id),u.success(`è·å–åˆ° ${C.models.length} ä¸ªæ¨¡å‹`)):u.warning(C.message||"æœªè·å–åˆ°å¯ç”¨æ¨¡å‹")}catch(C){const x=C instanceof Error?C.message:"è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥";u.error(x)}finally{M.value=!1}}function ae(U,r){g.updateAiVisionOcr({prompt:U}),_.value.prompt=U,u.success(`å·²åº”ç”¨æç¤ºè¯: ${r}`)}return(U,r)=>(A(),L("div",du,[e("div",gu,[r[21]||(r[21]=e("div",{class:"settings-group-title"},"OCRå¼•æ“é€‰æ‹©",-1)),e("div",pu,[r[19]||(r[19]=e("label",{for:"settingsOcrEngine"},"OCRå¼•æ“:",-1)),ke(Ve,{"model-value":S.value.ocrEngine,options:t,onChange:r[0]||(r[0]=d=>{S.value.ocrEngine=d,p()})},null,8,["model-value"])]),oe(e("div",mu,[r[20]||(r[20]=e("label",{for:"settingsSourceLanguage"},"æºè¯­è¨€:",-1)),ke(Ve,{"model-value":S.value.sourceLanguage,groups:m,onChange:r[1]||(r[1]=d=>{S.value.sourceLanguage=d,$()})},null,8,["model-value"]),e("div",vu,te(F()),1)],512),[[Oe,S.value.ocrEngine==="paddle_ocr"]])]),oe(e("div",fu,[r[24]||(r[24]=e("div",{class:"settings-group-title"},"PaddleOCR-VL è®¾ç½®",-1)),e("div",bu,[r[22]||(r[22]=e("label",{for:"settingsPaddleOcrVlSourceLanguage"},"æºè¯­è¨€:",-1)),ke(Ve,{"model-value":S.value.paddleOcrVl.sourceLanguage,groups:i,onChange:r[2]||(r[2]=d=>k(d))},null,8,["model-value"]),r[23]||(r[23]=e("div",{class:"input-hint"}," é€‰æ‹©å›¾åƒä¸­çš„æºè¯­è¨€ï¼Œç”¨äºä¼˜åŒ– OCR è¯†åˆ«æ•ˆæœ ",-1))])],512),[[Oe,S.value.ocrEngine==="paddleocr_vl"]]),oe(e("div",hu,[r[29]||(r[29]=e("div",{class:"settings-group-title"},"ç™¾åº¦OCR è®¾ç½®",-1)),e("div",xu,[e("div",yu,[r[25]||(r[25]=e("label",{for:"settingsBaiduApiKey"},"API Key:",-1)),e("div",Cu,[oe(e("input",{type:R.value?"text":"password",id:"settingsBaiduApiKey","onUpdate:modelValue":r[3]||(r[3]=d=>b.value.apiKey=d),class:"secure-input",placeholder:"è¯·è¾“å…¥ç™¾åº¦OCR API Key",autocomplete:"off"},null,8,_u),[[kt,b.value.apiKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:r[4]||(r[4]=d=>R.value=!R.value)},[R.value?(A(),L("span",Su,"ğŸ‘â€ğŸ—¨")):(A(),L("span",ku,"ğŸ‘"))])])]),e("div",wu,[r[26]||(r[26]=e("label",{for:"settingsBaiduSecretKey"},"Secret Key:",-1)),e("div",$u,[oe(e("input",{type:y.value?"text":"password",id:"settingsBaiduSecretKey","onUpdate:modelValue":r[5]||(r[5]=d=>b.value.secretKey=d),class:"secure-input",placeholder:"è¯·è¾“å…¥Secret Key",autocomplete:"off"},null,8,Tu),[[kt,b.value.secretKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:r[6]||(r[6]=d=>y.value=!y.value)},[y.value?(A(),L("span",Pu,"ğŸ‘â€ğŸ—¨")):(A(),L("span",Iu,"ğŸ‘"))])])])]),e("div",Ru,[e("div",Du,[r[27]||(r[27]=e("label",{for:"settingsBaiduVersion"},"è¯†åˆ«ç‰ˆæœ¬:",-1)),ke(Ve,{modelValue:b.value.version,"onUpdate:modelValue":r[7]||(r[7]=d=>b.value.version=d),options:s},null,8,["modelValue"])]),e("div",Mu,[r[28]||(r[28]=e("label",{for:"settingsBaiduSourceLanguage"},"æºè¯­è¨€:",-1)),ke(Ve,{modelValue:b.value.sourceLanguage,"onUpdate:modelValue":r[8]||(r[8]=d=>b.value.sourceLanguage=d),options:o},null,8,["modelValue"])])]),e("button",{class:"settings-test-btn",onClick:se,disabled:V.value},te(V.value?"æµ‹è¯•ä¸­...":"ğŸ”— æµ‹è¯•è¿æ¥"),9,Bu)],512),[[Oe,S.value.ocrEngine==="baidu_ocr"]]),oe(e("div",Au,[r[41]||(r[41]=e("div",{class:"settings-group-title"},"AIè§†è§‰OCR è®¾ç½®",-1)),e("div",Eu,[e("div",Lu,[r[30]||(r[30]=e("label",{for:"settingsAiVisionProvider"},"æœåŠ¡å•†:",-1)),ke(Ve,{"model-value":S.value.aiVisionOcr.provider,options:a,onChange:r[9]||(r[9]=d=>z(d))},null,8,["model-value"])]),e("div",Fu,[r[31]||(r[31]=e("label",{for:"settingsAiVisionApiKey"},"API Key:",-1)),e("div",Uu,[oe(e("input",{type:D.value?"text":"password",id:"settingsAiVisionApiKey","onUpdate:modelValue":r[10]||(r[10]=d=>_.value.apiKey=d),class:"secure-input",placeholder:"è¯·è¾“å…¥API Key",autocomplete:"off"},null,8,Ou),[[kt,_.value.apiKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:r[11]||(r[11]=d=>D.value=!D.value)},[D.value?(A(),L("span",Nu,"ğŸ‘â€ğŸ—¨")):(A(),L("span",zu,"ğŸ‘"))])])])]),oe(e("div",Vu,[r[32]||(r[32]=e("label",{for:"settingsCustomAiVisionBaseUrl"},"Base URL:",-1)),oe(e("input",{type:"text",id:"settingsCustomAiVisionBaseUrl","onUpdate:modelValue":r[12]||(r[12]=d=>_.value.customBaseUrl=d),placeholder:"ä¾‹å¦‚: https://api.example.com/v1"},null,512),[[Pe,_.value.customBaseUrl]])],512),[[Oe,S.value.aiVisionOcr.provider==="custom_openai_vision"]]),e("div",Wu,[r[34]||(r[34]=e("label",{for:"settingsAiVisionModelName"},"æ¨¡å‹åç§°:",-1)),e("div",Ku,[oe(e("input",{type:"text",id:"settingsAiVisionModelName","onUpdate:modelValue":r[13]||(r[13]=d=>_.value.modelName=d),placeholder:"å¦‚: silicon-llava2-34b"},null,512),[[Pe,_.value.modelName]]),e("button",{type:"button",class:"fetch-models-btn",title:"è·å–å¯ç”¨æ¨¡å‹åˆ—è¡¨",onClick:Q,disabled:M.value},[r[33]||(r[33]=e("span",{class:"fetch-icon"},"ğŸ”",-1)),e("span",Hu,te(M.value?"è·å–ä¸­...":"è·å–æ¨¡å‹"),1)],8,qu)]),B.value.length>0?(A(),L("div",ju,[ke(Ve,{modelValue:_.value.modelName,"onUpdate:modelValue":r[14]||(r[14]=d=>_.value.modelName=d),options:v.value},null,8,["modelValue","options"]),e("span",Ju,"å…± "+te(B.value.length)+" ä¸ªæ¨¡å‹",1)])):ce("",!0)]),e("div",Yu,[r[36]||(r[36]=e("label",{for:"settingsAiVisionOcrPrompt"},"OCRæç¤ºè¯:",-1)),oe(e("textarea",{id:"settingsAiVisionOcrPrompt","onUpdate:modelValue":r[15]||(r[15]=d=>_.value.prompt=d),rows:"3",placeholder:"AIè§†è§‰OCRæç¤ºè¯"},null,512),[[Pe,_.value.prompt]]),ke(Vt,{"prompt-type":"ai_vision_ocr",onSelect:ae}),e("div",Gu,[ke(Ve,{"model-value":S.value.aiVisionOcr.isJsonMode?"true":"false",options:l,onChange:r[16]||(r[16]=d=>{S.value.aiVisionOcr.isJsonMode=d==="true",J()})},null,8,["model-value"]),r[35]||(r[35]=e("span",{class:"input-hint"},"JSONæ ¼å¼è¾“å‡ºæ›´ç»“æ„åŒ–",-1))])]),e("div",Xu,[r[37]||(r[37]=e("label",{for:"settingsRpmAiVisionOcr"},"RPMé™åˆ¶ (æ¯åˆ†é’Ÿè¯·æ±‚æ•°):",-1)),oe(e("input",{type:"number",id:"settingsRpmAiVisionOcr","onUpdate:modelValue":r[17]||(r[17]=d=>_.value.rpmLimit=d),min:"0",step:"1"},null,512),[[Pe,_.value.rpmLimit,void 0,{number:!0}]]),r[38]||(r[38]=e("div",{class:"input-hint"},"0 è¡¨ç¤ºæ— é™åˆ¶",-1))]),e("div",Zu,[r[39]||(r[39]=e("label",{for:"settingsMinImageSize"},"æœ€å°å›¾ç‰‡å°ºå¯¸ (åƒç´ ):",-1)),oe(e("input",{type:"number",id:"settingsMinImageSize","onUpdate:modelValue":r[18]||(r[18]=d=>_.value.minImageSize=d),min:"0",step:"1"},null,512),[[Pe,_.value.minImageSize,void 0,{number:!0}]]),r[40]||(r[40]=e("div",{class:"input-hint"},"VLMæ¨¡å‹é€šå¸¸è¦æ±‚å›¾ç‰‡å°ºå¯¸ â‰¥28pxï¼Œè®¾ä¸º0åˆ™ä¸è‡ªåŠ¨æ”¾å¤§å°å›¾",-1))]),e("button",{class:"settings-test-btn",onClick:O,disabled:V.value},te(V.value?"æµ‹è¯•ä¸­...":"ğŸ”— æµ‹è¯•è¿æ¥"),9,Qu)],512),[[Oe,S.value.ocrEngine==="ai_vision"]])]))}}),tc=Je(ec,[["__scopeId","data-v-03445600"]]),oc={class:"translation-settings"},nc={class:"settings-group"},sc={class:"settings-row"},ac={class:"settings-item"},lc={class:"settings-item"},ic={for:"settingsApiKey"},rc={class:"password-input-wrapper"},uc=["type","placeholder"],cc={key:0,class:"eye-icon"},dc={key:1,class:"eye-off-icon"},gc={class:"settings-item"},pc={class:"settings-item"},mc={for:"settingsModelName"},vc={class:"model-input-with-fetch"},fc=["placeholder"],bc=["disabled"],hc={class:"fetch-text"},xc={key:0,class:"model-select-container"},yc={class:"model-count"},Cc={class:"settings-item"},_c={class:"model-input-with-fetch"},kc=["placeholder"],Sc=["disabled"],wc={class:"fetch-text"},$c={key:0,class:"model-select-container"},Tc={class:"model-count"},Ic={class:"settings-row"},Pc={class:"settings-item"},Rc={class:"settings-item"},Dc={class:"settings-item"},Mc={class:"input-hint translation-mode-hint"},Bc={key:0},Ac={key:1},Ec={key:0,class:"input-hint sakura-suggestion"},Lc={class:"settings-item"},Fc=["disabled"],Uc={class:"settings-item"},Oc=["disabled"],zc={class:"settings-group"},Nc={class:"settings-item"},Vc={class:"prompt-format-selector"},Wc={class:"settings-item"},Kc={class:"checkbox-label"},qc={class:"settings-item"},Hc=Ye({__name:"TranslationSettings",setup(n){const t=[{label:"SiliconFlow",value:"siliconflow"},{label:"DeepSeek",value:"deepseek"},{label:"ç«å±±å¼•æ“",value:"volcano"},{label:"å½©äº‘å°è¯‘",value:"caiyun"},{label:"ç™¾åº¦ç¿»è¯‘",value:"baidu_translate"},{label:"æœ‰é“ç¿»è¯‘",value:"youdao_translate"},{label:"Google Gemini",value:"gemini"},{label:"Ollama (æœ¬åœ°)",value:"ollama"},{label:"Sakura (æœ¬åœ°)",value:"sakura"},{label:"è‡ªå®šä¹‰ OpenAI å…¼å®¹æœåŠ¡",value:"custom_openai"}],s=[{label:"æ™®é€šæç¤ºè¯",value:"normal"},{label:"JSONæç¤ºè¯",value:"json"}],o=[{label:"æ•´é¡µæ‰¹é‡ç¿»è¯‘ (æ¨è)",value:"batch"},{label:"é€æ°”æ³¡ç¿»è¯‘ (é€‚åˆå°æ¨¡å‹)",value:"single"}],a=Ee(),i=ct(),l=a.settings.translation.translationMode||"batch",m=a.settings.translation.isJsonMode||!1,g=()=>{const C=a.settings.translation;return l==="single"?m?C.singleJsonPrompt:C.singleNormalPrompt:m?C.batchJsonPrompt:C.batchNormalPrompt},u=w({modelProvider:a.settings.translation.provider,apiKey:a.settings.translation.apiKey,modelName:a.settings.translation.modelName,customBaseUrl:a.settings.translation.customBaseUrl,rpmTranslation:a.settings.translation.rpmLimit,translationMaxRetries:a.settings.translation.maxRetries,translationMode:l,promptContent:g(),translatePromptMode:m?"json":"normal",enableTextboxPrompt:a.settings.useTextboxPrompt,textboxPromptContent:a.settings.textboxPrompt}),b=w(!1),_=w(!1),S=w(!1),R=w([]),y=w([]),D=Y(()=>{const C=[{label:"-- é€‰æ‹©æ¨¡å‹ --",value:""}];return R.value.forEach(x=>C.push({label:x,value:x})),C}),V=Y(()=>{const C=[{label:"-- é€‰æ‹©æ¨¡å‹ --",value:""}];return y.value.forEach(x=>C.push({label:x,value:x})),C}),M=Y(()=>["ollama","sakura"].includes(u.value.modelProvider)),B=Y(()=>!["ollama","sakura","caiyun","baidu_translate","youdao_translate"].includes(u.value.modelProvider)),v=Y(()=>["siliconflow","deepseek","volcano","gemini","custom_openai"].includes(u.value.modelProvider)),p=Y(()=>{switch(u.value.modelProvider){case"baidu_translate":return"App ID";case"youdao_translate":return"App Key";case"caiyun":return"API Token";default:return"API Key"}}),$=Y(()=>{switch(u.value.modelProvider){case"baidu_translate":return"è¯·è¾“å…¥ç™¾åº¦ç¿»è¯‘App ID";case"youdao_translate":return"è¯·è¾“å…¥æœ‰é“ç¿»è¯‘åº”ç”¨ID";case"caiyun":return"è¯·è¾“å…¥å½©äº‘å°è¯‘Token";default:return"è¯·è¾“å…¥API Key"}}),k=Y(()=>{switch(u.value.modelProvider){case"baidu_translate":return"App Key";case"youdao_translate":return"App Secret";case"caiyun":return"æºè¯­è¨€ (å¯é€‰)";default:return"æ¨¡å‹åç§°"}}),F=Y(()=>{switch(u.value.modelProvider){case"baidu_translate":return"è¯·è¾“å…¥ç™¾åº¦ç¿»è¯‘App Key";case"youdao_translate":return"è¯·è¾“å…¥æœ‰é“ç¿»è¯‘åº”ç”¨å¯†é’¥";case"caiyun":return"å¯é€‰: auto/æ—¥è¯­/è‹±è¯­";default:return"è¯·è¾“å…¥æ¨¡å‹åç§°"}});function z(){const C=u.value.modelProvider;a.setTranslationProvider(C),u.value.apiKey=a.settings.translation.apiKey,u.value.modelName=a.settings.translation.modelName,u.value.customBaseUrl=a.settings.translation.customBaseUrl,u.value.rpmTranslation=a.settings.translation.rpmLimit,u.value.translationMaxRetries=a.settings.translation.maxRetries,u.value.translationMode=a.settings.translation.translationMode||"batch",R.value=[],y.value=[]}function ee(){const C=u.value.translatePromptMode==="json",x=!C,P=u.value.translationMode==="single";P?x?a.updateTranslationService({singleJsonPrompt:u.value.promptContent}):a.updateTranslationService({singleNormalPrompt:u.value.promptContent}):x?a.updateTranslationService({batchJsonPrompt:u.value.promptContent}):a.updateTranslationService({batchNormalPrompt:u.value.promptContent});const I=a.settings.translation;let E;P?E=C?I.singleJsonPrompt:I.singleNormalPrompt:E=C?I.batchJsonPrompt:I.batchNormalPrompt,u.value.promptContent=E,a.updateTranslationService({isJsonMode:C}),a.setTranslatePrompt(E)}function J(C){const x=String(C),P=u.value.translationMode,I=u.value.translatePromptMode==="json";if(x===P)return;P==="batch"?I?a.updateTranslationService({batchJsonPrompt:u.value.promptContent}):a.updateTranslationService({batchNormalPrompt:u.value.promptContent}):I?a.updateTranslationService({singleJsonPrompt:u.value.promptContent}):a.updateTranslationService({singleNormalPrompt:u.value.promptContent}),u.value.translationMode=x,a.updateTranslationService({translationMode:x});const E=a.settings.translation;let K;x==="single"?K=I?E.singleJsonPrompt:E.singleNormalPrompt:K=I?E.batchJsonPrompt:E.batchNormalPrompt,u.value.promptContent=K,a.setTranslatePrompt(K),console.log(`ç¿»è¯‘æ¨¡å¼å·²åˆ‡æ¢ä¸º: ${x==="batch"?"æ•´é¡µæ‰¹é‡ç¿»è¯‘":"é€æ°”æ³¡ç¿»è¯‘"}`)}Se(()=>u.value.apiKey,C=>{a.updateTranslationService({apiKey:C})}),Se(()=>u.value.modelName,C=>{a.updateTranslationService({modelName:C})}),Se(()=>u.value.customBaseUrl,C=>{a.updateTranslationService({customBaseUrl:C})}),Se(()=>u.value.rpmTranslation,C=>{a.updateTranslationService({rpmLimit:C})}),Se(()=>u.value.translationMaxRetries,C=>{a.updateTranslationService({maxRetries:C})}),Se(()=>u.value.promptContent,C=>{a.setTranslatePrompt(C);const x=u.value.translationMode==="batch",P=u.value.translatePromptMode==="json";x?P?a.updateTranslationService({batchJsonPrompt:C}):a.updateTranslationService({batchNormalPrompt:C}):P?a.updateTranslationService({singleJsonPrompt:C}):a.updateTranslationService({singleNormalPrompt:C})}),Se(()=>u.value.enableTextboxPrompt,C=>{a.setUseTextboxPrompt(C)}),Se(()=>u.value.textboxPromptContent,C=>{a.setTextboxPrompt(C)});async function se(){const C=u.value.modelProvider,x=u.value.apiKey?.trim(),P=u.value.customBaseUrl?.trim();if(!x){i.warning("è¯·å…ˆå¡«å†™ API Key");return}if(!["siliconflow","deepseek","volcano","gemini","custom_openai"].includes(C)){i.warning(`${O(C)} ä¸æ”¯æŒè‡ªåŠ¨è·å–æ¨¡å‹åˆ—è¡¨`);return}if(C==="custom_openai"&&!P){i.warning("è‡ªå®šä¹‰æœåŠ¡éœ€è¦å…ˆå¡«å†™ Base URL");return}S.value=!0;try{const E=await He.fetchModels(C,x,P);E.success&&E.models&&E.models.length>0?(R.value=E.models.map(K=>K.id),i.success(`è·å–åˆ° ${E.models.length} ä¸ªæ¨¡å‹`)):i.warning(E.message||"æœªè·å–åˆ°å¯ç”¨æ¨¡å‹")}catch(E){const K=E instanceof Error?E.message:"è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥";i.error(K)}finally{S.value=!1}}function O(C){return{siliconflow:"SiliconFlow",deepseek:"DeepSeek",volcano:"ç«å±±å¼•æ“",gemini:"Google Gemini",custom_openai:"è‡ªå®šä¹‰OpenAI",ollama:"Ollama",sakura:"Sakura",caiyun:"å½©äº‘å°è¯‘",baidu_translate:"ç™¾åº¦ç¿»è¯‘",youdao_translate:"æœ‰é“ç¿»è¯‘"}[C]||C}async function Q(){const C=u.value.modelProvider;S.value=!0;try{let x;if(C==="ollama")x=await He.testOllamaConnection();else if(C==="sakura")x=await He.testSakuraConnection();else{i.error("æœªé€‰æ‹©æœ¬åœ°æœåŠ¡å•†");return}x.success&&x.models?(y.value=x.models,i.success(`è·å–åˆ° ${x.models.length} ä¸ª${C==="ollama"?"Ollama":"Sakura"}æ¨¡å‹`)):i.error(x.error||`${C==="ollama"?"Ollama":"Sakura"}è¿æ¥å¤±è´¥`)}catch(x){const P=x instanceof Error?x.message:"è·å–æœ¬åœ°æ¨¡å‹å¤±è´¥";i.error(P)}finally{S.value=!1}}async function ae(){_.value=!0;try{let C;u.value.modelProvider==="ollama"?C=await He.testOllamaConnection():C=await He.testSakuraConnection(),C.success?i.success(`${u.value.modelProvider==="ollama"?"Ollama":"Sakura"} è¿æ¥æˆåŠŸ`):i.error(C.error||"è¿æ¥å¤±è´¥")}catch(C){const x=C instanceof Error?C.message:"è¿æ¥æµ‹è¯•å¤±è´¥";i.error(x)}finally{_.value=!1}}async function U(){const C=u.value.modelProvider,x=u.value.apiKey?.trim(),P=u.value.modelName?.trim(),I=u.value.customBaseUrl?.trim();if(!x){i.warning("è¯·å…ˆå¡«å†™ API Key");return}if(C!=="caiyun"&&!P){i.warning("è¯·å¡«å†™æ¨¡å‹åç§°");return}if(C==="custom_openai"&&!I){i.warning("è‡ªå®šä¹‰æœåŠ¡éœ€è¦å¡«å†™ Base URL");return}_.value=!0,i.info("æ­£åœ¨æµ‹è¯•è¿æ¥...");try{let E;switch(C){case"baidu_translate":E=await He.testBaiduTranslateConnection(x,P);break;case"youdao_translate":E=await He.testYoudaoTranslateConnection(x,P);break;default:E=await He.testAiTranslateConnection({provider:C,apiKey:x,modelName:P,baseUrl:I})}E.success?i.success(E.message||`${O(C)} è¿æ¥æˆåŠŸ!`):i.error(E.message||E.error||"è¿æ¥å¤±è´¥")}catch(E){const K=E instanceof Error?E.message:"è¿æ¥æµ‹è¯•å¤±è´¥";i.error(K)}finally{_.value=!1}}function r(C,x){u.value.promptContent=C,i.success(`å·²åº”ç”¨æç¤ºè¯: ${x}`)}function d(C,x){u.value.textboxPromptContent=C,i.success(`å·²åº”ç”¨æç¤ºè¯: ${x}`)}function f(){const C=u.value.translatePromptMode==="json";u.value.translationMode==="single"?u.value.promptContent=C?_s:ks:u.value.promptContent=C?Ss:ws,i.success("å·²é‡ç½®ä¸ºé»˜è®¤æç¤ºè¯")}return(C,x)=>(A(),L("div",oc,[e("div",nc,[x[23]||(x[23]=e("div",{class:"settings-group-title"},"ç¿»è¯‘æœåŠ¡é…ç½®",-1)),e("div",sc,[e("div",ac,[x[14]||(x[14]=e("label",{for:"settingsModelProvider"},"ç¿»è¯‘æœåŠ¡å•†:",-1)),ke(Ve,{"model-value":u.value.modelProvider,options:t,onChange:x[0]||(x[0]=P=>{u.value.modelProvider=P,z()})},null,8,["model-value"])]),oe(e("div",lc,[e("label",ic,te(p.value)+":",1),e("div",rc,[oe(e("input",{type:b.value?"text":"password",id:"settingsApiKey","onUpdate:modelValue":x[1]||(x[1]=P=>u.value.apiKey=P),class:"secure-input",placeholder:$.value,autocomplete:"off"},null,8,uc),[[kt,u.value.apiKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:x[2]||(x[2]=P=>b.value=!b.value)},[b.value?(A(),L("span",dc,"ğŸ‘â€ğŸ—¨")):(A(),L("span",cc,"ğŸ‘"))])])],512),[[Oe,!M.value]])]),oe(e("div",gc,[x[15]||(x[15]=e("label",{for:"settingsCustomBaseUrl"},"Base URL:",-1)),oe(e("input",{type:"text",id:"settingsCustomBaseUrl","onUpdate:modelValue":x[3]||(x[3]=P=>u.value.customBaseUrl=P),placeholder:"ä¾‹å¦‚: https://api.example.com/v1"},null,512),[[Pe,u.value.customBaseUrl]])],512),[[Oe,u.value.modelProvider==="custom_openai"]]),oe(e("div",pc,[e("label",mc,te(k.value)+":",1),e("div",vc,[oe(e("input",{type:"text",id:"settingsModelName","onUpdate:modelValue":x[4]||(x[4]=P=>u.value.modelName=P),placeholder:F.value},null,8,fc),[[Pe,u.value.modelName]]),oe(e("button",{type:"button",class:"fetch-models-btn",title:"è·å–å¯ç”¨æ¨¡å‹åˆ—è¡¨",onClick:se,disabled:S.value},[x[16]||(x[16]=e("span",{class:"fetch-icon"},"ğŸ”",-1)),e("span",hc,te(S.value?"è·å–ä¸­...":"è·å–æ¨¡å‹"),1)],8,bc),[[Oe,v.value]])]),R.value.length>0?(A(),L("div",xc,[ke(Ve,{"model-value":u.value.modelName,options:D.value,onChange:x[5]||(x[5]=P=>{u.value.modelName=P})},null,8,["model-value","options"]),e("span",yc,"å…± "+te(R.value.length)+" ä¸ªæ¨¡å‹",1)])):ce("",!0)],512),[[Oe,!M.value]]),oe(e("div",Cc,[x[18]||(x[18]=e("label",{for:"settingsLocalModelName"},"æ¨¡å‹åç§°:",-1)),e("div",_c,[oe(e("input",{type:"text",id:"settingsLocalModelName","onUpdate:modelValue":x[6]||(x[6]=P=>u.value.modelName=P),placeholder:u.value.modelProvider==="ollama"?"ä¾‹å¦‚: qwen2.5:7b":"ä¾‹å¦‚: sakura-14b-qwen2.5-v1.0"},null,8,kc),[[Pe,u.value.modelName]]),e("button",{type:"button",class:"fetch-models-btn",title:"è·å–æœ¬åœ°å¯ç”¨æ¨¡å‹åˆ—è¡¨",onClick:Q,disabled:S.value},[x[17]||(x[17]=e("span",{class:"fetch-icon"},"ğŸ”",-1)),e("span",wc,te(S.value?"è·å–ä¸­...":"è·å–æ¨¡å‹"),1)],8,Sc)]),y.value.length>0?(A(),L("div",$c,[ke(Ve,{"model-value":u.value.modelName,options:V.value,onChange:x[7]||(x[7]=P=>u.value.modelName=P)},null,8,["model-value","options"]),e("span",Tc,"å…± "+te(y.value.length)+" ä¸ªæ¨¡å‹",1)])):ce("",!0)],512),[[Oe,M.value]]),oe(e("div",Ic,[e("div",Pc,[x[19]||(x[19]=e("label",{for:"settingsRpmTranslation"},"RPMé™åˆ¶:",-1)),oe(e("input",{type:"number",id:"settingsRpmTranslation","onUpdate:modelValue":x[8]||(x[8]=P=>u.value.rpmTranslation=P),min:"0",step:"1"},null,512),[[Pe,u.value.rpmTranslation,void 0,{number:!0}]]),x[20]||(x[20]=e("div",{class:"input-hint"},"æ¯åˆ†é’Ÿè¯·æ±‚æ•°ï¼Œ0è¡¨ç¤ºæ— é™åˆ¶",-1))]),e("div",Rc,[x[21]||(x[21]=e("label",{for:"settingsTranslationMaxRetries"},"é‡è¯•æ¬¡æ•°:",-1)),oe(e("input",{type:"number",id:"settingsTranslationMaxRetries","onUpdate:modelValue":x[9]||(x[9]=P=>u.value.translationMaxRetries=P),min:"0",max:"10",step:"1"},null,512),[[Pe,u.value.translationMaxRetries,void 0,{number:!0}]])])],512),[[Oe,B.value]]),e("div",Dc,[x[22]||(x[22]=e("label",{for:"settingsTranslationMode"},"ç¿»è¯‘æ¨¡å¼:",-1)),ke(Ve,{"model-value":u.value.translationMode,options:o,onChange:J},null,8,["model-value"]),e("div",Mc,[u.value.translationMode==="batch"?(A(),L("span",Bc," ğŸ’¡ æ•´é¡µæ‰¹é‡ç¿»è¯‘ï¼šä¸€æ¬¡å‘é€å…¨éƒ¨æ°”æ³¡ï¼Œæ•ˆç‡é«˜ï¼Œéœ€è¦æ¨¡å‹æ”¯æŒå¤æ‚æŒ‡ä»¤ ")):(A(),L("span",Ac," ğŸ’¡ é€æ°”æ³¡ç¿»è¯‘ï¼šæ¯ä¸ªæ°”æ³¡å•ç‹¬ç¿»è¯‘ï¼Œæ›´ç¨³å®šï¼Œé€‚åˆå°æ¨¡å‹æˆ–æ ¼å¼æ•æ„Ÿåœºæ™¯ "))]),u.value.modelProvider==="sakura"?(A(),L("div",Ec,' âš ï¸ å»ºè®® Sakura æœåŠ¡ä½¿ç”¨"é€æ°”æ³¡ç¿»è¯‘"æ¨¡å¼ï¼Œå¯è·å¾—æ›´ç¨³å®šçš„ç¿»è¯‘æ•ˆæœ ')):ce("",!0)]),oe(e("div",Lc,[e("button",{class:"settings-test-btn",onClick:ae,disabled:_.value},te(_.value?"æµ‹è¯•ä¸­...":"ğŸ”— æµ‹è¯•è¿æ¥"),9,Fc)],512),[[Oe,M.value]]),oe(e("div",Uc,[e("button",{class:"settings-test-btn",onClick:U,disabled:_.value},te(_.value?"æµ‹è¯•ä¸­...":"ğŸ”— æµ‹è¯•è¿æ¥"),9,Oc)],512),[[Oe,!M.value]])]),e("div",zc,[x[28]||(x[28]=e("div",{class:"settings-group-title"},"æç¤ºè¯è®¾ç½®",-1)),e("div",Nc,[x[25]||(x[25]=e("label",{for:"settingsPromptContent"},"ç¿»è¯‘æç¤ºè¯:",-1)),oe(e("textarea",{id:"settingsPromptContent","onUpdate:modelValue":x[10]||(x[10]=P=>u.value.promptContent=P),rows:"4",placeholder:"ç¿»è¯‘æç¤ºè¯"},null,512),[[Pe,u.value.promptContent]]),e("div",Vc,[ke(Ve,{"model-value":u.value.translatePromptMode,options:s,onChange:x[11]||(x[11]=P=>{u.value.translatePromptMode=P,ee()})},null,8,["model-value"]),x[24]||(x[24]=e("span",{class:"input-hint"},"JSONæ ¼å¼è¾“å‡ºæ›´ç»“æ„åŒ–",-1))]),ke(Vt,{"prompt-type":"translate",onSelect:r}),e("button",{type:"button",class:"reset-btn",onClick:f}," é‡ç½®ä¸ºé»˜è®¤ ")]),e("div",Wc,[e("label",Kc,[oe(e("input",{type:"checkbox","onUpdate:modelValue":x[12]||(x[12]=P=>u.value.enableTextboxPrompt=P)},null,512),[[Xe,u.value.enableTextboxPrompt]]),x[26]||(x[26]=de(" å¯ç”¨æ–‡æœ¬æ¡†æç¤ºè¯ ",-1))])]),oe(e("div",qc,[x[27]||(x[27]=e("label",{for:"settingsTextboxPromptContent"},"æ–‡æœ¬æ¡†æç¤ºè¯:",-1)),oe(e("textarea",{id:"settingsTextboxPromptContent","onUpdate:modelValue":x[13]||(x[13]=P=>u.value.textboxPromptContent=P),rows:"3",placeholder:"æ–‡æœ¬æ¡†æç¤ºè¯"},null,512),[[Pe,u.value.textboxPromptContent]]),ke(Vt,{"prompt-type":"textbox",onSelect:d})],512),[[Oe,u.value.enableTextboxPrompt]])])]))}}),jc=Je(Hc,[["__scopeId","data-v-7c76de5c"]]),Jc={class:"detection-settings"},Yc={class:"settings-group"},Gc={class:"settings-item"},Xc={class:"settings-group"},Zc={class:"settings-item"},Qc={class:"settings-row"},ed={class:"settings-item"},td={class:"settings-item"},od={class:"settings-row"},nd={class:"settings-item"},sd={class:"settings-item"},ad={class:"settings-group"},ld={class:"settings-row"},id={class:"settings-item"},rd={class:"settings-item"},ud={class:"settings-group"},cd={class:"settings-item"},dd={class:"checkbox-label"},gd=Ye({__name:"DetectionSettings",setup(n){const t=[{label:"CTD (Comic Text Detector)",value:"ctd"},{label:"YOLO",value:"yolo"},{label:"YOLOv5",value:"yolov5"},{label:"Default (DBNet)",value:"default"}],s=Ee(),o=So({textDetector:s.settings.textDetector,boxExpandRatio:s.settings.boxExpand.ratio,boxExpandTop:s.settings.boxExpand.top,boxExpandBottom:s.settings.boxExpand.bottom,boxExpandLeft:s.settings.boxExpand.left,boxExpandRight:s.settings.boxExpand.right,maskDilateSize:s.settings.preciseMask.dilateSize,maskBoxExpandRatio:s.settings.preciseMask.boxExpandRatio,showDetectionDebug:s.settings.showDetectionDebug});return Se(()=>o.textDetector,a=>{s.setTextDetector(a)}),Se(()=>o.boxExpandRatio,a=>{s.updateBoxExpand({ratio:a})}),Se(()=>o.boxExpandTop,a=>{s.updateBoxExpand({top:a})}),Se(()=>o.boxExpandBottom,a=>{s.updateBoxExpand({bottom:a})}),Se(()=>o.boxExpandLeft,a=>{s.updateBoxExpand({left:a})}),Se(()=>o.boxExpandRight,a=>{s.updateBoxExpand({right:a})}),Se(()=>o.maskDilateSize,a=>{s.updatePreciseMask({dilateSize:a})}),Se(()=>o.maskBoxExpandRatio,a=>{s.updatePreciseMask({boxExpandRatio:a})}),Se(()=>o.showDetectionDebug,a=>{s.setShowDetectionDebug(a)}),(a,i)=>(A(),L("div",Jc,[e("div",Yc,[i[10]||(i[10]=e("div",{class:"settings-group-title"},"æ–‡å­—æ£€æµ‹å™¨",-1)),e("div",Gc,[i[9]||(i[9]=e("label",{for:"settingsTextDetector"},"æ£€æµ‹å™¨ç±»å‹:",-1)),ke(Ve,{modelValue:o.textDetector,"onUpdate:modelValue":i[0]||(i[0]=l=>o.textDetector=l),options:t},null,8,["modelValue"])])]),e("div",Xc,[i[17]||(i[17]=e("div",{class:"settings-group-title"},"æ–‡æœ¬æ¡†æ‰©å±•å‚æ•°",-1)),e("div",Zc,[i[11]||(i[11]=e("label",{for:"settingsBoxExpandRatio"},"æ•´ä½“æ‰©å±• (%):",-1)),oe(e("input",{type:"number",id:"settingsBoxExpandRatio","onUpdate:modelValue":i[1]||(i[1]=l=>o.boxExpandRatio=l),min:"0",max:"50",step:"1"},null,512),[[Pe,o.boxExpandRatio,void 0,{number:!0}]]),i[12]||(i[12]=e("div",{class:"input-hint"},"å‘å››å‘¨å‡åŒ€æ‰©å±•çš„ç™¾åˆ†æ¯” (0-50%)",-1))]),e("div",Qc,[e("div",ed,[i[13]||(i[13]=e("label",{for:"settingsBoxExpandTop"},"ä¸Šæ–¹æ‰©å±• (%):",-1)),oe(e("input",{type:"number",id:"settingsBoxExpandTop","onUpdate:modelValue":i[2]||(i[2]=l=>o.boxExpandTop=l),min:"0",max:"50",step:"1"},null,512),[[Pe,o.boxExpandTop,void 0,{number:!0}]])]),e("div",td,[i[14]||(i[14]=e("label",{for:"settingsBoxExpandBottom"},"ä¸‹æ–¹æ‰©å±• (%):",-1)),oe(e("input",{type:"number",id:"settingsBoxExpandBottom","onUpdate:modelValue":i[3]||(i[3]=l=>o.boxExpandBottom=l),min:"0",max:"50",step:"1"},null,512),[[Pe,o.boxExpandBottom,void 0,{number:!0}]])])]),e("div",od,[e("div",nd,[i[15]||(i[15]=e("label",{for:"settingsBoxExpandLeft"},"å·¦ä¾§æ‰©å±• (%):",-1)),oe(e("input",{type:"number",id:"settingsBoxExpandLeft","onUpdate:modelValue":i[4]||(i[4]=l=>o.boxExpandLeft=l),min:"0",max:"50",step:"1"},null,512),[[Pe,o.boxExpandLeft,void 0,{number:!0}]])]),e("div",sd,[i[16]||(i[16]=e("label",{for:"settingsBoxExpandRight"},"å³ä¾§æ‰©å±• (%):",-1)),oe(e("input",{type:"number",id:"settingsBoxExpandRight","onUpdate:modelValue":i[5]||(i[5]=l=>o.boxExpandRight=l),min:"0",max:"50",step:"1"},null,512),[[Pe,o.boxExpandRight,void 0,{number:!0}]])])])]),e("div",ad,[i[22]||(i[22]=e("div",{class:"settings-group-title"},"ç²¾ç¡®æ–‡å­—æ©è†œ",-1)),e("div",ld,[e("div",id,[i[18]||(i[18]=e("label",{for:"settingsMaskDilateSize"},"è†¨èƒ€å¤§å°:",-1)),oe(e("input",{type:"number",id:"settingsMaskDilateSize","onUpdate:modelValue":i[6]||(i[6]=l=>o.maskDilateSize=l),min:"0",step:"1"},null,512),[[Pe,o.maskDilateSize,void 0,{number:!0}]]),i[19]||(i[19]=e("div",{class:"input-hint"},"æ©è†œè†¨èƒ€åƒç´ æ•°",-1))]),e("div",rd,[i[20]||(i[20]=e("label",{for:"settingsMaskBoxExpandRatio"},"æ ‡æ³¨æ¡†æ‰©å¤§æ¯”ä¾‹ (%):",-1)),oe(e("input",{type:"number",id:"settingsMaskBoxExpandRatio","onUpdate:modelValue":i[7]||(i[7]=l=>o.maskBoxExpandRatio=l),min:"0",max:"100",step:"1"},null,512),[[Pe,o.maskBoxExpandRatio,void 0,{number:!0}]]),i[21]||(i[21]=e("div",{class:"input-hint"},"æ ‡æ³¨æ¡†åŒºåŸŸæ‰©å¤§ç™¾åˆ†æ¯”",-1))])])]),e("div",ud,[i[25]||(i[25]=e("div",{class:"settings-group-title"},"è°ƒè¯•é€‰é¡¹",-1)),e("div",cd,[e("label",dd,[oe(e("input",{type:"checkbox","onUpdate:modelValue":i[8]||(i[8]=l=>o.showDetectionDebug=l)},null,512),[[Xe,o.showDetectionDebug]]),i[23]||(i[23]=de(" æ˜¾ç¤ºæ£€æµ‹æ¡†è°ƒè¯•ä¿¡æ¯ ",-1))]),i[24]||(i[24]=e("div",{class:"input-hint"},"åœ¨ç¿»è¯‘ç»“æœä¸­æ˜¾ç¤ºæ°”æ³¡æ£€æµ‹æ¡†ï¼Œç”¨äºè°ƒè¯•",-1))])])]))}}),pd=Je(gd,[["__scopeId","data-v-501af8bb"]]),md={class:"hq-translation-settings"},vd={class:"settings-group"},fd={class:"settings-row"},bd={class:"settings-item"},hd={class:"settings-item"},xd={class:"password-input-wrapper"},yd=["type"],Cd={key:0,class:"eye-icon"},_d={key:1,class:"eye-off-icon"},kd={class:"settings-item"},Sd={class:"settings-item"},wd={class:"model-input-with-fetch"},$d=["disabled"],Td={class:"fetch-text"},Id={key:0,class:"model-select-container"},Pd={class:"model-count"},Rd={class:"settings-item"},Dd=["disabled"],Md={class:"settings-group"},Bd={class:"settings-row"},Ad={class:"settings-item"},Ed={class:"settings-item"},Ld={class:"settings-row"},Fd={class:"settings-item"},Ud={class:"settings-item"},Od={class:"settings-group"},zd={class:"settings-row"},Nd={class:"settings-item"},Vd={class:"checkbox-label"},Wd={class:"settings-item"},Kd={class:"settings-row"},qd={class:"settings-item"},Hd={class:"checkbox-label"},jd={class:"settings-item"},Jd={class:"checkbox-label"},Yd={class:"settings-group"},Gd={class:"settings-item"},Xd=Ye({__name:"HqTranslationSettings",setup(n){const t=[{label:"SiliconFlow",value:"siliconflow"},{label:"DeepSeek",value:"deepseek"},{label:"ç«å±±å¼•æ“",value:"volcano"},{label:"Google Gemini",value:"gemini"},{label:"è‡ªå®šä¹‰ OpenAI å…¼å®¹æœåŠ¡",value:"custom_openai"}],s=[{label:"Geminié£æ ¼ (reasoning_effort=low)",value:"gemini"},{label:"ç«å±±å¼•æ“é£æ ¼ (thinking=null)",value:"volcano"}],o=Ee(),a=ct(),i=Y(()=>o.settings.hqTranslation),l=w({apiKey:o.settings.hqTranslation.apiKey,modelName:o.settings.hqTranslation.modelName,customBaseUrl:o.settings.hqTranslation.customBaseUrl,batchSize:o.settings.hqTranslation.batchSize,sessionReset:o.settings.hqTranslation.sessionReset,rpmLimit:o.settings.hqTranslation.rpmLimit,maxRetries:o.settings.hqTranslation.maxRetries,lowReasoning:o.settings.hqTranslation.lowReasoning,noThinkingMethod:o.settings.hqTranslation.noThinkingMethod,forceJsonOutput:o.settings.hqTranslation.forceJsonOutput,useStream:o.settings.hqTranslation.useStream,prompt:o.settings.hqTranslation.prompt});Se(()=>l.value.apiKey,v=>{o.updateHqTranslation({apiKey:v})}),Se(()=>l.value.modelName,v=>{o.updateHqTranslation({modelName:v})}),Se(()=>l.value.customBaseUrl,v=>{o.updateHqTranslation({customBaseUrl:v})}),Se(()=>l.value.batchSize,v=>{o.updateHqTranslation({batchSize:v})}),Se(()=>l.value.sessionReset,v=>{o.updateHqTranslation({sessionReset:v})}),Se(()=>l.value.rpmLimit,v=>{o.updateHqTranslation({rpmLimit:v})}),Se(()=>l.value.maxRetries,v=>{o.updateHqTranslation({maxRetries:v})}),Se(()=>l.value.lowReasoning,v=>{o.updateHqTranslation({lowReasoning:v})}),Se(()=>l.value.noThinkingMethod,v=>{o.updateHqTranslation({noThinkingMethod:v})}),Se(()=>l.value.forceJsonOutput,v=>{o.updateHqTranslation({forceJsonOutput:v})}),Se(()=>l.value.useStream,v=>{o.updateHqTranslation({useStream:v})}),Se(()=>l.value.prompt,v=>{o.updateHqTranslation({prompt:v})});const m=w(!1),g=w(!1),u=w([]),b=w(!1),_=Y(()=>{const v=[{label:"-- é€‰æ‹©æ¨¡å‹ --",value:""}];return u.value.forEach(p=>v.push({label:p,value:p})),v});function S(v){o.setHqProvider(v),u.value=[],R()}function R(){const v=o.settings.hqTranslation;l.value.apiKey=v.apiKey,l.value.modelName=v.modelName,l.value.customBaseUrl=v.customBaseUrl,l.value.batchSize=v.batchSize,l.value.sessionReset=v.sessionReset,l.value.rpmLimit=v.rpmLimit,l.value.maxRetries=v.maxRetries,l.value.lowReasoning=v.lowReasoning,l.value.noThinkingMethod=v.noThinkingMethod,l.value.forceJsonOutput=v.forceJsonOutput,l.value.useStream=v.useStream,l.value.prompt=v.prompt}function y(v){return{siliconflow:"SiliconFlow",deepseek:"DeepSeek",volcano:"ç«å±±å¼•æ“",gemini:"Google Gemini",custom_openai:"è‡ªå®šä¹‰OpenAI"}[v]||v}async function D(){const v=i.value.provider,p=l.value.apiKey?.trim(),$=l.value.customBaseUrl?.trim();if(!p){a.warning("è¯·å…ˆå¡«å†™ API Key");return}if(!["siliconflow","deepseek","volcano","gemini","custom_openai"].includes(v)){a.warning(`${y(v)} ä¸æ”¯æŒè‡ªåŠ¨è·å–æ¨¡å‹åˆ—è¡¨`);return}if(v==="custom_openai"&&!$){a.warning("è‡ªå®šä¹‰æœåŠ¡éœ€è¦å…ˆå¡«å†™ Base URL");return}g.value=!0;try{const F=await He.fetchModels(v,p,$);F.success&&F.models&&F.models.length>0?(u.value=F.models.map(z=>z.id),a.success(`è·å–åˆ° ${F.models.length} ä¸ªæ¨¡å‹`)):a.warning(F.message||"æœªè·å–åˆ°å¯ç”¨æ¨¡å‹")}catch(F){const z=F instanceof Error?F.message:"è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥";a.error(z)}finally{g.value=!1}}async function V(){const v=i.value.provider,p=l.value.apiKey?.trim(),$=l.value.modelName?.trim(),k=l.value.customBaseUrl?.trim();if(!p){a.warning("è¯·å…ˆå¡«å†™ API Key");return}if(!$){a.warning("è¯·å¡«å†™æ¨¡å‹åç§°");return}if(v==="custom_openai"&&!k){a.warning("è‡ªå®šä¹‰æœåŠ¡éœ€è¦å¡«å†™ Base URL");return}b.value=!0,a.info("æ­£åœ¨æµ‹è¯•è¿æ¥...");try{const F=await He.testAiTranslateConnection({provider:v,apiKey:p,modelName:$,baseUrl:k});F.success?a.success(F.message||`${y(v)} è¿æ¥æˆåŠŸ!`):a.error(F.message||F.error||"è¿æ¥å¤±è´¥")}catch(F){const z=F instanceof Error?F.message:"è¿æ¥æµ‹è¯•å¤±è´¥";a.error(z)}finally{b.value=!1}}function M(){o.updateHqTranslation({prompt:tn}),l.value.prompt=tn,a.success("å·²é‡ç½®ä¸ºé»˜è®¤æç¤ºè¯")}function B(v,p){o.updateHqTranslation({prompt:v}),l.value.prompt=v,a.success(`å·²åº”ç”¨æç¤ºè¯: ${p}`)}return(v,p)=>(A(),L("div",md,[e("div",vd,[p[20]||(p[20]=e("div",{class:"settings-group-title"},"é«˜è´¨é‡ç¿»è¯‘æœåŠ¡é…ç½®",-1)),e("div",fd,[e("div",bd,[p[15]||(p[15]=e("label",{for:"settingsHqTranslateProvider"},"æœåŠ¡å•†:",-1)),ke(Ve,{"model-value":i.value.provider,options:t,onChange:p[0]||(p[0]=$=>S($))},null,8,["model-value"])]),e("div",hd,[p[16]||(p[16]=e("label",{for:"settingsHqApiKey"},"API Key:",-1)),e("div",xd,[oe(e("input",{type:m.value?"text":"password",id:"settingsHqApiKey","onUpdate:modelValue":p[1]||(p[1]=$=>l.value.apiKey=$),class:"secure-input",placeholder:"è¯·è¾“å…¥API Key",autocomplete:"off"},null,8,yd),[[kt,l.value.apiKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:p[2]||(p[2]=$=>m.value=!m.value)},[m.value?(A(),L("span",_d,"ğŸ‘â€ğŸ—¨")):(A(),L("span",Cd,"ğŸ‘"))])])])]),oe(e("div",kd,[p[17]||(p[17]=e("label",{for:"settingsHqCustomBaseUrl"},"Base URL:",-1)),oe(e("input",{type:"text",id:"settingsHqCustomBaseUrl","onUpdate:modelValue":p[3]||(p[3]=$=>l.value.customBaseUrl=$),placeholder:"ä¾‹å¦‚: https://api.example.com/v1"},null,512),[[Pe,l.value.customBaseUrl]])],512),[[Oe,i.value.provider==="custom_openai"]]),e("div",Sd,[p[19]||(p[19]=e("label",{for:"settingsHqModelName"},"æ¨¡å‹åç§°:",-1)),e("div",wd,[oe(e("input",{type:"text",id:"settingsHqModelName","onUpdate:modelValue":p[4]||(p[4]=$=>l.value.modelName=$),placeholder:"è¯·è¾“å…¥æ¨¡å‹åç§°"},null,512),[[Pe,l.value.modelName]]),e("button",{type:"button",class:"fetch-models-btn",title:"è·å–å¯ç”¨æ¨¡å‹åˆ—è¡¨",onClick:D,disabled:g.value},[p[18]||(p[18]=e("span",{class:"fetch-icon"},"ğŸ”",-1)),e("span",Td,te(g.value?"è·å–ä¸­...":"è·å–æ¨¡å‹"),1)],8,$d)]),u.value.length>0?(A(),L("div",Id,[ke(Ve,{modelValue:l.value.modelName,"onUpdate:modelValue":p[5]||(p[5]=$=>l.value.modelName=$),options:_.value},null,8,["modelValue","options"]),e("span",Pd,"å…± "+te(u.value.length)+" ä¸ªæ¨¡å‹",1)])):ce("",!0)]),e("div",Rd,[e("button",{class:"settings-test-btn",onClick:V,disabled:b.value},te(b.value?"æµ‹è¯•ä¸­...":"ğŸ”— æµ‹è¯•è¿æ¥"),9,Dd)])]),e("div",Md,[p[28]||(p[28]=e("div",{class:"settings-group-title"},"æ‰¹å¤„ç†è®¾ç½®",-1)),e("div",Bd,[e("div",Ad,[p[21]||(p[21]=e("label",{for:"settingsHqBatchSize"},"æ‰¹æ¬¡å¤§å°:",-1)),oe(e("input",{type:"number",id:"settingsHqBatchSize","onUpdate:modelValue":p[6]||(p[6]=$=>l.value.batchSize=$),min:"1",max:"10",step:"1"},null,512),[[Pe,l.value.batchSize,void 0,{number:!0}]]),p[22]||(p[22]=e("div",{class:"input-hint"},"æ¯æ‰¹å¤„ç†çš„å›¾ç‰‡æ•°é‡ (æ¨è3-5å¼ )",-1))]),e("div",Ed,[p[23]||(p[23]=e("label",{for:"settingsHqSessionReset"},"ä¼šè¯é‡ç½®é¢‘ç‡:",-1)),oe(e("input",{type:"number",id:"settingsHqSessionReset","onUpdate:modelValue":p[7]||(p[7]=$=>l.value.sessionReset=$),min:"1",step:"1"},null,512),[[Pe,l.value.sessionReset,void 0,{number:!0}]]),p[24]||(p[24]=e("div",{class:"input-hint"},"å¤šå°‘æ‰¹æ¬¡åé‡ç½®ä¸Šä¸‹æ–‡",-1))])]),e("div",Ld,[e("div",Fd,[p[25]||(p[25]=e("label",{for:"settingsHqRpmLimit"},"RPMé™åˆ¶:",-1)),oe(e("input",{type:"number",id:"settingsHqRpmLimit","onUpdate:modelValue":p[8]||(p[8]=$=>l.value.rpmLimit=$),min:"0",step:"1"},null,512),[[Pe,l.value.rpmLimit,void 0,{number:!0}]]),p[26]||(p[26]=e("div",{class:"input-hint"},"æ¯åˆ†é’Ÿè¯·æ±‚æ•°ï¼Œ0è¡¨ç¤ºæ— é™åˆ¶",-1))]),e("div",Ud,[p[27]||(p[27]=e("label",{for:"settingsHqMaxRetries"},"é‡è¯•æ¬¡æ•°:",-1)),oe(e("input",{type:"number",id:"settingsHqMaxRetries","onUpdate:modelValue":p[9]||(p[9]=$=>l.value.maxRetries=$),min:"0",max:"10",step:"1"},null,512),[[Pe,l.value.maxRetries,void 0,{number:!0}]])])])]),e("div",Od,[p[36]||(p[36]=e("div",{class:"settings-group-title"},"é«˜çº§é€‰é¡¹",-1)),e("div",zd,[e("div",Nd,[e("label",Vd,[oe(e("input",{type:"checkbox","onUpdate:modelValue":p[10]||(p[10]=$=>l.value.lowReasoning=$)},null,512),[[Xe,l.value.lowReasoning]]),p[29]||(p[29]=de(" ä½æ¨ç†æ¨¡å¼ ",-1))]),p[30]||(p[30]=e("div",{class:"input-hint"},"å‡å°‘æ¨¡å‹æ¨ç†æ·±åº¦ï¼Œæé«˜é€Ÿåº¦",-1))]),e("div",Wd,[p[31]||(p[31]=e("label",{for:"settingsHqNoThinkingMethod"},"å–æ¶ˆæ€è€ƒæ–¹æ³•:",-1)),ke(Ve,{modelValue:l.value.noThinkingMethod,"onUpdate:modelValue":p[11]||(p[11]=$=>l.value.noThinkingMethod=$),options:s},null,8,["modelValue"])])]),e("div",Kd,[e("div",qd,[e("label",Hd,[oe(e("input",{type:"checkbox","onUpdate:modelValue":p[12]||(p[12]=$=>l.value.forceJsonOutput=$)},null,512),[[Xe,l.value.forceJsonOutput]]),p[32]||(p[32]=de(" å¼ºåˆ¶JSONè¾“å‡º ",-1))]),p[33]||(p[33]=e("div",{class:"input-hint"},"ä½¿ç”¨ response_format: json_object",-1))]),e("div",jd,[e("label",Jd,[oe(e("input",{type:"checkbox","onUpdate:modelValue":p[13]||(p[13]=$=>l.value.useStream=$)},null,512),[[Xe,l.value.useStream]]),p[34]||(p[34]=de(" æµå¼è°ƒç”¨ ",-1))]),p[35]||(p[35]=e("div",{class:"input-hint"},"ä½¿ç”¨æµå¼APIè°ƒç”¨",-1))])])]),e("div",Yd,[p[37]||(p[37]=e("div",{class:"settings-group-title"},"é«˜è´¨é‡ç¿»è¯‘æç¤ºè¯",-1)),e("div",Gd,[oe(e("textarea",{id:"settingsHqPrompt","onUpdate:modelValue":p[14]||(p[14]=$=>l.value.prompt=$),rows:"6",placeholder:"é«˜è´¨é‡ç¿»è¯‘æç¤ºè¯"},null,512),[[Pe,l.value.prompt]]),ke(Vt,{"prompt-type":"hq_translate",onSelect:B}),e("button",{class:"btn btn-secondary btn-sm",onClick:M},"é‡ç½®ä¸ºé»˜è®¤")])])]))}}),Zd=Je(Xd,[["__scopeId","data-v-23f4a3f7"]]),Qd={class:"proofreading-settings"},eg={class:"settings-group"},tg={class:"settings-item"},og={class:"checkbox-label"},ng={class:"settings-item"},sg={class:"settings-group"},ag={class:"round-header"},lg={class:"round-title"},ig=["onClick","disabled"],rg={class:"round-content"},ug={class:"settings-item"},cg=["onUpdate:modelValue"],dg={class:"settings-row"},gg={class:"settings-item"},pg={class:"settings-item"},mg={class:"password-input-wrapper"},vg=["type","onUpdate:modelValue"],fg=["onClick"],bg={key:0,class:"eye-icon"},hg={key:1,class:"eye-off-icon"},xg={class:"settings-item"},yg=["onUpdate:modelValue"],Cg={class:"settings-item"},_g={class:"model-input-with-fetch"},kg=["onUpdate:modelValue"],Sg=["onClick","disabled"],wg={class:"fetch-text"},$g={key:0,class:"model-select-container"},Tg={class:"model-count"},Ig={class:"settings-item"},Pg=["onClick","disabled"],Rg={class:"settings-row"},Dg={class:"settings-item"},Mg=["onUpdate:modelValue"],Bg={class:"settings-item"},Ag=["onUpdate:modelValue"],Eg={class:"settings-item"},Lg=["onUpdate:modelValue"],Fg={class:"settings-row"},Ug={class:"settings-item"},Og={class:"checkbox-label"},zg=["onUpdate:modelValue"],Ng={class:"settings-item"},Vg={class:"settings-row"},Wg={class:"settings-item"},Kg={class:"checkbox-label"},qg=["onUpdate:modelValue"],Hg={class:"settings-item"},jg={class:"checkbox-label"},Jg=["onUpdate:modelValue"],Yg={class:"settings-item"},Gg=["onUpdate:modelValue"],Xg=["onClick"],Zg=Ye({__name:"ProofreadingSettings",setup(n){const t=[{label:"SiliconFlow",value:"siliconflow"},{label:"DeepSeek",value:"deepseek"},{label:"ç«å±±å¼•æ“",value:"volcano"},{label:"Google Gemini",value:"gemini"},{label:"è‡ªå®šä¹‰ OpenAI å…¼å®¹æœåŠ¡",value:"custom_openai"}],s=[{label:"Geminié£æ ¼",value:"gemini"},{label:"ç«å±±å¼•æ“é£æ ¼",value:"volcano"}],o=Ee(),a=ct(),i=w({}),l=w({}),m=w({}),g=Y(()=>o.settings.proofreading.rounds),u=Y({get:()=>o.settings.proofreading.maxRetries,set:B=>o.setProofreadingMaxRetries(B)}),b=Y({get:()=>o.settings.proofreading.enabled,set:B=>o.setProofreadingEnabled(B)});Se(()=>o.settings.proofreading.rounds,()=>{o.saveToStorage()},{deep:!0});function _(B){const v=m.value[B]||[],p=[{label:"-- é€‰æ‹©æ¨¡å‹ --",value:""}];return v.forEach($=>p.push({label:$,value:$})),p}async function S(B){const v=g.value[B];if(!v)return;const p=v.provider,$=v.apiKey?.trim(),k=v.customBaseUrl?.trim();if(!$){a.warning("è¯·å…ˆå¡«å†™ API Key");return}if(!["siliconflow","deepseek","volcano","gemini","custom_openai"].includes(p)){a.warning("å½“å‰æœåŠ¡å•†ä¸æ”¯æŒè·å–æ¨¡å‹åˆ—è¡¨");return}i.value[B]=!0;try{const z=await He.fetchModels(p,$,k);z.success&&z.models&&z.models.length>0?(m.value[B]=z.models.map(ee=>ee.id),a.success(`è½®æ¬¡ ${B+1}: è·å–åˆ° ${z.models.length} ä¸ªæ¨¡å‹`)):a.warning(z.message||"æœªè·å–åˆ°å¯ç”¨æ¨¡å‹")}catch(z){const ee=z instanceof Error?z.message:"è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥";a.error(ee)}finally{i.value[B]=!1}}async function R(B){const v=g.value[B];if(!v)return;const p=v.provider,$=v.apiKey?.trim(),k=v.modelName?.trim(),F=v.customBaseUrl?.trim();if(!$){a.warning("è¯·å…ˆå¡«å†™ API Key");return}if(!k){a.warning("è¯·å¡«å†™æ¨¡å‹åç§°");return}l.value[B]=!0,a.info(`æ­£åœ¨æµ‹è¯•è½®æ¬¡ ${B+1} çš„è¿æ¥...`);try{const z=await He.testAiTranslateConnection({provider:p,apiKey:$,modelName:k,baseUrl:F});z.success?a.success(z.message||"è¿æ¥æˆåŠŸ!"):a.error(z.message||z.error||"è¿æ¥å¤±è´¥")}catch(z){const ee=z instanceof Error?z.message:"è¿æ¥æµ‹è¯•å¤±è´¥";a.error(ee)}finally{l.value[B]=!1}}function y(){const B={name:`ç¬¬${g.value.length+1}è½®æ ¡å¯¹`,provider:"siliconflow",apiKey:"",modelName:"",customBaseUrl:"",batchSize:3,sessionReset:3,rpmLimit:7,lowReasoning:!1,noThinkingMethod:"gemini",forceJsonOutput:!1,useStream:!0,prompt:on,showApiKey:!1};o.addProofreadingRound(B),a.success("å·²æ·»åŠ æ–°çš„æ ¡å¯¹è½®æ¬¡")}function D(B){if(g.value.length<=1){a.warning("è‡³å°‘éœ€è¦ä¿ç•™ä¸€ä¸ªæ ¡å¯¹è½®æ¬¡");return}o.removeProofreadingRound(B),a.success("å·²åˆ é™¤æ ¡å¯¹è½®æ¬¡")}function V(B){o.updateProofreadingRound(B,{prompt:on}),a.success("å·²é‡ç½®ä¸ºé»˜è®¤æç¤ºè¯")}function M(B,v,p){o.updateProofreadingRound(B,{prompt:v}),a.success(`å·²åº”ç”¨æç¤ºè¯: ${p}`)}return(B,v)=>(A(),L("div",Qd,[e("div",eg,[v[5]||(v[5]=e("div",{class:"settings-group-title"},"AIæ ¡å¯¹è®¾ç½®",-1)),e("div",tg,[e("label",og,[oe(e("input",{type:"checkbox","onUpdate:modelValue":v[0]||(v[0]=p=>b.value=p)},null,512),[[Xe,b.value]]),v[2]||(v[2]=de(" å¯ç”¨AIæ ¡å¯¹ ",-1))]),v[3]||(v[3]=e("div",{class:"input-hint"},"ç¿»è¯‘å®Œæˆåè‡ªåŠ¨è¿›è¡ŒAIæ ¡å¯¹",-1))]),e("div",ng,[v[4]||(v[4]=e("label",{for:"settingsProofreadingMaxRetries"},"å…¨å±€é‡è¯•æ¬¡æ•°:",-1)),oe(e("input",{type:"number",id:"settingsProofreadingMaxRetries","onUpdate:modelValue":v[1]||(v[1]=p=>u.value=p),min:"0",max:"10",step:"1"},null,512),[[Pe,u.value,void 0,{number:!0}]])])]),oe(e("div",sg,[e("div",{class:"settings-group-title"},[v[6]||(v[6]=de(" æ ¡å¯¹è½®æ¬¡é…ç½® ",-1)),e("button",{class:"btn btn-secondary btn-sm",onClick:y},"+ æ·»åŠ è½®æ¬¡")]),(A(!0),L(ze,null,Ge(g.value,(p,$)=>(A(),L("div",{key:$,class:"proofreading-round"},[e("div",ag,[e("span",lg,"è½®æ¬¡ "+te($+1)+": "+te(p.name||"æœªå‘½å"),1),e("button",{class:"btn btn-danger btn-sm",onClick:k=>D($),disabled:g.value.length<=1}," åˆ é™¤ ",8,ig)]),e("div",rg,[e("div",ug,[v[7]||(v[7]=e("label",null,"è½®æ¬¡åç§°:",-1)),oe(e("input",{type:"text","onUpdate:modelValue":k=>p.name=k,placeholder:"å¦‚: ç¬¬ä¸€è½®æ ¡å¯¹"},null,8,cg),[[Pe,p.name]])]),e("div",dg,[e("div",gg,[v[8]||(v[8]=e("label",null,"æœåŠ¡å•†:",-1)),ke(Ve,{modelValue:p.provider,"onUpdate:modelValue":k=>p.provider=k,options:t},null,8,["modelValue","onUpdate:modelValue"])]),e("div",pg,[v[9]||(v[9]=e("label",null,"API Key:",-1)),e("div",mg,[oe(e("input",{type:p.showApiKey?"text":"password","onUpdate:modelValue":k=>p.apiKey=k,class:"secure-input",placeholder:"è¯·è¾“å…¥API Key",autocomplete:"off"},null,8,vg),[[kt,p.apiKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:k=>p.showApiKey=!p.showApiKey},[p.showApiKey?(A(),L("span",hg,"ğŸ‘â€ğŸ—¨")):(A(),L("span",bg,"ğŸ‘"))],8,fg)])])]),oe(e("div",xg,[v[10]||(v[10]=e("label",null,"Base URL:",-1)),oe(e("input",{type:"text","onUpdate:modelValue":k=>p.customBaseUrl=k,placeholder:"ä¾‹å¦‚: https://api.example.com/v1"},null,8,yg),[[Pe,p.customBaseUrl]])],512),[[Oe,p.provider==="custom_openai"]]),e("div",Cg,[v[12]||(v[12]=e("label",null,"æ¨¡å‹åç§°:",-1)),e("div",_g,[oe(e("input",{type:"text","onUpdate:modelValue":k=>p.modelName=k,placeholder:"è¯·è¾“å…¥æ¨¡å‹åç§°"},null,8,kg),[[Pe,p.modelName]]),e("button",{type:"button",class:"fetch-models-btn",title:"è·å–å¯ç”¨æ¨¡å‹åˆ—è¡¨",onClick:k=>S($),disabled:i.value[$]},[v[11]||(v[11]=e("span",{class:"fetch-icon"},"ğŸ”",-1)),e("span",wg,te(i.value[$]?"è·å–ä¸­...":"è·å–æ¨¡å‹"),1)],8,Sg)]),m.value[$]&&m.value[$].length>0?(A(),L("div",$g,[ke(Ve,{modelValue:p.modelName,"onUpdate:modelValue":k=>p.modelName=k,options:_($)},null,8,["modelValue","onUpdate:modelValue","options"]),e("span",Tg,"å…± "+te(m.value[$].length)+" ä¸ªæ¨¡å‹",1)])):ce("",!0)]),e("div",Ig,[e("button",{class:"settings-test-btn",onClick:k=>R($),disabled:l.value[$]},te(l.value[$]?"æµ‹è¯•ä¸­...":"ğŸ”— æµ‹è¯•è¿æ¥"),9,Pg)]),e("div",Rg,[e("div",Dg,[v[13]||(v[13]=e("label",null,"æ‰¹æ¬¡å¤§å°:",-1)),oe(e("input",{type:"number","onUpdate:modelValue":k=>p.batchSize=k,min:"1",max:"10",step:"1"},null,8,Mg),[[Pe,p.batchSize,void 0,{number:!0}]])]),e("div",Bg,[v[14]||(v[14]=e("label",null,"ä¼šè¯é‡ç½®é¢‘ç‡:",-1)),oe(e("input",{type:"number","onUpdate:modelValue":k=>p.sessionReset=k,min:"1",step:"1"},null,8,Ag),[[Pe,p.sessionReset,void 0,{number:!0}]])]),e("div",Eg,[v[15]||(v[15]=e("label",null,"RPMé™åˆ¶:",-1)),oe(e("input",{type:"number","onUpdate:modelValue":k=>p.rpmLimit=k,min:"0",step:"1"},null,8,Lg),[[Pe,p.rpmLimit,void 0,{number:!0}]])])]),e("div",Fg,[e("div",Ug,[e("label",Og,[oe(e("input",{type:"checkbox","onUpdate:modelValue":k=>p.lowReasoning=k},null,8,zg),[[Xe,p.lowReasoning]]),v[16]||(v[16]=de(" ä½æ¨ç†æ¨¡å¼ ",-1))]),v[17]||(v[17]=e("div",{class:"input-hint"},"å‡å°‘æ¨¡å‹æ¨ç†æ·±åº¦ï¼Œæé«˜é€Ÿåº¦",-1))]),e("div",Ng,[v[18]||(v[18]=e("label",null,"å–æ¶ˆæ€è€ƒæ–¹æ³•:",-1)),ke(Ve,{modelValue:p.noThinkingMethod,"onUpdate:modelValue":k=>p.noThinkingMethod=k,options:s},null,8,["modelValue","onUpdate:modelValue"])])]),e("div",Vg,[e("div",Wg,[e("label",Kg,[oe(e("input",{type:"checkbox","onUpdate:modelValue":k=>p.forceJsonOutput=k},null,8,qg),[[Xe,p.forceJsonOutput]]),v[19]||(v[19]=de(" å¼ºåˆ¶JSONè¾“å‡º ",-1))]),v[20]||(v[20]=e("div",{class:"input-hint"},"ä½¿ç”¨ response_format: json_object",-1))]),e("div",Hg,[e("label",jg,[oe(e("input",{type:"checkbox","onUpdate:modelValue":k=>p.useStream=k},null,8,Jg),[[Xe,p.useStream]]),v[21]||(v[21]=de(" æµå¼è°ƒç”¨ ",-1))]),v[22]||(v[22]=e("div",{class:"input-hint"},"ä½¿ç”¨æµå¼APIè°ƒç”¨ï¼Œé¿å…è¶…æ—¶",-1))])]),e("div",Yg,[v[23]||(v[23]=e("label",null,"æ ¡å¯¹æç¤ºè¯:",-1)),oe(e("textarea",{"onUpdate:modelValue":k=>p.prompt=k,rows:"4",placeholder:"æ ¡å¯¹æç¤ºè¯"},null,8,Gg),[[Pe,p.prompt]]),ke(Vt,{"prompt-type":"proofreading",onSelect:(k,F)=>M($,k,F)},null,8,["onSelect"]),e("button",{class:"btn btn-secondary btn-sm",onClick:k=>V($)},"é‡ç½®ä¸ºé»˜è®¤",8,Xg)])])]))),128))],512),[[Oe,b.value]])]))}}),Qg=Je(Zg,[["__scopeId","data-v-7e4f95fe"]]),ep={class:"prompt-library"},tp={class:"settings-group"},op={class:"settings-item"},np={key:0,class:"settings-item"},sp={class:"mode-hint"},ap={class:"settings-group"},lp={key:0,class:"loading-hint"},ip={key:1,class:"empty-hint"},rp={key:2,class:"prompt-list"},up=["onClick"],cp={class:"prompt-name"},dp={class:"prompt-actions"},gp=["onClick"],pp=["onClick","disabled"],mp={class:"settings-group"},vp={class:"settings-item"},fp={class:"settings-item"},bp={class:"prompt-editor-actions"},hp=["disabled"],xp=Ye({__name:"PromptLibrary",setup(n){const t=[{label:"ç¿»è¯‘æç¤ºè¯",value:"translate"},{label:"æ–‡æœ¬æ¡†æç¤ºè¯",value:"textbox"},{label:"AIè§†è§‰OCRæç¤ºè¯",value:"ai_vision_ocr"},{label:"é«˜è´¨é‡ç¿»è¯‘æç¤ºè¯",value:"hq_translate"},{label:"æ ¡å¯¹æç¤ºè¯",value:"proofreading"}],s=[{label:"æ™®é€šæ¨¡å¼",value:"false"},{label:"JSONæ ¼å¼æ¨¡å¼",value:"true"}],o=ct(),a=Ee(),i=w("translate"),l=w([]),m=w(""),g=w(""),u=w(""),b=w(!1),_=w(!1),S=Y(()=>i.value==="translate"||i.value==="ai_vision_ocr"),R=Y(()=>_.value?"é€‚ç”¨äºéœ€è¦ç»“æ„åŒ–è¾“å‡ºçš„åœºæ™¯":"é€‚ç”¨äºæ™®é€šç¿»è¯‘åœºæ™¯");async function y(){b.value=!0;try{let $;i.value==="textbox"?$=await He.getTextboxPrompts():$=await He.getPrompts(i.value);const k=$.prompt_names||[];l.value=k.map(F=>({name:F}))}catch($){const k=$ instanceof Error?$.message:"åŠ è½½æç¤ºè¯åˆ—è¡¨å¤±è´¥";o.error(k)}finally{b.value=!1}}async function D($){m.value=$,g.value=$,await V($)}async function V($){try{let k;i.value==="textbox"?k=await He.getTextboxPromptContent($):k=await He.getPromptContent(i.value,$),g.value=$,u.value=k.prompt_content||"",m.value=$,o.success("å·²åŠ è½½æç¤ºè¯")}catch(k){const F=k instanceof Error?k.message:"åŠ è½½æç¤ºè¯å†…å®¹å¤±è´¥";o.error(F)}}async function M(){if(!g.value||!u.value){o.warning("è¯·è¾“å…¥æç¤ºè¯åç§°å’Œå†…å®¹");return}try{i.value==="textbox"?await He.saveTextboxPrompt(g.value,u.value):await He.savePrompt(i.value,g.value,u.value),o.success("æç¤ºè¯ä¿å­˜æˆåŠŸ"),g.value="",u.value="",await y()}catch($){const k=$ instanceof Error?$.message:"ä¿å­˜æç¤ºè¯å¤±è´¥";o.error(k)}}async function B($){if($==="default"){o.warning("é»˜è®¤æç¤ºè¯ä¸èƒ½åˆ é™¤");return}try{i.value==="textbox"?await He.deleteTextboxPrompt($):await He.deletePrompt(i.value,$),o.success("æç¤ºè¯åˆ é™¤æˆåŠŸ"),m.value===$&&(m.value="",g.value="",u.value=""),await y()}catch(k){const F=k instanceof Error?k.message:"åˆ é™¤æç¤ºè¯å¤±è´¥";o.error(F)}}function v(){m.value="",g.value="",u.value="",i.value==="translate"?_.value=a.settings.translation.isJsonMode:i.value==="ai_vision_ocr"?_.value=a.settings.aiVisionOcr.isJsonMode:_.value=!1,y()}function p(){i.value==="translate"?a.updateTranslationService({isJsonMode:_.value}):i.value==="ai_vision_ocr"&&a.updateAiVisionOcr({isJsonMode:_.value}),o.info(`å·²åˆ‡æ¢åˆ°${_.value?"JSONæ ¼å¼":"æ™®é€š"}æ¨¡å¼`)}return dt(()=>{_.value=a.settings.translation.isJsonMode,y()}),($,k)=>(A(),L("div",ep,[e("div",tp,[k[6]||(k[6]=e("div",{class:"settings-group-title"},"æç¤ºè¯ç®¡ç†",-1)),e("div",op,[k[4]||(k[4]=e("label",{for:"promptType"},"æç¤ºè¯ç±»å‹:",-1)),ke(Ve,{modelValue:i.value,"onUpdate:modelValue":k[0]||(k[0]=F=>i.value=F),options:t,onChange:v},null,8,["modelValue"])]),S.value?(A(),L("div",np,[k[5]||(k[5]=e("label",{for:"promptMode"},"æç¤ºè¯æ¨¡å¼:",-1)),ke(Ve,{"model-value":_.value?"true":"false",options:s,onChange:k[1]||(k[1]=F=>{_.value=F==="true",p()})},null,8,["model-value"]),e("span",sp,te(R.value),1)])):ce("",!0)]),e("div",ap,[k[7]||(k[7]=e("div",{class:"settings-group-title"},"å·²ä¿å­˜çš„æç¤ºè¯",-1)),b.value?(A(),L("div",lp,"åŠ è½½ä¸­...")):l.value.length===0?(A(),L("div",ip,"æš‚æ— ä¿å­˜çš„æç¤ºè¯")):(A(),L("div",rp,[(A(!0),L(ze,null,Ge(l.value,F=>(A(),L("div",{key:F.name,class:Re(["prompt-item",{active:m.value===F.name}]),onClick:z=>D(F.name)},[e("span",cp,te(F.name),1),e("div",dp,[e("button",{class:"btn btn-sm",onClick:nt(z=>V(F.name),["stop"]),title:"åŠ è½½åˆ°ç¼–è¾‘å™¨"},"ğŸ“¥",8,gp),e("button",{class:"btn btn-sm btn-danger",onClick:nt(z=>B(F.name),["stop"]),title:"åˆ é™¤",disabled:F.name==="default"}," ğŸ—‘ï¸ ",8,pp)])],10,up))),128))]))]),e("div",mp,[k[10]||(k[10]=e("div",{class:"settings-group-title"},"æç¤ºè¯ç¼–è¾‘",-1)),e("div",vp,[k[8]||(k[8]=e("label",{for:"promptName"},"æç¤ºè¯åç§°:",-1)),oe(e("input",{type:"text",id:"promptName","onUpdate:modelValue":k[2]||(k[2]=F=>g.value=F),placeholder:"è¯·è¾“å…¥æç¤ºè¯åç§°"},null,512),[[Pe,g.value]])]),e("div",fp,[k[9]||(k[9]=e("label",{for:"promptContent"},"æç¤ºè¯å†…å®¹:",-1)),oe(e("textarea",{id:"promptContent","onUpdate:modelValue":k[3]||(k[3]=F=>u.value=F),rows:"8",placeholder:"è¯·è¾“å…¥æç¤ºè¯å†…å®¹"},null,512),[[Pe,u.value]])]),e("div",bp,[e("button",{class:"btn btn-primary",onClick:M,disabled:!g.value||!u.value},"ä¿å­˜æç¤ºè¯",8,hp)])])]))}}),yp=Je(xp,[["__scopeId","data-v-70f0ec19"]]),Cp={class:"plugin-manager"},_p={class:"settings-group"},kp={key:0,class:"loading-hint"},Sp={key:1,class:"empty-hint"},wp={key:2,class:"plugin-list"},$p={class:"plugin-info"},Tp={class:"plugin-header"},Ip={class:"plugin-name"},Pp={class:"plugin-version"},Rp={class:"plugin-description"},Dp={class:"plugin-controls"},Mp={class:"switch"},Bp=["checked","onChange"],Ap=["onClick"],Ep=["onClick"],Lp={class:"settings-group"},Fp={class:"plugin-name"},Up={class:"switch"},Op=["checked","onChange"],zp={class:"plugin-config-content"},Np={class:"plugin-config-header"},Vp={class:"plugin-config-body"},Wp=["for"],Kp=["id","onUpdate:modelValue"],qp=["id","onUpdate:modelValue","min","max"],Hp=["id","onUpdate:modelValue","placeholder"],jp={key:4,class:"field-description"},Jp=Ye({__name:"PluginManager",setup(n){const t=ct(),s=w([]),o=w({}),a=w(!1),i=w(!1),l=w(null),m=w({}),g=w({});async function u(){a.value=!0;try{const M=await Zs();s.value=M.plugins||[]}catch(M){const B=M instanceof Error?M.message:"åŠ è½½æ’ä»¶åˆ—è¡¨å¤±è´¥";t.error(B)}finally{a.value=!1}}async function b(){try{const M=await ia();o.value=M.states||{}}catch(M){console.error("åŠ è½½é»˜è®¤çŠ¶æ€å¤±è´¥:",M)}}async function _(M){try{M.enabled?(await ea(M.name),M.enabled=!1,t.success(`å·²ç¦ç”¨ ${M.display_name||M.name}`)):(await Qs(M.name),M.enabled=!0,t.success(`å·²å¯ç”¨ ${M.display_name||M.name}`))}catch(B){const v=B instanceof Error?B.message:"æ“ä½œå¤±è´¥";t.error(v)}}async function S(M,B){const v=B.target,p=v.checked;try{await ra(M,p),o.value[M]=p,t.success("é»˜è®¤çŠ¶æ€å·²æ›´æ–°")}catch($){const k=$ instanceof Error?$.message:"è®¾ç½®å¤±è´¥";t.error(k),v.checked=!p}}async function R(M){l.value=M;try{const B=await ua(M.name);m.value=B.schema||{};const v=await ca(M.name);g.value=v.config||{},i.value=!0}catch(B){const v=B instanceof Error?B.message:"åŠ è½½é…ç½®å¤±è´¥";t.error(v)}}function y(){i.value=!1,l.value=null,m.value={},g.value={}}async function D(){if(l.value)try{await da(l.value.name,g.value),t.success("é…ç½®ä¿å­˜æˆåŠŸ"),y()}catch(M){const B=M instanceof Error?M.message:"ä¿å­˜é…ç½®å¤±è´¥";t.error(B)}}async function V(M){if(confirm(`ç¡®å®šè¦åˆ é™¤æ’ä»¶ "${M.display_name||M.name}" å—ï¼Ÿ`))try{await ta(M.name),t.success("æ’ä»¶åˆ é™¤æˆåŠŸ"),await u()}catch(B){const v=B instanceof Error?B.message:"åˆ é™¤æ’ä»¶å¤±è´¥";t.error(v)}}return dt(()=>{u(),b()}),(M,B)=>(A(),L("div",Cp,[e("div",_p,[B[1]||(B[1]=e("div",{class:"settings-group-title"},"å·²å®‰è£…æ’ä»¶",-1)),a.value?(A(),L("div",kp,"åŠ è½½ä¸­...")):s.value.length===0?(A(),L("div",Sp,"æš‚æ— å·²å®‰è£…çš„æ’ä»¶")):(A(),L("div",wp,[(A(!0),L(ze,null,Ge(s.value,v=>(A(),L("div",{key:v.name,class:"plugin-item"},[e("div",$p,[e("div",Tp,[e("span",Ip,te(v.display_name||v.name),1),e("span",Pp,"v"+te(v.version||"1.0.0"),1)]),e("p",Rp,te(v.description||"æš‚æ— æè¿°"),1)]),e("div",Dp,[e("label",Mp,[e("input",{type:"checkbox",checked:v.enabled,onChange:p=>_(v)},null,40,Bp),B[0]||(B[0]=e("span",{class:"slider"},null,-1))]),v.has_config?(A(),L("button",{key:0,class:"btn btn-sm",onClick:p=>R(v),title:"é…ç½®"},"âš™ï¸",8,Ap)):ce("",!0),e("button",{class:"btn btn-sm btn-danger",onClick:p=>V(v),title:"åˆ é™¤"},"ğŸ—‘ï¸",8,Ep)])]))),128))]))]),e("div",Lp,[B[3]||(B[3]=e("div",{class:"settings-group-title"},"é»˜è®¤å¯ç”¨çŠ¶æ€",-1)),B[4]||(B[4]=e("p",{class:"settings-hint"},"è®¾ç½®æ’ä»¶åœ¨æ–°ä¼šè¯ä¸­çš„é»˜è®¤å¯ç”¨çŠ¶æ€",-1)),(A(!0),L(ze,null,Ge(s.value,v=>(A(),L("div",{key:"default-"+v.name,class:"default-state-item"},[e("span",Fp,te(v.display_name||v.name),1),e("label",Up,[e("input",{type:"checkbox",checked:o.value[v.name],onChange:p=>S(v.name,p)},null,40,Op),B[2]||(B[2]=e("span",{class:"slider"},null,-1))])]))),128))]),i.value?(A(),L("div",{key:0,class:"plugin-config-modal",onClick:nt(y,["self"])},[e("div",zp,[e("div",Np,[e("h4",null,te(l.value?.display_name||l.value?.name)+" é…ç½®",1),e("span",{class:"close-btn",onClick:y},"Ã—")]),e("div",Vp,[(A(!0),L(ze,null,Ge(m.value,(v,p)=>(A(),L("div",{key:p,class:"config-field"},[e("label",{for:"config-"+p},te(v.label||p)+":",9,Wp),v.type==="boolean"?oe((A(),L("input",{key:0,type:"checkbox",id:"config-"+p,"onUpdate:modelValue":$=>g.value[p]=$},null,8,Kp)),[[Xe,g.value[p]]]):v.type==="select"?(A(),ut(Ve,{key:1,"model-value":String(g.value[p]??""),options:v.options||[],onChange:$=>{g.value[p]=$}},null,8,["model-value","options","onChange"])):v.type==="number"?oe((A(),L("input",{key:2,type:"number",id:"config-"+p,"onUpdate:modelValue":$=>g.value[p]=$,min:v.min,max:v.max},null,8,qp)),[[Pe,g.value[p],void 0,{number:!0}]]):oe((A(),L("input",{key:3,type:"text",id:"config-"+p,"onUpdate:modelValue":$=>g.value[p]=$,placeholder:v.placeholder},null,8,Hp)),[[Pe,g.value[p]]]),v.description?(A(),L("p",jp,te(v.description),1)):ce("",!0)]))),128))]),e("div",{class:"plugin-config-footer"},[e("button",{class:"btn btn-secondary",onClick:y},"å–æ¶ˆ"),e("button",{class:"btn btn-primary",onClick:D},"ä¿å­˜")])])])):ce("",!0)]))}}),Yp=Je(Jp,[["__scopeId","data-v-a62393a7"]]),Gp={class:"parallel-settings"},Xp={class:"settings-group"},Zp={class:"settings-item"},Qp={class:"toggle-switch"},em={class:"number-control"},tm=["disabled"],om=["disabled"],nm=["disabled"],sm={key:0,class:"settings-note"},am=Ye({__name:"ParallelSettings",setup(n){const t=Ee(),s=Y({get:()=>t.settings.parallel.enabled,set:a=>{t.updateSettings({parallel:{...t.settings.parallel,enabled:a}})}}),o=Y({get:()=>t.settings.parallel.deepLearningLockSize,set:a=>{t.updateSettings({parallel:{...t.settings.parallel,deepLearningLockSize:Math.max(1,Math.min(4,a))}})}});return(a,i)=>(A(),L("div",Gp,[e("div",Xp,[i[10]||(i[10]=e("div",{class:"settings-group-title"},"ğŸš€ å¹¶è¡Œç¿»è¯‘",-1)),e("div",Zp,[i[5]||(i[5]=e("label",null,"å¯ç”¨å¹¶è¡Œæ¨¡å¼:",-1)),e("label",Qp,[oe(e("input",{type:"checkbox","onUpdate:modelValue":i[0]||(i[0]=l=>s.value=l)},null,512),[[Xe,s.value]]),i[4]||(i[4]=e("span",{class:"toggle-slider"},null,-1))]),i[6]||(i[6]=e("div",{class:"input-hint"},"ä½¿ç”¨æµæ°´çº¿å¹¶è¡Œå¤„ç†ï¼Œå¯èƒ½æå‡æ‰¹é‡ç¿»è¯‘é€Ÿåº¦",-1))]),e("div",{class:Re(["settings-item",{"item-disabled":!s.value}])},[i[7]||(i[7]=e("label",null,"æ·±åº¦å­¦ä¹ å¹¶å‘æ•°:",-1)),e("div",em,[e("button",{class:"btn btn-sm",onClick:i[1]||(i[1]=l=>o.value=Math.max(1,o.value-1)),disabled:!s.value},"-",8,tm),oe(e("input",{type:"number","onUpdate:modelValue":i[2]||(i[2]=l=>o.value=l),min:"1",max:"4",disabled:!s.value,class:"number-input"},null,8,om),[[Pe,o.value,void 0,{number:!0}]]),e("button",{class:"btn btn-sm",onClick:i[3]||(i[3]=l=>o.value=Math.min(4,o.value+1)),disabled:!s.value},"+",8,nm)]),i[8]||(i[8]=e("div",{class:"input-hint"},"æ§åˆ¶æ£€æµ‹/OCR/é¢œè‰²/ä¿®å¤çš„æœ€å¤§å¹¶å‘æ•°ï¼ˆå»ºè®®1-2ï¼‰",-1))],2),s.value?(A(),L("div",sm,[...i[9]||(i[9]=[e("div",{class:"note-title"},"âš ï¸ æ³¨æ„äº‹é¡¹ï¼š",-1),e("ul",null,[e("li",null,"å¹¶å‘æ•°è®¾ä¸º1æ—¶ä¸ºä¸²è¡Œæ‰§è¡Œï¼Œæœ€ç¨³å®š"),e("li",null,"å¢å¤§å¹¶å‘æ•°å¯èƒ½åŠ é€Ÿå¤„ç†ï¼Œä½†ä¼šå ç”¨æ›´å¤šGPU/CPUèµ„æº"),e("li",null,"å¦‚æœé‡åˆ°æ˜¾å­˜ä¸è¶³ï¼Œè¯·å°†å¹¶å‘æ•°è®¾ä¸º1")],-1)])])):ce("",!0)])]))}}),lm=Je(am,[["__scopeId","data-v-4a6e42d5"]]),im={class:"more-settings"},rm={class:"settings-group"},um={class:"settings-item checkbox-item"},cm={class:"checkbox-label"},dm={class:"settings-group"},gm={class:"settings-item checkbox-item"},pm={class:"checkbox-label"},mm={class:"settings-group"},vm={class:"settings-item checkbox-item"},fm={class:"checkbox-label"},bm={class:"settings-group"},hm={class:"settings-item checkbox-item"},xm={class:"checkbox-label"},ym={class:"settings-group"},Cm={class:"settings-item"},_m={class:"settings-group"},km={class:"settings-item"},Sm=["disabled"],wm={key:0,class:"font-count"},$m={class:"settings-item"},Tm={class:"settings-group"},Im={class:"settings-row"},Pm={class:"settings-item"},Rm=["disabled"],Dm={class:"settings-item"},Mm=["disabled"],Bm=Ye({__name:"MoreSettings",setup(n){const t=[{label:"å‰ç«¯ pdf.js (æ¨è)",value:"frontend"},{label:"åç«¯ PyMuPDF",value:"backend"}],s=Ee(),o=ct(),a=w(!1),i=w([]),l=w(!1),m=w(null),g=w({pdfProcessingMethod:s.settings.pdfProcessingMethod||"frontend",autoSaveInBookshelfMode:s.settings.autoSaveInBookshelfMode||!1,removeTextWithOcr:s.settings.removeTextWithOcr||!1,enableVerboseLogs:s.settings.enableVerboseLogs||!1,lamaDisableResize:s.settings.lamaDisableResize||!1});Se(()=>g.value.pdfProcessingMethod,R=>{s.setPdfProcessingMethod(R)}),Se(()=>g.value.autoSaveInBookshelfMode,R=>{s.setAutoSaveInBookshelfMode(R)}),Se(()=>g.value.removeTextWithOcr,R=>{s.setRemoveTextWithOcr(R)}),Se(()=>g.value.enableVerboseLogs,R=>{s.setEnableVerboseLogs(R)}),Se(()=>g.value.lamaDisableResize,R=>{s.setLamaDisableResize(R)});async function u(){a.value=!0;try{const R=await He.getFontList();i.value=R.fonts||[],o.success(`è·å–åˆ° ${i.value.length} ä¸ªå­—ä½“`)}catch(R){const y=R instanceof Error?R.message:"è·å–å­—ä½“åˆ—è¡¨å¤±è´¥";o.error(y)}finally{a.value=!1}}async function b(R){const D=R.target.files?.[0];if(!D)return;const V=[".ttf",".ttc",".otf"],M=D.name.toLowerCase().slice(D.name.lastIndexOf("."));if(!V.includes(M)){o.error("ä¸æ”¯æŒçš„å­—ä½“æ ¼å¼ï¼Œè¯·ä¸Šä¼  .ttf, .ttc æˆ– .otf æ–‡ä»¶");return}try{const B=await He.uploadFont(D);B.success?(o.success(`å­—ä½“ "${B.fontPath||D.name}" ä¸Šä¼ æˆåŠŸ`),await u()):o.error(B.error||"å­—ä½“ä¸Šä¼ å¤±è´¥")}catch(B){const v=B instanceof Error?B.message:"å­—ä½“ä¸Šä¼ å¤±è´¥";o.error(v)}finally{m.value&&(m.value.value="")}}async function _(){l.value=!0;try{const R=await Dn();R.success?o.success(`å·²æ¸…ç† ${R.deleted_count||0} ä¸ªè°ƒè¯•æ–‡ä»¶`):o.error(R.error||"æ¸…ç†å¤±è´¥")}catch(R){const y=R instanceof Error?R.message:"æ¸…ç†å¤±è´¥";o.error(y)}finally{l.value=!1}}async function S(){l.value=!0;try{const R=await wo();R.success?o.success(`å·²æ¸…ç† ${R.deleted_count||0} ä¸ªä¸´æ—¶æ–‡ä»¶`):o.error(R.error||"æ¸…ç†å¤±è´¥")}catch(R){const y=R instanceof Error?R.message:"æ¸…ç†å¤±è´¥";o.error(y)}finally{l.value=!1}}return(R,y)=>(A(),L("div",im,[ke(lm),e("div",rm,[y[7]||(y[7]=e("div",{class:"settings-group-title"},"è‡ªåŠ¨ä¿å­˜è®¾ç½®",-1)),e("div",um,[e("label",cm,[oe(e("input",{type:"checkbox","onUpdate:modelValue":y[0]||(y[0]=D=>g.value.autoSaveInBookshelfMode=D)},null,512),[[Xe,g.value.autoSaveInBookshelfMode]]),y[5]||(y[5]=e("span",{class:"checkbox-text"},"ä¹¦æ¶æ¨¡å¼è‡ªåŠ¨ä¿å­˜",-1))]),y[6]||(y[6]=e("div",{class:"input-hint"},[de(" å¼€å¯åï¼Œåœ¨ä¹¦æ¶æ¨¡å¼ä¸‹ç¿»è¯‘æ—¶ä¼šè‡ªåŠ¨ä¿å­˜è¿›åº¦ï¼ˆç¿»è¯‘ä¸€å¼ ä¿å­˜ä¸€å¼ ï¼‰ï¼Œé˜²æ­¢æ„å¤–å…³é—­å¯¼è‡´æ•°æ®ä¸¢å¤±ã€‚ "),e("br"),e("span",{class:"hint-note"},"æ³¨æ„ï¼šæ­¤åŠŸèƒ½ä»…åœ¨ä¹¦æ¶æ¨¡å¼ä¸‹ç”Ÿæ•ˆï¼Œå¿«é€Ÿç¿»è¯‘æ¨¡å¼ä¸æ”¯æŒã€‚")],-1))])]),e("div",dm,[y[10]||(y[10]=e("div",{class:"settings-group-title"},"æ¶ˆé™¤æ–‡å­—æ¨¡å¼",-1)),e("div",gm,[e("label",pm,[oe(e("input",{type:"checkbox","onUpdate:modelValue":y[1]||(y[1]=D=>g.value.removeTextWithOcr=D)},null,512),[[Xe,g.value.removeTextWithOcr]]),y[8]||(y[8]=e("span",{class:"checkbox-text"},"åŒæ—¶æ‰§è¡ŒOCRè¯†åˆ«",-1))]),y[9]||(y[9]=e("div",{class:"input-hint"},[de(" å¼€å¯åï¼Œæ¶ˆé™¤æ–‡å­—æ¨¡å¼ä¼šåŒæ—¶æ‰§è¡ŒOCRè¯†åˆ«ï¼Œè·å–å¸¦æœ‰åŸæ–‡çš„å¹²å‡€èƒŒæ™¯å›¾ã€‚ "),e("br"),e("span",{class:"hint-note"},"é€‚ç”¨äºéœ€è¦ä¿ç•™åŸæ–‡ä¿¡æ¯ä»¥ä¾¿åç»­ç¿»è¯‘æˆ–å‚è€ƒçš„åœºæ™¯ã€‚")],-1))])]),e("div",mm,[y[13]||(y[13]=e("div",{class:"settings-group-title"},"LAMA ä¿®å¤è®¾ç½®",-1)),e("div",vm,[e("label",fm,[oe(e("input",{type:"checkbox","onUpdate:modelValue":y[2]||(y[2]=D=>g.value.lamaDisableResize=D)},null,512),[[Xe,g.value.lamaDisableResize]]),y[11]||(y[11]=e("span",{class:"checkbox-text"},"ç¦ç”¨è‡ªåŠ¨ç¼©æ”¾",-1))]),y[12]||(y[12]=e("div",{class:"input-hint"},[de(" å¼€å¯åï¼ŒLAMA ä¿®å¤å°†ä½¿ç”¨åŸå›¾å°ºå¯¸è¿›è¡Œå¤„ç†ï¼ˆä¸ç¼©æ”¾åˆ°1024pxï¼‰ï¼Œå¯è·å¾—æ›´é«˜ç”»è´¨ã€‚ "),e("br"),e("span",{class:"hint-note"},"âš ï¸ éœ€è¦æ›´å¼ºçš„ GPU å’Œæ›´å¤šæ˜¾å­˜ï¼Œå¤„ç†é€Ÿåº¦ä¼šå˜æ…¢ã€‚æ¨è RTX 4060 æˆ–æ›´é«˜é…ç½®ä½¿ç”¨ã€‚"),e("br"),e("span",{class:"hint-note"},"é€‚ç”¨äºä¸¤ç§LAMAä¿®å¤æ–¹æ³•ï¼ˆé€Ÿåº¦ä¼˜åŒ–å’Œé€šç”¨ï¼‰ã€‚")],-1))])]),e("div",bm,[y[16]||(y[16]=e("div",{class:"settings-group-title"},"è°ƒè¯•é€‰é¡¹",-1)),e("div",hm,[e("label",xm,[oe(e("input",{type:"checkbox","onUpdate:modelValue":y[3]||(y[3]=D=>g.value.enableVerboseLogs=D)},null,512),[[Xe,g.value.enableVerboseLogs]]),y[14]||(y[14]=e("span",{class:"checkbox-text"},"è¯¦ç»†æ—¥å¿—",-1))]),y[15]||(y[15]=e("div",{class:"input-hint"},[de(" å¼€å¯åï¼Œåç«¯ç»ˆç«¯ä¼šæ‰“å°è¯¦ç»†çš„è¯Šæ–­æ—¥å¿—ï¼ˆåŒ…æ‹¬å®Œæ•´çš„æ¶ˆæ¯ç»“æ„ã€æ¨¡å‹å“åº”ç­‰ï¼‰ï¼Œä¾¿äºè°ƒè¯•é—®é¢˜ã€‚ "),e("br"),e("span",{class:"hint-note"},"å½±å“æ‰€æœ‰ç¿»è¯‘æ¨¡å¼ï¼Œé»˜è®¤å…³é—­ä»¥ä¿æŒæ—¥å¿—ç®€æ´ã€‚")],-1))])]),e("div",ym,[y[19]||(y[19]=e("div",{class:"settings-group-title"},"PDFå¤„ç†è®¾ç½®",-1)),e("div",Cm,[y[17]||(y[17]=e("label",{for:"settingsPdfProcessingMethod"},"PDFå¤„ç†æ–¹å¼:",-1)),ke(Ve,{modelValue:g.value.pdfProcessingMethod,"onUpdate:modelValue":y[4]||(y[4]=D=>g.value.pdfProcessingMethod=D),options:t},null,8,["modelValue"]),y[18]||(y[18]=e("div",{class:"input-hint"},"å‰ç«¯å¤„ç†é€Ÿåº¦æ›´å¿«ï¼Œåç«¯å¤„ç†å…¼å®¹æ€§æ›´å¥½",-1))])]),e("div",_m,[y[23]||(y[23]=e("div",{class:"settings-group-title"},"å­—ä½“è®¾ç½®",-1)),e("div",km,[y[20]||(y[20]=e("label",null,"ç³»ç»Ÿå­—ä½“åˆ—è¡¨:",-1)),e("button",{class:"btn btn-secondary",onClick:u,disabled:a.value},te(a.value?"åŠ è½½ä¸­...":"ğŸ”„ åˆ·æ–°å­—ä½“åˆ—è¡¨"),9,Sm),i.value.length>0?(A(),L("div",wm,"å…± "+te(i.value.length)+" ä¸ªå­—ä½“",1)):ce("",!0)]),e("div",$m,[y[21]||(y[21]=e("label",null,"ä¸Šä¼ è‡ªå®šä¹‰å­—ä½“:",-1)),e("input",{type:"file",accept:".ttf,.ttc,.otf",onChange:b,ref_key:"fontInput",ref:m},null,544),y[22]||(y[22]=e("div",{class:"input-hint"},"æ”¯æŒ .ttf, .ttc, .otf æ ¼å¼",-1))])]),e("div",Tm,[y[26]||(y[26]=e("div",{class:"settings-group-title"},"ç¼“å­˜æ¸…ç†",-1)),e("div",Im,[e("div",Pm,[e("button",{class:"btn btn-secondary",onClick:_,disabled:l.value},te(l.value?"æ¸…ç†ä¸­...":"ğŸ—‘ï¸ æ¸…ç†è°ƒè¯•æ–‡ä»¶"),9,Rm),y[24]||(y[24]=e("div",{class:"input-hint"},"æ¸…ç†è°ƒè¯•è¿‡ç¨‹ä¸­ç”Ÿæˆçš„ä¸´æ—¶æ–‡ä»¶",-1))]),e("div",Dm,[e("button",{class:"btn btn-secondary",onClick:S,disabled:l.value},te(l.value?"æ¸…ç†ä¸­...":"ğŸ—‘ï¸ æ¸…ç†ä¸´æ—¶æ–‡ä»¶"),9,Mm),y[25]||(y[25]=e("div",{class:"input-hint"},"æ¸…ç†ä¸‹è½½å’Œå¤„ç†è¿‡ç¨‹ä¸­çš„ä¸´æ—¶æ–‡ä»¶",-1))])])]),y[27]||(y[27]=ho('<div class="settings-group" data-v-06334835><div class="settings-group-title" data-v-06334835>å…³äº</div><div class="about-info" data-v-06334835><p data-v-06334835><strong data-v-06334835>Saber-Translator</strong></p><p data-v-06334835>AIé©±åŠ¨çš„æ¼«ç”»ç¿»è¯‘å·¥å…·</p><p class="links" data-v-06334835><a href="http://www.mashirosaber.top" target="_blank" data-v-06334835>ğŸ“– ä½¿ç”¨æ•™ç¨‹</a><a href="https://github.com/MashiroSaber/saber-translator" target="_blank" data-v-06334835>ğŸ™ GitHub</a></p><p class="disclaimer" data-v-06334835>æœ¬é¡¹ç›®å®Œå…¨å¼€æºå…è´¹ï¼Œè¯·å‹¿ä¸Šå½“å—éª—</p></div></div>',1))]))}}),Am=Je(Bm,[["__scopeId","data-v-06334835"]]),Em={class:"settings-modal-content"},Lm={class:"settings-tabs"},Fm=["onClick"],Um={class:"settings-tab-content"},Om={class:"settings-tab-pane active"},zm={class:"settings-tab-pane"},Nm={class:"settings-tab-pane"},Vm={class:"settings-tab-pane"},Wm={class:"settings-tab-pane"},Km={class:"settings-tab-pane"},qm={class:"settings-tab-pane"},Hm={class:"settings-tab-pane"},jm=Ye({__name:"SettingsModal",props:{modelValue:{type:Boolean},initialTab:{}},emits:["update:modelValue","save"],setup(n,{emit:t}){const s=n,o=t,a=Ee(),i=w(s.modelValue),l=w("ocr"),m=[{id:"ocr",label:"OCRè¯†åˆ«"},{id:"translate",label:"ç¿»è¯‘æœåŠ¡"},{id:"detection",label:"æ£€æµ‹è®¾ç½®"},{id:"hq",label:"é«˜è´¨é‡ç¿»è¯‘"},{id:"proofreading",label:"AIæ ¡å¯¹"},{id:"prompt-library",label:"æç¤ºè¯ç®¡ç†"},{id:"plugins",label:"æ’ä»¶ç®¡ç†"},{id:"more",label:"æ›´å¤š"}];Se(()=>s.modelValue,_=>{i.value=_,_?(document.body.style.overflow="hidden",s.initialTab&&m.some(S=>S.id===s.initialTab)&&(l.value=s.initialTab)):(document.body.style.overflow="",l.value="ocr")});function g(){i.value=!1,o("update:modelValue",!1),document.body.style.overflow=""}async function u(){a.saveToStorage();try{await a.saveToBackend(),console.log("[SettingsModal] è®¾ç½®å·²ä¿å­˜åˆ°åç«¯")}catch(_){console.warn("[SettingsModal] ä¿å­˜åˆ°åç«¯å¤±è´¥ï¼Œä»…ä¿å­˜åˆ° localStorage:",_)}o("save"),g()}function b(_){_.key==="Escape"&&i.value&&g()}return dt(()=>{document.addEventListener("keydown",b)}),Wt(()=>{document.removeEventListener("keydown",b),document.body.style.overflow=""}),(_,S)=>i.value?(A(),L("div",{key:0,class:"settings-modal",onClick:nt(g,["self"])},[e("div",Em,[e("div",{class:"settings-modal-header"},[S[0]||(S[0]=e("h3",null,"âš™ï¸ è®¾ç½®",-1)),e("span",{class:"settings-modal-close",onClick:g},"Ã—")]),e("div",Lm,[(A(),L(ze,null,Ge(m,R=>e("button",{key:R.id,class:Re(["settings-tab",{active:l.value===R.id}]),onClick:y=>l.value=R.id},te(R.label),11,Fm)),64))]),e("div",Um,[oe(e("div",Om,[ke(tc)],512),[[Oe,l.value==="ocr"]]),oe(e("div",zm,[ke(jc)],512),[[Oe,l.value==="translate"]]),oe(e("div",Nm,[ke(pd)],512),[[Oe,l.value==="detection"]]),oe(e("div",Vm,[ke(Zd)],512),[[Oe,l.value==="hq"]]),oe(e("div",Wm,[ke(Qg)],512),[[Oe,l.value==="proofreading"]]),oe(e("div",Km,[ke(yp)],512),[[Oe,l.value==="prompt-library"]]),oe(e("div",qm,[ke(Yp)],512),[[Oe,l.value==="plugins"]]),oe(e("div",Hm,[ke(Am)],512),[[Oe,l.value==="more"]])]),e("div",{class:"settings-modal-footer"},[e("button",{class:"btn btn-secondary",onClick:g},"å–æ¶ˆ"),e("button",{class:"btn btn-primary",onClick:u},"ä¿å­˜è®¾ç½®")])])])):ce("",!0)}}),Jm=Je(jm,[["__scopeId","data-v-e1ec20ab"]]),Ym={minScale:.1,maxScale:5,zoomSpeed:.1};function kn(n={}){const t={...Ym,...n},s=w(1),o=w(0),a=w(0),i=w(!1),l=w(0),m=w(0),g=Y(()=>({transform:`translate(${o.value}px, ${a.value}px) scale(${s.value})`}));function u(J,se,O){const Q=Math.min(Math.max(s.value*O,t.minScale),t.maxScale),ae=Q/s.value;o.value=J-(J-o.value)*ae,a.value=se-(se-a.value)*ae,s.value=Q,n.onScaleChange?.(s.value),n.onTransformChange?.(k())}function b(J,se=800,O=600){u(se/2,O/2,J)}function _(){b(1.2)}function S(){b(.8)}function R(J,se=800,O=600){const Q=J/s.value;u(se/2,O/2,Q)}function y(J,se){i.value=!0,l.value=J,m.value=se}function D(J,se){if(!i.value)return;const O=J-l.value,Q=se-m.value;o.value+=O,a.value+=Q,l.value=J,m.value=se,n.onTransformChange?.(k())}function V(){i.value=!1}function M(J,se){o.value+=J,a.value+=se,n.onTransformChange?.(k())}function B(){s.value=1,o.value=0,a.value=0,n.onScaleChange?.(s.value),n.onTransformChange?.(k())}function v(){B()}function p(){s.value=1,o.value=0,a.value=0}function $(J,se,O,Q){if(!J||!se)return;const ae=O/J,U=Q/se;s.value=Math.min(ae,U)*.95,o.value=(O-J*s.value)/2,a.value=(Q-se*s.value)/2,n.onScaleChange?.(s.value),n.onTransformChange?.(k())}function k(){return{scale:s.value,translateX:o.value,translateY:a.value}}function F(J){J.scale!==void 0&&(s.value=J.scale),J.translateX!==void 0&&(o.value=J.translateX),J.translateY!==void 0&&(a.value=J.translateY),n.onTransformChange?.(k())}function z(J){s.value=J.scale,o.value=J.translateX,a.value=J.translateY}function ee(J,se,O){if(!J||J.length<4)return;const[Q,ae,U,r]=J,d=(Q+U)/2,f=(ae+r)/2,C=se/2,x=O/2;o.value=C-d*s.value,a.value=x-f*s.value,n.onTransformChange?.(k())}return{scale:s,translateX:o,translateY:a,isDragging:i,transformStyle:g,zoomAt:u,zoom:b,zoomIn:_,zoomOut:S,setScale:R,startDrag:y,drag:D,endDrag:V,pan:M,reset:B,resetZoom:v,resetTransform:p,fitToScreen:$,getTransform:k,setTransform:F,syncWith:z,scrollToBubble:ee}}function Jn(n,t){const s=document.createElement("canvas");s.width=n,s.height=t;const o=s.getContext("2d");return o.fillStyle="rgb(127, 127, 127)",o.fillRect(0,0,n,t),s.toDataURL("image/png").split(",")[1]||""}async function Sn(n,t,s,o,a){return n||(n=Jn(t,s)),new Promise((i,l)=>{const m=document.createElement("canvas");m.width=t,m.height=s;const g=m.getContext("2d"),u=new Image;u.onload=()=>{g.drawImage(u,0,0,t,s),g.fillStyle="white";for(const S of o)g.beginPath(),g.arc(S.x,S.y,a,0,Math.PI*2),g.fill();const _=m.toDataURL("image/png").split(",")[1]||"";i(_)},u.onerror=l,u.src="data:image/png;base64,"+n})}async function Gm(n,t,s,o,a){return n||(n=Jn(t,s)),new Promise((i,l)=>{const m=document.createElement("canvas");m.width=t,m.height=s;const g=m.getContext("2d"),u=new Image;u.onload=()=>{g.drawImage(u,0,0,t,s),g.fillStyle="black";for(const S of o)g.beginPath(),g.arc(S.x,S.y,a,0,Math.PI*2),g.fill();const _=m.toDataURL("image/png").split(",")[1]||"";i(_)},u.onerror=l,u.src="data:image/png;base64,"+n})}function Xm(n){const t=Ze(),s=Ee(),o=w(null),a=w($s),i=w(!1),l=w(!1),m=w([]),g=w(0),u=w(0);let b=null,_=null,S=null;const R=Y(()=>o.value!==null),y=Y(()=>o.value==="repair"?{fill:"rgba(76, 175, 80, 0.4)",border:"#4CAF50"}:o.value==="restore"?{fill:"rgba(33, 150, 243, 0.4)",border:"#2196F3"}:{fill:"transparent",border:"transparent"});function D(f){o.value!==f&&(o.value=f,i.value=!0,m.value=[],console.log(`è¿›å…¥${f==="repair"?"ä¿®å¤":"è¿˜åŸ"}ç¬”åˆ·æ¨¡å¼ï¼Œç¬”åˆ·å¤§å°: ${a.value}px`))}function V(){l.value&&F();const f=o.value!==null;o.value=null,i.value=!1,l.value=!1,m.value=[],se(),f&&console.log("é€€å‡ºç¬”åˆ·æ¨¡å¼")}function M(f){o.value===f?V():D(f)}function B(f){a.value=Math.max(sn,Math.min(nn,f))}function v(f){B(a.value+f)}function p(f){if(!R.value)return;f.preventDefault(),f.stopPropagation();const C=f.deltaY>0?-5:5;v(C)}function $(f,C){if(!R.value||f.button!==0)return;f.preventDefault(),f.stopPropagation(),l.value=!0,b=C,m.value=[];const x=z(f,C);x&&(m.value.push(x),J(C),O(x)),console.log("å¼€å§‹ç¬”åˆ·æ¶‚æŠ¹")}function k(f){if(g.value=f.clientX,u.value=f.clientY,!l.value||!R.value)return;const C=z(f,b);C&&(m.value.push(C),O(C))}function F(){if(!l.value)return;l.value=!1;const f=t.currentImage;if(!f||m.value.length===0){se(),m.value=[];return}const C=ee();if(!C){se(),m.value=[];return}const x=o.value;(async()=>{x==="restore"?await Q(f,C):x==="repair"&&await ae(f,C),n?.onBrushComplete?.()})(),se(),m.value=[]}function z(f,C){if(!C)return null;const x=C.querySelector(".image-canvas-wrapper"),P=x?.querySelector("img");if(!P||!P.naturalWidth)return null;const I=x.getBoundingClientRect(),E=window.getComputedStyle(x).transform;let K=1;E&&E!=="none"&&(K=new DOMMatrix(E).a);const G=(f.clientX-I.left)/K,c=(f.clientY-I.top)/K,h=P.naturalWidth,le=P.naturalHeight;return G<0||c<0||G>h||c>le?null:{x:G,y:c,scale:K}}function ee(){if(m.value.length===0)return null;const C=m.value[0]?.scale||1,x=a.value/2/C;let P=1/0,I=1/0,E=-1/0,K=-1/0;for(const G of m.value)P=Math.min(P,G.x-x),I=Math.min(I,G.y-x),E=Math.max(E,G.x+x),K=Math.max(K,G.y+x);return{x1:Math.max(0,Math.floor(P)),y1:Math.max(0,Math.floor(I)),x2:Math.ceil(E),y2:Math.ceil(K),path:[...m.value],radius:x}}function J(f){se();const C=f.querySelector(".image-canvas-wrapper"),x=C?.querySelector("img");if(!x)return;const P=document.createElement("canvas");P.id="brushOverlayCanvas",P.width=x.naturalWidth,P.height=x.naturalHeight,P.style.cssText="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100;",C.appendChild(P),_=P,S=P.getContext("2d")}function se(){_&&_.parentNode&&_.parentNode.removeChild(_),_=null,S=null}function O(f){if(!S||!f)return;const C=y.value.fill,x=a.value/2/(f.scale||1);S.beginPath(),S.arc(f.x,f.y,x,0,Math.PI*2),S.fillStyle=C,S.fill()}async function Q(f,C){if(!f.originalDataURL)return;let x;return f.cleanImageData?x="data:image/png;base64,"+f.cleanImageData:x=f.originalDataURL,new Promise(P=>{const I=new Image,E=new Image;let K=0;const G=async()=>{if(K++,K<2)return;const c=document.createElement("canvas");c.width=I.naturalWidth,c.height=I.naturalHeight;const h=c.getContext("2d");if(!h){P();return}h.drawImage(I,0,0);const le=document.createElement("canvas");le.width=c.width,le.height=c.height;const N=le.getContext("2d");if(!N){P();return}N.fillStyle="white";for(const ye of C.path)N.beginPath(),N.arc(ye.x,ye.y,C.radius,0,Math.PI*2),N.fill();h.globalCompositeOperation="destination-out",h.drawImage(le,0,0),h.globalCompositeOperation="destination-over",h.drawImage(E,0,0),h.globalCompositeOperation="source-over";const X=await Gm(f.userMask,c.width,c.height,C.path,C.radius),pe=c.toDataURL("image/png").split(",")[1];t.updateCurrentImage({cleanImageData:pe,userMask:X}),console.log("è¿˜åŸç¬”åˆ·åŒºåŸŸå®Œæˆï¼ŒuserMask å·²æ›´æ–°"),P()};I.onload=G,I.onerror=()=>P(),E.onload=G,E.onerror=()=>P(),I.src=x,E.src=f.originalDataURL})}async function ae(f,C){const x=n?.getCurrentRepairSettings?.()||{inpaintMethod:"solid",fillColor:"#FFFFFF"},P=x.inpaintMethod;P==="lama_mpe"||P==="litelama"?await U(f,C,P):await r(f,C,x.fillColor)}async function U(f,C,x="lama_mpe"){let P,I;if(f.cleanImageData)P=f.cleanImageData,I="data:image/png;base64,"+f.cleanImageData;else if(f.originalDataURL)P=f.originalDataURL.split(",")[1],I=f.originalDataURL;else{console.error("æ— æ³•è·å–åŸºç¡€å›¾åƒç”¨äº LAMA ä¿®å¤");return}return new Promise(E=>{const K=new Image;K.onload=async()=>{const G=K.naturalWidth,c=K.naturalHeight,h=document.createElement("canvas");h.width=G,h.height=c;const le=h.getContext("2d");if(!le){console.error("æ— æ³•åˆ›å»ºæ©è†œç”»å¸ƒä¸Šä¸‹æ–‡"),E();return}le.fillStyle="black",le.fillRect(0,0,G,c),le.fillStyle="white";for(const _e of C.path)le.beginPath(),le.arc(_e.x,_e.y,C.radius,0,Math.PI*2),le.fill();const X=h.toDataURL("image/png").split(",")[1],pe=[C.x1,C.y1,C.x2,C.y2],ye=x==="litelama"?"litelama":"lama_mpe";try{Ce("LAMA ä¿®å¤ä¸­...","info");const _e=await To(P,pe,{method:"lama",lamaModel:ye,maskData:X});if(_e.success&&_e.inpainted_image){const $e=await Sn(f.userMask,G,c,C.path,C.radius);t.updateCurrentImage({cleanImageData:_e.inpainted_image,userMask:$e}),console.log("ä¿®å¤ç¬”åˆ·åŒºåŸŸå®Œæˆï¼ˆLAMA ä¿®å¤ï¼Œç²¾ç¡®æ©è†œï¼‰ï¼ŒuserMask å·²æ›´æ–°"),Ce("LAMA ä¿®å¤å®Œæˆ","success")}else throw new Error(_e.error||"LAMA ä¿®å¤è¿”å›æ— æ•ˆæ•°æ®")}catch(_e){console.error("LAMA ä¿®å¤å¤±è´¥ï¼Œå›é€€åˆ°çº¯è‰²å¡«å……:",_e),Ce("LAMA ä¿®å¤å¤±è´¥ï¼Œä½¿ç”¨çº¯è‰²å¡«å……","warning");const $e=n?.getCurrentRepairSettings?.();await r(f,C,$e?.fillColor)}E()},K.onerror=()=>{console.error("åŠ è½½å›¾åƒå¤±è´¥ï¼Œæ— æ³•è¿›è¡Œ LAMA ä¿®å¤"),E()},K.src=I})}async function r(f,C,x){const P=x||s.settings.textStyle.fillColor||"#FFFFFF";let I;if(f.cleanImageData)I="data:image/png;base64,"+f.cleanImageData;else if(f.originalDataURL)I=f.originalDataURL;else return;return new Promise(E=>{const K=new Image;K.onload=async()=>{const G=document.createElement("canvas");G.width=K.naturalWidth,G.height=K.naturalHeight;const c=G.getContext("2d");if(!c){E();return}c.drawImage(K,0,0),c.fillStyle=P;for(const N of C.path)c.beginPath(),c.arc(N.x,N.y,C.radius,0,Math.PI*2),c.fill();const h=await Sn(f.userMask,K.naturalWidth,K.naturalHeight,C.path,C.radius),le=G.toDataURL("image/png").split(",")[1];t.updateCurrentImage({cleanImageData:le,userMask:h}),console.log("ä¿®å¤ç¬”åˆ·åŒºåŸŸå®Œæˆï¼ˆçº¯è‰²å¡«å……ï¼‰ï¼ŒuserMask å·²æ›´æ–°"),E()},K.onerror=()=>E(),K.src=I})}async function d(){const f=t.currentImage;if(!f)return console.warn("ensureCleanBackground: æ²¡æœ‰å½“å‰å›¾ç‰‡"),!1;if(f.cleanImageData)return console.log("ensureCleanBackground: å·²æœ‰å¹²å‡€èƒŒæ™¯"),!0;const C=n?.getCurrentRepairSettings?.();if((C?.inpaintMethod||s.settings.textStyle.inpaintMethod)!=="solid")return console.log("ensureCleanBackground: éçº¯è‰²å¡«å……æ¨¡å¼ï¼Œè·³è¿‡"),!1;if(!f.bubbleStates||f.bubbleStates.length===0)return console.warn("ensureCleanBackground: æ²¡æœ‰æ°”æ³¡æ•°æ®"),!1;if(!f.translatedDataURL&&!f.originalDataURL)return console.warn("ensureCleanBackground: æ²¡æœ‰å›¾ç‰‡æ•°æ®"),!1;console.log("ensureCleanBackground: å°è¯•ä¸ºçº¯è‰²å¡«å……æ¨¡å¼åˆ›å»ºä¸´æ—¶å¹²å‡€èƒŒæ™¯");const P=f.translatedDataURL||f.originalDataURL,I=C?.fillColor||s.settings.textStyle.fillColor||"#FFFFFF";return new Promise(E=>{const K=new Image;K.onload=()=>{try{const G=document.createElement("canvas");G.width=K.naturalWidth,G.height=K.naturalHeight;const c=G.getContext("2d");if(!c){console.error("ensureCleanBackground: æ— æ³•è·å– Canvas ä¸Šä¸‹æ–‡"),E(!1);return}c.drawImage(K,0,0),c.fillStyle=I;for(const le of f.bubbleStates){const[N,X,pe,ye]=le.coords;c.fillRect(N,X,pe-N+1,ye-X+1)}const h=G.toDataURL("image/png").split(",")[1];t.updateCurrentImage({cleanImageData:h}),console.log("ensureCleanBackground: æˆåŠŸåˆ›å»ºä¸´æ—¶å¹²å‡€èƒŒæ™¯ï¼ˆçº¯è‰²å¡«å……ï¼‰"),E(!0)}catch(G){console.error("ensureCleanBackground: Canvas æ“ä½œå¤±è´¥:",G),E(!1)}},K.onerror=()=>{console.error("ensureCleanBackground: åŠ è½½å›¾åƒå¤±è´¥"),E(!1)},K.src=P})}return Wt(()=>{V()}),{brushMode:o,brushSize:a,isBrushKeyDown:i,isBrushPainting:l,mouseX:g,mouseY:u,isActive:R,brushColor:y,BRUSH_MIN_SIZE:sn,BRUSH_MAX_SIZE:nn,enterBrushMode:D,exitBrushMode:V,toggleBrushMode:M,setBrushSize:B,adjustBrushSize:v,handleBrushWheel:p,startBrushPainting:$,continueBrushPainting:k,finishBrushPainting:F,getBrushPositionInImage:z,getBrushPathBounds:ee,ensureCleanBackground:d}}function Zm(n){return[Math.round(n[0]),Math.round(n[1]),Math.round(n[2]),Math.round(n[3])]}function Qm(n){const t=gt(),s=Ze(),o=Ee(),{bubbles:a,selectedIndex:i,hasSelection:l}=yt(t),{currentImage:m}=yt(s),g=w(!1),u=w(!1),b=w(null),_=w(0),S=w(0),R=w(!1);function y(c){t.selectBubble(c)}function D(c){t.toggleMultiSelect(c)}function V(){t.clearMultiSelect()}function M(c,h){console.log(`å¼€å§‹æ‹–åŠ¨æ°”æ³¡ #${c+1}`)}function B(c,h){}function v(c,h){t.updateBubble(c,{coords:h}),console.log(`æ°”æ³¡ #${c+1} æ‹–åŠ¨å®Œæˆ:`,h),x()}function p(c,h,le){console.log(`å¼€å§‹è°ƒæ•´æ°”æ³¡ #${c+1} å¤§å°ï¼Œæ‰‹æŸ„: ${h}`)}function $(c){}function k(c,h){t.updateBubble(c,{coords:h}),console.log(`æ°”æ³¡ #${c+1} è°ƒæ•´å¤§å°å®Œæˆ:`,h),x()}function F(c,h){console.log(`å¼€å§‹æ—‹è½¬æ°”æ³¡ #${c+1}`)}function z(c){}function ee(c,h){t.updateBubble(c,{rotationAngle:h}),console.log(`æ°”æ³¡ #${c+1} æ—‹è½¬å®Œæˆ: ${h}Â°`),x()}function J(){g.value=!g.value,g.value?console.log("è¿›å…¥ç»˜åˆ¶æ¨¡å¼"):console.log("é€€å‡ºç»˜åˆ¶æ¨¡å¼")}function se(c){t.addBubble(c),t.selectBubble(t.bubbleCount-1),console.log("å·²æ·»åŠ æ–°æ°”æ³¡:",c),n?.onReRender?.()}function O(c,h){u.value=!0,_.value=c,S.value=h,b.value=[c,h,c,h]}function Q(c,h){u.value&&(b.value=[_.value,S.value,c,h])}function ae(){if(!u.value||!b.value)return u.value=!1,b.value=null,null;const[c,h,le,N]=b.value,X=10;if(Math.abs(le-c)<X||Math.abs(N-h)<X)return u.value=!1,b.value=null,null;const pe=[Math.min(c,le),Math.min(h,N),Math.max(c,le),Math.max(h,N)];return u.value=!1,b.value=null,pe}function U(){u.value=!1,b.value=null,g.value=!1}function r(){if(!b.value)return{};const[c,h,le,N]=b.value;return{position:"absolute",left:`${Math.min(c,le)}px`,top:`${Math.min(h,N)}px`,width:`${Math.abs(le-c)}px`,height:`${Math.abs(N-h)}px`,border:"2px dashed #00d4ff",background:"rgba(0, 212, 255, 0.1)",pointerEvents:"none",zIndex:"25",boxSizing:"border-box"}}let d=null,f=!1;const C=150;function x(){d&&clearTimeout(d),d=setTimeout(async()=>{if(f){console.log("è·³è¿‡æ¸²æŸ“ï¼Œä¸Šä¸€æ¬¡æ¸²æŸ“ä»åœ¨è¿›è¡Œä¸­");return}console.log("è§¦å‘å»¶è¿Ÿæ¸²æŸ“é¢„è§ˆ"),f=!0;try{n?.onDelayedPreview?await n.onDelayedPreview():n?.onReRender&&await n.onReRender()}catch(c){console.error("å»¶è¿Ÿæ¸²æŸ“é¢„è§ˆå¤±è´¥:",c)}finally{f=!1}},C)}function P(c){t.updateSelectedBubble(c),x()}function I(){l.value&&(t.deleteSelected(),console.log("å·²åˆ é™¤é€‰ä¸­çš„æ°”æ³¡"),n?.onReRender?.())}async function E(){const c=i.value;if(c<0){console.warn("è¯·å…ˆé€‰ä¸­è¦ä¿®å¤çš„æ°”æ³¡æ¡†");return}const h=a.value[c],le=m.value;if(!h||!le?.originalDataURL){console.warn("æ— æ³•ä¿®å¤èƒŒæ™¯ï¼šç¼ºå°‘æ°”æ³¡æˆ–å›¾ç‰‡æ•°æ®");return}const N=h.inpaintMethod||"solid",X=h.fillColor||"#FFFFFF",pe=h.rotationAngle||0;try{console.log(`å¼€å§‹ä¿®å¤æ°”æ³¡ #${c+1} èƒŒæ™¯ï¼Œæ–¹æ³•: ${N}`);let ye;if(le.cleanImageData)ye=le.cleanImageData;else{const $e=le.originalDataURL.match(/^data:image\/[^;]+;base64,(.+)$/);if(ye=$e&&$e[1]?$e[1]:"",!ye){console.error("æ— æ³•è§£æå›¾åƒæ•°æ®");return}}if(N==="lama_mpe"||N==="litelama"){const $e=N==="litelama"?"litelama":"lama_mpe",De=Zm(h.coords),re=await To(ye,De,{bubbleAngle:pe,method:"lama",lamaModel:$e});re.success&&re.inpainted_image?(s.updateCurrentImage({cleanImageData:re.inpainted_image}),console.log(`æ°”æ³¡ #${c+1} LAMAèƒŒæ™¯ä¿®å¤æˆåŠŸ`),x()):(console.error("LAMAä¿®å¤å¤±è´¥:",re.error||"æœªçŸ¥é”™è¯¯"),await K(h.coords,X,pe),x())}else await K(h.coords,X,pe),console.log(`æ°”æ³¡ #${c+1} çº¯è‰²å¡«å……ä¿®å¤æˆåŠŸ`),x()}catch(ye){console.error("èƒŒæ™¯ä¿®å¤å‡ºé”™:",ye);const _e=ye instanceof Error?ye.message:"èƒŒæ™¯ä¿®å¤å¤±è´¥";Ce(_e,"error")}}async function K(c,h,le=0){const N=m.value;if(!N)return;const[X,pe,ye,_e]=c;let $e;if(N.cleanImageData)$e="data:image/png;base64,"+N.cleanImageData;else if(N.originalDataURL)$e=N.originalDataURL;else{console.error("æ— æ³•æ‰¾åˆ°åŸºç¡€å›¾åƒç”¨äºå¡«å……");return}return new Promise(De=>{const re=new Image;re.onload=()=>{const T=document.createElement("canvas");T.width=re.naturalWidth,T.height=re.naturalHeight;const Z=T.getContext("2d");if(!Z){De();return}if(Z.drawImage(re,0,0),Z.fillStyle=h,Math.abs(le)<.1)Z.fillRect(X,pe,ye-X,_e-pe);else{const me=(X+ye)/2,xe=(pe+_e)/2,W=(ye-X)/2,ne=(_e-pe)/2,ve=le*Math.PI/180,fe=Math.cos(ve),Me=Math.sin(ve),Ne=[[-W,-ne],[W,-ne],[W,ne],[-W,ne]].map(([we,Ae])=>[me+we*fe-Ae*Me,xe+we*Me+Ae*fe]);Z.beginPath();const Ue=Ne[0];if(Ue){Z.moveTo(Ue[0],Ue[1]);for(let we=1;we<Ne.length;we++){const Ae=Ne[we];Ae&&Z.lineTo(Ae[0],Ae[1])}}Z.closePath(),Z.fill()}const he=T.toDataURL("image/png").split(",")[1];s.updateCurrentImage({cleanImageData:he}),console.log("å·²å¯¹æ°”æ³¡åŒºåŸŸè¿›è¡Œçº¯è‰²å¡«å……:",c,h,"è§’åº¦:",le),De()},re.onerror=()=>{console.error("åŠ è½½åŸºç¡€å›¾åƒå¤±è´¥"),De()},re.src=$e})}async function G(c){const h=a.value[c],le=m.value;if(!h||!le?.originalDataURL){console.warn("æ— æ³•è¿›è¡Œ OCR è¯†åˆ«ï¼šç¼ºå°‘æ°”æ³¡æˆ–å›¾ç‰‡æ•°æ®");return}try{console.log(`å¼€å§‹ OCR è¯†åˆ«æ°”æ³¡ #${c+1}`);const N=le.originalDataURL.split(",")[1]||"",X=o.settings,pe=X.ocrEngine==="paddleocr_vl"?X.paddleOcrVl?.sourceLanguage||"japanese":X.sourceLanguage,ye=await An(N,h.coords,X.ocrEngine||"manga_ocr",{source_language:pe,baidu_ocr_api_key:X.baiduOcr.apiKey,baidu_ocr_secret_key:X.baiduOcr.secretKey,baidu_version:X.baiduOcr.version,baidu_source_language:X.baiduOcr.sourceLanguage,ai_vision_provider:X.aiVisionOcr.provider,ai_vision_api_key:X.aiVisionOcr.apiKey,ai_vision_model_name:X.aiVisionOcr.modelName,ai_vision_ocr_prompt:X.aiVisionOcr.prompt,custom_ai_vision_base_url:X.aiVisionOcr.customBaseUrl,ai_vision_min_image_size:X.aiVisionOcr.minImageSize});if(ye.success&&ye.text!==void 0)t.updateBubble(c,{originalText:ye.text}),console.log(`OCR è¯†åˆ«æˆåŠŸ: "${ye.text}"`);else{const _e=ye.error||"è¯†åˆ«å¤±è´¥";console.error("OCR è¯†åˆ«å¤±è´¥:",_e),Ce(_e,"error")}}catch(N){console.error("OCR è¯†åˆ«å‡ºé”™:",N);const X=N instanceof Error?N.message:"OCR è¯†åˆ«å‡ºé”™";Ce(X,"error")}}return{isDrawingMode:g,isDrawingBox:u,currentDrawingRect:b,isMiddleButtonDown:R,handleBubbleSelect:y,handleBubbleMultiSelect:D,handleClearMultiSelect:V,handleBubbleDragStart:M,handleBubbleDragging:B,handleBubbleDragEnd:v,handleBubbleResizeStart:p,handleBubbleResizing:$,handleBubbleResizeEnd:k,handleBubbleRotateStart:F,handleBubbleRotating:z,handleBubbleRotateEnd:ee,toggleDrawingMode:J,handleDrawBubble:se,startDrawingBox:O,updateDrawingBox:Q,finishDrawingBox:ae,cancelDrawing:U,getDrawingRectStyle:r,handleBubbleUpdate:P,deleteSelectedBubbles:I,repairSelectedBubble:E,triggerDelayedPreview:x,handleOcrRecognize:G}}function ev(n){const t=gt(),s=Ze(),{bubbles:o}=yt(t),{currentImage:a}=yt(s),i=w(!1),l=w("");let m=null;function g(){const _=a.value;if(!_)return null;if(_.cleanImageData)return _.cleanImageData;if(_.originalDataURL){const S=_.originalDataURL.match(/^data:image\/[^;]+;base64,(.+)$/);if(S&&S[1])return S[1]}return null}async function u(_=!1){if(!a.value)return console.warn("reRenderFullImage: æ²¡æœ‰å½“å‰å›¾ç‰‡"),!1;if(o.value.length===0){console.log("reRenderFullImage: æ²¡æœ‰æ°”æ³¡ï¼Œè·³è¿‡åç«¯æ¸²æŸ“");const D=g();if(D){const V=`data:image/png;base64,${D}`;s.updateCurrentImage({translatedDataURL:V}),_||n?.onRenderSuccess?.(V)}return!0}const R=g();if(!R)return console.error("reRenderFullImage: ç¼ºå°‘å›¾åƒæ•°æ®"),l.value="ç¼ºå°‘å›¾åƒæ•°æ®",_||n?.onRenderError?.("ç¼ºå°‘å›¾åƒæ•°æ®"),!1;const y=Symbol("render");m=y,i.value=!0,l.value="",_||n?.onRenderStart?.();try{console.log("reRenderFullImage: å¼€å§‹é‡æ–°æ¸²æŸ“ï¼Œæ°”æ³¡æ•°é‡:",o.value.length);const D=o.value,V=D.map(p=>p.translatedText||""),M=D.map(p=>p.coords.map($=>Math.round($))),B=D.map(p=>({translatedText:p.translatedText||"",coords:p.coords,fontSize:Number(p.fontSize)||24,fontFamily:p.fontFamily||ft,textDirection:Ot(p),textColor:p.textColor||"#231816",rotationAngle:Math.round(Number(p.rotationAngle)||0),position:p.position?{x:Math.round(p.position.x||0),y:Math.round(p.position.y||0)}:{x:0,y:0},strokeEnabled:p.strokeEnabled!==void 0?p.strokeEnabled:!0,strokeColor:p.strokeColor||"#FFFFFF",strokeWidth:Number(p.strokeWidth)||3})),v=await $o({clean_image:R,bubble_texts:V,bubble_coords:M,bubble_states:B,fontSize:Number(D[0]?.fontSize)||24,fontFamily:D[0]?.fontFamily||ft,textDirection:D[0]?Ot(D[0]):"vertical",textColor:D[0]?.textColor||"#231816",strokeEnabled:D[0]?.strokeEnabled!==void 0?D[0].strokeEnabled:!0,strokeColor:D[0]?.strokeColor||"#FFFFFF",strokeWidth:Number(D[0]?.strokeWidth)||3,use_individual_styles:!0,use_inpainting:!1,use_lama:!1,is_font_style_change:!0});if(m!==y)return console.log("reRenderFullImage: æ¸²æŸ“ç»“æœå·²è¿‡æœŸï¼Œå¿½ç•¥"),!1;if(v.rendered_image){const p=`data:image/png;base64,${v.rendered_image}`;return s.updateCurrentImage({translatedDataURL:p}),console.log("reRenderFullImage: æ¸²æŸ“æˆåŠŸ"),_||n?.onRenderSuccess?.(p),!0}else{const p=v.error||"æ¸²æŸ“å¤±è´¥";return console.error("reRenderFullImage: æ¸²æŸ“å¤±è´¥ -",p),l.value=p,_||n?.onRenderError?.(p),!1}}catch(D){if(m!==y)return!1;const V=D instanceof Error?D.message:"æ¸²æŸ“è¯·æ±‚å¤±è´¥";return console.error("reRenderFullImage: æ¸²æŸ“å‡ºé”™ -",D),l.value=V,_||n?.onRenderError?.(V),!1}finally{m===y&&(i.value=!1,_||n?.onRenderEnd?.())}}function b(){m=null,i.value=!1}return{isRendering:i,renderError:l,reRenderFullImage:u,cancelRender:b}}const tv=["data-index","data-coords","data-rotation","onClick","onMousedown"],ov={class:"bubble-index"},nv=["data-parent-index","onMousedown"],sv=["data-parent-index","onMousedown"],av=["data-parent-index","onMousedown"],lv=["data-parent-index","onMousedown"],iv=["data-parent-index","onMousedown"],rv=["data-parent-index","onMousedown"],uv=["data-parent-index","onMousedown"],cv=["data-parent-index","onMousedown"],dv=["data-parent-index","onMousedown"],gv=Ye({__name:"BubbleOverlay",props:{bubbles:{},selectedIndex:{},selectedIndices:{},scale:{},isDrawingMode:{type:Boolean},isBrushMode:{type:Boolean},imageWidth:{},imageHeight:{}},emits:["select","multiSelect","dragStart","dragging","dragEnd","resizeStart","resizing","resizeEnd","rotateStart","rotating","rotateEnd","drawBubble"],setup(n,{emit:t}){const s=gt(),{isDragging:o,draggingIndex:a,dragOffsetX:i,dragOffsetY:l,dragInitialX:m,dragInitialY:g,isResizing:u,resizingIndex:b,resizeCurrentCoords:_,isRotating:S,rotatingIndex:R,rotateCurrentAngle:y}=yt(s),D=n,V=t,M=w(null),B=w(0),v=w(0),p=w(""),$=w(0),k=w(0),F=w(null),z=w(0),ee=w(0),J=w(0),se=w(0),O=w(!1),Q=w(0),ae=w(0),U=w(null),r=w(!1);function d(T,Z){let he,me,xe,W,ne=T.rotationAngle||0;if(o.value&&a.value===Z){const[Ne,Ue,we,Ae]=T.coords;he=m.value+i.value,me=g.value+l.value,xe=he+(we-Ne),W=me+(Ae-Ue)}else u.value&&b.value===Z&&_.value?[he,me,xe,W]=_.value:S.value&&R.value===Z?([he,me,xe,W]=T.coords,ne=y.value):[he,me,xe,W]=T.coords;const ve=xe-he,fe=W-me,Me={left:`${he}px`,top:`${me}px`,width:`${ve}px`,height:`${fe}px`};return ne&&(Me.transformOrigin="center center",Me.transform=`rotate(${ne}deg)`),Me}function f(){if(!U.value)return{};const[T,Z,he,me]=U.value;return{left:`${Math.min(T,he)}px`,top:`${Math.min(Z,me)}px`,width:`${Math.abs(he-T)}px`,height:`${Math.abs(me-Z)}px`}}function C(T){if(!M.value)return null;const Z=M.value.getBoundingClientRect(),he=D.scale||1,me=(T.clientX-Z.left)/he,xe=(T.clientY-Z.top)/he;return{x:me,y:xe}}function x(T,Z){D.isBrushMode||Z.shiftKey||V("select",T)}function P(T){if(!D.isBrushMode){if(T.button===1){T.preventDefault(),r.value=!0,document.body.classList.add("middle-button-drawing"),ye(T);return}T.button===0&&D.isDrawingMode&&ye(T)}}function I(T,Z){if(!D.isBrushMode&&Z.button===0){if(Z.preventDefault(),Z.stopPropagation(),Z.shiftKey){V("multiSelect",T);return}if(T!==D.selectedIndex){V("select",T);return}E(T,Z)}}function E(T,Z){document.removeEventListener("mousemove",De),document.removeEventListener("mouseup",re),o.value=!0,a.value=T,B.value=Z.clientX,v.value=Z.clientY,i.value=0,l.value=0;const he=D.bubbles[T];he&&(m.value=he.coords[0],g.value=he.coords[1]),V("dragStart",T,Z),document.addEventListener("mousemove",De),document.addEventListener("mouseup",re)}function K(T){const Z=D.scale||1,he=(T.clientX-B.value)/Z,me=(T.clientY-v.value)/Z;i.value=he,l.value=me}function G(T){const Z=a.value;o.value=!1,a.value=-1,i.value=0,l.value=0;const he=D.scale||1,me=(T.clientX-B.value)/he,xe=(T.clientY-v.value)/he,W=D.bubbles[Z];if(!W)return;const[ne,ve,fe,Me]=W.coords,Ne=fe-ne,Ue=Me-ve;let we=Math.round(m.value+me),Ae=Math.round(g.value+xe);const Ie=D.imageWidth||2e3,tt=D.imageHeight||2e3,Ke=Math.min(Ne,Ie),lt=Math.min(Ue,tt);we=Math.max(0,Math.min(we,Ie-Ke)),Ae=Math.max(0,Math.min(Ae,tt-lt));const Te=[we,Ae,we+Ke,Ae+lt];V("dragEnd",Z,Te)}function c(T,Z,he){if(D.isBrushMode||he.button!==0)return;he.preventDefault(),he.stopPropagation(),document.removeEventListener("mousemove",De),document.removeEventListener("mouseup",re),u.value=!0,b.value=Z,p.value=T,$.value=he.clientX,k.value=he.clientY;const me=D.bubbles[Z];me&&(F.value=[...me.coords],_.value=[...me.coords]),V("resizeStart",Z,T,he),document.addEventListener("mousemove",De),document.addEventListener("mouseup",re)}function h(T){if(!F.value)return;const Z=D.scale||1,he=(T.clientX-$.value)/Z,me=(T.clientY-k.value)/Z;let[xe,W,ne,ve]=F.value;const fe=p.value;fe.includes("w")&&(xe+=he),fe.includes("e")&&(ne+=he),fe.includes("n")&&(W+=me),fe.includes("s")&&(ve+=me),xe>ne&&([xe,ne]=[ne,xe]),W>ve&&([W,ve]=[ve,W]);const Me=10;ne-xe<Me||ve-W<Me||(_.value=[xe,W,ne,ve])}function le(T){if(!F.value)return;const Z=D.scale||1,he=(T.clientX-$.value)/Z,me=(T.clientY-k.value)/Z;let[xe,W,ne,ve]=F.value;const fe=p.value;fe.includes("w")&&(xe+=he),fe.includes("e")&&(ne+=he),fe.includes("n")&&(W+=me),fe.includes("s")&&(ve+=me),xe>ne&&([xe,ne]=[ne,xe]),W>ve&&([W,ve]=[ve,W]);const Me=D.imageWidth||2e3,Ne=D.imageHeight||2e3;xe=Math.max(0,Math.round(xe)),W=Math.max(0,Math.round(W)),ne=Math.min(Me,Math.round(ne)),ve=Math.min(Ne,Math.round(ve));const Ue=10;if(ne-xe<Ue||ve-W<Ue){console.warn("è°ƒæ•´åå°ºå¯¸è¿‡å°ï¼Œå·²æ’¤é”€"),u.value=!1,b.value=-1,F.value=null;return}V("resizeEnd",b.value,[xe,W,ne,ve]),u.value=!1,b.value=-1,F.value=null,_.value=null}function N(T,Z){if(D.isBrushMode||Z.button!==0)return;Z.preventDefault(),Z.stopPropagation(),document.removeEventListener("mousemove",De),document.removeEventListener("mouseup",re),S.value=!0,R.value=T;const he=D.bubbles[T];if(!he||!M.value)return;const[me,xe,W,ne]=he.coords,ve=D.scale||1,fe=M.value.getBoundingClientRect();J.value=fe.left+(me+W)/2*ve,se.value=fe.top+(xe+ne)/2*ve;const Me=Z.clientX-J.value,Ne=Z.clientY-se.value;z.value=Math.atan2(Ne,Me)*180/Math.PI,ee.value=he.rotationAngle||0,y.value=he.rotationAngle||0,V("rotateStart",T,Z),document.body.classList.add("rotating-box"),document.addEventListener("mousemove",De),document.addEventListener("mouseup",re),console.log(`å¼€å§‹æ—‹è½¬æ°”æ³¡ #${T+1}ï¼Œåˆå§‹è§’åº¦: ${ee.value}Â°`)}function X(T){const Z=T.clientX-J.value,he=T.clientY-se.value,xe=Math.atan2(he,Z)*180/Math.PI-z.value;let W=ee.value+xe;for(;W>180;)W-=360;for(;W<-180;)W+=360;T.shiftKey&&(W=Math.round(W/15)*15),y.value=W}function pe(T){document.body.classList.remove("rotating-box");const Z=R.value,he=y.value;V("rotateEnd",Z,he),S.value=!1,R.value=-1,console.log(`æ°”æ³¡ #${Z+1} æ—‹è½¬å®Œæˆï¼Œè§’åº¦: ${he}Â°`)}function ye(T){const Z=C(T);if(!Z)return;const he=D.imageWidth||2e3,me=D.imageHeight||2e3;Z.x<0||Z.x>he||Z.y<0||Z.y>me||(O.value=!0,Q.value=Z.x,ae.value=Z.y,U.value=[Z.x,Z.y,Z.x,Z.y],document.addEventListener("mousemove",De),document.addEventListener("mouseup",re),console.log("å¼€å§‹ç»˜åˆ¶æ–°æ¡†:",Z.x.toFixed(1),Z.y.toFixed(1)))}function _e(T){const Z=C(T);!Z||!U.value||(U.value=[Q.value,ae.value,Z.x,Z.y])}function $e(T){const Z=C(T);if(r.value&&(r.value=!1,document.body.classList.remove("middle-button-drawing")),!Z||!U.value){O.value=!1,U.value=null;return}const he=D.imageWidth||2e3,me=D.imageHeight||2e3,xe=Math.max(0,Math.round(Math.min(Q.value,Z.x))),W=Math.max(0,Math.round(Math.min(ae.value,Z.y))),ne=Math.min(he,Math.round(Math.max(Q.value,Z.x))),ve=Math.min(me,Math.round(Math.max(ae.value,Z.y))),fe=10;if(ne-xe<fe||ve-W<fe){console.log("ç»˜åˆ¶çš„æ¡†å¤ªå°ï¼Œå·²å¿½ç•¥"),O.value=!1,U.value=null;return}console.log("å®Œæˆç»˜åˆ¶æ–°æ¡†:",[xe,W,ne,ve]),V("drawBubble",[xe,W,ne,ve]),O.value=!1,U.value=null}function De(T){o.value?K(T):u.value?h(T):S.value?X(T):O.value&&_e(T)}function re(T){document.removeEventListener("mousemove",De),document.removeEventListener("mouseup",re),(T.button===1||r.value)&&(r.value=!1,document.body.classList.remove("middle-button-drawing")),o.value?G(T):u.value?le(T):S.value?pe():O.value&&$e(T)}return dt(()=>{}),Wt(()=>{document.removeEventListener("mousemove",De),document.removeEventListener("mouseup",re),document.body.classList.remove("middle-button-drawing"),document.body.classList.remove("rotating-box")}),(T,Z)=>(A(),L("div",{class:Re(["bubble-overlay",{"brush-mode":n.isBrushMode}]),style:ot({"--scale":n.scale||1}),ref_key:"overlayRef",ref:M,onMousedown:P},[(A(!0),L(ze,null,Ge(n.bubbles,(he,me)=>(A(),L("div",{key:me,class:Re(["bubble-highlight-box",{selected:me===n.selectedIndex,"multi-selected":n.selectedIndices.length>1&&n.selectedIndices.includes(me)&&me!==n.selectedIndex}]),style:ot(d(he,me)),"data-index":me,"data-coords":JSON.stringify(he.coords),"data-rotation":he.rotationAngle||0,onClick:nt(xe=>x(me,xe),["stop"]),onMousedown:nt(xe=>I(me,xe),["stop"])},[e("span",ov,te(me+1),1),me===n.selectedIndex?(A(),L(ze,{key:0},[e("div",{class:"resize-handle nw","data-handle":"nw","data-parent-index":me,onMousedown:nt(xe=>c("nw",me,xe),["stop"])},null,40,nv),e("div",{class:"resize-handle n","data-handle":"n","data-parent-index":me,onMousedown:nt(xe=>c("n",me,xe),["stop"])},null,40,sv),e("div",{class:"resize-handle ne","data-handle":"ne","data-parent-index":me,onMousedown:nt(xe=>c("ne",me,xe),["stop"])},null,40,av),e("div",{class:"resize-handle e","data-handle":"e","data-parent-index":me,onMousedown:nt(xe=>c("e",me,xe),["stop"])},null,40,lv),e("div",{class:"resize-handle se","data-handle":"se","data-parent-index":me,onMousedown:nt(xe=>c("se",me,xe),["stop"])},null,40,iv),e("div",{class:"resize-handle s","data-handle":"s","data-parent-index":me,onMousedown:nt(xe=>c("s",me,xe),["stop"])},null,40,rv),e("div",{class:"resize-handle sw","data-handle":"sw","data-parent-index":me,onMousedown:nt(xe=>c("sw",me,xe),["stop"])},null,40,uv),e("div",{class:"resize-handle w","data-handle":"w","data-parent-index":me,onMousedown:nt(xe=>c("w",me,xe),["stop"])},null,40,cv),Z[0]||(Z[0]=e("div",{class:"rotate-line"},null,-1)),e("div",{class:"rotate-handle",title:"æ‹–æ‹½æ—‹è½¬","data-parent-index":me,onMousedown:nt(xe=>N(me,xe),["stop"])},null,40,dv)],64)):ce("",!0)],46,tv))),128)),U.value?(A(),L("div",{key:0,class:"drawing-rect",style:ot(f())},null,4)):ce("",!0)],38))}}),wn=Je(gv,[["__scopeId","data-v-8d9cb1b9"]]),pv={key:0,class:"kana-keyboard"},mv={class:"kana-keyboard-header"},vv={class:"kana-keyboard-tabs"},fv=["onClick"],bv={class:"kana-keyboard-options"},hv={class:"kana-mode-select"},xv={class:"kana-target-select"},yv={class:"kana-table"},Cv={class:"row-label"},_v=["onClick"],kv={class:"kana-hiragana"},Sv={class:"kana-katakana"},wv={class:"kana-table"},$v={class:"row-label"},Tv=["onClick"],Iv={class:"kana-hiragana"},Pv={class:"kana-katakana"},Rv={class:"kana-table combo-table"},Dv={class:"row-label"},Mv=["onClick"],Bv={class:"kana-hiragana"},Av={class:"kana-katakana"},Ev={class:"special-chars-grid"},Lv=["onClick"],Fv={key:0,class:"char-label"},Uv=Ye({__name:"JapaneseKeyboard",props:{visible:{type:Boolean,default:!1},defaultTarget:{default:"original"}},emits:["close","insert","delete"],setup(n,{emit:t}){const s=n,o=t,a=w("basic"),i=w("hiragana"),l=w(s.defaultTarget),m=w(null),g=[{label:"åŸæ–‡",value:"original"},{label:"è¯‘æ–‡",value:"translated"}],u=[{id:"basic",label:"åŸºæœ¬"},{id:"dakuten",label:"æµŠ/åŠæµŠéŸ³"},{id:"combo",label:"æ‹—éŸ³"},{id:"special",label:"ç‰¹æ®Š"}],b=[{label:"ã‚è¡Œ",chars:[{h:"ã‚",k:"ã‚¢"},{h:"ã„",k:"ã‚¤"},{h:"ã†",k:"ã‚¦"},{h:"ãˆ",k:"ã‚¨"},{h:"ãŠ",k:"ã‚ª"}]},{label:"ã‹è¡Œ",chars:[{h:"ã‹",k:"ã‚«"},{h:"ã",k:"ã‚­"},{h:"ã",k:"ã‚¯"},{h:"ã‘",k:"ã‚±"},{h:"ã“",k:"ã‚³"}]},{label:"ã•è¡Œ",chars:[{h:"ã•",k:"ã‚µ"},{h:"ã—",k:"ã‚·"},{h:"ã™",k:"ã‚¹"},{h:"ã›",k:"ã‚»"},{h:"ã",k:"ã‚½"}]},{label:"ãŸè¡Œ",chars:[{h:"ãŸ",k:"ã‚¿"},{h:"ã¡",k:"ãƒ"},{h:"ã¤",k:"ãƒ„"},{h:"ã¦",k:"ãƒ†"},{h:"ã¨",k:"ãƒˆ"}]},{label:"ãªè¡Œ",chars:[{h:"ãª",k:"ãƒŠ"},{h:"ã«",k:"ãƒ‹"},{h:"ã¬",k:"ãƒŒ"},{h:"ã­",k:"ãƒ"},{h:"ã®",k:"ãƒ"}]},{label:"ã¯è¡Œ",chars:[{h:"ã¯",k:"ãƒ"},{h:"ã²",k:"ãƒ’"},{h:"ãµ",k:"ãƒ•"},{h:"ã¸",k:"ãƒ˜"},{h:"ã»",k:"ãƒ›"}]},{label:"ã¾è¡Œ",chars:[{h:"ã¾",k:"ãƒ"},{h:"ã¿",k:"ãƒŸ"},{h:"ã‚€",k:"ãƒ "},{h:"ã‚",k:"ãƒ¡"},{h:"ã‚‚",k:"ãƒ¢"}]},{label:"ã‚„è¡Œ",chars:[{h:"ã‚„",k:"ãƒ¤"},null,{h:"ã‚†",k:"ãƒ¦"},null,{h:"ã‚ˆ",k:"ãƒ¨"}]},{label:"ã‚‰è¡Œ",chars:[{h:"ã‚‰",k:"ãƒ©"},{h:"ã‚Š",k:"ãƒª"},{h:"ã‚‹",k:"ãƒ«"},{h:"ã‚Œ",k:"ãƒ¬"},{h:"ã‚",k:"ãƒ­"}]},{label:"ã‚è¡Œ",chars:[{h:"ã‚",k:"ãƒ¯"},null,null,null,{h:"ã‚’",k:"ãƒ²"}]},{label:"ã‚“",chars:[{h:"ã‚“",k:"ãƒ³"},null,null,null,null]}],_=[{label:"ãŒè¡Œ",chars:[{h:"ãŒ",k:"ã‚¬"},{h:"ã",k:"ã‚®"},{h:"ã",k:"ã‚°"},{h:"ã’",k:"ã‚²"},{h:"ã”",k:"ã‚´"}]},{label:"ã–è¡Œ",chars:[{h:"ã–",k:"ã‚¶"},{h:"ã˜",k:"ã‚¸"},{h:"ãš",k:"ã‚º"},{h:"ãœ",k:"ã‚¼"},{h:"ã",k:"ã‚¾"}]},{label:"ã è¡Œ",chars:[{h:"ã ",k:"ãƒ€"},{h:"ã¢",k:"ãƒ‚"},{h:"ã¥",k:"ãƒ…"},{h:"ã§",k:"ãƒ‡"},{h:"ã©",k:"ãƒ‰"}]},{label:"ã°è¡Œ",chars:[{h:"ã°",k:"ãƒ"},{h:"ã³",k:"ãƒ“"},{h:"ã¶",k:"ãƒ–"},{h:"ã¹",k:"ãƒ™"},{h:"ã¼",k:"ãƒœ"}]},{label:"ã±è¡Œ",chars:[{h:"ã±",k:"ãƒ‘"},{h:"ã´",k:"ãƒ”"},{h:"ã·",k:"ãƒ—"},{h:"ãº",k:"ãƒš"},{h:"ã½",k:"ãƒ"}]}],S=[{label:"ãã‚ƒè¡Œ",chars:[{h:"ãã‚ƒ",k:"ã‚­ãƒ£"},{h:"ãã‚…",k:"ã‚­ãƒ¥"},{h:"ãã‚‡",k:"ã‚­ãƒ§"}]},{label:"ã—ã‚ƒè¡Œ",chars:[{h:"ã—ã‚ƒ",k:"ã‚·ãƒ£"},{h:"ã—ã‚…",k:"ã‚·ãƒ¥"},{h:"ã—ã‚‡",k:"ã‚·ãƒ§"}]},{label:"ã¡ã‚ƒè¡Œ",chars:[{h:"ã¡ã‚ƒ",k:"ãƒãƒ£"},{h:"ã¡ã‚…",k:"ãƒãƒ¥"},{h:"ã¡ã‚‡",k:"ãƒãƒ§"}]},{label:"ã«ã‚ƒè¡Œ",chars:[{h:"ã«ã‚ƒ",k:"ãƒ‹ãƒ£"},{h:"ã«ã‚…",k:"ãƒ‹ãƒ¥"},{h:"ã«ã‚‡",k:"ãƒ‹ãƒ§"}]},{label:"ã²ã‚ƒè¡Œ",chars:[{h:"ã²ã‚ƒ",k:"ãƒ’ãƒ£"},{h:"ã²ã‚…",k:"ãƒ’ãƒ¥"},{h:"ã²ã‚‡",k:"ãƒ’ãƒ§"}]},{label:"ã¿ã‚ƒè¡Œ",chars:[{h:"ã¿ã‚ƒ",k:"ãƒŸãƒ£"},{h:"ã¿ã‚…",k:"ãƒŸãƒ¥"},{h:"ã¿ã‚‡",k:"ãƒŸãƒ§"}]},{label:"ã‚Šã‚ƒè¡Œ",chars:[{h:"ã‚Šã‚ƒ",k:"ãƒªãƒ£"},{h:"ã‚Šã‚…",k:"ãƒªãƒ¥"},{h:"ã‚Šã‚‡",k:"ãƒªãƒ§"}]},{label:"ãã‚ƒè¡Œ",chars:[{h:"ãã‚ƒ",k:"ã‚®ãƒ£"},{h:"ãã‚…",k:"ã‚®ãƒ¥"},{h:"ãã‚‡",k:"ã‚®ãƒ§"}]},{label:"ã˜ã‚ƒè¡Œ",chars:[{h:"ã˜ã‚ƒ",k:"ã‚¸ãƒ£"},{h:"ã˜ã‚…",k:"ã‚¸ãƒ¥"},{h:"ã˜ã‚‡",k:"ã‚¸ãƒ§"}]},{label:"ã³ã‚ƒè¡Œ",chars:[{h:"ã³ã‚ƒ",k:"ãƒ“ãƒ£"},{h:"ã³ã‚…",k:"ãƒ“ãƒ¥"},{h:"ã³ã‚‡",k:"ãƒ“ãƒ§"}]},{label:"ã´ã‚ƒè¡Œ",chars:[{h:"ã´ã‚ƒ",k:"ãƒ”ãƒ£"},{h:"ã´ã‚…",k:"ãƒ”ãƒ¥"},{h:"ã´ã‚‡",k:"ãƒ”ãƒ§"}]}],R=[{char:"ã£",label:"ä¿ƒéŸ³"},{char:"ãƒƒ",label:"ä¿ƒéŸ³"},{char:"ãƒ¼",label:"é•¿éŸ³"},{char:"ã€œ",label:"æ³¢æµª"},{char:"ã€‚",label:"å¥å·"},{char:"ã€",label:"é¡¿å·"},{char:"ã€Œ",label:"å¼•å·"},{char:"ã€",label:"å¼•å·"},{char:"ã€",label:"åŒå¼•"},{char:"ã€",label:"åŒå¼•"},{char:"â€¦",label:"çœç•¥"},{char:"ãƒ»",label:"ä¸­ç‚¹"},{char:"ï¼",label:"æ„Ÿå¹"},{char:"ï¼Ÿ",label:"é—®å·"},{char:"â™ª",label:"éŸ³ç¬¦"},{char:"â™¡",label:"å¿ƒå½¢"},{char:"â˜…",label:"æ˜Ÿå½¢"},{char:"â˜†",label:"ç©ºæ˜Ÿ"},{char:"ã",label:"å°ã‚"},{char:"ãƒ",label:"å°ã„"},{char:"ã…",label:"å°ã†"},{char:"ã‡",label:"å°ãˆ"},{char:"ã‰",label:"å°ãŠ"},{char:"ã‚¡",label:"å°ã‚¢"},{char:"ã‚£",label:"å°ã‚¤"},{char:"ã‚¥",label:"å°ã‚¦"},{char:"ã‚§",label:"å°ã‚¨"},{char:"ã‚©",label:"å°ã‚ª"},{char:"ã‚ƒ",label:"å°ã‚„"},{char:"ã‚…",label:"å°ã‚†"},{char:"ã‚‡",label:"å°ã‚ˆ"},{char:"ãƒ£",label:"å°ãƒ¤"},{char:"ãƒ¥",label:"å°ãƒ¦"},{char:"ãƒ§",label:"å°ãƒ¨"}];function y(){o("close")}function D(B){const v=i.value==="hiragana"?B.h:B.k;m.value=B.h,setTimeout(()=>{m.value=null},100),o("insert",v,l.value)}function V(B){m.value=B,setTimeout(()=>{m.value=null},100),o("insert",B,l.value)}function M(){o("delete",l.value)}return(B,v)=>n.visible?(A(),L("div",pv,[e("div",mv,[v[3]||(v[3]=e("span",{class:"kana-keyboard-title"},"50éŸ³é”®ç›˜",-1)),e("div",vv,[(A(),L(ze,null,Ge(u,p=>e("button",{key:p.id,class:Re(["kana-tab",{active:a.value===p.id}]),onClick:$=>a.value=p.id},te(p.label),11,fv)),64))]),e("button",{class:"kana-keyboard-close",onClick:y},"âœ•")]),e("div",bv,[e("div",hv,[e("label",null,[oe(e("input",{type:"radio",name:"kanaMode",value:"hiragana","onUpdate:modelValue":v[0]||(v[0]=p=>i.value=p)},null,512),[[cn,i.value]]),v[4]||(v[4]=de(" å¹³å‡å ",-1))]),e("label",null,[oe(e("input",{type:"radio",name:"kanaMode",value:"katakana","onUpdate:modelValue":v[1]||(v[1]=p=>i.value=p)},null,512),[[cn,i.value]]),v[5]||(v[5]=de(" ç‰‡å‡å ",-1))])]),e("div",xv,[v[6]||(v[6]=e("label",null,"è¾“å…¥åˆ°ï¼š",-1)),ke(Ve,{modelValue:l.value,"onUpdate:modelValue":v[2]||(v[2]=p=>l.value=p),options:g},null,8,["modelValue"])])]),e("div",{class:Re(["kana-tab-content",{active:a.value==="basic"}])},[e("table",yv,[v[7]||(v[7]=e("thead",null,[e("tr",null,[e("th"),e("th",null,"ã‚æ®µ"),e("th",null,"ã„æ®µ"),e("th",null,"ã†æ®µ"),e("th",null,"ãˆæ®µ"),e("th",null,"ãŠæ®µ")])],-1)),e("tbody",null,[(A(),L(ze,null,Ge(b,p=>e("tr",{key:p.label},[e("td",Cv,te(p.label),1),(A(!0),L(ze,null,Ge(p.chars,($,k)=>(A(),L("td",{key:k},[$?(A(),L("button",{key:0,class:Re(["kana-key",{pressed:m.value===$.h}]),onClick:F=>D($)},[e("span",kv,te($.h),1),e("span",Sv,te($.k),1)],10,_v)):ce("",!0)]))),128))])),64))])])],2),e("div",{class:Re(["kana-tab-content",{active:a.value==="dakuten"}])},[e("table",wv,[v[8]||(v[8]=e("thead",null,[e("tr",null,[e("th"),e("th",null,"ã‚æ®µ"),e("th",null,"ã„æ®µ"),e("th",null,"ã†æ®µ"),e("th",null,"ãˆæ®µ"),e("th",null,"ãŠæ®µ")])],-1)),e("tbody",null,[(A(),L(ze,null,Ge(_,p=>e("tr",{key:p.label},[e("td",$v,te(p.label),1),(A(!0),L(ze,null,Ge(p.chars,($,k)=>(A(),L("td",{key:k},[$?(A(),L("button",{key:0,class:Re(["kana-key",{pressed:m.value===$.h}]),onClick:F=>D($)},[e("span",Iv,te($.h),1),e("span",Pv,te($.k),1)],10,Tv)):ce("",!0)]))),128))])),64))])])],2),e("div",{class:Re(["kana-tab-content",{active:a.value==="combo"}])},[e("table",Rv,[v[9]||(v[9]=e("thead",null,[e("tr",null,[e("th"),e("th",null,"ã‚ƒ"),e("th",null,"ã‚…"),e("th",null,"ã‚‡")])],-1)),e("tbody",null,[(A(),L(ze,null,Ge(S,p=>e("tr",{key:p.label},[e("td",Dv,te(p.label),1),(A(!0),L(ze,null,Ge(p.chars,($,k)=>(A(),L("td",{key:k},[$?(A(),L("button",{key:0,class:Re(["kana-key",{pressed:m.value===$.h}]),onClick:F=>D($)},[e("span",Bv,te($.h),1),e("span",Av,te($.k),1)],10,Mv)):ce("",!0)]))),128))])),64))])])],2),e("div",{class:Re(["kana-tab-content",{active:a.value==="special"}])},[e("div",Ev,[(A(),L(ze,null,Ge(R,p=>e("button",{key:p.char,class:Re(["kana-key special-key",{pressed:m.value===p.char}]),onClick:$=>V(p.char)},[de(te(p.char)+" ",1),p.label?(A(),L("span",Fv,te(p.label),1)):ce("",!0)],10,Lv)),64))])],2),e("div",{class:"kana-keyboard-footer"},[e("button",{class:"kana-backspace",onClick:M},"âŒ« é€€æ ¼")])])):ce("",!0)}}),Ov=Je(Uv,[["__scopeId","data-v-ebfc2125"]]),zv={class:"edit-panel-content"},Nv={class:"text-column original-text-column text-block"},Vv={class:"text-column-header"},Wv=["disabled"],Kv={class:"text-column translated-text-column text-block"},qv={class:"text-column-header"},Hv=["disabled"],jv={class:"style-settings-section text-block"},Jv={class:"office-toolbar"},Yv={class:"toolbar-row toolbar-row-top"},Gv={class:"combo-control font-control"},Xv={class:"combo-control size-control"},Zv={class:"size-input-wrap"},Qv=["min","max","step"],ef={class:"toolbar-row toolbar-row-actions"},tf={class:"toolbar-icon-group","aria-label":"æ’ç‰ˆæ–¹å‘"},of=["data-active"],nf=["data-active"],sf={class:"toolbar-color-group"},af={class:"toolbar-color-picker",title:"æ–‡å­—é¢œè‰²"},lf={class:"toolbar-inpaint-group",title:"èƒŒæ™¯ä¿®å¤æ–¹å¼"},rf={class:"toolbar-stroke-cluster"},uf=["data-active"],cf={class:"toolbar-row toolbar-row-bottom"},df={class:"toolbar-rotation-group",title:"æ—‹è½¬è§’åº¦"},gf={class:"toolbar-position-group",title:"ä½ç½®è°ƒæ•´"},pf={class:"toolbar-position-value"},mf={class:"fontsize-presets-panel"},vf={class:"font-size-presets"},ff=["onClick"],Yt=2,bf=Ye({__name:"BubbleEditor",props:{bubble:{},bubbleIndex:{},isOcrLoading:{type:Boolean},isTranslateLoading:{type:Boolean}},emits:["update","reRender","ocrRecognize","reTranslate","applyBubble","resetCurrent"],setup(n,{emit:t}){const s=n,o=t,a=gt(),i={originalText:"",translatedText:"",fontSize:24,fontFamily:ft,textDirection:"vertical",textColor:"#231816",fillColor:"#FFFFFF",strokeEnabled:!0,strokeColor:"#FFFFFF",strokeWidth:3,rotationAngle:0,inpaintMethod:"solid",position:{x:0,y:0}},l=w(""),m=w(""),g=w(24),u=w(ft),b=w("vertical"),_=w("#231816"),S=w("#FFFFFF"),R=w(!0),y=w("#FFFFFF"),D=w(3),V=w(0),M=w("solid"),B=w(0),v=w(0),p=w(null),$=w(null),k=w(null),F=w(null),z=w(null),ee=w(!1),J=w("original"),se=w([{name:"æ€æºé»‘ä½“",path:ft},{name:"åæ–‡æ¥·ä½“",path:"fonts/STKAITI.TTF"},{name:"åæ–‡ç»†é»‘",path:"fonts/STXIHEI.TTF"},{name:"é»‘ä½“",path:"fonts/SIMHEI.TTF"},{name:"å®‹ä½“",path:"fonts/SIMSUN.TTC"}]),O=w([]),Q=Y(()=>s.bubble?s.bubble.coords[0]+B.value:0),ae=Y(()=>s.bubble?s.bubble.coords[1]+v.value:0),U=Y(()=>{const Te=[{label:"ç³»ç»Ÿå­—ä½“",options:se.value.map(q=>({label:q.name,value:q.path}))}];return O.value.length>0&&Te.push({label:"è‡ªå®šä¹‰å­—ä½“",options:O.value.map(q=>({label:q.name,value:q.path}))}),Te}),r=[{label:"çº¯è‰²å¡«å……",value:"solid"},{label:"LAMAä¿®å¤(æ¼«ç”»)",value:"lama_mpe"},{label:"LAMAä¿®å¤(é€šç”¨)",value:"litelama"}];function d(Te){const q=Te||i;l.value=q.originalText,m.value=q.translatedText,g.value=q.fontSize,u.value=q.fontFamily,b.value=q.textDirection,_.value=q.textColor,S.value=q.fillColor,R.value=q.strokeEnabled,y.value=q.strokeColor,D.value=q.strokeWidth,V.value=q.rotationAngle,M.value=q.inpaintMethod,B.value=q.position?.x||0,v.value=q.position?.y||0}Se(()=>s.bubble,Te=>{d(Te)},{deep:!0,immediate:!0});function f(){o("update",{originalText:l.value})}function C(){o("update",{translatedText:m.value})}function x(){navigator.clipboard.writeText(l.value)}function P(){navigator.clipboard.writeText(m.value)}function I(){o("update",{fontSize:g.value})}function E(Te){g.value=Te,o("update",{fontSize:Te})}function K(){g.value=Math.min(an,g.value+vo),o("update",{fontSize:g.value})}function G(){g.value=Math.max(ln,g.value-vo),o("update",{fontSize:g.value})}function c(){o("update",{fontFamily:u.value})}function h(Te){b.value=Te,o("update",{textDirection:Te})}function le(){k.value?.click()}function N(){o("update",{textColor:_.value})}function X(){F.value?.click()}function pe(){o("update",{fillColor:S.value})}function ye(){z.value?.click()}function _e(){o("update",{strokeColor:y.value})}function $e(){R.value=!R.value,o("update",{strokeEnabled:R.value})}function De(){o("update",{strokeWidth:D.value})}function re(){o("update",{inpaintMethod:M.value})}function T(){o("update",{rotationAngle:V.value})}function Z(){V.value=Math.max(-180,V.value-5),o("update",{rotationAngle:V.value})}function he(){V.value=Math.min(180,V.value+5),o("update",{rotationAngle:V.value})}function me(){V.value=0,o("update",{rotationAngle:0})}function xe(){B.value-=Yt,o("update",{position:{x:B.value,y:v.value}})}function W(){B.value+=Yt,o("update",{position:{x:B.value,y:v.value}})}function ne(){v.value-=Yt,o("update",{position:{x:B.value,y:v.value}})}function ve(){v.value+=Yt,o("update",{position:{x:B.value,y:v.value}})}function fe(){B.value=0,v.value=0,o("update",{position:{x:0,y:0}})}function Me(){o("applyBubble",s.bubbleIndex)}function Ne(){a.updateAllBubbles({fontSize:g.value,fontFamily:u.value,textDirection:b.value,textColor:_.value,fillColor:S.value,strokeEnabled:R.value,strokeColor:y.value,strokeWidth:D.value,inpaintMethod:M.value}),console.log("æ ·å¼å·²åº”ç”¨åˆ°æ‰€æœ‰æ°”æ³¡"),o("reRender")}function Ue(){o("resetCurrent",s.bubbleIndex)}function we(){o("ocrRecognize",s.bubbleIndex)}function Ae(){o("reTranslate",s.bubbleIndex)}function Ie(){ee.value=!ee.value}function tt(Te,q){if(q==="original"){const ie=p.value;if(ie){const be=ie.selectionStart||l.value.length,We=ie.selectionEnd||l.value.length,rt=l.value;l.value=rt.slice(0,be)+Te+rt.slice(We),pt(()=>{ie.selectionStart=ie.selectionEnd=be+Te.length,ie.focus()}),o("update",{originalText:l.value})}}else{const ie=$.value;if(ie){const be=ie.selectionStart||m.value.length,We=ie.selectionEnd||m.value.length,rt=m.value;m.value=rt.slice(0,be)+Te+rt.slice(We),pt(()=>{ie.selectionStart=ie.selectionEnd=be+Te.length,ie.focus()}),o("update",{translatedText:m.value})}}}function Ke(Te){if(Te==="original"){const q=p.value;if(q&&l.value.length>0){const ie=q.selectionStart||l.value.length,be=q.selectionEnd||l.value.length,We=l.value;ie===be&&ie>0?(l.value=We.slice(0,ie-1)+We.slice(be),pt(()=>{q.selectionStart=q.selectionEnd=ie-1,q.focus()})):ie!==be&&(l.value=We.slice(0,ie)+We.slice(be),pt(()=>{q.selectionStart=q.selectionEnd=ie,q.focus()})),o("update",{originalText:l.value})}}else{const q=$.value;if(q&&m.value.length>0){const ie=q.selectionStart||m.value.length,be=q.selectionEnd||m.value.length,We=m.value;ie===be&&ie>0?(m.value=We.slice(0,ie-1)+We.slice(be),pt(()=>{q.selectionStart=q.selectionEnd=ie-1,q.focus()})):ie!==be&&(m.value=We.slice(0,ie)+We.slice(be),pt(()=>{q.selectionStart=q.selectionEnd=ie,q.focus()})),o("update",{translatedText:m.value})}}}async function lt(){try{const Te=await js();if(Te.fonts){const q=[],ie=[];for(const be of Te.fonts){const We={name:typeof be=="string"?be:be.display_name||be.file_name||"",path:typeof be=="string"?be:be.path};We.path.startsWith("fonts/")?q.push(We):ie.push(We)}q.length>0&&(se.value=q),O.value=ie}}catch(Te){console.error("åŠ è½½å­—ä½“åˆ—è¡¨å¤±è´¥:",Te)}}return dt(()=>{lt()}),(Te,q)=>(A(),L("div",zv,[e("div",Nv,[e("div",Vv,[q[14]||(q[14]=e("span",{class:"column-title"},"ğŸ‡¯ğŸ‡µ æ—¥è¯­åŸæ–‡ (OCRç»“æœ)",-1)),e("button",{class:Re(["re-ocr-btn",{"is-loading":n.isOcrLoading}]),disabled:n.isOcrLoading,onClick:we,title:"é‡æ–°OCRæ­¤æ°”æ³¡"},[...q[13]||(q[13]=[e("span",{class:"btn-icon"},"ğŸ”„",-1)])],10,Wv)]),oe(e("textarea",{ref_key:"originalTextInput",ref:p,"onUpdate:modelValue":q[0]||(q[0]=ie=>l.value=ie),class:"text-editor original-editor",placeholder:"OCRè¯†åˆ«çš„æ—¥è¯­åŸæ–‡...",spellcheck:"false",onInput:f},null,544),[[Pe,l.value]]),e("div",{class:"text-actions"},[e("button",{class:"copy-btn",onClick:x},"ğŸ“‹ å¤åˆ¶"),e("button",{class:"keyboard-toggle-btn",onClick:Ie,title:"æ˜¾ç¤º/éšè—50éŸ³é”®ç›˜"}," âŒ¨ï¸ 50éŸ³ ")]),ke(Ov,{visible:ee.value,"default-target":J.value,onClose:q[1]||(q[1]=ie=>ee.value=!1),onInsert:tt,onDelete:Ke},null,8,["visible","default-target"])]),e("div",Kv,[e("div",qv,[q[16]||(q[16]=e("span",{class:"column-title"},"ğŸ‡¨ğŸ‡³ ä¸­æ–‡è¯‘æ–‡",-1)),e("button",{class:Re(["re-translate-btn",{"is-loading":n.isTranslateLoading}]),disabled:n.isTranslateLoading,onClick:Ae,title:"é‡æ–°ç¿»è¯‘æ­¤æ°”æ³¡"},[...q[15]||(q[15]=[e("span",{class:"btn-icon"},"ğŸ”„",-1)])],10,Hv)]),oe(e("textarea",{ref_key:"translatedTextInput",ref:$,"onUpdate:modelValue":q[2]||(q[2]=ie=>m.value=ie),class:"text-editor translated-editor",placeholder:"ç¿»è¯‘åçš„ä¸­æ–‡...",spellcheck:"false",onInput:C},null,544),[[Pe,m.value]]),e("div",{class:"text-actions"},[e("button",{class:"copy-btn",onClick:P},"ğŸ“‹ å¤åˆ¶"),e("button",{class:"apply-text-btn",onClick:Me},"âœ“ åº”ç”¨æ–‡æœ¬")])]),e("div",jv,[e("div",Jv,[e("div",Yv,[e("div",Gv,[q[17]||(q[17]=e("label",null,"å­—ä½“",-1)),ke(Ve,{modelValue:u.value,"onUpdate:modelValue":q[3]||(q[3]=ie=>u.value=ie),groups:U.value,title:"å­—ä½“",onChange:c},null,8,["modelValue","groups"])]),e("div",Xv,[q[18]||(q[18]=e("label",null,"å­—å·",-1)),e("div",Zv,[oe(e("input",{type:"number","onUpdate:modelValue":q[4]||(q[4]=ie=>g.value=ie),class:"toolbar-fontsize-input",min:H(ln),max:H(an),step:H(vo),title:"å­—å·",onChange:I},null,40,Qv),[[Pe,g.value,void 0,{number:!0}]]),e("div",{class:"toolbar-fontsize-btns"},[e("button",{class:"toolbar-fontsize-btn",onClick:K,title:"å¢å¤§å­—å·"}," A+ "),e("button",{class:"toolbar-fontsize-btn",onClick:G,title:"å‡å°å­—å·"}," A- ")])])])]),e("div",ef,[e("div",tf,[e("button",{class:"toolbar-btn","data-active":b.value==="vertical",onClick:q[5]||(q[5]=ie=>h("vertical")),title:"ç«–å‘æ’ç‰ˆ"},[...q[19]||(q[19]=[e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("path",{d:"M8 2v12M8 2L5 5M8 2l3 3",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])],8,of),e("button",{class:"toolbar-btn","data-active":b.value==="horizontal",onClick:q[6]||(q[6]=ie=>h("horizontal")),title:"æ¨ªå‘æ’ç‰ˆ"},[...q[20]||(q[20]=[e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("path",{d:"M2 8h12M14 8l-3-3M14 8l-3 3",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])],8,nf)]),q[26]||(q[26]=e("div",{class:"toolbar-divider vertical"},null,-1)),e("div",sf,[e("div",af,[e("button",{class:"toolbar-btn toolbar-color-btn",onClick:le},[q[21]||(q[21]=e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("text",{x:"3",y:"11","font-size":"10","font-weight":"bold",fill:"currentColor"},"A")],-1)),e("span",{class:"color-indicator",style:ot({background:_.value})},null,4)]),oe(e("input",{ref_key:"textColorInput",ref:k,type:"color","onUpdate:modelValue":q[7]||(q[7]=ie=>_.value=ie),class:"hidden-color-input",onInput:N,onChange:N},null,544),[[Pe,_.value]])])]),q[27]||(q[27]=e("div",{class:"toolbar-divider vertical"},null,-1)),e("div",lf,[ke(Ve,{modelValue:M.value,"onUpdate:modelValue":q[8]||(q[8]=ie=>M.value=ie),options:r,onChange:re},null,8,["modelValue"]),e("div",{class:Re(["toolbar-color-picker toolbar-solid-color-options",{hidden:M.value!=="solid"}])},[e("button",{class:"toolbar-btn toolbar-color-btn",onClick:X},[q[22]||(q[22]=e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("rect",{x:"2",y:"2",width:"12",height:"12",rx:"2",fill:"none",stroke:"currentColor","stroke-width":"1.2"}),e("rect",{x:"4",y:"4",width:"8",height:"8",rx:"1",fill:"currentColor",opacity:"0.3"})],-1)),e("span",{class:"color-indicator",style:ot({background:S.value})},null,4)]),oe(e("input",{ref_key:"fillColorInput",ref:F,type:"color","onUpdate:modelValue":q[9]||(q[9]=ie=>S.value=ie),class:"hidden-color-input",onChange:pe},null,544),[[Pe,S.value]])],2)]),q[28]||(q[28]=e("div",{class:"toolbar-divider vertical"},null,-1)),e("div",rf,[e("button",{class:"toolbar-btn","data-active":R.value,onClick:$e,title:"æ–‡å­—æè¾¹"},[...q[23]||(q[23]=[e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("text",{x:"3",y:"12","font-size":"11","font-weight":"bold",stroke:"currentColor","stroke-width":"2",fill:"none"}," A "),e("text",{x:"3",y:"12","font-size":"11","font-weight":"bold",fill:"currentColor"},"A")],-1)])],8,uf),e("div",{class:Re(["toolbar-color-picker toolbar-stroke-options",{hidden:!R.value}]),title:"æè¾¹é¢œè‰²"},[e("button",{class:"toolbar-btn toolbar-color-btn",onClick:ye},[q[24]||(q[24]=e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("circle",{cx:"8",cy:"8",r:"5",fill:"none",stroke:"currentColor","stroke-width":"2"})],-1)),e("span",{class:"color-indicator",style:ot({background:y.value})},null,4)]),oe(e("input",{ref_key:"strokeColorInput",ref:z,type:"color","onUpdate:modelValue":q[10]||(q[10]=ie=>y.value=ie),class:"hidden-color-input",onChange:_e},null,544),[[Pe,y.value]])],2),e("div",{class:Re(["toolbar-stroke-width toolbar-stroke-options",{hidden:!R.value}]),title:"æè¾¹å®½åº¦"},[oe(e("input",{type:"number","onUpdate:modelValue":q[11]||(q[11]=ie=>D.value=ie),class:"toolbar-mini-input",min:"0",max:"10",onChange:De},null,544),[[Pe,D.value,void 0,{number:!0}]]),q[25]||(q[25]=e("span",{class:"toolbar-unit"},"px",-1))],2)])]),e("div",cf,[e("div",df,[e("button",{class:"toolbar-btn",onClick:Z,title:"é€†æ—¶é’ˆæ—‹è½¬"},[...q[29]||(q[29]=[e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("path",{d:"M2 8a6 6 0 1 1 1.5 4",stroke:"currentColor","stroke-width":"1.5",fill:"none"}),e("path",{d:"M2 5v3.5h3.5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),oe(e("input",{type:"number","onUpdate:modelValue":q[12]||(q[12]=ie=>V.value=ie),class:"toolbar-mini-input toolbar-rotation-input",min:"-180",max:"180",step:"5",onChange:T},null,544),[[Pe,V.value,void 0,{number:!0}]]),q[31]||(q[31]=e("span",{class:"toolbar-unit"},"Â°",-1)),e("button",{class:"toolbar-btn",onClick:he,title:"é¡ºæ—¶é’ˆæ—‹è½¬"},[...q[30]||(q[30]=[e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("path",{d:"M14 8a6 6 0 1 0-1.5 4",stroke:"currentColor","stroke-width":"1.5",fill:"none"}),e("path",{d:"M14 5v3.5h-3.5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),e("button",{class:"toolbar-btn toolbar-small-btn",onClick:me,title:"é‡ç½®æ—‹è½¬"}," 0 ")]),q[37]||(q[37]=e("div",{class:"toolbar-divider vertical"},null,-1)),e("div",gf,[e("button",{class:"toolbar-btn",onClick:xe,title:"å·¦ç§»"},[...q[32]||(q[32]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("path",{d:"M10 3L5 8l5 5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),e("button",{class:"toolbar-btn",onClick:W,title:"å³ç§»"},[...q[33]||(q[33]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("path",{d:"M6 3l5 5-5 5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),e("button",{class:"toolbar-btn",onClick:ne,title:"ä¸Šç§»"},[...q[34]||(q[34]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("path",{d:"M3 10l5-5 5 5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),e("button",{class:"toolbar-btn",onClick:ve,title:"ä¸‹ç§»"},[...q[35]||(q[35]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("path",{d:"M3 6l5 5 5-5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),e("span",pf,[e("span",null,te(Q.value),1),q[36]||(q[36]=de(",",-1)),e("span",null,te(ae.value),1)]),e("button",{class:"toolbar-btn toolbar-small-btn",onClick:fe,title:"é‡ç½®ä½ç½®"}," âŒ‚ ")])])]),e("details",mf,[q[38]||(q[38]=e("summary",null,"å­—å·é¢„è®¾",-1)),e("div",vf,[(A(!0),L(ze,null,Ge(H(Ts),ie=>(A(),L("button",{key:ie,class:Re(["preset-btn",{active:g.value===ie}]),onClick:be=>E(ie)},te(ie),11,ff))),128))])]),e("div",{class:"edit-action-buttons"},[e("button",{class:"btn-apply",onClick:Me},"åº”ç”¨"),e("button",{class:"btn-apply-all",onClick:Ne},"åº”ç”¨å…¨éƒ¨"),e("button",{class:"btn-reset",onClick:Ue},"é‡ç½®")])])]))}}),hf=Je(bf,[["__scopeId","data-v-9d0b72d7"]]),xf={class:"edit-toolbar-wrapper"},yf={class:"edit-toolbar toolbar-row-1"},Cf={class:"image-navigator"},_f=["disabled"],kf=["disabled"],Sf={class:"bubble-navigator"},wf=["disabled"],$f={class:"bubble-indicator"},Tf={id:"currentBubbleNum"},If={id:"totalBubbleNum"},Pf=["disabled"],Rf={class:"view-controls"},Df={key:0,viewBox:"0 0 20 20",width:"16",height:"16"},Mf={key:1,viewBox:"0 0 20 20",width:"16",height:"16"},Bf={id:"zoomLevel"},Af={class:"edit-toolbar toolbar-row-2"},Ef={class:"annotation-tools"},Lf=["disabled"],Ff=["disabled"],Uf={key:0,class:"brush-size-indicator"},Of={key:1,class:"brush-mode-hint"},zf={class:"edit-progress-info"},Nf={class:"edit-progress-text"},Vf={class:"edit-progress-count"},Wf={class:"edit-progress-bar"},Kf={class:"quick-actions"},qf=Ye({__name:"EditToolbar",props:{currentImageIndex:{},imageCount:{},canGoPrevious:{type:Boolean},canGoNext:{type:Boolean},showThumbnails:{type:Boolean},hasBubbles:{type:Boolean},selectedBubbleIndex:{},bubbleCount:{},layoutMode:{},syncEnabled:{type:Boolean},scale:{},isDrawingMode:{type:Boolean},hasSelection:{type:Boolean},brushMode:{},brushSize:{},mouseX:{},mouseY:{},isProcessing:{type:Boolean},progressText:{},progressCurrent:{},progressTotal:{},isRepairLoading:{type:Boolean}},emits:["go-previous-image","go-next-image","toggle-thumbnails","select-previous-bubble","select-next-bubble","toggle-layout","toggle-view-mode","toggle-sync","fit-to-screen","zoom-in","zoom-out","reset-zoom","exit-edit-mode","auto-detect-bubbles","detect-all-images","translate-with-bubbles","toggle-drawing-mode","delete-selected-bubbles","repair-selected-bubble","activate-repair-brush","activate-restore-brush","apply-and-next"],setup(n){const t=n,s=Y(()=>t.progressTotal===0?0:Math.round(t.progressCurrent/t.progressTotal*100)),o=Y(()=>t.progressTotal>0&&t.progressCurrent>=t.progressTotal),a=Y(()=>{const i=t.brushMode==="repair"?{fill:"rgba(76, 175, 80, 0.4)",border:"#4CAF50"}:{fill:"rgba(33, 150, 243, 0.4)",border:"#2196F3"};return{position:"fixed",left:`${t.mouseX}px`,top:`${t.mouseY}px`,width:`${t.brushSize}px`,height:`${t.brushSize}px`,borderRadius:"50%",border:`2px solid ${i.border}`,backgroundColor:i.fill,pointerEvents:"none",zIndex:99999,transform:"translate(-50%, -50%)",display:t.brushMode?"block":"none"}});return(i,l)=>(A(),L("div",xf,[e("div",yf,[e("div",Cf,[e("button",{class:"nav-btn",disabled:!n.canGoPrevious,onClick:l[0]||(l[0]=m=>i.$emit("go-previous-image")),title:"ä¸Šä¸€å¼ å›¾ç‰‡ (PageUp)"}," â—€â—€ ",8,_f),e("span",{class:"image-indicator",onClick:l[1]||(l[1]=m=>i.$emit("toggle-thumbnails")),title:"ç‚¹å‡»å±•å¼€ç¼©ç•¥å›¾"},[l[23]||(l[23]=de(" å›¾ ",-1)),e("span",null,te(n.currentImageIndex+1),1),l[24]||(l[24]=de(" / ",-1)),e("span",null,te(n.imageCount),1)]),e("button",{class:"nav-btn",disabled:!n.canGoNext,onClick:l[2]||(l[2]=m=>i.$emit("go-next-image")),title:"ä¸‹ä¸€å¼ å›¾ç‰‡ (PageDown)"}," â–¶â–¶ ",8,kf),e("button",{class:Re(["thumb-toggle-btn",{active:n.showThumbnails}]),onClick:l[3]||(l[3]=m=>i.$emit("toggle-thumbnails")),title:"æ˜¾ç¤º/éšè—ç¼©ç•¥å›¾"}," â˜· ",2)]),l[30]||(l[30]=e("div",{class:"toolbar-divider"},null,-1)),e("div",Sf,[e("button",{id:"prevBubbleBtn",class:"nav-btn",disabled:!n.hasBubbles||n.selectedBubbleIndex<=0,onClick:l[4]||(l[4]=m=>i.$emit("select-previous-bubble")),title:"ä¸Šä¸€ä¸ªæ°”æ³¡ (â†)"}," â—€ ",8,wf),e("span",$f,[l[25]||(l[25]=de(" æ°”æ³¡ ",-1)),e("span",Tf,te(n.selectedBubbleIndex>=0?n.selectedBubbleIndex+1:0),1),l[26]||(l[26]=de(" / ",-1)),e("span",If,te(n.bubbleCount),1)]),e("button",{id:"nextBubbleBtn",class:"nav-btn",disabled:!n.hasBubbles||n.selectedBubbleIndex>=n.bubbleCount-1,onClick:l[5]||(l[5]=m=>i.$emit("select-next-bubble")),title:"ä¸‹ä¸€ä¸ªæ°”æ³¡ (â†’)"}," â–¶ ",8,Pf)]),l[31]||(l[31]=e("div",{class:"toolbar-divider"},null,-1)),e("div",Rf,[e("button",{class:"layout-toggle-btn",onClick:l[6]||(l[6]=m=>i.$emit("toggle-layout")),title:"åˆ‡æ¢å¸ƒå±€ï¼šå·¦å³/ä¸Šä¸‹"},[n.layoutMode==="horizontal"?(A(),L("svg",Df,[...l[27]||(l[27]=[e("rect",{x:"1",y:"2",width:"8",height:"16",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"},null,-1),e("rect",{x:"11",y:"2",width:"8",height:"16",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"},null,-1)])])):(A(),L("svg",Mf,[...l[28]||(l[28]=[e("rect",{x:"2",y:"1",width:"16",height:"8",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"},null,-1),e("rect",{x:"2",y:"11",width:"16",height:"8",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"},null,-1)])]))]),e("button",{class:"view-mode-btn",onClick:l[7]||(l[7]=m=>i.$emit("toggle-view-mode")),title:"åˆ‡æ¢è§†å›¾æ¨¡å¼"},[...l[29]||(l[29]=[e("span",{class:"dual-icon"},"â§‰",-1)])]),e("button",{class:Re({active:n.syncEnabled}),onClick:l[8]||(l[8]=m=>i.$emit("toggle-sync")),title:"åŒæ­¥ç¼©æ”¾/æ‹–åŠ¨",style:{"font-size":"12px"}}," ğŸ”— ",2),e("button",{onClick:l[9]||(l[9]=m=>i.$emit("fit-to-screen")),title:"é€‚åº”å±å¹• (åŒå‡»)"},"â›¶"),e("button",{onClick:l[10]||(l[10]=m=>i.$emit("zoom-in")),title:"æ”¾å¤§ (+)"},"+"),e("span",Bf,te(Math.round(n.scale*100))+"%",1),e("button",{onClick:l[11]||(l[11]=m=>i.$emit("zoom-out")),title:"ç¼©å° (-)"},"âˆ’"),e("button",{onClick:l[12]||(l[12]=m=>i.$emit("reset-zoom")),title:"åŸå§‹å¤§å°"},"1:1")]),l[32]||(l[32]=e("div",{class:"toolbar-spacer"},null,-1)),e("button",{class:"secondary-btn",onClick:l[13]||(l[13]=m=>i.$emit("exit-edit-mode"))},"é€€å‡ºç¼–è¾‘")]),e("div",Af,[e("div",Ef,[e("button",{class:"annotation-btn detect-btn",onClick:l[14]||(l[14]=m=>i.$emit("auto-detect-bubbles")),title:"è‡ªåŠ¨æ£€æµ‹å½“å‰å›¾ç‰‡çš„æ–‡æœ¬æ¡†"},[...l[33]||(l[33]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("circle",{cx:"6",cy:"6",r:"4",fill:"none",stroke:"currentColor","stroke-width":"1.5"}),e("path",{d:"M9 9l4 4",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round"})],-1),e("span",null,"æ£€æµ‹",-1)])]),e("button",{class:"annotation-btn detect-btn",onClick:l[15]||(l[15]=m=>i.$emit("detect-all-images")),title:"æ‰¹é‡æ£€æµ‹æ‰€æœ‰å›¾ç‰‡"},[...l[34]||(l[34]=[ho('<svg viewBox="0 0 16 16" width="14" height="14" data-v-d94e5ff3><circle cx="5" cy="5" r="2.5" fill="none" stroke="currentColor" stroke-width="1" data-v-d94e5ff3></circle><path d="M7 7l2 2" stroke="currentColor" stroke-width="1" stroke-linecap="round" data-v-d94e5ff3></path><circle cx="10" cy="10" r="2.5" fill="none" stroke="currentColor" stroke-width="1" data-v-d94e5ff3></circle><path d="M12 12l2 2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" data-v-d94e5ff3></path></svg><span data-v-d94e5ff3>æ‰¹é‡æ£€æµ‹</span>',2)])]),e("button",{class:"annotation-btn primary-action-btn",onClick:l[16]||(l[16]=m=>i.$emit("translate-with-bubbles")),title:"ä½¿ç”¨å½“å‰æ–‡æœ¬æ¡†ç¿»è¯‘æ­¤å›¾ç‰‡"},[...l[35]||(l[35]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("path",{d:"M2 3h5M4.5 3v7M2 6h5",stroke:"currentColor","stroke-width":"1.2",fill:"none"}),e("path",{d:"M9 13l2-7 2 7M9.5 11h3",stroke:"currentColor","stroke-width":"1.2",fill:"none"})],-1),e("span",null,"ç¿»è¯‘",-1)])]),l[42]||(l[42]=e("div",{class:"toolbar-divider"},null,-1)),e("button",{class:Re(["annotation-btn",{active:n.isDrawingMode}]),onClick:l[17]||(l[17]=m=>i.$emit("toggle-drawing-mode")),title:"æ·»åŠ æ°”æ³¡æ¡†ï¼ˆæˆ–ä¸­é”®æ‹–æ‹½ç»˜åˆ¶ï¼‰"},[...l[36]||(l[36]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("rect",{x:"3",y:"3",width:"10",height:"10",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"}),e("path",{d:"M8 5v6M5 8h6",stroke:"currentColor","stroke-width":"1.5"})],-1),e("span",null,"æ·»åŠ ",-1)])],2),e("button",{class:"annotation-btn",disabled:!n.hasSelection,onClick:l[18]||(l[18]=m=>i.$emit("delete-selected-bubbles")),title:"åˆ é™¤é€‰ä¸­æ°”æ³¡æ¡† (Delete)"},[...l[37]||(l[37]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("rect",{x:"3",y:"3",width:"10",height:"10",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"}),e("path",{d:"M5 8h6",stroke:"currentColor","stroke-width":"1.5"})],-1),e("span",null,"åˆ é™¤",-1)])],8,Lf),e("button",{class:Re(["annotation-btn",{"is-loading":n.isRepairLoading}]),disabled:!n.hasSelection||n.isRepairLoading,onClick:l[19]||(l[19]=m=>i.$emit("repair-selected-bubble")),title:"ä¿®å¤é€‰ä¸­æ°”æ³¡èƒŒæ™¯ (R)"},[(A(),L("svg",{viewBox:"0 0 16 16",width:"14",height:"14",class:Re({"spin-icon":n.isRepairLoading})},[...l[38]||(l[38]=[e("path",{d:"M2 14l3-3m0 0l6-6 3 3-6 6m-3 0l-1 1 1-1z",fill:"none",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round"},null,-1),e("path",{d:"M11 5l-1-1 2-2 2 2-2 2-1-1z",fill:"currentColor"},null,-1)])],2)),l[39]||(l[39]=e("span",null,"ä¿®å¤",-1))],10,Ff),l[43]||(l[43]=e("div",{class:"toolbar-divider"},null,-1)),e("button",{class:Re(["annotation-btn brush-btn",{active:n.brushMode==="repair"}]),onClick:l[20]||(l[20]=m=>i.$emit("activate-repair-brush")),title:"ä¿®å¤ç¬”åˆ· (æŒ‰ä½R+å·¦é”®æ‹–æ‹½)"},[...l[40]||(l[40]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("circle",{cx:"8",cy:"8",r:"5",fill:"none",stroke:"currentColor","stroke-width":"1.5"}),e("circle",{cx:"8",cy:"8",r:"2",fill:"currentColor"})],-1),e("span",null,"ä¿®å¤ç¬”åˆ·",-1)])],2),e("button",{class:Re(["annotation-btn brush-btn",{active:n.brushMode==="restore"}]),onClick:l[21]||(l[21]=m=>i.$emit("activate-restore-brush")),title:"è¿˜åŸç¬”åˆ· (æŒ‰ä½U+å·¦é”®æ‹–æ‹½)"},[...l[41]||(l[41]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("circle",{cx:"8",cy:"8",r:"5",fill:"none",stroke:"currentColor","stroke-width":"1.5"}),e("path",{d:"M5 8h6M8 5v6",stroke:"currentColor","stroke-width":"1",transform:"rotate(45 8 8)"})],-1),e("span",null,"è¿˜åŸç¬”åˆ·",-1)])],2),n.brushMode?(A(),L("span",Uf," ç¬”åˆ·: "+te(n.brushSize)+"px ",1)):ce("",!0),l[44]||(l[44]=ho('<div class="help-tooltip-container" data-v-d94e5ff3><button class="help-tooltip-btn" title="å¿«æ·é”®æ“ä½œå¸®åŠ©" data-v-d94e5ff3><svg viewBox="0 0 16 16" width="14" height="14" data-v-d94e5ff3><circle cx="8" cy="8" r="6.5" fill="none" stroke="currentColor" stroke-width="1.2" data-v-d94e5ff3></circle><text x="8" y="11" text-anchor="middle" font-size="9" font-weight="bold" fill="currentColor" data-v-d94e5ff3>?</text></svg><span class="help-btn-text" data-v-d94e5ff3>å¿«æ·é”®</span></button><div class="help-tooltip-popup" data-v-d94e5ff3><div class="help-section" data-v-d94e5ff3><div class="help-title" data-v-d94e5ff3>ğŸ–±ï¸ é¼ æ ‡æ“ä½œ</div><div class="help-item" data-v-d94e5ff3><span class="help-key" data-v-d94e5ff3>å·¦é”®ç‚¹å‡»æ°”æ³¡</span><span class="help-desc" data-v-d94e5ff3>é€‰æ‹©æ°”æ³¡</span></div><div class="help-item" data-v-d94e5ff3><span class="help-key" data-v-d94e5ff3>Shift+å·¦é”®ç‚¹å‡»</span><span class="help-desc" data-v-d94e5ff3>å¤šé€‰æ°”æ³¡</span></div><div class="help-item" data-v-d94e5ff3><span class="help-key" data-v-d94e5ff3>å·¦é”®æ‹–æ‹½å››è§’/è¾¹</span><span class="help-desc" data-v-d94e5ff3>è°ƒæ•´å¤§å°</span></div><div class="help-item" data-v-d94e5ff3><span class="help-key" data-v-d94e5ff3>å·¦é”®æ‹–æ‹½æ¡†å†…éƒ¨</span><span class="help-desc" data-v-d94e5ff3>ç§»åŠ¨æ°”æ³¡æ¡†</span></div><div class="help-item" data-v-d94e5ff3><span class="help-key" data-v-d94e5ff3>ä¸­é”®æ‹–æ‹½</span><span class="help-desc" data-v-d94e5ff3>ç»˜åˆ¶æ–°æ°”æ³¡æ¡†</span></div></div><div class="help-section" data-v-d94e5ff3><div class="help-title" data-v-d94e5ff3>âŒ¨ï¸ å¿«æ·é”®</div><div class="help-item" data-v-d94e5ff3><span class="help-key" data-v-d94e5ff3>A / D</span><span class="help-desc" data-v-d94e5ff3>åˆ‡æ¢ä¸Š/ä¸‹ä¸€å¼ å›¾ç‰‡</span></div><div class="help-item" data-v-d94e5ff3><span class="help-key" data-v-d94e5ff3>Ctrl+Enter</span><span class="help-desc" data-v-d94e5ff3>åº”ç”¨å¹¶è·³è½¬ä¸‹ä¸€å¼ </span></div><div class="help-item" data-v-d94e5ff3><span class="help-key" data-v-d94e5ff3>Delete / Backspace</span><span class="help-desc" data-v-d94e5ff3>åˆ é™¤é€‰ä¸­æ°”æ³¡</span></div><div class="help-item" data-v-d94e5ff3><span class="help-key" data-v-d94e5ff3>æŒ‰ä½R+å·¦é”®æ‹–æ‹½</span><span class="help-desc" data-v-d94e5ff3>ä¿®å¤ç¬”åˆ·</span></div><div class="help-item" data-v-d94e5ff3><span class="help-key" data-v-d94e5ff3>æŒ‰ä½U+å·¦é”®æ‹–æ‹½</span><span class="help-desc" data-v-d94e5ff3>è¿˜åŸç¬”åˆ·</span></div><div class="help-item" data-v-d94e5ff3><span class="help-key" data-v-d94e5ff3>ç¬”åˆ·æ¨¡å¼ä¸‹æ»šè½®</span><span class="help-desc" data-v-d94e5ff3>è°ƒæ•´ç¬”åˆ·å¤§å°</span></div></div></div></div>',1))]),n.brushMode?(A(),L("div",{key:0,class:"brush-cursor",style:ot(a.value)},null,4)):ce("",!0),n.brushMode?(A(),L("div",Of,te(n.brushMode==="repair"?"ä¿®å¤ç¬”åˆ· (R)":"è¿˜åŸç¬”åˆ· (U)")+" - æ»šè½®è°ƒæ•´å¤§å° ",1)):ce("",!0),n.isProcessing?(A(),L("div",{key:2,class:Re(["edit-progress-container",{completed:o.value}])},[e("div",zf,[e("span",Nf,te(n.progressText),1),e("span",Vf,te(n.progressCurrent)+"/"+te(n.progressTotal),1)]),e("div",Wf,[e("div",{class:Re(["edit-progress-fill",{animating:!o.value}]),style:ot({width:s.value+"%"})},null,6)])],2)):ce("",!0),l[45]||(l[45]=e("div",{class:"toolbar-spacer"},null,-1)),e("div",Kf,[e("button",{class:"primary-btn",onClick:l[22]||(l[22]=m=>i.$emit("apply-and-next")),title:"åº”ç”¨æ›´æ”¹å¹¶è·³è½¬ä¸‹ä¸€å¼  (Ctrl+Enter)"}," åº”ç”¨å¹¶ä¸‹ä¸€å¼  ")])])]))}}),Hf=Je(qf,[["__scopeId","data-v-d94e5ff3"]]),jf={key:0,class:"edit-thumbnails-panel"},Jf={class:"thumbnails-scroll"},Yf=["onClick"],Gf=["src","alt"],Xf={class:"thumb-index"},Zf=Ye({__name:"EditThumbnailPanel",props:{visible:{type:Boolean},images:{},currentImageIndex:{}},emits:["switch-to-image"],setup(n){return(t,s)=>n.visible?(A(),L("div",jf,[e("div",Jf,[(A(!0),L(ze,null,Ge(n.images,(o,a)=>(A(),L("div",{key:o.id,class:Re(["edit-thumbnail-item",{active:a===n.currentImageIndex}]),onClick:i=>t.$emit("switch-to-image",a)},[e("img",{src:o.translatedDataURL||o.originalDataURL,alt:`å›¾ç‰‡ ${a+1}`},null,8,Gf),e("span",Xf,te(a+1),1)],10,Yf))),128))])])):ce("",!0)}}),Qf=Je(Zf,[["__scopeId","data-v-9d2a43d9"]]),eb=["data-brush-mode"],tb={class:"edit-main-layout"},ob={class:"image-comparison-container"},nb={class:"panel-header"},sb=["src"],ab={class:"panel-header"},lb=["src"],ib=Ye({__name:"EditWorkspace",props:{isEditModeActive:{type:Boolean}},emits:["exit"],setup(n,{emit:t}){const s=n,o=t,a=Ze(),i=gt(),{translateWithCurrentBubbles:l}=Eo(),{reRenderFullImage:m}=ev({onRenderStart:()=>console.log("å¼€å§‹é‡æ–°æ¸²æŸ“..."),onRenderSuccess:j=>console.log("æ¸²æŸ“æˆåŠŸ:",j.substring(0,50)+"..."),onRenderError:j=>console.error("æ¸²æŸ“å¤±è´¥:",j)}),{isDrawingMode:g,isDrawingBox:u,currentDrawingRect:b,isMiddleButtonDown:_,handleBubbleSelect:S,handleBubbleMultiSelect:R,handleClearMultiSelect:y,handleBubbleDragStart:D,handleBubbleDragging:V,handleBubbleDragEnd:M,handleBubbleResizeStart:B,handleBubbleResizing:v,handleBubbleResizeEnd:p,handleBubbleRotateStart:$,handleBubbleRotating:k,handleBubbleRotateEnd:F,toggleDrawingMode:z,handleDrawBubble:ee,getDrawingRectStyle:J,handleBubbleUpdate:se,deleteSelectedBubbles:O,repairSelectedBubble:Q,handleOcrRecognize:ae}=Qm({onReRender:()=>m(),onDelayedPreview:()=>m()}),U=w(0),r=w(0),{brushMode:d,brushSize:f,mouseX:C,mouseY:x,isBrushKeyDown:P,toggleBrushMode:I,exitBrushMode:E,startBrushPainting:K,continueBrushPainting:G,finishBrushPainting:c,adjustBrushSize:h}=Xm({onBrushComplete:()=>m(),getCurrentRepairSettings:()=>({inpaintMethod:q.value,fillColor:ie.value})}),{images:le,currentImageIndex:N,currentImage:X,imageCount:pe,canGoPrevious:ye,canGoNext:_e}=yt(a),{bubbles:$e,selectedIndex:De,selectedIndices:re,selectedBubble:T,bubbleCount:Z,hasBubbles:he,hasSelection:me}=yt(i),xe=Y(()=>X.value?.width||0),W=Y(()=>X.value?.height||0);function ne(){const j=Me.value?.querySelector("img");j&&j.naturalWidth>0&&j.naturalHeight>0&&a.updateCurrentImageDimensions(j.naturalWidth,j.naturalHeight)}const ve=w(null),fe=w(null),Me=w(null),Ne=w(null),Ue=w(null),we=w(null),Ae=w("dual"),Ie=w("horizontal"),tt=w(!1),Ke=w(!0),lt=w(!1),Te=w(!1),q=w("solid"),ie=w("#FFFFFF"),be=w(!1),We=w("å¤„ç†ä¸­..."),rt=w(0),Kt=w(0),Pt=w(!1),Rt=w(!1),Dt=w(!1),st=kn(),Qe=kn(),Mt=Y(()=>Qe.scale.value),Bt=Y(()=>Qe.translateX.value),at=Y(()=>Qe.translateY.value),Yn=Y(()=>st.scale.value),bt=w(null),Gn=Y(()=>({transform:`translate(${st.translateX.value}px, ${st.translateY.value}px) scale(${st.scale.value})`})),Xn=Y(()=>({transform:`translate(${Qe.translateX.value}px, ${Qe.translateY.value}px) scale(${Qe.scale.value})`}));function Lo(){Qe.zoomIn(),Ke.value&&st.setTransform(Qe.getTransform())}function Fo(){Qe.zoomOut(),Ke.value&&st.setTransform(Qe.getTransform())}function Uo(){Qe.resetZoom(),Ke.value&&st.setTransform(Qe.getTransform())}const to=w(!1),Zn=w(0),oo=w(!1),At=w({x:0,y:0,size:0});function no(){d.value&&E(),lo()}function so(){i.bubbles.length>0&&i.selectBubble(0)}function Oo(){ye.value&&(no(),a.goToPrevious())}function ao(){_e.value&&(no(),a.goToNext())}function Qn(j){j!==N.value&&j>=0&&j<pe.value&&(no(),a.setCurrentImageIndex(j))}function lo(){if(!X.value)return;const j=Array.isArray(X.value.bubbleStates);$e.value.length>0?(a.updateCurrentBubbleStates([...$e.value]),a.setManuallyAnnotated(!0),console.log("å·²ä¿å­˜æ°”æ³¡çŠ¶æ€åˆ°å½“å‰å›¾ç‰‡ï¼Œæ ‡è®°ä¸ºæ‰‹åŠ¨æ ‡æ³¨")):j&&(a.updateCurrentBubbleStates([]),a.setManuallyAnnotated(!0),console.log("å·²ä¿å­˜ç©ºæ°”æ³¡çŠ¶æ€åˆ°å½“å‰å›¾ç‰‡ï¼ˆç”¨æˆ·ä¸»åŠ¨æ¸…ç©ºï¼Œæ ‡è®°ä¸ºæ‰‹åŠ¨æ ‡æ³¨ï¼‰"))}function Et(){X.value?.bubbleStates?(i.setBubbles([...X.value.bubbleStates],!0),console.log(`å·²åŠ è½½ ${X.value.bubbleStates.length} ä¸ªæ°”æ³¡çŠ¶æ€`)):i.clearBubblesLocal(),so()}function es(){i.selectPrevious()}function ts(){i.selectNext()}function os(){tt.value=!tt.value}function ns(){Ie.value=Ie.value==="horizontal"?"vertical":"horizontal";try{localStorage.setItem(rn,Ie.value)}catch(j){console.warn("ä¿å­˜å¸ƒå±€æ¨¡å¼å¤±è´¥:",j)}setTimeout(()=>{Lt()},300)}function ss(){const j=["dual","original","translated"],ue=j.indexOf(Ae.value),ge=j[(ue+1)%j.length];ge&&(Ae.value=ge)}function as(){Ke.value=!Ke.value,console.log("åŒå›¾åŒæ­¥:",Ke.value?"å¼€å¯":"å…³é—­"),Ke.value&&st.setTransform(Qe.getTransform())}function Lt(){const j=Ne.value||fe.value,ue=Ue.value||Me.value;if(!j||!ue)return;const ge=ue.querySelector("img");if(!ge||!ge.naturalWidth)return;const Le=j.getBoundingClientRect(),Be=Le.width/ge.naturalWidth,Fe=Le.height/ge.naturalHeight,qe=Math.min(Be,Fe)*.95,je=(Le.width-ge.naturalWidth*qe)/2,ht=(Le.height-ge.naturalHeight*qe)/2,Ct={scale:qe,translateX:je,translateY:ht};Qe.setTransform(Ct),st.setTransform(Ct)}function zo(j,ue){if(d.value){const je=j.deltaY>0?-5:5;h(je);return}const ge=j.currentTarget.getBoundingClientRect(),Le=j.clientX-ge.left,Be=j.clientY-ge.top,Fe=j.deltaY>0?.9:1.1,qe=ue==="original"?st:Qe;qe.zoomAt(Le,Be,Fe),Ke.value&&(ue==="original"?Qe:st).setTransform(qe.getTransform())}function No(j,ue){if(d.value){const ge=ue==="original"?fe.value:Ne.value;ge&&K(j,ge);return}if(j.button===1){_.value=!0,Ko(j,ue),j.preventDefault();return}if(g.value&&j.button===0){Ko(j,ue),j.preventDefault();return}if(j.button===0){if(j.target.closest(".bubble-highlight-box"))return;j.shiftKey||y(),bt.value=ue,(ue==="original"?st:Qe).startDrag(j.clientX,j.clientY),document.addEventListener("mousemove",Vo),document.addEventListener("mouseup",Wo),j.preventDefault()}}function Vo(j){if(!bt.value)return;const ue=bt.value==="original"?st:Qe;ue.drag(j.clientX,j.clientY),Ke.value&&(bt.value==="original"?Qe:st).setTransform(ue.getTransform())}function Wo(){bt.value&&(bt.value==="original"?st:Qe).endDrag(),bt.value=null,document.removeEventListener("mousemove",Vo),document.removeEventListener("mouseup",Wo)}let io="translated";function Ko(j,ue="translated"){io=ue;const ge=ue==="original"?Me.value:Ue.value,Le=ue==="original"?st:Qe;if(!ge)return;const Be=ge.getBoundingClientRect(),Fe=(j.clientX-Be.left)/Le.scale.value,qe=(j.clientY-Be.top)/Le.scale.value;U.value=Fe,r.value=qe,u.value=!0,b.value=[Fe,qe,Fe,qe],document.addEventListener("mousemove",ro),document.addEventListener("mouseup",uo)}function ro(j){if(!u.value)return;const ue=io==="original"?Me.value:Ue.value,ge=io==="original"?st:Qe;if(!ue)return;const Le=ue.getBoundingClientRect(),Be=(j.clientX-Le.left)/ge.scale.value,Fe=(j.clientY-Le.top)/ge.scale.value;b.value=[Math.min(U.value,Be),Math.min(r.value,Fe),Math.max(U.value,Be),Math.max(r.value,Fe)]}function uo(j){document.removeEventListener("mousemove",ro),document.removeEventListener("mouseup",uo);const ue=_.value;if(!u.value||!b.value){u.value=!1,b.value=null,_.value=!1;return}const[ge,Le,Be,Fe]=b.value,qe=Be-ge,je=Fe-Le;qe>10&&je>10&&(i.addBubble(b.value),i.selectBubble(i.bubbleCount-1),console.log("å·²æ·»åŠ æ–°æ°”æ³¡:",b.value)),u.value=!1,b.value=null,_.value=!1,!ue&&g.value&&(g.value=!1)}function qo(j){console.log(`${j} å›¾ç‰‡åŠ è½½å®Œæˆ`),j==="original"&&ne(),Mt.value===1&&Bt.value===0&&at.value===0&&pt(()=>{Lt()})}function ls(){m()}function is(j){j.inpaintMethod!==void 0&&(q.value=j.inpaintMethod),j.fillColor!==void 0&&(ie.value=j.fillColor),De.value>=0&&se(j)}function rs(j){Ce("æ–‡æœ¬å·²åº”ç”¨","success"),m()}function us(j){const ue=i.initialStates[j];if(!ue){console.warn(`æ— æ³•é‡ç½®æ°”æ³¡ #${j+1}ï¼šæ‰¾ä¸åˆ°åˆå§‹çŠ¶æ€`),Ce("æ— æ³•é‡ç½®ï¼šæ‰¾ä¸åˆ°åˆå§‹çŠ¶æ€","warning");return}const ge=JSON.parse(JSON.stringify(ue));i.updateBubble(j,ge),console.log(`æ°”æ³¡ #${j+1} å·²é‡ç½®åˆ°åˆå§‹çŠ¶æ€`),Ce("æ°”æ³¡å·²é‡ç½®","success"),m()}async function cs(j){Pt.value=!0;try{await ae(j)}finally{Pt.value=!1}}async function ds(){Dt.value=!0;try{await Q()}finally{Dt.value=!1}}async function gs(j){const ue=$e.value[j];if(!ue?.originalText){console.warn("æ— æ³•é‡æ–°ç¿»è¯‘ï¼šç¼ºå°‘æ°”æ³¡æˆ–åŸæ–‡");return}Rt.value=!0;try{console.log(`å¼€å§‹é‡æ–°ç¿»è¯‘æ°”æ³¡ #${j+1}`);const{translateSingleText:ge}=await it(async()=>{const{translateSingleText:je}=await Promise.resolve().then(()=>Gs);return{translateSingleText:je}},void 0),{useSettingsStore:Le}=await it(async()=>{const{useSettingsStore:je}=await Promise.resolve().then(()=>xo);return{useSettingsStore:je}},void 0),Be=Le().settings,Fe=Be.translation.isJsonMode?Be.translation.singleJsonPrompt:Be.translation.singleNormalPrompt,qe=await ge({original_text:ue.originalText,model_provider:Be.translation.provider,api_key:Be.translation.apiKey,model_name:Be.translation.modelName,custom_base_url:Be.translation.customBaseUrl,target_language:Be.targetLanguage,prompt_content:Fe,use_json_format:Be.translation.isJsonMode,rpm_limit_translation:Be.translation.rpmLimit,max_retries:Be.translation.maxRetries});qe.success&&qe.data?.translated_text?(i.updateBubble(j,{translatedText:qe.data.translated_text}),console.log(`ç¿»è¯‘æˆåŠŸ: "${qe.data.translated_text}"`),m()):console.error("ç¿»è¯‘å¤±è´¥:",qe.error||"æœªçŸ¥é”™è¯¯")}catch(ge){console.error("ç¿»è¯‘å‡ºé”™:",ge)}finally{Rt.value=!1}}function Ho(j,ue){for(j.bubbleTexts||(j.bubbleTexts=[]),j.originalTexts||(j.originalTexts=[]);j.bubbleTexts.length<ue;)j.bubbleTexts.push("");for(;j.originalTexts.length<ue;)j.originalTexts.push("")}function jo(j,ue,ge){const Le=j.auto_directions||[];return j.bubble_coords.map((Be,Fe)=>{const qe=Be[0]??0,je=Be[1]??0,ht=Be[2]??0,Ct=Be[3]??0;let _t;return Le[Fe]?_t=Le[Fe]==="v"?"vertical":"horizontal":_t=Ct-je>ht-qe?"vertical":"horizontal",{coords:Be,originalText:ue.originalTexts?.[Fe]||"",translatedText:ue.bubbleTexts?.[Fe]||"",textboxText:"",fontSize:ge.fontSize,fontFamily:ge.fontFamily,textDirection:_t,autoTextDirection:_t,textColor:ge.textColor,fillColor:ge.fillColor,strokeEnabled:ge.strokeEnabled,strokeColor:ge.strokeColor,strokeWidth:ge.strokeWidth,rotationAngle:j.bubble_angles?.[Fe]||0,inpaintMethod:ge.inpaintMethod,position:{x:0,y:0},polygon:[]}})}async function ps(){const j=X.value;if(!j?.originalDataURL){Ce("æ²¡æœ‰æœ‰æ•ˆçš„å›¾ç‰‡ç”¨äºæ£€æµ‹","warning");return}try{Ce("æ­£åœ¨è‡ªåŠ¨æ£€æµ‹æ–‡æœ¬æ¡†...","info");const ue=Ee(),{textStyle:ge}=ue.settings,Le=await zt({imageIndex:N.value,image:j,forceDetect:!0});if(Le.bubbleCoords.length>0){yo(N.value,Le),Ho(j,Le.bubbleCoords.length);const Be={bubble_coords:Le.bubbleCoords,bubble_angles:Le.bubbleAngles,auto_directions:Le.autoDirections},Fe=jo(Be,j,ge);i.setBubbles(Fe),so(),Ce(`è‡ªåŠ¨æ£€æµ‹åˆ° ${Le.bubbleCoords.length} ä¸ªæ–‡æœ¬æ¡†`,"success")}else Ce("æœªæ£€æµ‹åˆ°æ–‡æœ¬æ¡†","info")}catch(ue){console.error("è‡ªåŠ¨æ£€æµ‹å¤±è´¥:",ue),Ce("è‡ªåŠ¨æ£€æµ‹å¤±è´¥","error")}}async function ms(){if(le.value.length<=1){Ce("è‡³å°‘éœ€è¦ä¸¤å¼ å›¾ç‰‡æ‰èƒ½æ‰§è¡Œæ‰¹é‡æ£€æµ‹","warning");return}if(!confirm("æ­¤æ“ä½œå°†å¯¹æ‰€æœ‰å›¾ç‰‡è¿›è¡Œæ–‡æœ¬æ¡†æ£€æµ‹ï¼Œå¯èƒ½ä¼šè¦†ç›–å·²æœ‰çš„æ£€æµ‹ç»“æœã€‚ç¡®å®šç»§ç»­å—ï¼Ÿ"))return;const j=Ee(),{textStyle:ue}=j.settings,ge=N.value,Le=le.value.length;be.value=!0,We.value="æ‰¹é‡æ£€æµ‹ä¸­",Kt.value=Le,rt.value=0;try{let Be=0;for(let Fe=0;Fe<Le;Fe++){const qe=le.value[Fe];if(qe?.originalDataURL){rt.value=Fe+1;try{const je=await zt({imageIndex:Fe,image:qe,forceDetect:!0});if(je.bubbleCoords.length>0){const ht=le.value[Fe];if(ht){Ho(ht,je.bubbleCoords.length);const Ct={bubble_coords:je.bubbleCoords,bubble_angles:je.bubbleAngles,auto_directions:je.autoDirections},_t=jo(Ct,ht,ue);yo(Fe,je,{updateBubbleStates:!0,bubbleStates:_t}),Be+=je.bubbleCoords.length,Fe===N.value&&Et()}}}catch(je){console.error(`å›¾ç‰‡ ${Fe+1} æ£€æµ‹å¤±è´¥:`,je)}}}We.value="æ£€æµ‹å®Œæˆ",rt.value=Le,ge!==N.value&&a.setCurrentImageIndex(ge),Et(),Ce(`æ‰¹é‡æ£€æµ‹å®Œæˆï¼å…±å¤„ç† ${Le} å¼ å›¾ç‰‡ï¼Œæ£€æµ‹åˆ° ${Be} ä¸ªæ–‡æœ¬æ¡†`,"success"),setTimeout(()=>{be.value=!1},2e3)}catch(Be){console.error("æ‰¹é‡æ£€æµ‹å¤±è´¥:",Be),Ce("æ‰¹é‡æ£€æµ‹å¤±è´¥","error"),be.value=!1}}async function vs(){if(!X.value?.originalDataURL){Ce("æ²¡æœ‰æœ‰æ•ˆçš„å›¾ç‰‡ç”¨äºç¿»è¯‘","warning");return}if($e.value.length===0){Ce("æ²¡æœ‰æ–‡æœ¬æ¡†å¯ç”¨äºç¿»è¯‘ï¼Œè¯·å…ˆæ£€æµ‹æˆ–æ·»åŠ æ–‡æœ¬æ¡†","warning");return}Ce("æ­£åœ¨ä½¿ç”¨å½“å‰æ–‡æœ¬æ¡†ç¿»è¯‘...","info");try{await l()&&(Ce("ç¿»è¯‘æˆåŠŸï¼","success"),so())}catch(ue){console.error("ç¿»è¯‘å¤±è´¥:",ue),Ce(`ç¿»è¯‘å¤±è´¥: ${ue instanceof Error?ue.message:"æœªçŸ¥é”™è¯¯"}`,"error")}}function fs(){I("repair")}function bs(){I("restore")}function Jo(j){G(j)}function Yo(){c()}function hs(j){to.value=!0,Zn.value=Ie.value==="horizontal"?j.clientX:j.clientY,document.body.style.cursor=Ie.value==="horizontal"?"col-resize":"row-resize",document.body.style.userSelect="none",document.addEventListener("mousemove",co),document.addEventListener("mouseup",go),j.preventDefault()}function co(j){if(!to.value)return;const ue=fe.value?.parentElement?.parentElement;if(!ue)return;const ge=ue.getBoundingClientRect();if(Ie.value==="horizontal"){const Le=j.clientX-ge.left,Be=ge.width,Fe=Math.max(20,Math.min(80,Le/Be*100)),qe=ue.querySelector(".original-panel"),je=ue.querySelector(".translated-panel");qe&&je&&(qe.style.flex=`0 0 ${Fe}%`,je.style.flex=`0 0 ${100-Fe}%`)}else{const Le=j.clientY-ge.top,Be=ge.height,Fe=Math.max(20,Math.min(80,Le/Be*100)),qe=ue.querySelector(".original-panel"),je=ue.querySelector(".translated-panel");qe&&je&&(qe.style.flex=`0 0 ${Fe}%`,je.style.flex=`0 0 ${100-Fe}%`)}}function go(){to.value=!1,document.body.style.cursor="",document.body.style.userSelect="",document.removeEventListener("mousemove",co),document.removeEventListener("mouseup",go)}function xs(j){oo.value=!0;const ue=we.value;ue&&(At.value={x:j.clientX,y:j.clientY,size:Ie.value==="horizontal"?ue.offsetWidth:ue.offsetHeight},document.body.style.cursor=Ie.value==="horizontal"?"ew-resize":"ns-resize",document.body.style.userSelect="none",document.addEventListener("mousemove",po),document.addEventListener("mouseup",mo),j.preventDefault())}function po(j){if(!(!oo.value||!we.value))if(Ie.value==="horizontal"){const ue=At.value.x-j.clientX;let ge=At.value.size+ue;ge=Math.max(300,Math.min(window.innerWidth*.6,ge)),we.value.style.flex=`0 0 ${ge}px`,we.value.style.minWidth=`${ge}px`}else{const ue=At.value.y-j.clientY;let ge=At.value.size+ue;ge=Math.max(200,Math.min(window.innerHeight*.5,ge)),we.value.style.flex=`0 0 ${ge}px`,we.value.style.height=`${ge}px`}}function mo(){oo.value=!1,document.body.style.cursor="",document.body.style.userSelect="",document.removeEventListener("mousemove",po),document.removeEventListener("mouseup",mo)}function Go(j){const ue=j.target,ge=j.key.toLowerCase();if(ge==="r"||ge==="u"||ge==="a"||ge==="d"){if(ue.tagName==="TEXTAREA")return;(ue.tagName==="INPUT"||ue.tagName==="SELECT"||ue.tagName==="BUTTON")&&ue.blur()}else if(ue.tagName==="INPUT"||ue.tagName==="TEXTAREA"||ue.tagName==="SELECT")return;switch(j.key){case"Escape":Qo();break;case"Delete":case"Backspace":!d.value&&me.value&&(O(),j.preventDefault());break;case"a":case"A":d.value||(Oo(),j.preventDefault());break;case"d":case"D":d.value||(ao(),j.preventDefault());break;case"Enter":j.ctrlKey&&!d.value&&(Zo(),j.preventDefault());break;case"r":case"R":P.value||(I("repair"),j.preventDefault());break;case"u":case"U":P.value||(I("restore"),j.preventDefault());break;case"+":case"=":Lo(),j.preventDefault();break;case"-":Fo(),j.preventDefault();break;case"0":Uo(),j.preventDefault();break}}function Xo(j){(j.key==="r"||j.key==="R"||j.key==="u"||j.key==="U")&&(E(),j.preventDefault())}async function Zo(){lo(),await m(),_e.value?ao():Ce("å·²æ˜¯æœ€åä¸€å¼ å›¾ç‰‡","info")}function Qo(){lo(),o("exit")}return Rs((j,ue,ge)=>{console.error("[EditWorkspace] æ•è·åˆ°é”™è¯¯:",j,ge);const Le=j instanceof Error?j.message:"æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•";return Ce(Le,"error"),!1}),dt(()=>{try{const j=localStorage.getItem(rn);(j==="horizontal"||j==="vertical")&&(Ie.value=j)}catch(j){console.warn("åŠ è½½å¸ƒå±€æ¨¡å¼å¤±è´¥:",j)}document.addEventListener("keydown",Go),document.addEventListener("keyup",Xo),document.addEventListener("mousemove",Jo),document.addEventListener("mouseup",Yo),s.isEditModeActive&&(Et(),pt(()=>{ve.value?.focus()}))}),Wt(()=>{document.removeEventListener("keydown",Go),document.removeEventListener("keyup",Xo),document.removeEventListener("mousemove",Jo),document.removeEventListener("mouseup",Yo),document.removeEventListener("mousemove",ro),document.removeEventListener("mouseup",uo),document.removeEventListener("mousemove",co),document.removeEventListener("mouseup",go),document.removeEventListener("mousemove",po),document.removeEventListener("mouseup",mo)}),Se(()=>s.isEditModeActive,j=>{j&&(Et(),pt(()=>{ve.value?.focus(),ne()}))}),Se(N,()=>{s.isEditModeActive&&Et()}),Se(T,j=>{j&&(q.value=j.inpaintMethod||"solid",ie.value=j.fillColor||"#FFFFFF")},{immediate:!0}),(j,ue)=>n.isEditModeActive?(A(),L("div",{key:0,class:Re(["edit-workspace",[`layout-${Ie.value}`,{"drawing-mode":H(g)},{"brush-mode-active":!!H(d)}]]),"data-brush-mode":H(d)||void 0,tabindex:"0",ref_key:"workspaceRef",ref:ve},[ke(Hf,{"current-image-index":H(N),"image-count":H(pe),"can-go-previous":H(ye),"can-go-next":H(_e),"show-thumbnails":tt.value,"has-bubbles":H(he),"selected-bubble-index":H(De),"bubble-count":H(Z),"layout-mode":Ie.value,"sync-enabled":Ke.value,scale:Mt.value,"is-drawing-mode":H(g),"has-selection":H(me),"brush-mode":H(d),"brush-size":H(f),"mouse-x":H(C),"mouse-y":H(x),"is-processing":be.value,"progress-text":We.value,"progress-current":rt.value,"progress-total":Kt.value,"is-repair-loading":Dt.value,onGoPreviousImage:Oo,onGoNextImage:ao,onToggleThumbnails:os,onSelectPreviousBubble:es,onSelectNextBubble:ts,onToggleLayout:ns,onToggleViewMode:ss,onToggleSync:as,onFitToScreen:Lt,onZoomIn:Lo,onZoomOut:Fo,onResetZoom:Uo,onExitEditMode:Qo,onAutoDetectBubbles:ps,onDetectAllImages:ms,onTranslateWithBubbles:vs,onToggleDrawingMode:H(z),onDeleteSelectedBubbles:H(O),onRepairSelectedBubble:ds,onActivateRepairBrush:fs,onActivateRestoreBrush:bs,onApplyAndNext:Zo},null,8,["current-image-index","image-count","can-go-previous","can-go-next","show-thumbnails","has-bubbles","selected-bubble-index","bubble-count","layout-mode","sync-enabled","scale","is-drawing-mode","has-selection","brush-mode","brush-size","mouse-x","mouse-y","is-processing","progress-text","progress-current","progress-total","is-repair-loading","onToggleDrawingMode","onDeleteSelectedBubbles"]),ke(Qf,{visible:tt.value,images:H(le),"current-image-index":H(N),onSwitchToImage:Qn},null,8,["visible","images","current-image-index"]),e("div",tb,[e("div",ob,[oe(e("div",{class:Re(["image-panel original-panel",{collapsed:Ae.value==="translated"||lt.value}])},[e("div",nb,[ue[8]||(ue[8]=e("span",{class:"panel-title"},"ğŸ“– åŸå›¾ (æ—¥æ–‡)",-1)),e("button",{class:"panel-toggle",onClick:ue[0]||(ue[0]=ge=>lt.value=!lt.value),title:"æŠ˜å /å±•å¼€"},te(lt.value?"+":"âˆ’"),1)]),e("div",{ref_key:"originalViewportRef",ref:fe,class:"image-viewport",onWheel:ue[2]||(ue[2]=nt(ge=>zo(ge,"original"),["prevent"])),onMousedown:ue[3]||(ue[3]=ge=>No(ge,"original")),onDblclick:Lt},[e("div",{ref_key:"originalWrapperRef",ref:Me,class:"image-canvas-wrapper",style:ot(Gn.value)},[H(X)?.originalDataURL?(A(),L("img",{key:0,src:H(X).originalDataURL,alt:"åŸå›¾",onLoad:ue[1]||(ue[1]=ge=>qo("original"))},null,40,sb)):ce("",!0),H(X)?.originalDataURL?(A(),ut(wn,{key:1,bubbles:H($e),"selected-index":H(De),"selected-indices":H(re),scale:Yn.value,"is-drawing-mode":H(g),"is-brush-mode":!!H(d),"image-width":xe.value,"image-height":W.value,onSelect:H(S),onMultiSelect:H(R),onDragStart:H(D),onDragging:H(V),onDragEnd:H(M),onResizeStart:H(B),onResizing:H(v),onResizeEnd:H(p),onRotateStart:H($),onRotating:H(k),onRotateEnd:H(F),onDrawBubble:H(ee)},null,8,["bubbles","selected-index","selected-indices","scale","is-drawing-mode","is-brush-mode","image-width","image-height","onSelect","onMultiSelect","onDragStart","onDragging","onDragEnd","onResizeStart","onResizing","onResizeEnd","onRotateStart","onRotating","onRotateEnd","onDrawBubble"])):ce("",!0),H(b)?(A(),L("div",{key:2,class:"drawing-rect-edit",style:ot(H(J)())},null,4)):ce("",!0)],4)],544)],2),[[Oe,Ae.value!=="translated"]]),Ae.value==="dual"?(A(),L("div",{key:0,class:Re(["panel-divider",{"vertical-divider":Ie.value==="vertical"}]),onMousedown:hs},null,34)):ce("",!0),oe(e("div",{class:Re(["image-panel translated-panel",{collapsed:Ae.value==="original"||Te.value}])},[e("div",ab,[ue[9]||(ue[9]=e("span",{class:"panel-title"},"ğŸ“ ç¿»è¯‘å›¾ (ä¸­æ–‡)",-1)),e("button",{class:"panel-toggle",onClick:ue[4]||(ue[4]=ge=>Te.value=!Te.value),title:"æŠ˜å /å±•å¼€"},te(Te.value?"+":"âˆ’"),1)]),e("div",{ref_key:"translatedViewportRef",ref:Ne,class:"image-viewport",onWheel:ue[6]||(ue[6]=nt(ge=>zo(ge,"translated"),["prevent"])),onMousedown:ue[7]||(ue[7]=ge=>No(ge,"translated")),onDblclick:Lt},[e("div",{ref_key:"translatedWrapperRef",ref:Ue,class:"image-canvas-wrapper",style:ot(Xn.value)},[H(X)?.translatedDataURL||H(X)?.originalDataURL?(A(),L("img",{key:0,src:H(X)?.translatedDataURL||H(X)?.originalDataURL,alt:"ç¿»è¯‘å›¾",onLoad:ue[5]||(ue[5]=ge=>qo("translated"))},null,40,lb)):ce("",!0),H(X)?.translatedDataURL||H(X)?.originalDataURL?(A(),ut(wn,{key:1,bubbles:H($e),"selected-index":H(De),"selected-indices":H(re),scale:Mt.value,"is-drawing-mode":H(g),"is-brush-mode":!!H(d),"image-width":xe.value,"image-height":W.value,onSelect:H(S),onMultiSelect:H(R),onDragStart:H(D),onDragging:H(V),onDragEnd:H(M),onResizeStart:H(B),onResizing:H(v),onResizeEnd:H(p),onRotateStart:H($),onRotating:H(k),onRotateEnd:H(F),onDrawBubble:H(ee)},null,8,["bubbles","selected-index","selected-indices","scale","is-drawing-mode","is-brush-mode","image-width","image-height","onSelect","onMultiSelect","onDragStart","onDragging","onDragEnd","onResizeStart","onResizing","onResizeEnd","onRotateStart","onRotating","onRotateEnd","onDrawBubble"])):ce("",!0),H(b)?(A(),L("div",{key:2,class:"drawing-rect-edit translated-drawing-rect",style:ot(H(J)())},null,4)):ce("",!0)],4)],544)],2),[[Oe,Ae.value!=="original"]])]),e("div",{ref_key:"editPanelRef",ref:we,class:"edit-panel-container"},[e("div",{class:"panel-resize-handle vertical",onMousedown:xs}," â‹®â‹®â‹® ",32),ke(hf,{bubble:H(T),"bubble-index":H(De),"is-ocr-loading":Pt.value,"is-translate-loading":Rt.value,onUpdate:is,onReRender:ls,onOcrRecognize:cs,onReTranslate:gs,onApplyBubble:rs,onResetCurrent:us},null,8,["bubble","bubble-index","is-ocr-loading","is-translate-loading"])],512)])],10,eb)):ce("",!0)}}),rb=Je(ib,[["__scopeId","data-v-ccf7fa16"]]),It="/api/web-import";async function ub(n){return(await fetch(`${It}/check-support?url=${encodeURIComponent(n)}`)).json()}async function cb(){return(await fetch(`${It}/gallery-dl-images`)).json()}async function db(n,t,s,o,a,i="auto",l){const m=await fetch(`${It}/extract`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:n,config:t,engine:i})});if(!m.ok){const _=await m.json().catch(()=>({error:"è¯·æ±‚å¤±è´¥"}));a(_.error||`HTTP ${m.status}`);return}const g=m.body?.getReader();if(!g){a("æ— æ³•è¯»å–å“åº”æµ");return}const u=new TextDecoder;let b="";try{for(;;){const{done:_,value:S}=await g.read();if(_)break;b+=u.decode(S,{stream:!0});const R=b.split(`
`);b=R.pop()||"";let y="",D="";for(const V of R)if(V.startsWith("event:"))y=V.slice(6).trim();else if(V.startsWith("data:"))D=V.slice(5).trim();else if(V===""&&y&&D){try{const M=JSON.parse(D);y==="log"?s(M):y==="page"?l&&l(M):y==="result"?o(M):y==="error"&&a(M.error||"æœªçŸ¥é”™è¯¯")}catch(M){console.error("è§£æ SSE æ•°æ®å¤±è´¥:",M)}y="",D=""}}}finally{g.releaseLock()}}async function gb(n,t,s,o="ai-agent"){const a=await fetch(`${It}/download`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({pages:n,sourceUrl:t,config:s,engine:o})});if(!a.ok){const i=await a.json().catch(()=>({error:"è¯·æ±‚å¤±è´¥"}));throw new Error(i.error||`HTTP ${a.status}`)}return a.json()}async function pb(n){return(await fetch(`${It}/test-firecrawl`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({apiKey:n})})).json()}async function mb(n,t,s,o){return(await fetch(`${It}/test-agent`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({provider:n,apiKey:t,customBaseUrl:s,modelName:o})})).json()}const vb={class:"modal-container"},fb={class:"modal-body"},bb={class:"url-section"},hb=["disabled"],xb=["disabled"],yb=["disabled"],Cb={key:0,class:"loading-spinner"},_b={key:1},kb={key:0,class:"engine-hint"},Sb={key:0,class:"hint-checking"},wb={key:1,class:"hint-supported"},$b={key:2,class:"hint-unsupported"},Tb={class:"settings-section"},Ib={class:"settings-toggle"},Pb={key:0,class:"settings-content"},Rb={class:"settings-tabs"},Db={class:"settings-tab-content"},Mb={class:"settings-group"},Bb={class:"form-row"},Ab={class:"input-group"},Eb=["type","value"],Lb=["disabled"],Fb={class:"settings-group"},Ub={class:"form-row"},Ob=["value"],zb=["value"],Nb={class:"form-row"},Vb={class:"input-group"},Wb=["type","value"],Kb={key:0,class:"form-row"},qb=["value"],Hb={class:"form-row"},jb=["value"],Jb={class:"form-row inline"},Yb={class:"checkbox-label"},Gb=["checked"],Xb={class:"checkbox-label"},Zb=["checked"],Qb={class:"form-row"},eh=["disabled"],th={class:"settings-group"},oh={class:"form-row"},nh=["value"],sh={class:"form-row"},ah=["value"],lh={class:"settings-group"},ih={class:"form-grid"},rh={class:"form-row"},uh=["value"],ch={class:"form-row"},dh=["value"],gh={class:"form-row"},ph=["value"],mh={class:"form-row"},vh=["value"],fh={class:"form-row"},bh={class:"checkbox-label"},hh=["checked"],xh={class:"settings-group"},yh={class:"form-row inline"},Ch={class:"checkbox-label"},_h=["checked"],kh={class:"checkbox-label"},Sh=["checked"],wh={class:"settings-tab-content"},$h={class:"settings-group"},Th={class:"form-row"},Ih={class:"checkbox-label"},Ph=["checked"],Rh={class:"form-row"},Dh={class:"checkbox-label"},Mh=["checked"],Bh={class:"form-row"},Ah={class:"checkbox-label"},Eh=["checked"],Lh={key:0,class:"form-grid"},Fh={class:"form-row"},Uh=["value"],Oh={class:"form-row"},zh=["value"],Nh={class:"form-row"},Vh=["value"],Wh={class:"form-row"},Kh={class:"checkbox-label"},qh=["checked"],Hh={key:1,class:"form-row"},jh=["value"],Jh={class:"settings-tab-content"},Yh={class:"settings-group"},Gh={class:"form-row"},Xh=["value"],Zh={class:"form-row"},Qh=["value"],ex={class:"form-row"},tx={class:"checkbox-label"},ox=["checked"],nx={key:1,class:"logs-section"},sx={class:"logs-toggle"},ax={key:0,class:"extracting-hint"},lx={key:0,class:"logs-content"},ix={class:"log-time"},rx={class:"log-message"},ux={key:2,class:"error-section"},cx={class:"error-message"},dx={key:3,class:"result-section"},gx={class:"result-header"},px={class:"result-title"},mx={class:"result-meta"},vx={class:"result-count"},fx={key:0,class:"result-engine"},bx={class:"select-control"},hx={class:"select-all"},xx=["checked"],yx={class:"selected-count"},Cx={class:"image-grid"},_x=["onClick"],kx={class:"image-checkbox"},Sx=["checked","onChange"],wx={class:"image-preview"},$x=["src","alt"],Tx={class:"image-label"},Ix={key:4,class:"progress-section"},Px={class:"progress-label"},Rx={class:"progress-bar"},Dx={class:"modal-footer"},Mx=["disabled"],Bx=["disabled"],Ax={key:0,class:"loading-spinner"},Ex={key:1},Lx=Ye({__name:"WebImportModal",setup(n){const t=Io(),s=Ze(),o=w(""),a=w(!0),i=w("auto"),l=w(!1),m=w(!1),g=w(!1),u=w(!1),b=w("basic"),_=w(!1),S=w(!1),R=w(!1),y=w(!1),D=Y(()=>t.modalVisible),V=Y(()=>t.status),M=Y(()=>t.logs),B=Y(()=>t.extractResult),v=Y(()=>t.selectedPages),p=Y(()=>t.selectedCount),$=Y(()=>t.downloadProgress),k=Y(()=>t.downloadProgressPercent),F=Y(()=>t.error),z=Y(()=>t.isProcessing),ee=Y(()=>t.settings.ui.showAgentLogs),J=Y(()=>B.value?.engine||null),se=Y(()=>{switch(J.value){case"gallery-dl":return"Gallery-DL";case"ai-agent":return"AI Agent";default:return""}}),O=Y(()=>B.value?.pages?p.value===B.value.pages.length:!1);function Q(G){return J.value==="gallery-dl",G}let ae=null;async function U(G){if(ae&&clearTimeout(ae),!G.trim()){l.value=!1,m.value=!1;return}ae=setTimeout(async()=>{g.value=!0;try{const c=await ub(G);l.value=c.available,m.value=c.supported}catch{l.value=!1,m.value=!1}finally{g.value=!1}},500)}function r(){z.value&&!confirm("æ­£åœ¨å¤„ç†ä¸­ï¼Œç¡®å®šè¦å…³é—­å—ï¼Ÿ")||(t.closeModal(),t.resetState(),o.value="")}async function d(){const G=o.value.trim();if(!G){alert("è¯·è¾“å…¥ç½‘å€");return}try{new URL(G)}catch{alert("è¯·è¾“å…¥æœ‰æ•ˆçš„ç½‘å€");return}t.resetState(),t.setUrl(G),t.setStatus("extracting");try{await db(G,t.settings,c=>{t.addLog(c)},c=>{t.setExtractResult(c),c.success?t.setStatus("extracted"):t.setError(c.error||"æå–å¤±è´¥")},c=>{t.setError(c)},i.value,c=>{t.addPageIncremental(c)})}catch(c){t.setError(c instanceof Error?c.message:"æå–å¤±è´¥")}}function f(G){t.togglePageSelection(G)}function C(){t.toggleSelectAll()}async function x(){if(!B.value?.pages||p.value===0){alert("è¯·é€‰æ‹©è¦å¯¼å…¥çš„å›¾ç‰‡");return}const G=B.value.pages.filter(h=>v.value.has(h.pageNumber));t.setStatus("downloading"),t.updateDownloadProgress(0,G.length);const c=J.value||"ai-agent";try{if(c==="gallery-dl"){const le=await cb();if(le.success&&le.images.length>0){let N=0;const X=Math.min(le.images.length,G.length);for(let pe=0;pe<X;pe++){const ye=le.images[pe];ye&&ye.filename&&ye.data&&(s.addImage(ye.filename,ye.data),N++,t.updateDownloadProgress(N,X))}t.setStatus("completed"),alert(`æˆåŠŸå¯¼å…¥ ${N} å¼ å›¾ç‰‡`),r();return}else throw new Error(le.error||"è·å–å›¾ç‰‡å¤±è´¥")}const h=await gb(G,B.value.sourceUrl,t.settings,c);if(h.success&&h.images.length>0){t.setDownloadedImages(h.images),t.updateDownloadProgress(h.images.length,G.length);for(const N of h.images)s.addImage(N.filename,N.dataUrl);t.setStatus("completed");const le=h.failedCount>0?`ï¼Œ${h.failedCount} å¼ å¤±è´¥`:"";alert(`æˆåŠŸå¯¼å…¥ ${h.images.length} å¼ å›¾ç‰‡${le}`),r()}else t.setError(h.error||"ä¸‹è½½å¤±è´¥")}catch(h){t.setError(h instanceof Error?h.message:"ä¸‹è½½å¤±è´¥")}}Se(D,G=>{G&&setTimeout(()=>{document.querySelector(".url-input")?.focus()},100)}),Se(o,G=>{U(G)});const P=Y(()=>t.settings.agent.provider==="custom_openai");async function I(){if(!t.settings.firecrawl.apiKey){alert("è¯·è¾“å…¥ Firecrawl API Key");return}_.value=!0;try{const G=await pb(t.settings.firecrawl.apiKey);G.success?alert("âœ… Firecrawl è¿æ¥æˆåŠŸ"):alert(`âŒ è¿æ¥å¤±è´¥: ${G.error}`)}catch(G){alert(`âŒ è¿æ¥å¤±è´¥: ${G instanceof Error?G.message:"æœªçŸ¥é”™è¯¯"}`)}finally{_.value=!1}}async function E(){if(!t.settings.agent.apiKey){alert("è¯·è¾“å…¥ AI Agent API Key");return}S.value=!0;try{const G=await mb(t.settings.agent.provider,t.settings.agent.apiKey,t.settings.agent.customBaseUrl,t.settings.agent.modelName);G.success?alert("âœ… AI Agent è¿æ¥æˆåŠŸ"):alert(`âŒ è¿æ¥å¤±è´¥: ${G.error}`)}catch(G){alert(`âŒ è¿æ¥å¤±è´¥: ${G instanceof Error?G.message:"æœªçŸ¥é”™è¯¯"}`)}finally{S.value=!1}}function K(){confirm("ç¡®å®šè¦é‡ç½®ä¸ºé»˜è®¤æç¤ºè¯å—ï¼Ÿ")&&t.resetExtractionPrompt()}return(G,c)=>(A(),ut(Rn,{to:"body"},[D.value?(A(),L("div",{key:0,class:"modal-overlay",onClick:nt(r,["self"])},[e("div",vb,[e("div",{class:"modal-header"},[c[37]||(c[37]=e("h2",{class:"modal-title"},[e("span",{class:"title-icon"},"ğŸŒ"),de(" ä»ç½‘é¡µå¯¼å…¥æ¼«ç”» ")],-1)),e("button",{class:"close-btn",onClick:r,title:"å…³é—­"},"Ã—")]),e("div",fb,[e("div",bb,[oe(e("input",{"onUpdate:modelValue":c[0]||(c[0]=h=>o.value=h),type:"url",class:"url-input",placeholder:"è¾“å…¥æ¼«ç”»ç½‘é¡µ URLï¼Œå¦‚ https://example.com/chapter-1",disabled:z.value,onKeyup:Pn(d,["enter"])},null,40,hb),[[Pe,o.value]]),oe(e("select",{"onUpdate:modelValue":c[1]||(c[1]=h=>i.value=h),class:"engine-select",disabled:z.value},[...c[38]||(c[38]=[e("option",{value:"auto"},"è‡ªåŠ¨é€‰æ‹©",-1),e("option",{value:"gallery-dl"},"Gallery-DL",-1),e("option",{value:"ai-agent"},"AI Agent",-1)])],8,xb),[[Ds,i.value]]),e("button",{class:"extract-btn",disabled:z.value||!o.value.trim(),onClick:d},[V.value==="extracting"?(A(),L("span",Cb)):(A(),L("span",_b,"ğŸ”")),de(" "+te(V.value==="extracting"?"æå–ä¸­...":"å¼€å§‹æå–"),1)],8,yb)]),o.value.trim()&&!z.value?(A(),L("div",kb,[g.value?(A(),L("span",Sb,"æ£€æŸ¥ä¸­...")):m.value?(A(),L("span",wb,"âœ“ è¯¥ç½‘ç«™æ”¯æŒ Gallery-DL é«˜é€Ÿä¸‹è½½")):l.value?(A(),L("span",$b,"è¯¥ç½‘ç«™å°†ä½¿ç”¨ AI Agent æ¨¡å¼")):ce("",!0)])):ce("",!0),c[80]||(c[80]=e("div",{class:"notice"}," âš ï¸ è¯·ä»…çˆ¬å–æ‚¨æœ‰æƒè®¿é—®çš„å†…å®¹ï¼Œå¹¶éµå®ˆç›®æ ‡ç½‘ç«™çš„ä½¿ç”¨æ¡æ¬¾ã€‚ ",-1)),e("div",Tb,[e("div",{class:"settings-header",onClick:c[2]||(c[2]=h=>u.value=!u.value)},[e("span",Ib,te(u.value?"â–¼":"â–¶"),1),c[39]||(c[39]=e("span",{class:"settings-title"},"âš™ï¸ è®¾ç½®",-1)),c[40]||(c[40]=e("span",{class:"settings-hint"},"ç‚¹å‡»å±•å¼€é…ç½®",-1))]),u.value?(A(),L("div",Pb,[e("div",Rb,[e("button",{class:Re(["settings-tab",{active:b.value==="basic"}]),onClick:c[3]||(c[3]=h=>b.value="basic")}," åŸºæœ¬è®¾ç½® ",2),e("button",{class:Re(["settings-tab",{active:b.value==="preprocess"}]),onClick:c[4]||(c[4]=h=>b.value="preprocess")}," å›¾ç‰‡é¢„å¤„ç† ",2),e("button",{class:Re(["settings-tab",{active:b.value==="advanced"}]),onClick:c[5]||(c[5]=h=>b.value="advanced")}," é«˜çº§è®¾ç½® ",2)]),oe(e("div",Db,[e("div",Mb,[c[42]||(c[42]=e("h4",{class:"group-title"},"Firecrawl é…ç½®",-1)),e("div",Bb,[c[41]||(c[41]=e("label",{class:"form-label"},"API Key",-1)),e("div",Ab,[e("input",{type:R.value?"text":"password",class:"form-input",value:H(t).settings.firecrawl.apiKey,onInput:c[6]||(c[6]=h=>H(t).setFirecrawlApiKey(h.target.value)),placeholder:"fc-xxxxxxxxxxxxxxxx"},null,40,Eb),e("button",{class:"toggle-btn",onClick:c[7]||(c[7]=h=>R.value=!R.value)},te(R.value?"ğŸ‘":"ğŸ‘â€ğŸ—¨"),1),e("button",{class:"test-btn",disabled:_.value||!H(t).settings.firecrawl.apiKey,onClick:I},te(_.value?"æµ‹è¯•ä¸­...":"æµ‹è¯•è¿æ¥"),9,Lb)])])]),e("div",Fb,[c[49]||(c[49]=e("h4",{class:"group-title"},"AI Agent é…ç½®",-1)),e("div",Ub,[c[43]||(c[43]=e("label",{class:"form-label"},"æœåŠ¡å•†",-1)),e("select",{class:"form-select",value:H(t).settings.agent.provider,onChange:c[8]||(c[8]=h=>H(t).setAgentProvider(h.target.value))},[(A(!0),L(ze,null,Ge(H(Is),h=>(A(),L("option",{key:h.value,value:h.value},te(h.label),9,zb))),128))],40,Ob)]),e("div",Nb,[c[44]||(c[44]=e("label",{class:"form-label"},"API Key",-1)),e("div",Vb,[e("input",{type:y.value?"text":"password",class:"form-input",value:H(t).settings.agent.apiKey,onInput:c[9]||(c[9]=h=>H(t).setAgentApiKey(h.target.value)),placeholder:"sk-xxxxxxxxxxxxxxxx"},null,40,Wb),e("button",{class:"toggle-btn",onClick:c[10]||(c[10]=h=>y.value=!y.value)},te(y.value?"ğŸ‘":"ğŸ‘â€ğŸ—¨"),1)])]),P.value?(A(),L("div",Kb,[c[45]||(c[45]=e("label",{class:"form-label"},"è‡ªå®šä¹‰ API åœ°å€",-1)),e("input",{type:"url",class:"form-input",value:H(t).settings.agent.customBaseUrl,onInput:c[11]||(c[11]=h=>H(t).setAgentBaseUrl(h.target.value)),placeholder:"https://api.example.com/v1"},null,40,qb)])):ce("",!0),e("div",Hb,[c[46]||(c[46]=e("label",{class:"form-label"},"æ¨¡å‹åç§°",-1)),e("input",{type:"text",class:"form-input",value:H(t).settings.agent.modelName,onInput:c[12]||(c[12]=h=>H(t).setAgentModelName(h.target.value)),placeholder:"gpt-4o-mini"},null,40,jb)]),e("div",Jb,[e("label",Yb,[e("input",{type:"checkbox",checked:H(t).settings.agent.forceJsonOutput,onChange:c[13]||(c[13]=h=>H(t).setAgentForceJson(h.target.checked))},null,40,Gb),c[47]||(c[47]=de(" å¼ºåˆ¶ JSON æ ¼å¼ ",-1))]),e("label",Xb,[e("input",{type:"checkbox",checked:H(t).settings.agent.useStream,onChange:c[14]||(c[14]=h=>H(t).setAgentUseStream(h.target.checked))},null,40,Zb),c[48]||(c[48]=de(" æµå¼è°ƒç”¨ ",-1))])]),e("div",Qb,[e("button",{class:"test-btn full",disabled:S.value||!H(t).settings.agent.apiKey,onClick:E},te(S.value?"æµ‹è¯•ä¸­...":"æµ‹è¯• Agent è¿æ¥"),9,eh)])]),e("div",th,[e("h4",{class:"group-title"},[c[50]||(c[50]=de(" æå–è®¾ç½® ",-1)),e("button",{class:"reset-btn",onClick:K},"é‡ç½®ä¸ºé»˜è®¤")]),e("div",oh,[c[51]||(c[51]=e("label",{class:"form-label"},"æå–æç¤ºè¯",-1)),e("textarea",{class:"form-textarea",value:H(t).settings.extraction.prompt,onInput:c[15]||(c[15]=h=>H(t).setExtractionPrompt(h.target.value)),rows:"6",placeholder:"è¾“å…¥æå–æç¤ºè¯..."},null,40,nh)]),e("div",sh,[c[52]||(c[52]=e("label",{class:"form-label"},"æœ€å¤§è¿­ä»£æ¬¡æ•°",-1)),e("input",{type:"number",class:"form-input small",value:H(t).settings.extraction.maxIterations,onInput:c[16]||(c[16]=h=>H(t).setExtractionMaxIterations(Number(h.target.value))),min:"1",max:"20"},null,40,ah)])]),e("div",lh,[c[58]||(c[58]=e("h4",{class:"group-title"},"ä¸‹è½½è®¾ç½®",-1)),e("div",ih,[e("div",rh,[c[53]||(c[53]=e("label",{class:"form-label"},"å¹¶å‘æ•°",-1)),e("input",{type:"number",class:"form-input small",value:H(t).settings.download.concurrency,onInput:c[17]||(c[17]=h=>H(t).setDownloadConcurrency(Number(h.target.value))),min:"1",max:"10"},null,40,uh)]),e("div",ch,[c[54]||(c[54]=e("label",{class:"form-label"},"è¶…æ—¶ (ç§’)",-1)),e("input",{type:"number",class:"form-input small",value:H(t).settings.download.timeout,onInput:c[18]||(c[18]=h=>H(t).setDownloadTimeout(Number(h.target.value))),min:"5",max:"120"},null,40,dh)]),e("div",gh,[c[55]||(c[55]=e("label",{class:"form-label"},"é‡è¯•æ¬¡æ•°",-1)),e("input",{type:"number",class:"form-input small",value:H(t).settings.download.retries,onInput:c[19]||(c[19]=h=>H(t).setDownloadRetries(Number(h.target.value))),min:"0",max:"5"},null,40,ph)]),e("div",mh,[c[56]||(c[56]=e("label",{class:"form-label"},"ä¸‹è½½é—´éš” (ms)",-1)),e("input",{type:"number",class:"form-input small",value:H(t).settings.download.delay,onInput:c[20]||(c[20]=h=>H(t).setDownloadDelay(Number(h.target.value))),min:"0",max:"2000",step:"100"},null,40,vh)])]),e("div",fh,[e("label",bh,[e("input",{type:"checkbox",checked:H(t).settings.download.useReferer,onChange:c[21]||(c[21]=h=>H(t).setDownloadUseReferer(h.target.checked))},null,40,hh),c[57]||(c[57]=de(" è‡ªåŠ¨æ·»åŠ  Referer ",-1))])])]),e("div",xh,[c[61]||(c[61]=e("h4",{class:"group-title"},"ç•Œé¢è®¾ç½®",-1)),e("div",yh,[e("label",Ch,[e("input",{type:"checkbox",checked:H(t).settings.ui.showAgentLogs,onChange:c[22]||(c[22]=h=>H(t).setShowAgentLogs(h.target.checked))},null,40,_h),c[59]||(c[59]=de(" æ˜¾ç¤º AI å·¥ä½œæ—¥å¿— ",-1))]),e("label",kh,[e("input",{type:"checkbox",checked:H(t).settings.ui.autoImport,onChange:c[23]||(c[23]=h=>H(t).setAutoImport(h.target.checked))},null,40,Sh),c[60]||(c[60]=de(" æå–åè‡ªåŠ¨å¯¼å…¥ ",-1))])])])],512),[[Oe,b.value==="basic"]]),oe(e("div",wh,[e("div",$h,[e("div",Th,[e("label",Ih,[e("input",{type:"checkbox",checked:H(t).settings.imagePreprocess.enabled,onChange:c[24]||(c[24]=h=>H(t).setImagePreprocessEnabled(h.target.checked))},null,40,Ph),c[62]||(c[62]=de(" å¯ç”¨å›¾ç‰‡é¢„å¤„ç† ",-1))])]),H(t).settings.imagePreprocess.enabled?(A(),L(ze,{key:0},[e("div",Rh,[e("label",Dh,[e("input",{type:"checkbox",checked:H(t).settings.imagePreprocess.autoRotate,onChange:c[25]||(c[25]=h=>H(t).setImageAutoRotate(h.target.checked))},null,40,Mh),c[63]||(c[63]=de(" æ ¹æ® EXIF è‡ªåŠ¨æ—‹è½¬ ",-1))])]),c[71]||(c[71]=e("h5",{class:"subsection-title"},"å‹ç¼©è®¾ç½®",-1)),e("div",Bh,[e("label",Ah,[e("input",{type:"checkbox",checked:H(t).settings.imagePreprocess.compression.enabled,onChange:c[26]||(c[26]=h=>H(t).setImageCompressionEnabled(h.target.checked))},null,40,Eh),c[64]||(c[64]=de(" å¯ç”¨å‹ç¼© ",-1))])]),H(t).settings.imagePreprocess.compression.enabled?(A(),L("div",Lh,[e("div",Fh,[c[65]||(c[65]=e("label",{class:"form-label"},"è´¨é‡ (0-100)",-1)),e("input",{type:"number",class:"form-input small",value:H(t).settings.imagePreprocess.compression.quality,onInput:c[27]||(c[27]=h=>H(t).setImageCompressionQuality(Number(h.target.value))),min:"1",max:"100"},null,40,Uh)]),e("div",Oh,[c[66]||(c[66]=e("label",{class:"form-label"},"æœ€å¤§å®½åº¦ (0=ä¸é™)",-1)),e("input",{type:"number",class:"form-input small",value:H(t).settings.imagePreprocess.compression.maxWidth,onInput:c[28]||(c[28]=h=>H(t).setImageMaxWidth(Number(h.target.value))),min:"0"},null,40,zh)]),e("div",Nh,[c[67]||(c[67]=e("label",{class:"form-label"},"æœ€å¤§é«˜åº¦ (0=ä¸é™)",-1)),e("input",{type:"number",class:"form-input small",value:H(t).settings.imagePreprocess.compression.maxHeight,onInput:c[29]||(c[29]=h=>H(t).setImageMaxHeight(Number(h.target.value))),min:"0"},null,40,Vh)])])):ce("",!0),c[72]||(c[72]=e("h5",{class:"subsection-title"},"æ ¼å¼è½¬æ¢",-1)),e("div",Wh,[e("label",Kh,[e("input",{type:"checkbox",checked:H(t).settings.imagePreprocess.formatConvert.enabled,onChange:c[30]||(c[30]=h=>H(t).setImageFormatConvertEnabled(h.target.checked))},null,40,qh),c[68]||(c[68]=de(" å¯ç”¨æ ¼å¼è½¬æ¢ ",-1))])]),H(t).settings.imagePreprocess.formatConvert.enabled?(A(),L("div",Hh,[c[70]||(c[70]=e("label",{class:"form-label"},"ç›®æ ‡æ ¼å¼",-1)),e("select",{class:"form-select",value:H(t).settings.imagePreprocess.formatConvert.targetFormat,onChange:c[31]||(c[31]=h=>H(t).setImageTargetFormat(h.target.value))},[...c[69]||(c[69]=[e("option",{value:"original"},"ä¿æŒåŸæ ¼å¼",-1),e("option",{value:"jpeg"},"JPEG",-1),e("option",{value:"png"},"PNG",-1),e("option",{value:"webp"},"WebP",-1)])],40,jh)])):ce("",!0)],64)):ce("",!0)])],512),[[Oe,b.value==="preprocess"]]),oe(e("div",Jh,[e("div",Yh,[c[76]||(c[76]=e("h4",{class:"group-title"},"è‡ªå®šä¹‰è¯·æ±‚å¤´",-1)),e("div",Gh,[c[73]||(c[73]=e("label",{class:"form-label"},"Cookie",-1)),e("input",{type:"text",class:"form-input",value:H(t).settings.advanced.customCookie,onInput:c[32]||(c[32]=h=>H(t).setCustomCookie(h.target.value)),placeholder:"name=value; name2=value2"},null,40,Xh)]),e("div",Zh,[c[74]||(c[74]=e("label",{class:"form-label"},"Headers (JSON)",-1)),e("textarea",{class:"form-textarea",value:H(t).settings.advanced.customHeaders,onInput:c[33]||(c[33]=h=>H(t).setCustomHeaders(h.target.value)),rows:"3",placeholder:'{"X-Custom-Header": "value"}'},null,40,Qh)]),e("div",ex,[e("label",tx,[e("input",{type:"checkbox",checked:H(t).settings.advanced.bypassProxy,onChange:c[34]||(c[34]=h=>H(t).setBypassProxy(h.target.checked))},null,40,ox),c[75]||(c[75]=de(" ç»•è¿‡ç³»ç»Ÿä»£ç† (è¿æ¥æœ¬åœ°æœåŠ¡æ—¶ä½¿ç”¨) ",-1))])])])],512),[[Oe,b.value==="advanced"]])])):ce("",!0)]),ee.value&&M.value.length>0?(A(),L("div",nx,[e("div",{class:"logs-header",onClick:c[35]||(c[35]=h=>a.value=!a.value)},[e("span",sx,te(a.value?"â–¼":"â–¶"),1),c[77]||(c[77]=e("span",null,"AI å·¥ä½œæ—¥å¿—",-1)),V.value==="extracting"?(A(),L("span",ax,"(æå–ä¸­...)")):ce("",!0)]),a.value?(A(),L("div",lx,[(A(!0),L(ze,null,Ge(M.value,(h,le)=>(A(),L("div",{key:le,class:Re(["log-item",`log-${h.type}`])},[e("span",ix,"["+te(h.timestamp)+"]",1),e("span",rx,te(h.message),1)],2))),128))])):ce("",!0)])):ce("",!0),F.value?(A(),L("div",ux,[c[78]||(c[78]=e("span",{class:"error-icon"},"âŒ",-1)),e("span",cx,te(F.value),1)])):ce("",!0),B.value?.success?(A(),L("div",dx,[e("div",gx,[e("span",px," ğŸ“– ã€Š"+te(B.value.comicTitle)+"ã€‹- "+te(B.value.chapterTitle),1),e("span",mx,[e("span",vx,"å…± "+te(B.value.totalPages)+" å¼ ",1),se.value?(A(),L("span",fx,"| å¼•æ“: "+te(se.value),1)):ce("",!0)])]),e("div",bx,[e("label",hx,[e("input",{type:"checkbox",checked:O.value,onChange:C},null,40,xx),c[79]||(c[79]=de(" å…¨é€‰ ",-1))]),e("span",yx,"å·²é€‰: "+te(p.value)+" å¼ ",1)]),e("div",Cx,[(A(!0),L(ze,null,Ge(B.value.pages,h=>(A(),L("div",{key:h.pageNumber,class:Re(["image-item",{selected:v.value.has(h.pageNumber)}]),onClick:le=>f(h.pageNumber)},[e("div",kx,[e("input",{type:"checkbox",checked:v.value.has(h.pageNumber),onClick:c[36]||(c[36]=nt(()=>{},["stop"])),onChange:le=>f(h.pageNumber)},null,40,Sx)]),e("div",wx,[e("img",{src:Q(h.imageUrl),alt:`ç¬¬${h.pageNumber}é¡µ`,loading:"lazy"},null,8,$x)]),e("div",Tx,"ç¬¬ "+te(h.pageNumber)+" é¡µ",1)],10,_x))),128))])])):ce("",!0),V.value==="downloading"?(A(),L("div",Ix,[e("div",Px," ä¸‹è½½è¿›åº¦: "+te($.value.current)+"/"+te($.value.total),1),e("div",Rx,[e("div",{class:"progress-fill",style:ot({width:`${k.value}%`})},null,4)])])):ce("",!0)]),e("div",Dx,[e("button",{class:"cancel-btn",onClick:r,disabled:V.value==="downloading"}," å–æ¶ˆ ",8,Mx),e("button",{class:"import-btn",disabled:!B.value?.success||p.value===0||z.value,onClick:x},[V.value==="downloading"?(A(),L("span",Ax)):(A(),L("span",Ex,"ğŸ“¥")),de(" "+te(V.value==="downloading"?"ä¸‹è½½ä¸­...":"å¯¼å…¥"),1)],8,Bx)])])])):ce("",!0)]))}}),Fx=Je(Lx,[["__scopeId","data-v-78fc5cb0"]]),Ux={class:"disclaimer-container"},Ox={class:"disclaimer-content"},zx={class:"confirmation-area"},Nx=["placeholder"],Vx={key:0,class:"input-error"},Wx={class:"disclaimer-footer"},Kx=["disabled"],Gt="æˆ‘å·²é˜…è¯»å¹¶åŒæ„",qx=Ye({__name:"WebImportDisclaimer",setup(n){const t=Io(),s=w(""),o=Y(()=>t.disclaimerVisible),a=Y(()=>s.value.trim()===Gt);function i(){a.value&&(t.acceptDisclaimer(),s.value="")}function l(){t.rejectDisclaimer(),s.value=""}return(m,g)=>(A(),ut(Rn,{to:"body"},[o.value?(A(),L("div",{key:0,class:"disclaimer-overlay",onClick:nt(l,["self"])},[e("div",Ux,[g[3]||(g[3]=e("div",{class:"disclaimer-header"},[e("span",{class:"warning-icon"},"âš ï¸"),e("h2",{class:"disclaimer-title"},"é‡è¦å…è´£å£°æ˜")],-1)),e("div",Ox,[g[2]||(g[2]=e("div",{class:"disclaimer-text"},[e("h3",null,"ğŸ“œ ä½¿ç”¨æ¡æ¬¾ä¸æ³•å¾‹å£°æ˜"),e("div",{class:"section"},[e("h4",null,"1. åŠŸèƒ½è¯´æ˜"),e("p",null,[de(' "ä»ç½‘é¡µå¯¼å…¥"åŠŸèƒ½å…è®¸æ‚¨ä»äº’è”ç½‘ç½‘é¡µä¸­æå–å›¾ç‰‡ã€‚æ­¤åŠŸèƒ½ä»…ä¾›'),e("strong",null,"æŠ€æœ¯ç ”ç©¶ä¸ä¸ªäººå­¦ä¹ "),de("ä¹‹ç›®çš„æä¾›ã€‚ ")])]),e("div",{class:"section"},[e("h4",null,"2. ç”¨æˆ·è´£ä»»"),e("ul",null,[e("li",null,[de("æ‚¨åº”å½“ç¡®ä¿æ‹¥æœ‰"),e("strong",null,"åˆæ³•æƒåˆ©"),de("è®¿é—®å’Œä¸‹è½½ç›®æ ‡å†…å®¹")]),e("li",null,[de("æ‚¨åº”å½“éµå®ˆç›®æ ‡ç½‘ç«™çš„"),e("strong",null,"æœåŠ¡æ¡æ¬¾"),de("å’Œ"),e("strong",null,"ä½¿ç”¨åè®®")]),e("li",null,[de("æ‚¨åº”å½“å°Šé‡å†…å®¹åˆ›ä½œè€…çš„"),e("strong",null,"ç‰ˆæƒ"),de("å’Œ"),e("strong",null,"çŸ¥è¯†äº§æƒ")]),e("li",null,[de("æ‚¨"),e("strong",null,"ä¸å¾—"),de("å°†ä¸‹è½½çš„å†…å®¹ç”¨äºå•†ä¸šç›®çš„æˆ–éæ³•ä¼ æ’­")]),e("li",null,[de("æ‚¨"),e("strong",null,"ä¸å¾—"),de("ä½¿ç”¨æœ¬åŠŸèƒ½ç»•è¿‡ä»˜è´¹å†…å®¹çš„è®¿é—®é™åˆ¶")])])]),e("div",{class:"section"},[e("h4",null,"3. ä½¿ç”¨é™åˆ¶"),e("p",null,[de("æœ¬åŠŸèƒ½"),e("strong",null,"ä¸¥ç¦"),de("ç”¨äºä»¥ä¸‹ç›®çš„ï¼š")]),e("ul",null,[e("li",null,[de("ä¸‹è½½ã€å­˜å‚¨æˆ–ä¼ æ’­"),e("strong",null,"ä¾µæƒå†…å®¹")]),e("li",null,[de("ç»•è¿‡ç½‘ç«™çš„"),e("strong",null,"ä»˜è´¹å¢™"),de("æˆ–"),e("strong",null,"è®¿é—®æ§åˆ¶")]),e("li",null,[de("è¿›è¡Œ"),e("strong",null,"å•†ä¸šç”¨é€”"),de("æˆ–å¤§è§„æ¨¡"),e("strong",null,"æ‰¹é‡çˆ¬å–")]),e("li",null,[de("ä»»ä½•è¿å"),e("strong",null,"å½“åœ°æ³•å¾‹æ³•è§„"),de("çš„æ´»åŠ¨")]),e("li",null,[de("å¯¹ç›®æ ‡ç½‘ç«™é€ æˆ"),e("strong",null,"æœåŠ¡å™¨è´Ÿæ‹…"),de("æˆ–"),e("strong",null,"æ¶æ„æ”»å‡»")])])]),e("div",{class:"section"},[e("h4",null,"4. å…è´£æ¡æ¬¾"),e("p",null,[de(" æœ¬è½¯ä»¶ä½œè€…åŠè´¡çŒ®è€…"),e("strong",null,"ä¸å¯¹æ‚¨ä½¿ç”¨æœ¬åŠŸèƒ½æ‰€å¯¼è‡´çš„ä»»ä½•ç›´æ¥æˆ–é—´æ¥åæœæ‰¿æ‹…è´£ä»»"),de("ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºï¼š ")]),e("ul",null,[e("li",null,"å› ä¾µçŠ¯ç‰ˆæƒè€Œäº§ç”Ÿçš„æ³•å¾‹è´£ä»»"),e("li",null,"å› è¿åæœåŠ¡æ¡æ¬¾è€Œå¯¼è‡´çš„è´¦å·å°ç¦"),e("li",null,"å› æ•°æ®ä¸¢å¤±æˆ–æŸåè€Œé€ æˆçš„æŸå¤±"),e("li",null,"ä»»ä½•å…¶ä»–å› ä½¿ç”¨æœ¬åŠŸèƒ½è€Œäº§ç”Ÿçš„ä¸åˆ©åæœ")])]),e("div",{class:"section warning-section"},[e("h4",null,"5. ç¡®è®¤å£°æ˜"),e("p",null,[de(" ä½¿ç”¨æœ¬åŠŸèƒ½å³è¡¨ç¤ºæ‚¨"),e("strong",null,"å·²é˜…è¯»ã€ç†è§£å¹¶åŒæ„"),de("ä¸Šè¿°æ‰€æœ‰æ¡æ¬¾ï¼Œå¹¶æ‰¿è¯ºï¼š ")]),e("ul",null,[e("li",null,[de("ä»…å°†æœ¬åŠŸèƒ½ç”¨äº"),e("strong",null,"åˆæ³•ã€åˆè§„"),de("çš„ç›®çš„")]),e("li",null,[e("strong",null,"è‡ªè¡Œæ‰¿æ‹…"),de("ä½¿ç”¨æœ¬åŠŸèƒ½æ‰€å¸¦æ¥çš„ä¸€åˆ‡é£é™©å’Œè´£ä»»")]),e("li",null,[de("å¦‚å› ä½¿ç”¨æœ¬åŠŸèƒ½å¯¼è‡´ä»»ä½•äº‰è®®ï¼Œ"),e("strong",null,"ä¸æœ¬è½¯ä»¶ä½œè€…æ— å…³")])])])],-1)),e("div",zx,[g[1]||(g[1]=e("p",{class:"confirmation-prompt"}," å¦‚æœæ‚¨å·²å®Œæ•´é˜…è¯»å¹¶åŒæ„ä»¥ä¸Šæ¡æ¬¾ï¼Œè¯·åœ¨ä¸‹æ–¹è¾“å…¥æ¡†ä¸­å‡†ç¡®è¾“å…¥ï¼š ",-1)),e("p",{class:"required-text"},[e("code",null,te(Gt))]),oe(e("input",{"onUpdate:modelValue":g[0]||(g[0]=u=>s.value=u),type:"text",class:"confirmation-input",placeholder:`è¯·è¾“å…¥: ${Gt}`,onKeyup:Pn(i,["enter"])},null,40,Nx),[[Pe,s.value]]),s.value&&!a.value?(A(),L("p",Vx," è¾“å…¥ä¸æ­£ç¡®ï¼Œè¯·å®Œæ•´è¾“å…¥ã€Œ"+te(Gt)+"ã€ ")):ce("",!0)])]),e("div",Wx,[e("button",{class:"btn-cancel",onClick:l}," æˆ‘ä¸åŒæ„ï¼Œè¿”å› "),e("button",{class:"btn-confirm",disabled:!a.value,onClick:i}," âœ“ ç¡®è®¤å¹¶ç»§ç»­ ",8,Kx)])])])):ce("",!0)]))}}),Hx=Je(qx,[["__scopeId","data-v-3750d090"]]),jx={class:"app-header"},Jx={class:"header-content"},Yx={class:"logo-container"},Gx={class:"header-links"},Xx={class:"container"},Zx={id:"image-display-area"},Qx={id:"upload-section",class:"card upload-card"},ey={class:"upload-actions"},ty={key:1,class:"bookshelf-mode-hint"},oy=Ye({__name:"TranslateView",setup(n){const t=In(),s=Ze(),o=Ee(),a=wt(),i=gt(),{validateBeforeTranslation:l,initValidation:m}=On(),g=Eo(),u=Qi(),b=w(!1),_=w(void 0),S=w(!1),R=w(!1),y=Y(()=>s.currentImage),D=Y(()=>s.hasImages),V=Y(()=>s.isBatchTranslationInProgress),M=Y(()=>s.failedImageCount>0),B=Y(()=>D.value&&!R.value),v=Y(()=>!!t.query.book&&!!t.query.chapter),p=Y(()=>t.query.book),$=Y(()=>t.query.chapter),k=Y(()=>u.currentBookTitle.value),F=Y(()=>u.currentChapterTitle.value),z=Y(()=>v.value&&F.value&&k.value?`${F.value} - ${k.value}`:"Saber-Translator");dt(async()=>{s.clearImages(),i.clearBubbles(),await u.initializeApp(),m(),window.addEventListener("keydown",Z)}),Wt(()=>{window.removeEventListener("keydown",Z)}),Se(()=>[t.query.book,t.query.chapter],async([W,ne],[ve,fe])=>{W&&ne?(s.clearImages(),i.clearBubbles(),await O()):ve&&fe&&!W&&!ne&&(s.clearImages(),i.clearBubbles(),await u.initializeBookChapterContext(),console.log("[TranslateView] ä»ä¹¦æ¶æ¨¡å¼åˆ‡æ¢åˆ°å¿«é€Ÿç¿»è¯‘æ¨¡å¼ï¼Œå·²æ¸…ç©ºæ•°æ®"))}),Se(z,W=>{typeof document<"u"&&(document.title=W)},{immediate:!0});const ee=w(!1);function J(W){if(!W)return;const ne=o.settings.textStyle;o.updateTextStyle({fontSize:W.fontSize??ne.fontSize,autoFontSize:W.autoFontSize??ne.autoFontSize,fontFamily:W.fontFamily??ne.fontFamily,layoutDirection:W.layoutDirection??ne.layoutDirection,textColor:W.textColor??ne.textColor,fillColor:W.fillColor??ne.fillColor,strokeEnabled:W.strokeEnabled??ne.strokeEnabled,strokeColor:W.strokeColor??ne.strokeColor,strokeWidth:W.strokeWidth??ne.strokeWidth,inpaintMethod:W.inpaintMethod??ne.inpaintMethod,useAutoTextColor:W.useAutoTextColor??ne.useAutoTextColor})}function se(W){s.currentImage&&s.updateCurrentImage({fontSize:W.fontSize,autoFontSize:W.autoFontSize,fontFamily:W.fontFamily,layoutDirection:W.layoutDirection,textColor:W.textColor,fillColor:W.fillColor,strokeEnabled:W.strokeEnabled,strokeColor:W.strokeColor,strokeWidth:W.strokeWidth,inpaintMethod:W.inpaintMethod,useAutoTextColor:W.useAutoTextColor})}Se(()=>s.currentImage,W=>{if(W&&!ee.value){ee.value=!0;try{J(W),console.log(`[TranslateView] å·²åŒæ­¥å›¾ç‰‡ ${s.currentImageIndex} çš„æ–‡å­—è®¾ç½®åˆ°ä¾§è¾¹æ `)}finally{ee.value=!1}}},{immediate:!1}),Se(()=>o.settings.textStyle,W=>{if(s.currentImage&&!ee.value){ee.value=!0;try{se(W),console.log(`[TranslateView] å·²å°†ä¾§è¾¹æ è®¾ç½®åŒæ­¥åˆ°å›¾ç‰‡ ${s.currentImageIndex}`)}finally{ee.value=!1}}},{deep:!0});async function O(){if(!(!p.value||!$.value))try{await u.initializeBookChapterContext()}catch(W){console.error("åŠ è½½ç« èŠ‚ä¼šè¯å¤±è´¥:",W),Ce("åŠ è½½ç« èŠ‚ä¼šè¯å¤±è´¥","error")}}function Q(W){console.log(`ä¸Šä¼ å®Œæˆï¼Œå…± ${W} å¼ å›¾ç‰‡`),s.hasImages&&(s.sortImagesByFileName(),u.switchImage(0))}async function ae(W){if(!Object.values(W).some(fe=>fe)){Ce("è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè¦åº”ç”¨çš„è®¾ç½®é¡¹","warning");return}if(s.images.length===0){Ce("æ²¡æœ‰å¯åº”ç”¨çš„å›¾ç‰‡","warning");return}if(s.images.length<=1){Ce("åªæœ‰ä¸€å¼ å›¾ç‰‡ï¼Œæ— éœ€åº”ç”¨åˆ°å…¨éƒ¨","info");return}const ve=[];for(let fe=0;fe<s.images.length;fe++){const Me=s.images[fe];Me?.bubbleStates&&Me.bubbleStates.length>0&&ve.push(fe)}if(ve.length===0){Ce("æ²¡æœ‰å·²ç¿»è¯‘çš„å›¾ç‰‡","warning");return}try{const{textStyle:fe}=o.settings,Me=fe.layoutDirection==="auto",Ne=fe.useAutoTextColor===!0,Ue=fe.autoFontSize===!0,we={fontSize:fe.fontSize,fontFamily:fe.fontFamily,textDirection:Me?"vertical":fe.layoutDirection,textColor:fe.textColor,fillColor:fe.fillColor,strokeEnabled:fe.strokeEnabled,strokeColor:fe.strokeColor,strokeWidth:fe.strokeWidth},Ae=Te=>{if(!Te||Te.length!==3)return null;const[q,ie,be]=Te;return"#"+[q,ie,be].map(We=>{const rt=Math.max(0,Math.min(255,Math.round(We))).toString(16);return rt.length===1?"0"+rt:rt}).join("")},Ie=Te=>{const q={...Te};if(W.fontSize&&!Ue&&(q.fontSize=we.fontSize),W.fontFamily&&(q.fontFamily=we.fontFamily),W.layoutDirection)if(Me){const ie=Te.autoTextDirection;q.textDirection=ie==="vertical"||ie==="horizontal"?ie:"vertical"}else q.textDirection=we.textDirection;return W.textColor&&(Ne&&Te.autoFgColor?q.textColor=Ae(Te.autoFgColor)??we.textColor:q.textColor=we.textColor),W.fillColor&&(Ne&&Te.autoBgColor?q.fillColor=Ae(Te.autoBgColor)??we.fillColor:q.fillColor=we.fillColor),W.strokeEnabled&&(q.strokeEnabled=we.strokeEnabled),W.strokeColor&&(q.strokeColor=we.strokeColor),W.strokeWidth&&(q.strokeWidth=we.strokeWidth),q},tt=[];for(const Te of ve){const q=s.images[Te];if(!q?.bubbleStates)continue;const be={bubbleStates:q.bubbleStates.map(Ie)};W.fontSize&&(be.autoFontSize=Ue,Ue||(be.fontSize=we.fontSize)),W.fontFamily&&(be.fontFamily=we.fontFamily),W.layoutDirection&&(be.layoutDirection=fe.layoutDirection),(W.textColor||W.fillColor)&&(be.useAutoTextColor=Ne,Ne||(W.textColor&&(be.textColor=we.textColor),W.fillColor&&(be.fillColor=we.fillColor))),W.strokeEnabled&&(be.strokeEnabled=we.strokeEnabled),W.strokeColor&&(be.strokeColor=we.strokeColor),W.strokeWidth&&(be.strokeWidth=we.strokeWidth),s.updateImageByIndex(Te,be),q.translatedDataURL&&tt.push(Te)}i.bubbles.length>0&&i.setBubbles(i.bubbles.map(Ie));const Ke=[];if(W.fontSize&&Ke.push(Ue?"è‡ªåŠ¨å­—å·":"å­—å·"),W.fontFamily&&Ke.push("å­—ä½“"),W.layoutDirection&&Ke.push(Me?"è‡ªåŠ¨æ’ç‰ˆæ–¹å‘":"æ’ç‰ˆæ–¹å‘"),W.textColor&&Ke.push(Ne?"è‡ªåŠ¨æ–‡å­—é¢œè‰²":"æ–‡å­—é¢œè‰²"),W.fillColor&&Ke.push(Ne?"è‡ªåŠ¨å¡«å……é¢œè‰²":"å¡«å……é¢œè‰²"),W.strokeEnabled&&Ke.push("æè¾¹å¼€å…³"),W.strokeColor&&Ke.push("æè¾¹é¢œè‰²"),W.strokeWidth&&Ke.push("æè¾¹å®½åº¦"),tt.length>0){g.progress.value={isInProgress:!0,current:0,total:tt.length,completed:0,failed:0,label:`åº”ç”¨è®¾ç½®ä¸­ï¼š0 / ${tt.length}`,percentage:0};const{executeRender:Te}=await it(async()=>{const{executeRender:ie}=await Promise.resolve().then(()=>Mi);return{executeRender:ie}},void 0);let q=0;for(const ie of tt){const be=s.images[ie];if(be?.bubbleStates)try{let We="";if(be.cleanImageData?We=be.cleanImageData.includes("base64,")?be.cleanImageData.split("base64,")[1]||"":be.cleanImageData:be.originalDataURL&&(We=be.originalDataURL.includes("base64,")?be.originalDataURL.split("base64,")[1]||"":be.originalDataURL,console.log(`handleApplyToAll: å›¾ç‰‡ ${ie} ä½¿ç”¨åŸå›¾ä½œä¸ºèƒŒæ™¯ï¼ˆå…œåº•ï¼‰`)),!We){console.log(`handleApplyToAll: å›¾ç‰‡ ${ie} æ²¡æœ‰å¯ç”¨çš„èƒŒæ™¯å›¾ï¼Œè·³è¿‡`),g.progress.value.failed++;continue}const rt=be.bubbleStates.map(at=>at.coords),Kt=be.bubbleStates.map(at=>at.rotationAngle||0),Pt=be.bubbleStates.map(at=>at.autoTextDirection||"vertical"),Rt=be.bubbleStates.map(at=>at.originalText||""),Dt=be.bubbleStates.map(at=>at.translatedText||""),st=be.bubbleStates.map(at=>at.textboxText||""),Qe=be.bubbleStates.map(at=>({textColor:at.textColor||"#000000",bgColor:at.fillColor||"#FFFFFF",autoFgColor:at.autoFgColor||null,autoBgColor:at.autoBgColor||null})),Mt={fontSize:be.fontSize,autoFontSize:W.fontSize&&Ue,fontFamily:be.fontFamily,textDirection:be.layoutDirection,autoTextDirection:fe.layoutDirection==="auto",textColor:be.textColor,fillColor:be.fillColor,strokeEnabled:be.strokeEnabled,strokeColor:be.strokeColor,strokeWidth:be.strokeWidth,inpaintMethod:be.inpaintMethod,useAutoTextColor:be.useAutoTextColor},Bt=await Te({imageIndex:ie,cleanImage:We,bubbleCoords:rt,bubbleAngles:Kt,autoDirections:Pt,originalTexts:Rt,translatedTexts:Dt,textboxTexts:st,colors:Qe,savedTextStyles:Mt,currentMode:"standard"});Bt.finalImage?(s.updateImageByIndex(ie,{translatedDataURL:`data:image/png;base64,${Bt.finalImage}`,bubbleStates:Bt.bubbleStates||be.bubbleStates,hasUnsavedChanges:!0}),q++,g.progress.value.current=q,g.progress.value.label=`åº”ç”¨è®¾ç½®ä¸­ï¼š${q} / ${tt.length}`,g.progress.value.percentage=Math.round(q/tt.length*100)):g.progress.value.failed++}catch(We){console.error(`é‡æ¸²æŸ“å›¾ç‰‡ ${ie} å¤±è´¥:`,We),g.progress.value.failed++}}g.progress.value.isInProgress=!1}const lt=s.currentImage;if(lt){ee.value=!0;try{J(lt),console.log("[TranslateView] åº”ç”¨åˆ°å…¨éƒ¨å®Œæˆï¼Œå·²åŒæ­¥å½“å‰å›¾ç‰‡è®¾ç½®åˆ°ä¾§è¾¹æ ")}finally{ee.value=!1}}Ce(`å·²å°† ${Ke.join("ã€")} åº”ç”¨åˆ° ${ve.length} å¼ å›¾ç‰‡`,"success"),console.log(`[TranslateView] åº”ç”¨è®¾ç½®åˆ°å…¨éƒ¨å®Œæˆï¼Œæ›´æ–°äº† ${ve.length} å¼ å›¾ç‰‡ï¼Œé‡æ¸²æŸ“äº† ${tt.length} å¼ `)}catch(fe){console.error("åº”ç”¨è®¾ç½®åˆ°å…¨éƒ¨å¤±è´¥:",fe),Ce("åº”ç”¨è®¾ç½®å¤±è´¥","error")}}async function U(){y.value&&l("normal")&&await g.translateCurrentImage()}async function r(){D.value&&l("normal")&&await g.translateAllImages()}async function d(){D.value&&l("hq")&&await g.executeHqTranslation()}async function f(){D.value&&l("proofread")&&await g.executeProofreading()}async function C(){y.value&&await g.removeTextOnly()}async function x(){D.value&&await g.removeAllTexts()}async function P(W,ne){D.value&&l("normal")&&await g.translateImageRange({startPage:W,endPage:ne})}async function I(W,ne){D.value&&l("hq")&&await g.executeHqTranslation({startPage:W,endPage:ne})}async function E(W,ne){D.value&&l("proofread")&&await g.executeProofreading({startPage:W,endPage:ne})}async function K(W,ne){D.value&&await g.removeTextRange({startPage:W,endPage:ne})}function G(){if(!y.value)return;const W=y.value.fileName||`å›¾ç‰‡ ${s.currentImageIndex+1}`;confirm(`ç¡®å®šè¦åˆ é™¤å½“å‰å›¾ç‰‡ (${W}) å—ï¼Ÿ`)&&(s.deleteCurrentImage(),Ce("å›¾ç‰‡å·²åˆ é™¤","success"))}function c(){D.value&&confirm("ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰å›¾ç‰‡å—ï¼Ÿè¿™å°†ä¸¢å¤±æ‰€æœ‰æœªä¿å­˜çš„è¿›åº¦ã€‚")&&(s.clearImages(),Ce("æ‰€æœ‰å›¾ç‰‡å·²æ¸…é™¤","success"))}async function h(){try{const W=await Dn(),ne=await wo();if(W.success&&ne.success)Ce("ä¸´æ—¶æ–‡ä»¶æ¸…ç†å®Œæˆ","success");else{const ve=[];W.success||ve.push("è°ƒè¯•æ–‡ä»¶æ¸…ç†å¤±è´¥"),ne.success||ve.push("ä¸´æ—¶æ–‡ä»¶æ¸…ç†å¤±è´¥"),Ce(ve.join("ï¼Œ"),"warning")}}catch{Ce("æ¸…ç†ä¸´æ—¶æ–‡ä»¶å¤±è´¥","error")}}function le(){u.goToPrevious()}function N(){u.goToNext()}function X(){R.value=!R.value}async function pe(){if(!M.value){Ce("æ²¡æœ‰å¤±è´¥çš„å›¾ç‰‡éœ€è¦é‡æ–°ç¿»è¯‘","info");return}l("normal")&&await g.retryFailedImages()}async function ye(){if(!D.value){Ce("æ²¡æœ‰å¯ä¿å­˜çš„å†…å®¹","warning");return}if(!(!p.value||!$.value))try{await a.saveChapterSession(p.value,$.value)?Ce("ç« èŠ‚è¿›åº¦å·²ä¿å­˜","success"):Ce("ä¿å­˜å¤±è´¥","error")}catch(W){console.error("ä¿å­˜ä¼šè¯å¤±è´¥:",W),Ce("ä¿å­˜å¤±è´¥: "+(W instanceof Error?W.message:"æœªçŸ¥é”™è¯¯"),"error")}}function _e(W){_.value=W,b.value=!0}function $e(){_e("plugins")}function De(){Ce("è®¾ç½®å·²ä¿å­˜","success")}function re(){S.value=!0}function T(){Ce("ğŸŒ™ è¯¥åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­ï¼Œæ•¬è¯·æœŸå¾…ï¼","info")}function Z(W){const ne=W.target;if(!(ne instanceof HTMLInputElement||ne instanceof HTMLTextAreaElement||ne.getAttribute("contenteditable")==="true"||ne.id==="bubbleTextEditor")&&!R.value&&W.altKey)switch(W.key){case"ArrowLeft":W.preventDefault(),le();break;case"ArrowRight":W.preventDefault(),N();break;case"ArrowUp":if(W.preventDefault(),!o.settings.textStyle.autoFontSize){const fe=o.settings.textStyle.fontSize;o.updateTextStyle({fontSize:fe+1})}break;case"ArrowDown":if(W.preventDefault(),!o.settings.textStyle.autoFontSize){const fe=o.settings.textStyle.fontSize;o.updateTextStyle({fontSize:Math.max(10,fe-1)})}break}}async function he(W){const ne=y.value;if(!ne||!ne.translatedDataURL){console.log(`è‡ªåŠ¨å­—å·è®¾ç½®å˜æ›´: ${W} (ä»…å½±å“ä¸‹æ¬¡ç¿»è¯‘)`);return}const ve=ne.bubbleStates;if(!ve||!Array.isArray(ve)||ve.length===0){console.log("å½“å‰å›¾ç‰‡æ²¡æœ‰ bubbleStatesï¼Œè·³è¿‡é‡æ¸²æŸ“");return}if(console.log(`è‡ªåŠ¨å­—å·è®¾ç½®å˜æ›´: ${W}ï¼Œå°†é‡æ–°æ¸²æŸ“...`),W){console.log("è‡ªåŠ¨å­—å·å·²å¼€å¯ï¼Œé‡æ–°è®¡ç®—å­—å·å¹¶æ¸²æŸ“...");try{const{apiClient:fe}=await it(async()=>{const{apiClient:Ie}=await import("./client.Bht704G-.js");return{apiClient:Ie}},__vite__mapDeps([1,2]));let Me="";if(ne.cleanImageData){const Ie=ne.cleanImageData;Me=Ie.includes("base64,")?Ie.split("base64,")[1]||"":Ie}else ne.originalDataURL&&(Me=ne.originalDataURL.includes("base64,")?ne.originalDataURL.split("base64,")[1]||"":ne.originalDataURL);if(!Me){console.log("æ²¡æœ‰å¯ç”¨çš„èƒŒæ™¯å›¾ï¼Œè·³è¿‡é‡æ¸²æŸ“");return}const Ne=ve.map(Ie=>({translatedText:Ie.translatedText||"",coords:Ie.coords,fontSize:Ie.fontSize||o.settings.textStyle.fontSize,fontFamily:Ie.fontFamily||o.settings.textStyle.fontFamily,textDirection:Ot(Ie),textColor:Ie.textColor||o.settings.textStyle.textColor,rotationAngle:Ie.rotationAngle||0,position:Ie.position||{x:0,y:0},strokeEnabled:Ie.strokeEnabled??o.settings.textStyle.strokeEnabled,strokeColor:Ie.strokeColor||o.settings.textStyle.strokeColor,strokeWidth:Ie.strokeWidth??o.settings.textStyle.strokeWidth})),Ue=Ne.map(Ie=>Ie.translatedText),we=Ne.map(Ie=>Ie.coords),Ae=await fe.post("/api/re_render_image",{clean_image:Me,bubble_texts:Ue,bubble_coords:we,fontSize:o.settings.textStyle.fontSize,fontFamily:o.settings.textStyle.fontFamily,textDirection:o.settings.textStyle.layoutDirection==="auto"?"vertical":o.settings.textStyle.layoutDirection,textColor:o.settings.textStyle.textColor,bubble_states:Ne,use_individual_styles:!0,use_inpainting:!1,use_lama:!1,fillColor:null,is_font_style_change:!0,autoFontSize:!0,strokeEnabled:o.settings.textStyle.strokeEnabled,strokeColor:o.settings.textStyle.strokeColor,strokeWidth:o.settings.textStyle.strokeWidth});if(Ae.rendered_image){if(Ae.bubble_states&&Array.isArray(Ae.bubble_states)){const Ie=ve.map((tt,Ke)=>({...tt,fontSize:Ae.bubble_states[Ke]?.fontSize??tt.fontSize}));s.updateCurrentImage({translatedDataURL:`data:image/png;base64,${Ae.rendered_image}`,bubbleStates:Ie,hasUnsavedChanges:!0}),i.setBubbles(Ie)}else s.updateCurrentImage({translatedDataURL:`data:image/png;base64,${Ae.rendered_image}`,hasUnsavedChanges:!0});console.log("è‡ªåŠ¨å­—å·æ¸²æŸ“æˆåŠŸ")}else Ae.error&&(console.error("è‡ªåŠ¨å­—å·æ¸²æŸ“å¤±è´¥:",Ae.error),Ce("é‡æ–°æ¸²æŸ“å¤±è´¥: "+Ae.error,"error"))}catch(fe){console.error("è‡ªåŠ¨å­—å·æ¸²æŸ“å‡ºé”™:",fe)}}else{const fe=o.settings.textStyle.fontSize;console.log(`è‡ªåŠ¨å­—å·å·²å…³é—­ï¼Œä½¿ç”¨å›ºå®šå­—å· ${fe} æ¸²æŸ“...`);const Me=ve.map(Ne=>({...Ne,fontSize:fe}));s.updateCurrentImage({bubbleStates:Me}),i.setBubbles(Me),await me("fontSize",fe)}}async function me(W,ne){const ve=y.value;if(!ve||!ve.translatedDataURL||!ve.bubbleStates||ve.bubbleStates.length===0||!["fontSize","fontFamily","layoutDirection","textColor","strokeEnabled","strokeColor","strokeWidth","fillColor"].includes(W))return;console.log(`å…¨å±€è®¾ç½®å˜æ›´ (${W}=${ne})ï¼Œå‡†å¤‡é‡æ¸²æŸ“...`);const Ne={fontSize:"fontSize",fontFamily:"fontFamily",layoutDirection:"textDirection",textColor:"textColor",strokeEnabled:"strokeEnabled",strokeColor:"strokeColor",strokeWidth:"strokeWidth",fillColor:"fillColor"}[W];if(Ne&&ve.bubbleStates)if(W==="layoutDirection")if(ne==="auto"){console.log("æ’ç‰ˆæ–¹å‘è®¾ç½®ä¸º 'auto'ï¼Œä» autoTextDirection æ¢å¤æ¯ä¸ªæ°”æ³¡çš„æ’ç‰ˆæ–¹å‘");const Ue=ve.bubbleStates.map(we=>({...we,textDirection:we.autoTextDirection==="vertical"||we.autoTextDirection==="horizontal"?we.autoTextDirection:"vertical"}));s.updateCurrentImage({bubbleStates:Ue}),i.setBubbles(Ue)}else{console.log(`æ’ç‰ˆæ–¹å‘è®¾ç½®ä¸º '${ne}'ï¼Œåº”ç”¨åˆ°æ‰€æœ‰æ°”æ³¡`);const Ue=ve.bubbleStates.map(we=>({...we,textDirection:ne}));s.updateCurrentImage({bubbleStates:Ue}),i.setBubbles(Ue)}else{const Ue=ve.bubbleStates.map(we=>({...we,[Ne]:ne}));s.updateCurrentImage({bubbleStates:Ue}),i.setBubbles(Ue)}try{const we=s.currentImage?.bubbleStates||ve.bubbleStates||[];if(we.length===0||!we[0]?.coords){console.log("æ²¡æœ‰æœ‰æ•ˆçš„æ°”æ³¡åæ ‡ï¼Œè·³è¿‡é‡æ¸²æŸ“");return}const Ae=o.settings.textStyle.layoutDirection,Ie=we.map(ie=>({translatedText:ie.translatedText||"",coords:ie.coords,fontSize:ie.fontSize||o.settings.textStyle.fontSize,fontFamily:ie.fontFamily||o.settings.textStyle.fontFamily,textDirection:Ot(ie),textColor:ie.textColor||o.settings.textStyle.textColor,rotationAngle:ie.rotationAngle||0,position:ie.position||{x:0,y:0},strokeEnabled:ie.strokeEnabled??o.settings.textStyle.strokeEnabled,strokeColor:ie.strokeColor||o.settings.textStyle.strokeColor,strokeWidth:ie.strokeWidth??o.settings.textStyle.strokeWidth})),tt=Ie.map(ie=>ie.translatedText),Ke=Ie.map(ie=>ie.coords);let lt="";if(ve.cleanImageData){const ie=ve.cleanImageData;lt=ie.includes("base64,")?ie.split("base64,")[1]||"":ie}else ve.originalDataURL&&(lt=ve.originalDataURL.includes("base64,")?ve.originalDataURL.split("base64,")[1]||"":ve.originalDataURL,console.log("handleTextStyleChanged: ä½¿ç”¨åŸå›¾ä½œä¸ºèƒŒæ™¯ï¼ˆå…œåº•ï¼‰"));if(!lt){console.log("æ²¡æœ‰å¯ç”¨çš„èƒŒæ™¯å›¾ï¼Œè·³è¿‡é‡æ¸²æŸ“");return}const{apiClient:Te}=await it(async()=>{const{apiClient:ie}=await import("./client.Bht704G-.js");return{apiClient:ie}},__vite__mapDeps([1,2])),q=await Te.post("/api/re_render_image",{clean_image:lt,bubble_texts:tt,bubble_coords:Ke,fontSize:o.settings.textStyle.fontSize,fontFamily:o.settings.textStyle.fontFamily,textDirection:Ae==="auto"?"vertical":Ae,textColor:o.settings.textStyle.textColor,bubble_states:Ie,use_individual_styles:!0,use_inpainting:!1,use_lama:!1,fillColor:null,is_font_style_change:!0,strokeEnabled:o.settings.textStyle.strokeEnabled,strokeColor:o.settings.textStyle.strokeColor,strokeWidth:o.settings.textStyle.strokeWidth});q.rendered_image?(s.updateCurrentImage({translatedDataURL:`data:image/png;base64,${q.rendered_image}`,hasUnsavedChanges:!0}),console.log("è®¾ç½®å˜æ›´åé‡æ–°æ¸²æŸ“æˆåŠŸ")):q.error&&console.error("é‡æ–°æ¸²æŸ“å¤±è´¥:",q.error)}catch(Ue){console.error("è®¾ç½®å˜æ›´åé‡æ–°æ¸²æŸ“å¤±è´¥:",Ue)}}function xe(W){u.switchImage(W)}return(W,ne)=>{const ve=Ms("router-link");return A(),L("div",{class:Re(["translate-page",{"edit-mode-active":R.value}])},[e("header",jx,[e("div",Jx,[e("div",Yx,[ke(ve,{to:"/",title:"è¿”å›ä¹¦æ¶"},{default:xt(()=>[...ne[3]||(ne[3]=[e("img",{src:"/pic/logo.png",alt:"Saber-Translator Logo",class:"app-logo"},null,-1),e("span",{class:"app-name"},"Saber-Translator",-1)])]),_:1})]),e("div",Gx,[ke(ve,{to:"/",class:"back-to-shelf",title:"è¿”å›ä¹¦æ¶"},{default:xt(()=>[...ne[4]||(ne[4]=[de("ğŸ“š",-1)])]),_:1}),v.value?(A(),L("button",{key:0,class:"save-header-btn",title:"ä¿å­˜è¿›åº¦",onClick:ye}," ğŸ’¾ ")):ce("",!0),e("button",{id:"openSettingsBtn",class:"settings-header-btn",title:"æ‰“å¼€è®¾ç½®",onClick:ne[0]||(ne[0]=fe=>_e())},[...ne[5]||(ne[5]=[e("span",{class:"icon"},"âš™ï¸",-1),e("span",null,"è®¾ç½®",-1)])]),ne[8]||(ne[8]=e("a",{href:"http://www.mashirosaber.top",target:"_blank",class:"tutorial-link"},"ä½¿ç”¨æ•™ç¨‹",-1)),e("a",{href:"javascript:void(0)",class:"donate-link",onClick:re},[...ne[6]||(ne[6]=[e("span",null,"â¤ï¸ è¯·ä½œè€…å–å¥¶èŒ¶",-1)])]),ne[9]||(ne[9]=e("a",{href:"https://github.com/MashiroSaber03",target:"_blank",class:"github-link"},[e("img",{src:"/pic/github.jpg",alt:"GitHub",class:"github-icon"})],-1)),e("button",{class:"theme-toggle",title:"åŠŸèƒ½å¼€å‘ä¸­",onClick:T},[...ne[7]||(ne[7]=[e("span",{class:"theme-icon"},"â˜€ï¸",-1)])])])])]),e("div",Xx,[ke(Nl,{onTranslateCurrent:U,onTranslateAll:r,onTranslateRange:P,onHqTranslate:d,onHqTranslateRange:I,onProofread:f,onProofreadRange:E,onRemoveText:C,onRemoveAllText:x,onRemoveTextRange:K,onRetryFailed:pe,onDeleteCurrent:G,onClearAll:c,onCleanTemp:h,onOpenPlugins:$e,onOpenSettings:_e,onPrevious:le,onNext:N,onApplyToAll:ae,onTextStyleChanged:me,onAutoFontSizeChanged:he}),e("main",Zx,[e("section",Qx,[e("div",ey,[ke(Ta,{ref:"imageUploadRef",onUploadComplete:Q},null,512)]),H(a).loadingProgress.total>0?(A(),ut(Po,{key:0,visible:!0,percentage:H(a).loadingProgress.current/H(a).loadingProgress.total*100,label:H(a).loadingProgress.message},null,8,["percentage","label"])):ce("",!0),ke(Pr,{progress:H(g).progress.value},null,8,["progress"]),V.value&&v.value?(A(),L("div",ty,[...ne[10]||(ne[10]=[e("span",{style:{color:"#888","font-size":"0.85em"}}," ï¼ˆä¹¦æ¶æ¨¡å¼ä¸‹é€€å‡ºå‰è¯·ç‚¹å‡»é¡¶éƒ¨ä¿å­˜æŒ‰é’®ï¼‰ ",-1)])])):ce("",!0)]),ke(ci,{ref:"imageResultRef","is-edit-mode":R.value,onToggleEditMode:X,onRetryFailed:pe},null,8,["is-edit-mode"])]),oe(ke(su,{"is-visible":B.value,onSelect:xe},null,8,["is-visible"]),[[Oe,B.value]])]),y.value&&R.value?(A(),ut(rb,{key:0,"is-edit-mode-active":R.value,onExit:X},null,8,["is-edit-mode-active"])):ce("",!0),ke(vi,{onOpenSettings:_e}),ke(Jm,{modelValue:b.value,"onUpdate:modelValue":ne[1]||(ne[1]=fe=>b.value=fe),"initial-tab":_.value,onSave:De},null,8,["modelValue","initial-tab"]),S.value?(A(),ut(Dr,{key:1,onClose:ne[2]||(ne[2]=fe=>S.value=!1)})):ce("",!0),ke(Hx),ke(Fx)],2)}}}),gy=Je(oy,[["__scopeId","data-v-065359f7"]]);export{gy as default};
