const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["js/index.CnztCBXu.js","js/vue-vendor.BU3zOQRA.js","assets/index.BYanE9pL.css","js/session.Kpy-QhBa.js","js/client.Bht704G-.js","js/utils-vendor.B9ygI19o.js"])))=>i.map(i=>d[i]);
import{D as on,b as an,c as sn,d as Hn,a as lt,_ as je,u as Qe,s as Ie,e as dt,f as To,g as Io,h as Do,i as Ro,j as Mn,k as Bn,B as En,l as Pn,m as Mo,F as Xt,n as An,o as Fn,p as Bo,L as Ln}from"./index.CnztCBXu.js";import{d as ln,r as h,c as te,a as Ge,i as J,v as Me,e,t as ye,x as it,h as V,b as rt,n as Le,B as Ne,l as ut,y as ie,G as Ke,f as Re,H as Un,w as yt,I as tt,u as fe,F as Ze,j as et,J as Jn,K as Be,D as ct,L as kt,z as Ae,M as Eo,k as nt,N as Qt,o as It,O as xt,P as On,E as Po}from"./vue-vendor.BU3zOQRA.js";import{p as Ao,a as Fo,b as Lo,c as Uo,d as Oo,e as zo,f as Vo,h as No,i as Wo,j as Ko,k as rn,l as Yn}from"./system.CmjDD-4C.js";import{getFontList as Xn,uploadFont as qo,getTextboxPrompts as Ho,getPrompts as Jo,configApi as qe,getFontListApi as Yo}from"./config.CwRcCkM9.js";import{_ as We}from"./CustomSelect.vue_vue_type_style_index_0_lang.qSOIWfjV.js";import{apiClient as at}from"./client.Bht704G-.js";import{B as jn}from"./BaseModal.BUrp_eXe.js";import{getBookDetail as Xo}from"./bookshelf.BX1u67VK.js";import"./utils-vendor.B9ygI19o.js";async function Et(n){return at.post("/api/translate_image",n)}async function un(n){return at.post("/api/re_render_image",n)}async function jo(n){try{return{success:!0,data:await at.post("/api/translate_single_text",n)}}catch(r){return{success:!1,error:r instanceof Error?r.message:"翻译失败"}}}async function en(n){return at.post("/api/hq_translate_batch",n)}async function tn(n,r,u){return at.post("/api/detect_boxes",{image:n,detector_type:r,...u})}async function Gn(n,r,u,o){return at.post("/api/ocr_single_bubble",{image_data:n,bubble_coords:r,ocr_engine:u,...o})}async function cn(n,r,u){return at.post("/api/inpaint_single_bubble",{image_data:n,bubble_coords:r,bubble_angle:u?.bubbleAngle??0,method:u?.method??"lama",lama_model:u?.lamaModel??"lama_mpe",...u?.maskData&&{mask_data:u.maskData}})}const Go=Object.freeze(Object.defineProperty({__proto__:null,detectBoxes:tn,hqTranslateBatch:en,inpaintSingleBubble:cn,ocrSingleBubble:Gn,reRenderImage:un,translateImage:Et,translateSingleText:jo},Symbol.toStringTag,{value:"Module"}));async function Zo(){return at.get("/api/plugins")}async function Qo(n){const r=encodeURIComponent(n);return at.post(`/api/plugins/${r}/enable`)}async function ea(n){const r=encodeURIComponent(n);return at.post(`/api/plugins/${r}/disable`)}async function ta(n){const r=encodeURIComponent(n);return at.delete(`/api/plugins/${r}`)}async function na(n){const r=encodeURIComponent(n);return at.get(`/api/plugins/${r}/config_schema`)}async function oa(n){const r=encodeURIComponent(n);return at.get(`/api/plugins/${r}/config`)}async function aa(n,r){const u=encodeURIComponent(n);return at.post(`/api/plugins/${u}/config`,r)}async function sa(){return at.get("/api/plugins/default_states")}async function la(n,r){const u=encodeURIComponent(n);return at.post(`/api/plugins/${u}/set_default_state`,{enabled:r})}async function ia(){return{states:(await sa()).default_states}}const ra=la,ua=na,ca=oa,da=aa;function ga(){return`img_${Date.now()}_${Math.random().toString(36).substring(2,9)}`}function zn(n,r,u){return{id:ga(),fileName:n,originalDataURL:r,translatedDataURL:null,cleanImageData:null,bubbleStates:null,translationStatus:"pending",translationFailed:!1,fontSize:25,autoFontSize:!0,fontFamily:"fonts/STSONG.TTF",layoutDirection:"vertical",textColor:"#000000",fillColor:Hn,inpaintMethod:"solid",strokeEnabled:sn,strokeColor:an,strokeWidth:on,hasUnsavedChanges:!1,...u}}const st=ln("image",()=>{const n=h([]),r=h(-1),u=h(!1),o=h(!1),a=h(null),i=te(()=>r.value>=0&&r.value<n.value.length?n.value[r.value]??null:null),t=te(()=>n.value.length),s=te(()=>n.value.length>0),_=te(()=>r.value>0),E=te(()=>r.value<n.value.length-1),T=te(()=>n.value.filter(f=>f.translationFailed).length),N=te(()=>n.value.filter(f=>f.translationStatus==="completed").length),oe=te(()=>n.value.filter(f=>f.translationStatus==="pending").length);function ne(f,w,c){const F=zn(f,w,c);return n.value.push(F),n.value.length===1&&(r.value=0),console.log(`图片已添加: ${f}，当前共 ${n.value.length} 张图片`),F}function G(f){const w=f.map(({fileName:F,originalDataURL:ve,overrides:W})=>zn(F,ve,W)),c=n.value.length===0;return n.value.push(...w),c&&n.value.length>0&&(r.value=0),console.log(`批量添加了 ${w.length} 张图片，当前共 ${n.value.length} 张`),w}function $(f){n.value=f.map(w=>({...w,strokeEnabled:w.strokeEnabled??sn,strokeColor:w.strokeColor||an,strokeWidth:w.strokeWidth??on,hasUnsavedChanges:w.hasUnsavedChanges||!1})),n.value.length>0?r.value=Math.min(Math.max(0,r.value),n.value.length-1):r.value=-1,console.log(`图片数组已设置，共 ${n.value.length} 张图片`)}function Z(f){return f<0||f>=n.value.length?(console.warn(`删除失败: 无效的索引 ${f}`),!1):(n.value.splice(f,1),r.value===f?(r.value=Math.min(f,n.value.length-1),n.value.length===0&&(r.value=-1)):r.value>f&&r.value--,console.log(`图片已删除，当前共 ${n.value.length} 张图片`),!0)}function X(){return Z(r.value)}function q(){n.value=[],r.value=-1,u.value=!1,o.value=!1,a.value=null,console.log("所有图片已清除")}function d(){const f=i.value?.id||null;if(n.value.sort((w,c)=>w.fileName.localeCompare(c.fileName,void 0,{numeric:!0,sensitivity:"base"})),f){const w=n.value.findIndex(c=>c.id===f);w>=0&&w!==r.value&&(console.log(`图片排序: currentImageIndex 从 ${r.value} 更新为 ${w}`),r.value=w)}console.log("图片已按文件名排序")}function l(f){f>=-1&&f<n.value.length?(r.value=f,console.log(`当前图片索引已设置为 ${f}`)):console.warn(`设置索引失败: 无效的索引 ${f}`)}function C(){return _.value?(r.value--,!0):!1}function x(){return E.value?(r.value++,!0):!1}function O(f){i.value?(Object.assign(i.value,f),console.log("当前图片属性已更新:",Object.keys(f))):console.warn("更新失败: 当前没有选中的图片")}function Q(f,w){if(f>=0&&f<n.value.length){const c=n.value[f];c&&(Object.assign(c,w),console.log(`图片 ${f} 属性已更新:`,Object.keys(w)))}else console.warn(`更新失败: 无效的索引 ${f}`)}function ge(f){i.value&&(i.value.bubbleStates=f,i.value.hasUnsavedChanges=!0,console.log(`当前图片气泡状态已更新，共 ${f?.length??0} 个气泡`))}function j(f){i.value&&(i.value.isManuallyAnnotated=f,i.value.hasUnsavedChanges=!0,console.log(`手动标注标记已设置为: ${f}`))}function P(f,w){i.value?(i.value[f]=w,i.value.hasUnsavedChanges=!0,console.log(`当前图片属性 ${String(f)} 已更新`)):console.warn("更新失败: 当前没有选中的图片")}function B(f,w){i.value&&(i.value.translatedDataURL=f,w&&(i.value.cleanImageData=w),i.value.translationStatus="completed",i.value.translationFailed=!1,i.value.hasUnsavedChanges=!0,console.log("当前图片翻译结果已更新"))}function k(f,w,c){if(f>=0&&f<n.value.length){const F=n.value[f];F&&(F.translationStatus=w,F.translationFailed=w==="failed",c&&(F.errorMessage=c),console.log(`图片 ${f} 翻译状态: ${w}`))}}function m(f){i.value&&(i.value.translationStatus="failed",i.value.translationFailed=!0,i.value.errorMessage=f,console.log(`当前图片翻译失败: ${f}`))}function D(){n.value.forEach(f=>{f.translationStatus="pending",f.translationFailed=!1,f.errorMessage=void 0}),console.log("所有图片翻译状态已重置")}function I(f){u.value=f,f||(o.value=!1,a.value=null),console.log(`批量翻译状态: ${f?"进行中":"已完成"}`)}function p(f){o.value=f,console.log(`批量翻译暂停状态: ${f?"已暂停":"继续中"}`)}function y(f){a.value=f}function ee(){if(o.value&&a.value){o.value=!1;const f=a.value;a.value=null,f(),console.log("批量翻译已继续")}}function se(){return n.value.map((f,w)=>f.translationFailed?w:-1).filter(f=>f!==-1)}return{images:n,currentImageIndex:r,isBatchTranslationInProgress:u,isBatchTranslationPaused:o,batchTranslationResumeCallback:a,currentImage:i,imageCount:t,hasImages:s,canGoPrevious:_,canGoNext:E,failedImageCount:T,completedImageCount:N,pendingImageCount:oe,addImage:ne,addImages:G,setImages:$,deleteImage:Z,deleteCurrentImage:X,clearImages:q,sortImagesByFileName:d,setCurrentImageIndex:l,goToPrevious:C,goToNext:x,updateCurrentImage:O,updateImageByIndex:Q,updateCurrentBubbleStates:ge,setManuallyAnnotated:j,updateCurrentImageProperty:P,updateCurrentTranslationResult:B,setTranslationStatus:k,markCurrentAsFailed:m,resetAllTranslationStatus:D,setBatchTranslationInProgress:I,setBatchTranslationPaused:p,setBatchTranslationResumeCallback:y,resumeBatchTranslation:ee,getFailedImageIndices:se}}),Vn=Object.freeze(Object.defineProperty({__proto__:null,useImageStore:st},Symbol.toStringTag,{value:"Module"})),Zn=ln("session",()=>{const n=h(null),r=h({bookId:null,chapterId:null,bookTitle:null,chapterTitle:null}),u=h([]),o=h(!1),a=h({current:0,total:0,message:""}),i=h(null),t=h(!1),s=te(()=>r.value.bookId!==null&&r.value.chapterId!==null),_=te(()=>r.value.bookId),E=te(()=>r.value.chapterId);function T(k,m,D=null,I=null){r.value={bookId:k,chapterId:m,bookTitle:D,chapterTitle:I},console.log(`会话上下文已设置: 书籍=${k}, 章节=${m}`)}function N(k,m,D,I){T(k,m,D,I)}function oe(){r.value={bookId:null,chapterId:null,bookTitle:null,chapterTitle:null},console.log("会话上下文已清除")}function ne(k){const m=k.get("book"),D=k.get("chapter");m&&D&&T(m,D)}function G(k){n.value=k,console.log(`当前会话名称: ${k}`)}function $(){n.value=null}function Z(k){u.value=k,console.log(`会话列表已更新，共 ${k.length} 个会话`)}function X(k){const m=u.value.findIndex(D=>D.name===k.name);m>=0?u.value[m]=k:u.value.unshift(k)}function q(k){const m=u.value.findIndex(D=>D.name===k);m>=0&&u.value.splice(m,1)}function d(k,m){const D=u.value.find(I=>I.name===k);D&&(D.name=m)}function l(k){o.value=k}function C(k){t.value=k}function x(k){i.value=k}function O(k,m,D,I){return{name:k,version:"2.0",savedAt:new Date().toISOString(),imageCount:m.length,ui_settings:I,images:m.map(p=>({originalDataURL:p.originalDataURL,translatedDataURL:p.translatedDataURL||void 0,cleanImageData:p.cleanImageData||void 0,bubbleStates:p.bubbleStates||void 0,isManuallyAnnotated:p.isManuallyAnnotated||void 0,fileName:p.fileName,fontSize:p.fontSize,autoFontSize:p.autoFontSize,fontFamily:p.fontFamily,layoutDirection:p.layoutDirection,textColor:p.textColor,fillColor:p.fillColor,inpaintMethod:p.inpaintMethod,strokeEnabled:p.strokeEnabled,strokeColor:p.strokeColor,strokeWidth:p.strokeWidth,translationStatus:p.translationStatus,translationFailed:p.translationFailed})),currentImageIndex:D}}function Q(){n.value=null,r.value={bookId:null,chapterId:null,bookTitle:null,chapterTitle:null},u.value=[],o.value=!1,t.value=!1,i.value=null,console.log("会话状态已重置")}async function ge(k){if(!k||typeof k!="string")return null;if(k.startsWith("data:"))return k;if(!k.startsWith("/api/"))return null;try{const m=await fetch(k);if(!m.ok)return null;const D=await m.blob();return new Promise(I=>{const p=new FileReader;p.onloadend=()=>I(p.result),p.onerror=()=>I(null),p.readAsDataURL(D)})}catch(m){return console.error(`转换图片 URL 失败: ${k}`,m),null}}async function j(k,m){const D=k.length;for(let I=0;I<D;I++){const p=k[I];if(p){if(m&&m(I+1,D),p.originalDataURL&&p.originalDataURL.startsWith("/api/")){const y=await ge(p.originalDataURL);y&&(p.originalDataURL=y)}if(p.translatedDataURL&&p.translatedDataURL.startsWith("/api/")){const y=await ge(p.translatedDataURL);y&&(p.translatedDataURL=y)}if(p.cleanImageData&&p.cleanImageData.startsWith("/api/")){const y=await ge(p.cleanImageData);y&&(p.cleanImageData=y.replace(/^data:image\/\w+;base64,/,""))}}}}async function P(k){l(!0),x(null),a.value={current:0,total:0,message:"正在加载..."};try{const{useImageStore:m}=await lt(async()=>{const{useImageStore:F}=await Promise.resolve().then(()=>Vn);return{useImageStore:F}},void 0),{useSettingsStore:D}=await lt(async()=>{const{useSettingsStore:F}=await import("./index.CnztCBXu.js").then(ve=>ve.q);return{useSettingsStore:F}},__vite__mapDeps([0,1,2])),{useBubbleStore:I}=await lt(async()=>{const{useBubbleStore:F}=await Promise.resolve().then(()=>tl);return{useBubbleStore:F}},void 0),p=m(),y=D(),ee=I(),{loadSessionByPathApi:se}=await lt(async()=>{const{loadSessionByPathApi:F}=await import("./session.Kpy-QhBa.js");return{loadSessionByPathApi:F}},__vite__mapDeps([3,4,5])),f=await se(k);if(!f.success||!f.session)throw new Error(f.error||"加载会话失败");const w=f.session;if(w.images&&w.images.length>0){const F=w.images.map((Y,me)=>({id:`session-${me}-${Date.now()}`,originalDataURL:Y.originalDataURL,translatedDataURL:Y.translatedDataURL||null,cleanImageData:Y.cleanImageData||null,bubbleStates:Y.bubbleStates!==void 0&&Y.bubbleStates!==null?Y.bubbleStates:null,isManuallyAnnotated:!!Y.isManuallyAnnotated,fileName:Y.fileName||`image-${me+1}.png`,translationStatus:Y.translationStatus||"pending",translationFailed:!!Y.translationFailed,hasUnsavedChanges:!1,fontSize:Y.fontSize||24,autoFontSize:Y.autoFontSize??!0,fontFamily:Y.fontFamily||"Microsoft YaHei",layoutDirection:Y.layoutDirection||"vertical",textColor:Y.textColor||"#000000",fillColor:Y.fillColor||"#FFFFFF",inpaintMethod:Y.inpaintMethod||"litelama",strokeEnabled:Y.strokeEnabled??!1,strokeColor:Y.strokeColor||"#FFFFFF",strokeWidth:Y.strokeWidth||2}));F.length>0&&(console.log("正在加载图片..."),a.value={current:0,total:F.length,message:"正在加载图片..."},await j(F,(Y,me)=>{const g=Y/me*100;a.value={current:Y,total:me,message:`加载图片 ${Y}/${me}...`},console.log(`加载图片 ${Y}/${me}... (${g.toFixed(0)}%)`)}),a.value={current:F.length,total:F.length,message:"加载完成"},console.log("图片加载完成，已转换为 Base64"),setTimeout(()=>{a.value={current:0,total:0,message:""}},500)),p.setImages(F);let ve=0;typeof w.currentImageIndex=="number"&&(ve=w.currentImageIndex,(ve>=F.length||ve<0)&&(ve=F.length>0?0:-1)),p.setCurrentImageIndex(ve);const W=F[ve];W&&W.bubbleStates&&W.bubbleStates.length>0?ee.setBubbles(W.bubbleStates,!0):ee.clearBubblesLocal(),console.log(`按路径加载会话成功: ${k}, 共 ${F.length} 张图片`)}const c=w.ui_settings;if(c){(c.targetLanguage||c.sourceLanguage)&&y.updateSettings({targetLanguage:c.targetLanguage||void 0,sourceLanguage:c.sourceLanguage||void 0});const F=c.useInpaintingMethod,W=["solid","lama_mpe","litelama"].includes(F)?F:y.settings.textStyle.inpaintMethod;y.updateTextStyle({fontSize:c.fontSize||y.settings.textStyle.fontSize,autoFontSize:c.autoFontSize??y.settings.textStyle.autoFontSize,fontFamily:c.fontFamily||y.settings.textStyle.fontFamily,layoutDirection:c.layoutDirection||y.settings.textStyle.layoutDirection,textColor:c.textColor||y.settings.textStyle.textColor,fillColor:c.fillColor||y.settings.textStyle.fillColor,inpaintMethod:W,strokeEnabled:c.strokeEnabled??y.settings.textStyle.strokeEnabled,strokeColor:c.strokeColor||y.settings.textStyle.strokeColor,strokeWidth:c.strokeWidth||y.settings.textStyle.strokeWidth}),console.log("UI 设置已恢复")}return G(k),!0}catch(m){const D=m instanceof Error?m.message:"加载会话失败";throw x(D),console.error(`按路径加载会话失败: ${k}`,m),m}finally{l(!1)}}async function B(k,m){if(!k||!m)return console.log("未在书籍/章节模式，不支持保存"),!1;console.log(`保存章节会话（分批）: book=${k}, chapter=${m}`);const{useImageStore:D}=await lt(async()=>{const{useImageStore:f}=await Promise.resolve().then(()=>Vn);return{useImageStore:f}},void 0),{useSettingsStore:I}=await lt(async()=>{const{useSettingsStore:f}=await import("./index.CnztCBXu.js").then(w=>w.q);return{useSettingsStore:f}},__vite__mapDeps([0,1,2])),p=D(),y=I(),ee=Array.isArray(p.images)?p.images:[];if(!ee||ee.length===0)return console.log("没有图片数据可保存"),!1;const se=`bookshelf/${k}/${m}`;C(!0),x(null),a.value={current:0,total:100,message:"准备保存..."};try{const{batchSaveStartApi:f,batchSaveImageApi:w,batchSaveCompleteApi:c}=await lt(async()=>{const{batchSaveStartApi:b,batchSaveImageApi:L,batchSaveCompleteApi:z}=await import("./session.Kpy-QhBa.js");return{batchSaveStartApi:b,batchSaveImageApi:L,batchSaveCompleteApi:z}},__vite__mapDeps([3,4,5])),F=ee.length;ee.some(b=>b.originalDataURL&&b.originalDataURL.startsWith("/api/")||b.translatedDataURL&&b.translatedDataURL.startsWith("/api/")||b.cleanImageData&&b.cleanImageData.startsWith("/api/"))&&(console.log("[saveChapterSession] 检测到 /api/ URL 格式图片，开始转换为 Base64..."),a.value={current:2,total:100,message:"转换图片格式..."},await j(ee,(b,L)=>{const z=2+b/L*3;a.value={current:Math.round(z),total:100,message:`转换图片 ${b}/${L}...`}}),console.log("[saveChapterSession] 图片格式转换完成")),a.value={current:5,total:100,message:"收集元数据..."};const{textStyle:W,targetLanguage:Y,sourceLanguage:me}=y.settings,g={targetLanguage:Y,sourceLanguage:me,fontSize:W.fontSize,autoFontSize:W.autoFontSize,fontFamily:W.fontFamily,layoutDirection:W.layoutDirection,textColor:W.textColor,useInpaintingMethod:W.inpaintMethod,fillColor:W.fillColor,strokeEnabled:W.strokeEnabled,strokeColor:W.strokeColor,strokeWidth:W.strokeWidth},v=ee.map(b=>{const L={};for(const z of Object.keys(b))z!=="originalDataURL"&&z!=="translatedDataURL"&&z!=="cleanImageData"&&(L[z]=b[z]);return L.hasOriginalData=!!b.originalDataURL,L.hasTranslatedData=!!b.translatedDataURL,L.hasCleanData=!!b.cleanImageData,L}),M={ui_settings:g,images_meta:v,currentImageIndex:p.currentImageIndex};a.value={current:10,total:100,message:"初始化保存..."};const R=await f(se,M);if(!R.success)throw new Error(R.error||"初始化保存失败");const U=R.session_folder;if(!U)throw new Error("未获取到会话文件夹路径");console.log(`会话文件夹: ${U}`);let le=0,re=0;const ae=b=>!!b&&typeof b=="string"&&b.startsWith("data:");for(let b=0;b<F;b++){const L=ee[b];if(!L)continue;const z=10+b/F*80;if(a.value={current:Math.round(z),total:100,message:`保存图片 ${b+1}/${F}...`},ae(L.originalDataURL))try{const H=await w(U,b,"original",L.originalDataURL);H.success||(console.error(`保存图片 ${b} original 失败:`,H.error),re++)}catch(H){console.error(`保存图片 ${b} original 出错:`,H),re++}if(ae(L.translatedDataURL))try{const H=await w(U,b,"translated",L.translatedDataURL);H.success||(console.error(`保存图片 ${b} translated 失败:`,H.error),re++)}catch(H){console.error(`保存图片 ${b} translated 出错:`,H),re++}if(L.cleanImageData&&typeof L.cleanImageData=="string"&&!L.cleanImageData.startsWith("/api/"))try{const H=await w(U,b,"clean",L.cleanImageData);H.success||(console.error(`保存图片 ${b} clean 失败:`,H.error),re++)}catch(H){console.error(`保存图片 ${b} clean 出错:`,H),re++}le++}a.value={current:95,total:100,message:"完成保存..."};const S=await c(U,v);if(!S.success)throw new Error(S.error||"完成保存失败");return a.value={current:100,total:100,message:"保存完成"},console.log(`分批保存完成: ${le} 张图片, ${re} 个失败`),setTimeout(()=>{a.value={current:0,total:0,message:""}},1e3),!0}catch(f){const w=f instanceof Error?f.message:"保存章节会话失败";return x(w),console.error("分批保存失败:",f),a.value={current:0,total:0,message:""},!1}finally{C(!1)}}return{currentSessionName:n,context:r,sessionList:u,isLoading:o,isSaving:t,error:i,loadingProgress:a,isBookshelfMode:s,currentBookId:_,currentChapterId:E,setContext:T,clearContext:oe,parseContextFromUrl:ne,setSessionName:G,clearSessionName:$,setSessionList:Z,addToSessionList:X,removeFromSessionList:q,renameInSessionList:d,setLoading:l,setSaving:C,setError:x,createSessionData:O,imageUrlToBase64:ge,saveChapterSession:B,loadSessionByPath:P,setBookChapterContext:N,reset:Q}}),ba={key:0,class:"translation-progress-bar"},pa={class:"progress-bar-label"},va={class:"progress-bar"},ma=Ge({__name:"ProgressBar",props:{visible:{type:Boolean,default:!0},percentage:{},label:{default:"进度"}},setup(n){return(r,u)=>n.visible?(V(),J("div",ba,[e("div",pa,ye(n.label),1),e("div",va,[e("div",{class:"progress",style:it({width:`${n.percentage}%`})},null,4)])])):Me("",!0)}}),dn=je(ma,[["__scopeId","data-v-f915cadf"]]),fa={class:"image-upload"},ha={class:"error-text"},ya={key:2,class:"loading-overlay"},xa=Ge({__name:"ImageUpload",emits:["uploadComplete"],setup(n,{expose:r,emit:u}){const o=u,a=st(),i=Qe(),t=h(null),s=h(!1),_=h(!1),E=h(""),T=h(0),N=h(""),oe=h(!1),ne=te(()=>i.settings.pdfProcessingMethod);function G(){t.value?.click()}async function $(P){const B=P.target;!B.files||B.files.length===0||(await d(Array.from(B.files)),B.value="")}async function Z(P){P.preventDefault(),_.value=!1,!(!P.dataTransfer?.files||P.dataTransfer.files.length===0)&&await d(Array.from(P.dataTransfer.files))}function X(P){P.preventDefault(),_.value=!0}function q(P){const B=P.currentTarget.getBoundingClientRect(),k=P.clientX,m=P.clientY;(k<B.left||k>B.right||m<B.top||m>B.bottom)&&(_.value=!1)}async function d(P){if(P.length!==0){s.value=!0,E.value="",oe.value=!0,T.value=0;try{let B=0;const k=P.length;for(let m=0;m<P.length;m++){const D=P[m];if(!D)continue;N.value=D.name;const I=D.type,p=D.name.toLowerCase();if(I.startsWith("image/"))await l(D),B++;else if(I==="application/pdf"||p.endsWith(".pdf")){const y=await C(D);B+=y}else if(p.endsWith(".mobi")||p.endsWith(".azw")||p.endsWith(".azw3")){const y=await ge(D);B+=y}else console.warn(`不支持的文件类型: ${D.name}`),Ie(`不支持的文件类型: ${D.name}`,"warning");T.value=Math.round((m+1)/k*100)}B>0&&(Ie(`已添加 ${B} 张图片`,"success"),o("uploadComplete",B))}catch(B){console.error("处理文件失败:",B);const k=B instanceof Error?B.message:"处理文件失败，请重试";E.value=k,Ie(k,"error")}finally{s.value=!1,oe.value=!1,N.value=""}}}async function l(P){return new Promise((B,k)=>{const m=new FileReader;m.onload=D=>{const I=D.target?.result;a.addImage(P.name,I),B()},m.onerror=()=>k(new Error(`读取图片文件失败: ${P.name}`)),m.readAsDataURL(P)})}async function C(P){return ne.value==="frontend"?await O(P):await Q(P)}function x(P){return new Promise((B,k)=>{const m=new FileReader;m.onload=()=>B(m.result),m.onerror=k,m.readAsDataURL(P)})}async function O(P){try{const B=await lt(()=>import("./pdf.U7tdldy2.js").then(y=>y.p),[]);B.GlobalWorkerOptions.workerSrc=`https://cdnjs.cloudflare.com/ajax/libs/pdf.js/${B.version}/pdf.worker.min.js`;const k=await P.arrayBuffer(),m=await B.getDocument({data:k}).promise,D=m.numPages;console.log(`PDF ${P.name} 共 ${D} 页，开始本地渲染...`),Ie(`正在解析 PDF，共 ${D} 页...`,"info");const I=typeof OffscreenCanvas<"u";I&&console.log("使用 OffscreenCanvas 后台渲染模式");let p=0;for(let y=1;y<=D;y++){N.value=`${P.name} - 第 ${y}/${D} 页`,T.value=Math.round(y/D*100);try{const ee=await m.getPage(y),f=ee.getViewport({scale:2});let w;if(I){const F=new OffscreenCanvas(f.width,f.height),ve=F.getContext("2d");await ee.render({canvasContext:ve,viewport:f}).promise;const W=await F.convertToBlob({type:"image/jpeg",quality:1});w=await x(W)}else{const F=document.createElement("canvas"),ve=F.getContext("2d");F.width=f.width,F.height=f.height,await ee.render({canvasContext:ve,viewport:f}).promise,w=F.toDataURL("image/jpeg",1)}const c=`${P.name}_页面${y}`;a.addImage(c,w),p++,console.log(`  页面 ${y}/${D} 处理完成`)}catch(ee){console.warn(`PDF ${P.name} 第 ${y} 页渲染失败:`,ee)}}return console.log(`PDF ${P.name} 全部 ${D} 页处理完成`),p}catch(B){return console.error("前端 PDF 解析失败:",B),Ie("前端 PDF 解析失败，尝试使用后端解析...","warning"),await Q(P)}}async function Q(P){let k=null;try{Ie("正在上传 PDF 文件...","info");const m=await Ao(P,5);if(!m.success||!m.session_id)throw new Error(m.error||"PDF 解析启动失败");k=m.session_id;const D=m.total_pages||0;console.log(`PDF ${P.name} 共 ${D} 页，开始后端分批解析...`),Ie(`正在解析 PDF，共 ${D} 页...`,"info");let I=0;for(let p=0;p<D;p+=5){N.value=`${P.name} - 处理中 ${Math.min(p+5,D)}/${D} 页`,T.value=D>0?Math.round(p/D*100):0;const y=await Fo(k,p,5);if(!y.success){console.warn(`批次 ${p} 获取失败:`,y.error);continue}if(y.images&&y.images.length>0)for(const ee of y.images){if(!ee||!ee.data_url)continue;const se=`${P.name}_页面${String(ee.page_index+1).padStart(4,"0")}`;a.addImage(se,ee.data_url),I++}console.log(`  已加载 ${I}/${D} 页`)}return console.log(`PDF ${P.name} 全部 ${I} 页处理完成`),I}catch(m){throw console.error("后端 PDF 解析失败:",m),m}finally{if(k)try{await Lo(k)}catch(m){console.warn("PDF 会话清理失败:",m)}}}async function ge(P){let B=null;try{Ie("正在上传电子书文件...","info");const k=await Uo(P,5);if(!k.success||!k.session_id)throw new Error(k.error||"MOBI/AZW 解析启动失败");B=k.session_id;const m=k.total_images||0;Ie(`正在解析电子书，共 ${m} 张图片...`,"info");let D=0,I=!0;for(;I;){N.value=`${P.name} - 已处理 ${D}/${m} 张`,T.value=m>0?Math.round(D/m*100):0;const p=await Oo(B);if(!p.success)throw new Error(p.error||"MOBI/AZW 批次解析失败");if(p.images&&p.images.length>0){for(let y=0;y<p.images.length;y++){const ee=p.images[y];if(!ee)continue;const se=D+y+1,f=`${P.name.replace(/\.(mobi|azw|azw3)$/i,"")}_image_${String(se).padStart(3,"0")}.png`,w=ee.startsWith("data:")?ee:`data:image/png;base64,${ee}`;a.addImage(f,w)}D+=p.images.length}I=p.has_more??!1}return D}catch(k){throw console.error("MOBI/AZW 解析失败:",k),k}finally{if(B)try{await zo(B)}catch(k){console.warn("MOBI/AZW 会话清理失败:",k)}}}function j(){E.value=""}return r({triggerFileSelect:G,processFiles:d,clearError:j}),(P,B)=>(V(),J("div",fa,[e("div",{id:"drop-area",class:Le(["drop-area",{"drag-over":_.value,loading:s.value}]),onDragover:X,onDragleave:q,onDrop:Z},[e("div",{class:"drop-content"},[e("p",{class:"drop-text"},[B[0]||(B[0]=Ne(" 拖拽图片、PDF或MOBI文件到这里，或 ",-1)),e("span",{class:"select-link",onClick:G}," 点击选择文件 ")])]),e("input",{ref_key:"fileInputRef",ref:t,type:"file",id:"imageUpload",accept:"image/*,application/pdf,.mobi,.azw,.azw3",multiple:"",class:"file-input",onChange:$},null,544)],34),oe.value?(V(),rt(dn,{key:0,visible:!0,percentage:T.value,label:N.value||"处理中..."},null,8,["percentage","label"])):Me("",!0),E.value?(V(),J("div",{key:1,class:"error-message",onClick:j},[B[1]||(B[1]=e("span",{class:"error-icon"},"⚠️",-1)),e("span",ha,ye(E.value),1),B[2]||(B[2]=e("span",{class:"error-close"},"×",-1))])):Me("",!0),s.value&&!oe.value?(V(),J("div",ya,[...B[3]||(B[3]=[e("div",{class:"spinner"},null,-1),e("span",{class:"loading-text"},"处理中...",-1)])])):Me("",!0)]))}}),Sa=je(xa,[["__scopeId","data-v-37201604"]]),ka={id:"settings-sidebar",class:"settings-sidebar"},_a={class:"card settings-card"},Ca={id:"font-settings",class:"settings-card collapsible-panel"},wa={class:"toggle-icon"},$a={class:"collapsible-content"},Ta={class:"settings-form"},Ia={class:"form-group"},Da=["value","disabled","title"],Ra={class:"auto-fontSize-option",title:"勾选后，首次翻译时自动为每个气泡计算合适的字号"},Ma=["checked"],Ba={class:"form-group"},Ea={class:"form-group"},Pa={class:"form-group"},Aa=["value"],Fa={class:"form-group"},La={class:"checkbox-label"},Ua=["checked"],Oa={key:0,id:"strokeOptions",class:"stroke-options"},za={class:"form-group"},Va=["value"],Na={class:"form-group"},Wa=["value"],Ka={class:"form-group"},qa={key:0,id:"solidColorOptions",class:"form-group"},Ha=["value"],Ja={class:"apply-settings-group"},Ya=["disabled"],Xa={key:0,class:"apply-options-dropdown"},ja={class:"apply-option"},Ga=["checked"],Za={class:"apply-option"},Qa={class:"apply-option"},es={class:"apply-option"},ts={class:"apply-option"},ns={class:"apply-option"},os={class:"apply-option"},as={class:"apply-option"},ss={class:"apply-option"},ls={class:"action-buttons"},is=["disabled"],rs=["disabled"],us=["disabled"],cs=["disabled"],ds=["disabled"],gs=["disabled"],bs=["disabled"],ps=["disabled"],vs={class:"navigation-buttons"},ms=["disabled"],fs=["disabled"],hs=Ge({__name:"SettingsSidebar",emits:["translateCurrent","translateAll","hqTranslate","proofread","removeText","removeAllText","deleteCurrent","clearAll","cleanTemp","openPlugins","openSettings","previous","next","applyToAll","textStyleChanged","autoFontSizeChanged"],setup(n,{emit:r}){const u=r,o=st(),a=Qe(),i=h(!0),t=h(!1),s=h({fontSize:!0,fontFamily:!0,layoutDirection:!0,textColor:!0,fillColor:!0,strokeEnabled:!0,strokeColor:!0,strokeWidth:!0}),_=[{label:"自动 (根据检测)",value:"auto"},{label:"竖向排版",value:"vertical"},{label:"横向排版",value:"horizontal"}],E=[{label:"纯色填充",value:"solid"},{label:"LAMA修复 (速度优化)",value:"lama_mpe"},{label:"LAMA修复 (通用)",value:"litelama"}],T=te(()=>o.currentImage),N=te(()=>o.hasImages),oe=te(()=>N.value&&!o.isBatchTranslationInProgress),ne=te(()=>o.canGoPrevious),G=te(()=>o.canGoNext),$=te(()=>a.textStyle),Z=h([]),X=["fonts/STSONG.TTF","fonts/msyh.ttc","fonts/simhei.ttf","fonts/simsun.ttc"],q=h(null),d=te(()=>{const w=Z.value.map(c=>({label:ge(c),value:c}));return w.push({label:"自定义字体...",value:"custom-font"}),w});ut(async()=>{await l();const w=$.value.fontFamily;w&&!Z.value.includes(w)&&(Z.value=[w,...Z.value])});async function l(){try{const w=await Xn();if(w.fonts&&Array.isArray(w.fonts)&&w.fonts.length>0){const c=w.fonts[0];if(typeof c=="object"&&"path"in c){const F=w.fonts.map(ve=>typeof ve=="object"?ve.path:ve);Z.value=F}else Z.value=w.fonts}else Z.value=[...X]}catch(w){console.error("加载字体列表失败:",w),Z.value=[...X]}}function C(){i.value=!i.value}function x(w){const c=parseInt(w.target.value);isNaN(c)||(a.updateTextStyle({fontSize:c}),u("textStyleChanged","fontSize",c))}function O(w){const c=w.target.checked;a.updateTextStyle({autoFontSize:c}),console.log(`自动字号设置变更: ${c}`),u("autoFontSizeChanged",c)}async function Q(w){const c=w.target,F=c.files?.[0];if(!F)return;const ve=[".ttf",".ttc",".otf"],W=F.name.toLowerCase();if(!ve.some(me=>W.endsWith(me))){Ie("请选择 .ttf、.ttc 或 .otf 格式的字体文件","error"),c.value="";return}try{const me=await qo(F);me.success&&me.fontPath?(await l(),a.updateTextStyle({fontFamily:me.fontPath}),Ie("字体上传成功","success")):Ie(me.error||"字体上传失败","error")}catch(me){console.error("字体上传失败:",me),Ie("字体上传失败","error")}finally{c.value=""}}function ge(w){const c={"fonts/STXINGKA.TTF":"华文行楷","fonts/STXINWEI.TTF":"华文新魏","fonts/STZHONGS.TTF":"华文中宋","fonts/STKAITI.TTF":"楷体","fonts/STLITI.TTF":"隶书","fonts/STSONG.TTF":"华文宋体","fonts/msyh.ttc":"微软雅黑","fonts/msyhbd.ttc":"微软雅黑粗体","fonts/SIMYOU.TTF":"幼圆","fonts/STFANGSO.TTF":"仿宋","fonts/STHUPO.TTF":"华文琥珀","fonts/STXIHEI.TTF":"华文细黑","fonts/simkai.ttf":"中易楷体","fonts/simfang.ttf":"中易仿宋","fonts/simhei.ttf":"中易黑体","fonts/SIMLI.TTF":"中易隶书","fonts/simsun.ttc":"宋体"};if(c[w])return c[w];const F=w.split("/").pop()||w;for(const[ve,W]of Object.entries(c))if((ve.split("/").pop()||"").toLowerCase()===F.toLowerCase())return W;return F.replace(/\.(ttf|ttc|otf)$/i,"")}function j(w){const c=String(w);if(c==="custom-font"){q.value?.click();return}a.updateTextStyle({fontFamily:c}),u("textStyleChanged","fontFamily",c)}function P(w){const c=String(w);a.updateTextStyle({layoutDirection:c}),u("textStyleChanged","layoutDirection",c)}function B(w){const c=String(w);a.updateTextStyle({inpaintMethod:c})}function k(w){const c=w.target.value;a.updateTextStyle({textColor:c}),u("textStyleChanged","textColor",c)}function m(w){const c=w.target.checked;a.updateTextStyle({strokeEnabled:c}),u("textStyleChanged","strokeEnabled",c)}function D(w){const c=w.target.value;a.updateTextStyle({strokeColor:c}),u("textStyleChanged","strokeColor",c)}function I(w){const c=parseInt(w.target.value);isNaN(c)||(a.updateTextStyle({strokeWidth:c}),u("textStyleChanged","strokeWidth",c))}function p(w){const c=w.target.value;a.updateTextStyle({fillColor:c}),u("textStyleChanged","fillColor",c)}function y(){t.value=!t.value}function ee(){const c=!Object.values(s.value).every(F=>F);s.value={fontSize:c,fontFamily:c,layoutDirection:c,textColor:c,fillColor:c,strokeEnabled:c,strokeColor:c,strokeWidth:c}}function se(){u("applyToAll",{...s.value}),t.value=!1}function f(w){w.target.closest(".apply-settings-group")||(t.value=!1)}return typeof window<"u"&&window.addEventListener("click",f),(w,c)=>(V(),J("aside",ka,[e("div",_a,[c[42]||(c[42]=e("h2",null,"翻译设置",-1)),e("div",Ca,[e("h3",{class:"collapsible-header",onClick:C},[c[20]||(c[20]=Ne(" 文字设置 ",-1)),e("span",wa,ye(i.value?"▼":"▶"),1)]),ie(e("div",$a,[e("div",Ta,[e("div",Ia,[c[22]||(c[22]=e("label",{for:"fontSize"},"字号大小:",-1)),e("input",{type:"number",id:"fontSize",value:$.value.fontSize,min:"10",max:"100",disabled:$.value.autoFontSize,class:Le({"disabled-input":$.value.autoFontSize}),title:$.value.autoFontSize?"已启用自动字号，首次翻译时将自动计算":"",onInput:x},null,42,Da),e("span",Ra,[e("input",{type:"checkbox",id:"autoFontSize",checked:$.value.autoFontSize,onChange:O},null,40,Ma),c[21]||(c[21]=e("label",{for:"autoFontSize"},"自动计算初始字号",-1))])]),e("div",Ba,[c[23]||(c[23]=e("label",{for:"fontFamily"},"文本字体:",-1)),Re(We,{"model-value":$.value.fontFamily,options:d.value,onChange:j},null,8,["model-value","options"]),e("input",{ref_key:"fontUploadInput",ref:q,type:"file",id:"fontUpload",accept:".ttf,.ttc,.otf",style:{display:"none"},onChange:Q},null,544)]),e("div",Ea,[c[24]||(c[24]=e("label",{for:"layoutDirection"},"排版设置:",-1)),Re(We,{"model-value":$.value.layoutDirection,options:_,onChange:P},null,8,["model-value"])]),e("div",Pa,[c[25]||(c[25]=e("label",{for:"textColor"},"文字颜色:",-1)),e("input",{type:"color",id:"textColor",value:$.value.textColor,onInput:k},null,40,Aa)]),e("div",Fa,[e("span",La,[e("input",{type:"checkbox",id:"strokeEnabled",checked:$.value.strokeEnabled,onChange:m},null,40,Ua),c[26]||(c[26]=e("label",{for:"strokeEnabled"},"启用文本描边:",-1))])]),Re(Un,{name:"stroke-slide"},{default:yt(()=>[$.value.strokeEnabled?(V(),J("div",Oa,[e("div",za,[c[27]||(c[27]=e("label",{for:"strokeColor"},"描边颜色:",-1)),e("input",{type:"color",id:"strokeColor",value:$.value.strokeColor,onInput:D},null,40,Va)]),e("div",Na,[c[28]||(c[28]=e("label",{for:"strokeWidth"},"描边宽度 (px):",-1)),e("input",{type:"number",id:"strokeWidth",value:$.value.strokeWidth,min:"0",max:"10",style:{width:"60px",padding:"5px"},onInput:I},null,40,Wa),c[29]||(c[29]=e("div",{class:"input-hint"},"0 表示无描边。",-1))])])):Me("",!0)]),_:1}),e("div",Ka,[c[30]||(c[30]=e("label",{for:"useInpainting"},"气泡填充方式:",-1)),Re(We,{"model-value":$.value.inpaintMethod,options:E,onChange:B},null,8,["model-value"])]),Re(Un,{name:"slide-fade"},{default:yt(()=>[$.value.inpaintMethod==="solid"?(V(),J("div",qa,[c[31]||(c[31]=e("label",{for:"fillColor"},"填充颜色:",-1)),e("input",{type:"color",id:"fillColor",value:$.value.fillColor,onInput:p},null,40,Ha)])):Me("",!0)]),_:1})]),e("div",Ja,[e("button",{type:"button",class:"settings-button",disabled:!N.value,onClick:se}," 应用到全部 ",8,Ya),e("button",{type:"button",class:"settings-gear-btn",title:"选择要应用的参数",onClick:y}," ⚙️ "),t.value?(V(),J("div",Xa,[e("div",ja,[e("input",{type:"checkbox",id:"apply_selectAll",checked:Object.values(s.value).every(F=>F),onChange:ee},null,40,Ga),c[32]||(c[32]=e("label",{for:"apply_selectAll"},"全选",-1))]),c[41]||(c[41]=e("hr",null,null,-1)),e("div",Za,[ie(e("input",{type:"checkbox",id:"apply_fontSize","onUpdate:modelValue":c[0]||(c[0]=F=>s.value.fontSize=F)},null,512),[[tt,s.value.fontSize]]),c[33]||(c[33]=e("label",{for:"apply_fontSize"},"字号",-1))]),e("div",Qa,[ie(e("input",{type:"checkbox",id:"apply_fontFamily","onUpdate:modelValue":c[1]||(c[1]=F=>s.value.fontFamily=F)},null,512),[[tt,s.value.fontFamily]]),c[34]||(c[34]=e("label",{for:"apply_fontFamily"},"字体",-1))]),e("div",es,[ie(e("input",{type:"checkbox",id:"apply_layoutDirection","onUpdate:modelValue":c[2]||(c[2]=F=>s.value.layoutDirection=F)},null,512),[[tt,s.value.layoutDirection]]),c[35]||(c[35]=e("label",{for:"apply_layoutDirection"},"排版方向",-1))]),e("div",ts,[ie(e("input",{type:"checkbox",id:"apply_textColor","onUpdate:modelValue":c[3]||(c[3]=F=>s.value.textColor=F)},null,512),[[tt,s.value.textColor]]),c[36]||(c[36]=e("label",{for:"apply_textColor"},"文字颜色",-1))]),e("div",ns,[ie(e("input",{type:"checkbox",id:"apply_fillColor","onUpdate:modelValue":c[4]||(c[4]=F=>s.value.fillColor=F)},null,512),[[tt,s.value.fillColor]]),c[37]||(c[37]=e("label",{for:"apply_fillColor"},"填充颜色",-1))]),e("div",os,[ie(e("input",{type:"checkbox",id:"apply_strokeEnabled","onUpdate:modelValue":c[5]||(c[5]=F=>s.value.strokeEnabled=F)},null,512),[[tt,s.value.strokeEnabled]]),c[38]||(c[38]=e("label",{for:"apply_strokeEnabled"},"描边开关",-1))]),e("div",as,[ie(e("input",{type:"checkbox",id:"apply_strokeColor","onUpdate:modelValue":c[6]||(c[6]=F=>s.value.strokeColor=F)},null,512),[[tt,s.value.strokeColor]]),c[39]||(c[39]=e("label",{for:"apply_strokeColor"},"描边颜色",-1))]),e("div",ss,[ie(e("input",{type:"checkbox",id:"apply_strokeWidth","onUpdate:modelValue":c[7]||(c[7]=F=>s.value.strokeWidth=F)},null,512),[[tt,s.value.strokeWidth]]),c[40]||(c[40]=e("label",{for:"apply_strokeWidth"},"描边宽度",-1))])])):Me("",!0)])],512),[[Ke,i.value]])]),e("div",ls,[e("button",{id:"translateButton",disabled:!oe.value,onClick:c[8]||(c[8]=F=>u("translateCurrent"))}," 翻译当前图片 ",8,is),e("button",{id:"translateAllButton",disabled:!oe.value,onClick:c[9]||(c[9]=F=>u("translateAll"))}," 翻译所有图片 ",8,rs),e("button",{id:"startHqTranslationBtn",class:"settings-button purple-button",disabled:!oe.value,title:"使用高质量翻译模式（需在设置中配置）",onClick:c[10]||(c[10]=F=>u("hqTranslate"))}," 高质量翻译 ",8,us),e("button",{id:"proofreadButton",disabled:!oe.value,onClick:c[11]||(c[11]=F=>u("proofread"))}," AI校对 ",8,cs),e("button",{id:"removeTextOnlyButton",disabled:!T.value,title:"消除图片中的气泡文字，无需填写翻译服务商和API Key",onClick:c[12]||(c[12]=F=>u("removeText"))}," 仅消除文字 ",8,ds),e("button",{id:"removeAllTextButton",disabled:!N.value,title:"消除所有图片中的气泡文字，无需填写翻译服务商和API Key",onClick:c[13]||(c[13]=F=>u("removeAllText"))}," 消除所有图片文字 ",8,gs),e("button",{id:"deleteCurrentImageButton",class:"settings-button red-button",disabled:!T.value,onClick:c[14]||(c[14]=F=>u("deleteCurrent"))}," 删除当前图片 ",8,bs),e("button",{id:"clearAllImagesButton",class:"settings-button red-button",disabled:!N.value,onClick:c[15]||(c[15]=F=>u("clearAll"))}," 清除所有图片 ",8,ps),e("button",{id:"cleanDebugFilesButton",class:"settings-button orange-button",onClick:c[16]||(c[16]=F=>u("cleanTemp"))}," 清理临时文件 "),e("button",{id:"managePluginsButton",class:"settings-button blue-button",onClick:c[17]||(c[17]=F=>u("openPlugins"))}," 插件管理 ")]),e("div",vs,[e("button",{id:"prevImageButton",disabled:!ne.value,onClick:c[18]||(c[18]=F=>u("previous"))}," 上一张 ",8,ms),e("button",{id:"nextImageButton",disabled:!G.value,onClick:c[19]||(c[19]=F=>u("next"))}," 下一张 ",8,fs)])])]))}}),ys=je(hs,[["__scopeId","data-v-2dcef39a"]]);function _t(n){if(n.textDirection&&n.textDirection!=="auto")return n.textDirection;if(n.autoTextDirection&&n.autoTextDirection!=="auto")return n.autoTextDirection;if(n.coords){const[r,u,o,a]=n.coords;return a-u>o-r?"vertical":"horizontal"}return"vertical"}function xs(){const n=st(),r=Qe(),u=dt(),o=h(!1),a=h(0),i=h(""),t=h(!1),s=h(0),_=h(""),E=te(()=>n.hasImages),T=te(()=>n.hasImages),N=te(()=>n.hasImages);function oe(){const d=n.images;if(d.length===0){u.warning("没有可导出的图片文本");return}const l=[];for(let P=0;P<d.length;P++){const B=d[P];if(!B)continue;const k=B.bubbleStates||[],m={imageIndex:P,bubbles:[]};for(let D=0;D<k.length;D++){const I=k[D];if(!I)continue;const p=I.originalText||"",y=I.translatedText||I.textboxText||"";let ee="vertical";I.textDirection&&I.textDirection!=="auto"?ee=I.textDirection:I.autoTextDirection&&(ee=I.autoTextDirection),m.bubbles.push({bubbleIndex:D,original:p,translated:y,textDirection:ee})}l.push(m)}const C=JSON.stringify(l,null,2),x=new Blob([C],{type:"application/json"}),O=URL.createObjectURL(x),Q=document.createElement("a");Q.href=O;const j=new Date().toISOString().replace(/[-:T]/g,"").slice(0,15);Q.download=`translations_${j}.json`,document.body.appendChild(Q),Q.click(),document.body.removeChild(Q),URL.revokeObjectURL(O),u.success("文本导出成功！")}function ne(){const d=n.images;if(d.length===0)return null;const l=[];for(let C=0;C<d.length;C++){const x=d[C];if(!x)continue;const O=x.bubbleStates||[],Q={imageIndex:C,bubbles:[]};for(let ge=0;ge<O.length;ge++){const j=O[ge];if(!j)continue;const P=j.originalText||"",B=j.translatedText||j.textboxText||"";let k="vertical";j.textDirection&&j.textDirection!=="auto"?k=j.textDirection:j.autoTextDirection&&(k=j.autoTextDirection),Q.bubbles.push({bubbleIndex:ge,original:P,translated:B,textDirection:k})}l.push(Q)}return l}async function G(d){if(!d){u.warning("未选择文件");return}t.value=!0,s.value=0,_.value="准备导入文本...",u.info("正在导入文本...",0);try{const l=await $(d);s.value=10,_.value="解析 JSON 数据...";const C=JSON.parse(l);if(!Array.isArray(C))throw new Error("导入的 JSON 格式不正确，应为数组");let x=0,O=0;const Q=r.settings.textStyle,ge=Q.autoFontSize?"auto":Q.fontSize,j=Q.fontFamily,P=Q.textColor,B=Q.fillColor;s.value=20,_.value="开始更新图片...";const k=C.length;let m=0;const D=[];for(const y of C){m++;const ee=20+m/k*60;s.value=ee,_.value=`处理图片 ${m}/${k}`;const se=y.imageIndex;if(se<0||se>=n.images.length){console.warn(`跳过无效的图片索引: ${se}`);continue}const f=n.images[se];if(!f)continue;let w=!1;f.bubbleStates||(f.bubbleStates=[]),f.bubbleTexts||(f.bubbleTexts=[]),f.originalTexts||(f.originalTexts=[]);for(const c of y.bubbles){const F=c.bubbleIndex,ve=c.original,W=c.translated,Y=c.textDirection,me=Y==="vertical"||Y==="horizontal"?Y:"vertical";for(;f.bubbleTexts.length<=F;)f.bubbleTexts.push("");for(;f.originalTexts.length<=F;)f.originalTexts.push("");for(ve&&(f.originalTexts[F]=ve),W&&(f.bubbleTexts[F]=W);f.bubbleStates.length<=F;)f.bubbleStates.push(Z(ge,j,P,B));const g=f.bubbleStates[F];g&&(ve&&(g.originalText=ve),W&&(g.translatedText=W,g.textboxText=W),g.textDirection=me,w=!0,O++)}w&&f.bubbleStates&&(f.bubbleTexts=f.bubbleStates.map(c=>c.translatedText||"")),w&&(x++,f.hasUnsavedChanges=!0,f.translatedDataURL&&f.bubbleStates&&f.bubbleStates.length>0&&D.push(se))}if(D.length>0){s.value=80,_.value="开始渲染图片...",u.info("正在渲染图片，请稍候...",0);const y=r.settings.textStyle,ee=y.layoutDirection,se=ee==="auto";for(let f=0;f<D.length;f++){const w=D[f];if(w===void 0)continue;const c=n.images[w];if(!(!c||!c.bubbleStates)){s.value=80+f/D.length*20,_.value=`渲染图片 ${f+1}/${D.length}`;try{let F="";if(c.cleanImageData?F=c.cleanImageData.includes("base64,")?c.cleanImageData.split("base64,")[1]||"":c.cleanImageData:c.originalDataURL&&(F=c.originalDataURL.includes("base64,")?c.originalDataURL.split("base64,")[1]||"":c.originalDataURL,console.log(`importText: 图片 ${w} 使用原图作为背景（兜底）`)),!F){console.log(`importText: 图片 ${w} 没有可用的背景图，跳过`);continue}const ve=c.bubbleStates.map(Y=>({translatedText:Y.translatedText||"",coords:Y.coords,fontSize:Y.fontSize||y.fontSize,fontFamily:Y.fontFamily||y.fontFamily,textDirection:_t(Y),textColor:Y.textColor||y.textColor,rotationAngle:Y.rotationAngle||0,position:Y.position||{x:0,y:0},strokeEnabled:Y.strokeEnabled??y.strokeEnabled,strokeColor:Y.strokeColor||y.strokeColor,strokeWidth:Y.strokeWidth??y.strokeWidth})),W=await un({clean_image:F,bubble_texts:ve.map(Y=>Y.translatedText),bubble_coords:ve.map(Y=>Y.coords),fontSize:y.fontSize,fontFamily:y.fontFamily,textDirection:se?"vertical":ee,textColor:y.textColor,bubble_states:ve,use_individual_styles:!0,use_inpainting:!1,use_lama:!1,is_font_style_change:!0,strokeEnabled:y.strokeEnabled,strokeColor:y.strokeColor,strokeWidth:y.strokeWidth});W.rendered_image&&(n.updateImageByIndex(w,{translatedDataURL:`data:image/png;base64,${W.rendered_image}`,hasUnsavedChanges:!0}),console.log(`importText: 图片 ${w} 渲染成功`))}catch(F){console.error(`importText: 重渲染图片 ${w} 失败:`,F)}}}}s.value=100,_.value="导入完成";const I=D.length,p=I>0?`导入成功！更新了 ${x} 张图片中的 ${O} 个气泡文本，重渲染了 ${I} 张图片`:`导入成功！更新了 ${x} 张图片中的 ${O} 个气泡文本`;u.success(p)}catch(l){console.error("导入文本出错:",l),u.error(`导入失败: ${l instanceof Error?l.message:String(l)}`)}finally{t.value=!1,setTimeout(()=>{s.value=0,_.value=""},2e3)}}function $(d){return new Promise((l,C)=>{const x=new FileReader;x.onload=O=>{O.target?.result?l(O.target.result):C(new Error("读取文件失败"))},x.onerror=()=>C(new Error("读取文件时出错")),x.readAsText(d)})}function Z(d,l,C,x){const O=r.settings.textStyle;return{coords:[0,0,100,100],polygon:[],originalText:"",translatedText:"",textboxText:"",fontSize:typeof d=="number"?d:25,fontFamily:l,textDirection:"vertical",autoTextDirection:"vertical",textColor:C,fillColor:x,rotationAngle:0,position:{x:0,y:0},strokeEnabled:O.strokeEnabled,strokeColor:O.strokeColor,strokeWidth:O.strokeWidth,inpaintMethod:O.inpaintMethod}}function X(){const d=n.currentImage;if(!d){u.warning("没有可下载的图片");return}const l=d.translatedDataURL||d.originalDataURL;if(!l){u.warning("没有可下载的图片");return}o.value=!0;try{const C=l.split(",")[1];if(!C)throw new Error("无效的图片数据");const x=atob(C),O=[];for(let k=0;k<x.length;k+=512){const m=x.slice(k,k+512),D=new Array(m.length);for(let p=0;p<m.length;p++)D[p]=m.charCodeAt(p);const I=new Uint8Array(D);O.push(I.buffer)}const Q=new Blob(O,{type:"image/png"}),ge=URL.createObjectURL(Q),j=document.createElement("a");j.href=ge;let P=d.fileName||`image_${n.currentImageIndex}.png`;P=`${d.translatedDataURL?"translated":"original"}_${P.replace(/\.[^/.]+$/,"")}.png`,j.download=P,document.body.appendChild(j),j.click(),document.body.removeChild(j),URL.revokeObjectURL(ge),u.success(`下载成功: ${P}`)}catch(C){console.error("下载图片时出错:",C),u.error("下载失败")}finally{o.value=!1}}async function q(d="zip"){const l=n.images;if(l.length===0){u.warning("没有可下载的图片");return}o.value=!0,a.value=0,i.value="准备下载...",u.info("下载中...处理可能需要一定时间，请耐心等待...",0);try{const C=[];let x=0,O=0;a.value=5,i.value="检查图片数据...";for(let p=0;p<l.length;p++){const y=l[p];y&&(y.translatedDataURL?(C.push({index:p,type:"translated"}),x++):y.originalDataURL&&(C.push({index:p,type:"original"}),O++))}if(C.length===0){u.warning("没有可下载的图片");return}a.value=10,i.value="创建下载会话...";const Q=await Vo(C.length);if(!Q.success||!Q.session_id)throw new Error(Q.error||"创建会话失败");const ge=Q.session_id,j=C.length;let P=0,B=0;for(let p=0;p<C.length;p++){const y=C[p];if(!y)continue;const ee=l[y.index];if(!ee)continue;const se=y.type==="translated"?ee.translatedDataURL:ee.originalDataURL;if(!se)continue;const f=10+p/j*70;a.value=f,i.value=`上传图片 ${p+1}/${j}...`;try{const w=await No(ge,se,p);w.success?P++:(console.error(`上传图片 ${p} 失败:`,w.error),B++)}catch(w){console.error(`上传图片 ${p} 出错:`,w),B++}}if(P===0)throw new Error("所有图片上传失败");a.value=85,i.value="打包文件...";const k=await Wo(ge,d);if(!k.success||!k.file_id)throw new Error(k.error||"打包失败");a.value=95,i.value="准备下载...";const m=Ko(k.file_id,d),D=document.createElement("a");D.href=m,document.body.appendChild(D),D.click(),document.body.removeChild(D),a.value=100,i.value="下载已开始";let I=`已成功处理 ${P} 张图片`;B>0&&(I+=`（${B} 张失败）`),x>0&&O>0?I+=`（${x} 张翻译图片和 ${O} 张原始图片）`:x>0?I+="（全部为翻译后图片）":O>0&&(I+="（全部为原始图片）"),I+="，下载即将开始",u.success(I),setTimeout(async()=>{try{const p=await rn();console.log("临时文件清理结果:",p)}catch(p){console.error("清理临时文件失败:",p)}},6e4)}catch(C){console.error("下载所有图片时出错:",C),u.error(`下载失败: ${C instanceof Error?C.message:String(C)}`)}finally{o.value=!1,setTimeout(()=>{a.value=0,i.value=""},2e3)}}return{isDownloading:o,downloadProgress:a,downloadProgressText:i,isImporting:t,importProgress:s,importProgressText:_,canExportText:E,canImportText:T,canDownload:N,exportText:oe,exportTextToJson:ne,importText:G,downloadCurrentImage:X,downloadAllImages:q}}const Ss={key:0,class:"result-section card result-card"},ks={class:"image-controls"},_s={class:"image-size-control"},Cs=["value"],ws={id:"imageSizeValue"},$s={class:"content-container"},Ts={class:"image-container"},Is=["src"],Ds={id:"detectedTextInfo",class:"text-info"},Rs={id:"detectedTextList"},Ms={class:"original-text"},Bs={class:"download-section"},Es={class:"download-buttons"},Ps=["disabled"],As={class:"download-all-container"},Fs=["disabled"],Ls={class:"download-format-selector"},Us=["disabled"],Os=["disabled"],zs={key:1,class:"empty-state-section"},jt=60,Vs=Ge({__name:"ImageResultDisplay",props:{isEditMode:{type:Boolean,default:!1}},emits:["toggle-edit-mode","retry-failed"],setup(n,{emit:r}){const u=[{label:"ZIP压缩包",value:"zip"},{label:"PDF文档",value:"pdf"},{label:"CBZ漫画",value:"cbz"}],o=r,a=st(),i=Qe(),t=xs(),s=h(100),_=te({get:()=>$.value?.showOriginal??!1,set:f=>{$.value&&a.updateCurrentImage({showOriginal:f})}}),E=h("zip"),T=h(null),N=te(()=>t.isDownloading.value),oe=te(()=>t.downloadProgressText.value),ne=te(()=>t.downloadProgress.value),G=te(()=>a.hasImages),$=te(()=>a.currentImage),Z=te(()=>!!$.value?.translatedDataURL),X=te(()=>!!($.value?.translatedDataURL||$.value?.originalDataURL)),q=te(()=>$.value?_.value||!$.value.translatedDataURL?$.value.originalDataURL:$.value.translatedDataURL:""),d=te(()=>a.failedImageCount>0),l=te(()=>({width:`${s.value}%`})),C=te(()=>i.settings.useTextboxPrompt),x=te(()=>{if(!$.value)return[];if($.value.bubbleStates&&$.value.bubbleStates.length>0)return $.value.bubbleStates.map(c=>({original:c.originalText||"",translated:C.value?c.textboxText||c.translatedText||"":c.translatedText||""}));const f=$.value.originalTexts||[],w=C.value?$.value.textboxTexts||$.value.bubbleTexts||[]:$.value.bubbleTexts||[];return f.length===0?[]:f.map((c,F)=>({original:c||"",translated:w[F]||""}))}),O=te(()=>x.value.length>0);function Q(f){if(!f||f.length<=jt)return f;let w="",c="";for(let F=0;F<f.length;F++)if(c+=f[F],c.length>=jt){let ve=-1;for(let W=c.length-1;W>=0;W--){const Y=c[W];if(Y&&["。","！","？",".","!","?","；",";","，",","].includes(Y)){ve=W+1;break}}ve>jt*.6?(w+=c.substring(0,ve)+`
`,c=c.substring(ve)):(w+=c+`
`,c="")}return c&&(w+=c),w}function ge(f){return Q((f||"").trim())}function j(f){const w=(f||"").trim();return Q(w)}function P(f){return(f||"").includes("翻译失败")}function B(){_.value=!_.value}function k(){o("toggle-edit-mode")}function m(f){const w=f.target;s.value=parseInt(w.value,10)}function D(){o("retry-failed")}function I(){t.downloadCurrentImage()}function p(){t.downloadAllImages(E.value)}function y(){t.exportText()}function ee(){T.value?.click()}async function se(f){const w=f.target,c=w.files?.[0];c&&(await t.importText(c),w.value="")}return(f,w)=>$.value?(V(),J("section",Ss,[e("div",ks,[Z.value?(V(),J("button",{key:0,id:"toggleImageButton",class:"control-btn",onClick:B},ye(_.value?"查看翻译图":"查看原图"),1)):Me("",!0),e("button",{id:"toggleEditModeButton",class:Le(["control-btn",{active:n.isEditMode}]),onClick:k},ye(n.isEditMode?"退出编辑":"切换编辑模式"),3),e("div",_s,[w[1]||(w[1]=e("label",{for:"imageSize"},"图片大小:",-1)),e("input",{type:"range",id:"imageSize",min:"50",max:"200",value:s.value,class:"slider range-slider",onInput:m},null,40,Cs),e("span",ws,ye(s.value)+"%",1)]),d.value?(V(),J("button",{key:1,id:"retranslateFailedButton",class:"retry-failed-btn",onClick:D,title:"重新翻译所有失败的图片"}," 重新翻译失败图片 ("+ye(fe(a).failedImageCount)+") ",1)):Me("",!0)]),e("div",$s,[e("div",Ts,[e("img",{id:"translatedImageDisplay",src:q.value,alt:"翻译后图片",style:it(l.value)},null,12,Is)])]),e("div",Ds,[w[6]||(w[6]=e("h3",null,"检测到的文本（原文 → 译文）",-1)),e("pre",Rs,[O.value?(V(!0),J(Ze,{key:0},et(x.value,(c,F)=>(V(),J("span",{key:F,class:"text-item"},[e("span",Ms,ye(ge(c.original)),1),w[2]||(w[2]=Ne(`
`,-1)),e("span",{class:Le(["translated-text",{"translation-error":P(c.translated)}])},ye(j(c.translated)),3),w[3]||(w[3]=Ne(`
`,-1)),w[4]||(w[4]=e("span",{class:"separator"},"──────────────────────────",-1)),w[5]||(w[5]=Ne(`

`,-1))]))),128)):(V(),J(Ze,{key:1},[Ne("未检测到文本或尚未翻译")],64))])]),e("div",Bs,[N.value?(V(),rt(dn,{key:0,visible:!0,percentage:ne.value,label:oe.value||"下载中，请稍候..."},null,8,["percentage","label"])):Me("",!0),e("div",Es,[e("button",{id:"downloadButton",class:"download-btn primary",disabled:!X.value,onClick:I}," 下载当前图片 ",8,Ps),e("div",As,[e("button",{id:"downloadAllImagesButton",class:"download-btn primary",disabled:!G.value,onClick:p}," 下载所有图片 ",8,Fs),e("div",Ls,[Re(We,{modelValue:E.value,"onUpdate:modelValue":w[0]||(w[0]=c=>E.value=c),options:u},null,8,["modelValue"])])]),e("button",{id:"exportTextButton",class:"download-btn success",disabled:!G.value,onClick:y}," 导出文本 ",8,Us),e("button",{id:"importTextButton",class:"download-btn success",disabled:!G.value,onClick:ee}," 导入文本 ",8,Os),e("input",{type:"file",ref_key:"importFileInput",ref:T,id:"importTextFileInput",style:{display:"none"},accept:".json",onChange:se},null,544)])])])):(V(),J("section",zs))}}),Ns=je(Vs,[["__scopeId","data-v-a26b9c58"]]),Ws={class:"guide-content"},Ks={class:"guide-footer"},qs={class:"dont-show-option"},Dt="saber_translator_dismiss_setup_reminder",Hs=Ge({__name:"FirstTimeGuide",emits:["openSettings"],setup(n,{expose:r,emit:u}){const o=u,a=h(!1),i=h(!1);ut(()=>{localStorage.getItem(Dt)!=="true"&&(a.value=!0)});function t(){i.value&&localStorage.setItem(Dt,"true"),a.value=!1}function s(){localStorage.setItem(Dt,"true"),a.value=!1,o("openSettings")}function _(){localStorage.removeItem(Dt)}return r({resetGuideState:_,showGuide:a}),(E,T)=>(V(),rt(jn,{"model-value":a.value,title:"欢迎使用 Saber-Translator",onClose:t},{default:yt(()=>[e("div",Ws,[T[3]||(T[3]=e("div",{class:"guide-icon"},"🎉",-1)),T[4]||(T[4]=e("div",{class:"guide-message"},[e("p",{class:"guide-title"},"首次使用提醒"),e("p",{class:"guide-text"}," 在开始翻译之前，请先配置翻译服务。 "),e("p",{class:"guide-text"},[Ne(" 点击右上角的 "),e("span",{class:"highlight"},"⚙️ 设置"),Ne(" 按钮，配置以下内容： ")]),e("ul",{class:"guide-list"},[e("li",null,"选择 OCR 引擎（文字识别）"),e("li",null,"配置翻译服务商和 API Key"),e("li",null,"（可选）配置高质量翻译和 AI 校对")])],-1)),e("div",{class:"guide-actions"},[e("button",{class:"guide-btn primary",onClick:s},[...T[1]||(T[1]=[e("span",{class:"btn-icon"},"⚙️",-1),Ne(" 立即配置 ",-1)])]),e("button",{class:"guide-btn secondary",onClick:t}," 稍后配置 ")]),e("div",Ks,[e("label",qs,[ie(e("input",{type:"checkbox","onUpdate:modelValue":T[0]||(T[0]=N=>i.value=N)},null,512),[[tt,i.value]]),T[2]||(T[2]=e("span",null,"不再显示此提醒",-1))])])])]),_:1},8,["model-value"]))}}),Js=je(Hs,[["__scopeId","data-v-eda18e4a"]]),Gt="saber_translator_dismiss_setup_reminder",Ys=["siliconflow","deepseek","volcano","caiyun","baidu_translate","youdao_translate","gemini","custom_openai"],Xs={manga_ocr:"MangaOCR",paddle_ocr:"PaddleOCR",baidu_ocr:"百度OCR",ai_vision:"AI视觉OCR"},js=["ollama","sakura"],Gs=["custom_openai"],Zs=["custom_openai"],Qs={siliconflow:"SiliconFlow",deepseek:"DeepSeek",volcano:"火山引擎",caiyun:"彩云小译",baidu_translate:"百度翻译",youdao_translate:"有道翻译",gemini:"Google Gemini",custom_openai:"自定义 OpenAI",ollama:"Ollama",sakura:"Sakura"};function Qn(){const n=Qe(),r=dt(),u=h(!1),o=h(!1),a=te(()=>{try{return localStorage.getItem(Gt)==="true"}catch{return!1}});function i(x){return Qs[x]||x}function t(x){return Ys.includes(x)}function s(x){return js.includes(x)}function _(x){return Gs.includes(x)}function E(x){return Zs.includes(x)}function T(x){return Xs[x]||x}function N(){const x=n.settings,O=x.ocrEngine,Q=x.baiduOcr,ge=x.aiVisionOcr,j=[];return O?(O==="baidu_ocr"&&((!Q?.apiKey||Q.apiKey.trim()==="")&&j.push("百度OCR 的 API Key"),(!Q?.secretKey||Q.secretKey.trim()==="")&&j.push("百度OCR 的 Secret Key")),O==="ai_vision"&&(ge?.provider||j.push("AI视觉OCR 的服务商"),(!ge?.apiKey||ge.apiKey.trim()==="")&&j.push("AI视觉OCR 的 API Key"),(!ge?.modelName||ge.modelName.trim()==="")&&j.push("AI视觉OCR 的模型名称"),ge?.provider==="custom"&&(!ge?.customBaseUrl||ge.customBaseUrl.trim()==="")&&j.push("AI视觉OCR 的自定义 Base URL")),j.length>0?{valid:!1,message:`请先在顶部 ⚙️ 设置菜单中填写 ${j[0]}`,missingItems:j}:{valid:!0,message:""}):{valid:!1,message:"请先在顶部 ⚙️ 设置菜单中选择 OCR 引擎",missingItems:["OCR 引擎"]}}function oe(){const{translation:x}=n.settings,{provider:O,apiKey:Q,modelName:ge,customBaseUrl:j}=x,P=[];return O?(t(O)&&(!Q||Q.trim()==="")&&P.push(`${i(O)} 的 API Key`),(!ge||ge.trim()==="")&&(s(O)||t(O))&&P.push(`${i(O)} 的模型名称`),_(O)&&(!j||j.trim()==="")&&P.push("自定义 OpenAI 服务的 Base URL"),P.length>0?{valid:!1,message:`请先在顶部 ⚙️ 设置菜单中填写 ${P[0]}`,missingItems:P}:{valid:!0,message:""}):{valid:!1,message:"请先在顶部 ⚙️ 设置菜单中选择翻译服务商",missingItems:["翻译服务商"]}}function ne(){const{hqTranslation:x}=n.settings,{provider:O,apiKey:Q,modelName:ge,customBaseUrl:j}=x,P=[];return O?((!Q||Q.trim()==="")&&P.push("高质量翻译的 API Key"),(!ge||ge.trim()==="")&&P.push("高质量翻译的模型名称"),E(O)&&(!j||j.trim()==="")&&P.push("高质量翻译的 Base URL"),P.length>0?{valid:!1,message:`请先在顶部 ⚙️ 设置菜单中填写 ${P[0]}`,missingItems:P}:{valid:!0,message:""}):{valid:!1,message:"请先在顶部 ⚙️ 设置菜单中选择高质量翻译的服务商",missingItems:["高质量翻译服务商"]}}function G(x){const O=x||n.settings.proofreading.rounds,Q=[];if(!O||O.length===0)return{valid:!1,message:"请先在顶部 ⚙️ 设置菜单中添加至少一个校对轮次",missingItems:["校对轮次"]};for(let ge=0;ge<O.length;ge++){const j=O[ge];if(!j)continue;const P=j.name||`轮次${ge+1}`;if(j.provider||Q.push(`校对 ${P} 的服务商`),(!j.apiKey||j.apiKey.trim()==="")&&Q.push(`校对 ${P} 的 API Key`),(!j.modelName||j.modelName.trim()==="")&&Q.push(`校对 ${P} 的模型名称`),Q.length>0)return{valid:!1,message:`请先在顶部 ⚙️ 设置菜单中为 ${Q[0]}`,missingItems:Q}}return{valid:!0,message:""}}function $(x="normal",O={}){let Q;switch(x){case"normal":Q=oe();break;case"hq":Q=ne();break;case"proofread":Q=G(O.proofreadingRounds);break;case"ocr":Q=N();break;default:Q=oe()}return Q.valid?!0:(r.error(Q.message),X(),!1)}function Z(){const x=N();if(!x.valid)return r.error(x.message),X(),!1;const O=oe();return O.valid?!0:(r.error(O.message),X(),!1)}function X(){const x=document.getElementById("openSettingsBtn");x&&(o.value=!0,x.style.animation="settingsBtnPulse 0.5s ease-in-out 3",x.style.boxShadow="0 0 10px var(--primary-color, #4a90d9)",setTimeout(()=>{x.style.animation="",x.style.boxShadow="",o.value=!1},3e3))}function q(){if(a.value){console.log("用户已选择不再显示设置提醒");return}u.value=!0}function d(x=!1){if(x)try{localStorage.setItem(Gt,"true"),console.log("用户选择永久关闭设置提醒")}catch(O){console.error("保存设置提醒状态失败:",O)}u.value=!1}function l(){try{localStorage.removeItem(Gt),console.log("设置提醒状态已重置")}catch(x){console.error("重置设置提醒状态失败:",x)}}function C(){setTimeout(()=>{q()},500)}return{showSetupReminder:u,isSettingsButtonHighlighted:o,isSetupReminderDismissed:a,validateOcrConfig:N,validateTranslationConfig:oe,validateHqTranslationConfig:ne,validateProofreadingConfig:G,validateBeforeTranslation:$,validateFullTranslationConfig:Z,highlightSettingsButton:X,checkAndShowSetupReminder:q,closeSetupReminder:d,resetSetupReminderDismiss:l,initValidation:C,getProviderDisplayName:i,getOcrEngineDisplayName:T,requiresApiKey:t,isLocalProvider:s,requiresBaseUrl:_}}const Rt={originalText:"",translatedText:"",textboxText:"",coords:[0,0,100,100],polygon:[],fontSize:25,fontFamily:"fonts/STSONG.TTF",textDirection:"auto",autoTextDirection:"vertical",textColor:"#000000",fillColor:Hn,rotationAngle:0,position:{x:0,y:0},strokeEnabled:sn,strokeColor:an,strokeWidth:on,inpaintMethod:"solid"};function nn(n){return{...{...Rt,...n},coords:n?.coords?[...n.coords]:[...Rt.coords],polygon:n?.polygon?n.polygon.map(u=>[...u]):[],position:n?.position?{...Rt.position,...n.position}:{...Rt.position}}}function eo(n){const[r,u,o,a]=n,i=Math.abs(o-r);return Math.abs(a-u)>i?"vertical":"horizontal"}function Nn(n,r){const{bubble_coords:u=[],bubble_states:o=[],original_texts:a=[],bubble_texts:i=[],textbox_texts:t=[],bubble_angles:s=[],auto_directions:_=[]}=n;return o.length>0?o.map((E,T)=>({...nn(r),...E,coords:E.coords||u[T]||[0,0,100,100]})):u.map((E,T)=>{let N;return _[T]?N=_[T]==="v"?"vertical":"horizontal":N=eo(E),nn({coords:E,originalText:a[T]||"",translatedText:i[T]||"",textboxText:t[T]||"",rotationAngle:s[T]||0,autoTextDirection:N,...r})})}function Mt(n){return n.map(r=>({...r,coords:[...r.coords],polygon:r.polygon?r.polygon.map(u=>[...u]):[],position:{...r.position}}))}function el(n){if(!n||typeof n!="object")return!1;const r=n;if(!Array.isArray(r.coords)||r.coords.length!==4||!r.coords.every(a=>typeof a=="number"&&!isNaN(a))||typeof r.fontSize!="number"||r.fontSize<=0)return!1;const u=["vertical","horizontal","auto"];if(typeof r.textDirection!="string"||!u.includes(r.textDirection))return!1;const o=["solid","lama_mpe","litelama"];return!(typeof r.inpaintMethod!="string"||!o.includes(r.inpaintMethod))}const gt=ln("bubble",()=>{const n=h([]),r=h(-1),u=h([]),o=h([]),a=h(!1),i=h(-1),t=h(0),s=h(0),_=h(0),E=h(0),T=h(!1),N=h(-1),oe=h(null),ne=h(!1),G=h(-1),$=h(0),Z=te(()=>r.value>=0&&r.value<n.value.length?n.value[r.value]??null:null),X=te(()=>n.value.length),q=te(()=>n.value.length>0),d=te(()=>r.value>=0),l=te(()=>u.value.length>1),C=te(()=>u.value.filter(g=>g>=0&&g<n.value.length).map(g=>n.value[g]).filter(g=>g!==void 0));function x(){const v=st().currentImage;v&&(v.bubbleStates=Mt(n.value),v.hasUnsavedChanges=!0,console.log("气泡状态已同步到当前图片"))}function O(g,v=!1){n.value=g,o.value=Mt(g),D(),console.log(`气泡数组已设置，共 ${g.length} 个气泡`),v||x()}function Q(g,v){const M=eo(g),U=Qe().settings.textStyle,le=U.layoutDirection,re=le==="auto"?"vertical":le||"vertical",ae=nn({coords:g,translatedText:"",autoTextDirection:M,fontSize:U.fontSize,fontFamily:U.fontFamily,textDirection:re,textColor:U.textColor,fillColor:U.fillColor,inpaintMethod:U.inpaintMethod,strokeEnabled:U.strokeEnabled,strokeColor:U.strokeColor,strokeWidth:U.strokeWidth,rotationAngle:0,position:{x:0,y:0},...v});return n.value.push(ae),console.log(`已添加气泡，当前共 ${n.value.length} 个`),x(),ae}function ge(g){return g<0||g>=n.value.length?(console.warn(`删除失败: 无效的索引 ${g}`),!1):(n.value.splice(g,1),r.value===g?r.value=-1:r.value>g&&r.value--,u.value=u.value.filter(v=>v!==g).map(v=>v>g?v-1:v),console.log(`已删除气泡，当前共 ${n.value.length} 个`),x(),!0)}function j(){if(u.value.length===0&&r.value<0)return;const g=[...new Set([...u.value,r.value])].filter(v=>v>=0).sort((v,M)=>M-v);for(const v of g)n.value.splice(v,1);D(),console.log(`已删除 ${g.length} 个气泡`),x()}function P(){n.value=[],o.value=[],D(),console.log("所有气泡已清除"),x()}function B(){n.value=[],o.value=[],D(),console.log("本地气泡状态已清除（不同步到imageStore）")}function k(g){g>=-1&&g<n.value.length&&(r.value=g,u.value=g>=0?[g]:[],console.log(`已选中气泡 ${g}`))}function m(g){if(g<0||g>=n.value.length)return;const v=u.value.indexOf(g);v>=0?(u.value.splice(v,1),r.value===g&&(r.value=u.value[0]??-1)):(u.value.push(g),r.value=g),console.log(`多选状态: ${u.value.join(", ")}`)}function D(){r.value=-1,u.value=[]}function I(){r.value>=0?u.value=[r.value]:u.value=[]}function p(){if(n.value.length===0)return!1;const g=r.value<n.value.length-1?r.value+1:0;return k(g),!0}function y(){if(n.value.length===0)return!1;const g=r.value>0?r.value-1:n.value.length-1;return k(g),!0}function ee(g,v){if(g<0||g>=n.value.length)return console.warn(`更新失败: 无效的索引 ${g}`),!1;const M=n.value[g];return M?(Object.assign(M,v),console.log(`已更新气泡 ${g}`),x(),!0):!1}function se(g){return r.value<0?(console.warn("更新失败: 没有选中的气泡"),!1):ee(r.value,g)}function f(g){const v=u.value.length>0?u.value:r.value>=0?[r.value]:[];for(const M of v){const R=n.value[M];R&&Object.assign(R,g)}x(),console.log(`已批量更新 ${v.length} 个气泡`)}function w(g){for(let v=0;v<n.value.length;v++){const M=n.value[v];M&&Object.assign(M,g)}x(),console.log(`已更新所有 ${n.value.length} 个气泡`)}function c(){if(n.value.length!==o.value.length)return!0;for(let g=0;g<n.value.length;g++){const v=n.value[g],M=o.value[g];if(!(!v||!M)&&(v.translatedText!==M.translatedText||v.textboxText!==M.textboxText||v.fontSize!==M.fontSize||v.fontFamily!==M.fontFamily||v.textDirection!==M.textDirection||v.textColor!==M.textColor||v.fillColor!==M.fillColor||v.rotationAngle!==M.rotationAngle||v.strokeEnabled!==M.strokeEnabled||v.strokeColor!==M.strokeColor||v.strokeWidth!==M.strokeWidth||v.inpaintMethod!==M.inpaintMethod||JSON.stringify(v.coords)!==JSON.stringify(M.coords)))return!0}return!1}function F(){n.value=Mt(o.value),D(),console.log("气泡状态已重置到初始状态")}function ve(){o.value=Mt(n.value),console.log("当前状态已保存为初始状态")}function W(){return{bubble_coords:n.value.map(g=>g.coords),bubble_texts:n.value.map(g=>g.translatedText),textbox_texts:n.value.map(g=>g.textboxText),font_sizes:n.value.map(g=>g.fontSize),font_families:n.value.map(g=>g.fontFamily),text_directions:n.value.map(g=>g.textDirection==="auto"?g.autoTextDirection==="vertical"?"v":"h":g.textDirection==="vertical"?"v":"h"),text_colors:n.value.map(g=>g.textColor),fill_colors:n.value.map(g=>g.fillColor),rotation_angles:n.value.map(g=>g.rotationAngle),stroke_enabled:n.value.map(g=>g.strokeEnabled),stroke_colors:n.value.map(g=>g.strokeColor),stroke_widths:n.value.map(g=>g.strokeWidth),inpaint_methods:n.value.map(g=>g.inpaintMethod)}}function Y(){return JSON.stringify(n.value)}function me(g){try{const v=JSON.parse(g);if(!Array.isArray(v))return console.error("反序列化失败: 数据不是数组"),!1;const M=[];for(const R of v)el(R)?M.push(R):console.warn("跳过无效的气泡状态:",R);return O(M),!0}catch(v){return console.error("反序列化失败:",v),!1}}return{bubbles:n,selectedIndex:r,selectedIndices:u,initialStates:o,isDragging:a,draggingIndex:i,dragOffsetX:t,dragOffsetY:s,dragInitialX:_,dragInitialY:E,isResizing:T,resizingIndex:N,resizeCurrentCoords:oe,isRotating:ne,rotatingIndex:G,rotateCurrentAngle:$,selectedBubble:Z,bubbleCount:X,hasBubbles:q,hasSelection:d,isMultiSelect:l,selectedBubbles:C,setBubbles:O,addBubble:Q,deleteBubble:ge,deleteSelected:j,clearBubbles:P,clearBubblesLocal:B,selectBubble:k,toggleMultiSelect:m,clearSelection:D,clearMultiSelect:I,selectNext:p,selectPrevious:y,updateBubble:ee,updateSelectedBubble:se,updateAllSelected:f,updateAllBubbles:w,hasChanges:c,resetToInitial:F,saveAsInitial:ve,toApiRequest:W,serialize:Y,deserialize:me}}),tl=Object.freeze(Object.defineProperty({__proto__:null,useBubbleStore:gt},Symbol.toStringTag,{value:"Module"}));function Zt(n){let r=n,u=0,o=0,a=Date.now();const i=()=>r<=0?0:Math.ceil(6e4/r);return{async acquire(){if(r<=0)return;const t=Date.now(),s=i();if(t-a>=6e4&&(a=t,o=0),o>=r){const E=6e4-(t-a);E>0&&await Wn(E),a=Date.now(),o=0}const _=t-u;_<s&&await Wn(s-_),u=Date.now(),o++},reset(){u=0,o=0,a=Date.now()},getRpm(){return r},setRpm(t){r=t,this.reset()}}}function Wn(n){return new Promise(r=>setTimeout(r,n))}function gn(){const n=st(),r=Qe(),u=gt(),o=Qn(),a=dt(),i=h(null),t=h({current:0,total:0,completed:0,failed:0,isInProgress:!1,isPaused:!1}),s=h(!1),_=h(!1),E=h(!1),T=te(()=>s.value||n.isBatchTranslationInProgress||_.value||E.value),N=te(()=>t.value.total===0?0:Math.round(t.value.completed/t.value.total*100));function oe(){const g=r.settings.translation.rpmLimit;i.value?i.value.setRpm(g):i.value=Zt(g)}function ne(g){return g.includes(",")&&g.split(",")[1]||g}function G(g){if(g.isManuallyAnnotated){const v=g.bubbleStates||[];return{coords:v.map(M=>M.coords),angles:v.map(M=>M.rotationAngle||0),isEmpty:v.length===0,isManual:!0}}return Array.isArray(g.bubbleStates)&&g.bubbleStates.length>0?{coords:g.bubbleStates.map(v=>v.coords),angles:g.bubbleStates.map(v=>v.rotationAngle||0),isEmpty:!1,isManual:!1}:Array.isArray(g.bubbleCoords)&&g.bubbleCoords.length>0?{coords:g.bubbleCoords,angles:g.bubbleAngles,isEmpty:!1,isManual:!1}:null}function $(g,v={}){const{settings:M}=r,{textStyle:R,translation:U,baiduOcr:le,aiVisionOcr:re,boxExpand:ae,preciseMask:S}=M,b={image:ne(g),ocr_engine:M.ocrEngine,source_language:M.sourceLanguage,model_provider:U.provider,api_key:U.apiKey,model_name:U.modelName,custom_base_url:U.customBaseUrl,target_language:M.targetLanguage,prompt_content:M.translatePrompt,textbox_prompt_content:M.textboxPrompt,use_textbox_prompt:M.useTextboxPrompt,rpm_limit_translation:U.rpmLimit,max_retries:U.maxRetries,use_json_format_translation:U.isJsonMode,detector_type:M.textDetector,box_expand_ratio:ae.ratio,box_expand_top:ae.top,box_expand_bottom:ae.bottom,box_expand_left:ae.left,box_expand_right:ae.right,usePreciseMask:S.enabled,maskDilateSize:S.dilateSize,maskBoxExpandRatio:S.boxExpandRatio,fontSize:R.fontSize,autoFontSize:R.autoFontSize,fontFamily:R.fontFamily,textDirection:R.layoutDirection==="auto"?"vertical":R.layoutDirection,autoTextDirection:R.layoutDirection==="auto",textColor:R.textColor,fillColor:R.fillColor,strokeEnabled:R.strokeEnabled,strokeColor:R.strokeColor,strokeWidth:R.strokeWidth,use_inpainting:!1,use_lama:R.inpaintMethod==="lama_mpe"||R.inpaintMethod==="litelama",lamaModel:R.inpaintMethod==="litelama"?"litelama":"lama_mpe",showDetectionDebug:M.showDetectionDebug,remove_only:v.removeTextOnly,skip_translation:v.removeTextOnly},L=z=>z.map(H=>[Math.round(H[0]),Math.round(H[1]),Math.round(H[2]),Math.round(H[3])]);return v.existingBubbleStates&&v.existingBubbleStates.length>0?(b.bubble_coords=L(v.existingBubbleStates.map(z=>z.coords)),b.bubble_angles=v.existingBubbleStates.map(z=>z.rotationAngle||0)):v.existingBubbleCoords&&(b.bubble_coords=L(v.existingBubbleCoords),b.bubble_angles=v.existingBubbleAngles),M.ocrEngine==="baidu_ocr"&&(b.baidu_api_key=le.apiKey,b.baidu_secret_key=le.secretKey,b.baidu_version=le.version,b.baidu_ocr_language=le.sourceLanguage),M.ocrEngine==="ai_vision"&&(b.ai_vision_provider=re.provider,b.ai_vision_api_key=re.apiKey,b.ai_vision_model_name=re.modelName,b.ai_vision_ocr_prompt=re.prompt,b.rpm_limit_ai_vision_ocr=re.rpmLimit,b.custom_ai_vision_base_url=re.customBaseUrl,b.use_json_format_ai_vision_ocr=re.isJsonMode),b}function Z(g,v,M={}){if(v.error||!v.translated_image){n.setTranslationStatus(g,"failed",v.error||"翻译失败");return}const{settings:R}=r,{textStyle:U}=R;let le=null;if(v.bubble_coords&&v.bubble_coords.length>0){const S={bubble_coords:v.bubble_coords,bubble_states:v.bubble_states,original_texts:v.original_texts,bubble_texts:v.bubble_texts,textbox_texts:v.textbox_texts,bubble_angles:v.bubble_angles,auto_directions:v.auto_directions},b={fontSize:U.fontSize,fontFamily:U.fontFamily,textDirection:U.layoutDirection==="auto"?"vertical":U.layoutDirection,textColor:U.textColor,fillColor:U.fillColor,strokeEnabled:U.strokeEnabled,strokeColor:U.strokeColor,strokeWidth:U.strokeWidth,inpaintMethod:U.inpaintMethod};le=Nn(S,b)}const re=v.translated_image?`data:image/png;base64,${v.translated_image}`:null,ae=r.settings.textStyle.layoutDirection;n.updateImageByIndex(g,{translatedDataURL:re,cleanImageData:v.clean_image||null,bubbleStates:le,bubbleCoords:v.bubble_coords,bubbleAngles:v.bubble_angles||[],originalTexts:v.original_texts,textboxTexts:v.textbox_texts||[],bubbleTexts:le?.map(S=>S.translatedText||"")||[],userLayoutDirection:ae,translationStatus:"completed",translationFailed:!1,hasUnsavedChanges:!0}),g===n.currentImageIndex&&le&&u.setBubbles(le)}async function X(g={}){if(g.removeTextOnly){if(!o.validateBeforeTranslation("ocr"))return!1}else if(!o.validateBeforeTranslation("normal"))return!1;const v=n.currentImage;if(!v)return a.error("请先上传图片"),!1;s.value=!0,n.setTranslationStatus(n.currentImageIndex,"processing");const M=a.showGeneralMessage("翻译中...","info",!1,0);try{oe(),i.value&&await i.value.acquire();const R={...g};if(!R.existingBubbleCoords&&!R.existingBubbleStates){const re=G(v);if(re)if(re.isEmpty)console.log("翻译当前图片: 文本框已被用户清空，将跳过翻译"),a.info("该图片无文本框，跳过翻译",3e3),R.existingBubbleCoords=[],R.existingBubbleAngles=[],R.useExistingBubbles=!0;else{R.existingBubbleCoords=re.coords,R.existingBubbleAngles=re.angles,R.useExistingBubbles=!0;const ae=re.isManual?"手动标注框":"已有的文本框";console.log(`翻译当前图片: 使用 ${re.coords.length} 个${ae}`),a.info(re.isManual?"检测到手动标注框，将优先使用...":"使用已有的文本框进行翻译...",3e3)}}const U=$(v.originalDataURL,R),le=await Et(U);return a.clearGeneralMessageById(M),Z(n.currentImageIndex,le,g),le.translated_image&&!le.error?(a.success("翻译成功！"),!0):(a.error(le.error||"翻译失败"),!1)}catch(R){a.clearGeneralMessageById(M);const U=R instanceof Error?R.message:"翻译请求失败";return n.markCurrentAsFailed(U),a.error(U),!1}finally{s.value=!1}}async function q(g,v={}){const M=n.images[g];if(!M)return console.error(`图片索引 ${g} 不存在`),!1;n.setTranslationStatus(g,"processing");try{i.value&&await i.value.acquire();const R={...v};if(!R.existingBubbleCoords&&!R.existingBubbleStates){const re=G(M);if(re)if(re.isEmpty)console.log(`批量翻译图片 ${g}: 文本框已被用户清空，跳过此图片的翻译`),R.existingBubbleCoords=[],R.existingBubbleAngles=[],R.useExistingBubbles=!0;else{R.existingBubbleCoords=re.coords,R.existingBubbleAngles=re.angles,R.useExistingBubbles=!0;const ae=re.isManual?"手动标注框":"已有的文本框";console.log(`批量翻译图片 ${g}: 使用 ${re.coords.length} 个${ae}`)}}const U=$(M.originalDataURL,R),le=await Et(U);return Z(g,le,v),!!le.translated_image&&!le.error}catch(R){const U=R instanceof Error?R.message:"翻译请求失败";return n.setTranslationStatus(g,"failed",U),!1}}async function d(g={}){if(g.removeTextOnly){if(!o.validateBeforeTranslation("ocr"))return!1}else if(!o.validateBeforeTranslation("normal"))return!1;const v=n.images;if(v.length===0)return a.error("请先上传图片"),!1;const M=g.removeTextOnly===!0;t.value={current:0,total:v.length,completed:0,failed:0,isInProgress:!0,isPaused:!1,label:M?`消除文字: 0/${v.length}`:`0/${v.length}`,percentage:0},n.setBatchTranslationInProgress(!0),oe(),a.info(M?`开始消除 ${v.length} 张图片文字...`:`开始批量翻译 ${v.length} 张图片...`);let R=!0;try{for(let U=0;U<v.length;U++){if(n.isBatchTranslationPaused&&await new Promise(re=>{n.setBatchTranslationResumeCallback(re)}),!n.isBatchTranslationInProgress){console.log("批量翻译已取消");break}t.value.current=U+1,t.value.label=M?`消除文字: ${U+1}/${v.length}`:`${U+1}/${v.length}`,t.value.percentage=Math.round((U+1)/v.length*100),await q(U,g)?t.value.completed++:(t.value.failed++,R=!1)}return t.value.failed>0?a.warning(M?`消除文字完成，${t.value.failed} 张图片失败`:`翻译完成，${t.value.failed} 张图片失败`):a.success(M?"所有图片文字消除完成":"所有图片翻译完成"),R}catch(U){const le=U instanceof Error?U.message:"批量翻译失败";return a.error(le),!1}finally{n.setBatchTranslationInProgress(!1);const U=n.currentImageIndex;if(U>=0&&U<n.images.length){const le=n.images[U];le&&(le.bubbleStates&&le.bubbleStates.length>0&&u.setBubbles(le.bubbleStates),n.setCurrentImageIndex(U))}setTimeout(()=>{t.value.isInProgress=!1},1e3)}}function l(){n.isBatchTranslationInProgress&&!n.isBatchTranslationPaused&&(n.setBatchTranslationPaused(!0),t.value.isPaused=!0,a.info("批量翻译已暂停"))}function C(){n.isBatchTranslationInProgress&&n.isBatchTranslationPaused&&(n.resumeBatchTranslation(),t.value.isPaused=!1,a.info("批量翻译继续中"))}function x(){n.isBatchTranslationInProgress&&(n.isBatchTranslationPaused&&n.resumeBatchTranslation(),n.setBatchTranslationInProgress(!1),t.value.isInProgress=!1,a.info("批量翻译已取消"))}async function O(){return X({removeTextOnly:!0})}async function Q(){return d({removeTextOnly:!0})}async function ge(g={}){if(!o.validateBeforeTranslation("normal"))return!1;const v=n.getFailedImageIndices();if(v.length===0)return a.info("没有失败的图片需要重新翻译"),!0;t.value={current:0,total:v.length,completed:0,failed:0,isInProgress:!0,isPaused:!1},n.setBatchTranslationInProgress(!0),oe();let M=!0;try{for(let R=0;R<v.length&&(n.isBatchTranslationPaused&&await new Promise(re=>{n.setBatchTranslationResumeCallback(re)}),!!n.isBatchTranslationInProgress);R++){t.value.current=R+1;const U=v[R];if(U===void 0)continue;await q(U,g)?t.value.completed++:(t.value.failed++,M=!1)}return t.value.failed>0?a.warning(`重试完成，仍有 ${t.value.failed} 张图片失败`):a.success("所有失败图片重新翻译完成"),M}catch(R){const U=R instanceof Error?R.message:"重试翻译失败";return a.error(U),!1}finally{n.setBatchTranslationInProgress(!1),setTimeout(()=>{t.value.isInProgress=!1},1e3)}}let j=[],P=null;function B(){return"session_"+Date.now()+"_"+Math.random().toString(36).substring(2,9)}function k(){const g=n.images;if(g.length===0)return null;const v=[];for(let M=0;M<g.length;M++){const R=g[M];if(!R)continue;const U=R.originalTexts||[],le={imageIndex:M,bubbles:[]};for(let re=0;re<U.length;re++){const ae=U[re]||"";let S="vertical";const b=R.bubbleStates?.[re];if(b&&b.textDirection){const L=b.textDirection;S=L==="auto"?"vertical":L}else R.userLayoutDirection&&R.userLayoutDirection!=="auto"&&(S=R.userLayoutDirection);le.bubbles.push({bubbleIndex:re,original:ae,translated:"",textDirection:S})}v.push(le)}return v}function m(){return n.images.map(g=>{const v=g.originalDataURL;return v.includes(",")?v.split(",")[1]||"":v})}function D(g,v,M){return g.filter(R=>R.imageIndex>=v&&R.imageIndex<M)}function I(g){if(!g||g.length===0)return[];const v=[];for(const M of g){if(!M){console.warn("mergeJsonResults: 跳过空的批次结果");continue}const R=Array.isArray(M)?M:[M];for(const U of R)U&&typeof U=="object"&&"imageIndex"in U?v.push(U):console.warn("mergeJsonResults: 跳过无效的图片数据",U)}return v.sort((M,R)=>M.imageIndex-R.imageIndex),v}async function p(g,v,M){const{hqTranslation:R}=r.settings,U=JSON.stringify(v,null,2),le=[{type:"text",text:R.prompt+`

以下是JSON数据:
\`\`\`json
`+U+"\n```"}];for(const S of g)le.push({type:"image_url",image_url:{url:`data:image/png;base64,${S}`}});const re=[{role:"system",content:"你是一个专业的漫画翻译助手，能够根据漫画图像内容和上下文提供高质量的翻译。"},{role:"user",content:le}],ae={provider:R.provider,api_key:R.apiKey,model_name:R.modelName,custom_base_url:R.customBaseUrl,messages:re,low_reasoning:R.lowReasoning,force_json_output:R.forceJsonOutput,no_thinking_method:R.noThinkingMethod,use_stream:R.useStream};try{console.log(`高质量翻译: 通过后端代理调用 ${R.provider} API...`);const S=await en(ae);if(!S.success)throw new Error(S.error||"API 调用失败");if(S.results&&S.results.length>0){const L=S.results[0];if(L&&"imageIndex"in L&&"bubbles"in L)return S.results}const b=S.content;if(b)if(R.forceJsonOutput)try{return JSON.parse(b)}catch(L){throw console.error("解析AI强制JSON返回的内容失败:",L),new Error("解析AI返回的JSON结果失败")}else{const L=b.match(/```json\s*([\s\S]*?)\s*```/);if(L&&L[1])try{return JSON.parse(L[1])}catch(z){throw console.error("解析AI返回的JSON失败:",z),new Error("解析AI返回的翻译结果失败")}}return null}catch(S){throw console.error("调用AI翻译API失败:",S),S}}async function y(){if(n.images.length===0)return a.warning("请先添加图片"),!1;if(n.isBatchTranslationInProgress)return a.warning("请等待当前批量操作完成"),!1;if(!o.validateBeforeTranslation("hq"))return!1;const{hqTranslation:g,textStyle:v}=r.settings,M=v.layoutDirection;P={fontFamily:v.fontFamily,fontSize:v.fontSize,autoFontSize:v.autoFontSize,autoTextDirection:M==="auto",textDirection:M==="auto"?"vertical":M,fillColor:v.fillColor,textColor:v.textColor,rotationAngle:0,strokeEnabled:v.strokeEnabled,strokeColor:v.strokeColor,strokeWidth:v.strokeWidth},console.log("高质量翻译前保存的文本样式设置:",P),t.value={current:0,total:n.images.length,completed:0,failed:0,isInProgress:!0,isPaused:!1,label:"准备翻译...",percentage:0},a.info("步骤1/4: 消除所有图片文字..."),_.value=!0,n.setBatchTranslationInProgress(!0);try{await ee(),a.info("步骤2/4: 导出文本数据..."),t.value.label="导出文本数据...",t.value.percentage=25;const R=k();if(!R)throw new Error("导出文本失败");a.info("步骤3/4: 准备图片数据..."),t.value.label="准备图片数据...",t.value.percentage=40;const U=m();a.info("步骤4/4: 发送到AI进行翻译..."),t.value.label="开始发送到AI...",t.value.percentage=50;const le=g.batchSize||3,re=g.sessionReset||5,ae=g.maxRetries??2;j=[];const S=U.length,b=Math.ceil(S/le),L=g.rpmLimit||0,z=L>0?Zt(L):null;let H=0,xe=B();for(let he=0;he<b;he++){t.value.label=`${he+1}/${b}`,t.value.percentage=Math.round(50+he/b*40),H>=re&&(console.log("重置会话上下文"),xe=B(),H=0);const be=he*le,Se=Math.min(be+le,S),ce=U.slice(be,Se),De=D(R,be,Se);let ke=0,$e=!1;for(;ke<=ae&&!$e;)try{z&&await z.acquire();const _e=await p(ce,De,xe);if(_e)j.push(_e),$e=!0;else{if(ke++,ke>ae)break;await new Promise(Te=>setTimeout(Te,1e3));continue}H++}catch(_e){ke++,ke<=ae?(console.log(`批次 ${he+1} 翻译失败，第 ${ke}/${ae} 次重试...`),a.warning(`批次 ${he+1} 失败，正在重试 (${ke}/${ae})...`),await new Promise(Te=>setTimeout(Te,1e3))):(console.error(`批次 ${he+1} 翻译最终失败:`,_e),a.error(`批次 ${he+1} 翻译失败: ${_e instanceof Error?_e.message:"未知错误"}`))}}return a.info("翻译完成，正在导入翻译结果..."),t.value.label="导入翻译结果...",t.value.percentage=90,await se(I(j)),t.value.label="翻译完成！",t.value.percentage=100,a.success("高质量翻译完成！"),!0}catch(R){return console.error("高质量翻译过程出错:",R),a.error(`翻译失败: ${R instanceof Error?R.message:"未知错误"}`),!1}finally{_.value=!1,n.setBatchTranslationInProgress(!1),setTimeout(()=>{t.value.isInProgress=!1},1e3)}}async function ee(){const g=n.images.length;let v=0;t.value.label=`消除文字: 0/${g}`,t.value.percentage=0;for(let M=0;M<g;M++){const R=Math.floor(M/g*25);t.value.label=`消除文字: ${M+1}/${g}`,t.value.percentage=R,n.setTranslationStatus(M,"processing");const U=n.images[M];if(!U||!U.originalDataURL){n.setTranslationStatus(M,"pending");continue}const le=G(U);if(le?.isEmpty){console.log(`高质量翻译[${M}]: 文本框已被用户清空，跳过此图片`),n.setTranslationStatus(M,"pending");continue}if(le){const re=le.isManual?"手动标注框":"已有文本框";console.log(`高质量翻译[${M}]: 使用${re} ${le.coords.length} 个`)}try{const re=$(U.originalDataURL,{removeTextOnly:!0,existingBubbleCoords:le?.coords,existingBubbleAngles:le?.angles,useExistingBubbles:!!le}),ae=await Et(re);if(ae.translated_image){const S=P?.textDirection,b=S==="vertical"||S==="horizontal"||S==="auto"?S:"vertical",L=ae.bubble_coords?Nn(ae,{fontSize:P?.fontSize||r.settings.textStyle.fontSize,fontFamily:P?.fontFamily||r.settings.textStyle.fontFamily,textDirection:b,textColor:P?.textColor||r.settings.textStyle.textColor,fillColor:P?.fillColor||r.settings.textStyle.fillColor,strokeEnabled:P?.strokeEnabled??r.settings.textStyle.strokeEnabled,strokeColor:P?.strokeColor||r.settings.textStyle.strokeColor,strokeWidth:P?.strokeWidth??r.settings.textStyle.strokeWidth,inpaintMethod:r.settings.textStyle.inpaintMethod}):[];n.updateImageByIndex(M,{translatedDataURL:`data:image/png;base64,${ae.translated_image}`,cleanImageData:ae.clean_image||null,bubbleCoords:ae.bubble_coords||[],bubbleAngles:ae.bubble_angles||[],originalTexts:ae.original_texts||[],textboxTexts:ae.textbox_texts||[],bubbleStates:L,bubbleTexts:L.map(z=>z.translatedText||""),translationFailed:!1,translationStatus:"completed",showOriginal:!1,hasUnsavedChanges:!0}),console.log(`高质量翻译-消除文字[${M+1}/${g}]: 处理完成`)}else v++,n.updateImageByIndex(M,{translationFailed:!0,translationStatus:"failed"})}catch(re){console.error(`图片 ${M} 消除文字失败:`,re),v++,n.updateImageByIndex(M,{translationFailed:!0,translationStatus:"failed"})}}if(t.value.label="消除文字完成",t.value.percentage=25,v>0)throw new Error(`消除文字完成，但有 ${v} 张图片失败`)}async function se(g){if(!g||g.length===0)throw new Error("没有有效的翻译数据可导入");const v=n.images,M=n.currentImageIndex,R=P?.fontSize||r.settings.textStyle.fontSize,U=P?.autoFontSize??r.settings.textStyle.autoFontSize,le=P?.fontFamily||r.settings.textStyle.fontFamily,re=P?.textDirection||r.settings.textStyle.layoutDirection,ae=re==="auto"?"vertical":re,S=P?.textColor||r.settings.textStyle.textColor,b=P?.fillColor||r.settings.textStyle.fillColor,L=P?.strokeEnabled??r.settings.textStyle.strokeEnabled,z=P?.strokeColor||r.settings.textStyle.strokeColor,H=P?.strokeWidth??r.settings.textStyle.strokeWidth;t.value.label="更新图片数据...",t.value.percentage=90;const xe=g.length;let he=0;for(const be of g){he++,t.value.label=`处理图片 ${he}/${xe}`,t.value.percentage=90+he/xe*5;const Se=be.imageIndex;if(Se<0||Se>=v.length){console.warn(`跳过无效的图片索引: ${Se}`);continue}const ce=v[Se];if(!ce)continue;let De=!1;const ke=ce.bubbleTexts||[],$e=ce.bubbleCoords||[];for(const _e of be.bubbles||[]){const Te=_e.bubbleIndex;if(Te<0||Te>=$e.length){console.warn(`图片 ${Se}: 跳过无效的气泡索引 ${Te}`);continue}const Ce=_e.translated;let Ee=_e.textDirection;Ee==="auto"&&(Ee=ae),ke[Te]=Ce;const Ye=Ee==="vertical"||Ee==="horizontal"?Ee:ae;if(!ce.bubbleStates||!Array.isArray(ce.bubbleStates)||ce.bubbleStates.length!==$e.length){const we=ce.bubbleAngles||[],A=[];for(let de=0;de<$e.length;de++){const Pe=de===Te?Ye:ae,Ue=$e[de];let ot=Pe;const Xe=ce.bubbleStates?.[de];if(Xe?.autoTextDirection&&Xe.autoTextDirection!=="auto")ot=Xe.autoTextDirection;else if(Ue&&Ue.length>=4){const[He,mt,Pt,At]=Ue;ot=At-mt>Pt-He?"vertical":"horizontal"}A.push({translatedText:ke[de]||"",originalText:ce.originalTexts?.[de]||"",textboxText:"",coords:Ue,polygon:[],fontSize:R,fontFamily:le,textDirection:Pe,autoTextDirection:ot,position:{x:0,y:0},textColor:S,rotationAngle:we[de]||0,fillColor:b,strokeEnabled:L,strokeColor:z,strokeWidth:H,inpaintMethod:r.settings.textStyle.inpaintMethod})}ce.bubbleStates=A}else if(ce.bubbleStates[Te])ce.bubbleStates[Te].translatedText=Ce,Ee&&Ee!=="auto"&&(ce.bubbleStates[Te].textDirection=Ye);else{const A=(ce.bubbleAngles||[])[Te]||0,de=$e[Te];let Pe=Ye;if(de&&de.length>=4){const[Ue,ot,Xe,He]=de;Pe=He-ot>Xe-Ue?"vertical":"horizontal"}ce.bubbleStates[Te]={translatedText:Ce,originalText:ce.originalTexts?.[Te]||"",textboxText:"",coords:de,polygon:[],fontSize:R,fontFamily:le,textDirection:Ye,autoTextDirection:Pe,position:{x:0,y:0},textColor:S,rotationAngle:A,fillColor:b,strokeEnabled:L,strokeColor:z,strokeWidth:H,inpaintMethod:r.settings.textStyle.inpaintMethod}}De=!0}if(De&&ce.bubbleStates){const _e=ce.bubbleStates.map(Te=>Te.translatedText||"");if(ce.cleanImageData)try{const{apiClient:Te}=await lt(async()=>{const{apiClient:we}=await import("./client.Bht704G-.js");return{apiClient:we}},__vite__mapDeps([4,5])),Ce=ce.bubbleStates.map(we=>({translatedText:we.translatedText||"",coords:we.coords,fontSize:we.fontSize||R,fontFamily:we.fontFamily||le,textDirection:we.textDirection||ae,textColor:we.textColor||S,rotationAngle:we.rotationAngle||0,position:we.position||{x:0,y:0},strokeEnabled:we.strokeEnabled??L,strokeColor:we.strokeColor||z,strokeWidth:we.strokeWidth??H}));let Ee=ce.cleanImageData;Ee.includes("base64,")&&(Ee=Ee.split("base64,")[1]||"");const Ye=await Te.post("/api/re_render_image",{clean_image:Ee,bubble_texts:_e,bubble_coords:$e,fontSize:U?"auto":R,autoFontSize:U,fontFamily:le,textDirection:ae,textColor:S,bubble_states:Ce,use_individual_styles:!0,use_inpainting:!1,use_lama:!1,fillColor:null,is_font_style_change:!1,strokeEnabled:L,strokeColor:z,strokeWidth:H});Ye.rendered_image&&(n.updateImageByIndex(Se,{translatedDataURL:`data:image/png;base64,${Ye.rendered_image}`,bubbleStates:ce.bubbleStates,bubbleTexts:_e,hasUnsavedChanges:!0}),console.log(`已完成图片 ${Se} 的渲染`))}catch(Te){console.error(`重新渲染图片 ${Se} 失败:`,Te)}else n.updateImageByIndex(Se,{bubbleStates:ce.bubbleStates,bubbleTexts:_e,hasUnsavedChanges:!0})}}M>=0&&M<v.length&&n.setCurrentImageIndex(M)}let f=[];function w(){const g=n.images;if(g.length===0)return null;const v=[];for(let M=0;M<g.length;M++){const R=g[M];if(!R)continue;const U=R.originalTexts||[],le=R.bubbleTexts||[],re={imageIndex:M,bubbles:[]};for(let ae=0;ae<U.length;ae++){const S=U[ae]||"",b=(ae<le.length?le[ae]:"")||"";let L="vertical";const z=R.bubbleStates?.[ae];if(z&&z.textDirection){const H=z.textDirection;L=H==="auto"?"vertical":H}else R.userLayoutDirection&&R.userLayoutDirection!=="auto"&&(L=R.userLayoutDirection);re.bubbles.push({bubbleIndex:ae,original:S,translated:b,textDirection:L})}v.push(re)}return v}function c(g,v,M){return g.filter(R=>R.imageIndex>=v&&R.imageIndex<M)}function F(g){if(!g||g.length===0)return[];const v=[];for(const M of g){if(!M)continue;const R=Array.isArray(M)?M:[M];for(const U of R)U&&typeof U=="object"&&"imageIndex"in U&&v.push(U)}return v.sort((M,R)=>M.imageIndex-R.imageIndex),v}async function ve(g,v,M,R){const U=JSON.stringify(v,null,2),le=[{type:"text",text:M.prompt+`

以下是JSON数据，包含原文和已有译文:
\`\`\`json
`+U+"\n```\n请在保持JSON格式的情况下，校对每个bubble的translated字段，使翻译更加准确、自然、符合语境。"}];for(const ae of g)le.push({type:"image_url",image_url:{url:`data:image/png;base64,${ae}`}});const re={provider:M.provider,api_key:M.apiKey,model_name:M.modelName,custom_base_url:M.customBaseUrl,messages:[{role:"system",content:"你是一个专业的漫画翻译校对助手，能够根据漫画图像内容和上下文对已有翻译进行校对和润色。"},{role:"user",content:le}],low_reasoning:M.lowReasoning,no_thinking_method:M.noThinkingMethod,force_json_output:M.forceJsonOutput};try{console.log(`AI校对: 通过后端代理调用 ${M.provider} API...`);const ae=await en(re);if(!ae.success)throw new Error(ae.error||"API 调用失败");if(ae.results&&ae.results.length>0){const b=ae.results[0];if(b&&"imageIndex"in b&&"bubbles"in b)return ae.results}const S=ae.content;if(S)if(M.forceJsonOutput)try{return JSON.parse(S)}catch(b){throw console.error("解析AI强制JSON返回的内容失败:",b),new Error("解析AI返回的JSON结果失败")}else{const b=S.match(/```json\s*([\s\S]*?)\s*```/);if(b&&b[1])try{return JSON.parse(b[1])}catch(L){throw console.error("解析AI返回的JSON失败:",L),new Error("解析AI返回的校对结果失败")}try{return JSON.parse(S)}catch(L){throw console.error("直接解析AI返回内容失败:",L),new Error("无法解析AI返回的校对结果")}}return null}catch(ae){throw console.error("调用AI校对API失败:",ae),ae}}async function W(g){if(!g||g.length===0){console.warn("没有有效的校对数据可导入"),a.warning("没有有效的校对结果可导入");return}const v=n.images,M=n.currentImageIndex,{textStyle:R}=r.settings,U=R.fontSize,le=R.fontFamily,re=R.layoutDirection,ae=re==="auto"?"vertical":re,S=R.textColor,b=R.fillColor,L=R.strokeEnabled,z=R.strokeColor,H=R.strokeWidth;for(const xe of g){const he=xe.imageIndex;if(he<0||he>=v.length){console.warn(`跳过无效的图片索引: ${he}`);continue}const be=v[he];if(!be)continue;if(!xe.bubbles||!Array.isArray(xe.bubbles)||xe.bubbles.length===0){console.warn(`图片 ${he}: 没有有效的气泡数据`);continue}let Se=!1;const ce=be.bubbleTexts||[],De=be.bubbleCoords||[];for(const ke of xe.bubbles){const $e=ke.bubbleIndex,_e=ke.translated||"";let Te=ke.textDirection;if((!Te||Te==="auto")&&(Te=ae),$e<0||$e>=De.length){console.warn(`图片 ${he}: 跳过无效的气泡索引 ${$e}`);continue}for(;ce.length<=$e;)ce.push("");if(ce[$e]=_e,Te&&Te!=="auto"){const Ce=Te==="vertical"||Te==="horizontal"?Te:ae;if(!be.bubbleStates||!Array.isArray(be.bubbleStates)||be.bubbleStates.length!==De.length){const Ee=be.bubbleAngles||[],Ye=[];for(let we=0;we<De.length;we++){const A=we===$e?Ce:ae,de=De[we];let Pe=A;const Ue=be.bubbleStates?.[we];if(Ue?.autoTextDirection&&Ue.autoTextDirection!=="auto")Pe=Ue.autoTextDirection;else if(de&&de.length>=4){const[ot,Xe,He,mt]=de;Pe=mt-Xe>He-ot?"vertical":"horizontal"}Ye.push({translatedText:ce[we]||"",originalText:be.originalTexts?.[we]||"",coords:de,fontSize:U,fontFamily:le,textDirection:A,autoTextDirection:Pe,position:{x:0,y:0},textColor:S,rotationAngle:Ee[we]||0,fillColor:b,strokeEnabled:L,strokeColor:z,strokeWidth:H})}be.bubbleStates=Ye}else be.bubbleStates[$e]&&(be.bubbleStates[$e].translatedText=_e,be.bubbleStates[$e].textDirection=Ce)}Se=!0}if(Se&&be.bubbleStates){const ke=be.bubbleStates.map($e=>$e.translatedText||"");if(be.cleanImageData)try{const{apiClient:$e}=await lt(async()=>{const{apiClient:Ee}=await import("./client.Bht704G-.js");return{apiClient:Ee}},__vite__mapDeps([4,5])),_e=be.bubbleStates.map(Ee=>({translatedText:Ee.translatedText||"",coords:Ee.coords,fontSize:Ee.fontSize||U,fontFamily:Ee.fontFamily||le,textDirection:Ee.textDirection||ae,textColor:Ee.textColor||S,rotationAngle:Ee.rotationAngle||0,position:Ee.position||{x:0,y:0},strokeEnabled:Ee.strokeEnabled??L,strokeColor:Ee.strokeColor||z,strokeWidth:Ee.strokeWidth??H}));let Te=be.cleanImageData;Te.includes("base64,")&&(Te=Te.split("base64,")[1]||"");const Ce=await $e.post("/api/re_render_image",{clean_image:Te,bubble_texts:ke,bubble_coords:De,fontSize:U,fontFamily:le,textDirection:ae,textColor:S,bubble_states:_e,use_individual_styles:!0,use_inpainting:!1,use_lama:!1,fillColor:null,is_font_style_change:!1,strokeEnabled:L,strokeColor:z,strokeWidth:H});Ce.rendered_image&&(n.updateImageByIndex(he,{translatedDataURL:`data:image/png;base64,${Ce.rendered_image}`,bubbleStates:be.bubbleStates,bubbleTexts:ke,hasUnsavedChanges:!0}),console.log(`已完成图片 ${he} 的校对渲染`))}catch($e){console.error(`重新渲染图片 ${he} 失败:`,$e)}else n.updateImageByIndex(he,{bubbleStates:be.bubbleStates,bubbleTexts:ke,hasUnsavedChanges:!0})}}M>=0&&M<v.length&&n.setCurrentImageIndex(M)}async function Y(){if(!o.validateBeforeTranslation("proofread"))return!1;const{proofreading:g}=r.settings;if(!g.enabled||g.rounds.length===0)return a.error("请先启用 AI 校对并添加校对轮次"),!1;const v=n.images;if(v.length===0)return a.error("请先上传图片"),!1;if(!v.some(U=>U.bubbleTexts&&U.bubbleTexts.length>0))return a.error("请先进行翻译以获取译文"),!1;E.value=!0,n.setBatchTranslationInProgress(!0);const R=g.rounds.length;t.value={current:0,total:R,completed:0,failed:0,isInProgress:!0,isPaused:!1,label:"准备校对...",percentage:0},a.info(`开始校对，共 ${R} 轮`);try{for(let U=0;U<R;U++){const le=g.rounds[U];if(!le)continue;const re=le.name||`轮次${U+1}`,ae=U/R*100,S=1/R*100;a.info(`校对第 ${U+1}/${R} 轮: ${re}`),t.value.label=`轮次 ${U+1}/${R}`,t.value.percentage=Math.round(ae),a.info(`轮次 ${U+1}/${R}: 导出文本数据...`),t.value.label="导出文本...",t.value.percentage=Math.round(ae+S*.2);const b=w();if(!b)throw new Error("导出文本失败");a.info(`轮次 ${U+1}/${R}: 准备图片数据...`),t.value.label="准备图片数据...",t.value.percentage=Math.round(ae+S*.4);const L=m();a.info(`轮次 ${U+1}/${R}: 发送到AI进行校对...`),t.value.label="开始发送到AI...",t.value.percentage=Math.round(ae+S*.5);const z=le.batchSize||3,H=le.sessionReset||20,xe=g.maxRetries??2;f=[];const he=L.length,be=Math.ceil(he/z),Se=le.rpmLimit||7,ce=Se>0?Zt(Se):null;let De=0,ke=B(),$e=0;for(let _e=0;_e<be;_e++){const Te=ae+S*.5+S*.4*(_e/be);t.value.label=`轮次 ${U+1}/${R}: ${_e+1}/${be}`,t.value.percentage=Math.round(Te),De>=H&&(console.log("重置会话上下文"),ke=B(),De=0);const Ce=_e*z,Ee=Math.min(Ce+z,he),Ye=L.slice(Ce,Ee),we=c(b,Ce,Ee);let A=0,de=!1;for(;A<=xe&&!de;)try{ce&&await ce.acquire();const Pe=await ve(Ye,we,le,ke);Pe&&(f.push(Pe),$e++,de=!0),De++}catch(Pe){A++,A<=xe?(console.log(`轮次 ${U+1}, 批次 ${_e+1} 校对失败，第 ${A}/${xe} 次重试...`),a.warning(`轮次 ${U+1}, 批次 ${_e+1} 失败，正在重试 (${A}/${xe})...`),await new Promise(Ue=>setTimeout(Ue,1e3))):(console.error(`轮次 ${U+1}, 批次 ${_e+1} 校对最终失败:`,Pe),a.error(`轮次 ${U+1}, 批次 ${_e+1} 校对失败: ${Pe instanceof Error?Pe.message:"未知错误"}`))}}if($e===0)throw new Error(`轮次 ${U+1} 校对完全失败，请检查API设置或校对提示词`);a.info(`轮次 ${U+1}/${R}: 导入校对结果...`),t.value.label="导入校对结果...",t.value.percentage=Math.round(ae+S*.9),await W(F(f)),t.value.completed++}return t.value.label="校对完成！",t.value.percentage=100,a.success(`AI校对完成，共 ${R} 轮`),!0}catch(U){const le=U instanceof Error?U.message:"AI 校对失败";return a.error(`校对失败: ${le}`),t.value.label="校对已取消",t.value.percentage=0,!1}finally{E.value=!1,n.setBatchTranslationInProgress(!1),setTimeout(()=>{t.value.isInProgress=!1},1e3)}}async function me(){if(!n.currentImage)return a.error("请先上传图片"),!1;const v=u.bubbles;return!v||v.length===0?(a.error("当前图片没有气泡框，请先检测或手动添加"),!1):X({useExistingBubbles:!0,existingBubbleStates:v})}return{progress:t,isTranslatingSingle:s,isHqTranslating:_,isProofreading:E,isTranslating:T,progressPercent:N,translateCurrentImage:X,translateImageByIndex:q,translateAllImages:d,pauseBatchTranslation:l,resumeBatchTranslation:C,cancelBatchTranslation:x,removeTextOnly:O,removeAllTexts:Q,retryFailedImages:ge,executeHqTranslation:y,executeProofreading:Y,translateWithCurrentBubbles:me}}function nl(){const n=gt(),r=st(),u=h(!1);function o(){if(!u.value)return;const a=r.currentImage;n.bubbleCount>0?r.updateCurrentBubbleStates([...n.bubbles]):a&&Array.isArray(a.bubbleStates)&&a.bubbleStates.length>0&&(r.updateCurrentBubbleStates([]),console.log("退出编辑模式（无重渲染），用户已删除所有气泡")),u.value=!1,n.clearSelection(),console.log("已退出编辑模式（无重渲染）")}return{isActive:u,exitEditModeWithoutRender:o}}function ol(){const n=Jn(),r=Qe(),u=st(),o=Zn(),a=gt(),i=nl(),t=h(!1),s=h(!1),_=h(null),E=h([]),T=h([]),N=h([]),oe=h(null),ne=h(null),G=h(null),$=h(null),Z=h(!1);async function X(B=!1){if(!B&&(t.value||s.value)){console.log("[TranslateInit] 已经初始化，仅重新加载上下文"),await x();return}console.log("[TranslateInit] 开始初始化应用..."),t.value=!0,_.value=null;try{await q(),await d(),await l(),await C(),await x(),console.log("[TranslateInit] 应用初始化完成"),s.value=!0}catch(k){console.error("[TranslateInit] 应用初始化失败:",k),_.value=k instanceof Error?k.message:"初始化失败"}finally{t.value=!1}}async function q(){console.log("[TranslateInit] 初始化设置..."),r.initSettings();try{const B=await r.loadFromBackend();console.log(B?"[TranslateInit] 已从后端加载设置":"[TranslateInit] 后端无设置，使用 localStorage 数据")}catch(B){console.warn("[TranslateInit] 从后端加载设置失败，使用 localStorage 数据:",B)}console.log("[TranslateInit] 设置初始化完成")}async function d(){console.log("[TranslateInit] 初始化字体列表...");try{const B=await Xn();B.fonts&&B.fonts.length>0?(E.value=B.fonts,console.log(`[TranslateInit] 已加载 ${B.fonts.length} 个字体`)):B.error?console.warn("[TranslateInit] 获取字体列表失败:",B.error):console.warn("[TranslateInit] 字体列表为空")}catch(B){console.error("[TranslateInit] 获取字体列表失败:",B)}}async function l(){console.log("[TranslateInit] 初始化翻译提示词设置...");try{const B=await Jo();B.prompt_names!==void 0?(T.value=B.prompt_names||[],!r.settings.translatePrompt&&B.default_prompt_content&&r.setTranslatePrompt(B.default_prompt_content),console.log(`[TranslateInit] 已加载 ${T.value.length} 个翻译提示词`)):B.error&&console.warn("[TranslateInit] 获取翻译提示词失败:",B.error)}catch(B){console.error("[TranslateInit] 获取翻译提示词失败:",B)}}async function C(){console.log("[TranslateInit] 初始化文本框提示词设置...");try{const B=await Ho();B.prompt_names!==void 0?(N.value=B.prompt_names||[],!r.settings.textboxPrompt&&B.default_prompt_content&&r.setTextboxPrompt(B.default_prompt_content),console.log(`[TranslateInit] 已加载 ${N.value.length} 个文本框提示词`)):B.error&&console.warn("[TranslateInit] 获取文本框提示词失败:",B.error)}catch(B){console.error("[TranslateInit] 获取文本框提示词失败:",B)}}async function x(){const B=n.query.book,k=n.query.chapter;if(!B||!k){console.log("[TranslateInit] 未指定书籍/章节参数，使用独立模式"),Z.value=!1,oe.value=null,ne.value=null,G.value=null,$.value=null,o.clearContext();return}console.log(`[TranslateInit] 检测到书籍/章节参数: book=${B}, chapter=${k}`),Z.value=!0,oe.value=B,ne.value=k;try{const m=await Xo(B);if(!m.success||!m.book){console.warn("[TranslateInit] 书籍不存在:",B),Ie("书籍不存在","warning");return}const D=m.book,I=D.chapters?.find(p=>p.id===k);if(!I){console.warn("[TranslateInit] 章节不存在:",k),Ie("章节不存在","warning");return}if(G.value=D.title,$.value=I.title,o.setBookChapterContext(B,k,D.title,I.title),typeof document<"u"&&(document.title=`${I.title} - ${D.title} - Saber-Translator`),I.session_path){console.log(`[TranslateInit] 尝试加载章节会话: ${I.session_path}`);try{await o.loadSessionByPath(I.session_path),Ie(`已加载章节: ${I.title}`,"success")}catch{console.log("[TranslateInit] 章节会话数据不存在或加载失败，将创建新会话")}}}catch(m){console.error("[TranslateInit] 加载书籍/章节信息失败:",m),Ie("加载书籍信息失败","error")}}function O(B){if(B<0||B>=u.imageCount){console.warn(`[TranslateInit] 无效的图片索引: ${B}`);return}window._isChangingFromSwitchImage=!0,i.isActive.value&&i.exitEditModeWithoutRender(),u.currentImage&&a.bubbles.length>0&&u.updateCurrentImageProperty("bubbleStates",a.bubbles),u.setCurrentImageIndex(B);const m=u.currentImage;if(!m){console.warn("[TranslateInit] 切换到的图片不存在"),window._isChangingFromSwitchImage=!1;return}console.log(`[TranslateInit] 切换到图片: ${B}, ${m.fileName}`),m.bubbleStates&&m.bubbleStates.length>0?a.setBubbles(m.bubbleStates,!0):a.clearBubblesLocal(),Q(m),setTimeout(()=>{window._isChangingFromSwitchImage=!1,console.log("[TranslateInit] 已重置切换图片操作标记")},100)}function Q(B){if(!B)return;const k=B.bubbleStates?.[0];k&&r.updateTextStyle({fontSize:k.fontSize||r.settings.textStyle.fontSize,fontFamily:k.fontFamily||r.settings.textStyle.fontFamily,layoutDirection:B.userLayoutDirection||k.textDirection||r.settings.textStyle.layoutDirection,textColor:k.textColor||r.settings.textStyle.textColor,fillColor:k.fillColor||r.settings.textStyle.fillColor,strokeEnabled:k.strokeEnabled??r.settings.textStyle.strokeEnabled,strokeColor:k.strokeColor||r.settings.textStyle.strokeColor,strokeWidth:k.strokeWidth||r.settings.textStyle.strokeWidth,inpaintMethod:k.inpaintMethod||r.settings.textStyle.inpaintMethod,autoFontSize:B.autoFontSize??r.settings.textStyle.autoFontSize})}function ge(){u.canGoPrevious&&O(u.currentImageIndex-1)}function j(){u.canGoNext&&O(u.currentImageIndex+1)}function P(){ut(async()=>{await X()})}return{isInitializing:t,isInitialized:s,initError:_,fontList:E,promptNames:T,textboxPromptNames:N,currentBookId:oe,currentChapterId:ne,currentBookTitle:G,currentChapterTitle:$,isBookshelfMode:Z,initializeApp:X,initializeSettings:q,initializeFontList:d,initializePromptSettings:l,initializeTextboxPromptSettings:C,initializeBookChapterContext:x,switchImage:O,goToPrevious:ge,goToNext:j,loadImageSettingsToStore:Q,editMode:i,setupAutoInit:P}}const al={key:0,id:"translationProgressBar",class:"translation-progress-bar"},sl={class:"progress-bar-label"},ll={key:0,class:"failed-count"},il={key:0,class:"progress-controls"},rl=["title"],ul={class:"pause-icon"},cl=Ge({__name:"TranslationProgress",props:{progress:{},showControls:{type:Boolean,default:!0}},emits:["pause","resume"],setup(n,{emit:r}){const u=n,o=r,a=st(),i=gn(),t=te(()=>u.progress||i.progress.value),s=te(()=>t.value.isInProgress||a.isBatchTranslationInProgress),_=te(()=>t.value.current),E=te(()=>t.value.total),T=te(()=>t.value.failed),N=te(()=>t.value.percentage!==void 0?t.value.percentage:E.value===0?0:Math.round(_.value/E.value*100)),oe=te(()=>t.value.isPaused||a.isBatchTranslationPaused),ne=te(()=>t.value.label?t.value.label:`${oe.value?"已暂停":"翻译中"}：${_.value} / ${E.value}`);function G(){oe.value?(i.resumeBatchTranslation(),o("resume")):(i.pauseBatchTranslation(),o("pause"))}return($,Z)=>s.value?(V(),J("div",al,[e("div",sl,[Ne(ye(ne.value)+" ",1),T.value>0?(V(),J("span",ll,"（"+ye(T.value)+" 张失败）",1)):Me("",!0)]),e("div",{class:Le(["progress-bar",{paused:oe.value}])},[e("div",{class:"progress",style:it({width:`${N.value}%`})},null,4)],2),u.showControls?(V(),J("div",il,[e("button",{class:Le(["pause-btn",{paused:oe.value}]),onClick:G,title:oe.value?"继续翻译":"暂停翻译"},[e("span",ul,ye(oe.value?"▶":"⏸"),1),Ne(" "+ye(oe.value?"继续":"暂停"),1)],10,rl)])):Me("",!0)])):Me("",!0)}}),dl=je(cl,[["__scopeId","data-v-d438b9d6"]]),gl=Ge({__name:"SponsorModal",emits:["close"],setup(n,{emit:r}){const u=r;return(o,a)=>(V(),rt(jn,{title:"支持作者",onClose:a[1]||(a[1]=i=>u("close"))},{footer:yt(()=>[e("button",{type:"button",class:"btn btn-primary",onClick:a[0]||(a[0]=i=>u("close"))},"关闭")]),default:yt(()=>[a[2]||(a[2]=e("div",{class:"sponsor-content"},[e("p",{class:"sponsor-message"}," 如果这个项目对你有帮助，欢迎请作者喝杯咖啡 ☕ "),e("div",{class:"qr-codes"},[e("div",{class:"qr-item"},[e("div",{class:"qr-image"},[e("img",{src:"/pic/wechat_qrcode.png",alt:"微信支付"})]),e("span",{class:"qr-label"},"微信支付")]),e("div",{class:"qr-item"},[e("div",{class:"qr-image"},[e("img",{src:"/pic/alipay_qrcode.png",alt:"支付宝"})]),e("span",{class:"qr-label"},"支付宝")])]),e("p",{class:"sponsor-thanks"},"感谢您的支持！🙏")],-1))]),_:1}))}}),bl=je(gl,[["__scopeId","data-v-02b6948e"]]),pl={id:"thumbnail-sidebar",class:"thumbnail-sidebar"},vl={class:"card thumbnail-card"},ml=["title","data-index","onClick"],fl=["src","alt"],hl={key:1,class:"translation-failed-indicator"},yl={key:2,class:"labeled-indicator"},xl={key:3,class:"thumbnail-processing-indicator"},Sl={key:1,class:"empty-state"},kl=Ge({__name:"ThumbnailSidebar",emits:["select"],setup(n,{emit:r}){const u=r,o=st(),a=h(null),i=h([]),t=te(()=>o.images),s=te(()=>o.currentImageIndex),_=te(()=>o.hasImages);function E($){u("select",$)}function T(){ct(()=>{const $=i.value[s.value];if($&&a.value){const Z=a.value,X=$.offsetTop-Z.clientHeight/2+$.clientHeight/2;Z.scrollTo({top:Math.max(0,X),behavior:"smooth"})}})}function N($,Z){i.value[Z]=$}function oe($){return $.translationFailed?"failed":$.isManuallyAnnotated?"labeled":$.translationStatus==="processing"?"processing":null}function ne($){const Z=[];return $.translationFailed&&Z.push("translation-failed"),$.isManuallyAnnotated&&Z.push("has-manual-labels"),Z}function G($){return $.translationFailed?"翻译失败，点击可重试":$.isManuallyAnnotated?"包含手动标注":$.fileName||""}return Be(s,()=>{T()}),ut(()=>{_.value&&T()}),($,Z)=>(V(),J("aside",pl,[e("div",vl,[Z[1]||(Z[1]=e("h2",null,"图片概览",-1)),_.value?(V(),J("ul",{key:0,ref_key:"containerRef",ref:a,id:"thumbnailList",class:"thumbnail-list"},[(V(!0),J(Ze,null,et(t.value,(X,q)=>(V(),J("li",{key:X.id,ref_for:!0,ref:d=>N(d,q),class:Le(["thumbnail-item",[{active:q===s.value},...ne(X)]]),title:G(X),"data-index":q,onClick:d=>E(q)},[X.originalDataURL?(V(),J("img",{key:0,src:X.originalDataURL,alt:X.fileName,class:"thumbnail-image"},null,8,fl)):Me("",!0),oe(X)==="failed"?(V(),J("span",hl,"!")):oe(X)==="labeled"?(V(),J("span",yl,"✏️")):Me("",!0),oe(X)==="processing"?(V(),J("div",xl,"⟳")):Me("",!0)],10,ml))),128))],512)):(V(),J("div",Sl,[...Z[0]||(Z[0]=[e("p",null,"暂无图片",-1)])]))])]))}}),_l=je(kl,[["__scopeId","data-v-899e5674"]]),Cl={class:"saved-prompts-picker"},wl={class:"prompts-chips-container"},$l={key:0,class:"empty-hint"},Tl={key:1,class:"empty-hint"},Il=["title","onClick"],Dl=Ge({__name:"SavedPromptsPicker",props:{promptType:{}},emits:["select"],setup(n,{expose:r,emit:u}){const o=n,a=u,i=h([]),t=h(!1);async function s(){t.value=!0;try{let E;o.promptType==="textbox"?E=await qe.getTextboxPrompts():E=await qe.getPrompts(o.promptType);const T=E.prompt_names||[];i.value=T.map(N=>({name:N}))}catch(E){console.error("加载提示词列表失败:",E),i.value=[]}finally{t.value=!1}}async function _(E){try{let T;o.promptType==="textbox"?T=await qe.getTextboxPromptContent(E):T=await qe.getPromptContent(o.promptType,E),T.prompt_content&&a("select",T.prompt_content,E)}catch(T){console.error("加载提示词内容失败:",T)}}return Be(()=>o.promptType,()=>{s()}),ut(()=>{s()}),r({refresh:s}),(E,T)=>(V(),J("div",Cl,[T[1]||(T[1]=e("span",{class:"picker-label"},"📑 快速选择:",-1)),e("div",wl,[t.value?(V(),J("span",$l,"加载中...")):i.value.length===0?(V(),J("span",Tl,"暂无保存的提示词")):(V(!0),J(Ze,{key:2},et(i.value,N=>(V(),J("button",{key:N.name,type:"button",class:"prompt-chip",title:N.name,onClick:oe=>_(N.name)},[T[0]||(T[0]=e("span",{class:"chip-icon"},"📝",-1)),Ne(" "+ye(N.name),1)],8,Il))),128))])]))}}),Tt=je(Dl,[["__scopeId","data-v-2ebbb8b3"]]),Rl={class:"ocr-settings"},Ml={class:"settings-group"},Bl={class:"settings-item"},El={class:"settings-item"},Pl={class:"input-hint"},Al={class:"settings-group"},Fl={class:"settings-row"},Ll={class:"settings-item"},Ul={class:"password-input-wrapper"},Ol=["type"],zl={key:0,class:"eye-icon"},Vl={key:1,class:"eye-off-icon"},Nl={class:"settings-item"},Wl={class:"password-input-wrapper"},Kl=["type"],ql={key:0,class:"eye-icon"},Hl={key:1,class:"eye-off-icon"},Jl={class:"settings-row"},Yl={class:"settings-item"},Xl={class:"settings-item"},jl=["disabled"],Gl={class:"settings-group"},Zl={class:"settings-row"},Ql={class:"settings-item"},ei={class:"settings-item"},ti={class:"password-input-wrapper"},ni=["type"],oi={key:0,class:"eye-icon"},ai={key:1,class:"eye-off-icon"},si={class:"settings-item"},li={class:"settings-item"},ii={class:"model-input-with-fetch"},ri=["disabled"],ui={class:"fetch-text"},ci={key:0,class:"model-select-container"},di={class:"model-count"},gi={class:"settings-item"},bi={class:"prompt-format-selector"},pi={class:"settings-item"},vi=["disabled"],mi=Ge({__name:"OcrSettings",setup(n){const r=[{label:"MangaOCR (日语专用)",value:"manga_ocr"},{label:"PaddleOCR (多语言)",value:"paddle_ocr"},{label:"百度OCR",value:"baidu_ocr"},{label:"AI视觉OCR",value:"ai_vision"}],u=[{label:"标准版",value:"standard"},{label:"高精度版",value:"high_precision"}],o=[{label:"自动检测",value:"auto_detect"},{label:"中英文混合",value:"CHN_ENG"},{label:"英文",value:"ENG"},{label:"日语",value:"JAP"},{label:"韩语",value:"KOR"},{label:"法语",value:"FRE"},{label:"德语",value:"GER"},{label:"俄语",value:"RUS"}],a=[{label:"SiliconFlow (硅基流动)",value:"siliconflow"},{label:"火山引擎",value:"volcano"},{label:"Google Gemini",value:"gemini"},{label:"自定义 OpenAI 兼容服务",value:"custom_openai_vision"}],i=[{label:"普通提示词",value:"false"},{label:"JSON提示词",value:"true"}],t=[{label:"🚀 常用语言",options:[{label:"日语",value:"japanese"},{label:"英语",value:"en"},{label:"简体中文",value:"chinese"},{label:"繁体中文",value:"chinese_cht"},{label:"韩语",value:"korean"}]},{label:"🌍 拉丁语系",options:[{label:"法语",value:"french"},{label:"德语",value:"german"},{label:"西班牙语",value:"spanish"},{label:"意大利语",value:"italian"},{label:"葡萄牙语",value:"portuguese"}]},{label:"🌏 其他语系",options:[{label:"俄语",value:"russian"}]}],s=Qe(),_=dt(),E=h({apiKey:s.settings.baiduOcr.apiKey,secretKey:s.settings.baiduOcr.secretKey,version:s.settings.baiduOcr.version,sourceLanguage:s.settings.baiduOcr.sourceLanguage}),T=h({apiKey:s.settings.aiVisionOcr.apiKey,modelName:s.settings.aiVisionOcr.modelName,customBaseUrl:s.settings.aiVisionOcr.customBaseUrl,prompt:s.settings.aiVisionOcr.prompt,rpmLimit:s.settings.aiVisionOcr.rpmLimit}),N=te(()=>s.settings);Be(()=>E.value.apiKey,k=>{s.updateBaiduOcr({apiKey:k})}),Be(()=>E.value.secretKey,k=>{s.updateBaiduOcr({secretKey:k})}),Be(()=>E.value.version,k=>{s.updateBaiduOcr({version:k})}),Be(()=>E.value.sourceLanguage,k=>{s.updateBaiduOcr({sourceLanguage:k})}),Be(()=>T.value.apiKey,k=>{s.updateAiVisionOcr({apiKey:k})}),Be(()=>T.value.modelName,k=>{s.updateAiVisionOcr({modelName:k})}),Be(()=>T.value.customBaseUrl,k=>{s.updateAiVisionOcr({customBaseUrl:k})}),Be(()=>T.value.prompt,k=>{s.updateAiVisionOcr({prompt:k})}),Be(()=>T.value.rpmLimit,k=>{s.updateAiVisionOcr({rpmLimit:k})});const oe=h(!1),ne=h(!1),G=h(!1),$=h(!1),Z=h(!1),X=h([]),q=te(()=>{const k=[{label:"-- 选择模型 --",value:""}];return X.value.forEach(m=>{k.push({label:m,value:m})}),k});function d(){s.saveToStorage()}function l(){s.saveToStorage()}function C(){switch(s.settings.ocrEngine){case"manga_ocr":return"MangaOCR 专为日语漫画优化，源语言设置不影响识别";case"paddle_ocr":return"PaddleOCR 会根据源语言加载对应的识别模型";case"baidu_ocr":return"百度OCR 使用独立的源语言设置（见下方）";case"ai_vision":return"AI视觉OCR 通过提示词指定识别语言";default:return"选择要识别的原文语言"}}function x(k){s.setAiVisionOcrProvider(k),X.value=[],O()}function O(){T.value.apiKey=s.settings.aiVisionOcr.apiKey,T.value.modelName=s.settings.aiVisionOcr.modelName,T.value.customBaseUrl=s.settings.aiVisionOcr.customBaseUrl,T.value.prompt=s.settings.aiVisionOcr.prompt,T.value.rpmLimit=s.settings.aiVisionOcr.rpmLimit}function Q(){const k=s.settings.aiVisionOcr.isJsonMode?To:Io;s.updateAiVisionOcr({prompt:k}),T.value.prompt=k}async function ge(){const k=E.value.apiKey?.trim(),m=E.value.secretKey?.trim();if(!k||!m){_.warning("请填写百度OCR的API Key和Secret Key");return}$.value=!0,_.info("正在测试百度OCR连接...");try{const D=await qe.testBaiduOcrConnection(k,m);D.success?_.success(D.message||"百度OCR连接成功!"):_.error(D.message||D.error||"百度OCR连接失败")}catch(D){const I=D instanceof Error?D.message:"连接测试失败";_.error(I)}finally{$.value=!1}}async function j(){$.value=!0;try{const k=await qe.testAiVisionOcrConnection({provider:s.settings.aiVisionOcr.provider,apiKey:T.value.apiKey,modelName:T.value.modelName,customBaseUrl:T.value.customBaseUrl,prompt:T.value.prompt});k.success?_.success("AI视觉OCR连接成功"):_.error(`AI视觉OCR连接失败: ${k.error||"未知错误"}`)}catch(k){const m=k instanceof Error?k.message:"连接测试失败";_.error(m)}finally{$.value=!1}}async function P(){const k=s.settings.aiVisionOcr.provider,m=T.value.apiKey?.trim(),D=T.value.customBaseUrl?.trim();if(!m){_.warning("请先填写 API Key");return}if(!["siliconflow","volcano","gemini","custom_openai_vision"].includes(k)){_.warning("当前服务商不支持自动获取模型列表");return}if(k==="custom_openai_vision"&&!D){_.warning("自定义服务需要先填写 Base URL");return}Z.value=!0;try{const p=await qe.fetchModels(k,m,D);p.success&&p.models&&p.models.length>0?(X.value=p.models.map(y=>y.id),_.success(`获取到 ${p.models.length} 个模型`)):_.warning(p.message||"未获取到可用模型")}catch(p){const y=p instanceof Error?p.message:"获取模型列表失败";_.error(y)}finally{Z.value=!1}}function B(k,m){s.updateAiVisionOcr({prompt:k}),T.value.prompt=k,_.success(`已应用提示词: ${m}`)}return(k,m)=>(V(),J("div",Rl,[e("div",Ml,[m[19]||(m[19]=e("div",{class:"settings-group-title"},"OCR引擎选择",-1)),e("div",Bl,[m[17]||(m[17]=e("label",{for:"settingsOcrEngine"},"OCR引擎:",-1)),Re(We,{"model-value":N.value.ocrEngine,options:r,onChange:m[0]||(m[0]=D=>{N.value.ocrEngine=D,d()})},null,8,["model-value"])]),ie(e("div",El,[m[18]||(m[18]=e("label",{for:"settingsSourceLanguage"},"源语言:",-1)),Re(We,{"model-value":N.value.sourceLanguage,groups:t,onChange:m[1]||(m[1]=D=>{N.value.sourceLanguage=D,l()})},null,8,["model-value"]),e("div",Pl,ye(C()),1)],512),[[Ke,N.value.ocrEngine==="paddle_ocr"]])]),ie(e("div",Al,[m[24]||(m[24]=e("div",{class:"settings-group-title"},"百度OCR 设置",-1)),e("div",Fl,[e("div",Ll,[m[20]||(m[20]=e("label",{for:"settingsBaiduApiKey"},"API Key:",-1)),e("div",Ul,[ie(e("input",{type:oe.value?"text":"password",id:"settingsBaiduApiKey","onUpdate:modelValue":m[2]||(m[2]=D=>E.value.apiKey=D),class:"secure-input",placeholder:"请输入百度OCR API Key",autocomplete:"off"},null,8,Ol),[[kt,E.value.apiKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:m[3]||(m[3]=D=>oe.value=!oe.value)},[oe.value?(V(),J("span",Vl,"👁‍🗨")):(V(),J("span",zl,"👁"))])])]),e("div",Nl,[m[21]||(m[21]=e("label",{for:"settingsBaiduSecretKey"},"Secret Key:",-1)),e("div",Wl,[ie(e("input",{type:ne.value?"text":"password",id:"settingsBaiduSecretKey","onUpdate:modelValue":m[4]||(m[4]=D=>E.value.secretKey=D),class:"secure-input",placeholder:"请输入Secret Key",autocomplete:"off"},null,8,Kl),[[kt,E.value.secretKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:m[5]||(m[5]=D=>ne.value=!ne.value)},[ne.value?(V(),J("span",Hl,"👁‍🗨")):(V(),J("span",ql,"👁"))])])])]),e("div",Jl,[e("div",Yl,[m[22]||(m[22]=e("label",{for:"settingsBaiduVersion"},"识别版本:",-1)),Re(We,{modelValue:E.value.version,"onUpdate:modelValue":m[6]||(m[6]=D=>E.value.version=D),options:u},null,8,["modelValue"])]),e("div",Xl,[m[23]||(m[23]=e("label",{for:"settingsBaiduSourceLanguage"},"源语言:",-1)),Re(We,{modelValue:E.value.sourceLanguage,"onUpdate:modelValue":m[7]||(m[7]=D=>E.value.sourceLanguage=D),options:o},null,8,["modelValue"])])]),e("button",{class:"settings-test-btn",onClick:ge,disabled:$.value},ye($.value?"测试中...":"🔗 测试连接"),9,jl)],512),[[Ke,N.value.ocrEngine==="baidu_ocr"]]),ie(e("div",Gl,[m[34]||(m[34]=e("div",{class:"settings-group-title"},"AI视觉OCR 设置",-1)),e("div",Zl,[e("div",Ql,[m[25]||(m[25]=e("label",{for:"settingsAiVisionProvider"},"服务商:",-1)),Re(We,{"model-value":N.value.aiVisionOcr.provider,options:a,onChange:m[8]||(m[8]=D=>x(D))},null,8,["model-value"])]),e("div",ei,[m[26]||(m[26]=e("label",{for:"settingsAiVisionApiKey"},"API Key:",-1)),e("div",ti,[ie(e("input",{type:G.value?"text":"password",id:"settingsAiVisionApiKey","onUpdate:modelValue":m[9]||(m[9]=D=>T.value.apiKey=D),class:"secure-input",placeholder:"请输入API Key",autocomplete:"off"},null,8,ni),[[kt,T.value.apiKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:m[10]||(m[10]=D=>G.value=!G.value)},[G.value?(V(),J("span",ai,"👁‍🗨")):(V(),J("span",oi,"👁"))])])])]),ie(e("div",si,[m[27]||(m[27]=e("label",{for:"settingsCustomAiVisionBaseUrl"},"Base URL:",-1)),ie(e("input",{type:"text",id:"settingsCustomAiVisionBaseUrl","onUpdate:modelValue":m[11]||(m[11]=D=>T.value.customBaseUrl=D),placeholder:"例如: https://api.example.com/v1"},null,512),[[Ae,T.value.customBaseUrl]])],512),[[Ke,N.value.aiVisionOcr.provider==="custom_openai_vision"]]),e("div",li,[m[29]||(m[29]=e("label",{for:"settingsAiVisionModelName"},"模型名称:",-1)),e("div",ii,[ie(e("input",{type:"text",id:"settingsAiVisionModelName","onUpdate:modelValue":m[12]||(m[12]=D=>T.value.modelName=D),placeholder:"如: silicon-llava2-34b"},null,512),[[Ae,T.value.modelName]]),e("button",{type:"button",class:"fetch-models-btn",title:"获取可用模型列表",onClick:P,disabled:Z.value},[m[28]||(m[28]=e("span",{class:"fetch-icon"},"🔍",-1)),e("span",ui,ye(Z.value?"获取中...":"获取模型"),1)],8,ri)]),X.value.length>0?(V(),J("div",ci,[Re(We,{modelValue:T.value.modelName,"onUpdate:modelValue":m[13]||(m[13]=D=>T.value.modelName=D),options:q.value},null,8,["modelValue","options"]),e("span",di,"共 "+ye(X.value.length)+" 个模型",1)])):Me("",!0)]),e("div",gi,[m[31]||(m[31]=e("label",{for:"settingsAiVisionOcrPrompt"},"OCR提示词:",-1)),ie(e("textarea",{id:"settingsAiVisionOcrPrompt","onUpdate:modelValue":m[14]||(m[14]=D=>T.value.prompt=D),rows:"3",placeholder:"AI视觉OCR提示词"},null,512),[[Ae,T.value.prompt]]),Re(Tt,{"prompt-type":"ai_vision_ocr",onSelect:B}),e("div",bi,[Re(We,{"model-value":N.value.aiVisionOcr.isJsonMode?"true":"false",options:i,onChange:m[15]||(m[15]=D=>{N.value.aiVisionOcr.isJsonMode=D==="true",Q()})},null,8,["model-value"]),m[30]||(m[30]=e("span",{class:"input-hint"},"JSON格式输出更结构化",-1))])]),e("div",pi,[m[32]||(m[32]=e("label",{for:"settingsRpmAiVisionOcr"},"RPM限制 (每分钟请求数):",-1)),ie(e("input",{type:"number",id:"settingsRpmAiVisionOcr","onUpdate:modelValue":m[16]||(m[16]=D=>T.value.rpmLimit=D),min:"0",step:"1"},null,512),[[Ae,T.value.rpmLimit,void 0,{number:!0}]]),m[33]||(m[33]=e("div",{class:"input-hint"},"0 表示无限制",-1))]),e("button",{class:"settings-test-btn",onClick:j,disabled:$.value},ye($.value?"测试中...":"🔗 测试连接"),9,vi)],512),[[Ke,N.value.ocrEngine==="ai_vision"]])]))}}),fi=je(mi,[["__scopeId","data-v-f3101cc5"]]),hi={class:"translation-settings"},yi={class:"settings-group"},xi={class:"settings-row"},Si={class:"settings-item"},ki={class:"settings-item"},_i={for:"settingsApiKey"},Ci={class:"password-input-wrapper"},wi=["type","placeholder"],$i={key:0,class:"eye-icon"},Ti={key:1,class:"eye-off-icon"},Ii={class:"settings-item"},Di={class:"settings-item"},Ri={for:"settingsModelName"},Mi={class:"model-input-with-fetch"},Bi=["placeholder"],Ei=["disabled"],Pi={class:"fetch-text"},Ai={key:0,class:"model-select-container"},Fi={class:"model-count"},Li={class:"settings-item"},Ui={class:"local-model-list"},Oi={key:0,class:"model-list-container"},zi=["disabled"],Vi={key:1,class:"model-hint"},Ni={key:1,class:"model-list-container"},Wi=["disabled"],Ki={key:1,class:"model-hint"},qi={class:"settings-row"},Hi={class:"settings-item"},Ji={class:"settings-item"},Yi={class:"settings-item"},Xi=["disabled"],ji={class:"settings-item"},Gi=["disabled"],Zi={class:"settings-group"},Qi={class:"settings-item"},er={class:"prompt-format-selector"},tr={class:"settings-item"},nr={class:"checkbox-label"},or={class:"settings-item"},ar=Ge({__name:"TranslationSettings",setup(n){const r=[{label:"SiliconFlow",value:"siliconflow"},{label:"DeepSeek",value:"deepseek"},{label:"火山引擎",value:"volcano"},{label:"彩云小译",value:"caiyun"},{label:"百度翻译",value:"baidu_translate"},{label:"有道翻译",value:"youdao_translate"},{label:"Google Gemini",value:"gemini"},{label:"Ollama (本地)",value:"ollama"},{label:"Sakura (本地)",value:"sakura"},{label:"自定义 OpenAI 兼容服务",value:"custom_openai"}],u=[{label:"普通提示词",value:"normal"},{label:"JSON提示词",value:"json"}],o=Qe(),a=dt(),i=h({modelProvider:o.settings.translation.provider,apiKey:o.settings.translation.apiKey,modelName:o.settings.translation.modelName,customBaseUrl:o.settings.translation.customBaseUrl,rpmTranslation:o.settings.translation.rpmLimit,translationMaxRetries:o.settings.translation.maxRetries,promptContent:o.settings.translatePrompt,translatePromptMode:o.settings.translation.isJsonMode?"json":"normal",enableTextboxPrompt:o.settings.useTextboxPrompt,textboxPromptContent:o.settings.textboxPrompt}),t=h(!1),s=h(!1),_=h(!1),E=h([]),T=h([]),N=h([]),oe=te(()=>{const I=[{label:"-- 选择模型 --",value:""}];return E.value.forEach(p=>I.push({label:p,value:p})),I}),ne=te(()=>{const I=[{label:"-- 选择模型 --",value:""}];return T.value.forEach(p=>I.push({label:p,value:p})),I}),G=te(()=>{const I=[{label:"-- 选择模型 --",value:""}];return N.value.forEach(p=>I.push({label:p,value:p})),I}),$=te(()=>["ollama","sakura"].includes(i.value.modelProvider)),Z=te(()=>!["ollama","sakura","caiyun","baidu_translate","youdao_translate"].includes(i.value.modelProvider)),X=te(()=>["siliconflow","deepseek","volcano","gemini","custom_openai"].includes(i.value.modelProvider)),q=te(()=>{switch(i.value.modelProvider){case"baidu_translate":return"App ID";case"youdao_translate":return"App Key";case"caiyun":return"API Token";default:return"API Key"}}),d=te(()=>{switch(i.value.modelProvider){case"baidu_translate":return"请输入百度翻译App ID";case"youdao_translate":return"请输入有道翻译应用ID";case"caiyun":return"请输入彩云小译Token";default:return"请输入API Key"}}),l=te(()=>{switch(i.value.modelProvider){case"baidu_translate":return"App Key";case"youdao_translate":return"App Secret";case"caiyun":return"源语言 (可选)";default:return"模型名称"}}),C=te(()=>{switch(i.value.modelProvider){case"baidu_translate":return"请输入百度翻译App Key";case"youdao_translate":return"请输入有道翻译应用密钥";case"caiyun":return"可选: auto/日语/英语";default:return"请输入模型名称"}});function x(){const I=i.value.modelProvider;o.setTranslationProvider(I),i.value.apiKey=o.settings.translation.apiKey,i.value.modelName=o.settings.translation.modelName,i.value.customBaseUrl=o.settings.translation.customBaseUrl,i.value.rpmTranslation=o.settings.translation.rpmLimit,i.value.translationMaxRetries=o.settings.translation.maxRetries,E.value=[]}function O(){const I=i.value.translatePromptMode==="json";I?i.value.promptContent=Do:i.value.promptContent=Ro,o.updateTranslationService({isJsonMode:I}),o.setTranslatePrompt(i.value.promptContent)}Be(()=>i.value.apiKey,I=>{o.updateTranslationService({apiKey:I})}),Be(()=>i.value.modelName,I=>{o.updateTranslationService({modelName:I})}),Be(()=>i.value.customBaseUrl,I=>{o.updateTranslationService({customBaseUrl:I})}),Be(()=>i.value.rpmTranslation,I=>{o.updateTranslationService({rpmLimit:I})}),Be(()=>i.value.translationMaxRetries,I=>{o.updateTranslationService({maxRetries:I})}),Be(()=>i.value.promptContent,I=>{o.setTranslatePrompt(I)}),Be(()=>i.value.enableTextboxPrompt,I=>{o.setUseTextboxPrompt(I)}),Be(()=>i.value.textboxPromptContent,I=>{o.setTextboxPrompt(I)});async function Q(){const I=i.value.modelProvider,p=i.value.apiKey?.trim(),y=i.value.customBaseUrl?.trim();if(!p){a.warning("请先填写 API Key");return}if(!["siliconflow","deepseek","volcano","gemini","custom_openai"].includes(I)){a.warning(`${ge(I)} 不支持自动获取模型列表`);return}if(I==="custom_openai"&&!y){a.warning("自定义服务需要先填写 Base URL");return}_.value=!0;try{const se=await qe.fetchModels(I,p,y);se.success&&se.models&&se.models.length>0?(E.value=se.models.map(f=>f.id),a.success(`获取到 ${se.models.length} 个模型`)):a.warning(se.message||"未获取到可用模型")}catch(se){const f=se instanceof Error?se.message:"获取模型列表失败";a.error(f)}finally{_.value=!1}}function ge(I){return{siliconflow:"SiliconFlow",deepseek:"DeepSeek",volcano:"火山引擎",gemini:"Google Gemini",custom_openai:"自定义OpenAI",ollama:"Ollama",sakura:"Sakura",caiyun:"彩云小译",baidu_translate:"百度翻译",youdao_translate:"有道翻译"}[I]||I}async function j(){_.value=!0;try{const I=await qe.testOllamaConnection();I.success&&I.models?(T.value=I.models,a.success(`获取到 ${I.models.length} 个Ollama模型`)):a.error(I.error||"Ollama连接失败")}catch(I){const p=I instanceof Error?I.message:"获取Ollama模型失败";a.error(p)}finally{_.value=!1}}async function P(){_.value=!0;try{const I=await qe.testSakuraConnection();I.success&&I.models?(N.value=I.models,a.success(`获取到 ${I.models.length} 个Sakura模型`)):a.error(I.error||"Sakura连接失败")}catch(I){const p=I instanceof Error?I.message:"获取Sakura模型失败";a.error(p)}finally{_.value=!1}}async function B(){s.value=!0;try{let I;i.value.modelProvider==="ollama"?I=await qe.testOllamaConnection():I=await qe.testSakuraConnection(),I.success?a.success(`${i.value.modelProvider==="ollama"?"Ollama":"Sakura"} 连接成功`):a.error(I.error||"连接失败")}catch(I){const p=I instanceof Error?I.message:"连接测试失败";a.error(p)}finally{s.value=!1}}async function k(){const I=i.value.modelProvider,p=i.value.apiKey?.trim(),y=i.value.modelName?.trim(),ee=i.value.customBaseUrl?.trim();if(!p){a.warning("请先填写 API Key");return}if(I!=="caiyun"&&!y){a.warning("请填写模型名称");return}if(I==="custom_openai"&&!ee){a.warning("自定义服务需要填写 Base URL");return}s.value=!0,a.info("正在测试连接...");try{let se;switch(I){case"baidu_translate":se=await qe.testBaiduTranslateConnection(p,y);break;case"youdao_translate":se=await qe.testYoudaoTranslateConnection(p,y);break;default:se=await qe.testAiTranslateConnection({provider:I,apiKey:p,modelName:y,baseUrl:ee})}se.success?a.success(se.message||`${ge(I)} 连接成功!`):a.error(se.message||se.error||"连接失败")}catch(se){const f=se instanceof Error?se.message:"连接测试失败";a.error(f)}finally{s.value=!1}}function m(I,p){i.value.promptContent=I,a.success(`已应用提示词: ${p}`)}function D(I,p){i.value.textboxPromptContent=I,a.success(`已应用提示词: ${p}`)}return(I,p)=>(V(),J("div",hi,[e("div",yi,[p[21]||(p[21]=e("div",{class:"settings-group-title"},"翻译服务配置",-1)),e("div",xi,[e("div",Si,[p[14]||(p[14]=e("label",{for:"settingsModelProvider"},"翻译服务商:",-1)),Re(We,{"model-value":i.value.modelProvider,options:r,onChange:p[0]||(p[0]=y=>{i.value.modelProvider=y,x()})},null,8,["model-value"])]),ie(e("div",ki,[e("label",_i,ye(q.value)+":",1),e("div",Ci,[ie(e("input",{type:t.value?"text":"password",id:"settingsApiKey","onUpdate:modelValue":p[1]||(p[1]=y=>i.value.apiKey=y),class:"secure-input",placeholder:d.value,autocomplete:"off"},null,8,wi),[[kt,i.value.apiKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:p[2]||(p[2]=y=>t.value=!t.value)},[t.value?(V(),J("span",Ti,"👁‍🗨")):(V(),J("span",$i,"👁"))])])],512),[[Ke,!$.value]])]),ie(e("div",Ii,[p[15]||(p[15]=e("label",{for:"settingsCustomBaseUrl"},"Base URL:",-1)),ie(e("input",{type:"text",id:"settingsCustomBaseUrl","onUpdate:modelValue":p[3]||(p[3]=y=>i.value.customBaseUrl=y),placeholder:"例如: https://api.example.com/v1"},null,512),[[Ae,i.value.customBaseUrl]])],512),[[Ke,i.value.modelProvider==="custom_openai"]]),ie(e("div",Di,[e("label",Ri,ye(l.value)+":",1),e("div",Mi,[ie(e("input",{type:"text",id:"settingsModelName","onUpdate:modelValue":p[4]||(p[4]=y=>i.value.modelName=y),placeholder:C.value},null,8,Bi),[[Ae,i.value.modelName]]),ie(e("button",{type:"button",class:"fetch-models-btn",title:"获取可用模型列表",onClick:Q,disabled:_.value},[p[16]||(p[16]=e("span",{class:"fetch-icon"},"🔍",-1)),e("span",Pi,ye(_.value?"获取中...":"获取模型"),1)],8,Ei),[[Ke,X.value]])]),E.value.length>0?(V(),J("div",Ai,[Re(We,{"model-value":i.value.modelName,options:oe.value,onChange:p[5]||(p[5]=y=>{i.value.modelName=y})},null,8,["model-value","options"]),e("span",Fi,"共 "+ye(E.value.length)+" 个模型",1)])):Me("",!0)],512),[[Ke,!$.value]]),ie(e("div",Li,[p[17]||(p[17]=e("label",null,"本地模型:",-1)),e("div",Ui,[i.value.modelProvider==="ollama"?(V(),J("div",Oi,[e("button",{class:"settings-test-btn",onClick:j,disabled:_.value},ye(_.value?"获取中...":"🔄 刷新模型列表"),9,zi),T.value.length>0?(V(),rt(We,{key:0,"model-value":i.value.modelName,options:ne.value,onChange:p[6]||(p[6]=y=>i.value.modelName=y)},null,8,["model-value","options"])):(V(),J("p",Vi,"点击刷新获取可用模型"))])):i.value.modelProvider==="sakura"?(V(),J("div",Ni,[e("button",{class:"settings-test-btn",onClick:P,disabled:_.value},ye(_.value?"获取中...":"🔄 刷新模型列表"),9,Wi),N.value.length>0?(V(),rt(We,{key:0,"model-value":i.value.modelName,options:G.value,onChange:p[7]||(p[7]=y=>i.value.modelName=y)},null,8,["model-value","options"])):(V(),J("p",Ki,"点击刷新获取可用模型"))])):Me("",!0)])],512),[[Ke,$.value]]),ie(e("div",qi,[e("div",Hi,[p[18]||(p[18]=e("label",{for:"settingsRpmTranslation"},"RPM限制:",-1)),ie(e("input",{type:"number",id:"settingsRpmTranslation","onUpdate:modelValue":p[8]||(p[8]=y=>i.value.rpmTranslation=y),min:"0",step:"1"},null,512),[[Ae,i.value.rpmTranslation,void 0,{number:!0}]]),p[19]||(p[19]=e("div",{class:"input-hint"},"每分钟请求数，0表示无限制",-1))]),e("div",Ji,[p[20]||(p[20]=e("label",{for:"settingsTranslationMaxRetries"},"重试次数:",-1)),ie(e("input",{type:"number",id:"settingsTranslationMaxRetries","onUpdate:modelValue":p[9]||(p[9]=y=>i.value.translationMaxRetries=y),min:"0",max:"10",step:"1"},null,512),[[Ae,i.value.translationMaxRetries,void 0,{number:!0}]])])],512),[[Ke,Z.value]]),ie(e("div",Yi,[e("button",{class:"settings-test-btn",onClick:B,disabled:s.value},ye(s.value?"测试中...":"🔗 测试连接"),9,Xi)],512),[[Ke,$.value]]),ie(e("div",ji,[e("button",{class:"settings-test-btn",onClick:k,disabled:s.value},ye(s.value?"测试中...":"🔗 测试连接"),9,Gi)],512),[[Ke,!$.value]])]),e("div",Zi,[p[26]||(p[26]=e("div",{class:"settings-group-title"},"提示词设置",-1)),e("div",Qi,[p[23]||(p[23]=e("label",{for:"settingsPromptContent"},"翻译提示词:",-1)),ie(e("textarea",{id:"settingsPromptContent","onUpdate:modelValue":p[10]||(p[10]=y=>i.value.promptContent=y),rows:"4",placeholder:"翻译提示词"},null,512),[[Ae,i.value.promptContent]]),e("div",er,[Re(We,{"model-value":i.value.translatePromptMode,options:u,onChange:p[11]||(p[11]=y=>{i.value.translatePromptMode=y,O()})},null,8,["model-value"]),p[22]||(p[22]=e("span",{class:"input-hint"},"JSON格式输出更结构化",-1))]),Re(Tt,{"prompt-type":"translate",onSelect:m})]),e("div",tr,[e("label",nr,[ie(e("input",{type:"checkbox","onUpdate:modelValue":p[12]||(p[12]=y=>i.value.enableTextboxPrompt=y)},null,512),[[tt,i.value.enableTextboxPrompt]]),p[24]||(p[24]=Ne(" 启用文本框提示词 ",-1))])]),ie(e("div",or,[p[25]||(p[25]=e("label",{for:"settingsTextboxPromptContent"},"文本框提示词:",-1)),ie(e("textarea",{id:"settingsTextboxPromptContent","onUpdate:modelValue":p[13]||(p[13]=y=>i.value.textboxPromptContent=y),rows:"3",placeholder:"文本框提示词"},null,512),[[Ae,i.value.textboxPromptContent]]),Re(Tt,{"prompt-type":"textbox",onSelect:D})],512),[[Ke,i.value.enableTextboxPrompt]])])]))}}),sr=je(ar,[["__scopeId","data-v-165d523b"]]),lr={class:"detection-settings"},ir={class:"settings-group"},rr={class:"settings-item"},ur={class:"settings-group"},cr={class:"settings-item"},dr={class:"settings-row"},gr={class:"settings-item"},br={class:"settings-item"},pr={class:"settings-row"},vr={class:"settings-item"},mr={class:"settings-item"},fr={class:"settings-group"},hr={class:"settings-item"},yr={class:"checkbox-label"},xr={class:"settings-row"},Sr={class:"settings-item"},kr={class:"settings-item"},_r={class:"settings-group"},Cr={class:"settings-item"},wr={class:"checkbox-label"},$r=Ge({__name:"DetectionSettings",setup(n){const r=[{label:"CTD (Comic Text Detector)",value:"ctd"},{label:"YOLO",value:"yolo"},{label:"YOLOv5",value:"yolov5"},{label:"Default (DBNet)",value:"default"}],u=Qe(),o=Eo({textDetector:u.settings.textDetector,boxExpandRatio:u.settings.boxExpand.ratio,boxExpandTop:u.settings.boxExpand.top,boxExpandBottom:u.settings.boxExpand.bottom,boxExpandLeft:u.settings.boxExpand.left,boxExpandRight:u.settings.boxExpand.right,usePreciseMask:u.settings.preciseMask.enabled,maskDilateSize:u.settings.preciseMask.dilateSize,maskBoxExpandRatio:u.settings.preciseMask.boxExpandRatio,showDetectionDebug:u.settings.showDetectionDebug}),a=te(()=>["ctd","default"].includes(o.textDetector));Be(()=>o.textDetector,t=>{u.setTextDetector(t)}),Be(()=>o.boxExpandRatio,t=>{u.updateBoxExpand({ratio:t})}),Be(()=>o.boxExpandTop,t=>{u.updateBoxExpand({top:t})}),Be(()=>o.boxExpandBottom,t=>{u.updateBoxExpand({bottom:t})}),Be(()=>o.boxExpandLeft,t=>{u.updateBoxExpand({left:t})}),Be(()=>o.boxExpandRight,t=>{u.updateBoxExpand({right:t})}),Be(()=>o.usePreciseMask,t=>{u.updatePreciseMask({enabled:t})}),Be(()=>o.maskDilateSize,t=>{u.updatePreciseMask({dilateSize:t})}),Be(()=>o.maskBoxExpandRatio,t=>{u.updatePreciseMask({boxExpandRatio:t})}),Be(()=>o.showDetectionDebug,t=>{u.setShowDetectionDebug(t)});function i(){a.value||(o.usePreciseMask=!1)}return(t,s)=>(V(),J("div",lr,[e("div",ir,[s[11]||(s[11]=e("div",{class:"settings-group-title"},"文字检测器",-1)),e("div",rr,[s[10]||(s[10]=e("label",{for:"settingsTextDetector"},"检测器类型:",-1)),Re(We,{modelValue:o.textDetector,"onUpdate:modelValue":s[0]||(s[0]=_=>o.textDetector=_),options:r,onChange:i},null,8,["modelValue"])])]),e("div",ur,[s[18]||(s[18]=e("div",{class:"settings-group-title"},"文本框扩展参数",-1)),e("div",cr,[s[12]||(s[12]=e("label",{for:"settingsBoxExpandRatio"},"整体扩展 (%):",-1)),ie(e("input",{type:"number",id:"settingsBoxExpandRatio","onUpdate:modelValue":s[1]||(s[1]=_=>o.boxExpandRatio=_),min:"0",max:"50",step:"1"},null,512),[[Ae,o.boxExpandRatio,void 0,{number:!0}]]),s[13]||(s[13]=e("div",{class:"input-hint"},"向四周均匀扩展的百分比 (0-50%)",-1))]),e("div",dr,[e("div",gr,[s[14]||(s[14]=e("label",{for:"settingsBoxExpandTop"},"上方扩展 (%):",-1)),ie(e("input",{type:"number",id:"settingsBoxExpandTop","onUpdate:modelValue":s[2]||(s[2]=_=>o.boxExpandTop=_),min:"0",max:"50",step:"1"},null,512),[[Ae,o.boxExpandTop,void 0,{number:!0}]])]),e("div",br,[s[15]||(s[15]=e("label",{for:"settingsBoxExpandBottom"},"下方扩展 (%):",-1)),ie(e("input",{type:"number",id:"settingsBoxExpandBottom","onUpdate:modelValue":s[3]||(s[3]=_=>o.boxExpandBottom=_),min:"0",max:"50",step:"1"},null,512),[[Ae,o.boxExpandBottom,void 0,{number:!0}]])])]),e("div",pr,[e("div",vr,[s[16]||(s[16]=e("label",{for:"settingsBoxExpandLeft"},"左侧扩展 (%):",-1)),ie(e("input",{type:"number",id:"settingsBoxExpandLeft","onUpdate:modelValue":s[4]||(s[4]=_=>o.boxExpandLeft=_),min:"0",max:"50",step:"1"},null,512),[[Ae,o.boxExpandLeft,void 0,{number:!0}]])]),e("div",mr,[s[17]||(s[17]=e("label",{for:"settingsBoxExpandRight"},"右侧扩展 (%):",-1)),ie(e("input",{type:"number",id:"settingsBoxExpandRight","onUpdate:modelValue":s[5]||(s[5]=_=>o.boxExpandRight=_),min:"0",max:"50",step:"1"},null,512),[[Ae,o.boxExpandRight,void 0,{number:!0}]])])])]),ie(e("div",fr,[s[25]||(s[25]=e("div",{class:"settings-group-title"},"精确文字掩膜",-1)),e("div",hr,[e("label",yr,[ie(e("input",{type:"checkbox","onUpdate:modelValue":s[6]||(s[6]=_=>o.usePreciseMask=_)},null,512),[[tt,o.usePreciseMask]]),s[19]||(s[19]=Ne(" 启用精确文字掩膜 ",-1))]),s[20]||(s[20]=e("div",{class:"input-hint"},"使用更精确的文字区域掩膜进行修复",-1))]),ie(e("div",xr,[e("div",Sr,[s[21]||(s[21]=e("label",{for:"settingsMaskDilateSize"},"膨胀大小:",-1)),ie(e("input",{type:"number",id:"settingsMaskDilateSize","onUpdate:modelValue":s[7]||(s[7]=_=>o.maskDilateSize=_),min:"0",step:"1"},null,512),[[Ae,o.maskDilateSize,void 0,{number:!0}]]),s[22]||(s[22]=e("div",{class:"input-hint"},"掩膜膨胀像素数",-1))]),e("div",kr,[s[23]||(s[23]=e("label",{for:"settingsMaskBoxExpandRatio"},"标注框扩大比例 (%):",-1)),ie(e("input",{type:"number",id:"settingsMaskBoxExpandRatio","onUpdate:modelValue":s[8]||(s[8]=_=>o.maskBoxExpandRatio=_),min:"0",max:"100",step:"1"},null,512),[[Ae,o.maskBoxExpandRatio,void 0,{number:!0}]]),s[24]||(s[24]=e("div",{class:"input-hint"},"标注框区域扩大百分比",-1))])],512),[[Ke,o.usePreciseMask]])],512),[[Ke,a.value]]),e("div",_r,[s[28]||(s[28]=e("div",{class:"settings-group-title"},"调试选项",-1)),e("div",Cr,[e("label",wr,[ie(e("input",{type:"checkbox","onUpdate:modelValue":s[9]||(s[9]=_=>o.showDetectionDebug=_)},null,512),[[tt,o.showDetectionDebug]]),s[26]||(s[26]=Ne(" 显示检测框调试信息 ",-1))]),s[27]||(s[27]=e("div",{class:"input-hint"},"在翻译结果中显示气泡检测框，用于调试",-1))])])]))}}),Tr=je($r,[["__scopeId","data-v-c12c43ee"]]),Ir={class:"hq-translation-settings"},Dr={class:"settings-group"},Rr={class:"settings-row"},Mr={class:"settings-item"},Br={class:"settings-item"},Er={class:"password-input-wrapper"},Pr=["type"],Ar={key:0,class:"eye-icon"},Fr={key:1,class:"eye-off-icon"},Lr={class:"settings-item"},Ur={class:"settings-item"},Or={class:"model-input-with-fetch"},zr=["disabled"],Vr={class:"fetch-text"},Nr={key:0,class:"model-select-container"},Wr={class:"model-count"},Kr={class:"settings-item"},qr=["disabled"],Hr={class:"settings-group"},Jr={class:"settings-row"},Yr={class:"settings-item"},Xr={class:"settings-item"},jr={class:"settings-row"},Gr={class:"settings-item"},Zr={class:"settings-item"},Qr={class:"settings-group"},eu={class:"settings-row"},tu={class:"settings-item"},nu={class:"checkbox-label"},ou={class:"settings-item"},au={class:"settings-row"},su={class:"settings-item"},lu={class:"checkbox-label"},iu={class:"settings-item"},ru={class:"checkbox-label"},uu={class:"settings-group"},cu={class:"settings-item"},du=Ge({__name:"HqTranslationSettings",setup(n){const r=[{label:"SiliconFlow",value:"siliconflow"},{label:"DeepSeek",value:"deepseek"},{label:"火山引擎",value:"volcano"},{label:"Google Gemini",value:"gemini"},{label:"自定义 OpenAI 兼容服务",value:"custom_openai"}],u=[{label:"Gemini风格 (reasoning_effort=low)",value:"gemini"},{label:"火山引擎风格 (thinking=null)",value:"volcano"}],o=Qe(),a=dt(),i=te(()=>o.settings.hqTranslation),t=h({apiKey:o.settings.hqTranslation.apiKey,modelName:o.settings.hqTranslation.modelName,customBaseUrl:o.settings.hqTranslation.customBaseUrl,batchSize:o.settings.hqTranslation.batchSize,sessionReset:o.settings.hqTranslation.sessionReset,rpmLimit:o.settings.hqTranslation.rpmLimit,maxRetries:o.settings.hqTranslation.maxRetries,lowReasoning:o.settings.hqTranslation.lowReasoning,noThinkingMethod:o.settings.hqTranslation.noThinkingMethod,forceJsonOutput:o.settings.hqTranslation.forceJsonOutput,useStream:o.settings.hqTranslation.useStream,prompt:o.settings.hqTranslation.prompt});Be(()=>t.value.apiKey,d=>{o.updateHqTranslation({apiKey:d})}),Be(()=>t.value.modelName,d=>{o.updateHqTranslation({modelName:d})}),Be(()=>t.value.customBaseUrl,d=>{o.updateHqTranslation({customBaseUrl:d})}),Be(()=>t.value.batchSize,d=>{o.updateHqTranslation({batchSize:d})}),Be(()=>t.value.sessionReset,d=>{o.updateHqTranslation({sessionReset:d})}),Be(()=>t.value.rpmLimit,d=>{o.updateHqTranslation({rpmLimit:d})}),Be(()=>t.value.maxRetries,d=>{o.updateHqTranslation({maxRetries:d})}),Be(()=>t.value.lowReasoning,d=>{o.updateHqTranslation({lowReasoning:d})}),Be(()=>t.value.noThinkingMethod,d=>{o.updateHqTranslation({noThinkingMethod:d})}),Be(()=>t.value.forceJsonOutput,d=>{o.updateHqTranslation({forceJsonOutput:d})}),Be(()=>t.value.useStream,d=>{o.updateHqTranslation({useStream:d})}),Be(()=>t.value.prompt,d=>{o.updateHqTranslation({prompt:d})});const s=h(!1),_=h(!1),E=h([]),T=h(!1),N=te(()=>{const d=[{label:"-- 选择模型 --",value:""}];return E.value.forEach(l=>d.push({label:l,value:l})),d});function oe(d){o.setHqProvider(d),E.value=[],ne()}function ne(){const d=o.settings.hqTranslation;t.value.apiKey=d.apiKey,t.value.modelName=d.modelName,t.value.customBaseUrl=d.customBaseUrl,t.value.batchSize=d.batchSize,t.value.sessionReset=d.sessionReset,t.value.rpmLimit=d.rpmLimit,t.value.maxRetries=d.maxRetries,t.value.lowReasoning=d.lowReasoning,t.value.noThinkingMethod=d.noThinkingMethod,t.value.forceJsonOutput=d.forceJsonOutput,t.value.useStream=d.useStream,t.value.prompt=d.prompt}function G(d){return{siliconflow:"SiliconFlow",deepseek:"DeepSeek",volcano:"火山引擎",gemini:"Google Gemini",custom_openai:"自定义OpenAI"}[d]||d}async function $(){const d=i.value.provider,l=t.value.apiKey?.trim(),C=t.value.customBaseUrl?.trim();if(!l){a.warning("请先填写 API Key");return}if(!["siliconflow","deepseek","volcano","gemini","custom_openai"].includes(d)){a.warning(`${G(d)} 不支持自动获取模型列表`);return}if(d==="custom_openai"&&!C){a.warning("自定义服务需要先填写 Base URL");return}_.value=!0;try{const O=await qe.fetchModels(d,l,C);O.success&&O.models&&O.models.length>0?(E.value=O.models.map(Q=>Q.id),a.success(`获取到 ${O.models.length} 个模型`)):a.warning(O.message||"未获取到可用模型")}catch(O){const Q=O instanceof Error?O.message:"获取模型列表失败";a.error(Q)}finally{_.value=!1}}async function Z(){const d=i.value.provider,l=t.value.apiKey?.trim(),C=t.value.modelName?.trim(),x=t.value.customBaseUrl?.trim();if(!l){a.warning("请先填写 API Key");return}if(!C){a.warning("请填写模型名称");return}if(d==="custom_openai"&&!x){a.warning("自定义服务需要填写 Base URL");return}T.value=!0,a.info("正在测试连接...");try{const O=await qe.testAiTranslateConnection({provider:d,apiKey:l,modelName:C,baseUrl:x});O.success?a.success(O.message||`${G(d)} 连接成功!`):a.error(O.message||O.error||"连接失败")}catch(O){const Q=O instanceof Error?O.message:"连接测试失败";a.error(Q)}finally{T.value=!1}}function X(){o.updateHqTranslation({prompt:Mn}),t.value.prompt=Mn,a.success("已重置为默认提示词")}function q(d,l){o.updateHqTranslation({prompt:d}),t.value.prompt=d,a.success(`已应用提示词: ${l}`)}return(d,l)=>(V(),J("div",Ir,[e("div",Dr,[l[20]||(l[20]=e("div",{class:"settings-group-title"},"高质量翻译服务配置",-1)),e("div",Rr,[e("div",Mr,[l[15]||(l[15]=e("label",{for:"settingsHqTranslateProvider"},"服务商:",-1)),Re(We,{"model-value":i.value.provider,options:r,onChange:l[0]||(l[0]=C=>oe(C))},null,8,["model-value"])]),e("div",Br,[l[16]||(l[16]=e("label",{for:"settingsHqApiKey"},"API Key:",-1)),e("div",Er,[ie(e("input",{type:s.value?"text":"password",id:"settingsHqApiKey","onUpdate:modelValue":l[1]||(l[1]=C=>t.value.apiKey=C),class:"secure-input",placeholder:"请输入API Key",autocomplete:"off"},null,8,Pr),[[kt,t.value.apiKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:l[2]||(l[2]=C=>s.value=!s.value)},[s.value?(V(),J("span",Fr,"👁‍🗨")):(V(),J("span",Ar,"👁"))])])])]),ie(e("div",Lr,[l[17]||(l[17]=e("label",{for:"settingsHqCustomBaseUrl"},"Base URL:",-1)),ie(e("input",{type:"text",id:"settingsHqCustomBaseUrl","onUpdate:modelValue":l[3]||(l[3]=C=>t.value.customBaseUrl=C),placeholder:"例如: https://api.example.com/v1"},null,512),[[Ae,t.value.customBaseUrl]])],512),[[Ke,i.value.provider==="custom_openai"]]),e("div",Ur,[l[19]||(l[19]=e("label",{for:"settingsHqModelName"},"模型名称:",-1)),e("div",Or,[ie(e("input",{type:"text",id:"settingsHqModelName","onUpdate:modelValue":l[4]||(l[4]=C=>t.value.modelName=C),placeholder:"请输入模型名称"},null,512),[[Ae,t.value.modelName]]),e("button",{type:"button",class:"fetch-models-btn",title:"获取可用模型列表",onClick:$,disabled:_.value},[l[18]||(l[18]=e("span",{class:"fetch-icon"},"🔍",-1)),e("span",Vr,ye(_.value?"获取中...":"获取模型"),1)],8,zr)]),E.value.length>0?(V(),J("div",Nr,[Re(We,{modelValue:t.value.modelName,"onUpdate:modelValue":l[5]||(l[5]=C=>t.value.modelName=C),options:N.value},null,8,["modelValue","options"]),e("span",Wr,"共 "+ye(E.value.length)+" 个模型",1)])):Me("",!0)]),e("div",Kr,[e("button",{class:"settings-test-btn",onClick:Z,disabled:T.value},ye(T.value?"测试中...":"🔗 测试连接"),9,qr)])]),e("div",Hr,[l[28]||(l[28]=e("div",{class:"settings-group-title"},"批处理设置",-1)),e("div",Jr,[e("div",Yr,[l[21]||(l[21]=e("label",{for:"settingsHqBatchSize"},"批次大小:",-1)),ie(e("input",{type:"number",id:"settingsHqBatchSize","onUpdate:modelValue":l[6]||(l[6]=C=>t.value.batchSize=C),min:"1",max:"10",step:"1"},null,512),[[Ae,t.value.batchSize,void 0,{number:!0}]]),l[22]||(l[22]=e("div",{class:"input-hint"},"每批处理的图片数量 (推荐3-5张)",-1))]),e("div",Xr,[l[23]||(l[23]=e("label",{for:"settingsHqSessionReset"},"会话重置频率:",-1)),ie(e("input",{type:"number",id:"settingsHqSessionReset","onUpdate:modelValue":l[7]||(l[7]=C=>t.value.sessionReset=C),min:"1",step:"1"},null,512),[[Ae,t.value.sessionReset,void 0,{number:!0}]]),l[24]||(l[24]=e("div",{class:"input-hint"},"多少批次后重置上下文",-1))])]),e("div",jr,[e("div",Gr,[l[25]||(l[25]=e("label",{for:"settingsHqRpmLimit"},"RPM限制:",-1)),ie(e("input",{type:"number",id:"settingsHqRpmLimit","onUpdate:modelValue":l[8]||(l[8]=C=>t.value.rpmLimit=C),min:"0",step:"1"},null,512),[[Ae,t.value.rpmLimit,void 0,{number:!0}]]),l[26]||(l[26]=e("div",{class:"input-hint"},"每分钟请求数，0表示无限制",-1))]),e("div",Zr,[l[27]||(l[27]=e("label",{for:"settingsHqMaxRetries"},"重试次数:",-1)),ie(e("input",{type:"number",id:"settingsHqMaxRetries","onUpdate:modelValue":l[9]||(l[9]=C=>t.value.maxRetries=C),min:"0",max:"10",step:"1"},null,512),[[Ae,t.value.maxRetries,void 0,{number:!0}]])])])]),e("div",Qr,[l[36]||(l[36]=e("div",{class:"settings-group-title"},"高级选项",-1)),e("div",eu,[e("div",tu,[e("label",nu,[ie(e("input",{type:"checkbox","onUpdate:modelValue":l[10]||(l[10]=C=>t.value.lowReasoning=C)},null,512),[[tt,t.value.lowReasoning]]),l[29]||(l[29]=Ne(" 低推理模式 ",-1))]),l[30]||(l[30]=e("div",{class:"input-hint"},"减少模型推理深度，提高速度",-1))]),e("div",ou,[l[31]||(l[31]=e("label",{for:"settingsHqNoThinkingMethod"},"取消思考方法:",-1)),Re(We,{modelValue:t.value.noThinkingMethod,"onUpdate:modelValue":l[11]||(l[11]=C=>t.value.noThinkingMethod=C),options:u},null,8,["modelValue"])])]),e("div",au,[e("div",su,[e("label",lu,[ie(e("input",{type:"checkbox","onUpdate:modelValue":l[12]||(l[12]=C=>t.value.forceJsonOutput=C)},null,512),[[tt,t.value.forceJsonOutput]]),l[32]||(l[32]=Ne(" 强制JSON输出 ",-1))]),l[33]||(l[33]=e("div",{class:"input-hint"},"使用 response_format: json_object",-1))]),e("div",iu,[e("label",ru,[ie(e("input",{type:"checkbox","onUpdate:modelValue":l[13]||(l[13]=C=>t.value.useStream=C)},null,512),[[tt,t.value.useStream]]),l[34]||(l[34]=Ne(" 流式调用 ",-1))]),l[35]||(l[35]=e("div",{class:"input-hint"},"使用流式API调用",-1))])])]),e("div",uu,[l[37]||(l[37]=e("div",{class:"settings-group-title"},"高质量翻译提示词",-1)),e("div",cu,[ie(e("textarea",{id:"settingsHqPrompt","onUpdate:modelValue":l[14]||(l[14]=C=>t.value.prompt=C),rows:"6",placeholder:"高质量翻译提示词"},null,512),[[Ae,t.value.prompt]]),Re(Tt,{"prompt-type":"hq_translate",onSelect:q}),e("button",{class:"btn btn-secondary btn-sm",onClick:X},"重置为默认")])])]))}}),gu=je(du,[["__scopeId","data-v-23f4a3f7"]]),bu={class:"proofreading-settings"},pu={class:"settings-group"},vu={class:"settings-item"},mu={class:"checkbox-label"},fu={class:"settings-item"},hu={class:"settings-group"},yu={class:"round-header"},xu={class:"round-title"},Su=["onClick","disabled"],ku={class:"round-content"},_u={class:"settings-item"},Cu=["onUpdate:modelValue"],wu={class:"settings-row"},$u={class:"settings-item"},Tu={class:"settings-item"},Iu={class:"password-input-wrapper"},Du=["type","onUpdate:modelValue"],Ru=["onClick"],Mu={key:0,class:"eye-icon"},Bu={key:1,class:"eye-off-icon"},Eu={class:"settings-item"},Pu=["onUpdate:modelValue"],Au={class:"settings-item"},Fu={class:"model-input-with-fetch"},Lu=["onUpdate:modelValue"],Uu=["onClick","disabled"],Ou={class:"fetch-text"},zu={key:0,class:"model-select-container"},Vu={class:"model-count"},Nu={class:"settings-item"},Wu=["onClick","disabled"],Ku={class:"settings-row"},qu={class:"settings-item"},Hu=["onUpdate:modelValue"],Ju={class:"settings-item"},Yu=["onUpdate:modelValue"],Xu={class:"settings-item"},ju=["onUpdate:modelValue"],Gu={class:"settings-row"},Zu={class:"settings-item"},Qu={class:"checkbox-label"},ec=["onUpdate:modelValue"],tc={class:"settings-item"},nc={class:"settings-item"},oc={class:"checkbox-label"},ac=["onUpdate:modelValue"],sc={class:"settings-item"},lc=["onUpdate:modelValue"],ic=["onClick"],rc=Ge({__name:"ProofreadingSettings",setup(n){const r=[{label:"SiliconFlow",value:"siliconflow"},{label:"DeepSeek",value:"deepseek"},{label:"火山引擎",value:"volcano"},{label:"Google Gemini",value:"gemini"},{label:"自定义 OpenAI 兼容服务",value:"custom_openai"}],u=[{label:"Gemini风格",value:"gemini"},{label:"火山引擎风格",value:"volcano"}],o=Qe(),a=dt(),i=h({}),t=h({}),s=h({}),_=te(()=>o.settings.proofreading.rounds),E=te({get:()=>o.settings.proofreading.maxRetries,set:q=>o.setProofreadingMaxRetries(q)}),T=te({get:()=>o.settings.proofreading.enabled,set:q=>o.setProofreadingEnabled(q)});Be(()=>o.settings.proofreading.rounds,()=>{o.saveToStorage()},{deep:!0});function N(q){const d=s.value[q]||[],l=[{label:"-- 选择模型 --",value:""}];return d.forEach(C=>l.push({label:C,value:C})),l}async function oe(q){const d=_.value[q];if(!d)return;const l=d.provider,C=d.apiKey?.trim(),x=d.customBaseUrl?.trim();if(!C){a.warning("请先填写 API Key");return}if(!["siliconflow","deepseek","volcano","gemini","custom_openai"].includes(l)){a.warning("当前服务商不支持获取模型列表");return}i.value[q]=!0;try{const Q=await qe.fetchModels(l,C,x);Q.success&&Q.models&&Q.models.length>0?(s.value[q]=Q.models.map(ge=>ge.id),a.success(`轮次 ${q+1}: 获取到 ${Q.models.length} 个模型`)):a.warning(Q.message||"未获取到可用模型")}catch(Q){const ge=Q instanceof Error?Q.message:"获取模型列表失败";a.error(ge)}finally{i.value[q]=!1}}async function ne(q){const d=_.value[q];if(!d)return;const l=d.provider,C=d.apiKey?.trim(),x=d.modelName?.trim(),O=d.customBaseUrl?.trim();if(!C){a.warning("请先填写 API Key");return}if(!x){a.warning("请填写模型名称");return}t.value[q]=!0,a.info(`正在测试轮次 ${q+1} 的连接...`);try{const Q=await qe.testAiTranslateConnection({provider:l,apiKey:C,modelName:x,baseUrl:O});Q.success?a.success(Q.message||"连接成功!"):a.error(Q.message||Q.error||"连接失败")}catch(Q){const ge=Q instanceof Error?Q.message:"连接测试失败";a.error(ge)}finally{t.value[q]=!1}}function G(){const q={name:`第${_.value.length+1}轮校对`,provider:"siliconflow",apiKey:"",modelName:"",customBaseUrl:"",batchSize:3,sessionReset:20,rpmLimit:7,lowReasoning:!1,noThinkingMethod:"gemini",forceJsonOutput:!0,prompt:Bn,showApiKey:!1};o.addProofreadingRound(q),a.success("已添加新的校对轮次")}function $(q){if(_.value.length<=1){a.warning("至少需要保留一个校对轮次");return}o.removeProofreadingRound(q),a.success("已删除校对轮次")}function Z(q){o.updateProofreadingRound(q,{prompt:Bn}),a.success("已重置为默认提示词")}function X(q,d,l){o.updateProofreadingRound(q,{prompt:d}),a.success(`已应用提示词: ${l}`)}return(q,d)=>(V(),J("div",bu,[e("div",pu,[d[5]||(d[5]=e("div",{class:"settings-group-title"},"AI校对设置",-1)),e("div",vu,[e("label",mu,[ie(e("input",{type:"checkbox","onUpdate:modelValue":d[0]||(d[0]=l=>T.value=l)},null,512),[[tt,T.value]]),d[2]||(d[2]=Ne(" 启用AI校对 ",-1))]),d[3]||(d[3]=e("div",{class:"input-hint"},"翻译完成后自动进行AI校对",-1))]),e("div",fu,[d[4]||(d[4]=e("label",{for:"settingsProofreadingMaxRetries"},"全局重试次数:",-1)),ie(e("input",{type:"number",id:"settingsProofreadingMaxRetries","onUpdate:modelValue":d[1]||(d[1]=l=>E.value=l),min:"0",max:"10",step:"1"},null,512),[[Ae,E.value,void 0,{number:!0}]])])]),ie(e("div",hu,[e("div",{class:"settings-group-title"},[d[6]||(d[6]=Ne(" 校对轮次配置 ",-1)),e("button",{class:"btn btn-secondary btn-sm",onClick:G},"+ 添加轮次")]),(V(!0),J(Ze,null,et(_.value,(l,C)=>(V(),J("div",{key:C,class:"proofreading-round"},[e("div",yu,[e("span",xu,"轮次 "+ye(C+1)+": "+ye(l.name||"未命名"),1),e("button",{class:"btn btn-danger btn-sm",onClick:x=>$(C),disabled:_.value.length<=1}," 删除 ",8,Su)]),e("div",ku,[e("div",_u,[d[7]||(d[7]=e("label",null,"轮次名称:",-1)),ie(e("input",{type:"text","onUpdate:modelValue":x=>l.name=x,placeholder:"如: 第一轮校对"},null,8,Cu),[[Ae,l.name]])]),e("div",wu,[e("div",$u,[d[8]||(d[8]=e("label",null,"服务商:",-1)),Re(We,{modelValue:l.provider,"onUpdate:modelValue":x=>l.provider=x,options:r},null,8,["modelValue","onUpdate:modelValue"])]),e("div",Tu,[d[9]||(d[9]=e("label",null,"API Key:",-1)),e("div",Iu,[ie(e("input",{type:l.showApiKey?"text":"password","onUpdate:modelValue":x=>l.apiKey=x,class:"secure-input",placeholder:"请输入API Key",autocomplete:"off"},null,8,Du),[[kt,l.apiKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:x=>l.showApiKey=!l.showApiKey},[l.showApiKey?(V(),J("span",Bu,"👁‍🗨")):(V(),J("span",Mu,"👁"))],8,Ru)])])]),ie(e("div",Eu,[d[10]||(d[10]=e("label",null,"Base URL:",-1)),ie(e("input",{type:"text","onUpdate:modelValue":x=>l.customBaseUrl=x,placeholder:"例如: https://api.example.com/v1"},null,8,Pu),[[Ae,l.customBaseUrl]])],512),[[Ke,l.provider==="custom_openai"]]),e("div",Au,[d[12]||(d[12]=e("label",null,"模型名称:",-1)),e("div",Fu,[ie(e("input",{type:"text","onUpdate:modelValue":x=>l.modelName=x,placeholder:"请输入模型名称"},null,8,Lu),[[Ae,l.modelName]]),e("button",{type:"button",class:"fetch-models-btn",title:"获取可用模型列表",onClick:x=>oe(C),disabled:i.value[C]},[d[11]||(d[11]=e("span",{class:"fetch-icon"},"🔍",-1)),e("span",Ou,ye(i.value[C]?"获取中...":"获取模型"),1)],8,Uu)]),s.value[C]&&s.value[C].length>0?(V(),J("div",zu,[Re(We,{modelValue:l.modelName,"onUpdate:modelValue":x=>l.modelName=x,options:N(C)},null,8,["modelValue","onUpdate:modelValue","options"]),e("span",Vu,"共 "+ye(s.value[C].length)+" 个模型",1)])):Me("",!0)]),e("div",Nu,[e("button",{class:"settings-test-btn",onClick:x=>ne(C),disabled:t.value[C]},ye(t.value[C]?"测试中...":"🔗 测试连接"),9,Wu)]),e("div",Ku,[e("div",qu,[d[13]||(d[13]=e("label",null,"批次大小:",-1)),ie(e("input",{type:"number","onUpdate:modelValue":x=>l.batchSize=x,min:"1",max:"10",step:"1"},null,8,Hu),[[Ae,l.batchSize,void 0,{number:!0}]])]),e("div",Ju,[d[14]||(d[14]=e("label",null,"会话重置频率:",-1)),ie(e("input",{type:"number","onUpdate:modelValue":x=>l.sessionReset=x,min:"1",step:"1"},null,8,Yu),[[Ae,l.sessionReset,void 0,{number:!0}]])]),e("div",Xu,[d[15]||(d[15]=e("label",null,"RPM限制:",-1)),ie(e("input",{type:"number","onUpdate:modelValue":x=>l.rpmLimit=x,min:"0",step:"1"},null,8,ju),[[Ae,l.rpmLimit,void 0,{number:!0}]])])]),e("div",Gu,[e("div",Zu,[e("label",Qu,[ie(e("input",{type:"checkbox","onUpdate:modelValue":x=>l.lowReasoning=x},null,8,ec),[[tt,l.lowReasoning]]),d[16]||(d[16]=Ne(" 低推理模式 ",-1))])]),e("div",tc,[d[17]||(d[17]=e("label",null,"取消思考方法:",-1)),Re(We,{modelValue:l.noThinkingMethod,"onUpdate:modelValue":x=>l.noThinkingMethod=x,options:u},null,8,["modelValue","onUpdate:modelValue"])]),e("div",nc,[e("label",oc,[ie(e("input",{type:"checkbox","onUpdate:modelValue":x=>l.forceJsonOutput=x},null,8,ac),[[tt,l.forceJsonOutput]]),d[18]||(d[18]=Ne(" 强制JSON输出 ",-1))])])]),e("div",sc,[d[19]||(d[19]=e("label",null,"校对提示词:",-1)),ie(e("textarea",{"onUpdate:modelValue":x=>l.prompt=x,rows:"4",placeholder:"校对提示词"},null,8,lc),[[Ae,l.prompt]]),Re(Tt,{"prompt-type":"proofreading",onSelect:(x,O)=>X(C,x,O)},null,8,["onSelect"]),e("button",{class:"btn btn-secondary btn-sm",onClick:x=>Z(C)},"重置为默认",8,ic)])])]))),128))],512),[[Ke,T.value]])]))}}),uc=je(rc,[["__scopeId","data-v-663a7972"]]),cc={class:"prompt-library"},dc={class:"settings-group"},gc={class:"settings-item"},bc={key:0,class:"settings-item"},pc={class:"mode-hint"},vc={class:"settings-group"},mc={key:0,class:"loading-hint"},fc={key:1,class:"empty-hint"},hc={key:2,class:"prompt-list"},yc=["onClick"],xc={class:"prompt-name"},Sc={class:"prompt-actions"},kc=["onClick"],_c=["onClick","disabled"],Cc={class:"settings-group"},wc={class:"settings-item"},$c={class:"settings-item"},Tc={class:"prompt-editor-actions"},Ic=["disabled"],Dc=Ge({__name:"PromptLibrary",setup(n){const r=[{label:"翻译提示词",value:"translate"},{label:"文本框提示词",value:"textbox"},{label:"AI视觉OCR提示词",value:"ai_vision_ocr"},{label:"高质量翻译提示词",value:"hq_translate"},{label:"校对提示词",value:"proofreading"}],u=[{label:"普通模式",value:"false"},{label:"JSON格式模式",value:"true"}],o=dt(),a=Qe(),i=h("translate"),t=h([]),s=h(""),_=h(""),E=h(""),T=h(!1),N=h(!1),oe=te(()=>i.value==="translate"||i.value==="ai_vision_ocr"),ne=te(()=>N.value?"适用于需要结构化输出的场景":"适用于普通翻译场景");async function G(){T.value=!0;try{let C;i.value==="textbox"?C=await qe.getTextboxPrompts():C=await qe.getPrompts(i.value);const x=C.prompt_names||[];t.value=x.map(O=>({name:O}))}catch(C){const x=C instanceof Error?C.message:"加载提示词列表失败";o.error(x)}finally{T.value=!1}}async function $(C){s.value=C,_.value=C,await Z(C)}async function Z(C){try{let x;i.value==="textbox"?x=await qe.getTextboxPromptContent(C):x=await qe.getPromptContent(i.value,C),_.value=C,E.value=x.prompt_content||"",s.value=C,o.success("已加载提示词")}catch(x){const O=x instanceof Error?x.message:"加载提示词内容失败";o.error(O)}}async function X(){if(!_.value||!E.value){o.warning("请输入提示词名称和内容");return}try{i.value==="textbox"?await qe.saveTextboxPrompt(_.value,E.value):await qe.savePrompt(i.value,_.value,E.value),o.success("提示词保存成功"),_.value="",E.value="",await G()}catch(C){const x=C instanceof Error?C.message:"保存提示词失败";o.error(x)}}async function q(C){if(C==="default"){o.warning("默认提示词不能删除");return}try{i.value==="textbox"?await qe.deleteTextboxPrompt(C):await qe.deletePrompt(i.value,C),o.success("提示词删除成功"),s.value===C&&(s.value="",_.value="",E.value=""),await G()}catch(x){const O=x instanceof Error?x.message:"删除提示词失败";o.error(O)}}function d(){s.value="",_.value="",E.value="",i.value==="translate"?N.value=a.settings.translation.isJsonMode:i.value==="ai_vision_ocr"?N.value=a.settings.aiVisionOcr.isJsonMode:N.value=!1,G()}function l(){i.value==="translate"?a.updateTranslationService({isJsonMode:N.value}):i.value==="ai_vision_ocr"&&a.updateAiVisionOcr({isJsonMode:N.value}),o.info(`已切换到${N.value?"JSON格式":"普通"}模式`)}return ut(()=>{N.value=a.settings.translation.isJsonMode,G()}),(C,x)=>(V(),J("div",cc,[e("div",dc,[x[6]||(x[6]=e("div",{class:"settings-group-title"},"提示词管理",-1)),e("div",gc,[x[4]||(x[4]=e("label",{for:"promptType"},"提示词类型:",-1)),Re(We,{modelValue:i.value,"onUpdate:modelValue":x[0]||(x[0]=O=>i.value=O),options:r,onChange:d},null,8,["modelValue"])]),oe.value?(V(),J("div",bc,[x[5]||(x[5]=e("label",{for:"promptMode"},"提示词模式:",-1)),Re(We,{"model-value":N.value?"true":"false",options:u,onChange:x[1]||(x[1]=O=>{N.value=O==="true",l()})},null,8,["model-value"]),e("span",pc,ye(ne.value),1)])):Me("",!0)]),e("div",vc,[x[7]||(x[7]=e("div",{class:"settings-group-title"},"已保存的提示词",-1)),T.value?(V(),J("div",mc,"加载中...")):t.value.length===0?(V(),J("div",fc,"暂无保存的提示词")):(V(),J("div",hc,[(V(!0),J(Ze,null,et(t.value,O=>(V(),J("div",{key:O.name,class:Le(["prompt-item",{active:s.value===O.name}]),onClick:Q=>$(O.name)},[e("span",xc,ye(O.name),1),e("div",Sc,[e("button",{class:"btn btn-sm",onClick:nt(Q=>Z(O.name),["stop"]),title:"加载到编辑器"},"📥",8,kc),e("button",{class:"btn btn-sm btn-danger",onClick:nt(Q=>q(O.name),["stop"]),title:"删除",disabled:O.name==="default"}," 🗑️ ",8,_c)])],10,yc))),128))]))]),e("div",Cc,[x[10]||(x[10]=e("div",{class:"settings-group-title"},"提示词编辑",-1)),e("div",wc,[x[8]||(x[8]=e("label",{for:"promptName"},"提示词名称:",-1)),ie(e("input",{type:"text",id:"promptName","onUpdate:modelValue":x[2]||(x[2]=O=>_.value=O),placeholder:"请输入提示词名称"},null,512),[[Ae,_.value]])]),e("div",$c,[x[9]||(x[9]=e("label",{for:"promptContent"},"提示词内容:",-1)),ie(e("textarea",{id:"promptContent","onUpdate:modelValue":x[3]||(x[3]=O=>E.value=O),rows:"8",placeholder:"请输入提示词内容"},null,512),[[Ae,E.value]])]),e("div",Tc,[e("button",{class:"btn btn-primary",onClick:X,disabled:!_.value||!E.value},"保存提示词",8,Ic)])])]))}}),Rc=je(Dc,[["__scopeId","data-v-70f0ec19"]]),Mc={class:"plugin-manager"},Bc={class:"settings-group"},Ec={key:0,class:"loading-hint"},Pc={key:1,class:"empty-hint"},Ac={key:2,class:"plugin-list"},Fc={class:"plugin-info"},Lc={class:"plugin-header"},Uc={class:"plugin-name"},Oc={class:"plugin-version"},zc={class:"plugin-description"},Vc={class:"plugin-controls"},Nc={class:"switch"},Wc=["checked","onChange"],Kc=["onClick"],qc=["onClick"],Hc={class:"settings-group"},Jc={class:"plugin-name"},Yc={class:"switch"},Xc=["checked","onChange"],jc={class:"plugin-config-content"},Gc={class:"plugin-config-header"},Zc={class:"plugin-config-body"},Qc=["for"],ed=["id","onUpdate:modelValue"],td=["id","onUpdate:modelValue","min","max"],nd=["id","onUpdate:modelValue","placeholder"],od={key:4,class:"field-description"},ad=Ge({__name:"PluginManager",setup(n){const r=dt(),u=h([]),o=h({}),a=h(!1),i=h(!1),t=h(null),s=h({}),_=h({});async function E(){a.value=!0;try{const X=await Zo();u.value=X.plugins||[]}catch(X){const q=X instanceof Error?X.message:"加载插件列表失败";r.error(q)}finally{a.value=!1}}async function T(){try{const X=await ia();o.value=X.states||{}}catch(X){console.error("加载默认状态失败:",X)}}async function N(X){try{X.enabled?(await ea(X.name),X.enabled=!1,r.success(`已禁用 ${X.display_name||X.name}`)):(await Qo(X.name),X.enabled=!0,r.success(`已启用 ${X.display_name||X.name}`))}catch(q){const d=q instanceof Error?q.message:"操作失败";r.error(d)}}async function oe(X,q){const d=q.target,l=d.checked;try{await ra(X,l),o.value[X]=l,r.success("默认状态已更新")}catch(C){const x=C instanceof Error?C.message:"设置失败";r.error(x),d.checked=!l}}async function ne(X){t.value=X;try{const q=await ua(X.name);s.value=q.schema||{};const d=await ca(X.name);_.value=d.config||{},i.value=!0}catch(q){const d=q instanceof Error?q.message:"加载配置失败";r.error(d)}}function G(){i.value=!1,t.value=null,s.value={},_.value={}}async function $(){if(t.value)try{await da(t.value.name,_.value),r.success("配置保存成功"),G()}catch(X){const q=X instanceof Error?X.message:"保存配置失败";r.error(q)}}async function Z(X){if(confirm(`确定要删除插件 "${X.display_name||X.name}" 吗？`))try{await ta(X.name),r.success("插件删除成功"),await E()}catch(q){const d=q instanceof Error?q.message:"删除插件失败";r.error(d)}}return ut(()=>{E(),T()}),(X,q)=>(V(),J("div",Mc,[e("div",Bc,[q[1]||(q[1]=e("div",{class:"settings-group-title"},"已安装插件",-1)),a.value?(V(),J("div",Ec,"加载中...")):u.value.length===0?(V(),J("div",Pc,"暂无已安装的插件")):(V(),J("div",Ac,[(V(!0),J(Ze,null,et(u.value,d=>(V(),J("div",{key:d.name,class:"plugin-item"},[e("div",Fc,[e("div",Lc,[e("span",Uc,ye(d.display_name||d.name),1),e("span",Oc,"v"+ye(d.version||"1.0.0"),1)]),e("p",zc,ye(d.description||"暂无描述"),1)]),e("div",Vc,[e("label",Nc,[e("input",{type:"checkbox",checked:d.enabled,onChange:l=>N(d)},null,40,Wc),q[0]||(q[0]=e("span",{class:"slider"},null,-1))]),d.has_config?(V(),J("button",{key:0,class:"btn btn-sm",onClick:l=>ne(d),title:"配置"},"⚙️",8,Kc)):Me("",!0),e("button",{class:"btn btn-sm btn-danger",onClick:l=>Z(d),title:"删除"},"🗑️",8,qc)])]))),128))]))]),e("div",Hc,[q[3]||(q[3]=e("div",{class:"settings-group-title"},"默认启用状态",-1)),q[4]||(q[4]=e("p",{class:"settings-hint"},"设置插件在新会话中的默认启用状态",-1)),(V(!0),J(Ze,null,et(u.value,d=>(V(),J("div",{key:"default-"+d.name,class:"default-state-item"},[e("span",Jc,ye(d.display_name||d.name),1),e("label",Yc,[e("input",{type:"checkbox",checked:o.value[d.name],onChange:l=>oe(d.name,l)},null,40,Xc),q[2]||(q[2]=e("span",{class:"slider"},null,-1))])]))),128))]),i.value?(V(),J("div",{key:0,class:"plugin-config-modal",onClick:nt(G,["self"])},[e("div",jc,[e("div",Gc,[e("h4",null,ye(t.value?.display_name||t.value?.name)+" 配置",1),e("span",{class:"close-btn",onClick:G},"×")]),e("div",Zc,[(V(!0),J(Ze,null,et(s.value,(d,l)=>(V(),J("div",{key:l,class:"config-field"},[e("label",{for:"config-"+l},ye(d.label||l)+":",9,Qc),d.type==="boolean"?ie((V(),J("input",{key:0,type:"checkbox",id:"config-"+l,"onUpdate:modelValue":C=>_.value[l]=C},null,8,ed)),[[tt,_.value[l]]]):d.type==="select"?(V(),rt(We,{key:1,"model-value":String(_.value[l]??""),options:d.options||[],onChange:C=>{_.value[l]=C}},null,8,["model-value","options","onChange"])):d.type==="number"?ie((V(),J("input",{key:2,type:"number",id:"config-"+l,"onUpdate:modelValue":C=>_.value[l]=C,min:d.min,max:d.max},null,8,td)),[[Ae,_.value[l],void 0,{number:!0}]]):ie((V(),J("input",{key:3,type:"text",id:"config-"+l,"onUpdate:modelValue":C=>_.value[l]=C,placeholder:d.placeholder},null,8,nd)),[[Ae,_.value[l]]]),d.description?(V(),J("p",od,ye(d.description),1)):Me("",!0)]))),128))]),e("div",{class:"plugin-config-footer"},[e("button",{class:"btn btn-secondary",onClick:G},"取消"),e("button",{class:"btn btn-primary",onClick:$},"保存")])])])):Me("",!0)]))}}),sd=je(ad,[["__scopeId","data-v-a62393a7"]]),ld={class:"more-settings"},id={class:"settings-group"},rd={class:"settings-item"},ud={class:"settings-group"},cd={class:"settings-item"},dd=["disabled"],gd={key:0,class:"font-count"},bd={class:"settings-item"},pd={class:"settings-group"},vd={class:"settings-row"},md={class:"settings-item"},fd=["disabled"],hd={class:"settings-item"},yd=["disabled"],xd=Ge({__name:"MoreSettings",setup(n){const r=[{label:"前端 pdf.js (推荐)",value:"frontend"},{label:"后端 PyMuPDF",value:"backend"}],u=Qe(),o=dt(),a=h(!1),i=h([]),t=h(!1),s=h(null),_=h({pdfProcessingMethod:u.settings.pdfProcessingMethod||"frontend"});Be(()=>_.value.pdfProcessingMethod,ne=>{u.setPdfProcessingMethod(ne)});async function E(){a.value=!0;try{const ne=await qe.getFontList();i.value=ne.fonts||[],o.success(`获取到 ${i.value.length} 个字体`)}catch(ne){const G=ne instanceof Error?ne.message:"获取字体列表失败";o.error(G)}finally{a.value=!1}}async function T(ne){const $=ne.target.files?.[0];if(!$)return;const Z=[".ttf",".ttc",".otf"],X=$.name.toLowerCase().slice($.name.lastIndexOf("."));if(!Z.includes(X)){o.error("不支持的字体格式，请上传 .ttf, .ttc 或 .otf 文件");return}try{const q=await qe.uploadFont($);q.success?(o.success(`字体 "${q.fontPath||$.name}" 上传成功`),await E()):o.error(q.error||"字体上传失败")}catch(q){const d=q instanceof Error?q.message:"字体上传失败";o.error(d)}finally{s.value&&(s.value.value="")}}async function N(){t.value=!0;try{const ne=await Yn();ne.success?o.success(`已清理 ${ne.deleted_count||0} 个调试文件`):o.error(ne.error||"清理失败")}catch(ne){const G=ne instanceof Error?ne.message:"清理失败";o.error(G)}finally{t.value=!1}}async function oe(){t.value=!0;try{const ne=await rn();ne.success?o.success(`已清理 ${ne.deleted_count||0} 个临时文件`):o.error(ne.error||"清理失败")}catch(ne){const G=ne instanceof Error?ne.message:"清理失败";o.error(G)}finally{t.value=!1}}return(ne,G)=>(V(),J("div",ld,[e("div",id,[G[3]||(G[3]=e("div",{class:"settings-group-title"},"PDF处理设置",-1)),e("div",rd,[G[1]||(G[1]=e("label",{for:"settingsPdfProcessingMethod"},"PDF处理方式:",-1)),Re(We,{modelValue:_.value.pdfProcessingMethod,"onUpdate:modelValue":G[0]||(G[0]=$=>_.value.pdfProcessingMethod=$),options:r},null,8,["modelValue"]),G[2]||(G[2]=e("div",{class:"input-hint"},"前端处理速度更快，后端处理兼容性更好",-1))])]),e("div",ud,[G[7]||(G[7]=e("div",{class:"settings-group-title"},"字体设置",-1)),e("div",cd,[G[4]||(G[4]=e("label",null,"系统字体列表:",-1)),e("button",{class:"btn btn-secondary",onClick:E,disabled:a.value},ye(a.value?"加载中...":"🔄 刷新字体列表"),9,dd),i.value.length>0?(V(),J("div",gd,"共 "+ye(i.value.length)+" 个字体",1)):Me("",!0)]),e("div",bd,[G[5]||(G[5]=e("label",null,"上传自定义字体:",-1)),e("input",{type:"file",accept:".ttf,.ttc,.otf",onChange:T,ref_key:"fontInput",ref:s},null,544),G[6]||(G[6]=e("div",{class:"input-hint"},"支持 .ttf, .ttc, .otf 格式",-1))])]),e("div",pd,[G[10]||(G[10]=e("div",{class:"settings-group-title"},"缓存清理",-1)),e("div",vd,[e("div",md,[e("button",{class:"btn btn-secondary",onClick:N,disabled:t.value},ye(t.value?"清理中...":"🗑️ 清理调试文件"),9,fd),G[8]||(G[8]=e("div",{class:"input-hint"},"清理调试过程中生成的临时文件",-1))]),e("div",hd,[e("button",{class:"btn btn-secondary",onClick:oe,disabled:t.value},ye(t.value?"清理中...":"🗑️ 清理临时文件"),9,yd),G[9]||(G[9]=e("div",{class:"input-hint"},"清理下载和处理过程中的临时文件",-1))])])]),G[11]||(G[11]=Qt('<div class="settings-group" data-v-136fb3b8><div class="settings-group-title" data-v-136fb3b8>关于</div><div class="about-info" data-v-136fb3b8><p data-v-136fb3b8><strong data-v-136fb3b8>Saber-Translator</strong></p><p data-v-136fb3b8>AI驱动的漫画翻译工具</p><p class="links" data-v-136fb3b8><a href="http://www.mashirosaber.top" target="_blank" data-v-136fb3b8>📖 使用教程</a><a href="https://github.com/MashiroSaber/saber-translator" target="_blank" data-v-136fb3b8>🐙 GitHub</a></p><p class="disclaimer" data-v-136fb3b8>本项目完全开源免费，请勿上当受骗</p></div></div>',1))]))}}),Sd=je(xd,[["__scopeId","data-v-136fb3b8"]]),kd={class:"settings-modal-content"},_d={class:"settings-tabs"},Cd=["onClick"],wd={class:"settings-tab-content"},$d={class:"settings-tab-pane active"},Td={class:"settings-tab-pane"},Id={class:"settings-tab-pane"},Dd={class:"settings-tab-pane"},Rd={class:"settings-tab-pane"},Md={class:"settings-tab-pane"},Bd={class:"settings-tab-pane"},Ed={class:"settings-tab-pane"},Pd=Ge({__name:"SettingsModal",props:{modelValue:{type:Boolean},initialTab:{}},emits:["update:modelValue","save"],setup(n,{emit:r}){const u=n,o=r,a=Qe(),i=h(u.modelValue),t=h("ocr"),s=[{id:"ocr",label:"OCR识别"},{id:"translate",label:"翻译服务"},{id:"detection",label:"检测设置"},{id:"hq",label:"高质量翻译"},{id:"proofreading",label:"AI校对"},{id:"prompt-library",label:"提示词管理"},{id:"plugins",label:"插件管理"},{id:"more",label:"更多"}];Be(()=>u.modelValue,N=>{i.value=N,N?(document.body.style.overflow="hidden",u.initialTab&&s.some(oe=>oe.id===u.initialTab)&&(t.value=u.initialTab)):(document.body.style.overflow="",t.value="ocr")});function _(){i.value=!1,o("update:modelValue",!1),document.body.style.overflow=""}async function E(){a.saveToStorage();try{await a.saveToBackend(),console.log("[SettingsModal] 设置已保存到后端")}catch(N){console.warn("[SettingsModal] 保存到后端失败，仅保存到 localStorage:",N)}o("save"),_()}function T(N){N.key==="Escape"&&i.value&&_()}return ut(()=>{document.addEventListener("keydown",T)}),It(()=>{document.removeEventListener("keydown",T),document.body.style.overflow=""}),(N,oe)=>i.value?(V(),J("div",{key:0,class:"settings-modal",onClick:nt(_,["self"])},[e("div",kd,[e("div",{class:"settings-modal-header"},[oe[0]||(oe[0]=e("h3",null,"⚙️ 设置",-1)),e("span",{class:"settings-modal-close",onClick:_},"×")]),e("div",_d,[(V(),J(Ze,null,et(s,ne=>e("button",{key:ne.id,class:Le(["settings-tab",{active:t.value===ne.id}]),onClick:G=>t.value=ne.id},ye(ne.label),11,Cd)),64))]),e("div",wd,[ie(e("div",$d,[Re(fi)],512),[[Ke,t.value==="ocr"]]),ie(e("div",Td,[Re(sr)],512),[[Ke,t.value==="translate"]]),ie(e("div",Id,[Re(Tr)],512),[[Ke,t.value==="detection"]]),ie(e("div",Dd,[Re(gu)],512),[[Ke,t.value==="hq"]]),ie(e("div",Rd,[Re(uc)],512),[[Ke,t.value==="proofreading"]]),ie(e("div",Md,[Re(Rc)],512),[[Ke,t.value==="prompt-library"]]),ie(e("div",Bd,[Re(sd)],512),[[Ke,t.value==="plugins"]]),ie(e("div",Ed,[Re(Sd)],512),[[Ke,t.value==="more"]])]),e("div",{class:"settings-modal-footer"},[e("button",{class:"btn btn-secondary",onClick:_},"取消"),e("button",{class:"btn btn-primary",onClick:E},"保存设置")])])])):Me("",!0)}}),Ad=je(Pd,[["__scopeId","data-v-e1ec20ab"]]),Fd={minScale:.1,maxScale:5,zoomSpeed:.1};function Kn(n={}){const r={...Fd,...n},u=h(1),o=h(0),a=h(0),i=h(!1),t=h(0),s=h(0),_=te(()=>({transform:`translate(${o.value}px, ${a.value}px) scale(${u.value})`}));function E(j,P,B){const k=Math.min(Math.max(u.value*B,r.minScale),r.maxScale),m=k/u.value;o.value=j-(j-o.value)*m,a.value=P-(P-a.value)*m,u.value=k,n.onScaleChange?.(u.value),n.onTransformChange?.(x())}function T(j,P=800,B=600){E(P/2,B/2,j)}function N(){T(1.2)}function oe(){T(.8)}function ne(j,P=800,B=600){const k=j/u.value;E(P/2,B/2,k)}function G(j,P){i.value=!0,t.value=j,s.value=P}function $(j,P){if(!i.value)return;const B=j-t.value,k=P-s.value;o.value+=B,a.value+=k,t.value=j,s.value=P,n.onTransformChange?.(x())}function Z(){i.value=!1}function X(j,P){o.value+=j,a.value+=P,n.onTransformChange?.(x())}function q(){u.value=1,o.value=0,a.value=0,n.onScaleChange?.(u.value),n.onTransformChange?.(x())}function d(){q()}function l(){u.value=1,o.value=0,a.value=0}function C(j,P,B,k){if(!j||!P)return;const m=B/j,D=k/P;u.value=Math.min(m,D)*.95,o.value=(B-j*u.value)/2,a.value=(k-P*u.value)/2,n.onScaleChange?.(u.value),n.onTransformChange?.(x())}function x(){return{scale:u.value,translateX:o.value,translateY:a.value}}function O(j){j.scale!==void 0&&(u.value=j.scale),j.translateX!==void 0&&(o.value=j.translateX),j.translateY!==void 0&&(a.value=j.translateY),n.onTransformChange?.(x())}function Q(j){u.value=j.scale,o.value=j.translateX,a.value=j.translateY}function ge(j,P,B){if(!j||j.length<4)return;const[k,m,D,I]=j,p=(k+D)/2,y=(m+I)/2,ee=P/2,se=B/2;o.value=ee-p*u.value,a.value=se-y*u.value,n.onTransformChange?.(x())}return{scale:u,translateX:o,translateY:a,isDragging:i,transformStyle:_,zoomAt:E,zoom:T,zoomIn:N,zoomOut:oe,setScale:ne,startDrag:G,drag:$,endDrag:Z,pan:X,reset:q,resetZoom:d,resetTransform:l,fitToScreen:C,getTransform:x,setTransform:O,syncWith:Q,scrollToBubble:ge}}function Ld(n){const r=st(),u=Qe(),o=h(null),a=h(Mo),i=h(!1),t=h(!1),s=h([]),_=h(0),E=h(0);let T=null,N=null,oe=null;const ne=te(()=>o.value!==null),G=te(()=>o.value==="repair"?{fill:"rgba(76, 175, 80, 0.4)",border:"#4CAF50"}:o.value==="restore"?{fill:"rgba(33, 150, 243, 0.4)",border:"#2196F3"}:{fill:"transparent",border:"transparent"});function $(y){o.value!==y&&(o.value=y,i.value=!0,s.value=[],console.log(`进入${y==="repair"?"修复":"还原"}笔刷模式，笔刷大小: ${a.value}px`))}function Z(){t.value&&O();const y=o.value!==null;o.value=null,i.value=!1,t.value=!1,s.value=[],P(),y&&console.log("退出笔刷模式")}function X(y){o.value===y?Z():$(y)}function q(y){a.value=Math.max(Pn,Math.min(En,y))}function d(y){q(a.value+y)}function l(y){if(!ne.value)return;y.preventDefault(),y.stopPropagation();const ee=y.deltaY>0?-5:5;d(ee)}function C(y,ee){if(!ne.value||y.button!==0)return;y.preventDefault(),y.stopPropagation(),t.value=!0,T=ee,s.value=[];const se=Q(y,ee);se&&(s.value.push(se),j(ee),B(se)),console.log("开始笔刷涂抹")}function x(y){if(_.value=y.clientX,E.value=y.clientY,!t.value||!ne.value)return;const ee=Q(y,T);ee&&(s.value.push(ee),B(ee))}function O(){if(!t.value)return;t.value=!1;const y=r.currentImage;if(!y||s.value.length===0){P(),s.value=[];return}const ee=ge();if(!ee){P(),s.value=[];return}const se=o.value;(async()=>{se==="restore"?await k(y,ee):se==="repair"&&await m(y,ee),n?.onBrushComplete?.()})(),P(),s.value=[]}function Q(y,ee){if(!ee)return null;const se=ee.querySelector(".image-canvas-wrapper"),f=se?.querySelector("img");if(!f||!f.naturalWidth)return null;const w=se.getBoundingClientRect(),c=window.getComputedStyle(se).transform;let F=1;c&&c!=="none"&&(F=new DOMMatrix(c).a);const ve=(y.clientX-w.left)/F,W=(y.clientY-w.top)/F,Y=f.naturalWidth,me=f.naturalHeight;return ve<0||W<0||ve>Y||W>me?null:{x:ve,y:W,scale:F}}function ge(){if(s.value.length===0)return null;const ee=s.value[0]?.scale||1,se=a.value/2/ee;let f=1/0,w=1/0,c=-1/0,F=-1/0;for(const ve of s.value)f=Math.min(f,ve.x-se),w=Math.min(w,ve.y-se),c=Math.max(c,ve.x+se),F=Math.max(F,ve.y+se);return{x1:Math.max(0,Math.floor(f)),y1:Math.max(0,Math.floor(w)),x2:Math.ceil(c),y2:Math.ceil(F),path:[...s.value],radius:se}}function j(y){P();const ee=y.querySelector(".image-canvas-wrapper"),se=ee?.querySelector("img");if(!se)return;const f=document.createElement("canvas");f.id="brushOverlayCanvas",f.width=se.naturalWidth,f.height=se.naturalHeight,f.style.cssText="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100;",ee.appendChild(f),N=f,oe=f.getContext("2d")}function P(){N&&N.parentNode&&N.parentNode.removeChild(N),N=null,oe=null}function B(y){if(!oe||!y)return;const ee=G.value.fill,se=a.value/2/(y.scale||1);oe.beginPath(),oe.arc(y.x,y.y,se,0,Math.PI*2),oe.fillStyle=ee,oe.fill()}async function k(y,ee){if(!y.originalDataURL)return;let se;return y.cleanImageData?se="data:image/png;base64,"+y.cleanImageData:se=y.originalDataURL,new Promise(f=>{const w=new Image,c=new Image;let F=0;const ve=()=>{if(F++,F<2)return;const W=document.createElement("canvas");W.width=w.naturalWidth,W.height=w.naturalHeight;const Y=W.getContext("2d");if(!Y){f();return}Y.drawImage(w,0,0);const me=document.createElement("canvas");me.width=W.width,me.height=W.height;const g=me.getContext("2d");if(!g){f();return}g.fillStyle="white";for(const M of ee.path)g.beginPath(),g.arc(M.x,M.y,ee.radius,0,Math.PI*2),g.fill();Y.globalCompositeOperation="destination-out",Y.drawImage(me,0,0),Y.globalCompositeOperation="destination-over",Y.drawImage(c,0,0),Y.globalCompositeOperation="source-over";const v=W.toDataURL("image/png").split(",")[1];r.updateCurrentImage({cleanImageData:v}),console.log("还原笔刷区域完成"),f()};w.onload=ve,w.onerror=()=>f(),c.onload=ve,c.onerror=()=>f(),w.src=se,c.src=y.originalDataURL})}async function m(y,ee){const se=n?.getCurrentRepairSettings?.()||{inpaintMethod:"solid",fillColor:"#FFFFFF"},f=se.inpaintMethod;f==="lama_mpe"||f==="litelama"?await D(y,ee,f):await I(y,ee,se.fillColor)}async function D(y,ee,se="lama_mpe"){let f,w;if(y.cleanImageData)f=y.cleanImageData,w="data:image/png;base64,"+y.cleanImageData;else if(y.originalDataURL)f=y.originalDataURL.split(",")[1],w=y.originalDataURL;else{console.error("无法获取基础图像用于 LAMA 修复");return}return new Promise(c=>{const F=new Image;F.onload=async()=>{const ve=F.naturalWidth,W=F.naturalHeight,Y=document.createElement("canvas");Y.width=ve,Y.height=W;const me=Y.getContext("2d");if(!me){console.error("无法创建掩膜画布上下文"),c();return}me.fillStyle="black",me.fillRect(0,0,ve,W),me.fillStyle="white";for(const U of ee.path)me.beginPath(),me.arc(U.x,U.y,ee.radius,0,Math.PI*2),me.fill();const v=Y.toDataURL("image/png").split(",")[1],M=[ee.x1,ee.y1,ee.x2,ee.y2],R=se==="litelama"?"litelama":"lama_mpe";try{Ie("LAMA 修复中...","info");const U=await cn(f,M,{method:"lama",lamaModel:R,maskData:v});if(U.success&&U.inpainted_image)r.updateCurrentImage({cleanImageData:U.inpainted_image}),console.log("修复笔刷区域完成（LAMA 修复，精确掩膜）"),Ie("LAMA 修复完成","success");else throw new Error(U.error||"LAMA 修复返回无效数据")}catch(U){console.error("LAMA 修复失败，回退到纯色填充:",U),Ie("LAMA 修复失败，使用纯色填充","warning");const le=n?.getCurrentRepairSettings?.();await I(y,ee,le?.fillColor)}c()},F.onerror=()=>{console.error("加载图像失败，无法进行 LAMA 修复"),c()},F.src=w})}async function I(y,ee,se){const f=se||u.settings.textStyle.fillColor||"#FFFFFF";let w;if(y.cleanImageData)w="data:image/png;base64,"+y.cleanImageData;else if(y.originalDataURL)w=y.originalDataURL;else return;return new Promise(c=>{const F=new Image;F.onload=()=>{const ve=document.createElement("canvas");ve.width=F.naturalWidth,ve.height=F.naturalHeight;const W=ve.getContext("2d");if(!W){c();return}W.drawImage(F,0,0),W.fillStyle=f;for(const me of ee.path)W.beginPath(),W.arc(me.x,me.y,ee.radius,0,Math.PI*2),W.fill();const Y=ve.toDataURL("image/png").split(",")[1];r.updateCurrentImage({cleanImageData:Y}),console.log("修复笔刷区域完成（纯色填充）"),c()},F.onerror=()=>c(),F.src=w})}async function p(){const y=r.currentImage;if(!y)return console.warn("ensureCleanBackground: 没有当前图片"),!1;if(y.cleanImageData)return console.log("ensureCleanBackground: 已有干净背景"),!0;const ee=n?.getCurrentRepairSettings?.();if((ee?.inpaintMethod||u.settings.textStyle.inpaintMethod)!=="solid")return console.log("ensureCleanBackground: 非纯色填充模式，跳过"),!1;if(!y.bubbleStates||y.bubbleStates.length===0)return console.warn("ensureCleanBackground: 没有气泡数据"),!1;if(!y.translatedDataURL&&!y.originalDataURL)return console.warn("ensureCleanBackground: 没有图片数据"),!1;console.log("ensureCleanBackground: 尝试为纯色填充模式创建临时干净背景");const f=y.translatedDataURL||y.originalDataURL,w=ee?.fillColor||u.settings.textStyle.fillColor||"#FFFFFF";return new Promise(c=>{const F=new Image;F.onload=()=>{try{const ve=document.createElement("canvas");ve.width=F.naturalWidth,ve.height=F.naturalHeight;const W=ve.getContext("2d");if(!W){console.error("ensureCleanBackground: 无法获取 Canvas 上下文"),c(!1);return}W.drawImage(F,0,0),W.fillStyle=w;for(const me of y.bubbleStates){const[g,v,M,R]=me.coords;W.fillRect(g,v,M-g+1,R-v+1)}const Y=ve.toDataURL("image/png").split(",")[1];r.updateCurrentImage({cleanImageData:Y}),console.log("ensureCleanBackground: 成功创建临时干净背景（纯色填充）"),c(!0)}catch(ve){console.error("ensureCleanBackground: Canvas 操作失败:",ve),c(!1)}},F.onerror=()=>{console.error("ensureCleanBackground: 加载图像失败"),c(!1)},F.src=f})}return It(()=>{Z()}),{brushMode:o,brushSize:a,isBrushKeyDown:i,isBrushPainting:t,mouseX:_,mouseY:E,isActive:ne,brushColor:G,BRUSH_MIN_SIZE:Pn,BRUSH_MAX_SIZE:En,enterBrushMode:$,exitBrushMode:Z,toggleBrushMode:X,setBrushSize:q,adjustBrushSize:d,handleBrushWheel:l,startBrushPainting:C,continueBrushPainting:x,finishBrushPainting:O,getBrushPositionInImage:Q,getBrushPathBounds:ge,ensureCleanBackground:p}}function Ud(n){return[Math.round(n[0]),Math.round(n[1]),Math.round(n[2]),Math.round(n[3])]}function Od(n){const r=gt(),u=st(),o=Qe(),{bubbles:a,selectedIndex:i,hasSelection:t}=xt(r),{currentImage:s}=xt(u),_=h(!1),E=h(!1),T=h(null),N=h(0),oe=h(0),ne=h(!1);function G(W){r.selectBubble(W)}function $(W){r.toggleMultiSelect(W)}function Z(){r.clearMultiSelect()}function X(W,Y){console.log(`开始拖动气泡 #${W+1}`)}function q(W,Y){}function d(W,Y){r.updateBubble(W,{coords:Y}),console.log(`气泡 #${W+1} 拖动完成:`,Y),se()}function l(W,Y,me){console.log(`开始调整气泡 #${W+1} 大小，手柄: ${Y}`)}function C(W){}function x(W,Y){r.updateBubble(W,{coords:Y}),console.log(`气泡 #${W+1} 调整大小完成:`,Y),se()}function O(W,Y){console.log(`开始旋转气泡 #${W+1}`)}function Q(W){}function ge(W,Y){r.updateBubble(W,{rotationAngle:Y}),console.log(`气泡 #${W+1} 旋转完成: ${Y}°`),se()}function j(){_.value=!_.value,_.value?console.log("进入绘制模式"):console.log("退出绘制模式")}function P(W){r.addBubble(W),r.selectBubble(r.bubbleCount-1),console.log("已添加新气泡:",W),n?.onReRender?.()}function B(W,Y){E.value=!0,N.value=W,oe.value=Y,T.value=[W,Y,W,Y]}function k(W,Y){E.value&&(T.value=[N.value,oe.value,W,Y])}function m(){if(!E.value||!T.value)return E.value=!1,T.value=null,null;const[W,Y,me,g]=T.value,v=10;if(Math.abs(me-W)<v||Math.abs(g-Y)<v)return E.value=!1,T.value=null,null;const M=[Math.min(W,me),Math.min(Y,g),Math.max(W,me),Math.max(Y,g)];return E.value=!1,T.value=null,M}function D(){E.value=!1,T.value=null,_.value=!1}function I(){if(!T.value)return{};const[W,Y,me,g]=T.value;return{position:"absolute",left:`${Math.min(W,me)}px`,top:`${Math.min(Y,g)}px`,width:`${Math.abs(me-W)}px`,height:`${Math.abs(g-Y)}px`,border:"2px dashed #00d4ff",background:"rgba(0, 212, 255, 0.1)",pointerEvents:"none",zIndex:"25",boxSizing:"border-box"}}let p=null,y=!1;const ee=150;function se(){p&&clearTimeout(p),p=setTimeout(async()=>{if(y){console.log("跳过渲染，上一次渲染仍在进行中");return}console.log("触发延迟渲染预览"),y=!0;try{n?.onDelayedPreview?await n.onDelayedPreview():n?.onReRender&&await n.onReRender()}catch(W){console.error("延迟渲染预览失败:",W)}finally{y=!1}},ee)}function f(W){r.updateSelectedBubble(W),se()}function w(){t.value&&(r.deleteSelected(),console.log("已删除选中的气泡"),n?.onReRender?.())}async function c(){const W=i.value;if(W<0){console.warn("请先选中要修复的气泡框");return}const Y=a.value[W],me=s.value;if(!Y||!me?.originalDataURL){console.warn("无法修复背景：缺少气泡或图片数据");return}const g=Y.inpaintMethod||"solid",v=Y.fillColor||"#FFFFFF",M=Y.rotationAngle||0;try{console.log(`开始修复气泡 #${W+1} 背景，方法: ${g}`);let R;if(me.cleanImageData)R=me.cleanImageData;else{const le=me.originalDataURL.match(/^data:image\/[^;]+;base64,(.+)$/);if(R=le&&le[1]?le[1]:"",!R){console.error("无法解析图像数据");return}}if(g==="lama_mpe"||g==="litelama"){const le=g==="litelama"?"litelama":"lama_mpe",re=Ud(Y.coords),ae=await cn(R,re,{bubbleAngle:M,method:"lama",lamaModel:le});ae.success&&ae.inpainted_image?(u.updateCurrentImage({cleanImageData:ae.inpainted_image}),console.log(`气泡 #${W+1} LAMA背景修复成功`),se()):(console.error("LAMA修复失败:",ae.error||"未知错误"),await F(Y.coords,v,M),se())}else await F(Y.coords,v,M),console.log(`气泡 #${W+1} 纯色填充修复成功`),se()}catch(R){console.error("背景修复出错:",R)}}async function F(W,Y,me=0){const g=s.value;if(!g)return;const[v,M,R,U]=W;let le;if(g.cleanImageData)le="data:image/png;base64,"+g.cleanImageData;else if(g.originalDataURL)le=g.originalDataURL;else{console.error("无法找到基础图像用于填充");return}return new Promise(re=>{const ae=new Image;ae.onload=()=>{const S=document.createElement("canvas");S.width=ae.naturalWidth,S.height=ae.naturalHeight;const b=S.getContext("2d");if(!b){re();return}if(b.drawImage(ae,0,0),b.fillStyle=Y,Math.abs(me)<.1)b.fillRect(v,M,R-v,U-M);else{const z=(v+R)/2,H=(M+U)/2,xe=(R-v)/2,he=(U-M)/2,be=me*Math.PI/180,Se=Math.cos(be),ce=Math.sin(be),De=[[-xe,-he],[xe,-he],[xe,he],[-xe,he]].map(([$e,_e])=>[z+$e*Se-_e*ce,H+$e*ce+_e*Se]);b.beginPath();const ke=De[0];if(ke){b.moveTo(ke[0],ke[1]);for(let $e=1;$e<De.length;$e++){const _e=De[$e];_e&&b.lineTo(_e[0],_e[1])}}b.closePath(),b.fill()}const L=S.toDataURL("image/png").split(",")[1];u.updateCurrentImage({cleanImageData:L}),console.log("已对气泡区域进行纯色填充:",W,Y,"角度:",me),re()},ae.onerror=()=>{console.error("加载基础图像失败"),re()},ae.src=le})}async function ve(W){const Y=a.value[W],me=s.value;if(!Y||!me?.originalDataURL){console.warn("无法进行 OCR 识别：缺少气泡或图片数据");return}try{console.log(`开始 OCR 识别气泡 #${W+1}`);const g=me.originalDataURL.split(",")[1]||"",v=o.settings,M=await Gn(g,Y.coords,v.ocrEngine||"manga_ocr",{source_language:v.sourceLanguage,baidu_ocr_api_key:v.baiduOcr.apiKey,baidu_ocr_secret_key:v.baiduOcr.secretKey,baidu_version:v.baiduOcr.version,baidu_source_language:v.baiduOcr.sourceLanguage,ai_vision_provider:v.aiVisionOcr.provider,ai_vision_api_key:v.aiVisionOcr.apiKey,ai_vision_model_name:v.aiVisionOcr.modelName,ai_vision_ocr_prompt:v.aiVisionOcr.prompt,custom_ai_vision_base_url:v.aiVisionOcr.customBaseUrl});M.success&&M.text!==void 0?(r.updateBubble(W,{originalText:M.text}),console.log(`OCR 识别成功: "${M.text}"`)):console.error("OCR 识别失败:",M.error||"未知错误")}catch(g){console.error("OCR 识别出错:",g)}}return{isDrawingMode:_,isDrawingBox:E,currentDrawingRect:T,isMiddleButtonDown:ne,handleBubbleSelect:G,handleBubbleMultiSelect:$,handleClearMultiSelect:Z,handleBubbleDragStart:X,handleBubbleDragging:q,handleBubbleDragEnd:d,handleBubbleResizeStart:l,handleBubbleResizing:C,handleBubbleResizeEnd:x,handleBubbleRotateStart:O,handleBubbleRotating:Q,handleBubbleRotateEnd:ge,toggleDrawingMode:j,handleDrawBubble:P,startDrawingBox:B,updateDrawingBox:k,finishDrawingBox:m,cancelDrawing:D,getDrawingRectStyle:I,handleBubbleUpdate:f,deleteSelectedBubbles:w,repairSelectedBubble:c,triggerDelayedPreview:se,handleOcrRecognize:ve}}function zd(n){const r=gt(),u=st(),{bubbles:o}=xt(r),{currentImage:a}=xt(u),i=h(!1),t=h("");let s=null;function _(){const N=a.value;if(!N)return null;if(N.cleanImageData)return N.cleanImageData;if(N.originalDataURL){const oe=N.originalDataURL.match(/^data:image\/[^;]+;base64,(.+)$/);if(oe&&oe[1])return oe[1]}return null}async function E(N=!1){if(!a.value)return console.warn("reRenderFullImage: 没有当前图片"),!1;if(o.value.length===0){console.log("reRenderFullImage: 没有气泡，跳过后端渲染");const $=_();if($){const Z=`data:image/png;base64,${$}`;u.updateCurrentImage({translatedDataURL:Z}),N||n?.onRenderSuccess?.(Z)}return!0}const ne=_();if(!ne)return console.error("reRenderFullImage: 缺少图像数据"),t.value="缺少图像数据",N||n?.onRenderError?.("缺少图像数据"),!1;const G=Symbol("render");s=G,i.value=!0,t.value="",N||n?.onRenderStart?.();try{console.log("reRenderFullImage: 开始重新渲染，气泡数量:",o.value.length);const $=o.value,Z=$.map(l=>l.translatedText||""),X=$.map(l=>l.coords.map(C=>Math.round(C))),q=$.map(l=>({translatedText:l.translatedText||"",coords:l.coords,fontSize:Number(l.fontSize)||24,fontFamily:l.fontFamily||"fonts/STSONG.TTF",textDirection:_t(l),textColor:l.textColor||"#231816",rotationAngle:Math.round(Number(l.rotationAngle)||0),position:l.position?{x:Math.round(l.position.x||0),y:Math.round(l.position.y||0)}:{x:0,y:0},strokeEnabled:l.strokeEnabled!==void 0?l.strokeEnabled:!0,strokeColor:l.strokeColor||"#FFFFFF",strokeWidth:Number(l.strokeWidth)||3})),d=await un({clean_image:ne,bubble_texts:Z,bubble_coords:X,bubble_states:q,fontSize:Number($[0]?.fontSize)||24,fontFamily:$[0]?.fontFamily||"fonts/STSONG.TTF",textDirection:$[0]?_t($[0]):"vertical",textColor:$[0]?.textColor||"#231816",strokeEnabled:$[0]?.strokeEnabled!==void 0?$[0].strokeEnabled:!0,strokeColor:$[0]?.strokeColor||"#FFFFFF",strokeWidth:Number($[0]?.strokeWidth)||3,use_individual_styles:!0,use_inpainting:!1,use_lama:!1,is_font_style_change:!0});if(s!==G)return console.log("reRenderFullImage: 渲染结果已过期，忽略"),!1;if(d.rendered_image){const l=`data:image/png;base64,${d.rendered_image}`;return u.updateCurrentImage({translatedDataURL:l}),console.log("reRenderFullImage: 渲染成功"),N||n?.onRenderSuccess?.(l),!0}else{const l=d.error||"渲染失败";return console.error("reRenderFullImage: 渲染失败 -",l),t.value=l,N||n?.onRenderError?.(l),!1}}catch($){if(s!==G)return!1;const Z=$ instanceof Error?$.message:"渲染请求失败";return console.error("reRenderFullImage: 渲染出错 -",$),t.value=Z,N||n?.onRenderError?.(Z),!1}finally{s===G&&(i.value=!1,N||n?.onRenderEnd?.())}}function T(){s=null,i.value=!1}return{isRendering:i,renderError:t,reRenderFullImage:E,cancelRender:T}}const Vd=["data-index","data-coords","data-rotation","onClick","onMousedown"],Nd={class:"bubble-index"},Wd=["data-parent-index","onMousedown"],Kd=["data-parent-index","onMousedown"],qd=["data-parent-index","onMousedown"],Hd=["data-parent-index","onMousedown"],Jd=["data-parent-index","onMousedown"],Yd=["data-parent-index","onMousedown"],Xd=["data-parent-index","onMousedown"],jd=["data-parent-index","onMousedown"],Gd=["data-parent-index","onMousedown"],Zd=Ge({__name:"BubbleOverlay",props:{bubbles:{},selectedIndex:{},selectedIndices:{},scale:{},isDrawingMode:{type:Boolean},isBrushMode:{type:Boolean},imageWidth:{},imageHeight:{}},emits:["select","multiSelect","dragStart","dragging","dragEnd","resizeStart","resizing","resizeEnd","rotateStart","rotating","rotateEnd","drawBubble"],setup(n,{emit:r}){const u=gt(),{isDragging:o,draggingIndex:a,dragOffsetX:i,dragOffsetY:t,dragInitialX:s,dragInitialY:_,isResizing:E,resizingIndex:T,resizeCurrentCoords:N,isRotating:oe,rotatingIndex:ne,rotateCurrentAngle:G}=xt(u),$=n,Z=r,X=h(null),q=h(0),d=h(0),l=h(""),C=h(0),x=h(0),O=h(null),Q=h(0),ge=h(0),j=h(0),P=h(0),B=h(!1),k=h(0),m=h(0),D=h(null),I=h(!1);function p(S,b){let L,z,H,xe,he=S.rotationAngle||0;if(o.value&&a.value===b){const[De,ke,$e,_e]=S.coords;L=s.value+i.value,z=_.value+t.value,H=L+($e-De),xe=z+(_e-ke)}else E.value&&T.value===b&&N.value?[L,z,H,xe]=N.value:oe.value&&ne.value===b?([L,z,H,xe]=S.coords,he=G.value):[L,z,H,xe]=S.coords;const be=H-L,Se=xe-z,ce={left:`${L}px`,top:`${z}px`,width:`${be}px`,height:`${Se}px`};return he&&(ce.transformOrigin="center center",ce.transform=`rotate(${he}deg)`),ce}function y(){if(!D.value)return{};const[S,b,L,z]=D.value;return{left:`${Math.min(S,L)}px`,top:`${Math.min(b,z)}px`,width:`${Math.abs(L-S)}px`,height:`${Math.abs(z-b)}px`}}function ee(S){if(!X.value)return null;const b=X.value.getBoundingClientRect(),L=$.scale||1,z=(S.clientX-b.left)/L,H=(S.clientY-b.top)/L;return{x:z,y:H}}function se(S,b){$.isBrushMode||b.shiftKey||Z("select",S)}function f(S){if(!$.isBrushMode){if(S.button===1){S.preventDefault(),I.value=!0,document.body.classList.add("middle-button-drawing"),R(S);return}S.button===0&&$.isDrawingMode&&R(S)}}function w(S,b){if(!$.isBrushMode&&b.button===0){if(b.preventDefault(),b.stopPropagation(),b.shiftKey){Z("multiSelect",S);return}if(S!==$.selectedIndex){Z("select",S);return}c(S,b)}}function c(S,b){document.removeEventListener("mousemove",re),document.removeEventListener("mouseup",ae),o.value=!0,a.value=S,q.value=b.clientX,d.value=b.clientY,i.value=0,t.value=0;const L=$.bubbles[S];L&&(s.value=L.coords[0],_.value=L.coords[1]),Z("dragStart",S,b),document.addEventListener("mousemove",re),document.addEventListener("mouseup",ae)}function F(S){const b=$.scale||1,L=(S.clientX-q.value)/b,z=(S.clientY-d.value)/b;i.value=L,t.value=z}function ve(S){const b=a.value;o.value=!1,a.value=-1,i.value=0,t.value=0;const L=$.scale||1,z=(S.clientX-q.value)/L,H=(S.clientY-d.value)/L,xe=$.bubbles[b];if(!xe)return;const[he,be,Se,ce]=xe.coords,De=Se-he,ke=ce-be;let $e=Math.round(s.value+z),_e=Math.round(_.value+H);const Te=$.imageWidth||2e3,Ce=$.imageHeight||2e3,Ee=Math.min(De,Te),Ye=Math.min(ke,Ce);$e=Math.max(0,Math.min($e,Te-Ee)),_e=Math.max(0,Math.min(_e,Ce-Ye));const we=[$e,_e,$e+Ee,_e+Ye];Z("dragEnd",b,we)}function W(S,b,L){if($.isBrushMode||L.button!==0)return;L.preventDefault(),L.stopPropagation(),document.removeEventListener("mousemove",re),document.removeEventListener("mouseup",ae),E.value=!0,T.value=b,l.value=S,C.value=L.clientX,x.value=L.clientY;const z=$.bubbles[b];z&&(O.value=[...z.coords],N.value=[...z.coords]),Z("resizeStart",b,S,L),document.addEventListener("mousemove",re),document.addEventListener("mouseup",ae)}function Y(S){if(!O.value)return;const b=$.scale||1,L=(S.clientX-C.value)/b,z=(S.clientY-x.value)/b;let[H,xe,he,be]=O.value;const Se=l.value;Se.includes("w")&&(H+=L),Se.includes("e")&&(he+=L),Se.includes("n")&&(xe+=z),Se.includes("s")&&(be+=z),H>he&&([H,he]=[he,H]),xe>be&&([xe,be]=[be,xe]);const ce=10;he-H<ce||be-xe<ce||(N.value=[H,xe,he,be])}function me(S){if(!O.value)return;const b=$.scale||1,L=(S.clientX-C.value)/b,z=(S.clientY-x.value)/b;let[H,xe,he,be]=O.value;const Se=l.value;Se.includes("w")&&(H+=L),Se.includes("e")&&(he+=L),Se.includes("n")&&(xe+=z),Se.includes("s")&&(be+=z),H>he&&([H,he]=[he,H]),xe>be&&([xe,be]=[be,xe]);const ce=$.imageWidth||2e3,De=$.imageHeight||2e3;H=Math.max(0,Math.round(H)),xe=Math.max(0,Math.round(xe)),he=Math.min(ce,Math.round(he)),be=Math.min(De,Math.round(be));const ke=10;if(he-H<ke||be-xe<ke){console.warn("调整后尺寸过小，已撤销"),E.value=!1,T.value=-1,O.value=null;return}Z("resizeEnd",T.value,[H,xe,he,be]),E.value=!1,T.value=-1,O.value=null,N.value=null}function g(S,b){if($.isBrushMode||b.button!==0)return;b.preventDefault(),b.stopPropagation(),document.removeEventListener("mousemove",re),document.removeEventListener("mouseup",ae),oe.value=!0,ne.value=S;const L=$.bubbles[S];if(!L||!X.value)return;const[z,H,xe,he]=L.coords,be=$.scale||1,Se=X.value.getBoundingClientRect();j.value=Se.left+(z+xe)/2*be,P.value=Se.top+(H+he)/2*be;const ce=b.clientX-j.value,De=b.clientY-P.value;Q.value=Math.atan2(De,ce)*180/Math.PI,ge.value=L.rotationAngle||0,G.value=L.rotationAngle||0,Z("rotateStart",S,b),document.body.classList.add("rotating-box"),document.addEventListener("mousemove",re),document.addEventListener("mouseup",ae),console.log(`开始旋转气泡 #${S+1}，初始角度: ${ge.value}°`)}function v(S){const b=S.clientX-j.value,L=S.clientY-P.value,H=Math.atan2(L,b)*180/Math.PI-Q.value;let xe=ge.value+H;for(;xe>180;)xe-=360;for(;xe<-180;)xe+=360;S.shiftKey&&(xe=Math.round(xe/15)*15),G.value=xe}function M(S){document.body.classList.remove("rotating-box");const b=ne.value,L=G.value;Z("rotateEnd",b,L),oe.value=!1,ne.value=-1,console.log(`气泡 #${b+1} 旋转完成，角度: ${L}°`)}function R(S){const b=ee(S);if(!b)return;const L=$.imageWidth||2e3,z=$.imageHeight||2e3;b.x<0||b.x>L||b.y<0||b.y>z||(B.value=!0,k.value=b.x,m.value=b.y,D.value=[b.x,b.y,b.x,b.y],document.addEventListener("mousemove",re),document.addEventListener("mouseup",ae),console.log("开始绘制新框:",b.x.toFixed(1),b.y.toFixed(1)))}function U(S){const b=ee(S);!b||!D.value||(D.value=[k.value,m.value,b.x,b.y])}function le(S){const b=ee(S);if(I.value&&(I.value=!1,document.body.classList.remove("middle-button-drawing")),!b||!D.value){B.value=!1,D.value=null;return}const L=$.imageWidth||2e3,z=$.imageHeight||2e3,H=Math.max(0,Math.round(Math.min(k.value,b.x))),xe=Math.max(0,Math.round(Math.min(m.value,b.y))),he=Math.min(L,Math.round(Math.max(k.value,b.x))),be=Math.min(z,Math.round(Math.max(m.value,b.y))),Se=10;if(he-H<Se||be-xe<Se){console.log("绘制的框太小，已忽略"),B.value=!1,D.value=null;return}console.log("完成绘制新框:",[H,xe,he,be]),Z("drawBubble",[H,xe,he,be]),B.value=!1,D.value=null}function re(S){o.value?F(S):E.value?Y(S):oe.value?v(S):B.value&&U(S)}function ae(S){document.removeEventListener("mousemove",re),document.removeEventListener("mouseup",ae),(S.button===1||I.value)&&(I.value=!1,document.body.classList.remove("middle-button-drawing")),o.value?ve(S):E.value?me(S):oe.value?M():B.value&&le(S)}return ut(()=>{}),It(()=>{document.removeEventListener("mousemove",re),document.removeEventListener("mouseup",ae),document.body.classList.remove("middle-button-drawing"),document.body.classList.remove("rotating-box")}),(S,b)=>(V(),J("div",{class:Le(["bubble-overlay",{"brush-mode":n.isBrushMode}]),ref_key:"overlayRef",ref:X,onMousedown:f},[(V(!0),J(Ze,null,et(n.bubbles,(L,z)=>(V(),J("div",{key:z,class:Le(["bubble-highlight-box",{selected:z===n.selectedIndex,"multi-selected":n.selectedIndices.length>1&&n.selectedIndices.includes(z)&&z!==n.selectedIndex}]),style:it(p(L,z)),"data-index":z,"data-coords":JSON.stringify(L.coords),"data-rotation":L.rotationAngle||0,onClick:nt(H=>se(z,H),["stop"]),onMousedown:nt(H=>w(z,H),["stop"])},[e("span",Nd,ye(z+1),1),z===n.selectedIndex?(V(),J(Ze,{key:0},[e("div",{class:"resize-handle nw","data-handle":"nw","data-parent-index":z,onMousedown:nt(H=>W("nw",z,H),["stop"])},null,40,Wd),e("div",{class:"resize-handle n","data-handle":"n","data-parent-index":z,onMousedown:nt(H=>W("n",z,H),["stop"])},null,40,Kd),e("div",{class:"resize-handle ne","data-handle":"ne","data-parent-index":z,onMousedown:nt(H=>W("ne",z,H),["stop"])},null,40,qd),e("div",{class:"resize-handle e","data-handle":"e","data-parent-index":z,onMousedown:nt(H=>W("e",z,H),["stop"])},null,40,Hd),e("div",{class:"resize-handle se","data-handle":"se","data-parent-index":z,onMousedown:nt(H=>W("se",z,H),["stop"])},null,40,Jd),e("div",{class:"resize-handle s","data-handle":"s","data-parent-index":z,onMousedown:nt(H=>W("s",z,H),["stop"])},null,40,Yd),e("div",{class:"resize-handle sw","data-handle":"sw","data-parent-index":z,onMousedown:nt(H=>W("sw",z,H),["stop"])},null,40,Xd),e("div",{class:"resize-handle w","data-handle":"w","data-parent-index":z,onMousedown:nt(H=>W("w",z,H),["stop"])},null,40,jd),b[0]||(b[0]=e("div",{class:"rotate-line"},null,-1)),e("div",{class:"rotate-handle",title:"拖拽旋转","data-parent-index":z,onMousedown:nt(H=>g(z,H),["stop"])},null,40,Gd)],64)):Me("",!0)],46,Vd))),128)),D.value?(V(),J("div",{key:0,class:"drawing-rect",style:it(y())},null,4)):Me("",!0)],34))}}),qn=je(Zd,[["__scopeId","data-v-a3e510ac"]]),Qd={key:0,class:"kana-keyboard"},eg={class:"kana-keyboard-header"},tg={class:"kana-keyboard-tabs"},ng=["onClick"],og={class:"kana-keyboard-options"},ag={class:"kana-mode-select"},sg={class:"kana-target-select"},lg={class:"kana-table"},ig={class:"row-label"},rg=["onClick"],ug={class:"kana-hiragana"},cg={class:"kana-katakana"},dg={class:"kana-table"},gg={class:"row-label"},bg=["onClick"],pg={class:"kana-hiragana"},vg={class:"kana-katakana"},mg={class:"kana-table combo-table"},fg={class:"row-label"},hg=["onClick"],yg={class:"kana-hiragana"},xg={class:"kana-katakana"},Sg={class:"special-chars-grid"},kg=["onClick"],_g={key:0,class:"char-label"},Cg=Ge({__name:"JapaneseKeyboard",props:{visible:{type:Boolean,default:!1},defaultTarget:{default:"original"}},emits:["close","insert","delete"],setup(n,{emit:r}){const u=n,o=r,a=h("basic"),i=h("hiragana"),t=h(u.defaultTarget),s=h(null),_=[{label:"原文",value:"original"},{label:"译文",value:"translated"}],E=[{id:"basic",label:"基本"},{id:"dakuten",label:"浊/半浊音"},{id:"combo",label:"拗音"},{id:"special",label:"特殊"}],T=[{label:"あ行",chars:[{h:"あ",k:"ア"},{h:"い",k:"イ"},{h:"う",k:"ウ"},{h:"え",k:"エ"},{h:"お",k:"オ"}]},{label:"か行",chars:[{h:"か",k:"カ"},{h:"き",k:"キ"},{h:"く",k:"ク"},{h:"け",k:"ケ"},{h:"こ",k:"コ"}]},{label:"さ行",chars:[{h:"さ",k:"サ"},{h:"し",k:"シ"},{h:"す",k:"ス"},{h:"せ",k:"セ"},{h:"そ",k:"ソ"}]},{label:"た行",chars:[{h:"た",k:"タ"},{h:"ち",k:"チ"},{h:"つ",k:"ツ"},{h:"て",k:"テ"},{h:"と",k:"ト"}]},{label:"な行",chars:[{h:"な",k:"ナ"},{h:"に",k:"ニ"},{h:"ぬ",k:"ヌ"},{h:"ね",k:"ネ"},{h:"の",k:"ノ"}]},{label:"は行",chars:[{h:"は",k:"ハ"},{h:"ひ",k:"ヒ"},{h:"ふ",k:"フ"},{h:"へ",k:"ヘ"},{h:"ほ",k:"ホ"}]},{label:"ま行",chars:[{h:"ま",k:"マ"},{h:"み",k:"ミ"},{h:"む",k:"ム"},{h:"め",k:"メ"},{h:"も",k:"モ"}]},{label:"や行",chars:[{h:"や",k:"ヤ"},null,{h:"ゆ",k:"ユ"},null,{h:"よ",k:"ヨ"}]},{label:"ら行",chars:[{h:"ら",k:"ラ"},{h:"り",k:"リ"},{h:"る",k:"ル"},{h:"れ",k:"レ"},{h:"ろ",k:"ロ"}]},{label:"わ行",chars:[{h:"わ",k:"ワ"},null,null,null,{h:"を",k:"ヲ"}]},{label:"ん",chars:[{h:"ん",k:"ン"},null,null,null,null]}],N=[{label:"が行",chars:[{h:"が",k:"ガ"},{h:"ぎ",k:"ギ"},{h:"ぐ",k:"グ"},{h:"げ",k:"ゲ"},{h:"ご",k:"ゴ"}]},{label:"ざ行",chars:[{h:"ざ",k:"ザ"},{h:"じ",k:"ジ"},{h:"ず",k:"ズ"},{h:"ぜ",k:"ゼ"},{h:"ぞ",k:"ゾ"}]},{label:"だ行",chars:[{h:"だ",k:"ダ"},{h:"ぢ",k:"ヂ"},{h:"づ",k:"ヅ"},{h:"で",k:"デ"},{h:"ど",k:"ド"}]},{label:"ば行",chars:[{h:"ば",k:"バ"},{h:"び",k:"ビ"},{h:"ぶ",k:"ブ"},{h:"べ",k:"ベ"},{h:"ぼ",k:"ボ"}]},{label:"ぱ行",chars:[{h:"ぱ",k:"パ"},{h:"ぴ",k:"ピ"},{h:"ぷ",k:"プ"},{h:"ぺ",k:"ペ"},{h:"ぽ",k:"ポ"}]}],oe=[{label:"きゃ行",chars:[{h:"きゃ",k:"キャ"},{h:"きゅ",k:"キュ"},{h:"きょ",k:"キョ"}]},{label:"しゃ行",chars:[{h:"しゃ",k:"シャ"},{h:"しゅ",k:"シュ"},{h:"しょ",k:"ショ"}]},{label:"ちゃ行",chars:[{h:"ちゃ",k:"チャ"},{h:"ちゅ",k:"チュ"},{h:"ちょ",k:"チョ"}]},{label:"にゃ行",chars:[{h:"にゃ",k:"ニャ"},{h:"にゅ",k:"ニュ"},{h:"にょ",k:"ニョ"}]},{label:"ひゃ行",chars:[{h:"ひゃ",k:"ヒャ"},{h:"ひゅ",k:"ヒュ"},{h:"ひょ",k:"ヒョ"}]},{label:"みゃ行",chars:[{h:"みゃ",k:"ミャ"},{h:"みゅ",k:"ミュ"},{h:"みょ",k:"ミョ"}]},{label:"りゃ行",chars:[{h:"りゃ",k:"リャ"},{h:"りゅ",k:"リュ"},{h:"りょ",k:"リョ"}]},{label:"ぎゃ行",chars:[{h:"ぎゃ",k:"ギャ"},{h:"ぎゅ",k:"ギュ"},{h:"ぎょ",k:"ギョ"}]},{label:"じゃ行",chars:[{h:"じゃ",k:"ジャ"},{h:"じゅ",k:"ジュ"},{h:"じょ",k:"ジョ"}]},{label:"びゃ行",chars:[{h:"びゃ",k:"ビャ"},{h:"びゅ",k:"ビュ"},{h:"びょ",k:"ビョ"}]},{label:"ぴゃ行",chars:[{h:"ぴゃ",k:"ピャ"},{h:"ぴゅ",k:"ピュ"},{h:"ぴょ",k:"ピョ"}]}],ne=[{char:"っ",label:"促音"},{char:"ッ",label:"促音"},{char:"ー",label:"长音"},{char:"〜",label:"波浪"},{char:"。",label:"句号"},{char:"、",label:"顿号"},{char:"「",label:"引号"},{char:"」",label:"引号"},{char:"『",label:"双引"},{char:"』",label:"双引"},{char:"…",label:"省略"},{char:"・",label:"中点"},{char:"！",label:"感叹"},{char:"？",label:"问号"},{char:"♪",label:"音符"},{char:"♡",label:"心形"},{char:"★",label:"星形"},{char:"☆",label:"空星"},{char:"ぁ",label:"小あ"},{char:"ぃ",label:"小い"},{char:"ぅ",label:"小う"},{char:"ぇ",label:"小え"},{char:"ぉ",label:"小お"},{char:"ァ",label:"小ア"},{char:"ィ",label:"小イ"},{char:"ゥ",label:"小ウ"},{char:"ェ",label:"小エ"},{char:"ォ",label:"小オ"},{char:"ゃ",label:"小や"},{char:"ゅ",label:"小ゆ"},{char:"ょ",label:"小よ"},{char:"ャ",label:"小ヤ"},{char:"ュ",label:"小ユ"},{char:"ョ",label:"小ヨ"}];function G(){o("close")}function $(q){const d=i.value==="hiragana"?q.h:q.k;s.value=q.h,setTimeout(()=>{s.value=null},100),o("insert",d,t.value)}function Z(q){s.value=q,setTimeout(()=>{s.value=null},100),o("insert",q,t.value)}function X(){o("delete",t.value)}return(q,d)=>n.visible?(V(),J("div",Qd,[e("div",eg,[d[3]||(d[3]=e("span",{class:"kana-keyboard-title"},"50音键盘",-1)),e("div",tg,[(V(),J(Ze,null,et(E,l=>e("button",{key:l.id,class:Le(["kana-tab",{active:a.value===l.id}]),onClick:C=>a.value=l.id},ye(l.label),11,ng)),64))]),e("button",{class:"kana-keyboard-close",onClick:G},"✕")]),e("div",og,[e("div",ag,[e("label",null,[ie(e("input",{type:"radio",name:"kanaMode",value:"hiragana","onUpdate:modelValue":d[0]||(d[0]=l=>i.value=l)},null,512),[[On,i.value]]),d[4]||(d[4]=Ne(" 平假名 ",-1))]),e("label",null,[ie(e("input",{type:"radio",name:"kanaMode",value:"katakana","onUpdate:modelValue":d[1]||(d[1]=l=>i.value=l)},null,512),[[On,i.value]]),d[5]||(d[5]=Ne(" 片假名 ",-1))])]),e("div",sg,[d[6]||(d[6]=e("label",null,"输入到：",-1)),Re(We,{modelValue:t.value,"onUpdate:modelValue":d[2]||(d[2]=l=>t.value=l),options:_},null,8,["modelValue"])])]),e("div",{class:Le(["kana-tab-content",{active:a.value==="basic"}])},[e("table",lg,[d[7]||(d[7]=e("thead",null,[e("tr",null,[e("th"),e("th",null,"あ段"),e("th",null,"い段"),e("th",null,"う段"),e("th",null,"え段"),e("th",null,"お段")])],-1)),e("tbody",null,[(V(),J(Ze,null,et(T,l=>e("tr",{key:l.label},[e("td",ig,ye(l.label),1),(V(!0),J(Ze,null,et(l.chars,(C,x)=>(V(),J("td",{key:x},[C?(V(),J("button",{key:0,class:Le(["kana-key",{pressed:s.value===C.h}]),onClick:O=>$(C)},[e("span",ug,ye(C.h),1),e("span",cg,ye(C.k),1)],10,rg)):Me("",!0)]))),128))])),64))])])],2),e("div",{class:Le(["kana-tab-content",{active:a.value==="dakuten"}])},[e("table",dg,[d[8]||(d[8]=e("thead",null,[e("tr",null,[e("th"),e("th",null,"あ段"),e("th",null,"い段"),e("th",null,"う段"),e("th",null,"え段"),e("th",null,"お段")])],-1)),e("tbody",null,[(V(),J(Ze,null,et(N,l=>e("tr",{key:l.label},[e("td",gg,ye(l.label),1),(V(!0),J(Ze,null,et(l.chars,(C,x)=>(V(),J("td",{key:x},[C?(V(),J("button",{key:0,class:Le(["kana-key",{pressed:s.value===C.h}]),onClick:O=>$(C)},[e("span",pg,ye(C.h),1),e("span",vg,ye(C.k),1)],10,bg)):Me("",!0)]))),128))])),64))])])],2),e("div",{class:Le(["kana-tab-content",{active:a.value==="combo"}])},[e("table",mg,[d[9]||(d[9]=e("thead",null,[e("tr",null,[e("th"),e("th",null,"ゃ"),e("th",null,"ゅ"),e("th",null,"ょ")])],-1)),e("tbody",null,[(V(),J(Ze,null,et(oe,l=>e("tr",{key:l.label},[e("td",fg,ye(l.label),1),(V(!0),J(Ze,null,et(l.chars,(C,x)=>(V(),J("td",{key:x},[C?(V(),J("button",{key:0,class:Le(["kana-key",{pressed:s.value===C.h}]),onClick:O=>$(C)},[e("span",yg,ye(C.h),1),e("span",xg,ye(C.k),1)],10,hg)):Me("",!0)]))),128))])),64))])])],2),e("div",{class:Le(["kana-tab-content",{active:a.value==="special"}])},[e("div",Sg,[(V(),J(Ze,null,et(ne,l=>e("button",{key:l.char,class:Le(["kana-key special-key",{pressed:s.value===l.char}]),onClick:C=>Z(l.char)},[Ne(ye(l.char)+" ",1),l.label?(V(),J("span",_g,ye(l.label),1)):Me("",!0)],10,kg)),64))])],2),e("div",{class:"kana-keyboard-footer"},[e("button",{class:"kana-backspace",onClick:X},"⌫ 退格")])])):Me("",!0)}}),wg=je(Cg,[["__scopeId","data-v-ebfc2125"]]),$g={class:"edit-panel-content"},Tg={class:"text-column original-text-column text-block"},Ig={class:"text-column translated-text-column text-block"},Dg={class:"style-settings-section text-block"},Rg={class:"office-toolbar"},Mg={class:"toolbar-row toolbar-row-top"},Bg={class:"combo-control font-control"},Eg={class:"combo-control size-control"},Pg={class:"size-input-wrap"},Ag=["min","max","step"],Fg={class:"toolbar-row toolbar-row-actions"},Lg={class:"toolbar-icon-group","aria-label":"排版方向"},Ug=["data-active"],Og=["data-active"],zg={class:"toolbar-color-group"},Vg={class:"toolbar-color-picker",title:"文字颜色"},Ng={class:"toolbar-inpaint-group",title:"背景修复方式"},Wg={class:"toolbar-stroke-cluster"},Kg=["data-active"],qg={class:"toolbar-row toolbar-row-bottom"},Hg={class:"toolbar-rotation-group",title:"旋转角度"},Jg={class:"toolbar-position-group",title:"位置调整"},Yg={class:"toolbar-position-value"},Xg={class:"fontsize-presets-panel"},jg={class:"font-size-presets"},Gg=["onClick"],Bt=2,Zg=Ge({__name:"BubbleEditor",props:{bubble:{},bubbleIndex:{}},emits:["update","reRender","ocrRecognize","reTranslate","applyBubble","resetCurrent"],setup(n,{emit:r}){const u=n,o=r,a=gt(),i={originalText:"",translatedText:"",fontSize:24,fontFamily:"fonts/STSONG.TTF",textDirection:"auto",textColor:"#231816",fillColor:"#FFFFFF",strokeEnabled:!0,strokeColor:"#FFFFFF",strokeWidth:3,rotationAngle:0,inpaintMethod:"solid",position:{x:0,y:0}},t=h(""),s=h(""),_=h(24),E=h("fonts/STSONG.TTF"),T=h("auto"),N=h("#231816"),oe=h("#FFFFFF"),ne=h(!0),G=h("#FFFFFF"),$=h(3),Z=h(0),X=h("solid"),q=h(0),d=h(0),l=h(null),C=h(null),x=h(null),O=h(null),Q=h(null),ge=h(!1),j=h("original"),P=h([{name:"华文宋体",path:"fonts/STSONG.TTF"},{name:"华文楷体",path:"fonts/STKAITI.TTF"},{name:"华文细黑",path:"fonts/STXIHEI.TTF"},{name:"黑体",path:"fonts/SIMHEI.TTF"},{name:"宋体",path:"fonts/SIMSUN.TTC"}]),B=h([]),k=te(()=>u.bubble?u.bubble.coords[0]+q.value:0),m=te(()=>u.bubble?u.bubble.coords[1]+d.value:0),D=te(()=>{const we=[{label:"系统字体",options:P.value.map(A=>({label:A.name,value:A.path}))}];return B.value.length>0&&we.push({label:"自定义字体",options:B.value.map(A=>({label:A.name,value:A.path}))}),we}),I=[{label:"纯色填充",value:"solid"},{label:"LAMA修复(漫画)",value:"lama_mpe"},{label:"LAMA修复(通用)",value:"litelama"}];function p(we){const A=we||i;t.value=A.originalText,s.value=A.translatedText,_.value=A.fontSize,E.value=A.fontFamily,T.value=A.textDirection,N.value=A.textColor,oe.value=A.fillColor,ne.value=A.strokeEnabled,G.value=A.strokeColor,$.value=A.strokeWidth,Z.value=A.rotationAngle,X.value=A.inpaintMethod,q.value=A.position?.x||0,d.value=A.position?.y||0}Be(()=>u.bubble,we=>{p(we)},{deep:!0,immediate:!0});function y(){o("update",{originalText:t.value})}function ee(){o("update",{translatedText:s.value})}function se(){navigator.clipboard.writeText(t.value)}function f(){navigator.clipboard.writeText(s.value)}function w(){o("update",{fontSize:_.value})}function c(we){_.value=we,o("update",{fontSize:we})}function F(){_.value=Math.min(An,_.value+Xt),o("update",{fontSize:_.value})}function ve(){_.value=Math.max(Fn,_.value-Xt),o("update",{fontSize:_.value})}function W(){o("update",{fontFamily:E.value})}function Y(we){T.value=we,o("update",{textDirection:we})}function me(){x.value?.click()}function g(){o("update",{textColor:N.value})}function v(){O.value?.click()}function M(){o("update",{fillColor:oe.value})}function R(){Q.value?.click()}function U(){o("update",{strokeColor:G.value})}function le(){ne.value=!ne.value,o("update",{strokeEnabled:ne.value})}function re(){o("update",{strokeWidth:$.value})}function ae(){o("update",{inpaintMethod:X.value})}function S(){o("update",{rotationAngle:Z.value})}function b(){Z.value=Math.max(-180,Z.value-5),o("update",{rotationAngle:Z.value})}function L(){Z.value=Math.min(180,Z.value+5),o("update",{rotationAngle:Z.value})}function z(){Z.value=0,o("update",{rotationAngle:0})}function H(){q.value-=Bt,o("update",{position:{x:q.value,y:d.value}})}function xe(){q.value+=Bt,o("update",{position:{x:q.value,y:d.value}})}function he(){d.value-=Bt,o("update",{position:{x:q.value,y:d.value}})}function be(){d.value+=Bt,o("update",{position:{x:q.value,y:d.value}})}function Se(){q.value=0,d.value=0,o("update",{position:{x:0,y:0}})}function ce(){o("applyBubble",u.bubbleIndex)}function De(){a.updateAllBubbles({fontSize:_.value,fontFamily:E.value,textDirection:T.value,textColor:N.value,fillColor:oe.value,strokeEnabled:ne.value,strokeColor:G.value,strokeWidth:$.value,inpaintMethod:X.value}),console.log("样式已应用到所有气泡"),o("reRender")}function ke(){o("resetCurrent",u.bubbleIndex)}function $e(){o("ocrRecognize",u.bubbleIndex)}function _e(){o("reTranslate",u.bubbleIndex)}function Te(){ge.value=!ge.value}function Ce(we,A){if(A==="original"){const de=l.value;if(de){const Pe=de.selectionStart||t.value.length,Ue=de.selectionEnd||t.value.length,ot=t.value;t.value=ot.slice(0,Pe)+we+ot.slice(Ue),ct(()=>{de.selectionStart=de.selectionEnd=Pe+we.length,de.focus()}),o("update",{originalText:t.value})}}else{const de=C.value;if(de){const Pe=de.selectionStart||s.value.length,Ue=de.selectionEnd||s.value.length,ot=s.value;s.value=ot.slice(0,Pe)+we+ot.slice(Ue),ct(()=>{de.selectionStart=de.selectionEnd=Pe+we.length,de.focus()}),o("update",{translatedText:s.value})}}}function Ee(we){if(we==="original"){const A=l.value;if(A&&t.value.length>0){const de=A.selectionStart||t.value.length,Pe=A.selectionEnd||t.value.length,Ue=t.value;de===Pe&&de>0?(t.value=Ue.slice(0,de-1)+Ue.slice(Pe),ct(()=>{A.selectionStart=A.selectionEnd=de-1,A.focus()})):de!==Pe&&(t.value=Ue.slice(0,de)+Ue.slice(Pe),ct(()=>{A.selectionStart=A.selectionEnd=de,A.focus()})),o("update",{originalText:t.value})}}else{const A=C.value;if(A&&s.value.length>0){const de=A.selectionStart||s.value.length,Pe=A.selectionEnd||s.value.length,Ue=s.value;de===Pe&&de>0?(s.value=Ue.slice(0,de-1)+Ue.slice(Pe),ct(()=>{A.selectionStart=A.selectionEnd=de-1,A.focus()})):de!==Pe&&(s.value=Ue.slice(0,de)+Ue.slice(Pe),ct(()=>{A.selectionStart=A.selectionEnd=de,A.focus()})),o("update",{translatedText:s.value})}}}async function Ye(){try{const we=await Yo();if(we.fonts){const A=[],de=[];for(const Pe of we.fonts){const Ue={name:typeof Pe=="string"?Pe:Pe.display_name||Pe.file_name||"",path:typeof Pe=="string"?Pe:Pe.path};Ue.path.startsWith("fonts/")?A.push(Ue):de.push(Ue)}A.length>0&&(P.value=A),B.value=de}}catch(we){console.error("加载字体列表失败:",we)}}return ut(()=>{Ye()}),(we,A)=>(V(),J("div",$g,[e("div",Tg,[e("div",{class:"text-column-header"},[A[13]||(A[13]=e("span",{class:"column-title"},"🇯🇵 日语原文 (OCR结果)",-1)),e("button",{class:"re-ocr-btn",onClick:$e,title:"重新OCR此气泡"},"🔄")]),ie(e("textarea",{ref_key:"originalTextInput",ref:l,"onUpdate:modelValue":A[0]||(A[0]=de=>t.value=de),class:"text-editor original-editor",placeholder:"OCR识别的日语原文...",spellcheck:"false",onInput:y},null,544),[[Ae,t.value]]),e("div",{class:"text-actions"},[e("button",{class:"copy-btn",onClick:se},"📋 复制"),e("button",{class:"keyboard-toggle-btn",onClick:Te,title:"显示/隐藏50音键盘"}," ⌨️ 50音 ")]),Re(wg,{visible:ge.value,"default-target":j.value,onClose:A[1]||(A[1]=de=>ge.value=!1),onInsert:Ce,onDelete:Ee},null,8,["visible","default-target"])]),e("div",Ig,[e("div",{class:"text-column-header"},[A[14]||(A[14]=e("span",{class:"column-title"},"🇨🇳 中文译文",-1)),e("button",{class:"re-translate-btn",onClick:_e,title:"重新翻译此气泡"}," 🔄 ")]),ie(e("textarea",{ref_key:"translatedTextInput",ref:C,"onUpdate:modelValue":A[2]||(A[2]=de=>s.value=de),class:"text-editor translated-editor",placeholder:"翻译后的中文...",spellcheck:"false",onInput:ee},null,544),[[Ae,s.value]]),e("div",{class:"text-actions"},[e("button",{class:"copy-btn",onClick:f},"📋 复制"),e("button",{class:"apply-text-btn",onClick:ce},"✓ 应用文本")])]),e("div",Dg,[e("div",Rg,[e("div",Mg,[e("div",Bg,[A[15]||(A[15]=e("label",null,"字体",-1)),Re(We,{modelValue:E.value,"onUpdate:modelValue":A[3]||(A[3]=de=>E.value=de),groups:D.value,title:"字体",onChange:W},null,8,["modelValue","groups"])]),e("div",Eg,[A[16]||(A[16]=e("label",null,"字号",-1)),e("div",Pg,[ie(e("input",{type:"number","onUpdate:modelValue":A[4]||(A[4]=de=>_.value=de),class:"toolbar-fontsize-input",min:fe(Fn),max:fe(An),step:fe(Xt),title:"字号",onChange:w},null,40,Ag),[[Ae,_.value,void 0,{number:!0}]]),e("div",{class:"toolbar-fontsize-btns"},[e("button",{class:"toolbar-fontsize-btn",onClick:F,title:"增大字号"}," A+ "),e("button",{class:"toolbar-fontsize-btn",onClick:ve,title:"减小字号"}," A- ")])])])]),e("div",Fg,[e("div",Lg,[e("button",{class:"toolbar-btn","data-active":T.value==="vertical",onClick:A[5]||(A[5]=de=>Y("vertical")),title:"竖向排版"},[...A[17]||(A[17]=[e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("path",{d:"M8 2v12M8 2L5 5M8 2l3 3",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])],8,Ug),e("button",{class:"toolbar-btn","data-active":T.value==="horizontal",onClick:A[6]||(A[6]=de=>Y("horizontal")),title:"横向排版"},[...A[18]||(A[18]=[e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("path",{d:"M2 8h12M14 8l-3-3M14 8l-3 3",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])],8,Og)]),A[24]||(A[24]=e("div",{class:"toolbar-divider vertical"},null,-1)),e("div",zg,[e("div",Vg,[e("button",{class:"toolbar-btn toolbar-color-btn",onClick:me},[A[19]||(A[19]=e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("text",{x:"3",y:"11","font-size":"10","font-weight":"bold",fill:"currentColor"},"A")],-1)),e("span",{class:"color-indicator",style:it({background:N.value})},null,4)]),ie(e("input",{ref_key:"textColorInput",ref:x,type:"color","onUpdate:modelValue":A[7]||(A[7]=de=>N.value=de),class:"hidden-color-input",onChange:g},null,544),[[Ae,N.value]])])]),A[25]||(A[25]=e("div",{class:"toolbar-divider vertical"},null,-1)),e("div",Ng,[Re(We,{modelValue:X.value,"onUpdate:modelValue":A[8]||(A[8]=de=>X.value=de),options:I,onChange:ae},null,8,["modelValue"]),e("div",{class:Le(["toolbar-color-picker toolbar-solid-color-options",{hidden:X.value!=="solid"}])},[e("button",{class:"toolbar-btn toolbar-color-btn",onClick:v},[A[20]||(A[20]=e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("rect",{x:"2",y:"2",width:"12",height:"12",rx:"2",fill:"none",stroke:"currentColor","stroke-width":"1.2"}),e("rect",{x:"4",y:"4",width:"8",height:"8",rx:"1",fill:"currentColor",opacity:"0.3"})],-1)),e("span",{class:"color-indicator",style:it({background:oe.value})},null,4)]),ie(e("input",{ref_key:"fillColorInput",ref:O,type:"color","onUpdate:modelValue":A[9]||(A[9]=de=>oe.value=de),class:"hidden-color-input",onChange:M},null,544),[[Ae,oe.value]])],2)]),A[26]||(A[26]=e("div",{class:"toolbar-divider vertical"},null,-1)),e("div",Wg,[e("button",{class:"toolbar-btn","data-active":ne.value,onClick:le,title:"文字描边"},[...A[21]||(A[21]=[e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("text",{x:"3",y:"12","font-size":"11","font-weight":"bold",stroke:"currentColor","stroke-width":"2",fill:"none"}," A "),e("text",{x:"3",y:"12","font-size":"11","font-weight":"bold",fill:"currentColor"},"A")],-1)])],8,Kg),e("div",{class:Le(["toolbar-color-picker toolbar-stroke-options",{hidden:!ne.value}]),title:"描边颜色"},[e("button",{class:"toolbar-btn toolbar-color-btn",onClick:R},[A[22]||(A[22]=e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("circle",{cx:"8",cy:"8",r:"5",fill:"none",stroke:"currentColor","stroke-width":"2"})],-1)),e("span",{class:"color-indicator",style:it({background:G.value})},null,4)]),ie(e("input",{ref_key:"strokeColorInput",ref:Q,type:"color","onUpdate:modelValue":A[10]||(A[10]=de=>G.value=de),class:"hidden-color-input",onChange:U},null,544),[[Ae,G.value]])],2),e("div",{class:Le(["toolbar-stroke-width toolbar-stroke-options",{hidden:!ne.value}]),title:"描边宽度"},[ie(e("input",{type:"number","onUpdate:modelValue":A[11]||(A[11]=de=>$.value=de),class:"toolbar-mini-input",min:"0",max:"10",onChange:re},null,544),[[Ae,$.value,void 0,{number:!0}]]),A[23]||(A[23]=e("span",{class:"toolbar-unit"},"px",-1))],2)])]),e("div",qg,[e("div",Hg,[e("button",{class:"toolbar-btn",onClick:b,title:"逆时针旋转"},[...A[27]||(A[27]=[e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("path",{d:"M2 8a6 6 0 1 1 1.5 4",stroke:"currentColor","stroke-width":"1.5",fill:"none"}),e("path",{d:"M2 5v3.5h3.5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),ie(e("input",{type:"number","onUpdate:modelValue":A[12]||(A[12]=de=>Z.value=de),class:"toolbar-mini-input toolbar-rotation-input",min:"-180",max:"180",step:"5",onChange:S},null,544),[[Ae,Z.value,void 0,{number:!0}]]),A[29]||(A[29]=e("span",{class:"toolbar-unit"},"°",-1)),e("button",{class:"toolbar-btn",onClick:L,title:"顺时针旋转"},[...A[28]||(A[28]=[e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("path",{d:"M14 8a6 6 0 1 0-1.5 4",stroke:"currentColor","stroke-width":"1.5",fill:"none"}),e("path",{d:"M14 5v3.5h-3.5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),e("button",{class:"toolbar-btn toolbar-small-btn",onClick:z,title:"重置旋转"}," 0 ")]),A[35]||(A[35]=e("div",{class:"toolbar-divider vertical"},null,-1)),e("div",Jg,[e("button",{class:"toolbar-btn",onClick:H,title:"左移"},[...A[30]||(A[30]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("path",{d:"M10 3L5 8l5 5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),e("button",{class:"toolbar-btn",onClick:xe,title:"右移"},[...A[31]||(A[31]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("path",{d:"M6 3l5 5-5 5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),e("button",{class:"toolbar-btn",onClick:he,title:"上移"},[...A[32]||(A[32]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("path",{d:"M3 10l5-5 5 5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),e("button",{class:"toolbar-btn",onClick:be,title:"下移"},[...A[33]||(A[33]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("path",{d:"M3 6l5 5 5-5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),e("span",Yg,[e("span",null,ye(k.value),1),A[34]||(A[34]=Ne(",",-1)),e("span",null,ye(m.value),1)]),e("button",{class:"toolbar-btn toolbar-small-btn",onClick:Se,title:"重置位置"}," ⌂ ")])])]),e("details",Xg,[A[36]||(A[36]=e("summary",null,"字号预设",-1)),e("div",jg,[(V(!0),J(Ze,null,et(fe(Bo),de=>(V(),J("button",{key:de,class:Le(["preset-btn",{active:_.value===de}]),onClick:Pe=>c(de)},ye(de),11,Gg))),128))])]),e("div",{class:"edit-action-buttons"},[e("button",{class:"btn-apply",onClick:ce},"应用"),e("button",{class:"btn-apply-all",onClick:De},"应用全部"),e("button",{class:"btn-reset",onClick:ke},"重置")])])]))}}),Qg=je(Zg,[["__scopeId","data-v-75af88de"]]),eb={class:"edit-toolbar-wrapper"},tb={class:"edit-toolbar toolbar-row-1"},nb={class:"image-navigator"},ob=["disabled"],ab=["disabled"],sb={class:"bubble-navigator"},lb=["disabled"],ib={class:"bubble-indicator"},rb={id:"currentBubbleNum"},ub={id:"totalBubbleNum"},cb=["disabled"],db={class:"view-controls"},gb={key:0,viewBox:"0 0 20 20",width:"16",height:"16"},bb={key:1,viewBox:"0 0 20 20",width:"16",height:"16"},pb={id:"zoomLevel"},vb={class:"edit-toolbar toolbar-row-2"},mb={class:"annotation-tools"},fb=["disabled"],hb=["disabled"],yb={key:0,class:"brush-size-indicator"},xb={key:1,class:"brush-mode-hint"},Sb={class:"edit-progress-info"},kb={class:"edit-progress-text"},_b={class:"edit-progress-count"},Cb={class:"edit-progress-bar"},wb={class:"quick-actions"},$b=Ge({__name:"EditToolbar",props:{currentImageIndex:{},imageCount:{},canGoPrevious:{type:Boolean},canGoNext:{type:Boolean},showThumbnails:{type:Boolean},hasBubbles:{type:Boolean},selectedBubbleIndex:{},bubbleCount:{},layoutMode:{},syncEnabled:{type:Boolean},scale:{},isDrawingMode:{type:Boolean},hasSelection:{type:Boolean},brushMode:{},brushSize:{},mouseX:{},mouseY:{},isProcessing:{type:Boolean},progressText:{},progressCurrent:{},progressTotal:{}},emits:["go-previous-image","go-next-image","toggle-thumbnails","select-previous-bubble","select-next-bubble","toggle-layout","toggle-view-mode","toggle-sync","fit-to-screen","zoom-in","zoom-out","reset-zoom","exit-edit-mode","auto-detect-bubbles","detect-all-images","translate-with-bubbles","toggle-drawing-mode","delete-selected-bubbles","repair-selected-bubble","activate-repair-brush","activate-restore-brush","apply-and-next"],setup(n){const r=n,u=te(()=>r.progressTotal===0?0:Math.round(r.progressCurrent/r.progressTotal*100)),o=te(()=>r.progressTotal>0&&r.progressCurrent>=r.progressTotal),a=te(()=>{const i=r.brushMode==="repair"?{fill:"rgba(76, 175, 80, 0.4)",border:"#4CAF50"}:{fill:"rgba(33, 150, 243, 0.4)",border:"#2196F3"};return{position:"fixed",left:`${r.mouseX}px`,top:`${r.mouseY}px`,width:`${r.brushSize}px`,height:`${r.brushSize}px`,borderRadius:"50%",border:`2px solid ${i.border}`,backgroundColor:i.fill,pointerEvents:"none",zIndex:99999,transform:"translate(-50%, -50%)",display:r.brushMode?"block":"none"}});return(i,t)=>(V(),J("div",eb,[e("div",tb,[e("div",nb,[e("button",{class:"nav-btn",disabled:!n.canGoPrevious,onClick:t[0]||(t[0]=s=>i.$emit("go-previous-image")),title:"上一张图片 (PageUp)"}," ◀◀ ",8,ob),e("span",{class:"image-indicator",onClick:t[1]||(t[1]=s=>i.$emit("toggle-thumbnails")),title:"点击展开缩略图"},[t[23]||(t[23]=Ne(" 图 ",-1)),e("span",null,ye(n.currentImageIndex+1),1),t[24]||(t[24]=Ne(" / ",-1)),e("span",null,ye(n.imageCount),1)]),e("button",{class:"nav-btn",disabled:!n.canGoNext,onClick:t[2]||(t[2]=s=>i.$emit("go-next-image")),title:"下一张图片 (PageDown)"}," ▶▶ ",8,ab),e("button",{class:Le(["thumb-toggle-btn",{active:n.showThumbnails}]),onClick:t[3]||(t[3]=s=>i.$emit("toggle-thumbnails")),title:"显示/隐藏缩略图"}," ☷ ",2)]),t[30]||(t[30]=e("div",{class:"toolbar-divider"},null,-1)),e("div",sb,[e("button",{id:"prevBubbleBtn",class:"nav-btn",disabled:!n.hasBubbles||n.selectedBubbleIndex<=0,onClick:t[4]||(t[4]=s=>i.$emit("select-previous-bubble")),title:"上一个气泡 (←)"}," ◀ ",8,lb),e("span",ib,[t[25]||(t[25]=Ne(" 气泡 ",-1)),e("span",rb,ye(n.selectedBubbleIndex>=0?n.selectedBubbleIndex+1:0),1),t[26]||(t[26]=Ne(" / ",-1)),e("span",ub,ye(n.bubbleCount),1)]),e("button",{id:"nextBubbleBtn",class:"nav-btn",disabled:!n.hasBubbles||n.selectedBubbleIndex>=n.bubbleCount-1,onClick:t[5]||(t[5]=s=>i.$emit("select-next-bubble")),title:"下一个气泡 (→)"}," ▶ ",8,cb)]),t[31]||(t[31]=e("div",{class:"toolbar-divider"},null,-1)),e("div",db,[e("button",{class:"layout-toggle-btn",onClick:t[6]||(t[6]=s=>i.$emit("toggle-layout")),title:"切换布局：左右/上下"},[n.layoutMode==="horizontal"?(V(),J("svg",gb,[...t[27]||(t[27]=[e("rect",{x:"1",y:"2",width:"8",height:"16",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"},null,-1),e("rect",{x:"11",y:"2",width:"8",height:"16",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"},null,-1)])])):(V(),J("svg",bb,[...t[28]||(t[28]=[e("rect",{x:"2",y:"1",width:"16",height:"8",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"},null,-1),e("rect",{x:"2",y:"11",width:"16",height:"8",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"},null,-1)])]))]),e("button",{class:"view-mode-btn",onClick:t[7]||(t[7]=s=>i.$emit("toggle-view-mode")),title:"切换视图模式"},[...t[29]||(t[29]=[e("span",{class:"dual-icon"},"⧉",-1)])]),e("button",{class:Le({active:n.syncEnabled}),onClick:t[8]||(t[8]=s=>i.$emit("toggle-sync")),title:"同步缩放/拖动",style:{"font-size":"12px"}}," 🔗 ",2),e("button",{onClick:t[9]||(t[9]=s=>i.$emit("fit-to-screen")),title:"适应屏幕 (双击)"},"⛶"),e("button",{onClick:t[10]||(t[10]=s=>i.$emit("zoom-in")),title:"放大 (+)"},"+"),e("span",pb,ye(Math.round(n.scale*100))+"%",1),e("button",{onClick:t[11]||(t[11]=s=>i.$emit("zoom-out")),title:"缩小 (-)"},"−"),e("button",{onClick:t[12]||(t[12]=s=>i.$emit("reset-zoom")),title:"原始大小"},"1:1")]),t[32]||(t[32]=e("div",{class:"toolbar-spacer"},null,-1)),e("button",{class:"secondary-btn",onClick:t[13]||(t[13]=s=>i.$emit("exit-edit-mode"))},"退出编辑")]),e("div",vb,[e("div",mb,[e("button",{class:"annotation-btn detect-btn",onClick:t[14]||(t[14]=s=>i.$emit("auto-detect-bubbles")),title:"自动检测当前图片的文本框"},[...t[33]||(t[33]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("circle",{cx:"6",cy:"6",r:"4",fill:"none",stroke:"currentColor","stroke-width":"1.5"}),e("path",{d:"M9 9l4 4",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round"})],-1),e("span",null,"检测",-1)])]),e("button",{class:"annotation-btn detect-btn",onClick:t[15]||(t[15]=s=>i.$emit("detect-all-images")),title:"批量检测所有图片"},[...t[34]||(t[34]=[Qt('<svg viewBox="0 0 16 16" width="14" height="14" data-v-b7164359><circle cx="5" cy="5" r="2.5" fill="none" stroke="currentColor" stroke-width="1" data-v-b7164359></circle><path d="M7 7l2 2" stroke="currentColor" stroke-width="1" stroke-linecap="round" data-v-b7164359></path><circle cx="10" cy="10" r="2.5" fill="none" stroke="currentColor" stroke-width="1" data-v-b7164359></circle><path d="M12 12l2 2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" data-v-b7164359></path></svg><span data-v-b7164359>批量检测</span>',2)])]),e("button",{class:"annotation-btn primary-action-btn",onClick:t[16]||(t[16]=s=>i.$emit("translate-with-bubbles")),title:"使用当前文本框翻译此图片"},[...t[35]||(t[35]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("path",{d:"M2 3h5M4.5 3v7M2 6h5",stroke:"currentColor","stroke-width":"1.2",fill:"none"}),e("path",{d:"M9 13l2-7 2 7M9.5 11h3",stroke:"currentColor","stroke-width":"1.2",fill:"none"})],-1),e("span",null,"翻译",-1)])]),t[41]||(t[41]=e("div",{class:"toolbar-divider"},null,-1)),e("button",{class:Le(["annotation-btn",{active:n.isDrawingMode}]),onClick:t[17]||(t[17]=s=>i.$emit("toggle-drawing-mode")),title:"添加气泡框（或中键拖拽绘制）"},[...t[36]||(t[36]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("rect",{x:"3",y:"3",width:"10",height:"10",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"}),e("path",{d:"M8 5v6M5 8h6",stroke:"currentColor","stroke-width":"1.5"})],-1),e("span",null,"添加",-1)])],2),e("button",{class:"annotation-btn",disabled:!n.hasSelection,onClick:t[18]||(t[18]=s=>i.$emit("delete-selected-bubbles")),title:"删除选中气泡框 (Delete)"},[...t[37]||(t[37]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("rect",{x:"3",y:"3",width:"10",height:"10",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"}),e("path",{d:"M5 8h6",stroke:"currentColor","stroke-width":"1.5"})],-1),e("span",null,"删除",-1)])],8,fb),e("button",{class:"annotation-btn",disabled:!n.hasSelection,onClick:t[19]||(t[19]=s=>i.$emit("repair-selected-bubble")),title:"修复选中气泡背景 (R)"},[...t[38]||(t[38]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("path",{d:"M2 14l3-3m0 0l6-6 3 3-6 6m-3 0l-1 1 1-1z",fill:"none",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round"}),e("path",{d:"M11 5l-1-1 2-2 2 2-2 2-1-1z",fill:"currentColor"})],-1),e("span",null,"修复",-1)])],8,hb),t[42]||(t[42]=e("div",{class:"toolbar-divider"},null,-1)),e("button",{class:Le(["annotation-btn brush-btn",{active:n.brushMode==="repair"}]),onClick:t[20]||(t[20]=s=>i.$emit("activate-repair-brush")),title:"修复笔刷 (按住R+左键拖拽)"},[...t[39]||(t[39]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("circle",{cx:"8",cy:"8",r:"5",fill:"none",stroke:"currentColor","stroke-width":"1.5"}),e("circle",{cx:"8",cy:"8",r:"2",fill:"currentColor"})],-1),e("span",null,"修复笔刷",-1)])],2),e("button",{class:Le(["annotation-btn brush-btn",{active:n.brushMode==="restore"}]),onClick:t[21]||(t[21]=s=>i.$emit("activate-restore-brush")),title:"还原笔刷 (按住U+左键拖拽)"},[...t[40]||(t[40]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("circle",{cx:"8",cy:"8",r:"5",fill:"none",stroke:"currentColor","stroke-width":"1.5"}),e("path",{d:"M5 8h6M8 5v6",stroke:"currentColor","stroke-width":"1",transform:"rotate(45 8 8)"})],-1),e("span",null,"还原笔刷",-1)])],2),n.brushMode?(V(),J("span",yb," 笔刷: "+ye(n.brushSize)+"px ",1)):Me("",!0),t[43]||(t[43]=Qt('<div class="help-tooltip-container" data-v-b7164359><button class="help-tooltip-btn" title="快捷键操作帮助" data-v-b7164359><svg viewBox="0 0 16 16" width="14" height="14" data-v-b7164359><circle cx="8" cy="8" r="6.5" fill="none" stroke="currentColor" stroke-width="1.2" data-v-b7164359></circle><text x="8" y="11" text-anchor="middle" font-size="9" font-weight="bold" fill="currentColor" data-v-b7164359>?</text></svg><span class="help-btn-text" data-v-b7164359>快捷键</span></button><div class="help-tooltip-popup" data-v-b7164359><div class="help-section" data-v-b7164359><div class="help-title" data-v-b7164359>🖱️ 鼠标操作</div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>左键点击气泡</span><span class="help-desc" data-v-b7164359>选择气泡</span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>Shift+左键点击</span><span class="help-desc" data-v-b7164359>多选气泡</span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>左键拖拽四角/边</span><span class="help-desc" data-v-b7164359>调整大小</span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>左键拖拽框内部</span><span class="help-desc" data-v-b7164359>移动气泡框</span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>中键拖拽</span><span class="help-desc" data-v-b7164359>绘制新气泡框</span></div></div><div class="help-section" data-v-b7164359><div class="help-title" data-v-b7164359>⌨️ 快捷键</div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>A / D</span><span class="help-desc" data-v-b7164359>切换上/下一张图片</span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>Ctrl+Enter</span><span class="help-desc" data-v-b7164359>应用并跳转下一张</span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>Delete / Backspace</span><span class="help-desc" data-v-b7164359>删除选中气泡</span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>按住R+左键拖拽</span><span class="help-desc" data-v-b7164359>修复笔刷</span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>按住U+左键拖拽</span><span class="help-desc" data-v-b7164359>还原笔刷</span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>笔刷模式下滚轮</span><span class="help-desc" data-v-b7164359>调整笔刷大小</span></div></div></div></div>',1))]),n.brushMode?(V(),J("div",{key:0,class:"brush-cursor",style:it(a.value)},null,4)):Me("",!0),n.brushMode?(V(),J("div",xb,ye(n.brushMode==="repair"?"修复笔刷 (R)":"还原笔刷 (U)")+" - 滚轮调整大小 ",1)):Me("",!0),n.isProcessing?(V(),J("div",{key:2,class:Le(["edit-progress-container",{completed:o.value}])},[e("div",Sb,[e("span",kb,ye(n.progressText),1),e("span",_b,ye(n.progressCurrent)+"/"+ye(n.progressTotal),1)]),e("div",Cb,[e("div",{class:Le(["edit-progress-fill",{animating:!o.value}]),style:it({width:u.value+"%"})},null,6)])],2)):Me("",!0),t[44]||(t[44]=e("div",{class:"toolbar-spacer"},null,-1)),e("div",wb,[e("button",{class:"primary-btn",onClick:t[22]||(t[22]=s=>i.$emit("apply-and-next")),title:"应用更改并跳转下一张 (Ctrl+Enter)"}," 应用并下一张 ")])])]))}}),Tb=je($b,[["__scopeId","data-v-b7164359"]]),Ib={key:0,class:"edit-thumbnails-panel"},Db={class:"thumbnails-scroll"},Rb=["onClick"],Mb=["src","alt"],Bb={class:"thumb-index"},Eb=Ge({__name:"EditThumbnailPanel",props:{visible:{type:Boolean},images:{},currentImageIndex:{}},emits:["switch-to-image"],setup(n){return(r,u)=>n.visible?(V(),J("div",Ib,[e("div",Db,[(V(!0),J(Ze,null,et(n.images,(o,a)=>(V(),J("div",{key:o.id,class:Le(["edit-thumbnail-item",{active:a===n.currentImageIndex}]),onClick:i=>r.$emit("switch-to-image",a)},[e("img",{src:o.translatedDataURL||o.originalDataURL,alt:`图片 ${a+1}`},null,8,Mb),e("span",Bb,ye(a+1),1)],10,Rb))),128))])])):Me("",!0)}}),Pb=je(Eb,[["__scopeId","data-v-9d2a43d9"]]),Ab={class:"edit-main-layout"},Fb={class:"image-comparison-container"},Lb={class:"panel-header"},Ub=["src"],Ob={class:"panel-header"},zb=["src"],Vb=Ge({__name:"EditWorkspace",props:{isEditModeActive:{type:Boolean}},emits:["exit"],setup(n,{emit:r}){const u=n,o=r,a=st(),i=gt(),{translateWithCurrentBubbles:t}=gn(),{reRenderFullImage:s}=zd({onRenderStart:()=>console.log("开始重新渲染..."),onRenderSuccess:K=>console.log("渲染成功:",K.substring(0,50)+"..."),onRenderError:K=>console.error("渲染失败:",K)}),{isDrawingMode:_,isDrawingBox:E,currentDrawingRect:T,isMiddleButtonDown:N,handleBubbleSelect:oe,handleBubbleMultiSelect:ne,handleClearMultiSelect:G,handleBubbleDragStart:$,handleBubbleDragging:Z,handleBubbleDragEnd:X,handleBubbleResizeStart:q,handleBubbleResizing:d,handleBubbleResizeEnd:l,handleBubbleRotateStart:C,handleBubbleRotating:x,handleBubbleRotateEnd:O,toggleDrawingMode:Q,handleDrawBubble:ge,getDrawingRectStyle:j,handleBubbleUpdate:P,deleteSelectedBubbles:B,repairSelectedBubble:k,handleOcrRecognize:m}=Od({onReRender:()=>s(),onDelayedPreview:()=>s()}),D=h(0),I=h(0),{brushMode:p,brushSize:y,mouseX:ee,mouseY:se,isBrushKeyDown:f,toggleBrushMode:w,exitBrushMode:c,startBrushPainting:F,continueBrushPainting:ve,finishBrushPainting:W,adjustBrushSize:Y}=Ld({onBrushComplete:()=>s(),getCurrentRepairSettings:()=>({inpaintMethod:we.value,fillColor:A.value})}),{images:me,currentImageIndex:g,currentImage:v,imageCount:M,canGoPrevious:R,canGoNext:U}=xt(a),{bubbles:le,selectedIndex:re,selectedIndices:ae,selectedBubble:S,bubbleCount:b,hasBubbles:L,hasSelection:z}=xt(i),H=te(()=>Se.value?.querySelector("img")?.naturalWidth||2e3),xe=te(()=>Se.value?.querySelector("img")?.naturalHeight||2e3),he=h(null),be=h(null),Se=h(null),ce=h(null),De=h(null),ke=h(null),$e=h("dual"),_e=h("horizontal"),Te=h(!1),Ce=h(!0),Ee=h(!1),Ye=h(!1),we=h("solid"),A=h("#FFFFFF"),de=h(!1),Pe=h("处理中..."),Ue=h(0),ot=h(0),Xe=Kn(),He=Kn(),mt=te(()=>He.scale.value),Pt=te(()=>He.translateX.value),At=te(()=>He.translateY.value),to=te(()=>Xe.scale.value),ft=h(null),no=te(()=>({transform:`translate(${Xe.translateX.value}px, ${Xe.translateY.value}px) scale(${Xe.scale.value})`})),oo=te(()=>({transform:`translate(${He.translateX.value}px, ${He.translateY.value}px) scale(${He.scale.value})`}));function bn(){He.zoomIn(),Ce.value&&Xe.setTransform(He.getTransform())}function pn(){He.zoomOut(),Ce.value&&Xe.setTransform(He.getTransform())}function vn(){He.resetZoom(),Ce.value&&Xe.setTransform(He.getTransform())}const Ft=h(!1),ao=h(0),Lt=h(!1),Ct=h({x:0,y:0,size:0});function Ut(){p.value&&c(),Vt()}function Ot(){i.bubbles.length>0&&i.selectBubble(0)}function mn(){R.value&&(Ut(),a.goToPrevious())}function zt(){U.value&&(Ut(),a.goToNext())}function so(K){K!==g.value&&K>=0&&K<M.value&&(Ut(),a.setCurrentImageIndex(K))}function Vt(){if(!v.value)return;const K=Array.isArray(v.value.bubbleStates);le.value.length>0?(a.updateCurrentBubbleStates([...le.value]),a.setManuallyAnnotated(!0),console.log("已保存气泡状态到当前图片，标记为手动标注")):K&&(a.updateCurrentBubbleStates([]),a.setManuallyAnnotated(!0),console.log("已保存空气泡状态到当前图片（用户主动清空，标记为手动标注）"))}function wt(){v.value?.bubbleStates?(i.setBubbles([...v.value.bubbleStates],!0),console.log(`已加载 ${v.value.bubbleStates.length} 个气泡状态`)):i.clearBubblesLocal(),Ot()}function lo(){i.selectPrevious()}function io(){i.selectNext()}function ro(){Te.value=!Te.value}function uo(){_e.value=_e.value==="horizontal"?"vertical":"horizontal";try{localStorage.setItem(Ln,_e.value)}catch(K){console.warn("保存布局模式失败:",K)}setTimeout(()=>{$t()},300)}function co(){const K=["dual","original","translated"],ue=K.indexOf($e.value),pe=K[(ue+1)%K.length];pe&&($e.value=pe)}function go(){Ce.value=!Ce.value,console.log("双图同步:",Ce.value?"开启":"关闭"),Ce.value&&Xe.setTransform(He.getTransform())}function $t(){const K=ce.value||be.value,ue=De.value||Se.value;if(!K||!ue)return;const pe=ue.querySelector("img");if(!pe||!pe.naturalWidth)return;const Je=K.getBoundingClientRect(),ze=Je.width/pe.naturalWidth,Fe=Je.height/pe.naturalHeight,Ve=Math.min(ze,Fe)*.95,Oe=(Je.width-pe.naturalWidth*Ve)/2,vt=(Je.height-pe.naturalHeight*Ve)/2,ht={scale:Ve,translateX:Oe,translateY:vt};He.setTransform(ht),Xe.setTransform(ht)}function fn(K,ue){if(p.value){const Oe=K.deltaY>0?-5:5;Y(Oe);return}const pe=K.currentTarget.getBoundingClientRect(),Je=K.clientX-pe.left,ze=K.clientY-pe.top,Fe=K.deltaY>0?.9:1.1,Ve=ue==="original"?Xe:He;Ve.zoomAt(Je,ze,Fe),Ce.value&&(ue==="original"?He:Xe).setTransform(Ve.getTransform())}function hn(K,ue){if(p.value){const pe=ue==="original"?be.value:ce.value;pe&&F(K,pe);return}if(K.button===1){N.value=!0,Sn(K,ue),K.preventDefault();return}if(_.value&&K.button===0){Sn(K,ue),K.preventDefault();return}if(K.button===0){if(K.target.closest(".bubble-highlight-box"))return;K.shiftKey||G(),ft.value=ue,(ue==="original"?Xe:He).startDrag(K.clientX,K.clientY),document.addEventListener("mousemove",yn),document.addEventListener("mouseup",xn),K.preventDefault()}}function yn(K){if(!ft.value)return;const ue=ft.value==="original"?Xe:He;ue.drag(K.clientX,K.clientY),Ce.value&&(ft.value==="original"?He:Xe).setTransform(ue.getTransform())}function xn(){ft.value&&(ft.value==="original"?Xe:He).endDrag(),ft.value=null,document.removeEventListener("mousemove",yn),document.removeEventListener("mouseup",xn)}let Nt="translated";function Sn(K,ue="translated"){Nt=ue;const pe=ue==="original"?Se.value:De.value,Je=ue==="original"?Xe:He;if(!pe)return;const ze=pe.getBoundingClientRect(),Fe=(K.clientX-ze.left)/Je.scale.value,Ve=(K.clientY-ze.top)/Je.scale.value;D.value=Fe,I.value=Ve,E.value=!0,T.value=[Fe,Ve,Fe,Ve],document.addEventListener("mousemove",Wt),document.addEventListener("mouseup",Kt)}function Wt(K){if(!E.value)return;const ue=Nt==="original"?Se.value:De.value,pe=Nt==="original"?Xe:He;if(!ue)return;const Je=ue.getBoundingClientRect(),ze=(K.clientX-Je.left)/pe.scale.value,Fe=(K.clientY-Je.top)/pe.scale.value;T.value=[Math.min(D.value,ze),Math.min(I.value,Fe),Math.max(D.value,ze),Math.max(I.value,Fe)]}function Kt(K){document.removeEventListener("mousemove",Wt),document.removeEventListener("mouseup",Kt);const ue=N.value;if(!E.value||!T.value){E.value=!1,T.value=null,N.value=!1;return}const[pe,Je,ze,Fe]=T.value,Ve=ze-pe,Oe=Fe-Je;Ve>10&&Oe>10&&(i.addBubble(T.value),i.selectBubble(i.bubbleCount-1),console.log("已添加新气泡:",T.value)),E.value=!1,T.value=null,N.value=!1,!ue&&_.value&&(_.value=!1)}function kn(K){console.log(`${K} 图片加载完成`),mt.value===1&&Pt.value===0&&At.value===0&&ct(()=>{$t()})}function bo(){s()}function po(K){K.inpaintMethod!==void 0&&(we.value=K.inpaintMethod),K.fillColor!==void 0&&(A.value=K.fillColor),re.value>=0&&P(K)}function vo(K){Ie("文本已应用","success"),s()}function mo(K){const ue=i.initialStates[K];if(!ue){console.warn(`无法重置气泡 #${K+1}：找不到初始状态`),Ie("无法重置：找不到初始状态","warning");return}const pe=JSON.parse(JSON.stringify(ue));i.updateBubble(K,pe),console.log(`气泡 #${K+1} 已重置到初始状态`),Ie("气泡已重置","success"),s()}async function fo(K){const ue=le.value[K];if(!ue?.originalText){console.warn("无法重新翻译：缺少气泡或原文");return}try{console.log(`开始重新翻译气泡 #${K+1}`);const{translateSingleText:pe}=await lt(async()=>{const{translateSingleText:Ve}=await Promise.resolve().then(()=>Go);return{translateSingleText:Ve}},void 0),{useSettingsStore:Je}=await lt(async()=>{const{useSettingsStore:Ve}=await import("./index.CnztCBXu.js").then(Oe=>Oe.q);return{useSettingsStore:Ve}},__vite__mapDeps([0,1,2])),ze=Je().settings,Fe=await pe({original_text:ue.originalText,model_provider:ze.translation.provider,api_key:ze.translation.apiKey,model_name:ze.translation.modelName,custom_base_url:ze.translation.customBaseUrl,target_language:ze.targetLanguage,prompt_content:ze.translatePrompt});Fe.success&&Fe.data?.translated_text?(i.updateBubble(K,{translatedText:Fe.data.translated_text}),console.log(`翻译成功: "${Fe.data.translated_text}"`),s()):console.error("翻译失败:",Fe.error||"未知错误")}catch(pe){console.error("翻译出错:",pe)}}function _n(K,ue){for(K.bubbleTexts||(K.bubbleTexts=[]),K.originalTexts||(K.originalTexts=[]);K.bubbleTexts.length<ue;)K.bubbleTexts.push("");for(;K.originalTexts.length<ue;)K.originalTexts.push("")}function Cn(K,ue,pe){const Je=K.auto_directions||[];return K.bubble_coords.map((ze,Fe)=>{const Ve=ze[0]??0,Oe=ze[1]??0,vt=ze[2]??0,ht=ze[3]??0;let bt;return Je[Fe]?bt=Je[Fe]==="v"?"vertical":"horizontal":bt=ht-Oe>vt-Ve?"vertical":"horizontal",{coords:ze,originalText:ue.originalTexts?.[Fe]||"",translatedText:ue.bubbleTexts?.[Fe]||"",textboxText:"",fontSize:pe.fontSize,fontFamily:pe.fontFamily,textDirection:bt,autoTextDirection:bt,textColor:pe.textColor,fillColor:pe.fillColor,strokeEnabled:pe.strokeEnabled,strokeColor:pe.strokeColor,strokeWidth:pe.strokeWidth,rotationAngle:K.bubble_angles?.[Fe]||0,inpaintMethod:pe.inpaintMethod,position:{x:0,y:0},polygon:[]}})}async function ho(){const K=v.value;if(!K?.originalDataURL){Ie("没有有效的图片用于检测","warning");return}try{Ie("正在自动检测文本框...","info");const pe=K.originalDataURL.match(/^data:image\/[^;]+;base64,(.+)$/)?.[1]||"";if(!pe){Ie("无法解析图片数据","error");return}const Je=Qe(),{textDetector:ze,boxExpand:Fe,textStyle:Ve}=Je.settings,Oe=await tn(pe,ze,{box_expand_ratio:Fe.ratio,box_expand_top:Fe.top,box_expand_bottom:Fe.bottom,box_expand_left:Fe.left,box_expand_right:Fe.right});if(Oe.success&&Oe.bubble_coords){a.updateCurrentImage({bubbleCoords:Oe.bubble_coords,bubbleAngles:Oe.bubble_angles||[]}),_n(K,Oe.bubble_coords.length);const vt={bubble_coords:Oe.bubble_coords.map(bt=>[...bt]),bubble_angles:Oe.bubble_angles,auto_directions:Oe.auto_directions},ht=Cn(vt,K,Ve);i.setBubbles(ht),Ot(),Ie(`自动检测到 ${Oe.bubble_coords.length} 个文本框`,"success")}else Ie(Oe.error||"检测失败","error")}catch(ue){console.error("自动检测失败:",ue),Ie("自动检测失败","error")}}async function yo(){if(me.value.length<=1){Ie("至少需要两张图片才能执行批量检测","warning");return}if(!confirm("此操作将对所有图片进行文本框检测，可能会覆盖已有的检测结果。确定继续吗？"))return;const K=Qe(),{textDetector:ue,boxExpand:pe,textStyle:Je}=K.settings,ze=g.value,Fe=me.value.length;de.value=!0,Pe.value="批量检测中",ot.value=Fe,Ue.value=0;try{let Ve=0;for(let Oe=0;Oe<Fe;Oe++){const vt=me.value[Oe];if(!vt?.originalDataURL)continue;Ue.value=Oe+1;const bt=vt.originalDataURL.match(/^data:image\/[^;]+;base64,(.+)$/)?.[1]||"";if(!bt)continue;const pt=await tn(bt,ue,{box_expand_ratio:pe.ratio,box_expand_top:pe.top,box_expand_bottom:pe.bottom,box_expand_left:pe.left,box_expand_right:pe.right});if(pt.success&&pt.bubble_coords){const St=me.value[Oe];if(St){St.bubbleCoords=pt.bubble_coords,St.bubbleAngles=pt.bubble_angles||[],_n(St,pt.bubble_coords.length);const wo={bubble_coords:pt.bubble_coords.map($o=>[...$o]),bubble_angles:pt.bubble_angles,auto_directions:pt.auto_directions};St.bubbleStates=Cn(wo,St,Je),Ve+=pt.bubble_coords.length,Oe===g.value&&wt()}}}Pe.value="检测完成",Ue.value=Fe,ze!==g.value&&a.setCurrentImageIndex(ze),wt(),Ie(`批量检测完成！共处理 ${Fe} 张图片，检测到 ${Ve} 个文本框`,"success"),setTimeout(()=>{de.value=!1},2e3)}catch(Ve){console.error("批量检测失败:",Ve),Ie("批量检测失败","error"),de.value=!1}}async function xo(){if(!v.value?.originalDataURL){Ie("没有有效的图片用于翻译","warning");return}if(le.value.length===0){Ie("没有文本框可用于翻译，请先检测或添加文本框","warning");return}Ie("正在使用当前文本框翻译...","info");try{await t()&&(Ie("翻译成功！","success"),Ot())}catch(ue){console.error("翻译失败:",ue),Ie(`翻译失败: ${ue instanceof Error?ue.message:"未知错误"}`,"error")}}function So(){w("repair")}function ko(){w("restore")}function wn(K){ve(K)}function $n(){W()}function _o(K){Ft.value=!0,ao.value=_e.value==="horizontal"?K.clientX:K.clientY,document.body.style.cursor=_e.value==="horizontal"?"col-resize":"row-resize",document.body.style.userSelect="none",document.addEventListener("mousemove",qt),document.addEventListener("mouseup",Ht),K.preventDefault()}function qt(K){if(!Ft.value)return;const ue=be.value?.parentElement?.parentElement;if(!ue)return;const pe=ue.getBoundingClientRect();if(_e.value==="horizontal"){const Je=K.clientX-pe.left,ze=pe.width,Fe=Math.max(20,Math.min(80,Je/ze*100)),Ve=ue.querySelector(".original-panel"),Oe=ue.querySelector(".translated-panel");Ve&&Oe&&(Ve.style.flex=`0 0 ${Fe}%`,Oe.style.flex=`0 0 ${100-Fe}%`)}else{const Je=K.clientY-pe.top,ze=pe.height,Fe=Math.max(20,Math.min(80,Je/ze*100)),Ve=ue.querySelector(".original-panel"),Oe=ue.querySelector(".translated-panel");Ve&&Oe&&(Ve.style.flex=`0 0 ${Fe}%`,Oe.style.flex=`0 0 ${100-Fe}%`)}}function Ht(){Ft.value=!1,document.body.style.cursor="",document.body.style.userSelect="",document.removeEventListener("mousemove",qt),document.removeEventListener("mouseup",Ht)}function Co(K){Lt.value=!0;const ue=ke.value;ue&&(Ct.value={x:K.clientX,y:K.clientY,size:_e.value==="horizontal"?ue.offsetWidth:ue.offsetHeight},document.body.style.cursor=_e.value==="horizontal"?"ew-resize":"ns-resize",document.body.style.userSelect="none",document.addEventListener("mousemove",Jt),document.addEventListener("mouseup",Yt),K.preventDefault())}function Jt(K){if(!(!Lt.value||!ke.value))if(_e.value==="horizontal"){const ue=Ct.value.x-K.clientX;let pe=Ct.value.size+ue;pe=Math.max(300,Math.min(window.innerWidth*.6,pe)),ke.value.style.flex=`0 0 ${pe}px`,ke.value.style.minWidth=`${pe}px`}else{const ue=Ct.value.y-K.clientY;let pe=Ct.value.size+ue;pe=Math.max(200,Math.min(window.innerHeight*.5,pe)),ke.value.style.flex=`0 0 ${pe}px`,ke.value.style.height=`${pe}px`}}function Yt(){Lt.value=!1,document.body.style.cursor="",document.body.style.userSelect="",document.removeEventListener("mousemove",Jt),document.removeEventListener("mouseup",Yt)}function Tn(K){const ue=K.target,pe=K.key.toLowerCase();if(pe==="r"||pe==="u"||pe==="a"||pe==="d"){if(ue.tagName==="TEXTAREA")return;(ue.tagName==="INPUT"||ue.tagName==="SELECT"||ue.tagName==="BUTTON")&&ue.blur()}else if(ue.tagName==="INPUT"||ue.tagName==="TEXTAREA"||ue.tagName==="SELECT")return;switch(K.key){case"Escape":Rn();break;case"Delete":case"Backspace":!p.value&&z.value&&(B(),K.preventDefault());break;case"a":case"A":p.value||(mn(),K.preventDefault());break;case"d":case"D":p.value||(zt(),K.preventDefault());break;case"Enter":K.ctrlKey&&!p.value&&(Dn(),K.preventDefault());break;case"r":case"R":f.value||(w("repair"),K.preventDefault());break;case"u":case"U":f.value||(w("restore"),K.preventDefault());break;case"+":case"=":bn(),K.preventDefault();break;case"-":pn(),K.preventDefault();break;case"0":vn(),K.preventDefault();break}}function In(K){(K.key==="r"||K.key==="R"||K.key==="u"||K.key==="U")&&(c(),K.preventDefault())}async function Dn(){Vt(),await s(),U.value?zt():Ie("已是最后一张图片","info")}function Rn(){Vt(),o("exit")}return ut(()=>{try{const K=localStorage.getItem(Ln);(K==="horizontal"||K==="vertical")&&(_e.value=K)}catch(K){console.warn("加载布局模式失败:",K)}document.addEventListener("keydown",Tn),document.addEventListener("keyup",In),document.addEventListener("mousemove",wn),document.addEventListener("mouseup",$n),u.isEditModeActive&&(wt(),ct(()=>{he.value?.focus()}))}),It(()=>{document.removeEventListener("keydown",Tn),document.removeEventListener("keyup",In),document.removeEventListener("mousemove",wn),document.removeEventListener("mouseup",$n),document.removeEventListener("mousemove",Wt),document.removeEventListener("mouseup",Kt),document.removeEventListener("mousemove",qt),document.removeEventListener("mouseup",Ht),document.removeEventListener("mousemove",Jt),document.removeEventListener("mouseup",Yt)}),Be(()=>u.isEditModeActive,K=>{K&&(wt(),ct(()=>{he.value?.focus()}))}),Be(g,()=>{u.isEditModeActive&&wt()}),Be(S,K=>{K&&(we.value=K.inpaintMethod||"solid",A.value=K.fillColor||"#FFFFFF")},{immediate:!0}),(K,ue)=>n.isEditModeActive?(V(),J("div",{key:0,class:Le(["edit-workspace",[`layout-${_e.value}`,{"drawing-mode":fe(_)}]]),tabindex:"0",ref_key:"workspaceRef",ref:he},[Re(Tb,{"current-image-index":fe(g),"image-count":fe(M),"can-go-previous":fe(R),"can-go-next":fe(U),"show-thumbnails":Te.value,"has-bubbles":fe(L),"selected-bubble-index":fe(re),"bubble-count":fe(b),"layout-mode":_e.value,"sync-enabled":Ce.value,scale:mt.value,"is-drawing-mode":fe(_),"has-selection":fe(z),"brush-mode":fe(p),"brush-size":fe(y),"mouse-x":fe(ee),"mouse-y":fe(se),"is-processing":de.value,"progress-text":Pe.value,"progress-current":Ue.value,"progress-total":ot.value,onGoPreviousImage:mn,onGoNextImage:zt,onToggleThumbnails:ro,onSelectPreviousBubble:lo,onSelectNextBubble:io,onToggleLayout:uo,onToggleViewMode:co,onToggleSync:go,onFitToScreen:$t,onZoomIn:bn,onZoomOut:pn,onResetZoom:vn,onExitEditMode:Rn,onAutoDetectBubbles:ho,onDetectAllImages:yo,onTranslateWithBubbles:xo,onToggleDrawingMode:fe(Q),onDeleteSelectedBubbles:fe(B),onRepairSelectedBubble:fe(k),onActivateRepairBrush:So,onActivateRestoreBrush:ko,onApplyAndNext:Dn},null,8,["current-image-index","image-count","can-go-previous","can-go-next","show-thumbnails","has-bubbles","selected-bubble-index","bubble-count","layout-mode","sync-enabled","scale","is-drawing-mode","has-selection","brush-mode","brush-size","mouse-x","mouse-y","is-processing","progress-text","progress-current","progress-total","onToggleDrawingMode","onDeleteSelectedBubbles","onRepairSelectedBubble"]),Re(Pb,{visible:Te.value,images:fe(me),"current-image-index":fe(g),onSwitchToImage:so},null,8,["visible","images","current-image-index"]),e("div",Ab,[e("div",Fb,[ie(e("div",{class:Le(["image-panel original-panel",{collapsed:$e.value==="translated"||Ee.value}])},[e("div",Lb,[ue[8]||(ue[8]=e("span",{class:"panel-title"},"📖 原图 (日文)",-1)),e("button",{class:"panel-toggle",onClick:ue[0]||(ue[0]=pe=>Ee.value=!Ee.value),title:"折叠/展开"},ye(Ee.value?"+":"−"),1)]),e("div",{ref_key:"originalViewportRef",ref:be,class:"image-viewport",onWheel:ue[2]||(ue[2]=nt(pe=>fn(pe,"original"),["prevent"])),onMousedown:ue[3]||(ue[3]=pe=>hn(pe,"original")),onDblclick:$t},[e("div",{ref_key:"originalWrapperRef",ref:Se,class:"image-canvas-wrapper",style:it(no.value)},[fe(v)?.originalDataURL?(V(),J("img",{key:0,src:fe(v).originalDataURL,alt:"原图",onLoad:ue[1]||(ue[1]=pe=>kn("original"))},null,40,Ub)):Me("",!0),fe(v)?.originalDataURL?(V(),rt(qn,{key:1,bubbles:fe(le),"selected-index":fe(re),"selected-indices":fe(ae),scale:to.value,"is-drawing-mode":fe(_),"is-brush-mode":!!fe(p),"image-width":H.value,"image-height":xe.value,onSelect:fe(oe),onMultiSelect:fe(ne),onDragStart:fe($),onDragging:fe(Z),onDragEnd:fe(X),onResizeStart:fe(q),onResizing:fe(d),onResizeEnd:fe(l),onRotateStart:fe(C),onRotating:fe(x),onRotateEnd:fe(O),onDrawBubble:fe(ge)},null,8,["bubbles","selected-index","selected-indices","scale","is-drawing-mode","is-brush-mode","image-width","image-height","onSelect","onMultiSelect","onDragStart","onDragging","onDragEnd","onResizeStart","onResizing","onResizeEnd","onRotateStart","onRotating","onRotateEnd","onDrawBubble"])):Me("",!0),fe(T)?(V(),J("div",{key:2,class:"drawing-rect-edit",style:it(fe(j)())},null,4)):Me("",!0)],4)],544)],2),[[Ke,$e.value!=="translated"]]),$e.value==="dual"?(V(),J("div",{key:0,class:Le(["panel-divider",{"vertical-divider":_e.value==="vertical"}]),onMousedown:_o},null,34)):Me("",!0),ie(e("div",{class:Le(["image-panel translated-panel",{collapsed:$e.value==="original"||Ye.value}])},[e("div",Ob,[ue[9]||(ue[9]=e("span",{class:"panel-title"},"📝 翻译图 (中文)",-1)),e("button",{class:"panel-toggle",onClick:ue[4]||(ue[4]=pe=>Ye.value=!Ye.value),title:"折叠/展开"},ye(Ye.value?"+":"−"),1)]),e("div",{ref_key:"translatedViewportRef",ref:ce,class:"image-viewport",onWheel:ue[6]||(ue[6]=nt(pe=>fn(pe,"translated"),["prevent"])),onMousedown:ue[7]||(ue[7]=pe=>hn(pe,"translated")),onDblclick:$t},[e("div",{ref_key:"translatedWrapperRef",ref:De,class:"image-canvas-wrapper",style:it(oo.value)},[fe(v)?.translatedDataURL||fe(v)?.originalDataURL?(V(),J("img",{key:0,src:fe(v)?.translatedDataURL||fe(v)?.originalDataURL,alt:"翻译图",onLoad:ue[5]||(ue[5]=pe=>kn("translated"))},null,40,zb)):Me("",!0),fe(v)?.translatedDataURL||fe(v)?.originalDataURL?(V(),rt(qn,{key:1,bubbles:fe(le),"selected-index":fe(re),"selected-indices":fe(ae),scale:mt.value,"is-drawing-mode":fe(_),"is-brush-mode":!!fe(p),"image-width":H.value,"image-height":xe.value,onSelect:fe(oe),onMultiSelect:fe(ne),onDragStart:fe($),onDragging:fe(Z),onDragEnd:fe(X),onResizeStart:fe(q),onResizing:fe(d),onResizeEnd:fe(l),onRotateStart:fe(C),onRotating:fe(x),onRotateEnd:fe(O),onDrawBubble:fe(ge)},null,8,["bubbles","selected-index","selected-indices","scale","is-drawing-mode","is-brush-mode","image-width","image-height","onSelect","onMultiSelect","onDragStart","onDragging","onDragEnd","onResizeStart","onResizing","onResizeEnd","onRotateStart","onRotating","onRotateEnd","onDrawBubble"])):Me("",!0),fe(T)?(V(),J("div",{key:2,class:"drawing-rect-edit translated-drawing-rect",style:it(fe(j)())},null,4)):Me("",!0)],4)],544)],2),[[Ke,$e.value!=="original"]])]),e("div",{ref_key:"editPanelRef",ref:ke,class:"edit-panel-container"},[e("div",{class:"panel-resize-handle vertical",onMousedown:Co}," ⋮⋮⋮ ",32),Re(Qg,{bubble:fe(S),"bubble-index":fe(re),onUpdate:po,onReRender:bo,onOcrRecognize:fe(m),onReTranslate:fo,onApplyBubble:vo,onResetCurrent:mo},null,8,["bubble","bubble-index","onOcrRecognize"])],512)])],2)):Me("",!0)}}),Nb=je(Vb,[["__scopeId","data-v-0916fb0e"]]),Wb={class:"app-header"},Kb={class:"header-content"},qb={class:"logo-container"},Hb={class:"header-links"},Jb={class:"container"},Yb={id:"image-display-area"},Xb={id:"upload-section",class:"card upload-card"},jb={key:1,class:"bookshelf-mode-hint"},Gb=Ge({__name:"TranslateView",setup(n){const r=Jn(),u=st(),o=Qe(),a=Zn(),i=gt(),{validateBeforeTranslation:t,initValidation:s}=Qn(),_=gn(),E=ol(),T=h(!1),N=h(void 0),oe=h(!1),ne=h(!1),G=h(null),$=h(null),Z=te(()=>u.currentImage),X=te(()=>u.hasImages);te(()=>u.imageCount),te(()=>u.currentImageIndex+1),te(()=>X.value&&!u.isBatchTranslationInProgress),te(()=>u.canGoPrevious),te(()=>u.canGoNext);const q=te(()=>u.isBatchTranslationInProgress);te(()=>u.isBatchTranslationPaused);const d=te(()=>q.value&&!_.isHqTranslating.value&&!_.isProofreading.value);te(()=>{if(!q.value)return 0;const S=u.completedImageCount,b=u.imageCount;return b>0?Math.round(S/b*100):0}),te(()=>`${u.completedImageCount}/${u.imageCount}`);const l=te(()=>u.failedImageCount>0),C=te(()=>!!r.query.book&&!!r.query.chapter),x=te(()=>r.query.book),O=te(()=>r.query.chapter),Q=te(()=>E.currentBookTitle.value),ge=te(()=>E.currentChapterTitle.value),j=te(()=>C.value&&ge.value&&Q.value?`${ge.value} - ${Q.value}`:"Saber-Translator");ut(async()=>{u.clearImages(),i.clearBubbles(),await E.initializeApp(),s(),window.addEventListener("keydown",U)}),It(()=>{window.removeEventListener("keydown",U)}),Be(()=>[r.query.book,r.query.chapter],async([S,b],[L,z])=>{S&&b?(u.clearImages(),i.clearBubbles(),await P()):L&&z&&!S&&!b&&(u.clearImages(),i.clearBubbles(),await E.initializeBookChapterContext(),console.log("[TranslateView] 从书架模式切换到快速翻译模式，已清空数据"))}),Be(j,S=>{typeof document<"u"&&(document.title=S)},{immediate:!0});async function P(){if(!(!x.value||!O.value))try{await E.initializeBookChapterContext()}catch(S){console.error("加载章节会话失败:",S),Ie("加载章节会话失败","error")}}function B(S){console.log(`上传完成，共 ${S} 张图片`),u.hasImages&&(u.sortImagesByFileName(),E.switchImage(0))}async function k(S){const b=Z.value;if(!b||!b.bubbleStates||b.bubbleStates.length===0){Ie("请先选择一张已翻译的图片","warning");return}if(u.images.length<=1){Ie("只有一张图片，无需应用到全部","info");return}if(!Object.values(S).some(z=>z)){Ie("请至少选择一个要应用的设置项","warning");return}try{const z=b.bubbleStates[0],H={};S.fontSize&&(H.fontSize=z.fontSize),S.fontFamily&&(H.fontFamily=z.fontFamily),S.layoutDirection&&(H.textDirection=z.textDirection==="auto"?"vertical":z.textDirection),S.textColor&&(H.textColor=z.textColor),S.fillColor&&(H.fillColor=z.fillColor),S.strokeEnabled&&(H.strokeEnabled=z.strokeEnabled),S.strokeColor&&(H.strokeColor=z.strokeColor),S.strokeWidth&&(H.strokeWidth=z.strokeWidth);const xe=De=>{const ke={...De};return S.fontSize&&H.fontSize!==void 0&&(ke.fontSize=H.fontSize),S.fontFamily&&H.fontFamily!==void 0&&(ke.fontFamily=H.fontFamily),S.layoutDirection&&H.textDirection!==void 0&&(ke.textDirection=H.textDirection),S.textColor&&H.textColor!==void 0&&(ke.textColor=H.textColor),S.fillColor&&H.fillColor!==void 0&&(ke.fillColor=H.fillColor),S.strokeEnabled&&H.strokeEnabled!==void 0&&(ke.strokeEnabled=H.strokeEnabled),S.strokeColor&&H.strokeColor!==void 0&&(ke.strokeColor=H.strokeColor),S.strokeWidth&&H.strokeWidth!==void 0&&(ke.strokeWidth=H.strokeWidth),ke};let he=0;const be=u.images;for(let De=0;De<be.length;De++){const ke=be[De];if(ke&&ke.bubbleStates&&ke.bubbleStates.length>0){const $e=ke.bubbleStates.map(xe);u.updateImageByIndex(De,{bubbleStates:$e}),he++}}if(i.bubbles.length>0){const De=i.bubbles.map(xe);i.setBubbles(De)}const Se=[];S.fontSize&&Se.push("字号"),S.fontFamily&&Se.push("字体"),S.layoutDirection&&Se.push("排版方向"),S.textColor&&Se.push("文字颜色"),S.fillColor&&Se.push("填充颜色"),S.strokeEnabled&&Se.push("描边开关"),S.strokeColor&&Se.push("描边颜色"),S.strokeWidth&&Se.push("描边宽度");const ce=[];for(let De=0;De<be.length;De++){const ke=be[De];ke&&ke.translatedDataURL&&ke.bubbleStates&&ke.bubbleStates.length>0&&ce.push(De)}if(ce.length>0){const{apiClient:De}=await lt(async()=>{const{apiClient:_e}=await import("./client.Bht704G-.js");return{apiClient:_e}},__vite__mapDeps([4,5])),ke=o.settings.textStyle.layoutDirection,$e=ke==="auto";for(let _e=0;_e<ce.length;_e++){const Te=ce[_e];if(Te===void 0)continue;const Ce=u.images[Te];if(!(!Ce||!Ce.bubbleStates))try{let Ee="";if(Ce.cleanImageData?Ee=Ce.cleanImageData.includes("base64,")?Ce.cleanImageData.split("base64,")[1]||"":Ce.cleanImageData:Ce.originalDataURL&&(Ee=Ce.originalDataURL.includes("base64,")?Ce.originalDataURL.split("base64,")[1]||"":Ce.originalDataURL,console.log(`handleApplyToAll: 图片 ${Te} 使用原图作为背景（兜底）`)),!Ee){console.log(`handleApplyToAll: 图片 ${Te} 没有可用的背景图，跳过`);continue}const Ye=Ce.bubbleStates.map(A=>({translatedText:A.translatedText||"",coords:A.coords,fontSize:A.fontSize||o.settings.textStyle.fontSize,fontFamily:A.fontFamily||o.settings.textStyle.fontFamily,textDirection:_t(A),textColor:A.textColor||o.settings.textStyle.textColor,rotationAngle:A.rotationAngle||0,position:A.position||{x:0,y:0},strokeEnabled:A.strokeEnabled??o.settings.textStyle.strokeEnabled,strokeColor:A.strokeColor||o.settings.textStyle.strokeColor,strokeWidth:A.strokeWidth??o.settings.textStyle.strokeWidth})),we=await De.post("/api/re_render_image",{clean_image:Ee,bubble_texts:Ye.map(A=>A.translatedText),bubble_coords:Ye.map(A=>A.coords),fontSize:o.settings.textStyle.fontSize,fontFamily:o.settings.textStyle.fontFamily,textDirection:$e?"vertical":ke,textColor:o.settings.textStyle.textColor,bubble_states:Ye,use_individual_styles:!0,use_inpainting:!1,use_lama:!1,fillColor:null,is_font_style_change:!0,strokeEnabled:o.settings.textStyle.strokeEnabled,strokeColor:o.settings.textStyle.strokeColor,strokeWidth:o.settings.textStyle.strokeWidth});we.rendered_image&&u.updateImageByIndex(Te,{translatedDataURL:`data:image/png;base64,${we.rendered_image}`,hasUnsavedChanges:!0})}catch(Ee){console.error(`重渲染图片 ${Te} 失败:`,Ee)}}}Ie(`已将 ${Se.join("、")} 应用到 ${he} 张图片`,"success"),console.log(`[TranslateView] 应用设置到全部完成，更新了 ${he} 张图片，重渲染了 ${ce.length} 张`)}catch(z){console.error("应用设置到全部失败:",z),Ie("应用设置失败","error")}}async function m(){Z.value&&t("normal")&&await _.translateCurrentImage()}async function D(){X.value&&t("normal")&&await _.translateAllImages()}async function I(){X.value&&t("hq")&&await _.executeHqTranslation()}async function p(){X.value&&t("proofread")&&await _.executeProofreading()}async function y(){Z.value&&await _.removeTextOnly()}async function ee(){X.value&&await _.removeAllTexts()}function se(){if(!Z.value)return;const S=Z.value.fileName||`图片 ${u.currentImageIndex+1}`;confirm(`确定要删除当前图片 (${S}) 吗？`)&&(u.deleteCurrentImage(),Ie("图片已删除","success"))}function f(){X.value&&confirm("确定要清除所有图片吗？这将丢失所有未保存的进度。")&&(u.clearImages(),Ie("所有图片已清除","success"))}async function w(){try{const S=await Yn(),b=await rn();if(S.success&&b.success)Ie("临时文件清理完成","success");else{const L=[];S.success||L.push("调试文件清理失败"),b.success||L.push("临时文件清理失败"),Ie(L.join("，"),"warning")}}catch{Ie("清理临时文件失败","error")}}function c(){E.goToPrevious()}function F(){E.goToNext()}function ve(){ne.value=!ne.value}async function W(){if(!l.value){Ie("没有失败的图片需要重新翻译","info");return}t("normal")&&await _.retryFailedImages()}async function Y(){if(!X.value){Ie("没有可保存的内容","warning");return}if(!(!x.value||!O.value))try{await a.saveChapterSession(x.value,O.value)?Ie("章节进度已保存","success"):Ie("保存失败","error")}catch(S){console.error("保存会话失败:",S),Ie("保存失败: "+(S instanceof Error?S.message:"未知错误"),"error")}}function me(S){N.value=S,T.value=!0}function g(){me("plugins")}function v(){Ie("设置已保存","success")}function M(){oe.value=!0}function R(){Ie("🌙 该功能正在开发中，敬请期待！","info")}function U(S){const b=S.target;if(!(b instanceof HTMLInputElement||b instanceof HTMLTextAreaElement||b.getAttribute("contenteditable")==="true"||b.id==="bubbleTextEditor")&&!ne.value&&S.altKey)switch(S.key){case"ArrowLeft":S.preventDefault(),c();break;case"ArrowRight":S.preventDefault(),F();break;case"ArrowUp":if(S.preventDefault(),!o.settings.textStyle.autoFontSize){const z=o.settings.textStyle.fontSize;o.updateTextStyle({fontSize:z+1})}break;case"ArrowDown":if(S.preventDefault(),!o.settings.textStyle.autoFontSize){const z=o.settings.textStyle.fontSize;o.updateTextStyle({fontSize:Math.max(10,z-1)})}break}}async function le(S){const b=Z.value;if(!b||!b.translatedDataURL){console.log(`自动字号设置变更: ${S} (仅影响下次翻译)`);return}const L=b.bubbleStates;if(!L||!Array.isArray(L)||L.length===0){console.log("当前图片没有 bubbleStates，跳过重渲染");return}if(console.log(`自动字号设置变更: ${S}，将重新渲染...`),S){console.log("自动字号已开启，重新计算字号并渲染...");try{const{apiClient:z}=await lt(async()=>{const{apiClient:ce}=await import("./client.Bht704G-.js");return{apiClient:ce}},__vite__mapDeps([4,5]));let H="";if(b.cleanImageData){const ce=b.cleanImageData;H=ce.includes("base64,")?ce.split("base64,")[1]||"":ce}else b.originalDataURL&&(H=b.originalDataURL.includes("base64,")?b.originalDataURL.split("base64,")[1]||"":b.originalDataURL);if(!H){console.log("没有可用的背景图，跳过重渲染");return}const xe=L.map(ce=>({translatedText:ce.translatedText||"",coords:ce.coords,fontSize:ce.fontSize||o.settings.textStyle.fontSize,fontFamily:ce.fontFamily||o.settings.textStyle.fontFamily,textDirection:_t(ce),textColor:ce.textColor||o.settings.textStyle.textColor,rotationAngle:ce.rotationAngle||0,position:ce.position||{x:0,y:0},strokeEnabled:ce.strokeEnabled??o.settings.textStyle.strokeEnabled,strokeColor:ce.strokeColor||o.settings.textStyle.strokeColor,strokeWidth:ce.strokeWidth??o.settings.textStyle.strokeWidth})),he=xe.map(ce=>ce.translatedText),be=xe.map(ce=>ce.coords),Se=await z.post("/api/re_render_image",{clean_image:H,bubble_texts:he,bubble_coords:be,fontSize:o.settings.textStyle.fontSize,fontFamily:o.settings.textStyle.fontFamily,textDirection:o.settings.textStyle.layoutDirection==="auto"?"vertical":o.settings.textStyle.layoutDirection,textColor:o.settings.textStyle.textColor,bubble_states:xe,use_individual_styles:!0,use_inpainting:!1,use_lama:!1,fillColor:null,is_font_style_change:!0,autoFontSize:!0,strokeEnabled:o.settings.textStyle.strokeEnabled,strokeColor:o.settings.textStyle.strokeColor,strokeWidth:o.settings.textStyle.strokeWidth});if(Se.rendered_image){if(Se.bubble_states&&Array.isArray(Se.bubble_states)){const ce=L.map((De,ke)=>({...De,fontSize:Se.bubble_states[ke]?.fontSize??De.fontSize}));u.updateCurrentImage({translatedDataURL:`data:image/png;base64,${Se.rendered_image}`,bubbleStates:ce,hasUnsavedChanges:!0}),i.setBubbles(ce)}else u.updateCurrentImage({translatedDataURL:`data:image/png;base64,${Se.rendered_image}`,hasUnsavedChanges:!0});console.log("自动字号渲染成功")}else Se.error&&(console.error("自动字号渲染失败:",Se.error),Ie("重新渲染失败: "+Se.error,"error"))}catch(z){console.error("自动字号渲染出错:",z)}}else{const z=o.settings.textStyle.fontSize;console.log(`自动字号已关闭，使用固定字号 ${z} 渲染...`);const H=L.map(xe=>({...xe,fontSize:z}));u.updateCurrentImage({bubbleStates:H}),i.setBubbles(H),await re("fontSize",z)}}async function re(S,b){const L=Z.value;if(!L||!L.translatedDataURL||!L.bubbleStates||L.bubbleStates.length===0||!["fontSize","fontFamily","layoutDirection","textColor","strokeEnabled","strokeColor","strokeWidth","fillColor"].includes(S))return;console.log(`全局设置变更 (${S}=${b})，准备重渲染...`);const xe={fontSize:"fontSize",fontFamily:"fontFamily",layoutDirection:"textDirection",textColor:"textColor",strokeEnabled:"strokeEnabled",strokeColor:"strokeColor",strokeWidth:"strokeWidth",fillColor:"fillColor"}[S];if(xe&&L.bubbleStates)if(S==="layoutDirection"&&b==="auto")console.log("排版方向设置为 'auto'，不修改气泡的 textDirection，使用 autoTextDirection 渲染");else{const he=L.bubbleStates.map(be=>({...be,[xe]:b}));u.updateCurrentImage({bubbleStates:he}),i.setBubbles(he)}try{const be=u.currentImage?.bubbleStates||L.bubbleStates||[];if(be.length===0||!be[0]?.coords){console.log("没有有效的气泡坐标，跳过重渲染");return}const Se=o.settings.textStyle.layoutDirection,ce=be.map(Ce=>({translatedText:Ce.translatedText||"",coords:Ce.coords,fontSize:Ce.fontSize||o.settings.textStyle.fontSize,fontFamily:Ce.fontFamily||o.settings.textStyle.fontFamily,textDirection:_t(Ce),textColor:Ce.textColor||o.settings.textStyle.textColor,rotationAngle:Ce.rotationAngle||0,position:Ce.position||{x:0,y:0},strokeEnabled:Ce.strokeEnabled??o.settings.textStyle.strokeEnabled,strokeColor:Ce.strokeColor||o.settings.textStyle.strokeColor,strokeWidth:Ce.strokeWidth??o.settings.textStyle.strokeWidth})),De=ce.map(Ce=>Ce.translatedText),ke=ce.map(Ce=>Ce.coords);let $e="";if(L.cleanImageData){const Ce=L.cleanImageData;$e=Ce.includes("base64,")?Ce.split("base64,")[1]||"":Ce}else L.originalDataURL&&($e=L.originalDataURL.includes("base64,")?L.originalDataURL.split("base64,")[1]||"":L.originalDataURL,console.log("handleTextStyleChanged: 使用原图作为背景（兜底）"));if(!$e){console.log("没有可用的背景图，跳过重渲染");return}const{apiClient:_e}=await lt(async()=>{const{apiClient:Ce}=await import("./client.Bht704G-.js");return{apiClient:Ce}},__vite__mapDeps([4,5])),Te=await _e.post("/api/re_render_image",{clean_image:$e,bubble_texts:De,bubble_coords:ke,fontSize:o.settings.textStyle.fontSize,fontFamily:o.settings.textStyle.fontFamily,textDirection:Se==="auto"?"vertical":Se,textColor:o.settings.textStyle.textColor,bubble_states:ce,use_individual_styles:!0,use_inpainting:!1,use_lama:!1,fillColor:null,is_font_style_change:!0,strokeEnabled:o.settings.textStyle.strokeEnabled,strokeColor:o.settings.textStyle.strokeColor,strokeWidth:o.settings.textStyle.strokeWidth});Te.rendered_image?(u.updateCurrentImage({translatedDataURL:`data:image/png;base64,${Te.rendered_image}`,hasUnsavedChanges:!0}),console.log("设置变更后重新渲染成功")):Te.error&&console.error("重新渲染失败:",Te.error)}catch(he){console.error("设置变更后重新渲染失败:",he)}}function ae(S){E.switchImage(S)}return(S,b)=>{const L=Po("router-link");return V(),J("div",{class:Le(["translate-page",{"edit-mode-active":ne.value}])},[e("header",Wb,[e("div",Kb,[e("div",qb,[Re(L,{to:"/",title:"返回书架"},{default:yt(()=>[...b[3]||(b[3]=[e("img",{src:"/pic/logo.png",alt:"Saber-Translator Logo",class:"app-logo"},null,-1),e("span",{class:"app-name"},"Saber-Translator",-1)])]),_:1})]),e("div",Hb,[Re(L,{to:"/",class:"back-to-shelf",title:"返回书架"},{default:yt(()=>[...b[4]||(b[4]=[Ne("📚",-1)])]),_:1}),C.value?(V(),J("button",{key:0,class:"save-header-btn",title:"保存进度",onClick:Y}," 💾 ")):Me("",!0),e("button",{id:"openSettingsBtn",class:"settings-header-btn",title:"打开设置",onClick:b[0]||(b[0]=z=>me())},[...b[5]||(b[5]=[e("span",{class:"icon"},"⚙️",-1),e("span",null,"设置",-1)])]),b[8]||(b[8]=e("a",{href:"http://www.mashirosaber.top",target:"_blank",class:"tutorial-link"},"使用教程",-1)),e("a",{href:"javascript:void(0)",class:"donate-link",onClick:M},[...b[6]||(b[6]=[e("span",null,"❤️ 请作者喝奶茶",-1)])]),b[9]||(b[9]=e("a",{href:"https://github.com/MashiroSaber03",target:"_blank",class:"github-link"},[e("img",{src:"/pic/github.jpg",alt:"GitHub",class:"github-icon"})],-1)),e("button",{class:"theme-toggle",title:"功能开发中",onClick:R},[...b[7]||(b[7]=[e("span",{class:"theme-icon"},"☀️",-1)])])])])]),e("div",Jb,[Re(ys,{onTranslateCurrent:m,onTranslateAll:D,onHqTranslate:I,onProofread:p,onRemoveText:y,onRemoveAllText:ee,onRetryFailed:W,onDeleteCurrent:se,onClearAll:f,onCleanTemp:w,onOpenPlugins:g,onOpenSettings:me,onPrevious:c,onNext:F,onApplyToAll:k,onTextStyleChanged:re,onAutoFontSizeChanged:le}),e("main",Yb,[e("section",Xb,[Re(Sa,{ref_key:"imageUploadRef",ref:G,onUploadComplete:B},null,512),fe(a).loadingProgress.total>0?(V(),rt(dn,{key:0,visible:!0,percentage:fe(a).loadingProgress.current/fe(a).loadingProgress.total*100,label:fe(a).loadingProgress.message},null,8,["percentage","label"])):Me("",!0),Re(dl,{progress:fe(_).progress.value,"show-controls":d.value},null,8,["progress","show-controls"]),q.value&&C.value?(V(),J("div",jb,[...b[10]||(b[10]=[e("span",{style:{color:"#888","font-size":"0.85em"}}," （书架模式下退出前请点击顶部保存按钮） ",-1)])])):Me("",!0)]),Re(Ns,{ref_key:"imageResultRef",ref:$,"is-edit-mode":ne.value,onToggleEditMode:ve,onRetryFailed:W},null,8,["is-edit-mode"])]),X.value&&!ne.value?(V(),rt(_l,{key:0,onSelect:ae})):Me("",!0)]),Z.value&&ne.value?(V(),rt(Nb,{key:0,"is-edit-mode-active":ne.value,onExit:ve},null,8,["is-edit-mode-active"])):Me("",!0),Re(Js,{onOpenSettings:me}),Re(Ad,{modelValue:T.value,"onUpdate:modelValue":b[1]||(b[1]=z=>T.value=z),"initial-tab":N.value,onSave:v},null,8,["modelValue","initial-tab"]),oe.value?(V(),rt(bl,{key:1,onClose:b[2]||(b[2]=z=>oe.value=!1)})):Me("",!0)],2)}}}),ip=je(Gb,[["__scopeId","data-v-578fd182"]]);export{ip as default};
