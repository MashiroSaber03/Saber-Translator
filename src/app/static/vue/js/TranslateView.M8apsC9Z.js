const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["js/index.D9YoG6bK.js","js/vue-vendor.BU3zOQRA.js","assets/index.BYanE9pL.css","js/session.Kpy-QhBa.js","js/client.Bht704G-.js","js/utils-vendor.B9ygI19o.js"])))=>i.map(i=>d[i]);
import{D as on,b as an,c as sn,d as Yn,a as at,_ as qe,u as Ke,s as be,e as rt,f as Bo,g as Eo,h as Po,i as Ao,j as En,k as Pn,B as An,l as Fn,m as Fo,F as Xt,n as Ln,o as Un,p as Lo,L as On}from"./index.D9YoG6bK.js";import{d as ln,r as S,c as te,a as He,i as G,v as fe,e,t as ue,x as st,h as K,b as it,n as De,B as Ue,l as ut,y as oe,G as ze,f as me,H as zn,w as ht,I as Ze,u as re,F as Xe,j as Ge,J as Jn,K as ye,D as ct,L as St,z as Ce,M as Uo,k as tt,N as Zt,o as Tt,O as yt,P as Vn,E as Oo}from"./vue-vendor.BU3zOQRA.js";import{p as zo,a as Vo,b as No,c as Wo,d as Ko,e as qo,f as Ho,h as Yo,i as Jo,j as Xo,k as rn,l as Xn}from"./system.CmjDD-4C.js";import{getFontList as jn,uploadFont as jo,getTextboxPrompts as Go,getPrompts as Zo,configApi as Ve,getFontListApi as Qo}from"./config.CwRcCkM9.js";import{_ as Oe}from"./CustomSelect.vue_vue_type_style_index_0_lang.qSOIWfjV.js";import{apiClient as ot}from"./client.Bht704G-.js";import{B as Gn}from"./BaseModal.B3aLJ1ke.js";import{getBookDetail as ea}from"./bookshelf.B4ums9uK.js";import"./utils-vendor.B9ygI19o.js";async function Bt(n){return ot.post("/api/translate_image",n)}async function un(n){return ot.post("/api/re_render_image",n)}async function ta(n){try{return{success:!0,data:await ot.post("/api/translate_single_text",n)}}catch(c){return{success:!1,error:c instanceof Error?c.message:"翻译失败"}}}async function cn(n){return ot.post("/api/hq_translate_batch",n)}async function Qt(n,c,u){return ot.post("/api/detect_boxes",{image:n,detector_type:c,...u})}async function Zn(n,c,u,t){return ot.post("/api/ocr_single_bubble",{image_data:n,bubble_coords:c,ocr_engine:u,...t})}async function dn(n,c,u){return ot.post("/api/inpaint_single_bubble",{image_data:n,bubble_coords:c,bubble_angle:u?.bubbleAngle??0,method:u?.method??"lama",lama_model:u?.lamaModel??"lama_mpe",...u?.maskData&&{mask_data:u.maskData}})}const na=Object.freeze(Object.defineProperty({__proto__:null,detectBoxes:Qt,hqTranslateBatch:cn,inpaintSingleBubble:dn,ocrSingleBubble:Zn,reRenderImage:un,translateImage:Bt,translateSingleText:ta},Symbol.toStringTag,{value:"Module"}));async function oa(){return ot.get("/api/plugins")}async function aa(n){const c=encodeURIComponent(n);return ot.post(`/api/plugins/${c}/enable`)}async function sa(n){const c=encodeURIComponent(n);return ot.post(`/api/plugins/${c}/disable`)}async function la(n){const c=encodeURIComponent(n);return ot.delete(`/api/plugins/${c}`)}async function ia(n){const c=encodeURIComponent(n);return ot.get(`/api/plugins/${c}/config_schema`)}async function ra(n){const c=encodeURIComponent(n);return ot.get(`/api/plugins/${c}/config`)}async function ua(n,c){const u=encodeURIComponent(n);return ot.post(`/api/plugins/${u}/config`,c)}async function ca(){return ot.get("/api/plugins/default_states")}async function da(n,c){const u=encodeURIComponent(n);return ot.post(`/api/plugins/${u}/set_default_state`,{enabled:c})}async function ga(){return{states:(await ca()).default_states}}const pa=da,ba=ia,va=ra,ma=ua;function fa(){return`img_${Date.now()}_${Math.random().toString(36).substring(2,9)}`}function Nn(n,c,u){return{id:fa(),fileName:n,originalDataURL:c,translatedDataURL:null,cleanImageData:null,bubbleStates:null,translationStatus:"pending",translationFailed:!1,fontSize:25,autoFontSize:!0,fontFamily:"fonts/STSONG.TTF",layoutDirection:"vertical",textColor:"#000000",fillColor:Yn,inpaintMethod:"solid",strokeEnabled:sn,strokeColor:an,strokeWidth:on,hasUnsavedChanges:!1,...u}}const Qe=ln("image",()=>{const n=S([]),c=S(-1),u=S(!1),t=S(!1),r=S(null),a=te(()=>c.value>=0&&c.value<n.value.length?n.value[c.value]??null:null),o=te(()=>n.value.length),s=te(()=>n.value.length>0),y=te(()=>c.value>0),P=te(()=>c.value<n.value.length-1),T=te(()=>n.value.filter(x=>x.translationFailed).length),V=te(()=>n.value.filter(x=>x.translationStatus==="completed").length),X=te(()=>n.value.filter(x=>x.translationStatus==="pending").length);function J(x,_,d){const M=Nn(x,_,d);return n.value.push(M),n.value.length===1&&(c.value=0),console.log(`图片已添加: ${x}，当前共 ${n.value.length} 张图片`),M}function A(x){const _=x.map(({fileName:M,originalDataURL:ae,overrides:L})=>Nn(M,ae,L)),d=n.value.length===0;return n.value.push(..._),d&&n.value.length>0&&(c.value=0),console.log(`批量添加了 ${_.length} 张图片，当前共 ${n.value.length} 张`),_}function f(x){n.value=x.map(_=>({..._,strokeEnabled:_.strokeEnabled??sn,strokeColor:_.strokeColor||an,strokeWidth:_.strokeWidth??on,hasUnsavedChanges:_.hasUnsavedChanges||!1})),n.value.length>0?c.value=Math.min(Math.max(0,c.value),n.value.length-1):c.value=-1,console.log(`图片数组已设置，共 ${n.value.length} 张图片`)}function D(x){return x<0||x>=n.value.length?(console.warn(`删除失败: 无效的索引 ${x}`),!1):(n.value.splice(x,1),c.value===x?(c.value=Math.min(x,n.value.length-1),n.value.length===0&&(c.value=-1)):c.value>x&&c.value--,console.log(`图片已删除，当前共 ${n.value.length} 张图片`),!0)}function B(){return D(c.value)}function F(){n.value=[],c.value=-1,u.value=!1,t.value=!1,r.value=null,console.log("所有图片已清除")}function i(){const x=a.value?.id||null;if(n.value.sort((_,d)=>_.fileName.localeCompare(d.fileName,void 0,{numeric:!0,sensitivity:"base"})),x){const _=n.value.findIndex(d=>d.id===x);_>=0&&_!==c.value&&(console.log(`图片排序: currentImageIndex 从 ${c.value} 更新为 ${_}`),c.value=_)}console.log("图片已按文件名排序")}function l(x){x>=-1&&x<n.value.length?(c.value=x,console.log(`当前图片索引已设置为 ${x}`)):console.warn(`设置索引失败: 无效的索引 ${x}`)}function v(){return y.value?(c.value--,!0):!1}function p(){return P.value?(c.value++,!0):!1}function R(x){a.value?(Object.assign(a.value,x),console.log("当前图片属性已更新:",Object.keys(x))):console.warn("更新失败: 当前没有选中的图片")}function E(x,_){if(x>=0&&x<n.value.length){const d=n.value[x];d&&(Object.assign(d,_),console.log(`图片 ${x} 属性已更新:`,Object.keys(_)))}else console.warn(`更新失败: 无效的索引 ${x}`)}function N(x){a.value&&(a.value.bubbleStates=x,a.value.hasUnsavedChanges=!0,console.log(`当前图片气泡状态已更新，共 ${x?.length??0} 个气泡`))}function O(x){a.value&&(a.value.isManuallyAnnotated=x,a.value.hasUnsavedChanges=!0,console.log(`手动标注标记已设置为: ${x}`))}function C(x,_){a.value?(a.value[x]=_,a.value.hasUnsavedChanges=!0,console.log(`当前图片属性 ${String(x)} 已更新`)):console.warn("更新失败: 当前没有选中的图片")}function w(x,_){a.value&&(a.value.translatedDataURL=x,_&&(a.value.cleanImageData=_),a.value.translationStatus="completed",a.value.translationFailed=!1,a.value.hasUnsavedChanges=!0,console.log("当前图片翻译结果已更新"))}function m(x,_,d){if(x>=0&&x<n.value.length){const M=n.value[x];M&&(M.translationStatus=_,M.translationFailed=_==="failed",d&&(M.errorMessage=d),console.log(`图片 ${x} 翻译状态: ${_}`))}}function g(x){a.value&&(a.value.translationStatus="failed",a.value.translationFailed=!0,a.value.errorMessage=x,console.log(`当前图片翻译失败: ${x}`))}function k(){n.value.forEach(x=>{x.translationStatus="pending",x.translationFailed=!1,x.errorMessage=void 0}),console.log("所有图片翻译状态已重置")}function $(x){u.value=x,x||(t.value=!1,r.value=null),console.log(`批量翻译状态: ${x?"进行中":"已完成"}`)}function b(x){t.value=x,console.log(`批量翻译暂停状态: ${x?"已暂停":"继续中"}`)}function h(x){r.value=x}function Y(){if(t.value&&r.value){t.value=!1;const x=r.value;r.value=null,x(),console.log("批量翻译已继续")}}function W(){return n.value.map((x,_)=>x.translationFailed?_:-1).filter(x=>x!==-1)}return{images:n,currentImageIndex:c,isBatchTranslationInProgress:u,isBatchTranslationPaused:t,batchTranslationResumeCallback:r,currentImage:a,imageCount:o,hasImages:s,canGoPrevious:y,canGoNext:P,failedImageCount:T,completedImageCount:V,pendingImageCount:X,addImage:J,addImages:A,setImages:f,deleteImage:D,deleteCurrentImage:B,clearImages:F,sortImagesByFileName:i,setCurrentImageIndex:l,goToPrevious:v,goToNext:p,updateCurrentImage:R,updateImageByIndex:E,updateCurrentBubbleStates:N,setManuallyAnnotated:O,updateCurrentImageProperty:C,updateCurrentTranslationResult:w,setTranslationStatus:m,markCurrentAsFailed:g,resetAllTranslationStatus:k,setBatchTranslationInProgress:$,setBatchTranslationPaused:b,setBatchTranslationResumeCallback:h,resumeBatchTranslation:Y,getFailedImageIndices:W}}),Wn=Object.freeze(Object.defineProperty({__proto__:null,useImageStore:Qe},Symbol.toStringTag,{value:"Module"})),Qn=ln("session",()=>{const n=S(null),c=S({bookId:null,chapterId:null,bookTitle:null,chapterTitle:null}),u=S([]),t=S(!1),r=S({current:0,total:0,message:""}),a=S(null),o=S(!1),s=te(()=>c.value.bookId!==null&&c.value.chapterId!==null),y=te(()=>c.value.bookId),P=te(()=>c.value.chapterId);function T(m,g,k=null,$=null){c.value={bookId:m,chapterId:g,bookTitle:k,chapterTitle:$},console.log(`会话上下文已设置: 书籍=${m}, 章节=${g}`)}function V(m,g,k,$){T(m,g,k,$)}function X(){c.value={bookId:null,chapterId:null,bookTitle:null,chapterTitle:null},console.log("会话上下文已清除")}function J(m){const g=m.get("book"),k=m.get("chapter");g&&k&&T(g,k)}function A(m){n.value=m,console.log(`当前会话名称: ${m}`)}function f(){n.value=null}function D(m){u.value=m,console.log(`会话列表已更新，共 ${m.length} 个会话`)}function B(m){const g=u.value.findIndex(k=>k.name===m.name);g>=0?u.value[g]=m:u.value.unshift(m)}function F(m){const g=u.value.findIndex(k=>k.name===m);g>=0&&u.value.splice(g,1)}function i(m,g){const k=u.value.find($=>$.name===m);k&&(k.name=g)}function l(m){t.value=m}function v(m){o.value=m}function p(m){a.value=m}function R(m,g,k,$){return{name:m,version:"2.0",savedAt:new Date().toISOString(),imageCount:g.length,ui_settings:$,images:g.map(b=>({originalDataURL:b.originalDataURL,translatedDataURL:b.translatedDataURL||void 0,cleanImageData:b.cleanImageData||void 0,bubbleStates:b.bubbleStates||void 0,isManuallyAnnotated:b.isManuallyAnnotated||void 0,fileName:b.fileName,fontSize:b.fontSize,autoFontSize:b.autoFontSize,fontFamily:b.fontFamily,layoutDirection:b.layoutDirection,textColor:b.textColor,fillColor:b.fillColor,inpaintMethod:b.inpaintMethod,strokeEnabled:b.strokeEnabled,strokeColor:b.strokeColor,strokeWidth:b.strokeWidth,translationStatus:b.translationStatus,translationFailed:b.translationFailed})),currentImageIndex:k}}function E(){n.value=null,c.value={bookId:null,chapterId:null,bookTitle:null,chapterTitle:null},u.value=[],t.value=!1,o.value=!1,a.value=null,console.log("会话状态已重置")}async function N(m){if(!m||typeof m!="string")return null;if(m.startsWith("data:"))return m;if(!m.startsWith("/api/"))return null;try{const g=await fetch(m);if(!g.ok)return null;const k=await g.blob();return new Promise($=>{const b=new FileReader;b.onloadend=()=>$(b.result),b.onerror=()=>$(null),b.readAsDataURL(k)})}catch(g){return console.error(`转换图片 URL 失败: ${m}`,g),null}}async function O(m,g){const k=m.length;for(let $=0;$<k;$++){const b=m[$];if(b){if(g&&g($+1,k),b.originalDataURL&&b.originalDataURL.startsWith("/api/")){const h=await N(b.originalDataURL);h&&(b.originalDataURL=h)}if(b.translatedDataURL&&b.translatedDataURL.startsWith("/api/")){const h=await N(b.translatedDataURL);h&&(b.translatedDataURL=h)}if(b.cleanImageData&&b.cleanImageData.startsWith("/api/")){const h=await N(b.cleanImageData);h&&(b.cleanImageData=h.replace(/^data:image\/\w+;base64,/,""))}}}}async function C(m){l(!0),p(null),r.value={current:0,total:0,message:"正在加载..."};try{const{useImageStore:g}=await at(async()=>{const{useImageStore:M}=await Promise.resolve().then(()=>Wn);return{useImageStore:M}},void 0),{useSettingsStore:k}=await at(async()=>{const{useSettingsStore:M}=await import("./index.D9YoG6bK.js").then(ae=>ae.q);return{useSettingsStore:M}},__vite__mapDeps([0,1,2])),{useBubbleStore:$}=await at(async()=>{const{useBubbleStore:M}=await Promise.resolve().then(()=>ll);return{useBubbleStore:M}},void 0),b=g(),h=k(),Y=$(),{loadSessionByPathApi:W}=await at(async()=>{const{loadSessionByPathApi:M}=await import("./session.Kpy-QhBa.js");return{loadSessionByPathApi:M}},__vite__mapDeps([3,4,5])),x=await W(m);if(!x.success||!x.session)throw new Error(x.error||"加载会话失败");const _=x.session;if(_.images&&_.images.length>0){const M=_.images.map((j,le)=>({id:`session-${le}-${Date.now()}`,originalDataURL:j.originalDataURL,translatedDataURL:j.translatedDataURL||null,cleanImageData:j.cleanImageData||null,bubbleStates:j.bubbleStates!==void 0&&j.bubbleStates!==null?j.bubbleStates:null,isManuallyAnnotated:!!j.isManuallyAnnotated,fileName:j.fileName||`image-${le+1}.png`,translationStatus:j.translationStatus||"pending",translationFailed:!!j.translationFailed,hasUnsavedChanges:!1,fontSize:j.fontSize||24,autoFontSize:j.autoFontSize??!0,fontFamily:j.fontFamily||"Microsoft YaHei",layoutDirection:j.layoutDirection||"vertical",textColor:j.textColor||"#000000",fillColor:j.fillColor||"#FFFFFF",inpaintMethod:j.inpaintMethod||"litelama",strokeEnabled:j.strokeEnabled??!1,strokeColor:j.strokeColor||"#FFFFFF",strokeWidth:j.strokeWidth||2}));M.length>0&&(console.log("正在加载图片..."),r.value={current:0,total:M.length,message:"正在加载图片..."},await O(M,(j,le)=>{const U=j/le*100;r.value={current:j,total:le,message:`加载图片 ${j}/${le}...`},console.log(`加载图片 ${j}/${le}... (${U.toFixed(0)}%)`)}),r.value={current:M.length,total:M.length,message:"加载完成"},console.log("图片加载完成，已转换为 Base64"),setTimeout(()=>{r.value={current:0,total:0,message:""}},500)),b.setImages(M);let ae=0;typeof _.currentImageIndex=="number"&&(ae=_.currentImageIndex,(ae>=M.length||ae<0)&&(ae=M.length>0?0:-1)),b.setCurrentImageIndex(ae);const L=M[ae];L&&L.bubbleStates&&L.bubbleStates.length>0?Y.setBubbles(L.bubbleStates,!0):Y.clearBubblesLocal(),console.log(`按路径加载会话成功: ${m}, 共 ${M.length} 张图片`)}const d=_.ui_settings;if(d){(d.targetLanguage||d.sourceLanguage)&&h.updateSettings({targetLanguage:d.targetLanguage||void 0,sourceLanguage:d.sourceLanguage||void 0});const M=d.useInpaintingMethod,L=["solid","lama_mpe","litelama"].includes(M)?M:h.settings.textStyle.inpaintMethod;h.updateTextStyle({fontSize:d.fontSize||h.settings.textStyle.fontSize,autoFontSize:d.autoFontSize??h.settings.textStyle.autoFontSize,fontFamily:d.fontFamily||h.settings.textStyle.fontFamily,layoutDirection:d.layoutDirection||h.settings.textStyle.layoutDirection,textColor:d.textColor||h.settings.textStyle.textColor,fillColor:d.fillColor||h.settings.textStyle.fillColor,inpaintMethod:L,strokeEnabled:d.strokeEnabled??h.settings.textStyle.strokeEnabled,strokeColor:d.strokeColor||h.settings.textStyle.strokeColor,strokeWidth:d.strokeWidth||h.settings.textStyle.strokeWidth}),console.log("UI 设置已恢复")}return A(m),!0}catch(g){const k=g instanceof Error?g.message:"加载会话失败";throw p(k),console.error(`按路径加载会话失败: ${m}`,g),g}finally{l(!1)}}async function w(m,g){if(!m||!g)return console.log("未在书籍/章节模式，不支持保存"),!1;console.log(`保存章节会话（分批）: book=${m}, chapter=${g}`);const{useImageStore:k}=await at(async()=>{const{useImageStore:x}=await Promise.resolve().then(()=>Wn);return{useImageStore:x}},void 0),{useSettingsStore:$}=await at(async()=>{const{useSettingsStore:x}=await import("./index.D9YoG6bK.js").then(_=>_.q);return{useSettingsStore:x}},__vite__mapDeps([0,1,2])),b=k(),h=$(),Y=Array.isArray(b.images)?b.images:[];if(!Y||Y.length===0)return console.log("没有图片数据可保存"),!1;const W=`bookshelf/${m}/${g}`;v(!0),p(null),r.value={current:0,total:100,message:"准备保存..."};try{const{batchSaveStartApi:x,batchSaveImageApi:_,batchSaveCompleteApi:d}=await at(async()=>{const{batchSaveStartApi:I,batchSaveImageApi:ee,batchSaveCompleteApi:Q}=await import("./session.Kpy-QhBa.js");return{batchSaveStartApi:I,batchSaveImageApi:ee,batchSaveCompleteApi:Q}},__vite__mapDeps([3,4,5])),M=Y.length;Y.some(I=>I.originalDataURL&&I.originalDataURL.startsWith("/api/")||I.translatedDataURL&&I.translatedDataURL.startsWith("/api/")||I.cleanImageData&&I.cleanImageData.startsWith("/api/"))&&(console.log("[saveChapterSession] 检测到 /api/ URL 格式图片，开始转换为 Base64..."),r.value={current:2,total:100,message:"转换图片格式..."},await O(Y,(I,ee)=>{const Q=2+I/ee*3;r.value={current:Math.round(Q),total:100,message:`转换图片 ${I}/${ee}...`}}),console.log("[saveChapterSession] 图片格式转换完成")),r.value={current:5,total:100,message:"收集元数据..."};const{textStyle:L,targetLanguage:j,sourceLanguage:le}=h.settings,U={targetLanguage:j,sourceLanguage:le,fontSize:L.fontSize,autoFontSize:L.autoFontSize,fontFamily:L.fontFamily,layoutDirection:L.layoutDirection,textColor:L.textColor,useInpaintingMethod:L.inpaintMethod,fillColor:L.fillColor,strokeEnabled:L.strokeEnabled,strokeColor:L.strokeColor,strokeWidth:L.strokeWidth},Z=Y.map(I=>{const ee={};for(const Q of Object.keys(I))Q!=="originalDataURL"&&Q!=="translatedDataURL"&&Q!=="cleanImageData"&&(ee[Q]=I[Q]);return ee.hasOriginalData=!!I.originalDataURL,ee.hasTranslatedData=!!I.translatedDataURL,ee.hasCleanData=!!I.cleanImageData,ee}),ce={ui_settings:U,images_meta:Z,currentImageIndex:b.currentImageIndex};r.value={current:10,total:100,message:"初始化保存..."};const Te=await x(W,ce);if(!Te.success)throw new Error(Te.error||"初始化保存失败");const _e=Te.session_folder;if(!_e)throw new Error("未获取到会话文件夹路径");console.log(`会话文件夹: ${_e}`);let Ae=0,Re=0;const Me=I=>!!I&&typeof I=="string"&&I.startsWith("data:");for(let I=0;I<M;I++){const ee=Y[I];if(!ee)continue;const Q=10+I/M*80;if(r.value={current:Math.round(Q),total:100,message:`保存图片 ${I+1}/${M}...`},Me(ee.originalDataURL))try{const ne=await _(_e,I,"original",ee.originalDataURL);ne.success||(console.error(`保存图片 ${I} original 失败:`,ne.error),Re++)}catch(ne){console.error(`保存图片 ${I} original 出错:`,ne),Re++}if(Me(ee.translatedDataURL))try{const ne=await _(_e,I,"translated",ee.translatedDataURL);ne.success||(console.error(`保存图片 ${I} translated 失败:`,ne.error),Re++)}catch(ne){console.error(`保存图片 ${I} translated 出错:`,ne),Re++}if(ee.cleanImageData&&typeof ee.cleanImageData=="string"&&!ee.cleanImageData.startsWith("/api/"))try{const ne=await _(_e,I,"clean",ee.cleanImageData);ne.success||(console.error(`保存图片 ${I} clean 失败:`,ne.error),Re++)}catch(ne){console.error(`保存图片 ${I} clean 出错:`,ne),Re++}Ae++}r.value={current:95,total:100,message:"完成保存..."};const z=await d(_e,Z);if(!z.success)throw new Error(z.error||"完成保存失败");return r.value={current:100,total:100,message:"保存完成"},console.log(`分批保存完成: ${Ae} 张图片, ${Re} 个失败`),setTimeout(()=>{r.value={current:0,total:0,message:""}},1e3),!0}catch(x){const _=x instanceof Error?x.message:"保存章节会话失败";return p(_),console.error("分批保存失败:",x),r.value={current:0,total:0,message:""},!1}finally{v(!1)}}return{currentSessionName:n,context:c,sessionList:u,isLoading:t,isSaving:o,error:a,loadingProgress:r,isBookshelfMode:s,currentBookId:y,currentChapterId:P,setContext:T,clearContext:X,parseContextFromUrl:J,setSessionName:A,clearSessionName:f,setSessionList:D,addToSessionList:B,removeFromSessionList:F,renameInSessionList:i,setLoading:l,setSaving:v,setError:p,createSessionData:R,imageUrlToBase64:N,saveChapterSession:w,loadSessionByPath:C,setBookChapterContext:V,reset:E}}),ha={key:0,class:"translation-progress-bar"},ya={class:"progress-bar-label"},xa={class:"progress-bar"},Sa=He({__name:"ProgressBar",props:{visible:{type:Boolean,default:!0},percentage:{},label:{default:"进度"}},setup(n){return(c,u)=>n.visible?(K(),G("div",ha,[e("div",ya,ue(n.label),1),e("div",xa,[e("div",{class:"progress",style:st({width:`${n.percentage}%`})},null,4)])])):fe("",!0)}}),gn=qe(Sa,[["__scopeId","data-v-f915cadf"]]),ka={class:"image-upload"},_a={class:"error-text"},Ca={key:2,class:"loading-overlay"},wa=He({__name:"ImageUpload",emits:["uploadComplete"],setup(n,{expose:c,emit:u}){const t=u,r=Qe(),a=Ke(),o=S(null),s=S(!1),y=S(!1),P=S(""),T=S(0),V=S(""),X=S(!1),J=te(()=>a.settings.pdfProcessingMethod);function A(){o.value?.click()}async function f(C){const w=C.target;!w.files||w.files.length===0||(await i(Array.from(w.files)),w.value="")}async function D(C){C.preventDefault(),y.value=!1,!(!C.dataTransfer?.files||C.dataTransfer.files.length===0)&&await i(Array.from(C.dataTransfer.files))}function B(C){C.preventDefault(),y.value=!0}function F(C){const w=C.currentTarget.getBoundingClientRect(),m=C.clientX,g=C.clientY;(m<w.left||m>w.right||g<w.top||g>w.bottom)&&(y.value=!1)}async function i(C){if(C.length!==0){s.value=!0,P.value="",X.value=!0,T.value=0;try{let w=0;const m=C.length;for(let g=0;g<C.length;g++){const k=C[g];if(!k)continue;V.value=k.name;const $=k.type,b=k.name.toLowerCase();if($.startsWith("image/"))await l(k),w++;else if($==="application/pdf"||b.endsWith(".pdf")){const h=await v(k);w+=h}else if(b.endsWith(".mobi")||b.endsWith(".azw")||b.endsWith(".azw3")){const h=await N(k);w+=h}else console.warn(`不支持的文件类型: ${k.name}`),be(`不支持的文件类型: ${k.name}`,"warning");T.value=Math.round((g+1)/m*100)}w>0&&(be(`已添加 ${w} 张图片`,"success"),t("uploadComplete",w))}catch(w){console.error("处理文件失败:",w);const m=w instanceof Error?w.message:"处理文件失败，请重试";P.value=m,be(m,"error")}finally{s.value=!1,X.value=!1,V.value=""}}}async function l(C){return new Promise((w,m)=>{const g=new FileReader;g.onload=k=>{const $=k.target?.result;r.addImage(C.name,$),w()},g.onerror=()=>m(new Error(`读取图片文件失败: ${C.name}`)),g.readAsDataURL(C)})}async function v(C){return J.value==="frontend"?await R(C):await E(C)}function p(C){return new Promise((w,m)=>{const g=new FileReader;g.onload=()=>w(g.result),g.onerror=m,g.readAsDataURL(C)})}async function R(C){try{const w=await at(()=>import("./pdf.U7tdldy2.js").then(h=>h.p),[]);w.GlobalWorkerOptions.workerSrc=`https://cdnjs.cloudflare.com/ajax/libs/pdf.js/${w.version}/pdf.worker.min.js`;const m=await C.arrayBuffer(),g=await w.getDocument({data:m}).promise,k=g.numPages;console.log(`PDF ${C.name} 共 ${k} 页，开始本地渲染...`),be(`正在解析 PDF，共 ${k} 页...`,"info");const $=typeof OffscreenCanvas<"u";$&&console.log("使用 OffscreenCanvas 后台渲染模式");let b=0;for(let h=1;h<=k;h++){V.value=`${C.name} - 第 ${h}/${k} 页`,T.value=Math.round(h/k*100);try{const Y=await g.getPage(h),x=Y.getViewport({scale:2});let _;if($){const M=new OffscreenCanvas(x.width,x.height),ae=M.getContext("2d");await Y.render({canvasContext:ae,viewport:x}).promise;const L=await M.convertToBlob({type:"image/jpeg",quality:1});_=await p(L)}else{const M=document.createElement("canvas"),ae=M.getContext("2d");M.width=x.width,M.height=x.height,await Y.render({canvasContext:ae,viewport:x}).promise,_=M.toDataURL("image/jpeg",1)}const d=`${C.name}_页面${h}`;r.addImage(d,_),b++,console.log(`  页面 ${h}/${k} 处理完成`)}catch(Y){console.warn(`PDF ${C.name} 第 ${h} 页渲染失败:`,Y)}}return console.log(`PDF ${C.name} 全部 ${k} 页处理完成`),b}catch(w){return console.error("前端 PDF 解析失败:",w),be("前端 PDF 解析失败，尝试使用后端解析...","warning"),await E(C)}}async function E(C){let m=null;try{be("正在上传 PDF 文件...","info");const g=await zo(C,5);if(!g.success||!g.session_id)throw new Error(g.error||"PDF 解析启动失败");m=g.session_id;const k=g.total_pages||0;console.log(`PDF ${C.name} 共 ${k} 页，开始后端分批解析...`),be(`正在解析 PDF，共 ${k} 页...`,"info");let $=0;for(let b=0;b<k;b+=5){V.value=`${C.name} - 处理中 ${Math.min(b+5,k)}/${k} 页`,T.value=k>0?Math.round(b/k*100):0;const h=await Vo(m,b,5);if(!h.success){console.warn(`批次 ${b} 获取失败:`,h.error);continue}if(h.images&&h.images.length>0)for(const Y of h.images){if(!Y||!Y.data_url)continue;const W=`${C.name}_页面${String(Y.page_index+1).padStart(4,"0")}`;r.addImage(W,Y.data_url),$++}console.log(`  已加载 ${$}/${k} 页`)}return console.log(`PDF ${C.name} 全部 ${$} 页处理完成`),$}catch(g){throw console.error("后端 PDF 解析失败:",g),g}finally{if(m)try{await No(m)}catch(g){console.warn("PDF 会话清理失败:",g)}}}async function N(C){let w=null;try{be("正在上传电子书文件...","info");const m=await Wo(C,5);if(!m.success||!m.session_id)throw new Error(m.error||"MOBI/AZW 解析启动失败");w=m.session_id;const g=m.total_images||0;be(`正在解析电子书，共 ${g} 张图片...`,"info");let k=0,$=!0;for(;$;){V.value=`${C.name} - 已处理 ${k}/${g} 张`,T.value=g>0?Math.round(k/g*100):0;const b=await Ko(w);if(!b.success)throw new Error(b.error||"MOBI/AZW 批次解析失败");if(b.images&&b.images.length>0){for(let h=0;h<b.images.length;h++){const Y=b.images[h];if(!Y)continue;const W=k+h+1,x=`${C.name.replace(/\.(mobi|azw|azw3)$/i,"")}_image_${String(W).padStart(3,"0")}.png`,_=Y.startsWith("data:")?Y:`data:image/png;base64,${Y}`;r.addImage(x,_)}k+=b.images.length}$=b.has_more??!1}return k}catch(m){throw console.error("MOBI/AZW 解析失败:",m),m}finally{if(w)try{await qo(w)}catch(m){console.warn("MOBI/AZW 会话清理失败:",m)}}}function O(){P.value=""}return c({triggerFileSelect:A,processFiles:i,clearError:O}),(C,w)=>(K(),G("div",ka,[e("div",{id:"drop-area",class:De(["drop-area",{"drag-over":y.value,loading:s.value}]),onDragover:B,onDragleave:F,onDrop:D},[e("div",{class:"drop-content"},[e("p",{class:"drop-text"},[w[0]||(w[0]=Ue(" 拖拽图片、PDF或MOBI文件到这里，或 ",-1)),e("span",{class:"select-link",onClick:A}," 点击选择文件 ")])]),e("input",{ref_key:"fileInputRef",ref:o,type:"file",id:"imageUpload",accept:"image/*,application/pdf,.mobi,.azw,.azw3",multiple:"",class:"file-input",onChange:f},null,544)],34),X.value?(K(),it(gn,{key:0,visible:!0,percentage:T.value,label:V.value||"处理中..."},null,8,["percentage","label"])):fe("",!0),P.value?(K(),G("div",{key:1,class:"error-message",onClick:O},[w[1]||(w[1]=e("span",{class:"error-icon"},"⚠️",-1)),e("span",_a,ue(P.value),1),w[2]||(w[2]=e("span",{class:"error-close"},"×",-1))])):fe("",!0),s.value&&!X.value?(K(),G("div",Ca,[...w[3]||(w[3]=[e("div",{class:"spinner"},null,-1),e("span",{class:"loading-text"},"处理中...",-1)])])):fe("",!0)]))}}),$a=qe(wa,[["__scopeId","data-v-37201604"]]),Ta={id:"settings-sidebar",class:"settings-sidebar"},Ia={class:"card settings-card"},Da={id:"font-settings",class:"settings-card collapsible-panel"},Ra={class:"toggle-icon"},Ma={class:"collapsible-content"},Ba={class:"settings-form"},Ea={class:"form-group"},Pa=["value","disabled","title"],Aa={class:"auto-fontSize-option",title:"勾选后，首次翻译时自动为每个气泡计算合适的字号"},Fa=["checked"],La={class:"form-group"},Ua={class:"form-group"},Oa={class:"form-group"},za=["value"],Va={class:"form-group"},Na={class:"checkbox-label"},Wa=["checked"],Ka={key:0,id:"strokeOptions",class:"stroke-options"},qa={class:"form-group"},Ha=["value"],Ya={class:"form-group"},Ja=["value"],Xa={class:"form-group"},ja={key:0,id:"solidColorOptions",class:"form-group"},Ga=["value"],Za={class:"apply-settings-group"},Qa=["disabled"],es={key:0,class:"apply-options-dropdown"},ts={class:"apply-option"},ns=["checked"],os={class:"apply-option"},as={class:"apply-option"},ss={class:"apply-option"},ls={class:"apply-option"},is={class:"apply-option"},rs={class:"apply-option"},us={class:"apply-option"},cs={class:"apply-option"},ds={class:"action-buttons"},gs=["disabled"],ps=["disabled"],bs=["disabled"],vs=["disabled"],ms=["disabled"],fs=["disabled"],hs=["disabled"],ys=["disabled"],xs={class:"navigation-buttons"},Ss=["disabled"],ks=["disabled"],_s=He({__name:"SettingsSidebar",emits:["translateCurrent","translateAll","hqTranslate","proofread","removeText","removeAllText","deleteCurrent","clearAll","cleanTemp","openPlugins","openSettings","previous","next","applyToAll","textStyleChanged","autoFontSizeChanged"],setup(n,{emit:c}){const u=c,t=Qe(),r=Ke(),a=S(!0),o=S(!1),s=S({fontSize:!0,fontFamily:!0,layoutDirection:!0,textColor:!0,fillColor:!0,strokeEnabled:!0,strokeColor:!0,strokeWidth:!0}),y=[{label:"自动 (根据检测)",value:"auto"},{label:"竖向排版",value:"vertical"},{label:"横向排版",value:"horizontal"}],P=[{label:"纯色填充",value:"solid"},{label:"LAMA修复 (速度优化)",value:"lama_mpe"},{label:"LAMA修复 (通用)",value:"litelama"}],T=te(()=>t.currentImage),V=te(()=>t.hasImages),X=te(()=>V.value&&!t.isBatchTranslationInProgress),J=te(()=>t.canGoPrevious),A=te(()=>t.canGoNext),f=te(()=>r.textStyle),D=S([]),B=["fonts/STSONG.TTF","fonts/msyh.ttc","fonts/simhei.ttf","fonts/simsun.ttc"],F=S(null),i=te(()=>{const _=D.value.map(d=>({label:N(d),value:d}));return _.push({label:"自定义字体...",value:"custom-font"}),_});ut(async()=>{await l();const _=f.value.fontFamily;_&&!D.value.includes(_)&&(D.value=[_,...D.value])});async function l(){try{const _=await jn();if(_.fonts&&Array.isArray(_.fonts)&&_.fonts.length>0){const d=_.fonts[0];if(typeof d=="object"&&"path"in d){const M=_.fonts.map(ae=>typeof ae=="object"?ae.path:ae);D.value=M}else D.value=_.fonts}else D.value=[...B]}catch(_){console.error("加载字体列表失败:",_),D.value=[...B]}}function v(){a.value=!a.value}function p(_){const d=parseInt(_.target.value);isNaN(d)||(r.updateTextStyle({fontSize:d}),u("textStyleChanged","fontSize",d))}function R(_){const d=_.target.checked;r.updateTextStyle({autoFontSize:d}),console.log(`自动字号设置变更: ${d}`),u("autoFontSizeChanged",d)}async function E(_){const d=_.target,M=d.files?.[0];if(!M)return;const ae=[".ttf",".ttc",".otf"],L=M.name.toLowerCase();if(!ae.some(le=>L.endsWith(le))){be("请选择 .ttf、.ttc 或 .otf 格式的字体文件","error"),d.value="";return}try{const le=await jo(M);le.success&&le.fontPath?(await l(),r.updateTextStyle({fontFamily:le.fontPath}),be("字体上传成功","success")):be(le.error||"字体上传失败","error")}catch(le){console.error("字体上传失败:",le),be("字体上传失败","error")}finally{d.value=""}}function N(_){const d={"fonts/STXINGKA.TTF":"华文行楷","fonts/STXINWEI.TTF":"华文新魏","fonts/STZHONGS.TTF":"华文中宋","fonts/STKAITI.TTF":"楷体","fonts/STLITI.TTF":"隶书","fonts/STSONG.TTF":"华文宋体","fonts/msyh.ttc":"微软雅黑","fonts/msyhbd.ttc":"微软雅黑粗体","fonts/SIMYOU.TTF":"幼圆","fonts/STFANGSO.TTF":"仿宋","fonts/STHUPO.TTF":"华文琥珀","fonts/STXIHEI.TTF":"华文细黑","fonts/simkai.ttf":"中易楷体","fonts/simfang.ttf":"中易仿宋","fonts/simhei.ttf":"中易黑体","fonts/SIMLI.TTF":"中易隶书","fonts/simsun.ttc":"宋体"};if(d[_])return d[_];const M=_.split("/").pop()||_;for(const[ae,L]of Object.entries(d))if((ae.split("/").pop()||"").toLowerCase()===M.toLowerCase())return L;return M.replace(/\.(ttf|ttc|otf)$/i,"")}function O(_){const d=String(_);if(d==="custom-font"){F.value?.click();return}r.updateTextStyle({fontFamily:d}),u("textStyleChanged","fontFamily",d)}function C(_){const d=String(_);r.updateTextStyle({layoutDirection:d}),u("textStyleChanged","layoutDirection",d)}function w(_){const d=String(_);r.updateTextStyle({inpaintMethod:d})}function m(_){const d=_.target.value;r.updateTextStyle({textColor:d}),u("textStyleChanged","textColor",d)}function g(_){const d=_.target.checked;r.updateTextStyle({strokeEnabled:d}),u("textStyleChanged","strokeEnabled",d)}function k(_){const d=_.target.value;r.updateTextStyle({strokeColor:d}),u("textStyleChanged","strokeColor",d)}function $(_){const d=parseInt(_.target.value);isNaN(d)||(r.updateTextStyle({strokeWidth:d}),u("textStyleChanged","strokeWidth",d))}function b(_){const d=_.target.value;r.updateTextStyle({fillColor:d}),u("textStyleChanged","fillColor",d)}function h(){o.value=!o.value}function Y(){const d=!Object.values(s.value).every(M=>M);s.value={fontSize:d,fontFamily:d,layoutDirection:d,textColor:d,fillColor:d,strokeEnabled:d,strokeColor:d,strokeWidth:d}}function W(){u("applyToAll",{...s.value}),o.value=!1}function x(_){_.target.closest(".apply-settings-group")||(o.value=!1)}return typeof window<"u"&&window.addEventListener("click",x),(_,d)=>(K(),G("aside",Ta,[e("div",Ia,[d[42]||(d[42]=e("h2",null,"翻译设置",-1)),e("div",Da,[e("h3",{class:"collapsible-header",onClick:v},[d[20]||(d[20]=Ue(" 文字设置 ",-1)),e("span",Ra,ue(a.value?"▼":"▶"),1)]),oe(e("div",Ma,[e("div",Ba,[e("div",Ea,[d[22]||(d[22]=e("label",{for:"fontSize"},"字号大小:",-1)),e("input",{type:"number",id:"fontSize",value:f.value.fontSize,min:"10",max:"100",disabled:f.value.autoFontSize,class:De({"disabled-input":f.value.autoFontSize}),title:f.value.autoFontSize?"已启用自动字号，首次翻译时将自动计算":"",onInput:p},null,42,Pa),e("span",Aa,[e("input",{type:"checkbox",id:"autoFontSize",checked:f.value.autoFontSize,onChange:R},null,40,Fa),d[21]||(d[21]=e("label",{for:"autoFontSize"},"自动计算初始字号",-1))])]),e("div",La,[d[23]||(d[23]=e("label",{for:"fontFamily"},"文本字体:",-1)),me(Oe,{"model-value":f.value.fontFamily,options:i.value,onChange:O},null,8,["model-value","options"]),e("input",{ref_key:"fontUploadInput",ref:F,type:"file",id:"fontUpload",accept:".ttf,.ttc,.otf",style:{display:"none"},onChange:E},null,544)]),e("div",Ua,[d[24]||(d[24]=e("label",{for:"layoutDirection"},"排版设置:",-1)),me(Oe,{"model-value":f.value.layoutDirection,options:y,onChange:C},null,8,["model-value"])]),e("div",Oa,[d[25]||(d[25]=e("label",{for:"textColor"},"文字颜色:",-1)),e("input",{type:"color",id:"textColor",value:f.value.textColor,onInput:m},null,40,za)]),e("div",Va,[e("span",Na,[e("input",{type:"checkbox",id:"strokeEnabled",checked:f.value.strokeEnabled,onChange:g},null,40,Wa),d[26]||(d[26]=e("label",{for:"strokeEnabled"},"启用文本描边:",-1))])]),me(zn,{name:"stroke-slide"},{default:ht(()=>[f.value.strokeEnabled?(K(),G("div",Ka,[e("div",qa,[d[27]||(d[27]=e("label",{for:"strokeColor"},"描边颜色:",-1)),e("input",{type:"color",id:"strokeColor",value:f.value.strokeColor,onInput:k},null,40,Ha)]),e("div",Ya,[d[28]||(d[28]=e("label",{for:"strokeWidth"},"描边宽度 (px):",-1)),e("input",{type:"number",id:"strokeWidth",value:f.value.strokeWidth,min:"0",max:"10",style:{width:"60px",padding:"5px"},onInput:$},null,40,Ja),d[29]||(d[29]=e("div",{class:"input-hint"},"0 表示无描边。",-1))])])):fe("",!0)]),_:1}),e("div",Xa,[d[30]||(d[30]=e("label",{for:"useInpainting"},"气泡填充方式:",-1)),me(Oe,{"model-value":f.value.inpaintMethod,options:P,onChange:w},null,8,["model-value"])]),me(zn,{name:"slide-fade"},{default:ht(()=>[f.value.inpaintMethod==="solid"?(K(),G("div",ja,[d[31]||(d[31]=e("label",{for:"fillColor"},"填充颜色:",-1)),e("input",{type:"color",id:"fillColor",value:f.value.fillColor,onInput:b},null,40,Ga)])):fe("",!0)]),_:1})]),e("div",Za,[e("button",{type:"button",class:"settings-button",disabled:!V.value,onClick:W}," 应用到全部 ",8,Qa),e("button",{type:"button",class:"settings-gear-btn",title:"选择要应用的参数",onClick:h}," ⚙️ "),o.value?(K(),G("div",es,[e("div",ts,[e("input",{type:"checkbox",id:"apply_selectAll",checked:Object.values(s.value).every(M=>M),onChange:Y},null,40,ns),d[32]||(d[32]=e("label",{for:"apply_selectAll"},"全选",-1))]),d[41]||(d[41]=e("hr",null,null,-1)),e("div",os,[oe(e("input",{type:"checkbox",id:"apply_fontSize","onUpdate:modelValue":d[0]||(d[0]=M=>s.value.fontSize=M)},null,512),[[Ze,s.value.fontSize]]),d[33]||(d[33]=e("label",{for:"apply_fontSize"},"字号",-1))]),e("div",as,[oe(e("input",{type:"checkbox",id:"apply_fontFamily","onUpdate:modelValue":d[1]||(d[1]=M=>s.value.fontFamily=M)},null,512),[[Ze,s.value.fontFamily]]),d[34]||(d[34]=e("label",{for:"apply_fontFamily"},"字体",-1))]),e("div",ss,[oe(e("input",{type:"checkbox",id:"apply_layoutDirection","onUpdate:modelValue":d[2]||(d[2]=M=>s.value.layoutDirection=M)},null,512),[[Ze,s.value.layoutDirection]]),d[35]||(d[35]=e("label",{for:"apply_layoutDirection"},"排版方向",-1))]),e("div",ls,[oe(e("input",{type:"checkbox",id:"apply_textColor","onUpdate:modelValue":d[3]||(d[3]=M=>s.value.textColor=M)},null,512),[[Ze,s.value.textColor]]),d[36]||(d[36]=e("label",{for:"apply_textColor"},"文字颜色",-1))]),e("div",is,[oe(e("input",{type:"checkbox",id:"apply_fillColor","onUpdate:modelValue":d[4]||(d[4]=M=>s.value.fillColor=M)},null,512),[[Ze,s.value.fillColor]]),d[37]||(d[37]=e("label",{for:"apply_fillColor"},"填充颜色",-1))]),e("div",rs,[oe(e("input",{type:"checkbox",id:"apply_strokeEnabled","onUpdate:modelValue":d[5]||(d[5]=M=>s.value.strokeEnabled=M)},null,512),[[Ze,s.value.strokeEnabled]]),d[38]||(d[38]=e("label",{for:"apply_strokeEnabled"},"描边开关",-1))]),e("div",us,[oe(e("input",{type:"checkbox",id:"apply_strokeColor","onUpdate:modelValue":d[6]||(d[6]=M=>s.value.strokeColor=M)},null,512),[[Ze,s.value.strokeColor]]),d[39]||(d[39]=e("label",{for:"apply_strokeColor"},"描边颜色",-1))]),e("div",cs,[oe(e("input",{type:"checkbox",id:"apply_strokeWidth","onUpdate:modelValue":d[7]||(d[7]=M=>s.value.strokeWidth=M)},null,512),[[Ze,s.value.strokeWidth]]),d[40]||(d[40]=e("label",{for:"apply_strokeWidth"},"描边宽度",-1))])])):fe("",!0)])],512),[[ze,a.value]])]),e("div",ds,[e("button",{id:"translateButton",disabled:!X.value,onClick:d[8]||(d[8]=M=>u("translateCurrent"))}," 翻译当前图片 ",8,gs),e("button",{id:"translateAllButton",disabled:!X.value,onClick:d[9]||(d[9]=M=>u("translateAll"))}," 翻译所有图片 ",8,ps),e("button",{id:"startHqTranslationBtn",class:"settings-button purple-button",disabled:!X.value,title:"使用高质量翻译模式（需在设置中配置）",onClick:d[10]||(d[10]=M=>u("hqTranslate"))}," 高质量翻译 ",8,bs),e("button",{id:"proofreadButton",disabled:!X.value,onClick:d[11]||(d[11]=M=>u("proofread"))}," AI校对 ",8,vs),e("button",{id:"removeTextOnlyButton",disabled:!T.value,title:"消除图片中的气泡文字，无需填写翻译服务商和API Key",onClick:d[12]||(d[12]=M=>u("removeText"))}," 仅消除文字 ",8,ms),e("button",{id:"removeAllTextButton",disabled:!V.value,title:"消除所有图片中的气泡文字，无需填写翻译服务商和API Key",onClick:d[13]||(d[13]=M=>u("removeAllText"))}," 消除所有图片文字 ",8,fs),e("button",{id:"deleteCurrentImageButton",class:"settings-button red-button",disabled:!T.value,onClick:d[14]||(d[14]=M=>u("deleteCurrent"))}," 删除当前图片 ",8,hs),e("button",{id:"clearAllImagesButton",class:"settings-button red-button",disabled:!V.value,onClick:d[15]||(d[15]=M=>u("clearAll"))}," 清除所有图片 ",8,ys),e("button",{id:"cleanDebugFilesButton",class:"settings-button orange-button",onClick:d[16]||(d[16]=M=>u("cleanTemp"))}," 清理临时文件 "),e("button",{id:"managePluginsButton",class:"settings-button blue-button",onClick:d[17]||(d[17]=M=>u("openPlugins"))}," 插件管理 ")]),e("div",xs,[e("button",{id:"prevImageButton",disabled:!J.value,onClick:d[18]||(d[18]=M=>u("previous"))}," 上一张 ",8,Ss),e("button",{id:"nextImageButton",disabled:!A.value,onClick:d[19]||(d[19]=M=>u("next"))}," 下一张 ",8,ks)])])]))}}),Cs=qe(_s,[["__scopeId","data-v-2dcef39a"]]);function kt(n){if(n.textDirection&&n.textDirection!=="auto")return n.textDirection;if(n.autoTextDirection&&n.autoTextDirection!=="auto")return n.autoTextDirection;if(n.coords){const[c,u,t,r]=n.coords;return r-u>t-c?"vertical":"horizontal"}return"vertical"}function ws(){const n=Qe(),c=Ke(),u=rt(),t=S(!1),r=S(0),a=S(""),o=S(!1),s=S(0),y=S(""),P=te(()=>n.hasImages),T=te(()=>n.hasImages),V=te(()=>n.hasImages);function X(){const i=n.images;if(i.length===0){u.warning("没有可导出的图片文本");return}const l=[];for(let C=0;C<i.length;C++){const w=i[C];if(!w)continue;const m=w.bubbleStates||[],g={imageIndex:C,bubbles:[]};for(let k=0;k<m.length;k++){const $=m[k];if(!$)continue;const b=$.originalText||"",h=$.translatedText||$.textboxText||"";let Y="vertical";$.textDirection&&$.textDirection!=="auto"?Y=$.textDirection:$.autoTextDirection&&(Y=$.autoTextDirection),g.bubbles.push({bubbleIndex:k,original:b,translated:h,textDirection:Y})}l.push(g)}const v=JSON.stringify(l,null,2),p=new Blob([v],{type:"application/json"}),R=URL.createObjectURL(p),E=document.createElement("a");E.href=R;const O=new Date().toISOString().replace(/[-:T]/g,"").slice(0,15);E.download=`translations_${O}.json`,document.body.appendChild(E),E.click(),document.body.removeChild(E),URL.revokeObjectURL(R),u.success("文本导出成功！")}function J(){const i=n.images;if(i.length===0)return null;const l=[];for(let v=0;v<i.length;v++){const p=i[v];if(!p)continue;const R=p.bubbleStates||[],E={imageIndex:v,bubbles:[]};for(let N=0;N<R.length;N++){const O=R[N];if(!O)continue;const C=O.originalText||"",w=O.translatedText||O.textboxText||"";let m="vertical";O.textDirection&&O.textDirection!=="auto"?m=O.textDirection:O.autoTextDirection&&(m=O.autoTextDirection),E.bubbles.push({bubbleIndex:N,original:C,translated:w,textDirection:m})}l.push(E)}return l}async function A(i){if(!i){u.warning("未选择文件");return}o.value=!0,s.value=0,y.value="准备导入文本...",u.info("正在导入文本...",0);try{const l=await f(i);s.value=10,y.value="解析 JSON 数据...";const v=JSON.parse(l);if(!Array.isArray(v))throw new Error("导入的 JSON 格式不正确，应为数组");let p=0,R=0;const E=c.settings.textStyle,N=E.autoFontSize?"auto":E.fontSize,O=E.fontFamily,C=E.textColor,w=E.fillColor;s.value=20,y.value="开始更新图片...";const m=v.length;let g=0;const k=[];for(const h of v){g++;const Y=20+g/m*60;s.value=Y,y.value=`处理图片 ${g}/${m}`;const W=h.imageIndex;if(W<0||W>=n.images.length){console.warn(`跳过无效的图片索引: ${W}`);continue}const x=n.images[W];if(!x)continue;let _=!1;x.bubbleStates||(x.bubbleStates=[]),x.bubbleTexts||(x.bubbleTexts=[]),x.originalTexts||(x.originalTexts=[]);for(const d of h.bubbles){const M=d.bubbleIndex,ae=d.original,L=d.translated,j=d.textDirection,le=j==="vertical"||j==="horizontal"?j:"vertical";for(;x.bubbleTexts.length<=M;)x.bubbleTexts.push("");for(;x.originalTexts.length<=M;)x.originalTexts.push("");for(ae&&(x.originalTexts[M]=ae),L&&(x.bubbleTexts[M]=L);x.bubbleStates.length<=M;)x.bubbleStates.push(D(N,O,C,w));const U=x.bubbleStates[M];U&&(ae&&(U.originalText=ae),L&&(U.translatedText=L,U.textboxText=L),U.textDirection=le,_=!0,R++)}_&&x.bubbleStates&&(x.bubbleTexts=x.bubbleStates.map(d=>d.translatedText||"")),_&&(p++,x.hasUnsavedChanges=!0,x.translatedDataURL&&x.bubbleStates&&x.bubbleStates.length>0&&k.push(W))}if(k.length>0){s.value=80,y.value="开始渲染图片...",u.info("正在渲染图片，请稍候...",0);const h=c.settings.textStyle,Y=h.layoutDirection,W=Y==="auto";for(let x=0;x<k.length;x++){const _=k[x];if(_===void 0)continue;const d=n.images[_];if(!(!d||!d.bubbleStates)){s.value=80+x/k.length*20,y.value=`渲染图片 ${x+1}/${k.length}`;try{let M="";if(d.cleanImageData?M=d.cleanImageData.includes("base64,")?d.cleanImageData.split("base64,")[1]||"":d.cleanImageData:d.originalDataURL&&(M=d.originalDataURL.includes("base64,")?d.originalDataURL.split("base64,")[1]||"":d.originalDataURL,console.log(`importText: 图片 ${_} 使用原图作为背景（兜底）`)),!M){console.log(`importText: 图片 ${_} 没有可用的背景图，跳过`);continue}const ae=d.bubbleStates.map(j=>({translatedText:j.translatedText||"",coords:j.coords,fontSize:j.fontSize||h.fontSize,fontFamily:j.fontFamily||h.fontFamily,textDirection:kt(j),textColor:j.textColor||h.textColor,rotationAngle:j.rotationAngle||0,position:j.position||{x:0,y:0},strokeEnabled:j.strokeEnabled??h.strokeEnabled,strokeColor:j.strokeColor||h.strokeColor,strokeWidth:j.strokeWidth??h.strokeWidth})),L=await un({clean_image:M,bubble_texts:ae.map(j=>j.translatedText),bubble_coords:ae.map(j=>j.coords),fontSize:h.fontSize,fontFamily:h.fontFamily,textDirection:W?"vertical":Y,textColor:h.textColor,bubble_states:ae,use_individual_styles:!0,use_inpainting:!1,use_lama:!1,is_font_style_change:!0,strokeEnabled:h.strokeEnabled,strokeColor:h.strokeColor,strokeWidth:h.strokeWidth});L.rendered_image&&(n.updateImageByIndex(_,{translatedDataURL:`data:image/png;base64,${L.rendered_image}`,hasUnsavedChanges:!0}),console.log(`importText: 图片 ${_} 渲染成功`))}catch(M){console.error(`importText: 重渲染图片 ${_} 失败:`,M)}}}}s.value=100,y.value="导入完成";const $=k.length,b=$>0?`导入成功！更新了 ${p} 张图片中的 ${R} 个气泡文本，重渲染了 ${$} 张图片`:`导入成功！更新了 ${p} 张图片中的 ${R} 个气泡文本`;u.success(b)}catch(l){console.error("导入文本出错:",l),u.error(`导入失败: ${l instanceof Error?l.message:String(l)}`)}finally{o.value=!1,setTimeout(()=>{s.value=0,y.value=""},2e3)}}function f(i){return new Promise((l,v)=>{const p=new FileReader;p.onload=R=>{R.target?.result?l(R.target.result):v(new Error("读取文件失败"))},p.onerror=()=>v(new Error("读取文件时出错")),p.readAsText(i)})}function D(i,l,v,p){const R=c.settings.textStyle;return{coords:[0,0,100,100],polygon:[],originalText:"",translatedText:"",textboxText:"",fontSize:typeof i=="number"?i:25,fontFamily:l,textDirection:"vertical",autoTextDirection:"vertical",textColor:v,fillColor:p,rotationAngle:0,position:{x:0,y:0},strokeEnabled:R.strokeEnabled,strokeColor:R.strokeColor,strokeWidth:R.strokeWidth,inpaintMethod:R.inpaintMethod}}function B(){const i=n.currentImage;if(!i){u.warning("没有可下载的图片");return}const l=i.translatedDataURL||i.originalDataURL;if(!l){u.warning("没有可下载的图片");return}t.value=!0;try{const v=l.split(",")[1];if(!v)throw new Error("无效的图片数据");const p=atob(v),R=[];for(let m=0;m<p.length;m+=512){const g=p.slice(m,m+512),k=new Array(g.length);for(let b=0;b<g.length;b++)k[b]=g.charCodeAt(b);const $=new Uint8Array(k);R.push($.buffer)}const E=new Blob(R,{type:"image/png"}),N=URL.createObjectURL(E),O=document.createElement("a");O.href=N;let C=i.fileName||`image_${n.currentImageIndex}.png`;C=`${i.translatedDataURL?"translated":"original"}_${C.replace(/\.[^/.]+$/,"")}.png`,O.download=C,document.body.appendChild(O),O.click(),document.body.removeChild(O),URL.revokeObjectURL(N),u.success(`下载成功: ${C}`)}catch(v){console.error("下载图片时出错:",v),u.error("下载失败")}finally{t.value=!1}}async function F(i="zip"){const l=n.images;if(l.length===0){u.warning("没有可下载的图片");return}t.value=!0,r.value=0,a.value="准备下载...",u.info("下载中...处理可能需要一定时间，请耐心等待...",0);try{const v=[];let p=0,R=0;r.value=5,a.value="检查图片数据...";for(let b=0;b<l.length;b++){const h=l[b];h&&(h.translatedDataURL?(v.push({index:b,type:"translated"}),p++):h.originalDataURL&&(v.push({index:b,type:"original"}),R++))}if(v.length===0){u.warning("没有可下载的图片");return}r.value=10,a.value="创建下载会话...";const E=await Ho(v.length);if(!E.success||!E.session_id)throw new Error(E.error||"创建会话失败");const N=E.session_id,O=v.length;let C=0,w=0;for(let b=0;b<v.length;b++){const h=v[b];if(!h)continue;const Y=l[h.index];if(!Y)continue;const W=h.type==="translated"?Y.translatedDataURL:Y.originalDataURL;if(!W)continue;const x=10+b/O*70;r.value=x,a.value=`上传图片 ${b+1}/${O}...`;try{const _=await Yo(N,W,b);_.success?C++:(console.error(`上传图片 ${b} 失败:`,_.error),w++)}catch(_){console.error(`上传图片 ${b} 出错:`,_),w++}}if(C===0)throw new Error("所有图片上传失败");r.value=85,a.value="打包文件...";const m=await Jo(N,i);if(!m.success||!m.file_id)throw new Error(m.error||"打包失败");r.value=95,a.value="准备下载...";const g=Xo(m.file_id,i),k=document.createElement("a");k.href=g,document.body.appendChild(k),k.click(),document.body.removeChild(k),r.value=100,a.value="下载已开始";let $=`已成功处理 ${C} 张图片`;w>0&&($+=`（${w} 张失败）`),p>0&&R>0?$+=`（${p} 张翻译图片和 ${R} 张原始图片）`:p>0?$+="（全部为翻译后图片）":R>0&&($+="（全部为原始图片）"),$+="，下载即将开始",u.success($),setTimeout(async()=>{try{const b=await rn();console.log("临时文件清理结果:",b)}catch(b){console.error("清理临时文件失败:",b)}},6e4)}catch(v){console.error("下载所有图片时出错:",v),u.error(`下载失败: ${v instanceof Error?v.message:String(v)}`)}finally{t.value=!1,setTimeout(()=>{r.value=0,a.value=""},2e3)}}return{isDownloading:t,downloadProgress:r,downloadProgressText:a,isImporting:o,importProgress:s,importProgressText:y,canExportText:P,canImportText:T,canDownload:V,exportText:X,exportTextToJson:J,importText:A,downloadCurrentImage:B,downloadAllImages:F}}const $s={key:0,class:"result-section card result-card"},Ts={class:"image-controls"},Is={class:"image-size-control"},Ds=["value"],Rs={id:"imageSizeValue"},Ms={class:"content-container"},Bs={class:"image-container"},Es=["src"],Ps={id:"detectedTextInfo",class:"text-info"},As={id:"detectedTextList"},Fs={class:"original-text"},Ls={class:"download-section"},Us={class:"download-buttons"},Os=["disabled"],zs={class:"download-all-container"},Vs=["disabled"],Ns={class:"download-format-selector"},Ws=["disabled"],Ks=["disabled"],qs={key:1,class:"empty-state-section"},jt=60,Hs=He({__name:"ImageResultDisplay",props:{isEditMode:{type:Boolean,default:!1}},emits:["toggle-edit-mode","retry-failed"],setup(n,{emit:c}){const u=[{label:"ZIP压缩包",value:"zip"},{label:"PDF文档",value:"pdf"},{label:"CBZ漫画",value:"cbz"}],t=c,r=Qe(),a=Ke(),o=ws(),s=S(100),y=te({get:()=>f.value?.showOriginal??!1,set:x=>{f.value&&r.updateCurrentImage({showOriginal:x})}}),P=S("zip"),T=S(null),V=te(()=>o.isDownloading.value),X=te(()=>o.downloadProgressText.value),J=te(()=>o.downloadProgress.value),A=te(()=>r.hasImages),f=te(()=>r.currentImage),D=te(()=>!!f.value?.translatedDataURL),B=te(()=>!!(f.value?.translatedDataURL||f.value?.originalDataURL)),F=te(()=>f.value?y.value||!f.value.translatedDataURL?f.value.originalDataURL:f.value.translatedDataURL:""),i=te(()=>r.failedImageCount>0),l=te(()=>({width:`${s.value}%`})),v=te(()=>a.settings.useTextboxPrompt),p=te(()=>{if(!f.value)return[];if(f.value.bubbleStates&&f.value.bubbleStates.length>0)return f.value.bubbleStates.map(d=>({original:d.originalText||"",translated:v.value?d.textboxText||d.translatedText||"":d.translatedText||""}));const x=f.value.originalTexts||[],_=v.value?f.value.textboxTexts||f.value.bubbleTexts||[]:f.value.bubbleTexts||[];return x.length===0?[]:x.map((d,M)=>({original:d||"",translated:_[M]||""}))}),R=te(()=>p.value.length>0);function E(x){if(!x||x.length<=jt)return x;let _="",d="";for(let M=0;M<x.length;M++)if(d+=x[M],d.length>=jt){let ae=-1;for(let L=d.length-1;L>=0;L--){const j=d[L];if(j&&["。","！","？",".","!","?","；",";","，",","].includes(j)){ae=L+1;break}}ae>jt*.6?(_+=d.substring(0,ae)+`
`,d=d.substring(ae)):(_+=d+`
`,d="")}return d&&(_+=d),_}function N(x){return E((x||"").trim())}function O(x){const _=(x||"").trim();return E(_)}function C(x){return(x||"").includes("翻译失败")}function w(){y.value=!y.value}function m(){t("toggle-edit-mode")}function g(x){const _=x.target;s.value=parseInt(_.value,10)}function k(){t("retry-failed")}function $(){o.downloadCurrentImage()}function b(){o.downloadAllImages(P.value)}function h(){o.exportText()}function Y(){T.value?.click()}async function W(x){const _=x.target,d=_.files?.[0];d&&(await o.importText(d),_.value="")}return(x,_)=>f.value?(K(),G("section",$s,[e("div",Ts,[D.value?(K(),G("button",{key:0,id:"toggleImageButton",class:"control-btn",onClick:w},ue(y.value?"查看翻译图":"查看原图"),1)):fe("",!0),e("button",{id:"toggleEditModeButton",class:De(["control-btn",{active:n.isEditMode}]),onClick:m},ue(n.isEditMode?"退出编辑":"切换编辑模式"),3),e("div",Is,[_[1]||(_[1]=e("label",{for:"imageSize"},"图片大小:",-1)),e("input",{type:"range",id:"imageSize",min:"50",max:"200",value:s.value,class:"slider range-slider",onInput:g},null,40,Ds),e("span",Rs,ue(s.value)+"%",1)]),i.value?(K(),G("button",{key:1,id:"retranslateFailedButton",class:"retry-failed-btn",onClick:k,title:"重新翻译所有失败的图片"}," 重新翻译失败图片 ("+ue(re(r).failedImageCount)+") ",1)):fe("",!0)]),e("div",Ms,[e("div",Bs,[e("img",{id:"translatedImageDisplay",src:F.value,alt:"翻译后图片",style:st(l.value)},null,12,Es)])]),e("div",Ps,[_[6]||(_[6]=e("h3",null,"检测到的文本（原文 → 译文）",-1)),e("pre",As,[R.value?(K(!0),G(Xe,{key:0},Ge(p.value,(d,M)=>(K(),G("span",{key:M,class:"text-item"},[e("span",Fs,ue(N(d.original)),1),_[2]||(_[2]=Ue(`
`,-1)),e("span",{class:De(["translated-text",{"translation-error":C(d.translated)}])},ue(O(d.translated)),3),_[3]||(_[3]=Ue(`
`,-1)),_[4]||(_[4]=e("span",{class:"separator"},"──────────────────────────",-1)),_[5]||(_[5]=Ue(`

`,-1))]))),128)):(K(),G(Xe,{key:1},[Ue("未检测到文本或尚未翻译")],64))])]),e("div",Ls,[V.value?(K(),it(gn,{key:0,visible:!0,percentage:J.value,label:X.value||"下载中，请稍候..."},null,8,["percentage","label"])):fe("",!0),e("div",Us,[e("button",{id:"downloadButton",class:"download-btn primary",disabled:!B.value,onClick:$}," 下载当前图片 ",8,Os),e("div",zs,[e("button",{id:"downloadAllImagesButton",class:"download-btn primary",disabled:!A.value,onClick:b}," 下载所有图片 ",8,Vs),e("div",Ns,[me(Oe,{modelValue:P.value,"onUpdate:modelValue":_[0]||(_[0]=d=>P.value=d),options:u},null,8,["modelValue"])])]),e("button",{id:"exportTextButton",class:"download-btn success",disabled:!A.value,onClick:h}," 导出文本 ",8,Ws),e("button",{id:"importTextButton",class:"download-btn success",disabled:!A.value,onClick:Y}," 导入文本 ",8,Ks),e("input",{type:"file",ref_key:"importFileInput",ref:T,id:"importTextFileInput",style:{display:"none"},accept:".json",onChange:W},null,544)])])])):(K(),G("section",qs))}}),Ys=qe(Hs,[["__scopeId","data-v-a26b9c58"]]),Js={class:"guide-content"},Xs={class:"guide-footer"},js={class:"dont-show-option"},It="saber_translator_dismiss_setup_reminder",Gs=He({__name:"FirstTimeGuide",emits:["openSettings"],setup(n,{expose:c,emit:u}){const t=u,r=S(!1),a=S(!1);ut(()=>{localStorage.getItem(It)!=="true"&&(r.value=!0)});function o(){a.value&&localStorage.setItem(It,"true"),r.value=!1}function s(){localStorage.setItem(It,"true"),r.value=!1,t("openSettings")}function y(){localStorage.removeItem(It)}return c({resetGuideState:y,showGuide:r}),(P,T)=>(K(),it(Gn,{"model-value":r.value,title:"欢迎使用 Saber-Translator",onClose:o},{default:ht(()=>[e("div",Js,[T[3]||(T[3]=e("div",{class:"guide-icon"},"🎉",-1)),T[4]||(T[4]=e("div",{class:"guide-message"},[e("p",{class:"guide-title"},"首次使用提醒"),e("p",{class:"guide-text"}," 在开始翻译之前，请先配置翻译服务。 "),e("p",{class:"guide-text"},[Ue(" 点击右上角的 "),e("span",{class:"highlight"},"⚙️ 设置"),Ue(" 按钮，配置以下内容： ")]),e("ul",{class:"guide-list"},[e("li",null,"选择 OCR 引擎（文字识别）"),e("li",null,"配置翻译服务商和 API Key"),e("li",null,"（可选）配置高质量翻译和 AI 校对")])],-1)),e("div",{class:"guide-actions"},[e("button",{class:"guide-btn primary",onClick:s},[...T[1]||(T[1]=[e("span",{class:"btn-icon"},"⚙️",-1),Ue(" 立即配置 ",-1)])]),e("button",{class:"guide-btn secondary",onClick:o}," 稍后配置 ")]),e("div",Xs,[e("label",js,[oe(e("input",{type:"checkbox","onUpdate:modelValue":T[0]||(T[0]=V=>a.value=V)},null,512),[[Ze,a.value]]),T[2]||(T[2]=e("span",null,"不再显示此提醒",-1))])])])]),_:1},8,["model-value"]))}}),Zs=qe(Gs,[["__scopeId","data-v-eda18e4a"]]),Gt="saber_translator_dismiss_setup_reminder",Qs=["siliconflow","deepseek","volcano","caiyun","baidu_translate","youdao_translate","gemini","custom_openai"],el={manga_ocr:"MangaOCR",paddle_ocr:"PaddleOCR",baidu_ocr:"百度OCR",ai_vision:"AI视觉OCR"},tl=["ollama","sakura"],nl=["custom_openai"],ol=["custom_openai"],al={siliconflow:"SiliconFlow",deepseek:"DeepSeek",volcano:"火山引擎",caiyun:"彩云小译",baidu_translate:"百度翻译",youdao_translate:"有道翻译",gemini:"Google Gemini",custom_openai:"自定义 OpenAI",ollama:"Ollama",sakura:"Sakura"};function Pt(){const n=Ke(),c=rt(),u=S(!1),t=S(!1),r=te(()=>{try{return localStorage.getItem(Gt)==="true"}catch{return!1}});function a(p){return al[p]||p}function o(p){return Qs.includes(p)}function s(p){return tl.includes(p)}function y(p){return nl.includes(p)}function P(p){return ol.includes(p)}function T(p){return el[p]||p}function V(){const p=n.settings,R=p.ocrEngine,E=p.baiduOcr,N=p.aiVisionOcr,O=[];return R?(R==="baidu_ocr"&&((!E?.apiKey||E.apiKey.trim()==="")&&O.push("百度OCR 的 API Key"),(!E?.secretKey||E.secretKey.trim()==="")&&O.push("百度OCR 的 Secret Key")),R==="ai_vision"&&(N?.provider||O.push("AI视觉OCR 的服务商"),(!N?.apiKey||N.apiKey.trim()==="")&&O.push("AI视觉OCR 的 API Key"),(!N?.modelName||N.modelName.trim()==="")&&O.push("AI视觉OCR 的模型名称"),N?.provider==="custom"&&(!N?.customBaseUrl||N.customBaseUrl.trim()==="")&&O.push("AI视觉OCR 的自定义 Base URL")),O.length>0?{valid:!1,message:`请先在顶部 ⚙️ 设置菜单中填写 ${O[0]}`,missingItems:O}:{valid:!0,message:""}):{valid:!1,message:"请先在顶部 ⚙️ 设置菜单中选择 OCR 引擎",missingItems:["OCR 引擎"]}}function X(){const{translation:p}=n.settings,{provider:R,apiKey:E,modelName:N,customBaseUrl:O}=p,C=[];return R?(o(R)&&(!E||E.trim()==="")&&C.push(`${a(R)} 的 API Key`),(!N||N.trim()==="")&&(s(R)||o(R))&&C.push(`${a(R)} 的模型名称`),y(R)&&(!O||O.trim()==="")&&C.push("自定义 OpenAI 服务的 Base URL"),C.length>0?{valid:!1,message:`请先在顶部 ⚙️ 设置菜单中填写 ${C[0]}`,missingItems:C}:{valid:!0,message:""}):{valid:!1,message:"请先在顶部 ⚙️ 设置菜单中选择翻译服务商",missingItems:["翻译服务商"]}}function J(){const{hqTranslation:p}=n.settings,{provider:R,apiKey:E,modelName:N,customBaseUrl:O}=p,C=[];return R?((!E||E.trim()==="")&&C.push("高质量翻译的 API Key"),(!N||N.trim()==="")&&C.push("高质量翻译的模型名称"),P(R)&&(!O||O.trim()==="")&&C.push("高质量翻译的 Base URL"),C.length>0?{valid:!1,message:`请先在顶部 ⚙️ 设置菜单中填写 ${C[0]}`,missingItems:C}:{valid:!0,message:""}):{valid:!1,message:"请先在顶部 ⚙️ 设置菜单中选择高质量翻译的服务商",missingItems:["高质量翻译服务商"]}}function A(p){const R=p||n.settings.proofreading.rounds,E=[];if(!R||R.length===0)return{valid:!1,message:"请先在顶部 ⚙️ 设置菜单中添加至少一个校对轮次",missingItems:["校对轮次"]};for(let N=0;N<R.length;N++){const O=R[N];if(!O)continue;const C=O.name||`轮次${N+1}`;if(O.provider||E.push(`校对 ${C} 的服务商`),(!O.apiKey||O.apiKey.trim()==="")&&E.push(`校对 ${C} 的 API Key`),(!O.modelName||O.modelName.trim()==="")&&E.push(`校对 ${C} 的模型名称`),E.length>0)return{valid:!1,message:`请先在顶部 ⚙️ 设置菜单中为 ${E[0]}`,missingItems:E}}return{valid:!0,message:""}}function f(p="normal",R={}){let E;switch(p){case"normal":E=X();break;case"hq":E=J();break;case"proofread":E=A(R.proofreadingRounds);break;case"ocr":E=V();break;default:E=X()}return E.valid?!0:(c.error(E.message),B(),!1)}function D(){const p=V();if(!p.valid)return c.error(p.message),B(),!1;const R=X();return R.valid?!0:(c.error(R.message),B(),!1)}function B(){const p=document.getElementById("openSettingsBtn");p&&(t.value=!0,p.style.animation="settingsBtnPulse 0.5s ease-in-out 3",p.style.boxShadow="0 0 10px var(--primary-color, #4a90d9)",setTimeout(()=>{p.style.animation="",p.style.boxShadow="",t.value=!1},3e3))}function F(){if(r.value){console.log("用户已选择不再显示设置提醒");return}u.value=!0}function i(p=!1){if(p)try{localStorage.setItem(Gt,"true"),console.log("用户选择永久关闭设置提醒")}catch(R){console.error("保存设置提醒状态失败:",R)}u.value=!1}function l(){try{localStorage.removeItem(Gt),console.log("设置提醒状态已重置")}catch(p){console.error("重置设置提醒状态失败:",p)}}function v(){setTimeout(()=>{F()},500)}return{showSetupReminder:u,isSettingsButtonHighlighted:t,isSetupReminderDismissed:r,validateOcrConfig:V,validateTranslationConfig:X,validateHqTranslationConfig:J,validateProofreadingConfig:A,validateBeforeTranslation:f,validateFullTranslationConfig:D,highlightSettingsButton:B,checkAndShowSetupReminder:F,closeSetupReminder:i,resetSetupReminderDismiss:l,initValidation:v,getProviderDisplayName:a,getOcrEngineDisplayName:T,requiresApiKey:o,isLocalProvider:s,requiresBaseUrl:y}}const Dt={originalText:"",translatedText:"",textboxText:"",coords:[0,0,100,100],polygon:[],fontSize:25,fontFamily:"fonts/STSONG.TTF",textDirection:"auto",autoTextDirection:"vertical",textColor:"#000000",fillColor:Yn,rotationAngle:0,position:{x:0,y:0},strokeEnabled:sn,strokeColor:an,strokeWidth:on,inpaintMethod:"solid"};function en(n){return{...{...Dt,...n},coords:n?.coords?[...n.coords]:[...Dt.coords],polygon:n?.polygon?n.polygon.map(u=>[...u]):[],position:n?.position?{...Dt.position,...n.position}:{...Dt.position}}}function eo(n){const[c,u,t,r]=n,a=Math.abs(t-c);return Math.abs(r-u)>a?"vertical":"horizontal"}function to(n,c){const{bubble_coords:u=[],bubble_states:t=[],original_texts:r=[],bubble_texts:a=[],textbox_texts:o=[],bubble_angles:s=[],auto_directions:y=[]}=n;return t.length>0?t.map((P,T)=>({...en(c),...P,coords:P.coords||u[T]||[0,0,100,100]})):u.map((P,T)=>{let V;return y[T]?V=y[T]==="v"?"vertical":"horizontal":V=eo(P),en({coords:P,originalText:r[T]||"",translatedText:a[T]||"",textboxText:o[T]||"",rotationAngle:s[T]||0,autoTextDirection:V,...c})})}function Rt(n){return n.map(c=>({...c,coords:[...c.coords],polygon:c.polygon?c.polygon.map(u=>[...u]):[],position:{...c.position}}))}function sl(n){if(!n||typeof n!="object")return!1;const c=n;if(!Array.isArray(c.coords)||c.coords.length!==4||!c.coords.every(r=>typeof r=="number"&&!isNaN(r))||typeof c.fontSize!="number"||c.fontSize<=0)return!1;const u=["vertical","horizontal","auto"];if(typeof c.textDirection!="string"||!u.includes(c.textDirection))return!1;const t=["solid","lama_mpe","litelama"];return!(typeof c.inpaintMethod!="string"||!t.includes(c.inpaintMethod))}const dt=ln("bubble",()=>{const n=S([]),c=S(-1),u=S([]),t=S([]),r=S(!1),a=S(-1),o=S(0),s=S(0),y=S(0),P=S(0),T=S(!1),V=S(-1),X=S(null),J=S(!1),A=S(-1),f=S(0),D=te(()=>c.value>=0&&c.value<n.value.length?n.value[c.value]??null:null),B=te(()=>n.value.length),F=te(()=>n.value.length>0),i=te(()=>c.value>=0),l=te(()=>u.value.length>1),v=te(()=>u.value.filter(U=>U>=0&&U<n.value.length).map(U=>n.value[U]).filter(U=>U!==void 0));function p(){const Z=Qe().currentImage;Z&&(Z.bubbleStates=Rt(n.value),Z.hasUnsavedChanges=!0,console.log("气泡状态已同步到当前图片"))}function R(U,Z=!1){n.value=U,t.value=Rt(U),k(),console.log(`气泡数组已设置，共 ${U.length} 个气泡`),Z||p()}function E(U,Z){const ce=eo(U),_e=Ke().settings.textStyle,Ae=_e.layoutDirection,Re=Ae==="auto"?"vertical":Ae||"vertical",Me=en({coords:U,translatedText:"",autoTextDirection:ce,fontSize:_e.fontSize,fontFamily:_e.fontFamily,textDirection:Re,textColor:_e.textColor,fillColor:_e.fillColor,inpaintMethod:_e.inpaintMethod,strokeEnabled:_e.strokeEnabled,strokeColor:_e.strokeColor,strokeWidth:_e.strokeWidth,rotationAngle:0,position:{x:0,y:0},...Z});return n.value.push(Me),console.log(`已添加气泡，当前共 ${n.value.length} 个`),p(),Me}function N(U){return U<0||U>=n.value.length?(console.warn(`删除失败: 无效的索引 ${U}`),!1):(n.value.splice(U,1),c.value===U?c.value=-1:c.value>U&&c.value--,u.value=u.value.filter(Z=>Z!==U).map(Z=>Z>U?Z-1:Z),console.log(`已删除气泡，当前共 ${n.value.length} 个`),p(),!0)}function O(){if(u.value.length===0&&c.value<0)return;const U=[...new Set([...u.value,c.value])].filter(Z=>Z>=0).sort((Z,ce)=>ce-Z);for(const Z of U)n.value.splice(Z,1);k(),console.log(`已删除 ${U.length} 个气泡`),p()}function C(){n.value=[],t.value=[],k(),console.log("所有气泡已清除"),p()}function w(){n.value=[],t.value=[],k(),console.log("本地气泡状态已清除（不同步到imageStore）")}function m(U){U>=-1&&U<n.value.length&&(c.value=U,u.value=U>=0?[U]:[],console.log(`已选中气泡 ${U}`))}function g(U){if(U<0||U>=n.value.length)return;const Z=u.value.indexOf(U);Z>=0?(u.value.splice(Z,1),c.value===U&&(c.value=u.value[0]??-1)):(u.value.push(U),c.value=U),console.log(`多选状态: ${u.value.join(", ")}`)}function k(){c.value=-1,u.value=[]}function $(){c.value>=0?u.value=[c.value]:u.value=[]}function b(){if(n.value.length===0)return!1;const U=c.value<n.value.length-1?c.value+1:0;return m(U),!0}function h(){if(n.value.length===0)return!1;const U=c.value>0?c.value-1:n.value.length-1;return m(U),!0}function Y(U,Z){if(U<0||U>=n.value.length)return console.warn(`更新失败: 无效的索引 ${U}`),!1;const ce=n.value[U];return ce?(Object.assign(ce,Z),console.log(`已更新气泡 ${U}`),p(),!0):!1}function W(U){return c.value<0?(console.warn("更新失败: 没有选中的气泡"),!1):Y(c.value,U)}function x(U){const Z=u.value.length>0?u.value:c.value>=0?[c.value]:[];for(const ce of Z){const Te=n.value[ce];Te&&Object.assign(Te,U)}p(),console.log(`已批量更新 ${Z.length} 个气泡`)}function _(U){for(let Z=0;Z<n.value.length;Z++){const ce=n.value[Z];ce&&Object.assign(ce,U)}p(),console.log(`已更新所有 ${n.value.length} 个气泡`)}function d(){if(n.value.length!==t.value.length)return!0;for(let U=0;U<n.value.length;U++){const Z=n.value[U],ce=t.value[U];if(!(!Z||!ce)&&(Z.translatedText!==ce.translatedText||Z.textboxText!==ce.textboxText||Z.fontSize!==ce.fontSize||Z.fontFamily!==ce.fontFamily||Z.textDirection!==ce.textDirection||Z.textColor!==ce.textColor||Z.fillColor!==ce.fillColor||Z.rotationAngle!==ce.rotationAngle||Z.strokeEnabled!==ce.strokeEnabled||Z.strokeColor!==ce.strokeColor||Z.strokeWidth!==ce.strokeWidth||Z.inpaintMethod!==ce.inpaintMethod||JSON.stringify(Z.coords)!==JSON.stringify(ce.coords)))return!0}return!1}function M(){n.value=Rt(t.value),k(),console.log("气泡状态已重置到初始状态")}function ae(){t.value=Rt(n.value),console.log("当前状态已保存为初始状态")}function L(){return{bubble_coords:n.value.map(U=>U.coords),bubble_texts:n.value.map(U=>U.translatedText),textbox_texts:n.value.map(U=>U.textboxText),font_sizes:n.value.map(U=>U.fontSize),font_families:n.value.map(U=>U.fontFamily),text_directions:n.value.map(U=>U.textDirection==="auto"?U.autoTextDirection==="vertical"?"v":"h":U.textDirection==="vertical"?"v":"h"),text_colors:n.value.map(U=>U.textColor),fill_colors:n.value.map(U=>U.fillColor),rotation_angles:n.value.map(U=>U.rotationAngle),stroke_enabled:n.value.map(U=>U.strokeEnabled),stroke_colors:n.value.map(U=>U.strokeColor),stroke_widths:n.value.map(U=>U.strokeWidth),inpaint_methods:n.value.map(U=>U.inpaintMethod)}}function j(){return JSON.stringify(n.value)}function le(U){try{const Z=JSON.parse(U);if(!Array.isArray(Z))return console.error("反序列化失败: 数据不是数组"),!1;const ce=[];for(const Te of Z)sl(Te)?ce.push(Te):console.warn("跳过无效的气泡状态:",Te);return R(ce),!0}catch(Z){return console.error("反序列化失败:",Z),!1}}return{bubbles:n,selectedIndex:c,selectedIndices:u,initialStates:t,isDragging:r,draggingIndex:a,dragOffsetX:o,dragOffsetY:s,dragInitialX:y,dragInitialY:P,isResizing:T,resizingIndex:V,resizeCurrentCoords:X,isRotating:J,rotatingIndex:A,rotateCurrentAngle:f,selectedBubble:D,bubbleCount:B,hasBubbles:F,hasSelection:i,isMultiSelect:l,selectedBubbles:v,setBubbles:R,addBubble:E,deleteBubble:N,deleteSelected:O,clearBubbles:C,clearBubblesLocal:w,selectBubble:m,toggleMultiSelect:g,clearSelection:k,clearMultiSelect:$,selectNext:b,selectPrevious:h,updateBubble:Y,updateSelectedBubble:W,updateAllSelected:x,updateAllBubbles:_,hasChanges:d,resetToInitial:M,saveAsInitial:ae,toApiRequest:L,serialize:j,deserialize:le}}),ll=Object.freeze(Object.defineProperty({__proto__:null,useBubbleStore:dt},Symbol.toStringTag,{value:"Module"}));function pn(n){let c=n,u=0,t=0,r=Date.now();const a=()=>c<=0?0:Math.ceil(6e4/c);return{async acquire(){if(c<=0)return;const o=Date.now(),s=a();if(o-r>=6e4&&(r=o,t=0),t>=c){const P=6e4-(o-r);P>0&&await Kn(P),r=Date.now(),t=0}const y=o-u;y<s&&await Kn(s-y),u=Date.now(),t++},reset(){u=0,t=0,r=Date.now()},getRpm(){return c},setRpm(o){c=o,this.reset()}}}function Kn(n){return new Promise(c=>setTimeout(c,n))}function il(n){return n.includes(",")&&n.split(",")[1]||n}function tn(n){if(n.isManuallyAnnotated){const c=n.bubbleStates||[];return{coords:c.map(u=>u.coords),angles:c.map(u=>u.rotationAngle||0),isEmpty:c.length===0,isManual:!0}}return Array.isArray(n.bubbleStates)&&n.bubbleStates.length>0?{coords:n.bubbleStates.map(c=>c.coords),angles:n.bubbleStates.map(c=>c.rotationAngle||0),isEmpty:!1,isManual:!1}:Array.isArray(n.bubbleCoords)&&n.bubbleCoords.length>0?{coords:n.bubbleCoords,angles:n.bubbleAngles,isEmpty:!1,isManual:!1}:null}function nn(n,c={}){const u=Ke(),{settings:t}=u,{textStyle:r,translation:a,baiduOcr:o,aiVisionOcr:s,boxExpand:y,preciseMask:P}=t,T={image:il(n),ocr_engine:t.ocrEngine,source_language:t.sourceLanguage,model_provider:a.provider,api_key:a.apiKey,model_name:a.modelName,custom_base_url:a.customBaseUrl,target_language:t.targetLanguage,prompt_content:t.translatePrompt,textbox_prompt_content:t.textboxPrompt,use_textbox_prompt:t.useTextboxPrompt,rpm_limit_translation:a.rpmLimit,max_retries:a.maxRetries,use_json_format_translation:a.isJsonMode,detector_type:t.textDetector,box_expand_ratio:y.ratio,box_expand_top:y.top,box_expand_bottom:y.bottom,box_expand_left:y.left,box_expand_right:y.right,usePreciseMask:P.enabled,maskDilateSize:P.dilateSize,maskBoxExpandRatio:P.boxExpandRatio,fontSize:r.fontSize,autoFontSize:r.autoFontSize,fontFamily:r.fontFamily,textDirection:r.layoutDirection==="auto"?"vertical":r.layoutDirection,autoTextDirection:r.layoutDirection==="auto",textColor:r.textColor,fillColor:r.fillColor,strokeEnabled:r.strokeEnabled,strokeColor:r.strokeColor,strokeWidth:r.strokeWidth,use_inpainting:!1,use_lama:r.inpaintMethod==="lama_mpe"||r.inpaintMethod==="litelama",lamaModel:r.inpaintMethod==="litelama"?"litelama":"lama_mpe",showDetectionDebug:t.showDetectionDebug,remove_only:c.removeTextOnly,skip_translation:c.removeTextOnly},V=X=>X.map(J=>[Math.round(J[0]),Math.round(J[1]),Math.round(J[2]),Math.round(J[3])]);return c.existingBubbleStates&&c.existingBubbleStates.length>0?(T.bubble_coords=V(c.existingBubbleStates.map(X=>X.coords)),T.bubble_angles=c.existingBubbleStates.map(X=>X.rotationAngle||0)):c.existingBubbleCoords&&(T.bubble_coords=V(c.existingBubbleCoords),T.bubble_angles=c.existingBubbleAngles),t.ocrEngine==="baidu_ocr"&&(T.baidu_api_key=o.apiKey,T.baidu_secret_key=o.secretKey,T.baidu_version=o.version,T.baidu_ocr_language=o.sourceLanguage),t.ocrEngine==="ai_vision"&&(T.ai_vision_provider=s.provider,T.ai_vision_api_key=s.apiKey,T.ai_vision_model_name=s.modelName,T.ai_vision_ocr_prompt=s.prompt,T.rpm_limit_ai_vision_ocr=s.rpmLimit,T.custom_ai_vision_base_url=s.customBaseUrl,T.use_json_format_ai_vision_ocr=s.isJsonMode),T}function rl(n){const c=Ke(),{textStyle:u}=c.settings;if(!n.bubble_coords||n.bubble_coords.length===0)return null;const t={bubble_coords:n.bubble_coords,bubble_states:n.bubble_states,original_texts:n.original_texts,bubble_texts:n.bubble_texts,textbox_texts:n.textbox_texts,bubble_angles:n.bubble_angles,auto_directions:n.auto_directions},r={fontSize:u.fontSize,fontFamily:u.fontFamily,textDirection:u.layoutDirection==="auto"?"vertical":u.layoutDirection,textColor:u.textColor,fillColor:u.fillColor,strokeEnabled:u.strokeEnabled,strokeColor:u.strokeColor,strokeWidth:u.strokeWidth,inpaintMethod:u.inpaintMethod};return to(t,r)}function Et(){return"session_"+Date.now()+"_"+Math.random().toString(36).substring(2,9)}function no(n,c,u){return n.filter(t=>t.imageIndex>=c&&t.imageIndex<u)}function oo(n){if(!n||n.length===0)return[];const c=[];for(const u of n){if(!u){console.warn("mergeJsonResults: 跳过空的批次结果");continue}const t=Array.isArray(u)?u:[u];for(const r of t)r&&typeof r=="object"&&"imageIndex"in r?c.push(r):console.warn("mergeJsonResults: 跳过无效的图片数据",r)}return c.sort((u,t)=>u.imageIndex-t.imageIndex),c}function ul(){const n=Qe(),c=Ke(),u=Pt(),t=rt(),r=S(!1),a=S({current:0,total:0,completed:0,failed:0,isInProgress:!1,isPaused:!1});let o=[],s=null;function y(){const A=n.images;if(A.length===0)return null;const f=[];for(let D=0;D<A.length;D++){const B=A[D];if(!B)continue;const F=B.originalTexts||[],i={imageIndex:D,bubbles:[]};for(let l=0;l<F.length;l++){const v=F[l]||"";let p="vertical";const R=B.bubbleStates?.[l];if(R&&R.textDirection){const E=R.textDirection;p=E==="auto"?"vertical":E}else B.userLayoutDirection&&B.userLayoutDirection!=="auto"&&(p=B.userLayoutDirection);i.bubbles.push({bubbleIndex:l,original:v,translated:"",textDirection:p})}f.push(i)}return f}function P(){return n.images.map(A=>{const f=A.originalDataURL;return f.includes(",")?f.split(",")[1]||"":f})}async function T(A,f,D){const{hqTranslation:B}=c.settings,F=JSON.stringify(f,null,2),i=[{type:"text",text:B.prompt+`

以下是JSON数据:
\`\`\`json
`+F+"\n```"}];for(const p of A)i.push({type:"image_url",image_url:{url:`data:image/png;base64,${p}`}});const l=[{role:"system",content:"你是一个专业的漫画翻译助手，能够根据漫画图像内容和上下文提供高质量的翻译。"},{role:"user",content:i}],v={provider:B.provider,api_key:B.apiKey,model_name:B.modelName,custom_base_url:B.customBaseUrl,messages:l,low_reasoning:B.lowReasoning,force_json_output:B.forceJsonOutput,no_thinking_method:B.noThinkingMethod,use_stream:B.useStream};try{console.log(`高质量翻译: 通过后端代理调用 ${B.provider} API...`);const p=await cn(v);if(!p.success)throw new Error(p.error||"API 调用失败");if(p.results&&p.results.length>0){const E=p.results[0];if(E&&"imageIndex"in E&&"bubbles"in E)return p.results}const R=p.content;if(R)if(B.forceJsonOutput)try{return JSON.parse(R)}catch(E){throw console.error("解析AI强制JSON返回的内容失败:",E),new Error("解析AI返回的JSON结果失败")}else{const E=R.match(/```json\s*([\s\S]*?)\s*```/);if(E&&E[1])try{return JSON.parse(E[1])}catch(N){throw console.error("解析AI返回的JSON失败:",N),new Error("解析AI返回的翻译结果失败")}}return null}catch(p){throw console.error("调用AI翻译API失败:",p),p}}async function V(){const A=n.images.length;let f=0;a.value.label=`消除文字: 0/${A}`,a.value.percentage=0;for(let D=0;D<A;D++){const B=Math.floor(D/A*25);a.value.label=`消除文字: ${D+1}/${A}`,a.value.percentage=B,n.setTranslationStatus(D,"processing");const F=n.images[D];if(!F||!F.originalDataURL){n.setTranslationStatus(D,"pending");continue}const i=tn(F);if(i?.isEmpty){console.log(`高质量翻译[${D}]: 文本框已被用户清空，跳过此图片`),n.setTranslationStatus(D,"pending");continue}if(i){const l=i.isManual?"手动标注框":"已有文本框";console.log(`高质量翻译[${D}]: 使用${l} ${i.coords.length} 个`)}try{const l=nn(F.originalDataURL,{removeTextOnly:!0,existingBubbleCoords:i?.coords,existingBubbleAngles:i?.angles,useExistingBubbles:!!i}),v=await Bt(l);if(v.translated_image){const p=s?.textDirection,R=p==="vertical"||p==="horizontal"||p==="auto"?p:"vertical",E=v.bubble_coords?to(v,{fontSize:s?.fontSize||c.settings.textStyle.fontSize,fontFamily:s?.fontFamily||c.settings.textStyle.fontFamily,textDirection:R,textColor:s?.textColor||c.settings.textStyle.textColor,fillColor:s?.fillColor||c.settings.textStyle.fillColor,strokeEnabled:s?.strokeEnabled??c.settings.textStyle.strokeEnabled,strokeColor:s?.strokeColor||c.settings.textStyle.strokeColor,strokeWidth:s?.strokeWidth??c.settings.textStyle.strokeWidth,inpaintMethod:c.settings.textStyle.inpaintMethod}):[];n.updateImageByIndex(D,{translatedDataURL:`data:image/png;base64,${v.translated_image}`,cleanImageData:v.clean_image||null,bubbleCoords:v.bubble_coords||[],bubbleAngles:v.bubble_angles||[],originalTexts:v.original_texts||[],textboxTexts:v.textbox_texts||[],bubbleStates:E,bubbleTexts:E.map(N=>N.translatedText||""),translationFailed:!1,translationStatus:"completed",showOriginal:!1,hasUnsavedChanges:!0}),console.log(`高质量翻译-消除文字[${D+1}/${A}]: 处理完成`)}else f++,n.updateImageByIndex(D,{translationFailed:!0,translationStatus:"failed"})}catch(l){console.error(`图片 ${D} 消除文字失败:`,l),f++,n.updateImageByIndex(D,{translationFailed:!0,translationStatus:"failed"})}}if(a.value.label="消除文字完成",a.value.percentage=25,f>0)throw new Error(`消除文字完成，但有 ${f} 张图片失败`)}async function X(A){if(!A||A.length===0)throw new Error("没有有效的翻译数据可导入");const f=n.images,D=n.currentImageIndex,B=s?.fontSize||c.settings.textStyle.fontSize,F=s?.autoFontSize??c.settings.textStyle.autoFontSize,i=s?.fontFamily||c.settings.textStyle.fontFamily,l=s?.textDirection||c.settings.textStyle.layoutDirection,v=l==="auto"?"vertical":l,p=s?.textColor||c.settings.textStyle.textColor,R=s?.fillColor||c.settings.textStyle.fillColor,E=s?.strokeEnabled??c.settings.textStyle.strokeEnabled,N=s?.strokeColor||c.settings.textStyle.strokeColor,O=s?.strokeWidth??c.settings.textStyle.strokeWidth;a.value.label="更新图片数据...",a.value.percentage=90;const C=A.length;let w=0;for(const m of A){w++,a.value.label=`处理图片 ${w}/${C}`,a.value.percentage=90+w/C*5;const g=m.imageIndex;if(g<0||g>=f.length){console.warn(`跳过无效的图片索引: ${g}`);continue}const k=f[g];if(!k)continue;let $=!1;const b=k.bubbleTexts||[],h=k.bubbleCoords||[];for(const Y of m.bubbles||[]){const W=Y.bubbleIndex;if(W<0||W>=h.length){console.warn(`图片 ${g}: 跳过无效的气泡索引 ${W}`);continue}const x=Y.translated;let _=Y.textDirection;_==="auto"&&(_=v),b[W]=x;const d=_==="vertical"||_==="horizontal"?_:v;if(!k.bubbleStates||!Array.isArray(k.bubbleStates)||k.bubbleStates.length!==h.length){const M=k.bubbleAngles||[],ae=[];for(let L=0;L<h.length;L++){const j=L===W?d:v,le=h[L];let U=j;const Z=k.bubbleStates?.[L];if(Z?.autoTextDirection&&Z.autoTextDirection!=="auto")U=Z.autoTextDirection;else if(le&&le.length>=4){const[ce,Te,_e,Ae]=le;U=Ae-Te>_e-ce?"vertical":"horizontal"}ae.push({translatedText:b[L]||"",originalText:k.originalTexts?.[L]||"",textboxText:"",coords:le,polygon:[],fontSize:B,fontFamily:i,textDirection:j,autoTextDirection:U,position:{x:0,y:0},textColor:p,rotationAngle:M[L]||0,fillColor:R,strokeEnabled:E,strokeColor:N,strokeWidth:O,inpaintMethod:c.settings.textStyle.inpaintMethod})}k.bubbleStates=ae}else if(k.bubbleStates[W])k.bubbleStates[W].translatedText=x,_&&_!=="auto"&&(k.bubbleStates[W].textDirection=d);else{const ae=(k.bubbleAngles||[])[W]||0,L=h[W];let j=d;if(L&&L.length>=4){const[le,U,Z,ce]=L;j=ce-U>Z-le?"vertical":"horizontal"}k.bubbleStates[W]={translatedText:x,originalText:k.originalTexts?.[W]||"",textboxText:"",coords:L,polygon:[],fontSize:B,fontFamily:i,textDirection:d,autoTextDirection:j,position:{x:0,y:0},textColor:p,rotationAngle:ae,fillColor:R,strokeEnabled:E,strokeColor:N,strokeWidth:O,inpaintMethod:c.settings.textStyle.inpaintMethod}}$=!0}if($&&k.bubbleStates){const Y=k.bubbleStates.map(W=>W.translatedText||"");if(k.cleanImageData)try{const{apiClient:W}=await at(async()=>{const{apiClient:M}=await import("./client.Bht704G-.js");return{apiClient:M}},__vite__mapDeps([4,5])),x=k.bubbleStates.map(M=>({translatedText:M.translatedText||"",coords:M.coords,fontSize:M.fontSize||B,fontFamily:M.fontFamily||i,textDirection:M.textDirection||v,textColor:M.textColor||p,rotationAngle:M.rotationAngle||0,position:M.position||{x:0,y:0},strokeEnabled:M.strokeEnabled??E,strokeColor:M.strokeColor||N,strokeWidth:M.strokeWidth??O}));let _=k.cleanImageData;_.includes("base64,")&&(_=_.split("base64,")[1]||"");const d=await W.post("/api/re_render_image",{clean_image:_,bubble_texts:Y,bubble_coords:h,fontSize:F?"auto":B,autoFontSize:F,fontFamily:i,textDirection:v,textColor:p,bubble_states:x,use_individual_styles:!0,use_inpainting:!1,use_lama:!1,fillColor:null,is_font_style_change:!1,strokeEnabled:E,strokeColor:N,strokeWidth:O});d.rendered_image&&(n.updateImageByIndex(g,{translatedDataURL:`data:image/png;base64,${d.rendered_image}`,bubbleStates:k.bubbleStates,bubbleTexts:Y,hasUnsavedChanges:!0}),console.log(`已完成图片 ${g} 的渲染`))}catch(W){console.error(`重新渲染图片 ${g} 失败:`,W)}else n.updateImageByIndex(g,{bubbleStates:k.bubbleStates,bubbleTexts:Y,hasUnsavedChanges:!0})}}D>=0&&D<f.length&&n.setCurrentImageIndex(D)}async function J(){if(n.images.length===0)return t.warning("请先添加图片"),!1;if(n.isBatchTranslationInProgress)return t.warning("请等待当前批量操作完成"),!1;if(!u.validateBeforeTranslation("hq"))return!1;const{hqTranslation:A,textStyle:f}=c.settings,D=f.layoutDirection;s={fontFamily:f.fontFamily,fontSize:f.fontSize,autoFontSize:f.autoFontSize,autoTextDirection:D==="auto",textDirection:D==="auto"?"vertical":D,fillColor:f.fillColor,textColor:f.textColor,rotationAngle:0,strokeEnabled:f.strokeEnabled,strokeColor:f.strokeColor,strokeWidth:f.strokeWidth},console.log("高质量翻译前保存的文本样式设置:",s),a.value={current:0,total:n.images.length,completed:0,failed:0,isInProgress:!0,isPaused:!1,label:"准备翻译...",percentage:0},t.info("步骤1/4: 消除所有图片文字..."),r.value=!0,n.setBatchTranslationInProgress(!0);try{await V(),t.info("步骤2/4: 导出文本数据..."),a.value.label="导出文本数据...",a.value.percentage=25;const B=y();if(!B)throw new Error("导出文本失败");t.info("步骤3/4: 准备图片数据..."),a.value.label="准备图片数据...",a.value.percentage=40;const F=P();t.info("步骤4/4: 发送到AI进行翻译..."),a.value.label="开始发送到AI...",a.value.percentage=50;const i=A.batchSize||3,l=A.sessionReset||5,v=A.maxRetries??2;o=[];const p=F.length,R=Math.ceil(p/i),E=A.rpmLimit||0,N=E>0?pn(E):null;let O=0,C=Et();for(let w=0;w<R;w++){a.value.label=`${w+1}/${R}`,a.value.percentage=Math.round(50+w/R*40),O>=l&&(console.log("重置会话上下文"),C=Et(),O=0);const m=w*i,g=Math.min(m+i,p),k=F.slice(m,g),$=no(B,m,g);let b=0,h=!1;for(;b<=v&&!h;)try{N&&await N.acquire();const Y=await T(k,$,C);if(Y)o.push(Y),h=!0;else{if(b++,b>v)break;await new Promise(W=>setTimeout(W,1e3));continue}O++}catch(Y){b++,b<=v?(console.log(`批次 ${w+1} 翻译失败，第 ${b}/${v} 次重试...`),t.warning(`批次 ${w+1} 失败，正在重试 (${b}/${v})...`),await new Promise(W=>setTimeout(W,1e3))):(console.error(`批次 ${w+1} 翻译最终失败:`,Y),t.error(`批次 ${w+1} 翻译失败: ${Y instanceof Error?Y.message:"未知错误"}`))}}return t.info("翻译完成，正在导入翻译结果..."),a.value.label="导入翻译结果...",a.value.percentage=90,await X(oo(o)),a.value.label="翻译完成！",a.value.percentage=100,t.success("高质量翻译完成！"),!0}catch(B){return console.error("高质量翻译过程出错:",B),t.error(`翻译失败: ${B instanceof Error?B.message:"未知错误"}`),!1}finally{r.value=!1,n.setBatchTranslationInProgress(!1),setTimeout(()=>{a.value.isInProgress=!1},1e3)}}return{isHqTranslating:r,progress:a,executeHqTranslation:J}}function cl(){const n=Qe(),c=Ke(),u=Pt(),t=rt(),r=S(!1),a=S({current:0,total:0,completed:0,failed:0,isInProgress:!1,isPaused:!1});let o=[];function s(){const X=n.images;if(X.length===0)return null;const J=[];for(let A=0;A<X.length;A++){const f=X[A];if(!f)continue;const D=f.originalTexts||[],B=f.bubbleTexts||[],F={imageIndex:A,bubbles:[]};for(let i=0;i<D.length;i++){const l=D[i]||"",v=(i<B.length?B[i]:"")||"";let p="vertical";const R=f.bubbleStates?.[i];if(R&&R.textDirection){const E=R.textDirection;p=E==="auto"?"vertical":E}else f.userLayoutDirection&&f.userLayoutDirection!=="auto"&&(p=f.userLayoutDirection);F.bubbles.push({bubbleIndex:i,original:l,translated:v,textDirection:p})}J.push(F)}return J}function y(){return n.images.map(X=>{const J=X.originalDataURL;return J.includes(",")?J.split(",")[1]||"":J})}async function P(X,J,A,f){const D=JSON.stringify(J,null,2),B=[{type:"text",text:A.prompt+`

以下是JSON数据，包含原文和已有译文:
\`\`\`json
`+D+"\n```\n请在保持JSON格式的情况下，校对每个bubble的translated字段，使翻译更加准确、自然、符合语境。"}];for(const i of X)B.push({type:"image_url",image_url:{url:`data:image/png;base64,${i}`}});const F={provider:A.provider,api_key:A.apiKey,model_name:A.modelName,custom_base_url:A.customBaseUrl,messages:[{role:"system",content:"你是一个专业的漫画翻译校对助手，能够根据漫画图像内容和上下文对已有翻译进行校对和润色。"},{role:"user",content:B}],low_reasoning:A.lowReasoning,no_thinking_method:A.noThinkingMethod,force_json_output:A.forceJsonOutput};try{console.log(`AI校对: 通过后端代理调用 ${A.provider} API...`);const i=await cn(F);if(!i.success)throw new Error(i.error||"API 调用失败");if(i.results&&i.results.length>0){const v=i.results[0];if(v&&"imageIndex"in v&&"bubbles"in v)return i.results}const l=i.content;if(l)if(A.forceJsonOutput)try{return JSON.parse(l)}catch(v){throw console.error("解析AI强制JSON返回的内容失败:",v),new Error("解析AI返回的JSON结果失败")}else{const v=l.match(/```json\s*([\s\S]*?)\s*```/);if(v&&v[1])try{return JSON.parse(v[1])}catch(p){throw console.error("解析AI返回的JSON失败:",p),new Error("解析AI返回的校对结果失败")}try{return JSON.parse(l)}catch(p){throw console.error("直接解析AI返回内容失败:",p),new Error("无法解析AI返回的校对结果")}}return null}catch(i){throw console.error("调用AI校对API失败:",i),i}}async function T(X){if(!X||X.length===0){console.warn("没有有效的校对数据可导入"),t.warning("没有有效的校对结果可导入");return}const J=n.images,A=n.currentImageIndex,{textStyle:f}=c.settings,D=f.fontSize,B=f.fontFamily,F=f.layoutDirection,i=F==="auto"?"vertical":F,l=f.textColor,v=f.fillColor,p=f.strokeEnabled,R=f.strokeColor,E=f.strokeWidth;for(const N of X){const O=N.imageIndex;if(O<0||O>=J.length){console.warn(`跳过无效的图片索引: ${O}`);continue}const C=J[O];if(!C)continue;if(!N.bubbles||!Array.isArray(N.bubbles)||N.bubbles.length===0){console.warn(`图片 ${O}: 没有有效的气泡数据`);continue}let w=!1;const m=C.bubbleTexts||[],g=C.bubbleCoords||[];for(const k of N.bubbles){const $=k.bubbleIndex,b=k.translated||"";let h=k.textDirection;if((!h||h==="auto")&&(h=i),$<0||$>=g.length){console.warn(`图片 ${O}: 跳过无效的气泡索引 ${$}`);continue}for(;m.length<=$;)m.push("");if(m[$]=b,h&&h!=="auto"){const Y=h==="vertical"||h==="horizontal"?h:i;if(!C.bubbleStates||!Array.isArray(C.bubbleStates)||C.bubbleStates.length!==g.length){const W=C.bubbleAngles||[],x=[];for(let _=0;_<g.length;_++){const d=_===$?Y:i,M=g[_];let ae=d;const L=C.bubbleStates?.[_];if(L?.autoTextDirection&&L.autoTextDirection!=="auto")ae=L.autoTextDirection;else if(M&&M.length>=4){const[j,le,U,Z]=M;ae=Z-le>U-j?"vertical":"horizontal"}x.push({translatedText:m[_]||"",originalText:C.originalTexts?.[_]||"",coords:M,fontSize:D,fontFamily:B,textDirection:d,autoTextDirection:ae,position:{x:0,y:0},textColor:l,rotationAngle:W[_]||0,fillColor:v,strokeEnabled:p,strokeColor:R,strokeWidth:E})}C.bubbleStates=x}else C.bubbleStates[$]&&(C.bubbleStates[$].translatedText=b,C.bubbleStates[$].textDirection=Y)}w=!0}if(w&&C.bubbleStates){const k=C.bubbleStates.map($=>$.translatedText||"");if(C.cleanImageData)try{const{apiClient:$}=await at(async()=>{const{apiClient:W}=await import("./client.Bht704G-.js");return{apiClient:W}},__vite__mapDeps([4,5])),b=C.bubbleStates.map(W=>({translatedText:W.translatedText||"",coords:W.coords,fontSize:W.fontSize||D,fontFamily:W.fontFamily||B,textDirection:W.textDirection||i,textColor:W.textColor||l,rotationAngle:W.rotationAngle||0,position:W.position||{x:0,y:0},strokeEnabled:W.strokeEnabled??p,strokeColor:W.strokeColor||R,strokeWidth:W.strokeWidth??E}));let h=C.cleanImageData;h.includes("base64,")&&(h=h.split("base64,")[1]||"");const Y=await $.post("/api/re_render_image",{clean_image:h,bubble_texts:k,bubble_coords:g,fontSize:D,fontFamily:B,textDirection:i,textColor:l,bubble_states:b,use_individual_styles:!0,use_inpainting:!1,use_lama:!1,fillColor:null,is_font_style_change:!1,strokeEnabled:p,strokeColor:R,strokeWidth:E});Y.rendered_image&&(n.updateImageByIndex(O,{translatedDataURL:`data:image/png;base64,${Y.rendered_image}`,bubbleStates:C.bubbleStates,bubbleTexts:k,hasUnsavedChanges:!0}),console.log(`已完成图片 ${O} 的校对渲染`))}catch($){console.error(`重新渲染图片 ${O} 失败:`,$)}else n.updateImageByIndex(O,{bubbleStates:C.bubbleStates,bubbleTexts:k,hasUnsavedChanges:!0})}}A>=0&&A<J.length&&n.setCurrentImageIndex(A)}async function V(){if(!u.validateBeforeTranslation("proofread"))return!1;const{proofreading:X}=c.settings;if(!X.enabled||X.rounds.length===0)return t.error("请先启用 AI 校对并添加校对轮次"),!1;const J=n.images;if(J.length===0)return t.error("请先上传图片"),!1;if(!J.some(D=>D.bubbleTexts&&D.bubbleTexts.length>0))return t.error("请先进行翻译以获取译文"),!1;r.value=!0,n.setBatchTranslationInProgress(!0);const f=X.rounds.length;a.value={current:0,total:f,completed:0,failed:0,isInProgress:!0,isPaused:!1,label:"准备校对...",percentage:0},t.info(`开始校对，共 ${f} 轮`);try{for(let D=0;D<f;D++){const B=X.rounds[D];if(!B)continue;const F=B.name||`轮次${D+1}`,i=D/f*100,l=1/f*100;t.info(`校对第 ${D+1}/${f} 轮: ${F}`),a.value.label=`轮次 ${D+1}/${f}`,a.value.percentage=Math.round(i),t.info(`轮次 ${D+1}/${f}: 导出文本数据...`),a.value.label="导出文本...",a.value.percentage=Math.round(i+l*.2);const v=s();if(!v)throw new Error("导出文本失败");t.info(`轮次 ${D+1}/${f}: 准备图片数据...`),a.value.label="准备图片数据...",a.value.percentage=Math.round(i+l*.4);const p=y();t.info(`轮次 ${D+1}/${f}: 发送到AI进行校对...`),a.value.label="开始发送到AI...",a.value.percentage=Math.round(i+l*.5);const R=B.batchSize||3,E=B.sessionReset||20,N=X.maxRetries??2;o=[];const O=p.length,C=Math.ceil(O/R),w=B.rpmLimit||7,m=w>0?pn(w):null;let g=0,k=Et(),$=0;for(let b=0;b<C;b++){const h=i+l*.5+l*.4*(b/C);a.value.label=`轮次 ${D+1}/${f}: ${b+1}/${C}`,a.value.percentage=Math.round(h),g>=E&&(console.log("重置会话上下文"),k=Et(),g=0);const Y=b*R,W=Math.min(Y+R,O),x=p.slice(Y,W),_=no(v,Y,W);let d=0,M=!1;for(;d<=N&&!M;)try{m&&await m.acquire();const ae=await P(x,_,B,k);ae&&(o.push(ae),$++,M=!0),g++}catch(ae){d++,d<=N?(console.log(`轮次 ${D+1}, 批次 ${b+1} 校对失败，第 ${d}/${N} 次重试...`),t.warning(`轮次 ${D+1}, 批次 ${b+1} 失败，正在重试 (${d}/${N})...`),await new Promise(L=>setTimeout(L,1e3))):(console.error(`轮次 ${D+1}, 批次 ${b+1} 校对最终失败:`,ae),t.error(`轮次 ${D+1}, 批次 ${b+1} 校对失败: ${ae instanceof Error?ae.message:"未知错误"}`))}}if($===0)throw new Error(`轮次 ${D+1} 校对完全失败，请检查API设置或校对提示词`);t.info(`轮次 ${D+1}/${f}: 导入校对结果...`),a.value.label="导入校对结果...",a.value.percentage=Math.round(i+l*.9),await T(oo(o)),a.value.completed++}return a.value.label="校对完成！",a.value.percentage=100,t.success(`AI校对完成，共 ${f} 轮`),!0}catch(D){const B=D instanceof Error?D.message:"AI 校对失败";return t.error(`校对失败: ${B}`),a.value.label="校对已取消",a.value.percentage=0,!1}finally{r.value=!1,n.setBatchTranslationInProgress(!1),setTimeout(()=>{a.value.isInProgress=!1},1e3)}}return{isProofreading:r,progress:a,executeProofreading:V}}function bn(){const n=Qe(),c=Ke(),u=dt(),t=Pt(),r=rt(),a=ul(),o=cl(),s=S(null),y=S({current:0,total:0,completed:0,failed:0,isInProgress:!1,isPaused:!1}),P=S(!1),T=te(()=>P.value||n.isBatchTranslationInProgress||a.isHqTranslating.value||o.isProofreading.value),V=te(()=>y.value.total===0?0:Math.round(y.value.completed/y.value.total*100));function X(){const E=c.settings.translation.rpmLimit;s.value?s.value.setRpm(E):s.value=pn(E)}function J(E,N,O={}){if(N.error||!N.translated_image){n.setTranslationStatus(E,"failed",N.error||"翻译失败");return}const C=rl(N),w=N.translated_image?`data:image/png;base64,${N.translated_image}`:null,m=c.settings.textStyle.layoutDirection;n.updateImageByIndex(E,{translatedDataURL:w,cleanImageData:N.clean_image||null,bubbleStates:C,bubbleCoords:N.bubble_coords,bubbleAngles:N.bubble_angles||[],originalTexts:N.original_texts,textboxTexts:N.textbox_texts||[],bubbleTexts:C?.map(g=>g.translatedText||"")||[],userLayoutDirection:m,translationStatus:"completed",translationFailed:!1,hasUnsavedChanges:!0}),E===n.currentImageIndex&&C&&u.setBubbles(C)}async function A(E={}){if(E.removeTextOnly){if(!t.validateBeforeTranslation("ocr"))return!1}else if(!t.validateBeforeTranslation("normal"))return!1;const N=n.currentImage;if(!N)return r.error("请先上传图片"),!1;P.value=!0,n.setTranslationStatus(n.currentImageIndex,"processing");const O=r.showGeneralMessage("翻译中...","info",!1,0);try{X(),s.value&&await s.value.acquire();const C={...E};if(!C.existingBubbleCoords&&!C.existingBubbleStates){const g=tn(N);if(g)if(g.isEmpty)console.log("翻译当前图片: 文本框已被用户清空，将跳过翻译"),r.info("该图片无文本框，跳过翻译",3e3),C.existingBubbleCoords=[],C.existingBubbleAngles=[],C.useExistingBubbles=!0;else{C.existingBubbleCoords=g.coords,C.existingBubbleAngles=g.angles,C.useExistingBubbles=!0;const k=g.isManual?"手动标注框":"已有的文本框";console.log(`翻译当前图片: 使用 ${g.coords.length} 个${k}`),r.info(g.isManual?"检测到手动标注框，将优先使用...":"使用已有的文本框进行翻译...",3e3)}}const w=nn(N.originalDataURL,C),m=await Bt(w);return r.clearGeneralMessageById(O),J(n.currentImageIndex,m,E),m.translated_image&&!m.error?(r.success("翻译成功！"),!0):(r.error(m.error||"翻译失败"),!1)}catch(C){r.clearGeneralMessageById(O);const w=C instanceof Error?C.message:"翻译请求失败";return n.markCurrentAsFailed(w),r.error(w),!1}finally{P.value=!1}}async function f(E,N={}){const O=n.images[E];if(!O)return console.error(`图片索引 ${E} 不存在`),!1;n.setTranslationStatus(E,"processing");try{s.value&&await s.value.acquire();const C={...N};if(!C.existingBubbleCoords&&!C.existingBubbleStates){const g=tn(O);if(g)if(g.isEmpty)console.log(`批量翻译图片 ${E}: 文本框已被用户清空，跳过此图片的翻译`),C.existingBubbleCoords=[],C.existingBubbleAngles=[],C.useExistingBubbles=!0;else{C.existingBubbleCoords=g.coords,C.existingBubbleAngles=g.angles,C.useExistingBubbles=!0;const k=g.isManual?"手动标注框":"已有的文本框";console.log(`批量翻译图片 ${E}: 使用 ${g.coords.length} 个${k}`)}}const w=nn(O.originalDataURL,C),m=await Bt(w);return J(E,m,N),!!m.translated_image&&!m.error}catch(C){const w=C instanceof Error?C.message:"翻译请求失败";return n.setTranslationStatus(E,"failed",w),!1}}async function D(E={}){if(E.removeTextOnly){if(!t.validateBeforeTranslation("ocr"))return!1}else if(!t.validateBeforeTranslation("normal"))return!1;const N=n.images;if(N.length===0)return r.error("请先上传图片"),!1;const O=E.removeTextOnly===!0;y.value={current:0,total:N.length,completed:0,failed:0,isInProgress:!0,isPaused:!1,label:O?`消除文字: 0/${N.length}`:`0/${N.length}`,percentage:0},n.setBatchTranslationInProgress(!0),X(),r.info(O?`开始消除 ${N.length} 张图片文字...`:`开始批量翻译 ${N.length} 张图片...`);let C=!0;try{for(let w=0;w<N.length;w++){if(n.isBatchTranslationPaused&&await new Promise(g=>{n.setBatchTranslationResumeCallback(g)}),!n.isBatchTranslationInProgress){console.log("批量翻译已取消");break}y.value.current=w+1,y.value.label=O?`消除文字: ${w+1}/${N.length}`:`${w+1}/${N.length}`,y.value.percentage=Math.round((w+1)/N.length*100),await f(w,E)?y.value.completed++:(y.value.failed++,C=!1)}return y.value.failed>0?r.warning(O?`消除文字完成，${y.value.failed} 张图片失败`:`翻译完成，${y.value.failed} 张图片失败`):r.success(O?"所有图片文字消除完成":"所有图片翻译完成"),C}catch(w){const m=w instanceof Error?w.message:"批量翻译失败";return r.error(m),!1}finally{n.setBatchTranslationInProgress(!1);const w=n.currentImageIndex;if(w>=0&&w<n.images.length){const m=n.images[w];m&&(m.bubbleStates&&m.bubbleStates.length>0&&u.setBubbles(m.bubbleStates),n.setCurrentImageIndex(w))}setTimeout(()=>{y.value.isInProgress=!1},1e3)}}function B(){n.isBatchTranslationInProgress&&!n.isBatchTranslationPaused&&(n.setBatchTranslationPaused(!0),y.value.isPaused=!0,r.info("批量翻译已暂停"))}function F(){n.isBatchTranslationInProgress&&n.isBatchTranslationPaused&&(n.resumeBatchTranslation(),y.value.isPaused=!1,r.info("批量翻译继续中"))}function i(){n.isBatchTranslationInProgress&&(n.isBatchTranslationPaused&&n.resumeBatchTranslation(),n.setBatchTranslationInProgress(!1),y.value.isInProgress=!1,r.info("批量翻译已取消"))}async function l(){return A({removeTextOnly:!0})}async function v(){return D({removeTextOnly:!0})}async function p(E={}){if(!t.validateBeforeTranslation("normal"))return!1;const N=n.getFailedImageIndices();if(N.length===0)return r.info("没有失败的图片需要重新翻译"),!0;y.value={current:0,total:N.length,completed:0,failed:0,isInProgress:!0,isPaused:!1},n.setBatchTranslationInProgress(!0),X();let O=!0;try{for(let C=0;C<N.length&&(n.isBatchTranslationPaused&&await new Promise(g=>{n.setBatchTranslationResumeCallback(g)}),!!n.isBatchTranslationInProgress);C++){y.value.current=C+1;const w=N[C];if(w===void 0)continue;await f(w,E)?y.value.completed++:(y.value.failed++,O=!1)}return y.value.failed>0?r.warning(`重试完成，仍有 ${y.value.failed} 张图片失败`):r.success("所有失败图片重新翻译完成"),O}catch(C){const w=C instanceof Error?C.message:"重试翻译失败";return r.error(w),!1}finally{n.setBatchTranslationInProgress(!1),setTimeout(()=>{y.value.isInProgress=!1},1e3)}}async function R(){if(!n.currentImage)return r.error("请先上传图片"),!1;const N=u.bubbles;return!N||N.length===0?(r.error("当前图片没有气泡框，请先检测或手动添加"),!1):A({useExistingBubbles:!0,existingBubbleStates:N})}return{progress:y,isTranslatingSingle:P,isHqTranslating:a.isHqTranslating,isProofreading:o.isProofreading,isTranslating:T,progressPercent:V,translateCurrentImage:A,translateImageByIndex:f,translateAllImages:D,pauseBatchTranslation:B,resumeBatchTranslation:F,cancelBatchTranslation:i,removeTextOnly:l,removeAllTexts:v,retryFailedImages:p,executeHqTranslation:a.executeHqTranslation,executeProofreading:o.executeProofreading,translateWithCurrentBubbles:R}}function dl(){const n=dt(),c=Qe(),u=S(!1);function t(){if(!u.value)return;const r=c.currentImage;n.bubbleCount>0?c.updateCurrentBubbleStates([...n.bubbles]):r&&Array.isArray(r.bubbleStates)&&r.bubbleStates.length>0&&(c.updateCurrentBubbleStates([]),console.log("退出编辑模式（无重渲染），用户已删除所有气泡")),u.value=!1,n.clearSelection(),console.log("已退出编辑模式（无重渲染）")}return{isActive:u,exitEditModeWithoutRender:t}}function gl(){const n=Jn(),c=Ke(),u=Qe(),t=Qn(),r=dt(),a=dl(),o=S(!1),s=S(!1),y=S(null),P=S([]),T=S([]),V=S([]),X=S(null),J=S(null),A=S(null),f=S(null),D=S(!1);async function B(w=!1){if(!w&&(o.value||s.value)){console.log("[TranslateInit] 已经初始化，仅重新加载上下文"),await p();return}console.log("[TranslateInit] 开始初始化应用..."),o.value=!0,y.value=null;try{await F(),await i(),await l(),await v(),await p(),console.log("[TranslateInit] 应用初始化完成"),s.value=!0}catch(m){console.error("[TranslateInit] 应用初始化失败:",m),y.value=m instanceof Error?m.message:"初始化失败"}finally{o.value=!1}}async function F(){console.log("[TranslateInit] 初始化设置..."),c.initSettings();try{const w=await c.loadFromBackend();console.log(w?"[TranslateInit] 已从后端加载设置":"[TranslateInit] 后端无设置，使用 localStorage 数据")}catch(w){console.warn("[TranslateInit] 从后端加载设置失败，使用 localStorage 数据:",w)}console.log("[TranslateInit] 设置初始化完成")}async function i(){console.log("[TranslateInit] 初始化字体列表...");try{const w=await jn();w.fonts&&w.fonts.length>0?(P.value=w.fonts,console.log(`[TranslateInit] 已加载 ${w.fonts.length} 个字体`)):w.error?console.warn("[TranslateInit] 获取字体列表失败:",w.error):console.warn("[TranslateInit] 字体列表为空")}catch(w){console.error("[TranslateInit] 获取字体列表失败:",w)}}async function l(){console.log("[TranslateInit] 初始化翻译提示词设置...");try{const w=await Zo();w.prompt_names!==void 0?(T.value=w.prompt_names||[],!c.settings.translatePrompt&&w.default_prompt_content&&c.setTranslatePrompt(w.default_prompt_content),console.log(`[TranslateInit] 已加载 ${T.value.length} 个翻译提示词`)):w.error&&console.warn("[TranslateInit] 获取翻译提示词失败:",w.error)}catch(w){console.error("[TranslateInit] 获取翻译提示词失败:",w)}}async function v(){console.log("[TranslateInit] 初始化文本框提示词设置...");try{const w=await Go();w.prompt_names!==void 0?(V.value=w.prompt_names||[],!c.settings.textboxPrompt&&w.default_prompt_content&&c.setTextboxPrompt(w.default_prompt_content),console.log(`[TranslateInit] 已加载 ${V.value.length} 个文本框提示词`)):w.error&&console.warn("[TranslateInit] 获取文本框提示词失败:",w.error)}catch(w){console.error("[TranslateInit] 获取文本框提示词失败:",w)}}async function p(){const w=n.query.book,m=n.query.chapter;if(!w||!m){console.log("[TranslateInit] 未指定书籍/章节参数，使用独立模式"),D.value=!1,X.value=null,J.value=null,A.value=null,f.value=null,t.clearContext();return}console.log(`[TranslateInit] 检测到书籍/章节参数: book=${w}, chapter=${m}`),D.value=!0,X.value=w,J.value=m;try{const g=await ea(w);if(!g.success||!g.book){console.warn("[TranslateInit] 书籍不存在:",w),be("书籍不存在","warning");return}const k=g.book,$=k.chapters?.find(b=>b.id===m);if(!$){console.warn("[TranslateInit] 章节不存在:",m),be("章节不存在","warning");return}if(A.value=k.title,f.value=$.title,t.setBookChapterContext(w,m,k.title,$.title),typeof document<"u"&&(document.title=`${$.title} - ${k.title} - Saber-Translator`),$.session_path){console.log(`[TranslateInit] 尝试加载章节会话: ${$.session_path}`);try{await t.loadSessionByPath($.session_path),be(`已加载章节: ${$.title}`,"success")}catch{console.log("[TranslateInit] 章节会话数据不存在或加载失败，将创建新会话")}}}catch(g){console.error("[TranslateInit] 加载书籍/章节信息失败:",g),be("加载书籍信息失败","error")}}function R(w){if(w<0||w>=u.imageCount){console.warn(`[TranslateInit] 无效的图片索引: ${w}`);return}window._isChangingFromSwitchImage=!0,a.isActive.value&&a.exitEditModeWithoutRender(),u.currentImage&&r.bubbles.length>0&&u.updateCurrentImageProperty("bubbleStates",r.bubbles),u.setCurrentImageIndex(w);const g=u.currentImage;if(!g){console.warn("[TranslateInit] 切换到的图片不存在"),window._isChangingFromSwitchImage=!1;return}console.log(`[TranslateInit] 切换到图片: ${w}, ${g.fileName}`),g.bubbleStates&&g.bubbleStates.length>0?r.setBubbles(g.bubbleStates,!0):r.clearBubblesLocal(),E(g),setTimeout(()=>{window._isChangingFromSwitchImage=!1,console.log("[TranslateInit] 已重置切换图片操作标记")},100)}function E(w){if(!w)return;const m=w.bubbleStates?.[0];m&&c.updateTextStyle({fontSize:m.fontSize||c.settings.textStyle.fontSize,fontFamily:m.fontFamily||c.settings.textStyle.fontFamily,layoutDirection:w.userLayoutDirection||m.textDirection||c.settings.textStyle.layoutDirection,textColor:m.textColor||c.settings.textStyle.textColor,fillColor:m.fillColor||c.settings.textStyle.fillColor,strokeEnabled:m.strokeEnabled??c.settings.textStyle.strokeEnabled,strokeColor:m.strokeColor||c.settings.textStyle.strokeColor,strokeWidth:m.strokeWidth||c.settings.textStyle.strokeWidth,inpaintMethod:m.inpaintMethod||c.settings.textStyle.inpaintMethod,autoFontSize:w.autoFontSize??c.settings.textStyle.autoFontSize})}function N(){u.canGoPrevious&&R(u.currentImageIndex-1)}function O(){u.canGoNext&&R(u.currentImageIndex+1)}function C(){ut(async()=>{await B()})}return{isInitializing:o,isInitialized:s,initError:y,fontList:P,promptNames:T,textboxPromptNames:V,currentBookId:X,currentChapterId:J,currentBookTitle:A,currentChapterTitle:f,isBookshelfMode:D,initializeApp:B,initializeSettings:F,initializeFontList:i,initializePromptSettings:l,initializeTextboxPromptSettings:v,initializeBookChapterContext:p,switchImage:R,goToPrevious:N,goToNext:O,loadImageSettingsToStore:E,editMode:a,setupAutoInit:C}}const pl={key:0,id:"translationProgressBar",class:"translation-progress-bar"},bl={class:"progress-bar-label"},vl={key:0,class:"failed-count"},ml={key:0,class:"progress-controls"},fl=["title"],hl={class:"pause-icon"},yl=He({__name:"TranslationProgress",props:{progress:{},showControls:{type:Boolean,default:!0}},emits:["pause","resume"],setup(n,{emit:c}){const u=n,t=c,r=Qe(),a=bn(),o=te(()=>u.progress||a.progress.value),s=te(()=>o.value.isInProgress||r.isBatchTranslationInProgress),y=te(()=>o.value.current),P=te(()=>o.value.total),T=te(()=>o.value.failed),V=te(()=>o.value.percentage!==void 0?o.value.percentage:P.value===0?0:Math.round(y.value/P.value*100)),X=te(()=>o.value.isPaused||r.isBatchTranslationPaused),J=te(()=>o.value.label?o.value.label:`${X.value?"已暂停":"翻译中"}：${y.value} / ${P.value}`);function A(){X.value?(a.resumeBatchTranslation(),t("resume")):(a.pauseBatchTranslation(),t("pause"))}return(f,D)=>s.value?(K(),G("div",pl,[e("div",bl,[Ue(ue(J.value)+" ",1),T.value>0?(K(),G("span",vl,"（"+ue(T.value)+" 张失败）",1)):fe("",!0)]),e("div",{class:De(["progress-bar",{paused:X.value}])},[e("div",{class:"progress",style:st({width:`${V.value}%`})},null,4)],2),u.showControls?(K(),G("div",ml,[e("button",{class:De(["pause-btn",{paused:X.value}]),onClick:A,title:X.value?"继续翻译":"暂停翻译"},[e("span",hl,ue(X.value?"▶":"⏸"),1),Ue(" "+ue(X.value?"继续":"暂停"),1)],10,fl)])):fe("",!0)])):fe("",!0)}}),xl=qe(yl,[["__scopeId","data-v-d438b9d6"]]),Sl=He({__name:"SponsorModal",emits:["close"],setup(n,{emit:c}){const u=c;return(t,r)=>(K(),it(Gn,{title:"支持作者",onClose:r[1]||(r[1]=a=>u("close"))},{footer:ht(()=>[e("button",{type:"button",class:"btn btn-primary",onClick:r[0]||(r[0]=a=>u("close"))},"关闭")]),default:ht(()=>[r[2]||(r[2]=e("div",{class:"sponsor-content"},[e("p",{class:"sponsor-message"}," 如果这个项目对你有帮助，欢迎请作者喝杯咖啡 ☕ "),e("div",{class:"qr-codes"},[e("div",{class:"qr-item"},[e("div",{class:"qr-image"},[e("img",{src:"/pic/wechat_qrcode.png",alt:"微信支付"})]),e("span",{class:"qr-label"},"微信支付")]),e("div",{class:"qr-item"},[e("div",{class:"qr-image"},[e("img",{src:"/pic/alipay_qrcode.png",alt:"支付宝"})]),e("span",{class:"qr-label"},"支付宝")])]),e("p",{class:"sponsor-thanks"},"感谢您的支持！🙏")],-1))]),_:1}))}}),kl=qe(Sl,[["__scopeId","data-v-02b6948e"]]),_l={id:"thumbnail-sidebar",class:"thumbnail-sidebar"},Cl={class:"card thumbnail-card"},wl=["title","data-index","onClick"],$l=["src","alt"],Tl={key:1,class:"translation-failed-indicator"},Il={key:2,class:"labeled-indicator"},Dl={key:3,class:"thumbnail-processing-indicator"},Rl={key:1,class:"empty-state"},Ml=He({__name:"ThumbnailSidebar",emits:["select"],setup(n,{emit:c}){const u=c,t=Qe(),r=S(null),a=S([]),o=te(()=>t.images),s=te(()=>t.currentImageIndex),y=te(()=>t.hasImages);function P(f){u("select",f)}function T(){ct(()=>{const f=a.value[s.value];if(f&&r.value){const D=r.value,B=f.offsetTop-D.clientHeight/2+f.clientHeight/2;D.scrollTo({top:Math.max(0,B),behavior:"smooth"})}})}function V(f,D){a.value[D]=f}function X(f){return f.translationFailed?"failed":f.isManuallyAnnotated?"labeled":f.translationStatus==="processing"?"processing":null}function J(f){const D=[];return f.translationFailed&&D.push("translation-failed"),f.isManuallyAnnotated&&D.push("has-manual-labels"),D}function A(f){return f.translationFailed?"翻译失败，点击可重试":f.isManuallyAnnotated?"包含手动标注":f.fileName||""}return ye(s,()=>{T()}),ut(()=>{y.value&&T()}),(f,D)=>(K(),G("aside",_l,[e("div",Cl,[D[1]||(D[1]=e("h2",null,"图片概览",-1)),y.value?(K(),G("ul",{key:0,ref_key:"containerRef",ref:r,id:"thumbnailList",class:"thumbnail-list"},[(K(!0),G(Xe,null,Ge(o.value,(B,F)=>(K(),G("li",{key:B.id,ref_for:!0,ref:i=>V(i,F),class:De(["thumbnail-item",[{active:F===s.value},...J(B)]]),title:A(B),"data-index":F,onClick:i=>P(F)},[B.originalDataURL?(K(),G("img",{key:0,src:B.originalDataURL,alt:B.fileName,class:"thumbnail-image"},null,8,$l)):fe("",!0),X(B)==="failed"?(K(),G("span",Tl,"!")):X(B)==="labeled"?(K(),G("span",Il,"✏️")):fe("",!0),X(B)==="processing"?(K(),G("div",Dl,"⟳")):fe("",!0)],10,wl))),128))],512)):(K(),G("div",Rl,[...D[0]||(D[0]=[e("p",null,"暂无图片",-1)])]))])]))}}),Bl=qe(Ml,[["__scopeId","data-v-899e5674"]]),El={class:"saved-prompts-picker"},Pl={class:"prompts-chips-container"},Al={key:0,class:"empty-hint"},Fl={key:1,class:"empty-hint"},Ll=["title","onClick"],Ul=He({__name:"SavedPromptsPicker",props:{promptType:{}},emits:["select"],setup(n,{expose:c,emit:u}){const t=n,r=u,a=S([]),o=S(!1);async function s(){o.value=!0;try{let P;t.promptType==="textbox"?P=await Ve.getTextboxPrompts():P=await Ve.getPrompts(t.promptType);const T=P.prompt_names||[];a.value=T.map(V=>({name:V}))}catch(P){console.error("加载提示词列表失败:",P),a.value=[]}finally{o.value=!1}}async function y(P){try{let T;t.promptType==="textbox"?T=await Ve.getTextboxPromptContent(P):T=await Ve.getPromptContent(t.promptType,P),T.prompt_content&&r("select",T.prompt_content,P)}catch(T){console.error("加载提示词内容失败:",T)}}return ye(()=>t.promptType,()=>{s()}),ut(()=>{s()}),c({refresh:s}),(P,T)=>(K(),G("div",El,[T[1]||(T[1]=e("span",{class:"picker-label"},"📑 快速选择:",-1)),e("div",Pl,[o.value?(K(),G("span",Al,"加载中...")):a.value.length===0?(K(),G("span",Fl,"暂无保存的提示词")):(K(!0),G(Xe,{key:2},Ge(a.value,V=>(K(),G("button",{key:V.name,type:"button",class:"prompt-chip",title:V.name,onClick:X=>y(V.name)},[T[0]||(T[0]=e("span",{class:"chip-icon"},"📝",-1)),Ue(" "+ue(V.name),1)],8,Ll))),128))])]))}}),$t=qe(Ul,[["__scopeId","data-v-2ebbb8b3"]]),Ol={class:"ocr-settings"},zl={class:"settings-group"},Vl={class:"settings-item"},Nl={class:"settings-item"},Wl={class:"input-hint"},Kl={class:"settings-group"},ql={class:"settings-row"},Hl={class:"settings-item"},Yl={class:"password-input-wrapper"},Jl=["type"],Xl={key:0,class:"eye-icon"},jl={key:1,class:"eye-off-icon"},Gl={class:"settings-item"},Zl={class:"password-input-wrapper"},Ql=["type"],ei={key:0,class:"eye-icon"},ti={key:1,class:"eye-off-icon"},ni={class:"settings-row"},oi={class:"settings-item"},ai={class:"settings-item"},si=["disabled"],li={class:"settings-group"},ii={class:"settings-row"},ri={class:"settings-item"},ui={class:"settings-item"},ci={class:"password-input-wrapper"},di=["type"],gi={key:0,class:"eye-icon"},pi={key:1,class:"eye-off-icon"},bi={class:"settings-item"},vi={class:"settings-item"},mi={class:"model-input-with-fetch"},fi=["disabled"],hi={class:"fetch-text"},yi={key:0,class:"model-select-container"},xi={class:"model-count"},Si={class:"settings-item"},ki={class:"prompt-format-selector"},_i={class:"settings-item"},Ci=["disabled"],wi=He({__name:"OcrSettings",setup(n){const c=[{label:"MangaOCR (日语专用)",value:"manga_ocr"},{label:"PaddleOCR (多语言)",value:"paddle_ocr"},{label:"百度OCR",value:"baidu_ocr"},{label:"AI视觉OCR",value:"ai_vision"}],u=[{label:"标准版",value:"standard"},{label:"高精度版",value:"high_precision"}],t=[{label:"自动检测",value:"auto_detect"},{label:"中英文混合",value:"CHN_ENG"},{label:"英文",value:"ENG"},{label:"日语",value:"JAP"},{label:"韩语",value:"KOR"},{label:"法语",value:"FRE"},{label:"德语",value:"GER"},{label:"俄语",value:"RUS"}],r=[{label:"SiliconFlow (硅基流动)",value:"siliconflow"},{label:"火山引擎",value:"volcano"},{label:"Google Gemini",value:"gemini"},{label:"自定义 OpenAI 兼容服务",value:"custom_openai_vision"}],a=[{label:"普通提示词",value:"false"},{label:"JSON提示词",value:"true"}],o=[{label:"🚀 常用语言",options:[{label:"日语",value:"japanese"},{label:"英语",value:"en"},{label:"简体中文",value:"chinese"},{label:"繁体中文",value:"chinese_cht"},{label:"韩语",value:"korean"}]},{label:"🌍 拉丁语系",options:[{label:"法语",value:"french"},{label:"德语",value:"german"},{label:"西班牙语",value:"spanish"},{label:"意大利语",value:"italian"},{label:"葡萄牙语",value:"portuguese"}]},{label:"🌏 其他语系",options:[{label:"俄语",value:"russian"}]}],s=Ke(),y=rt(),P=S({apiKey:s.settings.baiduOcr.apiKey,secretKey:s.settings.baiduOcr.secretKey,version:s.settings.baiduOcr.version,sourceLanguage:s.settings.baiduOcr.sourceLanguage}),T=S({apiKey:s.settings.aiVisionOcr.apiKey,modelName:s.settings.aiVisionOcr.modelName,customBaseUrl:s.settings.aiVisionOcr.customBaseUrl,prompt:s.settings.aiVisionOcr.prompt,rpmLimit:s.settings.aiVisionOcr.rpmLimit}),V=te(()=>s.settings);ye(()=>P.value.apiKey,m=>{s.updateBaiduOcr({apiKey:m})}),ye(()=>P.value.secretKey,m=>{s.updateBaiduOcr({secretKey:m})}),ye(()=>P.value.version,m=>{s.updateBaiduOcr({version:m})}),ye(()=>P.value.sourceLanguage,m=>{s.updateBaiduOcr({sourceLanguage:m})}),ye(()=>T.value.apiKey,m=>{s.updateAiVisionOcr({apiKey:m})}),ye(()=>T.value.modelName,m=>{s.updateAiVisionOcr({modelName:m})}),ye(()=>T.value.customBaseUrl,m=>{s.updateAiVisionOcr({customBaseUrl:m})}),ye(()=>T.value.prompt,m=>{s.updateAiVisionOcr({prompt:m})}),ye(()=>T.value.rpmLimit,m=>{s.updateAiVisionOcr({rpmLimit:m})});const X=S(!1),J=S(!1),A=S(!1),f=S(!1),D=S(!1),B=S([]),F=te(()=>{const m=[{label:"-- 选择模型 --",value:""}];return B.value.forEach(g=>{m.push({label:g,value:g})}),m});function i(){s.saveToStorage()}function l(){s.saveToStorage()}function v(){switch(s.settings.ocrEngine){case"manga_ocr":return"MangaOCR 专为日语漫画优化，源语言设置不影响识别";case"paddle_ocr":return"PaddleOCR 会根据源语言加载对应的识别模型";case"baidu_ocr":return"百度OCR 使用独立的源语言设置（见下方）";case"ai_vision":return"AI视觉OCR 通过提示词指定识别语言";default:return"选择要识别的原文语言"}}function p(m){s.setAiVisionOcrProvider(m),B.value=[],R()}function R(){T.value.apiKey=s.settings.aiVisionOcr.apiKey,T.value.modelName=s.settings.aiVisionOcr.modelName,T.value.customBaseUrl=s.settings.aiVisionOcr.customBaseUrl,T.value.prompt=s.settings.aiVisionOcr.prompt,T.value.rpmLimit=s.settings.aiVisionOcr.rpmLimit}function E(){const m=s.settings.aiVisionOcr.isJsonMode?Bo:Eo;s.updateAiVisionOcr({prompt:m}),T.value.prompt=m}async function N(){const m=P.value.apiKey?.trim(),g=P.value.secretKey?.trim();if(!m||!g){y.warning("请填写百度OCR的API Key和Secret Key");return}f.value=!0,y.info("正在测试百度OCR连接...");try{const k=await Ve.testBaiduOcrConnection(m,g);k.success?y.success(k.message||"百度OCR连接成功!"):y.error(k.message||k.error||"百度OCR连接失败")}catch(k){const $=k instanceof Error?k.message:"连接测试失败";y.error($)}finally{f.value=!1}}async function O(){f.value=!0;try{const m=await Ve.testAiVisionOcrConnection({provider:s.settings.aiVisionOcr.provider,apiKey:T.value.apiKey,modelName:T.value.modelName,customBaseUrl:T.value.customBaseUrl,prompt:T.value.prompt});m.success?y.success("AI视觉OCR连接成功"):y.error(`AI视觉OCR连接失败: ${m.error||"未知错误"}`)}catch(m){const g=m instanceof Error?m.message:"连接测试失败";y.error(g)}finally{f.value=!1}}async function C(){const m=s.settings.aiVisionOcr.provider,g=T.value.apiKey?.trim(),k=T.value.customBaseUrl?.trim();if(!g){y.warning("请先填写 API Key");return}if(!["siliconflow","volcano","gemini","custom_openai_vision"].includes(m)){y.warning("当前服务商不支持自动获取模型列表");return}if(m==="custom_openai_vision"&&!k){y.warning("自定义服务需要先填写 Base URL");return}D.value=!0;try{const b=await Ve.fetchModels(m,g,k);b.success&&b.models&&b.models.length>0?(B.value=b.models.map(h=>h.id),y.success(`获取到 ${b.models.length} 个模型`)):y.warning(b.message||"未获取到可用模型")}catch(b){const h=b instanceof Error?b.message:"获取模型列表失败";y.error(h)}finally{D.value=!1}}function w(m,g){s.updateAiVisionOcr({prompt:m}),T.value.prompt=m,y.success(`已应用提示词: ${g}`)}return(m,g)=>(K(),G("div",Ol,[e("div",zl,[g[19]||(g[19]=e("div",{class:"settings-group-title"},"OCR引擎选择",-1)),e("div",Vl,[g[17]||(g[17]=e("label",{for:"settingsOcrEngine"},"OCR引擎:",-1)),me(Oe,{"model-value":V.value.ocrEngine,options:c,onChange:g[0]||(g[0]=k=>{V.value.ocrEngine=k,i()})},null,8,["model-value"])]),oe(e("div",Nl,[g[18]||(g[18]=e("label",{for:"settingsSourceLanguage"},"源语言:",-1)),me(Oe,{"model-value":V.value.sourceLanguage,groups:o,onChange:g[1]||(g[1]=k=>{V.value.sourceLanguage=k,l()})},null,8,["model-value"]),e("div",Wl,ue(v()),1)],512),[[ze,V.value.ocrEngine==="paddle_ocr"]])]),oe(e("div",Kl,[g[24]||(g[24]=e("div",{class:"settings-group-title"},"百度OCR 设置",-1)),e("div",ql,[e("div",Hl,[g[20]||(g[20]=e("label",{for:"settingsBaiduApiKey"},"API Key:",-1)),e("div",Yl,[oe(e("input",{type:X.value?"text":"password",id:"settingsBaiduApiKey","onUpdate:modelValue":g[2]||(g[2]=k=>P.value.apiKey=k),class:"secure-input",placeholder:"请输入百度OCR API Key",autocomplete:"off"},null,8,Jl),[[St,P.value.apiKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:g[3]||(g[3]=k=>X.value=!X.value)},[X.value?(K(),G("span",jl,"👁‍🗨")):(K(),G("span",Xl,"👁"))])])]),e("div",Gl,[g[21]||(g[21]=e("label",{for:"settingsBaiduSecretKey"},"Secret Key:",-1)),e("div",Zl,[oe(e("input",{type:J.value?"text":"password",id:"settingsBaiduSecretKey","onUpdate:modelValue":g[4]||(g[4]=k=>P.value.secretKey=k),class:"secure-input",placeholder:"请输入Secret Key",autocomplete:"off"},null,8,Ql),[[St,P.value.secretKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:g[5]||(g[5]=k=>J.value=!J.value)},[J.value?(K(),G("span",ti,"👁‍🗨")):(K(),G("span",ei,"👁"))])])])]),e("div",ni,[e("div",oi,[g[22]||(g[22]=e("label",{for:"settingsBaiduVersion"},"识别版本:",-1)),me(Oe,{modelValue:P.value.version,"onUpdate:modelValue":g[6]||(g[6]=k=>P.value.version=k),options:u},null,8,["modelValue"])]),e("div",ai,[g[23]||(g[23]=e("label",{for:"settingsBaiduSourceLanguage"},"源语言:",-1)),me(Oe,{modelValue:P.value.sourceLanguage,"onUpdate:modelValue":g[7]||(g[7]=k=>P.value.sourceLanguage=k),options:t},null,8,["modelValue"])])]),e("button",{class:"settings-test-btn",onClick:N,disabled:f.value},ue(f.value?"测试中...":"🔗 测试连接"),9,si)],512),[[ze,V.value.ocrEngine==="baidu_ocr"]]),oe(e("div",li,[g[34]||(g[34]=e("div",{class:"settings-group-title"},"AI视觉OCR 设置",-1)),e("div",ii,[e("div",ri,[g[25]||(g[25]=e("label",{for:"settingsAiVisionProvider"},"服务商:",-1)),me(Oe,{"model-value":V.value.aiVisionOcr.provider,options:r,onChange:g[8]||(g[8]=k=>p(k))},null,8,["model-value"])]),e("div",ui,[g[26]||(g[26]=e("label",{for:"settingsAiVisionApiKey"},"API Key:",-1)),e("div",ci,[oe(e("input",{type:A.value?"text":"password",id:"settingsAiVisionApiKey","onUpdate:modelValue":g[9]||(g[9]=k=>T.value.apiKey=k),class:"secure-input",placeholder:"请输入API Key",autocomplete:"off"},null,8,di),[[St,T.value.apiKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:g[10]||(g[10]=k=>A.value=!A.value)},[A.value?(K(),G("span",pi,"👁‍🗨")):(K(),G("span",gi,"👁"))])])])]),oe(e("div",bi,[g[27]||(g[27]=e("label",{for:"settingsCustomAiVisionBaseUrl"},"Base URL:",-1)),oe(e("input",{type:"text",id:"settingsCustomAiVisionBaseUrl","onUpdate:modelValue":g[11]||(g[11]=k=>T.value.customBaseUrl=k),placeholder:"例如: https://api.example.com/v1"},null,512),[[Ce,T.value.customBaseUrl]])],512),[[ze,V.value.aiVisionOcr.provider==="custom_openai_vision"]]),e("div",vi,[g[29]||(g[29]=e("label",{for:"settingsAiVisionModelName"},"模型名称:",-1)),e("div",mi,[oe(e("input",{type:"text",id:"settingsAiVisionModelName","onUpdate:modelValue":g[12]||(g[12]=k=>T.value.modelName=k),placeholder:"如: silicon-llava2-34b"},null,512),[[Ce,T.value.modelName]]),e("button",{type:"button",class:"fetch-models-btn",title:"获取可用模型列表",onClick:C,disabled:D.value},[g[28]||(g[28]=e("span",{class:"fetch-icon"},"🔍",-1)),e("span",hi,ue(D.value?"获取中...":"获取模型"),1)],8,fi)]),B.value.length>0?(K(),G("div",yi,[me(Oe,{modelValue:T.value.modelName,"onUpdate:modelValue":g[13]||(g[13]=k=>T.value.modelName=k),options:F.value},null,8,["modelValue","options"]),e("span",xi,"共 "+ue(B.value.length)+" 个模型",1)])):fe("",!0)]),e("div",Si,[g[31]||(g[31]=e("label",{for:"settingsAiVisionOcrPrompt"},"OCR提示词:",-1)),oe(e("textarea",{id:"settingsAiVisionOcrPrompt","onUpdate:modelValue":g[14]||(g[14]=k=>T.value.prompt=k),rows:"3",placeholder:"AI视觉OCR提示词"},null,512),[[Ce,T.value.prompt]]),me($t,{"prompt-type":"ai_vision_ocr",onSelect:w}),e("div",ki,[me(Oe,{"model-value":V.value.aiVisionOcr.isJsonMode?"true":"false",options:a,onChange:g[15]||(g[15]=k=>{V.value.aiVisionOcr.isJsonMode=k==="true",E()})},null,8,["model-value"]),g[30]||(g[30]=e("span",{class:"input-hint"},"JSON格式输出更结构化",-1))])]),e("div",_i,[g[32]||(g[32]=e("label",{for:"settingsRpmAiVisionOcr"},"RPM限制 (每分钟请求数):",-1)),oe(e("input",{type:"number",id:"settingsRpmAiVisionOcr","onUpdate:modelValue":g[16]||(g[16]=k=>T.value.rpmLimit=k),min:"0",step:"1"},null,512),[[Ce,T.value.rpmLimit,void 0,{number:!0}]]),g[33]||(g[33]=e("div",{class:"input-hint"},"0 表示无限制",-1))]),e("button",{class:"settings-test-btn",onClick:O,disabled:f.value},ue(f.value?"测试中...":"🔗 测试连接"),9,Ci)],512),[[ze,V.value.ocrEngine==="ai_vision"]])]))}}),$i=qe(wi,[["__scopeId","data-v-f3101cc5"]]),Ti={class:"translation-settings"},Ii={class:"settings-group"},Di={class:"settings-row"},Ri={class:"settings-item"},Mi={class:"settings-item"},Bi={for:"settingsApiKey"},Ei={class:"password-input-wrapper"},Pi=["type","placeholder"],Ai={key:0,class:"eye-icon"},Fi={key:1,class:"eye-off-icon"},Li={class:"settings-item"},Ui={class:"settings-item"},Oi={for:"settingsModelName"},zi={class:"model-input-with-fetch"},Vi=["placeholder"],Ni=["disabled"],Wi={class:"fetch-text"},Ki={key:0,class:"model-select-container"},qi={class:"model-count"},Hi={class:"settings-item"},Yi={class:"local-model-list"},Ji={key:0,class:"model-list-container"},Xi=["disabled"],ji={key:1,class:"model-hint"},Gi={key:1,class:"model-list-container"},Zi=["disabled"],Qi={key:1,class:"model-hint"},er={class:"settings-row"},tr={class:"settings-item"},nr={class:"settings-item"},or={class:"settings-item"},ar=["disabled"],sr={class:"settings-item"},lr=["disabled"],ir={class:"settings-group"},rr={class:"settings-item"},ur={class:"prompt-format-selector"},cr={class:"settings-item"},dr={class:"checkbox-label"},gr={class:"settings-item"},pr=He({__name:"TranslationSettings",setup(n){const c=[{label:"SiliconFlow",value:"siliconflow"},{label:"DeepSeek",value:"deepseek"},{label:"火山引擎",value:"volcano"},{label:"彩云小译",value:"caiyun"},{label:"百度翻译",value:"baidu_translate"},{label:"有道翻译",value:"youdao_translate"},{label:"Google Gemini",value:"gemini"},{label:"Ollama (本地)",value:"ollama"},{label:"Sakura (本地)",value:"sakura"},{label:"自定义 OpenAI 兼容服务",value:"custom_openai"}],u=[{label:"普通提示词",value:"normal"},{label:"JSON提示词",value:"json"}],t=Ke(),r=rt(),a=S({modelProvider:t.settings.translation.provider,apiKey:t.settings.translation.apiKey,modelName:t.settings.translation.modelName,customBaseUrl:t.settings.translation.customBaseUrl,rpmTranslation:t.settings.translation.rpmLimit,translationMaxRetries:t.settings.translation.maxRetries,promptContent:t.settings.translatePrompt,translatePromptMode:t.settings.translation.isJsonMode?"json":"normal",enableTextboxPrompt:t.settings.useTextboxPrompt,textboxPromptContent:t.settings.textboxPrompt}),o=S(!1),s=S(!1),y=S(!1),P=S([]),T=S([]),V=S([]),X=te(()=>{const $=[{label:"-- 选择模型 --",value:""}];return P.value.forEach(b=>$.push({label:b,value:b})),$}),J=te(()=>{const $=[{label:"-- 选择模型 --",value:""}];return T.value.forEach(b=>$.push({label:b,value:b})),$}),A=te(()=>{const $=[{label:"-- 选择模型 --",value:""}];return V.value.forEach(b=>$.push({label:b,value:b})),$}),f=te(()=>["ollama","sakura"].includes(a.value.modelProvider)),D=te(()=>!["ollama","sakura","caiyun","baidu_translate","youdao_translate"].includes(a.value.modelProvider)),B=te(()=>["siliconflow","deepseek","volcano","gemini","custom_openai"].includes(a.value.modelProvider)),F=te(()=>{switch(a.value.modelProvider){case"baidu_translate":return"App ID";case"youdao_translate":return"App Key";case"caiyun":return"API Token";default:return"API Key"}}),i=te(()=>{switch(a.value.modelProvider){case"baidu_translate":return"请输入百度翻译App ID";case"youdao_translate":return"请输入有道翻译应用ID";case"caiyun":return"请输入彩云小译Token";default:return"请输入API Key"}}),l=te(()=>{switch(a.value.modelProvider){case"baidu_translate":return"App Key";case"youdao_translate":return"App Secret";case"caiyun":return"源语言 (可选)";default:return"模型名称"}}),v=te(()=>{switch(a.value.modelProvider){case"baidu_translate":return"请输入百度翻译App Key";case"youdao_translate":return"请输入有道翻译应用密钥";case"caiyun":return"可选: auto/日语/英语";default:return"请输入模型名称"}});function p(){const $=a.value.modelProvider;t.setTranslationProvider($),a.value.apiKey=t.settings.translation.apiKey,a.value.modelName=t.settings.translation.modelName,a.value.customBaseUrl=t.settings.translation.customBaseUrl,a.value.rpmTranslation=t.settings.translation.rpmLimit,a.value.translationMaxRetries=t.settings.translation.maxRetries,P.value=[]}function R(){const $=a.value.translatePromptMode==="json";$?a.value.promptContent=Po:a.value.promptContent=Ao,t.updateTranslationService({isJsonMode:$}),t.setTranslatePrompt(a.value.promptContent)}ye(()=>a.value.apiKey,$=>{t.updateTranslationService({apiKey:$})}),ye(()=>a.value.modelName,$=>{t.updateTranslationService({modelName:$})}),ye(()=>a.value.customBaseUrl,$=>{t.updateTranslationService({customBaseUrl:$})}),ye(()=>a.value.rpmTranslation,$=>{t.updateTranslationService({rpmLimit:$})}),ye(()=>a.value.translationMaxRetries,$=>{t.updateTranslationService({maxRetries:$})}),ye(()=>a.value.promptContent,$=>{t.setTranslatePrompt($)}),ye(()=>a.value.enableTextboxPrompt,$=>{t.setUseTextboxPrompt($)}),ye(()=>a.value.textboxPromptContent,$=>{t.setTextboxPrompt($)});async function E(){const $=a.value.modelProvider,b=a.value.apiKey?.trim(),h=a.value.customBaseUrl?.trim();if(!b){r.warning("请先填写 API Key");return}if(!["siliconflow","deepseek","volcano","gemini","custom_openai"].includes($)){r.warning(`${N($)} 不支持自动获取模型列表`);return}if($==="custom_openai"&&!h){r.warning("自定义服务需要先填写 Base URL");return}y.value=!0;try{const W=await Ve.fetchModels($,b,h);W.success&&W.models&&W.models.length>0?(P.value=W.models.map(x=>x.id),r.success(`获取到 ${W.models.length} 个模型`)):r.warning(W.message||"未获取到可用模型")}catch(W){const x=W instanceof Error?W.message:"获取模型列表失败";r.error(x)}finally{y.value=!1}}function N($){return{siliconflow:"SiliconFlow",deepseek:"DeepSeek",volcano:"火山引擎",gemini:"Google Gemini",custom_openai:"自定义OpenAI",ollama:"Ollama",sakura:"Sakura",caiyun:"彩云小译",baidu_translate:"百度翻译",youdao_translate:"有道翻译"}[$]||$}async function O(){y.value=!0;try{const $=await Ve.testOllamaConnection();$.success&&$.models?(T.value=$.models,r.success(`获取到 ${$.models.length} 个Ollama模型`)):r.error($.error||"Ollama连接失败")}catch($){const b=$ instanceof Error?$.message:"获取Ollama模型失败";r.error(b)}finally{y.value=!1}}async function C(){y.value=!0;try{const $=await Ve.testSakuraConnection();$.success&&$.models?(V.value=$.models,r.success(`获取到 ${$.models.length} 个Sakura模型`)):r.error($.error||"Sakura连接失败")}catch($){const b=$ instanceof Error?$.message:"获取Sakura模型失败";r.error(b)}finally{y.value=!1}}async function w(){s.value=!0;try{let $;a.value.modelProvider==="ollama"?$=await Ve.testOllamaConnection():$=await Ve.testSakuraConnection(),$.success?r.success(`${a.value.modelProvider==="ollama"?"Ollama":"Sakura"} 连接成功`):r.error($.error||"连接失败")}catch($){const b=$ instanceof Error?$.message:"连接测试失败";r.error(b)}finally{s.value=!1}}async function m(){const $=a.value.modelProvider,b=a.value.apiKey?.trim(),h=a.value.modelName?.trim(),Y=a.value.customBaseUrl?.trim();if(!b){r.warning("请先填写 API Key");return}if($!=="caiyun"&&!h){r.warning("请填写模型名称");return}if($==="custom_openai"&&!Y){r.warning("自定义服务需要填写 Base URL");return}s.value=!0,r.info("正在测试连接...");try{let W;switch($){case"baidu_translate":W=await Ve.testBaiduTranslateConnection(b,h);break;case"youdao_translate":W=await Ve.testYoudaoTranslateConnection(b,h);break;default:W=await Ve.testAiTranslateConnection({provider:$,apiKey:b,modelName:h,baseUrl:Y})}W.success?r.success(W.message||`${N($)} 连接成功!`):r.error(W.message||W.error||"连接失败")}catch(W){const x=W instanceof Error?W.message:"连接测试失败";r.error(x)}finally{s.value=!1}}function g($,b){a.value.promptContent=$,r.success(`已应用提示词: ${b}`)}function k($,b){a.value.textboxPromptContent=$,r.success(`已应用提示词: ${b}`)}return($,b)=>(K(),G("div",Ti,[e("div",Ii,[b[21]||(b[21]=e("div",{class:"settings-group-title"},"翻译服务配置",-1)),e("div",Di,[e("div",Ri,[b[14]||(b[14]=e("label",{for:"settingsModelProvider"},"翻译服务商:",-1)),me(Oe,{"model-value":a.value.modelProvider,options:c,onChange:b[0]||(b[0]=h=>{a.value.modelProvider=h,p()})},null,8,["model-value"])]),oe(e("div",Mi,[e("label",Bi,ue(F.value)+":",1),e("div",Ei,[oe(e("input",{type:o.value?"text":"password",id:"settingsApiKey","onUpdate:modelValue":b[1]||(b[1]=h=>a.value.apiKey=h),class:"secure-input",placeholder:i.value,autocomplete:"off"},null,8,Pi),[[St,a.value.apiKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:b[2]||(b[2]=h=>o.value=!o.value)},[o.value?(K(),G("span",Fi,"👁‍🗨")):(K(),G("span",Ai,"👁"))])])],512),[[ze,!f.value]])]),oe(e("div",Li,[b[15]||(b[15]=e("label",{for:"settingsCustomBaseUrl"},"Base URL:",-1)),oe(e("input",{type:"text",id:"settingsCustomBaseUrl","onUpdate:modelValue":b[3]||(b[3]=h=>a.value.customBaseUrl=h),placeholder:"例如: https://api.example.com/v1"},null,512),[[Ce,a.value.customBaseUrl]])],512),[[ze,a.value.modelProvider==="custom_openai"]]),oe(e("div",Ui,[e("label",Oi,ue(l.value)+":",1),e("div",zi,[oe(e("input",{type:"text",id:"settingsModelName","onUpdate:modelValue":b[4]||(b[4]=h=>a.value.modelName=h),placeholder:v.value},null,8,Vi),[[Ce,a.value.modelName]]),oe(e("button",{type:"button",class:"fetch-models-btn",title:"获取可用模型列表",onClick:E,disabled:y.value},[b[16]||(b[16]=e("span",{class:"fetch-icon"},"🔍",-1)),e("span",Wi,ue(y.value?"获取中...":"获取模型"),1)],8,Ni),[[ze,B.value]])]),P.value.length>0?(K(),G("div",Ki,[me(Oe,{"model-value":a.value.modelName,options:X.value,onChange:b[5]||(b[5]=h=>{a.value.modelName=h})},null,8,["model-value","options"]),e("span",qi,"共 "+ue(P.value.length)+" 个模型",1)])):fe("",!0)],512),[[ze,!f.value]]),oe(e("div",Hi,[b[17]||(b[17]=e("label",null,"本地模型:",-1)),e("div",Yi,[a.value.modelProvider==="ollama"?(K(),G("div",Ji,[e("button",{class:"settings-test-btn",onClick:O,disabled:y.value},ue(y.value?"获取中...":"🔄 刷新模型列表"),9,Xi),T.value.length>0?(K(),it(Oe,{key:0,"model-value":a.value.modelName,options:J.value,onChange:b[6]||(b[6]=h=>a.value.modelName=h)},null,8,["model-value","options"])):(K(),G("p",ji,"点击刷新获取可用模型"))])):a.value.modelProvider==="sakura"?(K(),G("div",Gi,[e("button",{class:"settings-test-btn",onClick:C,disabled:y.value},ue(y.value?"获取中...":"🔄 刷新模型列表"),9,Zi),V.value.length>0?(K(),it(Oe,{key:0,"model-value":a.value.modelName,options:A.value,onChange:b[7]||(b[7]=h=>a.value.modelName=h)},null,8,["model-value","options"])):(K(),G("p",Qi,"点击刷新获取可用模型"))])):fe("",!0)])],512),[[ze,f.value]]),oe(e("div",er,[e("div",tr,[b[18]||(b[18]=e("label",{for:"settingsRpmTranslation"},"RPM限制:",-1)),oe(e("input",{type:"number",id:"settingsRpmTranslation","onUpdate:modelValue":b[8]||(b[8]=h=>a.value.rpmTranslation=h),min:"0",step:"1"},null,512),[[Ce,a.value.rpmTranslation,void 0,{number:!0}]]),b[19]||(b[19]=e("div",{class:"input-hint"},"每分钟请求数，0表示无限制",-1))]),e("div",nr,[b[20]||(b[20]=e("label",{for:"settingsTranslationMaxRetries"},"重试次数:",-1)),oe(e("input",{type:"number",id:"settingsTranslationMaxRetries","onUpdate:modelValue":b[9]||(b[9]=h=>a.value.translationMaxRetries=h),min:"0",max:"10",step:"1"},null,512),[[Ce,a.value.translationMaxRetries,void 0,{number:!0}]])])],512),[[ze,D.value]]),oe(e("div",or,[e("button",{class:"settings-test-btn",onClick:w,disabled:s.value},ue(s.value?"测试中...":"🔗 测试连接"),9,ar)],512),[[ze,f.value]]),oe(e("div",sr,[e("button",{class:"settings-test-btn",onClick:m,disabled:s.value},ue(s.value?"测试中...":"🔗 测试连接"),9,lr)],512),[[ze,!f.value]])]),e("div",ir,[b[26]||(b[26]=e("div",{class:"settings-group-title"},"提示词设置",-1)),e("div",rr,[b[23]||(b[23]=e("label",{for:"settingsPromptContent"},"翻译提示词:",-1)),oe(e("textarea",{id:"settingsPromptContent","onUpdate:modelValue":b[10]||(b[10]=h=>a.value.promptContent=h),rows:"4",placeholder:"翻译提示词"},null,512),[[Ce,a.value.promptContent]]),e("div",ur,[me(Oe,{"model-value":a.value.translatePromptMode,options:u,onChange:b[11]||(b[11]=h=>{a.value.translatePromptMode=h,R()})},null,8,["model-value"]),b[22]||(b[22]=e("span",{class:"input-hint"},"JSON格式输出更结构化",-1))]),me($t,{"prompt-type":"translate",onSelect:g})]),e("div",cr,[e("label",dr,[oe(e("input",{type:"checkbox","onUpdate:modelValue":b[12]||(b[12]=h=>a.value.enableTextboxPrompt=h)},null,512),[[Ze,a.value.enableTextboxPrompt]]),b[24]||(b[24]=Ue(" 启用文本框提示词 ",-1))])]),oe(e("div",gr,[b[25]||(b[25]=e("label",{for:"settingsTextboxPromptContent"},"文本框提示词:",-1)),oe(e("textarea",{id:"settingsTextboxPromptContent","onUpdate:modelValue":b[13]||(b[13]=h=>a.value.textboxPromptContent=h),rows:"3",placeholder:"文本框提示词"},null,512),[[Ce,a.value.textboxPromptContent]]),me($t,{"prompt-type":"textbox",onSelect:k})],512),[[ze,a.value.enableTextboxPrompt]])])]))}}),br=qe(pr,[["__scopeId","data-v-165d523b"]]),vr={class:"detection-settings"},mr={class:"settings-group"},fr={class:"settings-item"},hr={class:"settings-group"},yr={class:"settings-item"},xr={class:"settings-row"},Sr={class:"settings-item"},kr={class:"settings-item"},_r={class:"settings-row"},Cr={class:"settings-item"},wr={class:"settings-item"},$r={class:"settings-group"},Tr={class:"settings-item"},Ir={class:"checkbox-label"},Dr={class:"settings-row"},Rr={class:"settings-item"},Mr={class:"settings-item"},Br={class:"settings-group"},Er={class:"settings-item"},Pr={class:"checkbox-label"},Ar=He({__name:"DetectionSettings",setup(n){const c=[{label:"CTD (Comic Text Detector)",value:"ctd"},{label:"YOLO",value:"yolo"},{label:"YOLOv5",value:"yolov5"},{label:"Default (DBNet)",value:"default"}],u=Ke(),t=Uo({textDetector:u.settings.textDetector,boxExpandRatio:u.settings.boxExpand.ratio,boxExpandTop:u.settings.boxExpand.top,boxExpandBottom:u.settings.boxExpand.bottom,boxExpandLeft:u.settings.boxExpand.left,boxExpandRight:u.settings.boxExpand.right,usePreciseMask:u.settings.preciseMask.enabled,maskDilateSize:u.settings.preciseMask.dilateSize,maskBoxExpandRatio:u.settings.preciseMask.boxExpandRatio,showDetectionDebug:u.settings.showDetectionDebug}),r=te(()=>["ctd","default"].includes(t.textDetector));ye(()=>t.textDetector,o=>{u.setTextDetector(o)}),ye(()=>t.boxExpandRatio,o=>{u.updateBoxExpand({ratio:o})}),ye(()=>t.boxExpandTop,o=>{u.updateBoxExpand({top:o})}),ye(()=>t.boxExpandBottom,o=>{u.updateBoxExpand({bottom:o})}),ye(()=>t.boxExpandLeft,o=>{u.updateBoxExpand({left:o})}),ye(()=>t.boxExpandRight,o=>{u.updateBoxExpand({right:o})}),ye(()=>t.usePreciseMask,o=>{u.updatePreciseMask({enabled:o})}),ye(()=>t.maskDilateSize,o=>{u.updatePreciseMask({dilateSize:o})}),ye(()=>t.maskBoxExpandRatio,o=>{u.updatePreciseMask({boxExpandRatio:o})}),ye(()=>t.showDetectionDebug,o=>{u.setShowDetectionDebug(o)});function a(){r.value||(t.usePreciseMask=!1)}return(o,s)=>(K(),G("div",vr,[e("div",mr,[s[11]||(s[11]=e("div",{class:"settings-group-title"},"文字检测器",-1)),e("div",fr,[s[10]||(s[10]=e("label",{for:"settingsTextDetector"},"检测器类型:",-1)),me(Oe,{modelValue:t.textDetector,"onUpdate:modelValue":s[0]||(s[0]=y=>t.textDetector=y),options:c,onChange:a},null,8,["modelValue"])])]),e("div",hr,[s[18]||(s[18]=e("div",{class:"settings-group-title"},"文本框扩展参数",-1)),e("div",yr,[s[12]||(s[12]=e("label",{for:"settingsBoxExpandRatio"},"整体扩展 (%):",-1)),oe(e("input",{type:"number",id:"settingsBoxExpandRatio","onUpdate:modelValue":s[1]||(s[1]=y=>t.boxExpandRatio=y),min:"0",max:"50",step:"1"},null,512),[[Ce,t.boxExpandRatio,void 0,{number:!0}]]),s[13]||(s[13]=e("div",{class:"input-hint"},"向四周均匀扩展的百分比 (0-50%)",-1))]),e("div",xr,[e("div",Sr,[s[14]||(s[14]=e("label",{for:"settingsBoxExpandTop"},"上方扩展 (%):",-1)),oe(e("input",{type:"number",id:"settingsBoxExpandTop","onUpdate:modelValue":s[2]||(s[2]=y=>t.boxExpandTop=y),min:"0",max:"50",step:"1"},null,512),[[Ce,t.boxExpandTop,void 0,{number:!0}]])]),e("div",kr,[s[15]||(s[15]=e("label",{for:"settingsBoxExpandBottom"},"下方扩展 (%):",-1)),oe(e("input",{type:"number",id:"settingsBoxExpandBottom","onUpdate:modelValue":s[3]||(s[3]=y=>t.boxExpandBottom=y),min:"0",max:"50",step:"1"},null,512),[[Ce,t.boxExpandBottom,void 0,{number:!0}]])])]),e("div",_r,[e("div",Cr,[s[16]||(s[16]=e("label",{for:"settingsBoxExpandLeft"},"左侧扩展 (%):",-1)),oe(e("input",{type:"number",id:"settingsBoxExpandLeft","onUpdate:modelValue":s[4]||(s[4]=y=>t.boxExpandLeft=y),min:"0",max:"50",step:"1"},null,512),[[Ce,t.boxExpandLeft,void 0,{number:!0}]])]),e("div",wr,[s[17]||(s[17]=e("label",{for:"settingsBoxExpandRight"},"右侧扩展 (%):",-1)),oe(e("input",{type:"number",id:"settingsBoxExpandRight","onUpdate:modelValue":s[5]||(s[5]=y=>t.boxExpandRight=y),min:"0",max:"50",step:"1"},null,512),[[Ce,t.boxExpandRight,void 0,{number:!0}]])])])]),oe(e("div",$r,[s[25]||(s[25]=e("div",{class:"settings-group-title"},"精确文字掩膜",-1)),e("div",Tr,[e("label",Ir,[oe(e("input",{type:"checkbox","onUpdate:modelValue":s[6]||(s[6]=y=>t.usePreciseMask=y)},null,512),[[Ze,t.usePreciseMask]]),s[19]||(s[19]=Ue(" 启用精确文字掩膜 ",-1))]),s[20]||(s[20]=e("div",{class:"input-hint"},"使用更精确的文字区域掩膜进行修复",-1))]),oe(e("div",Dr,[e("div",Rr,[s[21]||(s[21]=e("label",{for:"settingsMaskDilateSize"},"膨胀大小:",-1)),oe(e("input",{type:"number",id:"settingsMaskDilateSize","onUpdate:modelValue":s[7]||(s[7]=y=>t.maskDilateSize=y),min:"0",step:"1"},null,512),[[Ce,t.maskDilateSize,void 0,{number:!0}]]),s[22]||(s[22]=e("div",{class:"input-hint"},"掩膜膨胀像素数",-1))]),e("div",Mr,[s[23]||(s[23]=e("label",{for:"settingsMaskBoxExpandRatio"},"标注框扩大比例 (%):",-1)),oe(e("input",{type:"number",id:"settingsMaskBoxExpandRatio","onUpdate:modelValue":s[8]||(s[8]=y=>t.maskBoxExpandRatio=y),min:"0",max:"100",step:"1"},null,512),[[Ce,t.maskBoxExpandRatio,void 0,{number:!0}]]),s[24]||(s[24]=e("div",{class:"input-hint"},"标注框区域扩大百分比",-1))])],512),[[ze,t.usePreciseMask]])],512),[[ze,r.value]]),e("div",Br,[s[28]||(s[28]=e("div",{class:"settings-group-title"},"调试选项",-1)),e("div",Er,[e("label",Pr,[oe(e("input",{type:"checkbox","onUpdate:modelValue":s[9]||(s[9]=y=>t.showDetectionDebug=y)},null,512),[[Ze,t.showDetectionDebug]]),s[26]||(s[26]=Ue(" 显示检测框调试信息 ",-1))]),s[27]||(s[27]=e("div",{class:"input-hint"},"在翻译结果中显示气泡检测框，用于调试",-1))])])]))}}),Fr=qe(Ar,[["__scopeId","data-v-c12c43ee"]]),Lr={class:"hq-translation-settings"},Ur={class:"settings-group"},Or={class:"settings-row"},zr={class:"settings-item"},Vr={class:"settings-item"},Nr={class:"password-input-wrapper"},Wr=["type"],Kr={key:0,class:"eye-icon"},qr={key:1,class:"eye-off-icon"},Hr={class:"settings-item"},Yr={class:"settings-item"},Jr={class:"model-input-with-fetch"},Xr=["disabled"],jr={class:"fetch-text"},Gr={key:0,class:"model-select-container"},Zr={class:"model-count"},Qr={class:"settings-item"},eu=["disabled"],tu={class:"settings-group"},nu={class:"settings-row"},ou={class:"settings-item"},au={class:"settings-item"},su={class:"settings-row"},lu={class:"settings-item"},iu={class:"settings-item"},ru={class:"settings-group"},uu={class:"settings-row"},cu={class:"settings-item"},du={class:"checkbox-label"},gu={class:"settings-item"},pu={class:"settings-row"},bu={class:"settings-item"},vu={class:"checkbox-label"},mu={class:"settings-item"},fu={class:"checkbox-label"},hu={class:"settings-group"},yu={class:"settings-item"},xu=He({__name:"HqTranslationSettings",setup(n){const c=[{label:"SiliconFlow",value:"siliconflow"},{label:"DeepSeek",value:"deepseek"},{label:"火山引擎",value:"volcano"},{label:"Google Gemini",value:"gemini"},{label:"自定义 OpenAI 兼容服务",value:"custom_openai"}],u=[{label:"Gemini风格 (reasoning_effort=low)",value:"gemini"},{label:"火山引擎风格 (thinking=null)",value:"volcano"}],t=Ke(),r=rt(),a=te(()=>t.settings.hqTranslation),o=S({apiKey:t.settings.hqTranslation.apiKey,modelName:t.settings.hqTranslation.modelName,customBaseUrl:t.settings.hqTranslation.customBaseUrl,batchSize:t.settings.hqTranslation.batchSize,sessionReset:t.settings.hqTranslation.sessionReset,rpmLimit:t.settings.hqTranslation.rpmLimit,maxRetries:t.settings.hqTranslation.maxRetries,lowReasoning:t.settings.hqTranslation.lowReasoning,noThinkingMethod:t.settings.hqTranslation.noThinkingMethod,forceJsonOutput:t.settings.hqTranslation.forceJsonOutput,useStream:t.settings.hqTranslation.useStream,prompt:t.settings.hqTranslation.prompt});ye(()=>o.value.apiKey,i=>{t.updateHqTranslation({apiKey:i})}),ye(()=>o.value.modelName,i=>{t.updateHqTranslation({modelName:i})}),ye(()=>o.value.customBaseUrl,i=>{t.updateHqTranslation({customBaseUrl:i})}),ye(()=>o.value.batchSize,i=>{t.updateHqTranslation({batchSize:i})}),ye(()=>o.value.sessionReset,i=>{t.updateHqTranslation({sessionReset:i})}),ye(()=>o.value.rpmLimit,i=>{t.updateHqTranslation({rpmLimit:i})}),ye(()=>o.value.maxRetries,i=>{t.updateHqTranslation({maxRetries:i})}),ye(()=>o.value.lowReasoning,i=>{t.updateHqTranslation({lowReasoning:i})}),ye(()=>o.value.noThinkingMethod,i=>{t.updateHqTranslation({noThinkingMethod:i})}),ye(()=>o.value.forceJsonOutput,i=>{t.updateHqTranslation({forceJsonOutput:i})}),ye(()=>o.value.useStream,i=>{t.updateHqTranslation({useStream:i})}),ye(()=>o.value.prompt,i=>{t.updateHqTranslation({prompt:i})});const s=S(!1),y=S(!1),P=S([]),T=S(!1),V=te(()=>{const i=[{label:"-- 选择模型 --",value:""}];return P.value.forEach(l=>i.push({label:l,value:l})),i});function X(i){t.setHqProvider(i),P.value=[],J()}function J(){const i=t.settings.hqTranslation;o.value.apiKey=i.apiKey,o.value.modelName=i.modelName,o.value.customBaseUrl=i.customBaseUrl,o.value.batchSize=i.batchSize,o.value.sessionReset=i.sessionReset,o.value.rpmLimit=i.rpmLimit,o.value.maxRetries=i.maxRetries,o.value.lowReasoning=i.lowReasoning,o.value.noThinkingMethod=i.noThinkingMethod,o.value.forceJsonOutput=i.forceJsonOutput,o.value.useStream=i.useStream,o.value.prompt=i.prompt}function A(i){return{siliconflow:"SiliconFlow",deepseek:"DeepSeek",volcano:"火山引擎",gemini:"Google Gemini",custom_openai:"自定义OpenAI"}[i]||i}async function f(){const i=a.value.provider,l=o.value.apiKey?.trim(),v=o.value.customBaseUrl?.trim();if(!l){r.warning("请先填写 API Key");return}if(!["siliconflow","deepseek","volcano","gemini","custom_openai"].includes(i)){r.warning(`${A(i)} 不支持自动获取模型列表`);return}if(i==="custom_openai"&&!v){r.warning("自定义服务需要先填写 Base URL");return}y.value=!0;try{const R=await Ve.fetchModels(i,l,v);R.success&&R.models&&R.models.length>0?(P.value=R.models.map(E=>E.id),r.success(`获取到 ${R.models.length} 个模型`)):r.warning(R.message||"未获取到可用模型")}catch(R){const E=R instanceof Error?R.message:"获取模型列表失败";r.error(E)}finally{y.value=!1}}async function D(){const i=a.value.provider,l=o.value.apiKey?.trim(),v=o.value.modelName?.trim(),p=o.value.customBaseUrl?.trim();if(!l){r.warning("请先填写 API Key");return}if(!v){r.warning("请填写模型名称");return}if(i==="custom_openai"&&!p){r.warning("自定义服务需要填写 Base URL");return}T.value=!0,r.info("正在测试连接...");try{const R=await Ve.testAiTranslateConnection({provider:i,apiKey:l,modelName:v,baseUrl:p});R.success?r.success(R.message||`${A(i)} 连接成功!`):r.error(R.message||R.error||"连接失败")}catch(R){const E=R instanceof Error?R.message:"连接测试失败";r.error(E)}finally{T.value=!1}}function B(){t.updateHqTranslation({prompt:En}),o.value.prompt=En,r.success("已重置为默认提示词")}function F(i,l){t.updateHqTranslation({prompt:i}),o.value.prompt=i,r.success(`已应用提示词: ${l}`)}return(i,l)=>(K(),G("div",Lr,[e("div",Ur,[l[20]||(l[20]=e("div",{class:"settings-group-title"},"高质量翻译服务配置",-1)),e("div",Or,[e("div",zr,[l[15]||(l[15]=e("label",{for:"settingsHqTranslateProvider"},"服务商:",-1)),me(Oe,{"model-value":a.value.provider,options:c,onChange:l[0]||(l[0]=v=>X(v))},null,8,["model-value"])]),e("div",Vr,[l[16]||(l[16]=e("label",{for:"settingsHqApiKey"},"API Key:",-1)),e("div",Nr,[oe(e("input",{type:s.value?"text":"password",id:"settingsHqApiKey","onUpdate:modelValue":l[1]||(l[1]=v=>o.value.apiKey=v),class:"secure-input",placeholder:"请输入API Key",autocomplete:"off"},null,8,Wr),[[St,o.value.apiKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:l[2]||(l[2]=v=>s.value=!s.value)},[s.value?(K(),G("span",qr,"👁‍🗨")):(K(),G("span",Kr,"👁"))])])])]),oe(e("div",Hr,[l[17]||(l[17]=e("label",{for:"settingsHqCustomBaseUrl"},"Base URL:",-1)),oe(e("input",{type:"text",id:"settingsHqCustomBaseUrl","onUpdate:modelValue":l[3]||(l[3]=v=>o.value.customBaseUrl=v),placeholder:"例如: https://api.example.com/v1"},null,512),[[Ce,o.value.customBaseUrl]])],512),[[ze,a.value.provider==="custom_openai"]]),e("div",Yr,[l[19]||(l[19]=e("label",{for:"settingsHqModelName"},"模型名称:",-1)),e("div",Jr,[oe(e("input",{type:"text",id:"settingsHqModelName","onUpdate:modelValue":l[4]||(l[4]=v=>o.value.modelName=v),placeholder:"请输入模型名称"},null,512),[[Ce,o.value.modelName]]),e("button",{type:"button",class:"fetch-models-btn",title:"获取可用模型列表",onClick:f,disabled:y.value},[l[18]||(l[18]=e("span",{class:"fetch-icon"},"🔍",-1)),e("span",jr,ue(y.value?"获取中...":"获取模型"),1)],8,Xr)]),P.value.length>0?(K(),G("div",Gr,[me(Oe,{modelValue:o.value.modelName,"onUpdate:modelValue":l[5]||(l[5]=v=>o.value.modelName=v),options:V.value},null,8,["modelValue","options"]),e("span",Zr,"共 "+ue(P.value.length)+" 个模型",1)])):fe("",!0)]),e("div",Qr,[e("button",{class:"settings-test-btn",onClick:D,disabled:T.value},ue(T.value?"测试中...":"🔗 测试连接"),9,eu)])]),e("div",tu,[l[28]||(l[28]=e("div",{class:"settings-group-title"},"批处理设置",-1)),e("div",nu,[e("div",ou,[l[21]||(l[21]=e("label",{for:"settingsHqBatchSize"},"批次大小:",-1)),oe(e("input",{type:"number",id:"settingsHqBatchSize","onUpdate:modelValue":l[6]||(l[6]=v=>o.value.batchSize=v),min:"1",max:"10",step:"1"},null,512),[[Ce,o.value.batchSize,void 0,{number:!0}]]),l[22]||(l[22]=e("div",{class:"input-hint"},"每批处理的图片数量 (推荐3-5张)",-1))]),e("div",au,[l[23]||(l[23]=e("label",{for:"settingsHqSessionReset"},"会话重置频率:",-1)),oe(e("input",{type:"number",id:"settingsHqSessionReset","onUpdate:modelValue":l[7]||(l[7]=v=>o.value.sessionReset=v),min:"1",step:"1"},null,512),[[Ce,o.value.sessionReset,void 0,{number:!0}]]),l[24]||(l[24]=e("div",{class:"input-hint"},"多少批次后重置上下文",-1))])]),e("div",su,[e("div",lu,[l[25]||(l[25]=e("label",{for:"settingsHqRpmLimit"},"RPM限制:",-1)),oe(e("input",{type:"number",id:"settingsHqRpmLimit","onUpdate:modelValue":l[8]||(l[8]=v=>o.value.rpmLimit=v),min:"0",step:"1"},null,512),[[Ce,o.value.rpmLimit,void 0,{number:!0}]]),l[26]||(l[26]=e("div",{class:"input-hint"},"每分钟请求数，0表示无限制",-1))]),e("div",iu,[l[27]||(l[27]=e("label",{for:"settingsHqMaxRetries"},"重试次数:",-1)),oe(e("input",{type:"number",id:"settingsHqMaxRetries","onUpdate:modelValue":l[9]||(l[9]=v=>o.value.maxRetries=v),min:"0",max:"10",step:"1"},null,512),[[Ce,o.value.maxRetries,void 0,{number:!0}]])])])]),e("div",ru,[l[36]||(l[36]=e("div",{class:"settings-group-title"},"高级选项",-1)),e("div",uu,[e("div",cu,[e("label",du,[oe(e("input",{type:"checkbox","onUpdate:modelValue":l[10]||(l[10]=v=>o.value.lowReasoning=v)},null,512),[[Ze,o.value.lowReasoning]]),l[29]||(l[29]=Ue(" 低推理模式 ",-1))]),l[30]||(l[30]=e("div",{class:"input-hint"},"减少模型推理深度，提高速度",-1))]),e("div",gu,[l[31]||(l[31]=e("label",{for:"settingsHqNoThinkingMethod"},"取消思考方法:",-1)),me(Oe,{modelValue:o.value.noThinkingMethod,"onUpdate:modelValue":l[11]||(l[11]=v=>o.value.noThinkingMethod=v),options:u},null,8,["modelValue"])])]),e("div",pu,[e("div",bu,[e("label",vu,[oe(e("input",{type:"checkbox","onUpdate:modelValue":l[12]||(l[12]=v=>o.value.forceJsonOutput=v)},null,512),[[Ze,o.value.forceJsonOutput]]),l[32]||(l[32]=Ue(" 强制JSON输出 ",-1))]),l[33]||(l[33]=e("div",{class:"input-hint"},"使用 response_format: json_object",-1))]),e("div",mu,[e("label",fu,[oe(e("input",{type:"checkbox","onUpdate:modelValue":l[13]||(l[13]=v=>o.value.useStream=v)},null,512),[[Ze,o.value.useStream]]),l[34]||(l[34]=Ue(" 流式调用 ",-1))]),l[35]||(l[35]=e("div",{class:"input-hint"},"使用流式API调用",-1))])])]),e("div",hu,[l[37]||(l[37]=e("div",{class:"settings-group-title"},"高质量翻译提示词",-1)),e("div",yu,[oe(e("textarea",{id:"settingsHqPrompt","onUpdate:modelValue":l[14]||(l[14]=v=>o.value.prompt=v),rows:"6",placeholder:"高质量翻译提示词"},null,512),[[Ce,o.value.prompt]]),me($t,{"prompt-type":"hq_translate",onSelect:F}),e("button",{class:"btn btn-secondary btn-sm",onClick:B},"重置为默认")])])]))}}),Su=qe(xu,[["__scopeId","data-v-23f4a3f7"]]),ku={class:"proofreading-settings"},_u={class:"settings-group"},Cu={class:"settings-item"},wu={class:"checkbox-label"},$u={class:"settings-item"},Tu={class:"settings-group"},Iu={class:"round-header"},Du={class:"round-title"},Ru=["onClick","disabled"],Mu={class:"round-content"},Bu={class:"settings-item"},Eu=["onUpdate:modelValue"],Pu={class:"settings-row"},Au={class:"settings-item"},Fu={class:"settings-item"},Lu={class:"password-input-wrapper"},Uu=["type","onUpdate:modelValue"],Ou=["onClick"],zu={key:0,class:"eye-icon"},Vu={key:1,class:"eye-off-icon"},Nu={class:"settings-item"},Wu=["onUpdate:modelValue"],Ku={class:"settings-item"},qu={class:"model-input-with-fetch"},Hu=["onUpdate:modelValue"],Yu=["onClick","disabled"],Ju={class:"fetch-text"},Xu={key:0,class:"model-select-container"},ju={class:"model-count"},Gu={class:"settings-item"},Zu=["onClick","disabled"],Qu={class:"settings-row"},ec={class:"settings-item"},tc=["onUpdate:modelValue"],nc={class:"settings-item"},oc=["onUpdate:modelValue"],ac={class:"settings-item"},sc=["onUpdate:modelValue"],lc={class:"settings-row"},ic={class:"settings-item"},rc={class:"checkbox-label"},uc=["onUpdate:modelValue"],cc={class:"settings-item"},dc={class:"settings-item"},gc={class:"checkbox-label"},pc=["onUpdate:modelValue"],bc={class:"settings-item"},vc=["onUpdate:modelValue"],mc=["onClick"],fc=He({__name:"ProofreadingSettings",setup(n){const c=[{label:"SiliconFlow",value:"siliconflow"},{label:"DeepSeek",value:"deepseek"},{label:"火山引擎",value:"volcano"},{label:"Google Gemini",value:"gemini"},{label:"自定义 OpenAI 兼容服务",value:"custom_openai"}],u=[{label:"Gemini风格",value:"gemini"},{label:"火山引擎风格",value:"volcano"}],t=Ke(),r=rt(),a=S({}),o=S({}),s=S({}),y=te(()=>t.settings.proofreading.rounds),P=te({get:()=>t.settings.proofreading.maxRetries,set:F=>t.setProofreadingMaxRetries(F)}),T=te({get:()=>t.settings.proofreading.enabled,set:F=>t.setProofreadingEnabled(F)});ye(()=>t.settings.proofreading.rounds,()=>{t.saveToStorage()},{deep:!0});function V(F){const i=s.value[F]||[],l=[{label:"-- 选择模型 --",value:""}];return i.forEach(v=>l.push({label:v,value:v})),l}async function X(F){const i=y.value[F];if(!i)return;const l=i.provider,v=i.apiKey?.trim(),p=i.customBaseUrl?.trim();if(!v){r.warning("请先填写 API Key");return}if(!["siliconflow","deepseek","volcano","gemini","custom_openai"].includes(l)){r.warning("当前服务商不支持获取模型列表");return}a.value[F]=!0;try{const E=await Ve.fetchModels(l,v,p);E.success&&E.models&&E.models.length>0?(s.value[F]=E.models.map(N=>N.id),r.success(`轮次 ${F+1}: 获取到 ${E.models.length} 个模型`)):r.warning(E.message||"未获取到可用模型")}catch(E){const N=E instanceof Error?E.message:"获取模型列表失败";r.error(N)}finally{a.value[F]=!1}}async function J(F){const i=y.value[F];if(!i)return;const l=i.provider,v=i.apiKey?.trim(),p=i.modelName?.trim(),R=i.customBaseUrl?.trim();if(!v){r.warning("请先填写 API Key");return}if(!p){r.warning("请填写模型名称");return}o.value[F]=!0,r.info(`正在测试轮次 ${F+1} 的连接...`);try{const E=await Ve.testAiTranslateConnection({provider:l,apiKey:v,modelName:p,baseUrl:R});E.success?r.success(E.message||"连接成功!"):r.error(E.message||E.error||"连接失败")}catch(E){const N=E instanceof Error?E.message:"连接测试失败";r.error(N)}finally{o.value[F]=!1}}function A(){const F={name:`第${y.value.length+1}轮校对`,provider:"siliconflow",apiKey:"",modelName:"",customBaseUrl:"",batchSize:3,sessionReset:20,rpmLimit:7,lowReasoning:!1,noThinkingMethod:"gemini",forceJsonOutput:!0,prompt:Pn,showApiKey:!1};t.addProofreadingRound(F),r.success("已添加新的校对轮次")}function f(F){if(y.value.length<=1){r.warning("至少需要保留一个校对轮次");return}t.removeProofreadingRound(F),r.success("已删除校对轮次")}function D(F){t.updateProofreadingRound(F,{prompt:Pn}),r.success("已重置为默认提示词")}function B(F,i,l){t.updateProofreadingRound(F,{prompt:i}),r.success(`已应用提示词: ${l}`)}return(F,i)=>(K(),G("div",ku,[e("div",_u,[i[5]||(i[5]=e("div",{class:"settings-group-title"},"AI校对设置",-1)),e("div",Cu,[e("label",wu,[oe(e("input",{type:"checkbox","onUpdate:modelValue":i[0]||(i[0]=l=>T.value=l)},null,512),[[Ze,T.value]]),i[2]||(i[2]=Ue(" 启用AI校对 ",-1))]),i[3]||(i[3]=e("div",{class:"input-hint"},"翻译完成后自动进行AI校对",-1))]),e("div",$u,[i[4]||(i[4]=e("label",{for:"settingsProofreadingMaxRetries"},"全局重试次数:",-1)),oe(e("input",{type:"number",id:"settingsProofreadingMaxRetries","onUpdate:modelValue":i[1]||(i[1]=l=>P.value=l),min:"0",max:"10",step:"1"},null,512),[[Ce,P.value,void 0,{number:!0}]])])]),oe(e("div",Tu,[e("div",{class:"settings-group-title"},[i[6]||(i[6]=Ue(" 校对轮次配置 ",-1)),e("button",{class:"btn btn-secondary btn-sm",onClick:A},"+ 添加轮次")]),(K(!0),G(Xe,null,Ge(y.value,(l,v)=>(K(),G("div",{key:v,class:"proofreading-round"},[e("div",Iu,[e("span",Du,"轮次 "+ue(v+1)+": "+ue(l.name||"未命名"),1),e("button",{class:"btn btn-danger btn-sm",onClick:p=>f(v),disabled:y.value.length<=1}," 删除 ",8,Ru)]),e("div",Mu,[e("div",Bu,[i[7]||(i[7]=e("label",null,"轮次名称:",-1)),oe(e("input",{type:"text","onUpdate:modelValue":p=>l.name=p,placeholder:"如: 第一轮校对"},null,8,Eu),[[Ce,l.name]])]),e("div",Pu,[e("div",Au,[i[8]||(i[8]=e("label",null,"服务商:",-1)),me(Oe,{modelValue:l.provider,"onUpdate:modelValue":p=>l.provider=p,options:c},null,8,["modelValue","onUpdate:modelValue"])]),e("div",Fu,[i[9]||(i[9]=e("label",null,"API Key:",-1)),e("div",Lu,[oe(e("input",{type:l.showApiKey?"text":"password","onUpdate:modelValue":p=>l.apiKey=p,class:"secure-input",placeholder:"请输入API Key",autocomplete:"off"},null,8,Uu),[[St,l.apiKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:p=>l.showApiKey=!l.showApiKey},[l.showApiKey?(K(),G("span",Vu,"👁‍🗨")):(K(),G("span",zu,"👁"))],8,Ou)])])]),oe(e("div",Nu,[i[10]||(i[10]=e("label",null,"Base URL:",-1)),oe(e("input",{type:"text","onUpdate:modelValue":p=>l.customBaseUrl=p,placeholder:"例如: https://api.example.com/v1"},null,8,Wu),[[Ce,l.customBaseUrl]])],512),[[ze,l.provider==="custom_openai"]]),e("div",Ku,[i[12]||(i[12]=e("label",null,"模型名称:",-1)),e("div",qu,[oe(e("input",{type:"text","onUpdate:modelValue":p=>l.modelName=p,placeholder:"请输入模型名称"},null,8,Hu),[[Ce,l.modelName]]),e("button",{type:"button",class:"fetch-models-btn",title:"获取可用模型列表",onClick:p=>X(v),disabled:a.value[v]},[i[11]||(i[11]=e("span",{class:"fetch-icon"},"🔍",-1)),e("span",Ju,ue(a.value[v]?"获取中...":"获取模型"),1)],8,Yu)]),s.value[v]&&s.value[v].length>0?(K(),G("div",Xu,[me(Oe,{modelValue:l.modelName,"onUpdate:modelValue":p=>l.modelName=p,options:V(v)},null,8,["modelValue","onUpdate:modelValue","options"]),e("span",ju,"共 "+ue(s.value[v].length)+" 个模型",1)])):fe("",!0)]),e("div",Gu,[e("button",{class:"settings-test-btn",onClick:p=>J(v),disabled:o.value[v]},ue(o.value[v]?"测试中...":"🔗 测试连接"),9,Zu)]),e("div",Qu,[e("div",ec,[i[13]||(i[13]=e("label",null,"批次大小:",-1)),oe(e("input",{type:"number","onUpdate:modelValue":p=>l.batchSize=p,min:"1",max:"10",step:"1"},null,8,tc),[[Ce,l.batchSize,void 0,{number:!0}]])]),e("div",nc,[i[14]||(i[14]=e("label",null,"会话重置频率:",-1)),oe(e("input",{type:"number","onUpdate:modelValue":p=>l.sessionReset=p,min:"1",step:"1"},null,8,oc),[[Ce,l.sessionReset,void 0,{number:!0}]])]),e("div",ac,[i[15]||(i[15]=e("label",null,"RPM限制:",-1)),oe(e("input",{type:"number","onUpdate:modelValue":p=>l.rpmLimit=p,min:"0",step:"1"},null,8,sc),[[Ce,l.rpmLimit,void 0,{number:!0}]])])]),e("div",lc,[e("div",ic,[e("label",rc,[oe(e("input",{type:"checkbox","onUpdate:modelValue":p=>l.lowReasoning=p},null,8,uc),[[Ze,l.lowReasoning]]),i[16]||(i[16]=Ue(" 低推理模式 ",-1))])]),e("div",cc,[i[17]||(i[17]=e("label",null,"取消思考方法:",-1)),me(Oe,{modelValue:l.noThinkingMethod,"onUpdate:modelValue":p=>l.noThinkingMethod=p,options:u},null,8,["modelValue","onUpdate:modelValue"])]),e("div",dc,[e("label",gc,[oe(e("input",{type:"checkbox","onUpdate:modelValue":p=>l.forceJsonOutput=p},null,8,pc),[[Ze,l.forceJsonOutput]]),i[18]||(i[18]=Ue(" 强制JSON输出 ",-1))])])]),e("div",bc,[i[19]||(i[19]=e("label",null,"校对提示词:",-1)),oe(e("textarea",{"onUpdate:modelValue":p=>l.prompt=p,rows:"4",placeholder:"校对提示词"},null,8,vc),[[Ce,l.prompt]]),me($t,{"prompt-type":"proofreading",onSelect:(p,R)=>B(v,p,R)},null,8,["onSelect"]),e("button",{class:"btn btn-secondary btn-sm",onClick:p=>D(v)},"重置为默认",8,mc)])])]))),128))],512),[[ze,T.value]])]))}}),hc=qe(fc,[["__scopeId","data-v-663a7972"]]),yc={class:"prompt-library"},xc={class:"settings-group"},Sc={class:"settings-item"},kc={key:0,class:"settings-item"},_c={class:"mode-hint"},Cc={class:"settings-group"},wc={key:0,class:"loading-hint"},$c={key:1,class:"empty-hint"},Tc={key:2,class:"prompt-list"},Ic=["onClick"],Dc={class:"prompt-name"},Rc={class:"prompt-actions"},Mc=["onClick"],Bc=["onClick","disabled"],Ec={class:"settings-group"},Pc={class:"settings-item"},Ac={class:"settings-item"},Fc={class:"prompt-editor-actions"},Lc=["disabled"],Uc=He({__name:"PromptLibrary",setup(n){const c=[{label:"翻译提示词",value:"translate"},{label:"文本框提示词",value:"textbox"},{label:"AI视觉OCR提示词",value:"ai_vision_ocr"},{label:"高质量翻译提示词",value:"hq_translate"},{label:"校对提示词",value:"proofreading"}],u=[{label:"普通模式",value:"false"},{label:"JSON格式模式",value:"true"}],t=rt(),r=Ke(),a=S("translate"),o=S([]),s=S(""),y=S(""),P=S(""),T=S(!1),V=S(!1),X=te(()=>a.value==="translate"||a.value==="ai_vision_ocr"),J=te(()=>V.value?"适用于需要结构化输出的场景":"适用于普通翻译场景");async function A(){T.value=!0;try{let v;a.value==="textbox"?v=await Ve.getTextboxPrompts():v=await Ve.getPrompts(a.value);const p=v.prompt_names||[];o.value=p.map(R=>({name:R}))}catch(v){const p=v instanceof Error?v.message:"加载提示词列表失败";t.error(p)}finally{T.value=!1}}async function f(v){s.value=v,y.value=v,await D(v)}async function D(v){try{let p;a.value==="textbox"?p=await Ve.getTextboxPromptContent(v):p=await Ve.getPromptContent(a.value,v),y.value=v,P.value=p.prompt_content||"",s.value=v,t.success("已加载提示词")}catch(p){const R=p instanceof Error?p.message:"加载提示词内容失败";t.error(R)}}async function B(){if(!y.value||!P.value){t.warning("请输入提示词名称和内容");return}try{a.value==="textbox"?await Ve.saveTextboxPrompt(y.value,P.value):await Ve.savePrompt(a.value,y.value,P.value),t.success("提示词保存成功"),y.value="",P.value="",await A()}catch(v){const p=v instanceof Error?v.message:"保存提示词失败";t.error(p)}}async function F(v){if(v==="default"){t.warning("默认提示词不能删除");return}try{a.value==="textbox"?await Ve.deleteTextboxPrompt(v):await Ve.deletePrompt(a.value,v),t.success("提示词删除成功"),s.value===v&&(s.value="",y.value="",P.value=""),await A()}catch(p){const R=p instanceof Error?p.message:"删除提示词失败";t.error(R)}}function i(){s.value="",y.value="",P.value="",a.value==="translate"?V.value=r.settings.translation.isJsonMode:a.value==="ai_vision_ocr"?V.value=r.settings.aiVisionOcr.isJsonMode:V.value=!1,A()}function l(){a.value==="translate"?r.updateTranslationService({isJsonMode:V.value}):a.value==="ai_vision_ocr"&&r.updateAiVisionOcr({isJsonMode:V.value}),t.info(`已切换到${V.value?"JSON格式":"普通"}模式`)}return ut(()=>{V.value=r.settings.translation.isJsonMode,A()}),(v,p)=>(K(),G("div",yc,[e("div",xc,[p[6]||(p[6]=e("div",{class:"settings-group-title"},"提示词管理",-1)),e("div",Sc,[p[4]||(p[4]=e("label",{for:"promptType"},"提示词类型:",-1)),me(Oe,{modelValue:a.value,"onUpdate:modelValue":p[0]||(p[0]=R=>a.value=R),options:c,onChange:i},null,8,["modelValue"])]),X.value?(K(),G("div",kc,[p[5]||(p[5]=e("label",{for:"promptMode"},"提示词模式:",-1)),me(Oe,{"model-value":V.value?"true":"false",options:u,onChange:p[1]||(p[1]=R=>{V.value=R==="true",l()})},null,8,["model-value"]),e("span",_c,ue(J.value),1)])):fe("",!0)]),e("div",Cc,[p[7]||(p[7]=e("div",{class:"settings-group-title"},"已保存的提示词",-1)),T.value?(K(),G("div",wc,"加载中...")):o.value.length===0?(K(),G("div",$c,"暂无保存的提示词")):(K(),G("div",Tc,[(K(!0),G(Xe,null,Ge(o.value,R=>(K(),G("div",{key:R.name,class:De(["prompt-item",{active:s.value===R.name}]),onClick:E=>f(R.name)},[e("span",Dc,ue(R.name),1),e("div",Rc,[e("button",{class:"btn btn-sm",onClick:tt(E=>D(R.name),["stop"]),title:"加载到编辑器"},"📥",8,Mc),e("button",{class:"btn btn-sm btn-danger",onClick:tt(E=>F(R.name),["stop"]),title:"删除",disabled:R.name==="default"}," 🗑️ ",8,Bc)])],10,Ic))),128))]))]),e("div",Ec,[p[10]||(p[10]=e("div",{class:"settings-group-title"},"提示词编辑",-1)),e("div",Pc,[p[8]||(p[8]=e("label",{for:"promptName"},"提示词名称:",-1)),oe(e("input",{type:"text",id:"promptName","onUpdate:modelValue":p[2]||(p[2]=R=>y.value=R),placeholder:"请输入提示词名称"},null,512),[[Ce,y.value]])]),e("div",Ac,[p[9]||(p[9]=e("label",{for:"promptContent"},"提示词内容:",-1)),oe(e("textarea",{id:"promptContent","onUpdate:modelValue":p[3]||(p[3]=R=>P.value=R),rows:"8",placeholder:"请输入提示词内容"},null,512),[[Ce,P.value]])]),e("div",Fc,[e("button",{class:"btn btn-primary",onClick:B,disabled:!y.value||!P.value},"保存提示词",8,Lc)])])]))}}),Oc=qe(Uc,[["__scopeId","data-v-70f0ec19"]]),zc={class:"plugin-manager"},Vc={class:"settings-group"},Nc={key:0,class:"loading-hint"},Wc={key:1,class:"empty-hint"},Kc={key:2,class:"plugin-list"},qc={class:"plugin-info"},Hc={class:"plugin-header"},Yc={class:"plugin-name"},Jc={class:"plugin-version"},Xc={class:"plugin-description"},jc={class:"plugin-controls"},Gc={class:"switch"},Zc=["checked","onChange"],Qc=["onClick"],ed=["onClick"],td={class:"settings-group"},nd={class:"plugin-name"},od={class:"switch"},ad=["checked","onChange"],sd={class:"plugin-config-content"},ld={class:"plugin-config-header"},id={class:"plugin-config-body"},rd=["for"],ud=["id","onUpdate:modelValue"],cd=["id","onUpdate:modelValue","min","max"],dd=["id","onUpdate:modelValue","placeholder"],gd={key:4,class:"field-description"},pd=He({__name:"PluginManager",setup(n){const c=rt(),u=S([]),t=S({}),r=S(!1),a=S(!1),o=S(null),s=S({}),y=S({});async function P(){r.value=!0;try{const B=await oa();u.value=B.plugins||[]}catch(B){const F=B instanceof Error?B.message:"加载插件列表失败";c.error(F)}finally{r.value=!1}}async function T(){try{const B=await ga();t.value=B.states||{}}catch(B){console.error("加载默认状态失败:",B)}}async function V(B){try{B.enabled?(await sa(B.name),B.enabled=!1,c.success(`已禁用 ${B.display_name||B.name}`)):(await aa(B.name),B.enabled=!0,c.success(`已启用 ${B.display_name||B.name}`))}catch(F){const i=F instanceof Error?F.message:"操作失败";c.error(i)}}async function X(B,F){const i=F.target,l=i.checked;try{await pa(B,l),t.value[B]=l,c.success("默认状态已更新")}catch(v){const p=v instanceof Error?v.message:"设置失败";c.error(p),i.checked=!l}}async function J(B){o.value=B;try{const F=await ba(B.name);s.value=F.schema||{};const i=await va(B.name);y.value=i.config||{},a.value=!0}catch(F){const i=F instanceof Error?F.message:"加载配置失败";c.error(i)}}function A(){a.value=!1,o.value=null,s.value={},y.value={}}async function f(){if(o.value)try{await ma(o.value.name,y.value),c.success("配置保存成功"),A()}catch(B){const F=B instanceof Error?B.message:"保存配置失败";c.error(F)}}async function D(B){if(confirm(`确定要删除插件 "${B.display_name||B.name}" 吗？`))try{await la(B.name),c.success("插件删除成功"),await P()}catch(F){const i=F instanceof Error?F.message:"删除插件失败";c.error(i)}}return ut(()=>{P(),T()}),(B,F)=>(K(),G("div",zc,[e("div",Vc,[F[1]||(F[1]=e("div",{class:"settings-group-title"},"已安装插件",-1)),r.value?(K(),G("div",Nc,"加载中...")):u.value.length===0?(K(),G("div",Wc,"暂无已安装的插件")):(K(),G("div",Kc,[(K(!0),G(Xe,null,Ge(u.value,i=>(K(),G("div",{key:i.name,class:"plugin-item"},[e("div",qc,[e("div",Hc,[e("span",Yc,ue(i.display_name||i.name),1),e("span",Jc,"v"+ue(i.version||"1.0.0"),1)]),e("p",Xc,ue(i.description||"暂无描述"),1)]),e("div",jc,[e("label",Gc,[e("input",{type:"checkbox",checked:i.enabled,onChange:l=>V(i)},null,40,Zc),F[0]||(F[0]=e("span",{class:"slider"},null,-1))]),i.has_config?(K(),G("button",{key:0,class:"btn btn-sm",onClick:l=>J(i),title:"配置"},"⚙️",8,Qc)):fe("",!0),e("button",{class:"btn btn-sm btn-danger",onClick:l=>D(i),title:"删除"},"🗑️",8,ed)])]))),128))]))]),e("div",td,[F[3]||(F[3]=e("div",{class:"settings-group-title"},"默认启用状态",-1)),F[4]||(F[4]=e("p",{class:"settings-hint"},"设置插件在新会话中的默认启用状态",-1)),(K(!0),G(Xe,null,Ge(u.value,i=>(K(),G("div",{key:"default-"+i.name,class:"default-state-item"},[e("span",nd,ue(i.display_name||i.name),1),e("label",od,[e("input",{type:"checkbox",checked:t.value[i.name],onChange:l=>X(i.name,l)},null,40,ad),F[2]||(F[2]=e("span",{class:"slider"},null,-1))])]))),128))]),a.value?(K(),G("div",{key:0,class:"plugin-config-modal",onClick:tt(A,["self"])},[e("div",sd,[e("div",ld,[e("h4",null,ue(o.value?.display_name||o.value?.name)+" 配置",1),e("span",{class:"close-btn",onClick:A},"×")]),e("div",id,[(K(!0),G(Xe,null,Ge(s.value,(i,l)=>(K(),G("div",{key:l,class:"config-field"},[e("label",{for:"config-"+l},ue(i.label||l)+":",9,rd),i.type==="boolean"?oe((K(),G("input",{key:0,type:"checkbox",id:"config-"+l,"onUpdate:modelValue":v=>y.value[l]=v},null,8,ud)),[[Ze,y.value[l]]]):i.type==="select"?(K(),it(Oe,{key:1,"model-value":String(y.value[l]??""),options:i.options||[],onChange:v=>{y.value[l]=v}},null,8,["model-value","options","onChange"])):i.type==="number"?oe((K(),G("input",{key:2,type:"number",id:"config-"+l,"onUpdate:modelValue":v=>y.value[l]=v,min:i.min,max:i.max},null,8,cd)),[[Ce,y.value[l],void 0,{number:!0}]]):oe((K(),G("input",{key:3,type:"text",id:"config-"+l,"onUpdate:modelValue":v=>y.value[l]=v,placeholder:i.placeholder},null,8,dd)),[[Ce,y.value[l]]]),i.description?(K(),G("p",gd,ue(i.description),1)):fe("",!0)]))),128))]),e("div",{class:"plugin-config-footer"},[e("button",{class:"btn btn-secondary",onClick:A},"取消"),e("button",{class:"btn btn-primary",onClick:f},"保存")])])])):fe("",!0)]))}}),bd=qe(pd,[["__scopeId","data-v-a62393a7"]]),vd={class:"more-settings"},md={class:"settings-group"},fd={class:"settings-item"},hd={class:"settings-group"},yd={class:"settings-item"},xd=["disabled"],Sd={key:0,class:"font-count"},kd={class:"settings-item"},_d={class:"settings-group"},Cd={class:"settings-row"},wd={class:"settings-item"},$d=["disabled"],Td={class:"settings-item"},Id=["disabled"],Dd=He({__name:"MoreSettings",setup(n){const c=[{label:"前端 pdf.js (推荐)",value:"frontend"},{label:"后端 PyMuPDF",value:"backend"}],u=Ke(),t=rt(),r=S(!1),a=S([]),o=S(!1),s=S(null),y=S({pdfProcessingMethod:u.settings.pdfProcessingMethod||"frontend"});ye(()=>y.value.pdfProcessingMethod,J=>{u.setPdfProcessingMethod(J)});async function P(){r.value=!0;try{const J=await Ve.getFontList();a.value=J.fonts||[],t.success(`获取到 ${a.value.length} 个字体`)}catch(J){const A=J instanceof Error?J.message:"获取字体列表失败";t.error(A)}finally{r.value=!1}}async function T(J){const f=J.target.files?.[0];if(!f)return;const D=[".ttf",".ttc",".otf"],B=f.name.toLowerCase().slice(f.name.lastIndexOf("."));if(!D.includes(B)){t.error("不支持的字体格式，请上传 .ttf, .ttc 或 .otf 文件");return}try{const F=await Ve.uploadFont(f);F.success?(t.success(`字体 "${F.fontPath||f.name}" 上传成功`),await P()):t.error(F.error||"字体上传失败")}catch(F){const i=F instanceof Error?F.message:"字体上传失败";t.error(i)}finally{s.value&&(s.value.value="")}}async function V(){o.value=!0;try{const J=await Xn();J.success?t.success(`已清理 ${J.deleted_count||0} 个调试文件`):t.error(J.error||"清理失败")}catch(J){const A=J instanceof Error?J.message:"清理失败";t.error(A)}finally{o.value=!1}}async function X(){o.value=!0;try{const J=await rn();J.success?t.success(`已清理 ${J.deleted_count||0} 个临时文件`):t.error(J.error||"清理失败")}catch(J){const A=J instanceof Error?J.message:"清理失败";t.error(A)}finally{o.value=!1}}return(J,A)=>(K(),G("div",vd,[e("div",md,[A[3]||(A[3]=e("div",{class:"settings-group-title"},"PDF处理设置",-1)),e("div",fd,[A[1]||(A[1]=e("label",{for:"settingsPdfProcessingMethod"},"PDF处理方式:",-1)),me(Oe,{modelValue:y.value.pdfProcessingMethod,"onUpdate:modelValue":A[0]||(A[0]=f=>y.value.pdfProcessingMethod=f),options:c},null,8,["modelValue"]),A[2]||(A[2]=e("div",{class:"input-hint"},"前端处理速度更快，后端处理兼容性更好",-1))])]),e("div",hd,[A[7]||(A[7]=e("div",{class:"settings-group-title"},"字体设置",-1)),e("div",yd,[A[4]||(A[4]=e("label",null,"系统字体列表:",-1)),e("button",{class:"btn btn-secondary",onClick:P,disabled:r.value},ue(r.value?"加载中...":"🔄 刷新字体列表"),9,xd),a.value.length>0?(K(),G("div",Sd,"共 "+ue(a.value.length)+" 个字体",1)):fe("",!0)]),e("div",kd,[A[5]||(A[5]=e("label",null,"上传自定义字体:",-1)),e("input",{type:"file",accept:".ttf,.ttc,.otf",onChange:T,ref_key:"fontInput",ref:s},null,544),A[6]||(A[6]=e("div",{class:"input-hint"},"支持 .ttf, .ttc, .otf 格式",-1))])]),e("div",_d,[A[10]||(A[10]=e("div",{class:"settings-group-title"},"缓存清理",-1)),e("div",Cd,[e("div",wd,[e("button",{class:"btn btn-secondary",onClick:V,disabled:o.value},ue(o.value?"清理中...":"🗑️ 清理调试文件"),9,$d),A[8]||(A[8]=e("div",{class:"input-hint"},"清理调试过程中生成的临时文件",-1))]),e("div",Td,[e("button",{class:"btn btn-secondary",onClick:X,disabled:o.value},ue(o.value?"清理中...":"🗑️ 清理临时文件"),9,Id),A[9]||(A[9]=e("div",{class:"input-hint"},"清理下载和处理过程中的临时文件",-1))])])]),A[11]||(A[11]=Zt('<div class="settings-group" data-v-136fb3b8><div class="settings-group-title" data-v-136fb3b8>关于</div><div class="about-info" data-v-136fb3b8><p data-v-136fb3b8><strong data-v-136fb3b8>Saber-Translator</strong></p><p data-v-136fb3b8>AI驱动的漫画翻译工具</p><p class="links" data-v-136fb3b8><a href="http://www.mashirosaber.top" target="_blank" data-v-136fb3b8>📖 使用教程</a><a href="https://github.com/MashiroSaber/saber-translator" target="_blank" data-v-136fb3b8>🐙 GitHub</a></p><p class="disclaimer" data-v-136fb3b8>本项目完全开源免费，请勿上当受骗</p></div></div>',1))]))}}),Rd=qe(Dd,[["__scopeId","data-v-136fb3b8"]]),Md={class:"settings-modal-content"},Bd={class:"settings-tabs"},Ed=["onClick"],Pd={class:"settings-tab-content"},Ad={class:"settings-tab-pane active"},Fd={class:"settings-tab-pane"},Ld={class:"settings-tab-pane"},Ud={class:"settings-tab-pane"},Od={class:"settings-tab-pane"},zd={class:"settings-tab-pane"},Vd={class:"settings-tab-pane"},Nd={class:"settings-tab-pane"},Wd=He({__name:"SettingsModal",props:{modelValue:{type:Boolean},initialTab:{}},emits:["update:modelValue","save"],setup(n,{emit:c}){const u=n,t=c,r=Ke(),a=S(u.modelValue),o=S("ocr"),s=[{id:"ocr",label:"OCR识别"},{id:"translate",label:"翻译服务"},{id:"detection",label:"检测设置"},{id:"hq",label:"高质量翻译"},{id:"proofreading",label:"AI校对"},{id:"prompt-library",label:"提示词管理"},{id:"plugins",label:"插件管理"},{id:"more",label:"更多"}];ye(()=>u.modelValue,V=>{a.value=V,V?(document.body.style.overflow="hidden",u.initialTab&&s.some(X=>X.id===u.initialTab)&&(o.value=u.initialTab)):(document.body.style.overflow="",o.value="ocr")});function y(){a.value=!1,t("update:modelValue",!1),document.body.style.overflow=""}async function P(){r.saveToStorage();try{await r.saveToBackend(),console.log("[SettingsModal] 设置已保存到后端")}catch(V){console.warn("[SettingsModal] 保存到后端失败，仅保存到 localStorage:",V)}t("save"),y()}function T(V){V.key==="Escape"&&a.value&&y()}return ut(()=>{document.addEventListener("keydown",T)}),Tt(()=>{document.removeEventListener("keydown",T),document.body.style.overflow=""}),(V,X)=>a.value?(K(),G("div",{key:0,class:"settings-modal",onClick:tt(y,["self"])},[e("div",Md,[e("div",{class:"settings-modal-header"},[X[0]||(X[0]=e("h3",null,"⚙️ 设置",-1)),e("span",{class:"settings-modal-close",onClick:y},"×")]),e("div",Bd,[(K(),G(Xe,null,Ge(s,J=>e("button",{key:J.id,class:De(["settings-tab",{active:o.value===J.id}]),onClick:A=>o.value=J.id},ue(J.label),11,Ed)),64))]),e("div",Pd,[oe(e("div",Ad,[me($i)],512),[[ze,o.value==="ocr"]]),oe(e("div",Fd,[me(br)],512),[[ze,o.value==="translate"]]),oe(e("div",Ld,[me(Fr)],512),[[ze,o.value==="detection"]]),oe(e("div",Ud,[me(Su)],512),[[ze,o.value==="hq"]]),oe(e("div",Od,[me(hc)],512),[[ze,o.value==="proofreading"]]),oe(e("div",zd,[me(Oc)],512),[[ze,o.value==="prompt-library"]]),oe(e("div",Vd,[me(bd)],512),[[ze,o.value==="plugins"]]),oe(e("div",Nd,[me(Rd)],512),[[ze,o.value==="more"]])]),e("div",{class:"settings-modal-footer"},[e("button",{class:"btn btn-secondary",onClick:y},"取消"),e("button",{class:"btn btn-primary",onClick:P},"保存设置")])])])):fe("",!0)}}),Kd=qe(Wd,[["__scopeId","data-v-e1ec20ab"]]),qd={minScale:.1,maxScale:5,zoomSpeed:.1};function qn(n={}){const c={...qd,...n},u=S(1),t=S(0),r=S(0),a=S(!1),o=S(0),s=S(0),y=te(()=>({transform:`translate(${t.value}px, ${r.value}px) scale(${u.value})`}));function P(O,C,w){const m=Math.min(Math.max(u.value*w,c.minScale),c.maxScale),g=m/u.value;t.value=O-(O-t.value)*g,r.value=C-(C-r.value)*g,u.value=m,n.onScaleChange?.(u.value),n.onTransformChange?.(p())}function T(O,C=800,w=600){P(C/2,w/2,O)}function V(){T(1.2)}function X(){T(.8)}function J(O,C=800,w=600){const m=O/u.value;P(C/2,w/2,m)}function A(O,C){a.value=!0,o.value=O,s.value=C}function f(O,C){if(!a.value)return;const w=O-o.value,m=C-s.value;t.value+=w,r.value+=m,o.value=O,s.value=C,n.onTransformChange?.(p())}function D(){a.value=!1}function B(O,C){t.value+=O,r.value+=C,n.onTransformChange?.(p())}function F(){u.value=1,t.value=0,r.value=0,n.onScaleChange?.(u.value),n.onTransformChange?.(p())}function i(){F()}function l(){u.value=1,t.value=0,r.value=0}function v(O,C,w,m){if(!O||!C)return;const g=w/O,k=m/C;u.value=Math.min(g,k)*.95,t.value=(w-O*u.value)/2,r.value=(m-C*u.value)/2,n.onScaleChange?.(u.value),n.onTransformChange?.(p())}function p(){return{scale:u.value,translateX:t.value,translateY:r.value}}function R(O){O.scale!==void 0&&(u.value=O.scale),O.translateX!==void 0&&(t.value=O.translateX),O.translateY!==void 0&&(r.value=O.translateY),n.onTransformChange?.(p())}function E(O){u.value=O.scale,t.value=O.translateX,r.value=O.translateY}function N(O,C,w){if(!O||O.length<4)return;const[m,g,k,$]=O,b=(m+k)/2,h=(g+$)/2,Y=C/2,W=w/2;t.value=Y-b*u.value,r.value=W-h*u.value,n.onTransformChange?.(p())}return{scale:u,translateX:t,translateY:r,isDragging:a,transformStyle:y,zoomAt:P,zoom:T,zoomIn:V,zoomOut:X,setScale:J,startDrag:A,drag:f,endDrag:D,pan:B,reset:F,resetZoom:i,resetTransform:l,fitToScreen:v,getTransform:p,setTransform:R,syncWith:E,scrollToBubble:N}}function Hd(n){const c=Qe(),u=Ke(),t=S(null),r=S(Fo),a=S(!1),o=S(!1),s=S([]),y=S(0),P=S(0);let T=null,V=null,X=null;const J=te(()=>t.value!==null),A=te(()=>t.value==="repair"?{fill:"rgba(76, 175, 80, 0.4)",border:"#4CAF50"}:t.value==="restore"?{fill:"rgba(33, 150, 243, 0.4)",border:"#2196F3"}:{fill:"transparent",border:"transparent"});function f(h){t.value!==h&&(t.value=h,a.value=!0,s.value=[],console.log(`进入${h==="repair"?"修复":"还原"}笔刷模式，笔刷大小: ${r.value}px`))}function D(){o.value&&R();const h=t.value!==null;t.value=null,a.value=!1,o.value=!1,s.value=[],C(),h&&console.log("退出笔刷模式")}function B(h){t.value===h?D():f(h)}function F(h){r.value=Math.max(Fn,Math.min(An,h))}function i(h){F(r.value+h)}function l(h){if(!J.value)return;h.preventDefault(),h.stopPropagation();const Y=h.deltaY>0?-5:5;i(Y)}function v(h,Y){if(!J.value||h.button!==0)return;h.preventDefault(),h.stopPropagation(),o.value=!0,T=Y,s.value=[];const W=E(h,Y);W&&(s.value.push(W),O(Y),w(W)),console.log("开始笔刷涂抹")}function p(h){if(y.value=h.clientX,P.value=h.clientY,!o.value||!J.value)return;const Y=E(h,T);Y&&(s.value.push(Y),w(Y))}function R(){if(!o.value)return;o.value=!1;const h=c.currentImage;if(!h||s.value.length===0){C(),s.value=[];return}const Y=N();if(!Y){C(),s.value=[];return}const W=t.value;(async()=>{W==="restore"?await m(h,Y):W==="repair"&&await g(h,Y),n?.onBrushComplete?.()})(),C(),s.value=[]}function E(h,Y){if(!Y)return null;const W=Y.querySelector(".image-canvas-wrapper"),x=W?.querySelector("img");if(!x||!x.naturalWidth)return null;const _=W.getBoundingClientRect(),d=window.getComputedStyle(W).transform;let M=1;d&&d!=="none"&&(M=new DOMMatrix(d).a);const ae=(h.clientX-_.left)/M,L=(h.clientY-_.top)/M,j=x.naturalWidth,le=x.naturalHeight;return ae<0||L<0||ae>j||L>le?null:{x:ae,y:L,scale:M}}function N(){if(s.value.length===0)return null;const Y=s.value[0]?.scale||1,W=r.value/2/Y;let x=1/0,_=1/0,d=-1/0,M=-1/0;for(const ae of s.value)x=Math.min(x,ae.x-W),_=Math.min(_,ae.y-W),d=Math.max(d,ae.x+W),M=Math.max(M,ae.y+W);return{x1:Math.max(0,Math.floor(x)),y1:Math.max(0,Math.floor(_)),x2:Math.ceil(d),y2:Math.ceil(M),path:[...s.value],radius:W}}function O(h){C();const Y=h.querySelector(".image-canvas-wrapper"),W=Y?.querySelector("img");if(!W)return;const x=document.createElement("canvas");x.id="brushOverlayCanvas",x.width=W.naturalWidth,x.height=W.naturalHeight,x.style.cssText="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100;",Y.appendChild(x),V=x,X=x.getContext("2d")}function C(){V&&V.parentNode&&V.parentNode.removeChild(V),V=null,X=null}function w(h){if(!X||!h)return;const Y=A.value.fill,W=r.value/2/(h.scale||1);X.beginPath(),X.arc(h.x,h.y,W,0,Math.PI*2),X.fillStyle=Y,X.fill()}async function m(h,Y){if(!h.originalDataURL)return;let W;return h.cleanImageData?W="data:image/png;base64,"+h.cleanImageData:W=h.originalDataURL,new Promise(x=>{const _=new Image,d=new Image;let M=0;const ae=()=>{if(M++,M<2)return;const L=document.createElement("canvas");L.width=_.naturalWidth,L.height=_.naturalHeight;const j=L.getContext("2d");if(!j){x();return}j.drawImage(_,0,0);const le=document.createElement("canvas");le.width=L.width,le.height=L.height;const U=le.getContext("2d");if(!U){x();return}U.fillStyle="white";for(const ce of Y.path)U.beginPath(),U.arc(ce.x,ce.y,Y.radius,0,Math.PI*2),U.fill();j.globalCompositeOperation="destination-out",j.drawImage(le,0,0),j.globalCompositeOperation="destination-over",j.drawImage(d,0,0),j.globalCompositeOperation="source-over";const Z=L.toDataURL("image/png").split(",")[1];c.updateCurrentImage({cleanImageData:Z}),console.log("还原笔刷区域完成"),x()};_.onload=ae,_.onerror=()=>x(),d.onload=ae,d.onerror=()=>x(),_.src=W,d.src=h.originalDataURL})}async function g(h,Y){const W=n?.getCurrentRepairSettings?.()||{inpaintMethod:"solid",fillColor:"#FFFFFF"},x=W.inpaintMethod;x==="lama_mpe"||x==="litelama"?await k(h,Y,x):await $(h,Y,W.fillColor)}async function k(h,Y,W="lama_mpe"){let x,_;if(h.cleanImageData)x=h.cleanImageData,_="data:image/png;base64,"+h.cleanImageData;else if(h.originalDataURL)x=h.originalDataURL.split(",")[1],_=h.originalDataURL;else{console.error("无法获取基础图像用于 LAMA 修复");return}return new Promise(d=>{const M=new Image;M.onload=async()=>{const ae=M.naturalWidth,L=M.naturalHeight,j=document.createElement("canvas");j.width=ae,j.height=L;const le=j.getContext("2d");if(!le){console.error("无法创建掩膜画布上下文"),d();return}le.fillStyle="black",le.fillRect(0,0,ae,L),le.fillStyle="white";for(const _e of Y.path)le.beginPath(),le.arc(_e.x,_e.y,Y.radius,0,Math.PI*2),le.fill();const Z=j.toDataURL("image/png").split(",")[1],ce=[Y.x1,Y.y1,Y.x2,Y.y2],Te=W==="litelama"?"litelama":"lama_mpe";try{be("LAMA 修复中...","info");const _e=await dn(x,ce,{method:"lama",lamaModel:Te,maskData:Z});if(_e.success&&_e.inpainted_image)c.updateCurrentImage({cleanImageData:_e.inpainted_image}),console.log("修复笔刷区域完成（LAMA 修复，精确掩膜）"),be("LAMA 修复完成","success");else throw new Error(_e.error||"LAMA 修复返回无效数据")}catch(_e){console.error("LAMA 修复失败，回退到纯色填充:",_e),be("LAMA 修复失败，使用纯色填充","warning");const Ae=n?.getCurrentRepairSettings?.();await $(h,Y,Ae?.fillColor)}d()},M.onerror=()=>{console.error("加载图像失败，无法进行 LAMA 修复"),d()},M.src=_})}async function $(h,Y,W){const x=W||u.settings.textStyle.fillColor||"#FFFFFF";let _;if(h.cleanImageData)_="data:image/png;base64,"+h.cleanImageData;else if(h.originalDataURL)_=h.originalDataURL;else return;return new Promise(d=>{const M=new Image;M.onload=()=>{const ae=document.createElement("canvas");ae.width=M.naturalWidth,ae.height=M.naturalHeight;const L=ae.getContext("2d");if(!L){d();return}L.drawImage(M,0,0),L.fillStyle=x;for(const le of Y.path)L.beginPath(),L.arc(le.x,le.y,Y.radius,0,Math.PI*2),L.fill();const j=ae.toDataURL("image/png").split(",")[1];c.updateCurrentImage({cleanImageData:j}),console.log("修复笔刷区域完成（纯色填充）"),d()},M.onerror=()=>d(),M.src=_})}async function b(){const h=c.currentImage;if(!h)return console.warn("ensureCleanBackground: 没有当前图片"),!1;if(h.cleanImageData)return console.log("ensureCleanBackground: 已有干净背景"),!0;const Y=n?.getCurrentRepairSettings?.();if((Y?.inpaintMethod||u.settings.textStyle.inpaintMethod)!=="solid")return console.log("ensureCleanBackground: 非纯色填充模式，跳过"),!1;if(!h.bubbleStates||h.bubbleStates.length===0)return console.warn("ensureCleanBackground: 没有气泡数据"),!1;if(!h.translatedDataURL&&!h.originalDataURL)return console.warn("ensureCleanBackground: 没有图片数据"),!1;console.log("ensureCleanBackground: 尝试为纯色填充模式创建临时干净背景");const x=h.translatedDataURL||h.originalDataURL,_=Y?.fillColor||u.settings.textStyle.fillColor||"#FFFFFF";return new Promise(d=>{const M=new Image;M.onload=()=>{try{const ae=document.createElement("canvas");ae.width=M.naturalWidth,ae.height=M.naturalHeight;const L=ae.getContext("2d");if(!L){console.error("ensureCleanBackground: 无法获取 Canvas 上下文"),d(!1);return}L.drawImage(M,0,0),L.fillStyle=_;for(const le of h.bubbleStates){const[U,Z,ce,Te]=le.coords;L.fillRect(U,Z,ce-U+1,Te-Z+1)}const j=ae.toDataURL("image/png").split(",")[1];c.updateCurrentImage({cleanImageData:j}),console.log("ensureCleanBackground: 成功创建临时干净背景（纯色填充）"),d(!0)}catch(ae){console.error("ensureCleanBackground: Canvas 操作失败:",ae),d(!1)}},M.onerror=()=>{console.error("ensureCleanBackground: 加载图像失败"),d(!1)},M.src=x})}return Tt(()=>{D()}),{brushMode:t,brushSize:r,isBrushKeyDown:a,isBrushPainting:o,mouseX:y,mouseY:P,isActive:J,brushColor:A,BRUSH_MIN_SIZE:Fn,BRUSH_MAX_SIZE:An,enterBrushMode:f,exitBrushMode:D,toggleBrushMode:B,setBrushSize:F,adjustBrushSize:i,handleBrushWheel:l,startBrushPainting:v,continueBrushPainting:p,finishBrushPainting:R,getBrushPositionInImage:E,getBrushPathBounds:N,ensureCleanBackground:b}}function Yd(n){return[Math.round(n[0]),Math.round(n[1]),Math.round(n[2]),Math.round(n[3])]}function Jd(n){const c=dt(),u=Qe(),t=Ke(),{bubbles:r,selectedIndex:a,hasSelection:o}=yt(c),{currentImage:s}=yt(u),y=S(!1),P=S(!1),T=S(null),V=S(0),X=S(0),J=S(!1);function A(L){c.selectBubble(L)}function f(L){c.toggleMultiSelect(L)}function D(){c.clearMultiSelect()}function B(L,j){console.log(`开始拖动气泡 #${L+1}`)}function F(L,j){}function i(L,j){c.updateBubble(L,{coords:j}),console.log(`气泡 #${L+1} 拖动完成:`,j),W()}function l(L,j,le){console.log(`开始调整气泡 #${L+1} 大小，手柄: ${j}`)}function v(L){}function p(L,j){c.updateBubble(L,{coords:j}),console.log(`气泡 #${L+1} 调整大小完成:`,j),W()}function R(L,j){console.log(`开始旋转气泡 #${L+1}`)}function E(L){}function N(L,j){c.updateBubble(L,{rotationAngle:j}),console.log(`气泡 #${L+1} 旋转完成: ${j}°`),W()}function O(){y.value=!y.value,y.value?console.log("进入绘制模式"):console.log("退出绘制模式")}function C(L){c.addBubble(L),c.selectBubble(c.bubbleCount-1),console.log("已添加新气泡:",L),n?.onReRender?.()}function w(L,j){P.value=!0,V.value=L,X.value=j,T.value=[L,j,L,j]}function m(L,j){P.value&&(T.value=[V.value,X.value,L,j])}function g(){if(!P.value||!T.value)return P.value=!1,T.value=null,null;const[L,j,le,U]=T.value,Z=10;if(Math.abs(le-L)<Z||Math.abs(U-j)<Z)return P.value=!1,T.value=null,null;const ce=[Math.min(L,le),Math.min(j,U),Math.max(L,le),Math.max(j,U)];return P.value=!1,T.value=null,ce}function k(){P.value=!1,T.value=null,y.value=!1}function $(){if(!T.value)return{};const[L,j,le,U]=T.value;return{position:"absolute",left:`${Math.min(L,le)}px`,top:`${Math.min(j,U)}px`,width:`${Math.abs(le-L)}px`,height:`${Math.abs(U-j)}px`,border:"2px dashed #00d4ff",background:"rgba(0, 212, 255, 0.1)",pointerEvents:"none",zIndex:"25",boxSizing:"border-box"}}let b=null,h=!1;const Y=150;function W(){b&&clearTimeout(b),b=setTimeout(async()=>{if(h){console.log("跳过渲染，上一次渲染仍在进行中");return}console.log("触发延迟渲染预览"),h=!0;try{n?.onDelayedPreview?await n.onDelayedPreview():n?.onReRender&&await n.onReRender()}catch(L){console.error("延迟渲染预览失败:",L)}finally{h=!1}},Y)}function x(L){c.updateSelectedBubble(L),W()}function _(){o.value&&(c.deleteSelected(),console.log("已删除选中的气泡"),n?.onReRender?.())}async function d(){const L=a.value;if(L<0){console.warn("请先选中要修复的气泡框");return}const j=r.value[L],le=s.value;if(!j||!le?.originalDataURL){console.warn("无法修复背景：缺少气泡或图片数据");return}const U=j.inpaintMethod||"solid",Z=j.fillColor||"#FFFFFF",ce=j.rotationAngle||0;try{console.log(`开始修复气泡 #${L+1} 背景，方法: ${U}`);let Te;if(le.cleanImageData)Te=le.cleanImageData;else{const Ae=le.originalDataURL.match(/^data:image\/[^;]+;base64,(.+)$/);if(Te=Ae&&Ae[1]?Ae[1]:"",!Te){console.error("无法解析图像数据");return}}if(U==="lama_mpe"||U==="litelama"){const Ae=U==="litelama"?"litelama":"lama_mpe",Re=Yd(j.coords),Me=await dn(Te,Re,{bubbleAngle:ce,method:"lama",lamaModel:Ae});Me.success&&Me.inpainted_image?(u.updateCurrentImage({cleanImageData:Me.inpainted_image}),console.log(`气泡 #${L+1} LAMA背景修复成功`),W()):(console.error("LAMA修复失败:",Me.error||"未知错误"),await M(j.coords,Z,ce),W())}else await M(j.coords,Z,ce),console.log(`气泡 #${L+1} 纯色填充修复成功`),W()}catch(Te){console.error("背景修复出错:",Te)}}async function M(L,j,le=0){const U=s.value;if(!U)return;const[Z,ce,Te,_e]=L;let Ae;if(U.cleanImageData)Ae="data:image/png;base64,"+U.cleanImageData;else if(U.originalDataURL)Ae=U.originalDataURL;else{console.error("无法找到基础图像用于填充");return}return new Promise(Re=>{const Me=new Image;Me.onload=()=>{const z=document.createElement("canvas");z.width=Me.naturalWidth,z.height=Me.naturalHeight;const I=z.getContext("2d");if(!I){Re();return}if(I.drawImage(Me,0,0),I.fillStyle=j,Math.abs(le)<.1)I.fillRect(Z,ce,Te-Z,_e-ce);else{const Q=(Z+Te)/2,ne=(ce+_e)/2,ge=(Te-Z)/2,he=(_e-ce)/2,xe=le*Math.PI/180,ve=Math.cos(xe),pe=Math.sin(xe),$e=[[-ge,-he],[ge,-he],[ge,he],[-ge,he]].map(([Fe,Ie])=>[Q+Fe*ve-Ie*pe,ne+Fe*pe+Ie*ve]);I.beginPath();const ke=$e[0];if(ke){I.moveTo(ke[0],ke[1]);for(let Fe=1;Fe<$e.length;Fe++){const Ie=$e[Fe];Ie&&I.lineTo(Ie[0],Ie[1])}}I.closePath(),I.fill()}const ee=z.toDataURL("image/png").split(",")[1];u.updateCurrentImage({cleanImageData:ee}),console.log("已对气泡区域进行纯色填充:",L,j,"角度:",le),Re()},Me.onerror=()=>{console.error("加载基础图像失败"),Re()},Me.src=Ae})}async function ae(L){const j=r.value[L],le=s.value;if(!j||!le?.originalDataURL){console.warn("无法进行 OCR 识别：缺少气泡或图片数据");return}try{console.log(`开始 OCR 识别气泡 #${L+1}`);const U=le.originalDataURL.split(",")[1]||"",Z=t.settings,ce=await Zn(U,j.coords,Z.ocrEngine||"manga_ocr",{source_language:Z.sourceLanguage,baidu_ocr_api_key:Z.baiduOcr.apiKey,baidu_ocr_secret_key:Z.baiduOcr.secretKey,baidu_version:Z.baiduOcr.version,baidu_source_language:Z.baiduOcr.sourceLanguage,ai_vision_provider:Z.aiVisionOcr.provider,ai_vision_api_key:Z.aiVisionOcr.apiKey,ai_vision_model_name:Z.aiVisionOcr.modelName,ai_vision_ocr_prompt:Z.aiVisionOcr.prompt,custom_ai_vision_base_url:Z.aiVisionOcr.customBaseUrl});ce.success&&ce.text!==void 0?(c.updateBubble(L,{originalText:ce.text}),console.log(`OCR 识别成功: "${ce.text}"`)):console.error("OCR 识别失败:",ce.error||"未知错误")}catch(U){console.error("OCR 识别出错:",U)}}return{isDrawingMode:y,isDrawingBox:P,currentDrawingRect:T,isMiddleButtonDown:J,handleBubbleSelect:A,handleBubbleMultiSelect:f,handleClearMultiSelect:D,handleBubbleDragStart:B,handleBubbleDragging:F,handleBubbleDragEnd:i,handleBubbleResizeStart:l,handleBubbleResizing:v,handleBubbleResizeEnd:p,handleBubbleRotateStart:R,handleBubbleRotating:E,handleBubbleRotateEnd:N,toggleDrawingMode:O,handleDrawBubble:C,startDrawingBox:w,updateDrawingBox:m,finishDrawingBox:g,cancelDrawing:k,getDrawingRectStyle:$,handleBubbleUpdate:x,deleteSelectedBubbles:_,repairSelectedBubble:d,triggerDelayedPreview:W,handleOcrRecognize:ae}}function Xd(n){const c=dt(),u=Qe(),{bubbles:t}=yt(c),{currentImage:r}=yt(u),a=S(!1),o=S("");let s=null;function y(){const V=r.value;if(!V)return null;if(V.cleanImageData)return V.cleanImageData;if(V.originalDataURL){const X=V.originalDataURL.match(/^data:image\/[^;]+;base64,(.+)$/);if(X&&X[1])return X[1]}return null}async function P(V=!1){if(!r.value)return console.warn("reRenderFullImage: 没有当前图片"),!1;if(t.value.length===0){console.log("reRenderFullImage: 没有气泡，跳过后端渲染");const f=y();if(f){const D=`data:image/png;base64,${f}`;u.updateCurrentImage({translatedDataURL:D}),V||n?.onRenderSuccess?.(D)}return!0}const J=y();if(!J)return console.error("reRenderFullImage: 缺少图像数据"),o.value="缺少图像数据",V||n?.onRenderError?.("缺少图像数据"),!1;const A=Symbol("render");s=A,a.value=!0,o.value="",V||n?.onRenderStart?.();try{console.log("reRenderFullImage: 开始重新渲染，气泡数量:",t.value.length);const f=t.value,D=f.map(l=>l.translatedText||""),B=f.map(l=>l.coords.map(v=>Math.round(v))),F=f.map(l=>({translatedText:l.translatedText||"",coords:l.coords,fontSize:Number(l.fontSize)||24,fontFamily:l.fontFamily||"fonts/STSONG.TTF",textDirection:kt(l),textColor:l.textColor||"#231816",rotationAngle:Math.round(Number(l.rotationAngle)||0),position:l.position?{x:Math.round(l.position.x||0),y:Math.round(l.position.y||0)}:{x:0,y:0},strokeEnabled:l.strokeEnabled!==void 0?l.strokeEnabled:!0,strokeColor:l.strokeColor||"#FFFFFF",strokeWidth:Number(l.strokeWidth)||3})),i=await un({clean_image:J,bubble_texts:D,bubble_coords:B,bubble_states:F,fontSize:Number(f[0]?.fontSize)||24,fontFamily:f[0]?.fontFamily||"fonts/STSONG.TTF",textDirection:f[0]?kt(f[0]):"vertical",textColor:f[0]?.textColor||"#231816",strokeEnabled:f[0]?.strokeEnabled!==void 0?f[0].strokeEnabled:!0,strokeColor:f[0]?.strokeColor||"#FFFFFF",strokeWidth:Number(f[0]?.strokeWidth)||3,use_individual_styles:!0,use_inpainting:!1,use_lama:!1,is_font_style_change:!0});if(s!==A)return console.log("reRenderFullImage: 渲染结果已过期，忽略"),!1;if(i.rendered_image){const l=`data:image/png;base64,${i.rendered_image}`;return u.updateCurrentImage({translatedDataURL:l}),console.log("reRenderFullImage: 渲染成功"),V||n?.onRenderSuccess?.(l),!0}else{const l=i.error||"渲染失败";return console.error("reRenderFullImage: 渲染失败 -",l),o.value=l,V||n?.onRenderError?.(l),!1}}catch(f){if(s!==A)return!1;const D=f instanceof Error?f.message:"渲染请求失败";return console.error("reRenderFullImage: 渲染出错 -",f),o.value=D,V||n?.onRenderError?.(D),!1}finally{s===A&&(a.value=!1,V||n?.onRenderEnd?.())}}function T(){s=null,a.value=!1}return{isRendering:a,renderError:o,reRenderFullImage:P,cancelRender:T}}const jd=["data-index","data-coords","data-rotation","onClick","onMousedown"],Gd={class:"bubble-index"},Zd=["data-parent-index","onMousedown"],Qd=["data-parent-index","onMousedown"],eg=["data-parent-index","onMousedown"],tg=["data-parent-index","onMousedown"],ng=["data-parent-index","onMousedown"],og=["data-parent-index","onMousedown"],ag=["data-parent-index","onMousedown"],sg=["data-parent-index","onMousedown"],lg=["data-parent-index","onMousedown"],ig=He({__name:"BubbleOverlay",props:{bubbles:{},selectedIndex:{},selectedIndices:{},scale:{},isDrawingMode:{type:Boolean},isBrushMode:{type:Boolean},imageWidth:{},imageHeight:{}},emits:["select","multiSelect","dragStart","dragging","dragEnd","resizeStart","resizing","resizeEnd","rotateStart","rotating","rotateEnd","drawBubble"],setup(n,{emit:c}){const u=dt(),{isDragging:t,draggingIndex:r,dragOffsetX:a,dragOffsetY:o,dragInitialX:s,dragInitialY:y,isResizing:P,resizingIndex:T,resizeCurrentCoords:V,isRotating:X,rotatingIndex:J,rotateCurrentAngle:A}=yt(u),f=n,D=c,B=S(null),F=S(0),i=S(0),l=S(""),v=S(0),p=S(0),R=S(null),E=S(0),N=S(0),O=S(0),C=S(0),w=S(!1),m=S(0),g=S(0),k=S(null),$=S(!1);function b(z,I){let ee,Q,ne,ge,he=z.rotationAngle||0;if(t.value&&r.value===I){const[$e,ke,Fe,Ie]=z.coords;ee=s.value+a.value,Q=y.value+o.value,ne=ee+(Fe-$e),ge=Q+(Ie-ke)}else P.value&&T.value===I&&V.value?[ee,Q,ne,ge]=V.value:X.value&&J.value===I?([ee,Q,ne,ge]=z.coords,he=A.value):[ee,Q,ne,ge]=z.coords;const xe=ne-ee,ve=ge-Q,pe={left:`${ee}px`,top:`${Q}px`,width:`${xe}px`,height:`${ve}px`};return he&&(pe.transformOrigin="center center",pe.transform=`rotate(${he}deg)`),pe}function h(){if(!k.value)return{};const[z,I,ee,Q]=k.value;return{left:`${Math.min(z,ee)}px`,top:`${Math.min(I,Q)}px`,width:`${Math.abs(ee-z)}px`,height:`${Math.abs(Q-I)}px`}}function Y(z){if(!B.value)return null;const I=B.value.getBoundingClientRect(),ee=f.scale||1,Q=(z.clientX-I.left)/ee,ne=(z.clientY-I.top)/ee;return{x:Q,y:ne}}function W(z,I){f.isBrushMode||I.shiftKey||D("select",z)}function x(z){if(!f.isBrushMode){if(z.button===1){z.preventDefault(),$.value=!0,document.body.classList.add("middle-button-drawing"),Te(z);return}z.button===0&&f.isDrawingMode&&Te(z)}}function _(z,I){if(!f.isBrushMode&&I.button===0){if(I.preventDefault(),I.stopPropagation(),I.shiftKey){D("multiSelect",z);return}if(z!==f.selectedIndex){D("select",z);return}d(z,I)}}function d(z,I){document.removeEventListener("mousemove",Re),document.removeEventListener("mouseup",Me),t.value=!0,r.value=z,F.value=I.clientX,i.value=I.clientY,a.value=0,o.value=0;const ee=f.bubbles[z];ee&&(s.value=ee.coords[0],y.value=ee.coords[1]),D("dragStart",z,I),document.addEventListener("mousemove",Re),document.addEventListener("mouseup",Me)}function M(z){const I=f.scale||1,ee=(z.clientX-F.value)/I,Q=(z.clientY-i.value)/I;a.value=ee,o.value=Q}function ae(z){const I=r.value;t.value=!1,r.value=-1,a.value=0,o.value=0;const ee=f.scale||1,Q=(z.clientX-F.value)/ee,ne=(z.clientY-i.value)/ee,ge=f.bubbles[I];if(!ge)return;const[he,xe,ve,pe]=ge.coords,$e=ve-he,ke=pe-xe;let Fe=Math.round(s.value+Q),Ie=Math.round(y.value+ne);const je=f.imageWidth||2e3,Se=f.imageHeight||2e3,nt=Math.min($e,je),lt=Math.min(ke,Se);Fe=Math.max(0,Math.min(Fe,je-nt)),Ie=Math.max(0,Math.min(Ie,Se-lt));const Be=[Fe,Ie,Fe+nt,Ie+lt];D("dragEnd",I,Be)}function L(z,I,ee){if(f.isBrushMode||ee.button!==0)return;ee.preventDefault(),ee.stopPropagation(),document.removeEventListener("mousemove",Re),document.removeEventListener("mouseup",Me),P.value=!0,T.value=I,l.value=z,v.value=ee.clientX,p.value=ee.clientY;const Q=f.bubbles[I];Q&&(R.value=[...Q.coords],V.value=[...Q.coords]),D("resizeStart",I,z,ee),document.addEventListener("mousemove",Re),document.addEventListener("mouseup",Me)}function j(z){if(!R.value)return;const I=f.scale||1,ee=(z.clientX-v.value)/I,Q=(z.clientY-p.value)/I;let[ne,ge,he,xe]=R.value;const ve=l.value;ve.includes("w")&&(ne+=ee),ve.includes("e")&&(he+=ee),ve.includes("n")&&(ge+=Q),ve.includes("s")&&(xe+=Q),ne>he&&([ne,he]=[he,ne]),ge>xe&&([ge,xe]=[xe,ge]);const pe=10;he-ne<pe||xe-ge<pe||(V.value=[ne,ge,he,xe])}function le(z){if(!R.value)return;const I=f.scale||1,ee=(z.clientX-v.value)/I,Q=(z.clientY-p.value)/I;let[ne,ge,he,xe]=R.value;const ve=l.value;ve.includes("w")&&(ne+=ee),ve.includes("e")&&(he+=ee),ve.includes("n")&&(ge+=Q),ve.includes("s")&&(xe+=Q),ne>he&&([ne,he]=[he,ne]),ge>xe&&([ge,xe]=[xe,ge]);const pe=f.imageWidth||2e3,$e=f.imageHeight||2e3;ne=Math.max(0,Math.round(ne)),ge=Math.max(0,Math.round(ge)),he=Math.min(pe,Math.round(he)),xe=Math.min($e,Math.round(xe));const ke=10;if(he-ne<ke||xe-ge<ke){console.warn("调整后尺寸过小，已撤销"),P.value=!1,T.value=-1,R.value=null;return}D("resizeEnd",T.value,[ne,ge,he,xe]),P.value=!1,T.value=-1,R.value=null,V.value=null}function U(z,I){if(f.isBrushMode||I.button!==0)return;I.preventDefault(),I.stopPropagation(),document.removeEventListener("mousemove",Re),document.removeEventListener("mouseup",Me),X.value=!0,J.value=z;const ee=f.bubbles[z];if(!ee||!B.value)return;const[Q,ne,ge,he]=ee.coords,xe=f.scale||1,ve=B.value.getBoundingClientRect();O.value=ve.left+(Q+ge)/2*xe,C.value=ve.top+(ne+he)/2*xe;const pe=I.clientX-O.value,$e=I.clientY-C.value;E.value=Math.atan2($e,pe)*180/Math.PI,N.value=ee.rotationAngle||0,A.value=ee.rotationAngle||0,D("rotateStart",z,I),document.body.classList.add("rotating-box"),document.addEventListener("mousemove",Re),document.addEventListener("mouseup",Me),console.log(`开始旋转气泡 #${z+1}，初始角度: ${N.value}°`)}function Z(z){const I=z.clientX-O.value,ee=z.clientY-C.value,ne=Math.atan2(ee,I)*180/Math.PI-E.value;let ge=N.value+ne;for(;ge>180;)ge-=360;for(;ge<-180;)ge+=360;z.shiftKey&&(ge=Math.round(ge/15)*15),A.value=ge}function ce(z){document.body.classList.remove("rotating-box");const I=J.value,ee=A.value;D("rotateEnd",I,ee),X.value=!1,J.value=-1,console.log(`气泡 #${I+1} 旋转完成，角度: ${ee}°`)}function Te(z){const I=Y(z);if(!I)return;const ee=f.imageWidth||2e3,Q=f.imageHeight||2e3;I.x<0||I.x>ee||I.y<0||I.y>Q||(w.value=!0,m.value=I.x,g.value=I.y,k.value=[I.x,I.y,I.x,I.y],document.addEventListener("mousemove",Re),document.addEventListener("mouseup",Me),console.log("开始绘制新框:",I.x.toFixed(1),I.y.toFixed(1)))}function _e(z){const I=Y(z);!I||!k.value||(k.value=[m.value,g.value,I.x,I.y])}function Ae(z){const I=Y(z);if($.value&&($.value=!1,document.body.classList.remove("middle-button-drawing")),!I||!k.value){w.value=!1,k.value=null;return}const ee=f.imageWidth||2e3,Q=f.imageHeight||2e3,ne=Math.max(0,Math.round(Math.min(m.value,I.x))),ge=Math.max(0,Math.round(Math.min(g.value,I.y))),he=Math.min(ee,Math.round(Math.max(m.value,I.x))),xe=Math.min(Q,Math.round(Math.max(g.value,I.y))),ve=10;if(he-ne<ve||xe-ge<ve){console.log("绘制的框太小，已忽略"),w.value=!1,k.value=null;return}console.log("完成绘制新框:",[ne,ge,he,xe]),D("drawBubble",[ne,ge,he,xe]),w.value=!1,k.value=null}function Re(z){t.value?M(z):P.value?j(z):X.value?Z(z):w.value&&_e(z)}function Me(z){document.removeEventListener("mousemove",Re),document.removeEventListener("mouseup",Me),(z.button===1||$.value)&&($.value=!1,document.body.classList.remove("middle-button-drawing")),t.value?ae(z):P.value?le(z):X.value?ce():w.value&&Ae(z)}return ut(()=>{}),Tt(()=>{document.removeEventListener("mousemove",Re),document.removeEventListener("mouseup",Me),document.body.classList.remove("middle-button-drawing"),document.body.classList.remove("rotating-box")}),(z,I)=>(K(),G("div",{class:De(["bubble-overlay",{"brush-mode":n.isBrushMode}]),ref_key:"overlayRef",ref:B,onMousedown:x},[(K(!0),G(Xe,null,Ge(n.bubbles,(ee,Q)=>(K(),G("div",{key:Q,class:De(["bubble-highlight-box",{selected:Q===n.selectedIndex,"multi-selected":n.selectedIndices.length>1&&n.selectedIndices.includes(Q)&&Q!==n.selectedIndex}]),style:st(b(ee,Q)),"data-index":Q,"data-coords":JSON.stringify(ee.coords),"data-rotation":ee.rotationAngle||0,onClick:tt(ne=>W(Q,ne),["stop"]),onMousedown:tt(ne=>_(Q,ne),["stop"])},[e("span",Gd,ue(Q+1),1),Q===n.selectedIndex?(K(),G(Xe,{key:0},[e("div",{class:"resize-handle nw","data-handle":"nw","data-parent-index":Q,onMousedown:tt(ne=>L("nw",Q,ne),["stop"])},null,40,Zd),e("div",{class:"resize-handle n","data-handle":"n","data-parent-index":Q,onMousedown:tt(ne=>L("n",Q,ne),["stop"])},null,40,Qd),e("div",{class:"resize-handle ne","data-handle":"ne","data-parent-index":Q,onMousedown:tt(ne=>L("ne",Q,ne),["stop"])},null,40,eg),e("div",{class:"resize-handle e","data-handle":"e","data-parent-index":Q,onMousedown:tt(ne=>L("e",Q,ne),["stop"])},null,40,tg),e("div",{class:"resize-handle se","data-handle":"se","data-parent-index":Q,onMousedown:tt(ne=>L("se",Q,ne),["stop"])},null,40,ng),e("div",{class:"resize-handle s","data-handle":"s","data-parent-index":Q,onMousedown:tt(ne=>L("s",Q,ne),["stop"])},null,40,og),e("div",{class:"resize-handle sw","data-handle":"sw","data-parent-index":Q,onMousedown:tt(ne=>L("sw",Q,ne),["stop"])},null,40,ag),e("div",{class:"resize-handle w","data-handle":"w","data-parent-index":Q,onMousedown:tt(ne=>L("w",Q,ne),["stop"])},null,40,sg),I[0]||(I[0]=e("div",{class:"rotate-line"},null,-1)),e("div",{class:"rotate-handle",title:"拖拽旋转","data-parent-index":Q,onMousedown:tt(ne=>U(Q,ne),["stop"])},null,40,lg)],64)):fe("",!0)],46,jd))),128)),k.value?(K(),G("div",{key:0,class:"drawing-rect",style:st(h())},null,4)):fe("",!0)],34))}}),Hn=qe(ig,[["__scopeId","data-v-a3e510ac"]]),rg={key:0,class:"kana-keyboard"},ug={class:"kana-keyboard-header"},cg={class:"kana-keyboard-tabs"},dg=["onClick"],gg={class:"kana-keyboard-options"},pg={class:"kana-mode-select"},bg={class:"kana-target-select"},vg={class:"kana-table"},mg={class:"row-label"},fg=["onClick"],hg={class:"kana-hiragana"},yg={class:"kana-katakana"},xg={class:"kana-table"},Sg={class:"row-label"},kg=["onClick"],_g={class:"kana-hiragana"},Cg={class:"kana-katakana"},wg={class:"kana-table combo-table"},$g={class:"row-label"},Tg=["onClick"],Ig={class:"kana-hiragana"},Dg={class:"kana-katakana"},Rg={class:"special-chars-grid"},Mg=["onClick"],Bg={key:0,class:"char-label"},Eg=He({__name:"JapaneseKeyboard",props:{visible:{type:Boolean,default:!1},defaultTarget:{default:"original"}},emits:["close","insert","delete"],setup(n,{emit:c}){const u=n,t=c,r=S("basic"),a=S("hiragana"),o=S(u.defaultTarget),s=S(null),y=[{label:"原文",value:"original"},{label:"译文",value:"translated"}],P=[{id:"basic",label:"基本"},{id:"dakuten",label:"浊/半浊音"},{id:"combo",label:"拗音"},{id:"special",label:"特殊"}],T=[{label:"あ行",chars:[{h:"あ",k:"ア"},{h:"い",k:"イ"},{h:"う",k:"ウ"},{h:"え",k:"エ"},{h:"お",k:"オ"}]},{label:"か行",chars:[{h:"か",k:"カ"},{h:"き",k:"キ"},{h:"く",k:"ク"},{h:"け",k:"ケ"},{h:"こ",k:"コ"}]},{label:"さ行",chars:[{h:"さ",k:"サ"},{h:"し",k:"シ"},{h:"す",k:"ス"},{h:"せ",k:"セ"},{h:"そ",k:"ソ"}]},{label:"た行",chars:[{h:"た",k:"タ"},{h:"ち",k:"チ"},{h:"つ",k:"ツ"},{h:"て",k:"テ"},{h:"と",k:"ト"}]},{label:"な行",chars:[{h:"な",k:"ナ"},{h:"に",k:"ニ"},{h:"ぬ",k:"ヌ"},{h:"ね",k:"ネ"},{h:"の",k:"ノ"}]},{label:"は行",chars:[{h:"は",k:"ハ"},{h:"ひ",k:"ヒ"},{h:"ふ",k:"フ"},{h:"へ",k:"ヘ"},{h:"ほ",k:"ホ"}]},{label:"ま行",chars:[{h:"ま",k:"マ"},{h:"み",k:"ミ"},{h:"む",k:"ム"},{h:"め",k:"メ"},{h:"も",k:"モ"}]},{label:"や行",chars:[{h:"や",k:"ヤ"},null,{h:"ゆ",k:"ユ"},null,{h:"よ",k:"ヨ"}]},{label:"ら行",chars:[{h:"ら",k:"ラ"},{h:"り",k:"リ"},{h:"る",k:"ル"},{h:"れ",k:"レ"},{h:"ろ",k:"ロ"}]},{label:"わ行",chars:[{h:"わ",k:"ワ"},null,null,null,{h:"を",k:"ヲ"}]},{label:"ん",chars:[{h:"ん",k:"ン"},null,null,null,null]}],V=[{label:"が行",chars:[{h:"が",k:"ガ"},{h:"ぎ",k:"ギ"},{h:"ぐ",k:"グ"},{h:"げ",k:"ゲ"},{h:"ご",k:"ゴ"}]},{label:"ざ行",chars:[{h:"ざ",k:"ザ"},{h:"じ",k:"ジ"},{h:"ず",k:"ズ"},{h:"ぜ",k:"ゼ"},{h:"ぞ",k:"ゾ"}]},{label:"だ行",chars:[{h:"だ",k:"ダ"},{h:"ぢ",k:"ヂ"},{h:"づ",k:"ヅ"},{h:"で",k:"デ"},{h:"ど",k:"ド"}]},{label:"ば行",chars:[{h:"ば",k:"バ"},{h:"び",k:"ビ"},{h:"ぶ",k:"ブ"},{h:"べ",k:"ベ"},{h:"ぼ",k:"ボ"}]},{label:"ぱ行",chars:[{h:"ぱ",k:"パ"},{h:"ぴ",k:"ピ"},{h:"ぷ",k:"プ"},{h:"ぺ",k:"ペ"},{h:"ぽ",k:"ポ"}]}],X=[{label:"きゃ行",chars:[{h:"きゃ",k:"キャ"},{h:"きゅ",k:"キュ"},{h:"きょ",k:"キョ"}]},{label:"しゃ行",chars:[{h:"しゃ",k:"シャ"},{h:"しゅ",k:"シュ"},{h:"しょ",k:"ショ"}]},{label:"ちゃ行",chars:[{h:"ちゃ",k:"チャ"},{h:"ちゅ",k:"チュ"},{h:"ちょ",k:"チョ"}]},{label:"にゃ行",chars:[{h:"にゃ",k:"ニャ"},{h:"にゅ",k:"ニュ"},{h:"にょ",k:"ニョ"}]},{label:"ひゃ行",chars:[{h:"ひゃ",k:"ヒャ"},{h:"ひゅ",k:"ヒュ"},{h:"ひょ",k:"ヒョ"}]},{label:"みゃ行",chars:[{h:"みゃ",k:"ミャ"},{h:"みゅ",k:"ミュ"},{h:"みょ",k:"ミョ"}]},{label:"りゃ行",chars:[{h:"りゃ",k:"リャ"},{h:"りゅ",k:"リュ"},{h:"りょ",k:"リョ"}]},{label:"ぎゃ行",chars:[{h:"ぎゃ",k:"ギャ"},{h:"ぎゅ",k:"ギュ"},{h:"ぎょ",k:"ギョ"}]},{label:"じゃ行",chars:[{h:"じゃ",k:"ジャ"},{h:"じゅ",k:"ジュ"},{h:"じょ",k:"ジョ"}]},{label:"びゃ行",chars:[{h:"びゃ",k:"ビャ"},{h:"びゅ",k:"ビュ"},{h:"びょ",k:"ビョ"}]},{label:"ぴゃ行",chars:[{h:"ぴゃ",k:"ピャ"},{h:"ぴゅ",k:"ピュ"},{h:"ぴょ",k:"ピョ"}]}],J=[{char:"っ",label:"促音"},{char:"ッ",label:"促音"},{char:"ー",label:"长音"},{char:"〜",label:"波浪"},{char:"。",label:"句号"},{char:"、",label:"顿号"},{char:"「",label:"引号"},{char:"」",label:"引号"},{char:"『",label:"双引"},{char:"』",label:"双引"},{char:"…",label:"省略"},{char:"・",label:"中点"},{char:"！",label:"感叹"},{char:"？",label:"问号"},{char:"♪",label:"音符"},{char:"♡",label:"心形"},{char:"★",label:"星形"},{char:"☆",label:"空星"},{char:"ぁ",label:"小あ"},{char:"ぃ",label:"小い"},{char:"ぅ",label:"小う"},{char:"ぇ",label:"小え"},{char:"ぉ",label:"小お"},{char:"ァ",label:"小ア"},{char:"ィ",label:"小イ"},{char:"ゥ",label:"小ウ"},{char:"ェ",label:"小エ"},{char:"ォ",label:"小オ"},{char:"ゃ",label:"小や"},{char:"ゅ",label:"小ゆ"},{char:"ょ",label:"小よ"},{char:"ャ",label:"小ヤ"},{char:"ュ",label:"小ユ"},{char:"ョ",label:"小ヨ"}];function A(){t("close")}function f(F){const i=a.value==="hiragana"?F.h:F.k;s.value=F.h,setTimeout(()=>{s.value=null},100),t("insert",i,o.value)}function D(F){s.value=F,setTimeout(()=>{s.value=null},100),t("insert",F,o.value)}function B(){t("delete",o.value)}return(F,i)=>n.visible?(K(),G("div",rg,[e("div",ug,[i[3]||(i[3]=e("span",{class:"kana-keyboard-title"},"50音键盘",-1)),e("div",cg,[(K(),G(Xe,null,Ge(P,l=>e("button",{key:l.id,class:De(["kana-tab",{active:r.value===l.id}]),onClick:v=>r.value=l.id},ue(l.label),11,dg)),64))]),e("button",{class:"kana-keyboard-close",onClick:A},"✕")]),e("div",gg,[e("div",pg,[e("label",null,[oe(e("input",{type:"radio",name:"kanaMode",value:"hiragana","onUpdate:modelValue":i[0]||(i[0]=l=>a.value=l)},null,512),[[Vn,a.value]]),i[4]||(i[4]=Ue(" 平假名 ",-1))]),e("label",null,[oe(e("input",{type:"radio",name:"kanaMode",value:"katakana","onUpdate:modelValue":i[1]||(i[1]=l=>a.value=l)},null,512),[[Vn,a.value]]),i[5]||(i[5]=Ue(" 片假名 ",-1))])]),e("div",bg,[i[6]||(i[6]=e("label",null,"输入到：",-1)),me(Oe,{modelValue:o.value,"onUpdate:modelValue":i[2]||(i[2]=l=>o.value=l),options:y},null,8,["modelValue"])])]),e("div",{class:De(["kana-tab-content",{active:r.value==="basic"}])},[e("table",vg,[i[7]||(i[7]=e("thead",null,[e("tr",null,[e("th"),e("th",null,"あ段"),e("th",null,"い段"),e("th",null,"う段"),e("th",null,"え段"),e("th",null,"お段")])],-1)),e("tbody",null,[(K(),G(Xe,null,Ge(T,l=>e("tr",{key:l.label},[e("td",mg,ue(l.label),1),(K(!0),G(Xe,null,Ge(l.chars,(v,p)=>(K(),G("td",{key:p},[v?(K(),G("button",{key:0,class:De(["kana-key",{pressed:s.value===v.h}]),onClick:R=>f(v)},[e("span",hg,ue(v.h),1),e("span",yg,ue(v.k),1)],10,fg)):fe("",!0)]))),128))])),64))])])],2),e("div",{class:De(["kana-tab-content",{active:r.value==="dakuten"}])},[e("table",xg,[i[8]||(i[8]=e("thead",null,[e("tr",null,[e("th"),e("th",null,"あ段"),e("th",null,"い段"),e("th",null,"う段"),e("th",null,"え段"),e("th",null,"お段")])],-1)),e("tbody",null,[(K(),G(Xe,null,Ge(V,l=>e("tr",{key:l.label},[e("td",Sg,ue(l.label),1),(K(!0),G(Xe,null,Ge(l.chars,(v,p)=>(K(),G("td",{key:p},[v?(K(),G("button",{key:0,class:De(["kana-key",{pressed:s.value===v.h}]),onClick:R=>f(v)},[e("span",_g,ue(v.h),1),e("span",Cg,ue(v.k),1)],10,kg)):fe("",!0)]))),128))])),64))])])],2),e("div",{class:De(["kana-tab-content",{active:r.value==="combo"}])},[e("table",wg,[i[9]||(i[9]=e("thead",null,[e("tr",null,[e("th"),e("th",null,"ゃ"),e("th",null,"ゅ"),e("th",null,"ょ")])],-1)),e("tbody",null,[(K(),G(Xe,null,Ge(X,l=>e("tr",{key:l.label},[e("td",$g,ue(l.label),1),(K(!0),G(Xe,null,Ge(l.chars,(v,p)=>(K(),G("td",{key:p},[v?(K(),G("button",{key:0,class:De(["kana-key",{pressed:s.value===v.h}]),onClick:R=>f(v)},[e("span",Ig,ue(v.h),1),e("span",Dg,ue(v.k),1)],10,Tg)):fe("",!0)]))),128))])),64))])])],2),e("div",{class:De(["kana-tab-content",{active:r.value==="special"}])},[e("div",Rg,[(K(),G(Xe,null,Ge(J,l=>e("button",{key:l.char,class:De(["kana-key special-key",{pressed:s.value===l.char}]),onClick:v=>D(l.char)},[Ue(ue(l.char)+" ",1),l.label?(K(),G("span",Bg,ue(l.label),1)):fe("",!0)],10,Mg)),64))])],2),e("div",{class:"kana-keyboard-footer"},[e("button",{class:"kana-backspace",onClick:B},"⌫ 退格")])])):fe("",!0)}}),Pg=qe(Eg,[["__scopeId","data-v-ebfc2125"]]),Ag={class:"edit-panel-content"},Fg={class:"text-column original-text-column text-block"},Lg={class:"text-column translated-text-column text-block"},Ug={class:"style-settings-section text-block"},Og={class:"office-toolbar"},zg={class:"toolbar-row toolbar-row-top"},Vg={class:"combo-control font-control"},Ng={class:"combo-control size-control"},Wg={class:"size-input-wrap"},Kg=["min","max","step"],qg={class:"toolbar-row toolbar-row-actions"},Hg={class:"toolbar-icon-group","aria-label":"排版方向"},Yg=["data-active"],Jg=["data-active"],Xg={class:"toolbar-color-group"},jg={class:"toolbar-color-picker",title:"文字颜色"},Gg={class:"toolbar-inpaint-group",title:"背景修复方式"},Zg={class:"toolbar-stroke-cluster"},Qg=["data-active"],ep={class:"toolbar-row toolbar-row-bottom"},tp={class:"toolbar-rotation-group",title:"旋转角度"},np={class:"toolbar-position-group",title:"位置调整"},op={class:"toolbar-position-value"},ap={class:"fontsize-presets-panel"},sp={class:"font-size-presets"},lp=["onClick"],Mt=2,ip=He({__name:"BubbleEditor",props:{bubble:{},bubbleIndex:{}},emits:["update","reRender","ocrRecognize","reTranslate","applyBubble","resetCurrent"],setup(n,{emit:c}){const u=n,t=c,r=dt(),a={originalText:"",translatedText:"",fontSize:24,fontFamily:"fonts/STSONG.TTF",textDirection:"auto",textColor:"#231816",fillColor:"#FFFFFF",strokeEnabled:!0,strokeColor:"#FFFFFF",strokeWidth:3,rotationAngle:0,inpaintMethod:"solid",position:{x:0,y:0}},o=S(""),s=S(""),y=S(24),P=S("fonts/STSONG.TTF"),T=S("auto"),V=S("#231816"),X=S("#FFFFFF"),J=S(!0),A=S("#FFFFFF"),f=S(3),D=S(0),B=S("solid"),F=S(0),i=S(0),l=S(null),v=S(null),p=S(null),R=S(null),E=S(null),N=S(!1),O=S("original"),C=S([{name:"华文宋体",path:"fonts/STSONG.TTF"},{name:"华文楷体",path:"fonts/STKAITI.TTF"},{name:"华文细黑",path:"fonts/STXIHEI.TTF"},{name:"黑体",path:"fonts/SIMHEI.TTF"},{name:"宋体",path:"fonts/SIMSUN.TTC"}]),w=S([]),m=te(()=>u.bubble?u.bubble.coords[0]+F.value:0),g=te(()=>u.bubble?u.bubble.coords[1]+i.value:0),k=te(()=>{const Be=[{label:"系统字体",options:C.value.map(q=>({label:q.name,value:q.path}))}];return w.value.length>0&&Be.push({label:"自定义字体",options:w.value.map(q=>({label:q.name,value:q.path}))}),Be}),$=[{label:"纯色填充",value:"solid"},{label:"LAMA修复(漫画)",value:"lama_mpe"},{label:"LAMA修复(通用)",value:"litelama"}];function b(Be){const q=Be||a;o.value=q.originalText,s.value=q.translatedText,y.value=q.fontSize,P.value=q.fontFamily,T.value=q.textDirection,V.value=q.textColor,X.value=q.fillColor,J.value=q.strokeEnabled,A.value=q.strokeColor,f.value=q.strokeWidth,D.value=q.rotationAngle,B.value=q.inpaintMethod,F.value=q.position?.x||0,i.value=q.position?.y||0}ye(()=>u.bubble,Be=>{b(Be)},{deep:!0,immediate:!0});function h(){t("update",{originalText:o.value})}function Y(){t("update",{translatedText:s.value})}function W(){navigator.clipboard.writeText(o.value)}function x(){navigator.clipboard.writeText(s.value)}function _(){t("update",{fontSize:y.value})}function d(Be){y.value=Be,t("update",{fontSize:Be})}function M(){y.value=Math.min(Ln,y.value+Xt),t("update",{fontSize:y.value})}function ae(){y.value=Math.max(Un,y.value-Xt),t("update",{fontSize:y.value})}function L(){t("update",{fontFamily:P.value})}function j(Be){T.value=Be,t("update",{textDirection:Be})}function le(){p.value?.click()}function U(){t("update",{textColor:V.value})}function Z(){R.value?.click()}function ce(){t("update",{fillColor:X.value})}function Te(){E.value?.click()}function _e(){t("update",{strokeColor:A.value})}function Ae(){J.value=!J.value,t("update",{strokeEnabled:J.value})}function Re(){t("update",{strokeWidth:f.value})}function Me(){t("update",{inpaintMethod:B.value})}function z(){t("update",{rotationAngle:D.value})}function I(){D.value=Math.max(-180,D.value-5),t("update",{rotationAngle:D.value})}function ee(){D.value=Math.min(180,D.value+5),t("update",{rotationAngle:D.value})}function Q(){D.value=0,t("update",{rotationAngle:0})}function ne(){F.value-=Mt,t("update",{position:{x:F.value,y:i.value}})}function ge(){F.value+=Mt,t("update",{position:{x:F.value,y:i.value}})}function he(){i.value-=Mt,t("update",{position:{x:F.value,y:i.value}})}function xe(){i.value+=Mt,t("update",{position:{x:F.value,y:i.value}})}function ve(){F.value=0,i.value=0,t("update",{position:{x:0,y:0}})}function pe(){t("applyBubble",u.bubbleIndex)}function $e(){r.updateAllBubbles({fontSize:y.value,fontFamily:P.value,textDirection:T.value,textColor:V.value,fillColor:X.value,strokeEnabled:J.value,strokeColor:A.value,strokeWidth:f.value,inpaintMethod:B.value}),console.log("样式已应用到所有气泡"),t("reRender")}function ke(){t("resetCurrent",u.bubbleIndex)}function Fe(){t("ocrRecognize",u.bubbleIndex)}function Ie(){t("reTranslate",u.bubbleIndex)}function je(){N.value=!N.value}function Se(Be,q){if(q==="original"){const de=l.value;if(de){const Ne=de.selectionStart||o.value.length,Ye=de.selectionEnd||o.value.length,bt=o.value;o.value=bt.slice(0,Ne)+Be+bt.slice(Ye),ct(()=>{de.selectionStart=de.selectionEnd=Ne+Be.length,de.focus()}),t("update",{originalText:o.value})}}else{const de=v.value;if(de){const Ne=de.selectionStart||s.value.length,Ye=de.selectionEnd||s.value.length,bt=s.value;s.value=bt.slice(0,Ne)+Be+bt.slice(Ye),ct(()=>{de.selectionStart=de.selectionEnd=Ne+Be.length,de.focus()}),t("update",{translatedText:s.value})}}}function nt(Be){if(Be==="original"){const q=l.value;if(q&&o.value.length>0){const de=q.selectionStart||o.value.length,Ne=q.selectionEnd||o.value.length,Ye=o.value;de===Ne&&de>0?(o.value=Ye.slice(0,de-1)+Ye.slice(Ne),ct(()=>{q.selectionStart=q.selectionEnd=de-1,q.focus()})):de!==Ne&&(o.value=Ye.slice(0,de)+Ye.slice(Ne),ct(()=>{q.selectionStart=q.selectionEnd=de,q.focus()})),t("update",{originalText:o.value})}}else{const q=v.value;if(q&&s.value.length>0){const de=q.selectionStart||s.value.length,Ne=q.selectionEnd||s.value.length,Ye=s.value;de===Ne&&de>0?(s.value=Ye.slice(0,de-1)+Ye.slice(Ne),ct(()=>{q.selectionStart=q.selectionEnd=de-1,q.focus()})):de!==Ne&&(s.value=Ye.slice(0,de)+Ye.slice(Ne),ct(()=>{q.selectionStart=q.selectionEnd=de,q.focus()})),t("update",{translatedText:s.value})}}}async function lt(){try{const Be=await Qo();if(Be.fonts){const q=[],de=[];for(const Ne of Be.fonts){const Ye={name:typeof Ne=="string"?Ne:Ne.display_name||Ne.file_name||"",path:typeof Ne=="string"?Ne:Ne.path};Ye.path.startsWith("fonts/")?q.push(Ye):de.push(Ye)}q.length>0&&(C.value=q),w.value=de}}catch(Be){console.error("加载字体列表失败:",Be)}}return ut(()=>{lt()}),(Be,q)=>(K(),G("div",Ag,[e("div",Fg,[e("div",{class:"text-column-header"},[q[13]||(q[13]=e("span",{class:"column-title"},"🇯🇵 日语原文 (OCR结果)",-1)),e("button",{class:"re-ocr-btn",onClick:Fe,title:"重新OCR此气泡"},"🔄")]),oe(e("textarea",{ref_key:"originalTextInput",ref:l,"onUpdate:modelValue":q[0]||(q[0]=de=>o.value=de),class:"text-editor original-editor",placeholder:"OCR识别的日语原文...",spellcheck:"false",onInput:h},null,544),[[Ce,o.value]]),e("div",{class:"text-actions"},[e("button",{class:"copy-btn",onClick:W},"📋 复制"),e("button",{class:"keyboard-toggle-btn",onClick:je,title:"显示/隐藏50音键盘"}," ⌨️ 50音 ")]),me(Pg,{visible:N.value,"default-target":O.value,onClose:q[1]||(q[1]=de=>N.value=!1),onInsert:Se,onDelete:nt},null,8,["visible","default-target"])]),e("div",Lg,[e("div",{class:"text-column-header"},[q[14]||(q[14]=e("span",{class:"column-title"},"🇨🇳 中文译文",-1)),e("button",{class:"re-translate-btn",onClick:Ie,title:"重新翻译此气泡"}," 🔄 ")]),oe(e("textarea",{ref_key:"translatedTextInput",ref:v,"onUpdate:modelValue":q[2]||(q[2]=de=>s.value=de),class:"text-editor translated-editor",placeholder:"翻译后的中文...",spellcheck:"false",onInput:Y},null,544),[[Ce,s.value]]),e("div",{class:"text-actions"},[e("button",{class:"copy-btn",onClick:x},"📋 复制"),e("button",{class:"apply-text-btn",onClick:pe},"✓ 应用文本")])]),e("div",Ug,[e("div",Og,[e("div",zg,[e("div",Vg,[q[15]||(q[15]=e("label",null,"字体",-1)),me(Oe,{modelValue:P.value,"onUpdate:modelValue":q[3]||(q[3]=de=>P.value=de),groups:k.value,title:"字体",onChange:L},null,8,["modelValue","groups"])]),e("div",Ng,[q[16]||(q[16]=e("label",null,"字号",-1)),e("div",Wg,[oe(e("input",{type:"number","onUpdate:modelValue":q[4]||(q[4]=de=>y.value=de),class:"toolbar-fontsize-input",min:re(Un),max:re(Ln),step:re(Xt),title:"字号",onChange:_},null,40,Kg),[[Ce,y.value,void 0,{number:!0}]]),e("div",{class:"toolbar-fontsize-btns"},[e("button",{class:"toolbar-fontsize-btn",onClick:M,title:"增大字号"}," A+ "),e("button",{class:"toolbar-fontsize-btn",onClick:ae,title:"减小字号"}," A- ")])])])]),e("div",qg,[e("div",Hg,[e("button",{class:"toolbar-btn","data-active":T.value==="vertical",onClick:q[5]||(q[5]=de=>j("vertical")),title:"竖向排版"},[...q[17]||(q[17]=[e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("path",{d:"M8 2v12M8 2L5 5M8 2l3 3",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])],8,Yg),e("button",{class:"toolbar-btn","data-active":T.value==="horizontal",onClick:q[6]||(q[6]=de=>j("horizontal")),title:"横向排版"},[...q[18]||(q[18]=[e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("path",{d:"M2 8h12M14 8l-3-3M14 8l-3 3",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])],8,Jg)]),q[24]||(q[24]=e("div",{class:"toolbar-divider vertical"},null,-1)),e("div",Xg,[e("div",jg,[e("button",{class:"toolbar-btn toolbar-color-btn",onClick:le},[q[19]||(q[19]=e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("text",{x:"3",y:"11","font-size":"10","font-weight":"bold",fill:"currentColor"},"A")],-1)),e("span",{class:"color-indicator",style:st({background:V.value})},null,4)]),oe(e("input",{ref_key:"textColorInput",ref:p,type:"color","onUpdate:modelValue":q[7]||(q[7]=de=>V.value=de),class:"hidden-color-input",onChange:U},null,544),[[Ce,V.value]])])]),q[25]||(q[25]=e("div",{class:"toolbar-divider vertical"},null,-1)),e("div",Gg,[me(Oe,{modelValue:B.value,"onUpdate:modelValue":q[8]||(q[8]=de=>B.value=de),options:$,onChange:Me},null,8,["modelValue"]),e("div",{class:De(["toolbar-color-picker toolbar-solid-color-options",{hidden:B.value!=="solid"}])},[e("button",{class:"toolbar-btn toolbar-color-btn",onClick:Z},[q[20]||(q[20]=e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("rect",{x:"2",y:"2",width:"12",height:"12",rx:"2",fill:"none",stroke:"currentColor","stroke-width":"1.2"}),e("rect",{x:"4",y:"4",width:"8",height:"8",rx:"1",fill:"currentColor",opacity:"0.3"})],-1)),e("span",{class:"color-indicator",style:st({background:X.value})},null,4)]),oe(e("input",{ref_key:"fillColorInput",ref:R,type:"color","onUpdate:modelValue":q[9]||(q[9]=de=>X.value=de),class:"hidden-color-input",onChange:ce},null,544),[[Ce,X.value]])],2)]),q[26]||(q[26]=e("div",{class:"toolbar-divider vertical"},null,-1)),e("div",Zg,[e("button",{class:"toolbar-btn","data-active":J.value,onClick:Ae,title:"文字描边"},[...q[21]||(q[21]=[e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("text",{x:"3",y:"12","font-size":"11","font-weight":"bold",stroke:"currentColor","stroke-width":"2",fill:"none"}," A "),e("text",{x:"3",y:"12","font-size":"11","font-weight":"bold",fill:"currentColor"},"A")],-1)])],8,Qg),e("div",{class:De(["toolbar-color-picker toolbar-stroke-options",{hidden:!J.value}]),title:"描边颜色"},[e("button",{class:"toolbar-btn toolbar-color-btn",onClick:Te},[q[22]||(q[22]=e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("circle",{cx:"8",cy:"8",r:"5",fill:"none",stroke:"currentColor","stroke-width":"2"})],-1)),e("span",{class:"color-indicator",style:st({background:A.value})},null,4)]),oe(e("input",{ref_key:"strokeColorInput",ref:E,type:"color","onUpdate:modelValue":q[10]||(q[10]=de=>A.value=de),class:"hidden-color-input",onChange:_e},null,544),[[Ce,A.value]])],2),e("div",{class:De(["toolbar-stroke-width toolbar-stroke-options",{hidden:!J.value}]),title:"描边宽度"},[oe(e("input",{type:"number","onUpdate:modelValue":q[11]||(q[11]=de=>f.value=de),class:"toolbar-mini-input",min:"0",max:"10",onChange:Re},null,544),[[Ce,f.value,void 0,{number:!0}]]),q[23]||(q[23]=e("span",{class:"toolbar-unit"},"px",-1))],2)])]),e("div",ep,[e("div",tp,[e("button",{class:"toolbar-btn",onClick:I,title:"逆时针旋转"},[...q[27]||(q[27]=[e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("path",{d:"M2 8a6 6 0 1 1 1.5 4",stroke:"currentColor","stroke-width":"1.5",fill:"none"}),e("path",{d:"M2 5v3.5h3.5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),oe(e("input",{type:"number","onUpdate:modelValue":q[12]||(q[12]=de=>D.value=de),class:"toolbar-mini-input toolbar-rotation-input",min:"-180",max:"180",step:"5",onChange:z},null,544),[[Ce,D.value,void 0,{number:!0}]]),q[29]||(q[29]=e("span",{class:"toolbar-unit"},"°",-1)),e("button",{class:"toolbar-btn",onClick:ee,title:"顺时针旋转"},[...q[28]||(q[28]=[e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("path",{d:"M14 8a6 6 0 1 0-1.5 4",stroke:"currentColor","stroke-width":"1.5",fill:"none"}),e("path",{d:"M14 5v3.5h-3.5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),e("button",{class:"toolbar-btn toolbar-small-btn",onClick:Q,title:"重置旋转"}," 0 ")]),q[35]||(q[35]=e("div",{class:"toolbar-divider vertical"},null,-1)),e("div",np,[e("button",{class:"toolbar-btn",onClick:ne,title:"左移"},[...q[30]||(q[30]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("path",{d:"M10 3L5 8l5 5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),e("button",{class:"toolbar-btn",onClick:ge,title:"右移"},[...q[31]||(q[31]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("path",{d:"M6 3l5 5-5 5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),e("button",{class:"toolbar-btn",onClick:he,title:"上移"},[...q[32]||(q[32]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("path",{d:"M3 10l5-5 5 5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),e("button",{class:"toolbar-btn",onClick:xe,title:"下移"},[...q[33]||(q[33]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("path",{d:"M3 6l5 5 5-5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),e("span",op,[e("span",null,ue(m.value),1),q[34]||(q[34]=Ue(",",-1)),e("span",null,ue(g.value),1)]),e("button",{class:"toolbar-btn toolbar-small-btn",onClick:ve,title:"重置位置"}," ⌂ ")])])]),e("details",ap,[q[36]||(q[36]=e("summary",null,"字号预设",-1)),e("div",sp,[(K(!0),G(Xe,null,Ge(re(Lo),de=>(K(),G("button",{key:de,class:De(["preset-btn",{active:y.value===de}]),onClick:Ne=>d(de)},ue(de),11,lp))),128))])]),e("div",{class:"edit-action-buttons"},[e("button",{class:"btn-apply",onClick:pe},"应用"),e("button",{class:"btn-apply-all",onClick:$e},"应用全部"),e("button",{class:"btn-reset",onClick:ke},"重置")])])]))}}),rp=qe(ip,[["__scopeId","data-v-75af88de"]]),up={class:"edit-toolbar-wrapper"},cp={class:"edit-toolbar toolbar-row-1"},dp={class:"image-navigator"},gp=["disabled"],pp=["disabled"],bp={class:"bubble-navigator"},vp=["disabled"],mp={class:"bubble-indicator"},fp={id:"currentBubbleNum"},hp={id:"totalBubbleNum"},yp=["disabled"],xp={class:"view-controls"},Sp={key:0,viewBox:"0 0 20 20",width:"16",height:"16"},kp={key:1,viewBox:"0 0 20 20",width:"16",height:"16"},_p={id:"zoomLevel"},Cp={class:"edit-toolbar toolbar-row-2"},wp={class:"annotation-tools"},$p=["disabled"],Tp=["disabled"],Ip={key:0,class:"brush-size-indicator"},Dp={key:1,class:"brush-mode-hint"},Rp={class:"edit-progress-info"},Mp={class:"edit-progress-text"},Bp={class:"edit-progress-count"},Ep={class:"edit-progress-bar"},Pp={class:"quick-actions"},Ap=He({__name:"EditToolbar",props:{currentImageIndex:{},imageCount:{},canGoPrevious:{type:Boolean},canGoNext:{type:Boolean},showThumbnails:{type:Boolean},hasBubbles:{type:Boolean},selectedBubbleIndex:{},bubbleCount:{},layoutMode:{},syncEnabled:{type:Boolean},scale:{},isDrawingMode:{type:Boolean},hasSelection:{type:Boolean},brushMode:{},brushSize:{},mouseX:{},mouseY:{},isProcessing:{type:Boolean},progressText:{},progressCurrent:{},progressTotal:{}},emits:["go-previous-image","go-next-image","toggle-thumbnails","select-previous-bubble","select-next-bubble","toggle-layout","toggle-view-mode","toggle-sync","fit-to-screen","zoom-in","zoom-out","reset-zoom","exit-edit-mode","auto-detect-bubbles","detect-all-images","translate-with-bubbles","toggle-drawing-mode","delete-selected-bubbles","repair-selected-bubble","activate-repair-brush","activate-restore-brush","apply-and-next"],setup(n){const c=n,u=te(()=>c.progressTotal===0?0:Math.round(c.progressCurrent/c.progressTotal*100)),t=te(()=>c.progressTotal>0&&c.progressCurrent>=c.progressTotal),r=te(()=>{const a=c.brushMode==="repair"?{fill:"rgba(76, 175, 80, 0.4)",border:"#4CAF50"}:{fill:"rgba(33, 150, 243, 0.4)",border:"#2196F3"};return{position:"fixed",left:`${c.mouseX}px`,top:`${c.mouseY}px`,width:`${c.brushSize}px`,height:`${c.brushSize}px`,borderRadius:"50%",border:`2px solid ${a.border}`,backgroundColor:a.fill,pointerEvents:"none",zIndex:99999,transform:"translate(-50%, -50%)",display:c.brushMode?"block":"none"}});return(a,o)=>(K(),G("div",up,[e("div",cp,[e("div",dp,[e("button",{class:"nav-btn",disabled:!n.canGoPrevious,onClick:o[0]||(o[0]=s=>a.$emit("go-previous-image")),title:"上一张图片 (PageUp)"}," ◀◀ ",8,gp),e("span",{class:"image-indicator",onClick:o[1]||(o[1]=s=>a.$emit("toggle-thumbnails")),title:"点击展开缩略图"},[o[23]||(o[23]=Ue(" 图 ",-1)),e("span",null,ue(n.currentImageIndex+1),1),o[24]||(o[24]=Ue(" / ",-1)),e("span",null,ue(n.imageCount),1)]),e("button",{class:"nav-btn",disabled:!n.canGoNext,onClick:o[2]||(o[2]=s=>a.$emit("go-next-image")),title:"下一张图片 (PageDown)"}," ▶▶ ",8,pp),e("button",{class:De(["thumb-toggle-btn",{active:n.showThumbnails}]),onClick:o[3]||(o[3]=s=>a.$emit("toggle-thumbnails")),title:"显示/隐藏缩略图"}," ☷ ",2)]),o[30]||(o[30]=e("div",{class:"toolbar-divider"},null,-1)),e("div",bp,[e("button",{id:"prevBubbleBtn",class:"nav-btn",disabled:!n.hasBubbles||n.selectedBubbleIndex<=0,onClick:o[4]||(o[4]=s=>a.$emit("select-previous-bubble")),title:"上一个气泡 (←)"}," ◀ ",8,vp),e("span",mp,[o[25]||(o[25]=Ue(" 气泡 ",-1)),e("span",fp,ue(n.selectedBubbleIndex>=0?n.selectedBubbleIndex+1:0),1),o[26]||(o[26]=Ue(" / ",-1)),e("span",hp,ue(n.bubbleCount),1)]),e("button",{id:"nextBubbleBtn",class:"nav-btn",disabled:!n.hasBubbles||n.selectedBubbleIndex>=n.bubbleCount-1,onClick:o[5]||(o[5]=s=>a.$emit("select-next-bubble")),title:"下一个气泡 (→)"}," ▶ ",8,yp)]),o[31]||(o[31]=e("div",{class:"toolbar-divider"},null,-1)),e("div",xp,[e("button",{class:"layout-toggle-btn",onClick:o[6]||(o[6]=s=>a.$emit("toggle-layout")),title:"切换布局：左右/上下"},[n.layoutMode==="horizontal"?(K(),G("svg",Sp,[...o[27]||(o[27]=[e("rect",{x:"1",y:"2",width:"8",height:"16",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"},null,-1),e("rect",{x:"11",y:"2",width:"8",height:"16",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"},null,-1)])])):(K(),G("svg",kp,[...o[28]||(o[28]=[e("rect",{x:"2",y:"1",width:"16",height:"8",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"},null,-1),e("rect",{x:"2",y:"11",width:"16",height:"8",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"},null,-1)])]))]),e("button",{class:"view-mode-btn",onClick:o[7]||(o[7]=s=>a.$emit("toggle-view-mode")),title:"切换视图模式"},[...o[29]||(o[29]=[e("span",{class:"dual-icon"},"⧉",-1)])]),e("button",{class:De({active:n.syncEnabled}),onClick:o[8]||(o[8]=s=>a.$emit("toggle-sync")),title:"同步缩放/拖动",style:{"font-size":"12px"}}," 🔗 ",2),e("button",{onClick:o[9]||(o[9]=s=>a.$emit("fit-to-screen")),title:"适应屏幕 (双击)"},"⛶"),e("button",{onClick:o[10]||(o[10]=s=>a.$emit("zoom-in")),title:"放大 (+)"},"+"),e("span",_p,ue(Math.round(n.scale*100))+"%",1),e("button",{onClick:o[11]||(o[11]=s=>a.$emit("zoom-out")),title:"缩小 (-)"},"−"),e("button",{onClick:o[12]||(o[12]=s=>a.$emit("reset-zoom")),title:"原始大小"},"1:1")]),o[32]||(o[32]=e("div",{class:"toolbar-spacer"},null,-1)),e("button",{class:"secondary-btn",onClick:o[13]||(o[13]=s=>a.$emit("exit-edit-mode"))},"退出编辑")]),e("div",Cp,[e("div",wp,[e("button",{class:"annotation-btn detect-btn",onClick:o[14]||(o[14]=s=>a.$emit("auto-detect-bubbles")),title:"自动检测当前图片的文本框"},[...o[33]||(o[33]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("circle",{cx:"6",cy:"6",r:"4",fill:"none",stroke:"currentColor","stroke-width":"1.5"}),e("path",{d:"M9 9l4 4",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round"})],-1),e("span",null,"检测",-1)])]),e("button",{class:"annotation-btn detect-btn",onClick:o[15]||(o[15]=s=>a.$emit("detect-all-images")),title:"批量检测所有图片"},[...o[34]||(o[34]=[Zt('<svg viewBox="0 0 16 16" width="14" height="14" data-v-b7164359><circle cx="5" cy="5" r="2.5" fill="none" stroke="currentColor" stroke-width="1" data-v-b7164359></circle><path d="M7 7l2 2" stroke="currentColor" stroke-width="1" stroke-linecap="round" data-v-b7164359></path><circle cx="10" cy="10" r="2.5" fill="none" stroke="currentColor" stroke-width="1" data-v-b7164359></circle><path d="M12 12l2 2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" data-v-b7164359></path></svg><span data-v-b7164359>批量检测</span>',2)])]),e("button",{class:"annotation-btn primary-action-btn",onClick:o[16]||(o[16]=s=>a.$emit("translate-with-bubbles")),title:"使用当前文本框翻译此图片"},[...o[35]||(o[35]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("path",{d:"M2 3h5M4.5 3v7M2 6h5",stroke:"currentColor","stroke-width":"1.2",fill:"none"}),e("path",{d:"M9 13l2-7 2 7M9.5 11h3",stroke:"currentColor","stroke-width":"1.2",fill:"none"})],-1),e("span",null,"翻译",-1)])]),o[41]||(o[41]=e("div",{class:"toolbar-divider"},null,-1)),e("button",{class:De(["annotation-btn",{active:n.isDrawingMode}]),onClick:o[17]||(o[17]=s=>a.$emit("toggle-drawing-mode")),title:"添加气泡框（或中键拖拽绘制）"},[...o[36]||(o[36]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("rect",{x:"3",y:"3",width:"10",height:"10",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"}),e("path",{d:"M8 5v6M5 8h6",stroke:"currentColor","stroke-width":"1.5"})],-1),e("span",null,"添加",-1)])],2),e("button",{class:"annotation-btn",disabled:!n.hasSelection,onClick:o[18]||(o[18]=s=>a.$emit("delete-selected-bubbles")),title:"删除选中气泡框 (Delete)"},[...o[37]||(o[37]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("rect",{x:"3",y:"3",width:"10",height:"10",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"}),e("path",{d:"M5 8h6",stroke:"currentColor","stroke-width":"1.5"})],-1),e("span",null,"删除",-1)])],8,$p),e("button",{class:"annotation-btn",disabled:!n.hasSelection,onClick:o[19]||(o[19]=s=>a.$emit("repair-selected-bubble")),title:"修复选中气泡背景 (R)"},[...o[38]||(o[38]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("path",{d:"M2 14l3-3m0 0l6-6 3 3-6 6m-3 0l-1 1 1-1z",fill:"none",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round"}),e("path",{d:"M11 5l-1-1 2-2 2 2-2 2-1-1z",fill:"currentColor"})],-1),e("span",null,"修复",-1)])],8,Tp),o[42]||(o[42]=e("div",{class:"toolbar-divider"},null,-1)),e("button",{class:De(["annotation-btn brush-btn",{active:n.brushMode==="repair"}]),onClick:o[20]||(o[20]=s=>a.$emit("activate-repair-brush")),title:"修复笔刷 (按住R+左键拖拽)"},[...o[39]||(o[39]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("circle",{cx:"8",cy:"8",r:"5",fill:"none",stroke:"currentColor","stroke-width":"1.5"}),e("circle",{cx:"8",cy:"8",r:"2",fill:"currentColor"})],-1),e("span",null,"修复笔刷",-1)])],2),e("button",{class:De(["annotation-btn brush-btn",{active:n.brushMode==="restore"}]),onClick:o[21]||(o[21]=s=>a.$emit("activate-restore-brush")),title:"还原笔刷 (按住U+左键拖拽)"},[...o[40]||(o[40]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("circle",{cx:"8",cy:"8",r:"5",fill:"none",stroke:"currentColor","stroke-width":"1.5"}),e("path",{d:"M5 8h6M8 5v6",stroke:"currentColor","stroke-width":"1",transform:"rotate(45 8 8)"})],-1),e("span",null,"还原笔刷",-1)])],2),n.brushMode?(K(),G("span",Ip," 笔刷: "+ue(n.brushSize)+"px ",1)):fe("",!0),o[43]||(o[43]=Zt('<div class="help-tooltip-container" data-v-b7164359><button class="help-tooltip-btn" title="快捷键操作帮助" data-v-b7164359><svg viewBox="0 0 16 16" width="14" height="14" data-v-b7164359><circle cx="8" cy="8" r="6.5" fill="none" stroke="currentColor" stroke-width="1.2" data-v-b7164359></circle><text x="8" y="11" text-anchor="middle" font-size="9" font-weight="bold" fill="currentColor" data-v-b7164359>?</text></svg><span class="help-btn-text" data-v-b7164359>快捷键</span></button><div class="help-tooltip-popup" data-v-b7164359><div class="help-section" data-v-b7164359><div class="help-title" data-v-b7164359>🖱️ 鼠标操作</div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>左键点击气泡</span><span class="help-desc" data-v-b7164359>选择气泡</span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>Shift+左键点击</span><span class="help-desc" data-v-b7164359>多选气泡</span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>左键拖拽四角/边</span><span class="help-desc" data-v-b7164359>调整大小</span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>左键拖拽框内部</span><span class="help-desc" data-v-b7164359>移动气泡框</span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>中键拖拽</span><span class="help-desc" data-v-b7164359>绘制新气泡框</span></div></div><div class="help-section" data-v-b7164359><div class="help-title" data-v-b7164359>⌨️ 快捷键</div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>A / D</span><span class="help-desc" data-v-b7164359>切换上/下一张图片</span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>Ctrl+Enter</span><span class="help-desc" data-v-b7164359>应用并跳转下一张</span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>Delete / Backspace</span><span class="help-desc" data-v-b7164359>删除选中气泡</span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>按住R+左键拖拽</span><span class="help-desc" data-v-b7164359>修复笔刷</span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>按住U+左键拖拽</span><span class="help-desc" data-v-b7164359>还原笔刷</span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>笔刷模式下滚轮</span><span class="help-desc" data-v-b7164359>调整笔刷大小</span></div></div></div></div>',1))]),n.brushMode?(K(),G("div",{key:0,class:"brush-cursor",style:st(r.value)},null,4)):fe("",!0),n.brushMode?(K(),G("div",Dp,ue(n.brushMode==="repair"?"修复笔刷 (R)":"还原笔刷 (U)")+" - 滚轮调整大小 ",1)):fe("",!0),n.isProcessing?(K(),G("div",{key:2,class:De(["edit-progress-container",{completed:t.value}])},[e("div",Rp,[e("span",Mp,ue(n.progressText),1),e("span",Bp,ue(n.progressCurrent)+"/"+ue(n.progressTotal),1)]),e("div",Ep,[e("div",{class:De(["edit-progress-fill",{animating:!t.value}]),style:st({width:u.value+"%"})},null,6)])],2)):fe("",!0),o[44]||(o[44]=e("div",{class:"toolbar-spacer"},null,-1)),e("div",Pp,[e("button",{class:"primary-btn",onClick:o[22]||(o[22]=s=>a.$emit("apply-and-next")),title:"应用更改并跳转下一张 (Ctrl+Enter)"}," 应用并下一张 ")])])]))}}),Fp=qe(Ap,[["__scopeId","data-v-b7164359"]]),Lp={key:0,class:"edit-thumbnails-panel"},Up={class:"thumbnails-scroll"},Op=["onClick"],zp=["src","alt"],Vp={class:"thumb-index"},Np=He({__name:"EditThumbnailPanel",props:{visible:{type:Boolean},images:{},currentImageIndex:{}},emits:["switch-to-image"],setup(n){return(c,u)=>n.visible?(K(),G("div",Lp,[e("div",Up,[(K(!0),G(Xe,null,Ge(n.images,(t,r)=>(K(),G("div",{key:t.id,class:De(["edit-thumbnail-item",{active:r===n.currentImageIndex}]),onClick:a=>c.$emit("switch-to-image",r)},[e("img",{src:t.translatedDataURL||t.originalDataURL,alt:`图片 ${r+1}`},null,8,zp),e("span",Vp,ue(r+1),1)],10,Op))),128))])])):fe("",!0)}}),Wp=qe(Np,[["__scopeId","data-v-9d2a43d9"]]),Kp={class:"edit-main-layout"},qp={class:"image-comparison-container"},Hp={class:"panel-header"},Yp=["src"],Jp={class:"panel-header"},Xp=["src"],jp=He({__name:"EditWorkspace",props:{isEditModeActive:{type:Boolean}},emits:["exit"],setup(n,{emit:c}){const u=n,t=c,r=Qe(),a=dt(),{translateWithCurrentBubbles:o}=bn(),{reRenderFullImage:s}=Xd({onRenderStart:()=>console.log("开始重新渲染..."),onRenderSuccess:H=>console.log("渲染成功:",H.substring(0,50)+"..."),onRenderError:H=>console.error("渲染失败:",H)}),{isDrawingMode:y,isDrawingBox:P,currentDrawingRect:T,isMiddleButtonDown:V,handleBubbleSelect:X,handleBubbleMultiSelect:J,handleClearMultiSelect:A,handleBubbleDragStart:f,handleBubbleDragging:D,handleBubbleDragEnd:B,handleBubbleResizeStart:F,handleBubbleResizing:i,handleBubbleResizeEnd:l,handleBubbleRotateStart:v,handleBubbleRotating:p,handleBubbleRotateEnd:R,toggleDrawingMode:E,handleDrawBubble:N,getDrawingRectStyle:O,handleBubbleUpdate:C,deleteSelectedBubbles:w,repairSelectedBubble:m,handleOcrRecognize:g}=Jd({onReRender:()=>s(),onDelayedPreview:()=>s()}),k=S(0),$=S(0),{brushMode:b,brushSize:h,mouseX:Y,mouseY:W,isBrushKeyDown:x,toggleBrushMode:_,exitBrushMode:d,startBrushPainting:M,continueBrushPainting:ae,finishBrushPainting:L,adjustBrushSize:j}=Hd({onBrushComplete:()=>s(),getCurrentRepairSettings:()=>({inpaintMethod:Be.value,fillColor:q.value})}),{images:le,currentImageIndex:U,currentImage:Z,imageCount:ce,canGoPrevious:Te,canGoNext:_e}=yt(r),{bubbles:Ae,selectedIndex:Re,selectedIndices:Me,selectedBubble:z,bubbleCount:I,hasBubbles:ee,hasSelection:Q}=yt(a),ne=te(()=>ve.value?.querySelector("img")?.naturalWidth||2e3),ge=te(()=>ve.value?.querySelector("img")?.naturalHeight||2e3),he=S(null),xe=S(null),ve=S(null),pe=S(null),$e=S(null),ke=S(null),Fe=S("dual"),Ie=S("horizontal"),je=S(!1),Se=S(!0),nt=S(!1),lt=S(!1),Be=S("solid"),q=S("#FFFFFF"),de=S(!1),Ne=S("处理中..."),Ye=S(0),bt=S(0),et=qn(),Je=qn(),At=te(()=>Je.scale.value),ao=te(()=>Je.translateX.value),so=te(()=>Je.translateY.value),lo=te(()=>et.scale.value),mt=S(null),io=te(()=>({transform:`translate(${et.translateX.value}px, ${et.translateY.value}px) scale(${et.scale.value})`})),ro=te(()=>({transform:`translate(${Je.translateX.value}px, ${Je.translateY.value}px) scale(${Je.scale.value})`}));function vn(){Je.zoomIn(),Se.value&&et.setTransform(Je.getTransform())}function mn(){Je.zoomOut(),Se.value&&et.setTransform(Je.getTransform())}function fn(){Je.resetZoom(),Se.value&&et.setTransform(Je.getTransform())}const Ft=S(!1),uo=S(0),Lt=S(!1),_t=S({x:0,y:0,size:0});function Ut(){b.value&&d(),Vt()}function Ot(){a.bubbles.length>0&&a.selectBubble(0)}function hn(){Te.value&&(Ut(),r.goToPrevious())}function zt(){_e.value&&(Ut(),r.goToNext())}function co(H){H!==U.value&&H>=0&&H<ce.value&&(Ut(),r.setCurrentImageIndex(H))}function Vt(){if(!Z.value)return;const H=Array.isArray(Z.value.bubbleStates);Ae.value.length>0?(r.updateCurrentBubbleStates([...Ae.value]),r.setManuallyAnnotated(!0),console.log("已保存气泡状态到当前图片，标记为手动标注")):H&&(r.updateCurrentBubbleStates([]),r.setManuallyAnnotated(!0),console.log("已保存空气泡状态到当前图片（用户主动清空，标记为手动标注）"))}function Ct(){Z.value?.bubbleStates?(a.setBubbles([...Z.value.bubbleStates],!0),console.log(`已加载 ${Z.value.bubbleStates.length} 个气泡状态`)):a.clearBubblesLocal(),Ot()}function go(){a.selectPrevious()}function po(){a.selectNext()}function bo(){je.value=!je.value}function vo(){Ie.value=Ie.value==="horizontal"?"vertical":"horizontal";try{localStorage.setItem(On,Ie.value)}catch(H){console.warn("保存布局模式失败:",H)}setTimeout(()=>{wt()},300)}function mo(){const H=["dual","original","translated"],se=H.indexOf(Fe.value),ie=H[(se+1)%H.length];ie&&(Fe.value=ie)}function fo(){Se.value=!Se.value,console.log("双图同步:",Se.value?"开启":"关闭"),Se.value&&et.setTransform(Je.getTransform())}function wt(){const H=pe.value||xe.value,se=$e.value||ve.value;if(!H||!se)return;const ie=se.querySelector("img");if(!ie||!ie.naturalWidth)return;const We=H.getBoundingClientRect(),Pe=We.width/ie.naturalWidth,we=We.height/ie.naturalHeight,Le=Math.min(Pe,we)*.95,Ee=(We.width-ie.naturalWidth*Le)/2,vt=(We.height-ie.naturalHeight*Le)/2,ft={scale:Le,translateX:Ee,translateY:vt};Je.setTransform(ft),et.setTransform(ft)}function yn(H,se){if(b.value){const Ee=H.deltaY>0?-5:5;j(Ee);return}const ie=H.currentTarget.getBoundingClientRect(),We=H.clientX-ie.left,Pe=H.clientY-ie.top,we=H.deltaY>0?.9:1.1,Le=se==="original"?et:Je;Le.zoomAt(We,Pe,we),Se.value&&(se==="original"?Je:et).setTransform(Le.getTransform())}function xn(H,se){if(b.value){const ie=se==="original"?xe.value:pe.value;ie&&M(H,ie);return}if(H.button===1){V.value=!0,_n(H,se),H.preventDefault();return}if(y.value&&H.button===0){_n(H,se),H.preventDefault();return}if(H.button===0){if(H.target.closest(".bubble-highlight-box"))return;H.shiftKey||A(),mt.value=se,(se==="original"?et:Je).startDrag(H.clientX,H.clientY),document.addEventListener("mousemove",Sn),document.addEventListener("mouseup",kn),H.preventDefault()}}function Sn(H){if(!mt.value)return;const se=mt.value==="original"?et:Je;se.drag(H.clientX,H.clientY),Se.value&&(mt.value==="original"?Je:et).setTransform(se.getTransform())}function kn(){mt.value&&(mt.value==="original"?et:Je).endDrag(),mt.value=null,document.removeEventListener("mousemove",Sn),document.removeEventListener("mouseup",kn)}let Nt="translated";function _n(H,se="translated"){Nt=se;const ie=se==="original"?ve.value:$e.value,We=se==="original"?et:Je;if(!ie)return;const Pe=ie.getBoundingClientRect(),we=(H.clientX-Pe.left)/We.scale.value,Le=(H.clientY-Pe.top)/We.scale.value;k.value=we,$.value=Le,P.value=!0,T.value=[we,Le,we,Le],document.addEventListener("mousemove",Wt),document.addEventListener("mouseup",Kt)}function Wt(H){if(!P.value)return;const se=Nt==="original"?ve.value:$e.value,ie=Nt==="original"?et:Je;if(!se)return;const We=se.getBoundingClientRect(),Pe=(H.clientX-We.left)/ie.scale.value,we=(H.clientY-We.top)/ie.scale.value;T.value=[Math.min(k.value,Pe),Math.min($.value,we),Math.max(k.value,Pe),Math.max($.value,we)]}function Kt(H){document.removeEventListener("mousemove",Wt),document.removeEventListener("mouseup",Kt);const se=V.value;if(!P.value||!T.value){P.value=!1,T.value=null,V.value=!1;return}const[ie,We,Pe,we]=T.value,Le=Pe-ie,Ee=we-We;Le>10&&Ee>10&&(a.addBubble(T.value),a.selectBubble(a.bubbleCount-1),console.log("已添加新气泡:",T.value)),P.value=!1,T.value=null,V.value=!1,!se&&y.value&&(y.value=!1)}function Cn(H){console.log(`${H} 图片加载完成`),At.value===1&&ao.value===0&&so.value===0&&ct(()=>{wt()})}function ho(){s()}function yo(H){H.inpaintMethod!==void 0&&(Be.value=H.inpaintMethod),H.fillColor!==void 0&&(q.value=H.fillColor),Re.value>=0&&C(H)}function xo(H){be("文本已应用","success"),s()}function So(H){const se=a.initialStates[H];if(!se){console.warn(`无法重置气泡 #${H+1}：找不到初始状态`),be("无法重置：找不到初始状态","warning");return}const ie=JSON.parse(JSON.stringify(se));a.updateBubble(H,ie),console.log(`气泡 #${H+1} 已重置到初始状态`),be("气泡已重置","success"),s()}async function ko(H){const se=Ae.value[H];if(!se?.originalText){console.warn("无法重新翻译：缺少气泡或原文");return}try{console.log(`开始重新翻译气泡 #${H+1}`);const{translateSingleText:ie}=await at(async()=>{const{translateSingleText:Le}=await Promise.resolve().then(()=>na);return{translateSingleText:Le}},void 0),{useSettingsStore:We}=await at(async()=>{const{useSettingsStore:Le}=await import("./index.D9YoG6bK.js").then(Ee=>Ee.q);return{useSettingsStore:Le}},__vite__mapDeps([0,1,2])),Pe=We().settings,we=await ie({original_text:se.originalText,model_provider:Pe.translation.provider,api_key:Pe.translation.apiKey,model_name:Pe.translation.modelName,custom_base_url:Pe.translation.customBaseUrl,target_language:Pe.targetLanguage,prompt_content:Pe.translatePrompt});we.success&&we.data?.translated_text?(a.updateBubble(H,{translatedText:we.data.translated_text}),console.log(`翻译成功: "${we.data.translated_text}"`),s()):console.error("翻译失败:",we.error||"未知错误")}catch(ie){console.error("翻译出错:",ie)}}function wn(H,se){for(H.bubbleTexts||(H.bubbleTexts=[]),H.originalTexts||(H.originalTexts=[]);H.bubbleTexts.length<se;)H.bubbleTexts.push("");for(;H.originalTexts.length<se;)H.originalTexts.push("")}function $n(H,se,ie){const We=H.auto_directions||[];return H.bubble_coords.map((Pe,we)=>{const Le=Pe[0]??0,Ee=Pe[1]??0,vt=Pe[2]??0,ft=Pe[3]??0;let gt;return We[we]?gt=We[we]==="v"?"vertical":"horizontal":gt=ft-Ee>vt-Le?"vertical":"horizontal",{coords:Pe,originalText:se.originalTexts?.[we]||"",translatedText:se.bubbleTexts?.[we]||"",textboxText:"",fontSize:ie.fontSize,fontFamily:ie.fontFamily,textDirection:gt,autoTextDirection:gt,textColor:ie.textColor,fillColor:ie.fillColor,strokeEnabled:ie.strokeEnabled,strokeColor:ie.strokeColor,strokeWidth:ie.strokeWidth,rotationAngle:H.bubble_angles?.[we]||0,inpaintMethod:ie.inpaintMethod,position:{x:0,y:0},polygon:[]}})}async function _o(){const H=Z.value;if(!H?.originalDataURL){be("没有有效的图片用于检测","warning");return}try{be("正在自动检测文本框...","info");const ie=H.originalDataURL.match(/^data:image\/[^;]+;base64,(.+)$/)?.[1]||"";if(!ie){be("无法解析图片数据","error");return}const We=Ke(),{textDetector:Pe,boxExpand:we,textStyle:Le}=We.settings,Ee=await Qt(ie,Pe,{box_expand_ratio:we.ratio,box_expand_top:we.top,box_expand_bottom:we.bottom,box_expand_left:we.left,box_expand_right:we.right});if(Ee.success&&Ee.bubble_coords){r.updateCurrentImage({bubbleCoords:Ee.bubble_coords,bubbleAngles:Ee.bubble_angles||[]}),wn(H,Ee.bubble_coords.length);const vt={bubble_coords:Ee.bubble_coords.map(gt=>[...gt]),bubble_angles:Ee.bubble_angles,auto_directions:Ee.auto_directions},ft=$n(vt,H,Le);a.setBubbles(ft),Ot(),be(`自动检测到 ${Ee.bubble_coords.length} 个文本框`,"success")}else be(Ee.error||"检测失败","error")}catch(se){console.error("自动检测失败:",se),be("自动检测失败","error")}}async function Co(){if(le.value.length<=1){be("至少需要两张图片才能执行批量检测","warning");return}if(!confirm("此操作将对所有图片进行文本框检测，可能会覆盖已有的检测结果。确定继续吗？"))return;const H=Ke(),{textDetector:se,boxExpand:ie,textStyle:We}=H.settings,Pe=U.value,we=le.value.length;de.value=!0,Ne.value="批量检测中",bt.value=we,Ye.value=0;try{let Le=0;for(let Ee=0;Ee<we;Ee++){const vt=le.value[Ee];if(!vt?.originalDataURL)continue;Ye.value=Ee+1;const gt=vt.originalDataURL.match(/^data:image\/[^;]+;base64,(.+)$/)?.[1]||"";if(!gt)continue;const pt=await Qt(gt,se,{box_expand_ratio:ie.ratio,box_expand_top:ie.top,box_expand_bottom:ie.bottom,box_expand_left:ie.left,box_expand_right:ie.right});if(pt.success&&pt.bubble_coords){const xt=le.value[Ee];if(xt){xt.bubbleCoords=pt.bubble_coords,xt.bubbleAngles=pt.bubble_angles||[],wn(xt,pt.bubble_coords.length);const Ro={bubble_coords:pt.bubble_coords.map(Mo=>[...Mo]),bubble_angles:pt.bubble_angles,auto_directions:pt.auto_directions};xt.bubbleStates=$n(Ro,xt,We),Le+=pt.bubble_coords.length,Ee===U.value&&Ct()}}}Ne.value="检测完成",Ye.value=we,Pe!==U.value&&r.setCurrentImageIndex(Pe),Ct(),be(`批量检测完成！共处理 ${we} 张图片，检测到 ${Le} 个文本框`,"success"),setTimeout(()=>{de.value=!1},2e3)}catch(Le){console.error("批量检测失败:",Le),be("批量检测失败","error"),de.value=!1}}async function wo(){if(!Z.value?.originalDataURL){be("没有有效的图片用于翻译","warning");return}if(Ae.value.length===0){be("没有文本框可用于翻译，请先检测或添加文本框","warning");return}be("正在使用当前文本框翻译...","info");try{await o()&&(be("翻译成功！","success"),Ot())}catch(se){console.error("翻译失败:",se),be(`翻译失败: ${se instanceof Error?se.message:"未知错误"}`,"error")}}function $o(){_("repair")}function To(){_("restore")}function Tn(H){ae(H)}function In(){L()}function Io(H){Ft.value=!0,uo.value=Ie.value==="horizontal"?H.clientX:H.clientY,document.body.style.cursor=Ie.value==="horizontal"?"col-resize":"row-resize",document.body.style.userSelect="none",document.addEventListener("mousemove",qt),document.addEventListener("mouseup",Ht),H.preventDefault()}function qt(H){if(!Ft.value)return;const se=xe.value?.parentElement?.parentElement;if(!se)return;const ie=se.getBoundingClientRect();if(Ie.value==="horizontal"){const We=H.clientX-ie.left,Pe=ie.width,we=Math.max(20,Math.min(80,We/Pe*100)),Le=se.querySelector(".original-panel"),Ee=se.querySelector(".translated-panel");Le&&Ee&&(Le.style.flex=`0 0 ${we}%`,Ee.style.flex=`0 0 ${100-we}%`)}else{const We=H.clientY-ie.top,Pe=ie.height,we=Math.max(20,Math.min(80,We/Pe*100)),Le=se.querySelector(".original-panel"),Ee=se.querySelector(".translated-panel");Le&&Ee&&(Le.style.flex=`0 0 ${we}%`,Ee.style.flex=`0 0 ${100-we}%`)}}function Ht(){Ft.value=!1,document.body.style.cursor="",document.body.style.userSelect="",document.removeEventListener("mousemove",qt),document.removeEventListener("mouseup",Ht)}function Do(H){Lt.value=!0;const se=ke.value;se&&(_t.value={x:H.clientX,y:H.clientY,size:Ie.value==="horizontal"?se.offsetWidth:se.offsetHeight},document.body.style.cursor=Ie.value==="horizontal"?"ew-resize":"ns-resize",document.body.style.userSelect="none",document.addEventListener("mousemove",Yt),document.addEventListener("mouseup",Jt),H.preventDefault())}function Yt(H){if(!(!Lt.value||!ke.value))if(Ie.value==="horizontal"){const se=_t.value.x-H.clientX;let ie=_t.value.size+se;ie=Math.max(300,Math.min(window.innerWidth*.6,ie)),ke.value.style.flex=`0 0 ${ie}px`,ke.value.style.minWidth=`${ie}px`}else{const se=_t.value.y-H.clientY;let ie=_t.value.size+se;ie=Math.max(200,Math.min(window.innerHeight*.5,ie)),ke.value.style.flex=`0 0 ${ie}px`,ke.value.style.height=`${ie}px`}}function Jt(){Lt.value=!1,document.body.style.cursor="",document.body.style.userSelect="",document.removeEventListener("mousemove",Yt),document.removeEventListener("mouseup",Jt)}function Dn(H){const se=H.target,ie=H.key.toLowerCase();if(ie==="r"||ie==="u"||ie==="a"||ie==="d"){if(se.tagName==="TEXTAREA")return;(se.tagName==="INPUT"||se.tagName==="SELECT"||se.tagName==="BUTTON")&&se.blur()}else if(se.tagName==="INPUT"||se.tagName==="TEXTAREA"||se.tagName==="SELECT")return;switch(H.key){case"Escape":Bn();break;case"Delete":case"Backspace":!b.value&&Q.value&&(w(),H.preventDefault());break;case"a":case"A":b.value||(hn(),H.preventDefault());break;case"d":case"D":b.value||(zt(),H.preventDefault());break;case"Enter":H.ctrlKey&&!b.value&&(Mn(),H.preventDefault());break;case"r":case"R":x.value||(_("repair"),H.preventDefault());break;case"u":case"U":x.value||(_("restore"),H.preventDefault());break;case"+":case"=":vn(),H.preventDefault();break;case"-":mn(),H.preventDefault();break;case"0":fn(),H.preventDefault();break}}function Rn(H){(H.key==="r"||H.key==="R"||H.key==="u"||H.key==="U")&&(d(),H.preventDefault())}async function Mn(){Vt(),await s(),_e.value?zt():be("已是最后一张图片","info")}function Bn(){Vt(),t("exit")}return ut(()=>{try{const H=localStorage.getItem(On);(H==="horizontal"||H==="vertical")&&(Ie.value=H)}catch(H){console.warn("加载布局模式失败:",H)}document.addEventListener("keydown",Dn),document.addEventListener("keyup",Rn),document.addEventListener("mousemove",Tn),document.addEventListener("mouseup",In),u.isEditModeActive&&(Ct(),ct(()=>{he.value?.focus()}))}),Tt(()=>{document.removeEventListener("keydown",Dn),document.removeEventListener("keyup",Rn),document.removeEventListener("mousemove",Tn),document.removeEventListener("mouseup",In),document.removeEventListener("mousemove",Wt),document.removeEventListener("mouseup",Kt),document.removeEventListener("mousemove",qt),document.removeEventListener("mouseup",Ht),document.removeEventListener("mousemove",Yt),document.removeEventListener("mouseup",Jt)}),ye(()=>u.isEditModeActive,H=>{H&&(Ct(),ct(()=>{he.value?.focus()}))}),ye(U,()=>{u.isEditModeActive&&Ct()}),ye(z,H=>{H&&(Be.value=H.inpaintMethod||"solid",q.value=H.fillColor||"#FFFFFF")},{immediate:!0}),(H,se)=>n.isEditModeActive?(K(),G("div",{key:0,class:De(["edit-workspace",[`layout-${Ie.value}`,{"drawing-mode":re(y)}]]),tabindex:"0",ref_key:"workspaceRef",ref:he},[me(Fp,{"current-image-index":re(U),"image-count":re(ce),"can-go-previous":re(Te),"can-go-next":re(_e),"show-thumbnails":je.value,"has-bubbles":re(ee),"selected-bubble-index":re(Re),"bubble-count":re(I),"layout-mode":Ie.value,"sync-enabled":Se.value,scale:At.value,"is-drawing-mode":re(y),"has-selection":re(Q),"brush-mode":re(b),"brush-size":re(h),"mouse-x":re(Y),"mouse-y":re(W),"is-processing":de.value,"progress-text":Ne.value,"progress-current":Ye.value,"progress-total":bt.value,onGoPreviousImage:hn,onGoNextImage:zt,onToggleThumbnails:bo,onSelectPreviousBubble:go,onSelectNextBubble:po,onToggleLayout:vo,onToggleViewMode:mo,onToggleSync:fo,onFitToScreen:wt,onZoomIn:vn,onZoomOut:mn,onResetZoom:fn,onExitEditMode:Bn,onAutoDetectBubbles:_o,onDetectAllImages:Co,onTranslateWithBubbles:wo,onToggleDrawingMode:re(E),onDeleteSelectedBubbles:re(w),onRepairSelectedBubble:re(m),onActivateRepairBrush:$o,onActivateRestoreBrush:To,onApplyAndNext:Mn},null,8,["current-image-index","image-count","can-go-previous","can-go-next","show-thumbnails","has-bubbles","selected-bubble-index","bubble-count","layout-mode","sync-enabled","scale","is-drawing-mode","has-selection","brush-mode","brush-size","mouse-x","mouse-y","is-processing","progress-text","progress-current","progress-total","onToggleDrawingMode","onDeleteSelectedBubbles","onRepairSelectedBubble"]),me(Wp,{visible:je.value,images:re(le),"current-image-index":re(U),onSwitchToImage:co},null,8,["visible","images","current-image-index"]),e("div",Kp,[e("div",qp,[oe(e("div",{class:De(["image-panel original-panel",{collapsed:Fe.value==="translated"||nt.value}])},[e("div",Hp,[se[8]||(se[8]=e("span",{class:"panel-title"},"📖 原图 (日文)",-1)),e("button",{class:"panel-toggle",onClick:se[0]||(se[0]=ie=>nt.value=!nt.value),title:"折叠/展开"},ue(nt.value?"+":"−"),1)]),e("div",{ref_key:"originalViewportRef",ref:xe,class:"image-viewport",onWheel:se[2]||(se[2]=tt(ie=>yn(ie,"original"),["prevent"])),onMousedown:se[3]||(se[3]=ie=>xn(ie,"original")),onDblclick:wt},[e("div",{ref_key:"originalWrapperRef",ref:ve,class:"image-canvas-wrapper",style:st(io.value)},[re(Z)?.originalDataURL?(K(),G("img",{key:0,src:re(Z).originalDataURL,alt:"原图",onLoad:se[1]||(se[1]=ie=>Cn("original"))},null,40,Yp)):fe("",!0),re(Z)?.originalDataURL?(K(),it(Hn,{key:1,bubbles:re(Ae),"selected-index":re(Re),"selected-indices":re(Me),scale:lo.value,"is-drawing-mode":re(y),"is-brush-mode":!!re(b),"image-width":ne.value,"image-height":ge.value,onSelect:re(X),onMultiSelect:re(J),onDragStart:re(f),onDragging:re(D),onDragEnd:re(B),onResizeStart:re(F),onResizing:re(i),onResizeEnd:re(l),onRotateStart:re(v),onRotating:re(p),onRotateEnd:re(R),onDrawBubble:re(N)},null,8,["bubbles","selected-index","selected-indices","scale","is-drawing-mode","is-brush-mode","image-width","image-height","onSelect","onMultiSelect","onDragStart","onDragging","onDragEnd","onResizeStart","onResizing","onResizeEnd","onRotateStart","onRotating","onRotateEnd","onDrawBubble"])):fe("",!0),re(T)?(K(),G("div",{key:2,class:"drawing-rect-edit",style:st(re(O)())},null,4)):fe("",!0)],4)],544)],2),[[ze,Fe.value!=="translated"]]),Fe.value==="dual"?(K(),G("div",{key:0,class:De(["panel-divider",{"vertical-divider":Ie.value==="vertical"}]),onMousedown:Io},null,34)):fe("",!0),oe(e("div",{class:De(["image-panel translated-panel",{collapsed:Fe.value==="original"||lt.value}])},[e("div",Jp,[se[9]||(se[9]=e("span",{class:"panel-title"},"📝 翻译图 (中文)",-1)),e("button",{class:"panel-toggle",onClick:se[4]||(se[4]=ie=>lt.value=!lt.value),title:"折叠/展开"},ue(lt.value?"+":"−"),1)]),e("div",{ref_key:"translatedViewportRef",ref:pe,class:"image-viewport",onWheel:se[6]||(se[6]=tt(ie=>yn(ie,"translated"),["prevent"])),onMousedown:se[7]||(se[7]=ie=>xn(ie,"translated")),onDblclick:wt},[e("div",{ref_key:"translatedWrapperRef",ref:$e,class:"image-canvas-wrapper",style:st(ro.value)},[re(Z)?.translatedDataURL||re(Z)?.originalDataURL?(K(),G("img",{key:0,src:re(Z)?.translatedDataURL||re(Z)?.originalDataURL,alt:"翻译图",onLoad:se[5]||(se[5]=ie=>Cn("translated"))},null,40,Xp)):fe("",!0),re(Z)?.translatedDataURL||re(Z)?.originalDataURL?(K(),it(Hn,{key:1,bubbles:re(Ae),"selected-index":re(Re),"selected-indices":re(Me),scale:At.value,"is-drawing-mode":re(y),"is-brush-mode":!!re(b),"image-width":ne.value,"image-height":ge.value,onSelect:re(X),onMultiSelect:re(J),onDragStart:re(f),onDragging:re(D),onDragEnd:re(B),onResizeStart:re(F),onResizing:re(i),onResizeEnd:re(l),onRotateStart:re(v),onRotating:re(p),onRotateEnd:re(R),onDrawBubble:re(N)},null,8,["bubbles","selected-index","selected-indices","scale","is-drawing-mode","is-brush-mode","image-width","image-height","onSelect","onMultiSelect","onDragStart","onDragging","onDragEnd","onResizeStart","onResizing","onResizeEnd","onRotateStart","onRotating","onRotateEnd","onDrawBubble"])):fe("",!0),re(T)?(K(),G("div",{key:2,class:"drawing-rect-edit translated-drawing-rect",style:st(re(O)())},null,4)):fe("",!0)],4)],544)],2),[[ze,Fe.value!=="original"]])]),e("div",{ref_key:"editPanelRef",ref:ke,class:"edit-panel-container"},[e("div",{class:"panel-resize-handle vertical",onMousedown:Do}," ⋮⋮⋮ ",32),me(rp,{bubble:re(z),"bubble-index":re(Re),onUpdate:yo,onReRender:ho,onOcrRecognize:re(g),onReTranslate:ko,onApplyBubble:xo,onResetCurrent:So},null,8,["bubble","bubble-index","onOcrRecognize"])],512)])],2)):fe("",!0)}}),Gp=qe(jp,[["__scopeId","data-v-0916fb0e"]]),Zp={class:"app-header"},Qp={class:"header-content"},eb={class:"logo-container"},tb={class:"header-links"},nb={class:"container"},ob={id:"image-display-area"},ab={id:"upload-section",class:"card upload-card"},sb={key:1,class:"bookshelf-mode-hint"},lb=He({__name:"TranslateView",setup(n){const c=Jn(),u=Qe(),t=Ke(),r=Qn(),a=dt(),{validateBeforeTranslation:o,initValidation:s}=Pt(),y=bn(),P=gl(),T=S(!1),V=S(void 0),X=S(!1),J=S(!1),A=S(null),f=S(null),D=te(()=>u.currentImage),B=te(()=>u.hasImages);te(()=>u.imageCount),te(()=>u.currentImageIndex+1),te(()=>B.value&&!u.isBatchTranslationInProgress),te(()=>u.canGoPrevious),te(()=>u.canGoNext);const F=te(()=>u.isBatchTranslationInProgress);te(()=>u.isBatchTranslationPaused);const i=te(()=>F.value&&!y.isHqTranslating.value&&!y.isProofreading.value);te(()=>{if(!F.value)return 0;const z=u.completedImageCount,I=u.imageCount;return I>0?Math.round(z/I*100):0}),te(()=>`${u.completedImageCount}/${u.imageCount}`);const l=te(()=>u.failedImageCount>0),v=te(()=>!!c.query.book&&!!c.query.chapter),p=te(()=>c.query.book),R=te(()=>c.query.chapter),E=te(()=>P.currentBookTitle.value),N=te(()=>P.currentChapterTitle.value),O=te(()=>v.value&&N.value&&E.value?`${N.value} - ${E.value}`:"Saber-Translator");ut(async()=>{u.clearImages(),a.clearBubbles(),await P.initializeApp(),s(),window.addEventListener("keydown",_e)}),Tt(()=>{window.removeEventListener("keydown",_e)}),ye(()=>[c.query.book,c.query.chapter],async([z,I],[ee,Q])=>{z&&I?(u.clearImages(),a.clearBubbles(),await C()):ee&&Q&&!z&&!I&&(u.clearImages(),a.clearBubbles(),await P.initializeBookChapterContext(),console.log("[TranslateView] 从书架模式切换到快速翻译模式，已清空数据"))}),ye(O,z=>{typeof document<"u"&&(document.title=z)},{immediate:!0});async function C(){if(!(!p.value||!R.value))try{await P.initializeBookChapterContext()}catch(z){console.error("加载章节会话失败:",z),be("加载章节会话失败","error")}}function w(z){console.log(`上传完成，共 ${z} 张图片`),u.hasImages&&(u.sortImagesByFileName(),P.switchImage(0))}async function m(z){const I=D.value;if(!I||!I.bubbleStates||I.bubbleStates.length===0){be("请先选择一张已翻译的图片","warning");return}if(u.images.length<=1){be("只有一张图片，无需应用到全部","info");return}if(!Object.values(z).some(Q=>Q)){be("请至少选择一个要应用的设置项","warning");return}try{const Q=I.bubbleStates[0],ne={};z.fontSize&&(ne.fontSize=Q.fontSize),z.fontFamily&&(ne.fontFamily=Q.fontFamily),z.layoutDirection&&(ne.textDirection=Q.textDirection==="auto"?"vertical":Q.textDirection),z.textColor&&(ne.textColor=Q.textColor),z.fillColor&&(ne.fillColor=Q.fillColor),z.strokeEnabled&&(ne.strokeEnabled=Q.strokeEnabled),z.strokeColor&&(ne.strokeColor=Q.strokeColor),z.strokeWidth&&(ne.strokeWidth=Q.strokeWidth);const ge=$e=>{const ke={...$e};return z.fontSize&&ne.fontSize!==void 0&&(ke.fontSize=ne.fontSize),z.fontFamily&&ne.fontFamily!==void 0&&(ke.fontFamily=ne.fontFamily),z.layoutDirection&&ne.textDirection!==void 0&&(ke.textDirection=ne.textDirection),z.textColor&&ne.textColor!==void 0&&(ke.textColor=ne.textColor),z.fillColor&&ne.fillColor!==void 0&&(ke.fillColor=ne.fillColor),z.strokeEnabled&&ne.strokeEnabled!==void 0&&(ke.strokeEnabled=ne.strokeEnabled),z.strokeColor&&ne.strokeColor!==void 0&&(ke.strokeColor=ne.strokeColor),z.strokeWidth&&ne.strokeWidth!==void 0&&(ke.strokeWidth=ne.strokeWidth),ke};let he=0;const xe=u.images;for(let $e=0;$e<xe.length;$e++){const ke=xe[$e];if(ke&&ke.bubbleStates&&ke.bubbleStates.length>0){const Fe=ke.bubbleStates.map(ge);u.updateImageByIndex($e,{bubbleStates:Fe}),he++}}if(a.bubbles.length>0){const $e=a.bubbles.map(ge);a.setBubbles($e)}const ve=[];z.fontSize&&ve.push("字号"),z.fontFamily&&ve.push("字体"),z.layoutDirection&&ve.push("排版方向"),z.textColor&&ve.push("文字颜色"),z.fillColor&&ve.push("填充颜色"),z.strokeEnabled&&ve.push("描边开关"),z.strokeColor&&ve.push("描边颜色"),z.strokeWidth&&ve.push("描边宽度");const pe=[];for(let $e=0;$e<xe.length;$e++){const ke=xe[$e];ke&&ke.translatedDataURL&&ke.bubbleStates&&ke.bubbleStates.length>0&&pe.push($e)}if(pe.length>0){const{apiClient:$e}=await at(async()=>{const{apiClient:Ie}=await import("./client.Bht704G-.js");return{apiClient:Ie}},__vite__mapDeps([4,5])),ke=t.settings.textStyle.layoutDirection,Fe=ke==="auto";for(let Ie=0;Ie<pe.length;Ie++){const je=pe[Ie];if(je===void 0)continue;const Se=u.images[je];if(!(!Se||!Se.bubbleStates))try{let nt="";if(Se.cleanImageData?nt=Se.cleanImageData.includes("base64,")?Se.cleanImageData.split("base64,")[1]||"":Se.cleanImageData:Se.originalDataURL&&(nt=Se.originalDataURL.includes("base64,")?Se.originalDataURL.split("base64,")[1]||"":Se.originalDataURL,console.log(`handleApplyToAll: 图片 ${je} 使用原图作为背景（兜底）`)),!nt){console.log(`handleApplyToAll: 图片 ${je} 没有可用的背景图，跳过`);continue}const lt=Se.bubbleStates.map(q=>({translatedText:q.translatedText||"",coords:q.coords,fontSize:q.fontSize||t.settings.textStyle.fontSize,fontFamily:q.fontFamily||t.settings.textStyle.fontFamily,textDirection:kt(q),textColor:q.textColor||t.settings.textStyle.textColor,rotationAngle:q.rotationAngle||0,position:q.position||{x:0,y:0},strokeEnabled:q.strokeEnabled??t.settings.textStyle.strokeEnabled,strokeColor:q.strokeColor||t.settings.textStyle.strokeColor,strokeWidth:q.strokeWidth??t.settings.textStyle.strokeWidth})),Be=await $e.post("/api/re_render_image",{clean_image:nt,bubble_texts:lt.map(q=>q.translatedText),bubble_coords:lt.map(q=>q.coords),fontSize:t.settings.textStyle.fontSize,fontFamily:t.settings.textStyle.fontFamily,textDirection:Fe?"vertical":ke,textColor:t.settings.textStyle.textColor,bubble_states:lt,use_individual_styles:!0,use_inpainting:!1,use_lama:!1,fillColor:null,is_font_style_change:!0,strokeEnabled:t.settings.textStyle.strokeEnabled,strokeColor:t.settings.textStyle.strokeColor,strokeWidth:t.settings.textStyle.strokeWidth});Be.rendered_image&&u.updateImageByIndex(je,{translatedDataURL:`data:image/png;base64,${Be.rendered_image}`,hasUnsavedChanges:!0})}catch(nt){console.error(`重渲染图片 ${je} 失败:`,nt)}}}be(`已将 ${ve.join("、")} 应用到 ${he} 张图片`,"success"),console.log(`[TranslateView] 应用设置到全部完成，更新了 ${he} 张图片，重渲染了 ${pe.length} 张`)}catch(Q){console.error("应用设置到全部失败:",Q),be("应用设置失败","error")}}async function g(){D.value&&o("normal")&&await y.translateCurrentImage()}async function k(){B.value&&o("normal")&&await y.translateAllImages()}async function $(){B.value&&o("hq")&&await y.executeHqTranslation()}async function b(){B.value&&o("proofread")&&await y.executeProofreading()}async function h(){D.value&&await y.removeTextOnly()}async function Y(){B.value&&await y.removeAllTexts()}function W(){if(!D.value)return;const z=D.value.fileName||`图片 ${u.currentImageIndex+1}`;confirm(`确定要删除当前图片 (${z}) 吗？`)&&(u.deleteCurrentImage(),be("图片已删除","success"))}function x(){B.value&&confirm("确定要清除所有图片吗？这将丢失所有未保存的进度。")&&(u.clearImages(),be("所有图片已清除","success"))}async function _(){try{const z=await Xn(),I=await rn();if(z.success&&I.success)be("临时文件清理完成","success");else{const ee=[];z.success||ee.push("调试文件清理失败"),I.success||ee.push("临时文件清理失败"),be(ee.join("，"),"warning")}}catch{be("清理临时文件失败","error")}}function d(){P.goToPrevious()}function M(){P.goToNext()}function ae(){J.value=!J.value}async function L(){if(!l.value){be("没有失败的图片需要重新翻译","info");return}o("normal")&&await y.retryFailedImages()}async function j(){if(!B.value){be("没有可保存的内容","warning");return}if(!(!p.value||!R.value))try{await r.saveChapterSession(p.value,R.value)?be("章节进度已保存","success"):be("保存失败","error")}catch(z){console.error("保存会话失败:",z),be("保存失败: "+(z instanceof Error?z.message:"未知错误"),"error")}}function le(z){V.value=z,T.value=!0}function U(){le("plugins")}function Z(){be("设置已保存","success")}function ce(){X.value=!0}function Te(){be("🌙 该功能正在开发中，敬请期待！","info")}function _e(z){const I=z.target;if(!(I instanceof HTMLInputElement||I instanceof HTMLTextAreaElement||I.getAttribute("contenteditable")==="true"||I.id==="bubbleTextEditor")&&!J.value&&z.altKey)switch(z.key){case"ArrowLeft":z.preventDefault(),d();break;case"ArrowRight":z.preventDefault(),M();break;case"ArrowUp":if(z.preventDefault(),!t.settings.textStyle.autoFontSize){const Q=t.settings.textStyle.fontSize;t.updateTextStyle({fontSize:Q+1})}break;case"ArrowDown":if(z.preventDefault(),!t.settings.textStyle.autoFontSize){const Q=t.settings.textStyle.fontSize;t.updateTextStyle({fontSize:Math.max(10,Q-1)})}break}}async function Ae(z){const I=D.value;if(!I||!I.translatedDataURL){console.log(`自动字号设置变更: ${z} (仅影响下次翻译)`);return}const ee=I.bubbleStates;if(!ee||!Array.isArray(ee)||ee.length===0){console.log("当前图片没有 bubbleStates，跳过重渲染");return}if(console.log(`自动字号设置变更: ${z}，将重新渲染...`),z){console.log("自动字号已开启，重新计算字号并渲染...");try{const{apiClient:Q}=await at(async()=>{const{apiClient:pe}=await import("./client.Bht704G-.js");return{apiClient:pe}},__vite__mapDeps([4,5]));let ne="";if(I.cleanImageData){const pe=I.cleanImageData;ne=pe.includes("base64,")?pe.split("base64,")[1]||"":pe}else I.originalDataURL&&(ne=I.originalDataURL.includes("base64,")?I.originalDataURL.split("base64,")[1]||"":I.originalDataURL);if(!ne){console.log("没有可用的背景图，跳过重渲染");return}const ge=ee.map(pe=>({translatedText:pe.translatedText||"",coords:pe.coords,fontSize:pe.fontSize||t.settings.textStyle.fontSize,fontFamily:pe.fontFamily||t.settings.textStyle.fontFamily,textDirection:kt(pe),textColor:pe.textColor||t.settings.textStyle.textColor,rotationAngle:pe.rotationAngle||0,position:pe.position||{x:0,y:0},strokeEnabled:pe.strokeEnabled??t.settings.textStyle.strokeEnabled,strokeColor:pe.strokeColor||t.settings.textStyle.strokeColor,strokeWidth:pe.strokeWidth??t.settings.textStyle.strokeWidth})),he=ge.map(pe=>pe.translatedText),xe=ge.map(pe=>pe.coords),ve=await Q.post("/api/re_render_image",{clean_image:ne,bubble_texts:he,bubble_coords:xe,fontSize:t.settings.textStyle.fontSize,fontFamily:t.settings.textStyle.fontFamily,textDirection:t.settings.textStyle.layoutDirection==="auto"?"vertical":t.settings.textStyle.layoutDirection,textColor:t.settings.textStyle.textColor,bubble_states:ge,use_individual_styles:!0,use_inpainting:!1,use_lama:!1,fillColor:null,is_font_style_change:!0,autoFontSize:!0,strokeEnabled:t.settings.textStyle.strokeEnabled,strokeColor:t.settings.textStyle.strokeColor,strokeWidth:t.settings.textStyle.strokeWidth});if(ve.rendered_image){if(ve.bubble_states&&Array.isArray(ve.bubble_states)){const pe=ee.map(($e,ke)=>({...$e,fontSize:ve.bubble_states[ke]?.fontSize??$e.fontSize}));u.updateCurrentImage({translatedDataURL:`data:image/png;base64,${ve.rendered_image}`,bubbleStates:pe,hasUnsavedChanges:!0}),a.setBubbles(pe)}else u.updateCurrentImage({translatedDataURL:`data:image/png;base64,${ve.rendered_image}`,hasUnsavedChanges:!0});console.log("自动字号渲染成功")}else ve.error&&(console.error("自动字号渲染失败:",ve.error),be("重新渲染失败: "+ve.error,"error"))}catch(Q){console.error("自动字号渲染出错:",Q)}}else{const Q=t.settings.textStyle.fontSize;console.log(`自动字号已关闭，使用固定字号 ${Q} 渲染...`);const ne=ee.map(ge=>({...ge,fontSize:Q}));u.updateCurrentImage({bubbleStates:ne}),a.setBubbles(ne),await Re("fontSize",Q)}}async function Re(z,I){const ee=D.value;if(!ee||!ee.translatedDataURL||!ee.bubbleStates||ee.bubbleStates.length===0||!["fontSize","fontFamily","layoutDirection","textColor","strokeEnabled","strokeColor","strokeWidth","fillColor"].includes(z))return;console.log(`全局设置变更 (${z}=${I})，准备重渲染...`);const ge={fontSize:"fontSize",fontFamily:"fontFamily",layoutDirection:"textDirection",textColor:"textColor",strokeEnabled:"strokeEnabled",strokeColor:"strokeColor",strokeWidth:"strokeWidth",fillColor:"fillColor"}[z];if(ge&&ee.bubbleStates)if(z==="layoutDirection"&&I==="auto")console.log("排版方向设置为 'auto'，不修改气泡的 textDirection，使用 autoTextDirection 渲染");else{const he=ee.bubbleStates.map(xe=>({...xe,[ge]:I}));u.updateCurrentImage({bubbleStates:he}),a.setBubbles(he)}try{const xe=u.currentImage?.bubbleStates||ee.bubbleStates||[];if(xe.length===0||!xe[0]?.coords){console.log("没有有效的气泡坐标，跳过重渲染");return}const ve=t.settings.textStyle.layoutDirection,pe=xe.map(Se=>({translatedText:Se.translatedText||"",coords:Se.coords,fontSize:Se.fontSize||t.settings.textStyle.fontSize,fontFamily:Se.fontFamily||t.settings.textStyle.fontFamily,textDirection:kt(Se),textColor:Se.textColor||t.settings.textStyle.textColor,rotationAngle:Se.rotationAngle||0,position:Se.position||{x:0,y:0},strokeEnabled:Se.strokeEnabled??t.settings.textStyle.strokeEnabled,strokeColor:Se.strokeColor||t.settings.textStyle.strokeColor,strokeWidth:Se.strokeWidth??t.settings.textStyle.strokeWidth})),$e=pe.map(Se=>Se.translatedText),ke=pe.map(Se=>Se.coords);let Fe="";if(ee.cleanImageData){const Se=ee.cleanImageData;Fe=Se.includes("base64,")?Se.split("base64,")[1]||"":Se}else ee.originalDataURL&&(Fe=ee.originalDataURL.includes("base64,")?ee.originalDataURL.split("base64,")[1]||"":ee.originalDataURL,console.log("handleTextStyleChanged: 使用原图作为背景（兜底）"));if(!Fe){console.log("没有可用的背景图，跳过重渲染");return}const{apiClient:Ie}=await at(async()=>{const{apiClient:Se}=await import("./client.Bht704G-.js");return{apiClient:Se}},__vite__mapDeps([4,5])),je=await Ie.post("/api/re_render_image",{clean_image:Fe,bubble_texts:$e,bubble_coords:ke,fontSize:t.settings.textStyle.fontSize,fontFamily:t.settings.textStyle.fontFamily,textDirection:ve==="auto"?"vertical":ve,textColor:t.settings.textStyle.textColor,bubble_states:pe,use_individual_styles:!0,use_inpainting:!1,use_lama:!1,fillColor:null,is_font_style_change:!0,strokeEnabled:t.settings.textStyle.strokeEnabled,strokeColor:t.settings.textStyle.strokeColor,strokeWidth:t.settings.textStyle.strokeWidth});je.rendered_image?(u.updateCurrentImage({translatedDataURL:`data:image/png;base64,${je.rendered_image}`,hasUnsavedChanges:!0}),console.log("设置变更后重新渲染成功")):je.error&&console.error("重新渲染失败:",je.error)}catch(he){console.error("设置变更后重新渲染失败:",he)}}function Me(z){P.switchImage(z)}return(z,I)=>{const ee=Oo("router-link");return K(),G("div",{class:De(["translate-page",{"edit-mode-active":J.value}])},[e("header",Zp,[e("div",Qp,[e("div",eb,[me(ee,{to:"/",title:"返回书架"},{default:ht(()=>[...I[3]||(I[3]=[e("img",{src:"/pic/logo.png",alt:"Saber-Translator Logo",class:"app-logo"},null,-1),e("span",{class:"app-name"},"Saber-Translator",-1)])]),_:1})]),e("div",tb,[me(ee,{to:"/",class:"back-to-shelf",title:"返回书架"},{default:ht(()=>[...I[4]||(I[4]=[Ue("📚",-1)])]),_:1}),v.value?(K(),G("button",{key:0,class:"save-header-btn",title:"保存进度",onClick:j}," 💾 ")):fe("",!0),e("button",{id:"openSettingsBtn",class:"settings-header-btn",title:"打开设置",onClick:I[0]||(I[0]=Q=>le())},[...I[5]||(I[5]=[e("span",{class:"icon"},"⚙️",-1),e("span",null,"设置",-1)])]),I[8]||(I[8]=e("a",{href:"http://www.mashirosaber.top",target:"_blank",class:"tutorial-link"},"使用教程",-1)),e("a",{href:"javascript:void(0)",class:"donate-link",onClick:ce},[...I[6]||(I[6]=[e("span",null,"❤️ 请作者喝奶茶",-1)])]),I[9]||(I[9]=e("a",{href:"https://github.com/MashiroSaber03",target:"_blank",class:"github-link"},[e("img",{src:"/pic/github.jpg",alt:"GitHub",class:"github-icon"})],-1)),e("button",{class:"theme-toggle",title:"功能开发中",onClick:Te},[...I[7]||(I[7]=[e("span",{class:"theme-icon"},"☀️",-1)])])])])]),e("div",nb,[me(Cs,{onTranslateCurrent:g,onTranslateAll:k,onHqTranslate:$,onProofread:b,onRemoveText:h,onRemoveAllText:Y,onRetryFailed:L,onDeleteCurrent:W,onClearAll:x,onCleanTemp:_,onOpenPlugins:U,onOpenSettings:le,onPrevious:d,onNext:M,onApplyToAll:m,onTextStyleChanged:Re,onAutoFontSizeChanged:Ae}),e("main",ob,[e("section",ab,[me($a,{ref_key:"imageUploadRef",ref:A,onUploadComplete:w},null,512),re(r).loadingProgress.total>0?(K(),it(gn,{key:0,visible:!0,percentage:re(r).loadingProgress.current/re(r).loadingProgress.total*100,label:re(r).loadingProgress.message},null,8,["percentage","label"])):fe("",!0),me(xl,{progress:re(y).progress.value,"show-controls":i.value},null,8,["progress","show-controls"]),F.value&&v.value?(K(),G("div",sb,[...I[10]||(I[10]=[e("span",{style:{color:"#888","font-size":"0.85em"}}," （书架模式下退出前请点击顶部保存按钮） ",-1)])])):fe("",!0)]),me(Ys,{ref_key:"imageResultRef",ref:f,"is-edit-mode":J.value,onToggleEditMode:ae,onRetryFailed:L},null,8,["is-edit-mode"])]),B.value&&!J.value?(K(),it(Bl,{key:0,onSelect:Me})):fe("",!0)]),D.value&&J.value?(K(),it(Gp,{key:0,"is-edit-mode-active":J.value,onExit:ae},null,8,["is-edit-mode-active"])):fe("",!0),me(Zs,{onOpenSettings:le}),me(Kd,{modelValue:T.value,"onUpdate:modelValue":I[1]||(I[1]=Q=>T.value=Q),"initial-tab":V.value,onSave:Z},null,8,["modelValue","initial-tab"]),X.value?(K(),it(kl,{key:1,onClose:I[2]||(I[2]=Q=>X.value=!1)})):fe("",!0)],2)}}}),mb=qe(lb,[["__scopeId","data-v-578fd182"]]);export{mb as default};
