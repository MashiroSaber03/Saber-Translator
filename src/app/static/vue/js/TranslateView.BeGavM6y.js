const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["js/system.DJNGJ5SO.js","js/index.0QwM5c-h.js","js/vue-vendor.DIYfje1l.js","assets/index.BYanE9pL.css","js/client.Bht704G-.js","js/utils-vendor.B9ygI19o.js","js/session.Kpy-QhBa.js"])))=>i.map(i=>d[i]);
import{D as en,b as so,c as ao,d as lo,e as tn,a as lt,S as Mo,_ as je,f as Ue,s as fe,u as rt,g as qn,h as Hn,i as Eo,j as Bo,k as Ao,l as Lo,B as Fo,m as Uo,n as jn,F as Zt,o as Oo,p as zo,q as Jn,L as No,W as Gn}from"./index.0QwM5c-h.js";import{d as Ft,r as _,c as q,a as Je,e as E,h as ge,f as e,t as oe,i as ot,k as R,g as st,n as Te,u as Ce,o as ut,v as ne,x as Fe,l as ye,s as Vo,m as yt,K as et,D as K,F as Be,j as He,M as io,N as Yn,L as on,w as xe,B as dt,O as kt,z as Se,p as tt,P as oo,b as Dt,Q as xt,S as Wo,A as Xn,U as Zn,T as Qn,C as es}from"./vue-vendor.DIYfje1l.js";import{p as ts,a as os,b as ns,c as ss,d as as,e as ls,f as is,h as rs,i as us,j as cs,k as ro,l as nn}from"./system.DJNGJ5SO.js";import{getFontList as sn,uploadFont as ds,getTextboxPrompts as gs,getPrompts as ps,configApi as We,getFontListApi as ms}from"./config.CwRcCkM9.js";import{_ as Ne}from"./CustomSelect.vue_vue_type_style_index_0_lang.BbTiIb--.js";import{apiClient as Ze}from"./client.Bht704G-.js";import{B as an}from"./BaseModal.CKbWNK6E.js";import{getBookDetail as vs}from"./bookshelf.B4ums9uK.js";import"./utils-vendor.B9ygI19o.js";function Ko(){return{firecrawl:{apiKey:""},agent:{provider:"openai",apiKey:"",customBaseUrl:"",modelName:"gpt-4o-mini",useStream:!1,forceJsonOutput:!0,maxRetries:3,timeout:120},extraction:{prompt:en,maxIterations:10},download:{concurrency:3,timeout:30,retries:3,delay:100,useReferer:!0},imagePreprocess:{enabled:!1,autoRotate:!0,compression:{enabled:!1,quality:85,maxWidth:0,maxHeight:0},formatConvert:{enabled:!1,targetFormat:"original"}},advanced:{customCookie:"",customHeaders:"",bypassProxy:!1},ui:{showAgentLogs:!0,autoImport:!1}}}function fs(s,t){function n(b){s.value.firecrawl.apiKey=b,t()}function o(b){s.value.agent.provider=b,t()}function l(b){s.value.agent.apiKey=b,t()}function i(b){s.value.agent.customBaseUrl=b,t()}function a(b){s.value.agent.modelName=b,t()}function r(b){s.value.agent.useStream=b,t()}function h(b){s.value.agent.forceJsonOutput=b,t()}function T(b){s.value.agent.timeout=b,t()}function S(b){s.value.extraction.prompt=b,t()}function D(b){s.value.extraction.maxIterations=b,t()}function B(){s.value.extraction.prompt=en,t()}function I(b){s.value.download.concurrency=b,t()}function A(b){s.value.download.timeout=b,t()}function w(b){s.value.download.retries=b,t()}function N(b){s.value.download.delay=b,t()}function W(b){s.value.download.useReferer=b,t()}function U(b){s.value.imagePreprocess.enabled=b,t()}function f(b){s.value.imagePreprocess.autoRotate=b,t()}function g(b){s.value.imagePreprocess.compression.enabled=b,t()}function C(b){s.value.imagePreprocess.compression.quality=b,t()}function k(b){s.value.imagePreprocess.compression.maxWidth=b,t()}function V(b){s.value.imagePreprocess.compression.maxHeight=b,t()}function Y(b){s.value.imagePreprocess.formatConvert.enabled=b,t()}function ie(b){s.value.imagePreprocess.formatConvert.targetFormat=b,t()}function X(b){s.value.advanced.customCookie=b,t()}function ae(b){s.value.advanced.customHeaders=b,t()}function Q(b){s.value.advanced.bypassProxy=b,t()}function p(b){s.value.ui.showAgentLogs=b,t()}function m(b){s.value.ui.autoImport=b,t()}function x(b){s.value={...s.value,...b},t()}return{setFirecrawlApiKey:n,setAgentProvider:o,setAgentApiKey:l,setAgentBaseUrl:i,setAgentModelName:a,setAgentUseStream:r,setAgentForceJson:h,setAgentTimeout:T,setExtractionPrompt:S,setExtractionMaxIterations:D,resetExtractionPrompt:B,setDownloadConcurrency:I,setDownloadTimeout:A,setDownloadRetries:w,setDownloadDelay:N,setDownloadUseReferer:W,setImagePreprocessEnabled:U,setImageAutoRotate:f,setImageCompressionEnabled:g,setImageCompressionQuality:C,setImageMaxWidth:k,setImageMaxHeight:V,setImageFormatConvertEnabled:Y,setImageTargetFormat:ie,setCustomCookie:X,setCustomHeaders:ae,setBypassProxy:Q,setShowAgentLogs:p,setAutoImport:m,updateWebImportSettings:x}}async function uo(s){return Ze.post("/api/re_render_image",s)}async function bs(s){try{return{success:!0,data:await Ze.post("/api/translate_single_text",s)}}catch(t){return{success:!1,error:t instanceof Error?t.message:"ç¿»è¯‘å¤±è´¥"}}}async function Rt(s){return Ze.post("/api/hq_translate_batch",s)}async function no(s,t,n){return Ze.post("/api/detect_boxes",{image:s,detector_type:t,...n})}async function ln(s,t,n,o){return Ze.post("/api/ocr_single_bubble",{image_data:s,bubble_coords:t,ocr_engine:n,...o})}async function co(s,t,n){return Ze.post("/api/inpaint_single_bubble",{image_data:s,bubble_coords:t,bubble_angle:n?.bubbleAngle??0,method:n?.method??"lama",lama_model:n?.lamaModel??"lama_mpe",...n?.maskData&&{mask_data:n.maskData}})}const hs=Object.freeze(Object.defineProperty({__proto__:null,detectBoxes:no,hqTranslateBatch:Rt,inpaintSingleBubble:co,ocrSingleBubble:ln,reRenderImage:uo,translateSingleText:bs},Symbol.toStringTag,{value:"Module"}));async function ys(){return Ze.get("/api/plugins")}async function xs(s){const t=encodeURIComponent(s);return Ze.post(`/api/plugins/${t}/enable`)}async function _s(s){const t=encodeURIComponent(s);return Ze.post(`/api/plugins/${t}/disable`)}async function ks(s){const t=encodeURIComponent(s);return Ze.delete(`/api/plugins/${t}`)}async function Cs(s){const t=encodeURIComponent(s);return Ze.get(`/api/plugins/${t}/config_schema`)}async function Ss(s){const t=encodeURIComponent(s);return Ze.get(`/api/plugins/${t}/config`)}async function ws(s,t){const n=encodeURIComponent(s);return Ze.post(`/api/plugins/${n}/config`,t)}async function $s(){return Ze.get("/api/plugins/default_states")}async function Ts(s,t){const n=encodeURIComponent(s);return Ze.post(`/api/plugins/${n}/set_default_state`,{enabled:t})}async function Is(){return{states:(await $s()).default_states}}const Rs=Ts,Ps=Cs,Ds=Ss,Ms=ws;function Es(){return`img_${Date.now()}_${Math.random().toString(36).substring(2,9)}`}function qo(s,t,n){return{id:Es(),fileName:s,originalDataURL:t,translatedDataURL:null,cleanImageData:null,bubbleStates:null,translationStatus:"pending",translationFailed:!1,fontSize:25,autoFontSize:!0,fontFamily:"fonts/STSONG.TTF",layoutDirection:"vertical",textColor:"#000000",fillColor:tn,inpaintMethod:"solid",strokeEnabled:lo,strokeColor:ao,strokeWidth:so,hasUnsavedChanges:!1,...n}}const Qe=Ft("image",()=>{const s=_([]),t=_(-1),n=_(!1),o=q(()=>t.value>=0&&t.value<s.value.length?s.value[t.value]??null:null),l=q(()=>s.value.length),i=q(()=>s.value.length>0),a=q(()=>t.value>0),r=q(()=>t.value<s.value.length-1),h=q(()=>s.value.filter(b=>b.translationFailed).length),T=q(()=>s.value.filter(b=>b.translationStatus==="completed").length),S=q(()=>s.value.filter(b=>b.translationStatus==="pending").length);function D(b,u,c){const M=qo(b,u,c);return s.value.push(M),s.value.length===1&&(t.value=0),console.log(`å›¾ç‰‡å·²æ·»åŠ : ${b}ï¼Œå½“å‰å…± ${s.value.length} å¼ å›¾ç‰‡`),M}function B(b){const u=b.map(({fileName:M,originalDataURL:H,overrides:$})=>qo(M,H,$)),c=s.value.length===0;return s.value.push(...u),c&&s.value.length>0&&(t.value=0),console.log(`æ‰¹é‡æ·»åŠ äº† ${u.length} å¼ å›¾ç‰‡ï¼Œå½“å‰å…± ${s.value.length} å¼ `),u}function I(b){s.value=b.map(u=>({...u,strokeEnabled:u.strokeEnabled??lo,strokeColor:u.strokeColor||ao,strokeWidth:u.strokeWidth??so,hasUnsavedChanges:u.hasUnsavedChanges||!1})),s.value.length>0?t.value=Math.min(Math.max(0,t.value),s.value.length-1):t.value=-1,console.log(`å›¾ç‰‡æ•°ç»„å·²è®¾ç½®ï¼Œå…± ${s.value.length} å¼ å›¾ç‰‡`)}function A(b){return b<0||b>=s.value.length?(console.warn(`åˆ é™¤å¤±è´¥: æ— æ•ˆçš„ç´¢å¼• ${b}`),!1):(s.value.splice(b,1),t.value===b?(t.value=Math.min(b,s.value.length-1),s.value.length===0&&(t.value=-1)):t.value>b&&t.value--,console.log(`å›¾ç‰‡å·²åˆ é™¤ï¼Œå½“å‰å…± ${s.value.length} å¼ å›¾ç‰‡`),!0)}function w(){return A(t.value)}function N(){s.value=[],t.value=-1,n.value=!1,console.log("æ‰€æœ‰å›¾ç‰‡å·²æ¸…é™¤")}function W(){const b=o.value?.id||null;if(s.value.sort((u,c)=>u.fileName.localeCompare(c.fileName,void 0,{numeric:!0,sensitivity:"base"})),b){const u=s.value.findIndex(c=>c.id===b);u>=0&&u!==t.value&&(console.log(`å›¾ç‰‡æ’åº: currentImageIndex ä» ${t.value} æ›´æ–°ä¸º ${u}`),t.value=u)}console.log("å›¾ç‰‡å·²æŒ‰æ–‡ä»¶åæ’åº")}function U(b){b>=-1&&b<s.value.length?(t.value=b,console.log(`å½“å‰å›¾ç‰‡ç´¢å¼•å·²è®¾ç½®ä¸º ${b}`)):console.warn(`è®¾ç½®ç´¢å¼•å¤±è´¥: æ— æ•ˆçš„ç´¢å¼• ${b}`)}function f(){return a.value?(t.value--,!0):!1}function g(){return r.value?(t.value++,!0):!1}function C(b){o.value?(Object.assign(o.value,b),console.log("å½“å‰å›¾ç‰‡å±æ€§å·²æ›´æ–°:",Object.keys(b))):console.warn("æ›´æ–°å¤±è´¥: å½“å‰æ²¡æœ‰é€‰ä¸­çš„å›¾ç‰‡")}function k(b,u){if(b>=0&&b<s.value.length){const c=s.value[b];c&&(Object.assign(c,u),console.log(`å›¾ç‰‡ ${b} å±æ€§å·²æ›´æ–°:`,Object.keys(u)))}else console.warn(`æ›´æ–°å¤±è´¥: æ— æ•ˆçš„ç´¢å¼• ${b}`)}function V(b){o.value&&(o.value.bubbleStates=b,o.value.hasUnsavedChanges=!0,console.log(`å½“å‰å›¾ç‰‡æ°”æ³¡çŠ¶æ€å·²æ›´æ–°ï¼Œå…± ${b?.length??0} ä¸ªæ°”æ³¡`))}function Y(b){o.value&&(o.value.isManuallyAnnotated=b,o.value.hasUnsavedChanges=!0,console.log(`æ‰‹åŠ¨æ ‡æ³¨æ ‡è®°å·²è®¾ç½®ä¸º: ${b}`))}function ie(b,u){o.value?(o.value[b]=u,o.value.hasUnsavedChanges=!0,console.log(`å½“å‰å›¾ç‰‡å±æ€§ ${String(b)} å·²æ›´æ–°`)):console.warn("æ›´æ–°å¤±è´¥: å½“å‰æ²¡æœ‰é€‰ä¸­çš„å›¾ç‰‡")}function X(b,u){o.value&&(o.value.translatedDataURL=b,u&&(o.value.cleanImageData=u),o.value.translationStatus="completed",o.value.translationFailed=!1,o.value.hasUnsavedChanges=!0,console.log("å½“å‰å›¾ç‰‡ç¿»è¯‘ç»“æœå·²æ›´æ–°"))}function ae(b,u,c){if(b>=0&&b<s.value.length){const M=s.value[b];M&&(M.translationStatus=u,M.translationFailed=u==="failed",c&&(M.errorMessage=c),console.log(`å›¾ç‰‡ ${b} ç¿»è¯‘çŠ¶æ€: ${u}`))}}function Q(b){o.value&&(o.value.translationStatus="failed",o.value.translationFailed=!0,o.value.errorMessage=b,console.log(`å½“å‰å›¾ç‰‡ç¿»è¯‘å¤±è´¥: ${b}`))}function p(){s.value.forEach(b=>{b.translationStatus="pending",b.translationFailed=!1,b.errorMessage=void 0}),console.log("æ‰€æœ‰å›¾ç‰‡ç¿»è¯‘çŠ¶æ€å·²é‡ç½®")}function m(b){n.value=b,console.log(`æ‰¹é‡ç¿»è¯‘çŠ¶æ€: ${b?"è¿›è¡Œä¸­":"å·²å®Œæˆ"}`)}function x(){return s.value.map((b,u)=>b.translationFailed?u:-1).filter(b=>b!==-1)}return{images:s,currentImageIndex:t,isBatchTranslationInProgress:n,currentImage:o,imageCount:l,hasImages:i,canGoPrevious:a,canGoNext:r,failedImageCount:h,completedImageCount:T,pendingImageCount:S,addImage:D,addImages:B,setImages:I,deleteImage:A,deleteCurrentImage:w,clearImages:N,sortImagesByFileName:W,setCurrentImageIndex:U,goToPrevious:f,goToNext:g,updateCurrentImage:C,updateImageByIndex:k,updateCurrentBubbleStates:V,setManuallyAnnotated:Y,updateCurrentImageProperty:ie,updateCurrentTranslationResult:X,setTranslationStatus:ae,markCurrentAsFailed:Q,resetAllTranslationStatus:p,setBatchTranslationInProgress:m,getFailedImageIndices:x}}),Ho=Object.freeze(Object.defineProperty({__proto__:null,useImageStore:Qe},Symbol.toStringTag,{value:"Module"})),rn=Ft("session",()=>{const s=_(null),t=_({bookId:null,chapterId:null,bookTitle:null,chapterTitle:null}),n=_([]),o=_(!1),l=_({current:0,total:0,message:""}),i=_(null),a=_(!1),r=q(()=>t.value.bookId!==null&&t.value.chapterId!==null),h=q(()=>t.value.bookId),T=q(()=>t.value.chapterId);function S(p,m,x=null,b=null){t.value={bookId:p,chapterId:m,bookTitle:x,chapterTitle:b},console.log(`ä¼šè¯ä¸Šä¸‹æ–‡å·²è®¾ç½®: ä¹¦ç±=${p}, ç« èŠ‚=${m}`)}function D(p,m,x,b){S(p,m,x,b)}function B(){t.value={bookId:null,chapterId:null,bookTitle:null,chapterTitle:null},console.log("ä¼šè¯ä¸Šä¸‹æ–‡å·²æ¸…é™¤")}function I(p){const m=p.get("book"),x=p.get("chapter");m&&x&&S(m,x)}function A(p){s.value=p,console.log(`å½“å‰ä¼šè¯åç§°: ${p}`)}function w(){s.value=null}function N(p){n.value=p,console.log(`ä¼šè¯åˆ—è¡¨å·²æ›´æ–°ï¼Œå…± ${p.length} ä¸ªä¼šè¯`)}function W(p){const m=n.value.findIndex(x=>x.name===p.name);m>=0?n.value[m]=p:n.value.unshift(p)}function U(p){const m=n.value.findIndex(x=>x.name===p);m>=0&&n.value.splice(m,1)}function f(p,m){const x=n.value.find(b=>b.name===p);x&&(x.name=m)}function g(p){o.value=p}function C(p){a.value=p}function k(p){i.value=p}function V(p,m,x,b){return{name:p,version:"2.0",savedAt:new Date().toISOString(),imageCount:m.length,ui_settings:b,images:m.map(u=>({originalDataURL:u.originalDataURL,translatedDataURL:u.translatedDataURL||void 0,cleanImageData:u.cleanImageData||void 0,bubbleStates:u.bubbleStates||void 0,isManuallyAnnotated:u.isManuallyAnnotated||void 0,relativePath:u.relativePath||void 0,folderPath:u.folderPath||void 0,fileName:u.fileName,fontSize:u.fontSize,autoFontSize:u.autoFontSize,fontFamily:u.fontFamily,layoutDirection:u.layoutDirection,textColor:u.textColor,fillColor:u.fillColor,inpaintMethod:u.inpaintMethod,strokeEnabled:u.strokeEnabled,strokeColor:u.strokeColor,strokeWidth:u.strokeWidth,translationStatus:u.translationStatus,translationFailed:u.translationFailed})),currentImageIndex:x}}function Y(){s.value=null,t.value={bookId:null,chapterId:null,bookTitle:null,chapterTitle:null},n.value=[],o.value=!1,a.value=!1,i.value=null,console.log("ä¼šè¯çŠ¶æ€å·²é‡ç½®")}async function ie(p){if(!p||typeof p!="string")return null;if(p.startsWith("data:"))return p;if(!p.startsWith("/api/"))return null;try{const m=await fetch(p);if(!m.ok)return null;const x=await m.blob();return new Promise(b=>{const u=new FileReader;u.onloadend=()=>b(u.result),u.onerror=()=>b(null),u.readAsDataURL(x)})}catch(m){return console.error(`è½¬æ¢å›¾ç‰‡ URL å¤±è´¥: ${p}`,m),null}}async function X(p,m){const x=p.length;for(let b=0;b<x;b++){const u=p[b];if(u){if(m&&m(b+1,x),u.originalDataURL&&u.originalDataURL.startsWith("/api/")){const c=await ie(u.originalDataURL);c&&(u.originalDataURL=c)}if(u.translatedDataURL&&u.translatedDataURL.startsWith("/api/")){const c=await ie(u.translatedDataURL);c&&(u.translatedDataURL=c)}if(u.cleanImageData&&u.cleanImageData.startsWith("/api/")){const c=await ie(u.cleanImageData);c&&(u.cleanImageData=c.replace(/^data:image\/\w+;base64,/,""))}}}}async function ae(p){g(!0),k(null),l.value={current:0,total:0,message:"æ­£åœ¨åŠ è½½..."};try{const{useImageStore:m}=await lt(async()=>{const{useImageStore:v}=await Promise.resolve().then(()=>Ho);return{useImageStore:v}},void 0),{useSettingsStore:x}=await lt(async()=>{const{useSettingsStore:v}=await import("./system.DJNGJ5SO.js").then(F=>F.s);return{useSettingsStore:v}},__vite__mapDeps([0,1,2,3,4,5])),{useBubbleStore:b}=await lt(async()=>{const{useBubbleStore:v}=await Promise.resolve().then(()=>Dl);return{useBubbleStore:v}},void 0),u=m(),c=x(),M=b(),{loadSessionByPathApi:H}=await lt(async()=>{const{loadSessionByPathApi:v}=await import("./session.Kpy-QhBa.js");return{loadSessionByPathApi:v}},__vite__mapDeps([6,4,5])),$=await H(p);if(!$.success||!$.session)throw new Error($.error||"åŠ è½½ä¼šè¯å¤±è´¥");const O=$.session;if(O.images&&O.images.length>0){const v=O.images.map((y,ue)=>({id:`session-${ue}-${Date.now()}`,originalDataURL:y.originalDataURL,translatedDataURL:y.translatedDataURL||null,cleanImageData:y.cleanImageData||null,bubbleStates:y.bubbleStates!==void 0&&y.bubbleStates!==null?y.bubbleStates:null,isManuallyAnnotated:!!y.isManuallyAnnotated,relativePath:y.relativePath||void 0,folderPath:y.folderPath||void 0,fileName:y.fileName||`image-${ue+1}.png`,translationStatus:y.translationStatus||"pending",translationFailed:!!y.translationFailed,hasUnsavedChanges:!1,fontSize:y.fontSize||24,autoFontSize:y.autoFontSize??!0,fontFamily:y.fontFamily||"Microsoft YaHei",layoutDirection:y.layoutDirection||"vertical",textColor:y.textColor||"#000000",fillColor:y.fillColor||"#FFFFFF",inpaintMethod:y.inpaintMethod||"litelama",strokeEnabled:y.strokeEnabled??!1,strokeColor:y.strokeColor||"#FFFFFF",strokeWidth:y.strokeWidth||2}));v.length>0&&(console.log("æ­£åœ¨åŠ è½½å›¾ç‰‡..."),l.value={current:0,total:v.length,message:"æ­£åœ¨åŠ è½½å›¾ç‰‡..."},await X(v,(y,ue)=>{const L=y/ue*100;l.value={current:y,total:ue,message:`åŠ è½½å›¾ç‰‡ ${y}/${ue}...`},console.log(`åŠ è½½å›¾ç‰‡ ${y}/${ue}... (${L.toFixed(0)}%)`)}),l.value={current:v.length,total:v.length,message:"åŠ è½½å®Œæˆ"},console.log("å›¾ç‰‡åŠ è½½å®Œæˆï¼Œå·²è½¬æ¢ä¸º Base64"),setTimeout(()=>{l.value={current:0,total:0,message:""}},500)),u.setImages(v);let F=0;typeof O.currentImageIndex=="number"&&(F=O.currentImageIndex,(F>=v.length||F<0)&&(F=v.length>0?0:-1)),u.setCurrentImageIndex(F);const d=v[F];d&&d.bubbleStates&&d.bubbleStates.length>0?M.setBubbles(d.bubbleStates,!0):M.clearBubblesLocal(),console.log(`æŒ‰è·¯å¾„åŠ è½½ä¼šè¯æˆåŠŸ: ${p}, å…± ${v.length} å¼ å›¾ç‰‡`)}const P=O.ui_settings;if(P){(P.targetLanguage||P.sourceLanguage)&&c.updateSettings({targetLanguage:P.targetLanguage||void 0,sourceLanguage:P.sourceLanguage||void 0});const v=P.useInpaintingMethod,d=["solid","lama_mpe","litelama"].includes(v)?v:c.settings.textStyle.inpaintMethod;c.updateTextStyle({fontSize:P.fontSize||c.settings.textStyle.fontSize,autoFontSize:P.autoFontSize??c.settings.textStyle.autoFontSize,fontFamily:P.fontFamily||c.settings.textStyle.fontFamily,layoutDirection:P.layoutDirection||c.settings.textStyle.layoutDirection,textColor:P.textColor||c.settings.textStyle.textColor,fillColor:P.fillColor||c.settings.textStyle.fillColor,inpaintMethod:d,strokeEnabled:P.strokeEnabled??c.settings.textStyle.strokeEnabled,strokeColor:P.strokeColor||c.settings.textStyle.strokeColor,strokeWidth:P.strokeWidth||c.settings.textStyle.strokeWidth}),console.log("UI è®¾ç½®å·²æ¢å¤")}return A(p),!0}catch(m){const x=m instanceof Error?m.message:"åŠ è½½ä¼šè¯å¤±è´¥";throw k(x),console.error(`æŒ‰è·¯å¾„åŠ è½½ä¼šè¯å¤±è´¥: ${p}`,m),m}finally{g(!1)}}async function Q(p,m){if(!p||!m)return console.log("æœªåœ¨ä¹¦ç±/ç« èŠ‚æ¨¡å¼ï¼Œä¸æ”¯æŒä¿å­˜"),!1;console.log(`ä¿å­˜ç« èŠ‚ä¼šè¯ï¼ˆåˆ†æ‰¹ï¼‰: book=${p}, chapter=${m}`);const{useImageStore:x}=await lt(async()=>{const{useImageStore:$}=await Promise.resolve().then(()=>Ho);return{useImageStore:$}},void 0),{useSettingsStore:b}=await lt(async()=>{const{useSettingsStore:$}=await import("./system.DJNGJ5SO.js").then(O=>O.s);return{useSettingsStore:$}},__vite__mapDeps([0,1,2,3,4,5])),u=x(),c=b(),M=Array.isArray(u.images)?u.images:[];if(!M||M.length===0)return console.log("æ²¡æœ‰å›¾ç‰‡æ•°æ®å¯ä¿å­˜"),!1;const H=`bookshelf/${p}/${m}`;C(!0),k(null),l.value={current:0,total:100,message:"å‡†å¤‡ä¿å­˜..."};try{const{batchSaveStartApi:$,batchSaveImageApi:O,batchSaveCompleteApi:P}=await lt(async()=>{const{batchSaveStartApi:z,batchSaveImageApi:te,batchSaveCompleteApi:ee}=await import("./session.Kpy-QhBa.js");return{batchSaveStartApi:z,batchSaveImageApi:te,batchSaveCompleteApi:ee}},__vite__mapDeps([6,4,5])),v=M.length;M.some(z=>z.originalDataURL&&z.originalDataURL.startsWith("/api/")||z.translatedDataURL&&z.translatedDataURL.startsWith("/api/")||z.cleanImageData&&z.cleanImageData.startsWith("/api/"))&&(console.log("[saveChapterSession] æ£€æµ‹åˆ° /api/ URL æ ¼å¼å›¾ç‰‡ï¼Œå¼€å§‹è½¬æ¢ä¸º Base64..."),l.value={current:2,total:100,message:"è½¬æ¢å›¾ç‰‡æ ¼å¼..."},await X(M,(z,te)=>{const ee=2+z/te*3;l.value={current:Math.round(ee),total:100,message:`è½¬æ¢å›¾ç‰‡ ${z}/${te}...`}}),console.log("[saveChapterSession] å›¾ç‰‡æ ¼å¼è½¬æ¢å®Œæˆ")),l.value={current:5,total:100,message:"æ”¶é›†å…ƒæ•°æ®..."};const{textStyle:d,targetLanguage:y,sourceLanguage:ue}=c.settings,L={targetLanguage:y,sourceLanguage:ue,fontSize:d.fontSize,autoFontSize:d.autoFontSize,fontFamily:d.fontFamily,layoutDirection:d.layoutDirection,textColor:d.textColor,useInpaintingMethod:d.inpaintMethod,fillColor:d.fillColor,strokeEnabled:d.strokeEnabled,strokeColor:d.strokeColor,strokeWidth:d.strokeWidth},j=M.map(z=>{const te={};for(const ee of Object.keys(z))ee!=="originalDataURL"&&ee!=="translatedDataURL"&&ee!=="cleanImageData"&&(te[ee]=z[ee]);return te.hasOriginalData=!!z.originalDataURL,te.hasTranslatedData=!!z.translatedDataURL,te.hasCleanData=!!z.cleanImageData,te}),le={ui_settings:L,images_meta:j,currentImageIndex:u.currentImageIndex};l.value={current:10,total:100,message:"åˆå§‹åŒ–ä¿å­˜..."};const he=await $(H,le);if(!he.success)throw new Error(he.error||"åˆå§‹åŒ–ä¿å­˜å¤±è´¥");const $e=he.session_folder;if(!$e)throw new Error("æœªè·å–åˆ°ä¼šè¯æ–‡ä»¶å¤¹è·¯å¾„");console.log(`ä¼šè¯æ–‡ä»¶å¤¹: ${$e}`);let Ae=0,Me=0;const se=z=>!!z&&typeof z=="string"&&z.startsWith("data:");for(let z=0;z<v;z++){const te=M[z];if(!te)continue;const ee=10+z/v*80;if(l.value={current:Math.round(ee),total:100,message:`ä¿å­˜å›¾ç‰‡ ${z+1}/${v}...`},se(te.originalDataURL))try{const ce=await O($e,z,"original",te.originalDataURL);ce.success||(console.error(`ä¿å­˜å›¾ç‰‡ ${z} original å¤±è´¥:`,ce.error),Me++)}catch(ce){console.error(`ä¿å­˜å›¾ç‰‡ ${z} original å‡ºé”™:`,ce),Me++}if(se(te.translatedDataURL))try{const ce=await O($e,z,"translated",te.translatedDataURL);ce.success||(console.error(`ä¿å­˜å›¾ç‰‡ ${z} translated å¤±è´¥:`,ce.error),Me++)}catch(ce){console.error(`ä¿å­˜å›¾ç‰‡ ${z} translated å‡ºé”™:`,ce),Me++}if(te.cleanImageData&&typeof te.cleanImageData=="string"&&!te.cleanImageData.startsWith("/api/"))try{const ce=await O($e,z,"clean",te.cleanImageData);ce.success||(console.error(`ä¿å­˜å›¾ç‰‡ ${z} clean å¤±è´¥:`,ce.error),Me++)}catch(ce){console.error(`ä¿å­˜å›¾ç‰‡ ${z} clean å‡ºé”™:`,ce),Me++}Ae++}l.value={current:95,total:100,message:"å®Œæˆä¿å­˜..."};const J=await P($e,j);if(!J.success)throw new Error(J.error||"å®Œæˆä¿å­˜å¤±è´¥");return l.value={current:100,total:100,message:"ä¿å­˜å®Œæˆ"},console.log(`åˆ†æ‰¹ä¿å­˜å®Œæˆ: ${Ae} å¼ å›¾ç‰‡, ${Me} ä¸ªå¤±è´¥`),setTimeout(()=>{l.value={current:0,total:0,message:""}},1e3),!0}catch($){const O=$ instanceof Error?$.message:"ä¿å­˜ç« èŠ‚ä¼šè¯å¤±è´¥";return k(O),console.error("åˆ†æ‰¹ä¿å­˜å¤±è´¥:",$),l.value={current:0,total:0,message:""},!1}finally{C(!1)}}return{currentSessionName:s,context:t,sessionList:n,isLoading:o,isSaving:a,error:i,loadingProgress:l,isBookshelfMode:r,currentBookId:h,currentChapterId:T,setContext:S,clearContext:B,parseContextFromUrl:I,setSessionName:A,clearSessionName:w,setSessionList:N,addToSessionList:W,removeFromSessionList:U,renameInSessionList:f,setLoading:g,setSaving:C,setError:k,createSessionData:V,imageUrlToBase64:ie,saveChapterSession:Q,loadSessionByPath:ae,setBookChapterContext:D,reset:Y}}),Mt={originalText:"",translatedText:"",textboxText:"",coords:[0,0,100,100],polygon:[],fontSize:25,fontFamily:"fonts/STSONG.TTF",textDirection:"auto",autoTextDirection:"vertical",textColor:"#000000",fillColor:tn,rotationAngle:0,position:{x:0,y:0},strokeEnabled:lo,strokeColor:ao,strokeWidth:so,inpaintMethod:"solid",autoFgColor:null,autoBgColor:null,colorConfidence:0};function Bs(s){return{...{...Mt,...s},coords:s?.coords?[...s.coords]:[...Mt.coords],polygon:s?.polygon?s.polygon.map(n=>[...n]):[],position:s?.position?{...Mt.position,...s.position}:{...Mt.position}}}function As(s){const[t,n,o,l]=s,i=Math.abs(o-t);return Math.abs(l-n)>i?"vertical":"horizontal"}function Et(s){return s.map(t=>({...t,coords:[...t.coords],polygon:t.polygon?t.polygon.map(n=>[...n]):[],position:{...t.position},autoFgColor:t.autoFgColor?[...t.autoFgColor]:null,autoBgColor:t.autoBgColor?[...t.autoBgColor]:null}))}function Ls(s){if(!s||typeof s!="object")return!1;const t=s;if(!Array.isArray(t.coords)||t.coords.length!==4||!t.coords.every(l=>typeof l=="number"&&!isNaN(l))||typeof t.fontSize!="number"||t.fontSize<=0)return!1;const n=["vertical","horizontal","auto"];if(typeof t.textDirection!="string"||!n.includes(t.textDirection))return!1;const o=["solid","lama_mpe","litelama"];return!(typeof t.inpaintMethod!="string"||!o.includes(t.inpaintMethod))}function Fs(s){let t=s,n=0,o=0,l=Date.now();const i=()=>t<=0?0:Math.ceil(6e4/t);return{async acquire(){if(t<=0)return;const a=Date.now(),r=i();if(a-l>=6e4&&(l=a,o=0),o>=t){const T=6e4-(a-l);T>0&&await jo(T),l=Date.now(),o=0}const h=a-n;h<r&&await jo(r-h),n=Date.now(),o++},reset(){n=0,o=0,l=Date.now()},getRpm(){return t},setRpm(a){t=a,this.reset()}}}function jo(s){return new Promise(t=>setTimeout(t,s))}function Jo(s){const t=s.replace(/\\/g,"/"),n=[],o=/(\d+)/g;let l=0,i;for(;(i=o.exec(t))!==null;){if(i.index>l){const a=t.slice(l,i.index);a&&n.push([!0,a.toLowerCase()])}n.push([!1,parseInt(i[0],10)]),l=o.lastIndex}if(l<t.length){const a=t.slice(l);a&&n.push([!0,a.toLowerCase()])}return n}function Us(s,t){const n=Jo(s),o=Jo(t),l=Math.min(n.length,o.length);for(let i=0;i<l;i++){const[a,r]=n[i],[h,T]=o[i];if(a!==h)return a?1:-1;if(r<T)return-1;if(r>T)return 1}return n.length-o.length}function Os(s,t=n=>String(n)){return[...s].sort((n,o)=>Us(t(n),t(o)))}const un=Ft("webImport",()=>{const s=_(Ko()),t=_("idle"),n=_(""),o=_([]),l=_(null),i=_(new Set),a=_({current:0,total:0}),r=_([]),h=_(null),T=_(!1),S=q(()=>t.value==="extracting"),D=q(()=>t.value==="downloading"),B=q(()=>S.value||D.value),I=q(()=>i.value.size),A=q(()=>a.value.total===0?0:Math.round(a.value.current/a.value.total*100));function w(){try{localStorage.setItem(Mo,JSON.stringify(s.value))}catch(u){console.error("ä¿å­˜ç½‘é¡µå¯¼å…¥è®¾ç½®å¤±è´¥:",u)}}function N(){try{const u=localStorage.getItem(Mo);if(u){const c=JSON.parse(u);s.value=W(Ko(),c)}}catch(u){console.error("åŠ è½½ç½‘é¡µå¯¼å…¥è®¾ç½®å¤±è´¥:",u)}}function W(u,c){const M={...u};for(const H in c)if(Object.prototype.hasOwnProperty.call(c,H)){const $=c[H],O=u[H];$!==null&&typeof $=="object"&&!Array.isArray($)&&O!==null&&typeof O=="object"&&!Array.isArray(O)?M[H]=W(O,$):$!==void 0&&(M[H]=$)}return M}function U(){T.value=!0}function f(){T.value=!1}function g(){t.value="idle",n.value="",o.value=[],l.value=null,i.value=new Set,a.value={current:0,total:0},r.value=[],h.value=null}function C(u){n.value=u}function k(u){o.value.push(u)}function V(){o.value=[]}function Y(u){l.value&&l.value.pages.length>0?(l.value.comicTitle=u.comicTitle,l.value.chapterTitle=u.chapterTitle,l.value.totalPages=u.totalPages,l.value.sourceUrl=u.sourceUrl,l.value.referer=u.referer,l.value.engine=u.engine,l.value.success=u.success,l.value.error=u.error):(l.value=u,u.success&&u.pages&&(i.value=new Set(u.pages.map(c=>c.pageNumber))))}function ie(u){i.value.has(u)?i.value.delete(u):i.value.add(u),i.value=new Set(i.value)}function X(){l.value?.pages&&(i.value.size===l.value.pages.length?i.value=new Set:i.value=new Set(l.value.pages.map(u=>u.pageNumber)))}function ae(u){t.value=u}function Q(u){h.value=u,u&&(t.value="error")}function p(u,c){a.value={current:u,total:c}}function m(u){r.value=u}function x(u){l.value||(l.value={success:!0,comicTitle:"",chapterTitle:"",pages:[],totalPages:0,sourceUrl:n.value,referer:"",engine:"gallery-dl"}),l.value.pages.push(u),l.value.totalPages=l.value.pages.length,i.value.add(u.pageNumber),i.value=new Set(i.value)}const b=fs(s,w);return N(),{settings:s,status:t,url:n,logs:o,extractResult:l,selectedPages:i,downloadProgress:a,downloadedImages:r,error:h,modalVisible:T,isExtracting:S,isDownloading:D,isProcessing:B,selectedCount:I,downloadProgressPercent:A,saveToStorage:w,loadFromStorage:N,openModal:U,closeModal:f,resetState:g,setUrl:C,addLog:k,clearLogs:V,setExtractResult:Y,togglePageSelection:ie,toggleSelectAll:X,setStatus:ae,setError:Q,updateDownloadProgress:p,setDownloadedImages:m,addPageIncremental:x,...b}}),zs={key:0,class:"translation-progress-bar"},Ns={class:"progress-bar-label"},Vs={class:"progress-bar"},Ws=Je({__name:"ProgressBar",props:{visible:{type:Boolean,default:!0},percentage:{},label:{default:"è¿›åº¦"}},setup(s){return(t,n)=>s.visible?(R(),E("div",zs,[e("div",Ns,oe(s.label),1),e("div",Vs,[e("div",{class:"progress",style:ot({width:`${s.percentage}%`})},null,4)])])):ge("",!0)}}),go=je(Ws,[["__scopeId","data-v-f915cadf"]]),Ks={class:"image-upload"},qs={class:"error-text"},Hs={key:2,class:"loading-overlay"},js=Je({__name:"ImageUpload",emits:["uploadComplete"],setup(s,{expose:t,emit:n}){const o=n,l=Qe(),i=Ue(),a=un(),r=_(null),h=_(null),T=_(!1),S=_(!1),D=_(""),B=_(0),I=_(""),A=_(!1),w=q(()=>i.settings.pdfProcessingMethod);function N(){r.value?.click()}function W(){a.openModal()}function U(){h.value?.click()}async function f(u){const c=u.target;if(!c.files||c.files.length===0)return;const H=Array.from(c.files).filter(O=>O.type.startsWith("image/"));if(H.length===0){fe("æ‰€é€‰æ–‡ä»¶å¤¹ä¸­æ²¡æœ‰æ‰¾åˆ°å›¾ç‰‡æ–‡ä»¶","warning"),c.value="";return}const $=Os(H,O=>O.webkitRelativePath);console.log(`ä»æ–‡ä»¶å¤¹å¯¼å…¥ ${$.length} å¼ å›¾ç‰‡`),await g($),c.value=""}async function g(u){if(u.length!==0){T.value=!0,A.value=!0,B.value=0;try{let c=0;const M=u.length;for(let H=0;H<u.length;H++){const $=u[H];if(!$||!$.type.startsWith("image/"))continue;I.value=$.name;const O=$.webkitRelativePath||"",P=O.includes("/")?O.substring(0,O.lastIndexOf("/")):"";await new Promise((v,F)=>{const d=new FileReader;d.onload=y=>{const ue=y.target?.result;l.addImage($.name,ue,{relativePath:O,folderPath:P}),v()},d.onerror=()=>F(new Error(`è¯»å–å›¾ç‰‡å¤±è´¥: ${$.name}`)),d.readAsDataURL($)}),c++,B.value=Math.round((H+1)/M*100)}c>0&&(fe(`å·²æ·»åŠ  ${c} å¼ å›¾ç‰‡`,"success"),o("uploadComplete",c))}catch(c){console.error("å¤„ç†æ–‡ä»¶å¤±è´¥:",c);const M=c instanceof Error?c.message:"å¤„ç†æ–‡ä»¶å¤±è´¥";fe(M,"error")}finally{T.value=!1,A.value=!1}}}async function C(u){const c=u.target;!c.files||c.files.length===0||(await ie(Array.from(c.files)),c.value="")}async function k(u){u.preventDefault(),S.value=!1,!(!u.dataTransfer?.files||u.dataTransfer.files.length===0)&&await ie(Array.from(u.dataTransfer.files))}function V(u){u.preventDefault(),S.value=!0}function Y(u){const c=u.currentTarget.getBoundingClientRect(),M=u.clientX,H=u.clientY;(M<c.left||M>c.right||H<c.top||H>c.bottom)&&(S.value=!1)}async function ie(u){if(u.length!==0){T.value=!0,D.value="",A.value=!0,B.value=0;try{let c=0;const M=u.length;for(let H=0;H<u.length;H++){const $=u[H];if(!$)continue;I.value=$.name;const O=$.type,P=$.name.toLowerCase();if(O.startsWith("image/"))await X($),c++;else if(O==="application/pdf"||P.endsWith(".pdf")){const v=await ae($);c+=v}else if(P.endsWith(".mobi")||P.endsWith(".azw")||P.endsWith(".azw3")){const v=await x($);c+=v}else console.warn(`ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹: ${$.name}`),fe(`ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹: ${$.name}`,"warning");B.value=Math.round((H+1)/M*100)}c>0&&(fe(`å·²æ·»åŠ  ${c} å¼ å›¾ç‰‡`,"success"),o("uploadComplete",c))}catch(c){console.error("å¤„ç†æ–‡ä»¶å¤±è´¥:",c);const M=c instanceof Error?c.message:"å¤„ç†æ–‡ä»¶å¤±è´¥ï¼Œè¯·é‡è¯•";D.value=M,fe(M,"error")}finally{T.value=!1,A.value=!1,I.value=""}}}async function X(u){return new Promise((c,M)=>{const H=new FileReader;H.onload=$=>{const O=$.target?.result;l.addImage(u.name,O),c()},H.onerror=()=>M(new Error(`è¯»å–å›¾ç‰‡æ–‡ä»¶å¤±è´¥: ${u.name}`)),H.readAsDataURL(u)})}async function ae(u){return w.value==="frontend"?await p(u):await m(u)}function Q(u){return new Promise((c,M)=>{const H=new FileReader;H.onload=()=>c(H.result),H.onerror=M,H.readAsDataURL(u)})}async function p(u){try{const c=await lt(()=>import("./pdf.U7tdldy2.js").then(v=>v.p),[]);c.GlobalWorkerOptions.workerSrc=`https://cdnjs.cloudflare.com/ajax/libs/pdf.js/${c.version}/pdf.worker.min.js`;const M=await u.arrayBuffer(),H=await c.getDocument({data:M}).promise,$=H.numPages;console.log(`PDF ${u.name} å…± ${$} é¡µï¼Œå¼€å§‹æœ¬åœ°æ¸²æŸ“...`),fe(`æ­£åœ¨è§£æ PDFï¼Œå…± ${$} é¡µ...`,"info");const O=typeof OffscreenCanvas<"u";O&&console.log("ä½¿ç”¨ OffscreenCanvas åå°æ¸²æŸ“æ¨¡å¼");let P=0;for(let v=1;v<=$;v++){I.value=`${u.name} - ç¬¬ ${v}/${$} é¡µ`,B.value=Math.round(v/$*100);try{const F=await H.getPage(v),y=F.getViewport({scale:2});let ue;if(O){const j=new OffscreenCanvas(y.width,y.height),le=j.getContext("2d");await F.render({canvasContext:le,viewport:y}).promise;const he=await j.convertToBlob({type:"image/jpeg",quality:1});ue=await Q(he)}else{const j=document.createElement("canvas"),le=j.getContext("2d");j.width=y.width,j.height=y.height,await F.render({canvasContext:le,viewport:y}).promise,ue=j.toDataURL("image/jpeg",1)}const L=`${u.name}_é¡µé¢${v}`;l.addImage(L,ue),P++,console.log(`  é¡µé¢ ${v}/${$} å¤„ç†å®Œæˆ`)}catch(F){console.warn(`PDF ${u.name} ç¬¬ ${v} é¡µæ¸²æŸ“å¤±è´¥:`,F)}}return console.log(`PDF ${u.name} å…¨éƒ¨ ${$} é¡µå¤„ç†å®Œæˆ`),P}catch(c){return console.error("å‰ç«¯ PDF è§£æå¤±è´¥:",c),fe("å‰ç«¯ PDF è§£æå¤±è´¥ï¼Œå°è¯•ä½¿ç”¨åç«¯è§£æ...","warning"),await m(u)}}async function m(u){let M=null;try{fe("æ­£åœ¨ä¸Šä¼  PDF æ–‡ä»¶...","info");const H=await ts(u,5);if(!H.success||!H.session_id)throw new Error(H.error||"PDF è§£æå¯åŠ¨å¤±è´¥");M=H.session_id;const $=H.total_pages||0;console.log(`PDF ${u.name} å…± ${$} é¡µï¼Œå¼€å§‹åç«¯åˆ†æ‰¹è§£æ...`),fe(`æ­£åœ¨è§£æ PDFï¼Œå…± ${$} é¡µ...`,"info");let O=0;for(let P=0;P<$;P+=5){I.value=`${u.name} - å¤„ç†ä¸­ ${Math.min(P+5,$)}/${$} é¡µ`,B.value=$>0?Math.round(P/$*100):0;const v=await os(M,P,5);if(!v.success){console.warn(`æ‰¹æ¬¡ ${P} è·å–å¤±è´¥:`,v.error);continue}if(v.images&&v.images.length>0)for(const F of v.images){if(!F||!F.data_url)continue;const d=`${u.name}_é¡µé¢${String(F.page_index+1).padStart(4,"0")}`;l.addImage(d,F.data_url),O++}console.log(`  å·²åŠ è½½ ${O}/${$} é¡µ`)}return console.log(`PDF ${u.name} å…¨éƒ¨ ${O} é¡µå¤„ç†å®Œæˆ`),O}catch(H){throw console.error("åç«¯ PDF è§£æå¤±è´¥:",H),H}finally{if(M)try{await ns(M)}catch(H){console.warn("PDF ä¼šè¯æ¸…ç†å¤±è´¥:",H)}}}async function x(u){let c=null;try{fe("æ­£åœ¨ä¸Šä¼ ç”µå­ä¹¦æ–‡ä»¶...","info");const M=await ss(u,5);if(!M.success||!M.session_id)throw new Error(M.error||"MOBI/AZW è§£æå¯åŠ¨å¤±è´¥");c=M.session_id;const H=M.total_images||0;fe(`æ­£åœ¨è§£æç”µå­ä¹¦ï¼Œå…± ${H} å¼ å›¾ç‰‡...`,"info");let $=0,O=!0;for(;O;){I.value=`${u.name} - å·²å¤„ç† ${$}/${H} å¼ `,B.value=H>0?Math.round($/H*100):0;const P=await as(c);if(!P.success)throw new Error(P.error||"MOBI/AZW æ‰¹æ¬¡è§£æå¤±è´¥");if(P.images&&P.images.length>0){for(let v=0;v<P.images.length;v++){const F=P.images[v];if(!F)continue;const d=$+v+1,y=`${u.name.replace(/\.(mobi|azw|azw3)$/i,"")}_image_${String(d).padStart(3,"0")}.png`,ue=F.startsWith("data:")?F:`data:image/png;base64,${F}`;l.addImage(y,ue)}$+=P.images.length}O=P.has_more??!1}return $}catch(M){throw console.error("MOBI/AZW è§£æå¤±è´¥:",M),M}finally{if(c)try{await ls(c)}catch(M){console.warn("MOBI/AZW ä¼šè¯æ¸…ç†å¤±è´¥:",M)}}}function b(){D.value=""}return t({triggerFileSelect:N,triggerFolderSelect:U,processFiles:ie,clearError:b}),(u,c)=>(R(),E("div",Ks,[e("div",{id:"drop-area",class:Te(["drop-area",{"drag-over":S.value,loading:T.value}]),onDragover:V,onDragleave:Y,onDrop:k},[e("div",{class:"drop-content"},[e("p",{class:"drop-text"},[c[0]||(c[0]=Ce(" æ‹–æ‹½å›¾ç‰‡ã€PDFæˆ–MOBIæ–‡ä»¶åˆ°è¿™é‡Œï¼Œæˆ– ",-1)),e("span",{class:"select-link",onClick:N}," é€‰æ‹©æ–‡ä»¶ "),c[1]||(c[1]=e("span",{class:"separator"}," | ",-1)),e("span",{class:"select-link folder-link",onClick:U}," ğŸ“ é€‰æ‹©æ–‡ä»¶å¤¹ "),c[2]||(c[2]=e("span",{class:"separator"}," | ",-1)),e("span",{class:"select-link web-import-link",onClick:W}," ğŸŒ ä»ç½‘é¡µå¯¼å…¥ ")])]),e("input",{ref_key:"fileInputRef",ref:r,type:"file",id:"imageUpload",accept:"image/*,application/pdf,.mobi,.azw,.azw3",multiple:"",class:"file-input",onChange:C},null,544),e("input",{ref_key:"folderInputRef",ref:h,type:"file",webkitdirectory:"",class:"file-input",onChange:f},null,544)],34),A.value?(R(),st(go,{key:0,visible:!0,percentage:B.value,label:I.value||"å¤„ç†ä¸­..."},null,8,["percentage","label"])):ge("",!0),D.value?(R(),E("div",{key:1,class:"error-message",onClick:b},[c[3]||(c[3]=e("span",{class:"error-icon"},"âš ï¸",-1)),e("span",qs,oe(D.value),1),c[4]||(c[4]=e("span",{class:"error-close"},"Ã—",-1))])):ge("",!0),T.value&&!A.value?(R(),E("div",Hs,[...c[5]||(c[5]=[e("div",{class:"spinner"},null,-1),e("span",{class:"loading-text"},"å¤„ç†ä¸­...",-1)])])):ge("",!0)]))}}),Js=je(js,[["__scopeId","data-v-5ff3dc04"]]),Gs={id:"settings-sidebar",class:"settings-sidebar"},Ys={class:"card settings-card"},Xs={id:"font-settings",class:"settings-card collapsible-panel"},Zs={class:"toggle-icon"},Qs={class:"collapsible-content"},ea={class:"settings-form"},ta={class:"form-group"},oa=["value","disabled","title"],na={class:"auto-fontSize-option",title:"å‹¾é€‰åï¼Œé¦–æ¬¡ç¿»è¯‘æ—¶è‡ªåŠ¨ä¸ºæ¯ä¸ªæ°”æ³¡è®¡ç®—åˆé€‚çš„å­—å·"},sa=["checked"],aa={class:"form-group"},la={class:"form-group"},ia={class:"form-group"},ra={class:"color-with-auto"},ua={class:"auto-color-toggle",title:"ç¿»è¯‘æ—¶è‡ªåŠ¨ä½¿ç”¨è¯†åˆ«åˆ°çš„æ–‡å­—é¢œè‰²"},ca=["checked"],da=["value","disabled"],ga={key:0,class:"auto-color-hint"},pa={class:"form-group"},ma={class:"checkbox-label"},va=["checked"],fa={key:0,id:"strokeOptions",class:"stroke-options"},ba={class:"form-group"},ha=["value"],ya={class:"form-group"},xa=["value"],_a={class:"form-group"},ka={key:0,id:"solidColorOptions",class:"form-group"},Ca=["value"],Sa={class:"apply-settings-group"},wa=["disabled"],$a={key:0,class:"apply-options-dropdown"},Ta={class:"apply-option"},Ia=["checked"],Ra={class:"apply-option"},Pa={class:"apply-option"},Da={class:"apply-option"},Ma={class:"apply-option"},Ea={class:"apply-option"},Ba={class:"apply-option"},Aa={class:"apply-option"},La={class:"apply-option"},Fa={class:"action-buttons"},Ua=["disabled"],Oa=["disabled"],za=["disabled"],Na=["disabled"],Va=["disabled"],Wa=["disabled"],Ka=["disabled"],qa=["disabled"],Ha={class:"navigation-buttons"},ja=["disabled"],Ja=["disabled"],Ga=Je({__name:"SettingsSidebar",emits:["translateCurrent","translateAll","hqTranslate","proofread","removeText","removeAllText","deleteCurrent","clearAll","cleanTemp","openPlugins","openSettings","previous","next","applyToAll","textStyleChanged","autoFontSizeChanged"],setup(s,{emit:t}){const n=t,o=Qe(),l=Ue(),i=_(!0),a=_(!1),r=_({fontSize:!0,fontFamily:!0,layoutDirection:!0,textColor:!0,fillColor:!0,strokeEnabled:!0,strokeColor:!0,strokeWidth:!0}),h=[{label:"è‡ªåŠ¨ (æ ¹æ®æ£€æµ‹)",value:"auto"},{label:"ç«–å‘æ’ç‰ˆ",value:"vertical"},{label:"æ¨ªå‘æ’ç‰ˆ",value:"horizontal"}],T=[{label:"çº¯è‰²å¡«å……",value:"solid"},{label:"LAMAä¿®å¤ (é€Ÿåº¦ä¼˜åŒ–)",value:"lama_mpe"},{label:"LAMAä¿®å¤ (é€šç”¨)",value:"litelama"}],S=q(()=>o.currentImage),D=q(()=>o.hasImages),B=q(()=>D.value&&!o.isBatchTranslationInProgress),I=q(()=>o.canGoPrevious),A=q(()=>o.canGoNext),w=q(()=>l.textStyle),N=_([]),W=["fonts/STSONG.TTF","fonts/msyh.ttc","fonts/simhei.ttf","fonts/simsun.ttc"],U=_(null),f=q(()=>{const P=N.value.map(v=>({label:ie(v),value:v}));return P.push({label:"è‡ªå®šä¹‰å­—ä½“...",value:"custom-font"}),P});ut(async()=>{await g();const P=w.value.fontFamily;P&&!N.value.includes(P)&&(N.value=[P,...N.value])});async function g(){try{const P=await sn();if(P.fonts&&Array.isArray(P.fonts)&&P.fonts.length>0){const v=P.fonts[0];if(typeof v=="object"&&"path"in v){const F=P.fonts.map(d=>typeof d=="object"?d.path:d);N.value=F}else N.value=P.fonts}else N.value=[...W]}catch(P){console.error("åŠ è½½å­—ä½“åˆ—è¡¨å¤±è´¥:",P),N.value=[...W]}}function C(){i.value=!i.value}function k(P){const v=parseInt(P.target.value);isNaN(v)||(l.updateTextStyle({fontSize:v}),n("textStyleChanged","fontSize",v))}function V(P){const v=P.target.checked;l.updateTextStyle({autoFontSize:v}),console.log(`è‡ªåŠ¨å­—å·è®¾ç½®å˜æ›´: ${v}`),n("autoFontSizeChanged",v)}async function Y(P){const v=P.target,F=v.files?.[0];if(!F)return;const d=[".ttf",".ttc",".otf"],y=F.name.toLowerCase();if(!d.some(L=>y.endsWith(L))){fe("è¯·é€‰æ‹© .ttfã€.ttc æˆ– .otf æ ¼å¼çš„å­—ä½“æ–‡ä»¶","error"),v.value="";return}try{const L=await ds(F);L.success&&L.fontPath?(await g(),l.updateTextStyle({fontFamily:L.fontPath}),fe("å­—ä½“ä¸Šä¼ æˆåŠŸ","success")):fe(L.error||"å­—ä½“ä¸Šä¼ å¤±è´¥","error")}catch(L){console.error("å­—ä½“ä¸Šä¼ å¤±è´¥:",L),fe("å­—ä½“ä¸Šä¼ å¤±è´¥","error")}finally{v.value=""}}function ie(P){const v={"fonts/STXINGKA.TTF":"åæ–‡è¡Œæ¥·","fonts/STXINWEI.TTF":"åæ–‡æ–°é­","fonts/STZHONGS.TTF":"åæ–‡ä¸­å®‹","fonts/STKAITI.TTF":"æ¥·ä½“","fonts/STLITI.TTF":"éš¶ä¹¦","fonts/STSONG.TTF":"åæ–‡å®‹ä½“","fonts/msyh.ttc":"å¾®è½¯é›…é»‘","fonts/msyhbd.ttc":"å¾®è½¯é›…é»‘ç²—ä½“","fonts/SIMYOU.TTF":"å¹¼åœ†","fonts/STFANGSO.TTF":"ä»¿å®‹","fonts/STHUPO.TTF":"åæ–‡ç¥ç€","fonts/STXIHEI.TTF":"åæ–‡ç»†é»‘","fonts/simkai.ttf":"ä¸­æ˜“æ¥·ä½“","fonts/simfang.ttf":"ä¸­æ˜“ä»¿å®‹","fonts/simhei.ttf":"ä¸­æ˜“é»‘ä½“","fonts/SIMLI.TTF":"ä¸­æ˜“éš¶ä¹¦","fonts/simsun.ttc":"å®‹ä½“"};if(v[P])return v[P];const F=P.split("/").pop()||P;for(const[d,y]of Object.entries(v))if((d.split("/").pop()||"").toLowerCase()===F.toLowerCase())return y;return F.replace(/\.(ttf|ttc|otf)$/i,"")}function X(P){const v=String(P);if(v==="custom-font"){U.value?.click();return}l.updateTextStyle({fontFamily:v}),n("textStyleChanged","fontFamily",v)}function ae(P){const v=String(P);l.updateTextStyle({layoutDirection:v}),n("textStyleChanged","layoutDirection",v)}function Q(P){const v=String(P);l.updateTextStyle({inpaintMethod:v})}function p(P){const v=P.target.value;l.updateTextStyle({textColor:v}),n("textStyleChanged","textColor",v)}function m(P){const v=P.target.checked;l.updateTextStyle({useAutoTextColor:v})}function x(P){const v=P.target.checked;l.updateTextStyle({strokeEnabled:v}),n("textStyleChanged","strokeEnabled",v)}function b(P){const v=P.target.value;l.updateTextStyle({strokeColor:v}),n("textStyleChanged","strokeColor",v)}function u(P){const v=parseInt(P.target.value);isNaN(v)||(l.updateTextStyle({strokeWidth:v}),n("textStyleChanged","strokeWidth",v))}function c(P){const v=P.target.value;l.updateTextStyle({fillColor:v}),n("textStyleChanged","fillColor",v)}function M(){a.value=!a.value}function H(){const v=!Object.values(r.value).every(F=>F);r.value={fontSize:v,fontFamily:v,layoutDirection:v,textColor:v,fillColor:v,strokeEnabled:v,strokeColor:v,strokeWidth:v}}function $(){n("applyToAll",{...r.value}),a.value=!1}function O(P){P.target.closest(".apply-settings-group")||(a.value=!1)}return typeof window<"u"&&window.addEventListener("click",O),(P,v)=>(R(),E("aside",Gs,[e("div",Ys,[v[43]||(v[43]=e("h2",null,"ç¿»è¯‘è®¾ç½®",-1)),e("div",Xs,[e("h3",{class:"collapsible-header",onClick:C},[v[20]||(v[20]=Ce(" æ–‡å­—è®¾ç½® ",-1)),e("span",Zs,oe(i.value?"â–¼":"â–¶"),1)]),ne(e("div",Qs,[e("div",ea,[e("div",ta,[v[22]||(v[22]=e("label",{for:"fontSize"},"å­—å·å¤§å°:",-1)),e("input",{type:"number",id:"fontSize",value:w.value.fontSize,min:"10",max:"100",disabled:w.value.autoFontSize,class:Te({"disabled-input":w.value.autoFontSize}),title:w.value.autoFontSize?"å·²å¯ç”¨è‡ªåŠ¨å­—å·ï¼Œé¦–æ¬¡ç¿»è¯‘æ—¶å°†è‡ªåŠ¨è®¡ç®—":"",onInput:k},null,42,oa),e("span",na,[e("input",{type:"checkbox",id:"autoFontSize",checked:w.value.autoFontSize,onChange:V},null,40,sa),v[21]||(v[21]=e("label",{for:"autoFontSize"},"è‡ªåŠ¨è®¡ç®—åˆå§‹å­—å·",-1))])]),e("div",aa,[v[23]||(v[23]=e("label",{for:"fontFamily"},"æ–‡æœ¬å­—ä½“:",-1)),ye(Ne,{"model-value":w.value.fontFamily,options:f.value,onChange:X},null,8,["model-value","options"]),e("input",{ref_key:"fontUploadInput",ref:U,type:"file",id:"fontUpload",accept:".ttf,.ttc,.otf",style:{display:"none"},onChange:Y},null,544)]),e("div",la,[v[24]||(v[24]=e("label",{for:"layoutDirection"},"æ’ç‰ˆè®¾ç½®:",-1)),ye(Ne,{"model-value":w.value.layoutDirection,options:h,onChange:ae},null,8,["model-value"])]),e("div",ia,[v[26]||(v[26]=e("label",{for:"textColor"},"æ–‡å­—é¢œè‰²:",-1)),e("div",ra,[e("label",ua,[e("input",{type:"checkbox",checked:w.value.useAutoTextColor,onChange:m},null,40,ca),v[25]||(v[25]=e("span",null,"è‡ªåŠ¨",-1))]),e("input",{type:"color",id:"textColor",value:w.value.textColor,disabled:w.value.useAutoTextColor,onInput:p},null,40,da)]),w.value.useAutoTextColor?(R(),E("div",ga," ğŸ’¡ ç¿»è¯‘æ—¶å°†è‡ªåŠ¨ä½¿ç”¨è¯†åˆ«åˆ°çš„æ–‡å­—é¢œè‰² ")):ge("",!0)]),e("div",pa,[e("span",ma,[e("input",{type:"checkbox",id:"strokeEnabled",checked:w.value.strokeEnabled,onChange:x},null,40,va),v[27]||(v[27]=e("label",{for:"strokeEnabled"},"å¯ç”¨æ–‡æœ¬æè¾¹:",-1))])]),ye(Vo,{name:"stroke-slide"},{default:yt(()=>[w.value.strokeEnabled?(R(),E("div",fa,[e("div",ba,[v[28]||(v[28]=e("label",{for:"strokeColor"},"æè¾¹é¢œè‰²:",-1)),e("input",{type:"color",id:"strokeColor",value:w.value.strokeColor,onInput:b},null,40,ha)]),e("div",ya,[v[29]||(v[29]=e("label",{for:"strokeWidth"},"æè¾¹å®½åº¦ (px):",-1)),e("input",{type:"number",id:"strokeWidth",value:w.value.strokeWidth,min:"0",max:"10",style:{width:"60px",padding:"5px"},onInput:u},null,40,xa),v[30]||(v[30]=e("div",{class:"input-hint"},"0 è¡¨ç¤ºæ— æè¾¹ã€‚",-1))])])):ge("",!0)]),_:1}),e("div",_a,[v[31]||(v[31]=e("label",{for:"useInpainting"},"æ°”æ³¡å¡«å……æ–¹å¼:",-1)),ye(Ne,{"model-value":w.value.inpaintMethod,options:T,onChange:Q},null,8,["model-value"])]),ye(Vo,{name:"slide-fade"},{default:yt(()=>[w.value.inpaintMethod==="solid"?(R(),E("div",ka,[v[32]||(v[32]=e("label",{for:"fillColor"},"å¡«å……é¢œè‰²:",-1)),e("input",{type:"color",id:"fillColor",value:w.value.fillColor,onInput:c},null,40,Ca)])):ge("",!0)]),_:1})]),e("div",Sa,[e("button",{type:"button",class:"settings-button",disabled:!D.value,onClick:$}," åº”ç”¨åˆ°å…¨éƒ¨ ",8,wa),e("button",{type:"button",class:"settings-gear-btn",title:"é€‰æ‹©è¦åº”ç”¨çš„å‚æ•°",onClick:M}," âš™ï¸ "),a.value?(R(),E("div",$a,[e("div",Ta,[e("input",{type:"checkbox",id:"apply_selectAll",checked:Object.values(r.value).every(F=>F),onChange:H},null,40,Ia),v[33]||(v[33]=e("label",{for:"apply_selectAll"},"å…¨é€‰",-1))]),v[42]||(v[42]=e("hr",null,null,-1)),e("div",Ra,[ne(e("input",{type:"checkbox",id:"apply_fontSize","onUpdate:modelValue":v[0]||(v[0]=F=>r.value.fontSize=F)},null,512),[[et,r.value.fontSize]]),v[34]||(v[34]=e("label",{for:"apply_fontSize"},"å­—å·",-1))]),e("div",Pa,[ne(e("input",{type:"checkbox",id:"apply_fontFamily","onUpdate:modelValue":v[1]||(v[1]=F=>r.value.fontFamily=F)},null,512),[[et,r.value.fontFamily]]),v[35]||(v[35]=e("label",{for:"apply_fontFamily"},"å­—ä½“",-1))]),e("div",Da,[ne(e("input",{type:"checkbox",id:"apply_layoutDirection","onUpdate:modelValue":v[2]||(v[2]=F=>r.value.layoutDirection=F)},null,512),[[et,r.value.layoutDirection]]),v[36]||(v[36]=e("label",{for:"apply_layoutDirection"},"æ’ç‰ˆæ–¹å‘",-1))]),e("div",Ma,[ne(e("input",{type:"checkbox",id:"apply_textColor","onUpdate:modelValue":v[3]||(v[3]=F=>r.value.textColor=F)},null,512),[[et,r.value.textColor]]),v[37]||(v[37]=e("label",{for:"apply_textColor"},"æ–‡å­—é¢œè‰²",-1))]),e("div",Ea,[ne(e("input",{type:"checkbox",id:"apply_fillColor","onUpdate:modelValue":v[4]||(v[4]=F=>r.value.fillColor=F)},null,512),[[et,r.value.fillColor]]),v[38]||(v[38]=e("label",{for:"apply_fillColor"},"å¡«å……é¢œè‰²",-1))]),e("div",Ba,[ne(e("input",{type:"checkbox",id:"apply_strokeEnabled","onUpdate:modelValue":v[5]||(v[5]=F=>r.value.strokeEnabled=F)},null,512),[[et,r.value.strokeEnabled]]),v[39]||(v[39]=e("label",{for:"apply_strokeEnabled"},"æè¾¹å¼€å…³",-1))]),e("div",Aa,[ne(e("input",{type:"checkbox",id:"apply_strokeColor","onUpdate:modelValue":v[6]||(v[6]=F=>r.value.strokeColor=F)},null,512),[[et,r.value.strokeColor]]),v[40]||(v[40]=e("label",{for:"apply_strokeColor"},"æè¾¹é¢œè‰²",-1))]),e("div",La,[ne(e("input",{type:"checkbox",id:"apply_strokeWidth","onUpdate:modelValue":v[7]||(v[7]=F=>r.value.strokeWidth=F)},null,512),[[et,r.value.strokeWidth]]),v[41]||(v[41]=e("label",{for:"apply_strokeWidth"},"æè¾¹å®½åº¦",-1))])])):ge("",!0)])],512),[[Fe,i.value]])]),e("div",Fa,[e("button",{id:"translateButton",disabled:!B.value,onClick:v[8]||(v[8]=F=>n("translateCurrent"))}," ç¿»è¯‘å½“å‰å›¾ç‰‡ ",8,Ua),e("button",{id:"translateAllButton",disabled:!B.value,onClick:v[9]||(v[9]=F=>n("translateAll"))}," ç¿»è¯‘æ‰€æœ‰å›¾ç‰‡ ",8,Oa),e("button",{id:"startHqTranslationBtn",class:"settings-button purple-button",disabled:!B.value,title:"ä½¿ç”¨é«˜è´¨é‡ç¿»è¯‘æ¨¡å¼ï¼ˆéœ€åœ¨è®¾ç½®ä¸­é…ç½®ï¼‰",onClick:v[10]||(v[10]=F=>n("hqTranslate"))}," é«˜è´¨é‡ç¿»è¯‘ ",8,za),e("button",{id:"proofreadButton",disabled:!B.value,onClick:v[11]||(v[11]=F=>n("proofread"))}," AIæ ¡å¯¹ ",8,Na),e("button",{id:"removeTextOnlyButton",disabled:!S.value,title:"æ¶ˆé™¤å›¾ç‰‡ä¸­çš„æ°”æ³¡æ–‡å­—ï¼Œæ— éœ€å¡«å†™ç¿»è¯‘æœåŠ¡å•†å’ŒAPI Key",onClick:v[12]||(v[12]=F=>n("removeText"))}," ä»…æ¶ˆé™¤æ–‡å­— ",8,Va),e("button",{id:"removeAllTextButton",disabled:!D.value,title:"æ¶ˆé™¤æ‰€æœ‰å›¾ç‰‡ä¸­çš„æ°”æ³¡æ–‡å­—ï¼Œæ— éœ€å¡«å†™ç¿»è¯‘æœåŠ¡å•†å’ŒAPI Key",onClick:v[13]||(v[13]=F=>n("removeAllText"))}," æ¶ˆé™¤æ‰€æœ‰å›¾ç‰‡æ–‡å­— ",8,Wa),e("button",{id:"deleteCurrentImageButton",class:"settings-button red-button",disabled:!S.value,onClick:v[14]||(v[14]=F=>n("deleteCurrent"))}," åˆ é™¤å½“å‰å›¾ç‰‡ ",8,Ka),e("button",{id:"clearAllImagesButton",class:"settings-button red-button",disabled:!D.value,onClick:v[15]||(v[15]=F=>n("clearAll"))}," æ¸…é™¤æ‰€æœ‰å›¾ç‰‡ ",8,qa),e("button",{id:"cleanDebugFilesButton",class:"settings-button orange-button",onClick:v[16]||(v[16]=F=>n("cleanTemp"))}," æ¸…ç†ä¸´æ—¶æ–‡ä»¶ "),e("button",{id:"managePluginsButton",class:"settings-button blue-button",onClick:v[17]||(v[17]=F=>n("openPlugins"))}," æ’ä»¶ç®¡ç† ")]),e("div",Ha,[e("button",{id:"prevImageButton",disabled:!I.value,onClick:v[18]||(v[18]=F=>n("previous"))}," ä¸Šä¸€å¼  ",8,ja),e("button",{id:"nextImageButton",disabled:!A.value,onClick:v[19]||(v[19]=F=>n("next"))}," ä¸‹ä¸€å¼  ",8,Ja)])])]))}}),Ya=je(Ga,[["__scopeId","data-v-df51db99"]]);function Ct(s){if(s.textDirection&&s.textDirection!=="auto")return s.textDirection;if(s.autoTextDirection&&s.autoTextDirection!=="auto")return s.autoTextDirection;if(s.coords){const[t,n,o,l]=s.coords;return l-n>o-t?"vertical":"horizontal"}return"vertical"}function Xa(){const s=Qe(),t=Ue(),n=rt(),o=_(!1),l=_(0),i=_(""),a=_(!1),r=_(0),h=_(""),T=q(()=>s.hasImages),S=q(()=>s.hasImages),D=q(()=>s.hasImages);function B(){const f=s.images;if(f.length===0){n.warning("æ²¡æœ‰å¯å¯¼å‡ºçš„å›¾ç‰‡æ–‡æœ¬");return}const g=[];for(let ae=0;ae<f.length;ae++){const Q=f[ae];if(!Q)continue;const p=Q.bubbleStates||[],m={imageIndex:ae,bubbles:[]};for(let x=0;x<p.length;x++){const b=p[x];if(!b)continue;const u=b.originalText||"",c=b.translatedText||b.textboxText||"";let M="vertical";b.textDirection&&b.textDirection!=="auto"?M=b.textDirection:b.autoTextDirection&&(M=b.autoTextDirection),m.bubbles.push({bubbleIndex:x,original:u,translated:c,textDirection:M})}g.push(m)}const C=JSON.stringify(g,null,2),k=new Blob([C],{type:"application/json"}),V=URL.createObjectURL(k),Y=document.createElement("a");Y.href=V;const X=new Date().toISOString().replace(/[-:T]/g,"").slice(0,15);Y.download=`translations_${X}.json`,document.body.appendChild(Y),Y.click(),document.body.removeChild(Y),URL.revokeObjectURL(V),n.success("æ–‡æœ¬å¯¼å‡ºæˆåŠŸï¼")}function I(){const f=s.images;if(f.length===0)return null;const g=[];for(let C=0;C<f.length;C++){const k=f[C];if(!k)continue;const V=k.bubbleStates||[],Y={imageIndex:C,bubbles:[]};for(let ie=0;ie<V.length;ie++){const X=V[ie];if(!X)continue;const ae=X.originalText||"",Q=X.translatedText||X.textboxText||"";let p="vertical";X.textDirection&&X.textDirection!=="auto"?p=X.textDirection:X.autoTextDirection&&(p=X.autoTextDirection),Y.bubbles.push({bubbleIndex:ie,original:ae,translated:Q,textDirection:p})}g.push(Y)}return g}async function A(f){if(!f){n.warning("æœªé€‰æ‹©æ–‡ä»¶");return}a.value=!0,r.value=0,h.value="å‡†å¤‡å¯¼å…¥æ–‡æœ¬...",n.info("æ­£åœ¨å¯¼å…¥æ–‡æœ¬...",0);try{const g=await w(f);r.value=10,h.value="è§£æ JSON æ•°æ®...";const C=JSON.parse(g);if(!Array.isArray(C))throw new Error("å¯¼å…¥çš„ JSON æ ¼å¼ä¸æ­£ç¡®ï¼Œåº”ä¸ºæ•°ç»„");let k=0,V=0;const Y=t.settings.textStyle,ie=Y.autoFontSize?"auto":Y.fontSize,X=Y.fontFamily,ae=Y.textColor,Q=Y.fillColor;r.value=20,h.value="å¼€å§‹æ›´æ–°å›¾ç‰‡...";const p=C.length;let m=0;const x=[];for(const c of C){m++;const M=20+m/p*60;r.value=M,h.value=`å¤„ç†å›¾ç‰‡ ${m}/${p}`;const H=c.imageIndex;if(H<0||H>=s.images.length){console.warn(`è·³è¿‡æ— æ•ˆçš„å›¾ç‰‡ç´¢å¼•: ${H}`);continue}const $=s.images[H];if(!$)continue;let O=!1;$.bubbleStates||($.bubbleStates=[]),$.bubbleTexts||($.bubbleTexts=[]),$.originalTexts||($.originalTexts=[]);for(const P of c.bubbles){const v=P.bubbleIndex,F=P.original,d=P.translated,y=P.textDirection,ue=y==="vertical"||y==="horizontal"?y:"vertical";for(;$.bubbleTexts.length<=v;)$.bubbleTexts.push("");for(;$.originalTexts.length<=v;)$.originalTexts.push("");for(F&&($.originalTexts[v]=F),d&&($.bubbleTexts[v]=d);$.bubbleStates.length<=v;)$.bubbleStates.push(N(ie,X,ae,Q));const L=$.bubbleStates[v];L&&(F&&(L.originalText=F),d&&(L.translatedText=d,L.textboxText=d),L.textDirection=ue,O=!0,V++)}O&&$.bubbleStates&&($.bubbleTexts=$.bubbleStates.map(P=>P.translatedText||"")),O&&(k++,$.hasUnsavedChanges=!0,$.translatedDataURL&&$.bubbleStates&&$.bubbleStates.length>0&&x.push(H))}if(x.length>0){r.value=80,h.value="å¼€å§‹æ¸²æŸ“å›¾ç‰‡...",n.info("æ­£åœ¨æ¸²æŸ“å›¾ç‰‡ï¼Œè¯·ç¨å€™...",0);const c=t.settings.textStyle,M=c.layoutDirection,H=M==="auto";for(let $=0;$<x.length;$++){const O=x[$];if(O===void 0)continue;const P=s.images[O];if(!(!P||!P.bubbleStates)){r.value=80+$/x.length*20,h.value=`æ¸²æŸ“å›¾ç‰‡ ${$+1}/${x.length}`;try{let v="";if(P.cleanImageData?v=P.cleanImageData.includes("base64,")?P.cleanImageData.split("base64,")[1]||"":P.cleanImageData:P.originalDataURL&&(v=P.originalDataURL.includes("base64,")?P.originalDataURL.split("base64,")[1]||"":P.originalDataURL,console.log(`importText: å›¾ç‰‡ ${O} ä½¿ç”¨åŸå›¾ä½œä¸ºèƒŒæ™¯ï¼ˆå…œåº•ï¼‰`)),!v){console.log(`importText: å›¾ç‰‡ ${O} æ²¡æœ‰å¯ç”¨çš„èƒŒæ™¯å›¾ï¼Œè·³è¿‡`);continue}const F=P.bubbleStates.map(y=>({translatedText:y.translatedText||"",coords:y.coords,fontSize:y.fontSize||c.fontSize,fontFamily:y.fontFamily||c.fontFamily,textDirection:Ct(y),textColor:y.textColor||c.textColor,rotationAngle:y.rotationAngle||0,position:y.position||{x:0,y:0},strokeEnabled:y.strokeEnabled??c.strokeEnabled,strokeColor:y.strokeColor||c.strokeColor,strokeWidth:y.strokeWidth??c.strokeWidth})),d=await uo({clean_image:v,bubble_texts:F.map(y=>y.translatedText),bubble_coords:F.map(y=>y.coords),fontSize:c.fontSize,fontFamily:c.fontFamily,textDirection:H?"vertical":M,textColor:c.textColor,bubble_states:F,use_individual_styles:!0,use_inpainting:!1,use_lama:!1,is_font_style_change:!0,strokeEnabled:c.strokeEnabled,strokeColor:c.strokeColor,strokeWidth:c.strokeWidth});d.rendered_image&&(s.updateImageByIndex(O,{translatedDataURL:`data:image/png;base64,${d.rendered_image}`,hasUnsavedChanges:!0}),console.log(`importText: å›¾ç‰‡ ${O} æ¸²æŸ“æˆåŠŸ`))}catch(v){console.error(`importText: é‡æ¸²æŸ“å›¾ç‰‡ ${O} å¤±è´¥:`,v)}}}}r.value=100,h.value="å¯¼å…¥å®Œæˆ";const b=x.length,u=b>0?`å¯¼å…¥æˆåŠŸï¼æ›´æ–°äº† ${k} å¼ å›¾ç‰‡ä¸­çš„ ${V} ä¸ªæ°”æ³¡æ–‡æœ¬ï¼Œé‡æ¸²æŸ“äº† ${b} å¼ å›¾ç‰‡`:`å¯¼å…¥æˆåŠŸï¼æ›´æ–°äº† ${k} å¼ å›¾ç‰‡ä¸­çš„ ${V} ä¸ªæ°”æ³¡æ–‡æœ¬`;n.success(u)}catch(g){console.error("å¯¼å…¥æ–‡æœ¬å‡ºé”™:",g),n.error(`å¯¼å…¥å¤±è´¥: ${g instanceof Error?g.message:String(g)}`)}finally{a.value=!1,setTimeout(()=>{r.value=0,h.value=""},2e3)}}function w(f){return new Promise((g,C)=>{const k=new FileReader;k.onload=V=>{V.target?.result?g(V.target.result):C(new Error("è¯»å–æ–‡ä»¶å¤±è´¥"))},k.onerror=()=>C(new Error("è¯»å–æ–‡ä»¶æ—¶å‡ºé”™")),k.readAsText(f)})}function N(f,g,C,k){const V=t.settings.textStyle;return{coords:[0,0,100,100],polygon:[],originalText:"",translatedText:"",textboxText:"",fontSize:typeof f=="number"?f:25,fontFamily:g,textDirection:"vertical",autoTextDirection:"vertical",textColor:C,fillColor:k,rotationAngle:0,position:{x:0,y:0},strokeEnabled:V.strokeEnabled,strokeColor:V.strokeColor,strokeWidth:V.strokeWidth,inpaintMethod:V.inpaintMethod}}function W(){const f=s.currentImage;if(!f){n.warning("æ²¡æœ‰å¯ä¸‹è½½çš„å›¾ç‰‡");return}const g=f.translatedDataURL||f.originalDataURL;if(!g){n.warning("æ²¡æœ‰å¯ä¸‹è½½çš„å›¾ç‰‡");return}o.value=!0;try{const C=g.split(",")[1];if(!C)throw new Error("æ— æ•ˆçš„å›¾ç‰‡æ•°æ®");const k=atob(C),V=[];for(let p=0;p<k.length;p+=512){const m=k.slice(p,p+512),x=new Array(m.length);for(let u=0;u<m.length;u++)x[u]=m.charCodeAt(u);const b=new Uint8Array(x);V.push(b.buffer)}const Y=new Blob(V,{type:"image/png"}),ie=URL.createObjectURL(Y),X=document.createElement("a");X.href=ie;let ae=f.fileName||`image_${s.currentImageIndex}.png`;ae=`${f.translatedDataURL?"translated":"original"}_${ae.replace(/\.[^/.]+$/,"")}.png`,X.download=ae,document.body.appendChild(X),X.click(),document.body.removeChild(X),URL.revokeObjectURL(ie),n.success(`ä¸‹è½½æˆåŠŸ: ${ae}`)}catch(C){console.error("ä¸‹è½½å›¾ç‰‡æ—¶å‡ºé”™:",C),n.error("ä¸‹è½½å¤±è´¥")}finally{o.value=!1}}async function U(f="zip"){const g=s.images;if(g.length===0){n.warning("æ²¡æœ‰å¯ä¸‹è½½çš„å›¾ç‰‡");return}o.value=!0,l.value=0,i.value="å‡†å¤‡ä¸‹è½½...",n.info("ä¸‹è½½ä¸­...å¤„ç†å¯èƒ½éœ€è¦ä¸€å®šæ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…...",0);try{const C=[];let k=0,V=0;l.value=5,i.value="æ£€æŸ¥å›¾ç‰‡æ•°æ®...";for(let u=0;u<g.length;u++){const c=g[u];c&&(c.translatedDataURL?(C.push({index:u,type:"translated"}),k++):c.originalDataURL&&(C.push({index:u,type:"original"}),V++))}if(C.length===0){n.warning("æ²¡æœ‰å¯ä¸‹è½½çš„å›¾ç‰‡");return}l.value=10,i.value="åˆ›å»ºä¸‹è½½ä¼šè¯...";const Y=await is(C.length);if(!Y.success||!Y.session_id)throw new Error(Y.error||"åˆ›å»ºä¼šè¯å¤±è´¥");const ie=Y.session_id,X=C.length;let ae=0,Q=0;for(let u=0;u<C.length;u++){const c=C[u];if(!c)continue;const M=g[c.index];if(!M)continue;const H=c.type==="translated"?M.translatedDataURL:M.originalDataURL;if(!H)continue;const $=10+u/X*70;l.value=$,i.value=`ä¸Šä¼ å›¾ç‰‡ ${u+1}/${X}...`;try{const O=await rs(ie,H,u);O.success?ae++:(console.error(`ä¸Šä¼ å›¾ç‰‡ ${u} å¤±è´¥:`,O.error),Q++)}catch(O){console.error(`ä¸Šä¼ å›¾ç‰‡ ${u} å‡ºé”™:`,O),Q++}}if(ae===0)throw new Error("æ‰€æœ‰å›¾ç‰‡ä¸Šä¼ å¤±è´¥");l.value=85,i.value="æ‰“åŒ…æ–‡ä»¶...";const p=await us(ie,f);if(!p.success||!p.file_id)throw new Error(p.error||"æ‰“åŒ…å¤±è´¥");l.value=95,i.value="å‡†å¤‡ä¸‹è½½...";const m=cs(p.file_id,f),x=document.createElement("a");x.href=m,document.body.appendChild(x),x.click(),document.body.removeChild(x),l.value=100,i.value="ä¸‹è½½å·²å¼€å§‹";let b=`å·²æˆåŠŸå¤„ç† ${ae} å¼ å›¾ç‰‡`;Q>0&&(b+=`ï¼ˆ${Q} å¼ å¤±è´¥ï¼‰`),k>0&&V>0?b+=`ï¼ˆ${k} å¼ ç¿»è¯‘å›¾ç‰‡å’Œ ${V} å¼ åŸå§‹å›¾ç‰‡ï¼‰`:k>0?b+="ï¼ˆå…¨éƒ¨ä¸ºç¿»è¯‘åå›¾ç‰‡ï¼‰":V>0&&(b+="ï¼ˆå…¨éƒ¨ä¸ºåŸå§‹å›¾ç‰‡ï¼‰"),b+="ï¼Œä¸‹è½½å³å°†å¼€å§‹",n.success(b),setTimeout(async()=>{try{const u=await ro();console.log("ä¸´æ—¶æ–‡ä»¶æ¸…ç†ç»“æœ:",u)}catch(u){console.error("æ¸…ç†ä¸´æ—¶æ–‡ä»¶å¤±è´¥:",u)}},6e4)}catch(C){console.error("ä¸‹è½½æ‰€æœ‰å›¾ç‰‡æ—¶å‡ºé”™:",C),n.error(`ä¸‹è½½å¤±è´¥: ${C instanceof Error?C.message:String(C)}`)}finally{o.value=!1,setTimeout(()=>{l.value=0,i.value=""},2e3)}}return{isDownloading:o,downloadProgress:l,downloadProgressText:i,isImporting:a,importProgress:r,importProgressText:h,canExportText:T,canImportText:S,canDownload:D,exportText:B,exportTextToJson:I,importText:A,downloadCurrentImage:W,downloadAllImages:U}}const Za={key:0,class:"result-section card result-card"},Qa={class:"image-controls"},el={class:"image-size-control"},tl=["value"],ol={id:"imageSizeValue"},nl={class:"content-container"},sl={class:"image-container"},al=["src"],ll={id:"detectedTextInfo",class:"text-info"},il={id:"detectedTextList"},rl={class:"original-text"},ul={class:"download-section"},cl={class:"download-buttons"},dl=["disabled"],gl={class:"download-all-container"},pl=["disabled"],ml={class:"download-format-selector"},vl=["disabled"],fl=["disabled"],bl={key:1,class:"empty-state-section"},Qt=60,hl=Je({__name:"ImageResultDisplay",props:{isEditMode:{type:Boolean,default:!1}},emits:["toggle-edit-mode","retry-failed"],setup(s,{emit:t}){const n=[{label:"ZIPå‹ç¼©åŒ…",value:"zip"},{label:"PDFæ–‡æ¡£",value:"pdf"},{label:"CBZæ¼«ç”»",value:"cbz"}],o=t,l=Qe(),i=Ue(),a=Xa(),r=_(100),h=q({get:()=>w.value?.showOriginal??!1,set:$=>{w.value&&l.updateCurrentImage({showOriginal:$})}}),T=_("zip"),S=_(null),D=q(()=>a.isDownloading.value),B=q(()=>a.downloadProgressText.value),I=q(()=>a.downloadProgress.value),A=q(()=>l.hasImages),w=q(()=>l.currentImage),N=q(()=>!!w.value?.translatedDataURL),W=q(()=>!!(w.value?.translatedDataURL||w.value?.originalDataURL)),U=q(()=>w.value?h.value||!w.value.translatedDataURL?w.value.originalDataURL:w.value.translatedDataURL:""),f=q(()=>l.failedImageCount>0),g=q(()=>({width:`${r.value}%`})),C=q(()=>i.settings.useTextboxPrompt),k=q(()=>{if(!w.value)return[];if(w.value.bubbleStates&&w.value.bubbleStates.length>0)return w.value.bubbleStates.map(P=>({original:P.originalText||"",translated:C.value?P.textboxText||P.translatedText||"":P.translatedText||""}));const $=w.value.originalTexts||[],O=C.value?w.value.textboxTexts||w.value.bubbleTexts||[]:w.value.bubbleTexts||[];return $.length===0?[]:$.map((P,v)=>({original:P||"",translated:O[v]||""}))}),V=q(()=>k.value.length>0);function Y($){if(!$||$.length<=Qt)return $;let O="",P="";for(let v=0;v<$.length;v++)if(P+=$[v],P.length>=Qt){let F=-1;for(let d=P.length-1;d>=0;d--){const y=P[d];if(y&&["ã€‚","ï¼","ï¼Ÿ",".","!","?","ï¼›",";","ï¼Œ",","].includes(y)){F=d+1;break}}F>Qt*.6?(O+=P.substring(0,F)+`
`,P=P.substring(F)):(O+=P+`
`,P="")}return P&&(O+=P),O}function ie($){return Y(($||"").trim())}function X($){const O=($||"").trim();return Y(O)}function ae($){return($||"").includes("ç¿»è¯‘å¤±è´¥")}function Q(){h.value=!h.value}function p(){o("toggle-edit-mode")}function m($){const O=$.target;r.value=parseInt(O.value,10)}function x(){o("retry-failed")}function b(){a.downloadCurrentImage()}function u(){a.downloadAllImages(T.value)}function c(){a.exportText()}function M(){S.value?.click()}async function H($){const O=$.target,P=O.files?.[0];P&&(await a.importText(P),O.value="")}return($,O)=>w.value?(R(),E("section",Za,[e("div",Qa,[N.value?(R(),E("button",{key:0,id:"toggleImageButton",class:"control-btn",onClick:Q},oe(h.value?"æŸ¥çœ‹ç¿»è¯‘å›¾":"æŸ¥çœ‹åŸå›¾"),1)):ge("",!0),e("button",{id:"toggleEditModeButton",class:Te(["control-btn",{active:s.isEditMode}]),onClick:p},oe(s.isEditMode?"é€€å‡ºç¼–è¾‘":"åˆ‡æ¢ç¼–è¾‘æ¨¡å¼"),3),e("div",el,[O[1]||(O[1]=e("label",{for:"imageSize"},"å›¾ç‰‡å¤§å°:",-1)),e("input",{type:"range",id:"imageSize",min:"50",max:"200",value:r.value,class:"slider range-slider",onInput:m},null,40,tl),e("span",ol,oe(r.value)+"%",1)]),f.value?(R(),E("button",{key:1,id:"retranslateFailedButton",class:"retry-failed-btn",onClick:x,title:"é‡æ–°ç¿»è¯‘æ‰€æœ‰å¤±è´¥çš„å›¾ç‰‡"}," é‡æ–°ç¿»è¯‘å¤±è´¥å›¾ç‰‡ ("+oe(K(l).failedImageCount)+") ",1)):ge("",!0)]),e("div",nl,[e("div",sl,[e("img",{id:"translatedImageDisplay",src:U.value,alt:"ç¿»è¯‘åå›¾ç‰‡",style:ot(g.value)},null,12,al)])]),e("div",ll,[O[6]||(O[6]=e("h3",null,"æ£€æµ‹åˆ°çš„æ–‡æœ¬ï¼ˆåŸæ–‡ â†’ è¯‘æ–‡ï¼‰",-1)),e("pre",il,[V.value?(R(!0),E(Be,{key:0},He(k.value,(P,v)=>(R(),E("span",{key:v,class:"text-item"},[e("span",rl,oe(ie(P.original)),1),O[2]||(O[2]=Ce(`
`,-1)),e("span",{class:Te(["translated-text",{"translation-error":ae(P.translated)}])},oe(X(P.translated)),3),O[3]||(O[3]=Ce(`
`,-1)),O[4]||(O[4]=e("span",{class:"separator"},"â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€",-1)),O[5]||(O[5]=Ce(`

`,-1))]))),128)):(R(),E(Be,{key:1},[Ce("æœªæ£€æµ‹åˆ°æ–‡æœ¬æˆ–å°šæœªç¿»è¯‘")],64))])]),e("div",ul,[D.value?(R(),st(go,{key:0,visible:!0,percentage:I.value,label:B.value||"ä¸‹è½½ä¸­ï¼Œè¯·ç¨å€™..."},null,8,["percentage","label"])):ge("",!0),e("div",cl,[e("button",{id:"downloadButton",class:"download-btn primary",disabled:!W.value,onClick:b}," ä¸‹è½½å½“å‰å›¾ç‰‡ ",8,dl),e("div",gl,[e("button",{id:"downloadAllImagesButton",class:"download-btn primary",disabled:!A.value,onClick:u}," ä¸‹è½½æ‰€æœ‰å›¾ç‰‡ ",8,pl),e("div",ml,[ye(Ne,{modelValue:T.value,"onUpdate:modelValue":O[0]||(O[0]=P=>T.value=P),options:n},null,8,["modelValue"])])]),e("button",{id:"exportTextButton",class:"download-btn success",disabled:!A.value,onClick:c}," å¯¼å‡ºæ–‡æœ¬ ",8,vl),e("button",{id:"importTextButton",class:"download-btn success",disabled:!A.value,onClick:M}," å¯¼å…¥æ–‡æœ¬ ",8,fl),e("input",{type:"file",ref_key:"importFileInput",ref:S,id:"importTextFileInput",style:{display:"none"},accept:".json",onChange:H},null,544)])])])):(R(),E("section",bl))}}),yl=je(hl,[["__scopeId","data-v-a26b9c58"]]),xl={class:"guide-content"},_l={class:"guide-footer"},kl={class:"dont-show-option"},Bt="saber_translator_dismiss_setup_reminder",Cl=Je({__name:"FirstTimeGuide",emits:["openSettings"],setup(s,{expose:t,emit:n}){const o=n,l=_(!1),i=_(!1);ut(()=>{localStorage.getItem(Bt)!=="true"&&(l.value=!0)});function a(){i.value&&localStorage.setItem(Bt,"true"),l.value=!1}function r(){localStorage.setItem(Bt,"true"),l.value=!1,o("openSettings")}function h(){localStorage.removeItem(Bt)}return t({resetGuideState:h,showGuide:l}),(T,S)=>(R(),st(an,{"model-value":l.value,title:"æ¬¢è¿ä½¿ç”¨ Saber-Translator",onClose:a},{default:yt(()=>[e("div",xl,[S[3]||(S[3]=e("div",{class:"guide-icon"},"ğŸ‰",-1)),S[4]||(S[4]=e("div",{class:"guide-message"},[e("p",{class:"guide-title"},"é¦–æ¬¡ä½¿ç”¨æé†’"),e("p",{class:"guide-text"}," åœ¨å¼€å§‹ç¿»è¯‘ä¹‹å‰ï¼Œè¯·å…ˆé…ç½®ç¿»è¯‘æœåŠ¡ã€‚ "),e("p",{class:"guide-text"},[Ce(" ç‚¹å‡»å³ä¸Šè§’çš„ "),e("span",{class:"highlight"},"âš™ï¸ è®¾ç½®"),Ce(" æŒ‰é’®ï¼Œé…ç½®ä»¥ä¸‹å†…å®¹ï¼š ")]),e("ul",{class:"guide-list"},[e("li",null,"é€‰æ‹© OCR å¼•æ“ï¼ˆæ–‡å­—è¯†åˆ«ï¼‰"),e("li",null,"é…ç½®ç¿»è¯‘æœåŠ¡å•†å’Œ API Key"),e("li",null,"ï¼ˆå¯é€‰ï¼‰é…ç½®é«˜è´¨é‡ç¿»è¯‘å’Œ AI æ ¡å¯¹")])],-1)),e("div",{class:"guide-actions"},[e("button",{class:"guide-btn primary",onClick:r},[...S[1]||(S[1]=[e("span",{class:"btn-icon"},"âš™ï¸",-1),Ce(" ç«‹å³é…ç½® ",-1)])]),e("button",{class:"guide-btn secondary",onClick:a}," ç¨åé…ç½® ")]),e("div",_l,[e("label",kl,[ne(e("input",{type:"checkbox","onUpdate:modelValue":S[0]||(S[0]=D=>i.value=D)},null,512),[[et,i.value]]),S[2]||(S[2]=e("span",null,"ä¸å†æ˜¾ç¤ºæ­¤æé†’",-1))])])])]),_:1},8,["model-value"]))}}),Sl=je(Cl,[["__scopeId","data-v-eda18e4a"]]),eo="saber_translator_dismiss_setup_reminder",wl=["siliconflow","deepseek","volcano","caiyun","baidu_translate","youdao_translate","gemini","custom_openai"],$l={manga_ocr:"MangaOCR",paddle_ocr:"PaddleOCR",baidu_ocr:"ç™¾åº¦OCR",ai_vision:"AIè§†è§‰OCR"},Tl=["ollama","sakura"],Il=["custom_openai"],Rl=["custom_openai"],Pl={siliconflow:"SiliconFlow",deepseek:"DeepSeek",volcano:"ç«å±±å¼•æ“",caiyun:"å½©äº‘å°è¯‘",baidu_translate:"ç™¾åº¦ç¿»è¯‘",youdao_translate:"æœ‰é“ç¿»è¯‘",gemini:"Google Gemini",custom_openai:"è‡ªå®šä¹‰ OpenAI",ollama:"Ollama",sakura:"Sakura"};function cn(){const s=Ue(),t=rt(),n=_(!1),o=_(!1),l=q(()=>{try{return localStorage.getItem(eo)==="true"}catch{return!1}});function i(k){return Pl[k]||k}function a(k){return wl.includes(k)}function r(k){return Tl.includes(k)}function h(k){return Il.includes(k)}function T(k){return Rl.includes(k)}function S(k){return $l[k]||k}function D(){const k=s.settings,V=k.ocrEngine,Y=k.baiduOcr,ie=k.aiVisionOcr,X=[];return V?(V==="baidu_ocr"&&((!Y?.apiKey||Y.apiKey.trim()==="")&&X.push("ç™¾åº¦OCR çš„ API Key"),(!Y?.secretKey||Y.secretKey.trim()==="")&&X.push("ç™¾åº¦OCR çš„ Secret Key")),V==="ai_vision"&&(ie?.provider||X.push("AIè§†è§‰OCR çš„æœåŠ¡å•†"),(!ie?.apiKey||ie.apiKey.trim()==="")&&X.push("AIè§†è§‰OCR çš„ API Key"),(!ie?.modelName||ie.modelName.trim()==="")&&X.push("AIè§†è§‰OCR çš„æ¨¡å‹åç§°"),ie?.provider==="custom"&&(!ie?.customBaseUrl||ie.customBaseUrl.trim()==="")&&X.push("AIè§†è§‰OCR çš„è‡ªå®šä¹‰ Base URL")),X.length>0?{valid:!1,message:`è¯·å…ˆåœ¨é¡¶éƒ¨ âš™ï¸ è®¾ç½®èœå•ä¸­å¡«å†™ ${X[0]}`,missingItems:X}:{valid:!0,message:""}):{valid:!1,message:"è¯·å…ˆåœ¨é¡¶éƒ¨ âš™ï¸ è®¾ç½®èœå•ä¸­é€‰æ‹© OCR å¼•æ“",missingItems:["OCR å¼•æ“"]}}function B(){const{translation:k}=s.settings,{provider:V,apiKey:Y,modelName:ie,customBaseUrl:X}=k,ae=[];return V?(a(V)&&(!Y||Y.trim()==="")&&ae.push(`${i(V)} çš„ API Key`),(!ie||ie.trim()==="")&&(r(V)||a(V))&&ae.push(`${i(V)} çš„æ¨¡å‹åç§°`),h(V)&&(!X||X.trim()==="")&&ae.push("è‡ªå®šä¹‰ OpenAI æœåŠ¡çš„ Base URL"),ae.length>0?{valid:!1,message:`è¯·å…ˆåœ¨é¡¶éƒ¨ âš™ï¸ è®¾ç½®èœå•ä¸­å¡«å†™ ${ae[0]}`,missingItems:ae}:{valid:!0,message:""}):{valid:!1,message:"è¯·å…ˆåœ¨é¡¶éƒ¨ âš™ï¸ è®¾ç½®èœå•ä¸­é€‰æ‹©ç¿»è¯‘æœåŠ¡å•†",missingItems:["ç¿»è¯‘æœåŠ¡å•†"]}}function I(){const{hqTranslation:k}=s.settings,{provider:V,apiKey:Y,modelName:ie,customBaseUrl:X}=k,ae=[];return V?((!Y||Y.trim()==="")&&ae.push("é«˜è´¨é‡ç¿»è¯‘çš„ API Key"),(!ie||ie.trim()==="")&&ae.push("é«˜è´¨é‡ç¿»è¯‘çš„æ¨¡å‹åç§°"),T(V)&&(!X||X.trim()==="")&&ae.push("é«˜è´¨é‡ç¿»è¯‘çš„ Base URL"),ae.length>0?{valid:!1,message:`è¯·å…ˆåœ¨é¡¶éƒ¨ âš™ï¸ è®¾ç½®èœå•ä¸­å¡«å†™ ${ae[0]}`,missingItems:ae}:{valid:!0,message:""}):{valid:!1,message:"è¯·å…ˆåœ¨é¡¶éƒ¨ âš™ï¸ è®¾ç½®èœå•ä¸­é€‰æ‹©é«˜è´¨é‡ç¿»è¯‘çš„æœåŠ¡å•†",missingItems:["é«˜è´¨é‡ç¿»è¯‘æœåŠ¡å•†"]}}function A(k){const V=k||s.settings.proofreading.rounds,Y=[];if(!V||V.length===0)return{valid:!1,message:"è¯·å…ˆåœ¨é¡¶éƒ¨ âš™ï¸ è®¾ç½®èœå•ä¸­æ·»åŠ è‡³å°‘ä¸€ä¸ªæ ¡å¯¹è½®æ¬¡",missingItems:["æ ¡å¯¹è½®æ¬¡"]};for(let ie=0;ie<V.length;ie++){const X=V[ie];if(!X)continue;const ae=X.name||`è½®æ¬¡${ie+1}`;if(X.provider||Y.push(`æ ¡å¯¹ ${ae} çš„æœåŠ¡å•†`),(!X.apiKey||X.apiKey.trim()==="")&&Y.push(`æ ¡å¯¹ ${ae} çš„ API Key`),(!X.modelName||X.modelName.trim()==="")&&Y.push(`æ ¡å¯¹ ${ae} çš„æ¨¡å‹åç§°`),Y.length>0)return{valid:!1,message:`è¯·å…ˆåœ¨é¡¶éƒ¨ âš™ï¸ è®¾ç½®èœå•ä¸­ä¸º ${Y[0]}`,missingItems:Y}}return{valid:!0,message:""}}function w(k="normal",V={}){let Y;switch(k){case"normal":Y=B();break;case"hq":Y=I();break;case"proofread":Y=A(V.proofreadingRounds);break;case"ocr":Y=D();break;default:Y=B()}return Y.valid?!0:(t.error(Y.message),W(),!1)}function N(){const k=D();if(!k.valid)return t.error(k.message),W(),!1;const V=B();return V.valid?!0:(t.error(V.message),W(),!1)}function W(){const k=document.getElementById("openSettingsBtn");k&&(o.value=!0,k.style.animation="settingsBtnPulse 0.5s ease-in-out 3",k.style.boxShadow="0 0 10px var(--primary-color, #4a90d9)",setTimeout(()=>{k.style.animation="",k.style.boxShadow="",o.value=!1},3e3))}function U(){if(l.value){console.log("ç”¨æˆ·å·²é€‰æ‹©ä¸å†æ˜¾ç¤ºè®¾ç½®æé†’");return}n.value=!0}function f(k=!1){if(k)try{localStorage.setItem(eo,"true"),console.log("ç”¨æˆ·é€‰æ‹©æ°¸ä¹…å…³é—­è®¾ç½®æé†’")}catch(V){console.error("ä¿å­˜è®¾ç½®æé†’çŠ¶æ€å¤±è´¥:",V)}n.value=!1}function g(){try{localStorage.removeItem(eo),console.log("è®¾ç½®æé†’çŠ¶æ€å·²é‡ç½®")}catch(k){console.error("é‡ç½®è®¾ç½®æé†’çŠ¶æ€å¤±è´¥:",k)}}function C(){setTimeout(()=>{U()},500)}return{showSetupReminder:n,isSettingsButtonHighlighted:o,isSetupReminderDismissed:l,validateOcrConfig:D,validateTranslationConfig:B,validateHqTranslationConfig:I,validateProofreadingConfig:A,validateBeforeTranslation:w,validateFullTranslationConfig:N,highlightSettingsButton:W,checkAndShowSetupReminder:U,closeSetupReminder:f,resetSetupReminderDismiss:g,initValidation:C,getProviderDisplayName:i,getOcrEngineDisplayName:S,requiresApiKey:a,isLocalProvider:r,requiresBaseUrl:h}}const ct=Ft("bubble",()=>{const s=_([]),t=_(-1),n=_([]),o=_([]),l=_(!1),i=_(-1),a=_(0),r=_(0),h=_(0),T=_(0),S=_(!1),D=_(-1),B=_(null),I=_(!1),A=_(-1),w=_(0),N=q(()=>t.value>=0&&t.value<s.value.length?s.value[t.value]??null:null),W=q(()=>s.value.length),U=q(()=>s.value.length>0),f=q(()=>t.value>=0),g=q(()=>n.value.length>1),C=q(()=>n.value.filter(L=>L>=0&&L<s.value.length).map(L=>s.value[L]).filter(L=>L!==void 0));function k(){const j=Qe().currentImage;j&&(j.bubbleStates=Et(s.value),j.hasUnsavedChanges=!0,console.log("æ°”æ³¡çŠ¶æ€å·²åŒæ­¥åˆ°å½“å‰å›¾ç‰‡"))}function V(L,j=!1){s.value=L,o.value=Et(L),x(),console.log(`æ°”æ³¡æ•°ç»„å·²è®¾ç½®ï¼Œå…± ${L.length} ä¸ªæ°”æ³¡`),j||k()}function Y(L,j){const le=As(L),$e=Ue().settings.textStyle,Ae=$e.layoutDirection,Me=Ae==="auto"?"vertical":Ae||"vertical",se=Bs({coords:L,translatedText:"",autoTextDirection:le,fontSize:$e.fontSize,fontFamily:$e.fontFamily,textDirection:Me,textColor:$e.textColor,fillColor:$e.fillColor,inpaintMethod:$e.inpaintMethod,strokeEnabled:$e.strokeEnabled,strokeColor:$e.strokeColor,strokeWidth:$e.strokeWidth,rotationAngle:0,position:{x:0,y:0},...j});return s.value.push(se),console.log(`å·²æ·»åŠ æ°”æ³¡ï¼Œå½“å‰å…± ${s.value.length} ä¸ª`),k(),se}function ie(L){return L<0||L>=s.value.length?(console.warn(`åˆ é™¤å¤±è´¥: æ— æ•ˆçš„ç´¢å¼• ${L}`),!1):(s.value.splice(L,1),t.value===L?t.value=-1:t.value>L&&t.value--,n.value=n.value.filter(j=>j!==L).map(j=>j>L?j-1:j),console.log(`å·²åˆ é™¤æ°”æ³¡ï¼Œå½“å‰å…± ${s.value.length} ä¸ª`),k(),!0)}function X(){if(n.value.length===0&&t.value<0)return;const L=[...new Set([...n.value,t.value])].filter(j=>j>=0).sort((j,le)=>le-j);for(const j of L)s.value.splice(j,1);x(),console.log(`å·²åˆ é™¤ ${L.length} ä¸ªæ°”æ³¡`),k()}function ae(){s.value=[],o.value=[],x(),console.log("æ‰€æœ‰æ°”æ³¡å·²æ¸…é™¤"),k()}function Q(){s.value=[],o.value=[],x(),console.log("æœ¬åœ°æ°”æ³¡çŠ¶æ€å·²æ¸…é™¤ï¼ˆä¸åŒæ­¥åˆ°imageStoreï¼‰")}function p(L){L>=-1&&L<s.value.length&&(t.value=L,n.value=L>=0?[L]:[],console.log(`å·²é€‰ä¸­æ°”æ³¡ ${L}`))}function m(L){if(L<0||L>=s.value.length)return;const j=n.value.indexOf(L);j>=0?(n.value.splice(j,1),t.value===L&&(t.value=n.value[0]??-1)):(n.value.push(L),t.value=L),console.log(`å¤šé€‰çŠ¶æ€: ${n.value.join(", ")}`)}function x(){t.value=-1,n.value=[]}function b(){t.value>=0?n.value=[t.value]:n.value=[]}function u(){if(s.value.length===0)return!1;const L=t.value<s.value.length-1?t.value+1:0;return p(L),!0}function c(){if(s.value.length===0)return!1;const L=t.value>0?t.value-1:s.value.length-1;return p(L),!0}function M(L,j){if(L<0||L>=s.value.length)return console.warn(`æ›´æ–°å¤±è´¥: æ— æ•ˆçš„ç´¢å¼• ${L}`),!1;const le=s.value[L];return le?(Object.assign(le,j),console.log(`å·²æ›´æ–°æ°”æ³¡ ${L}`),k(),!0):!1}function H(L){return t.value<0?(console.warn("æ›´æ–°å¤±è´¥: æ²¡æœ‰é€‰ä¸­çš„æ°”æ³¡"),!1):M(t.value,L)}function $(L){const j=n.value.length>0?n.value:t.value>=0?[t.value]:[];for(const le of j){const he=s.value[le];he&&Object.assign(he,L)}k(),console.log(`å·²æ‰¹é‡æ›´æ–° ${j.length} ä¸ªæ°”æ³¡`)}function O(L){for(let j=0;j<s.value.length;j++){const le=s.value[j];le&&Object.assign(le,L)}k(),console.log(`å·²æ›´æ–°æ‰€æœ‰ ${s.value.length} ä¸ªæ°”æ³¡`)}function P(){if(s.value.length!==o.value.length)return!0;for(let L=0;L<s.value.length;L++){const j=s.value[L],le=o.value[L];if(!(!j||!le)&&(j.translatedText!==le.translatedText||j.textboxText!==le.textboxText||j.fontSize!==le.fontSize||j.fontFamily!==le.fontFamily||j.textDirection!==le.textDirection||j.textColor!==le.textColor||j.fillColor!==le.fillColor||j.rotationAngle!==le.rotationAngle||j.strokeEnabled!==le.strokeEnabled||j.strokeColor!==le.strokeColor||j.strokeWidth!==le.strokeWidth||j.inpaintMethod!==le.inpaintMethod||JSON.stringify(j.coords)!==JSON.stringify(le.coords)))return!0}return!1}function v(){s.value=Et(o.value),x(),console.log("æ°”æ³¡çŠ¶æ€å·²é‡ç½®åˆ°åˆå§‹çŠ¶æ€")}function F(){o.value=Et(s.value),console.log("å½“å‰çŠ¶æ€å·²ä¿å­˜ä¸ºåˆå§‹çŠ¶æ€")}function d(){return{bubble_coords:s.value.map(L=>L.coords),bubble_texts:s.value.map(L=>L.translatedText),textbox_texts:s.value.map(L=>L.textboxText),font_sizes:s.value.map(L=>L.fontSize),font_families:s.value.map(L=>L.fontFamily),text_directions:s.value.map(L=>L.textDirection==="auto"?L.autoTextDirection==="vertical"?"v":"h":L.textDirection==="vertical"?"v":"h"),text_colors:s.value.map(L=>L.textColor),fill_colors:s.value.map(L=>L.fillColor),rotation_angles:s.value.map(L=>L.rotationAngle),stroke_enabled:s.value.map(L=>L.strokeEnabled),stroke_colors:s.value.map(L=>L.strokeColor),stroke_widths:s.value.map(L=>L.strokeWidth),inpaint_methods:s.value.map(L=>L.inpaintMethod)}}function y(){return JSON.stringify(s.value)}function ue(L){try{const j=JSON.parse(L);if(!Array.isArray(j))return console.error("ååºåˆ—åŒ–å¤±è´¥: æ•°æ®ä¸æ˜¯æ•°ç»„"),!1;const le=[];for(const he of j)Ls(he)?le.push(he):console.warn("è·³è¿‡æ— æ•ˆçš„æ°”æ³¡çŠ¶æ€:",he);return V(le),!0}catch(j){return console.error("ååºåˆ—åŒ–å¤±è´¥:",j),!1}}return{bubbles:s,selectedIndex:t,selectedIndices:n,initialStates:o,isDragging:l,draggingIndex:i,dragOffsetX:a,dragOffsetY:r,dragInitialX:h,dragInitialY:T,isResizing:S,resizingIndex:D,resizeCurrentCoords:B,isRotating:I,rotatingIndex:A,rotateCurrentAngle:w,selectedBubble:N,bubbleCount:W,hasBubbles:U,hasSelection:f,isMultiSelect:g,selectedBubbles:C,setBubbles:V,addBubble:Y,deleteBubble:ie,deleteSelected:X,clearBubbles:ae,clearBubblesLocal:Q,selectBubble:p,toggleMultiSelect:m,clearSelection:x,clearMultiSelect:b,selectNext:u,selectPrevious:c,updateBubble:M,updateSelectedBubble:H,updateAllSelected:$,updateAllBubbles:O,hasChanges:P,resetToInitial:v,saveAsInitial:F,toApiRequest:d,serialize:y,deserialize:ue}}),Dl=Object.freeze(Object.defineProperty({__proto__:null,useBubbleStore:ct},Symbol.toStringTag,{value:"Module"}));function Ml(){const s=_({current:0,total:0,completed:0,failed:0,isInProgress:!1,label:"",percentage:0});return{progress:s,reporter:{init(n,o){s.value={current:0,total:n,completed:0,failed:0,isInProgress:!0,label:o||"å‡†å¤‡ä¸­...",percentage:0}},update(n,o){s.value.current=n,o!==void 0&&(s.value.label=o),s.value.total>0&&(s.value.percentage=Math.round(n/s.value.total*100))},setPercentage(n,o){s.value.percentage=Math.min(100,Math.max(0,n)),o!==void 0&&(s.value.label=o)},incrementCompleted(){s.value.completed++},incrementFailed(){s.value.failed++},finish(){s.value.isInProgress=!1,s.value.percentage=100},getProgress(){return{...s.value}}}}}async function dn(s){return Ze.post("/api/parallel/detect",s)}async function gn(s){return Ze.post("/api/parallel/ocr",s)}async function pn(s){return Ze.post("/api/parallel/color",s)}async function mn(s){return Ze.post("/api/parallel/translate",s)}async function vn(s){return Ze.post("/api/parallel/inpaint",s)}async function fn(s){return Ze.post("/api/parallel/render",s)}const Go={standard:["detection","ocr","color","translate","inpaint","render"],hq:["detection","ocr","color","aiTranslate","inpaint","render"],proofread:["aiTranslate","render"],removeText:["detection","inpaint","render"]},to={detection:"æ°”æ³¡æ£€æµ‹",ocr:"æ–‡å­—è¯†åˆ«",color:"é¢œè‰²æå–",translate:"ç¿»è¯‘",aiTranslate:"AIç¿»è¯‘",inpaint:"èƒŒæ™¯ä¿®å¤",render:"æ¸²æŸ“"};function El(){const s=Qe(),t=ct(),n=Ue(),o=cn(),l=rt(),{progress:i,reporter:a}=Ml(),r=_(!1),h=_(null);let T=null,S="standard";const D=q(()=>r.value||s.isBatchTranslationInProgress),B=q(()=>i.value.percentage||0);function I(){const p=n.settings.translation.rpmLimit;h.value?h.value.setRpm(p):h.value=Fs(p)}function A(p){const m=p.mode==="hq"?"hq":p.mode==="proofread"?"proofread":p.mode==="removeText"?"ocr":"normal";return o.validateBeforeTranslation(m)}function w(){const{textStyle:p}=n.settings,m=p.layoutDirection;T={fontFamily:p.fontFamily,fontSize:p.fontSize,autoFontSize:p.autoFontSize,autoTextDirection:m==="auto",textDirection:m==="auto"?"vertical":m,fillColor:p.fillColor,textColor:p.textColor,rotationAngle:0,strokeEnabled:p.strokeEnabled,strokeColor:p.strokeColor,strokeWidth:p.strokeWidth}}function N(p){return p.includes("base64,")?p.split("base64,")[1]||"":p}function W(p){const m=s.images;if(p.scope==="current"){const x=s.currentImage;return x?[{image:x,index:s.currentImageIndex}]:[]}return p.scope==="failed"?s.getFailedImageIndices().map(x=>({image:m[x],index:x})).filter(x=>x.image!==void 0):m.map((x,b)=>({image:x,index:b}))}async function U(p){const m=n.settings,x=N(p.image.originalDataURL),b=await dn({image:x,detector_type:m.textDetector,box_expand_ratio:m.boxExpand.ratio,box_expand_top:m.boxExpand.top,box_expand_bottom:m.boxExpand.bottom,box_expand_left:m.boxExpand.left,box_expand_right:m.boxExpand.right});if(!b.success)throw new Error(b.error||"æ£€æµ‹å¤±è´¥");p.bubbleCoords=b.bubble_coords||[],p.bubbleAngles=b.bubble_angles||[],p.bubblePolygons=b.bubble_polygons||[],p.autoDirections=b.auto_directions||[],p.rawMask=b.raw_mask,p.textlinesPerBubble=b.textlines_per_bubble||[]}async function f(p){if(p.bubbleCoords.length===0){p.originalTexts=[];return}const m=n.settings,x=N(p.image.originalDataURL),b=await gn({image:x,bubble_coords:p.bubbleCoords,source_language:m.sourceLanguage,ocr_engine:m.ocrEngine,baidu_api_key:m.baiduOcr?.apiKey,baidu_secret_key:m.baiduOcr?.secretKey,baidu_version:m.baiduOcr?.version,baidu_ocr_language:m.baiduOcr?.sourceLanguage,ai_vision_provider:m.aiVisionOcr?.provider,ai_vision_api_key:m.aiVisionOcr?.apiKey,ai_vision_model_name:m.aiVisionOcr?.modelName,ai_vision_ocr_prompt:m.aiVisionOcr?.prompt,custom_ai_vision_base_url:m.aiVisionOcr?.customBaseUrl,textlines_per_bubble:p.textlinesPerBubble});if(!b.success)throw new Error(b.error||"OCRå¤±è´¥");p.originalTexts=b.original_texts||[]}async function g(p){if(p.bubbleCoords.length===0){p.colors=[];return}const m=N(p.image.originalDataURL),x=await pn({image:m,bubble_coords:p.bubbleCoords,textlines_per_bubble:p.textlinesPerBubble});if(!x.success)throw new Error(x.error||"é¢œè‰²æå–å¤±è´¥");p.colors=x.colors||[]}async function C(p){if(p.originalTexts.length===0){p.translatedTexts=[],p.textboxTexts=[];return}const m=n.settings,x=await mn({original_texts:p.originalTexts,target_language:m.targetLanguage,source_language:m.sourceLanguage,model_provider:m.translation.provider,model_name:m.translation.modelName,api_key:m.translation.apiKey,custom_base_url:m.translation.customBaseUrl,prompt_content:m.translatePrompt,textbox_prompt_content:m.textboxPrompt,use_textbox_prompt:m.useTextboxPrompt,rpm_limit:m.translation.rpmLimit,max_retries:m.translation.maxRetries,use_json_format:m.translation.isJsonMode});if(!x.success)throw new Error(x.error||"ç¿»è¯‘å¤±è´¥");p.translatedTexts=x.translated_texts||[],p.textboxTexts=x.textbox_texts||[]}async function k(p){const m=n.settings,x=S==="proofread",b=p.map(j=>x?{imageIndex:j.imageIndex,bubbles:(j.image.bubbleStates||[]).map((le,he)=>({bubbleIndex:he,original:le.originalText||"",translated:m.useTextboxPrompt?le.textboxText||le.translatedText||"":le.translatedText||"",textDirection:le.textDirection!=="auto"?le.textDirection:le.autoTextDirection!=="auto"?le.autoTextDirection:"vertical"}))}:{imageIndex:j.imageIndex,bubbles:j.originalTexts.map((le,he)=>({bubbleIndex:he,original:le,translated:"",textDirection:j.autoDirections[he]||"vertical"}))}),u=p.map(j=>{const le=x&&j.image.translatedDataURL||j.image.originalDataURL;return N(le)}),c=x?m.proofreading.rounds[0]:m.hqTranslation,M=x?c?.prompt:m.hqTranslation.prompt,H=x?"ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ¼«ç”»ç¿»è¯‘æ ¡å¯¹åŠ©æ‰‹ï¼Œèƒ½å¤Ÿæ ¹æ®æ¼«ç”»å›¾åƒå†…å®¹æ£€æŸ¥å’Œä¿®æ­£ç¿»è¯‘ã€‚":"ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ¼«ç”»ç¿»è¯‘åŠ©æ‰‹ï¼Œèƒ½å¤Ÿæ ¹æ®æ¼«ç”»å›¾åƒå†…å®¹å’Œä¸Šä¸‹æ–‡æä¾›é«˜è´¨é‡çš„ç¿»è¯‘ã€‚",$=JSON.stringify(b,null,2),O=[{type:"text",text:(M||"")+`

ä»¥ä¸‹æ˜¯JSONæ•°æ®:
\`\`\`json
`+$+"\n```"}];for(const j of u)O.push({type:"image_url",image_url:{url:`data:image/png;base64,${j}`}});const P=[{role:"system",content:H},{role:"user",content:O}],v=m.hqTranslation,F=x?c:null,d=await Rt({provider:(x?F?.provider:v.provider)||"openai",api_key:(x?F?.apiKey:v.apiKey)||"",model_name:(x?F?.modelName:v.modelName)||"",custom_base_url:x?F?.customBaseUrl:v.customBaseUrl,messages:P,low_reasoning:x?F?.lowReasoning:v.lowReasoning,force_json_output:x?F?.forceJsonOutput:v.forceJsonOutput,no_thinking_method:x?F?.noThinkingMethod:v.noThinkingMethod,use_stream:x?!1:v.useStream}),y=x?F?.forceJsonOutput||!1:v.forceJsonOutput;let L=ie(d,y)||b;if(x&&m.proofreading.rounds.length>1)for(let j=1;j<m.proofreading.rounds.length;j++){const le=m.proofreading.rounds[j],he=JSON.stringify(L,null,2),$e=[{type:"text",text:le.prompt+`

ä»¥ä¸‹æ˜¯JSONæ•°æ®:
\`\`\`json
`+he+"\n```"}];for(const J of u)$e.push({type:"image_url",image_url:{url:`data:image/png;base64,${J}`}});const Ae=[{role:"system",content:H},{role:"user",content:$e}],Me=await Rt({provider:le.provider,api_key:le.apiKey,model_name:le.modelName,custom_base_url:le.customBaseUrl,messages:Ae,low_reasoning:le.lowReasoning,force_json_output:le.forceJsonOutput,no_thinking_method:le.noThinkingMethod,use_stream:!1}),se=ie(Me,le.forceJsonOutput);se&&(L=se)}for(const j of p){const le=L?.find(he=>he.imageIndex===j.imageIndex);le?j.translatedTexts=le.bubbles.map(he=>he.translated):j.translatedTexts=[],j.textboxTexts=[]}}async function V(p){if(p.bubbleCoords.length===0){p.cleanImage=N(p.image.originalDataURL);return}const m=n.settings,{textStyle:x,preciseMask:b}=m,u=N(p.image.originalDataURL),c=await vn({image:u,bubble_coords:p.bubbleCoords,bubble_polygons:p.bubblePolygons,raw_mask:p.rawMask,method:x.inpaintMethod==="solid"?"solid":"lama",lama_model:x.inpaintMethod==="litelama"?"litelama":"lama_mpe",fill_color:x.fillColor,mask_dilate_size:b.dilateSize,mask_box_expand_ratio:b.boxExpandRatio});if(!c.success)throw new Error(c.error||"èƒŒæ™¯ä¿®å¤å¤±è´¥");p.cleanImage=c.clean_image}async function Y(p){if(!p.cleanImage)throw new Error("ç¼ºå°‘å¹²å‡€èƒŒæ™¯å›¾ç‰‡");const{textStyle:m}=n.settings,x=p.bubbleCoords.map((u,c)=>({coords:u,polygon:[],position:{x:0,y:0},rotationAngle:p.bubbleAngles[c]||0,originalText:p.originalTexts[c]||"",translatedText:p.translatedTexts[c]||"",textboxText:p.textboxTexts[c]||"",textDirection:T?.textDirection||"vertical",autoTextDirection:p.autoDirections[c]||"vertical",fontSize:T?.fontSize||m.fontSize,fontFamily:T?.fontFamily||m.fontFamily,autoFontSize:T?.autoFontSize??m.autoFontSize,textColor:p.colors[c]?.textColor||T?.textColor||m.textColor,fillColor:T?.fillColor||m.fillColor,strokeEnabled:T?.strokeEnabled??m.strokeEnabled,strokeColor:T?.strokeColor||m.strokeColor,strokeWidth:T?.strokeWidth||m.strokeWidth,inpaintMethod:m.inpaintMethod,autoFgColor:p.colors[c]?.autoFgColor||null,autoBgColor:p.colors[c]?.autoBgColor||null})),b=await fn({clean_image:p.cleanImage,bubble_states:x,fontSize:T?.fontSize||m.fontSize,fontFamily:T?.fontFamily||m.fontFamily,textDirection:T?.textDirection||m.layoutDirection,textColor:T?.textColor||m.textColor,strokeEnabled:T?.strokeEnabled??m.strokeEnabled,strokeColor:T?.strokeColor||m.strokeColor,strokeWidth:T?.strokeWidth||m.strokeWidth,autoFontSize:T?.autoFontSize??m.autoFontSize,use_individual_styles:!0});if(!b.success)throw new Error(b.error||"æ¸²æŸ“å¤±è´¥");p.finalImage=b.final_image,p.bubbleStates=b.bubble_states||x}function ie(p,m){if(!p.success)return console.error("APIè°ƒç”¨å¤±è´¥:",p.error),null;if(p.results&&p.results.length>0){const b=p.results[0];if(b&&"imageIndex"in b&&"bubbles"in b)return p.results}const x=p.content;if(x)if(m)try{return JSON.parse(x)}catch{return null}else{const b=x.match(/```json\s*([\s\S]*?)\s*```/);if(b?.[1])try{return JSON.parse(b[1])}catch{return null}}return null}function X(p){const m=p.finalImage?`data:image/png;base64,${p.finalImage}`:p.cleanImage?`data:image/png;base64,${p.cleanImage}`:null;s.updateImageByIndex(p.imageIndex,{translatedDataURL:m,cleanImageData:p.cleanImage||null,bubbleStates:p.bubbleStates,bubbleCoords:p.bubbleCoords,bubbleAngles:p.bubbleAngles,originalTexts:p.originalTexts,textboxTexts:p.textboxTexts,bubbleTexts:p.translatedTexts,translationStatus:"completed",translationFailed:!1,showOriginal:!1,hasUnsavedChanges:!0}),p.imageIndex===s.currentImageIndex&&p.bubbleStates&&t.setBubbles(p.bubbleStates)}async function ae(p){if(!A(p))return{success:!1,completed:0,failed:0,errors:["é…ç½®éªŒè¯å¤±è´¥"]};if(s.images.length===0)return l.error("è¯·å…ˆä¸Šä¼ å›¾ç‰‡"),{success:!1,completed:0,failed:0,errors:["æ²¡æœ‰å›¾ç‰‡"]};S=p.mode;const x=Go[p.mode];console.log(`ğŸš€ é¡ºåºç®¡çº¿å¯åŠ¨ï¼Œæ¨¡å¼: ${p.mode}, æ­¥éª¤é“¾: [${x.join(" â†’ ")}]`),r.value=!0,(p.scope==="all"||p.scope==="failed")&&s.setBatchTranslationInProgress(!0),I(),w();const b=W(p),u=[];let c=0,M=0;const H=b.map(({image:$,index:O})=>({imageIndex:O,image:$,bubbleCoords:[],bubbleAngles:[],bubblePolygons:[],autoDirections:[],textlinesPerBubble:[],originalTexts:[],colors:[],translatedTexts:[],textboxTexts:[]}));try{a.init(b.length,`${p.mode} æ¨¡å¼å¯åŠ¨...`);for(let O=0;O<x.length;O++){const P=x[O],v=Math.floor(O/x.length*90);if(a.setPercentage(v,`æ‰§è¡Œ: ${to[P]}`),l.info(`æ­¥éª¤ ${O+1}/${x.length}: ${to[P]}...`),P==="aiTranslate")await k(H);else for(let F=0;F<H.length;F++){const d=H[F];if(p.scope==="all"&&!s.isBatchTranslationInProgress)break;h.value&&await h.value.acquire();try{switch(s.setTranslationStatus(d.imageIndex,"processing"),P){case"detection":await U(d);break;case"ocr":await f(d);break;case"color":await g(d);break;case"translate":await C(d);break;case"inpaint":await V(d);break;case"render":await Y(d),X(d);break}}catch(L){const j=L instanceof Error?L.message:"æœªçŸ¥é”™è¯¯";u.push(`å›¾ç‰‡ ${d.imageIndex}: ${P} - ${j}`),s.setTranslationStatus(d.imageIndex,"failed",j)}const y=Math.floor((F+1)/H.length*100),ue=v+Math.floor(y/100*(90/x.length));a.setPercentage(ue,`${to[P]}: ${F+1}/${H.length}`)}}for(const O of H){const P=s.images[O.imageIndex]?.translationStatus;P==="completed"?c++:P==="failed"?M++:x.includes("render")||(X(O),c++)}a.setPercentage(100,"å®Œæˆï¼");const $={standard:"ç¿»è¯‘",hq:"é«˜è´¨é‡ç¿»è¯‘",proofread:"AIæ ¡å¯¹",removeText:"æ¶ˆé™¤æ–‡å­—"};return l.success(`${$[p.mode]}å®Œæˆï¼`),{success:M===0,completed:c,failed:M,errors:u.length>0?u:void 0}}catch($){const O=$ instanceof Error?$.message:"æ‰§è¡Œå¤±è´¥";return l.error(O),u.push(O),{success:!1,completed:0,failed:b.length,errors:u}}finally{r.value=!1,s.setBatchTranslationInProgress(!1);const $=s.currentImageIndex,O=s.images[$];O?.bubbleStates&&O.bubbleStates.length>0&&t.setBubbles(O.bubbleStates),setTimeout(()=>a.finish(),1e3)}}function Q(){s.isBatchTranslationInProgress&&(s.setBatchTranslationInProgress(!1),l.info("æ“ä½œå·²å–æ¶ˆ"))}return{progress:i,isExecuting:r,isTranslating:D,progressPercent:B,execute:ae,cancel:Q,STEP_CHAIN_CONFIGS:Go}}class Bl{currentCount=0;maxCount;waitQueue=[];holders=[];constructor(t=1){this.maxCount=Math.max(1,t)}setSize(t){this.maxCount=Math.max(1,t),this.tryWakeUp()}getSize(){return this.maxCount}async acquire(t){if(this.currentCount<this.maxCount){this.currentCount++,this.holders.push(t);return}return new Promise(n=>{this.waitQueue.push({resolve:n,poolName:t})})}release(t){const n=this.holders.indexOf(t);n>=0&&(this.holders.splice(n,1),this.currentCount--),this.tryWakeUp()}tryWakeUp(){for(;this.currentCount<this.maxCount&&this.waitQueue.length>0;){const t=this.waitQueue.shift();this.currentCount++,this.holders.push(t.poolName),t.resolve()}}async withLock(t,n){await this.acquire(t);try{return await n()}finally{this.release(t)}}getStatus(){return{isLocked:this.currentCount>=this.maxCount,currentCount:this.currentCount,maxCount:this.maxCount,holders:[...this.holders],waitingCount:this.waitQueue.length,waitingPools:this.waitQueue.map(t=>t.poolName)}}isWaiting(t){return this.waitQueue.some(n=>n.poolName===t)}isHolding(t){return this.holders.includes(t)}reset(){this.currentCount=0,this.holders=[];for(const t of this.waitQueue)t.resolve();this.waitQueue=[]}}class St{queue=[];currentTask=null;isRunning=!1;isCancelled=!1;completedCount=0;nextPool;name;icon;lock;progressTracker;onTaskComplete;constructor(t,n,o,l,i,a){this.name=t,this.icon=n,this.nextPool=o,this.lock=l,this.progressTracker=i,this.onTaskComplete=a}getName(){return this.name}getIcon(){return this.icon}setNextPool(t){this.nextPool=t}enqueue(t){this.isCancelled||(this.queue.push(t),this.progressTracker.updatePool(this.name,{waiting:this.queue.length}),this.tryProcessNext())}enqueueBatch(t){if(!this.isCancelled){for(const n of t)this.queue.push(n);this.progressTracker.updatePool(this.name,{waiting:this.queue.length}),this.tryProcessNext()}}async tryProcessNext(){if(!(this.isRunning||this.isCancelled||this.queue.length===0)){this.isRunning=!0,this.currentTask=this.queue.shift(),this.progressTracker.updatePool(this.name,{waiting:this.queue.length,isProcessing:!0,currentPage:this.currentTask.imageIndex+1,isWaitingLock:!1});try{let t;this.lock?(this.progressTracker.updatePool(this.name,{isWaitingLock:!0}),t=await this.lock.withLock(this.name,async()=>(this.progressTracker.updatePool(this.name,{isWaitingLock:!1}),await this.process(this.currentTask)))):t=await this.process(this.currentTask),this.completedCount++,this.progressTracker.updatePool(this.name,{completed:this.completedCount}),this.nextPool&&t.status!=="failed"&&t.status!=="buffered"&&this.nextPool.enqueue(t),this.onTaskComplete?.(t)}catch(t){this.currentTask.status="failed",this.currentTask.error=t.message,console.error(`[${this.name}] å¤„ç†ä»»åŠ¡å¤±è´¥:`,t),this.onTaskComplete?.(this.currentTask)}finally{this.currentTask=null,this.isRunning=!1,this.progressTracker.updatePool(this.name,{isProcessing:!1,currentPage:void 0}),this.tryProcessNext()}}}getStatus(){return{name:this.name,icon:this.icon,waiting:this.queue.length,processing:this.isRunning,currentPage:this.currentTask?.imageIndex,completed:this.completedCount,isWaitingLock:this.lock?.isWaiting(this.name)??!1}}cancel(){this.isCancelled=!0,this.queue=[]}reset(){this.isCancelled=!1,this.queue=[],this.currentTask=null,this.isRunning=!1,this.completedCount=0}getCompletedCount(){return this.completedCount}getWaitingCount(){return this.queue.length}isProcessing(){return this.isRunning}}const Al=[{name:"æ£€æµ‹",icon:"ğŸ“"},{name:"OCR",icon:"ğŸ“–"},{name:"é¢œè‰²",icon:"ğŸ¨"},{name:"ç¿»è¯‘",icon:"ğŸŒ"},{name:"ä¿®å¤",icon:"ğŸ–Œï¸"},{name:"æ¸²æŸ“",icon:"âœ¨"}];class Ll{poolStatuses=new Map;totalPages=0;startTime=0;progress=io({pools:[],totalCompleted:0,totalFailed:0,totalPages:0,estimatedTimeRemaining:0});constructor(){this.initPools()}initPools(){for(const t of Al){const n={name:t.name,icon:t.icon,waiting:0,processing:!1,completed:0,isWaitingLock:!1};this.poolStatuses.set(t.name,n)}this.syncToReactive()}init(t){this.totalPages=t,this.startTime=Date.now();for(const n of this.poolStatuses.values())n.waiting=0,n.processing=!1,n.currentPage=void 0,n.completed=0,n.isWaitingLock=!1;this.progress.totalCompleted=0,this.progress.totalFailed=0,this.progress.totalPages=t,this.progress.estimatedTimeRemaining=0,this.syncToReactive()}updatePool(t,n){const o=this.poolStatuses.get(t);o&&(n.waiting!==void 0&&(o.waiting=n.waiting),n.isProcessing!==void 0&&(o.processing=n.isProcessing),n.currentPage!==void 0&&(o.currentPage=n.currentPage),n.completed!==void 0&&(o.completed=n.completed),n.isWaitingLock!==void 0&&(o.isWaitingLock=n.isWaitingLock),this.syncToReactive(),this.updateEstimatedTime())}incrementCompleted(){this.progress.totalCompleted++,this.updateEstimatedTime()}incrementFailed(){this.progress.totalFailed++}updateEstimatedTime(){if(this.progress.totalCompleted===0){this.progress.estimatedTimeRemaining=0;return}const n=(Date.now()-this.startTime)/1e3/this.progress.totalCompleted,o=this.totalPages-this.progress.totalCompleted-this.progress.totalFailed;this.progress.estimatedTimeRemaining=Math.ceil(n*o)}syncToReactive(){this.progress.pools=Array.from(this.poolStatuses.values()).map(t=>({...t}))}getPoolStatus(t){return this.poolStatuses.get(t)}getAllPoolStatuses(){return Array.from(this.poolStatuses.values())}getProgress(){return{...this.progress}}reset(){this.totalPages=0,this.startTime=0,this.initPools()}formatRemainingTime(){const t=this.progress.estimatedTimeRemaining;if(t<=0)return"--";const n=Math.floor(t/60),o=t%60;return n>0?`${n}åˆ†${o}ç§’`:`${o}ç§’`}}class Fl{results=new Map;totalExpected=0;completedCount=0;failedCount=0;resolveWaitAll=null;init(t){this.results.clear(),this.totalExpected=t,this.completedCount=0,this.failedCount=0,this.resolveWaitAll=null}add(t){this.results.set(t.imageIndex,t),t.status==="completed"?this.completedCount++:t.status==="failed"&&this.failedCount++,this.completedCount+this.failedCount>=this.totalExpected&&this.resolveWaitAll&&(this.resolveWaitAll({success:this.completedCount,failed:this.failedCount}),this.resolveWaitAll=null)}waitForAll(t){return this.totalExpected=t,this.completedCount+this.failedCount>=t?Promise.resolve({success:this.completedCount,failed:this.failedCount}):new Promise(n=>{this.resolveWaitAll=n})}get(t){return this.results.get(t)}getAll(){return Array.from(this.results.values()).sort((t,n)=>t.imageIndex-n.imageIndex)}getSuccessful(){return this.getAll().filter(t=>t.status==="completed")}getFailed(){return this.getAll().filter(t=>t.status==="failed")}getStats(){return{total:this.totalExpected,completed:this.completedCount,failed:this.failedCount,pending:this.totalExpected-this.completedCount-this.failedCount}}reset(){this.results.clear(),this.totalExpected=0,this.completedCount=0,this.failedCount=0,this.resolveWaitAll=null}}class Ul extends St{constructor(t,n,o,l){super("æ£€æµ‹","ğŸ“",t,n,o,l)}async process(t){const{imageData:n}=t,l=Ue().settings,i=this.extractBase64(n.originalDataURL),a=await dn({image:i,detector_type:l.textDetector,box_expand_ratio:l.boxExpand.ratio,box_expand_top:l.boxExpand.top,box_expand_bottom:l.boxExpand.bottom,box_expand_left:l.boxExpand.left,box_expand_right:l.boxExpand.right});if(!a.success)throw new Error(a.error||"æ£€æµ‹å¤±è´¥");return t.detectionResult={bubbleCoords:a.bubble_coords||[],bubbleAngles:a.bubble_angles||[],bubblePolygons:a.bubble_polygons||[],autoDirections:a.auto_directions||[],rawMask:a.raw_mask,textlinesPerBubble:a.textlines_per_bubble||[]},t.status="processing",t}extractBase64(t){return t.includes("base64,")?t.split("base64,")[1]||"":t}}class Ol extends St{constructor(t,n,o,l){super("OCR","ğŸ“–",t,n,o,l)}async process(t){const{imageData:n,detectionResult:o}=t,i=Ue().settings;if(!o||o.bubbleCoords.length===0)return t.ocrResult={originalTexts:[],textlinesPerBubble:[]},t.status="processing",t;const a=this.extractBase64(n.originalDataURL),r=await gn({image:a,bubble_coords:o.bubbleCoords,source_language:i.sourceLanguage,ocr_engine:i.ocrEngine,baidu_api_key:i.baiduOcr?.apiKey,baidu_secret_key:i.baiduOcr?.secretKey,baidu_version:i.baiduOcr?.version,baidu_ocr_language:i.baiduOcr?.sourceLanguage,ai_vision_provider:i.aiVisionOcr?.provider,ai_vision_api_key:i.aiVisionOcr?.apiKey,ai_vision_model_name:i.aiVisionOcr?.modelName,ai_vision_ocr_prompt:i.aiVisionOcr?.prompt,custom_ai_vision_base_url:i.aiVisionOcr?.customBaseUrl,textlines_per_bubble:o.textlinesPerBubble});if(!r.success)throw new Error(r.error||"OCRå¤±è´¥");return t.ocrResult={originalTexts:r.original_texts||[],textlinesPerBubble:r.textlines_per_bubble||[]},t.status="processing",t}extractBase64(t){return t.includes("base64,")?t.split("base64,")[1]||"":t}}class zl extends St{constructor(t,n,o,l){super("é¢œè‰²","ğŸ¨",t,n,o,l)}async process(t){const{imageData:n,detectionResult:o,ocrResult:l}=t;if(!o||o.bubbleCoords.length===0)return t.colorResult={colors:[]},t.status="processing",t;const i=this.extractBase64(n.originalDataURL),a=await pn({image:i,bubble_coords:o.bubbleCoords,textlines_per_bubble:l?.textlinesPerBubble||o.textlinesPerBubble});if(!a.success)throw new Error(a.error||"é¢œè‰²æå–å¤±è´¥");return t.colorResult={colors:a.colors||[]},t.status="processing",t}extractBase64(t){return t.includes("base64,")?t.split("base64,")[1]||"":t}}class Nl extends St{mode="standard";batchBuffer=[];totalTasks=0;processedCount=0;constructor(t,n,o){super("ç¿»è¯‘","ğŸŒ",t,null,n,o)}setMode(t,n,o){this.mode=t,this.totalTasks=n,this.batchBuffer=[],this.processedCount=0,this.nextPool=o}async process(t){switch(this.mode){case"standard":return this.handleStandardTranslate(t);case"hq":return this.handleHqTranslate(t);case"proofread":return this.handleProofread(t);case"removeText":return this.handleRemoveTextOnly(t);default:return t}}async handleStandardTranslate(t){const o=Ue().settings;if(!t.ocrResult||t.ocrResult.originalTexts.length===0)return t.translateResult={translatedTexts:[],textboxTexts:[]},t.status="processing",t;const l=await mn({original_texts:t.ocrResult.originalTexts,target_language:o.targetLanguage,source_language:o.sourceLanguage,model_provider:o.translation.provider,model_name:o.translation.modelName,api_key:o.translation.apiKey,custom_base_url:o.translation.customBaseUrl,prompt_content:o.translatePrompt,textbox_prompt_content:o.textboxPrompt,use_textbox_prompt:o.useTextboxPrompt,rpm_limit:o.translation.rpmLimit,max_retries:o.translation.maxRetries,use_json_format:o.translation.isJsonMode});if(!l.success)throw new Error(l.error||"ç¿»è¯‘å¤±è´¥");return t.translateResult={translatedTexts:l.translated_texts||[],textboxTexts:l.textbox_texts||[]},t.status="processing",t}async handleHqTranslate(t){this.batchBuffer.push(t),this.processedCount++;const n=Ue(),{hqTranslation:o}=n.settings,l=o.batchSize||3,i=this.processedCount>=this.totalTasks;if(!(this.batchBuffer.length>=l||i))return t.status="buffered",t;const r=[...this.batchBuffer];this.batchBuffer=[];const h=r.map(w=>({imageIndex:w.imageIndex,bubbles:(w.ocrResult?.originalTexts||[]).map((N,W)=>({bubbleIndex:W,original:N,translated:"",textDirection:w.detectionResult?.autoDirections[W]||"vertical"}))})),T=r.map(w=>this.extractBase64(w.imageData.originalDataURL)),S=JSON.stringify(h,null,2),D=[{type:"text",text:o.prompt+`

ä»¥ä¸‹æ˜¯JSONæ•°æ®:
\`\`\`json
`+S+"\n```"}];for(const w of T)D.push({type:"image_url",image_url:{url:`data:image/png;base64,${w}`}});const B=[{role:"system",content:"ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ¼«ç”»ç¿»è¯‘åŠ©æ‰‹ï¼Œèƒ½å¤Ÿæ ¹æ®æ¼«ç”»å›¾åƒå†…å®¹å’Œä¸Šä¸‹æ–‡æä¾›é«˜è´¨é‡çš„ç¿»è¯‘ã€‚"},{role:"user",content:D}],I=await Rt({provider:o.provider,api_key:o.apiKey,model_name:o.modelName,custom_base_url:o.customBaseUrl,messages:B,low_reasoning:o.lowReasoning,force_json_output:o.forceJsonOutput,no_thinking_method:o.noThinkingMethod,use_stream:o.useStream}),A=this.parseHqResponse(I,o.forceJsonOutput);for(const w of r){const N=A?.find(W=>W.imageIndex===w.imageIndex);N?w.translateResult={translatedTexts:N.bubbles.map(W=>W.translated),textboxTexts:[]}:w.translateResult={translatedTexts:[],textboxTexts:[]},w.status="processing",this.nextPool&&this.nextPool.enqueue(w)}return t}async handleProofread(t){this.batchBuffer.push(t),this.processedCount++;const n=Ue(),{proofreading:o,useTextboxPrompt:l}=n.settings,i=o.rounds[0]?.batchSize||3,a=this.processedCount>=this.totalTasks;if(!(this.batchBuffer.length>=i||a))return t.status="buffered",t;const h=[...this.batchBuffer];this.batchBuffer=[];const T=h.map(B=>({imageIndex:B.imageIndex,bubbles:(B.imageData.bubbleStates||[]).map((I,A)=>({bubbleIndex:A,original:I.originalText||"",translated:l?I.textboxText||I.translatedText||"":I.translatedText||"",textDirection:I.textDirection!=="auto"?I.textDirection:I.autoTextDirection!=="auto"?I.autoTextDirection:"vertical"}))})),S=h.map(B=>{const I=B.imageData.translatedDataURL||B.imageData.originalDataURL;return this.extractBase64(I)});let D=T;for(const B of o.rounds){const I=JSON.stringify(D,null,2),A=[{type:"text",text:B.prompt+`

ä»¥ä¸‹æ˜¯JSONæ•°æ®:
\`\`\`json
`+I+"\n```"}];for(const U of S)A.push({type:"image_url",image_url:{url:`data:image/png;base64,${U}`}});const w=[{role:"system",content:"ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ¼«ç”»ç¿»è¯‘æ ¡å¯¹åŠ©æ‰‹ï¼Œèƒ½å¤Ÿæ ¹æ®æ¼«ç”»å›¾åƒå†…å®¹æ£€æŸ¥å’Œä¿®æ­£ç¿»è¯‘ã€‚"},{role:"user",content:A}],N=await Rt({provider:B.provider,api_key:B.apiKey,model_name:B.modelName,custom_base_url:B.customBaseUrl,messages:w,low_reasoning:B.lowReasoning,force_json_output:B.forceJsonOutput,no_thinking_method:B.noThinkingMethod,use_stream:!1}),W=this.parseHqResponse(N,B.forceJsonOutput);W&&(D=W)}for(const B of h){const I=D.find(A=>A.imageIndex===B.imageIndex);I?B.translateResult={translatedTexts:I.bubbles.map(A=>A.translated),textboxTexts:[]}:B.translateResult={translatedTexts:[],textboxTexts:[]},B.status="processing",this.nextPool&&this.nextPool.enqueue(B)}return t}async handleRemoveTextOnly(t){return t.translateResult={translatedTexts:[],textboxTexts:[]},t.status="processing",t}extractBase64(t){return t.includes("base64,")?t.split("base64,")[1]||"":t}parseHqResponse(t,n){if(!t.success)return console.error("APIè°ƒç”¨å¤±è´¥:",t.error),null;if(t.results&&t.results.length>0){const l=t.results[0];if(l&&"imageIndex"in l&&"bubbles"in l)return t.results}const o=t.content;if(o)if(n)try{return JSON.parse(o)}catch(l){return console.error("è§£æAIå¼ºåˆ¶JSONè¿”å›çš„å†…å®¹å¤±è´¥:",l),null}else{const l=o.match(/```json\s*([\s\S]*?)\s*```/);if(l?.[1])try{return JSON.parse(l[1])}catch(i){return console.error("è§£æAIè¿”å›çš„JSONå¤±è´¥:",i),null}}return null}}class Vl extends St{constructor(t,n,o,l){super("ä¿®å¤","ğŸ–Œï¸",t,n,o,l)}async process(t){const{imageData:n,detectionResult:o}=t,i=Ue().settings;if(!o||o.bubbleCoords.length===0)return t.inpaintResult={cleanImage:this.extractBase64(n.originalDataURL)},t.status="processing",t;const a=this.extractBase64(n.originalDataURL),r=i.textStyle.inpaintMethod,h=r==="lama_mpe"||r==="litelama",T=await vn({image:a,bubble_coords:o.bubbleCoords,bubble_polygons:o.bubblePolygons,raw_mask:o.rawMask,method:h?"lama":"solid",lama_model:h?r:void 0,fill_color:i.textStyle.fillColor,mask_dilate_size:i.preciseMask.dilateSize,mask_box_expand_ratio:i.preciseMask.boxExpandRatio});if(!T.success)throw new Error(T.error||"ä¿®å¤å¤±è´¥");return t.inpaintResult={cleanImage:T.clean_image||""},t.status="processing",t}extractBase64(t){return t.includes("base64,")?t.split("base64,")[1]||"":t}}class Wl extends St{resultCollector;constructor(t,n,o){super("æ¸²æŸ“","âœ¨",null,null,t,o),this.resultCollector=n}async process(t){const n=Qe(),o=ct(),l=Ue(),i=this.buildBubbleStates(t,l);if(i.length===0){const h=t.inpaintResult?.cleanImage||t.imageData.cleanImageData||this.extractBase64(t.imageData.originalDataURL);return t.renderResult={finalImage:h,bubbleStates:[]},t.status="completed",this.updateImageToUI(t,n,o),this.resultCollector.add(t),t}const a=t.inpaintResult?.cleanImage||t.imageData.cleanImageData||this.extractBase64(t.imageData.translatedDataURL||t.imageData.originalDataURL),r=await fn({clean_image:a,bubble_states:i,fontSize:l.settings.textStyle.fontSize,fontFamily:l.settings.textStyle.fontFamily,textDirection:l.settings.textStyle.layoutDirection,textColor:l.settings.textStyle.textColor,strokeEnabled:l.settings.textStyle.strokeEnabled,strokeColor:l.settings.textStyle.strokeColor,strokeWidth:l.settings.textStyle.strokeWidth,autoFontSize:l.settings.textStyle.autoFontSize,use_individual_styles:!0});if(!r.success)throw new Error(r.error||"æ¸²æŸ“å¤±è´¥");return t.renderResult={finalImage:r.final_image||"",bubbleStates:r.bubble_states||i},t.status="completed",this.updateImageToUI(t,n,o),this.resultCollector.add(t),t}updateImageToUI(t,n,o){const l=t.imageIndex,i=(t.detectionResult?.bubbleCoords||[]).map(a=>a.length>=4?[a[0],a[1],a[2],a[3]]:[0,0,0,0]);n.updateImageByIndex(l,{translatedDataURL:`data:image/png;base64,${t.renderResult.finalImage}`,cleanImageData:t.inpaintResult?.cleanImage||null,bubbleStates:t.renderResult.bubbleStates,bubbleCoords:i,bubbleAngles:t.detectionResult?.bubbleAngles||[],originalTexts:t.ocrResult?.originalTexts||[],bubbleTexts:t.translateResult?.translatedTexts||[],textboxTexts:t.translateResult?.textboxTexts||[],translationStatus:"completed",translationFailed:!1,showOriginal:!1,hasUnsavedChanges:!0}),l===n.currentImageIndex&&t.renderResult?.bubbleStates&&o.setBubbles(t.renderResult.bubbleStates),this.progressTracker.incrementCompleted(),console.log(`âœ… å›¾ç‰‡ ${l+1} æ¸²æŸ“å®Œæˆå¹¶å·²æ›´æ–°åˆ°ç•Œé¢`)}buildBubbleStates(t,n){if(!t.detectionResult&&t.imageData.bubbleStates&&t.imageData.bubbleStates.length>0){const D=t.translateResult?.translatedTexts||[];return t.imageData.bubbleStates.map((B,I)=>({...B,translatedText:D[I]||B.translatedText||""}))}if(t.detectionResult&&!t.translateResult)return console.log(`[æ¸²æŸ“æ± ] å›¾ç‰‡ ${t.imageIndex+1}: æ£€æµ‹åˆ°æ¶ˆé™¤æ–‡å­—æ¨¡å¼ï¼ˆæ— ç¿»è¯‘ç»“æœï¼‰ï¼Œè·³è¿‡æ¸²æŸ“`),[];const o=t.detectionResult?.bubbleCoords||[],l=t.translateResult?.translatedTexts||[],i=t.ocrResult?.originalTexts||[],a=t.colorResult?.colors||[],r=t.detectionResult?.bubbleAngles||[],h=t.detectionResult?.autoDirections||[],T=t.detectionResult?.bubblePolygons||[],S=n.settings;return o.map((D,B)=>{const I=h[B],A=I==="v"?"vertical":I==="h"?"horizontal":"vertical";let w=S.textStyle.textColor,N=S.textStyle.fillColor;const W=a[B];return S.textStyle.useAutoTextColor&&W&&(W.textColor&&(w=W.textColor),W.bgColor&&(N=W.bgColor)),{originalText:i[B]||"",translatedText:l[B]||"",textboxText:"",coords:D.length>=4?[D[0],D[1],D[2],D[3]]:[0,0,0,0],polygon:T[B]||[],fontSize:S.textStyle.fontSize,fontFamily:S.textStyle.fontFamily,textDirection:S.textStyle.layoutDirection,autoTextDirection:A,textColor:w,fillColor:N,rotationAngle:r[B]||0,position:{x:0,y:0},strokeEnabled:S.textStyle.strokeEnabled,strokeColor:S.textStyle.strokeColor,strokeWidth:S.textStyle.strokeWidth,inpaintMethod:S.textStyle.inpaintMethod,autoFgColor:W?.autoFgColor||null,autoBgColor:W?.autoBgColor||null}})}extractBase64(t){return t.includes("base64,")?t.split("base64,")[1]||"":t}}const Yo={standard:["detection","ocr","color","translate","inpaint","render"],hq:["detection","ocr","color","translate","inpaint","render"],proofread:["translate","render"],removeText:["detection","inpaint","render"]};class Kl{lock;progressTracker;resultCollector;detectionPool;ocrPool;colorPool;translatePool;inpaintPool;renderPool;isCancelled=!1;config;constructor(t){this.config=t,this.lock=new Bl(t.deepLearningLockSize),this.progressTracker=new Ll,this.resultCollector=new Fl,this.renderPool=new Wl(this.progressTracker,this.resultCollector),this.inpaintPool=new Vl(this.renderPool,this.lock,this.progressTracker),this.translatePool=new Nl(this.inpaintPool,this.progressTracker),this.colorPool=new zl(this.translatePool,this.lock,this.progressTracker),this.ocrPool=new Ol(this.colorPool,this.lock,this.progressTracker),this.detectionPool=new Ul(this.ocrPool,this.lock,this.progressTracker)}updateConfig(t){t.deepLearningLockSize!==void 0&&(this.lock.setSize(t.deepLearningLockSize),this.config.deepLearningLockSize=t.deepLearningLockSize),t.enabled!==void 0&&(this.config.enabled=t.enabled)}async execute(t,n){this.reset(),this.progressTracker.init(t.length),this.resultCollector.init(t.length),this.setupPoolChain(n,t.length);const o=t.map((a,r)=>({id:`task-${r}`,imageIndex:r,imageData:a,status:"pending"})),l=this.getEntryPool(n);for(const a of o)l.enqueue(a);const i=await this.resultCollector.waitForAll(t.length);return{success:i.success,failed:i.failed,errors:this.resultCollector.getFailed().map(a=>a.error||"æœªçŸ¥é”™è¯¯")}}setupPoolChain(t,n){const o=Yo[t],l=this.getPoolMap();for(let h=0;h<o.length-1;h++){const T=o[h],S=o[h+1],D=l[T],B=l[S];D&&B&&D.setNextPool(B)}const i=o[o.length-1],a=l[i];a&&a.setNextPool(null);const r=o.indexOf("translate");if(r>=0&&r<o.length-1){const h=o[r+1];this.translatePool.setMode(t,n,l[h]||null)}else r===o.length-1&&this.translatePool.setMode(t,n,null)}getPoolMap(){return{detection:this.detectionPool,ocr:this.ocrPool,color:this.colorPool,translate:this.translatePool,inpaint:this.inpaintPool,render:this.renderPool}}getEntryPool(t){const o=Yo[t][0];return this.getPoolMap()[o]||this.detectionPool}cancel(){this.isCancelled=!0,this.detectionPool.cancel(),this.ocrPool.cancel(),this.colorPool.cancel(),this.translatePool.cancel(),this.inpaintPool.cancel(),this.renderPool.cancel(),this.lock.reset()}reset(){this.isCancelled=!1,this.detectionPool.reset(),this.ocrPool.reset(),this.colorPool.reset(),this.translatePool.reset(),this.inpaintPool.reset(),this.renderPool.reset(),this.resultCollector.reset(),this.progressTracker.reset()}get progress(){return this.progressTracker.progress}getProgressTracker(){return this.progressTracker}getLockStatus(){return this.lock.getStatus()}get cancelled(){return this.isCancelled}}function ql(s){return new Kl(s)}const mt=io({pools:[{name:"æ£€æµ‹",icon:"ğŸ“",waiting:0,processing:!1,completed:0,isWaitingLock:!1},{name:"OCR",icon:"ğŸ“–",waiting:0,processing:!1,completed:0,isWaitingLock:!1},{name:"é¢œè‰²",icon:"ğŸ¨",waiting:0,processing:!1,completed:0,isWaitingLock:!1},{name:"ç¿»è¯‘",icon:"ğŸŒ",waiting:0,processing:!1,completed:0,isWaitingLock:!1},{name:"ä¿®å¤",icon:"ğŸ–Œï¸",waiting:0,processing:!1,completed:0,isWaitingLock:!1},{name:"æ¸²æŸ“",icon:"âœ¨",waiting:0,processing:!1,completed:0,isWaitingLock:!1}],totalCompleted:0,totalFailed:0,totalPages:0,estimatedTimeRemaining:0}),Hl=_(!1);function bn(){const s=Qe(),t=Ue(),n=Yn(null),o=q(()=>t.settings.parallel),l=q(()=>o.value?.enabled??!1),i=Hl,a=q(()=>mt);function r(){const B=t.settings;return B.proofreading?.enabled&&B.proofreading.rounds.length>0?"proofread":["gemini","openai","claude","deepseek"].includes(B.hqTranslation?.provider||"")&&B.hqTranslation?.apiKey?"hq":"standard"}function h(){if(!n.value)return;const B=n.value.progress;B&&(mt.pools=B.pools.map(I=>({...I})),mt.totalCompleted=B.totalCompleted,mt.totalFailed=B.totalFailed,mt.totalPages=B.totalPages,mt.estimatedTimeRemaining=B.estimatedTimeRemaining)}async function T(B){if(i.value)return{success:0,failed:0,errors:["ç¿»è¯‘æ­£åœ¨è¿›è¡Œä¸­"]};const I=s.images;if(I.length===0)return{success:0,failed:0,errors:["æ²¡æœ‰å›¾ç‰‡"]};i.value=!0,mt.totalPages=I.length,mt.totalCompleted=0,mt.totalFailed=0;const A=setInterval(h,200);try{n.value=ql({enabled:!0,deepLearningLockSize:o.value?.deepLearningLockSize??1});const w=B??r();console.log(`ğŸš€ å¼€å§‹å¹¶è¡Œç¿»è¯‘ï¼Œæ¨¡å¼: ${w}ï¼Œå›¾ç‰‡æ•°: ${I.length}`);const N=await n.value.execute(I,w);return h(),console.log(`âœ… å¹¶è¡Œç¿»è¯‘å®Œæˆï¼ŒæˆåŠŸ: ${N.success}ï¼Œå¤±è´¥: ${N.failed}`),N}catch(w){return console.error("å¹¶è¡Œç¿»è¯‘å‡ºé”™:",w),{success:0,failed:I.length,errors:[w.message]}}finally{clearInterval(A),i.value=!1}}function S(){n.value&&n.value.cancel(),i.value=!1}function D(){n.value=null,i.value=!1}return{isEnabled:l,isRunning:i,progress:a,executeParallel:T,cancel:S,reset:D,determineMode:r}}function jl(){const s=Qe(),t=Ue(),n=rt(),o=El(),l=bn(),i=q(()=>o.isTranslating.value||s.isBatchTranslationInProgress),a=q(()=>o.progressPercent.value);async function r(S){return s.images.length===0?(n.error("è¯·å…ˆä¸Šä¼ å›¾ç‰‡"),{success:!1,completed:0,failed:0,errors:["æ²¡æœ‰å›¾ç‰‡"]}):t.settings.parallel?.enabled&&S.scope==="all"?(console.log(`ğŸš€ ä½¿ç”¨å¹¶è¡Œç®¡çº¿ï¼Œæ¨¡å¼: ${S.mode}`),h(S)):(console.log(`ğŸš€ ä½¿ç”¨é¡ºåºç®¡çº¿ï¼Œæ¨¡å¼: ${S.mode}`),o.execute(S))}async function h(S){const D=s.images;try{const B=S.mode;console.log(`ğŸš€ å¯åŠ¨å¹¶è¡Œç¿»è¯‘æ¨¡å¼: ${B}`),n.info(`å¹¶è¡Œç¿»è¯‘å¼€å§‹ï¼Œæ¨¡å¼: ${B}`);const I=await l.executeParallel(B);return I.success>0&&I.failed===0?n.success(`å¹¶è¡Œç¿»è¯‘å®Œæˆï¼ŒæˆåŠŸå¤„ç† ${I.success} å¼ å›¾ç‰‡`):I.success>0&&I.failed>0?n.warning(`å¹¶è¡Œç¿»è¯‘å®Œæˆï¼ŒæˆåŠŸ ${I.success} å¼ ï¼Œå¤±è´¥ ${I.failed} å¼ `):n.error("å¹¶è¡Œç¿»è¯‘å¤±è´¥"),{success:I.failed===0,completed:I.success,failed:I.failed,errors:I.errors}}catch(B){const I=B instanceof Error?B.message:"å¹¶è¡Œç¿»è¯‘å‡ºé”™";return n.error(I),{success:!1,completed:0,failed:D.length,errors:[I]}}}function T(){o.cancel(),l.cancel()}return{progress:o.progress,isExecuting:o.isExecuting,isTranslating:i,progressPercent:a,execute:r,cancel:T,STEP_CHAIN_CONFIGS:o.STEP_CHAIN_CONFIGS}}function At(s="current"){return{mode:"standard",scope:s}}function Jl(s){return{mode:"hq",scope:"all",batchOptions:{batchSize:3,maxRetries:2,rpmLimit:10,sessionResetFrequency:5}}}function Gl(s){return{mode:"proofread",scope:"all",batchOptions:{batchSize:3,maxRetries:2,rpmLimit:10,sessionResetFrequency:5}}}function Xo(s="current"){return{mode:"removeText",scope:s}}function po(){const s=Qe(),t=ct(),n=rt(),o=jl(),l=o.progress,i=o.isExecuting,a=o.isTranslating,r=o.progressPercent,h=q(()=>o.isExecuting.value),T=q(()=>o.isExecuting.value);async function S(){return(await o.execute(At("current"))).success}async function D(g){const C=s.currentImageIndex;s.setCurrentImageIndex(g);const k=await o.execute(At("current"));return s.setCurrentImageIndex(C),k.success}async function B(){return(await o.execute(At("all"))).success}function I(){o.cancel()}async function A(){return(await o.execute(Xo("current"))).success}async function w(){return(await o.execute(Xo("all"))).success}async function N(){return s.getFailedImageIndices().length===0?(n.info("æ²¡æœ‰å¤±è´¥çš„å›¾ç‰‡éœ€è¦é‡æ–°ç¿»è¯‘"),!0):(await o.execute(At("failed"))).success}async function W(){return(await o.execute(Jl())).success}async function U(){return(await o.execute(Gl())).success}async function f(){if(!s.currentImage)return n.error("è¯·å…ˆä¸Šä¼ å›¾ç‰‡"),!1;const C=t.bubbles;return!C||C.length===0?(n.error("å½“å‰å›¾ç‰‡æ²¡æœ‰æ°”æ³¡æ¡†ï¼Œè¯·å…ˆæ£€æµ‹æˆ–æ‰‹åŠ¨æ·»åŠ "),!1):(s.setManuallyAnnotated(!0),S())}return{progress:l,isTranslatingSingle:i,isHqTranslating:h,isProofreading:T,isTranslating:a,progressPercent:r,translateCurrentImage:S,translateImageByIndex:D,translateAllImages:B,cancelBatchTranslation:I,removeTextOnly:A,removeAllTexts:w,retryFailedImages:N,executeHqTranslation:W,executeProofreading:U,translateWithCurrentBubbles:f}}function Yl(){const s=ct(),t=Qe(),n=_(!1);function o(){if(!n.value)return;const l=t.currentImage;s.bubbleCount>0?t.updateCurrentBubbleStates([...s.bubbles]):l&&Array.isArray(l.bubbleStates)&&l.bubbleStates.length>0&&(t.updateCurrentBubbleStates([]),console.log("é€€å‡ºç¼–è¾‘æ¨¡å¼ï¼ˆæ— é‡æ¸²æŸ“ï¼‰ï¼Œç”¨æˆ·å·²åˆ é™¤æ‰€æœ‰æ°”æ³¡")),n.value=!1,s.clearSelection(),console.log("å·²é€€å‡ºç¼–è¾‘æ¨¡å¼ï¼ˆæ— é‡æ¸²æŸ“ï¼‰")}return{isActive:n,exitEditModeWithoutRender:o}}function Xl(){const s=on(),t=Ue(),n=Qe(),o=rn(),l=ct(),i=Yl(),a=_(!1),r=_(!1),h=_(null),T=_([]),S=_([]),D=_([]),B=_(null),I=_(null),A=_(null),w=_(null),N=_(!1);async function W(Q=!1){if(!Q&&(a.value||r.value)){console.log("[TranslateInit] å·²ç»åˆå§‹åŒ–ï¼Œä»…é‡æ–°åŠ è½½ä¸Šä¸‹æ–‡"),await k();return}console.log("[TranslateInit] å¼€å§‹åˆå§‹åŒ–åº”ç”¨..."),a.value=!0,h.value=null;try{await U(),await f(),await g(),await C(),await k(),console.log("[TranslateInit] åº”ç”¨åˆå§‹åŒ–å®Œæˆ"),r.value=!0}catch(p){console.error("[TranslateInit] åº”ç”¨åˆå§‹åŒ–å¤±è´¥:",p),h.value=p instanceof Error?p.message:"åˆå§‹åŒ–å¤±è´¥"}finally{a.value=!1}}async function U(){console.log("[TranslateInit] åˆå§‹åŒ–è®¾ç½®..."),t.initSettings();try{const Q=await t.loadFromBackend();console.log(Q?"[TranslateInit] å·²ä»åç«¯åŠ è½½è®¾ç½®":"[TranslateInit] åç«¯æ— è®¾ç½®ï¼Œä½¿ç”¨ localStorage æ•°æ®")}catch(Q){console.warn("[TranslateInit] ä»åç«¯åŠ è½½è®¾ç½®å¤±è´¥ï¼Œä½¿ç”¨ localStorage æ•°æ®:",Q)}console.log("[TranslateInit] è®¾ç½®åˆå§‹åŒ–å®Œæˆ")}async function f(){console.log("[TranslateInit] åˆå§‹åŒ–å­—ä½“åˆ—è¡¨...");try{const Q=await sn();Q.fonts&&Q.fonts.length>0?(T.value=Q.fonts,console.log(`[TranslateInit] å·²åŠ è½½ ${Q.fonts.length} ä¸ªå­—ä½“`)):Q.error?console.warn("[TranslateInit] è·å–å­—ä½“åˆ—è¡¨å¤±è´¥:",Q.error):console.warn("[TranslateInit] å­—ä½“åˆ—è¡¨ä¸ºç©º")}catch(Q){console.error("[TranslateInit] è·å–å­—ä½“åˆ—è¡¨å¤±è´¥:",Q)}}async function g(){console.log("[TranslateInit] åˆå§‹åŒ–ç¿»è¯‘æç¤ºè¯è®¾ç½®...");try{const Q=await ps();Q.prompt_names!==void 0?(S.value=Q.prompt_names||[],!t.settings.translatePrompt&&Q.default_prompt_content&&t.setTranslatePrompt(Q.default_prompt_content),console.log(`[TranslateInit] å·²åŠ è½½ ${S.value.length} ä¸ªç¿»è¯‘æç¤ºè¯`)):Q.error&&console.warn("[TranslateInit] è·å–ç¿»è¯‘æç¤ºè¯å¤±è´¥:",Q.error)}catch(Q){console.error("[TranslateInit] è·å–ç¿»è¯‘æç¤ºè¯å¤±è´¥:",Q)}}async function C(){console.log("[TranslateInit] åˆå§‹åŒ–æ–‡æœ¬æ¡†æç¤ºè¯è®¾ç½®...");try{const Q=await gs();Q.prompt_names!==void 0?(D.value=Q.prompt_names||[],!t.settings.textboxPrompt&&Q.default_prompt_content&&t.setTextboxPrompt(Q.default_prompt_content),console.log(`[TranslateInit] å·²åŠ è½½ ${D.value.length} ä¸ªæ–‡æœ¬æ¡†æç¤ºè¯`)):Q.error&&console.warn("[TranslateInit] è·å–æ–‡æœ¬æ¡†æç¤ºè¯å¤±è´¥:",Q.error)}catch(Q){console.error("[TranslateInit] è·å–æ–‡æœ¬æ¡†æç¤ºè¯å¤±è´¥:",Q)}}async function k(){const Q=s.query.book,p=s.query.chapter;if(!Q||!p){console.log("[TranslateInit] æœªæŒ‡å®šä¹¦ç±/ç« èŠ‚å‚æ•°ï¼Œä½¿ç”¨ç‹¬ç«‹æ¨¡å¼"),N.value=!1,B.value=null,I.value=null,A.value=null,w.value=null,o.clearContext();return}console.log(`[TranslateInit] æ£€æµ‹åˆ°ä¹¦ç±/ç« èŠ‚å‚æ•°: book=${Q}, chapter=${p}`),N.value=!0,B.value=Q,I.value=p;try{const m=await vs(Q);if(!m.success||!m.book){console.warn("[TranslateInit] ä¹¦ç±ä¸å­˜åœ¨:",Q),fe("ä¹¦ç±ä¸å­˜åœ¨","warning");return}const x=m.book,b=x.chapters?.find(u=>u.id===p);if(!b){console.warn("[TranslateInit] ç« èŠ‚ä¸å­˜åœ¨:",p),fe("ç« èŠ‚ä¸å­˜åœ¨","warning");return}if(A.value=x.title,w.value=b.title,o.setBookChapterContext(Q,p,x.title,b.title),typeof document<"u"&&(document.title=`${b.title} - ${x.title} - Saber-Translator`),b.session_path){console.log(`[TranslateInit] å°è¯•åŠ è½½ç« èŠ‚ä¼šè¯: ${b.session_path}`);try{await o.loadSessionByPath(b.session_path),fe(`å·²åŠ è½½ç« èŠ‚: ${b.title}`,"success")}catch{console.log("[TranslateInit] ç« èŠ‚ä¼šè¯æ•°æ®ä¸å­˜åœ¨æˆ–åŠ è½½å¤±è´¥ï¼Œå°†åˆ›å»ºæ–°ä¼šè¯")}}}catch(m){console.error("[TranslateInit] åŠ è½½ä¹¦ç±/ç« èŠ‚ä¿¡æ¯å¤±è´¥:",m),fe("åŠ è½½ä¹¦ç±ä¿¡æ¯å¤±è´¥","error")}}function V(Q){if(Q<0||Q>=n.imageCount){console.warn(`[TranslateInit] æ— æ•ˆçš„å›¾ç‰‡ç´¢å¼•: ${Q}`);return}window._isChangingFromSwitchImage=!0,i.isActive.value&&i.exitEditModeWithoutRender(),n.currentImage&&l.bubbles.length>0&&n.updateCurrentImageProperty("bubbleStates",l.bubbles),n.setCurrentImageIndex(Q);const m=n.currentImage;if(!m){console.warn("[TranslateInit] åˆ‡æ¢åˆ°çš„å›¾ç‰‡ä¸å­˜åœ¨"),window._isChangingFromSwitchImage=!1;return}console.log(`[TranslateInit] åˆ‡æ¢åˆ°å›¾ç‰‡: ${Q}, ${m.fileName}`),m.bubbleStates&&m.bubbleStates.length>0?l.setBubbles(m.bubbleStates,!0):l.clearBubblesLocal(),Y(m),setTimeout(()=>{window._isChangingFromSwitchImage=!1,console.log("[TranslateInit] å·²é‡ç½®åˆ‡æ¢å›¾ç‰‡æ“ä½œæ ‡è®°")},100)}function Y(Q){if(!Q)return;const p=Q.bubbleStates?.[0];p&&t.updateTextStyle({fontSize:p.fontSize||t.settings.textStyle.fontSize,fontFamily:p.fontFamily||t.settings.textStyle.fontFamily,layoutDirection:Q.userLayoutDirection||p.textDirection||t.settings.textStyle.layoutDirection,textColor:p.textColor||t.settings.textStyle.textColor,fillColor:p.fillColor||t.settings.textStyle.fillColor,strokeEnabled:p.strokeEnabled??t.settings.textStyle.strokeEnabled,strokeColor:p.strokeColor||t.settings.textStyle.strokeColor,strokeWidth:p.strokeWidth||t.settings.textStyle.strokeWidth,inpaintMethod:p.inpaintMethod||t.settings.textStyle.inpaintMethod,autoFontSize:Q.autoFontSize??t.settings.textStyle.autoFontSize})}function ie(){n.canGoPrevious&&V(n.currentImageIndex-1)}function X(){n.canGoNext&&V(n.currentImageIndex+1)}function ae(){ut(async()=>{await W()})}return{isInitializing:a,isInitialized:r,initError:h,fontList:T,promptNames:S,textboxPromptNames:D,currentBookId:B,currentChapterId:I,currentBookTitle:A,currentChapterTitle:w,isBookshelfMode:N,initializeApp:W,initializeSettings:U,initializeFontList:f,initializePromptSettings:g,initializeTextboxPromptSettings:C,initializeBookChapterContext:k,switchImage:V,goToPrevious:ie,goToNext:X,loadImageSettingsToStore:Y,editMode:i,setupAutoInit:ae}}const Zl={key:0,id:"translationProgressBar",class:"translation-progress-bar"},Ql={class:"parallel-header"},ei={class:"header-title"},ti={class:"pools-list"},oi={class:"pool-label"},ni={class:"pool-icon"},si={class:"pool-name"},ai={class:"pool-progress-bar"},li={class:"pool-stats"},ii={class:"completed-count"},ri={class:"total-count"},ui={key:0,class:"waiting-badge"},ci={key:1,class:"lock-indicator",title:"ç­‰å¾…æ·±åº¦å­¦ä¹ é”"},di={class:"overall-section"},gi={class:"overall-label"},pi={key:0,class:"failed-text"},mi={class:"overall-progress-bar"},vi={class:"progress-bar-label"},fi={key:0,class:"failed-count"},bi={class:"progress-bar"},hi=Je({__name:"TranslationProgress",props:{progress:{}},setup(s){const t=s,n=Qe(),o=Ue(),l=po(),i=bn(),a=q(()=>o.settings.parallel?.enabled&&i.isRunning.value),r=q(()=>i.progress.value),h=q(()=>{const U=r.value;return!U||U.totalPages===0?0:Math.round(U.totalCompleted/U.totalPages*100)});function T(U){const f=r.value?.totalPages||0;return f===0?0:Math.round(U.completed/f*100)}function S(){const U=r.value?.totalPages||0;return U===0?0:Math.max(3,Math.round(1/U*100))}const D=q(()=>t.progress||l.progress.value),B=q(()=>D.value.isInProgress||n.isBatchTranslationInProgress||a.value),I=q(()=>D.value.current),A=q(()=>D.value.total),w=q(()=>D.value.failed),N=q(()=>D.value.percentage!==void 0?D.value.percentage:A.value===0?0:Math.round(I.value/A.value*100)),W=q(()=>D.value.label?D.value.label:`ç¿»è¯‘ä¸­ï¼š${I.value} / ${A.value}`);return(U,f)=>B.value?(R(),E("div",Zl,[a.value&&r.value?(R(),E(Be,{key:0},[e("div",Ql,[e("span",ei,"ğŸš€ å¹¶è¡Œç¿»è¯‘ä¸­ï¼š"+oe(r.value.totalCompleted)+"/"+oe(r.value.totalPages),1)]),e("div",ti,[(R(!0),E(Be,null,He(r.value.pools,g=>(R(),E("div",{key:g.name,class:Te(["pool-row",{"pool-processing":g.processing,"pool-waiting-lock":g.isWaitingLock}])},[e("div",oi,[e("span",ni,oe(g.icon),1),e("span",si,oe(g.name),1)]),e("div",ai,[e("div",{class:"progress-completed",style:ot({width:T(g)+"%"})},null,4),g.processing?(R(),E("div",{key:0,class:"progress-processing",style:ot({left:T(g)+"%",width:S()+"%"})},null,4)):ge("",!0)]),e("div",li,[e("span",ii,oe(g.completed),1),e("span",ri,"/ "+oe(r.value.totalPages),1),g.waiting>0?(R(),E("span",ui,"+"+oe(g.waiting),1)):ge("",!0),g.isWaitingLock?(R(),E("span",ci,"ğŸ”’")):ge("",!0)])],2))),128))]),f[0]||(f[0]=e("div",{class:"divider"},null,-1)),e("div",di,[e("div",gi,[Ce(" æ€»è¿›åº¦ï¼š"+oe(h.value)+"% ",1),r.value.totalFailed>0?(R(),E("span",pi," ï¼ˆ"+oe(r.value.totalFailed)+" å¤±è´¥ï¼‰ ",1)):ge("",!0)]),e("div",mi,[e("div",{class:"overall-progress-fill",style:ot({width:h.value+"%"})},null,4)])])],64)):(R(),E(Be,{key:1},[e("div",vi,[Ce(oe(W.value)+" ",1),w.value>0?(R(),E("span",fi,"ï¼ˆ"+oe(w.value)+" å¼ å¤±è´¥ï¼‰",1)):ge("",!0)]),e("div",bi,[e("div",{class:"progress",style:ot({width:`${N.value}%`})},null,4)])],64))])):ge("",!0)}}),yi=je(hi,[["__scopeId","data-v-bbcb3b33"]]),xi=Je({__name:"SponsorModal",emits:["close"],setup(s,{emit:t}){const n=t;return(o,l)=>(R(),st(an,{title:"æ”¯æŒä½œè€…",onClose:l[1]||(l[1]=i=>n("close"))},{footer:yt(()=>[e("button",{type:"button",class:"btn btn-primary",onClick:l[0]||(l[0]=i=>n("close"))},"å…³é—­")]),default:yt(()=>[l[2]||(l[2]=e("div",{class:"sponsor-content"},[e("p",{class:"sponsor-message"}," å¦‚æœè¿™ä¸ªé¡¹ç›®å¯¹ä½ æœ‰å¸®åŠ©ï¼Œæ¬¢è¿è¯·ä½œè€…å–æ¯å’–å•¡ â˜• "),e("div",{class:"qr-codes"},[e("div",{class:"qr-item"},[e("div",{class:"qr-image"},[e("img",{src:"/pic/wechat_qrcode.png",alt:"å¾®ä¿¡æ”¯ä»˜"})]),e("span",{class:"qr-label"},"å¾®ä¿¡æ”¯ä»˜")]),e("div",{class:"qr-item"},[e("div",{class:"qr-image"},[e("img",{src:"/pic/alipay_qrcode.png",alt:"æ”¯ä»˜å®"})]),e("span",{class:"qr-label"},"æ”¯ä»˜å®")])]),e("p",{class:"sponsor-thanks"},"æ„Ÿè°¢æ‚¨çš„æ”¯æŒï¼ğŸ™")],-1))]),_:1}))}}),_i=je(xi,[["__scopeId","data-v-02b6948e"]]);function ki(s){const t=_(""),n=q(()=>s.value.some(I=>I.folderPath)),o=q(()=>{if(!n.value)return null;const I={name:"æ ¹ç›®å½•",path:"",images:[],subfolders:[]},A=new Map;A.set("",I);for(const w of s.value){const N=w.folderPath||"";if(N&&!A.has(N)){const W=N.split("/");let U="";for(const f of W){const g=U;if(U=U?`${U}/${f}`:f,!A.has(U)){const C={name:f,path:U,images:[],subfolders:[]};A.set(U,C),A.has(g)&&A.get(g).subfolders.push(C)}}}A.has(N)&&A.get(N).images.push(w)}return I}),l=q(()=>{if(!t.value)return[{name:"æ ¹ç›®å½•",path:""}];const I=t.value.split("/"),A=[{name:"æ ¹ç›®å½•",path:""}];let w="";for(const N of I)w=w?`${w}/${N}`:N,A.push({name:N,path:w});return A}),i=q(()=>{if(!o.value)return null;if(!t.value)return o.value;const I=(A,w)=>{if(A.path===w)return A;for(const N of A.subfolders){const W=I(N,w);if(W)return W}return null};return I(o.value,t.value)}),a=q(()=>i.value?.subfolders||[]),r=q(()=>i.value?.images||[]);function h(I){t.value=I}function T(){if(!t.value)return;const I=t.value.lastIndexOf("/");t.value=I>0?t.value.substring(0,I):""}function S(I){t.value=I}function D(I){let A=I.images.length;for(const w of I.subfolders)A+=D(w);return A}function B(){t.value=""}return{currentFolderPath:t,useTreeMode:n,folderTree:o,breadcrumbs:l,currentFolder:i,currentSubfolders:a,currentImages:r,enterFolder:h,goUp:T,navigateTo:S,getFolderImageCount:D,resetToRoot:B}}const Ci={id:"thumbnail-sidebar",class:"thumbnail-sidebar"},Si={class:"card thumbnail-card"},wi={class:"breadcrumb-nav"},$i=["onClick"],Ti={key:0,class:"breadcrumb-sep"},Ii=["onClick"],Ri={class:"folder-info"},Pi=["title"],Di={class:"folder-count"},Mi=["title","onClick"],Ei=["src","alt"],Bi={key:1,class:"translation-failed-indicator"},Ai={key:2,class:"labeled-indicator"},Li={key:3,class:"thumbnail-processing-indicator"},Fi={key:0,class:"empty-folder"},Ui=["title","data-index","onClick"],Oi=["src","alt"],zi={key:1,class:"translation-failed-indicator"},Ni={key:2,class:"labeled-indicator"},Vi={key:3,class:"thumbnail-processing-indicator"},Wi={key:2,class:"empty-state"},Ki=Je({__name:"ThumbnailSidebar",emits:["select"],setup(s,{emit:t}){const n=t,o=Qe(),l=_(null),i=_([]),a=q(()=>o.images),r=q(()=>o.currentImageIndex),h=q(()=>o.hasImages),{useTreeMode:T,breadcrumbs:S,currentSubfolders:D,currentImages:B,currentFolderPath:I,enterFolder:A,goUp:w,navigateTo:N,getFolderImageCount:W,folderTree:U,resetToRoot:f}=ki(a);xe(()=>a.value.length,(p,m)=>{(p===0||m===0&&p>0)&&f()});function g(p){return a.value.findIndex(m=>m.id===p.id)}function C(p){return p.translationFailed?"failed":p.isManuallyAnnotated?"labeled":p.translationStatus==="processing"?"processing":null}function k(p){n("select",p)}function V(p){A(p.path)}function Y(p){N(p)}function ie(){dt(()=>{const p=i.value[r.value];if(p&&l.value){const m=l.value,x=p.offsetTop-m.clientHeight/2+p.clientHeight/2;m.scrollTo({top:Math.max(0,x),behavior:"smooth"})}})}function X(p,m){i.value[m]=p}function ae(p){const m=[];return p.translationFailed&&m.push("translation-failed"),p.isManuallyAnnotated&&m.push("has-manual-labels"),m}function Q(p){return p.translationFailed?"ç¿»è¯‘å¤±è´¥ï¼Œç‚¹å‡»å¯é‡è¯•":p.isManuallyAnnotated?"åŒ…å«æ‰‹åŠ¨æ ‡æ³¨":p.fileName||""}return xe(r,()=>{ie()}),ut(()=>{h.value&&ie()}),(p,m)=>(R(),E("aside",Ci,[e("div",Si,[m[5]||(m[5]=e("h2",null,"å›¾ç‰‡æ¦‚è§ˆ",-1)),h.value&&K(T)&&K(U)?(R(),E(Be,{key:0},[e("div",wi,[(R(!0),E(Be,null,He(K(S),(x,b)=>(R(),E(Be,{key:x.path},[e("span",{class:Te(["breadcrumb-item",{active:b===K(S).length-1}]),onClick:u=>b<K(S).length-1&&Y(x.path)},oe(b===0?"ğŸ“":"")+oe(x.name),11,$i),b<K(S).length-1?(R(),E("span",Ti,"/")):ge("",!0)],64))),128))]),K(I)?(R(),E("div",{key:0,class:"folder-back-btn",onClick:m[0]||(m[0]=(...x)=>K(w)&&K(w)(...x))},[...m[1]||(m[1]=[e("span",{class:"back-icon"},"â¬…ï¸",-1),e("span",null,"è¿”å›ä¸Šçº§",-1)])])):ge("",!0),e("div",{ref_key:"containerRef",ref:l,class:"folder-content-list"},[(R(!0),E(Be,null,He(K(D),x=>(R(),E("div",{key:x.path,class:"folder-item",onClick:b=>V(x)},[m[2]||(m[2]=e("span",{class:"folder-icon"},"ğŸ“",-1)),e("div",Ri,[e("span",{class:"folder-name",title:x.name},oe(x.name),9,Pi),e("span",Di,"("+oe(K(W)(x))+")",1)])],8,Ii))),128)),(R(!0),E(Be,null,He(K(B),x=>(R(),E("div",{key:x.id,ref_for:!0,ref:b=>X(b,g(x)),class:Te(["thumbnail-item",[{active:g(x)===r.value},...ae(x)]]),title:Q(x),onClick:b=>k(g(x))},[x.originalDataURL?(R(),E("img",{key:0,src:x.originalDataURL,alt:x.fileName,class:"thumbnail-image"},null,8,Ei)):ge("",!0),C(x)==="failed"?(R(),E("span",Bi,"!")):C(x)==="labeled"?(R(),E("span",Ai,"âœï¸")):ge("",!0),C(x)==="processing"?(R(),E("div",Li,"âŸ³")):ge("",!0)],10,Mi))),128)),K(D).length===0&&K(B).length===0?(R(),E("div",Fi,[...m[3]||(m[3]=[e("p",null,"æ­¤æ–‡ä»¶å¤¹ä¸ºç©º",-1)])])):ge("",!0)],512)],64)):h.value?(R(),E("ul",{key:1,ref_key:"containerRef",ref:l,id:"thumbnailList",class:"thumbnail-list"},[(R(!0),E(Be,null,He(a.value,(x,b)=>(R(),E("li",{key:x.id,ref_for:!0,ref:u=>X(u,b),class:Te(["thumbnail-item",[{active:b===r.value},...ae(x)]]),title:Q(x),"data-index":b,onClick:u=>k(b)},[x.originalDataURL?(R(),E("img",{key:0,src:x.originalDataURL,alt:x.fileName,class:"thumbnail-image"},null,8,Oi)):ge("",!0),C(x)==="failed"?(R(),E("span",zi,"!")):C(x)==="labeled"?(R(),E("span",Ni,"âœï¸")):ge("",!0),C(x)==="processing"?(R(),E("div",Vi," âŸ³ ")):ge("",!0)],10,Ui))),128))],512)):(R(),E("div",Wi,[...m[4]||(m[4]=[e("p",null,"æš‚æ— å›¾ç‰‡",-1)])]))])]))}}),qi=je(Ki,[["__scopeId","data-v-6aa1c6be"]]),Hi={class:"saved-prompts-picker"},ji={class:"prompts-chips-container"},Ji={key:0,class:"empty-hint"},Gi={key:1,class:"empty-hint"},Yi=["title","onClick"],Xi=Je({__name:"SavedPromptsPicker",props:{promptType:{}},emits:["select"],setup(s,{expose:t,emit:n}){const o=s,l=n,i=_([]),a=_(!1);async function r(){a.value=!0;try{let T;o.promptType==="textbox"?T=await We.getTextboxPrompts():T=await We.getPrompts(o.promptType);const S=T.prompt_names||[];i.value=S.map(D=>({name:D}))}catch(T){console.error("åŠ è½½æç¤ºè¯åˆ—è¡¨å¤±è´¥:",T),i.value=[]}finally{a.value=!1}}async function h(T){try{let S;o.promptType==="textbox"?S=await We.getTextboxPromptContent(T):S=await We.getPromptContent(o.promptType,T),S.prompt_content&&l("select",S.prompt_content,T)}catch(S){console.error("åŠ è½½æç¤ºè¯å†…å®¹å¤±è´¥:",S)}}return xe(()=>o.promptType,()=>{r()}),ut(()=>{r()}),t({refresh:r}),(T,S)=>(R(),E("div",Hi,[S[1]||(S[1]=e("span",{class:"picker-label"},"ğŸ“‘ å¿«é€Ÿé€‰æ‹©:",-1)),e("div",ji,[a.value?(R(),E("span",Ji,"åŠ è½½ä¸­...")):i.value.length===0?(R(),E("span",Gi,"æš‚æ— ä¿å­˜çš„æç¤ºè¯")):(R(!0),E(Be,{key:2},He(i.value,D=>(R(),E("button",{key:D.name,type:"button",class:"prompt-chip",title:D.name,onClick:B=>h(D.name)},[S[0]||(S[0]=e("span",{class:"chip-icon"},"ğŸ“",-1)),Ce(" "+oe(D.name),1)],8,Yi))),128))])]))}}),Pt=je(Xi,[["__scopeId","data-v-2ebbb8b3"]]),Zi={class:"ocr-settings"},Qi={class:"settings-group"},er={class:"settings-item"},tr={class:"settings-item"},or={class:"input-hint"},nr={class:"settings-group"},sr={class:"settings-row"},ar={class:"settings-item"},lr={class:"password-input-wrapper"},ir=["type"],rr={key:0,class:"eye-icon"},ur={key:1,class:"eye-off-icon"},cr={class:"settings-item"},dr={class:"password-input-wrapper"},gr=["type"],pr={key:0,class:"eye-icon"},mr={key:1,class:"eye-off-icon"},vr={class:"settings-row"},fr={class:"settings-item"},br={class:"settings-item"},hr=["disabled"],yr={class:"settings-group"},xr={class:"settings-row"},_r={class:"settings-item"},kr={class:"settings-item"},Cr={class:"password-input-wrapper"},Sr=["type"],wr={key:0,class:"eye-icon"},$r={key:1,class:"eye-off-icon"},Tr={class:"settings-item"},Ir={class:"settings-item"},Rr={class:"model-input-with-fetch"},Pr=["disabled"],Dr={class:"fetch-text"},Mr={key:0,class:"model-select-container"},Er={class:"model-count"},Br={class:"settings-item"},Ar={class:"prompt-format-selector"},Lr={class:"settings-item"},Fr=["disabled"],Ur=Je({__name:"OcrSettings",setup(s){const t=[{label:"MangaOCR (æ—¥è¯­ä¸“ç”¨)",value:"manga_ocr"},{label:"PaddleOCR (å¤šè¯­è¨€)",value:"paddle_ocr"},{label:"PaddleOCR-VL (æ—¥æ¼«ä¸“ç”¨)",value:"paddleocr_vl"},{label:"ç™¾åº¦OCR",value:"baidu_ocr"},{label:"48px OCR",value:"48px_ocr"},{label:"AIè§†è§‰OCR",value:"ai_vision"}],n=[{label:"æ ‡å‡†ç‰ˆ",value:"standard"},{label:"é«˜ç²¾åº¦ç‰ˆ",value:"high_precision"}],o=[{label:"è‡ªåŠ¨æ£€æµ‹",value:"auto_detect"},{label:"ä¸­è‹±æ–‡æ··åˆ",value:"CHN_ENG"},{label:"è‹±æ–‡",value:"ENG"},{label:"æ—¥è¯­",value:"JAP"},{label:"éŸ©è¯­",value:"KOR"},{label:"æ³•è¯­",value:"FRE"},{label:"å¾·è¯­",value:"GER"},{label:"ä¿„è¯­",value:"RUS"}],l=[{label:"SiliconFlow (ç¡…åŸºæµåŠ¨)",value:"siliconflow"},{label:"ç«å±±å¼•æ“",value:"volcano"},{label:"Google Gemini",value:"gemini"},{label:"è‡ªå®šä¹‰ OpenAI å…¼å®¹æœåŠ¡",value:"custom_openai_vision"}],i=[{label:"æ™®é€šæç¤ºè¯",value:"false"},{label:"JSONæç¤ºè¯",value:"true"}],a=[{label:"ğŸš€ å¸¸ç”¨è¯­è¨€",options:[{label:"æ—¥è¯­",value:"japanese"},{label:"è‹±è¯­",value:"en"},{label:"ç®€ä½“ä¸­æ–‡",value:"chinese"},{label:"ç¹ä½“ä¸­æ–‡",value:"chinese_cht"},{label:"éŸ©è¯­",value:"korean"}]},{label:"ğŸŒ æ‹‰ä¸è¯­ç³»",options:[{label:"æ³•è¯­",value:"french"},{label:"å¾·è¯­",value:"german"},{label:"è¥¿ç­ç‰™è¯­",value:"spanish"},{label:"æ„å¤§åˆ©è¯­",value:"italian"},{label:"è‘¡è„ç‰™è¯­",value:"portuguese"}]},{label:"ğŸŒ å…¶ä»–è¯­ç³»",options:[{label:"ä¿„è¯­",value:"russian"}]}],r=Ue(),h=rt(),T=_({apiKey:r.settings.baiduOcr.apiKey,secretKey:r.settings.baiduOcr.secretKey,version:r.settings.baiduOcr.version,sourceLanguage:r.settings.baiduOcr.sourceLanguage}),S=_({apiKey:r.settings.aiVisionOcr.apiKey,modelName:r.settings.aiVisionOcr.modelName,customBaseUrl:r.settings.aiVisionOcr.customBaseUrl,prompt:r.settings.aiVisionOcr.prompt,rpmLimit:r.settings.aiVisionOcr.rpmLimit}),D=q(()=>r.settings);xe(()=>T.value.apiKey,p=>{r.updateBaiduOcr({apiKey:p})}),xe(()=>T.value.secretKey,p=>{r.updateBaiduOcr({secretKey:p})}),xe(()=>T.value.version,p=>{r.updateBaiduOcr({version:p})}),xe(()=>T.value.sourceLanguage,p=>{r.updateBaiduOcr({sourceLanguage:p})}),xe(()=>S.value.apiKey,p=>{r.updateAiVisionOcr({apiKey:p})}),xe(()=>S.value.modelName,p=>{r.updateAiVisionOcr({modelName:p})}),xe(()=>S.value.customBaseUrl,p=>{r.updateAiVisionOcr({customBaseUrl:p})}),xe(()=>S.value.prompt,p=>{r.updateAiVisionOcr({prompt:p})}),xe(()=>S.value.rpmLimit,p=>{r.updateAiVisionOcr({rpmLimit:p})});const B=_(!1),I=_(!1),A=_(!1),w=_(!1),N=_(!1),W=_([]),U=q(()=>{const p=[{label:"-- é€‰æ‹©æ¨¡å‹ --",value:""}];return W.value.forEach(m=>{p.push({label:m,value:m})}),p});function f(){r.saveToStorage()}function g(){r.saveToStorage()}function C(){switch(r.settings.ocrEngine){case"manga_ocr":return"MangaOCR ä¸“ä¸ºæ—¥è¯­æ¼«ç”»ä¼˜åŒ–ï¼Œæºè¯­è¨€è®¾ç½®ä¸å½±å“è¯†åˆ«";case"paddle_ocr":return"PaddleOCR ä¼šæ ¹æ®æºè¯­è¨€åŠ è½½å¯¹åº”çš„è¯†åˆ«æ¨¡å‹";case"paddleocr_vl":return"PaddleOCR-VL åŸºäº VLM å¾®è°ƒï¼Œä¸“ä¸ºæ—¥è¯­æ¼«ç”»ä¼˜åŒ–ï¼Œå‡†ç¡®ç‡é«˜è¾¾ 70%";case"baidu_ocr":return"ç™¾åº¦OCR ä½¿ç”¨ç‹¬ç«‹çš„æºè¯­è¨€è®¾ç½®ï¼ˆè§ä¸‹æ–¹ï¼‰";case"ai_vision":return"AIè§†è§‰OCR é€šè¿‡æç¤ºè¯æŒ‡å®šè¯†åˆ«è¯­è¨€";case"48px_ocr":return"48px OCR æ”¯æŒæ—¥ä¸­è‹±éŸ©ç­‰å¤šè¯­è¨€ï¼Œæºè¯­è¨€è®¾ç½®ä¸å½±å“è¯†åˆ«";default:return"é€‰æ‹©è¦è¯†åˆ«çš„åŸæ–‡è¯­è¨€"}}function k(p){r.setAiVisionOcrProvider(p),W.value=[],V()}function V(){S.value.apiKey=r.settings.aiVisionOcr.apiKey,S.value.modelName=r.settings.aiVisionOcr.modelName,S.value.customBaseUrl=r.settings.aiVisionOcr.customBaseUrl,S.value.prompt=r.settings.aiVisionOcr.prompt,S.value.rpmLimit=r.settings.aiVisionOcr.rpmLimit}function Y(){const p=r.settings.aiVisionOcr.isJsonMode?qn:Hn;r.updateAiVisionOcr({prompt:p}),S.value.prompt=p}async function ie(){const p=T.value.apiKey?.trim(),m=T.value.secretKey?.trim();if(!p||!m){h.warning("è¯·å¡«å†™ç™¾åº¦OCRçš„API Keyå’ŒSecret Key");return}w.value=!0,h.info("æ­£åœ¨æµ‹è¯•ç™¾åº¦OCRè¿æ¥...");try{const x=await We.testBaiduOcrConnection(p,m);x.success?h.success(x.message||"ç™¾åº¦OCRè¿æ¥æˆåŠŸ!"):h.error(x.message||x.error||"ç™¾åº¦OCRè¿æ¥å¤±è´¥")}catch(x){const b=x instanceof Error?x.message:"è¿æ¥æµ‹è¯•å¤±è´¥";h.error(b)}finally{w.value=!1}}async function X(){w.value=!0;try{const p=await We.testAiVisionOcrConnection({provider:r.settings.aiVisionOcr.provider,apiKey:S.value.apiKey,modelName:S.value.modelName,customBaseUrl:S.value.customBaseUrl,prompt:S.value.prompt});p.success?h.success("AIè§†è§‰OCRè¿æ¥æˆåŠŸ"):h.error(`AIè§†è§‰OCRè¿æ¥å¤±è´¥: ${p.error||"æœªçŸ¥é”™è¯¯"}`)}catch(p){const m=p instanceof Error?p.message:"è¿æ¥æµ‹è¯•å¤±è´¥";h.error(m)}finally{w.value=!1}}async function ae(){const p=r.settings.aiVisionOcr.provider,m=S.value.apiKey?.trim(),x=S.value.customBaseUrl?.trim();if(!m){h.warning("è¯·å…ˆå¡«å†™ API Key");return}if(!["siliconflow","volcano","gemini","custom_openai_vision"].includes(p)){h.warning("å½“å‰æœåŠ¡å•†ä¸æ”¯æŒè‡ªåŠ¨è·å–æ¨¡å‹åˆ—è¡¨");return}if(p==="custom_openai_vision"&&!x){h.warning("è‡ªå®šä¹‰æœåŠ¡éœ€è¦å…ˆå¡«å†™ Base URL");return}N.value=!0;try{const u=await We.fetchModels(p,m,x);u.success&&u.models&&u.models.length>0?(W.value=u.models.map(c=>c.id),h.success(`è·å–åˆ° ${u.models.length} ä¸ªæ¨¡å‹`)):h.warning(u.message||"æœªè·å–åˆ°å¯ç”¨æ¨¡å‹")}catch(u){const c=u instanceof Error?u.message:"è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥";h.error(c)}finally{N.value=!1}}function Q(p,m){r.updateAiVisionOcr({prompt:p}),S.value.prompt=p,h.success(`å·²åº”ç”¨æç¤ºè¯: ${m}`)}return(p,m)=>(R(),E("div",Zi,[e("div",Qi,[m[19]||(m[19]=e("div",{class:"settings-group-title"},"OCRå¼•æ“é€‰æ‹©",-1)),e("div",er,[m[17]||(m[17]=e("label",{for:"settingsOcrEngine"},"OCRå¼•æ“:",-1)),ye(Ne,{"model-value":D.value.ocrEngine,options:t,onChange:m[0]||(m[0]=x=>{D.value.ocrEngine=x,f()})},null,8,["model-value"])]),ne(e("div",tr,[m[18]||(m[18]=e("label",{for:"settingsSourceLanguage"},"æºè¯­è¨€:",-1)),ye(Ne,{"model-value":D.value.sourceLanguage,groups:a,onChange:m[1]||(m[1]=x=>{D.value.sourceLanguage=x,g()})},null,8,["model-value"]),e("div",or,oe(C()),1)],512),[[Fe,D.value.ocrEngine==="paddle_ocr"]])]),ne(e("div",nr,[m[24]||(m[24]=e("div",{class:"settings-group-title"},"ç™¾åº¦OCR è®¾ç½®",-1)),e("div",sr,[e("div",ar,[m[20]||(m[20]=e("label",{for:"settingsBaiduApiKey"},"API Key:",-1)),e("div",lr,[ne(e("input",{type:B.value?"text":"password",id:"settingsBaiduApiKey","onUpdate:modelValue":m[2]||(m[2]=x=>T.value.apiKey=x),class:"secure-input",placeholder:"è¯·è¾“å…¥ç™¾åº¦OCR API Key",autocomplete:"off"},null,8,ir),[[kt,T.value.apiKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:m[3]||(m[3]=x=>B.value=!B.value)},[B.value?(R(),E("span",ur,"ğŸ‘â€ğŸ—¨")):(R(),E("span",rr,"ğŸ‘"))])])]),e("div",cr,[m[21]||(m[21]=e("label",{for:"settingsBaiduSecretKey"},"Secret Key:",-1)),e("div",dr,[ne(e("input",{type:I.value?"text":"password",id:"settingsBaiduSecretKey","onUpdate:modelValue":m[4]||(m[4]=x=>T.value.secretKey=x),class:"secure-input",placeholder:"è¯·è¾“å…¥Secret Key",autocomplete:"off"},null,8,gr),[[kt,T.value.secretKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:m[5]||(m[5]=x=>I.value=!I.value)},[I.value?(R(),E("span",mr,"ğŸ‘â€ğŸ—¨")):(R(),E("span",pr,"ğŸ‘"))])])])]),e("div",vr,[e("div",fr,[m[22]||(m[22]=e("label",{for:"settingsBaiduVersion"},"è¯†åˆ«ç‰ˆæœ¬:",-1)),ye(Ne,{modelValue:T.value.version,"onUpdate:modelValue":m[6]||(m[6]=x=>T.value.version=x),options:n},null,8,["modelValue"])]),e("div",br,[m[23]||(m[23]=e("label",{for:"settingsBaiduSourceLanguage"},"æºè¯­è¨€:",-1)),ye(Ne,{modelValue:T.value.sourceLanguage,"onUpdate:modelValue":m[7]||(m[7]=x=>T.value.sourceLanguage=x),options:o},null,8,["modelValue"])])]),e("button",{class:"settings-test-btn",onClick:ie,disabled:w.value},oe(w.value?"æµ‹è¯•ä¸­...":"ğŸ”— æµ‹è¯•è¿æ¥"),9,hr)],512),[[Fe,D.value.ocrEngine==="baidu_ocr"]]),ne(e("div",yr,[m[34]||(m[34]=e("div",{class:"settings-group-title"},"AIè§†è§‰OCR è®¾ç½®",-1)),e("div",xr,[e("div",_r,[m[25]||(m[25]=e("label",{for:"settingsAiVisionProvider"},"æœåŠ¡å•†:",-1)),ye(Ne,{"model-value":D.value.aiVisionOcr.provider,options:l,onChange:m[8]||(m[8]=x=>k(x))},null,8,["model-value"])]),e("div",kr,[m[26]||(m[26]=e("label",{for:"settingsAiVisionApiKey"},"API Key:",-1)),e("div",Cr,[ne(e("input",{type:A.value?"text":"password",id:"settingsAiVisionApiKey","onUpdate:modelValue":m[9]||(m[9]=x=>S.value.apiKey=x),class:"secure-input",placeholder:"è¯·è¾“å…¥API Key",autocomplete:"off"},null,8,Sr),[[kt,S.value.apiKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:m[10]||(m[10]=x=>A.value=!A.value)},[A.value?(R(),E("span",$r,"ğŸ‘â€ğŸ—¨")):(R(),E("span",wr,"ğŸ‘"))])])])]),ne(e("div",Tr,[m[27]||(m[27]=e("label",{for:"settingsCustomAiVisionBaseUrl"},"Base URL:",-1)),ne(e("input",{type:"text",id:"settingsCustomAiVisionBaseUrl","onUpdate:modelValue":m[11]||(m[11]=x=>S.value.customBaseUrl=x),placeholder:"ä¾‹å¦‚: https://api.example.com/v1"},null,512),[[Se,S.value.customBaseUrl]])],512),[[Fe,D.value.aiVisionOcr.provider==="custom_openai_vision"]]),e("div",Ir,[m[29]||(m[29]=e("label",{for:"settingsAiVisionModelName"},"æ¨¡å‹åç§°:",-1)),e("div",Rr,[ne(e("input",{type:"text",id:"settingsAiVisionModelName","onUpdate:modelValue":m[12]||(m[12]=x=>S.value.modelName=x),placeholder:"å¦‚: silicon-llava2-34b"},null,512),[[Se,S.value.modelName]]),e("button",{type:"button",class:"fetch-models-btn",title:"è·å–å¯ç”¨æ¨¡å‹åˆ—è¡¨",onClick:ae,disabled:N.value},[m[28]||(m[28]=e("span",{class:"fetch-icon"},"ğŸ”",-1)),e("span",Dr,oe(N.value?"è·å–ä¸­...":"è·å–æ¨¡å‹"),1)],8,Pr)]),W.value.length>0?(R(),E("div",Mr,[ye(Ne,{modelValue:S.value.modelName,"onUpdate:modelValue":m[13]||(m[13]=x=>S.value.modelName=x),options:U.value},null,8,["modelValue","options"]),e("span",Er,"å…± "+oe(W.value.length)+" ä¸ªæ¨¡å‹",1)])):ge("",!0)]),e("div",Br,[m[31]||(m[31]=e("label",{for:"settingsAiVisionOcrPrompt"},"OCRæç¤ºè¯:",-1)),ne(e("textarea",{id:"settingsAiVisionOcrPrompt","onUpdate:modelValue":m[14]||(m[14]=x=>S.value.prompt=x),rows:"3",placeholder:"AIè§†è§‰OCRæç¤ºè¯"},null,512),[[Se,S.value.prompt]]),ye(Pt,{"prompt-type":"ai_vision_ocr",onSelect:Q}),e("div",Ar,[ye(Ne,{"model-value":D.value.aiVisionOcr.isJsonMode?"true":"false",options:i,onChange:m[15]||(m[15]=x=>{D.value.aiVisionOcr.isJsonMode=x==="true",Y()})},null,8,["model-value"]),m[30]||(m[30]=e("span",{class:"input-hint"},"JSONæ ¼å¼è¾“å‡ºæ›´ç»“æ„åŒ–",-1))])]),e("div",Lr,[m[32]||(m[32]=e("label",{for:"settingsRpmAiVisionOcr"},"RPMé™åˆ¶ (æ¯åˆ†é’Ÿè¯·æ±‚æ•°):",-1)),ne(e("input",{type:"number",id:"settingsRpmAiVisionOcr","onUpdate:modelValue":m[16]||(m[16]=x=>S.value.rpmLimit=x),min:"0",step:"1"},null,512),[[Se,S.value.rpmLimit,void 0,{number:!0}]]),m[33]||(m[33]=e("div",{class:"input-hint"},"0 è¡¨ç¤ºæ— é™åˆ¶",-1))]),e("button",{class:"settings-test-btn",onClick:X,disabled:w.value},oe(w.value?"æµ‹è¯•ä¸­...":"ğŸ”— æµ‹è¯•è¿æ¥"),9,Fr)],512),[[Fe,D.value.ocrEngine==="ai_vision"]])]))}}),Or=je(Ur,[["__scopeId","data-v-49a9cd9f"]]),zr={class:"translation-settings"},Nr={class:"settings-group"},Vr={class:"settings-row"},Wr={class:"settings-item"},Kr={class:"settings-item"},qr={for:"settingsApiKey"},Hr={class:"password-input-wrapper"},jr=["type","placeholder"],Jr={key:0,class:"eye-icon"},Gr={key:1,class:"eye-off-icon"},Yr={class:"settings-item"},Xr={class:"settings-item"},Zr={for:"settingsModelName"},Qr={class:"model-input-with-fetch"},eu=["placeholder"],tu=["disabled"],ou={class:"fetch-text"},nu={key:0,class:"model-select-container"},su={class:"model-count"},au={class:"settings-item"},lu={class:"local-model-list"},iu={key:0,class:"model-list-container"},ru=["disabled"],uu={key:1,class:"model-hint"},cu={key:1,class:"model-list-container"},du=["disabled"],gu={key:1,class:"model-hint"},pu={class:"settings-row"},mu={class:"settings-item"},vu={class:"settings-item"},fu={class:"settings-item"},bu=["disabled"],hu={class:"settings-item"},yu=["disabled"],xu={class:"settings-group"},_u={class:"settings-item"},ku={class:"prompt-format-selector"},Cu={class:"settings-item"},Su={class:"checkbox-label"},wu={class:"settings-item"},$u=Je({__name:"TranslationSettings",setup(s){const t=[{label:"SiliconFlow",value:"siliconflow"},{label:"DeepSeek",value:"deepseek"},{label:"ç«å±±å¼•æ“",value:"volcano"},{label:"å½©äº‘å°è¯‘",value:"caiyun"},{label:"ç™¾åº¦ç¿»è¯‘",value:"baidu_translate"},{label:"æœ‰é“ç¿»è¯‘",value:"youdao_translate"},{label:"Google Gemini",value:"gemini"},{label:"Ollama (æœ¬åœ°)",value:"ollama"},{label:"Sakura (æœ¬åœ°)",value:"sakura"},{label:"è‡ªå®šä¹‰ OpenAI å…¼å®¹æœåŠ¡",value:"custom_openai"}],n=[{label:"æ™®é€šæç¤ºè¯",value:"normal"},{label:"JSONæç¤ºè¯",value:"json"}],o=Ue(),l=rt(),i=_({modelProvider:o.settings.translation.provider,apiKey:o.settings.translation.apiKey,modelName:o.settings.translation.modelName,customBaseUrl:o.settings.translation.customBaseUrl,rpmTranslation:o.settings.translation.rpmLimit,translationMaxRetries:o.settings.translation.maxRetries,promptContent:o.settings.translatePrompt,translatePromptMode:o.settings.translation.isJsonMode?"json":"normal",enableTextboxPrompt:o.settings.useTextboxPrompt,textboxPromptContent:o.settings.textboxPrompt}),a=_(!1),r=_(!1),h=_(!1),T=_([]),S=_([]),D=_([]),B=q(()=>{const u=[{label:"-- é€‰æ‹©æ¨¡å‹ --",value:""}];return T.value.forEach(c=>u.push({label:c,value:c})),u}),I=q(()=>{const u=[{label:"-- é€‰æ‹©æ¨¡å‹ --",value:""}];return S.value.forEach(c=>u.push({label:c,value:c})),u}),A=q(()=>{const u=[{label:"-- é€‰æ‹©æ¨¡å‹ --",value:""}];return D.value.forEach(c=>u.push({label:c,value:c})),u}),w=q(()=>["ollama","sakura"].includes(i.value.modelProvider)),N=q(()=>!["ollama","sakura","caiyun","baidu_translate","youdao_translate"].includes(i.value.modelProvider)),W=q(()=>["siliconflow","deepseek","volcano","gemini","custom_openai"].includes(i.value.modelProvider)),U=q(()=>{switch(i.value.modelProvider){case"baidu_translate":return"App ID";case"youdao_translate":return"App Key";case"caiyun":return"API Token";default:return"API Key"}}),f=q(()=>{switch(i.value.modelProvider){case"baidu_translate":return"è¯·è¾“å…¥ç™¾åº¦ç¿»è¯‘App ID";case"youdao_translate":return"è¯·è¾“å…¥æœ‰é“ç¿»è¯‘åº”ç”¨ID";case"caiyun":return"è¯·è¾“å…¥å½©äº‘å°è¯‘Token";default:return"è¯·è¾“å…¥API Key"}}),g=q(()=>{switch(i.value.modelProvider){case"baidu_translate":return"App Key";case"youdao_translate":return"App Secret";case"caiyun":return"æºè¯­è¨€ (å¯é€‰)";default:return"æ¨¡å‹åç§°"}}),C=q(()=>{switch(i.value.modelProvider){case"baidu_translate":return"è¯·è¾“å…¥ç™¾åº¦ç¿»è¯‘App Key";case"youdao_translate":return"è¯·è¾“å…¥æœ‰é“ç¿»è¯‘åº”ç”¨å¯†é’¥";case"caiyun":return"å¯é€‰: auto/æ—¥è¯­/è‹±è¯­";default:return"è¯·è¾“å…¥æ¨¡å‹åç§°"}});function k(){const u=i.value.modelProvider;o.setTranslationProvider(u),i.value.apiKey=o.settings.translation.apiKey,i.value.modelName=o.settings.translation.modelName,i.value.customBaseUrl=o.settings.translation.customBaseUrl,i.value.rpmTranslation=o.settings.translation.rpmLimit,i.value.translationMaxRetries=o.settings.translation.maxRetries,T.value=[]}function V(){const u=i.value.translatePromptMode==="json";u?i.value.promptContent=Eo:i.value.promptContent=Bo,o.updateTranslationService({isJsonMode:u}),o.setTranslatePrompt(i.value.promptContent)}xe(()=>i.value.apiKey,u=>{o.updateTranslationService({apiKey:u})}),xe(()=>i.value.modelName,u=>{o.updateTranslationService({modelName:u})}),xe(()=>i.value.customBaseUrl,u=>{o.updateTranslationService({customBaseUrl:u})}),xe(()=>i.value.rpmTranslation,u=>{o.updateTranslationService({rpmLimit:u})}),xe(()=>i.value.translationMaxRetries,u=>{o.updateTranslationService({maxRetries:u})}),xe(()=>i.value.promptContent,u=>{o.setTranslatePrompt(u)}),xe(()=>i.value.enableTextboxPrompt,u=>{o.setUseTextboxPrompt(u)}),xe(()=>i.value.textboxPromptContent,u=>{o.setTextboxPrompt(u)});async function Y(){const u=i.value.modelProvider,c=i.value.apiKey?.trim(),M=i.value.customBaseUrl?.trim();if(!c){l.warning("è¯·å…ˆå¡«å†™ API Key");return}if(!["siliconflow","deepseek","volcano","gemini","custom_openai"].includes(u)){l.warning(`${ie(u)} ä¸æ”¯æŒè‡ªåŠ¨è·å–æ¨¡å‹åˆ—è¡¨`);return}if(u==="custom_openai"&&!M){l.warning("è‡ªå®šä¹‰æœåŠ¡éœ€è¦å…ˆå¡«å†™ Base URL");return}h.value=!0;try{const $=await We.fetchModels(u,c,M);$.success&&$.models&&$.models.length>0?(T.value=$.models.map(O=>O.id),l.success(`è·å–åˆ° ${$.models.length} ä¸ªæ¨¡å‹`)):l.warning($.message||"æœªè·å–åˆ°å¯ç”¨æ¨¡å‹")}catch($){const O=$ instanceof Error?$.message:"è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥";l.error(O)}finally{h.value=!1}}function ie(u){return{siliconflow:"SiliconFlow",deepseek:"DeepSeek",volcano:"ç«å±±å¼•æ“",gemini:"Google Gemini",custom_openai:"è‡ªå®šä¹‰OpenAI",ollama:"Ollama",sakura:"Sakura",caiyun:"å½©äº‘å°è¯‘",baidu_translate:"ç™¾åº¦ç¿»è¯‘",youdao_translate:"æœ‰é“ç¿»è¯‘"}[u]||u}async function X(){h.value=!0;try{const u=await We.testOllamaConnection();u.success&&u.models?(S.value=u.models,l.success(`è·å–åˆ° ${u.models.length} ä¸ªOllamaæ¨¡å‹`)):l.error(u.error||"Ollamaè¿æ¥å¤±è´¥")}catch(u){const c=u instanceof Error?u.message:"è·å–Ollamaæ¨¡å‹å¤±è´¥";l.error(c)}finally{h.value=!1}}async function ae(){h.value=!0;try{const u=await We.testSakuraConnection();u.success&&u.models?(D.value=u.models,l.success(`è·å–åˆ° ${u.models.length} ä¸ªSakuraæ¨¡å‹`)):l.error(u.error||"Sakuraè¿æ¥å¤±è´¥")}catch(u){const c=u instanceof Error?u.message:"è·å–Sakuraæ¨¡å‹å¤±è´¥";l.error(c)}finally{h.value=!1}}async function Q(){r.value=!0;try{let u;i.value.modelProvider==="ollama"?u=await We.testOllamaConnection():u=await We.testSakuraConnection(),u.success?l.success(`${i.value.modelProvider==="ollama"?"Ollama":"Sakura"} è¿æ¥æˆåŠŸ`):l.error(u.error||"è¿æ¥å¤±è´¥")}catch(u){const c=u instanceof Error?u.message:"è¿æ¥æµ‹è¯•å¤±è´¥";l.error(c)}finally{r.value=!1}}async function p(){const u=i.value.modelProvider,c=i.value.apiKey?.trim(),M=i.value.modelName?.trim(),H=i.value.customBaseUrl?.trim();if(!c){l.warning("è¯·å…ˆå¡«å†™ API Key");return}if(u!=="caiyun"&&!M){l.warning("è¯·å¡«å†™æ¨¡å‹åç§°");return}if(u==="custom_openai"&&!H){l.warning("è‡ªå®šä¹‰æœåŠ¡éœ€è¦å¡«å†™ Base URL");return}r.value=!0,l.info("æ­£åœ¨æµ‹è¯•è¿æ¥...");try{let $;switch(u){case"baidu_translate":$=await We.testBaiduTranslateConnection(c,M);break;case"youdao_translate":$=await We.testYoudaoTranslateConnection(c,M);break;default:$=await We.testAiTranslateConnection({provider:u,apiKey:c,modelName:M,baseUrl:H})}$.success?l.success($.message||`${ie(u)} è¿æ¥æˆåŠŸ!`):l.error($.message||$.error||"è¿æ¥å¤±è´¥")}catch($){const O=$ instanceof Error?$.message:"è¿æ¥æµ‹è¯•å¤±è´¥";l.error(O)}finally{r.value=!1}}function m(u,c){i.value.promptContent=u,l.success(`å·²åº”ç”¨æç¤ºè¯: ${c}`)}function x(u,c){i.value.textboxPromptContent=u,l.success(`å·²åº”ç”¨æç¤ºè¯: ${c}`)}function b(){i.value.translatePromptMode==="json"?i.value.promptContent=Eo:i.value.promptContent=Bo,l.success("å·²é‡ç½®ä¸ºé»˜è®¤æç¤ºè¯")}return(u,c)=>(R(),E("div",zr,[e("div",Nr,[c[21]||(c[21]=e("div",{class:"settings-group-title"},"ç¿»è¯‘æœåŠ¡é…ç½®",-1)),e("div",Vr,[e("div",Wr,[c[14]||(c[14]=e("label",{for:"settingsModelProvider"},"ç¿»è¯‘æœåŠ¡å•†:",-1)),ye(Ne,{"model-value":i.value.modelProvider,options:t,onChange:c[0]||(c[0]=M=>{i.value.modelProvider=M,k()})},null,8,["model-value"])]),ne(e("div",Kr,[e("label",qr,oe(U.value)+":",1),e("div",Hr,[ne(e("input",{type:a.value?"text":"password",id:"settingsApiKey","onUpdate:modelValue":c[1]||(c[1]=M=>i.value.apiKey=M),class:"secure-input",placeholder:f.value,autocomplete:"off"},null,8,jr),[[kt,i.value.apiKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:c[2]||(c[2]=M=>a.value=!a.value)},[a.value?(R(),E("span",Gr,"ğŸ‘â€ğŸ—¨")):(R(),E("span",Jr,"ğŸ‘"))])])],512),[[Fe,!w.value]])]),ne(e("div",Yr,[c[15]||(c[15]=e("label",{for:"settingsCustomBaseUrl"},"Base URL:",-1)),ne(e("input",{type:"text",id:"settingsCustomBaseUrl","onUpdate:modelValue":c[3]||(c[3]=M=>i.value.customBaseUrl=M),placeholder:"ä¾‹å¦‚: https://api.example.com/v1"},null,512),[[Se,i.value.customBaseUrl]])],512),[[Fe,i.value.modelProvider==="custom_openai"]]),ne(e("div",Xr,[e("label",Zr,oe(g.value)+":",1),e("div",Qr,[ne(e("input",{type:"text",id:"settingsModelName","onUpdate:modelValue":c[4]||(c[4]=M=>i.value.modelName=M),placeholder:C.value},null,8,eu),[[Se,i.value.modelName]]),ne(e("button",{type:"button",class:"fetch-models-btn",title:"è·å–å¯ç”¨æ¨¡å‹åˆ—è¡¨",onClick:Y,disabled:h.value},[c[16]||(c[16]=e("span",{class:"fetch-icon"},"ğŸ”",-1)),e("span",ou,oe(h.value?"è·å–ä¸­...":"è·å–æ¨¡å‹"),1)],8,tu),[[Fe,W.value]])]),T.value.length>0?(R(),E("div",nu,[ye(Ne,{"model-value":i.value.modelName,options:B.value,onChange:c[5]||(c[5]=M=>{i.value.modelName=M})},null,8,["model-value","options"]),e("span",su,"å…± "+oe(T.value.length)+" ä¸ªæ¨¡å‹",1)])):ge("",!0)],512),[[Fe,!w.value]]),ne(e("div",au,[c[17]||(c[17]=e("label",null,"æœ¬åœ°æ¨¡å‹:",-1)),e("div",lu,[i.value.modelProvider==="ollama"?(R(),E("div",iu,[e("button",{class:"settings-test-btn",onClick:X,disabled:h.value},oe(h.value?"è·å–ä¸­...":"ğŸ”„ åˆ·æ–°æ¨¡å‹åˆ—è¡¨"),9,ru),S.value.length>0?(R(),st(Ne,{key:0,"model-value":i.value.modelName,options:I.value,onChange:c[6]||(c[6]=M=>i.value.modelName=M)},null,8,["model-value","options"])):(R(),E("p",uu,"ç‚¹å‡»åˆ·æ–°è·å–å¯ç”¨æ¨¡å‹"))])):i.value.modelProvider==="sakura"?(R(),E("div",cu,[e("button",{class:"settings-test-btn",onClick:ae,disabled:h.value},oe(h.value?"è·å–ä¸­...":"ğŸ”„ åˆ·æ–°æ¨¡å‹åˆ—è¡¨"),9,du),D.value.length>0?(R(),st(Ne,{key:0,"model-value":i.value.modelName,options:A.value,onChange:c[7]||(c[7]=M=>i.value.modelName=M)},null,8,["model-value","options"])):(R(),E("p",gu,"ç‚¹å‡»åˆ·æ–°è·å–å¯ç”¨æ¨¡å‹"))])):ge("",!0)])],512),[[Fe,w.value]]),ne(e("div",pu,[e("div",mu,[c[18]||(c[18]=e("label",{for:"settingsRpmTranslation"},"RPMé™åˆ¶:",-1)),ne(e("input",{type:"number",id:"settingsRpmTranslation","onUpdate:modelValue":c[8]||(c[8]=M=>i.value.rpmTranslation=M),min:"0",step:"1"},null,512),[[Se,i.value.rpmTranslation,void 0,{number:!0}]]),c[19]||(c[19]=e("div",{class:"input-hint"},"æ¯åˆ†é’Ÿè¯·æ±‚æ•°ï¼Œ0è¡¨ç¤ºæ— é™åˆ¶",-1))]),e("div",vu,[c[20]||(c[20]=e("label",{for:"settingsTranslationMaxRetries"},"é‡è¯•æ¬¡æ•°:",-1)),ne(e("input",{type:"number",id:"settingsTranslationMaxRetries","onUpdate:modelValue":c[9]||(c[9]=M=>i.value.translationMaxRetries=M),min:"0",max:"10",step:"1"},null,512),[[Se,i.value.translationMaxRetries,void 0,{number:!0}]])])],512),[[Fe,N.value]]),ne(e("div",fu,[e("button",{class:"settings-test-btn",onClick:Q,disabled:r.value},oe(r.value?"æµ‹è¯•ä¸­...":"ğŸ”— æµ‹è¯•è¿æ¥"),9,bu)],512),[[Fe,w.value]]),ne(e("div",hu,[e("button",{class:"settings-test-btn",onClick:p,disabled:r.value},oe(r.value?"æµ‹è¯•ä¸­...":"ğŸ”— æµ‹è¯•è¿æ¥"),9,yu)],512),[[Fe,!w.value]])]),e("div",xu,[c[26]||(c[26]=e("div",{class:"settings-group-title"},"æç¤ºè¯è®¾ç½®",-1)),e("div",_u,[c[23]||(c[23]=e("label",{for:"settingsPromptContent"},"ç¿»è¯‘æç¤ºè¯:",-1)),ne(e("textarea",{id:"settingsPromptContent","onUpdate:modelValue":c[10]||(c[10]=M=>i.value.promptContent=M),rows:"4",placeholder:"ç¿»è¯‘æç¤ºè¯"},null,512),[[Se,i.value.promptContent]]),e("div",ku,[ye(Ne,{"model-value":i.value.translatePromptMode,options:n,onChange:c[11]||(c[11]=M=>{i.value.translatePromptMode=M,V()})},null,8,["model-value"]),c[22]||(c[22]=e("span",{class:"input-hint"},"JSONæ ¼å¼è¾“å‡ºæ›´ç»“æ„åŒ–",-1))]),ye(Pt,{"prompt-type":"translate",onSelect:m}),e("button",{type:"button",class:"reset-btn",onClick:b}," é‡ç½®ä¸ºé»˜è®¤ ")]),e("div",Cu,[e("label",Su,[ne(e("input",{type:"checkbox","onUpdate:modelValue":c[12]||(c[12]=M=>i.value.enableTextboxPrompt=M)},null,512),[[et,i.value.enableTextboxPrompt]]),c[24]||(c[24]=Ce(" å¯ç”¨æ–‡æœ¬æ¡†æç¤ºè¯ ",-1))])]),ne(e("div",wu,[c[25]||(c[25]=e("label",{for:"settingsTextboxPromptContent"},"æ–‡æœ¬æ¡†æç¤ºè¯:",-1)),ne(e("textarea",{id:"settingsTextboxPromptContent","onUpdate:modelValue":c[13]||(c[13]=M=>i.value.textboxPromptContent=M),rows:"3",placeholder:"æ–‡æœ¬æ¡†æç¤ºè¯"},null,512),[[Se,i.value.textboxPromptContent]]),ye(Pt,{"prompt-type":"textbox",onSelect:x})],512),[[Fe,i.value.enableTextboxPrompt]])])]))}}),Tu=je($u,[["__scopeId","data-v-1eaa2d97"]]),Iu={class:"detection-settings"},Ru={class:"settings-group"},Pu={class:"settings-item"},Du={class:"settings-group"},Mu={class:"settings-item"},Eu={class:"settings-row"},Bu={class:"settings-item"},Au={class:"settings-item"},Lu={class:"settings-row"},Fu={class:"settings-item"},Uu={class:"settings-item"},Ou={class:"settings-group"},zu={class:"settings-item"},Nu={class:"checkbox-label"},Vu={class:"settings-row"},Wu={class:"settings-item"},Ku={class:"settings-item"},qu={class:"settings-group"},Hu={class:"settings-item"},ju={class:"checkbox-label"},Ju=Je({__name:"DetectionSettings",setup(s){const t=[{label:"CTD (Comic Text Detector)",value:"ctd"},{label:"YOLO",value:"yolo"},{label:"YOLOv5",value:"yolov5"},{label:"Default (DBNet)",value:"default"}],n=Ue(),o=io({textDetector:n.settings.textDetector,boxExpandRatio:n.settings.boxExpand.ratio,boxExpandTop:n.settings.boxExpand.top,boxExpandBottom:n.settings.boxExpand.bottom,boxExpandLeft:n.settings.boxExpand.left,boxExpandRight:n.settings.boxExpand.right,usePreciseMask:n.settings.preciseMask.enabled,maskDilateSize:n.settings.preciseMask.dilateSize,maskBoxExpandRatio:n.settings.preciseMask.boxExpandRatio,showDetectionDebug:n.settings.showDetectionDebug}),l=q(()=>["ctd","default"].includes(o.textDetector));xe(()=>o.textDetector,a=>{n.setTextDetector(a)}),xe(()=>o.boxExpandRatio,a=>{n.updateBoxExpand({ratio:a})}),xe(()=>o.boxExpandTop,a=>{n.updateBoxExpand({top:a})}),xe(()=>o.boxExpandBottom,a=>{n.updateBoxExpand({bottom:a})}),xe(()=>o.boxExpandLeft,a=>{n.updateBoxExpand({left:a})}),xe(()=>o.boxExpandRight,a=>{n.updateBoxExpand({right:a})}),xe(()=>o.usePreciseMask,a=>{n.updatePreciseMask({enabled:a})}),xe(()=>o.maskDilateSize,a=>{n.updatePreciseMask({dilateSize:a})}),xe(()=>o.maskBoxExpandRatio,a=>{n.updatePreciseMask({boxExpandRatio:a})}),xe(()=>o.showDetectionDebug,a=>{n.setShowDetectionDebug(a)});function i(){l.value||(o.usePreciseMask=!1)}return(a,r)=>(R(),E("div",Iu,[e("div",Ru,[r[11]||(r[11]=e("div",{class:"settings-group-title"},"æ–‡å­—æ£€æµ‹å™¨",-1)),e("div",Pu,[r[10]||(r[10]=e("label",{for:"settingsTextDetector"},"æ£€æµ‹å™¨ç±»å‹:",-1)),ye(Ne,{modelValue:o.textDetector,"onUpdate:modelValue":r[0]||(r[0]=h=>o.textDetector=h),options:t,onChange:i},null,8,["modelValue"])])]),e("div",Du,[r[18]||(r[18]=e("div",{class:"settings-group-title"},"æ–‡æœ¬æ¡†æ‰©å±•å‚æ•°",-1)),e("div",Mu,[r[12]||(r[12]=e("label",{for:"settingsBoxExpandRatio"},"æ•´ä½“æ‰©å±• (%):",-1)),ne(e("input",{type:"number",id:"settingsBoxExpandRatio","onUpdate:modelValue":r[1]||(r[1]=h=>o.boxExpandRatio=h),min:"0",max:"50",step:"1"},null,512),[[Se,o.boxExpandRatio,void 0,{number:!0}]]),r[13]||(r[13]=e("div",{class:"input-hint"},"å‘å››å‘¨å‡åŒ€æ‰©å±•çš„ç™¾åˆ†æ¯” (0-50%)",-1))]),e("div",Eu,[e("div",Bu,[r[14]||(r[14]=e("label",{for:"settingsBoxExpandTop"},"ä¸Šæ–¹æ‰©å±• (%):",-1)),ne(e("input",{type:"number",id:"settingsBoxExpandTop","onUpdate:modelValue":r[2]||(r[2]=h=>o.boxExpandTop=h),min:"0",max:"50",step:"1"},null,512),[[Se,o.boxExpandTop,void 0,{number:!0}]])]),e("div",Au,[r[15]||(r[15]=e("label",{for:"settingsBoxExpandBottom"},"ä¸‹æ–¹æ‰©å±• (%):",-1)),ne(e("input",{type:"number",id:"settingsBoxExpandBottom","onUpdate:modelValue":r[3]||(r[3]=h=>o.boxExpandBottom=h),min:"0",max:"50",step:"1"},null,512),[[Se,o.boxExpandBottom,void 0,{number:!0}]])])]),e("div",Lu,[e("div",Fu,[r[16]||(r[16]=e("label",{for:"settingsBoxExpandLeft"},"å·¦ä¾§æ‰©å±• (%):",-1)),ne(e("input",{type:"number",id:"settingsBoxExpandLeft","onUpdate:modelValue":r[4]||(r[4]=h=>o.boxExpandLeft=h),min:"0",max:"50",step:"1"},null,512),[[Se,o.boxExpandLeft,void 0,{number:!0}]])]),e("div",Uu,[r[17]||(r[17]=e("label",{for:"settingsBoxExpandRight"},"å³ä¾§æ‰©å±• (%):",-1)),ne(e("input",{type:"number",id:"settingsBoxExpandRight","onUpdate:modelValue":r[5]||(r[5]=h=>o.boxExpandRight=h),min:"0",max:"50",step:"1"},null,512),[[Se,o.boxExpandRight,void 0,{number:!0}]])])])]),ne(e("div",Ou,[r[25]||(r[25]=e("div",{class:"settings-group-title"},"ç²¾ç¡®æ–‡å­—æ©è†œ",-1)),e("div",zu,[e("label",Nu,[ne(e("input",{type:"checkbox","onUpdate:modelValue":r[6]||(r[6]=h=>o.usePreciseMask=h)},null,512),[[et,o.usePreciseMask]]),r[19]||(r[19]=Ce(" å¯ç”¨ç²¾ç¡®æ–‡å­—æ©è†œ ",-1))]),r[20]||(r[20]=e("div",{class:"input-hint"},"ä½¿ç”¨æ›´ç²¾ç¡®çš„æ–‡å­—åŒºåŸŸæ©è†œè¿›è¡Œä¿®å¤",-1))]),ne(e("div",Vu,[e("div",Wu,[r[21]||(r[21]=e("label",{for:"settingsMaskDilateSize"},"è†¨èƒ€å¤§å°:",-1)),ne(e("input",{type:"number",id:"settingsMaskDilateSize","onUpdate:modelValue":r[7]||(r[7]=h=>o.maskDilateSize=h),min:"0",step:"1"},null,512),[[Se,o.maskDilateSize,void 0,{number:!0}]]),r[22]||(r[22]=e("div",{class:"input-hint"},"æ©è†œè†¨èƒ€åƒç´ æ•°",-1))]),e("div",Ku,[r[23]||(r[23]=e("label",{for:"settingsMaskBoxExpandRatio"},"æ ‡æ³¨æ¡†æ‰©å¤§æ¯”ä¾‹ (%):",-1)),ne(e("input",{type:"number",id:"settingsMaskBoxExpandRatio","onUpdate:modelValue":r[8]||(r[8]=h=>o.maskBoxExpandRatio=h),min:"0",max:"100",step:"1"},null,512),[[Se,o.maskBoxExpandRatio,void 0,{number:!0}]]),r[24]||(r[24]=e("div",{class:"input-hint"},"æ ‡æ³¨æ¡†åŒºåŸŸæ‰©å¤§ç™¾åˆ†æ¯”",-1))])],512),[[Fe,o.usePreciseMask]])],512),[[Fe,l.value]]),e("div",qu,[r[28]||(r[28]=e("div",{class:"settings-group-title"},"è°ƒè¯•é€‰é¡¹",-1)),e("div",Hu,[e("label",ju,[ne(e("input",{type:"checkbox","onUpdate:modelValue":r[9]||(r[9]=h=>o.showDetectionDebug=h)},null,512),[[et,o.showDetectionDebug]]),r[26]||(r[26]=Ce(" æ˜¾ç¤ºæ£€æµ‹æ¡†è°ƒè¯•ä¿¡æ¯ ",-1))]),r[27]||(r[27]=e("div",{class:"input-hint"},"åœ¨ç¿»è¯‘ç»“æœä¸­æ˜¾ç¤ºæ°”æ³¡æ£€æµ‹æ¡†ï¼Œç”¨äºè°ƒè¯•",-1))])])]))}}),Gu=je(Ju,[["__scopeId","data-v-c12c43ee"]]),Yu={class:"hq-translation-settings"},Xu={class:"settings-group"},Zu={class:"settings-row"},Qu={class:"settings-item"},ec={class:"settings-item"},tc={class:"password-input-wrapper"},oc=["type"],nc={key:0,class:"eye-icon"},sc={key:1,class:"eye-off-icon"},ac={class:"settings-item"},lc={class:"settings-item"},ic={class:"model-input-with-fetch"},rc=["disabled"],uc={class:"fetch-text"},cc={key:0,class:"model-select-container"},dc={class:"model-count"},gc={class:"settings-item"},pc=["disabled"],mc={class:"settings-group"},vc={class:"settings-row"},fc={class:"settings-item"},bc={class:"settings-item"},hc={class:"settings-row"},yc={class:"settings-item"},xc={class:"settings-item"},_c={class:"settings-group"},kc={class:"settings-row"},Cc={class:"settings-item"},Sc={class:"checkbox-label"},wc={class:"settings-item"},$c={class:"settings-row"},Tc={class:"settings-item"},Ic={class:"checkbox-label"},Rc={class:"settings-item"},Pc={class:"checkbox-label"},Dc={class:"settings-group"},Mc={class:"settings-item"},Ec=Je({__name:"HqTranslationSettings",setup(s){const t=[{label:"SiliconFlow",value:"siliconflow"},{label:"DeepSeek",value:"deepseek"},{label:"ç«å±±å¼•æ“",value:"volcano"},{label:"Google Gemini",value:"gemini"},{label:"è‡ªå®šä¹‰ OpenAI å…¼å®¹æœåŠ¡",value:"custom_openai"}],n=[{label:"Geminié£æ ¼ (reasoning_effort=low)",value:"gemini"},{label:"ç«å±±å¼•æ“é£æ ¼ (thinking=null)",value:"volcano"}],o=Ue(),l=rt(),i=q(()=>o.settings.hqTranslation),a=_({apiKey:o.settings.hqTranslation.apiKey,modelName:o.settings.hqTranslation.modelName,customBaseUrl:o.settings.hqTranslation.customBaseUrl,batchSize:o.settings.hqTranslation.batchSize,sessionReset:o.settings.hqTranslation.sessionReset,rpmLimit:o.settings.hqTranslation.rpmLimit,maxRetries:o.settings.hqTranslation.maxRetries,lowReasoning:o.settings.hqTranslation.lowReasoning,noThinkingMethod:o.settings.hqTranslation.noThinkingMethod,forceJsonOutput:o.settings.hqTranslation.forceJsonOutput,useStream:o.settings.hqTranslation.useStream,prompt:o.settings.hqTranslation.prompt});xe(()=>a.value.apiKey,f=>{o.updateHqTranslation({apiKey:f})}),xe(()=>a.value.modelName,f=>{o.updateHqTranslation({modelName:f})}),xe(()=>a.value.customBaseUrl,f=>{o.updateHqTranslation({customBaseUrl:f})}),xe(()=>a.value.batchSize,f=>{o.updateHqTranslation({batchSize:f})}),xe(()=>a.value.sessionReset,f=>{o.updateHqTranslation({sessionReset:f})}),xe(()=>a.value.rpmLimit,f=>{o.updateHqTranslation({rpmLimit:f})}),xe(()=>a.value.maxRetries,f=>{o.updateHqTranslation({maxRetries:f})}),xe(()=>a.value.lowReasoning,f=>{o.updateHqTranslation({lowReasoning:f})}),xe(()=>a.value.noThinkingMethod,f=>{o.updateHqTranslation({noThinkingMethod:f})}),xe(()=>a.value.forceJsonOutput,f=>{o.updateHqTranslation({forceJsonOutput:f})}),xe(()=>a.value.useStream,f=>{o.updateHqTranslation({useStream:f})}),xe(()=>a.value.prompt,f=>{o.updateHqTranslation({prompt:f})});const r=_(!1),h=_(!1),T=_([]),S=_(!1),D=q(()=>{const f=[{label:"-- é€‰æ‹©æ¨¡å‹ --",value:""}];return T.value.forEach(g=>f.push({label:g,value:g})),f});function B(f){o.setHqProvider(f),T.value=[],I()}function I(){const f=o.settings.hqTranslation;a.value.apiKey=f.apiKey,a.value.modelName=f.modelName,a.value.customBaseUrl=f.customBaseUrl,a.value.batchSize=f.batchSize,a.value.sessionReset=f.sessionReset,a.value.rpmLimit=f.rpmLimit,a.value.maxRetries=f.maxRetries,a.value.lowReasoning=f.lowReasoning,a.value.noThinkingMethod=f.noThinkingMethod,a.value.forceJsonOutput=f.forceJsonOutput,a.value.useStream=f.useStream,a.value.prompt=f.prompt}function A(f){return{siliconflow:"SiliconFlow",deepseek:"DeepSeek",volcano:"ç«å±±å¼•æ“",gemini:"Google Gemini",custom_openai:"è‡ªå®šä¹‰OpenAI"}[f]||f}async function w(){const f=i.value.provider,g=a.value.apiKey?.trim(),C=a.value.customBaseUrl?.trim();if(!g){l.warning("è¯·å…ˆå¡«å†™ API Key");return}if(!["siliconflow","deepseek","volcano","gemini","custom_openai"].includes(f)){l.warning(`${A(f)} ä¸æ”¯æŒè‡ªåŠ¨è·å–æ¨¡å‹åˆ—è¡¨`);return}if(f==="custom_openai"&&!C){l.warning("è‡ªå®šä¹‰æœåŠ¡éœ€è¦å…ˆå¡«å†™ Base URL");return}h.value=!0;try{const V=await We.fetchModels(f,g,C);V.success&&V.models&&V.models.length>0?(T.value=V.models.map(Y=>Y.id),l.success(`è·å–åˆ° ${V.models.length} ä¸ªæ¨¡å‹`)):l.warning(V.message||"æœªè·å–åˆ°å¯ç”¨æ¨¡å‹")}catch(V){const Y=V instanceof Error?V.message:"è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥";l.error(Y)}finally{h.value=!1}}async function N(){const f=i.value.provider,g=a.value.apiKey?.trim(),C=a.value.modelName?.trim(),k=a.value.customBaseUrl?.trim();if(!g){l.warning("è¯·å…ˆå¡«å†™ API Key");return}if(!C){l.warning("è¯·å¡«å†™æ¨¡å‹åç§°");return}if(f==="custom_openai"&&!k){l.warning("è‡ªå®šä¹‰æœåŠ¡éœ€è¦å¡«å†™ Base URL");return}S.value=!0,l.info("æ­£åœ¨æµ‹è¯•è¿æ¥...");try{const V=await We.testAiTranslateConnection({provider:f,apiKey:g,modelName:C,baseUrl:k});V.success?l.success(V.message||`${A(f)} è¿æ¥æˆåŠŸ!`):l.error(V.message||V.error||"è¿æ¥å¤±è´¥")}catch(V){const Y=V instanceof Error?V.message:"è¿æ¥æµ‹è¯•å¤±è´¥";l.error(Y)}finally{S.value=!1}}function W(){o.updateHqTranslation({prompt:Ao}),a.value.prompt=Ao,l.success("å·²é‡ç½®ä¸ºé»˜è®¤æç¤ºè¯")}function U(f,g){o.updateHqTranslation({prompt:f}),a.value.prompt=f,l.success(`å·²åº”ç”¨æç¤ºè¯: ${g}`)}return(f,g)=>(R(),E("div",Yu,[e("div",Xu,[g[20]||(g[20]=e("div",{class:"settings-group-title"},"é«˜è´¨é‡ç¿»è¯‘æœåŠ¡é…ç½®",-1)),e("div",Zu,[e("div",Qu,[g[15]||(g[15]=e("label",{for:"settingsHqTranslateProvider"},"æœåŠ¡å•†:",-1)),ye(Ne,{"model-value":i.value.provider,options:t,onChange:g[0]||(g[0]=C=>B(C))},null,8,["model-value"])]),e("div",ec,[g[16]||(g[16]=e("label",{for:"settingsHqApiKey"},"API Key:",-1)),e("div",tc,[ne(e("input",{type:r.value?"text":"password",id:"settingsHqApiKey","onUpdate:modelValue":g[1]||(g[1]=C=>a.value.apiKey=C),class:"secure-input",placeholder:"è¯·è¾“å…¥API Key",autocomplete:"off"},null,8,oc),[[kt,a.value.apiKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:g[2]||(g[2]=C=>r.value=!r.value)},[r.value?(R(),E("span",sc,"ğŸ‘â€ğŸ—¨")):(R(),E("span",nc,"ğŸ‘"))])])])]),ne(e("div",ac,[g[17]||(g[17]=e("label",{for:"settingsHqCustomBaseUrl"},"Base URL:",-1)),ne(e("input",{type:"text",id:"settingsHqCustomBaseUrl","onUpdate:modelValue":g[3]||(g[3]=C=>a.value.customBaseUrl=C),placeholder:"ä¾‹å¦‚: https://api.example.com/v1"},null,512),[[Se,a.value.customBaseUrl]])],512),[[Fe,i.value.provider==="custom_openai"]]),e("div",lc,[g[19]||(g[19]=e("label",{for:"settingsHqModelName"},"æ¨¡å‹åç§°:",-1)),e("div",ic,[ne(e("input",{type:"text",id:"settingsHqModelName","onUpdate:modelValue":g[4]||(g[4]=C=>a.value.modelName=C),placeholder:"è¯·è¾“å…¥æ¨¡å‹åç§°"},null,512),[[Se,a.value.modelName]]),e("button",{type:"button",class:"fetch-models-btn",title:"è·å–å¯ç”¨æ¨¡å‹åˆ—è¡¨",onClick:w,disabled:h.value},[g[18]||(g[18]=e("span",{class:"fetch-icon"},"ğŸ”",-1)),e("span",uc,oe(h.value?"è·å–ä¸­...":"è·å–æ¨¡å‹"),1)],8,rc)]),T.value.length>0?(R(),E("div",cc,[ye(Ne,{modelValue:a.value.modelName,"onUpdate:modelValue":g[5]||(g[5]=C=>a.value.modelName=C),options:D.value},null,8,["modelValue","options"]),e("span",dc,"å…± "+oe(T.value.length)+" ä¸ªæ¨¡å‹",1)])):ge("",!0)]),e("div",gc,[e("button",{class:"settings-test-btn",onClick:N,disabled:S.value},oe(S.value?"æµ‹è¯•ä¸­...":"ğŸ”— æµ‹è¯•è¿æ¥"),9,pc)])]),e("div",mc,[g[28]||(g[28]=e("div",{class:"settings-group-title"},"æ‰¹å¤„ç†è®¾ç½®",-1)),e("div",vc,[e("div",fc,[g[21]||(g[21]=e("label",{for:"settingsHqBatchSize"},"æ‰¹æ¬¡å¤§å°:",-1)),ne(e("input",{type:"number",id:"settingsHqBatchSize","onUpdate:modelValue":g[6]||(g[6]=C=>a.value.batchSize=C),min:"1",max:"10",step:"1"},null,512),[[Se,a.value.batchSize,void 0,{number:!0}]]),g[22]||(g[22]=e("div",{class:"input-hint"},"æ¯æ‰¹å¤„ç†çš„å›¾ç‰‡æ•°é‡ (æ¨è3-5å¼ )",-1))]),e("div",bc,[g[23]||(g[23]=e("label",{for:"settingsHqSessionReset"},"ä¼šè¯é‡ç½®é¢‘ç‡:",-1)),ne(e("input",{type:"number",id:"settingsHqSessionReset","onUpdate:modelValue":g[7]||(g[7]=C=>a.value.sessionReset=C),min:"1",step:"1"},null,512),[[Se,a.value.sessionReset,void 0,{number:!0}]]),g[24]||(g[24]=e("div",{class:"input-hint"},"å¤šå°‘æ‰¹æ¬¡åé‡ç½®ä¸Šä¸‹æ–‡",-1))])]),e("div",hc,[e("div",yc,[g[25]||(g[25]=e("label",{for:"settingsHqRpmLimit"},"RPMé™åˆ¶:",-1)),ne(e("input",{type:"number",id:"settingsHqRpmLimit","onUpdate:modelValue":g[8]||(g[8]=C=>a.value.rpmLimit=C),min:"0",step:"1"},null,512),[[Se,a.value.rpmLimit,void 0,{number:!0}]]),g[26]||(g[26]=e("div",{class:"input-hint"},"æ¯åˆ†é’Ÿè¯·æ±‚æ•°ï¼Œ0è¡¨ç¤ºæ— é™åˆ¶",-1))]),e("div",xc,[g[27]||(g[27]=e("label",{for:"settingsHqMaxRetries"},"é‡è¯•æ¬¡æ•°:",-1)),ne(e("input",{type:"number",id:"settingsHqMaxRetries","onUpdate:modelValue":g[9]||(g[9]=C=>a.value.maxRetries=C),min:"0",max:"10",step:"1"},null,512),[[Se,a.value.maxRetries,void 0,{number:!0}]])])])]),e("div",_c,[g[36]||(g[36]=e("div",{class:"settings-group-title"},"é«˜çº§é€‰é¡¹",-1)),e("div",kc,[e("div",Cc,[e("label",Sc,[ne(e("input",{type:"checkbox","onUpdate:modelValue":g[10]||(g[10]=C=>a.value.lowReasoning=C)},null,512),[[et,a.value.lowReasoning]]),g[29]||(g[29]=Ce(" ä½æ¨ç†æ¨¡å¼ ",-1))]),g[30]||(g[30]=e("div",{class:"input-hint"},"å‡å°‘æ¨¡å‹æ¨ç†æ·±åº¦ï¼Œæé«˜é€Ÿåº¦",-1))]),e("div",wc,[g[31]||(g[31]=e("label",{for:"settingsHqNoThinkingMethod"},"å–æ¶ˆæ€è€ƒæ–¹æ³•:",-1)),ye(Ne,{modelValue:a.value.noThinkingMethod,"onUpdate:modelValue":g[11]||(g[11]=C=>a.value.noThinkingMethod=C),options:n},null,8,["modelValue"])])]),e("div",$c,[e("div",Tc,[e("label",Ic,[ne(e("input",{type:"checkbox","onUpdate:modelValue":g[12]||(g[12]=C=>a.value.forceJsonOutput=C)},null,512),[[et,a.value.forceJsonOutput]]),g[32]||(g[32]=Ce(" å¼ºåˆ¶JSONè¾“å‡º ",-1))]),g[33]||(g[33]=e("div",{class:"input-hint"},"ä½¿ç”¨ response_format: json_object",-1))]),e("div",Rc,[e("label",Pc,[ne(e("input",{type:"checkbox","onUpdate:modelValue":g[13]||(g[13]=C=>a.value.useStream=C)},null,512),[[et,a.value.useStream]]),g[34]||(g[34]=Ce(" æµå¼è°ƒç”¨ ",-1))]),g[35]||(g[35]=e("div",{class:"input-hint"},"ä½¿ç”¨æµå¼APIè°ƒç”¨",-1))])])]),e("div",Dc,[g[37]||(g[37]=e("div",{class:"settings-group-title"},"é«˜è´¨é‡ç¿»è¯‘æç¤ºè¯",-1)),e("div",Mc,[ne(e("textarea",{id:"settingsHqPrompt","onUpdate:modelValue":g[14]||(g[14]=C=>a.value.prompt=C),rows:"6",placeholder:"é«˜è´¨é‡ç¿»è¯‘æç¤ºè¯"},null,512),[[Se,a.value.prompt]]),ye(Pt,{"prompt-type":"hq_translate",onSelect:U}),e("button",{class:"btn btn-secondary btn-sm",onClick:W},"é‡ç½®ä¸ºé»˜è®¤")])])]))}}),Bc=je(Ec,[["__scopeId","data-v-23f4a3f7"]]),Ac={class:"proofreading-settings"},Lc={class:"settings-group"},Fc={class:"settings-item"},Uc={class:"checkbox-label"},Oc={class:"settings-item"},zc={class:"settings-group"},Nc={class:"round-header"},Vc={class:"round-title"},Wc=["onClick","disabled"],Kc={class:"round-content"},qc={class:"settings-item"},Hc=["onUpdate:modelValue"],jc={class:"settings-row"},Jc={class:"settings-item"},Gc={class:"settings-item"},Yc={class:"password-input-wrapper"},Xc=["type","onUpdate:modelValue"],Zc=["onClick"],Qc={key:0,class:"eye-icon"},ed={key:1,class:"eye-off-icon"},td={class:"settings-item"},od=["onUpdate:modelValue"],nd={class:"settings-item"},sd={class:"model-input-with-fetch"},ad=["onUpdate:modelValue"],ld=["onClick","disabled"],id={class:"fetch-text"},rd={key:0,class:"model-select-container"},ud={class:"model-count"},cd={class:"settings-item"},dd=["onClick","disabled"],gd={class:"settings-row"},pd={class:"settings-item"},md=["onUpdate:modelValue"],vd={class:"settings-item"},fd=["onUpdate:modelValue"],bd={class:"settings-item"},hd=["onUpdate:modelValue"],yd={class:"settings-row"},xd={class:"settings-item"},_d={class:"checkbox-label"},kd=["onUpdate:modelValue"],Cd={class:"settings-item"},Sd={class:"settings-item"},wd={class:"checkbox-label"},$d=["onUpdate:modelValue"],Td={class:"settings-item"},Id=["onUpdate:modelValue"],Rd=["onClick"],Pd=Je({__name:"ProofreadingSettings",setup(s){const t=[{label:"SiliconFlow",value:"siliconflow"},{label:"DeepSeek",value:"deepseek"},{label:"ç«å±±å¼•æ“",value:"volcano"},{label:"Google Gemini",value:"gemini"},{label:"è‡ªå®šä¹‰ OpenAI å…¼å®¹æœåŠ¡",value:"custom_openai"}],n=[{label:"Geminié£æ ¼",value:"gemini"},{label:"ç«å±±å¼•æ“é£æ ¼",value:"volcano"}],o=Ue(),l=rt(),i=_({}),a=_({}),r=_({}),h=q(()=>o.settings.proofreading.rounds),T=q({get:()=>o.settings.proofreading.maxRetries,set:U=>o.setProofreadingMaxRetries(U)}),S=q({get:()=>o.settings.proofreading.enabled,set:U=>o.setProofreadingEnabled(U)});xe(()=>o.settings.proofreading.rounds,()=>{o.saveToStorage()},{deep:!0});function D(U){const f=r.value[U]||[],g=[{label:"-- é€‰æ‹©æ¨¡å‹ --",value:""}];return f.forEach(C=>g.push({label:C,value:C})),g}async function B(U){const f=h.value[U];if(!f)return;const g=f.provider,C=f.apiKey?.trim(),k=f.customBaseUrl?.trim();if(!C){l.warning("è¯·å…ˆå¡«å†™ API Key");return}if(!["siliconflow","deepseek","volcano","gemini","custom_openai"].includes(g)){l.warning("å½“å‰æœåŠ¡å•†ä¸æ”¯æŒè·å–æ¨¡å‹åˆ—è¡¨");return}i.value[U]=!0;try{const Y=await We.fetchModels(g,C,k);Y.success&&Y.models&&Y.models.length>0?(r.value[U]=Y.models.map(ie=>ie.id),l.success(`è½®æ¬¡ ${U+1}: è·å–åˆ° ${Y.models.length} ä¸ªæ¨¡å‹`)):l.warning(Y.message||"æœªè·å–åˆ°å¯ç”¨æ¨¡å‹")}catch(Y){const ie=Y instanceof Error?Y.message:"è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥";l.error(ie)}finally{i.value[U]=!1}}async function I(U){const f=h.value[U];if(!f)return;const g=f.provider,C=f.apiKey?.trim(),k=f.modelName?.trim(),V=f.customBaseUrl?.trim();if(!C){l.warning("è¯·å…ˆå¡«å†™ API Key");return}if(!k){l.warning("è¯·å¡«å†™æ¨¡å‹åç§°");return}a.value[U]=!0,l.info(`æ­£åœ¨æµ‹è¯•è½®æ¬¡ ${U+1} çš„è¿æ¥...`);try{const Y=await We.testAiTranslateConnection({provider:g,apiKey:C,modelName:k,baseUrl:V});Y.success?l.success(Y.message||"è¿æ¥æˆåŠŸ!"):l.error(Y.message||Y.error||"è¿æ¥å¤±è´¥")}catch(Y){const ie=Y instanceof Error?Y.message:"è¿æ¥æµ‹è¯•å¤±è´¥";l.error(ie)}finally{a.value[U]=!1}}function A(){const U={name:`ç¬¬${h.value.length+1}è½®æ ¡å¯¹`,provider:"siliconflow",apiKey:"",modelName:"",customBaseUrl:"",batchSize:3,sessionReset:20,rpmLimit:7,lowReasoning:!1,noThinkingMethod:"gemini",forceJsonOutput:!0,prompt:Lo,showApiKey:!1};o.addProofreadingRound(U),l.success("å·²æ·»åŠ æ–°çš„æ ¡å¯¹è½®æ¬¡")}function w(U){if(h.value.length<=1){l.warning("è‡³å°‘éœ€è¦ä¿ç•™ä¸€ä¸ªæ ¡å¯¹è½®æ¬¡");return}o.removeProofreadingRound(U),l.success("å·²åˆ é™¤æ ¡å¯¹è½®æ¬¡")}function N(U){o.updateProofreadingRound(U,{prompt:Lo}),l.success("å·²é‡ç½®ä¸ºé»˜è®¤æç¤ºè¯")}function W(U,f,g){o.updateProofreadingRound(U,{prompt:f}),l.success(`å·²åº”ç”¨æç¤ºè¯: ${g}`)}return(U,f)=>(R(),E("div",Ac,[e("div",Lc,[f[5]||(f[5]=e("div",{class:"settings-group-title"},"AIæ ¡å¯¹è®¾ç½®",-1)),e("div",Fc,[e("label",Uc,[ne(e("input",{type:"checkbox","onUpdate:modelValue":f[0]||(f[0]=g=>S.value=g)},null,512),[[et,S.value]]),f[2]||(f[2]=Ce(" å¯ç”¨AIæ ¡å¯¹ ",-1))]),f[3]||(f[3]=e("div",{class:"input-hint"},"ç¿»è¯‘å®Œæˆåè‡ªåŠ¨è¿›è¡ŒAIæ ¡å¯¹",-1))]),e("div",Oc,[f[4]||(f[4]=e("label",{for:"settingsProofreadingMaxRetries"},"å…¨å±€é‡è¯•æ¬¡æ•°:",-1)),ne(e("input",{type:"number",id:"settingsProofreadingMaxRetries","onUpdate:modelValue":f[1]||(f[1]=g=>T.value=g),min:"0",max:"10",step:"1"},null,512),[[Se,T.value,void 0,{number:!0}]])])]),ne(e("div",zc,[e("div",{class:"settings-group-title"},[f[6]||(f[6]=Ce(" æ ¡å¯¹è½®æ¬¡é…ç½® ",-1)),e("button",{class:"btn btn-secondary btn-sm",onClick:A},"+ æ·»åŠ è½®æ¬¡")]),(R(!0),E(Be,null,He(h.value,(g,C)=>(R(),E("div",{key:C,class:"proofreading-round"},[e("div",Nc,[e("span",Vc,"è½®æ¬¡ "+oe(C+1)+": "+oe(g.name||"æœªå‘½å"),1),e("button",{class:"btn btn-danger btn-sm",onClick:k=>w(C),disabled:h.value.length<=1}," åˆ é™¤ ",8,Wc)]),e("div",Kc,[e("div",qc,[f[7]||(f[7]=e("label",null,"è½®æ¬¡åç§°:",-1)),ne(e("input",{type:"text","onUpdate:modelValue":k=>g.name=k,placeholder:"å¦‚: ç¬¬ä¸€è½®æ ¡å¯¹"},null,8,Hc),[[Se,g.name]])]),e("div",jc,[e("div",Jc,[f[8]||(f[8]=e("label",null,"æœåŠ¡å•†:",-1)),ye(Ne,{modelValue:g.provider,"onUpdate:modelValue":k=>g.provider=k,options:t},null,8,["modelValue","onUpdate:modelValue"])]),e("div",Gc,[f[9]||(f[9]=e("label",null,"API Key:",-1)),e("div",Yc,[ne(e("input",{type:g.showApiKey?"text":"password","onUpdate:modelValue":k=>g.apiKey=k,class:"secure-input",placeholder:"è¯·è¾“å…¥API Key",autocomplete:"off"},null,8,Xc),[[kt,g.apiKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:k=>g.showApiKey=!g.showApiKey},[g.showApiKey?(R(),E("span",ed,"ğŸ‘â€ğŸ—¨")):(R(),E("span",Qc,"ğŸ‘"))],8,Zc)])])]),ne(e("div",td,[f[10]||(f[10]=e("label",null,"Base URL:",-1)),ne(e("input",{type:"text","onUpdate:modelValue":k=>g.customBaseUrl=k,placeholder:"ä¾‹å¦‚: https://api.example.com/v1"},null,8,od),[[Se,g.customBaseUrl]])],512),[[Fe,g.provider==="custom_openai"]]),e("div",nd,[f[12]||(f[12]=e("label",null,"æ¨¡å‹åç§°:",-1)),e("div",sd,[ne(e("input",{type:"text","onUpdate:modelValue":k=>g.modelName=k,placeholder:"è¯·è¾“å…¥æ¨¡å‹åç§°"},null,8,ad),[[Se,g.modelName]]),e("button",{type:"button",class:"fetch-models-btn",title:"è·å–å¯ç”¨æ¨¡å‹åˆ—è¡¨",onClick:k=>B(C),disabled:i.value[C]},[f[11]||(f[11]=e("span",{class:"fetch-icon"},"ğŸ”",-1)),e("span",id,oe(i.value[C]?"è·å–ä¸­...":"è·å–æ¨¡å‹"),1)],8,ld)]),r.value[C]&&r.value[C].length>0?(R(),E("div",rd,[ye(Ne,{modelValue:g.modelName,"onUpdate:modelValue":k=>g.modelName=k,options:D(C)},null,8,["modelValue","onUpdate:modelValue","options"]),e("span",ud,"å…± "+oe(r.value[C].length)+" ä¸ªæ¨¡å‹",1)])):ge("",!0)]),e("div",cd,[e("button",{class:"settings-test-btn",onClick:k=>I(C),disabled:a.value[C]},oe(a.value[C]?"æµ‹è¯•ä¸­...":"ğŸ”— æµ‹è¯•è¿æ¥"),9,dd)]),e("div",gd,[e("div",pd,[f[13]||(f[13]=e("label",null,"æ‰¹æ¬¡å¤§å°:",-1)),ne(e("input",{type:"number","onUpdate:modelValue":k=>g.batchSize=k,min:"1",max:"10",step:"1"},null,8,md),[[Se,g.batchSize,void 0,{number:!0}]])]),e("div",vd,[f[14]||(f[14]=e("label",null,"ä¼šè¯é‡ç½®é¢‘ç‡:",-1)),ne(e("input",{type:"number","onUpdate:modelValue":k=>g.sessionReset=k,min:"1",step:"1"},null,8,fd),[[Se,g.sessionReset,void 0,{number:!0}]])]),e("div",bd,[f[15]||(f[15]=e("label",null,"RPMé™åˆ¶:",-1)),ne(e("input",{type:"number","onUpdate:modelValue":k=>g.rpmLimit=k,min:"0",step:"1"},null,8,hd),[[Se,g.rpmLimit,void 0,{number:!0}]])])]),e("div",yd,[e("div",xd,[e("label",_d,[ne(e("input",{type:"checkbox","onUpdate:modelValue":k=>g.lowReasoning=k},null,8,kd),[[et,g.lowReasoning]]),f[16]||(f[16]=Ce(" ä½æ¨ç†æ¨¡å¼ ",-1))])]),e("div",Cd,[f[17]||(f[17]=e("label",null,"å–æ¶ˆæ€è€ƒæ–¹æ³•:",-1)),ye(Ne,{modelValue:g.noThinkingMethod,"onUpdate:modelValue":k=>g.noThinkingMethod=k,options:n},null,8,["modelValue","onUpdate:modelValue"])]),e("div",Sd,[e("label",wd,[ne(e("input",{type:"checkbox","onUpdate:modelValue":k=>g.forceJsonOutput=k},null,8,$d),[[et,g.forceJsonOutput]]),f[18]||(f[18]=Ce(" å¼ºåˆ¶JSONè¾“å‡º ",-1))])])]),e("div",Td,[f[19]||(f[19]=e("label",null,"æ ¡å¯¹æç¤ºè¯:",-1)),ne(e("textarea",{"onUpdate:modelValue":k=>g.prompt=k,rows:"4",placeholder:"æ ¡å¯¹æç¤ºè¯"},null,8,Id),[[Se,g.prompt]]),ye(Pt,{"prompt-type":"proofreading",onSelect:(k,V)=>W(C,k,V)},null,8,["onSelect"]),e("button",{class:"btn btn-secondary btn-sm",onClick:k=>N(C)},"é‡ç½®ä¸ºé»˜è®¤",8,Rd)])])]))),128))],512),[[Fe,S.value]])]))}}),Dd=je(Pd,[["__scopeId","data-v-663a7972"]]),Md={class:"prompt-library"},Ed={class:"settings-group"},Bd={class:"settings-item"},Ad={key:0,class:"settings-item"},Ld={class:"mode-hint"},Fd={class:"settings-group"},Ud={key:0,class:"loading-hint"},Od={key:1,class:"empty-hint"},zd={key:2,class:"prompt-list"},Nd=["onClick"],Vd={class:"prompt-name"},Wd={class:"prompt-actions"},Kd=["onClick"],qd=["onClick","disabled"],Hd={class:"settings-group"},jd={class:"settings-item"},Jd={class:"settings-item"},Gd={class:"prompt-editor-actions"},Yd=["disabled"],Xd=Je({__name:"PromptLibrary",setup(s){const t=[{label:"ç¿»è¯‘æç¤ºè¯",value:"translate"},{label:"æ–‡æœ¬æ¡†æç¤ºè¯",value:"textbox"},{label:"AIè§†è§‰OCRæç¤ºè¯",value:"ai_vision_ocr"},{label:"é«˜è´¨é‡ç¿»è¯‘æç¤ºè¯",value:"hq_translate"},{label:"æ ¡å¯¹æç¤ºè¯",value:"proofreading"}],n=[{label:"æ™®é€šæ¨¡å¼",value:"false"},{label:"JSONæ ¼å¼æ¨¡å¼",value:"true"}],o=rt(),l=Ue(),i=_("translate"),a=_([]),r=_(""),h=_(""),T=_(""),S=_(!1),D=_(!1),B=q(()=>i.value==="translate"||i.value==="ai_vision_ocr"),I=q(()=>D.value?"é€‚ç”¨äºéœ€è¦ç»“æ„åŒ–è¾“å‡ºçš„åœºæ™¯":"é€‚ç”¨äºæ™®é€šç¿»è¯‘åœºæ™¯");async function A(){S.value=!0;try{let C;i.value==="textbox"?C=await We.getTextboxPrompts():C=await We.getPrompts(i.value);const k=C.prompt_names||[];a.value=k.map(V=>({name:V}))}catch(C){const k=C instanceof Error?C.message:"åŠ è½½æç¤ºè¯åˆ—è¡¨å¤±è´¥";o.error(k)}finally{S.value=!1}}async function w(C){r.value=C,h.value=C,await N(C)}async function N(C){try{let k;i.value==="textbox"?k=await We.getTextboxPromptContent(C):k=await We.getPromptContent(i.value,C),h.value=C,T.value=k.prompt_content||"",r.value=C,o.success("å·²åŠ è½½æç¤ºè¯")}catch(k){const V=k instanceof Error?k.message:"åŠ è½½æç¤ºè¯å†…å®¹å¤±è´¥";o.error(V)}}async function W(){if(!h.value||!T.value){o.warning("è¯·è¾“å…¥æç¤ºè¯åç§°å’Œå†…å®¹");return}try{i.value==="textbox"?await We.saveTextboxPrompt(h.value,T.value):await We.savePrompt(i.value,h.value,T.value),o.success("æç¤ºè¯ä¿å­˜æˆåŠŸ"),h.value="",T.value="",await A()}catch(C){const k=C instanceof Error?C.message:"ä¿å­˜æç¤ºè¯å¤±è´¥";o.error(k)}}async function U(C){if(C==="default"){o.warning("é»˜è®¤æç¤ºè¯ä¸èƒ½åˆ é™¤");return}try{i.value==="textbox"?await We.deleteTextboxPrompt(C):await We.deletePrompt(i.value,C),o.success("æç¤ºè¯åˆ é™¤æˆåŠŸ"),r.value===C&&(r.value="",h.value="",T.value=""),await A()}catch(k){const V=k instanceof Error?k.message:"åˆ é™¤æç¤ºè¯å¤±è´¥";o.error(V)}}function f(){r.value="",h.value="",T.value="",i.value==="translate"?D.value=l.settings.translation.isJsonMode:i.value==="ai_vision_ocr"?D.value=l.settings.aiVisionOcr.isJsonMode:D.value=!1,A()}function g(){i.value==="translate"?l.updateTranslationService({isJsonMode:D.value}):i.value==="ai_vision_ocr"&&l.updateAiVisionOcr({isJsonMode:D.value}),o.info(`å·²åˆ‡æ¢åˆ°${D.value?"JSONæ ¼å¼":"æ™®é€š"}æ¨¡å¼`)}return ut(()=>{D.value=l.settings.translation.isJsonMode,A()}),(C,k)=>(R(),E("div",Md,[e("div",Ed,[k[6]||(k[6]=e("div",{class:"settings-group-title"},"æç¤ºè¯ç®¡ç†",-1)),e("div",Bd,[k[4]||(k[4]=e("label",{for:"promptType"},"æç¤ºè¯ç±»å‹:",-1)),ye(Ne,{modelValue:i.value,"onUpdate:modelValue":k[0]||(k[0]=V=>i.value=V),options:t,onChange:f},null,8,["modelValue"])]),B.value?(R(),E("div",Ad,[k[5]||(k[5]=e("label",{for:"promptMode"},"æç¤ºè¯æ¨¡å¼:",-1)),ye(Ne,{"model-value":D.value?"true":"false",options:n,onChange:k[1]||(k[1]=V=>{D.value=V==="true",g()})},null,8,["model-value"]),e("span",Ld,oe(I.value),1)])):ge("",!0)]),e("div",Fd,[k[7]||(k[7]=e("div",{class:"settings-group-title"},"å·²ä¿å­˜çš„æç¤ºè¯",-1)),S.value?(R(),E("div",Ud,"åŠ è½½ä¸­...")):a.value.length===0?(R(),E("div",Od,"æš‚æ— ä¿å­˜çš„æç¤ºè¯")):(R(),E("div",zd,[(R(!0),E(Be,null,He(a.value,V=>(R(),E("div",{key:V.name,class:Te(["prompt-item",{active:r.value===V.name}]),onClick:Y=>w(V.name)},[e("span",Vd,oe(V.name),1),e("div",Wd,[e("button",{class:"btn btn-sm",onClick:tt(Y=>N(V.name),["stop"]),title:"åŠ è½½åˆ°ç¼–è¾‘å™¨"},"ğŸ“¥",8,Kd),e("button",{class:"btn btn-sm btn-danger",onClick:tt(Y=>U(V.name),["stop"]),title:"åˆ é™¤",disabled:V.name==="default"}," ğŸ—‘ï¸ ",8,qd)])],10,Nd))),128))]))]),e("div",Hd,[k[10]||(k[10]=e("div",{class:"settings-group-title"},"æç¤ºè¯ç¼–è¾‘",-1)),e("div",jd,[k[8]||(k[8]=e("label",{for:"promptName"},"æç¤ºè¯åç§°:",-1)),ne(e("input",{type:"text",id:"promptName","onUpdate:modelValue":k[2]||(k[2]=V=>h.value=V),placeholder:"è¯·è¾“å…¥æç¤ºè¯åç§°"},null,512),[[Se,h.value]])]),e("div",Jd,[k[9]||(k[9]=e("label",{for:"promptContent"},"æç¤ºè¯å†…å®¹:",-1)),ne(e("textarea",{id:"promptContent","onUpdate:modelValue":k[3]||(k[3]=V=>T.value=V),rows:"8",placeholder:"è¯·è¾“å…¥æç¤ºè¯å†…å®¹"},null,512),[[Se,T.value]])]),e("div",Gd,[e("button",{class:"btn btn-primary",onClick:W,disabled:!h.value||!T.value},"ä¿å­˜æç¤ºè¯",8,Yd)])])]))}}),Zd=je(Xd,[["__scopeId","data-v-70f0ec19"]]),Qd={class:"plugin-manager"},eg={class:"settings-group"},tg={key:0,class:"loading-hint"},og={key:1,class:"empty-hint"},ng={key:2,class:"plugin-list"},sg={class:"plugin-info"},ag={class:"plugin-header"},lg={class:"plugin-name"},ig={class:"plugin-version"},rg={class:"plugin-description"},ug={class:"plugin-controls"},cg={class:"switch"},dg=["checked","onChange"],gg=["onClick"],pg=["onClick"],mg={class:"settings-group"},vg={class:"plugin-name"},fg={class:"switch"},bg=["checked","onChange"],hg={class:"plugin-config-content"},yg={class:"plugin-config-header"},xg={class:"plugin-config-body"},_g=["for"],kg=["id","onUpdate:modelValue"],Cg=["id","onUpdate:modelValue","min","max"],Sg=["id","onUpdate:modelValue","placeholder"],wg={key:4,class:"field-description"},$g=Je({__name:"PluginManager",setup(s){const t=rt(),n=_([]),o=_({}),l=_(!1),i=_(!1),a=_(null),r=_({}),h=_({});async function T(){l.value=!0;try{const W=await ys();n.value=W.plugins||[]}catch(W){const U=W instanceof Error?W.message:"åŠ è½½æ’ä»¶åˆ—è¡¨å¤±è´¥";t.error(U)}finally{l.value=!1}}async function S(){try{const W=await Is();o.value=W.states||{}}catch(W){console.error("åŠ è½½é»˜è®¤çŠ¶æ€å¤±è´¥:",W)}}async function D(W){try{W.enabled?(await _s(W.name),W.enabled=!1,t.success(`å·²ç¦ç”¨ ${W.display_name||W.name}`)):(await xs(W.name),W.enabled=!0,t.success(`å·²å¯ç”¨ ${W.display_name||W.name}`))}catch(U){const f=U instanceof Error?U.message:"æ“ä½œå¤±è´¥";t.error(f)}}async function B(W,U){const f=U.target,g=f.checked;try{await Rs(W,g),o.value[W]=g,t.success("é»˜è®¤çŠ¶æ€å·²æ›´æ–°")}catch(C){const k=C instanceof Error?C.message:"è®¾ç½®å¤±è´¥";t.error(k),f.checked=!g}}async function I(W){a.value=W;try{const U=await Ps(W.name);r.value=U.schema||{};const f=await Ds(W.name);h.value=f.config||{},i.value=!0}catch(U){const f=U instanceof Error?U.message:"åŠ è½½é…ç½®å¤±è´¥";t.error(f)}}function A(){i.value=!1,a.value=null,r.value={},h.value={}}async function w(){if(a.value)try{await Ms(a.value.name,h.value),t.success("é…ç½®ä¿å­˜æˆåŠŸ"),A()}catch(W){const U=W instanceof Error?W.message:"ä¿å­˜é…ç½®å¤±è´¥";t.error(U)}}async function N(W){if(confirm(`ç¡®å®šè¦åˆ é™¤æ’ä»¶ "${W.display_name||W.name}" å—ï¼Ÿ`))try{await ks(W.name),t.success("æ’ä»¶åˆ é™¤æˆåŠŸ"),await T()}catch(U){const f=U instanceof Error?U.message:"åˆ é™¤æ’ä»¶å¤±è´¥";t.error(f)}}return ut(()=>{T(),S()}),(W,U)=>(R(),E("div",Qd,[e("div",eg,[U[1]||(U[1]=e("div",{class:"settings-group-title"},"å·²å®‰è£…æ’ä»¶",-1)),l.value?(R(),E("div",tg,"åŠ è½½ä¸­...")):n.value.length===0?(R(),E("div",og,"æš‚æ— å·²å®‰è£…çš„æ’ä»¶")):(R(),E("div",ng,[(R(!0),E(Be,null,He(n.value,f=>(R(),E("div",{key:f.name,class:"plugin-item"},[e("div",sg,[e("div",ag,[e("span",lg,oe(f.display_name||f.name),1),e("span",ig,"v"+oe(f.version||"1.0.0"),1)]),e("p",rg,oe(f.description||"æš‚æ— æè¿°"),1)]),e("div",ug,[e("label",cg,[e("input",{type:"checkbox",checked:f.enabled,onChange:g=>D(f)},null,40,dg),U[0]||(U[0]=e("span",{class:"slider"},null,-1))]),f.has_config?(R(),E("button",{key:0,class:"btn btn-sm",onClick:g=>I(f),title:"é…ç½®"},"âš™ï¸",8,gg)):ge("",!0),e("button",{class:"btn btn-sm btn-danger",onClick:g=>N(f),title:"åˆ é™¤"},"ğŸ—‘ï¸",8,pg)])]))),128))]))]),e("div",mg,[U[3]||(U[3]=e("div",{class:"settings-group-title"},"é»˜è®¤å¯ç”¨çŠ¶æ€",-1)),U[4]||(U[4]=e("p",{class:"settings-hint"},"è®¾ç½®æ’ä»¶åœ¨æ–°ä¼šè¯ä¸­çš„é»˜è®¤å¯ç”¨çŠ¶æ€",-1)),(R(!0),E(Be,null,He(n.value,f=>(R(),E("div",{key:"default-"+f.name,class:"default-state-item"},[e("span",vg,oe(f.display_name||f.name),1),e("label",fg,[e("input",{type:"checkbox",checked:o.value[f.name],onChange:g=>B(f.name,g)},null,40,bg),U[2]||(U[2]=e("span",{class:"slider"},null,-1))])]))),128))]),i.value?(R(),E("div",{key:0,class:"plugin-config-modal",onClick:tt(A,["self"])},[e("div",hg,[e("div",yg,[e("h4",null,oe(a.value?.display_name||a.value?.name)+" é…ç½®",1),e("span",{class:"close-btn",onClick:A},"Ã—")]),e("div",xg,[(R(!0),E(Be,null,He(r.value,(f,g)=>(R(),E("div",{key:g,class:"config-field"},[e("label",{for:"config-"+g},oe(f.label||g)+":",9,_g),f.type==="boolean"?ne((R(),E("input",{key:0,type:"checkbox",id:"config-"+g,"onUpdate:modelValue":C=>h.value[g]=C},null,8,kg)),[[et,h.value[g]]]):f.type==="select"?(R(),st(Ne,{key:1,"model-value":String(h.value[g]??""),options:f.options||[],onChange:C=>{h.value[g]=C}},null,8,["model-value","options","onChange"])):f.type==="number"?ne((R(),E("input",{key:2,type:"number",id:"config-"+g,"onUpdate:modelValue":C=>h.value[g]=C,min:f.min,max:f.max},null,8,Cg)),[[Se,h.value[g],void 0,{number:!0}]]):ne((R(),E("input",{key:3,type:"text",id:"config-"+g,"onUpdate:modelValue":C=>h.value[g]=C,placeholder:f.placeholder},null,8,Sg)),[[Se,h.value[g]]]),f.description?(R(),E("p",wg,oe(f.description),1)):ge("",!0)]))),128))]),e("div",{class:"plugin-config-footer"},[e("button",{class:"btn btn-secondary",onClick:A},"å–æ¶ˆ"),e("button",{class:"btn btn-primary",onClick:w},"ä¿å­˜")])])])):ge("",!0)]))}}),Tg=je($g,[["__scopeId","data-v-a62393a7"]]),Ig={class:"parallel-settings"},Rg={class:"settings-group"},Pg={class:"settings-item"},Dg={class:"toggle-switch"},Mg={class:"number-control"},Eg=["disabled"],Bg=["disabled"],Ag=["disabled"],Lg={key:0,class:"settings-note"},Fg=Je({__name:"ParallelSettings",setup(s){const t=Ue(),n=q({get:()=>t.settings.parallel.enabled,set:l=>{t.updateSettings({parallel:{...t.settings.parallel,enabled:l}})}}),o=q({get:()=>t.settings.parallel.deepLearningLockSize,set:l=>{t.updateSettings({parallel:{...t.settings.parallel,deepLearningLockSize:Math.max(1,Math.min(4,l))}})}});return(l,i)=>(R(),E("div",Ig,[e("div",Rg,[i[10]||(i[10]=e("div",{class:"settings-group-title"},"ğŸš€ å¹¶è¡Œç¿»è¯‘",-1)),e("div",Pg,[i[5]||(i[5]=e("label",null,"å¯ç”¨å¹¶è¡Œæ¨¡å¼:",-1)),e("label",Dg,[ne(e("input",{type:"checkbox","onUpdate:modelValue":i[0]||(i[0]=a=>n.value=a)},null,512),[[et,n.value]]),i[4]||(i[4]=e("span",{class:"toggle-slider"},null,-1))]),i[6]||(i[6]=e("div",{class:"input-hint"},"ä½¿ç”¨æµæ°´çº¿å¹¶è¡Œå¤„ç†ï¼Œå¯èƒ½æå‡æ‰¹é‡ç¿»è¯‘é€Ÿåº¦",-1))]),e("div",{class:Te(["settings-item",{"item-disabled":!n.value}])},[i[7]||(i[7]=e("label",null,"æ·±åº¦å­¦ä¹ å¹¶å‘æ•°:",-1)),e("div",Mg,[e("button",{class:"btn btn-sm",onClick:i[1]||(i[1]=a=>o.value=Math.max(1,o.value-1)),disabled:!n.value},"-",8,Eg),ne(e("input",{type:"number","onUpdate:modelValue":i[2]||(i[2]=a=>o.value=a),min:"1",max:"4",disabled:!n.value,class:"number-input"},null,8,Bg),[[Se,o.value,void 0,{number:!0}]]),e("button",{class:"btn btn-sm",onClick:i[3]||(i[3]=a=>o.value=Math.min(4,o.value+1)),disabled:!n.value},"+",8,Ag)]),i[8]||(i[8]=e("div",{class:"input-hint"},"æ§åˆ¶æ£€æµ‹/OCR/é¢œè‰²/ä¿®å¤çš„æœ€å¤§å¹¶å‘æ•°ï¼ˆå»ºè®®1-2ï¼‰",-1))],2),n.value?(R(),E("div",Lg,[...i[9]||(i[9]=[e("div",{class:"note-title"},"âš ï¸ æ³¨æ„äº‹é¡¹ï¼š",-1),e("ul",null,[e("li",null,"å¹¶å‘æ•°è®¾ä¸º1æ—¶ä¸ºä¸²è¡Œæ‰§è¡Œï¼Œæœ€ç¨³å®š"),e("li",null,"å¢å¤§å¹¶å‘æ•°å¯èƒ½åŠ é€Ÿå¤„ç†ï¼Œä½†ä¼šå ç”¨æ›´å¤šGPU/CPUèµ„æº"),e("li",null,"å¦‚æœé‡åˆ°æ˜¾å­˜ä¸è¶³ï¼Œè¯·å°†å¹¶å‘æ•°è®¾ä¸º1")],-1)])])):ge("",!0)])]))}}),Ug=je(Fg,[["__scopeId","data-v-4a6e42d5"]]),Og={class:"more-settings"},zg={class:"settings-group"},Ng={class:"settings-item"},Vg={class:"settings-group"},Wg={class:"settings-item"},Kg=["disabled"],qg={key:0,class:"font-count"},Hg={class:"settings-item"},jg={class:"settings-group"},Jg={class:"settings-row"},Gg={class:"settings-item"},Yg=["disabled"],Xg={class:"settings-item"},Zg=["disabled"],Qg=Je({__name:"MoreSettings",setup(s){const t=[{label:"å‰ç«¯ pdf.js (æ¨è)",value:"frontend"},{label:"åç«¯ PyMuPDF",value:"backend"}],n=Ue(),o=rt(),l=_(!1),i=_([]),a=_(!1),r=_(null),h=_({pdfProcessingMethod:n.settings.pdfProcessingMethod||"frontend"});xe(()=>h.value.pdfProcessingMethod,I=>{n.setPdfProcessingMethod(I)});async function T(){l.value=!0;try{const I=await We.getFontList();i.value=I.fonts||[],o.success(`è·å–åˆ° ${i.value.length} ä¸ªå­—ä½“`)}catch(I){const A=I instanceof Error?I.message:"è·å–å­—ä½“åˆ—è¡¨å¤±è´¥";o.error(A)}finally{l.value=!1}}async function S(I){const w=I.target.files?.[0];if(!w)return;const N=[".ttf",".ttc",".otf"],W=w.name.toLowerCase().slice(w.name.lastIndexOf("."));if(!N.includes(W)){o.error("ä¸æ”¯æŒçš„å­—ä½“æ ¼å¼ï¼Œè¯·ä¸Šä¼  .ttf, .ttc æˆ– .otf æ–‡ä»¶");return}try{const U=await We.uploadFont(w);U.success?(o.success(`å­—ä½“ "${U.fontPath||w.name}" ä¸Šä¼ æˆåŠŸ`),await T()):o.error(U.error||"å­—ä½“ä¸Šä¼ å¤±è´¥")}catch(U){const f=U instanceof Error?U.message:"å­—ä½“ä¸Šä¼ å¤±è´¥";o.error(f)}finally{r.value&&(r.value.value="")}}async function D(){a.value=!0;try{const I=await nn();I.success?o.success(`å·²æ¸…ç† ${I.deleted_count||0} ä¸ªè°ƒè¯•æ–‡ä»¶`):o.error(I.error||"æ¸…ç†å¤±è´¥")}catch(I){const A=I instanceof Error?I.message:"æ¸…ç†å¤±è´¥";o.error(A)}finally{a.value=!1}}async function B(){a.value=!0;try{const I=await ro();I.success?o.success(`å·²æ¸…ç† ${I.deleted_count||0} ä¸ªä¸´æ—¶æ–‡ä»¶`):o.error(I.error||"æ¸…ç†å¤±è´¥")}catch(I){const A=I instanceof Error?I.message:"æ¸…ç†å¤±è´¥";o.error(A)}finally{a.value=!1}}return(I,A)=>(R(),E("div",Og,[ye(Ug),e("div",zg,[A[3]||(A[3]=e("div",{class:"settings-group-title"},"PDFå¤„ç†è®¾ç½®",-1)),e("div",Ng,[A[1]||(A[1]=e("label",{for:"settingsPdfProcessingMethod"},"PDFå¤„ç†æ–¹å¼:",-1)),ye(Ne,{modelValue:h.value.pdfProcessingMethod,"onUpdate:modelValue":A[0]||(A[0]=w=>h.value.pdfProcessingMethod=w),options:t},null,8,["modelValue"]),A[2]||(A[2]=e("div",{class:"input-hint"},"å‰ç«¯å¤„ç†é€Ÿåº¦æ›´å¿«ï¼Œåç«¯å¤„ç†å…¼å®¹æ€§æ›´å¥½",-1))])]),e("div",Vg,[A[7]||(A[7]=e("div",{class:"settings-group-title"},"å­—ä½“è®¾ç½®",-1)),e("div",Wg,[A[4]||(A[4]=e("label",null,"ç³»ç»Ÿå­—ä½“åˆ—è¡¨:",-1)),e("button",{class:"btn btn-secondary",onClick:T,disabled:l.value},oe(l.value?"åŠ è½½ä¸­...":"ğŸ”„ åˆ·æ–°å­—ä½“åˆ—è¡¨"),9,Kg),i.value.length>0?(R(),E("div",qg,"å…± "+oe(i.value.length)+" ä¸ªå­—ä½“",1)):ge("",!0)]),e("div",Hg,[A[5]||(A[5]=e("label",null,"ä¸Šä¼ è‡ªå®šä¹‰å­—ä½“:",-1)),e("input",{type:"file",accept:".ttf,.ttc,.otf",onChange:S,ref_key:"fontInput",ref:r},null,544),A[6]||(A[6]=e("div",{class:"input-hint"},"æ”¯æŒ .ttf, .ttc, .otf æ ¼å¼",-1))])]),e("div",jg,[A[10]||(A[10]=e("div",{class:"settings-group-title"},"ç¼“å­˜æ¸…ç†",-1)),e("div",Jg,[e("div",Gg,[e("button",{class:"btn btn-secondary",onClick:D,disabled:a.value},oe(a.value?"æ¸…ç†ä¸­...":"ğŸ—‘ï¸ æ¸…ç†è°ƒè¯•æ–‡ä»¶"),9,Yg),A[8]||(A[8]=e("div",{class:"input-hint"},"æ¸…ç†è°ƒè¯•è¿‡ç¨‹ä¸­ç”Ÿæˆçš„ä¸´æ—¶æ–‡ä»¶",-1))]),e("div",Xg,[e("button",{class:"btn btn-secondary",onClick:B,disabled:a.value},oe(a.value?"æ¸…ç†ä¸­...":"ğŸ—‘ï¸ æ¸…ç†ä¸´æ—¶æ–‡ä»¶"),9,Zg),A[9]||(A[9]=e("div",{class:"input-hint"},"æ¸…ç†ä¸‹è½½å’Œå¤„ç†è¿‡ç¨‹ä¸­çš„ä¸´æ—¶æ–‡ä»¶",-1))])])]),A[11]||(A[11]=oo('<div class="settings-group" data-v-fc8cf2d0><div class="settings-group-title" data-v-fc8cf2d0>å…³äº</div><div class="about-info" data-v-fc8cf2d0><p data-v-fc8cf2d0><strong data-v-fc8cf2d0>Saber-Translator</strong></p><p data-v-fc8cf2d0>AIé©±åŠ¨çš„æ¼«ç”»ç¿»è¯‘å·¥å…·</p><p class="links" data-v-fc8cf2d0><a href="http://www.mashirosaber.top" target="_blank" data-v-fc8cf2d0>ğŸ“– ä½¿ç”¨æ•™ç¨‹</a><a href="https://github.com/MashiroSaber/saber-translator" target="_blank" data-v-fc8cf2d0>ğŸ™ GitHub</a></p><p class="disclaimer" data-v-fc8cf2d0>æœ¬é¡¹ç›®å®Œå…¨å¼€æºå…è´¹ï¼Œè¯·å‹¿ä¸Šå½“å—éª—</p></div></div>',1))]))}}),ep=je(Qg,[["__scopeId","data-v-fc8cf2d0"]]),tp={class:"settings-modal-content"},op={class:"settings-tabs"},np=["onClick"],sp={class:"settings-tab-content"},ap={class:"settings-tab-pane active"},lp={class:"settings-tab-pane"},ip={class:"settings-tab-pane"},rp={class:"settings-tab-pane"},up={class:"settings-tab-pane"},cp={class:"settings-tab-pane"},dp={class:"settings-tab-pane"},gp={class:"settings-tab-pane"},pp=Je({__name:"SettingsModal",props:{modelValue:{type:Boolean},initialTab:{}},emits:["update:modelValue","save"],setup(s,{emit:t}){const n=s,o=t,l=Ue(),i=_(n.modelValue),a=_("ocr"),r=[{id:"ocr",label:"OCRè¯†åˆ«"},{id:"translate",label:"ç¿»è¯‘æœåŠ¡"},{id:"detection",label:"æ£€æµ‹è®¾ç½®"},{id:"hq",label:"é«˜è´¨é‡ç¿»è¯‘"},{id:"proofreading",label:"AIæ ¡å¯¹"},{id:"prompt-library",label:"æç¤ºè¯ç®¡ç†"},{id:"plugins",label:"æ’ä»¶ç®¡ç†"},{id:"more",label:"æ›´å¤š"}];xe(()=>n.modelValue,D=>{i.value=D,D?(document.body.style.overflow="hidden",n.initialTab&&r.some(B=>B.id===n.initialTab)&&(a.value=n.initialTab)):(document.body.style.overflow="",a.value="ocr")});function h(){i.value=!1,o("update:modelValue",!1),document.body.style.overflow=""}async function T(){l.saveToStorage();try{await l.saveToBackend(),console.log("[SettingsModal] è®¾ç½®å·²ä¿å­˜åˆ°åç«¯")}catch(D){console.warn("[SettingsModal] ä¿å­˜åˆ°åç«¯å¤±è´¥ï¼Œä»…ä¿å­˜åˆ° localStorage:",D)}o("save"),h()}function S(D){D.key==="Escape"&&i.value&&h()}return ut(()=>{document.addEventListener("keydown",S)}),Dt(()=>{document.removeEventListener("keydown",S),document.body.style.overflow=""}),(D,B)=>i.value?(R(),E("div",{key:0,class:"settings-modal",onClick:tt(h,["self"])},[e("div",tp,[e("div",{class:"settings-modal-header"},[B[0]||(B[0]=e("h3",null,"âš™ï¸ è®¾ç½®",-1)),e("span",{class:"settings-modal-close",onClick:h},"Ã—")]),e("div",op,[(R(),E(Be,null,He(r,I=>e("button",{key:I.id,class:Te(["settings-tab",{active:a.value===I.id}]),onClick:A=>a.value=I.id},oe(I.label),11,np)),64))]),e("div",sp,[ne(e("div",ap,[ye(Or)],512),[[Fe,a.value==="ocr"]]),ne(e("div",lp,[ye(Tu)],512),[[Fe,a.value==="translate"]]),ne(e("div",ip,[ye(Gu)],512),[[Fe,a.value==="detection"]]),ne(e("div",rp,[ye(Bc)],512),[[Fe,a.value==="hq"]]),ne(e("div",up,[ye(Dd)],512),[[Fe,a.value==="proofreading"]]),ne(e("div",cp,[ye(Zd)],512),[[Fe,a.value==="prompt-library"]]),ne(e("div",dp,[ye(Tg)],512),[[Fe,a.value==="plugins"]]),ne(e("div",gp,[ye(ep)],512),[[Fe,a.value==="more"]])]),e("div",{class:"settings-modal-footer"},[e("button",{class:"btn btn-secondary",onClick:h},"å–æ¶ˆ"),e("button",{class:"btn btn-primary",onClick:T},"ä¿å­˜è®¾ç½®")])])])):ge("",!0)}}),mp=je(pp,[["__scopeId","data-v-e1ec20ab"]]),vp={minScale:.1,maxScale:5,zoomSpeed:.1};function Zo(s={}){const t={...vp,...s},n=_(1),o=_(0),l=_(0),i=_(!1),a=_(0),r=_(0),h=q(()=>({transform:`translate(${o.value}px, ${l.value}px) scale(${n.value})`}));function T(X,ae,Q){const p=Math.min(Math.max(n.value*Q,t.minScale),t.maxScale),m=p/n.value;o.value=X-(X-o.value)*m,l.value=ae-(ae-l.value)*m,n.value=p,s.onScaleChange?.(n.value),s.onTransformChange?.(k())}function S(X,ae=800,Q=600){T(ae/2,Q/2,X)}function D(){S(1.2)}function B(){S(.8)}function I(X,ae=800,Q=600){const p=X/n.value;T(ae/2,Q/2,p)}function A(X,ae){i.value=!0,a.value=X,r.value=ae}function w(X,ae){if(!i.value)return;const Q=X-a.value,p=ae-r.value;o.value+=Q,l.value+=p,a.value=X,r.value=ae,s.onTransformChange?.(k())}function N(){i.value=!1}function W(X,ae){o.value+=X,l.value+=ae,s.onTransformChange?.(k())}function U(){n.value=1,o.value=0,l.value=0,s.onScaleChange?.(n.value),s.onTransformChange?.(k())}function f(){U()}function g(){n.value=1,o.value=0,l.value=0}function C(X,ae,Q,p){if(!X||!ae)return;const m=Q/X,x=p/ae;n.value=Math.min(m,x)*.95,o.value=(Q-X*n.value)/2,l.value=(p-ae*n.value)/2,s.onScaleChange?.(n.value),s.onTransformChange?.(k())}function k(){return{scale:n.value,translateX:o.value,translateY:l.value}}function V(X){X.scale!==void 0&&(n.value=X.scale),X.translateX!==void 0&&(o.value=X.translateX),X.translateY!==void 0&&(l.value=X.translateY),s.onTransformChange?.(k())}function Y(X){n.value=X.scale,o.value=X.translateX,l.value=X.translateY}function ie(X,ae,Q){if(!X||X.length<4)return;const[p,m,x,b]=X,u=(p+x)/2,c=(m+b)/2,M=ae/2,H=Q/2;o.value=M-u*n.value,l.value=H-c*n.value,s.onTransformChange?.(k())}return{scale:n,translateX:o,translateY:l,isDragging:i,transformStyle:h,zoomAt:T,zoom:S,zoomIn:D,zoomOut:B,setScale:I,startDrag:A,drag:w,endDrag:N,pan:W,reset:U,resetZoom:f,resetTransform:g,fitToScreen:C,getTransform:k,setTransform:V,syncWith:Y,scrollToBubble:ie}}function fp(s){const t=Qe(),n=Ue(),o=_(null),l=_(jn),i=_(!1),a=_(!1),r=_([]),h=_(0),T=_(0);let S=null,D=null,B=null;const I=q(()=>o.value!==null),A=q(()=>o.value==="repair"?{fill:"rgba(76, 175, 80, 0.4)",border:"#4CAF50"}:o.value==="restore"?{fill:"rgba(33, 150, 243, 0.4)",border:"#2196F3"}:{fill:"transparent",border:"transparent"});function w(c){o.value!==c&&(o.value=c,i.value=!0,r.value=[],console.log(`è¿›å…¥${c==="repair"?"ä¿®å¤":"è¿˜åŸ"}ç¬”åˆ·æ¨¡å¼ï¼Œç¬”åˆ·å¤§å°: ${l.value}px`))}function N(){a.value&&V();const c=o.value!==null;o.value=null,i.value=!1,a.value=!1,r.value=[],ae(),c&&console.log("é€€å‡ºç¬”åˆ·æ¨¡å¼")}function W(c){o.value===c?N():w(c)}function U(c){l.value=Math.max(Uo,Math.min(Fo,c))}function f(c){U(l.value+c)}function g(c){if(!I.value)return;c.preventDefault(),c.stopPropagation();const M=c.deltaY>0?-5:5;f(M)}function C(c,M){if(!I.value||c.button!==0)return;c.preventDefault(),c.stopPropagation(),a.value=!0,S=M,r.value=[];const H=Y(c,M);H&&(r.value.push(H),X(M),Q(H)),console.log("å¼€å§‹ç¬”åˆ·æ¶‚æŠ¹")}function k(c){if(h.value=c.clientX,T.value=c.clientY,!a.value||!I.value)return;const M=Y(c,S);M&&(r.value.push(M),Q(M))}function V(){if(!a.value)return;a.value=!1;const c=t.currentImage;if(!c||r.value.length===0){ae(),r.value=[];return}const M=ie();if(!M){ae(),r.value=[];return}const H=o.value;(async()=>{H==="restore"?await p(c,M):H==="repair"&&await m(c,M),s?.onBrushComplete?.()})(),ae(),r.value=[]}function Y(c,M){if(!M)return null;const H=M.querySelector(".image-canvas-wrapper"),$=H?.querySelector("img");if(!$||!$.naturalWidth)return null;const O=H.getBoundingClientRect(),P=window.getComputedStyle(H).transform;let v=1;P&&P!=="none"&&(v=new DOMMatrix(P).a);const F=(c.clientX-O.left)/v,d=(c.clientY-O.top)/v,y=$.naturalWidth,ue=$.naturalHeight;return F<0||d<0||F>y||d>ue?null:{x:F,y:d,scale:v}}function ie(){if(r.value.length===0)return null;const M=r.value[0]?.scale||1,H=l.value/2/M;let $=1/0,O=1/0,P=-1/0,v=-1/0;for(const F of r.value)$=Math.min($,F.x-H),O=Math.min(O,F.y-H),P=Math.max(P,F.x+H),v=Math.max(v,F.y+H);return{x1:Math.max(0,Math.floor($)),y1:Math.max(0,Math.floor(O)),x2:Math.ceil(P),y2:Math.ceil(v),path:[...r.value],radius:H}}function X(c){ae();const M=c.querySelector(".image-canvas-wrapper"),H=M?.querySelector("img");if(!H)return;const $=document.createElement("canvas");$.id="brushOverlayCanvas",$.width=H.naturalWidth,$.height=H.naturalHeight,$.style.cssText="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100;",M.appendChild($),D=$,B=$.getContext("2d")}function ae(){D&&D.parentNode&&D.parentNode.removeChild(D),D=null,B=null}function Q(c){if(!B||!c)return;const M=A.value.fill,H=l.value/2/(c.scale||1);B.beginPath(),B.arc(c.x,c.y,H,0,Math.PI*2),B.fillStyle=M,B.fill()}async function p(c,M){if(!c.originalDataURL)return;let H;return c.cleanImageData?H="data:image/png;base64,"+c.cleanImageData:H=c.originalDataURL,new Promise($=>{const O=new Image,P=new Image;let v=0;const F=()=>{if(v++,v<2)return;const d=document.createElement("canvas");d.width=O.naturalWidth,d.height=O.naturalHeight;const y=d.getContext("2d");if(!y){$();return}y.drawImage(O,0,0);const ue=document.createElement("canvas");ue.width=d.width,ue.height=d.height;const L=ue.getContext("2d");if(!L){$();return}L.fillStyle="white";for(const le of M.path)L.beginPath(),L.arc(le.x,le.y,M.radius,0,Math.PI*2),L.fill();y.globalCompositeOperation="destination-out",y.drawImage(ue,0,0),y.globalCompositeOperation="destination-over",y.drawImage(P,0,0),y.globalCompositeOperation="source-over";const j=d.toDataURL("image/png").split(",")[1];t.updateCurrentImage({cleanImageData:j}),console.log("è¿˜åŸç¬”åˆ·åŒºåŸŸå®Œæˆ"),$()};O.onload=F,O.onerror=()=>$(),P.onload=F,P.onerror=()=>$(),O.src=H,P.src=c.originalDataURL})}async function m(c,M){const H=s?.getCurrentRepairSettings?.()||{inpaintMethod:"solid",fillColor:"#FFFFFF"},$=H.inpaintMethod;$==="lama_mpe"||$==="litelama"?await x(c,M,$):await b(c,M,H.fillColor)}async function x(c,M,H="lama_mpe"){let $,O;if(c.cleanImageData)$=c.cleanImageData,O="data:image/png;base64,"+c.cleanImageData;else if(c.originalDataURL)$=c.originalDataURL.split(",")[1],O=c.originalDataURL;else{console.error("æ— æ³•è·å–åŸºç¡€å›¾åƒç”¨äº LAMA ä¿®å¤");return}return new Promise(P=>{const v=new Image;v.onload=async()=>{const F=v.naturalWidth,d=v.naturalHeight,y=document.createElement("canvas");y.width=F,y.height=d;const ue=y.getContext("2d");if(!ue){console.error("æ— æ³•åˆ›å»ºæ©è†œç”»å¸ƒä¸Šä¸‹æ–‡"),P();return}ue.fillStyle="black",ue.fillRect(0,0,F,d),ue.fillStyle="white";for(const $e of M.path)ue.beginPath(),ue.arc($e.x,$e.y,M.radius,0,Math.PI*2),ue.fill();const j=y.toDataURL("image/png").split(",")[1],le=[M.x1,M.y1,M.x2,M.y2],he=H==="litelama"?"litelama":"lama_mpe";try{fe("LAMA ä¿®å¤ä¸­...","info");const $e=await co($,le,{method:"lama",lamaModel:he,maskData:j});if($e.success&&$e.inpainted_image)t.updateCurrentImage({cleanImageData:$e.inpainted_image}),console.log("ä¿®å¤ç¬”åˆ·åŒºåŸŸå®Œæˆï¼ˆLAMA ä¿®å¤ï¼Œç²¾ç¡®æ©è†œï¼‰"),fe("LAMA ä¿®å¤å®Œæˆ","success");else throw new Error($e.error||"LAMA ä¿®å¤è¿”å›æ— æ•ˆæ•°æ®")}catch($e){console.error("LAMA ä¿®å¤å¤±è´¥ï¼Œå›é€€åˆ°çº¯è‰²å¡«å……:",$e),fe("LAMA ä¿®å¤å¤±è´¥ï¼Œä½¿ç”¨çº¯è‰²å¡«å……","warning");const Ae=s?.getCurrentRepairSettings?.();await b(c,M,Ae?.fillColor)}P()},v.onerror=()=>{console.error("åŠ è½½å›¾åƒå¤±è´¥ï¼Œæ— æ³•è¿›è¡Œ LAMA ä¿®å¤"),P()},v.src=O})}async function b(c,M,H){const $=H||n.settings.textStyle.fillColor||"#FFFFFF";let O;if(c.cleanImageData)O="data:image/png;base64,"+c.cleanImageData;else if(c.originalDataURL)O=c.originalDataURL;else return;return new Promise(P=>{const v=new Image;v.onload=()=>{const F=document.createElement("canvas");F.width=v.naturalWidth,F.height=v.naturalHeight;const d=F.getContext("2d");if(!d){P();return}d.drawImage(v,0,0),d.fillStyle=$;for(const ue of M.path)d.beginPath(),d.arc(ue.x,ue.y,M.radius,0,Math.PI*2),d.fill();const y=F.toDataURL("image/png").split(",")[1];t.updateCurrentImage({cleanImageData:y}),console.log("ä¿®å¤ç¬”åˆ·åŒºåŸŸå®Œæˆï¼ˆçº¯è‰²å¡«å……ï¼‰"),P()},v.onerror=()=>P(),v.src=O})}async function u(){const c=t.currentImage;if(!c)return console.warn("ensureCleanBackground: æ²¡æœ‰å½“å‰å›¾ç‰‡"),!1;if(c.cleanImageData)return console.log("ensureCleanBackground: å·²æœ‰å¹²å‡€èƒŒæ™¯"),!0;const M=s?.getCurrentRepairSettings?.();if((M?.inpaintMethod||n.settings.textStyle.inpaintMethod)!=="solid")return console.log("ensureCleanBackground: éçº¯è‰²å¡«å……æ¨¡å¼ï¼Œè·³è¿‡"),!1;if(!c.bubbleStates||c.bubbleStates.length===0)return console.warn("ensureCleanBackground: æ²¡æœ‰æ°”æ³¡æ•°æ®"),!1;if(!c.translatedDataURL&&!c.originalDataURL)return console.warn("ensureCleanBackground: æ²¡æœ‰å›¾ç‰‡æ•°æ®"),!1;console.log("ensureCleanBackground: å°è¯•ä¸ºçº¯è‰²å¡«å……æ¨¡å¼åˆ›å»ºä¸´æ—¶å¹²å‡€èƒŒæ™¯");const $=c.translatedDataURL||c.originalDataURL,O=M?.fillColor||n.settings.textStyle.fillColor||"#FFFFFF";return new Promise(P=>{const v=new Image;v.onload=()=>{try{const F=document.createElement("canvas");F.width=v.naturalWidth,F.height=v.naturalHeight;const d=F.getContext("2d");if(!d){console.error("ensureCleanBackground: æ— æ³•è·å– Canvas ä¸Šä¸‹æ–‡"),P(!1);return}d.drawImage(v,0,0),d.fillStyle=O;for(const ue of c.bubbleStates){const[L,j,le,he]=ue.coords;d.fillRect(L,j,le-L+1,he-j+1)}const y=F.toDataURL("image/png").split(",")[1];t.updateCurrentImage({cleanImageData:y}),console.log("ensureCleanBackground: æˆåŠŸåˆ›å»ºä¸´æ—¶å¹²å‡€èƒŒæ™¯ï¼ˆçº¯è‰²å¡«å……ï¼‰"),P(!0)}catch(F){console.error("ensureCleanBackground: Canvas æ“ä½œå¤±è´¥:",F),P(!1)}},v.onerror=()=>{console.error("ensureCleanBackground: åŠ è½½å›¾åƒå¤±è´¥"),P(!1)},v.src=$})}return Dt(()=>{N()}),{brushMode:o,brushSize:l,isBrushKeyDown:i,isBrushPainting:a,mouseX:h,mouseY:T,isActive:I,brushColor:A,BRUSH_MIN_SIZE:Uo,BRUSH_MAX_SIZE:Fo,enterBrushMode:w,exitBrushMode:N,toggleBrushMode:W,setBrushSize:U,adjustBrushSize:f,handleBrushWheel:g,startBrushPainting:C,continueBrushPainting:k,finishBrushPainting:V,getBrushPositionInImage:Y,getBrushPathBounds:ie,ensureCleanBackground:u}}function bp(s){return[Math.round(s[0]),Math.round(s[1]),Math.round(s[2]),Math.round(s[3])]}function hp(s){const t=ct(),n=Qe(),o=Ue(),{bubbles:l,selectedIndex:i,hasSelection:a}=xt(t),{currentImage:r}=xt(n),h=_(!1),T=_(!1),S=_(null),D=_(0),B=_(0),I=_(!1);function A(d){t.selectBubble(d)}function w(d){t.toggleMultiSelect(d)}function N(){t.clearMultiSelect()}function W(d,y){console.log(`å¼€å§‹æ‹–åŠ¨æ°”æ³¡ #${d+1}`)}function U(d,y){}function f(d,y){t.updateBubble(d,{coords:y}),console.log(`æ°”æ³¡ #${d+1} æ‹–åŠ¨å®Œæˆ:`,y),H()}function g(d,y,ue){console.log(`å¼€å§‹è°ƒæ•´æ°”æ³¡ #${d+1} å¤§å°ï¼Œæ‰‹æŸ„: ${y}`)}function C(d){}function k(d,y){t.updateBubble(d,{coords:y}),console.log(`æ°”æ³¡ #${d+1} è°ƒæ•´å¤§å°å®Œæˆ:`,y),H()}function V(d,y){console.log(`å¼€å§‹æ—‹è½¬æ°”æ³¡ #${d+1}`)}function Y(d){}function ie(d,y){t.updateBubble(d,{rotationAngle:y}),console.log(`æ°”æ³¡ #${d+1} æ—‹è½¬å®Œæˆ: ${y}Â°`),H()}function X(){h.value=!h.value,h.value?console.log("è¿›å…¥ç»˜åˆ¶æ¨¡å¼"):console.log("é€€å‡ºç»˜åˆ¶æ¨¡å¼")}function ae(d){t.addBubble(d),t.selectBubble(t.bubbleCount-1),console.log("å·²æ·»åŠ æ–°æ°”æ³¡:",d),s?.onReRender?.()}function Q(d,y){T.value=!0,D.value=d,B.value=y,S.value=[d,y,d,y]}function p(d,y){T.value&&(S.value=[D.value,B.value,d,y])}function m(){if(!T.value||!S.value)return T.value=!1,S.value=null,null;const[d,y,ue,L]=S.value,j=10;if(Math.abs(ue-d)<j||Math.abs(L-y)<j)return T.value=!1,S.value=null,null;const le=[Math.min(d,ue),Math.min(y,L),Math.max(d,ue),Math.max(y,L)];return T.value=!1,S.value=null,le}function x(){T.value=!1,S.value=null,h.value=!1}function b(){if(!S.value)return{};const[d,y,ue,L]=S.value;return{position:"absolute",left:`${Math.min(d,ue)}px`,top:`${Math.min(y,L)}px`,width:`${Math.abs(ue-d)}px`,height:`${Math.abs(L-y)}px`,border:"2px dashed #00d4ff",background:"rgba(0, 212, 255, 0.1)",pointerEvents:"none",zIndex:"25",boxSizing:"border-box"}}let u=null,c=!1;const M=150;function H(){u&&clearTimeout(u),u=setTimeout(async()=>{if(c){console.log("è·³è¿‡æ¸²æŸ“ï¼Œä¸Šä¸€æ¬¡æ¸²æŸ“ä»åœ¨è¿›è¡Œä¸­");return}console.log("è§¦å‘å»¶è¿Ÿæ¸²æŸ“é¢„è§ˆ"),c=!0;try{s?.onDelayedPreview?await s.onDelayedPreview():s?.onReRender&&await s.onReRender()}catch(d){console.error("å»¶è¿Ÿæ¸²æŸ“é¢„è§ˆå¤±è´¥:",d)}finally{c=!1}},M)}function $(d){t.updateSelectedBubble(d),H()}function O(){a.value&&(t.deleteSelected(),console.log("å·²åˆ é™¤é€‰ä¸­çš„æ°”æ³¡"),s?.onReRender?.())}async function P(){const d=i.value;if(d<0){console.warn("è¯·å…ˆé€‰ä¸­è¦ä¿®å¤çš„æ°”æ³¡æ¡†");return}const y=l.value[d],ue=r.value;if(!y||!ue?.originalDataURL){console.warn("æ— æ³•ä¿®å¤èƒŒæ™¯ï¼šç¼ºå°‘æ°”æ³¡æˆ–å›¾ç‰‡æ•°æ®");return}const L=y.inpaintMethod||"solid",j=y.fillColor||"#FFFFFF",le=y.rotationAngle||0;try{console.log(`å¼€å§‹ä¿®å¤æ°”æ³¡ #${d+1} èƒŒæ™¯ï¼Œæ–¹æ³•: ${L}`);let he;if(ue.cleanImageData)he=ue.cleanImageData;else{const Ae=ue.originalDataURL.match(/^data:image\/[^;]+;base64,(.+)$/);if(he=Ae&&Ae[1]?Ae[1]:"",!he){console.error("æ— æ³•è§£æå›¾åƒæ•°æ®");return}}if(L==="lama_mpe"||L==="litelama"){const Ae=L==="litelama"?"litelama":"lama_mpe",Me=bp(y.coords),se=await co(he,Me,{bubbleAngle:le,method:"lama",lamaModel:Ae});se.success&&se.inpainted_image?(n.updateCurrentImage({cleanImageData:se.inpainted_image}),console.log(`æ°”æ³¡ #${d+1} LAMAèƒŒæ™¯ä¿®å¤æˆåŠŸ`),H()):(console.error("LAMAä¿®å¤å¤±è´¥:",se.error||"æœªçŸ¥é”™è¯¯"),await v(y.coords,j,le),H())}else await v(y.coords,j,le),console.log(`æ°”æ³¡ #${d+1} çº¯è‰²å¡«å……ä¿®å¤æˆåŠŸ`),H()}catch(he){console.error("èƒŒæ™¯ä¿®å¤å‡ºé”™:",he)}}async function v(d,y,ue=0){const L=r.value;if(!L)return;const[j,le,he,$e]=d;let Ae;if(L.cleanImageData)Ae="data:image/png;base64,"+L.cleanImageData;else if(L.originalDataURL)Ae=L.originalDataURL;else{console.error("æ— æ³•æ‰¾åˆ°åŸºç¡€å›¾åƒç”¨äºå¡«å……");return}return new Promise(Me=>{const se=new Image;se.onload=()=>{const J=document.createElement("canvas");J.width=se.naturalWidth,J.height=se.naturalHeight;const z=J.getContext("2d");if(!z){Me();return}if(z.drawImage(se,0,0),z.fillStyle=y,Math.abs(ue)<.1)z.fillRect(j,le,he-j,$e-le);else{const ee=(j+he)/2,ce=(le+$e)/2,ve=(he-j)/2,_e=($e-le)/2,be=ue*Math.PI/180,pe=Math.cos(be),Ie=Math.sin(be),we=[[-ve,-_e],[ve,-_e],[ve,_e],[-ve,_e]].map(([Oe,Pe])=>[ee+Oe*pe-Pe*Ie,ce+Oe*Ie+Pe*pe]);z.beginPath();const Ve=we[0];if(Ve){z.moveTo(Ve[0],Ve[1]);for(let Oe=1;Oe<we.length;Oe++){const Pe=we[Oe];Pe&&z.lineTo(Pe[0],Pe[1])}}z.closePath(),z.fill()}const te=J.toDataURL("image/png").split(",")[1];n.updateCurrentImage({cleanImageData:te}),console.log("å·²å¯¹æ°”æ³¡åŒºåŸŸè¿›è¡Œçº¯è‰²å¡«å……:",d,y,"è§’åº¦:",ue),Me()},se.onerror=()=>{console.error("åŠ è½½åŸºç¡€å›¾åƒå¤±è´¥"),Me()},se.src=Ae})}async function F(d){const y=l.value[d],ue=r.value;if(!y||!ue?.originalDataURL){console.warn("æ— æ³•è¿›è¡Œ OCR è¯†åˆ«ï¼šç¼ºå°‘æ°”æ³¡æˆ–å›¾ç‰‡æ•°æ®");return}try{console.log(`å¼€å§‹ OCR è¯†åˆ«æ°”æ³¡ #${d+1}`);const L=ue.originalDataURL.split(",")[1]||"",j=o.settings,le=await ln(L,y.coords,j.ocrEngine||"manga_ocr",{source_language:j.sourceLanguage,baidu_ocr_api_key:j.baiduOcr.apiKey,baidu_ocr_secret_key:j.baiduOcr.secretKey,baidu_version:j.baiduOcr.version,baidu_source_language:j.baiduOcr.sourceLanguage,ai_vision_provider:j.aiVisionOcr.provider,ai_vision_api_key:j.aiVisionOcr.apiKey,ai_vision_model_name:j.aiVisionOcr.modelName,ai_vision_ocr_prompt:j.aiVisionOcr.prompt,custom_ai_vision_base_url:j.aiVisionOcr.customBaseUrl});le.success&&le.text!==void 0?(t.updateBubble(d,{originalText:le.text}),console.log(`OCR è¯†åˆ«æˆåŠŸ: "${le.text}"`)):console.error("OCR è¯†åˆ«å¤±è´¥:",le.error||"æœªçŸ¥é”™è¯¯")}catch(L){console.error("OCR è¯†åˆ«å‡ºé”™:",L)}}return{isDrawingMode:h,isDrawingBox:T,currentDrawingRect:S,isMiddleButtonDown:I,handleBubbleSelect:A,handleBubbleMultiSelect:w,handleClearMultiSelect:N,handleBubbleDragStart:W,handleBubbleDragging:U,handleBubbleDragEnd:f,handleBubbleResizeStart:g,handleBubbleResizing:C,handleBubbleResizeEnd:k,handleBubbleRotateStart:V,handleBubbleRotating:Y,handleBubbleRotateEnd:ie,toggleDrawingMode:X,handleDrawBubble:ae,startDrawingBox:Q,updateDrawingBox:p,finishDrawingBox:m,cancelDrawing:x,getDrawingRectStyle:b,handleBubbleUpdate:$,deleteSelectedBubbles:O,repairSelectedBubble:P,triggerDelayedPreview:H,handleOcrRecognize:F}}function yp(s){const t=ct(),n=Qe(),{bubbles:o}=xt(t),{currentImage:l}=xt(n),i=_(!1),a=_("");let r=null;function h(){const D=l.value;if(!D)return null;if(D.cleanImageData)return D.cleanImageData;if(D.originalDataURL){const B=D.originalDataURL.match(/^data:image\/[^;]+;base64,(.+)$/);if(B&&B[1])return B[1]}return null}async function T(D=!1){if(!l.value)return console.warn("reRenderFullImage: æ²¡æœ‰å½“å‰å›¾ç‰‡"),!1;if(o.value.length===0){console.log("reRenderFullImage: æ²¡æœ‰æ°”æ³¡ï¼Œè·³è¿‡åç«¯æ¸²æŸ“");const w=h();if(w){const N=`data:image/png;base64,${w}`;n.updateCurrentImage({translatedDataURL:N}),D||s?.onRenderSuccess?.(N)}return!0}const I=h();if(!I)return console.error("reRenderFullImage: ç¼ºå°‘å›¾åƒæ•°æ®"),a.value="ç¼ºå°‘å›¾åƒæ•°æ®",D||s?.onRenderError?.("ç¼ºå°‘å›¾åƒæ•°æ®"),!1;const A=Symbol("render");r=A,i.value=!0,a.value="",D||s?.onRenderStart?.();try{console.log("reRenderFullImage: å¼€å§‹é‡æ–°æ¸²æŸ“ï¼Œæ°”æ³¡æ•°é‡:",o.value.length);const w=o.value,N=w.map(g=>g.translatedText||""),W=w.map(g=>g.coords.map(C=>Math.round(C))),U=w.map(g=>({translatedText:g.translatedText||"",coords:g.coords,fontSize:Number(g.fontSize)||24,fontFamily:g.fontFamily||"fonts/STSONG.TTF",textDirection:Ct(g),textColor:g.textColor||"#231816",rotationAngle:Math.round(Number(g.rotationAngle)||0),position:g.position?{x:Math.round(g.position.x||0),y:Math.round(g.position.y||0)}:{x:0,y:0},strokeEnabled:g.strokeEnabled!==void 0?g.strokeEnabled:!0,strokeColor:g.strokeColor||"#FFFFFF",strokeWidth:Number(g.strokeWidth)||3})),f=await uo({clean_image:I,bubble_texts:N,bubble_coords:W,bubble_states:U,fontSize:Number(w[0]?.fontSize)||24,fontFamily:w[0]?.fontFamily||"fonts/STSONG.TTF",textDirection:w[0]?Ct(w[0]):"vertical",textColor:w[0]?.textColor||"#231816",strokeEnabled:w[0]?.strokeEnabled!==void 0?w[0].strokeEnabled:!0,strokeColor:w[0]?.strokeColor||"#FFFFFF",strokeWidth:Number(w[0]?.strokeWidth)||3,use_individual_styles:!0,use_inpainting:!1,use_lama:!1,is_font_style_change:!0});if(r!==A)return console.log("reRenderFullImage: æ¸²æŸ“ç»“æœå·²è¿‡æœŸï¼Œå¿½ç•¥"),!1;if(f.rendered_image){const g=`data:image/png;base64,${f.rendered_image}`;return n.updateCurrentImage({translatedDataURL:g}),console.log("reRenderFullImage: æ¸²æŸ“æˆåŠŸ"),D||s?.onRenderSuccess?.(g),!0}else{const g=f.error||"æ¸²æŸ“å¤±è´¥";return console.error("reRenderFullImage: æ¸²æŸ“å¤±è´¥ -",g),a.value=g,D||s?.onRenderError?.(g),!1}}catch(w){if(r!==A)return!1;const N=w instanceof Error?w.message:"æ¸²æŸ“è¯·æ±‚å¤±è´¥";return console.error("reRenderFullImage: æ¸²æŸ“å‡ºé”™ -",w),a.value=N,D||s?.onRenderError?.(N),!1}finally{r===A&&(i.value=!1,D||s?.onRenderEnd?.())}}function S(){r=null,i.value=!1}return{isRendering:i,renderError:a,reRenderFullImage:T,cancelRender:S}}const xp=["data-index","data-coords","data-rotation","onClick","onMousedown"],_p={class:"bubble-index"},kp=["data-parent-index","onMousedown"],Cp=["data-parent-index","onMousedown"],Sp=["data-parent-index","onMousedown"],wp=["data-parent-index","onMousedown"],$p=["data-parent-index","onMousedown"],Tp=["data-parent-index","onMousedown"],Ip=["data-parent-index","onMousedown"],Rp=["data-parent-index","onMousedown"],Pp=["data-parent-index","onMousedown"],Dp=Je({__name:"BubbleOverlay",props:{bubbles:{},selectedIndex:{},selectedIndices:{},scale:{},isDrawingMode:{type:Boolean},isBrushMode:{type:Boolean},imageWidth:{},imageHeight:{}},emits:["select","multiSelect","dragStart","dragging","dragEnd","resizeStart","resizing","resizeEnd","rotateStart","rotating","rotateEnd","drawBubble"],setup(s,{emit:t}){const n=ct(),{isDragging:o,draggingIndex:l,dragOffsetX:i,dragOffsetY:a,dragInitialX:r,dragInitialY:h,isResizing:T,resizingIndex:S,resizeCurrentCoords:D,isRotating:B,rotatingIndex:I,rotateCurrentAngle:A}=xt(n),w=s,N=t,W=_(null),U=_(0),f=_(0),g=_(""),C=_(0),k=_(0),V=_(null),Y=_(0),ie=_(0),X=_(0),ae=_(0),Q=_(!1),p=_(0),m=_(0),x=_(null),b=_(!1);function u(J,z){let te,ee,ce,ve,_e=J.rotationAngle||0;if(o.value&&l.value===z){const[we,Ve,Oe,Pe]=J.coords;te=r.value+i.value,ee=h.value+a.value,ce=te+(Oe-we),ve=ee+(Pe-Ve)}else T.value&&S.value===z&&D.value?[te,ee,ce,ve]=D.value:B.value&&I.value===z?([te,ee,ce,ve]=J.coords,_e=A.value):[te,ee,ce,ve]=J.coords;const be=ce-te,pe=ve-ee,Ie={left:`${te}px`,top:`${ee}px`,width:`${be}px`,height:`${pe}px`};return _e&&(Ie.transformOrigin="center center",Ie.transform=`rotate(${_e}deg)`),Ie}function c(){if(!x.value)return{};const[J,z,te,ee]=x.value;return{left:`${Math.min(J,te)}px`,top:`${Math.min(z,ee)}px`,width:`${Math.abs(te-J)}px`,height:`${Math.abs(ee-z)}px`}}function M(J){if(!W.value)return null;const z=W.value.getBoundingClientRect(),te=w.scale||1,ee=(J.clientX-z.left)/te,ce=(J.clientY-z.top)/te;return{x:ee,y:ce}}function H(J,z){w.isBrushMode||z.shiftKey||N("select",J)}function $(J){if(!w.isBrushMode){if(J.button===1){J.preventDefault(),b.value=!0,document.body.classList.add("middle-button-drawing"),he(J);return}J.button===0&&w.isDrawingMode&&he(J)}}function O(J,z){if(!w.isBrushMode&&z.button===0){if(z.preventDefault(),z.stopPropagation(),z.shiftKey){N("multiSelect",J);return}if(J!==w.selectedIndex){N("select",J);return}P(J,z)}}function P(J,z){document.removeEventListener("mousemove",Me),document.removeEventListener("mouseup",se),o.value=!0,l.value=J,U.value=z.clientX,f.value=z.clientY,i.value=0,a.value=0;const te=w.bubbles[J];te&&(r.value=te.coords[0],h.value=te.coords[1]),N("dragStart",J,z),document.addEventListener("mousemove",Me),document.addEventListener("mouseup",se)}function v(J){const z=w.scale||1,te=(J.clientX-U.value)/z,ee=(J.clientY-f.value)/z;i.value=te,a.value=ee}function F(J){const z=l.value;o.value=!1,l.value=-1,i.value=0,a.value=0;const te=w.scale||1,ee=(J.clientX-U.value)/te,ce=(J.clientY-f.value)/te,ve=w.bubbles[z];if(!ve)return;const[_e,be,pe,Ie]=ve.coords,we=pe-_e,Ve=Ie-be;let Oe=Math.round(r.value+ee),Pe=Math.round(h.value+ce);const Re=w.imageWidth||2e3,Ge=w.imageHeight||2e3,at=Math.min(we,Re),it=Math.min(Ve,Ge);Oe=Math.max(0,Math.min(Oe,Re-at)),Pe=Math.max(0,Math.min(Pe,Ge-it));const ke=[Oe,Pe,Oe+at,Pe+it];N("dragEnd",z,ke)}function d(J,z,te){if(w.isBrushMode||te.button!==0)return;te.preventDefault(),te.stopPropagation(),document.removeEventListener("mousemove",Me),document.removeEventListener("mouseup",se),T.value=!0,S.value=z,g.value=J,C.value=te.clientX,k.value=te.clientY;const ee=w.bubbles[z];ee&&(V.value=[...ee.coords],D.value=[...ee.coords]),N("resizeStart",z,J,te),document.addEventListener("mousemove",Me),document.addEventListener("mouseup",se)}function y(J){if(!V.value)return;const z=w.scale||1,te=(J.clientX-C.value)/z,ee=(J.clientY-k.value)/z;let[ce,ve,_e,be]=V.value;const pe=g.value;pe.includes("w")&&(ce+=te),pe.includes("e")&&(_e+=te),pe.includes("n")&&(ve+=ee),pe.includes("s")&&(be+=ee),ce>_e&&([ce,_e]=[_e,ce]),ve>be&&([ve,be]=[be,ve]);const Ie=10;_e-ce<Ie||be-ve<Ie||(D.value=[ce,ve,_e,be])}function ue(J){if(!V.value)return;const z=w.scale||1,te=(J.clientX-C.value)/z,ee=(J.clientY-k.value)/z;let[ce,ve,_e,be]=V.value;const pe=g.value;pe.includes("w")&&(ce+=te),pe.includes("e")&&(_e+=te),pe.includes("n")&&(ve+=ee),pe.includes("s")&&(be+=ee),ce>_e&&([ce,_e]=[_e,ce]),ve>be&&([ve,be]=[be,ve]);const Ie=w.imageWidth||2e3,we=w.imageHeight||2e3;ce=Math.max(0,Math.round(ce)),ve=Math.max(0,Math.round(ve)),_e=Math.min(Ie,Math.round(_e)),be=Math.min(we,Math.round(be));const Ve=10;if(_e-ce<Ve||be-ve<Ve){console.warn("è°ƒæ•´åå°ºå¯¸è¿‡å°ï¼Œå·²æ’¤é”€"),T.value=!1,S.value=-1,V.value=null;return}N("resizeEnd",S.value,[ce,ve,_e,be]),T.value=!1,S.value=-1,V.value=null,D.value=null}function L(J,z){if(w.isBrushMode||z.button!==0)return;z.preventDefault(),z.stopPropagation(),document.removeEventListener("mousemove",Me),document.removeEventListener("mouseup",se),B.value=!0,I.value=J;const te=w.bubbles[J];if(!te||!W.value)return;const[ee,ce,ve,_e]=te.coords,be=w.scale||1,pe=W.value.getBoundingClientRect();X.value=pe.left+(ee+ve)/2*be,ae.value=pe.top+(ce+_e)/2*be;const Ie=z.clientX-X.value,we=z.clientY-ae.value;Y.value=Math.atan2(we,Ie)*180/Math.PI,ie.value=te.rotationAngle||0,A.value=te.rotationAngle||0,N("rotateStart",J,z),document.body.classList.add("rotating-box"),document.addEventListener("mousemove",Me),document.addEventListener("mouseup",se),console.log(`å¼€å§‹æ—‹è½¬æ°”æ³¡ #${J+1}ï¼Œåˆå§‹è§’åº¦: ${ie.value}Â°`)}function j(J){const z=J.clientX-X.value,te=J.clientY-ae.value,ce=Math.atan2(te,z)*180/Math.PI-Y.value;let ve=ie.value+ce;for(;ve>180;)ve-=360;for(;ve<-180;)ve+=360;J.shiftKey&&(ve=Math.round(ve/15)*15),A.value=ve}function le(J){document.body.classList.remove("rotating-box");const z=I.value,te=A.value;N("rotateEnd",z,te),B.value=!1,I.value=-1,console.log(`æ°”æ³¡ #${z+1} æ—‹è½¬å®Œæˆï¼Œè§’åº¦: ${te}Â°`)}function he(J){const z=M(J);if(!z)return;const te=w.imageWidth||2e3,ee=w.imageHeight||2e3;z.x<0||z.x>te||z.y<0||z.y>ee||(Q.value=!0,p.value=z.x,m.value=z.y,x.value=[z.x,z.y,z.x,z.y],document.addEventListener("mousemove",Me),document.addEventListener("mouseup",se),console.log("å¼€å§‹ç»˜åˆ¶æ–°æ¡†:",z.x.toFixed(1),z.y.toFixed(1)))}function $e(J){const z=M(J);!z||!x.value||(x.value=[p.value,m.value,z.x,z.y])}function Ae(J){const z=M(J);if(b.value&&(b.value=!1,document.body.classList.remove("middle-button-drawing")),!z||!x.value){Q.value=!1,x.value=null;return}const te=w.imageWidth||2e3,ee=w.imageHeight||2e3,ce=Math.max(0,Math.round(Math.min(p.value,z.x))),ve=Math.max(0,Math.round(Math.min(m.value,z.y))),_e=Math.min(te,Math.round(Math.max(p.value,z.x))),be=Math.min(ee,Math.round(Math.max(m.value,z.y))),pe=10;if(_e-ce<pe||be-ve<pe){console.log("ç»˜åˆ¶çš„æ¡†å¤ªå°ï¼Œå·²å¿½ç•¥"),Q.value=!1,x.value=null;return}console.log("å®Œæˆç»˜åˆ¶æ–°æ¡†:",[ce,ve,_e,be]),N("drawBubble",[ce,ve,_e,be]),Q.value=!1,x.value=null}function Me(J){o.value?v(J):T.value?y(J):B.value?j(J):Q.value&&$e(J)}function se(J){document.removeEventListener("mousemove",Me),document.removeEventListener("mouseup",se),(J.button===1||b.value)&&(b.value=!1,document.body.classList.remove("middle-button-drawing")),o.value?F(J):T.value?ue(J):B.value?le():Q.value&&Ae(J)}return ut(()=>{}),Dt(()=>{document.removeEventListener("mousemove",Me),document.removeEventListener("mouseup",se),document.body.classList.remove("middle-button-drawing"),document.body.classList.remove("rotating-box")}),(J,z)=>(R(),E("div",{class:Te(["bubble-overlay",{"brush-mode":s.isBrushMode}]),ref_key:"overlayRef",ref:W,onMousedown:$},[(R(!0),E(Be,null,He(s.bubbles,(te,ee)=>(R(),E("div",{key:ee,class:Te(["bubble-highlight-box",{selected:ee===s.selectedIndex,"multi-selected":s.selectedIndices.length>1&&s.selectedIndices.includes(ee)&&ee!==s.selectedIndex}]),style:ot(u(te,ee)),"data-index":ee,"data-coords":JSON.stringify(te.coords),"data-rotation":te.rotationAngle||0,onClick:tt(ce=>H(ee,ce),["stop"]),onMousedown:tt(ce=>O(ee,ce),["stop"])},[e("span",_p,oe(ee+1),1),ee===s.selectedIndex?(R(),E(Be,{key:0},[e("div",{class:"resize-handle nw","data-handle":"nw","data-parent-index":ee,onMousedown:tt(ce=>d("nw",ee,ce),["stop"])},null,40,kp),e("div",{class:"resize-handle n","data-handle":"n","data-parent-index":ee,onMousedown:tt(ce=>d("n",ee,ce),["stop"])},null,40,Cp),e("div",{class:"resize-handle ne","data-handle":"ne","data-parent-index":ee,onMousedown:tt(ce=>d("ne",ee,ce),["stop"])},null,40,Sp),e("div",{class:"resize-handle e","data-handle":"e","data-parent-index":ee,onMousedown:tt(ce=>d("e",ee,ce),["stop"])},null,40,wp),e("div",{class:"resize-handle se","data-handle":"se","data-parent-index":ee,onMousedown:tt(ce=>d("se",ee,ce),["stop"])},null,40,$p),e("div",{class:"resize-handle s","data-handle":"s","data-parent-index":ee,onMousedown:tt(ce=>d("s",ee,ce),["stop"])},null,40,Tp),e("div",{class:"resize-handle sw","data-handle":"sw","data-parent-index":ee,onMousedown:tt(ce=>d("sw",ee,ce),["stop"])},null,40,Ip),e("div",{class:"resize-handle w","data-handle":"w","data-parent-index":ee,onMousedown:tt(ce=>d("w",ee,ce),["stop"])},null,40,Rp),z[0]||(z[0]=e("div",{class:"rotate-line"},null,-1)),e("div",{class:"rotate-handle",title:"æ‹–æ‹½æ—‹è½¬","data-parent-index":ee,onMousedown:tt(ce=>L(ee,ce),["stop"])},null,40,Pp)],64)):ge("",!0)],46,xp))),128)),x.value?(R(),E("div",{key:0,class:"drawing-rect",style:ot(c())},null,4)):ge("",!0)],34))}}),Qo=je(Dp,[["__scopeId","data-v-a3e510ac"]]),Mp={key:0,class:"kana-keyboard"},Ep={class:"kana-keyboard-header"},Bp={class:"kana-keyboard-tabs"},Ap=["onClick"],Lp={class:"kana-keyboard-options"},Fp={class:"kana-mode-select"},Up={class:"kana-target-select"},Op={class:"kana-table"},zp={class:"row-label"},Np=["onClick"],Vp={class:"kana-hiragana"},Wp={class:"kana-katakana"},Kp={class:"kana-table"},qp={class:"row-label"},Hp=["onClick"],jp={class:"kana-hiragana"},Jp={class:"kana-katakana"},Gp={class:"kana-table combo-table"},Yp={class:"row-label"},Xp=["onClick"],Zp={class:"kana-hiragana"},Qp={class:"kana-katakana"},em={class:"special-chars-grid"},tm=["onClick"],om={key:0,class:"char-label"},nm=Je({__name:"JapaneseKeyboard",props:{visible:{type:Boolean,default:!1},defaultTarget:{default:"original"}},emits:["close","insert","delete"],setup(s,{emit:t}){const n=s,o=t,l=_("basic"),i=_("hiragana"),a=_(n.defaultTarget),r=_(null),h=[{label:"åŸæ–‡",value:"original"},{label:"è¯‘æ–‡",value:"translated"}],T=[{id:"basic",label:"åŸºæœ¬"},{id:"dakuten",label:"æµŠ/åŠæµŠéŸ³"},{id:"combo",label:"æ‹—éŸ³"},{id:"special",label:"ç‰¹æ®Š"}],S=[{label:"ã‚è¡Œ",chars:[{h:"ã‚",k:"ã‚¢"},{h:"ã„",k:"ã‚¤"},{h:"ã†",k:"ã‚¦"},{h:"ãˆ",k:"ã‚¨"},{h:"ãŠ",k:"ã‚ª"}]},{label:"ã‹è¡Œ",chars:[{h:"ã‹",k:"ã‚«"},{h:"ã",k:"ã‚­"},{h:"ã",k:"ã‚¯"},{h:"ã‘",k:"ã‚±"},{h:"ã“",k:"ã‚³"}]},{label:"ã•è¡Œ",chars:[{h:"ã•",k:"ã‚µ"},{h:"ã—",k:"ã‚·"},{h:"ã™",k:"ã‚¹"},{h:"ã›",k:"ã‚»"},{h:"ã",k:"ã‚½"}]},{label:"ãŸè¡Œ",chars:[{h:"ãŸ",k:"ã‚¿"},{h:"ã¡",k:"ãƒ"},{h:"ã¤",k:"ãƒ„"},{h:"ã¦",k:"ãƒ†"},{h:"ã¨",k:"ãƒˆ"}]},{label:"ãªè¡Œ",chars:[{h:"ãª",k:"ãƒŠ"},{h:"ã«",k:"ãƒ‹"},{h:"ã¬",k:"ãƒŒ"},{h:"ã­",k:"ãƒ"},{h:"ã®",k:"ãƒ"}]},{label:"ã¯è¡Œ",chars:[{h:"ã¯",k:"ãƒ"},{h:"ã²",k:"ãƒ’"},{h:"ãµ",k:"ãƒ•"},{h:"ã¸",k:"ãƒ˜"},{h:"ã»",k:"ãƒ›"}]},{label:"ã¾è¡Œ",chars:[{h:"ã¾",k:"ãƒ"},{h:"ã¿",k:"ãƒŸ"},{h:"ã‚€",k:"ãƒ "},{h:"ã‚",k:"ãƒ¡"},{h:"ã‚‚",k:"ãƒ¢"}]},{label:"ã‚„è¡Œ",chars:[{h:"ã‚„",k:"ãƒ¤"},null,{h:"ã‚†",k:"ãƒ¦"},null,{h:"ã‚ˆ",k:"ãƒ¨"}]},{label:"ã‚‰è¡Œ",chars:[{h:"ã‚‰",k:"ãƒ©"},{h:"ã‚Š",k:"ãƒª"},{h:"ã‚‹",k:"ãƒ«"},{h:"ã‚Œ",k:"ãƒ¬"},{h:"ã‚",k:"ãƒ­"}]},{label:"ã‚è¡Œ",chars:[{h:"ã‚",k:"ãƒ¯"},null,null,null,{h:"ã‚’",k:"ãƒ²"}]},{label:"ã‚“",chars:[{h:"ã‚“",k:"ãƒ³"},null,null,null,null]}],D=[{label:"ãŒè¡Œ",chars:[{h:"ãŒ",k:"ã‚¬"},{h:"ã",k:"ã‚®"},{h:"ã",k:"ã‚°"},{h:"ã’",k:"ã‚²"},{h:"ã”",k:"ã‚´"}]},{label:"ã–è¡Œ",chars:[{h:"ã–",k:"ã‚¶"},{h:"ã˜",k:"ã‚¸"},{h:"ãš",k:"ã‚º"},{h:"ãœ",k:"ã‚¼"},{h:"ã",k:"ã‚¾"}]},{label:"ã è¡Œ",chars:[{h:"ã ",k:"ãƒ€"},{h:"ã¢",k:"ãƒ‚"},{h:"ã¥",k:"ãƒ…"},{h:"ã§",k:"ãƒ‡"},{h:"ã©",k:"ãƒ‰"}]},{label:"ã°è¡Œ",chars:[{h:"ã°",k:"ãƒ"},{h:"ã³",k:"ãƒ“"},{h:"ã¶",k:"ãƒ–"},{h:"ã¹",k:"ãƒ™"},{h:"ã¼",k:"ãƒœ"}]},{label:"ã±è¡Œ",chars:[{h:"ã±",k:"ãƒ‘"},{h:"ã´",k:"ãƒ”"},{h:"ã·",k:"ãƒ—"},{h:"ãº",k:"ãƒš"},{h:"ã½",k:"ãƒ"}]}],B=[{label:"ãã‚ƒè¡Œ",chars:[{h:"ãã‚ƒ",k:"ã‚­ãƒ£"},{h:"ãã‚…",k:"ã‚­ãƒ¥"},{h:"ãã‚‡",k:"ã‚­ãƒ§"}]},{label:"ã—ã‚ƒè¡Œ",chars:[{h:"ã—ã‚ƒ",k:"ã‚·ãƒ£"},{h:"ã—ã‚…",k:"ã‚·ãƒ¥"},{h:"ã—ã‚‡",k:"ã‚·ãƒ§"}]},{label:"ã¡ã‚ƒè¡Œ",chars:[{h:"ã¡ã‚ƒ",k:"ãƒãƒ£"},{h:"ã¡ã‚…",k:"ãƒãƒ¥"},{h:"ã¡ã‚‡",k:"ãƒãƒ§"}]},{label:"ã«ã‚ƒè¡Œ",chars:[{h:"ã«ã‚ƒ",k:"ãƒ‹ãƒ£"},{h:"ã«ã‚…",k:"ãƒ‹ãƒ¥"},{h:"ã«ã‚‡",k:"ãƒ‹ãƒ§"}]},{label:"ã²ã‚ƒè¡Œ",chars:[{h:"ã²ã‚ƒ",k:"ãƒ’ãƒ£"},{h:"ã²ã‚…",k:"ãƒ’ãƒ¥"},{h:"ã²ã‚‡",k:"ãƒ’ãƒ§"}]},{label:"ã¿ã‚ƒè¡Œ",chars:[{h:"ã¿ã‚ƒ",k:"ãƒŸãƒ£"},{h:"ã¿ã‚…",k:"ãƒŸãƒ¥"},{h:"ã¿ã‚‡",k:"ãƒŸãƒ§"}]},{label:"ã‚Šã‚ƒè¡Œ",chars:[{h:"ã‚Šã‚ƒ",k:"ãƒªãƒ£"},{h:"ã‚Šã‚…",k:"ãƒªãƒ¥"},{h:"ã‚Šã‚‡",k:"ãƒªãƒ§"}]},{label:"ãã‚ƒè¡Œ",chars:[{h:"ãã‚ƒ",k:"ã‚®ãƒ£"},{h:"ãã‚…",k:"ã‚®ãƒ¥"},{h:"ãã‚‡",k:"ã‚®ãƒ§"}]},{label:"ã˜ã‚ƒè¡Œ",chars:[{h:"ã˜ã‚ƒ",k:"ã‚¸ãƒ£"},{h:"ã˜ã‚…",k:"ã‚¸ãƒ¥"},{h:"ã˜ã‚‡",k:"ã‚¸ãƒ§"}]},{label:"ã³ã‚ƒè¡Œ",chars:[{h:"ã³ã‚ƒ",k:"ãƒ“ãƒ£"},{h:"ã³ã‚…",k:"ãƒ“ãƒ¥"},{h:"ã³ã‚‡",k:"ãƒ“ãƒ§"}]},{label:"ã´ã‚ƒè¡Œ",chars:[{h:"ã´ã‚ƒ",k:"ãƒ”ãƒ£"},{h:"ã´ã‚…",k:"ãƒ”ãƒ¥"},{h:"ã´ã‚‡",k:"ãƒ”ãƒ§"}]}],I=[{char:"ã£",label:"ä¿ƒéŸ³"},{char:"ãƒƒ",label:"ä¿ƒéŸ³"},{char:"ãƒ¼",label:"é•¿éŸ³"},{char:"ã€œ",label:"æ³¢æµª"},{char:"ã€‚",label:"å¥å·"},{char:"ã€",label:"é¡¿å·"},{char:"ã€Œ",label:"å¼•å·"},{char:"ã€",label:"å¼•å·"},{char:"ã€",label:"åŒå¼•"},{char:"ã€",label:"åŒå¼•"},{char:"â€¦",label:"çœç•¥"},{char:"ãƒ»",label:"ä¸­ç‚¹"},{char:"ï¼",label:"æ„Ÿå¹"},{char:"ï¼Ÿ",label:"é—®å·"},{char:"â™ª",label:"éŸ³ç¬¦"},{char:"â™¡",label:"å¿ƒå½¢"},{char:"â˜…",label:"æ˜Ÿå½¢"},{char:"â˜†",label:"ç©ºæ˜Ÿ"},{char:"ã",label:"å°ã‚"},{char:"ãƒ",label:"å°ã„"},{char:"ã…",label:"å°ã†"},{char:"ã‡",label:"å°ãˆ"},{char:"ã‰",label:"å°ãŠ"},{char:"ã‚¡",label:"å°ã‚¢"},{char:"ã‚£",label:"å°ã‚¤"},{char:"ã‚¥",label:"å°ã‚¦"},{char:"ã‚§",label:"å°ã‚¨"},{char:"ã‚©",label:"å°ã‚ª"},{char:"ã‚ƒ",label:"å°ã‚„"},{char:"ã‚…",label:"å°ã‚†"},{char:"ã‚‡",label:"å°ã‚ˆ"},{char:"ãƒ£",label:"å°ãƒ¤"},{char:"ãƒ¥",label:"å°ãƒ¦"},{char:"ãƒ§",label:"å°ãƒ¨"}];function A(){o("close")}function w(U){const f=i.value==="hiragana"?U.h:U.k;r.value=U.h,setTimeout(()=>{r.value=null},100),o("insert",f,a.value)}function N(U){r.value=U,setTimeout(()=>{r.value=null},100),o("insert",U,a.value)}function W(){o("delete",a.value)}return(U,f)=>s.visible?(R(),E("div",Mp,[e("div",Ep,[f[3]||(f[3]=e("span",{class:"kana-keyboard-title"},"50éŸ³é”®ç›˜",-1)),e("div",Bp,[(R(),E(Be,null,He(T,g=>e("button",{key:g.id,class:Te(["kana-tab",{active:l.value===g.id}]),onClick:C=>l.value=g.id},oe(g.label),11,Ap)),64))]),e("button",{class:"kana-keyboard-close",onClick:A},"âœ•")]),e("div",Lp,[e("div",Fp,[e("label",null,[ne(e("input",{type:"radio",name:"kanaMode",value:"hiragana","onUpdate:modelValue":f[0]||(f[0]=g=>i.value=g)},null,512),[[Wo,i.value]]),f[4]||(f[4]=Ce(" å¹³å‡å ",-1))]),e("label",null,[ne(e("input",{type:"radio",name:"kanaMode",value:"katakana","onUpdate:modelValue":f[1]||(f[1]=g=>i.value=g)},null,512),[[Wo,i.value]]),f[5]||(f[5]=Ce(" ç‰‡å‡å ",-1))])]),e("div",Up,[f[6]||(f[6]=e("label",null,"è¾“å…¥åˆ°ï¼š",-1)),ye(Ne,{modelValue:a.value,"onUpdate:modelValue":f[2]||(f[2]=g=>a.value=g),options:h},null,8,["modelValue"])])]),e("div",{class:Te(["kana-tab-content",{active:l.value==="basic"}])},[e("table",Op,[f[7]||(f[7]=e("thead",null,[e("tr",null,[e("th"),e("th",null,"ã‚æ®µ"),e("th",null,"ã„æ®µ"),e("th",null,"ã†æ®µ"),e("th",null,"ãˆæ®µ"),e("th",null,"ãŠæ®µ")])],-1)),e("tbody",null,[(R(),E(Be,null,He(S,g=>e("tr",{key:g.label},[e("td",zp,oe(g.label),1),(R(!0),E(Be,null,He(g.chars,(C,k)=>(R(),E("td",{key:k},[C?(R(),E("button",{key:0,class:Te(["kana-key",{pressed:r.value===C.h}]),onClick:V=>w(C)},[e("span",Vp,oe(C.h),1),e("span",Wp,oe(C.k),1)],10,Np)):ge("",!0)]))),128))])),64))])])],2),e("div",{class:Te(["kana-tab-content",{active:l.value==="dakuten"}])},[e("table",Kp,[f[8]||(f[8]=e("thead",null,[e("tr",null,[e("th"),e("th",null,"ã‚æ®µ"),e("th",null,"ã„æ®µ"),e("th",null,"ã†æ®µ"),e("th",null,"ãˆæ®µ"),e("th",null,"ãŠæ®µ")])],-1)),e("tbody",null,[(R(),E(Be,null,He(D,g=>e("tr",{key:g.label},[e("td",qp,oe(g.label),1),(R(!0),E(Be,null,He(g.chars,(C,k)=>(R(),E("td",{key:k},[C?(R(),E("button",{key:0,class:Te(["kana-key",{pressed:r.value===C.h}]),onClick:V=>w(C)},[e("span",jp,oe(C.h),1),e("span",Jp,oe(C.k),1)],10,Hp)):ge("",!0)]))),128))])),64))])])],2),e("div",{class:Te(["kana-tab-content",{active:l.value==="combo"}])},[e("table",Gp,[f[9]||(f[9]=e("thead",null,[e("tr",null,[e("th"),e("th",null,"ã‚ƒ"),e("th",null,"ã‚…"),e("th",null,"ã‚‡")])],-1)),e("tbody",null,[(R(),E(Be,null,He(B,g=>e("tr",{key:g.label},[e("td",Yp,oe(g.label),1),(R(!0),E(Be,null,He(g.chars,(C,k)=>(R(),E("td",{key:k},[C?(R(),E("button",{key:0,class:Te(["kana-key",{pressed:r.value===C.h}]),onClick:V=>w(C)},[e("span",Zp,oe(C.h),1),e("span",Qp,oe(C.k),1)],10,Xp)):ge("",!0)]))),128))])),64))])])],2),e("div",{class:Te(["kana-tab-content",{active:l.value==="special"}])},[e("div",em,[(R(),E(Be,null,He(I,g=>e("button",{key:g.char,class:Te(["kana-key special-key",{pressed:r.value===g.char}]),onClick:C=>N(g.char)},[Ce(oe(g.char)+" ",1),g.label?(R(),E("span",om,oe(g.label),1)):ge("",!0)],10,tm)),64))])],2),e("div",{class:"kana-keyboard-footer"},[e("button",{class:"kana-backspace",onClick:W},"âŒ« é€€æ ¼")])])):ge("",!0)}}),sm=je(nm,[["__scopeId","data-v-ebfc2125"]]),am={class:"edit-panel-content"},lm={class:"text-column original-text-column text-block"},im={class:"text-column translated-text-column text-block"},rm={class:"style-settings-section text-block"},um={class:"office-toolbar"},cm={class:"toolbar-row toolbar-row-top"},dm={class:"combo-control font-control"},gm={class:"combo-control size-control"},pm={class:"size-input-wrap"},mm=["min","max","step"],vm={class:"toolbar-row toolbar-row-actions"},fm={class:"toolbar-icon-group","aria-label":"æ’ç‰ˆæ–¹å‘"},bm=["data-active"],hm=["data-active"],ym={class:"toolbar-color-group"},xm={class:"toolbar-color-picker",title:"æ–‡å­—é¢œè‰²"},_m={class:"toolbar-inpaint-group",title:"èƒŒæ™¯ä¿®å¤æ–¹å¼"},km={class:"toolbar-stroke-cluster"},Cm=["data-active"],Sm={class:"toolbar-row toolbar-row-bottom"},wm={class:"toolbar-rotation-group",title:"æ—‹è½¬è§’åº¦"},$m={class:"toolbar-position-group",title:"ä½ç½®è°ƒæ•´"},Tm={class:"toolbar-position-value"},Im={class:"fontsize-presets-panel"},Rm={class:"font-size-presets"},Pm=["onClick"],Lt=2,Dm=Je({__name:"BubbleEditor",props:{bubble:{},bubbleIndex:{}},emits:["update","reRender","ocrRecognize","reTranslate","applyBubble","resetCurrent"],setup(s,{emit:t}){const n=s,o=t,l=ct(),i={originalText:"",translatedText:"",fontSize:24,fontFamily:"fonts/STSONG.TTF",textDirection:"auto",textColor:"#231816",fillColor:"#FFFFFF",strokeEnabled:!0,strokeColor:"#FFFFFF",strokeWidth:3,rotationAngle:0,inpaintMethod:"solid",position:{x:0,y:0}},a=_(""),r=_(""),h=_(24),T=_("fonts/STSONG.TTF"),S=_("auto"),D=_("#231816"),B=_("#FFFFFF"),I=_(!0),A=_("#FFFFFF"),w=_(3),N=_(0),W=_("solid"),U=_(0),f=_(0),g=_(null),C=_(null),k=_(null),V=_(null),Y=_(null),ie=_(!1),X=_("original"),ae=_([{name:"åæ–‡å®‹ä½“",path:"fonts/STSONG.TTF"},{name:"åæ–‡æ¥·ä½“",path:"fonts/STKAITI.TTF"},{name:"åæ–‡ç»†é»‘",path:"fonts/STXIHEI.TTF"},{name:"é»‘ä½“",path:"fonts/SIMHEI.TTF"},{name:"å®‹ä½“",path:"fonts/SIMSUN.TTC"}]),Q=_([]),p=q(()=>n.bubble?n.bubble.coords[0]+U.value:0),m=q(()=>n.bubble?n.bubble.coords[1]+f.value:0),x=q(()=>{const ke=[{label:"ç³»ç»Ÿå­—ä½“",options:ae.value.map(Z=>({label:Z.name,value:Z.path}))}];return Q.value.length>0&&ke.push({label:"è‡ªå®šä¹‰å­—ä½“",options:Q.value.map(Z=>({label:Z.name,value:Z.path}))}),ke}),b=[{label:"çº¯è‰²å¡«å……",value:"solid"},{label:"LAMAä¿®å¤(æ¼«ç”»)",value:"lama_mpe"},{label:"LAMAä¿®å¤(é€šç”¨)",value:"litelama"}];function u(ke){const Z=ke||i;a.value=Z.originalText,r.value=Z.translatedText,h.value=Z.fontSize,T.value=Z.fontFamily,S.value=Z.textDirection,D.value=Z.textColor,B.value=Z.fillColor,I.value=Z.strokeEnabled,A.value=Z.strokeColor,w.value=Z.strokeWidth,N.value=Z.rotationAngle,W.value=Z.inpaintMethod,U.value=Z.position?.x||0,f.value=Z.position?.y||0}xe(()=>n.bubble,ke=>{u(ke)},{deep:!0,immediate:!0});function c(){o("update",{originalText:a.value})}function M(){o("update",{translatedText:r.value})}function H(){navigator.clipboard.writeText(a.value)}function $(){navigator.clipboard.writeText(r.value)}function O(){o("update",{fontSize:h.value})}function P(ke){h.value=ke,o("update",{fontSize:ke})}function v(){h.value=Math.min(Oo,h.value+Zt),o("update",{fontSize:h.value})}function F(){h.value=Math.max(zo,h.value-Zt),o("update",{fontSize:h.value})}function d(){o("update",{fontFamily:T.value})}function y(ke){S.value=ke,o("update",{textDirection:ke})}function ue(){k.value?.click()}function L(){o("update",{textColor:D.value})}function j(){V.value?.click()}function le(){o("update",{fillColor:B.value})}function he(){Y.value?.click()}function $e(){o("update",{strokeColor:A.value})}function Ae(){I.value=!I.value,o("update",{strokeEnabled:I.value})}function Me(){o("update",{strokeWidth:w.value})}function se(){o("update",{inpaintMethod:W.value})}function J(){o("update",{rotationAngle:N.value})}function z(){N.value=Math.max(-180,N.value-5),o("update",{rotationAngle:N.value})}function te(){N.value=Math.min(180,N.value+5),o("update",{rotationAngle:N.value})}function ee(){N.value=0,o("update",{rotationAngle:0})}function ce(){U.value-=Lt,o("update",{position:{x:U.value,y:f.value}})}function ve(){U.value+=Lt,o("update",{position:{x:U.value,y:f.value}})}function _e(){f.value-=Lt,o("update",{position:{x:U.value,y:f.value}})}function be(){f.value+=Lt,o("update",{position:{x:U.value,y:f.value}})}function pe(){U.value=0,f.value=0,o("update",{position:{x:0,y:0}})}function Ie(){o("applyBubble",n.bubbleIndex)}function we(){l.updateAllBubbles({fontSize:h.value,fontFamily:T.value,textDirection:S.value,textColor:D.value,fillColor:B.value,strokeEnabled:I.value,strokeColor:A.value,strokeWidth:w.value,inpaintMethod:W.value}),console.log("æ ·å¼å·²åº”ç”¨åˆ°æ‰€æœ‰æ°”æ³¡"),o("reRender")}function Ve(){o("resetCurrent",n.bubbleIndex)}function Oe(){o("ocrRecognize",n.bubbleIndex)}function Pe(){o("reTranslate",n.bubbleIndex)}function Re(){ie.value=!ie.value}function Ge(ke,Z){if(Z==="original"){const me=g.value;if(me){const Ke=me.selectionStart||a.value.length,Ye=me.selectionEnd||a.value.length,vt=a.value;a.value=vt.slice(0,Ke)+ke+vt.slice(Ye),dt(()=>{me.selectionStart=me.selectionEnd=Ke+ke.length,me.focus()}),o("update",{originalText:a.value})}}else{const me=C.value;if(me){const Ke=me.selectionStart||r.value.length,Ye=me.selectionEnd||r.value.length,vt=r.value;r.value=vt.slice(0,Ke)+ke+vt.slice(Ye),dt(()=>{me.selectionStart=me.selectionEnd=Ke+ke.length,me.focus()}),o("update",{translatedText:r.value})}}}function at(ke){if(ke==="original"){const Z=g.value;if(Z&&a.value.length>0){const me=Z.selectionStart||a.value.length,Ke=Z.selectionEnd||a.value.length,Ye=a.value;me===Ke&&me>0?(a.value=Ye.slice(0,me-1)+Ye.slice(Ke),dt(()=>{Z.selectionStart=Z.selectionEnd=me-1,Z.focus()})):me!==Ke&&(a.value=Ye.slice(0,me)+Ye.slice(Ke),dt(()=>{Z.selectionStart=Z.selectionEnd=me,Z.focus()})),o("update",{originalText:a.value})}}else{const Z=C.value;if(Z&&r.value.length>0){const me=Z.selectionStart||r.value.length,Ke=Z.selectionEnd||r.value.length,Ye=r.value;me===Ke&&me>0?(r.value=Ye.slice(0,me-1)+Ye.slice(Ke),dt(()=>{Z.selectionStart=Z.selectionEnd=me-1,Z.focus()})):me!==Ke&&(r.value=Ye.slice(0,me)+Ye.slice(Ke),dt(()=>{Z.selectionStart=Z.selectionEnd=me,Z.focus()})),o("update",{translatedText:r.value})}}}async function it(){try{const ke=await ms();if(ke.fonts){const Z=[],me=[];for(const Ke of ke.fonts){const Ye={name:typeof Ke=="string"?Ke:Ke.display_name||Ke.file_name||"",path:typeof Ke=="string"?Ke:Ke.path};Ye.path.startsWith("fonts/")?Z.push(Ye):me.push(Ye)}Z.length>0&&(ae.value=Z),Q.value=me}}catch(ke){console.error("åŠ è½½å­—ä½“åˆ—è¡¨å¤±è´¥:",ke)}}return ut(()=>{it()}),(ke,Z)=>(R(),E("div",am,[e("div",lm,[e("div",{class:"text-column-header"},[Z[13]||(Z[13]=e("span",{class:"column-title"},"ğŸ‡¯ğŸ‡µ æ—¥è¯­åŸæ–‡ (OCRç»“æœ)",-1)),e("button",{class:"re-ocr-btn",onClick:Oe,title:"é‡æ–°OCRæ­¤æ°”æ³¡"},"ğŸ”„")]),ne(e("textarea",{ref_key:"originalTextInput",ref:g,"onUpdate:modelValue":Z[0]||(Z[0]=me=>a.value=me),class:"text-editor original-editor",placeholder:"OCRè¯†åˆ«çš„æ—¥è¯­åŸæ–‡...",spellcheck:"false",onInput:c},null,544),[[Se,a.value]]),e("div",{class:"text-actions"},[e("button",{class:"copy-btn",onClick:H},"ğŸ“‹ å¤åˆ¶"),e("button",{class:"keyboard-toggle-btn",onClick:Re,title:"æ˜¾ç¤º/éšè—50éŸ³é”®ç›˜"}," âŒ¨ï¸ 50éŸ³ ")]),ye(sm,{visible:ie.value,"default-target":X.value,onClose:Z[1]||(Z[1]=me=>ie.value=!1),onInsert:Ge,onDelete:at},null,8,["visible","default-target"])]),e("div",im,[e("div",{class:"text-column-header"},[Z[14]||(Z[14]=e("span",{class:"column-title"},"ğŸ‡¨ğŸ‡³ ä¸­æ–‡è¯‘æ–‡",-1)),e("button",{class:"re-translate-btn",onClick:Pe,title:"é‡æ–°ç¿»è¯‘æ­¤æ°”æ³¡"}," ğŸ”„ ")]),ne(e("textarea",{ref_key:"translatedTextInput",ref:C,"onUpdate:modelValue":Z[2]||(Z[2]=me=>r.value=me),class:"text-editor translated-editor",placeholder:"ç¿»è¯‘åçš„ä¸­æ–‡...",spellcheck:"false",onInput:M},null,544),[[Se,r.value]]),e("div",{class:"text-actions"},[e("button",{class:"copy-btn",onClick:$},"ğŸ“‹ å¤åˆ¶"),e("button",{class:"apply-text-btn",onClick:Ie},"âœ“ åº”ç”¨æ–‡æœ¬")])]),e("div",rm,[e("div",um,[e("div",cm,[e("div",dm,[Z[15]||(Z[15]=e("label",null,"å­—ä½“",-1)),ye(Ne,{modelValue:T.value,"onUpdate:modelValue":Z[3]||(Z[3]=me=>T.value=me),groups:x.value,title:"å­—ä½“",onChange:d},null,8,["modelValue","groups"])]),e("div",gm,[Z[16]||(Z[16]=e("label",null,"å­—å·",-1)),e("div",pm,[ne(e("input",{type:"number","onUpdate:modelValue":Z[4]||(Z[4]=me=>h.value=me),class:"toolbar-fontsize-input",min:K(zo),max:K(Oo),step:K(Zt),title:"å­—å·",onChange:O},null,40,mm),[[Se,h.value,void 0,{number:!0}]]),e("div",{class:"toolbar-fontsize-btns"},[e("button",{class:"toolbar-fontsize-btn",onClick:v,title:"å¢å¤§å­—å·"}," A+ "),e("button",{class:"toolbar-fontsize-btn",onClick:F,title:"å‡å°å­—å·"}," A- ")])])])]),e("div",vm,[e("div",fm,[e("button",{class:"toolbar-btn","data-active":S.value==="vertical",onClick:Z[5]||(Z[5]=me=>y("vertical")),title:"ç«–å‘æ’ç‰ˆ"},[...Z[17]||(Z[17]=[e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("path",{d:"M8 2v12M8 2L5 5M8 2l3 3",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])],8,bm),e("button",{class:"toolbar-btn","data-active":S.value==="horizontal",onClick:Z[6]||(Z[6]=me=>y("horizontal")),title:"æ¨ªå‘æ’ç‰ˆ"},[...Z[18]||(Z[18]=[e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("path",{d:"M2 8h12M14 8l-3-3M14 8l-3 3",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])],8,hm)]),Z[24]||(Z[24]=e("div",{class:"toolbar-divider vertical"},null,-1)),e("div",ym,[e("div",xm,[e("button",{class:"toolbar-btn toolbar-color-btn",onClick:ue},[Z[19]||(Z[19]=e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("text",{x:"3",y:"11","font-size":"10","font-weight":"bold",fill:"currentColor"},"A")],-1)),e("span",{class:"color-indicator",style:ot({background:D.value})},null,4)]),ne(e("input",{ref_key:"textColorInput",ref:k,type:"color","onUpdate:modelValue":Z[7]||(Z[7]=me=>D.value=me),class:"hidden-color-input",onInput:L,onChange:L},null,544),[[Se,D.value]])])]),Z[25]||(Z[25]=e("div",{class:"toolbar-divider vertical"},null,-1)),e("div",_m,[ye(Ne,{modelValue:W.value,"onUpdate:modelValue":Z[8]||(Z[8]=me=>W.value=me),options:b,onChange:se},null,8,["modelValue"]),e("div",{class:Te(["toolbar-color-picker toolbar-solid-color-options",{hidden:W.value!=="solid"}])},[e("button",{class:"toolbar-btn toolbar-color-btn",onClick:j},[Z[20]||(Z[20]=e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("rect",{x:"2",y:"2",width:"12",height:"12",rx:"2",fill:"none",stroke:"currentColor","stroke-width":"1.2"}),e("rect",{x:"4",y:"4",width:"8",height:"8",rx:"1",fill:"currentColor",opacity:"0.3"})],-1)),e("span",{class:"color-indicator",style:ot({background:B.value})},null,4)]),ne(e("input",{ref_key:"fillColorInput",ref:V,type:"color","onUpdate:modelValue":Z[9]||(Z[9]=me=>B.value=me),class:"hidden-color-input",onChange:le},null,544),[[Se,B.value]])],2)]),Z[26]||(Z[26]=e("div",{class:"toolbar-divider vertical"},null,-1)),e("div",km,[e("button",{class:"toolbar-btn","data-active":I.value,onClick:Ae,title:"æ–‡å­—æè¾¹"},[...Z[21]||(Z[21]=[e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("text",{x:"3",y:"12","font-size":"11","font-weight":"bold",stroke:"currentColor","stroke-width":"2",fill:"none"}," A "),e("text",{x:"3",y:"12","font-size":"11","font-weight":"bold",fill:"currentColor"},"A")],-1)])],8,Cm),e("div",{class:Te(["toolbar-color-picker toolbar-stroke-options",{hidden:!I.value}]),title:"æè¾¹é¢œè‰²"},[e("button",{class:"toolbar-btn toolbar-color-btn",onClick:he},[Z[22]||(Z[22]=e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("circle",{cx:"8",cy:"8",r:"5",fill:"none",stroke:"currentColor","stroke-width":"2"})],-1)),e("span",{class:"color-indicator",style:ot({background:A.value})},null,4)]),ne(e("input",{ref_key:"strokeColorInput",ref:Y,type:"color","onUpdate:modelValue":Z[10]||(Z[10]=me=>A.value=me),class:"hidden-color-input",onChange:$e},null,544),[[Se,A.value]])],2),e("div",{class:Te(["toolbar-stroke-width toolbar-stroke-options",{hidden:!I.value}]),title:"æè¾¹å®½åº¦"},[ne(e("input",{type:"number","onUpdate:modelValue":Z[11]||(Z[11]=me=>w.value=me),class:"toolbar-mini-input",min:"0",max:"10",onChange:Me},null,544),[[Se,w.value,void 0,{number:!0}]]),Z[23]||(Z[23]=e("span",{class:"toolbar-unit"},"px",-1))],2)])]),e("div",Sm,[e("div",wm,[e("button",{class:"toolbar-btn",onClick:z,title:"é€†æ—¶é’ˆæ—‹è½¬"},[...Z[27]||(Z[27]=[e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("path",{d:"M2 8a6 6 0 1 1 1.5 4",stroke:"currentColor","stroke-width":"1.5",fill:"none"}),e("path",{d:"M2 5v3.5h3.5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),ne(e("input",{type:"number","onUpdate:modelValue":Z[12]||(Z[12]=me=>N.value=me),class:"toolbar-mini-input toolbar-rotation-input",min:"-180",max:"180",step:"5",onChange:J},null,544),[[Se,N.value,void 0,{number:!0}]]),Z[29]||(Z[29]=e("span",{class:"toolbar-unit"},"Â°",-1)),e("button",{class:"toolbar-btn",onClick:te,title:"é¡ºæ—¶é’ˆæ—‹è½¬"},[...Z[28]||(Z[28]=[e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("path",{d:"M14 8a6 6 0 1 0-1.5 4",stroke:"currentColor","stroke-width":"1.5",fill:"none"}),e("path",{d:"M14 5v3.5h-3.5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),e("button",{class:"toolbar-btn toolbar-small-btn",onClick:ee,title:"é‡ç½®æ—‹è½¬"}," 0 ")]),Z[35]||(Z[35]=e("div",{class:"toolbar-divider vertical"},null,-1)),e("div",$m,[e("button",{class:"toolbar-btn",onClick:ce,title:"å·¦ç§»"},[...Z[30]||(Z[30]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("path",{d:"M10 3L5 8l5 5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),e("button",{class:"toolbar-btn",onClick:ve,title:"å³ç§»"},[...Z[31]||(Z[31]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("path",{d:"M6 3l5 5-5 5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),e("button",{class:"toolbar-btn",onClick:_e,title:"ä¸Šç§»"},[...Z[32]||(Z[32]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("path",{d:"M3 10l5-5 5 5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),e("button",{class:"toolbar-btn",onClick:be,title:"ä¸‹ç§»"},[...Z[33]||(Z[33]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("path",{d:"M3 6l5 5 5-5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),e("span",Tm,[e("span",null,oe(p.value),1),Z[34]||(Z[34]=Ce(",",-1)),e("span",null,oe(m.value),1)]),e("button",{class:"toolbar-btn toolbar-small-btn",onClick:pe,title:"é‡ç½®ä½ç½®"}," âŒ‚ ")])])]),e("details",Im,[Z[36]||(Z[36]=e("summary",null,"å­—å·é¢„è®¾",-1)),e("div",Rm,[(R(!0),E(Be,null,He(K(Jn),me=>(R(),E("button",{key:me,class:Te(["preset-btn",{active:h.value===me}]),onClick:Ke=>P(me)},oe(me),11,Pm))),128))])]),e("div",{class:"edit-action-buttons"},[e("button",{class:"btn-apply",onClick:Ie},"åº”ç”¨"),e("button",{class:"btn-apply-all",onClick:we},"åº”ç”¨å…¨éƒ¨"),e("button",{class:"btn-reset",onClick:Ve},"é‡ç½®")])])]))}}),Mm=je(Dm,[["__scopeId","data-v-ea49fb5e"]]),Em={class:"edit-toolbar-wrapper"},Bm={class:"edit-toolbar toolbar-row-1"},Am={class:"image-navigator"},Lm=["disabled"],Fm=["disabled"],Um={class:"bubble-navigator"},Om=["disabled"],zm={class:"bubble-indicator"},Nm={id:"currentBubbleNum"},Vm={id:"totalBubbleNum"},Wm=["disabled"],Km={class:"view-controls"},qm={key:0,viewBox:"0 0 20 20",width:"16",height:"16"},Hm={key:1,viewBox:"0 0 20 20",width:"16",height:"16"},jm={id:"zoomLevel"},Jm={class:"edit-toolbar toolbar-row-2"},Gm={class:"annotation-tools"},Ym=["disabled"],Xm=["disabled"],Zm={key:0,class:"brush-size-indicator"},Qm={key:1,class:"brush-mode-hint"},ev={class:"edit-progress-info"},tv={class:"edit-progress-text"},ov={class:"edit-progress-count"},nv={class:"edit-progress-bar"},sv={class:"quick-actions"},av=Je({__name:"EditToolbar",props:{currentImageIndex:{},imageCount:{},canGoPrevious:{type:Boolean},canGoNext:{type:Boolean},showThumbnails:{type:Boolean},hasBubbles:{type:Boolean},selectedBubbleIndex:{},bubbleCount:{},layoutMode:{},syncEnabled:{type:Boolean},scale:{},isDrawingMode:{type:Boolean},hasSelection:{type:Boolean},brushMode:{},brushSize:{},mouseX:{},mouseY:{},isProcessing:{type:Boolean},progressText:{},progressCurrent:{},progressTotal:{}},emits:["go-previous-image","go-next-image","toggle-thumbnails","select-previous-bubble","select-next-bubble","toggle-layout","toggle-view-mode","toggle-sync","fit-to-screen","zoom-in","zoom-out","reset-zoom","exit-edit-mode","auto-detect-bubbles","detect-all-images","translate-with-bubbles","toggle-drawing-mode","delete-selected-bubbles","repair-selected-bubble","activate-repair-brush","activate-restore-brush","apply-and-next"],setup(s){const t=s,n=q(()=>t.progressTotal===0?0:Math.round(t.progressCurrent/t.progressTotal*100)),o=q(()=>t.progressTotal>0&&t.progressCurrent>=t.progressTotal),l=q(()=>{const i=t.brushMode==="repair"?{fill:"rgba(76, 175, 80, 0.4)",border:"#4CAF50"}:{fill:"rgba(33, 150, 243, 0.4)",border:"#2196F3"};return{position:"fixed",left:`${t.mouseX}px`,top:`${t.mouseY}px`,width:`${t.brushSize}px`,height:`${t.brushSize}px`,borderRadius:"50%",border:`2px solid ${i.border}`,backgroundColor:i.fill,pointerEvents:"none",zIndex:99999,transform:"translate(-50%, -50%)",display:t.brushMode?"block":"none"}});return(i,a)=>(R(),E("div",Em,[e("div",Bm,[e("div",Am,[e("button",{class:"nav-btn",disabled:!s.canGoPrevious,onClick:a[0]||(a[0]=r=>i.$emit("go-previous-image")),title:"ä¸Šä¸€å¼ å›¾ç‰‡ (PageUp)"}," â—€â—€ ",8,Lm),e("span",{class:"image-indicator",onClick:a[1]||(a[1]=r=>i.$emit("toggle-thumbnails")),title:"ç‚¹å‡»å±•å¼€ç¼©ç•¥å›¾"},[a[23]||(a[23]=Ce(" å›¾ ",-1)),e("span",null,oe(s.currentImageIndex+1),1),a[24]||(a[24]=Ce(" / ",-1)),e("span",null,oe(s.imageCount),1)]),e("button",{class:"nav-btn",disabled:!s.canGoNext,onClick:a[2]||(a[2]=r=>i.$emit("go-next-image")),title:"ä¸‹ä¸€å¼ å›¾ç‰‡ (PageDown)"}," â–¶â–¶ ",8,Fm),e("button",{class:Te(["thumb-toggle-btn",{active:s.showThumbnails}]),onClick:a[3]||(a[3]=r=>i.$emit("toggle-thumbnails")),title:"æ˜¾ç¤º/éšè—ç¼©ç•¥å›¾"}," â˜· ",2)]),a[30]||(a[30]=e("div",{class:"toolbar-divider"},null,-1)),e("div",Um,[e("button",{id:"prevBubbleBtn",class:"nav-btn",disabled:!s.hasBubbles||s.selectedBubbleIndex<=0,onClick:a[4]||(a[4]=r=>i.$emit("select-previous-bubble")),title:"ä¸Šä¸€ä¸ªæ°”æ³¡ (â†)"}," â—€ ",8,Om),e("span",zm,[a[25]||(a[25]=Ce(" æ°”æ³¡ ",-1)),e("span",Nm,oe(s.selectedBubbleIndex>=0?s.selectedBubbleIndex+1:0),1),a[26]||(a[26]=Ce(" / ",-1)),e("span",Vm,oe(s.bubbleCount),1)]),e("button",{id:"nextBubbleBtn",class:"nav-btn",disabled:!s.hasBubbles||s.selectedBubbleIndex>=s.bubbleCount-1,onClick:a[5]||(a[5]=r=>i.$emit("select-next-bubble")),title:"ä¸‹ä¸€ä¸ªæ°”æ³¡ (â†’)"}," â–¶ ",8,Wm)]),a[31]||(a[31]=e("div",{class:"toolbar-divider"},null,-1)),e("div",Km,[e("button",{class:"layout-toggle-btn",onClick:a[6]||(a[6]=r=>i.$emit("toggle-layout")),title:"åˆ‡æ¢å¸ƒå±€ï¼šå·¦å³/ä¸Šä¸‹"},[s.layoutMode==="horizontal"?(R(),E("svg",qm,[...a[27]||(a[27]=[e("rect",{x:"1",y:"2",width:"8",height:"16",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"},null,-1),e("rect",{x:"11",y:"2",width:"8",height:"16",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"},null,-1)])])):(R(),E("svg",Hm,[...a[28]||(a[28]=[e("rect",{x:"2",y:"1",width:"16",height:"8",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"},null,-1),e("rect",{x:"2",y:"11",width:"16",height:"8",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"},null,-1)])]))]),e("button",{class:"view-mode-btn",onClick:a[7]||(a[7]=r=>i.$emit("toggle-view-mode")),title:"åˆ‡æ¢è§†å›¾æ¨¡å¼"},[...a[29]||(a[29]=[e("span",{class:"dual-icon"},"â§‰",-1)])]),e("button",{class:Te({active:s.syncEnabled}),onClick:a[8]||(a[8]=r=>i.$emit("toggle-sync")),title:"åŒæ­¥ç¼©æ”¾/æ‹–åŠ¨",style:{"font-size":"12px"}}," ğŸ”— ",2),e("button",{onClick:a[9]||(a[9]=r=>i.$emit("fit-to-screen")),title:"é€‚åº”å±å¹• (åŒå‡»)"},"â›¶"),e("button",{onClick:a[10]||(a[10]=r=>i.$emit("zoom-in")),title:"æ”¾å¤§ (+)"},"+"),e("span",jm,oe(Math.round(s.scale*100))+"%",1),e("button",{onClick:a[11]||(a[11]=r=>i.$emit("zoom-out")),title:"ç¼©å° (-)"},"âˆ’"),e("button",{onClick:a[12]||(a[12]=r=>i.$emit("reset-zoom")),title:"åŸå§‹å¤§å°"},"1:1")]),a[32]||(a[32]=e("div",{class:"toolbar-spacer"},null,-1)),e("button",{class:"secondary-btn",onClick:a[13]||(a[13]=r=>i.$emit("exit-edit-mode"))},"é€€å‡ºç¼–è¾‘")]),e("div",Jm,[e("div",Gm,[e("button",{class:"annotation-btn detect-btn",onClick:a[14]||(a[14]=r=>i.$emit("auto-detect-bubbles")),title:"è‡ªåŠ¨æ£€æµ‹å½“å‰å›¾ç‰‡çš„æ–‡æœ¬æ¡†"},[...a[33]||(a[33]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("circle",{cx:"6",cy:"6",r:"4",fill:"none",stroke:"currentColor","stroke-width":"1.5"}),e("path",{d:"M9 9l4 4",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round"})],-1),e("span",null,"æ£€æµ‹",-1)])]),e("button",{class:"annotation-btn detect-btn",onClick:a[15]||(a[15]=r=>i.$emit("detect-all-images")),title:"æ‰¹é‡æ£€æµ‹æ‰€æœ‰å›¾ç‰‡"},[...a[34]||(a[34]=[oo('<svg viewBox="0 0 16 16" width="14" height="14" data-v-b7164359><circle cx="5" cy="5" r="2.5" fill="none" stroke="currentColor" stroke-width="1" data-v-b7164359></circle><path d="M7 7l2 2" stroke="currentColor" stroke-width="1" stroke-linecap="round" data-v-b7164359></path><circle cx="10" cy="10" r="2.5" fill="none" stroke="currentColor" stroke-width="1" data-v-b7164359></circle><path d="M12 12l2 2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" data-v-b7164359></path></svg><span data-v-b7164359>æ‰¹é‡æ£€æµ‹</span>',2)])]),e("button",{class:"annotation-btn primary-action-btn",onClick:a[16]||(a[16]=r=>i.$emit("translate-with-bubbles")),title:"ä½¿ç”¨å½“å‰æ–‡æœ¬æ¡†ç¿»è¯‘æ­¤å›¾ç‰‡"},[...a[35]||(a[35]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("path",{d:"M2 3h5M4.5 3v7M2 6h5",stroke:"currentColor","stroke-width":"1.2",fill:"none"}),e("path",{d:"M9 13l2-7 2 7M9.5 11h3",stroke:"currentColor","stroke-width":"1.2",fill:"none"})],-1),e("span",null,"ç¿»è¯‘",-1)])]),a[41]||(a[41]=e("div",{class:"toolbar-divider"},null,-1)),e("button",{class:Te(["annotation-btn",{active:s.isDrawingMode}]),onClick:a[17]||(a[17]=r=>i.$emit("toggle-drawing-mode")),title:"æ·»åŠ æ°”æ³¡æ¡†ï¼ˆæˆ–ä¸­é”®æ‹–æ‹½ç»˜åˆ¶ï¼‰"},[...a[36]||(a[36]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("rect",{x:"3",y:"3",width:"10",height:"10",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"}),e("path",{d:"M8 5v6M5 8h6",stroke:"currentColor","stroke-width":"1.5"})],-1),e("span",null,"æ·»åŠ ",-1)])],2),e("button",{class:"annotation-btn",disabled:!s.hasSelection,onClick:a[18]||(a[18]=r=>i.$emit("delete-selected-bubbles")),title:"åˆ é™¤é€‰ä¸­æ°”æ³¡æ¡† (Delete)"},[...a[37]||(a[37]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("rect",{x:"3",y:"3",width:"10",height:"10",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"}),e("path",{d:"M5 8h6",stroke:"currentColor","stroke-width":"1.5"})],-1),e("span",null,"åˆ é™¤",-1)])],8,Ym),e("button",{class:"annotation-btn",disabled:!s.hasSelection,onClick:a[19]||(a[19]=r=>i.$emit("repair-selected-bubble")),title:"ä¿®å¤é€‰ä¸­æ°”æ³¡èƒŒæ™¯ (R)"},[...a[38]||(a[38]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("path",{d:"M2 14l3-3m0 0l6-6 3 3-6 6m-3 0l-1 1 1-1z",fill:"none",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round"}),e("path",{d:"M11 5l-1-1 2-2 2 2-2 2-1-1z",fill:"currentColor"})],-1),e("span",null,"ä¿®å¤",-1)])],8,Xm),a[42]||(a[42]=e("div",{class:"toolbar-divider"},null,-1)),e("button",{class:Te(["annotation-btn brush-btn",{active:s.brushMode==="repair"}]),onClick:a[20]||(a[20]=r=>i.$emit("activate-repair-brush")),title:"ä¿®å¤ç¬”åˆ· (æŒ‰ä½R+å·¦é”®æ‹–æ‹½)"},[...a[39]||(a[39]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("circle",{cx:"8",cy:"8",r:"5",fill:"none",stroke:"currentColor","stroke-width":"1.5"}),e("circle",{cx:"8",cy:"8",r:"2",fill:"currentColor"})],-1),e("span",null,"ä¿®å¤ç¬”åˆ·",-1)])],2),e("button",{class:Te(["annotation-btn brush-btn",{active:s.brushMode==="restore"}]),onClick:a[21]||(a[21]=r=>i.$emit("activate-restore-brush")),title:"è¿˜åŸç¬”åˆ· (æŒ‰ä½U+å·¦é”®æ‹–æ‹½)"},[...a[40]||(a[40]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("circle",{cx:"8",cy:"8",r:"5",fill:"none",stroke:"currentColor","stroke-width":"1.5"}),e("path",{d:"M5 8h6M8 5v6",stroke:"currentColor","stroke-width":"1",transform:"rotate(45 8 8)"})],-1),e("span",null,"è¿˜åŸç¬”åˆ·",-1)])],2),s.brushMode?(R(),E("span",Zm," ç¬”åˆ·: "+oe(s.brushSize)+"px ",1)):ge("",!0),a[43]||(a[43]=oo('<div class="help-tooltip-container" data-v-b7164359><button class="help-tooltip-btn" title="å¿«æ·é”®æ“ä½œå¸®åŠ©" data-v-b7164359><svg viewBox="0 0 16 16" width="14" height="14" data-v-b7164359><circle cx="8" cy="8" r="6.5" fill="none" stroke="currentColor" stroke-width="1.2" data-v-b7164359></circle><text x="8" y="11" text-anchor="middle" font-size="9" font-weight="bold" fill="currentColor" data-v-b7164359>?</text></svg><span class="help-btn-text" data-v-b7164359>å¿«æ·é”®</span></button><div class="help-tooltip-popup" data-v-b7164359><div class="help-section" data-v-b7164359><div class="help-title" data-v-b7164359>ğŸ–±ï¸ é¼ æ ‡æ“ä½œ</div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>å·¦é”®ç‚¹å‡»æ°”æ³¡</span><span class="help-desc" data-v-b7164359>é€‰æ‹©æ°”æ³¡</span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>Shift+å·¦é”®ç‚¹å‡»</span><span class="help-desc" data-v-b7164359>å¤šé€‰æ°”æ³¡</span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>å·¦é”®æ‹–æ‹½å››è§’/è¾¹</span><span class="help-desc" data-v-b7164359>è°ƒæ•´å¤§å°</span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>å·¦é”®æ‹–æ‹½æ¡†å†…éƒ¨</span><span class="help-desc" data-v-b7164359>ç§»åŠ¨æ°”æ³¡æ¡†</span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>ä¸­é”®æ‹–æ‹½</span><span class="help-desc" data-v-b7164359>ç»˜åˆ¶æ–°æ°”æ³¡æ¡†</span></div></div><div class="help-section" data-v-b7164359><div class="help-title" data-v-b7164359>âŒ¨ï¸ å¿«æ·é”®</div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>A / D</span><span class="help-desc" data-v-b7164359>åˆ‡æ¢ä¸Š/ä¸‹ä¸€å¼ å›¾ç‰‡</span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>Ctrl+Enter</span><span class="help-desc" data-v-b7164359>åº”ç”¨å¹¶è·³è½¬ä¸‹ä¸€å¼ </span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>Delete / Backspace</span><span class="help-desc" data-v-b7164359>åˆ é™¤é€‰ä¸­æ°”æ³¡</span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>æŒ‰ä½R+å·¦é”®æ‹–æ‹½</span><span class="help-desc" data-v-b7164359>ä¿®å¤ç¬”åˆ·</span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>æŒ‰ä½U+å·¦é”®æ‹–æ‹½</span><span class="help-desc" data-v-b7164359>è¿˜åŸç¬”åˆ·</span></div><div class="help-item" data-v-b7164359><span class="help-key" data-v-b7164359>ç¬”åˆ·æ¨¡å¼ä¸‹æ»šè½®</span><span class="help-desc" data-v-b7164359>è°ƒæ•´ç¬”åˆ·å¤§å°</span></div></div></div></div>',1))]),s.brushMode?(R(),E("div",{key:0,class:"brush-cursor",style:ot(l.value)},null,4)):ge("",!0),s.brushMode?(R(),E("div",Qm,oe(s.brushMode==="repair"?"ä¿®å¤ç¬”åˆ· (R)":"è¿˜åŸç¬”åˆ· (U)")+" - æ»šè½®è°ƒæ•´å¤§å° ",1)):ge("",!0),s.isProcessing?(R(),E("div",{key:2,class:Te(["edit-progress-container",{completed:o.value}])},[e("div",ev,[e("span",tv,oe(s.progressText),1),e("span",ov,oe(s.progressCurrent)+"/"+oe(s.progressTotal),1)]),e("div",nv,[e("div",{class:Te(["edit-progress-fill",{animating:!o.value}]),style:ot({width:n.value+"%"})},null,6)])],2)):ge("",!0),a[44]||(a[44]=e("div",{class:"toolbar-spacer"},null,-1)),e("div",sv,[e("button",{class:"primary-btn",onClick:a[22]||(a[22]=r=>i.$emit("apply-and-next")),title:"åº”ç”¨æ›´æ”¹å¹¶è·³è½¬ä¸‹ä¸€å¼  (Ctrl+Enter)"}," åº”ç”¨å¹¶ä¸‹ä¸€å¼  ")])])]))}}),lv=je(av,[["__scopeId","data-v-b7164359"]]),iv={key:0,class:"edit-thumbnails-panel"},rv={class:"thumbnails-scroll"},uv=["onClick"],cv=["src","alt"],dv={class:"thumb-index"},gv=Je({__name:"EditThumbnailPanel",props:{visible:{type:Boolean},images:{},currentImageIndex:{}},emits:["switch-to-image"],setup(s){return(t,n)=>s.visible?(R(),E("div",iv,[e("div",rv,[(R(!0),E(Be,null,He(s.images,(o,l)=>(R(),E("div",{key:o.id,class:Te(["edit-thumbnail-item",{active:l===s.currentImageIndex}]),onClick:i=>t.$emit("switch-to-image",l)},[e("img",{src:o.translatedDataURL||o.originalDataURL,alt:`å›¾ç‰‡ ${l+1}`},null,8,cv),e("span",dv,oe(l+1),1)],10,uv))),128))])])):ge("",!0)}}),pv=je(gv,[["__scopeId","data-v-9d2a43d9"]]),mv={class:"edit-main-layout"},vv={class:"image-comparison-container"},fv={class:"panel-header"},bv=["src"],hv={class:"panel-header"},yv=["src"],xv=Je({__name:"EditWorkspace",props:{isEditModeActive:{type:Boolean}},emits:["exit"],setup(s,{emit:t}){const n=s,o=t,l=Qe(),i=ct(),{translateWithCurrentBubbles:a}=po(),{reRenderFullImage:r}=yp({onRenderStart:()=>console.log("å¼€å§‹é‡æ–°æ¸²æŸ“..."),onRenderSuccess:G=>console.log("æ¸²æŸ“æˆåŠŸ:",G.substring(0,50)+"..."),onRenderError:G=>console.error("æ¸²æŸ“å¤±è´¥:",G)}),{isDrawingMode:h,isDrawingBox:T,currentDrawingRect:S,isMiddleButtonDown:D,handleBubbleSelect:B,handleBubbleMultiSelect:I,handleClearMultiSelect:A,handleBubbleDragStart:w,handleBubbleDragging:N,handleBubbleDragEnd:W,handleBubbleResizeStart:U,handleBubbleResizing:f,handleBubbleResizeEnd:g,handleBubbleRotateStart:C,handleBubbleRotating:k,handleBubbleRotateEnd:V,toggleDrawingMode:Y,handleDrawBubble:ie,getDrawingRectStyle:X,handleBubbleUpdate:ae,deleteSelectedBubbles:Q,repairSelectedBubble:p,handleOcrRecognize:m}=hp({onReRender:()=>r(),onDelayedPreview:()=>r()}),x=_(0),b=_(0),{brushMode:u,brushSize:c,mouseX:M,mouseY:H,isBrushKeyDown:$,toggleBrushMode:O,exitBrushMode:P,startBrushPainting:v,continueBrushPainting:F,finishBrushPainting:d,adjustBrushSize:y}=fp({onBrushComplete:()=>r(),getCurrentRepairSettings:()=>({inpaintMethod:ke.value,fillColor:Z.value})}),{images:ue,currentImageIndex:L,currentImage:j,imageCount:le,canGoPrevious:he,canGoNext:$e}=xt(l),{bubbles:Ae,selectedIndex:Me,selectedIndices:se,selectedBubble:J,bubbleCount:z,hasBubbles:te,hasSelection:ee}=xt(i),ce=q(()=>pe.value?.querySelector("img")?.naturalWidth||2e3),ve=q(()=>pe.value?.querySelector("img")?.naturalHeight||2e3),_e=_(null),be=_(null),pe=_(null),Ie=_(null),we=_(null),Ve=_(null),Oe=_("dual"),Pe=_("horizontal"),Re=_(!1),Ge=_(!0),at=_(!1),it=_(!1),ke=_("solid"),Z=_("#FFFFFF"),me=_(!1),Ke=_("å¤„ç†ä¸­..."),Ye=_(0),vt=_(0),nt=Zo(),Xe=Zo(),Ut=q(()=>Xe.scale.value),hn=q(()=>Xe.translateX.value),yn=q(()=>Xe.translateY.value),xn=q(()=>nt.scale.value),bt=_(null),_n=q(()=>({transform:`translate(${nt.translateX.value}px, ${nt.translateY.value}px) scale(${nt.scale.value})`})),kn=q(()=>({transform:`translate(${Xe.translateX.value}px, ${Xe.translateY.value}px) scale(${Xe.scale.value})`}));function mo(){Xe.zoomIn(),Ge.value&&nt.setTransform(Xe.getTransform())}function vo(){Xe.zoomOut(),Ge.value&&nt.setTransform(Xe.getTransform())}function fo(){Xe.resetZoom(),Ge.value&&nt.setTransform(Xe.getTransform())}const Ot=_(!1),Cn=_(0),zt=_(!1),$t=_({x:0,y:0,size:0});function Nt(){u.value&&P(),Kt()}function Vt(){i.bubbles.length>0&&i.selectBubble(0)}function bo(){he.value&&(Nt(),l.goToPrevious())}function Wt(){$e.value&&(Nt(),l.goToNext())}function Sn(G){G!==L.value&&G>=0&&G<le.value&&(Nt(),l.setCurrentImageIndex(G))}function Kt(){if(!j.value)return;const G=Array.isArray(j.value.bubbleStates);Ae.value.length>0?(l.updateCurrentBubbleStates([...Ae.value]),l.setManuallyAnnotated(!0),console.log("å·²ä¿å­˜æ°”æ³¡çŠ¶æ€åˆ°å½“å‰å›¾ç‰‡ï¼Œæ ‡è®°ä¸ºæ‰‹åŠ¨æ ‡æ³¨")):G&&(l.updateCurrentBubbleStates([]),l.setManuallyAnnotated(!0),console.log("å·²ä¿å­˜ç©ºæ°”æ³¡çŠ¶æ€åˆ°å½“å‰å›¾ç‰‡ï¼ˆç”¨æˆ·ä¸»åŠ¨æ¸…ç©ºï¼Œæ ‡è®°ä¸ºæ‰‹åŠ¨æ ‡æ³¨ï¼‰"))}function Tt(){j.value?.bubbleStates?(i.setBubbles([...j.value.bubbleStates],!0),console.log(`å·²åŠ è½½ ${j.value.bubbleStates.length} ä¸ªæ°”æ³¡çŠ¶æ€`)):i.clearBubblesLocal(),Vt()}function wn(){i.selectPrevious()}function $n(){i.selectNext()}function Tn(){Re.value=!Re.value}function In(){Pe.value=Pe.value==="horizontal"?"vertical":"horizontal";try{localStorage.setItem(No,Pe.value)}catch(G){console.warn("ä¿å­˜å¸ƒå±€æ¨¡å¼å¤±è´¥:",G)}setTimeout(()=>{It()},300)}function Rn(){const G=["dual","original","translated"],re=G.indexOf(Oe.value),de=G[(re+1)%G.length];de&&(Oe.value=de)}function Pn(){Ge.value=!Ge.value,console.log("åŒå›¾åŒæ­¥:",Ge.value?"å¼€å¯":"å…³é—­"),Ge.value&&nt.setTransform(Xe.getTransform())}function It(){const G=Ie.value||be.value,re=we.value||pe.value;if(!G||!re)return;const de=re.querySelector("img");if(!de||!de.naturalWidth)return;const qe=G.getBoundingClientRect(),Le=qe.width/de.naturalWidth,De=qe.height/de.naturalHeight,ze=Math.min(Le,De)*.95,Ee=(qe.width-de.naturalWidth*ze)/2,ft=(qe.height-de.naturalHeight*ze)/2,ht={scale:ze,translateX:Ee,translateY:ft};Xe.setTransform(ht),nt.setTransform(ht)}function ho(G,re){if(u.value){const Ee=G.deltaY>0?-5:5;y(Ee);return}const de=G.currentTarget.getBoundingClientRect(),qe=G.clientX-de.left,Le=G.clientY-de.top,De=G.deltaY>0?.9:1.1,ze=re==="original"?nt:Xe;ze.zoomAt(qe,Le,De),Ge.value&&(re==="original"?Xe:nt).setTransform(ze.getTransform())}function yo(G,re){if(u.value){const de=re==="original"?be.value:Ie.value;de&&v(G,de);return}if(G.button===1){D.value=!0,ko(G,re),G.preventDefault();return}if(h.value&&G.button===0){ko(G,re),G.preventDefault();return}if(G.button===0){if(G.target.closest(".bubble-highlight-box"))return;G.shiftKey||A(),bt.value=re,(re==="original"?nt:Xe).startDrag(G.clientX,G.clientY),document.addEventListener("mousemove",xo),document.addEventListener("mouseup",_o),G.preventDefault()}}function xo(G){if(!bt.value)return;const re=bt.value==="original"?nt:Xe;re.drag(G.clientX,G.clientY),Ge.value&&(bt.value==="original"?Xe:nt).setTransform(re.getTransform())}function _o(){bt.value&&(bt.value==="original"?nt:Xe).endDrag(),bt.value=null,document.removeEventListener("mousemove",xo),document.removeEventListener("mouseup",_o)}let qt="translated";function ko(G,re="translated"){qt=re;const de=re==="original"?pe.value:we.value,qe=re==="original"?nt:Xe;if(!de)return;const Le=de.getBoundingClientRect(),De=(G.clientX-Le.left)/qe.scale.value,ze=(G.clientY-Le.top)/qe.scale.value;x.value=De,b.value=ze,T.value=!0,S.value=[De,ze,De,ze],document.addEventListener("mousemove",Ht),document.addEventListener("mouseup",jt)}function Ht(G){if(!T.value)return;const re=qt==="original"?pe.value:we.value,de=qt==="original"?nt:Xe;if(!re)return;const qe=re.getBoundingClientRect(),Le=(G.clientX-qe.left)/de.scale.value,De=(G.clientY-qe.top)/de.scale.value;S.value=[Math.min(x.value,Le),Math.min(b.value,De),Math.max(x.value,Le),Math.max(b.value,De)]}function jt(G){document.removeEventListener("mousemove",Ht),document.removeEventListener("mouseup",jt);const re=D.value;if(!T.value||!S.value){T.value=!1,S.value=null,D.value=!1;return}const[de,qe,Le,De]=S.value,ze=Le-de,Ee=De-qe;ze>10&&Ee>10&&(i.addBubble(S.value),i.selectBubble(i.bubbleCount-1),console.log("å·²æ·»åŠ æ–°æ°”æ³¡:",S.value)),T.value=!1,S.value=null,D.value=!1,!re&&h.value&&(h.value=!1)}function Co(G){console.log(`${G} å›¾ç‰‡åŠ è½½å®Œæˆ`),Ut.value===1&&hn.value===0&&yn.value===0&&dt(()=>{It()})}function Dn(){r()}function Mn(G){G.inpaintMethod!==void 0&&(ke.value=G.inpaintMethod),G.fillColor!==void 0&&(Z.value=G.fillColor),Me.value>=0&&ae(G)}function En(G){fe("æ–‡æœ¬å·²åº”ç”¨","success"),r()}function Bn(G){const re=i.initialStates[G];if(!re){console.warn(`æ— æ³•é‡ç½®æ°”æ³¡ #${G+1}ï¼šæ‰¾ä¸åˆ°åˆå§‹çŠ¶æ€`),fe("æ— æ³•é‡ç½®ï¼šæ‰¾ä¸åˆ°åˆå§‹çŠ¶æ€","warning");return}const de=JSON.parse(JSON.stringify(re));i.updateBubble(G,de),console.log(`æ°”æ³¡ #${G+1} å·²é‡ç½®åˆ°åˆå§‹çŠ¶æ€`),fe("æ°”æ³¡å·²é‡ç½®","success"),r()}async function An(G){const re=Ae.value[G];if(!re?.originalText){console.warn("æ— æ³•é‡æ–°ç¿»è¯‘ï¼šç¼ºå°‘æ°”æ³¡æˆ–åŸæ–‡");return}try{console.log(`å¼€å§‹é‡æ–°ç¿»è¯‘æ°”æ³¡ #${G+1}`);const{translateSingleText:de}=await lt(async()=>{const{translateSingleText:ze}=await Promise.resolve().then(()=>hs);return{translateSingleText:ze}},void 0),{useSettingsStore:qe}=await lt(async()=>{const{useSettingsStore:ze}=await import("./system.DJNGJ5SO.js").then(Ee=>Ee.s);return{useSettingsStore:ze}},__vite__mapDeps([0,1,2,3,4,5])),Le=qe().settings,De=await de({original_text:re.originalText,model_provider:Le.translation.provider,api_key:Le.translation.apiKey,model_name:Le.translation.modelName,custom_base_url:Le.translation.customBaseUrl,target_language:Le.targetLanguage,prompt_content:Le.translatePrompt});De.success&&De.data?.translated_text?(i.updateBubble(G,{translatedText:De.data.translated_text}),console.log(`ç¿»è¯‘æˆåŠŸ: "${De.data.translated_text}"`),r()):console.error("ç¿»è¯‘å¤±è´¥:",De.error||"æœªçŸ¥é”™è¯¯")}catch(de){console.error("ç¿»è¯‘å‡ºé”™:",de)}}function So(G,re){for(G.bubbleTexts||(G.bubbleTexts=[]),G.originalTexts||(G.originalTexts=[]);G.bubbleTexts.length<re;)G.bubbleTexts.push("");for(;G.originalTexts.length<re;)G.originalTexts.push("")}function wo(G,re,de){const qe=G.auto_directions||[];return G.bubble_coords.map((Le,De)=>{const ze=Le[0]??0,Ee=Le[1]??0,ft=Le[2]??0,ht=Le[3]??0;let gt;return qe[De]?gt=qe[De]==="v"?"vertical":"horizontal":gt=ht-Ee>ft-ze?"vertical":"horizontal",{coords:Le,originalText:re.originalTexts?.[De]||"",translatedText:re.bubbleTexts?.[De]||"",textboxText:"",fontSize:de.fontSize,fontFamily:de.fontFamily,textDirection:gt,autoTextDirection:gt,textColor:de.textColor,fillColor:de.fillColor,strokeEnabled:de.strokeEnabled,strokeColor:de.strokeColor,strokeWidth:de.strokeWidth,rotationAngle:G.bubble_angles?.[De]||0,inpaintMethod:de.inpaintMethod,position:{x:0,y:0},polygon:[]}})}async function Ln(){const G=j.value;if(!G?.originalDataURL){fe("æ²¡æœ‰æœ‰æ•ˆçš„å›¾ç‰‡ç”¨äºæ£€æµ‹","warning");return}try{fe("æ­£åœ¨è‡ªåŠ¨æ£€æµ‹æ–‡æœ¬æ¡†...","info");const de=G.originalDataURL.match(/^data:image\/[^;]+;base64,(.+)$/)?.[1]||"";if(!de){fe("æ— æ³•è§£æå›¾ç‰‡æ•°æ®","error");return}const qe=Ue(),{textDetector:Le,boxExpand:De,textStyle:ze}=qe.settings,Ee=await no(de,Le,{box_expand_ratio:De.ratio,box_expand_top:De.top,box_expand_bottom:De.bottom,box_expand_left:De.left,box_expand_right:De.right});if(Ee.success&&Ee.bubble_coords){l.updateCurrentImage({bubbleCoords:Ee.bubble_coords,bubbleAngles:Ee.bubble_angles||[]}),So(G,Ee.bubble_coords.length);const ft={bubble_coords:Ee.bubble_coords.map(gt=>[...gt]),bubble_angles:Ee.bubble_angles,auto_directions:Ee.auto_directions},ht=wo(ft,G,ze);i.setBubbles(ht),Vt(),fe(`è‡ªåŠ¨æ£€æµ‹åˆ° ${Ee.bubble_coords.length} ä¸ªæ–‡æœ¬æ¡†`,"success")}else fe(Ee.error||"æ£€æµ‹å¤±è´¥","error")}catch(re){console.error("è‡ªåŠ¨æ£€æµ‹å¤±è´¥:",re),fe("è‡ªåŠ¨æ£€æµ‹å¤±è´¥","error")}}async function Fn(){if(ue.value.length<=1){fe("è‡³å°‘éœ€è¦ä¸¤å¼ å›¾ç‰‡æ‰èƒ½æ‰§è¡Œæ‰¹é‡æ£€æµ‹","warning");return}if(!confirm("æ­¤æ“ä½œå°†å¯¹æ‰€æœ‰å›¾ç‰‡è¿›è¡Œæ–‡æœ¬æ¡†æ£€æµ‹ï¼Œå¯èƒ½ä¼šè¦†ç›–å·²æœ‰çš„æ£€æµ‹ç»“æœã€‚ç¡®å®šç»§ç»­å—ï¼Ÿ"))return;const G=Ue(),{textDetector:re,boxExpand:de,textStyle:qe}=G.settings,Le=L.value,De=ue.value.length;me.value=!0,Ke.value="æ‰¹é‡æ£€æµ‹ä¸­",vt.value=De,Ye.value=0;try{let ze=0;for(let Ee=0;Ee<De;Ee++){const ft=ue.value[Ee];if(!ft?.originalDataURL)continue;Ye.value=Ee+1;const gt=ft.originalDataURL.match(/^data:image\/[^;]+;base64,(.+)$/)?.[1]||"";if(!gt)continue;const pt=await no(gt,re,{box_expand_ratio:de.ratio,box_expand_top:de.top,box_expand_bottom:de.bottom,box_expand_left:de.left,box_expand_right:de.right});if(pt.success&&pt.bubble_coords){const _t=ue.value[Ee];if(_t){_t.bubbleCoords=pt.bubble_coords,_t.bubbleAngles=pt.bubble_angles||[],So(_t,pt.bubble_coords.length);const Wn={bubble_coords:pt.bubble_coords.map(Kn=>[...Kn]),bubble_angles:pt.bubble_angles,auto_directions:pt.auto_directions};_t.bubbleStates=wo(Wn,_t,qe),ze+=pt.bubble_coords.length,Ee===L.value&&Tt()}}}Ke.value="æ£€æµ‹å®Œæˆ",Ye.value=De,Le!==L.value&&l.setCurrentImageIndex(Le),Tt(),fe(`æ‰¹é‡æ£€æµ‹å®Œæˆï¼å…±å¤„ç† ${De} å¼ å›¾ç‰‡ï¼Œæ£€æµ‹åˆ° ${ze} ä¸ªæ–‡æœ¬æ¡†`,"success"),setTimeout(()=>{me.value=!1},2e3)}catch(ze){console.error("æ‰¹é‡æ£€æµ‹å¤±è´¥:",ze),fe("æ‰¹é‡æ£€æµ‹å¤±è´¥","error"),me.value=!1}}async function Un(){if(!j.value?.originalDataURL){fe("æ²¡æœ‰æœ‰æ•ˆçš„å›¾ç‰‡ç”¨äºç¿»è¯‘","warning");return}if(Ae.value.length===0){fe("æ²¡æœ‰æ–‡æœ¬æ¡†å¯ç”¨äºç¿»è¯‘ï¼Œè¯·å…ˆæ£€æµ‹æˆ–æ·»åŠ æ–‡æœ¬æ¡†","warning");return}fe("æ­£åœ¨ä½¿ç”¨å½“å‰æ–‡æœ¬æ¡†ç¿»è¯‘...","info");try{await a()&&(fe("ç¿»è¯‘æˆåŠŸï¼","success"),Vt())}catch(re){console.error("ç¿»è¯‘å¤±è´¥:",re),fe(`ç¿»è¯‘å¤±è´¥: ${re instanceof Error?re.message:"æœªçŸ¥é”™è¯¯"}`,"error")}}function On(){O("repair")}function zn(){O("restore")}function $o(G){F(G)}function To(){d()}function Nn(G){Ot.value=!0,Cn.value=Pe.value==="horizontal"?G.clientX:G.clientY,document.body.style.cursor=Pe.value==="horizontal"?"col-resize":"row-resize",document.body.style.userSelect="none",document.addEventListener("mousemove",Jt),document.addEventListener("mouseup",Gt),G.preventDefault()}function Jt(G){if(!Ot.value)return;const re=be.value?.parentElement?.parentElement;if(!re)return;const de=re.getBoundingClientRect();if(Pe.value==="horizontal"){const qe=G.clientX-de.left,Le=de.width,De=Math.max(20,Math.min(80,qe/Le*100)),ze=re.querySelector(".original-panel"),Ee=re.querySelector(".translated-panel");ze&&Ee&&(ze.style.flex=`0 0 ${De}%`,Ee.style.flex=`0 0 ${100-De}%`)}else{const qe=G.clientY-de.top,Le=de.height,De=Math.max(20,Math.min(80,qe/Le*100)),ze=re.querySelector(".original-panel"),Ee=re.querySelector(".translated-panel");ze&&Ee&&(ze.style.flex=`0 0 ${De}%`,Ee.style.flex=`0 0 ${100-De}%`)}}function Gt(){Ot.value=!1,document.body.style.cursor="",document.body.style.userSelect="",document.removeEventListener("mousemove",Jt),document.removeEventListener("mouseup",Gt)}function Vn(G){zt.value=!0;const re=Ve.value;re&&($t.value={x:G.clientX,y:G.clientY,size:Pe.value==="horizontal"?re.offsetWidth:re.offsetHeight},document.body.style.cursor=Pe.value==="horizontal"?"ew-resize":"ns-resize",document.body.style.userSelect="none",document.addEventListener("mousemove",Yt),document.addEventListener("mouseup",Xt),G.preventDefault())}function Yt(G){if(!(!zt.value||!Ve.value))if(Pe.value==="horizontal"){const re=$t.value.x-G.clientX;let de=$t.value.size+re;de=Math.max(300,Math.min(window.innerWidth*.6,de)),Ve.value.style.flex=`0 0 ${de}px`,Ve.value.style.minWidth=`${de}px`}else{const re=$t.value.y-G.clientY;let de=$t.value.size+re;de=Math.max(200,Math.min(window.innerHeight*.5,de)),Ve.value.style.flex=`0 0 ${de}px`,Ve.value.style.height=`${de}px`}}function Xt(){zt.value=!1,document.body.style.cursor="",document.body.style.userSelect="",document.removeEventListener("mousemove",Yt),document.removeEventListener("mouseup",Xt)}function Io(G){const re=G.target,de=G.key.toLowerCase();if(de==="r"||de==="u"||de==="a"||de==="d"){if(re.tagName==="TEXTAREA")return;(re.tagName==="INPUT"||re.tagName==="SELECT"||re.tagName==="BUTTON")&&re.blur()}else if(re.tagName==="INPUT"||re.tagName==="TEXTAREA"||re.tagName==="SELECT")return;switch(G.key){case"Escape":Do();break;case"Delete":case"Backspace":!u.value&&ee.value&&(Q(),G.preventDefault());break;case"a":case"A":u.value||(bo(),G.preventDefault());break;case"d":case"D":u.value||(Wt(),G.preventDefault());break;case"Enter":G.ctrlKey&&!u.value&&(Po(),G.preventDefault());break;case"r":case"R":$.value||(O("repair"),G.preventDefault());break;case"u":case"U":$.value||(O("restore"),G.preventDefault());break;case"+":case"=":mo(),G.preventDefault();break;case"-":vo(),G.preventDefault();break;case"0":fo(),G.preventDefault();break}}function Ro(G){(G.key==="r"||G.key==="R"||G.key==="u"||G.key==="U")&&(P(),G.preventDefault())}async function Po(){Kt(),await r(),$e.value?Wt():fe("å·²æ˜¯æœ€åä¸€å¼ å›¾ç‰‡","info")}function Do(){Kt(),o("exit")}return ut(()=>{try{const G=localStorage.getItem(No);(G==="horizontal"||G==="vertical")&&(Pe.value=G)}catch(G){console.warn("åŠ è½½å¸ƒå±€æ¨¡å¼å¤±è´¥:",G)}document.addEventListener("keydown",Io),document.addEventListener("keyup",Ro),document.addEventListener("mousemove",$o),document.addEventListener("mouseup",To),n.isEditModeActive&&(Tt(),dt(()=>{_e.value?.focus()}))}),Dt(()=>{document.removeEventListener("keydown",Io),document.removeEventListener("keyup",Ro),document.removeEventListener("mousemove",$o),document.removeEventListener("mouseup",To),document.removeEventListener("mousemove",Ht),document.removeEventListener("mouseup",jt),document.removeEventListener("mousemove",Jt),document.removeEventListener("mouseup",Gt),document.removeEventListener("mousemove",Yt),document.removeEventListener("mouseup",Xt)}),xe(()=>n.isEditModeActive,G=>{G&&(Tt(),dt(()=>{_e.value?.focus()}))}),xe(L,()=>{n.isEditModeActive&&Tt()}),xe(J,G=>{G&&(ke.value=G.inpaintMethod||"solid",Z.value=G.fillColor||"#FFFFFF")},{immediate:!0}),(G,re)=>s.isEditModeActive?(R(),E("div",{key:0,class:Te(["edit-workspace",[`layout-${Pe.value}`,{"drawing-mode":K(h)}]]),tabindex:"0",ref_key:"workspaceRef",ref:_e},[ye(lv,{"current-image-index":K(L),"image-count":K(le),"can-go-previous":K(he),"can-go-next":K($e),"show-thumbnails":Re.value,"has-bubbles":K(te),"selected-bubble-index":K(Me),"bubble-count":K(z),"layout-mode":Pe.value,"sync-enabled":Ge.value,scale:Ut.value,"is-drawing-mode":K(h),"has-selection":K(ee),"brush-mode":K(u),"brush-size":K(c),"mouse-x":K(M),"mouse-y":K(H),"is-processing":me.value,"progress-text":Ke.value,"progress-current":Ye.value,"progress-total":vt.value,onGoPreviousImage:bo,onGoNextImage:Wt,onToggleThumbnails:Tn,onSelectPreviousBubble:wn,onSelectNextBubble:$n,onToggleLayout:In,onToggleViewMode:Rn,onToggleSync:Pn,onFitToScreen:It,onZoomIn:mo,onZoomOut:vo,onResetZoom:fo,onExitEditMode:Do,onAutoDetectBubbles:Ln,onDetectAllImages:Fn,onTranslateWithBubbles:Un,onToggleDrawingMode:K(Y),onDeleteSelectedBubbles:K(Q),onRepairSelectedBubble:K(p),onActivateRepairBrush:On,onActivateRestoreBrush:zn,onApplyAndNext:Po},null,8,["current-image-index","image-count","can-go-previous","can-go-next","show-thumbnails","has-bubbles","selected-bubble-index","bubble-count","layout-mode","sync-enabled","scale","is-drawing-mode","has-selection","brush-mode","brush-size","mouse-x","mouse-y","is-processing","progress-text","progress-current","progress-total","onToggleDrawingMode","onDeleteSelectedBubbles","onRepairSelectedBubble"]),ye(pv,{visible:Re.value,images:K(ue),"current-image-index":K(L),onSwitchToImage:Sn},null,8,["visible","images","current-image-index"]),e("div",mv,[e("div",vv,[ne(e("div",{class:Te(["image-panel original-panel",{collapsed:Oe.value==="translated"||at.value}])},[e("div",fv,[re[8]||(re[8]=e("span",{class:"panel-title"},"ğŸ“– åŸå›¾ (æ—¥æ–‡)",-1)),e("button",{class:"panel-toggle",onClick:re[0]||(re[0]=de=>at.value=!at.value),title:"æŠ˜å /å±•å¼€"},oe(at.value?"+":"âˆ’"),1)]),e("div",{ref_key:"originalViewportRef",ref:be,class:"image-viewport",onWheel:re[2]||(re[2]=tt(de=>ho(de,"original"),["prevent"])),onMousedown:re[3]||(re[3]=de=>yo(de,"original")),onDblclick:It},[e("div",{ref_key:"originalWrapperRef",ref:pe,class:"image-canvas-wrapper",style:ot(_n.value)},[K(j)?.originalDataURL?(R(),E("img",{key:0,src:K(j).originalDataURL,alt:"åŸå›¾",onLoad:re[1]||(re[1]=de=>Co("original"))},null,40,bv)):ge("",!0),K(j)?.originalDataURL?(R(),st(Qo,{key:1,bubbles:K(Ae),"selected-index":K(Me),"selected-indices":K(se),scale:xn.value,"is-drawing-mode":K(h),"is-brush-mode":!!K(u),"image-width":ce.value,"image-height":ve.value,onSelect:K(B),onMultiSelect:K(I),onDragStart:K(w),onDragging:K(N),onDragEnd:K(W),onResizeStart:K(U),onResizing:K(f),onResizeEnd:K(g),onRotateStart:K(C),onRotating:K(k),onRotateEnd:K(V),onDrawBubble:K(ie)},null,8,["bubbles","selected-index","selected-indices","scale","is-drawing-mode","is-brush-mode","image-width","image-height","onSelect","onMultiSelect","onDragStart","onDragging","onDragEnd","onResizeStart","onResizing","onResizeEnd","onRotateStart","onRotating","onRotateEnd","onDrawBubble"])):ge("",!0),K(S)?(R(),E("div",{key:2,class:"drawing-rect-edit",style:ot(K(X)())},null,4)):ge("",!0)],4)],544)],2),[[Fe,Oe.value!=="translated"]]),Oe.value==="dual"?(R(),E("div",{key:0,class:Te(["panel-divider",{"vertical-divider":Pe.value==="vertical"}]),onMousedown:Nn},null,34)):ge("",!0),ne(e("div",{class:Te(["image-panel translated-panel",{collapsed:Oe.value==="original"||it.value}])},[e("div",hv,[re[9]||(re[9]=e("span",{class:"panel-title"},"ğŸ“ ç¿»è¯‘å›¾ (ä¸­æ–‡)",-1)),e("button",{class:"panel-toggle",onClick:re[4]||(re[4]=de=>it.value=!it.value),title:"æŠ˜å /å±•å¼€"},oe(it.value?"+":"âˆ’"),1)]),e("div",{ref_key:"translatedViewportRef",ref:Ie,class:"image-viewport",onWheel:re[6]||(re[6]=tt(de=>ho(de,"translated"),["prevent"])),onMousedown:re[7]||(re[7]=de=>yo(de,"translated")),onDblclick:It},[e("div",{ref_key:"translatedWrapperRef",ref:we,class:"image-canvas-wrapper",style:ot(kn.value)},[K(j)?.translatedDataURL||K(j)?.originalDataURL?(R(),E("img",{key:0,src:K(j)?.translatedDataURL||K(j)?.originalDataURL,alt:"ç¿»è¯‘å›¾",onLoad:re[5]||(re[5]=de=>Co("translated"))},null,40,yv)):ge("",!0),K(j)?.translatedDataURL||K(j)?.originalDataURL?(R(),st(Qo,{key:1,bubbles:K(Ae),"selected-index":K(Me),"selected-indices":K(se),scale:Ut.value,"is-drawing-mode":K(h),"is-brush-mode":!!K(u),"image-width":ce.value,"image-height":ve.value,onSelect:K(B),onMultiSelect:K(I),onDragStart:K(w),onDragging:K(N),onDragEnd:K(W),onResizeStart:K(U),onResizing:K(f),onResizeEnd:K(g),onRotateStart:K(C),onRotating:K(k),onRotateEnd:K(V),onDrawBubble:K(ie)},null,8,["bubbles","selected-index","selected-indices","scale","is-drawing-mode","is-brush-mode","image-width","image-height","onSelect","onMultiSelect","onDragStart","onDragging","onDragEnd","onResizeStart","onResizing","onResizeEnd","onRotateStart","onRotating","onRotateEnd","onDrawBubble"])):ge("",!0),K(S)?(R(),E("div",{key:2,class:"drawing-rect-edit translated-drawing-rect",style:ot(K(X)())},null,4)):ge("",!0)],4)],544)],2),[[Fe,Oe.value!=="original"]])]),e("div",{ref_key:"editPanelRef",ref:Ve,class:"edit-panel-container"},[e("div",{class:"panel-resize-handle vertical",onMousedown:Vn}," â‹®â‹®â‹® ",32),ye(Mm,{bubble:K(J),"bubble-index":K(Me),onUpdate:Mn,onReRender:Dn,onOcrRecognize:K(m),onReTranslate:An,onApplyBubble:En,onResetCurrent:Bn},null,8,["bubble","bubble-index","onOcrRecognize"])],512)])],2)):ge("",!0)}}),_v=je(xv,[["__scopeId","data-v-593a2a42"]]),wt="/api/web-import";async function kv(s){return(await fetch(`${wt}/check-support?url=${encodeURIComponent(s)}`)).json()}async function Cv(){return(await fetch(`${wt}/gallery-dl-images`)).json()}async function Sv(s,t,n,o,l,i="auto",a){const r=await fetch(`${wt}/extract`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url:s,config:t,engine:i})});if(!r.ok){const D=await r.json().catch(()=>({error:"è¯·æ±‚å¤±è´¥"}));l(D.error||`HTTP ${r.status}`);return}const h=r.body?.getReader();if(!h){l("æ— æ³•è¯»å–å“åº”æµ");return}const T=new TextDecoder;let S="";try{for(;;){const{done:D,value:B}=await h.read();if(D)break;S+=T.decode(B,{stream:!0});const I=S.split(`
`);S=I.pop()||"";let A="",w="";for(const N of I)if(N.startsWith("event:"))A=N.slice(6).trim();else if(N.startsWith("data:"))w=N.slice(5).trim();else if(N===""&&A&&w){try{const W=JSON.parse(w);A==="log"?n(W):A==="page"?a&&a(W):A==="result"?o(W):A==="error"&&l(W.error||"æœªçŸ¥é”™è¯¯")}catch(W){console.error("è§£æ SSE æ•°æ®å¤±è´¥:",W)}A="",w=""}}}finally{h.releaseLock()}}async function wv(s,t,n,o="ai-agent"){const l=await fetch(`${wt}/download`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({pages:s,sourceUrl:t,config:n,engine:o})});if(!l.ok){const i=await l.json().catch(()=>({error:"è¯·æ±‚å¤±è´¥"}));throw new Error(i.error||`HTTP ${l.status}`)}return l.json()}async function $v(s){return(await fetch(`${wt}/test-firecrawl`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({apiKey:s})})).json()}async function Tv(s,t,n,o){return(await fetch(`${wt}/test-agent`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({provider:s,apiKey:t,customBaseUrl:n,modelName:o})})).json()}const Iv={class:"modal-container"},Rv={class:"modal-body"},Pv={class:"url-section"},Dv=["disabled"],Mv=["disabled"],Ev=["disabled"],Bv={key:0,class:"loading-spinner"},Av={key:1},Lv={key:0,class:"engine-hint"},Fv={key:0,class:"hint-checking"},Uv={key:1,class:"hint-supported"},Ov={key:2,class:"hint-unsupported"},zv={class:"settings-section"},Nv={class:"settings-toggle"},Vv={key:0,class:"settings-content"},Wv={class:"settings-tabs"},Kv={class:"settings-tab-content"},qv={class:"settings-group"},Hv={class:"form-row"},jv={class:"input-group"},Jv=["type","value"],Gv=["disabled"],Yv={class:"settings-group"},Xv={class:"form-row"},Zv=["value"],Qv=["value"],ef={class:"form-row"},tf={class:"input-group"},of=["type","value"],nf={key:0,class:"form-row"},sf=["value"],af={class:"form-row"},lf=["value"],rf={class:"form-row inline"},uf={class:"checkbox-label"},cf=["checked"],df={class:"checkbox-label"},gf=["checked"],pf={class:"form-row"},mf=["disabled"],vf={class:"settings-group"},ff={class:"form-row"},bf=["value"],hf={class:"form-row"},yf=["value"],xf={class:"settings-group"},_f={class:"form-grid"},kf={class:"form-row"},Cf=["value"],Sf={class:"form-row"},wf=["value"],$f={class:"form-row"},Tf=["value"],If={class:"form-row"},Rf=["value"],Pf={class:"form-row"},Df={class:"checkbox-label"},Mf=["checked"],Ef={class:"settings-group"},Bf={class:"form-row inline"},Af={class:"checkbox-label"},Lf=["checked"],Ff={class:"checkbox-label"},Uf=["checked"],Of={class:"settings-tab-content"},zf={class:"settings-group"},Nf={class:"form-row"},Vf={class:"checkbox-label"},Wf=["checked"],Kf={class:"form-row"},qf={class:"checkbox-label"},Hf=["checked"],jf={class:"form-row"},Jf={class:"checkbox-label"},Gf=["checked"],Yf={key:0,class:"form-grid"},Xf={class:"form-row"},Zf=["value"],Qf={class:"form-row"},eb=["value"],tb={class:"form-row"},ob=["value"],nb={class:"form-row"},sb={class:"checkbox-label"},ab=["checked"],lb={key:1,class:"form-row"},ib=["value"],rb={class:"settings-tab-content"},ub={class:"settings-group"},cb={class:"form-row"},db=["value"],gb={class:"form-row"},pb=["value"],mb={class:"form-row"},vb={class:"checkbox-label"},fb=["checked"],bb={key:1,class:"logs-section"},hb={class:"logs-toggle"},yb={key:0,class:"extracting-hint"},xb={key:0,class:"logs-content"},_b={class:"log-time"},kb={class:"log-message"},Cb={key:2,class:"error-section"},Sb={class:"error-message"},wb={key:3,class:"result-section"},$b={class:"result-header"},Tb={class:"result-title"},Ib={class:"result-meta"},Rb={class:"result-count"},Pb={key:0,class:"result-engine"},Db={class:"select-control"},Mb={class:"select-all"},Eb=["checked"],Bb={class:"selected-count"},Ab={class:"image-grid"},Lb=["onClick"],Fb={class:"image-checkbox"},Ub=["checked","onChange"],Ob={class:"image-preview"},zb=["src","alt"],Nb={class:"image-label"},Vb={key:4,class:"progress-section"},Wb={class:"progress-label"},Kb={class:"progress-bar"},qb={class:"modal-footer"},Hb=["disabled"],jb=["disabled"],Jb={key:0,class:"loading-spinner"},Gb={key:1},Yb=Je({__name:"WebImportModal",setup(s){const t=un(),n=Qe(),o=_(""),l=_(!0),i=_("auto"),a=_(!1),r=_(!1),h=_(!1),T=_(!1),S=_("basic"),D=_(!1),B=_(!1),I=_(!1),A=_(!1),w=q(()=>t.modalVisible),N=q(()=>t.status),W=q(()=>t.logs),U=q(()=>t.extractResult),f=q(()=>t.selectedPages),g=q(()=>t.selectedCount),C=q(()=>t.downloadProgress),k=q(()=>t.downloadProgressPercent),V=q(()=>t.error),Y=q(()=>t.isProcessing),ie=q(()=>t.settings.ui.showAgentLogs),X=q(()=>U.value?.engine||null),ae=q(()=>{switch(X.value){case"gallery-dl":return"Gallery-DL";case"ai-agent":return"AI Agent";default:return""}}),Q=q(()=>U.value?.pages?g.value===U.value.pages.length:!1);function p(F){return X.value==="gallery-dl",F}let m=null;async function x(F){if(m&&clearTimeout(m),!F.trim()){a.value=!1,r.value=!1;return}m=setTimeout(async()=>{h.value=!0;try{const d=await kv(F);a.value=d.available,r.value=d.supported}catch{a.value=!1,r.value=!1}finally{h.value=!1}},500)}function b(){Y.value&&!confirm("æ­£åœ¨å¤„ç†ä¸­ï¼Œç¡®å®šè¦å…³é—­å—ï¼Ÿ")||(t.closeModal(),t.resetState(),o.value="")}async function u(){const F=o.value.trim();if(!F){alert("è¯·è¾“å…¥ç½‘å€");return}try{new URL(F)}catch{alert("è¯·è¾“å…¥æœ‰æ•ˆçš„ç½‘å€");return}t.resetState(),t.setUrl(F),t.setStatus("extracting");try{await Sv(F,t.settings,d=>{t.addLog(d)},d=>{t.setExtractResult(d),d.success?t.setStatus("extracted"):t.setError(d.error||"æå–å¤±è´¥")},d=>{t.setError(d)},i.value,d=>{t.addPageIncremental(d)})}catch(d){t.setError(d instanceof Error?d.message:"æå–å¤±è´¥")}}function c(F){t.togglePageSelection(F)}function M(){t.toggleSelectAll()}async function H(){if(!U.value?.pages||g.value===0){alert("è¯·é€‰æ‹©è¦å¯¼å…¥çš„å›¾ç‰‡");return}const F=U.value.pages.filter(y=>f.value.has(y.pageNumber));t.setStatus("downloading"),t.updateDownloadProgress(0,F.length);const d=X.value||"ai-agent";try{if(d==="gallery-dl"){const ue=await Cv();if(ue.success&&ue.images.length>0){let L=0;const j=Math.min(ue.images.length,F.length);for(let le=0;le<j;le++){const he=ue.images[le];he&&he.filename&&he.data&&(n.addImage(he.filename,he.data),L++,t.updateDownloadProgress(L,j))}t.setStatus("completed"),alert(`æˆåŠŸå¯¼å…¥ ${L} å¼ å›¾ç‰‡`),b();return}else throw new Error(ue.error||"è·å–å›¾ç‰‡å¤±è´¥")}const y=await wv(F,U.value.sourceUrl,t.settings,d);if(y.success&&y.images.length>0){t.setDownloadedImages(y.images),t.updateDownloadProgress(y.images.length,F.length);for(const L of y.images)n.addImage(L.filename,L.dataUrl);t.setStatus("completed");const ue=y.failedCount>0?`ï¼Œ${y.failedCount} å¼ å¤±è´¥`:"";alert(`æˆåŠŸå¯¼å…¥ ${y.images.length} å¼ å›¾ç‰‡${ue}`),b()}else t.setError(y.error||"ä¸‹è½½å¤±è´¥")}catch(y){t.setError(y instanceof Error?y.message:"ä¸‹è½½å¤±è´¥")}}xe(w,F=>{F&&setTimeout(()=>{document.querySelector(".url-input")?.focus()},100)}),xe(o,F=>{x(F)});const $=q(()=>t.settings.agent.provider==="custom_openai");async function O(){if(!t.settings.firecrawl.apiKey){alert("è¯·è¾“å…¥ Firecrawl API Key");return}D.value=!0;try{const F=await $v(t.settings.firecrawl.apiKey);F.success?alert("âœ… Firecrawl è¿æ¥æˆåŠŸ"):alert(`âŒ è¿æ¥å¤±è´¥: ${F.error}`)}catch(F){alert(`âŒ è¿æ¥å¤±è´¥: ${F instanceof Error?F.message:"æœªçŸ¥é”™è¯¯"}`)}finally{D.value=!1}}async function P(){if(!t.settings.agent.apiKey){alert("è¯·è¾“å…¥ AI Agent API Key");return}B.value=!0;try{const F=await Tv(t.settings.agent.provider,t.settings.agent.apiKey,t.settings.agent.customBaseUrl,t.settings.agent.modelName);F.success?alert("âœ… AI Agent è¿æ¥æˆåŠŸ"):alert(`âŒ è¿æ¥å¤±è´¥: ${F.error}`)}catch(F){alert(`âŒ è¿æ¥å¤±è´¥: ${F instanceof Error?F.message:"æœªçŸ¥é”™è¯¯"}`)}finally{B.value=!1}}function v(){confirm("ç¡®å®šè¦é‡ç½®ä¸ºé»˜è®¤æç¤ºè¯å—ï¼Ÿ")&&t.resetExtractionPrompt()}return(F,d)=>(R(),st(Qn,{to:"body"},[w.value?(R(),E("div",{key:0,class:"modal-overlay",onClick:tt(b,["self"])},[e("div",Iv,[e("div",{class:"modal-header"},[d[37]||(d[37]=e("h2",{class:"modal-title"},[e("span",{class:"title-icon"},"ğŸŒ"),Ce(" ä»ç½‘é¡µå¯¼å…¥æ¼«ç”» ")],-1)),e("button",{class:"close-btn",onClick:b,title:"å…³é—­"},"Ã—")]),e("div",Rv,[e("div",Pv,[ne(e("input",{"onUpdate:modelValue":d[0]||(d[0]=y=>o.value=y),type:"url",class:"url-input",placeholder:"è¾“å…¥æ¼«ç”»ç½‘é¡µ URLï¼Œå¦‚ https://example.com/chapter-1",disabled:Y.value,onKeyup:Xn(u,["enter"])},null,40,Dv),[[Se,o.value]]),ne(e("select",{"onUpdate:modelValue":d[1]||(d[1]=y=>i.value=y),class:"engine-select",disabled:Y.value},[...d[38]||(d[38]=[e("option",{value:"auto"},"è‡ªåŠ¨é€‰æ‹©",-1),e("option",{value:"gallery-dl"},"Gallery-DL",-1),e("option",{value:"ai-agent"},"AI Agent",-1)])],8,Mv),[[Zn,i.value]]),e("button",{class:"extract-btn",disabled:Y.value||!o.value.trim(),onClick:u},[N.value==="extracting"?(R(),E("span",Bv)):(R(),E("span",Av,"ğŸ”")),Ce(" "+oe(N.value==="extracting"?"æå–ä¸­...":"å¼€å§‹æå–"),1)],8,Ev)]),o.value.trim()&&!Y.value?(R(),E("div",Lv,[h.value?(R(),E("span",Fv,"æ£€æŸ¥ä¸­...")):r.value?(R(),E("span",Uv,"âœ“ è¯¥ç½‘ç«™æ”¯æŒ Gallery-DL é«˜é€Ÿä¸‹è½½")):a.value?(R(),E("span",Ov,"è¯¥ç½‘ç«™å°†ä½¿ç”¨ AI Agent æ¨¡å¼")):ge("",!0)])):ge("",!0),d[80]||(d[80]=e("div",{class:"notice"}," âš ï¸ è¯·ä»…çˆ¬å–æ‚¨æœ‰æƒè®¿é—®çš„å†…å®¹ï¼Œå¹¶éµå®ˆç›®æ ‡ç½‘ç«™çš„ä½¿ç”¨æ¡æ¬¾ã€‚ ",-1)),e("div",zv,[e("div",{class:"settings-header",onClick:d[2]||(d[2]=y=>T.value=!T.value)},[e("span",Nv,oe(T.value?"â–¼":"â–¶"),1),d[39]||(d[39]=e("span",{class:"settings-title"},"âš™ï¸ è®¾ç½®",-1)),d[40]||(d[40]=e("span",{class:"settings-hint"},"ç‚¹å‡»å±•å¼€é…ç½®",-1))]),T.value?(R(),E("div",Vv,[e("div",Wv,[e("button",{class:Te(["settings-tab",{active:S.value==="basic"}]),onClick:d[3]||(d[3]=y=>S.value="basic")}," åŸºæœ¬è®¾ç½® ",2),e("button",{class:Te(["settings-tab",{active:S.value==="preprocess"}]),onClick:d[4]||(d[4]=y=>S.value="preprocess")}," å›¾ç‰‡é¢„å¤„ç† ",2),e("button",{class:Te(["settings-tab",{active:S.value==="advanced"}]),onClick:d[5]||(d[5]=y=>S.value="advanced")}," é«˜çº§è®¾ç½® ",2)]),ne(e("div",Kv,[e("div",qv,[d[42]||(d[42]=e("h4",{class:"group-title"},"Firecrawl é…ç½®",-1)),e("div",Hv,[d[41]||(d[41]=e("label",{class:"form-label"},"API Key",-1)),e("div",jv,[e("input",{type:I.value?"text":"password",class:"form-input",value:K(t).settings.firecrawl.apiKey,onInput:d[6]||(d[6]=y=>K(t).setFirecrawlApiKey(y.target.value)),placeholder:"fc-xxxxxxxxxxxxxxxx"},null,40,Jv),e("button",{class:"toggle-btn",onClick:d[7]||(d[7]=y=>I.value=!I.value)},oe(I.value?"ğŸ‘":"ğŸ‘â€ğŸ—¨"),1),e("button",{class:"test-btn",disabled:D.value||!K(t).settings.firecrawl.apiKey,onClick:O},oe(D.value?"æµ‹è¯•ä¸­...":"æµ‹è¯•è¿æ¥"),9,Gv)])])]),e("div",Yv,[d[49]||(d[49]=e("h4",{class:"group-title"},"AI Agent é…ç½®",-1)),e("div",Xv,[d[43]||(d[43]=e("label",{class:"form-label"},"æœåŠ¡å•†",-1)),e("select",{class:"form-select",value:K(t).settings.agent.provider,onChange:d[8]||(d[8]=y=>K(t).setAgentProvider(y.target.value))},[(R(!0),E(Be,null,He(K(Gn),y=>(R(),E("option",{key:y.value,value:y.value},oe(y.label),9,Qv))),128))],40,Zv)]),e("div",ef,[d[44]||(d[44]=e("label",{class:"form-label"},"API Key",-1)),e("div",tf,[e("input",{type:A.value?"text":"password",class:"form-input",value:K(t).settings.agent.apiKey,onInput:d[9]||(d[9]=y=>K(t).setAgentApiKey(y.target.value)),placeholder:"sk-xxxxxxxxxxxxxxxx"},null,40,of),e("button",{class:"toggle-btn",onClick:d[10]||(d[10]=y=>A.value=!A.value)},oe(A.value?"ğŸ‘":"ğŸ‘â€ğŸ—¨"),1)])]),$.value?(R(),E("div",nf,[d[45]||(d[45]=e("label",{class:"form-label"},"è‡ªå®šä¹‰ API åœ°å€",-1)),e("input",{type:"url",class:"form-input",value:K(t).settings.agent.customBaseUrl,onInput:d[11]||(d[11]=y=>K(t).setAgentBaseUrl(y.target.value)),placeholder:"https://api.example.com/v1"},null,40,sf)])):ge("",!0),e("div",af,[d[46]||(d[46]=e("label",{class:"form-label"},"æ¨¡å‹åç§°",-1)),e("input",{type:"text",class:"form-input",value:K(t).settings.agent.modelName,onInput:d[12]||(d[12]=y=>K(t).setAgentModelName(y.target.value)),placeholder:"gpt-4o-mini"},null,40,lf)]),e("div",rf,[e("label",uf,[e("input",{type:"checkbox",checked:K(t).settings.agent.forceJsonOutput,onChange:d[13]||(d[13]=y=>K(t).setAgentForceJson(y.target.checked))},null,40,cf),d[47]||(d[47]=Ce(" å¼ºåˆ¶ JSON æ ¼å¼ ",-1))]),e("label",df,[e("input",{type:"checkbox",checked:K(t).settings.agent.useStream,onChange:d[14]||(d[14]=y=>K(t).setAgentUseStream(y.target.checked))},null,40,gf),d[48]||(d[48]=Ce(" æµå¼è°ƒç”¨ ",-1))])]),e("div",pf,[e("button",{class:"test-btn full",disabled:B.value||!K(t).settings.agent.apiKey,onClick:P},oe(B.value?"æµ‹è¯•ä¸­...":"æµ‹è¯• Agent è¿æ¥"),9,mf)])]),e("div",vf,[e("h4",{class:"group-title"},[d[50]||(d[50]=Ce(" æå–è®¾ç½® ",-1)),e("button",{class:"reset-btn",onClick:v},"é‡ç½®ä¸ºé»˜è®¤")]),e("div",ff,[d[51]||(d[51]=e("label",{class:"form-label"},"æå–æç¤ºè¯",-1)),e("textarea",{class:"form-textarea",value:K(t).settings.extraction.prompt,onInput:d[15]||(d[15]=y=>K(t).setExtractionPrompt(y.target.value)),rows:"6",placeholder:"è¾“å…¥æå–æç¤ºè¯..."},null,40,bf)]),e("div",hf,[d[52]||(d[52]=e("label",{class:"form-label"},"æœ€å¤§è¿­ä»£æ¬¡æ•°",-1)),e("input",{type:"number",class:"form-input small",value:K(t).settings.extraction.maxIterations,onInput:d[16]||(d[16]=y=>K(t).setExtractionMaxIterations(Number(y.target.value))),min:"1",max:"20"},null,40,yf)])]),e("div",xf,[d[58]||(d[58]=e("h4",{class:"group-title"},"ä¸‹è½½è®¾ç½®",-1)),e("div",_f,[e("div",kf,[d[53]||(d[53]=e("label",{class:"form-label"},"å¹¶å‘æ•°",-1)),e("input",{type:"number",class:"form-input small",value:K(t).settings.download.concurrency,onInput:d[17]||(d[17]=y=>K(t).setDownloadConcurrency(Number(y.target.value))),min:"1",max:"10"},null,40,Cf)]),e("div",Sf,[d[54]||(d[54]=e("label",{class:"form-label"},"è¶…æ—¶ (ç§’)",-1)),e("input",{type:"number",class:"form-input small",value:K(t).settings.download.timeout,onInput:d[18]||(d[18]=y=>K(t).setDownloadTimeout(Number(y.target.value))),min:"5",max:"120"},null,40,wf)]),e("div",$f,[d[55]||(d[55]=e("label",{class:"form-label"},"é‡è¯•æ¬¡æ•°",-1)),e("input",{type:"number",class:"form-input small",value:K(t).settings.download.retries,onInput:d[19]||(d[19]=y=>K(t).setDownloadRetries(Number(y.target.value))),min:"0",max:"5"},null,40,Tf)]),e("div",If,[d[56]||(d[56]=e("label",{class:"form-label"},"ä¸‹è½½é—´éš” (ms)",-1)),e("input",{type:"number",class:"form-input small",value:K(t).settings.download.delay,onInput:d[20]||(d[20]=y=>K(t).setDownloadDelay(Number(y.target.value))),min:"0",max:"2000",step:"100"},null,40,Rf)])]),e("div",Pf,[e("label",Df,[e("input",{type:"checkbox",checked:K(t).settings.download.useReferer,onChange:d[21]||(d[21]=y=>K(t).setDownloadUseReferer(y.target.checked))},null,40,Mf),d[57]||(d[57]=Ce(" è‡ªåŠ¨æ·»åŠ  Referer ",-1))])])]),e("div",Ef,[d[61]||(d[61]=e("h4",{class:"group-title"},"ç•Œé¢è®¾ç½®",-1)),e("div",Bf,[e("label",Af,[e("input",{type:"checkbox",checked:K(t).settings.ui.showAgentLogs,onChange:d[22]||(d[22]=y=>K(t).setShowAgentLogs(y.target.checked))},null,40,Lf),d[59]||(d[59]=Ce(" æ˜¾ç¤º AI å·¥ä½œæ—¥å¿— ",-1))]),e("label",Ff,[e("input",{type:"checkbox",checked:K(t).settings.ui.autoImport,onChange:d[23]||(d[23]=y=>K(t).setAutoImport(y.target.checked))},null,40,Uf),d[60]||(d[60]=Ce(" æå–åè‡ªåŠ¨å¯¼å…¥ ",-1))])])])],512),[[Fe,S.value==="basic"]]),ne(e("div",Of,[e("div",zf,[e("div",Nf,[e("label",Vf,[e("input",{type:"checkbox",checked:K(t).settings.imagePreprocess.enabled,onChange:d[24]||(d[24]=y=>K(t).setImagePreprocessEnabled(y.target.checked))},null,40,Wf),d[62]||(d[62]=Ce(" å¯ç”¨å›¾ç‰‡é¢„å¤„ç† ",-1))])]),K(t).settings.imagePreprocess.enabled?(R(),E(Be,{key:0},[e("div",Kf,[e("label",qf,[e("input",{type:"checkbox",checked:K(t).settings.imagePreprocess.autoRotate,onChange:d[25]||(d[25]=y=>K(t).setImageAutoRotate(y.target.checked))},null,40,Hf),d[63]||(d[63]=Ce(" æ ¹æ® EXIF è‡ªåŠ¨æ—‹è½¬ ",-1))])]),d[71]||(d[71]=e("h5",{class:"subsection-title"},"å‹ç¼©è®¾ç½®",-1)),e("div",jf,[e("label",Jf,[e("input",{type:"checkbox",checked:K(t).settings.imagePreprocess.compression.enabled,onChange:d[26]||(d[26]=y=>K(t).setImageCompressionEnabled(y.target.checked))},null,40,Gf),d[64]||(d[64]=Ce(" å¯ç”¨å‹ç¼© ",-1))])]),K(t).settings.imagePreprocess.compression.enabled?(R(),E("div",Yf,[e("div",Xf,[d[65]||(d[65]=e("label",{class:"form-label"},"è´¨é‡ (0-100)",-1)),e("input",{type:"number",class:"form-input small",value:K(t).settings.imagePreprocess.compression.quality,onInput:d[27]||(d[27]=y=>K(t).setImageCompressionQuality(Number(y.target.value))),min:"1",max:"100"},null,40,Zf)]),e("div",Qf,[d[66]||(d[66]=e("label",{class:"form-label"},"æœ€å¤§å®½åº¦ (0=ä¸é™)",-1)),e("input",{type:"number",class:"form-input small",value:K(t).settings.imagePreprocess.compression.maxWidth,onInput:d[28]||(d[28]=y=>K(t).setImageMaxWidth(Number(y.target.value))),min:"0"},null,40,eb)]),e("div",tb,[d[67]||(d[67]=e("label",{class:"form-label"},"æœ€å¤§é«˜åº¦ (0=ä¸é™)",-1)),e("input",{type:"number",class:"form-input small",value:K(t).settings.imagePreprocess.compression.maxHeight,onInput:d[29]||(d[29]=y=>K(t).setImageMaxHeight(Number(y.target.value))),min:"0"},null,40,ob)])])):ge("",!0),d[72]||(d[72]=e("h5",{class:"subsection-title"},"æ ¼å¼è½¬æ¢",-1)),e("div",nb,[e("label",sb,[e("input",{type:"checkbox",checked:K(t).settings.imagePreprocess.formatConvert.enabled,onChange:d[30]||(d[30]=y=>K(t).setImageFormatConvertEnabled(y.target.checked))},null,40,ab),d[68]||(d[68]=Ce(" å¯ç”¨æ ¼å¼è½¬æ¢ ",-1))])]),K(t).settings.imagePreprocess.formatConvert.enabled?(R(),E("div",lb,[d[70]||(d[70]=e("label",{class:"form-label"},"ç›®æ ‡æ ¼å¼",-1)),e("select",{class:"form-select",value:K(t).settings.imagePreprocess.formatConvert.targetFormat,onChange:d[31]||(d[31]=y=>K(t).setImageTargetFormat(y.target.value))},[...d[69]||(d[69]=[e("option",{value:"original"},"ä¿æŒåŸæ ¼å¼",-1),e("option",{value:"jpeg"},"JPEG",-1),e("option",{value:"png"},"PNG",-1),e("option",{value:"webp"},"WebP",-1)])],40,ib)])):ge("",!0)],64)):ge("",!0)])],512),[[Fe,S.value==="preprocess"]]),ne(e("div",rb,[e("div",ub,[d[76]||(d[76]=e("h4",{class:"group-title"},"è‡ªå®šä¹‰è¯·æ±‚å¤´",-1)),e("div",cb,[d[73]||(d[73]=e("label",{class:"form-label"},"Cookie",-1)),e("input",{type:"text",class:"form-input",value:K(t).settings.advanced.customCookie,onInput:d[32]||(d[32]=y=>K(t).setCustomCookie(y.target.value)),placeholder:"name=value; name2=value2"},null,40,db)]),e("div",gb,[d[74]||(d[74]=e("label",{class:"form-label"},"Headers (JSON)",-1)),e("textarea",{class:"form-textarea",value:K(t).settings.advanced.customHeaders,onInput:d[33]||(d[33]=y=>K(t).setCustomHeaders(y.target.value)),rows:"3",placeholder:'{"X-Custom-Header": "value"}'},null,40,pb)]),e("div",mb,[e("label",vb,[e("input",{type:"checkbox",checked:K(t).settings.advanced.bypassProxy,onChange:d[34]||(d[34]=y=>K(t).setBypassProxy(y.target.checked))},null,40,fb),d[75]||(d[75]=Ce(" ç»•è¿‡ç³»ç»Ÿä»£ç† (è¿æ¥æœ¬åœ°æœåŠ¡æ—¶ä½¿ç”¨) ",-1))])])])],512),[[Fe,S.value==="advanced"]])])):ge("",!0)]),ie.value&&W.value.length>0?(R(),E("div",bb,[e("div",{class:"logs-header",onClick:d[35]||(d[35]=y=>l.value=!l.value)},[e("span",hb,oe(l.value?"â–¼":"â–¶"),1),d[77]||(d[77]=e("span",null,"AI å·¥ä½œæ—¥å¿—",-1)),N.value==="extracting"?(R(),E("span",yb,"(æå–ä¸­...)")):ge("",!0)]),l.value?(R(),E("div",xb,[(R(!0),E(Be,null,He(W.value,(y,ue)=>(R(),E("div",{key:ue,class:Te(["log-item",`log-${y.type}`])},[e("span",_b,"["+oe(y.timestamp)+"]",1),e("span",kb,oe(y.message),1)],2))),128))])):ge("",!0)])):ge("",!0),V.value?(R(),E("div",Cb,[d[78]||(d[78]=e("span",{class:"error-icon"},"âŒ",-1)),e("span",Sb,oe(V.value),1)])):ge("",!0),U.value?.success?(R(),E("div",wb,[e("div",$b,[e("span",Tb," ğŸ“– ã€Š"+oe(U.value.comicTitle)+"ã€‹- "+oe(U.value.chapterTitle),1),e("span",Ib,[e("span",Rb,"å…± "+oe(U.value.totalPages)+" å¼ ",1),ae.value?(R(),E("span",Pb,"| å¼•æ“: "+oe(ae.value),1)):ge("",!0)])]),e("div",Db,[e("label",Mb,[e("input",{type:"checkbox",checked:Q.value,onChange:M},null,40,Eb),d[79]||(d[79]=Ce(" å…¨é€‰ ",-1))]),e("span",Bb,"å·²é€‰: "+oe(g.value)+" å¼ ",1)]),e("div",Ab,[(R(!0),E(Be,null,He(U.value.pages,y=>(R(),E("div",{key:y.pageNumber,class:Te(["image-item",{selected:f.value.has(y.pageNumber)}]),onClick:ue=>c(y.pageNumber)},[e("div",Fb,[e("input",{type:"checkbox",checked:f.value.has(y.pageNumber),onClick:d[36]||(d[36]=tt(()=>{},["stop"])),onChange:ue=>c(y.pageNumber)},null,40,Ub)]),e("div",Ob,[e("img",{src:p(y.imageUrl),alt:`ç¬¬${y.pageNumber}é¡µ`,loading:"lazy"},null,8,zb)]),e("div",Nb,"ç¬¬ "+oe(y.pageNumber)+" é¡µ",1)],10,Lb))),128))])])):ge("",!0),N.value==="downloading"?(R(),E("div",Vb,[e("div",Wb," ä¸‹è½½è¿›åº¦: "+oe(C.value.current)+"/"+oe(C.value.total),1),e("div",Kb,[e("div",{class:"progress-fill",style:ot({width:`${k.value}%`})},null,4)])])):ge("",!0)]),e("div",qb,[e("button",{class:"cancel-btn",onClick:b,disabled:N.value==="downloading"}," å–æ¶ˆ ",8,Hb),e("button",{class:"import-btn",disabled:!U.value?.success||g.value===0||Y.value,onClick:H},[N.value==="downloading"?(R(),E("span",Jb)):(R(),E("span",Gb,"ğŸ“¥")),Ce(" "+oe(N.value==="downloading"?"ä¸‹è½½ä¸­...":"å¯¼å…¥"),1)],8,jb)])])])):ge("",!0)]))}}),Xb=je(Yb,[["__scopeId","data-v-78fc5cb0"]]),Zb={class:"app-header"},Qb={class:"header-content"},eh={class:"logo-container"},th={class:"header-links"},oh={class:"container"},nh={id:"image-display-area"},sh={id:"upload-section",class:"card upload-card"},ah={class:"upload-actions"},lh={key:1,class:"bookshelf-mode-hint"},ih=Je({__name:"TranslateView",setup(s){const t=on(),n=Qe(),o=Ue(),l=rn(),i=ct(),{validateBeforeTranslation:a,initValidation:r}=cn(),h=po(),T=Xl(),S=_(!1),D=_(void 0),B=_(!1),I=_(!1),A=_(null),w=_(null),N=q(()=>n.currentImage),W=q(()=>n.hasImages);q(()=>n.imageCount),q(()=>n.currentImageIndex+1),q(()=>W.value&&!n.isBatchTranslationInProgress),q(()=>n.canGoPrevious),q(()=>n.canGoNext);const U=q(()=>n.isBatchTranslationInProgress);q(()=>{if(!U.value)return 0;const se=n.completedImageCount,J=n.imageCount;return J>0?Math.round(se/J*100):0}),q(()=>`${n.completedImageCount}/${n.imageCount}`);const f=q(()=>n.failedImageCount>0),g=q(()=>!!t.query.book&&!!t.query.chapter),C=q(()=>t.query.book),k=q(()=>t.query.chapter),V=q(()=>T.currentBookTitle.value),Y=q(()=>T.currentChapterTitle.value),ie=q(()=>g.value&&Y.value&&V.value?`${Y.value} - ${V.value}`:"Saber-Translator");ut(async()=>{n.clearImages(),i.clearBubbles(),await T.initializeApp(),r(),window.addEventListener("keydown",he)}),Dt(()=>{window.removeEventListener("keydown",he)}),xe(()=>[t.query.book,t.query.chapter],async([se,J],[z,te])=>{se&&J?(n.clearImages(),i.clearBubbles(),await X()):z&&te&&!se&&!J&&(n.clearImages(),i.clearBubbles(),await T.initializeBookChapterContext(),console.log("[TranslateView] ä»ä¹¦æ¶æ¨¡å¼åˆ‡æ¢åˆ°å¿«é€Ÿç¿»è¯‘æ¨¡å¼ï¼Œå·²æ¸…ç©ºæ•°æ®"))}),xe(ie,se=>{typeof document<"u"&&(document.title=se)},{immediate:!0});async function X(){if(!(!C.value||!k.value))try{await T.initializeBookChapterContext()}catch(se){console.error("åŠ è½½ç« èŠ‚ä¼šè¯å¤±è´¥:",se),fe("åŠ è½½ç« èŠ‚ä¼šè¯å¤±è´¥","error")}}function ae(se){console.log(`ä¸Šä¼ å®Œæˆï¼Œå…± ${se} å¼ å›¾ç‰‡`),n.hasImages&&(n.sortImagesByFileName(),T.switchImage(0))}async function Q(se){const J=N.value;if(!J||!J.bubbleStates||J.bubbleStates.length===0){fe("è¯·å…ˆé€‰æ‹©ä¸€å¼ å·²ç¿»è¯‘çš„å›¾ç‰‡","warning");return}if(n.images.length<=1){fe("åªæœ‰ä¸€å¼ å›¾ç‰‡ï¼Œæ— éœ€åº”ç”¨åˆ°å…¨éƒ¨","info");return}if(!Object.values(se).some(te=>te)){fe("è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè¦åº”ç”¨çš„è®¾ç½®é¡¹","warning");return}try{const te=J.bubbleStates[0],ee={};se.fontSize&&(ee.fontSize=te.fontSize),se.fontFamily&&(ee.fontFamily=te.fontFamily),se.layoutDirection&&(ee.textDirection=te.textDirection==="auto"?"vertical":te.textDirection),se.textColor&&(ee.textColor=te.textColor),se.fillColor&&(ee.fillColor=te.fillColor),se.strokeEnabled&&(ee.strokeEnabled=te.strokeEnabled),se.strokeColor&&(ee.strokeColor=te.strokeColor),se.strokeWidth&&(ee.strokeWidth=te.strokeWidth);const ce=Ie=>{const we={...Ie};return se.fontSize&&ee.fontSize!==void 0&&(we.fontSize=ee.fontSize),se.fontFamily&&ee.fontFamily!==void 0&&(we.fontFamily=ee.fontFamily),se.layoutDirection&&ee.textDirection!==void 0&&(we.textDirection=ee.textDirection),se.textColor&&ee.textColor!==void 0&&(we.textColor=ee.textColor),se.fillColor&&ee.fillColor!==void 0&&(we.fillColor=ee.fillColor),se.strokeEnabled&&ee.strokeEnabled!==void 0&&(we.strokeEnabled=ee.strokeEnabled),se.strokeColor&&ee.strokeColor!==void 0&&(we.strokeColor=ee.strokeColor),se.strokeWidth&&ee.strokeWidth!==void 0&&(we.strokeWidth=ee.strokeWidth),we};let ve=0;const _e=n.images;for(let Ie=0;Ie<_e.length;Ie++){const we=_e[Ie];if(we&&we.bubbleStates&&we.bubbleStates.length>0){const Ve=we.bubbleStates.map(ce);n.updateImageByIndex(Ie,{bubbleStates:Ve}),ve++}}if(i.bubbles.length>0){const Ie=i.bubbles.map(ce);i.setBubbles(Ie)}const be=[];se.fontSize&&be.push("å­—å·"),se.fontFamily&&be.push("å­—ä½“"),se.layoutDirection&&be.push("æ’ç‰ˆæ–¹å‘"),se.textColor&&be.push("æ–‡å­—é¢œè‰²"),se.fillColor&&be.push("å¡«å……é¢œè‰²"),se.strokeEnabled&&be.push("æè¾¹å¼€å…³"),se.strokeColor&&be.push("æè¾¹é¢œè‰²"),se.strokeWidth&&be.push("æè¾¹å®½åº¦");const pe=[];for(let Ie=0;Ie<_e.length;Ie++){const we=_e[Ie];we&&we.translatedDataURL&&we.bubbleStates&&we.bubbleStates.length>0&&pe.push(Ie)}if(pe.length>0){const{apiClient:Ie}=await lt(async()=>{const{apiClient:Oe}=await import("./client.Bht704G-.js");return{apiClient:Oe}},__vite__mapDeps([4,5])),we=o.settings.textStyle.layoutDirection,Ve=we==="auto";for(let Oe=0;Oe<pe.length;Oe++){const Pe=pe[Oe];if(Pe===void 0)continue;const Re=n.images[Pe];if(!(!Re||!Re.bubbleStates))try{let Ge="";if(Re.cleanImageData?Ge=Re.cleanImageData.includes("base64,")?Re.cleanImageData.split("base64,")[1]||"":Re.cleanImageData:Re.originalDataURL&&(Ge=Re.originalDataURL.includes("base64,")?Re.originalDataURL.split("base64,")[1]||"":Re.originalDataURL,console.log(`handleApplyToAll: å›¾ç‰‡ ${Pe} ä½¿ç”¨åŸå›¾ä½œä¸ºèƒŒæ™¯ï¼ˆå…œåº•ï¼‰`)),!Ge){console.log(`handleApplyToAll: å›¾ç‰‡ ${Pe} æ²¡æœ‰å¯ç”¨çš„èƒŒæ™¯å›¾ï¼Œè·³è¿‡`);continue}const at=Re.bubbleStates.map(ke=>({translatedText:ke.translatedText||"",coords:ke.coords,fontSize:ke.fontSize||o.settings.textStyle.fontSize,fontFamily:ke.fontFamily||o.settings.textStyle.fontFamily,textDirection:Ct(ke),textColor:ke.textColor||o.settings.textStyle.textColor,rotationAngle:ke.rotationAngle||0,position:ke.position||{x:0,y:0},strokeEnabled:ke.strokeEnabled??o.settings.textStyle.strokeEnabled,strokeColor:ke.strokeColor||o.settings.textStyle.strokeColor,strokeWidth:ke.strokeWidth??o.settings.textStyle.strokeWidth})),it=await Ie.post("/api/re_render_image",{clean_image:Ge,bubble_texts:at.map(ke=>ke.translatedText),bubble_coords:at.map(ke=>ke.coords),fontSize:o.settings.textStyle.fontSize,fontFamily:o.settings.textStyle.fontFamily,textDirection:Ve?"vertical":we,textColor:o.settings.textStyle.textColor,bubble_states:at,use_individual_styles:!0,use_inpainting:!1,use_lama:!1,fillColor:null,is_font_style_change:!0,strokeEnabled:o.settings.textStyle.strokeEnabled,strokeColor:o.settings.textStyle.strokeColor,strokeWidth:o.settings.textStyle.strokeWidth});it.rendered_image&&n.updateImageByIndex(Pe,{translatedDataURL:`data:image/png;base64,${it.rendered_image}`,hasUnsavedChanges:!0})}catch(Ge){console.error(`é‡æ¸²æŸ“å›¾ç‰‡ ${Pe} å¤±è´¥:`,Ge)}}}fe(`å·²å°† ${be.join("ã€")} åº”ç”¨åˆ° ${ve} å¼ å›¾ç‰‡`,"success"),console.log(`[TranslateView] åº”ç”¨è®¾ç½®åˆ°å…¨éƒ¨å®Œæˆï¼Œæ›´æ–°äº† ${ve} å¼ å›¾ç‰‡ï¼Œé‡æ¸²æŸ“äº† ${pe.length} å¼ `)}catch(te){console.error("åº”ç”¨è®¾ç½®åˆ°å…¨éƒ¨å¤±è´¥:",te),fe("åº”ç”¨è®¾ç½®å¤±è´¥","error")}}async function p(){N.value&&a("normal")&&await h.translateCurrentImage()}async function m(){W.value&&a("normal")&&await h.translateAllImages()}async function x(){W.value&&a("hq")&&await h.executeHqTranslation()}async function b(){W.value&&a("proofread")&&await h.executeProofreading()}async function u(){N.value&&await h.removeTextOnly()}async function c(){W.value&&await h.removeAllTexts()}function M(){if(!N.value)return;const se=N.value.fileName||`å›¾ç‰‡ ${n.currentImageIndex+1}`;confirm(`ç¡®å®šè¦åˆ é™¤å½“å‰å›¾ç‰‡ (${se}) å—ï¼Ÿ`)&&(n.deleteCurrentImage(),fe("å›¾ç‰‡å·²åˆ é™¤","success"))}function H(){W.value&&confirm("ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰å›¾ç‰‡å—ï¼Ÿè¿™å°†ä¸¢å¤±æ‰€æœ‰æœªä¿å­˜çš„è¿›åº¦ã€‚")&&(n.clearImages(),fe("æ‰€æœ‰å›¾ç‰‡å·²æ¸…é™¤","success"))}async function $(){try{const se=await nn(),J=await ro();if(se.success&&J.success)fe("ä¸´æ—¶æ–‡ä»¶æ¸…ç†å®Œæˆ","success");else{const z=[];se.success||z.push("è°ƒè¯•æ–‡ä»¶æ¸…ç†å¤±è´¥"),J.success||z.push("ä¸´æ—¶æ–‡ä»¶æ¸…ç†å¤±è´¥"),fe(z.join("ï¼Œ"),"warning")}}catch{fe("æ¸…ç†ä¸´æ—¶æ–‡ä»¶å¤±è´¥","error")}}function O(){T.goToPrevious()}function P(){T.goToNext()}function v(){I.value=!I.value}async function F(){if(!f.value){fe("æ²¡æœ‰å¤±è´¥çš„å›¾ç‰‡éœ€è¦é‡æ–°ç¿»è¯‘","info");return}a("normal")&&await h.retryFailedImages()}async function d(){if(!W.value){fe("æ²¡æœ‰å¯ä¿å­˜çš„å†…å®¹","warning");return}if(!(!C.value||!k.value))try{await l.saveChapterSession(C.value,k.value)?fe("ç« èŠ‚è¿›åº¦å·²ä¿å­˜","success"):fe("ä¿å­˜å¤±è´¥","error")}catch(se){console.error("ä¿å­˜ä¼šè¯å¤±è´¥:",se),fe("ä¿å­˜å¤±è´¥: "+(se instanceof Error?se.message:"æœªçŸ¥é”™è¯¯"),"error")}}function y(se){D.value=se,S.value=!0}function ue(){y("plugins")}function L(){fe("è®¾ç½®å·²ä¿å­˜","success")}function j(){B.value=!0}function le(){fe("ğŸŒ™ è¯¥åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­ï¼Œæ•¬è¯·æœŸå¾…ï¼","info")}function he(se){const J=se.target;if(!(J instanceof HTMLInputElement||J instanceof HTMLTextAreaElement||J.getAttribute("contenteditable")==="true"||J.id==="bubbleTextEditor")&&!I.value&&se.altKey)switch(se.key){case"ArrowLeft":se.preventDefault(),O();break;case"ArrowRight":se.preventDefault(),P();break;case"ArrowUp":if(se.preventDefault(),!o.settings.textStyle.autoFontSize){const te=o.settings.textStyle.fontSize;o.updateTextStyle({fontSize:te+1})}break;case"ArrowDown":if(se.preventDefault(),!o.settings.textStyle.autoFontSize){const te=o.settings.textStyle.fontSize;o.updateTextStyle({fontSize:Math.max(10,te-1)})}break}}async function $e(se){const J=N.value;if(!J||!J.translatedDataURL){console.log(`è‡ªåŠ¨å­—å·è®¾ç½®å˜æ›´: ${se} (ä»…å½±å“ä¸‹æ¬¡ç¿»è¯‘)`);return}const z=J.bubbleStates;if(!z||!Array.isArray(z)||z.length===0){console.log("å½“å‰å›¾ç‰‡æ²¡æœ‰ bubbleStatesï¼Œè·³è¿‡é‡æ¸²æŸ“");return}if(console.log(`è‡ªåŠ¨å­—å·è®¾ç½®å˜æ›´: ${se}ï¼Œå°†é‡æ–°æ¸²æŸ“...`),se){console.log("è‡ªåŠ¨å­—å·å·²å¼€å¯ï¼Œé‡æ–°è®¡ç®—å­—å·å¹¶æ¸²æŸ“...");try{const{apiClient:te}=await lt(async()=>{const{apiClient:pe}=await import("./client.Bht704G-.js");return{apiClient:pe}},__vite__mapDeps([4,5]));let ee="";if(J.cleanImageData){const pe=J.cleanImageData;ee=pe.includes("base64,")?pe.split("base64,")[1]||"":pe}else J.originalDataURL&&(ee=J.originalDataURL.includes("base64,")?J.originalDataURL.split("base64,")[1]||"":J.originalDataURL);if(!ee){console.log("æ²¡æœ‰å¯ç”¨çš„èƒŒæ™¯å›¾ï¼Œè·³è¿‡é‡æ¸²æŸ“");return}const ce=z.map(pe=>({translatedText:pe.translatedText||"",coords:pe.coords,fontSize:pe.fontSize||o.settings.textStyle.fontSize,fontFamily:pe.fontFamily||o.settings.textStyle.fontFamily,textDirection:Ct(pe),textColor:pe.textColor||o.settings.textStyle.textColor,rotationAngle:pe.rotationAngle||0,position:pe.position||{x:0,y:0},strokeEnabled:pe.strokeEnabled??o.settings.textStyle.strokeEnabled,strokeColor:pe.strokeColor||o.settings.textStyle.strokeColor,strokeWidth:pe.strokeWidth??o.settings.textStyle.strokeWidth})),ve=ce.map(pe=>pe.translatedText),_e=ce.map(pe=>pe.coords),be=await te.post("/api/re_render_image",{clean_image:ee,bubble_texts:ve,bubble_coords:_e,fontSize:o.settings.textStyle.fontSize,fontFamily:o.settings.textStyle.fontFamily,textDirection:o.settings.textStyle.layoutDirection==="auto"?"vertical":o.settings.textStyle.layoutDirection,textColor:o.settings.textStyle.textColor,bubble_states:ce,use_individual_styles:!0,use_inpainting:!1,use_lama:!1,fillColor:null,is_font_style_change:!0,autoFontSize:!0,strokeEnabled:o.settings.textStyle.strokeEnabled,strokeColor:o.settings.textStyle.strokeColor,strokeWidth:o.settings.textStyle.strokeWidth});if(be.rendered_image){if(be.bubble_states&&Array.isArray(be.bubble_states)){const pe=z.map((Ie,we)=>({...Ie,fontSize:be.bubble_states[we]?.fontSize??Ie.fontSize}));n.updateCurrentImage({translatedDataURL:`data:image/png;base64,${be.rendered_image}`,bubbleStates:pe,hasUnsavedChanges:!0}),i.setBubbles(pe)}else n.updateCurrentImage({translatedDataURL:`data:image/png;base64,${be.rendered_image}`,hasUnsavedChanges:!0});console.log("è‡ªåŠ¨å­—å·æ¸²æŸ“æˆåŠŸ")}else be.error&&(console.error("è‡ªåŠ¨å­—å·æ¸²æŸ“å¤±è´¥:",be.error),fe("é‡æ–°æ¸²æŸ“å¤±è´¥: "+be.error,"error"))}catch(te){console.error("è‡ªåŠ¨å­—å·æ¸²æŸ“å‡ºé”™:",te)}}else{const te=o.settings.textStyle.fontSize;console.log(`è‡ªåŠ¨å­—å·å·²å…³é—­ï¼Œä½¿ç”¨å›ºå®šå­—å· ${te} æ¸²æŸ“...`);const ee=z.map(ce=>({...ce,fontSize:te}));n.updateCurrentImage({bubbleStates:ee}),i.setBubbles(ee),await Ae("fontSize",te)}}async function Ae(se,J){const z=N.value;if(!z||!z.translatedDataURL||!z.bubbleStates||z.bubbleStates.length===0||!["fontSize","fontFamily","layoutDirection","textColor","strokeEnabled","strokeColor","strokeWidth","fillColor"].includes(se))return;console.log(`å…¨å±€è®¾ç½®å˜æ›´ (${se}=${J})ï¼Œå‡†å¤‡é‡æ¸²æŸ“...`);const ce={fontSize:"fontSize",fontFamily:"fontFamily",layoutDirection:"textDirection",textColor:"textColor",strokeEnabled:"strokeEnabled",strokeColor:"strokeColor",strokeWidth:"strokeWidth",fillColor:"fillColor"}[se];if(ce&&z.bubbleStates)if(se==="layoutDirection"&&J==="auto")console.log("æ’ç‰ˆæ–¹å‘è®¾ç½®ä¸º 'auto'ï¼Œä¸ä¿®æ”¹æ°”æ³¡çš„ textDirectionï¼Œä½¿ç”¨ autoTextDirection æ¸²æŸ“");else{const ve=z.bubbleStates.map(_e=>({..._e,[ce]:J}));n.updateCurrentImage({bubbleStates:ve}),i.setBubbles(ve)}try{const _e=n.currentImage?.bubbleStates||z.bubbleStates||[];if(_e.length===0||!_e[0]?.coords){console.log("æ²¡æœ‰æœ‰æ•ˆçš„æ°”æ³¡åæ ‡ï¼Œè·³è¿‡é‡æ¸²æŸ“");return}const be=o.settings.textStyle.layoutDirection,pe=_e.map(Re=>({translatedText:Re.translatedText||"",coords:Re.coords,fontSize:Re.fontSize||o.settings.textStyle.fontSize,fontFamily:Re.fontFamily||o.settings.textStyle.fontFamily,textDirection:Ct(Re),textColor:Re.textColor||o.settings.textStyle.textColor,rotationAngle:Re.rotationAngle||0,position:Re.position||{x:0,y:0},strokeEnabled:Re.strokeEnabled??o.settings.textStyle.strokeEnabled,strokeColor:Re.strokeColor||o.settings.textStyle.strokeColor,strokeWidth:Re.strokeWidth??o.settings.textStyle.strokeWidth})),Ie=pe.map(Re=>Re.translatedText),we=pe.map(Re=>Re.coords);let Ve="";if(z.cleanImageData){const Re=z.cleanImageData;Ve=Re.includes("base64,")?Re.split("base64,")[1]||"":Re}else z.originalDataURL&&(Ve=z.originalDataURL.includes("base64,")?z.originalDataURL.split("base64,")[1]||"":z.originalDataURL,console.log("handleTextStyleChanged: ä½¿ç”¨åŸå›¾ä½œä¸ºèƒŒæ™¯ï¼ˆå…œåº•ï¼‰"));if(!Ve){console.log("æ²¡æœ‰å¯ç”¨çš„èƒŒæ™¯å›¾ï¼Œè·³è¿‡é‡æ¸²æŸ“");return}const{apiClient:Oe}=await lt(async()=>{const{apiClient:Re}=await import("./client.Bht704G-.js");return{apiClient:Re}},__vite__mapDeps([4,5])),Pe=await Oe.post("/api/re_render_image",{clean_image:Ve,bubble_texts:Ie,bubble_coords:we,fontSize:o.settings.textStyle.fontSize,fontFamily:o.settings.textStyle.fontFamily,textDirection:be==="auto"?"vertical":be,textColor:o.settings.textStyle.textColor,bubble_states:pe,use_individual_styles:!0,use_inpainting:!1,use_lama:!1,fillColor:null,is_font_style_change:!0,strokeEnabled:o.settings.textStyle.strokeEnabled,strokeColor:o.settings.textStyle.strokeColor,strokeWidth:o.settings.textStyle.strokeWidth});Pe.rendered_image?(n.updateCurrentImage({translatedDataURL:`data:image/png;base64,${Pe.rendered_image}`,hasUnsavedChanges:!0}),console.log("è®¾ç½®å˜æ›´åé‡æ–°æ¸²æŸ“æˆåŠŸ")):Pe.error&&console.error("é‡æ–°æ¸²æŸ“å¤±è´¥:",Pe.error)}catch(ve){console.error("è®¾ç½®å˜æ›´åé‡æ–°æ¸²æŸ“å¤±è´¥:",ve)}}function Me(se){T.switchImage(se)}return(se,J)=>{const z=es("router-link");return R(),E("div",{class:Te(["translate-page",{"edit-mode-active":I.value}])},[e("header",Zb,[e("div",Qb,[e("div",eh,[ye(z,{to:"/",title:"è¿”å›ä¹¦æ¶"},{default:yt(()=>[...J[3]||(J[3]=[e("img",{src:"/pic/logo.png",alt:"Saber-Translator Logo",class:"app-logo"},null,-1),e("span",{class:"app-name"},"Saber-Translator",-1)])]),_:1})]),e("div",th,[ye(z,{to:"/",class:"back-to-shelf",title:"è¿”å›ä¹¦æ¶"},{default:yt(()=>[...J[4]||(J[4]=[Ce("ğŸ“š",-1)])]),_:1}),g.value?(R(),E("button",{key:0,class:"save-header-btn",title:"ä¿å­˜è¿›åº¦",onClick:d}," ğŸ’¾ ")):ge("",!0),e("button",{id:"openSettingsBtn",class:"settings-header-btn",title:"æ‰“å¼€è®¾ç½®",onClick:J[0]||(J[0]=te=>y())},[...J[5]||(J[5]=[e("span",{class:"icon"},"âš™ï¸",-1),e("span",null,"è®¾ç½®",-1)])]),J[8]||(J[8]=e("a",{href:"http://www.mashirosaber.top",target:"_blank",class:"tutorial-link"},"ä½¿ç”¨æ•™ç¨‹",-1)),e("a",{href:"javascript:void(0)",class:"donate-link",onClick:j},[...J[6]||(J[6]=[e("span",null,"â¤ï¸ è¯·ä½œè€…å–å¥¶èŒ¶",-1)])]),J[9]||(J[9]=e("a",{href:"https://github.com/MashiroSaber03",target:"_blank",class:"github-link"},[e("img",{src:"/pic/github.jpg",alt:"GitHub",class:"github-icon"})],-1)),e("button",{class:"theme-toggle",title:"åŠŸèƒ½å¼€å‘ä¸­",onClick:le},[...J[7]||(J[7]=[e("span",{class:"theme-icon"},"â˜€ï¸",-1)])])])])]),e("div",oh,[ye(Ya,{onTranslateCurrent:p,onTranslateAll:m,onHqTranslate:x,onProofread:b,onRemoveText:u,onRemoveAllText:c,onRetryFailed:F,onDeleteCurrent:M,onClearAll:H,onCleanTemp:$,onOpenPlugins:ue,onOpenSettings:y,onPrevious:O,onNext:P,onApplyToAll:Q,onTextStyleChanged:Ae,onAutoFontSizeChanged:$e}),e("main",nh,[e("section",sh,[e("div",ah,[ye(Js,{ref_key:"imageUploadRef",ref:A,onUploadComplete:ae},null,512)]),K(l).loadingProgress.total>0?(R(),st(go,{key:0,visible:!0,percentage:K(l).loadingProgress.current/K(l).loadingProgress.total*100,label:K(l).loadingProgress.message},null,8,["percentage","label"])):ge("",!0),ye(yi,{progress:K(h).progress.value},null,8,["progress"]),U.value&&g.value?(R(),E("div",lh,[...J[10]||(J[10]=[e("span",{style:{color:"#888","font-size":"0.85em"}}," ï¼ˆä¹¦æ¶æ¨¡å¼ä¸‹é€€å‡ºå‰è¯·ç‚¹å‡»é¡¶éƒ¨ä¿å­˜æŒ‰é’®ï¼‰ ",-1)])])):ge("",!0)]),ye(yl,{ref_key:"imageResultRef",ref:w,"is-edit-mode":I.value,onToggleEditMode:v,onRetryFailed:F},null,8,["is-edit-mode"])]),W.value&&!I.value?(R(),st(qi,{key:0,onSelect:Me})):ge("",!0)]),N.value&&I.value?(R(),st(_v,{key:0,"is-edit-mode-active":I.value,onExit:v},null,8,["is-edit-mode-active"])):ge("",!0),ye(Sl,{onOpenSettings:y}),ye(mp,{modelValue:S.value,"onUpdate:modelValue":J[1]||(J[1]=te=>S.value=te),"initial-tab":D.value,onSave:L},null,8,["modelValue","initial-tab"]),B.value?(R(),st(_i,{key:1,onClose:J[2]||(J[2]=te=>B.value=!1)})):ge("",!0),ye(Xb)],2)}}}),bh=je(ih,[["__scopeId","data-v-518dd956"]]);export{bh as default};
