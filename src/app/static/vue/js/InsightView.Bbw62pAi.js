import{d as Ds,r as _,c as z,a as ze,i as p,f as ue,h as c,J as st,e,v as T,b as et,n as H,t as $,x as Ns,u as ge,y as K,z as X,l as nt,F as Z,j as le,B as oe,k as we,H as tt,K as as,w as ft,I as js,o as Fs,D as Qs,E as Ft,C as Hs}from"./vue-vendor.DDJbHApa.js";import{u as ms,_ as Js}from"./bookshelfStore.DE2j25LI.js";import{_ as Ke,u as Gs}from"./index.Dz1DNgba.js";import{_ as Se}from"./CustomSelect.vue_vue_type_style_index_0_lang.3BEAab7t.js";import{apiClient as ae}from"./client.Bht704G-.js";import{B as Zs}from"./BaseModal.B6buknA4.js";import{fetchModels as Ws}from"./config.CwRcCkM9.js";import"./bookshelf.C_zUWUVG.js";import"./utils-vendor.B9ygI19o.js";async function Xs(a,t){return ae.post(`/api/manga-insight/${a}/analyze/start`,t)}async function Ys(a,t){return ae.post(`/api/manga-insight/${a}/analyze/pause`,{task_id:t})}async function en(a,t){return ae.post(`/api/manga-insight/${a}/analyze/resume`,{task_id:t})}async function tn(a,t){return ae.post(`/api/manga-insight/${a}/analyze/cancel`,{task_id:t})}async function gs(a){return ae.get(`/api/manga-insight/${a}/analyze/status`)}async function hs(a,t){return ae.post(`/api/manga-insight/${a}/reanalyze/page/${t}`)}async function sn(a,t){return ae.get(`/api/manga-insight/${a}/pages/${t}`)}function nn(a,t){return`/api/manga-insight/${a}/page-image/${t}`}function fs(a,t){return`/api/manga-insight/${a}/thumbnail/${t}`}async function ln(a){return ae.get(`/api/manga-insight/${a}/chapters`)}async function bs(a,t){return t?ae.get(`/api/manga-insight/${a}/overview/${t}`):ae.get(`/api/manga-insight/${a}/overview`)}async function an(a,t,l=!1){return ae.post(`/api/manga-insight/${a}/overview/generate`,{template:t,force:l})}async function ks(a){return ae.get(`/api/manga-insight/${a}/overview/templates`)}async function ys(a){return ae.get(`/api/manga-insight/${a}/timeline`)}async function on(a){return ae.post(`/api/manga-insight/${a}/regenerate/timeline`,{})}async function rn(a,t,l){return ae.post(`/api/manga-insight/${a}/chat`,{question:t,...l})}async function un(a){return ae.post(`/api/manga-insight/${a}/rebuild-embeddings`,{})}async function cn(){return ae.get("/api/manga-insight/config")}async function dn(a){return ae.post("/api/manga-insight/config",a)}async function pn(a){return ae.post("/api/manga-insight/config/test/vlm",a)}async function vn(a){return ae.post("/api/manga-insight/config/test/embedding",a)}async function mn(a){return ae.post("/api/manga-insight/config/test/reranker",a)}async function gn(a){return ae.post("/api/manga-insight/config/test/llm",a)}const os={batch_analysis:{label:"ğŸ“„ æ‰¹é‡åˆ†ææç¤ºè¯",hint:"ç”¨äºæ‰¹é‡åˆ†æå¤šä¸ªé¡µé¢ã€‚æ”¯æŒå˜é‡ï¼š{page_count}, {start_page}, {end_page}"},segment_summary:{label:"ğŸ“‘ æ®µè½æ€»ç»“æç¤ºè¯",hint:"ç”¨äºæ±‡æ€»å¤šä¸ªæ‰¹æ¬¡çš„åˆ†æç»“æœç”Ÿæˆæ®µè½æ€»ç»“ã€‚"},chapter_summary:{label:"ğŸ“– ç« èŠ‚æ€»ç»“æç¤ºè¯",hint:"ç”¨äºç”Ÿæˆç« èŠ‚çº§åˆ«çš„å®Œæ•´æ€»ç»“ã€‚"},qa_response:{label:"ğŸ’¬ é—®ç­”å“åº”æç¤ºè¯",hint:"ç”¨äºå›ç­”ç”¨æˆ·å…³äºæ¼«ç”»å†…å®¹çš„é—®é¢˜ã€‚"}},Ye={batch_analysis:`ã€è¾“å‡ºä¸­æ–‡ã€‘åˆ†æä»¥ä¸‹ {page_count} é¡µæ¼«ç”»å†…å®¹ï¼ˆç¬¬ {start_page} é¡µåˆ°ç¬¬ {end_page} é¡µï¼‰ã€‚

è¯·æå–ä»¥ä¸‹ä¿¡æ¯ï¼Œä»¥ JSON æ ¼å¼è¾“å‡ºï¼š
{
    "pages": [
        {
            "page_num": <é¡µç >,
            "summary": "<è¯¥é¡µå†…å®¹æ¦‚è¿°ï¼Œ2-3å¥è¯>",
            "dialogues": [
                {"character": "<è§’è‰²åæˆ–'æ—ç™½'>", "text": "<å¯¹è¯å†…å®¹>"}
            ],
            "scene": "<åœºæ™¯æè¿°>",
            "mood": "<æ°›å›´/æƒ…ç»ª>"
        }
    ],
    "batch_summary": "<è¿™å‡ é¡µçš„æ•´ä½“æ¦‚è¿°ï¼Œ3-5å¥è¯>",
    "key_events": ["<å…³é”®äº‹ä»¶1>", "<å…³é”®äº‹ä»¶2>"]
}

è¦æ±‚ï¼š
1. å‡†ç¡®è¯†åˆ«å¯¹è¯å†…å®¹å’Œè¯´è¯è€…
2. æ³¨æ„ç”»é¢ä¸­çš„æ–‡å­—ã€éŸ³æ•ˆ
3. æè¿°é‡è¦çš„è§†è§‰å…ƒç´ å’Œè¡¨æƒ…`,segment_summary:`ã€è¾“å‡ºä¸­æ–‡ã€‘åŸºäºä»¥ä¸‹æ‰¹æ¬¡åˆ†æç»“æœï¼Œç”Ÿæˆæ®µè½æ€»ç»“ã€‚

è¯·ç”Ÿæˆæ®µè½æ€»ç»“ï¼ŒJSON æ ¼å¼ï¼š
{
    "summary": "<æ®µè½æ•´ä½“æ¦‚è¿°ï¼Œ3-5å¥è¯>",
    "plot_points": ["<å‰§æƒ…è¦ç‚¹1>", "<å‰§æƒ…è¦ç‚¹2>"],
    "character_developments": ["<è§’è‰²å‘å±•1>"],
    "themes": ["<ä¸»é¢˜1>"]
}

è¦æ±‚ï¼š
1. ç»¼åˆå¤šä¸ªæ‰¹æ¬¡çš„ä¿¡æ¯
2. çªå‡ºé‡è¦è§’è‰²å’Œå…³é”®äº‹ä»¶
3. æ³¨æ„å‰§æƒ…çš„å› æœå…³ç³»`,chapter_summary:`ã€è¾“å‡ºä¸­æ–‡ã€‘åŸºäºä»¥ä¸‹å†…å®¹ï¼Œç”Ÿæˆå®Œæ•´çš„ç« èŠ‚æ€»ç»“ã€‚

è¯·ç”Ÿæˆç« èŠ‚æ€»ç»“ï¼ŒJSON æ ¼å¼ï¼š
{
    "summary": "<ç« èŠ‚æ•´ä½“æ¦‚è¿°ï¼Œ5-8å¥è¯>",
    "main_plot": "<ä¸»è¦å‰§æƒ…çº¿æè¿°>",
    "key_events": ["<ç« èŠ‚å…³é”®äº‹ä»¶ï¼ŒæŒ‰é¡ºåº>"],
    "themes": ["<æœ¬ç« ä¸»é¢˜>"],
    "atmosphere": "<æ•´ä½“æ°›å›´>"
}

è¦æ±‚ï¼š
1. ç»¼åˆæ‰€æœ‰å†…å®¹ï¼Œå½¢æˆå®Œæ•´çš„ç« èŠ‚å™è¿°
2. ç†æ¸…äººç‰©å…³ç³»å’Œå‰§æƒ…è„‰ç»œ
3. æç‚¼ç« èŠ‚ä¸»é¢˜å’Œæ ¸å¿ƒå†²çª`,qa_response:`ã€è¾“å‡ºä¸­æ–‡ã€‘æ ¹æ®åˆ†æç»“æœå›ç­”ç”¨æˆ·é—®é¢˜ï¼Œå¼•ç”¨ç›¸å…³é¡µé¢ã€‚
å›ç­”æ—¶è¯·ï¼š
1. åŸºäºæä¾›çš„æ¼«ç”»å†…å®¹å›ç­”
2. å¼•ç”¨å…·ä½“é¡µç ä½œä¸ºä¾æ®
3. å¦‚æœé—®é¢˜è¶…å‡ºå·²åˆ†æå†…å®¹ï¼Œè¯·è¯šå®è¯´æ˜`};async function hn(){return ae.get("/api/manga-insight/prompts/library")}async function fn(a){return ae.post("/api/manga-insight/prompts/library",a)}async function bn(a){return ae.delete(`/api/manga-insight/prompts/library/${a}`)}async function kn(a){return ae.post("/api/manga-insight/prompts/library/import",{library:a})}async function _s(a){return ae.get(`/api/manga-insight/${a}/export`)}const rs="insight_provider_configs",De=Ds("insight",()=>{const a=_(null),t=_(null),l=_("idle"),s=_({current:0,total:0,status:"idle"}),n=_(0),i=_(0),o=_("full"),f=_(!0),m=_([]),w=_(new Map),S=_(null),B=_([]),R=_([]),M=_([]),L=_([]),V=_(null),O=_("all"),N=_(!1),j=_(!1),J=_(null),u=_({vlm:{provider:"gemini",apiKey:"",model:"gemini-2.0-flash",baseUrl:"",rpmLimit:10,temperature:.3,forceJson:!1,useStream:!0,imageMaxSize:0},llm:{useSameAsVlm:!0,provider:"gemini",apiKey:"",model:"gemini-2.0-flash",baseUrl:"",useStream:!0},embedding:{provider:"openai",apiKey:"",model:"text-embedding-3-small",baseUrl:"",rpmLimit:0},reranker:{provider:"jina",apiKey:"",model:"jina-reranker-v2-base-multilingual",baseUrl:"",topK:5},batch:{pagesPerBatch:5,contextBatchCount:1,architecturePreset:"standard",customLayers:[]},prompts:{}}),P=_({vlm:{},llm:{},embedding:{},reranker:{}}),v=z(()=>s.value.total===0?0:Math.round(s.value.current/s.value.total*100)),h=z(()=>l.value==="running"),C=z(()=>l.value==="completed"),A=z(()=>{if(i.value>0)return i.value;let d=0;return w.value.forEach(x=>{x.analyzed&&d++}),d}),E=z(()=>n.value||w.value.size),q=z(()=>O.value==="all"?L.value:L.value.filter(d=>d.type===O.value)),te=z(()=>V.value===null?null:w.value.get(V.value)||null);function I(d){a.value=d,d?(console.log(`å½“å‰åˆ†æä¹¦ç±: ${d}`),console.log("å‡†å¤‡åŠ è½½ç¬”è®°..."),be()):L.value=[]}function g(d){l.value=d,s.value.status=d,console.log(`åˆ†æçŠ¶æ€: ${d}`)}function k(d){t.value=d}function U(d,x,F){s.value={current:d,total:x,status:l.value,message:F}}function Y(d){o.value=d}function ce(d){f.value=d}function Pe(d){n.value=d,console.log(`ä¹¦ç±æ€»é¡µæ•°: ${d}`)}function xe(d){i.value=d,console.log(`å·²åˆ†æé¡µæ•°: ${d}`)}function Ne(d){m.value=d,console.log(`ç« èŠ‚åˆ—è¡¨å·²è®¾ç½®ï¼Œå…± ${d.length} ç« `)}function ye(d,x){w.value.set(d,x)}function je(d){w.value.clear();for(const x of d)w.value.set(x.pageNum,x);console.log(`é¡µé¢æ•°æ®å·²è®¾ç½®ï¼Œå…± ${d.length} é¡µ`)}function de(d){V.value=d}function Ie(d){S.value=d,d&&!B.value.includes(d.type)&&B.value.push(d.type)}function Ue(d){B.value=d}function _e(d){R.value=d,console.log(`æ—¶é—´çº¿å·²è®¾ç½®ï¼Œå…± ${d.length} ä¸ªäº‹ä»¶`)}function Me(d){M.value.push(d)}function Fe(d){const x=M.value[M.value.length-1];x&&x.role==="assistant"&&(x.content=d)}function Te(){M.value=[]}function Ee(){M.value=M.value.filter(d=>!d.isLoading)}function $e(d){j.value=d}function Ve(d){V.value=d}async function Qe(d){if(await lt(d))L.value.unshift(d),console.log(`å·²æ·»åŠ ç¬”è®°: ${d.id}`);else throw new Error("ä¿å­˜ç¬”è®°åˆ°åç«¯å¤±è´¥")}async function ve(d,x){const F=L.value.find(ke=>ke.id===d);F&&(Object.assign(F,x,{updatedAt:new Date().toISOString()}),await gt(d,x),console.log(`å·²æ›´æ–°ç¬”è®°: ${d}`))}async function re(d){const x=L.value.findIndex(F=>F.id===d);x>=0&&(await wt(d)?(L.value.splice(x,1),console.log(`å·²åˆ é™¤ç¬”è®°: ${d}`)):console.error(`åˆ é™¤ç¬”è®°å¤±è´¥: ${d}`))}function pe(d){O.value=d}async function be(){if(console.log("loadNotesFromAPI è¢«è°ƒç”¨, bookId:",a.value),!!a.value)try{const x=await(await fetch(`/api/manga-insight/${a.value}/notes`)).json();console.log("ç¬”è®°APIå“åº”:",x),x.success&&x.notes?(L.value=x.notes,console.log(`å·²ä»APIåŠ è½½ ${L.value.length} æ¡ç¬”è®°`)):(console.log("APIè¿”å›æ— ç¬”è®°æ•°æ®"),L.value=[])}catch(d){console.error("ä»APIåŠ è½½ç¬”è®°å¤±è´¥:",d),L.value=[]}}async function lt(d){if(!a.value)return!1;try{return(await(await fetch(`/api/manga-insight/${a.value}/notes`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(d)})).json()).success}catch(x){return console.error("ä¿å­˜ç¬”è®°åˆ°APIå¤±è´¥:",x),!1}}async function gt(d,x){if(!a.value)return!1;try{return(await(await fetch(`/api/manga-insight/${a.value}/notes/${d}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(x)})).json()).success}catch(F){return console.error("æ›´æ–°ç¬”è®°åˆ°APIå¤±è´¥:",F),!1}}async function wt(d){if(!a.value)return!1;try{return(await(await fetch(`/api/manga-insight/${a.value}/notes/${d}`,{method:"DELETE"})).json()).success}catch(x){return console.error("ä»APIåˆ é™¤ç¬”è®°å¤±è´¥:",x),!1}}function xt(d){N.value=d}function Ct(d){J.value=d}function St(d){u.value.vlm={...u.value.vlm,...d},at(u.value.vlm.provider),he()}function Pt(d){u.value.llm={...u.value.llm,...d},Ge(u.value.llm.provider),he()}function It(d){u.value.embedding={...u.value.embedding,...d},ot(u.value.embedding.provider),he()}function Tt(d){u.value.reranker={...u.value.reranker,...d},it(u.value.reranker.provider),he()}function At(d){u.value.batch={...u.value.batch,...d},he()}function Lt(d){u.value.prompts={...u.value.prompts,...d},he()}function Rt(d){const x=u.value.vlm.provider;x!==d&&(at(x),u.value.vlm.provider=d,He(d),he(),console.log(`[Insight] VLM æœåŠ¡å•†å·²åˆ‡æ¢ä¸º: ${d}`))}function Bt(d){const x=u.value.llm.provider;x!==d&&(Ge(x),u.value.llm.provider=d,Et(d),he(),console.log(`[Insight] LLM æœåŠ¡å•†å·²åˆ‡æ¢ä¸º: ${d}`))}function zt(d){const x=u.value.embedding.provider;x!==d&&(ot(x),u.value.embedding.provider=d,rt(d),he(),console.log(`[Insight] Embedding æœåŠ¡å•†å·²åˆ‡æ¢ä¸º: ${d}`))}function Ut(d){const x=u.value.reranker.provider;x!==d&&(it(x),u.value.reranker.provider=d,Vt(d),he(),console.log(`[Insight] Reranker æœåŠ¡å•†å·²åˆ‡æ¢ä¸º: ${d}`))}function Je(){localStorage.setItem(rs,JSON.stringify(P.value))}function Mt(){const d=localStorage.getItem(rs);if(d)try{const x=JSON.parse(d);P.value={vlm:x.vlm||{},llm:x.llm||{},embedding:x.embedding||{},reranker:x.reranker||{}},console.log("[Insight] å·²åŠ è½½æœåŠ¡å•†é…ç½®ç¼“å­˜")}catch(x){console.error("[Insight] åŠ è½½æœåŠ¡å•†é…ç½®ç¼“å­˜å¤±è´¥:",x)}}function at(d){d&&(P.value.vlm[d]={apiKey:u.value.vlm.apiKey,model:u.value.vlm.model,baseUrl:u.value.vlm.baseUrl,rpmLimit:u.value.vlm.rpmLimit,temperature:u.value.vlm.temperature,forceJson:u.value.vlm.forceJson,useStream:u.value.vlm.useStream,imageMaxSize:u.value.vlm.imageMaxSize},Je(),console.log(`[Insight] ä¿å­˜ VLM æœåŠ¡å•†é…ç½®: ${d}`))}function He(d){if(!d)return;const x=P.value.vlm[d];x?(x.apiKey!==void 0&&(u.value.vlm.apiKey=x.apiKey),x.model!==void 0&&(u.value.vlm.model=x.model),x.baseUrl!==void 0&&(u.value.vlm.baseUrl=x.baseUrl),x.rpmLimit!==void 0&&(u.value.vlm.rpmLimit=x.rpmLimit),x.temperature!==void 0&&(u.value.vlm.temperature=x.temperature),x.forceJson!==void 0&&(u.value.vlm.forceJson=x.forceJson),x.useStream!==void 0&&(u.value.vlm.useStream=x.useStream),x.imageMaxSize!==void 0&&(u.value.vlm.imageMaxSize=x.imageMaxSize),console.log(`[Insight] æ¢å¤ VLM æœåŠ¡å•†é…ç½®: ${d}`)):(u.value.vlm.apiKey="",u.value.vlm.model="",u.value.vlm.baseUrl="",console.log(`[Insight] ${d} æ— ç¼“å­˜é…ç½®ï¼Œä½¿ç”¨é»˜è®¤å€¼`))}function Ge(d){d&&(P.value.llm[d]={apiKey:u.value.llm.apiKey,model:u.value.llm.model,baseUrl:u.value.llm.baseUrl,useStream:u.value.llm.useStream},Je(),console.log(`[Insight] ä¿å­˜ LLM æœåŠ¡å•†é…ç½®: ${d}`))}function Et(d){if(!d)return;const x=P.value.llm[d];x?(x.apiKey!==void 0&&(u.value.llm.apiKey=x.apiKey),x.model!==void 0&&(u.value.llm.model=x.model),x.baseUrl!==void 0&&(u.value.llm.baseUrl=x.baseUrl),x.useStream!==void 0&&(u.value.llm.useStream=x.useStream),console.log(`[Insight] æ¢å¤ LLM æœåŠ¡å•†é…ç½®: ${d}`)):(u.value.llm.apiKey="",u.value.llm.model="",u.value.llm.baseUrl="",console.log(`[Insight] ${d} æ— ç¼“å­˜é…ç½®ï¼Œä½¿ç”¨é»˜è®¤å€¼`))}function ot(d){d&&(P.value.embedding[d]={apiKey:u.value.embedding.apiKey,model:u.value.embedding.model,baseUrl:u.value.embedding.baseUrl,rpmLimit:u.value.embedding.rpmLimit},Je(),console.log(`[Insight] ä¿å­˜ Embedding æœåŠ¡å•†é…ç½®: ${d}`))}function rt(d){if(!d)return;const x=P.value.embedding[d];x?(x.apiKey!==void 0&&(u.value.embedding.apiKey=x.apiKey),x.model!==void 0&&(u.value.embedding.model=x.model),x.baseUrl!==void 0&&(u.value.embedding.baseUrl=x.baseUrl),x.rpmLimit!==void 0&&(u.value.embedding.rpmLimit=x.rpmLimit),console.log(`[Insight] æ¢å¤ Embedding æœåŠ¡å•†é…ç½®: ${d}`)):(u.value.embedding.apiKey="",u.value.embedding.model="",u.value.embedding.baseUrl="",console.log(`[Insight] ${d} æ— ç¼“å­˜é…ç½®ï¼Œä½¿ç”¨é»˜è®¤å€¼`))}function it(d){d&&(P.value.reranker[d]={apiKey:u.value.reranker.apiKey,model:u.value.reranker.model,baseUrl:u.value.reranker.baseUrl,topK:u.value.reranker.topK},Je(),console.log(`[Insight] ä¿å­˜ Reranker æœåŠ¡å•†é…ç½®: ${d}`))}function Vt(d){if(!d)return;const x=P.value.reranker[d];x?(x.apiKey!==void 0&&(u.value.reranker.apiKey=x.apiKey),x.model!==void 0&&(u.value.reranker.model=x.model),x.baseUrl!==void 0&&(u.value.reranker.baseUrl=x.baseUrl),x.topK!==void 0&&(u.value.reranker.topK=x.topK),console.log(`[Insight] æ¢å¤ Reranker æœåŠ¡å•†é…ç½®: ${d}`)):(u.value.reranker.apiKey="",u.value.reranker.model="",u.value.reranker.baseUrl="",console.log(`[Insight] ${d} æ— ç¼“å­˜é…ç½®ï¼Œä½¿ç”¨é»˜è®¤å€¼`))}function qt(d){u.value=d,he()}function he(){localStorage.setItem("manga_insight_config",JSON.stringify(u.value))}function Kt(){Mt();const x=localStorage.getItem("manga_insight_config");if(x)try{const F=JSON.parse(x);u.value={vlm:{...u.value.vlm,...F.vlm},llm:{...u.value.llm,...F.llm},embedding:{...u.value.embedding,...F.embedding},reranker:{...u.value.reranker,...F.reranker},batch:{...u.value.batch,...F.batch},prompts:F.prompts||{}},console.log("å·²åŠ è½½æ¼«ç”»åˆ†æé…ç½®")}catch(F){console.error("åŠ è½½æ¼«ç”»åˆ†æé…ç½®å¤±è´¥:",F)}}function Ot(){return{vlm:{provider:u.value.vlm.provider,api_key:u.value.vlm.apiKey,model:u.value.vlm.model,base_url:u.value.vlm.baseUrl||null,rpm_limit:u.value.vlm.rpmLimit,temperature:u.value.vlm.temperature,force_json:u.value.vlm.forceJson,use_stream:u.value.vlm.useStream,image_max_size:u.value.vlm.imageMaxSize},chat_llm:{use_same_as_vlm:u.value.llm.useSameAsVlm,provider:u.value.llm.provider,api_key:u.value.llm.apiKey,model:u.value.llm.model,base_url:u.value.llm.baseUrl||null,use_stream:u.value.llm.useStream},embedding:{provider:u.value.embedding.provider,api_key:u.value.embedding.apiKey,model:u.value.embedding.model,base_url:u.value.embedding.baseUrl||null,rpm_limit:u.value.embedding.rpmLimit},reranker:{provider:u.value.reranker.provider,api_key:u.value.reranker.apiKey,model:u.value.reranker.model,base_url:u.value.reranker.baseUrl||null,top_k:u.value.reranker.topK},analysis:{batch:{pages_per_batch:u.value.batch.pagesPerBatch,context_batch_count:u.value.batch.contextBatchCount,architecture_preset:u.value.batch.architecturePreset,custom_layers:u.value.batch.customLayers.map(d=>({name:d.name,units_per_group:d.units,align_to_chapter:d.align}))}},prompts:u.value.prompts,providerSettings:Dt()}}function Dt(){const d={},x={},F={},ke={};for(const[me,se]of Object.entries(P.value.vlm))d[me]={api_key:se.apiKey||"",model:se.model||"",base_url:se.baseUrl||"",rpm_limit:se.rpmLimit??10,temperature:se.temperature??.3,force_json:se.forceJson??!1,use_stream:se.useStream??!0,image_max_size:se.imageMaxSize??0};for(const[me,se]of Object.entries(P.value.llm))x[me]={api_key:se.apiKey||"",model:se.model||"",base_url:se.baseUrl||"",use_stream:se.useStream??!0};for(const[me,se]of Object.entries(P.value.embedding))F[me]={api_key:se.apiKey||"",model:se.model||"",base_url:se.baseUrl||"",rpm_limit:se.rpmLimit??0};for(const[me,se]of Object.entries(P.value.reranker))ke[me]={api_key:se.apiKey||"",model:se.model||"",base_url:se.baseUrl||"",top_k:se.topK??5};return{vlmProvider:d,llmProvider:x,embeddingProvider:F,rerankerProvider:ke}}function Nt(d){const x=d.vlm,F=d.chat_llm,ke=d.embedding,me=d.reranker,qe=d.analysis?.batch;if(x&&(u.value.vlm={provider:x.provider||"gemini",apiKey:x.api_key||"",model:x.model||"",baseUrl:x.base_url||"",rpmLimit:x.rpm_limit||10,temperature:x.temperature||.3,forceJson:x.force_json||!1,useStream:x.use_stream!==!1,imageMaxSize:x.image_max_size||0}),F&&(u.value.llm={useSameAsVlm:F.use_same_as_vlm!==!1,provider:F.provider||u.value.vlm.provider,apiKey:F.api_key||u.value.vlm.apiKey,model:F.model||u.value.vlm.model,baseUrl:F.base_url||u.value.vlm.baseUrl,useStream:F.use_stream!==!1}),ke&&(u.value.embedding={provider:ke.provider||"openai",apiKey:ke.api_key||"",model:ke.model||"",baseUrl:ke.base_url||"",rpmLimit:ke.rpm_limit??0}),me&&(u.value.reranker={provider:me.provider||"jina",apiKey:me.api_key||"",model:me.model||"",baseUrl:me.base_url||"",topK:me.top_k||5}),qe){const Le=qe.custom_layers;u.value.batch={pagesPerBatch:qe.pages_per_batch||5,contextBatchCount:qe.context_batch_count??1,architecturePreset:qe.architecture_preset||"standard",customLayers:Le?.map(ne=>({name:ne.name||"",units:ne.units_per_group||1,align:ne.align_to_chapter||!1}))||[]}}const Ae=d.providerSettings;if(Ae){if(Ae.vlmProvider)for(const[Le,ne]of Object.entries(Ae.vlmProvider))P.value.vlm[Le]={apiKey:ne.api_key||"",model:ne.model||"",baseUrl:ne.base_url||"",rpmLimit:ne.rpm_limit??10,temperature:ne.temperature??.3,forceJson:ne.force_json??!1,useStream:ne.use_stream??!0,imageMaxSize:ne.image_max_size??0};if(Ae.llmProvider)for(const[Le,ne]of Object.entries(Ae.llmProvider))P.value.llm[Le]={apiKey:ne.api_key||"",model:ne.model||"",baseUrl:ne.base_url||"",useStream:ne.use_stream??!0};if(Ae.embeddingProvider)for(const[Le,ne]of Object.entries(Ae.embeddingProvider))P.value.embedding[Le]={apiKey:ne.api_key||"",model:ne.model||"",baseUrl:ne.base_url||"",rpmLimit:ne.rpm_limit??0};if(Ae.rerankerProvider)for(const[Le,ne]of Object.entries(Ae.rerankerProvider))P.value.reranker[Le]={apiKey:ne.api_key||"",model:ne.model||"",baseUrl:ne.base_url||"",topK:ne.top_k??5};console.log("[Insight] å·²ä»åç«¯æ¢å¤æœåŠ¡å•†é…ç½®ç¼“å­˜"),Je()}const ut=d.prompts;ut&&(u.value.prompts=ut),he(),at(u.value.vlm.provider),Ge(u.value.llm.provider),ot(u.value.embedding.provider),it(u.value.reranker.provider),console.log("[Insight] å·²ä» API åŠ è½½é…ç½®")}function jt(){l.value="idle",s.value={current:0,total:0,status:"idle"},w.value.clear(),S.value=null,R.value=[],console.log("åˆ†æçŠ¶æ€å·²é‡ç½®")}function D(){a.value=null,l.value="idle",s.value={current:0,total:0,status:"idle"},o.value="full",f.value=!0,m.value=[],w.value.clear(),S.value=null,B.value=[],R.value=[],M.value=[],L.value=[],V.value=null,O.value="all",N.value=!1,j.value=!1,J.value=null,console.log("æ¼«ç”»åˆ†æçŠ¶æ€å·²é‡ç½®")}return{currentBookId:a,currentTaskId:t,analysisStatus:l,progress:s,analysisMode:o,incrementalAnalysis:f,chapters:m,pages:w,overview:S,generatedTemplates:B,timeline:R,qaHistory:M,notes:L,selectedPageNum:V,noteTypeFilter:O,isLoading:N,isStreaming:j,error:J,config:u,progressPercent:v,isAnalyzing:h,isAnalysisCompleted:C,analyzedPageCount:A,totalPageCount:E,filteredNotes:q,selectedPage:te,setCurrentBook:I,setCurrentTaskId:k,setAnalysisStatus:g,updateProgress:U,setAnalysisMode:Y,setIncrementalAnalysis:ce,setBookTotalPages:Pe,setAnalyzedPagesCount:xe,setChapters:Ne,setPageData:ye,setPages:je,selectPage:de,setOverview:Ie,setGeneratedTemplates:Ue,setTimeline:_e,addQAMessage:Me,updateLastAssistantMessage:Fe,clearQAHistory:Te,removeLoadingMessages:Ee,setStreaming:$e,setCurrentPage:Ve,addNote:Qe,updateNote:ve,deleteNote:re,setNoteTypeFilter:pe,loadNotesFromAPI:be,setLoading:xt,setError:Ct,updateVlmConfig:St,updateLlmConfig:Pt,updateEmbeddingConfig:It,updateRerankerConfig:Tt,updateBatchConfig:At,updatePrompts:Lt,setConfig:qt,saveConfigToStorage:he,loadConfigFromStorage:Kt,getConfigForApi:Ot,setConfigFromApi:Nt,setVlmProvider:Rt,setLlmProvider:Bt,setEmbeddingProvider:zt,setRerankerProvider:Ut,resetAnalysis:jt,reset:D}}),yn={class:"book-selector"},_n=ze({__name:"BookSelector",emits:["select"],setup(a,{emit:t}){const l=t,s=ms(),n=z(()=>s.books),i=z(()=>{const m=[{label:"-- é€‰æ‹©ä¹¦ç± --",value:""}];return n.value.forEach(w=>{m.push({label:w.title||w.id,value:w.id})}),m}),o=_("");function f(m){o.value=m,m&&l("select",m)}return(m,w)=>(c(),p("div",yn,[ue(Se,{modelValue:o.value,"onUpdate:modelValue":w[0]||(w[0]=S=>o.value=S),options:i.value,onChange:f},null,8,["modelValue","options"])]))}}),$n=Ke(_n,[["__scopeId","data-v-f3d6be77"]]),wn={class:"sidebar-section analysis-control-compact"},xn={class:"analysis-status-bar"},Cn={class:"status-left"},Sn={class:"status-label"},Pn={class:"status-right"},In={class:"status-progress"},Tn={key:1,class:"progress-message"},An={class:"analysis-btn-group"},Ln={key:0,class:"btn-group-idle"},Rn=["disabled"],Bn={key:0,width:"16",height:"16",viewBox:"0 0 24 24",fill:"currentColor"},zn={key:1,class:"loading-spinner"},Un={key:1,class:"btn-group-running"},Mn={key:2,class:"btn-group-paused"},En={key:4,class:"page-input-wrapper"},Vn=["max"],qn={class:"page-hint"},Kn={key:5,class:"mode-description"},On={key:6,class:"estimated-time"},Dn={class:"analysis-options-row"},Nn={class:"checkbox-compact",title:"ä»…åˆ†ææœªåˆ†æçš„é¡µé¢ï¼Œè·³è¿‡å·²åˆ†æçš„é¡µé¢"},jn=["checked"],Fn=["disabled"],Qn=ze({__name:"AnalysisProgress",emits:["start-polling","stop-polling"],setup(a,{emit:t}){const l=[{label:"å…¨ä¹¦",value:"full"},{label:"ç« èŠ‚",value:"chapter"},{label:"å•é¡µ",value:"page"}],s=z(()=>{const g=[{label:"é€‰æ‹©ç« èŠ‚...",value:""}];return i.chapters.forEach(k=>{g.push({label:`${k.title} (${k.startPage}-${k.endPage}é¡µ)`,value:k.id})}),g}),n=t,i=De(),o=_("full"),f=_(""),m=_(null),w=_(!1),S=_(""),B=z(()=>{const g=i.analysisStatus;return{"status-dot":!0,running:g==="running",paused:g==="paused",completed:g==="completed",failed:g==="failed"}}),R=z(()=>{switch(i.analysisStatus){case"running":return"åˆ†æä¸­";case"paused":return"å·²æš‚åœ";case"completed":return"å·²å®Œæˆ";case"failed":return"åˆ†æå¤±è´¥";default:return"æœªåˆ†æ"}}),M=z(()=>{const{current:g,total:k}=i.progress;return k===0?"":`${g}/${k}`}),L=z(()=>i.analysisStatus==="idle"||i.analysisStatus==="completed"),V=z(()=>i.analysisStatus==="running"),O=z(()=>i.analysisStatus==="paused"),N=z(()=>i.analysisStatus==="completed"?"é‡æ–°åˆ†æ":"å¼€å§‹åˆ†æ"),j=z(()=>o.value==="chapter"),J=z(()=>o.value==="page"),u=z(()=>!(w.value||i.isAnalyzing||o.value==="chapter"&&!f.value||o.value==="page"&&!m.value)),P=z(()=>{switch(o.value){case"full":return"åˆ†ææ•´æœ¬ä¹¦çš„æ‰€æœ‰é¡µé¢";case"chapter":return"ä»…åˆ†æé€‰ä¸­ç« èŠ‚çš„é¡µé¢";case"page":return"ä»…åˆ†ææŒ‡å®šçš„å•ä¸ªé¡µé¢";default:return""}}),v=z(()=>{const g=i.totalPageCount;if(g===0)return"";const k=i.config.batch.pagesPerBatch||5,Y=Math.ceil(g/k)*10;return Y<60?`çº¦ ${Y} ç§’`:`çº¦ ${Math.ceil(Y/60)} åˆ†é’Ÿ`});function h(){i.setAnalysisMode(o.value)}async function C(){if(i.currentBookId){if(i.isAnalyzing||w.value){console.warn("åˆ†ææ­£åœ¨è¿›è¡Œä¸­æˆ–æ­£åœ¨å¯åŠ¨");return}if(o.value==="chapter"&&!f.value){S.value="è¯·é€‰æ‹©è¦åˆ†æçš„ç« èŠ‚";return}if(o.value==="page"&&!m.value){S.value="è¯·è¾“å…¥è¦åˆ†æçš„é¡µç ";return}w.value=!0,S.value="";try{const g={};o.value==="chapter"&&f.value?(g.mode="chapters",g.chapters=[f.value]):o.value==="page"&&m.value?(g.mode="pages",g.pages=[m.value]):g.mode=i.incrementalAnalysis?"incremental":"full";const k=await Xs(i.currentBookId,g);k.success?(k.task_id&&i.setCurrentTaskId(k.task_id),i.setAnalysisStatus("running"),n("start-polling")):(S.value=k.error||"å¯åŠ¨åˆ†æå¤±è´¥",console.error("å¯åŠ¨åˆ†æå¤±è´¥:",k.error))}catch(g){S.value=g instanceof Error?g.message:"å¯åŠ¨åˆ†æå¤±è´¥",console.error("å¯åŠ¨åˆ†æå¤±è´¥:",g)}finally{w.value=!1}}}async function A(){if(i.currentBookId)try{(await Ys(i.currentBookId,i.currentTaskId||void 0)).success&&i.setAnalysisStatus("paused")}catch(g){console.error("æš‚åœåˆ†æå¤±è´¥:",g)}}async function E(){if(i.currentBookId)try{(await en(i.currentBookId,i.currentTaskId||void 0)).success&&(i.setAnalysisStatus("running"),n("start-polling"))}catch(g){console.error("ç»§ç»­åˆ†æå¤±è´¥:",g)}}async function q(){if(i.currentBookId&&confirm("ç¡®å®šè¦å–æ¶ˆåˆ†æå—ï¼Ÿ"))try{(await tn(i.currentBookId,i.currentTaskId||void 0)).success&&(i.setAnalysisStatus("idle"),i.setCurrentTaskId(null),n("stop-polling"))}catch(g){console.error("å–æ¶ˆåˆ†æå¤±è´¥:",g)}}async function te(){if(!i.currentBookId){S.value="è¯·å…ˆé€‰æ‹©ä¹¦ç±";return}try{const g=await _s(i.currentBookId);if(g.success&&g.markdown){const k=new Blob([g.markdown],{type:"text/markdown"}),U=URL.createObjectURL(k),Y=document.createElement("a");Y.href=U,Y.download=`${i.currentBookId}_analysis.md`,Y.click(),URL.revokeObjectURL(U)}else S.value=g.error||"å¯¼å‡ºå¤±è´¥"}catch(g){S.value=g instanceof Error?g.message:"å¯¼å‡ºå¤±è´¥",console.error("å¯¼å‡ºå¤±è´¥:",g)}}function I(){S.value=""}return st(o,()=>{I()}),(g,k)=>(c(),p("div",wn,[e("div",xn,[e("div",Cn,[e("span",{class:H(B.value)},null,2),e("span",Sn,$(R.value),1)]),e("div",Pn,[e("span",In,$(M.value),1)])]),V.value||O.value?(c(),p("div",{key:0,class:H(["progress-bar-slim",{paused:O.value}])},[e("div",{class:"progress-fill-slim",style:Ns({width:ge(i).progressPercent+"%"})},null,4)],2)):T("",!0),ge(i).progress.message&&(V.value||O.value)?(c(),p("div",Tn,$(ge(i).progress.message),1)):T("",!0),S.value?(c(),p("div",{key:2,class:"error-message",onClick:I}," âš ï¸ "+$(S.value),1)):T("",!0),e("div",An,[L.value?(c(),p("div",Ln,[ue(Se,{modelValue:o.value,"onUpdate:modelValue":k[0]||(k[0]=U=>o.value=U),options:l,onChange:h},null,8,["modelValue"]),e("button",{class:H(["btn-analysis-start",{loading:w.value}]),disabled:!u.value,onClick:C},[w.value?T("",!0):(c(),p("svg",Bn,[...k[4]||(k[4]=[e("path",{d:"M8 5v14l11-7z"},null,-1)])])),w.value?(c(),p("span",zn)):T("",!0),e("span",null,$(w.value?"å¯åŠ¨ä¸­...":N.value),1)],10,Rn)])):T("",!0),V.value?(c(),p("div",Un,[e("button",{class:"btn-control btn-pause",title:"æš‚åœåˆ†æ",onClick:A},[...k[5]||(k[5]=[e("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"currentColor"},[e("path",{d:"M6 19h4V5H6v14zm8-14v14h4V5h-4z"})],-1),e("span",{class:"btn-label"},"æš‚åœ",-1)])]),e("button",{class:"btn-control btn-cancel",title:"å–æ¶ˆåˆ†æ",onClick:q},[...k[6]||(k[6]=[e("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"currentColor"},[e("path",{d:"M6 6h12v12H6z"})],-1),e("span",{class:"btn-label"},"å–æ¶ˆ",-1)])])])):T("",!0),O.value?(c(),p("div",Mn,[e("button",{class:"btn-control btn-resume",title:"ç»§ç»­åˆ†æ",onClick:E},[...k[7]||(k[7]=[e("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"currentColor"},[e("path",{d:"M8 5v14l11-7z"})],-1),e("span",{class:"btn-label"},"ç»§ç»­",-1)])]),e("button",{class:"btn-control btn-cancel",title:"å–æ¶ˆåˆ†æ",onClick:q},[...k[8]||(k[8]=[e("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"currentColor"},[e("path",{d:"M6 6h12v12H6z"})],-1),e("span",{class:"btn-label"},"å–æ¶ˆ",-1)])])])):T("",!0)]),j.value?(c(),et(Se,{key:3,modelValue:f.value,"onUpdate:modelValue":k[1]||(k[1]=U=>f.value=U),options:s.value},null,8,["modelValue","options"])):T("",!0),J.value?(c(),p("div",En,[K(e("input",{"onUpdate:modelValue":k[2]||(k[2]=U=>m.value=U),type:"number",class:"form-input-compact",placeholder:"è¾“å…¥é¡µç ",min:"1",max:ge(i).totalPageCount||void 0},null,8,Vn),[[X,m.value,void 0,{number:!0}]]),e("span",qn,"/ "+$(ge(i).totalPageCount||"?"),1)])):T("",!0),L.value&&P.value?(c(),p("div",Kn,$(P.value),1)):T("",!0),L.value&&o.value==="full"&&v.value?(c(),p("div",On," â±ï¸ "+$(v.value),1)):T("",!0),e("div",Dn,[e("label",Nn,[e("input",{type:"checkbox",checked:ge(i).incrementalAnalysis,onChange:k[3]||(k[3]=U=>ge(i).setIncrementalAnalysis(U.target.checked))},null,40,jn),k[9]||(k[9]=e("span",null,"å¢é‡æ¨¡å¼",-1))]),e("button",{class:"btn-icon-sm",title:"å¯¼å‡ºåˆ†ææŠ¥å‘Š",disabled:ge(i).analyzedPageCount===0,onClick:te},[...k[10]||(k[10]=[e("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[e("path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"}),e("polyline",{points:"7 10 12 15 17 10"}),e("line",{x1:"12",y1:"15",x2:"12",y2:"3"})],-1)])],8,Fn)])]))}}),Hn=Ke(Qn,[["__scopeId","data-v-0ba2de66"]]);function Gt(){return{async:!1,breaks:!1,extensions:null,gfm:!0,hooks:null,pedantic:!1,renderer:null,silent:!1,tokenizer:null,walkTokens:null}}var Xe=Gt();function $s(a){Xe=a}var vt={exec:()=>null};function W(a,t=""){let l=typeof a=="string"?a:a.source,s={replace:(n,i)=>{let o=typeof i=="string"?i:i.source;return o=o.replace(fe.caret,"$1"),l=l.replace(n,o),s},getRegex:()=>new RegExp(l,t)};return s}var Jn=(()=>{try{return!!new RegExp("(?<=1)(?<!1)")}catch{return!1}})(),fe={codeRemoveIndent:/^(?: {1,4}| {0,3}\t)/gm,outputLinkReplace:/\\([\[\]])/g,indentCodeCompensation:/^(\s+)(?:```)/,beginningSpace:/^\s+/,endingHash:/#$/,startingSpaceChar:/^ /,endingSpaceChar:/ $/,nonSpaceChar:/[^ ]/,newLineCharGlobal:/\n/g,tabCharGlobal:/\t/g,multipleSpaceGlobal:/\s+/g,blankLine:/^[ \t]*$/,doubleBlankLine:/\n[ \t]*\n[ \t]*$/,blockquoteStart:/^ {0,3}>/,blockquoteSetextReplace:/\n {0,3}((?:=+|-+) *)(?=\n|$)/g,blockquoteSetextReplace2:/^ {0,3}>[ \t]?/gm,listReplaceTabs:/^\t+/,listReplaceNesting:/^ {1,4}(?=( {4})*[^ ])/g,listIsTask:/^\[[ xX]\] +\S/,listReplaceTask:/^\[[ xX]\] +/,listTaskCheckbox:/\[[ xX]\]/,anyLine:/\n.*\n/,hrefBrackets:/^<(.*)>$/,tableDelimiter:/[:|]/,tableAlignChars:/^\||\| *$/g,tableRowBlankLine:/\n[ \t]*$/,tableAlignRight:/^ *-+: *$/,tableAlignCenter:/^ *:-+: *$/,tableAlignLeft:/^ *:-+ *$/,startATag:/^<a /i,endATag:/^<\/a>/i,startPreScriptTag:/^<(pre|code|kbd|script)(\s|>)/i,endPreScriptTag:/^<\/(pre|code|kbd|script)(\s|>)/i,startAngleBracket:/^</,endAngleBracket:/>$/,pedanticHrefTitle:/^([^'"]*[^\s])\s+(['"])(.*)\2/,unicodeAlphaNumeric:/[\p{L}\p{N}]/u,escapeTest:/[&<>"']/,escapeReplace:/[&<>"']/g,escapeTestNoEncode:/[<>"']|&(?!(#\d{1,7}|#[Xx][a-fA-F0-9]{1,6}|\w+);)/,escapeReplaceNoEncode:/[<>"']|&(?!(#\d{1,7}|#[Xx][a-fA-F0-9]{1,6}|\w+);)/g,unescapeTest:/&(#(?:\d+)|(?:#x[0-9A-Fa-f]+)|(?:\w+));?/ig,caret:/(^|[^\[])\^/g,percentDecode:/%25/g,findPipe:/\|/g,splitPipe:/ \|/,slashPipe:/\\\|/g,carriageReturn:/\r\n|\r/g,spaceLine:/^ +$/gm,notSpaceStart:/^\S*/,endingNewline:/\n$/,listItemRegex:a=>new RegExp(`^( {0,3}${a})((?:[	 ][^\\n]*)?(?:\\n|$))`),nextBulletRegex:a=>new RegExp(`^ {0,${Math.min(3,a-1)}}(?:[*+-]|\\d{1,9}[.)])((?:[ 	][^\\n]*)?(?:\\n|$))`),hrRegex:a=>new RegExp(`^ {0,${Math.min(3,a-1)}}((?:- *){3,}|(?:_ *){3,}|(?:\\* *){3,})(?:\\n+|$)`),fencesBeginRegex:a=>new RegExp(`^ {0,${Math.min(3,a-1)}}(?:\`\`\`|~~~)`),headingBeginRegex:a=>new RegExp(`^ {0,${Math.min(3,a-1)}}#`),htmlBeginRegex:a=>new RegExp(`^ {0,${Math.min(3,a-1)}}<(?:[a-z].*>|!--)`,"i")},Gn=/^(?:[ \t]*(?:\n|$))+/,Zn=/^((?: {4}| {0,3}\t)[^\n]+(?:\n(?:[ \t]*(?:\n|$))*)?)+/,Wn=/^ {0,3}(`{3,}(?=[^`\n]*(?:\n|$))|~{3,})([^\n]*)(?:\n|$)(?:|([\s\S]*?)(?:\n|$))(?: {0,3}\1[~`]* *(?=\n|$)|$)/,mt=/^ {0,3}((?:-[\t ]*){3,}|(?:_[ \t]*){3,}|(?:\*[ \t]*){3,})(?:\n+|$)/,Xn=/^ {0,3}(#{1,6})(?=\s|$)(.*)(?:\n+|$)/,Zt=/(?:[*+-]|\d{1,9}[.)])/,ws=/^(?!bull |blockCode|fences|blockquote|heading|html|table)((?:.|\n(?!\s*?\n|bull |blockCode|fences|blockquote|heading|html|table))+?)\n {0,3}(=+|-+) *(?:\n+|$)/,xs=W(ws).replace(/bull/g,Zt).replace(/blockCode/g,/(?: {4}| {0,3}\t)/).replace(/fences/g,/ {0,3}(?:`{3,}|~{3,})/).replace(/blockquote/g,/ {0,3}>/).replace(/heading/g,/ {0,3}#{1,6}/).replace(/html/g,/ {0,3}<[^\n>]+>\n/).replace(/\|table/g,"").getRegex(),Yn=W(ws).replace(/bull/g,Zt).replace(/blockCode/g,/(?: {4}| {0,3}\t)/).replace(/fences/g,/ {0,3}(?:`{3,}|~{3,})/).replace(/blockquote/g,/ {0,3}>/).replace(/heading/g,/ {0,3}#{1,6}/).replace(/html/g,/ {0,3}<[^\n>]+>\n/).replace(/table/g,/ {0,3}\|?(?:[:\- ]*\|)+[\:\- ]*\n/).getRegex(),Wt=/^([^\n]+(?:\n(?!hr|heading|lheading|blockquote|fences|list|html|table| +\n)[^\n]+)*)/,el=/^[^\n]+/,Xt=/(?!\s*\])(?:\\[\s\S]|[^\[\]\\])+/,tl=W(/^ {0,3}\[(label)\]: *(?:\n[ \t]*)?([^<\s][^\s]*|<.*?>)(?:(?: +(?:\n[ \t]*)?| *\n[ \t]*)(title))? *(?:\n+|$)/).replace("label",Xt).replace("title",/(?:"(?:\\"?|[^"\\])*"|'[^'\n]*(?:\n[^'\n]+)*\n?'|\([^()]*\))/).getRegex(),sl=W(/^( {0,3}bull)([ \t][^\n]+?)?(?:\n|$)/).replace(/bull/g,Zt).getRegex(),_t="address|article|aside|base|basefont|blockquote|body|caption|center|col|colgroup|dd|details|dialog|dir|div|dl|dt|fieldset|figcaption|figure|footer|form|frame|frameset|h[1-6]|head|header|hr|html|iframe|legend|li|link|main|menu|menuitem|meta|nav|noframes|ol|optgroup|option|p|param|search|section|summary|table|tbody|td|tfoot|th|thead|title|tr|track|ul",Yt=/<!--(?:-?>|[\s\S]*?(?:-->|$))/,nl=W("^ {0,3}(?:<(script|pre|style|textarea)[\\s>][\\s\\S]*?(?:</\\1>[^\\n]*\\n+|$)|comment[^\\n]*(\\n+|$)|<\\?[\\s\\S]*?(?:\\?>\\n*|$)|<![A-Z][\\s\\S]*?(?:>\\n*|$)|<!\\[CDATA\\[[\\s\\S]*?(?:\\]\\]>\\n*|$)|</?(tag)(?: +|\\n|/?>)[\\s\\S]*?(?:(?:\\n[ 	]*)+\\n|$)|<(?!script|pre|style|textarea)([a-z][\\w-]*)(?:attribute)*? */?>(?=[ \\t]*(?:\\n|$))[\\s\\S]*?(?:(?:\\n[ 	]*)+\\n|$)|</(?!script|pre|style|textarea)[a-z][\\w-]*\\s*>(?=[ \\t]*(?:\\n|$))[\\s\\S]*?(?:(?:\\n[ 	]*)+\\n|$))","i").replace("comment",Yt).replace("tag",_t).replace("attribute",/ +[a-zA-Z:_][\w.:-]*(?: *= *"[^"\n]*"| *= *'[^'\n]*'| *= *[^\s"'=<>`]+)?/).getRegex(),Cs=W(Wt).replace("hr",mt).replace("heading"," {0,3}#{1,6}(?:\\s|$)").replace("|lheading","").replace("|table","").replace("blockquote"," {0,3}>").replace("fences"," {0,3}(?:`{3,}(?=[^`\\n]*\\n)|~{3,})[^\\n]*\\n").replace("list"," {0,3}(?:[*+-]|1[.)]) ").replace("html","</?(?:tag)(?: +|\\n|/?>)|<(?:script|pre|style|textarea|!--)").replace("tag",_t).getRegex(),ll=W(/^( {0,3}> ?(paragraph|[^\n]*)(?:\n|$))+/).replace("paragraph",Cs).getRegex(),es={blockquote:ll,code:Zn,def:tl,fences:Wn,heading:Xn,hr:mt,html:nl,lheading:xs,list:sl,newline:Gn,paragraph:Cs,table:vt,text:el},is=W("^ *([^\\n ].*)\\n {0,3}((?:\\| *)?:?-+:? *(?:\\| *:?-+:? *)*(?:\\| *)?)(?:\\n((?:(?! *\\n|hr|heading|blockquote|code|fences|list|html).*(?:\\n|$))*)\\n*|$)").replace("hr",mt).replace("heading"," {0,3}#{1,6}(?:\\s|$)").replace("blockquote"," {0,3}>").replace("code","(?: {4}| {0,3}	)[^\\n]").replace("fences"," {0,3}(?:`{3,}(?=[^`\\n]*\\n)|~{3,})[^\\n]*\\n").replace("list"," {0,3}(?:[*+-]|1[.)]) ").replace("html","</?(?:tag)(?: +|\\n|/?>)|<(?:script|pre|style|textarea|!--)").replace("tag",_t).getRegex(),al={...es,lheading:Yn,table:is,paragraph:W(Wt).replace("hr",mt).replace("heading"," {0,3}#{1,6}(?:\\s|$)").replace("|lheading","").replace("table",is).replace("blockquote"," {0,3}>").replace("fences"," {0,3}(?:`{3,}(?=[^`\\n]*\\n)|~{3,})[^\\n]*\\n").replace("list"," {0,3}(?:[*+-]|1[.)]) ").replace("html","</?(?:tag)(?: +|\\n|/?>)|<(?:script|pre|style|textarea|!--)").replace("tag",_t).getRegex()},ol={...es,html:W(`^ *(?:comment *(?:\\n|\\s*$)|<(tag)[\\s\\S]+?</\\1> *(?:\\n{2,}|\\s*$)|<tag(?:"[^"]*"|'[^']*'|\\s[^'"/>\\s]*)*?/?> *(?:\\n{2,}|\\s*$))`).replace("comment",Yt).replace(/tag/g,"(?!(?:a|em|strong|small|s|cite|q|dfn|abbr|data|time|code|var|samp|kbd|sub|sup|i|b|u|mark|ruby|rt|rp|bdi|bdo|span|br|wbr|ins|del|img)\\b)\\w+(?!:|[^\\w\\s@]*@)\\b").getRegex(),def:/^ *\[([^\]]+)\]: *<?([^\s>]+)>?(?: +(["(][^\n]+[")]))? *(?:\n+|$)/,heading:/^(#{1,6})(.*)(?:\n+|$)/,fences:vt,lheading:/^(.+?)\n {0,3}(=+|-+) *(?:\n+|$)/,paragraph:W(Wt).replace("hr",mt).replace("heading",` *#{1,6} *[^
]`).replace("lheading",xs).replace("|table","").replace("blockquote"," {0,3}>").replace("|fences","").replace("|list","").replace("|html","").replace("|tag","").getRegex()},rl=/^\\([!"#$%&'()*+,\-./:;<=>?@\[\]\\^_`{|}~])/,il=/^(`+)([^`]|[^`][\s\S]*?[^`])\1(?!`)/,Ss=/^( {2,}|\\)\n(?!\s*$)/,ul=/^(`+|[^`])(?:(?= {2,}\n)|[\s\S]*?(?:(?=[\\<!\[`*_]|\b_|$)|[^ ](?= {2,}\n)))/,$t=/[\p{P}\p{S}]/u,ts=/[\s\p{P}\p{S}]/u,Ps=/[^\s\p{P}\p{S}]/u,cl=W(/^((?![*_])punctSpace)/,"u").replace(/punctSpace/g,ts).getRegex(),Is=/(?!~)[\p{P}\p{S}]/u,dl=/(?!~)[\s\p{P}\p{S}]/u,pl=/(?:[^\s\p{P}\p{S}]|~)/u,vl=W(/link|precode-code|html/,"g").replace("link",/\[(?:[^\[\]`]|(?<a>`+)[^`]+\k<a>(?!`))*?\]\((?:\\[\s\S]|[^\\\(\)]|\((?:\\[\s\S]|[^\\\(\)])*\))*\)/).replace("precode-",Jn?"(?<!`)()":"(^^|[^`])").replace("code",/(?<b>`+)[^`]+\k<b>(?!`)/).replace("html",/<(?! )[^<>]*?>/).getRegex(),Ts=/^(?:\*+(?:((?!\*)punct)|[^\s*]))|^_+(?:((?!_)punct)|([^\s_]))/,ml=W(Ts,"u").replace(/punct/g,$t).getRegex(),gl=W(Ts,"u").replace(/punct/g,Is).getRegex(),As="^[^_*]*?__[^_*]*?\\*[^_*]*?(?=__)|[^*]+(?=[^*])|(?!\\*)punct(\\*+)(?=[\\s]|$)|notPunctSpace(\\*+)(?!\\*)(?=punctSpace|$)|(?!\\*)punctSpace(\\*+)(?=notPunctSpace)|[\\s](\\*+)(?!\\*)(?=punct)|(?!\\*)punct(\\*+)(?!\\*)(?=punct)|notPunctSpace(\\*+)(?=notPunctSpace)",hl=W(As,"gu").replace(/notPunctSpace/g,Ps).replace(/punctSpace/g,ts).replace(/punct/g,$t).getRegex(),fl=W(As,"gu").replace(/notPunctSpace/g,pl).replace(/punctSpace/g,dl).replace(/punct/g,Is).getRegex(),bl=W("^[^_*]*?\\*\\*[^_*]*?_[^_*]*?(?=\\*\\*)|[^_]+(?=[^_])|(?!_)punct(_+)(?=[\\s]|$)|notPunctSpace(_+)(?!_)(?=punctSpace|$)|(?!_)punctSpace(_+)(?=notPunctSpace)|[\\s](_+)(?!_)(?=punct)|(?!_)punct(_+)(?!_)(?=punct)","gu").replace(/notPunctSpace/g,Ps).replace(/punctSpace/g,ts).replace(/punct/g,$t).getRegex(),kl=W(/\\(punct)/,"gu").replace(/punct/g,$t).getRegex(),yl=W(/^<(scheme:[^\s\x00-\x1f<>]*|email)>/).replace("scheme",/[a-zA-Z][a-zA-Z0-9+.-]{1,31}/).replace("email",/[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+(@)[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)+(?![-_])/).getRegex(),_l=W(Yt).replace("(?:-->|$)","-->").getRegex(),$l=W("^comment|^</[a-zA-Z][\\w:-]*\\s*>|^<[a-zA-Z][\\w-]*(?:attribute)*?\\s*/?>|^<\\?[\\s\\S]*?\\?>|^<![a-zA-Z]+\\s[\\s\\S]*?>|^<!\\[CDATA\\[[\\s\\S]*?\\]\\]>").replace("comment",_l).replace("attribute",/\s+[a-zA-Z:_][\w.:-]*(?:\s*=\s*"[^"]*"|\s*=\s*'[^']*'|\s*=\s*[^\s"'=<>`]+)?/).getRegex(),bt=/(?:\[(?:\\[\s\S]|[^\[\]\\])*\]|\\[\s\S]|`+[^`]*?`+(?!`)|[^\[\]\\`])*?/,wl=W(/^!?\[(label)\]\(\s*(href)(?:(?:[ \t]*(?:\n[ \t]*)?)(title))?\s*\)/).replace("label",bt).replace("href",/<(?:\\.|[^\n<>\\])+>|[^ \t\n\x00-\x1f]*/).replace("title",/"(?:\\"?|[^"\\])*"|'(?:\\'?|[^'\\])*'|\((?:\\\)?|[^)\\])*\)/).getRegex(),Ls=W(/^!?\[(label)\]\[(ref)\]/).replace("label",bt).replace("ref",Xt).getRegex(),Rs=W(/^!?\[(ref)\](?:\[\])?/).replace("ref",Xt).getRegex(),xl=W("reflink|nolink(?!\\()","g").replace("reflink",Ls).replace("nolink",Rs).getRegex(),us=/[hH][tT][tT][pP][sS]?|[fF][tT][pP]/,ss={_backpedal:vt,anyPunctuation:kl,autolink:yl,blockSkip:vl,br:Ss,code:il,del:vt,emStrongLDelim:ml,emStrongRDelimAst:hl,emStrongRDelimUnd:bl,escape:rl,link:wl,nolink:Rs,punctuation:cl,reflink:Ls,reflinkSearch:xl,tag:$l,text:ul,url:vt},Cl={...ss,link:W(/^!?\[(label)\]\((.*?)\)/).replace("label",bt).getRegex(),reflink:W(/^!?\[(label)\]\s*\[([^\]]*)\]/).replace("label",bt).getRegex()},Qt={...ss,emStrongRDelimAst:fl,emStrongLDelim:gl,url:W(/^((?:protocol):\/\/|www\.)(?:[a-zA-Z0-9\-]+\.?)+[^\s<]*|^email/).replace("protocol",us).replace("email",/[A-Za-z0-9._+-]+(@)[a-zA-Z0-9-_]+(?:\.[a-zA-Z0-9-_]*[a-zA-Z0-9])+(?![-_])/).getRegex(),_backpedal:/(?:[^?!.,:;*_'"~()&]+|\([^)]*\)|&(?![a-zA-Z0-9]+;$)|[?!.,:;*_'"~)]+(?!$))+/,del:/^(~~?)(?=[^\s~])((?:\\[\s\S]|[^\\])*?(?:\\[\s\S]|[^\s~\\]))\1(?=[^~]|$)/,text:W(/^([`~]+|[^`~])(?:(?= {2,}\n)|(?=[a-zA-Z0-9.!#$%&'*+\/=?_`{\|}~-]+@)|[\s\S]*?(?:(?=[\\<!\[`*~_]|\b_|protocol:\/\/|www\.|$)|[^ ](?= {2,}\n)|[^a-zA-Z0-9.!#$%&'*+\/=?_`{\|}~-](?=[a-zA-Z0-9.!#$%&'*+\/=?_`{\|}~-]+@)))/).replace("protocol",us).getRegex()},Sl={...Qt,br:W(Ss).replace("{2,}","*").getRegex(),text:W(Qt.text).replace("\\b_","\\b_| {2,}\\n").replace(/\{2,\}/g,"*").getRegex()},ht={normal:es,gfm:al,pedantic:ol},ct={normal:ss,gfm:Qt,breaks:Sl,pedantic:Cl},Pl={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"},cs=a=>Pl[a];function Oe(a,t){if(t){if(fe.escapeTest.test(a))return a.replace(fe.escapeReplace,cs)}else if(fe.escapeTestNoEncode.test(a))return a.replace(fe.escapeReplaceNoEncode,cs);return a}function ds(a){try{a=encodeURI(a).replace(fe.percentDecode,"%")}catch{return null}return a}function ps(a,t){let l=a.replace(fe.findPipe,(i,o,f)=>{let m=!1,w=o;for(;--w>=0&&f[w]==="\\";)m=!m;return m?"|":" |"}),s=l.split(fe.splitPipe),n=0;if(s[0].trim()||s.shift(),s.length>0&&!s.at(-1)?.trim()&&s.pop(),t)if(s.length>t)s.splice(t);else for(;s.length<t;)s.push("");for(;n<s.length;n++)s[n]=s[n].trim().replace(fe.slashPipe,"|");return s}function dt(a,t,l){let s=a.length;if(s===0)return"";let n=0;for(;n<s&&a.charAt(s-n-1)===t;)n++;return a.slice(0,s-n)}function Il(a,t){if(a.indexOf(t[1])===-1)return-1;let l=0;for(let s=0;s<a.length;s++)if(a[s]==="\\")s++;else if(a[s]===t[0])l++;else if(a[s]===t[1]&&(l--,l<0))return s;return l>0?-2:-1}function vs(a,t,l,s,n){let i=t.href,o=t.title||null,f=a[1].replace(n.other.outputLinkReplace,"$1");s.state.inLink=!0;let m={type:a[0].charAt(0)==="!"?"image":"link",raw:l,href:i,title:o,text:f,tokens:s.inlineTokens(f)};return s.state.inLink=!1,m}function Tl(a,t,l){let s=a.match(l.other.indentCodeCompensation);if(s===null)return t;let n=s[1];return t.split(`
`).map(i=>{let o=i.match(l.other.beginningSpace);if(o===null)return i;let[f]=o;return f.length>=n.length?i.slice(n.length):i}).join(`
`)}var kt=class{options;rules;lexer;constructor(a){this.options=a||Xe}space(a){let t=this.rules.block.newline.exec(a);if(t&&t[0].length>0)return{type:"space",raw:t[0]}}code(a){let t=this.rules.block.code.exec(a);if(t){let l=t[0].replace(this.rules.other.codeRemoveIndent,"");return{type:"code",raw:t[0],codeBlockStyle:"indented",text:this.options.pedantic?l:dt(l,`
`)}}}fences(a){let t=this.rules.block.fences.exec(a);if(t){let l=t[0],s=Tl(l,t[3]||"",this.rules);return{type:"code",raw:l,lang:t[2]?t[2].trim().replace(this.rules.inline.anyPunctuation,"$1"):t[2],text:s}}}heading(a){let t=this.rules.block.heading.exec(a);if(t){let l=t[2].trim();if(this.rules.other.endingHash.test(l)){let s=dt(l,"#");(this.options.pedantic||!s||this.rules.other.endingSpaceChar.test(s))&&(l=s.trim())}return{type:"heading",raw:t[0],depth:t[1].length,text:l,tokens:this.lexer.inline(l)}}}hr(a){let t=this.rules.block.hr.exec(a);if(t)return{type:"hr",raw:dt(t[0],`
`)}}blockquote(a){let t=this.rules.block.blockquote.exec(a);if(t){let l=dt(t[0],`
`).split(`
`),s="",n="",i=[];for(;l.length>0;){let o=!1,f=[],m;for(m=0;m<l.length;m++)if(this.rules.other.blockquoteStart.test(l[m]))f.push(l[m]),o=!0;else if(!o)f.push(l[m]);else break;l=l.slice(m);let w=f.join(`
`),S=w.replace(this.rules.other.blockquoteSetextReplace,`
    $1`).replace(this.rules.other.blockquoteSetextReplace2,"");s=s?`${s}
${w}`:w,n=n?`${n}
${S}`:S;let B=this.lexer.state.top;if(this.lexer.state.top=!0,this.lexer.blockTokens(S,i,!0),this.lexer.state.top=B,l.length===0)break;let R=i.at(-1);if(R?.type==="code")break;if(R?.type==="blockquote"){let M=R,L=M.raw+`
`+l.join(`
`),V=this.blockquote(L);i[i.length-1]=V,s=s.substring(0,s.length-M.raw.length)+V.raw,n=n.substring(0,n.length-M.text.length)+V.text;break}else if(R?.type==="list"){let M=R,L=M.raw+`
`+l.join(`
`),V=this.list(L);i[i.length-1]=V,s=s.substring(0,s.length-R.raw.length)+V.raw,n=n.substring(0,n.length-M.raw.length)+V.raw,l=L.substring(i.at(-1).raw.length).split(`
`);continue}}return{type:"blockquote",raw:s,tokens:i,text:n}}}list(a){let t=this.rules.block.list.exec(a);if(t){let l=t[1].trim(),s=l.length>1,n={type:"list",raw:"",ordered:s,start:s?+l.slice(0,-1):"",loose:!1,items:[]};l=s?`\\d{1,9}\\${l.slice(-1)}`:`\\${l}`,this.options.pedantic&&(l=s?l:"[*+-]");let i=this.rules.other.listItemRegex(l),o=!1;for(;a;){let m=!1,w="",S="";if(!(t=i.exec(a))||this.rules.block.hr.test(a))break;w=t[0],a=a.substring(w.length);let B=t[2].split(`
`,1)[0].replace(this.rules.other.listReplaceTabs,V=>" ".repeat(3*V.length)),R=a.split(`
`,1)[0],M=!B.trim(),L=0;if(this.options.pedantic?(L=2,S=B.trimStart()):M?L=t[1].length+1:(L=t[2].search(this.rules.other.nonSpaceChar),L=L>4?1:L,S=B.slice(L),L+=t[1].length),M&&this.rules.other.blankLine.test(R)&&(w+=R+`
`,a=a.substring(R.length+1),m=!0),!m){let V=this.rules.other.nextBulletRegex(L),O=this.rules.other.hrRegex(L),N=this.rules.other.fencesBeginRegex(L),j=this.rules.other.headingBeginRegex(L),J=this.rules.other.htmlBeginRegex(L);for(;a;){let u=a.split(`
`,1)[0],P;if(R=u,this.options.pedantic?(R=R.replace(this.rules.other.listReplaceNesting,"  "),P=R):P=R.replace(this.rules.other.tabCharGlobal,"    "),N.test(R)||j.test(R)||J.test(R)||V.test(R)||O.test(R))break;if(P.search(this.rules.other.nonSpaceChar)>=L||!R.trim())S+=`
`+P.slice(L);else{if(M||B.replace(this.rules.other.tabCharGlobal,"    ").search(this.rules.other.nonSpaceChar)>=4||N.test(B)||j.test(B)||O.test(B))break;S+=`
`+R}!M&&!R.trim()&&(M=!0),w+=u+`
`,a=a.substring(u.length+1),B=P.slice(L)}}n.loose||(o?n.loose=!0:this.rules.other.doubleBlankLine.test(w)&&(o=!0)),n.items.push({type:"list_item",raw:w,task:!!this.options.gfm&&this.rules.other.listIsTask.test(S),loose:!1,text:S,tokens:[]}),n.raw+=w}let f=n.items.at(-1);if(f)f.raw=f.raw.trimEnd(),f.text=f.text.trimEnd();else return;n.raw=n.raw.trimEnd();for(let m of n.items){if(this.lexer.state.top=!1,m.tokens=this.lexer.blockTokens(m.text,[]),m.task){if(m.text=m.text.replace(this.rules.other.listReplaceTask,""),m.tokens[0]?.type==="text"||m.tokens[0]?.type==="paragraph"){m.tokens[0].raw=m.tokens[0].raw.replace(this.rules.other.listReplaceTask,""),m.tokens[0].text=m.tokens[0].text.replace(this.rules.other.listReplaceTask,"");for(let S=this.lexer.inlineQueue.length-1;S>=0;S--)if(this.rules.other.listIsTask.test(this.lexer.inlineQueue[S].src)){this.lexer.inlineQueue[S].src=this.lexer.inlineQueue[S].src.replace(this.rules.other.listReplaceTask,"");break}}let w=this.rules.other.listTaskCheckbox.exec(m.raw);if(w){let S={type:"checkbox",raw:w[0]+" ",checked:w[0]!=="[ ]"};m.checked=S.checked,n.loose?m.tokens[0]&&["paragraph","text"].includes(m.tokens[0].type)&&"tokens"in m.tokens[0]&&m.tokens[0].tokens?(m.tokens[0].raw=S.raw+m.tokens[0].raw,m.tokens[0].text=S.raw+m.tokens[0].text,m.tokens[0].tokens.unshift(S)):m.tokens.unshift({type:"paragraph",raw:S.raw,text:S.raw,tokens:[S]}):m.tokens.unshift(S)}}if(!n.loose){let w=m.tokens.filter(B=>B.type==="space"),S=w.length>0&&w.some(B=>this.rules.other.anyLine.test(B.raw));n.loose=S}}if(n.loose)for(let m of n.items){m.loose=!0;for(let w of m.tokens)w.type==="text"&&(w.type="paragraph")}return n}}html(a){let t=this.rules.block.html.exec(a);if(t)return{type:"html",block:!0,raw:t[0],pre:t[1]==="pre"||t[1]==="script"||t[1]==="style",text:t[0]}}def(a){let t=this.rules.block.def.exec(a);if(t){let l=t[1].toLowerCase().replace(this.rules.other.multipleSpaceGlobal," "),s=t[2]?t[2].replace(this.rules.other.hrefBrackets,"$1").replace(this.rules.inline.anyPunctuation,"$1"):"",n=t[3]?t[3].substring(1,t[3].length-1).replace(this.rules.inline.anyPunctuation,"$1"):t[3];return{type:"def",tag:l,raw:t[0],href:s,title:n}}}table(a){let t=this.rules.block.table.exec(a);if(!t||!this.rules.other.tableDelimiter.test(t[2]))return;let l=ps(t[1]),s=t[2].replace(this.rules.other.tableAlignChars,"").split("|"),n=t[3]?.trim()?t[3].replace(this.rules.other.tableRowBlankLine,"").split(`
`):[],i={type:"table",raw:t[0],header:[],align:[],rows:[]};if(l.length===s.length){for(let o of s)this.rules.other.tableAlignRight.test(o)?i.align.push("right"):this.rules.other.tableAlignCenter.test(o)?i.align.push("center"):this.rules.other.tableAlignLeft.test(o)?i.align.push("left"):i.align.push(null);for(let o=0;o<l.length;o++)i.header.push({text:l[o],tokens:this.lexer.inline(l[o]),header:!0,align:i.align[o]});for(let o of n)i.rows.push(ps(o,i.header.length).map((f,m)=>({text:f,tokens:this.lexer.inline(f),header:!1,align:i.align[m]})));return i}}lheading(a){let t=this.rules.block.lheading.exec(a);if(t)return{type:"heading",raw:t[0],depth:t[2].charAt(0)==="="?1:2,text:t[1],tokens:this.lexer.inline(t[1])}}paragraph(a){let t=this.rules.block.paragraph.exec(a);if(t){let l=t[1].charAt(t[1].length-1)===`
`?t[1].slice(0,-1):t[1];return{type:"paragraph",raw:t[0],text:l,tokens:this.lexer.inline(l)}}}text(a){let t=this.rules.block.text.exec(a);if(t)return{type:"text",raw:t[0],text:t[0],tokens:this.lexer.inline(t[0])}}escape(a){let t=this.rules.inline.escape.exec(a);if(t)return{type:"escape",raw:t[0],text:t[1]}}tag(a){let t=this.rules.inline.tag.exec(a);if(t)return!this.lexer.state.inLink&&this.rules.other.startATag.test(t[0])?this.lexer.state.inLink=!0:this.lexer.state.inLink&&this.rules.other.endATag.test(t[0])&&(this.lexer.state.inLink=!1),!this.lexer.state.inRawBlock&&this.rules.other.startPreScriptTag.test(t[0])?this.lexer.state.inRawBlock=!0:this.lexer.state.inRawBlock&&this.rules.other.endPreScriptTag.test(t[0])&&(this.lexer.state.inRawBlock=!1),{type:"html",raw:t[0],inLink:this.lexer.state.inLink,inRawBlock:this.lexer.state.inRawBlock,block:!1,text:t[0]}}link(a){let t=this.rules.inline.link.exec(a);if(t){let l=t[2].trim();if(!this.options.pedantic&&this.rules.other.startAngleBracket.test(l)){if(!this.rules.other.endAngleBracket.test(l))return;let i=dt(l.slice(0,-1),"\\");if((l.length-i.length)%2===0)return}else{let i=Il(t[2],"()");if(i===-2)return;if(i>-1){let o=(t[0].indexOf("!")===0?5:4)+t[1].length+i;t[2]=t[2].substring(0,i),t[0]=t[0].substring(0,o).trim(),t[3]=""}}let s=t[2],n="";if(this.options.pedantic){let i=this.rules.other.pedanticHrefTitle.exec(s);i&&(s=i[1],n=i[3])}else n=t[3]?t[3].slice(1,-1):"";return s=s.trim(),this.rules.other.startAngleBracket.test(s)&&(this.options.pedantic&&!this.rules.other.endAngleBracket.test(l)?s=s.slice(1):s=s.slice(1,-1)),vs(t,{href:s&&s.replace(this.rules.inline.anyPunctuation,"$1"),title:n&&n.replace(this.rules.inline.anyPunctuation,"$1")},t[0],this.lexer,this.rules)}}reflink(a,t){let l;if((l=this.rules.inline.reflink.exec(a))||(l=this.rules.inline.nolink.exec(a))){let s=(l[2]||l[1]).replace(this.rules.other.multipleSpaceGlobal," "),n=t[s.toLowerCase()];if(!n){let i=l[0].charAt(0);return{type:"text",raw:i,text:i}}return vs(l,n,l[0],this.lexer,this.rules)}}emStrong(a,t,l=""){let s=this.rules.inline.emStrongLDelim.exec(a);if(!(!s||s[3]&&l.match(this.rules.other.unicodeAlphaNumeric))&&(!(s[1]||s[2])||!l||this.rules.inline.punctuation.exec(l))){let n=[...s[0]].length-1,i,o,f=n,m=0,w=s[0][0]==="*"?this.rules.inline.emStrongRDelimAst:this.rules.inline.emStrongRDelimUnd;for(w.lastIndex=0,t=t.slice(-1*a.length+n);(s=w.exec(t))!=null;){if(i=s[1]||s[2]||s[3]||s[4]||s[5]||s[6],!i)continue;if(o=[...i].length,s[3]||s[4]){f+=o;continue}else if((s[5]||s[6])&&n%3&&!((n+o)%3)){m+=o;continue}if(f-=o,f>0)continue;o=Math.min(o,o+f+m);let S=[...s[0]][0].length,B=a.slice(0,n+s.index+S+o);if(Math.min(n,o)%2){let M=B.slice(1,-1);return{type:"em",raw:B,text:M,tokens:this.lexer.inlineTokens(M)}}let R=B.slice(2,-2);return{type:"strong",raw:B,text:R,tokens:this.lexer.inlineTokens(R)}}}}codespan(a){let t=this.rules.inline.code.exec(a);if(t){let l=t[2].replace(this.rules.other.newLineCharGlobal," "),s=this.rules.other.nonSpaceChar.test(l),n=this.rules.other.startingSpaceChar.test(l)&&this.rules.other.endingSpaceChar.test(l);return s&&n&&(l=l.substring(1,l.length-1)),{type:"codespan",raw:t[0],text:l}}}br(a){let t=this.rules.inline.br.exec(a);if(t)return{type:"br",raw:t[0]}}del(a){let t=this.rules.inline.del.exec(a);if(t)return{type:"del",raw:t[0],text:t[2],tokens:this.lexer.inlineTokens(t[2])}}autolink(a){let t=this.rules.inline.autolink.exec(a);if(t){let l,s;return t[2]==="@"?(l=t[1],s="mailto:"+l):(l=t[1],s=l),{type:"link",raw:t[0],text:l,href:s,tokens:[{type:"text",raw:l,text:l}]}}}url(a){let t;if(t=this.rules.inline.url.exec(a)){let l,s;if(t[2]==="@")l=t[0],s="mailto:"+l;else{let n;do n=t[0],t[0]=this.rules.inline._backpedal.exec(t[0])?.[0]??"";while(n!==t[0]);l=t[0],t[1]==="www."?s="http://"+t[0]:s=t[0]}return{type:"link",raw:t[0],text:l,href:s,tokens:[{type:"text",raw:l,text:l}]}}}inlineText(a){let t=this.rules.inline.text.exec(a);if(t){let l=this.lexer.state.inRawBlock;return{type:"text",raw:t[0],text:t[0],escaped:l}}}},Re=class Ht{tokens;options;state;inlineQueue;tokenizer;constructor(t){this.tokens=[],this.tokens.links=Object.create(null),this.options=t||Xe,this.options.tokenizer=this.options.tokenizer||new kt,this.tokenizer=this.options.tokenizer,this.tokenizer.options=this.options,this.tokenizer.lexer=this,this.inlineQueue=[],this.state={inLink:!1,inRawBlock:!1,top:!0};let l={other:fe,block:ht.normal,inline:ct.normal};this.options.pedantic?(l.block=ht.pedantic,l.inline=ct.pedantic):this.options.gfm&&(l.block=ht.gfm,this.options.breaks?l.inline=ct.breaks:l.inline=ct.gfm),this.tokenizer.rules=l}static get rules(){return{block:ht,inline:ct}}static lex(t,l){return new Ht(l).lex(t)}static lexInline(t,l){return new Ht(l).inlineTokens(t)}lex(t){t=t.replace(fe.carriageReturn,`
`),this.blockTokens(t,this.tokens);for(let l=0;l<this.inlineQueue.length;l++){let s=this.inlineQueue[l];this.inlineTokens(s.src,s.tokens)}return this.inlineQueue=[],this.tokens}blockTokens(t,l=[],s=!1){for(this.options.pedantic&&(t=t.replace(fe.tabCharGlobal,"    ").replace(fe.spaceLine,""));t;){let n;if(this.options.extensions?.block?.some(o=>(n=o.call({lexer:this},t,l))?(t=t.substring(n.raw.length),l.push(n),!0):!1))continue;if(n=this.tokenizer.space(t)){t=t.substring(n.raw.length);let o=l.at(-1);n.raw.length===1&&o!==void 0?o.raw+=`
`:l.push(n);continue}if(n=this.tokenizer.code(t)){t=t.substring(n.raw.length);let o=l.at(-1);o?.type==="paragraph"||o?.type==="text"?(o.raw+=(o.raw.endsWith(`
`)?"":`
`)+n.raw,o.text+=`
`+n.text,this.inlineQueue.at(-1).src=o.text):l.push(n);continue}if(n=this.tokenizer.fences(t)){t=t.substring(n.raw.length),l.push(n);continue}if(n=this.tokenizer.heading(t)){t=t.substring(n.raw.length),l.push(n);continue}if(n=this.tokenizer.hr(t)){t=t.substring(n.raw.length),l.push(n);continue}if(n=this.tokenizer.blockquote(t)){t=t.substring(n.raw.length),l.push(n);continue}if(n=this.tokenizer.list(t)){t=t.substring(n.raw.length),l.push(n);continue}if(n=this.tokenizer.html(t)){t=t.substring(n.raw.length),l.push(n);continue}if(n=this.tokenizer.def(t)){t=t.substring(n.raw.length);let o=l.at(-1);o?.type==="paragraph"||o?.type==="text"?(o.raw+=(o.raw.endsWith(`
`)?"":`
`)+n.raw,o.text+=`
`+n.raw,this.inlineQueue.at(-1).src=o.text):this.tokens.links[n.tag]||(this.tokens.links[n.tag]={href:n.href,title:n.title},l.push(n));continue}if(n=this.tokenizer.table(t)){t=t.substring(n.raw.length),l.push(n);continue}if(n=this.tokenizer.lheading(t)){t=t.substring(n.raw.length),l.push(n);continue}let i=t;if(this.options.extensions?.startBlock){let o=1/0,f=t.slice(1),m;this.options.extensions.startBlock.forEach(w=>{m=w.call({lexer:this},f),typeof m=="number"&&m>=0&&(o=Math.min(o,m))}),o<1/0&&o>=0&&(i=t.substring(0,o+1))}if(this.state.top&&(n=this.tokenizer.paragraph(i))){let o=l.at(-1);s&&o?.type==="paragraph"?(o.raw+=(o.raw.endsWith(`
`)?"":`
`)+n.raw,o.text+=`
`+n.text,this.inlineQueue.pop(),this.inlineQueue.at(-1).src=o.text):l.push(n),s=i.length!==t.length,t=t.substring(n.raw.length);continue}if(n=this.tokenizer.text(t)){t=t.substring(n.raw.length);let o=l.at(-1);o?.type==="text"?(o.raw+=(o.raw.endsWith(`
`)?"":`
`)+n.raw,o.text+=`
`+n.text,this.inlineQueue.pop(),this.inlineQueue.at(-1).src=o.text):l.push(n);continue}if(t){let o="Infinite loop on byte: "+t.charCodeAt(0);if(this.options.silent){console.error(o);break}else throw new Error(o)}}return this.state.top=!0,l}inline(t,l=[]){return this.inlineQueue.push({src:t,tokens:l}),l}inlineTokens(t,l=[]){let s=t,n=null;if(this.tokens.links){let m=Object.keys(this.tokens.links);if(m.length>0)for(;(n=this.tokenizer.rules.inline.reflinkSearch.exec(s))!=null;)m.includes(n[0].slice(n[0].lastIndexOf("[")+1,-1))&&(s=s.slice(0,n.index)+"["+"a".repeat(n[0].length-2)+"]"+s.slice(this.tokenizer.rules.inline.reflinkSearch.lastIndex))}for(;(n=this.tokenizer.rules.inline.anyPunctuation.exec(s))!=null;)s=s.slice(0,n.index)+"++"+s.slice(this.tokenizer.rules.inline.anyPunctuation.lastIndex);let i;for(;(n=this.tokenizer.rules.inline.blockSkip.exec(s))!=null;)i=n[2]?n[2].length:0,s=s.slice(0,n.index+i)+"["+"a".repeat(n[0].length-i-2)+"]"+s.slice(this.tokenizer.rules.inline.blockSkip.lastIndex);s=this.options.hooks?.emStrongMask?.call({lexer:this},s)??s;let o=!1,f="";for(;t;){o||(f=""),o=!1;let m;if(this.options.extensions?.inline?.some(S=>(m=S.call({lexer:this},t,l))?(t=t.substring(m.raw.length),l.push(m),!0):!1))continue;if(m=this.tokenizer.escape(t)){t=t.substring(m.raw.length),l.push(m);continue}if(m=this.tokenizer.tag(t)){t=t.substring(m.raw.length),l.push(m);continue}if(m=this.tokenizer.link(t)){t=t.substring(m.raw.length),l.push(m);continue}if(m=this.tokenizer.reflink(t,this.tokens.links)){t=t.substring(m.raw.length);let S=l.at(-1);m.type==="text"&&S?.type==="text"?(S.raw+=m.raw,S.text+=m.text):l.push(m);continue}if(m=this.tokenizer.emStrong(t,s,f)){t=t.substring(m.raw.length),l.push(m);continue}if(m=this.tokenizer.codespan(t)){t=t.substring(m.raw.length),l.push(m);continue}if(m=this.tokenizer.br(t)){t=t.substring(m.raw.length),l.push(m);continue}if(m=this.tokenizer.del(t)){t=t.substring(m.raw.length),l.push(m);continue}if(m=this.tokenizer.autolink(t)){t=t.substring(m.raw.length),l.push(m);continue}if(!this.state.inLink&&(m=this.tokenizer.url(t))){t=t.substring(m.raw.length),l.push(m);continue}let w=t;if(this.options.extensions?.startInline){let S=1/0,B=t.slice(1),R;this.options.extensions.startInline.forEach(M=>{R=M.call({lexer:this},B),typeof R=="number"&&R>=0&&(S=Math.min(S,R))}),S<1/0&&S>=0&&(w=t.substring(0,S+1))}if(m=this.tokenizer.inlineText(w)){t=t.substring(m.raw.length),m.raw.slice(-1)!=="_"&&(f=m.raw.slice(-1)),o=!0;let S=l.at(-1);S?.type==="text"?(S.raw+=m.raw,S.text+=m.text):l.push(m);continue}if(t){let S="Infinite loop on byte: "+t.charCodeAt(0);if(this.options.silent){console.error(S);break}else throw new Error(S)}}return l}},yt=class{options;parser;constructor(a){this.options=a||Xe}space(a){return""}code({text:a,lang:t,escaped:l}){let s=(t||"").match(fe.notSpaceStart)?.[0],n=a.replace(fe.endingNewline,"")+`
`;return s?'<pre><code class="language-'+Oe(s)+'">'+(l?n:Oe(n,!0))+`</code></pre>
`:"<pre><code>"+(l?n:Oe(n,!0))+`</code></pre>
`}blockquote({tokens:a}){return`<blockquote>
${this.parser.parse(a)}</blockquote>
`}html({text:a}){return a}def(a){return""}heading({tokens:a,depth:t}){return`<h${t}>${this.parser.parseInline(a)}</h${t}>
`}hr(a){return`<hr>
`}list(a){let t=a.ordered,l=a.start,s="";for(let o=0;o<a.items.length;o++){let f=a.items[o];s+=this.listitem(f)}let n=t?"ol":"ul",i=t&&l!==1?' start="'+l+'"':"";return"<"+n+i+`>
`+s+"</"+n+`>
`}listitem(a){return`<li>${this.parser.parse(a.tokens)}</li>
`}checkbox({checked:a}){return"<input "+(a?'checked="" ':"")+'disabled="" type="checkbox"> '}paragraph({tokens:a}){return`<p>${this.parser.parseInline(a)}</p>
`}table(a){let t="",l="";for(let n=0;n<a.header.length;n++)l+=this.tablecell(a.header[n]);t+=this.tablerow({text:l});let s="";for(let n=0;n<a.rows.length;n++){let i=a.rows[n];l="";for(let o=0;o<i.length;o++)l+=this.tablecell(i[o]);s+=this.tablerow({text:l})}return s&&(s=`<tbody>${s}</tbody>`),`<table>
<thead>
`+t+`</thead>
`+s+`</table>
`}tablerow({text:a}){return`<tr>
${a}</tr>
`}tablecell(a){let t=this.parser.parseInline(a.tokens),l=a.header?"th":"td";return(a.align?`<${l} align="${a.align}">`:`<${l}>`)+t+`</${l}>
`}strong({tokens:a}){return`<strong>${this.parser.parseInline(a)}</strong>`}em({tokens:a}){return`<em>${this.parser.parseInline(a)}</em>`}codespan({text:a}){return`<code>${Oe(a,!0)}</code>`}br(a){return"<br>"}del({tokens:a}){return`<del>${this.parser.parseInline(a)}</del>`}link({href:a,title:t,tokens:l}){let s=this.parser.parseInline(l),n=ds(a);if(n===null)return s;a=n;let i='<a href="'+a+'"';return t&&(i+=' title="'+Oe(t)+'"'),i+=">"+s+"</a>",i}image({href:a,title:t,text:l,tokens:s}){s&&(l=this.parser.parseInline(s,this.parser.textRenderer));let n=ds(a);if(n===null)return Oe(l);a=n;let i=`<img src="${a}" alt="${l}"`;return t&&(i+=` title="${Oe(t)}"`),i+=">",i}text(a){return"tokens"in a&&a.tokens?this.parser.parseInline(a.tokens):"escaped"in a&&a.escaped?a.text:Oe(a.text)}},ns=class{strong({text:a}){return a}em({text:a}){return a}codespan({text:a}){return a}del({text:a}){return a}html({text:a}){return a}text({text:a}){return a}link({text:a}){return""+a}image({text:a}){return""+a}br(){return""}checkbox({raw:a}){return a}},Be=class Jt{options;renderer;textRenderer;constructor(t){this.options=t||Xe,this.options.renderer=this.options.renderer||new yt,this.renderer=this.options.renderer,this.renderer.options=this.options,this.renderer.parser=this,this.textRenderer=new ns}static parse(t,l){return new Jt(l).parse(t)}static parseInline(t,l){return new Jt(l).parseInline(t)}parse(t){let l="";for(let s=0;s<t.length;s++){let n=t[s];if(this.options.extensions?.renderers?.[n.type]){let o=n,f=this.options.extensions.renderers[o.type].call({parser:this},o);if(f!==!1||!["space","hr","heading","code","table","blockquote","list","html","def","paragraph","text"].includes(o.type)){l+=f||"";continue}}let i=n;switch(i.type){case"space":{l+=this.renderer.space(i);break}case"hr":{l+=this.renderer.hr(i);break}case"heading":{l+=this.renderer.heading(i);break}case"code":{l+=this.renderer.code(i);break}case"table":{l+=this.renderer.table(i);break}case"blockquote":{l+=this.renderer.blockquote(i);break}case"list":{l+=this.renderer.list(i);break}case"checkbox":{l+=this.renderer.checkbox(i);break}case"html":{l+=this.renderer.html(i);break}case"def":{l+=this.renderer.def(i);break}case"paragraph":{l+=this.renderer.paragraph(i);break}case"text":{l+=this.renderer.text(i);break}default:{let o='Token with "'+i.type+'" type was not found.';if(this.options.silent)return console.error(o),"";throw new Error(o)}}}return l}parseInline(t,l=this.renderer){let s="";for(let n=0;n<t.length;n++){let i=t[n];if(this.options.extensions?.renderers?.[i.type]){let f=this.options.extensions.renderers[i.type].call({parser:this},i);if(f!==!1||!["escape","html","link","image","strong","em","codespan","br","del","text"].includes(i.type)){s+=f||"";continue}}let o=i;switch(o.type){case"escape":{s+=l.text(o);break}case"html":{s+=l.html(o);break}case"link":{s+=l.link(o);break}case"image":{s+=l.image(o);break}case"checkbox":{s+=l.checkbox(o);break}case"strong":{s+=l.strong(o);break}case"em":{s+=l.em(o);break}case"codespan":{s+=l.codespan(o);break}case"br":{s+=l.br(o);break}case"del":{s+=l.del(o);break}case"text":{s+=l.text(o);break}default:{let f='Token with "'+o.type+'" type was not found.';if(this.options.silent)return console.error(f),"";throw new Error(f)}}}return s}},pt=class{options;block;constructor(a){this.options=a||Xe}static passThroughHooks=new Set(["preprocess","postprocess","processAllTokens","emStrongMask"]);static passThroughHooksRespectAsync=new Set(["preprocess","postprocess","processAllTokens"]);preprocess(a){return a}postprocess(a){return a}processAllTokens(a){return a}emStrongMask(a){return a}provideLexer(){return this.block?Re.lex:Re.lexInline}provideParser(){return this.block?Be.parse:Be.parseInline}},Al=class{defaults=Gt();options=this.setOptions;parse=this.parseMarkdown(!0);parseInline=this.parseMarkdown(!1);Parser=Be;Renderer=yt;TextRenderer=ns;Lexer=Re;Tokenizer=kt;Hooks=pt;constructor(...a){this.use(...a)}walkTokens(a,t){let l=[];for(let s of a)switch(l=l.concat(t.call(this,s)),s.type){case"table":{let n=s;for(let i of n.header)l=l.concat(this.walkTokens(i.tokens,t));for(let i of n.rows)for(let o of i)l=l.concat(this.walkTokens(o.tokens,t));break}case"list":{let n=s;l=l.concat(this.walkTokens(n.items,t));break}default:{let n=s;this.defaults.extensions?.childTokens?.[n.type]?this.defaults.extensions.childTokens[n.type].forEach(i=>{let o=n[i].flat(1/0);l=l.concat(this.walkTokens(o,t))}):n.tokens&&(l=l.concat(this.walkTokens(n.tokens,t)))}}return l}use(...a){let t=this.defaults.extensions||{renderers:{},childTokens:{}};return a.forEach(l=>{let s={...l};if(s.async=this.defaults.async||s.async||!1,l.extensions&&(l.extensions.forEach(n=>{if(!n.name)throw new Error("extension name required");if("renderer"in n){let i=t.renderers[n.name];i?t.renderers[n.name]=function(...o){let f=n.renderer.apply(this,o);return f===!1&&(f=i.apply(this,o)),f}:t.renderers[n.name]=n.renderer}if("tokenizer"in n){if(!n.level||n.level!=="block"&&n.level!=="inline")throw new Error("extension level must be 'block' or 'inline'");let i=t[n.level];i?i.unshift(n.tokenizer):t[n.level]=[n.tokenizer],n.start&&(n.level==="block"?t.startBlock?t.startBlock.push(n.start):t.startBlock=[n.start]:n.level==="inline"&&(t.startInline?t.startInline.push(n.start):t.startInline=[n.start]))}"childTokens"in n&&n.childTokens&&(t.childTokens[n.name]=n.childTokens)}),s.extensions=t),l.renderer){let n=this.defaults.renderer||new yt(this.defaults);for(let i in l.renderer){if(!(i in n))throw new Error(`renderer '${i}' does not exist`);if(["options","parser"].includes(i))continue;let o=i,f=l.renderer[o],m=n[o];n[o]=(...w)=>{let S=f.apply(n,w);return S===!1&&(S=m.apply(n,w)),S||""}}s.renderer=n}if(l.tokenizer){let n=this.defaults.tokenizer||new kt(this.defaults);for(let i in l.tokenizer){if(!(i in n))throw new Error(`tokenizer '${i}' does not exist`);if(["options","rules","lexer"].includes(i))continue;let o=i,f=l.tokenizer[o],m=n[o];n[o]=(...w)=>{let S=f.apply(n,w);return S===!1&&(S=m.apply(n,w)),S}}s.tokenizer=n}if(l.hooks){let n=this.defaults.hooks||new pt;for(let i in l.hooks){if(!(i in n))throw new Error(`hook '${i}' does not exist`);if(["options","block"].includes(i))continue;let o=i,f=l.hooks[o],m=n[o];pt.passThroughHooks.has(i)?n[o]=w=>{if(this.defaults.async&&pt.passThroughHooksRespectAsync.has(i))return(async()=>{let B=await f.call(n,w);return m.call(n,B)})();let S=f.call(n,w);return m.call(n,S)}:n[o]=(...w)=>{if(this.defaults.async)return(async()=>{let B=await f.apply(n,w);return B===!1&&(B=await m.apply(n,w)),B})();let S=f.apply(n,w);return S===!1&&(S=m.apply(n,w)),S}}s.hooks=n}if(l.walkTokens){let n=this.defaults.walkTokens,i=l.walkTokens;s.walkTokens=function(o){let f=[];return f.push(i.call(this,o)),n&&(f=f.concat(n.call(this,o))),f}}this.defaults={...this.defaults,...s}}),this}setOptions(a){return this.defaults={...this.defaults,...a},this}lexer(a,t){return Re.lex(a,t??this.defaults)}parser(a,t){return Be.parse(a,t??this.defaults)}parseMarkdown(a){return(t,l)=>{let s={...l},n={...this.defaults,...s},i=this.onError(!!n.silent,!!n.async);if(this.defaults.async===!0&&s.async===!1)return i(new Error("marked(): The async option was set to true by an extension. Remove async: false from the parse options object to return a Promise."));if(typeof t>"u"||t===null)return i(new Error("marked(): input parameter is undefined or null"));if(typeof t!="string")return i(new Error("marked(): input parameter is of type "+Object.prototype.toString.call(t)+", string expected"));if(n.hooks&&(n.hooks.options=n,n.hooks.block=a),n.async)return(async()=>{let o=n.hooks?await n.hooks.preprocess(t):t,f=await(n.hooks?await n.hooks.provideLexer():a?Re.lex:Re.lexInline)(o,n),m=n.hooks?await n.hooks.processAllTokens(f):f;n.walkTokens&&await Promise.all(this.walkTokens(m,n.walkTokens));let w=await(n.hooks?await n.hooks.provideParser():a?Be.parse:Be.parseInline)(m,n);return n.hooks?await n.hooks.postprocess(w):w})().catch(i);try{n.hooks&&(t=n.hooks.preprocess(t));let o=(n.hooks?n.hooks.provideLexer():a?Re.lex:Re.lexInline)(t,n);n.hooks&&(o=n.hooks.processAllTokens(o)),n.walkTokens&&this.walkTokens(o,n.walkTokens);let f=(n.hooks?n.hooks.provideParser():a?Be.parse:Be.parseInline)(o,n);return n.hooks&&(f=n.hooks.postprocess(f)),f}catch(o){return i(o)}}}onError(a,t){return l=>{if(l.message+=`
Please report this to https://github.com/markedjs/marked.`,a){let s="<p>An error occurred:</p><pre>"+Oe(l.message+"",!0)+"</pre>";return t?Promise.resolve(s):s}if(t)return Promise.reject(l);throw l}}},We=new Al;function ee(a,t){return We.parse(a,t)}ee.options=ee.setOptions=function(a){return We.setOptions(a),ee.defaults=We.defaults,$s(ee.defaults),ee};ee.getDefaults=Gt;ee.defaults=Xe;ee.use=function(...a){return We.use(...a),ee.defaults=We.defaults,$s(ee.defaults),ee};ee.walkTokens=function(a,t){return We.walkTokens(a,t)};ee.parseInline=We.parseInline;ee.Parser=Be;ee.parser=Be.parse;ee.Renderer=yt;ee.TextRenderer=ns;ee.Lexer=Re;ee.lexer=Re.lex;ee.Tokenizer=kt;ee.Hooks=pt;ee.parse=ee;ee.options;ee.setOptions;ee.use;ee.walkTokens;ee.parseInline;Be.parse;Re.lex;const Ll={class:"overview-grid"},Rl={class:"overview-card summary-card"},Bl={class:"card-header"},zl={class:"card-title-with-selector"},Ul={class:"card-title-icon"},Ml={class:"card-header-actions"},El={class:"template-status"},Vl={class:"template-description"},ql={class:"card-content markdown-content"},Kl={key:0,class:"loading-text"},Ol=["innerHTML"],Dl={key:2,class:"placeholder-text"},Nl={class:"overview-card stats-card"},jl={class:"stats-grid"},Fl={class:"stat-item"},Ql={class:"stat-value"},Hl={class:"stat-item"},Jl={class:"stat-value"},Gl={class:"export-actions"},Zl=["disabled"],Wl=["disabled"],Xl={class:"overview-card recent-card"},Yl={class:"recent-pages"},ea={key:0,class:"placeholder-text"},ta=["onClick"],sa={class:"page-number"},na={key:0,class:"page-summary"},la=ze({__name:"OverviewPanel",setup(a){const t=De(),l=_("no_spoiler"),s=_(""),n=_(!1),i=_([]),o=_([]),f=[{value:"no_spoiler",label:"æ— å‰§é€ç®€ä»‹",icon:"ğŸ",description:"ä¸å«å‰§é€çš„ç®€çŸ­ä»‹ç»ï¼Œé€‚åˆæ¨èç»™ä»–äºº"},{value:"story_summary",label:"æ•…äº‹æ¦‚è¦",icon:"ğŸ“–",description:"å®Œæ•´çš„å‰§æƒ…å›é¡¾ï¼ŒåŒ…å«æ‰€æœ‰å‰§é€"},{value:"recap",label:"å‰æƒ…å›é¡¾",icon:"âª",description:"ä¹‹å‰å‘ç”Ÿçš„é‡è¦äº‹ä»¶å›é¡¾"},{value:"character_guide",label:"è§’è‰²å›¾é‰´",icon:"ğŸ‘¥",description:"ä¸»è¦è§’è‰²ä»‹ç»å’Œå…³ç³»"},{value:"world_setting",label:"ä¸–ç•Œè§‚è®¾å®š",icon:"ğŸŒ",description:"æ•…äº‹èƒŒæ™¯å’Œä¸–ç•Œè§‚è®¾å®š"},{value:"highlights",label:"ååœºé¢ç›˜ç‚¹",icon:"âœ¨",description:"ç²¾å½©ç‰‡æ®µå’Œç»å…¸åœºæ™¯å›é¡¾"},{value:"reading_notes",label:"é˜…è¯»ç¬”è®°",icon:"ğŸ“",description:"é˜…è¯»è¿‡ç¨‹ä¸­çš„é‡ç‚¹ç¬”è®°"}],m=f.map(v=>({label:`${v.icon} ${v.label}`,value:v.value})),w=z(()=>f.find(h=>h.value===l.value)?.icon||"ğŸ“Š"),S=z(()=>f.find(h=>h.value===l.value)?.description||""),B=z(()=>i.value.includes(l.value)?"å·²ç”Ÿæˆ":""),R=z(()=>s.value?ee.parse(s.value):"");async function M(){await L(!1)}async function L(v){if(t.currentBookId){n.value=!0,s.value="";try{let h;v?h=await an(t.currentBookId,l.value,!0):h=await bs(t.currentBookId,l.value),h.success&&(h.content?(s.value=h.content,i.value.includes(l.value)||i.value.push(l.value)):h.cached||(s.value=""))}catch(h){console.error("åŠ è½½æ¦‚è§ˆå¤±è´¥:",h),s.value="åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•"}finally{n.value=!1}}}async function V(v){await L(v)}async function O(){if(t.currentBookId)try{const v=await ks(t.currentBookId);if(v.success){let h=[];v.generated?h=v.generated:v.templates&&Array.isArray(v.templates)&&(h=v.templates),i.value=h,h.length>0&&!h.includes(l.value)&&(l.value=h[0],console.log(`é»˜è®¤æ¨¡æ¿æœªç”Ÿæˆï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°å·²ç”Ÿæˆçš„æ¨¡æ¿: ${h[0]}`))}}catch(v){console.error("åŠ è½½æ¨¡æ¿åˆ—è¡¨å¤±è´¥:",v)}}const N=_(!1);async function j(){if(!t.currentBookId){alert("è¯·å…ˆé€‰æ‹©ä¹¦ç±");return}N.value=!0;try{const v=await _s(t.currentBookId);if(v.success&&v.markdown){const h=new Blob([v.markdown],{type:"text/markdown"}),C=URL.createObjectURL(h),A=document.createElement("a");A.href=C,A.download=`${t.currentBookId}_analysis.md`,A.click(),URL.revokeObjectURL(C),alert("å¯¼å‡ºæˆåŠŸ")}else alert("å¯¼å‡ºå¤±è´¥: "+(v.error||"æœªçŸ¥é”™è¯¯"))}catch(v){console.error("å¯¼å‡ºå¤±è´¥:",v),alert("å¯¼å‡ºå¤±è´¥")}finally{N.value=!1}}function J(){if(!s.value){alert("æš‚æ— å†…å®¹å¯å¯¼å‡º");return}const v=f.find(te=>te.value===l.value),h=`${t.currentBookId}_${l.value}.md`,C=`# ${v?.label||l.value}

${s.value}`,A=new Blob([C],{type:"text/markdown"}),E=URL.createObjectURL(A),q=document.createElement("a");q.href=E,q.download=h,q.click(),URL.revokeObjectURL(E)}async function u(){if(t.currentBookId)try{if((await gs(t.currentBookId)).success&&t.analyzedPageCount>0){const h=t.totalPageCount,C=t.analyzedPageCount,A=[],E=Math.max(1,C-4);for(let q=0;q<Math.min(5,C);q++){const te=E+q;te<=h&&A.push({page_num:te,summary:`ç¬¬ ${te} é¡µ`})}o.value=A.reverse()}}catch(v){console.error("åŠ è½½æœ€è¿‘åˆ†æé¡µé¢å¤±è´¥:",v)}}function P(v){t.selectPage(v)}return nt(async()=>{await O(),await u(),i.value.includes(l.value)&&await L(!1)}),st(()=>t.currentBookId,async v=>{v&&(s.value="",i.value=[],o.value=[],await O(),await u(),i.value.includes(l.value)&&await L(!1))}),(v,h)=>(c(),p("div",Ll,[e("div",Rl,[e("div",Bl,[e("div",zl,[e("span",Ul,$(w.value),1),ue(Se,{modelValue:l.value,"onUpdate:modelValue":h[0]||(h[0]=C=>l.value=C),options:ge(m),onChange:M},null,8,["modelValue","options"])]),e("div",Ml,[e("span",El,$(B.value),1),e("button",{class:"btn-icon",title:"ç”Ÿæˆ/åŠ è½½",onClick:h[1]||(h[1]=C=>V(!1))}," ğŸ“„ "),e("button",{class:"btn-icon",title:"é‡æ–°ç”Ÿæˆ",onClick:h[2]||(h[2]=C=>V(!0))}," ğŸ”„ ")])]),e("p",Vl,$(S.value),1),e("div",ql,[n.value?(c(),p("div",Kl,"åŠ è½½ä¸­...")):s.value?(c(),p("div",{key:1,innerHTML:R.value},null,8,Ol)):(c(),p("div",Dl,"é€‰æ‹©æ¨¡æ¿ç±»å‹ï¼Œç‚¹å‡»ç”ŸæˆæŒ‰é’®"))])]),e("div",Nl,[h[5]||(h[5]=e("h3",{class:"card-title"},"ğŸ“Š åˆ†æç»Ÿè®¡",-1)),e("div",jl,[e("div",Fl,[e("span",Ql,$(ge(t).analyzedPageCount),1),h[3]||(h[3]=e("span",{class:"stat-label"},"å·²åˆ†æé¡µé¢",-1))]),e("div",Hl,[e("span",Jl,$(ge(t).chapters.length),1),h[4]||(h[4]=e("span",{class:"stat-label"},"ç« èŠ‚æ•°",-1))])]),e("div",Gl,[e("button",{class:"btn btn-secondary btn-sm",disabled:N.value||!s.value,title:"å¯¼å‡ºå½“å‰æ¦‚è§ˆ",onClick:J}," ğŸ“„ å¯¼å‡ºå½“å‰ ",8,Zl),e("button",{class:"btn btn-primary btn-sm",disabled:N.value,title:"å¯¼å‡ºå®Œæ•´åˆ†ææ•°æ®",onClick:j},$(N.value?"å¯¼å‡ºä¸­...":"ğŸ“¤ å¯¼å‡ºå…¨éƒ¨"),9,Wl)])]),e("div",Xl,[h[6]||(h[6]=e("h3",{class:"card-title"},"ğŸ• æœ€è¿‘åˆ†æ",-1)),e("div",Yl,[o.value.length===0?(c(),p("div",ea,"æš‚æ— åˆ†æè®°å½•")):T("",!0),(c(!0),p(Z,null,le(o.value,C=>(c(),p("div",{key:C.page_num,class:"recent-page-item",onClick:A=>P(C.page_num)},[e("span",sa,"ç¬¬ "+$(C.page_num)+" é¡µ",1),C.summary?(c(),p("span",na,$(C.summary),1)):T("",!0)],8,ta))),128))])])]))}}),aa=Ke(la,[["__scopeId","data-v-c38fbd62"]]),oa={class:"timeline-tab"},ra={class:"timeline-header"},ia=["disabled"],ua={key:0,class:"btn-spinner"},ca={key:0,class:"error-message"},da={class:"timeline-container"},pa={key:0,class:"loading-state"},va={key:1,class:"timeline-empty-state"},ma=["disabled"],ga={class:"timeline-stats"},ha={key:0,class:"stat-badge"},fa={class:"stat-badge"},ba={key:1,class:"stat-badge"},ka={key:2,class:"stat-badge"},ya={class:"stat-badge"},_a={key:0,class:"timeline-summary-card"},$a={class:"one-sentence"},wa={key:0,class:"themes"},xa={key:1,class:"characters-section"},Ca={class:"characters-grid"},Sa=["onClick"],Pa={class:"character-name"},Ia={class:"character-desc"},Ta={class:"character-page"},Aa={key:2,class:"timeline-section"},La={key:3,class:"timeline-track"},Ra={class:"timeline-node"},Ba=["onClick"],za={class:"timeline-card"},Ua=["onClick"],Ma=["src","alt","onClick"],Ea={class:"timeline-card-title"},Va={class:"timeline-page-range"},qa={class:"timeline-event-count"},Ka={class:"expand-icon"},Oa={key:0,class:"timeline-summary"},Da={key:1,class:"timeline-mood"},Na={key:4,class:"timeline-track"},ja={class:"timeline-node"},Fa=["onClick"],Qa={class:"timeline-card"},Ha=["onClick"],Ja=["src","alt","onClick"],Ga={class:"timeline-card-title"},Za={class:"timeline-page-range"},Wa={class:"timeline-event-count"},Xa={class:"expand-icon"},Ya={key:0,class:"timeline-summary"},eo={key:1,class:"timeline-events-list"},to={key:5,class:"timeline-section"},so={class:"plot-threads-list"},no={class:"thread-header"},lo={class:"thread-name"},ao={key:0,class:"thread-desc"},oo={key:1,class:"thread-intro"},ro={key:6,class:"placeholder-text"},io=ze({__name:"TimelinePanel",setup(a){const t=De(),l=_(!1),s=_(!1),n=_(null);_("simple");const i=_(new Set),o=_(""),f=z(()=>{if(!n.value)return!1;const u=n.value.groups&&n.value.groups.length>0,P=n.value.plot_arcs&&n.value.plot_arcs.length>0;return u||P}),m=z(()=>n.value?.stats?.total_events||0),w=z(()=>n.value?.stats?.total_pages||0),S=z(()=>n.value?.mode==="enhanced"||!!n.value?.story_summary||!!n.value?.plot_arcs?.length),B=z(()=>n.value?.main_characters||[]),R=z(()=>n.value?.plot_arcs||[]),M=z(()=>n.value?.story_summary||"");async function L(){if(t.currentBookId){l.value=!0,o.value="";try{const u=await ys(t.currentBookId);console.log("Timeline API response:",u),u.success?(n.value={mode:u.mode||"simple",groups:u.groups||[],stats:u.stats,story_summary:u.summary?.one_sentence||"",main_characters:u.characters||[],plot_arcs:u.story_arcs||[],plot_threads:u.plot_threads||[],events:u.events||[],cached:u.cached},console.log("Parsed timelineData:",n.value)):o.value=u.error||"åŠ è½½æ—¶é—´çº¿å¤±è´¥"}catch(u){console.error("åŠ è½½æ—¶é—´çº¿å¤±è´¥:",u),o.value=u instanceof Error?u.message:"åŠ è½½å¤±è´¥"}finally{l.value=!1}}}async function V(){if(t.currentBookId){s.value=!0,o.value="";try{const u=await on(t.currentBookId);u.success?n.value=u:o.value="é‡æ–°ç”Ÿæˆå¤±è´¥"}catch(u){console.error("é‡æ–°ç”Ÿæˆæ—¶é—´çº¿å¤±è´¥:",u),o.value=u instanceof Error?u.message:"é‡æ–°ç”Ÿæˆå¤±è´¥"}finally{s.value=!1}}}function O(u){return t.currentBookId?fs(t.currentBookId,u):""}function N(u){t.selectPage(u)}function j(u){i.value.has(u)?i.value.delete(u):i.value.add(u)}function J(u){return i.value.has(u)}return nt(()=>{t.currentBookId&&L()}),st(()=>t.currentBookId,u=>{u&&(n.value=null,L())}),(u,P)=>(c(),p("div",oa,[e("div",ra,[P[2]||(P[2]=e("h3",null,"ğŸ“ˆ å‰§æƒ…æ—¶é—´çº¿",-1)),e("button",{class:H(["btn btn-secondary btn-sm",{loading:s.value}]),disabled:l.value||s.value,onClick:V},[s.value?(c(),p("span",ua)):T("",!0),oe(" "+$(s.value?"ç”Ÿæˆä¸­...":"ğŸ”„ é‡æ–°ç”Ÿæˆ"),1)],10,ia)]),o.value?(c(),p("div",ca," âš ï¸ "+$(o.value),1)):T("",!0),e("div",da,[l.value?(c(),p("div",pa,[...P[3]||(P[3]=[e("div",{class:"loading-spinner"},null,-1),e("p",null,"åŠ è½½æ—¶é—´çº¿...",-1)])])):f.value?(c(),p(Z,{key:2},[e("div",ga,[n.value?.stats?.total_arcs?(c(),p("span",ha,"ğŸ­ "+$(n.value.stats.total_arcs)+" ä¸ªå‰§æƒ…å¼§",1)):T("",!0),e("span",fa,"ğŸ“Š "+$(m.value)+" ä¸ªäº‹ä»¶",1),n.value?.stats?.total_characters?(c(),p("span",ba,"ğŸ‘¥ "+$(n.value.stats.total_characters)+" ä¸ªè§’è‰²",1)):T("",!0),n.value?.stats?.total_threads?(c(),p("span",ka,"ğŸ”— "+$(n.value.stats.total_threads)+" æ¡çº¿ç´¢",1)):T("",!0),e("span",ya,"ğŸ“„ "+$(w.value)+" é¡µ",1)]),M.value?(c(),p("div",_a,[P[8]||(P[8]=e("h4",null,"ğŸ“– æ•…äº‹æ¦‚è¦",-1)),e("p",$a,$(M.value),1),n.value?.plot_threads?.length?(c(),p("div",wa,[P[7]||(P[7]=e("span",null,"ä¸»é¢˜ï¼š",-1)),(c(!0),p(Z,null,le(n.value.plot_threads.slice(0,5),v=>(c(),p("span",{key:v.id,class:"theme-tag"},$(v.name),1))),128))])):T("",!0)])):T("",!0),B.value.length>0?(c(),p("div",xa,[P[9]||(P[9]=e("h4",null,"ğŸ‘¥ ä¸»è¦è§’è‰²",-1)),e("div",Ca,[(c(!0),p(Z,null,le(B.value,v=>(c(),p("div",{key:v.name,class:"character-card",onClick:h=>N(v.first_appearance)},[e("div",Pa,$(v.name),1),e("div",Ia,$(v.description),1),e("div",Ta,"é¦–æ¬¡å‡ºç°ï¼šç¬¬ "+$(v.first_appearance)+" é¡µ",1)],8,Sa))),128))])])):T("",!0),S.value&&R.value.length>0?(c(),p("div",Aa,[...P[10]||(P[10]=[e("h4",null,"ğŸ­ å‰§æƒ…å‘å±•",-1)])])):T("",!0),S.value&&R.value.length>0?(c(),p("div",La,[(c(!0),p(Z,null,le(R.value,(v,h)=>(c(),p("div",{key:v.id||v.name,class:H(["timeline-group",{expanded:J(v.id||`arc-${h}`)}])},[e("div",Ra,[e("div",{class:"timeline-node-dot",onClick:C=>j(v.id||`arc-${h}`)},null,8,Ba),P[11]||(P[11]=e("div",{class:"timeline-node-line"},null,-1))]),e("div",za,[e("div",{class:"timeline-card-header",onClick:C=>j(v.id||`arc-${h}`)},[e("img",{class:"timeline-thumbnail",src:O(v.page_range?.start||1),alt:`ç¬¬${v.page_range?.start||1}é¡µ`,loading:"lazy",onError:P[0]||(P[0]=C=>C.target.style.display="none"),onClick:we(C=>N(v.page_range?.start||1),["stop"])},null,40,Ma),e("div",Ea,[e("span",Va," ç¬¬ "+$(v.page_range?.start||v.start_page||"?")+"-"+$(v.page_range?.end||v.end_page||"?")+" é¡µ ",1),e("span",qa,$(v.name),1)]),e("span",Ka,$(J(v.id||`arc-${h}`)?"â–¼":"â–¶"),1)],8,Ua),v.description?(c(),p("div",Oa,$(v.description),1)):T("",!0),v.mood?(c(),p("div",Da,[P[12]||(P[12]=e("span",{class:"label"},"ğŸ¨ æ°›å›´ï¼š",-1)),oe($(v.mood),1)])):T("",!0)])],2))),128))])):n.value?.groups&&n.value.groups.length>0?(c(),p("div",Na,[(c(!0),p(Z,null,le(n.value.groups,v=>(c(),p("div",{key:v.id,class:H(["timeline-group",{expanded:J(v.id)}])},[e("div",ja,[e("div",{class:"timeline-node-dot",onClick:h=>j(v.id)},null,8,Fa),P[13]||(P[13]=e("div",{class:"timeline-node-line"},null,-1))]),e("div",Qa,[e("div",{class:"timeline-card-header",onClick:h=>j(v.id)},[e("img",{class:"timeline-thumbnail",src:O(v.thumbnail_page||v.page_range.start),alt:`ç¬¬${v.page_range.start}é¡µ`,loading:"lazy",onError:P[1]||(P[1]=h=>h.target.style.display="none"),onClick:we(h=>N(v.page_range.start),["stop"])},null,40,Ja),e("div",Ga,[e("span",Za," ç¬¬ "+$(v.page_range.start)+"-"+$(v.page_range.end)+" é¡µ ",1),e("span",Wa,$(v.events.length)+" ä¸ªäº‹ä»¶",1)]),e("span",Xa,$(J(v.id)?"â–¼":"â–¶"),1)],8,Ha),v.summary?(c(),p("div",Ya,$(v.summary),1)):T("",!0),J(v.id)&&v.events.length>0?(c(),p("ul",eo,[(c(!0),p(Z,null,le(v.events,(h,C)=>(c(),p("li",{key:C,class:"timeline-event-item"},$(h),1))),128))])):T("",!0)])],2))),128))])):T("",!0),n.value?.plot_threads&&n.value.plot_threads.length>0?(c(),p("div",to,[P[14]||(P[14]=e("h4",null,"ğŸ”— ä¼ç¬”ä¸çº¿ç´¢",-1)),e("div",so,[(c(!0),p(Z,null,le(n.value.plot_threads,v=>(c(),p("div",{key:v.id,class:H(["plot-thread-item",{resolved:v.status==="å·²è§£å†³"}])},[e("div",no,[e("span",lo,$(v.name||"æœªå‘½åçº¿ç´¢"),1),e("span",{class:H(["thread-status",{resolved:v.status==="å·²è§£å†³"}])},$(v.status||"è¿›è¡Œä¸­"),3)]),v.description?(c(),p("p",ao,$(v.description),1)):T("",!0),v.introduced_at?(c(),p("span",oo,"ç¬¬ "+$(v.introduced_at)+" é¡µå¼•å…¥",1)):T("",!0)],2))),128))])])):T("",!0),f.value?T("",!0):(c(),p("div",ro,' æš‚æ— è¯¦ç»†æ—¶é—´çº¿æ•°æ®ï¼Œç‚¹å‡»"é‡æ–°ç”Ÿæˆ"æŒ‰é’®ç”Ÿæˆ '))],64)):(c(),p("div",va,[P[4]||(P[4]=e("div",{class:"empty-icon"},"ğŸ“ˆ",-1)),P[5]||(P[5]=e("h4",null,"æ—¶é—´çº¿å°šæœªç”Ÿæˆ",-1)),P[6]||(P[6]=e("p",null,"å®Œæˆæ¼«ç”»åˆ†æåä¼šè‡ªåŠ¨ç”Ÿæˆæ—¶é—´çº¿ï¼Œæˆ–ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ‰‹åŠ¨ç”Ÿæˆ",-1)),e("button",{class:"btn btn-primary btn-sm",disabled:s.value,onClick:V},$(s.value?"ç”Ÿæˆä¸­...":"ç”Ÿæˆæ—¶é—´çº¿"),9,ma)]))])]))}}),uo=Ke(io,[["__scopeId","data-v-b4582aff"]]),co={class:"qa-container"},po={key:0,class:"welcome-message"},vo={class:"message-avatar"},mo={key:0,src:Js,alt:"ç”¨æˆ·",class:"avatar-img"},go={key:0,class:"message-content"},ho={key:1,class:"message-content markdown-content"},fo={key:0,class:"loading-dots"},bo={key:0,class:"answer-mode-badge"},ko=["innerHTML"],yo={key:1,class:"message-citations"},_o=["onClick"],$o=["disabled","onClick"],wo={class:"chat-input-container"},xo={class:"chat-options"},Co={class:"qa-mode-toggle",title:"ç²¾ç¡®æ¨¡å¼ï¼šä½¿ç”¨RAGæ£€ç´¢ç›¸å…³ç‰‡æ®µï¼›å…¨å±€æ¨¡å¼ï¼šä½¿ç”¨å…¨æ–‡æ‘˜è¦"},So={key:0,class:"precise-mode-options"},Po={class:"checkbox-label compact",title:"å¯ç”¨çˆ¶å­å—æ¨¡å¼"},Io={class:"checkbox-label compact",title:"å¯ç”¨æ¨ç†æ£€ç´¢"},To={class:"checkbox-label compact",title:"å¯ç”¨é‡æ’åº"},Ao={class:"input-label compact",title:"è¿”å›çš„æœ€å¤§ç»“æœæ•°"},Lo={class:"input-label compact",title:"ç›¸å…³æ€§é˜ˆå€¼"},Ro={key:1,class:"global-mode-hint"},Bo={class:"welcome-examples"},zo=["onClick"],Uo={class:"chat-input-wrapper"},Mo=["disabled"],Eo=["disabled"],Vo={key:0,class:"modal note-modal show"},qo={class:"modal-content note-modal-content"},Ko={class:"modal-body"},Oo={key:0,class:"qa-preview"},Do={class:"qa-preview-section"},No={class:"qa-preview-content"},jo={class:"qa-preview-section"},Fo=["innerHTML"],Qo={key:0,class:"qa-preview-section"},Ho={class:"qa-preview-citations"},Jo={class:"note-form"},Go={class:"form-group"},Zo={class:"form-group"},Wo=ze({__name:"QAPanel",setup(a){const t=De(),l=_(""),s=_("precise"),n=_(!0),i=_(!0),o=_(!0),f=_(5),m=_(0),w=_(null),S=z(()=>t.qaHistory),B=z(()=>t.isStreaming),R=z(()=>s.value==="precise");function M(I){s.value=I}async function L(){const I=l.value.trim();if(!I||!t.currentBookId||B.value)return;l.value="",t.clearQAHistory(),t.addQAMessage({id:Date.now().toString(),role:"user",content:I,timestamp:new Date().toISOString()}),await as(),O();const g=s.value==="global"?"æ­£åœ¨åˆ†æå…¨æ–‡...":"æ€è€ƒä¸­...";t.addQAMessage({id:(Date.now()+1).toString(),role:"assistant",content:g,timestamp:new Date().toISOString(),isLoading:!0}),t.setStreaming(!0);try{const k=await rn(t.currentBookId,I,{use_parent_child:n.value,use_reasoning:i.value,use_reranker:o.value,top_k:f.value,threshold:m.value,use_global_context:s.value==="global"});if(t.removeLoadingMessages(),k.success){const U=k.mode==="global"?"ğŸŒ å…¨å±€æ¨¡å¼":"ğŸ¯ ç²¾ç¡®æ¨¡å¼";t.addQAMessage({id:(Date.now()+2).toString(),role:"assistant",content:k.answer||"",timestamp:new Date().toISOString(),mode:U,citations:k.citations||[]})}else t.addQAMessage({id:(Date.now()+2).toString(),role:"assistant",content:"æŠ±æ­‰ï¼Œå¤„ç†é—®é¢˜æ—¶å‡ºé”™: "+(k.error||"æœªçŸ¥é”™è¯¯"),timestamp:new Date().toISOString()})}catch(k){console.error("é—®ç­”è¯·æ±‚å¤±è´¥:",k),t.removeLoadingMessages(),t.addQAMessage({id:(Date.now()+2).toString(),role:"assistant",content:"æŠ±æ­‰ï¼Œç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚",timestamp:new Date().toISOString()})}finally{t.setStreaming(!1),await as(),O()}}function V(I){I.key==="Enter"&&!I.shiftKey&&(I.preventDefault(),L())}function O(){w.value&&(w.value.scrollTop=w.value.scrollHeight)}async function N(){if(t.currentBookId&&confirm(`ç¡®å®šè¦é‡å»ºå‘é‡ç´¢å¼•å—ï¼Ÿ

è¿™å°†åˆ é™¤ç°æœ‰çš„å‘é‡æ•°æ®å¹¶é‡æ–°æ„å»ºï¼Œå¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´ã€‚`)){t.setLoading(!0);try{const I=await un(t.currentBookId);if(I.success){let g="å‘é‡ç´¢å¼•é‡å»ºå®Œæˆ";I.stats&&(g+=`
é¡µé¢å‘é‡: ${I.stats.pages_count||0} æ¡`,I.stats.dialogues_count&&(g+=`
å¯¹è¯å‘é‡: ${I.stats.dialogues_count} æ¡`)),alert(g)}else alert("é‡å»ºå¤±è´¥: "+(I.error||"æœªçŸ¥é”™è¯¯"))}catch(I){console.error("é‡å»ºå‘é‡ç´¢å¼•å¤±è´¥:",I),alert("é‡å»ºå‘é‡ç´¢å¼•å¤±è´¥")}finally{t.setLoading(!1)}}}function j(I){return I?ee.parse(I):""}function J(I){t.setCurrentPage(I)}const u=["æ•…äº‹çš„ä¸»é¢˜æ˜¯ä»€ä¹ˆï¼Ÿ","ä¸»è§’çš„æ€§æ ¼æœ‰ä»€ä¹ˆå˜åŒ–ï¼Ÿ","ç»“å±€æ˜¯æ€æ ·çš„ï¼Ÿ"];function P(I){l.value=I,L()}const v=_(!1),h=_(null),C=_(""),A=_("");function E(I){if(!t.currentBookId)return;const k=t.qaHistory.find(U=>U.role==="user")?.content||"";h.value={messageId:I.id,question:k,answer:I.content,citations:I.citations||[]},C.value="",A.value="",v.value=!0}function q(){v.value=!1,h.value=null}async function te(){if(!t.currentBookId||!h.value)return;const I=new Date().toISOString(),g={id:Date.now().toString(),type:"qa",title:C.value||h.value.question.substring(0,30),content:h.value.answer,question:h.value.question,answer:h.value.answer,citations:h.value.citations,comment:A.value||void 0,createdAt:I,updatedAt:I};try{await t.addNote(g);const k=t.qaHistory.find(U=>U.id===h.value?.messageId);k&&(k.saved=!0),q()}catch(k){console.error("ä¿å­˜ç¬”è®°å¤±è´¥:",k),alert("ä¿å­˜ç¬”è®°å¤±è´¥")}}return nt(()=>{O()}),(I,g)=>(c(),p("div",co,[e("div",{ref_key:"messagesContainer",ref:w,class:"chat-messages"},[S.value.length===0?(c(),p("div",po,[...g[10]||(g[10]=[e("div",{class:"welcome-icon"},"ğŸ’¬",-1),e("h3",null,"æ™ºèƒ½é—®ç­”",-1),e("p",null,"é’ˆå¯¹å·²åˆ†æçš„æ¼«ç”»å†…å®¹æé—®ï¼Œè·å–ç²¾å‡†å›ç­”",-1)])])):T("",!0),(c(!0),p(Z,null,le(S.value,k=>(c(),p("div",{key:k.id,class:H(["chat-message",k.role])},[e("div",vo,[k.role==="user"?(c(),p("img",mo)):(c(),p(Z,{key:1},[oe(" ğŸ¤– ")],64))]),k.role==="user"?(c(),p("div",go,$(k.content),1)):(c(),p("div",ho,[k.isLoading?(c(),p("div",fo,$(k.content),1)):(c(),p(Z,{key:1},[k.mode?(c(),p("div",bo,$(k.mode),1)):T("",!0),e("div",{class:"answer-text",innerHTML:j(k.content)},null,8,ko),k.citations&&k.citations.length>0?(c(),p("div",yo,[g[11]||(g[11]=e("span",null,"ğŸ“– å¼•ç”¨: ",-1)),(c(!0),p(Z,null,le(k.citations,U=>(c(),p("span",{key:U.page,class:"citation-item",onClick:Y=>J(U.page)}," ç¬¬"+$(U.page)+"é¡µ ",9,_o))),128))])):T("",!0),k.content&&!k.isLoading?(c(),p("button",{key:2,class:H(["message-save-btn",{saved:k.saved}]),disabled:k.saved,onClick:U=>E(k)},$(k.saved?"âœ… å·²ä¿å­˜":"ğŸ“ ä¿å­˜ä¸ºç¬”è®°"),11,$o)):T("",!0)],64))]))],2))),128))],512),e("div",wo,[e("div",xo,[e("div",Co,[e("button",{type:"button",class:H(["qa-mode-btn",{active:s.value==="precise"}]),onClick:g[0]||(g[0]=k=>M("precise"))}," ğŸ¯ ç²¾ç¡®æ¨¡å¼ ",2),e("button",{type:"button",class:H(["qa-mode-btn",{active:s.value==="global"}]),onClick:g[1]||(g[1]=k=>M("global"))}," ğŸŒ å…¨å±€æ¨¡å¼ ",2)]),g[20]||(g[20]=e("span",{class:"chat-option-divider"},"|",-1)),R.value?(c(),p("div",So,[e("label",Po,[K(e("input",{"onUpdate:modelValue":g[2]||(g[2]=k=>n.value=k),type:"checkbox"},null,512),[[tt,n.value]]),g[12]||(g[12]=e("span",null,"çˆ¶å­å—æ¨¡å¼",-1))]),e("label",Io,[K(e("input",{"onUpdate:modelValue":g[3]||(g[3]=k=>i.value=k),type:"checkbox"},null,512),[[tt,i.value]]),g[13]||(g[13]=e("span",null,"æ¨ç†æ£€ç´¢",-1))]),e("label",To,[K(e("input",{"onUpdate:modelValue":g[4]||(g[4]=k=>o.value=k),type:"checkbox"},null,512),[[tt,o.value]]),g[14]||(g[14]=e("span",null,"é‡æ’åº",-1))]),g[17]||(g[17]=e("span",{class:"chat-option-divider"},"|",-1)),e("label",Ao,[g[15]||(g[15]=e("span",null,"Top K:",-1)),K(e("input",{"onUpdate:modelValue":g[5]||(g[5]=k=>f.value=k),type:"number",min:"1",max:"20",class:"input-small"},null,512),[[X,f.value,void 0,{number:!0}]])]),e("label",Lo,[g[16]||(g[16]=e("span",null,"é˜ˆå€¼:",-1)),K(e("input",{"onUpdate:modelValue":g[6]||(g[6]=k=>m.value=k),type:"number",min:"0",max:"1",step:"0.1",class:"input-small"},null,512),[[X,m.value,void 0,{number:!0}]])]),g[18]||(g[18]=e("span",{class:"chat-option-divider"},"|",-1)),e("button",{type:"button",class:"btn btn-sm btn-secondary",title:"é‡å»ºå‘é‡ç´¢å¼•",onClick:N}," ğŸ”„ é‡å»ºå‘é‡ ")])):(c(),p("div",Ro,[g[19]||(g[19]=e("span",{class:"hint-text"},"ğŸ’¡ å…¨å±€æ¨¡å¼ä½¿ç”¨å…¨æ–‡æ‘˜è¦å›ç­”ï¼Œé€‚åˆæ€»ç»“æ€§é—®é¢˜",-1)),e("div",Bo,[(c(),p(Z,null,le(u,(k,U)=>e("span",{key:U,class:"example-tag",onClick:Y=>P(k)},$(k),9,zo)),64))])]))]),e("div",Uo,[K(e("textarea",{"onUpdate:modelValue":g[7]||(g[7]=k=>l.value=k),placeholder:"è¾“å…¥ä½ çš„é—®é¢˜...",rows:"1",disabled:B.value,onKeydown:V},null,40,Mo),[[X,l.value]]),e("button",{class:"send-btn",disabled:B.value||!l.value.trim(),onClick:L},[...g[21]||(g[21]=[e("span",null,"å‘é€",-1)])],8,Eo)])]),v.value?(c(),p("div",Vo,[e("div",{class:"modal-overlay",onClick:q}),e("div",qo,[e("div",{class:"modal-header"},[g[22]||(g[22]=e("h2",null,"ğŸ“ æ·»åŠ ç¬”è®°",-1)),e("button",{class:"modal-close",onClick:q},"Ã—")]),e("div",Ko,[h.value?(c(),p("div",Oo,[e("div",Do,[g[23]||(g[23]=e("label",null,"é—®é¢˜",-1)),e("div",No,$(h.value.question),1)]),e("div",jo,[g[24]||(g[24]=e("label",null,"å›ç­”",-1)),e("div",{class:"qa-preview-content",innerHTML:j(h.value.answer)},null,8,Fo)]),h.value.citations.length>0?(c(),p("div",Qo,[g[25]||(g[25]=e("label",null,"å¼•ç”¨é¡µç ",-1)),e("div",Ho,[(c(!0),p(Z,null,le(h.value.citations,k=>(c(),p("span",{key:k.page,class:"qa-citation-badge"}," ç¬¬"+$(k.page)+"é¡µ ",1))),128))])])):T("",!0)])):T("",!0),e("div",Jo,[e("div",Go,[g[26]||(g[26]=e("label",{for:"qaNoteTitle"},[oe("ç¬”è®°æ ‡é¢˜ "),e("span",{class:"optional"},"(å¯é€‰)")],-1)),K(e("input",{"onUpdate:modelValue":g[8]||(g[8]=k=>C.value=k),type:"text",id:"qaNoteTitle",class:"form-input",placeholder:"é»˜è®¤ä½¿ç”¨é—®é¢˜ä½œä¸ºæ ‡é¢˜..."},null,512),[[X,C.value]])]),e("div",Zo,[g[27]||(g[27]=e("label",{for:"qaNoteComment"},[oe("è¡¥å……è¯´æ˜ "),e("span",{class:"optional"},"(å¯é€‰)")],-1)),K(e("textarea",{"onUpdate:modelValue":g[9]||(g[9]=k=>A.value=k),id:"qaNoteComment",class:"form-textarea",rows:"3",placeholder:"æ·»åŠ ä½ çš„è¯„è®ºæˆ–è¡¥å……..."},null,512),[[X,A.value]])])])]),e("div",{class:"modal-footer"},[e("button",{class:"btn btn-secondary",onClick:q},"å–æ¶ˆ"),e("button",{class:"btn btn-primary",onClick:te},"ä¿å­˜ç¬”è®°")])])])):T("",!0)]))}}),Xo=Ke(Wo,[["__scopeId","data-v-6caf9696"]]),Yo={class:"workspace-section notes-section"},er={class:"section-header-with-actions"},tr={class:"notes-filter"},sr={class:"notes-list"},nr={key:0,class:"placeholder-text"},lr=["onClick"],ar={class:"note-header"},or={class:"note-type-icon"},rr={class:"note-date"},ir={class:"note-actions"},ur=["onClick"],cr=["onClick"],dr={key:0,class:"note-title"},pr={key:1,class:"note-content"},vr={class:"qa-preview-text"},mr={key:2,class:"note-content"},gr={key:3,class:"note-tags"},hr={key:4,class:"note-citations"},fr=["onClick"],br={key:0,class:"citation-badge"},kr={key:5,class:"note-page-link"},yr=["onClick"],_r={class:"modal-content modal-sm"},$r={class:"modal-header"},wr={class:"modal-body"},xr={class:"qa-note-view"},Cr={class:"qa-section"},Sr={class:"qa-content"},Pr={class:"qa-section"},Ir={class:"qa-content qa-answer"},Tr={key:0,class:"qa-section"},Ar={class:"qa-citations"},Lr=["onClick"],Rr={key:1,class:"qa-section"},Br={class:"qa-content"},zr={class:"form-group"},Ur={class:"form-group"},Mr={class:"form-group"},Er={class:"form-group"},Vr={class:"form-group"},qr={class:"form-group"},Kr={class:"modal-footer"},Or=["disabled"],Dr=ze({__name:"NotesPanel",setup(a){const t=[{label:"å…¨éƒ¨",value:"all"},{label:"æ–‡æœ¬ç¬”è®°",value:"text"},{label:"é—®ç­”ç¬”è®°",value:"qa"}],l=[{label:"æ–‡æœ¬ç¬”è®°",value:"text"},{label:"é—®ç­”ç¬”è®°",value:"qa"}],s=De(),n=_(!1),i=_(null),o=_(""),f=_(""),m=_("text"),w=_(null),S=_(""),B=z(()=>s.filteredNotes),R=z({get:()=>s.noteTypeFilter,set:v=>s.setNoteTypeFilter(v)});function M(){i.value=null,o.value="",f.value="",m.value="text",w.value=s.selectedPageNum,S.value="",n.value=!0}function L(v){i.value=v,o.value=v.title||"",f.value=v.content,m.value=v.type,w.value=v.pageNum||null,S.value=(v.tags||[]).join(", "),n.value=!0}function V(){n.value=!1,i.value=null,o.value="",f.value="",S.value=""}function O(v){return v.trim()?v.split(/[,ï¼Œ]/).map(h=>h.trim()).filter(h=>h):[]}async function N(){if(!f.value.trim())return;const v=O(S.value);if(i.value)await s.updateNote(i.value.id,{title:o.value||void 0,content:f.value,type:m.value,pageNum:w.value||void 0,tags:v.length>0?v:void 0});else{const h={id:Date.now().toString(),type:m.value,title:o.value||void 0,content:f.value,pageNum:w.value||void 0,tags:v.length>0?v:void 0,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};await s.addNote(h)}V()}async function j(v){confirm("ç¡®å®šè¦åˆ é™¤è¿™æ¡ç¬”è®°å—ï¼Ÿ")&&await s.deleteNote(v)}function J(v){s.selectPage(v)}function u(v){return new Date(v).toLocaleDateString("zh-CN",{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}function P(v){return v==="qa"?"ğŸ’¬":"ğŸ“"}return(v,h)=>(c(),p("div",Yo,[e("div",er,[h[7]||(h[7]=e("h3",{class:"section-title"},"ğŸ“ ç¬”è®°",-1)),e("div",tr,[ue(Se,{modelValue:R.value,"onUpdate:modelValue":h[0]||(h[0]=C=>R.value=C),options:t},null,8,["modelValue"])])]),e("div",sr,[B.value.length===0?(c(),p("div",nr," æš‚æ— ç¬”è®° ")):T("",!0),(c(!0),p(Z,null,le(B.value,C=>(c(),p("div",{key:C.id,class:H(["note-item",{"qa-note":C.type==="qa"}]),onClick:A=>L(C)},[e("div",ar,[e("span",or,$(P(C.type)),1),e("span",rr,$(u(C.createdAt)),1),e("div",ir,[e("button",{class:"btn-icon-sm",title:"ç¼–è¾‘",onClick:we(A=>L(C),["stop"])}," âœï¸ ",8,ur),e("button",{class:"btn-icon-sm",title:"åˆ é™¤",onClick:we(A=>j(C.id),["stop"])}," ğŸ—‘ï¸ ",8,cr)])]),C.title?(c(),p("div",dr,$(C.title),1)):T("",!0),C.type==="qa"?(c(),p("div",pr,[e("div",vr,"Q: "+$(C.question?.substring(0,60))+"...",1)])):(c(),p("div",mr,$(C.content),1)),C.tags&&C.tags.length>0?(c(),p("div",gr,[(c(!0),p(Z,null,le(C.tags,A=>(c(),p("span",{key:A,class:"note-tag"},$(A),1))),128))])):T("",!0),C.type==="qa"&&C.citations&&C.citations.length>0?(c(),p("div",hr,[(c(!0),p(Z,null,le(C.citations.slice(0,3),A=>(c(),p("span",{key:A.page,class:"citation-badge",onClick:we(E=>J(A.page),["stop"])}," ç¬¬"+$(A.page)+"é¡µ ",9,fr))),128)),C.citations.length>3?(c(),p("span",br,"+"+$(C.citations.length-3),1)):T("",!0)])):T("",!0),C.pageNum?(c(),p("div",kr,[e("button",{class:"btn-link",onClick:we(A=>J(C.pageNum),["stop"])}," ğŸ“„ ç¬¬ "+$(C.pageNum)+" é¡µ ",9,yr)])):T("",!0)],10,lr))),128))]),e("button",{class:"btn btn-secondary btn-block btn-sm",onClick:M}," + æ·»åŠ ç¬”è®° "),n.value?(c(),p("div",{key:0,class:"modal show",onClick:we(V,["self"])},[e("div",_r,[e("div",$r,[e("h3",null,$(i.value?"ç¼–è¾‘ç¬”è®°":"æ·»åŠ ç¬”è®°"),1),e("button",{class:"modal-close",onClick:V},"Ã—")]),e("div",wr,[i.value&&i.value.type==="qa"?(c(),p(Z,{key:0},[e("div",xr,[e("div",Cr,[h[8]||(h[8]=e("label",{class:"qa-label"},"é—®é¢˜",-1)),e("div",Sr,$(i.value.question),1)]),e("div",Pr,[h[9]||(h[9]=e("label",{class:"qa-label"},"å›ç­”",-1)),e("div",Ir,$(i.value.answer),1)]),i.value.citations&&i.value.citations.length>0?(c(),p("div",Tr,[h[10]||(h[10]=e("label",{class:"qa-label"},"å¼•ç”¨é¡µç ",-1)),e("div",Ar,[(c(!0),p(Z,null,le(i.value.citations,C=>(c(),p("span",{key:C.page,class:"qa-citation-badge",onClick:A=>J(C.page)}," ç¬¬"+$(C.page)+"é¡µ ",9,Lr))),128))])])):T("",!0),i.value.comment?(c(),p("div",Rr,[h[11]||(h[11]=e("label",{class:"qa-label"},"è¡¥å……è¯´æ˜",-1)),e("div",Br,$(i.value.comment),1)])):T("",!0)]),e("div",zr,[h[12]||(h[12]=e("label",null,[oe("ç¬”è®°æ ‡é¢˜ "),e("span",{class:"label-optional"},"(å¯é€‰)")],-1)),K(e("input",{"onUpdate:modelValue":h[1]||(h[1]=C=>o.value=C),type:"text",class:"form-input",placeholder:"ä¿®æ”¹æ ‡é¢˜..."},null,512),[[X,o.value]])])],64)):(c(),p(Z,{key:1},[e("div",Ur,[h[13]||(h[13]=e("label",null,"ç¬”è®°ç±»å‹",-1)),ue(Se,{modelValue:m.value,"onUpdate:modelValue":h[2]||(h[2]=C=>m.value=C),options:l},null,8,["modelValue"])]),e("div",Mr,[h[14]||(h[14]=e("label",null,[oe("æ ‡é¢˜ "),e("span",{class:"label-optional"},"(å¯é€‰)")],-1)),K(e("input",{"onUpdate:modelValue":h[3]||(h[3]=C=>o.value=C),type:"text",class:"form-input",placeholder:"ç»™ç¬”è®°èµ·ä¸ªæ ‡é¢˜..."},null,512),[[X,o.value]])]),e("div",Er,[h[15]||(h[15]=e("label",null,[oe("å†…å®¹ "),e("span",{class:"label-required"},"*")],-1)),K(e("textarea",{"onUpdate:modelValue":h[4]||(h[4]=C=>f.value=C),class:"form-textarea",rows:"5",placeholder:"å†™ä¸‹ä½ çš„æƒ³æ³•..."},null,512),[[X,f.value]])]),e("div",Vr,[h[16]||(h[16]=e("label",null,[oe("å…³è”é¡µç  "),e("span",{class:"label-optional"},"(å¯é€‰)")],-1)),K(e("input",{"onUpdate:modelValue":h[5]||(h[5]=C=>w.value=C),type:"number",class:"form-input",placeholder:"è¾“å…¥é¡µç ",min:"1"},null,512),[[X,w.value,void 0,{number:!0}]])]),e("div",qr,[h[17]||(h[17]=e("label",null,[oe("æ ‡ç­¾ "),e("span",{class:"label-optional"},"(å¯é€‰)")],-1)),K(e("input",{"onUpdate:modelValue":h[6]||(h[6]=C=>S.value=C),type:"text",class:"form-input",placeholder:"å¤šä¸ªæ ‡ç­¾ç”¨é€—å·åˆ†éš”ï¼Œå¦‚: è§’è‰²,å‰§æƒ…"},null,512),[[X,S.value]])])],64))]),e("div",Kr,[e("button",{class:"btn btn-secondary",onClick:V},"å–æ¶ˆ"),e("button",{class:"btn btn-primary",disabled:i.value?.type!=="qa"&&!f.value.trim(),onClick:N}," ä¿å­˜ ",8,Or)])])])):T("",!0)]))}}),Nr=Ke(Dr,[["__scopeId","data-v-a80a8846"]]),jr={class:"workspace-section page-detail-section"},Fr={class:"page-detail"},Qr={key:0,class:"placeholder-text"},Hr={key:1,class:"loading-state"},Jr={key:2,class:"page-detail-content"},Gr={class:"page-detail-header"},Zr={class:"page-nav-buttons"},Wr=["disabled"],Xr={class:"page-indicator"},Yr=["disabled"],ei={key:0,class:"error-message"},ti=["src","alt"],si={key:1,class:"page-summary"},ni={key:2,class:"page-summary empty"},li={key:3,class:"scene-mood-info"},ai={key:0,class:"info-item"},oi={class:"info-value"},ri={key:1,class:"info-item"},ii={class:"info-value"},ui={key:4,class:"dialogues-section"},ci={class:"dialogue-speaker"},di={class:"dialogue-text"},pi={key:0,class:"dialogue-original"},vi={key:5,class:"dialogues-section empty"},mi={class:"page-detail-actions"},gi=["disabled"],hi={key:0,class:"btn-spinner"},fi=["disabled"],bi=["src","alt"],ki={class:"preview-nav"},yi=["disabled"],_i={class:"preview-page-info"},$i=["disabled"],wi=ze({__name:"PageDetail",setup(a){const t=De(),l=_(null),s=_(!1),n=_(!1),i=_(!1),o=_(""),f=z(()=>t.selectedPageNum),m=z(()=>t.totalPageCount),w=z(()=>f.value!==null&&f.value>1),S=z(()=>f.value!==null&&f.value<m.value),B=z(()=>!t.currentBookId||!f.value?"":nn(t.currentBookId,f.value)),R=z(()=>{if(!l.value?.panels)return[];const A=[];for(const E of l.value.panels)if(E.dialogues)for(const q of E.dialogues){const te=q.translated_text||q.text;te&&A.push({speaker:q.speaker_name||q.character||"æœªçŸ¥",text:te,originalText:q.text!==q.translated_text?q.text:void 0})}return A}),M=z(()=>l.value?.analyzed===!0||!!l.value?.page_summary),L=z(()=>l.value?.scene||""),V=z(()=>l.value?.mood||"");async function O(){if(!t.currentBookId||!f.value){l.value=null;return}s.value=!0,o.value="";try{const A=await sn(t.currentBookId,f.value);A.success?A.analysis?l.value=A.analysis:A.page?l.value=A.page:l.value=null:(l.value=null,A.error&&(o.value=A.error))}catch(A){console.error("åŠ è½½é¡µé¢è¯¦æƒ…å¤±è´¥:",A),l.value=null,o.value=A instanceof Error?A.message:"åŠ è½½å¤±è´¥"}finally{s.value=!1}}function N(){w.value&&f.value&&t.selectPage(f.value-1)}function j(){S.value&&f.value&&t.selectPage(f.value+1)}async function J(){if(!(!t.currentBookId||!f.value)){n.value=!0,o.value="";try{const A=await hs(t.currentBookId,f.value);A.success?await O():o.value=A.error||"é‡æ–°åˆ†æå¤±è´¥"}catch(A){console.error("é‡æ–°åˆ†æå¤±è´¥:",A),o.value=A instanceof Error?A.message:"é‡æ–°åˆ†æå¤±è´¥"}finally{n.value=!1}}}function u(){i.value=!0}function P(){i.value=!1}function v(A){if(i.value)switch(A.key){case"Escape":P();break;case"ArrowLeft":w.value&&N();break;case"ArrowRight":S.value&&j();break}}const h=_(!1);async function C(){if(!(!t.currentBookId||!f.value||!l.value)){h.value=!0;try{let A=`# ç¬¬ ${f.value} é¡µåˆ†ææ•°æ®

`;if(l.value.page_summary&&(A+=`## ğŸ“ é¡µé¢æ‘˜è¦

${l.value.page_summary}

`),l.value.scene&&(A+=`## ğŸ¬ åœºæ™¯

${l.value.scene}

`),l.value.mood&&(A+=`## ğŸ­ æ°›å›´

${l.value.mood}

`),R.value.length>0){A+=`## ğŸ’¬ å¯¹è¯å†…å®¹

`;for(const I of R.value)A+=`**${I.speaker}**: ${I.text}

`,I.originalText&&(A+=`> åŸæ–‡: ${I.originalText}

`)}const E=new Blob([A],{type:"text/markdown"}),q=URL.createObjectURL(E),te=document.createElement("a");te.href=q,te.download=`${t.currentBookId}_page_${f.value}.md`,te.click(),URL.revokeObjectURL(q)}catch(A){console.error("å¯¼å‡ºé¡µé¢æ•°æ®å¤±è´¥:",A),o.value="å¯¼å‡ºå¤±è´¥"}finally{h.value=!1}}}return st(f,()=>{O()},{immediate:!0}),(A,E)=>(c(),p("div",jr,[E[12]||(E[12]=e("h3",{class:"section-title"},"ğŸ“„ é¡µé¢è¯¦æƒ…",-1)),e("div",Fr,[f.value?s.value?(c(),p("div",Hr,[...E[3]||(E[3]=[e("div",{class:"loading-spinner"},null,-1),e("p",null,"åŠ è½½ä¸­...",-1)])])):(c(),p("div",Jr,[e("div",Gr,[e("h4",null,"ğŸ“„ ç¬¬ "+$(f.value)+" é¡µ",1),e("div",Zr,[e("button",{class:H(["btn-page-nav",{disabled:!w.value}]),disabled:!w.value,title:"ä¸Šä¸€é¡µ (â†)",onClick:N}," â—€ ä¸Šä¸€å¼  ",10,Wr),e("span",Xr,$(f.value)+" / "+$(m.value),1),e("button",{class:H(["btn-page-nav",{disabled:!S.value}]),disabled:!S.value,title:"ä¸‹ä¸€é¡µ (â†’)",onClick:j}," ä¸‹ä¸€å¼  â–¶ ",10,Yr)])]),o.value?(c(),p("div",ei," âš ï¸ "+$(o.value),1)):T("",!0),e("div",{class:"page-detail-image",onClick:u},[e("img",{src:B.value,alt:`ç¬¬${f.value}é¡µ`,onError:E[0]||(E[0]=q=>q.target.style.display="none")},null,40,ti),E[4]||(E[4]=e("div",{class:"image-overlay"},[e("span",{class:"zoom-hint"},"ğŸ” ç‚¹å‡»æ”¾å¤§")],-1))]),e("div",{class:H(["analysis-status-tag",{analyzed:M.value}])},$(M.value?"âœ“ å·²åˆ†æ":"â—‹ æœªåˆ†æ"),3),l.value?.page_summary?(c(),p("div",si,[E[5]||(E[5]=e("h5",null,"ğŸ“ é¡µé¢æ‘˜è¦",-1)),e("p",null,$(l.value.page_summary),1)])):(c(),p("div",ni,[...E[6]||(E[6]=[e("p",null,"æ­¤é¡µå°šæœªåˆ†æï¼Œç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å§‹åˆ†æ",-1)])])),L.value||V.value?(c(),p("div",li,[L.value?(c(),p("div",ai,[E[7]||(E[7]=e("span",{class:"info-label"},"ğŸ¬ åœºæ™¯ï¼š",-1)),e("span",oi,$(L.value),1)])):T("",!0),V.value?(c(),p("div",ri,[E[8]||(E[8]=e("span",{class:"info-label"},"ğŸ­ æ°›å›´ï¼š",-1)),e("span",ii,$(V.value),1)])):T("",!0)])):T("",!0),R.value.length>0?(c(),p("div",ui,[e("h5",null,"ğŸ’¬ å¯¹è¯å†…å®¹ ("+$(R.value.length)+")",1),(c(!0),p(Z,null,le(R.value,(q,te)=>(c(),p("div",{key:te,class:"dialogue-item"},[e("div",ci,[E[9]||(E[9]=e("span",{class:"speaker-icon"},"ğŸ‘¤",-1)),oe(" "+$(q.speaker),1)]),e("div",di,$(q.text),1),q.originalText?(c(),p("div",pi,[E[10]||(E[10]=e("span",{class:"original-label"},"åŸæ–‡ï¼š",-1)),oe($(q.originalText),1)])):T("",!0)]))),128))])):M.value?(c(),p("div",vi,[...E[11]||(E[11]=[e("p",null,"æ­¤é¡µæ²¡æœ‰æ£€æµ‹åˆ°å¯¹è¯å†…å®¹",-1)])])):T("",!0),e("div",mi,[e("button",{class:H(["btn btn-secondary btn-sm",{loading:n.value}]),disabled:n.value,onClick:J},[n.value?(c(),p("span",hi)):T("",!0),oe(" "+$(n.value?"åˆ†æä¸­...":"ğŸ”„ é‡æ–°åˆ†æ"),1)],10,gi),M.value?(c(),p("button",{key:0,class:"btn btn-secondary btn-sm",disabled:h.value,onClick:C},$(h.value?"å¯¼å‡ºä¸­...":"ğŸ“„ å¯¼å‡ºæ­¤é¡µ"),9,fi)):T("",!0)])])):(c(),p("div",Qr,[...E[2]||(E[2]=[e("div",{class:"empty-icon"},"ğŸ“„",-1),e("p",null,"ç‚¹å‡»å·¦ä¾§å¯¼èˆªæ ‘ä¸­çš„é¡µé¢æŸ¥çœ‹è¯¦æƒ…",-1)])]))]),i.value?(c(),p("div",{key:0,class:"image-preview-modal",tabindex:"0",onClick:P,onKeydown:v},[e("div",{class:"image-preview-content",onClick:E[1]||(E[1]=we(()=>{},["stop"]))},[e("button",{class:"preview-close",title:"å…³é—­ (Esc)",onClick:P},"Ã—"),e("img",{src:B.value,alt:`ç¬¬${f.value}é¡µ`},null,8,bi),e("div",ki,[e("button",{class:"preview-nav-btn prev",disabled:!w.value,title:"ä¸Šä¸€é¡µ (â†)",onClick:we(N,["stop"])}," â—€ ",8,yi),e("span",_i,$(f.value)+" / "+$(m.value),1),e("button",{class:"preview-nav-btn next",disabled:!S.value,title:"ä¸‹ä¸€é¡µ (â†’)",onClick:we(j,["stop"])}," â–¶ ",8,$i)])])],32)):T("",!0)]))}}),xi=Ke(wi,[["__scopeId","data-v-b7c8cc0d"]]),Ci={class:"sidebar-section pages-tree-section"},Si={class:"section-header"},Pi={class:"page-count-badge"},Ii={class:"pages-tree"},Ti={key:0,class:"empty-hint"},Ai={key:1,class:"tree-all-pages"},Li=["data-page","onClick"],Ri=["src","alt"],Bi={class:"tree-page-num"},zi={key:2,class:"tree-load-more"},Ui=["onClick"],Mi={class:"tree-chapter-info"},Ei={class:"tree-chapter-title"},Vi={class:"tree-chapter-meta"},qi=["onClick"],Ki={class:"tree-pages-grid"},Oi=["data-page","onClick","onContextmenu"],Di=["src","alt"],Ni={class:"tree-page-num"},ji=ze({__name:"PagesTree",setup(a){const t=De(),l=_(new Set),s=_(new Map),n=_(100),i=z(()=>t.chapters),o=z(()=>t.totalPageCount);function f(P){l.value.has(P)?l.value.delete(P):l.value.add(P)}function m(P){return l.value.has(P)}function w(P){t.selectPage(P)}function S(P){return s.value.get(P)||!1}function B(P){return t.selectedPageNum===P}function R(P,v){const h=[];for(let C=P;C<=v;C++)h.push(C);return h}function M(P){return t.currentBookId?fs(t.currentBookId,P):""}function L(){n.value=Math.min(n.value+100,o.value)}function V(P){const v=P.target;v.style.opacity="0"}function O(P){const v=P.endPage-P.startPage+1;let h=0;for(let C=P.startPage;C<=P.endPage;C++)s.value.get(C)&&h++;return h===v}async function N(P){if(confirm("ç¡®å®šè¦é‡æ–°åˆ†ææ­¤ç« èŠ‚å—ï¼Ÿ"))try{const h=await(await fetch(`/api/manga-insight/${t.currentBookId}/reanalyze/chapter/${P}`,{method:"POST"})).json();h.success?alert("ç« èŠ‚åˆ†æå·²å¯åŠ¨"):alert("å¯åŠ¨å¤±è´¥: "+(h.error||"æœªçŸ¥é”™è¯¯"))}catch(v){console.error("é‡æ–°åˆ†æç« èŠ‚å¤±è´¥:",v),alert("é‡æ–°åˆ†æå¤±è´¥")}}function j(P,v){const h=prompt(`ç¬¬ ${v} é¡µæ“ä½œ:
1. æŸ¥çœ‹è¯¦æƒ…
2. é‡æ–°åˆ†æ
3. æ·»åŠ ç¬”è®°

è¯·è¾“å…¥æ•°å­—:`);h==="1"?w(v):h==="2"?J(v):h==="3"&&alert("ç¬”è®°åŠŸèƒ½å¼€å‘ä¸­")}async function J(P){try{const v=await hs(t.currentBookId,P);v.success?alert(`ç¬¬ ${P} é¡µåˆ†æå·²å¯åŠ¨`):alert("åˆ†æå¤±è´¥: "+(v.error||"æœªçŸ¥é”™è¯¯"))}catch(v){console.error("é‡æ–°åˆ†æé¡µé¢å¤±è´¥:",v),alert("é‡æ–°åˆ†æå¤±è´¥")}}async function u(){if(t.currentBookId)try{const v=await(await fetch(`/api/manga-insight/${t.currentBookId}/pages`)).json();v.success&&v.pages&&v.pages.forEach(C=>{s.value.set(C,!0)})}catch(P){console.error("åŠ è½½å·²åˆ†æé¡µé¢å¤±è´¥:",P)}}return nt(async()=>{await u(),i.value.length>0&&i.value[0]&&l.value.add(i.value[0].id)}),(P,v)=>(c(),p("div",Ci,[e("div",Si,[v[2]||(v[2]=e("h3",{class:"section-title"},"å†…å®¹å¯¼èˆª",-1)),e("span",Pi,$(o.value)+"é¡µ",1)]),e("div",Ii,[i.value.length===0?(c(),p(Z,{key:0},[o.value===0?(c(),p("div",Ti," æš‚æ— é¡µé¢ ")):(c(),p("div",Ai,[(c(!0),p(Z,null,le(R(1,Math.min(o.value,n.value)),h=>(c(),p("div",{key:h,class:H(["tree-page-item",{selected:B(h),analyzed:S(h)}]),"data-page":h,onClick:C=>w(h)},[e("img",{src:M(h),alt:`ç¬¬${h}é¡µ`,class:"tree-page-thumb",loading:"lazy",onError:v[0]||(v[0]=C=>V(C))},null,40,Ri),e("span",Bi,$(h),1)],10,Li))),128))])),o.value>n.value?(c(),p("div",zi,[e("button",{class:"btn-load-more",onClick:L}," åŠ è½½æ›´å¤š (è¿˜æœ‰ "+$(o.value-n.value)+" é¡µ) ",1)])):T("",!0)],64)):(c(!0),p(Z,{key:1},le(i.value,h=>(c(),p("div",{key:h.id,class:H(["tree-chapter",{expanded:m(h.id)}])},[e("div",{class:"tree-chapter-header",onClick:C=>f(h.id)},[v[3]||(v[3]=e("span",{class:"tree-expand-icon"},[e("svg",{width:"12",height:"12",viewBox:"0 0 24 24",fill:"currentColor"},[e("path",{d:"M8 5l8 7-8 7z"})])],-1)),e("div",Mi,[e("span",Ei,$(h.title),1),e("span",Vi,$(h.endPage-h.startPage+1)+"é¡µ",1)]),e("span",{class:H(["tree-chapter-status",{analyzed:O(h)}])},null,2),e("button",{class:"btn-reanalyze-chapter",title:"é‡æ–°åˆ†ææ­¤ç« èŠ‚",onClick:we(C=>N(h.id),["stop"])}," ğŸ”„ ",8,qi)],8,Ui),e("div",Ki,[(c(!0),p(Z,null,le(R(h.startPage,h.endPage),C=>(c(),p("div",{key:C,class:H(["tree-page-item",{selected:B(C),analyzed:S(C)}]),"data-page":C,onClick:A=>w(C),onContextmenu:we(A=>j(A,C),["prevent"])},[e("img",{src:M(C),alt:`ç¬¬${C}é¡µ`,class:"tree-page-thumb",loading:"lazy",onError:v[1]||(v[1]=A=>V(A))},null,40,Di),e("span",Ni,$(C),1)],42,Oi))),128))])],2))),128))])]))}}),Fi=Ke(ji,[["__scopeId","data-v-40e69941"]]),Qi={class:"settings-tabs"},Hi={key:1,class:"insight-settings-content"},Ji={class:"form-group"},Gi={class:"form-group"},Zi={class:"form-group"},Wi={class:"model-input-row"},Xi=["disabled"],Yi={key:0,class:"model-select-container"},eu=["value"],tu=["value"],su={class:"model-count"},nu={key:0,class:"form-group"},lu={class:"form-row"},au={class:"form-group"},ou={class:"form-group"},ru={class:"form-group"},iu={class:"checkbox-label"},uu={class:"form-group"},cu={class:"checkbox-label"},du={class:"form-group"},pu=["disabled"],vu={key:2,class:"insight-settings-content"},mu={class:"form-group"},gu={class:"form-group"},hu={class:"form-group"},fu={class:"model-input-row"},bu=["disabled"],ku={key:0,class:"model-select-container"},yu=["value"],_u=["value"],$u={class:"model-count"},wu={key:0,class:"form-group"},xu={class:"form-group"},Cu={class:"checkbox-label"},Su=["disabled"],Pu={key:3,class:"insight-settings-content"},Iu={class:"form-group"},Tu={class:"form-hint"},Au={class:"form-group"},Lu={class:"form-group"},Ru={class:"form-hint"},Bu={key:0,style:{"margin-top":"16px"}},zu={style:{"margin-bottom":"8px"}},Uu={style:{"min-width":"50px",color:"#666","font-size":"13px"}},Mu=["value","disabled","onChange"],Eu=["value","disabled","title","onChange"],Vu={style:{display:"flex","flex-direction":"column","align-items":"center",gap:"2px","font-size":"11px",cursor:"pointer","min-width":"40px","text-align":"center"}},qu=["checked","onChange"],Ku=["onClick"],Ou={class:"batch-info-box"},Du={class:"layers-preview-list"},Nu={key:0,class:"align-badge"},ju={class:"batch-estimate-box"},Fu={key:4,class:"insight-settings-content"},Qu={class:"form-group"},Hu={class:"form-group"},Ju={class:"form-group"},Gu={class:"model-input-row"},Zu=["disabled"],Wu={key:0,class:"model-select-container"},Xu=["value"],Yu=["value"],ec={class:"model-count"},tc={key:0,class:"form-group"},sc={class:"form-group"},nc=["disabled"],lc={key:5,class:"insight-settings-content"},ac={class:"form-group"},oc={class:"form-group"},rc={class:"form-group"},ic={class:"model-input-row"},uc=["disabled"],cc={key:0,class:"model-select-container"},dc=["value"],pc=["value"],vc={class:"model-count"},mc={key:0,class:"form-group"},gc={class:"form-group"},hc=["disabled"],fc={key:6,class:"insight-settings-content prompts-settings"},bc={class:"form-group"},kc={class:"form-hint"},yc={class:"form-group"},_c={class:"prompts-library-section"},$c={class:"library-header"},wc={class:"library-actions"},xc={class:"saved-prompts-list"},Cc={key:0,class:"loading-text"},Sc={key:1,class:"placeholder-text"},Pc=["onClick"],Ic={class:"prompt-name"},Tc={class:"prompt-type-badge"},Ac=["onClick"],Lc=["disabled"],Rc=ze({__name:"InsightSettingsModal",emits:["close"],setup(a,{emit:t}){const l=t,s=De(),n=_("vlm"),i=_(!1),o=_(!1),f=_(""),m=_(""),w=_([]),S=_([]),B=_([]),R=_([]),M=_(!1),L=_(!1),V=_(!1),O=_(!1),N=_(!1),j=_(!1),J=_(!1),u=_(!1),P=_(!1),v=_(s.config.vlm.provider),h=_(s.config.vlm.apiKey),C=_(s.config.vlm.model),A=_(s.config.vlm.baseUrl),E=_(s.config.vlm.rpmLimit),q=_(s.config.vlm.temperature),te=_(s.config.vlm.forceJson),I=_(s.config.vlm.useStream),g=_(s.config.vlm.imageMaxSize),k=_(s.config.llm.provider),U=_(s.config.llm.apiKey),Y=_(s.config.llm.model),ce=_(s.config.llm.baseUrl),Pe=_(s.config.llm.useStream),xe=_(s.config.batch.pagesPerBatch),Ne=_(s.config.batch.contextBatchCount),ye=_(s.config.batch.architecturePreset),je={simple:{name:"ç®€æ´æ¨¡å¼",description:"é€‚åˆ100é¡µä»¥å†…çš„çŸ­ç¯‡æ¼«ç”»",layers:[{name:"æ‰¹é‡åˆ†æ",units:5,align:!1},{name:"å…¨ä¹¦æ€»ç»“",units:0,align:!1}]},standard:{name:"æ ‡å‡†æ¨¡å¼",description:"é€‚åˆå¤§å¤šæ•°æ¼«ç”»ï¼Œå¹³è¡¡æ•ˆæœä¸é€Ÿåº¦",layers:[{name:"æ‰¹é‡åˆ†æ",units:5,align:!1},{name:"æ®µè½æ€»ç»“",units:5,align:!1},{name:"å…¨ä¹¦æ€»ç»“",units:0,align:!1}]},chapter_based:{name:"ç« èŠ‚æ¨¡å¼",description:"é€‚åˆæœ‰æ˜ç¡®ç« èŠ‚åˆ’åˆ†çš„æ¼«ç”»ï¼Œä¼šåœ¨ç« èŠ‚è¾¹ç•Œå¤„åˆ‡åˆ†",layers:[{name:"æ‰¹é‡åˆ†æ",units:5,align:!0},{name:"ç« èŠ‚æ€»ç»“",units:0,align:!0},{name:"å…¨ä¹¦æ€»ç»“",units:0,align:!1}]},full:{name:"å®Œæ•´æ¨¡å¼",description:"é€‚åˆé•¿ç¯‡è¿è½½ï¼Œæä¾›æœ€è¯¦ç»†çš„åˆ†å±‚æ€»ç»“",layers:[{name:"æ‰¹é‡åˆ†æ",units:5,align:!1},{name:"å°æ€»ç»“",units:5,align:!1},{name:"ç« èŠ‚æ€»ç»“",units:0,align:!0},{name:"å…¨ä¹¦æ€»ç»“",units:0,align:!1}]}},de=_(s.config.batch.customLayers?.length>0?s.config.batch.customLayers.map(y=>({name:y.name,units:y.units_per_group??y.units??5,align:y.align_to_chapter??y.align??!1})):[{name:"æ‰¹é‡åˆ†æ",units:5,align:!1},{name:"æ®µè½æ€»ç»“",units:5,align:!1},{name:"å…¨ä¹¦æ€»ç»“",units:0,align:!1}]),Ie=_(s.config.embedding.provider),Ue=_(s.config.embedding.apiKey),_e=_(s.config.embedding.model),Me=_(s.config.embedding.baseUrl),Fe=_(s.config.embedding.rpmLimit),Te=_(s.config.reranker.provider),Ee=_(s.config.reranker.apiKey),$e=_(s.config.reranker.model),Ve=_(s.config.reranker.baseUrl),Qe=_(s.config.reranker.topK),ve=_("batch_analysis"),re=_(""),pe=_({}),be=_([]),lt=_(!1),gt=[{value:"gemini",label:"Google Gemini"},{value:"openai",label:"OpenAI"},{value:"qwen",label:"é˜¿é‡Œé€šä¹‰åƒé—®"},{value:"siliconflow",label:"SiliconFlow"},{value:"deepseek",label:"DeepSeek"},{value:"volcano",label:"ç«å±±å¼•æ“"},{value:"custom",label:"è‡ªå®šä¹‰ OpenAI å…¼å®¹"}],wt=[{value:"openai",label:"OpenAI"},{value:"siliconflow",label:"SiliconFlow"},{value:"custom",label:"è‡ªå®šä¹‰"}],xt=[{value:"jina",label:"Jina AI"},{value:"cohere",label:"Cohere"},{value:"siliconflow",label:"SiliconFlow"},{value:"custom",label:"è‡ªå®šä¹‰"}],Ct=[{value:"simple",label:"ç®€æ´æ¨¡å¼ - æ‰¹é‡åˆ†æ â†’ å…¨ä¹¦æ€»ç»“ï¼ˆçŸ­ç¯‡ï¼‰"},{value:"standard",label:"æ ‡å‡†æ¨¡å¼ - æ‰¹é‡åˆ†æ â†’ æ®µè½æ€»ç»“ â†’ å…¨ä¹¦æ€»ç»“"},{value:"chapter_based",label:"ç« èŠ‚æ¨¡å¼ - æ‰¹é‡åˆ†æ â†’ ç« èŠ‚æ€»ç»“ â†’ å…¨ä¹¦æ€»ç»“"},{value:"full",label:"å®Œæ•´æ¨¡å¼ - æ‰¹é‡åˆ†æ â†’ å°æ€»ç»“ â†’ ç« èŠ‚æ€»ç»“ â†’ å…¨ä¹¦æ€»ç»“"},{value:"custom",label:"è‡ªå®šä¹‰æ¨¡å¼ - å®Œå…¨è‡ªå®šä¹‰å±‚çº§æ¶æ„"}],St=[{value:"batch_analysis",label:"ğŸ“„ æ‰¹é‡åˆ†ææç¤ºè¯"},{value:"segment_summary",label:"ğŸ“‘ æ®µè½æ€»ç»“æç¤ºè¯"},{value:"chapter_summary",label:"ğŸ“– ç« èŠ‚æ€»ç»“æç¤ºè¯"},{value:"qa_response",label:"ğŸ’¬ é—®ç­”å“åº”æç¤ºè¯"}],Pt={gemini:"gemini-2.0-flash",openai:"gpt-4o",qwen:"qwen-vl-max",deepseek:"deepseek-chat",siliconflow:"Qwen/Qwen2.5-VL-72B-Instruct",volcano:"doubao-1.5-vision-pro-32k"},It={gemini:"gemini-2.0-flash",openai:"gpt-4o-mini",qwen:"qwen-turbo",deepseek:"deepseek-chat",siliconflow:"Qwen/Qwen2.5-72B-Instruct",volcano:"doubao-1.5-pro-32k"},Tt={openai:"text-embedding-3-small",siliconflow:"BAAI/bge-m3"},At={jina:"jina-reranker-v2-base-multilingual",cohere:"rerank-multilingual-v3.0",siliconflow:"BAAI/bge-reranker-v2-m3"},Lt=z(()=>v.value==="custom"),Rt=z(()=>k.value==="custom"),Bt=z(()=>Ie.value==="custom"),zt=z(()=>Te.value==="custom"),Ut=z(()=>`æ¯æ‰¹æ¬¡åˆ†æ ${xe.value||5} é¡µ`),Je=z(()=>ye.value==="custom"),Mt=z(()=>ye.value==="custom"?"å®Œå…¨è‡ªå®šä¹‰å±‚çº§æ¶æ„ï¼Œçµæ´»é…ç½®åˆ†ææµç¨‹":je[ye.value]?.description||"æ ¹æ®æ¼«ç”»ç±»å‹é€‰æ‹©åˆé€‚çš„åˆ†ææ¶æ„"),at=z(()=>{if(ye.value==="custom")return de.value;const y=je[ye.value];return y?y.layers:je.standard.layers});function He(y){n.value=y,f.value="",m.value=""}function Ge(){l("close")}function Et(){const y=de.value.length-1;de.value.splice(y,0,{name:`æ±‡æ€»å±‚${y}`,units:5,align:!1})}function ot(y){y>0&&y<de.value.length-1&&de.value.splice(y,1)}function rt(y,r,b){de.value[y]&&(de.value[y][r]=b,y===0&&r==="units"&&(xe.value=b))}function it(){de.value.length>0&&de.value[0]&&(de.value[0].units=xe.value)}function Vt(y){return y>0&&y<de.value.length-1&&de.value.length>2}function qt(y){return y>0&&y<de.value.length-1}function he(y){return y<de.value.length-1}function Kt(y){return y===0?"æ¯æ‰¹åˆ†æçš„é¡µæ•°":"æ¯ç»„åŒ…å«å•å…ƒæ•°ï¼ˆ0=å…¨éƒ¨æ±‡æ€»ï¼‰"}function Ot(){const y=v.value;if(s.config.vlm.provider!==y&&(s.config.vlm.apiKey=h.value,s.config.vlm.model=C.value,s.config.vlm.baseUrl=A.value,s.config.vlm.rpmLimit=E.value,s.config.vlm.temperature=q.value,s.config.vlm.forceJson=te.value,s.config.vlm.useStream=I.value,s.config.vlm.imageMaxSize=g.value),s.setVlmProvider(y),h.value=s.config.vlm.apiKey,C.value=s.config.vlm.model,A.value=s.config.vlm.baseUrl,E.value=s.config.vlm.rpmLimit,q.value=s.config.vlm.temperature,te.value=s.config.vlm.forceJson,I.value=s.config.vlm.useStream,g.value=s.config.vlm.imageMaxSize,!C.value){const b=Pt[y];b&&(C.value=b)}}function Dt(){const y=k.value;if(s.config.llm.provider!==y&&(s.config.llm.apiKey=U.value,s.config.llm.model=Y.value,s.config.llm.baseUrl=ce.value,s.config.llm.useStream=Pe.value),s.setLlmProvider(y),U.value=s.config.llm.apiKey,Y.value=s.config.llm.model,ce.value=s.config.llm.baseUrl,Pe.value=s.config.llm.useStream,!Y.value){const b=It[y];b&&(Y.value=b)}}function Nt(){const y=Ie.value;if(s.config.embedding.provider!==y&&(s.config.embedding.apiKey=Ue.value,s.config.embedding.model=_e.value,s.config.embedding.baseUrl=Me.value,s.config.embedding.rpmLimit=Fe.value),s.setEmbeddingProvider(y),Ue.value=s.config.embedding.apiKey,_e.value=s.config.embedding.model,Me.value=s.config.embedding.baseUrl,Fe.value=s.config.embedding.rpmLimit,!_e.value){const b=Tt[y];b&&(_e.value=b)}}function jt(){const y=Te.value;if(s.config.reranker.provider!==y&&(s.config.reranker.apiKey=Ee.value,s.config.reranker.model=$e.value,s.config.reranker.baseUrl=Ve.value,s.config.reranker.topK=Qe.value),s.setRerankerProvider(y),Ee.value=s.config.reranker.apiKey,$e.value=s.config.reranker.model,Ve.value=s.config.reranker.baseUrl,Qe.value=s.config.reranker.topK,!$e.value){const b=At[y];b&&($e.value=b)}}function D(y,r){f.value=y,m.value=r,setTimeout(()=>{f.value="",m.value=""},3e3)}async function d(){if(!o.value){o.value=!0,f.value="";try{const y=await pn({provider:v.value,api_key:h.value,model:C.value,base_url:A.value||void 0});y.success?D("VLM è¿æ¥æˆåŠŸ","success"):D("è¿æ¥å¤±è´¥: "+(y.error||"æœªçŸ¥é”™è¯¯"),"error")}catch(y){D("æµ‹è¯•å¤±è´¥: "+(y instanceof Error?y.message:"ç½‘ç»œé”™è¯¯"),"error")}finally{o.value=!1}}}async function x(){if(!o.value){o.value=!0,f.value="";try{const y=await vn({provider:Ie.value,api_key:Ue.value,model:_e.value,base_url:Me.value||void 0});y.success?D("Embedding è¿æ¥æˆåŠŸ","success"):D("è¿æ¥å¤±è´¥: "+(y.error||"æœªçŸ¥é”™è¯¯"),"error")}catch(y){D("æµ‹è¯•å¤±è´¥: "+(y instanceof Error?y.message:"ç½‘ç»œé”™è¯¯"),"error")}finally{o.value=!1}}}async function F(){if(!o.value){o.value=!0,f.value="";try{const y=await mn({provider:Te.value,api_key:Ee.value,model:$e.value,base_url:Ve.value||void 0});y.success?D("Reranker è¿æ¥æˆåŠŸ","success"):D("è¿æ¥å¤±è´¥: "+(y.error||"æœªçŸ¥é”™è¯¯"),"error")}catch(y){D("æµ‹è¯•å¤±è´¥: "+(y instanceof Error?y.message:"ç½‘ç»œé”™è¯¯"),"error")}finally{o.value=!1}}}async function ke(){if(!P.value){P.value=!0,f.value="";try{const y=await gn({provider:k.value,api_key:U.value,model:Y.value,base_url:ce.value||void 0});y.success?D("LLM è¿æ¥æˆåŠŸ","success"):D("è¿æ¥å¤±è´¥: "+(y.error||"æœªçŸ¥é”™è¯¯"),"error")}catch(y){D("æµ‹è¯•å¤±è´¥: "+(y instanceof Error?y.message:"ç½‘ç»œé”™è¯¯"),"error")}finally{P.value=!1}}}const me=["siliconflow","deepseek","volcano","gemini","qwen","openai","custom"];async function se(y){let r,b,Q,ie,Ze,Ce;switch(y){case"vlm":r=v.value,b=h.value,Q=A.value,ie=G=>{N.value=G},Ze=G=>{w.value=G},Ce=G=>{M.value=G};break;case"llm":r=k.value,b=U.value,Q=ce.value,ie=G=>{j.value=G},Ze=G=>{S.value=G},Ce=G=>{L.value=G};break;case"embedding":r=Ie.value,b=Ue.value,Q=Me.value,ie=G=>{J.value=G},Ze=G=>{B.value=G},Ce=G=>{V.value=G};break;case"reranker":r=Te.value,b=Ee.value,Q=Ve.value,ie=G=>{u.value=G},Ze=G=>{R.value=G},Ce=G=>{O.value=G};break}if(!b){D("è¯·å…ˆå¡«å†™ API Key","error");return}if(!me.includes(r)){D(`${r} ä¸æ”¯æŒè‡ªåŠ¨è·å–æ¨¡å‹åˆ—è¡¨`,"error");return}if(r==="custom"&&!Q){D("è‡ªå®šä¹‰æœåŠ¡éœ€è¦å…ˆå¡«å†™ Base URL","error");return}const Os=r==="custom"?"custom_openai":r;ie(!0);try{const G=await Ws(Os,b,Q||void 0);G.success&&G.models&&G.models.length>0?(Ze(G.models),Ce(!0),D(`è·å–åˆ° ${G.models.length} ä¸ªæ¨¡å‹`,"success")):(D(G.message||"æœªè·å–åˆ°æ¨¡å‹åˆ—è¡¨","error"),Ce(!1))}catch(G){D("è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥: "+(G instanceof Error?G.message:"ç½‘ç»œé”™è¯¯"),"error"),Ce(!1)}finally{ie(!1)}}function qe(y,r){if(r)switch(y){case"vlm":C.value=r;break;case"llm":Y.value=r;break;case"embedding":_e.value=r;break;case"reranker":$e.value=r;break}}async function Ae(){lt.value=!0;try{const y=await hn();y.success&&y.library&&(be.value=y.library)}catch(y){console.error("åŠ è½½æç¤ºè¯åº“å¤±è´¥:",y),be.value=[]}finally{lt.value=!1}}function ut(){const y=ve.value;re.value=pe.value[y]||Ye[y]||""}function Le(){if(confirm("ç¡®å®šè¦é‡ç½®ä¸ºé»˜è®¤æç¤ºè¯å—ï¼Ÿå½“å‰ç¼–è¾‘çš„å†…å®¹å°†ä¸¢å¤±ã€‚")){const y=ve.value;re.value=Ye[y]||"",delete pe.value[y],D("å·²é‡ç½®ä¸ºé»˜è®¤æç¤ºè¯","success")}}async function ne(){try{await navigator.clipboard.writeText(re.value),D("å·²å¤åˆ¶åˆ°å‰ªè´´æ¿","success")}catch{D("å¤åˆ¶å¤±è´¥","error")}}async function Bs(){const y=re.value.trim();if(!y){D("æç¤ºè¯å†…å®¹ä¸èƒ½ä¸ºç©º","error");return}const r=prompt("è¯·è¾“å…¥æç¤ºè¯åç§°ï¼š");if(!r||!r.trim())return;const b={id:Date.now().toString(),name:r.trim(),type:ve.value,content:y,created_at:new Date().toISOString()};try{const Q=await fn(b);Q.success?(be.value.push(b),D("æç¤ºè¯å·²ä¿å­˜åˆ°åº“","success")):D("ä¿å­˜å¤±è´¥: "+(Q.error||"æœªçŸ¥é”™è¯¯"),"error")}catch{D("ä¿å­˜å¤±è´¥","error")}}function zs(y){ve.value=y.type,re.value=y.content,pe.value[y.type]=y.content,D(`å·²åŠ è½½æç¤ºè¯: ${y.name}`,"success")}async function Us(y){if(confirm("ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæç¤ºè¯å—ï¼Ÿ"))try{(await bn(y)).success?(be.value=be.value.filter(b=>b.id!==y),D("æç¤ºè¯å·²åˆ é™¤","success")):D("åˆ é™¤å¤±è´¥","error")}catch{D("åˆ é™¤å¤±è´¥","error")}}function Ms(){re.value&&(pe.value[ve.value]=re.value);const y={version:"1.0",exported_at:new Date().toISOString(),prompts:pe.value,library:be.value},r=new Blob([JSON.stringify(y,null,2)],{type:"application/json"}),b=URL.createObjectURL(r),Q=document.createElement("a");Q.href=b,Q.download=`manga-insight-prompts-${new Date().toISOString().slice(0,10)}.json`,Q.click(),URL.revokeObjectURL(b),D("æç¤ºè¯å·²å¯¼å‡º","success")}function Es(){const y=document.getElementById("promptsFileInput");y&&y.click()}async function Vs(y){const r=y.target,b=r.files?.[0];if(b){try{const Q=await b.text(),ie=JSON.parse(Q);if(ie.prompts&&(pe.value={...pe.value,...ie.prompts}),ie.library&&Array.isArray(ie.library)){const Ze=new Set(be.value.map(Ce=>Ce.id));for(const Ce of ie.library)Ze.has(Ce.id)||be.value.push(Ce);await kn(be.value)}ut(),D("æç¤ºè¯å¯¼å…¥æˆåŠŸ","success")}catch(Q){console.error("å¯¼å…¥å¤±è´¥:",Q),D("å¯¼å…¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼","error")}r.value=""}}async function qs(){if(!i.value){i.value=!0;try{s.updateVlmConfig({provider:v.value,apiKey:h.value,model:C.value,baseUrl:v.value==="custom"?A.value:"",rpmLimit:E.value,temperature:q.value,forceJson:te.value,useStream:I.value,imageMaxSize:g.value}),s.updateLlmConfig({useSameAsVlm:!1,provider:k.value,apiKey:U.value,model:Y.value,baseUrl:k.value==="custom"?ce.value:"",useStream:Pe.value}),s.updateEmbeddingConfig({provider:Ie.value,apiKey:Ue.value,model:_e.value,baseUrl:Ie.value==="custom"?Me.value:"",rpmLimit:Fe.value}),s.updateRerankerConfig({provider:Te.value,apiKey:Ee.value,model:$e.value,baseUrl:Te.value==="custom"?Ve.value:"",topK:Qe.value}),s.updateBatchConfig({pagesPerBatch:xe.value,contextBatchCount:Ne.value,architecturePreset:ye.value}),re.value&&(pe.value[ve.value]=re.value),s.updatePrompts(pe.value);const y=s.getConfigForApi(),r=await dn(y);r.success?(D("è®¾ç½®å·²ä¿å­˜","success"),setTimeout(()=>{Ge()},500)):D("ä¿å­˜å¤±è´¥: "+(r.error||"æœªçŸ¥é”™è¯¯"),"error")}catch(y){D("ä¿å­˜å¤±è´¥: "+(y instanceof Error?y.message:"ç½‘ç»œé”™è¯¯"),"error")}finally{i.value=!1}}}async function Ks(){try{s.loadConfigFromStorage();const y=await cn();y.success&&y.config&&s.setConfigFromApi(y.config),ls()}catch(y){console.error("åŠ è½½é…ç½®å¤±è´¥:",y),ls()}}function ls(){if(v.value=s.config.vlm.provider,h.value=s.config.vlm.apiKey,C.value=s.config.vlm.model,A.value=s.config.vlm.baseUrl,E.value=s.config.vlm.rpmLimit,q.value=s.config.vlm.temperature,te.value=s.config.vlm.forceJson,I.value=s.config.vlm.useStream,g.value=s.config.vlm.imageMaxSize,k.value=s.config.llm.provider,U.value=s.config.llm.apiKey,Y.value=s.config.llm.model,ce.value=s.config.llm.baseUrl,Pe.value=s.config.llm.useStream,Ie.value=s.config.embedding.provider,Ue.value=s.config.embedding.apiKey,_e.value=s.config.embedding.model,Me.value=s.config.embedding.baseUrl,Fe.value=s.config.embedding.rpmLimit,Te.value=s.config.reranker.provider,Ee.value=s.config.reranker.apiKey,$e.value=s.config.reranker.model,Ve.value=s.config.reranker.baseUrl,Qe.value=s.config.reranker.topK,xe.value=s.config.batch.pagesPerBatch,Ne.value=s.config.batch.contextBatchCount,ye.value=s.config.batch.architecturePreset,s.config.prompts){pe.value={...s.config.prompts};const y=ve.value;re.value=pe.value[y]||Ye[y]||""}else pe.value={},re.value=Ye[ve.value]||""}return st(ve,(y,r)=>{r&&re.value&&(pe.value[r]=re.value),y&&(re.value=pe.value[y]||Ye[y]||"")}),nt(async()=>{await Ks(),await Ae(),re.value=pe.value[ve.value]||Ye[ve.value]||""}),(y,r)=>(c(),et(Zs,{title:"æ¼«ç”»åˆ†æè®¾ç½®",size:"large",customClass:"insight-settings-modal",onClose:Ge},{footer:ft(()=>[e("button",{class:"btn btn-secondary",onClick:Ge},"å–æ¶ˆ"),e("button",{class:"btn btn-primary",disabled:i.value,onClick:qs},$(i.value?"ä¿å­˜ä¸­...":"ä¿å­˜"),9,Lc)]),default:ft(()=>[e("div",Qi,[e("button",{class:H(["settings-tab",{active:n.value==="vlm"}]),onClick:r[0]||(r[0]=b=>He("vlm"))}," ğŸ–¼ï¸ VLM å¤šæ¨¡æ€ ",2),e("button",{class:H(["settings-tab",{active:n.value==="llm"}]),onClick:r[1]||(r[1]=b=>He("llm"))}," ğŸ’¬ LLM å¯¹è¯ ",2),e("button",{class:H(["settings-tab",{active:n.value==="batch"}]),onClick:r[2]||(r[2]=b=>He("batch"))}," ğŸ“Š æ‰¹é‡åˆ†æ ",2),e("button",{class:H(["settings-tab",{active:n.value==="embedding"}]),onClick:r[3]||(r[3]=b=>He("embedding"))}," ğŸ”¢ å‘é‡æ¨¡å‹ ",2),e("button",{class:H(["settings-tab",{active:n.value==="reranker"}]),onClick:r[4]||(r[4]=b=>He("reranker"))}," ğŸ”„ é‡æ’åº ",2),e("button",{class:H(["settings-tab",{active:n.value==="prompts"}]),onClick:r[5]||(r[5]=b=>He("prompts"))}," ğŸ“ æç¤ºè¯ ",2)]),f.value?(c(),p("div",{key:0,class:H(["test-message",m.value])},$(f.value),3)):T("",!0),n.value==="vlm"?(c(),p("div",Hi,[r[58]||(r[58]=e("p",{class:"settings-hint"},"VLMï¼ˆè§†è§‰è¯­è¨€æ¨¡å‹ï¼‰ç”¨äºåˆ†ææ¼«ç”»å›¾ç‰‡å†…å®¹ï¼Œæå–å¯¹è¯å’Œåœºæ™¯ä¿¡æ¯ã€‚",-1)),e("div",Ji,[r[43]||(r[43]=e("label",null,"æœåŠ¡å•†",-1)),ue(Se,{modelValue:v.value,"onUpdate:modelValue":r[6]||(r[6]=b=>v.value=b),options:gt,onChange:Ot},null,8,["modelValue"])]),e("div",Gi,[r[44]||(r[44]=e("label",null,"API Key",-1)),K(e("input",{"onUpdate:modelValue":r[7]||(r[7]=b=>h.value=b),type:"password",placeholder:"è¾“å…¥ API Key"},null,512),[[X,h.value]])]),e("div",Zi,[r[46]||(r[46]=e("label",null,"æ¨¡å‹",-1)),e("div",Wi,[K(e("input",{"onUpdate:modelValue":r[8]||(r[8]=b=>C.value=b),type:"text",placeholder:"ä¾‹å¦‚: gemini-2.0-flash"},null,512),[[X,C.value]]),e("button",{class:"btn btn-secondary btn-sm fetch-btn",disabled:N.value,onClick:r[9]||(r[9]=b=>se("vlm"))},$(N.value?"è·å–ä¸­...":"ğŸ” è·å–æ¨¡å‹"),9,Xi)]),M.value&&w.value.length>0?(c(),p("div",Yi,[e("select",{class:"model-select",value:C.value,onChange:r[10]||(r[10]=b=>qe("vlm",b.target.value))},[r[45]||(r[45]=e("option",{value:""},"-- é€‰æ‹©æ¨¡å‹ --",-1)),(c(!0),p(Z,null,le(w.value,b=>(c(),p("option",{key:b.id,value:b.id},$(b.name||b.id),9,tu))),128))],40,eu),e("span",su,"å…± "+$(w.value.length)+" ä¸ªæ¨¡å‹",1)])):T("",!0)]),Lt.value?(c(),p("div",nu,[r[47]||(r[47]=e("label",null,"Base URL",-1)),K(e("input",{"onUpdate:modelValue":r[11]||(r[11]=b=>A.value=b),type:"text",placeholder:"è‡ªå®šä¹‰ API åœ°å€"},null,512),[[X,A.value]])])):T("",!0),e("div",lu,[e("div",au,[r[48]||(r[48]=e("label",null,"RPM é™åˆ¶",-1)),K(e("input",{"onUpdate:modelValue":r[12]||(r[12]=b=>E.value=b),type:"number",min:"1",max:"100"},null,512),[[X,E.value,void 0,{number:!0}]]),r[49]||(r[49]=e("p",{class:"form-hint"},"æ¯åˆ†é’Ÿæœ€å¤§è¯·æ±‚æ•°",-1))]),e("div",ou,[r[50]||(r[50]=e("label",null,"æ¸©åº¦",-1)),K(e("input",{"onUpdate:modelValue":r[13]||(r[13]=b=>q.value=b),type:"number",min:"0",max:"1",step:"0.1"},null,512),[[X,q.value,void 0,{number:!0}]]),r[51]||(r[51]=e("p",{class:"form-hint"},"0-1ï¼Œè¶Šä½è¶Šç¡®å®š",-1))])]),e("div",ru,[e("label",iu,[K(e("input",{"onUpdate:modelValue":r[14]||(r[14]=b=>te.value=b),type:"checkbox"},null,512),[[tt,te.value]]),r[52]||(r[52]=e("span",null,"å¼ºåˆ¶ JSON è¾“å‡º",-1))]),r[53]||(r[53]=e("p",{class:"form-hint"},"å¯¹ OpenAI å…¼å®¹ API å¯ç”¨ response_format: json_object",-1))]),e("div",uu,[e("label",cu,[K(e("input",{"onUpdate:modelValue":r[15]||(r[15]=b=>I.value=b),type:"checkbox"},null,512),[[tt,I.value]]),r[54]||(r[54]=e("span",null,"ä½¿ç”¨æµå¼è¯·æ±‚",-1))]),r[55]||(r[55]=e("p",{class:"form-hint"},"æµå¼è¯·æ±‚å¯é¿å…é•¿æ—¶é—´ç­‰å¾…å¯¼è‡´çš„è¶…æ—¶é—®é¢˜",-1))]),e("div",du,[r[56]||(r[56]=e("label",null,"å›¾ç‰‡å‹ç¼©ï¼ˆæœ€å¤§è¾¹é•¿ï¼‰",-1)),K(e("input",{"onUpdate:modelValue":r[16]||(r[16]=b=>g.value=b),type:"number",min:"0",max:"4096",step:"128",placeholder:"0 è¡¨ç¤ºä¸å‹ç¼©"},null,512),[[X,g.value,void 0,{number:!0}]]),r[57]||(r[57]=e("p",{class:"form-hint"},"å‘é€å‰å°†å›¾ç‰‡ç­‰æ¯”ä¾‹ç¼©æ”¾åˆ°æŒ‡å®šæœ€å¤§è¾¹é•¿ï¼ˆåƒç´ ï¼‰ï¼Œ0 è¡¨ç¤ºä¸å‹ç¼©",-1))]),e("button",{class:"btn btn-secondary",disabled:o.value,onClick:d},$(o.value?"æµ‹è¯•ä¸­...":"æµ‹è¯•è¿æ¥"),9,pu)])):T("",!0),n.value==="llm"?(c(),p("div",vu,[r[65]||(r[65]=e("p",{class:"settings-hint"},"LLMï¼ˆå¯¹è¯æ¨¡å‹ï¼‰ç”¨äºç”Ÿæˆæ•…äº‹æ¦‚è¦ã€æ™ºèƒ½é—®ç­”ç­‰æ–‡æœ¬ç”Ÿæˆä»»åŠ¡ã€‚",-1)),e("div",mu,[r[59]||(r[59]=e("label",null,"æœåŠ¡å•†",-1)),ue(Se,{modelValue:k.value,"onUpdate:modelValue":r[17]||(r[17]=b=>k.value=b),options:gt,onChange:Dt},null,8,["modelValue"])]),e("div",gu,[r[60]||(r[60]=e("label",null,"API Key",-1)),K(e("input",{"onUpdate:modelValue":r[18]||(r[18]=b=>U.value=b),type:"password",placeholder:"è¾“å…¥ API Key"},null,512),[[X,U.value]])]),e("div",hu,[r[62]||(r[62]=e("label",null,"æ¨¡å‹",-1)),e("div",fu,[K(e("input",{"onUpdate:modelValue":r[19]||(r[19]=b=>Y.value=b),type:"text",placeholder:"ä¾‹å¦‚: gpt-4o-mini"},null,512),[[X,Y.value]]),e("button",{class:"btn btn-secondary btn-sm fetch-btn",disabled:j.value,onClick:r[20]||(r[20]=b=>se("llm"))},$(j.value?"è·å–ä¸­...":"ğŸ” è·å–æ¨¡å‹"),9,bu)]),L.value&&S.value.length>0?(c(),p("div",ku,[e("select",{class:"model-select",value:Y.value,onChange:r[21]||(r[21]=b=>qe("llm",b.target.value))},[r[61]||(r[61]=e("option",{value:""},"-- é€‰æ‹©æ¨¡å‹ --",-1)),(c(!0),p(Z,null,le(S.value,b=>(c(),p("option",{key:b.id,value:b.id},$(b.name||b.id),9,_u))),128))],40,yu),e("span",$u,"å…± "+$(S.value.length)+" ä¸ªæ¨¡å‹",1)])):T("",!0)]),Rt.value?(c(),p("div",wu,[r[63]||(r[63]=e("label",null,"Base URL",-1)),K(e("input",{"onUpdate:modelValue":r[22]||(r[22]=b=>ce.value=b),type:"text",placeholder:"è‡ªå®šä¹‰ API åœ°å€"},null,512),[[X,ce.value]])])):T("",!0),e("div",xu,[e("label",Cu,[K(e("input",{"onUpdate:modelValue":r[23]||(r[23]=b=>Pe.value=b),type:"checkbox"},null,512),[[tt,Pe.value]]),r[64]||(r[64]=e("span",null,"ä½¿ç”¨æµå¼è¯·æ±‚",-1))])]),e("button",{class:"btn btn-secondary",disabled:P.value,onClick:ke},$(P.value?"æµ‹è¯•ä¸­...":"æµ‹è¯•è¿æ¥"),9,Su)])):T("",!0),n.value==="batch"?(c(),p("div",Pu,[r[76]||(r[76]=e("p",{class:"settings-hint"},"é…ç½®æ‰¹é‡åˆ†æçš„å‚æ•°ï¼Œå½±å“åˆ†æé€Ÿåº¦å’Œè´¨é‡ã€‚",-1)),e("div",Iu,[r[66]||(r[66]=e("label",null,"æ¯æ‰¹æ¬¡åˆ†æé¡µæ•°",-1)),K(e("input",{"onUpdate:modelValue":r[24]||(r[24]=b=>xe.value=b),type:"number",min:"1",max:"10",onChange:it},null,544),[[X,xe.value,void 0,{number:!0}]]),e("p",Tu,"æ¯æ¬¡å‘é€ç»™ VLM çš„å›¾ç‰‡æ•°é‡ï¼Œå»ºè®® 3-5 å¼ ã€‚"+$(Ut.value),1)]),e("div",Au,[r[67]||(r[67]=e("label",null,"ä¸Šæ–‡å‚è€ƒæ‰¹æ¬¡æ•°",-1)),K(e("input",{"onUpdate:modelValue":r[25]||(r[25]=b=>Ne.value=b),type:"number",min:"0",max:"5"},null,512),[[X,Ne.value,void 0,{number:!0}]]),r[68]||(r[68]=e("p",{class:"form-hint"},"æ¯æ‰¹åˆ†ææ—¶å‚è€ƒå‰å‡ æ‰¹çš„ç»“æœä½œä¸ºä¸Šä¸‹æ–‡ï¼Œ0 è¡¨ç¤ºä¸å‚è€ƒ",-1))]),e("div",Lu,[r[69]||(r[69]=e("label",null,"åˆ†ææ¶æ„",-1)),ue(Se,{modelValue:ye.value,"onUpdate:modelValue":r[26]||(r[26]=b=>ye.value=b),options:Ct},null,8,["modelValue"]),e("p",Ru,$(Mt.value),1)]),Je.value?(c(),p("div",Bu,[r[71]||(r[71]=e("label",{style:{display:"block","margin-bottom":"8px","font-weight":"500","font-size":"14px"}},"è‡ªå®šä¹‰å±‚çº§",-1)),e("div",zu,[(c(!0),p(Z,null,le(de.value,(b,Q)=>(c(),p("div",{key:Q,style:{display:"flex","flex-direction":"row",gap:"8px","align-items":"center","margin-bottom":"8px",padding:"12px",background:"#f5f5f5","border-radius":"8px",border:"1px solid #e0e0e0"}},[e("span",Uu,"ç¬¬"+$(Q+1)+"å±‚",1),e("input",{type:"text",value:b.name,disabled:!qt(Q),placeholder:"å±‚çº§åç§°",style:{flex:"1",padding:"8px 12px",border:"1px solid #e0e0e0","border-radius":"6px","font-size":"14px"},onChange:ie=>rt(Q,"name",ie.target.value)},null,40,Mu),e("input",{type:"number",value:b.units,disabled:!he(Q),title:Kt(Q),min:"0",max:"20",style:{width:"70px",padding:"8px 12px",border:"1px solid #e0e0e0","border-radius":"6px","font-size":"14px"},onChange:ie=>rt(Q,"units",parseInt(ie.target.value)||0)},null,40,Eu),e("label",Vu,[e("input",{type:"checkbox",checked:b.align,style:{width:"16px",height:"16px"},onChange:ie=>rt(Q,"align",ie.target.checked)},null,40,qu),r[70]||(r[70]=e("span",{style:{"line-height":"1.2"}},[oe("ç« èŠ‚"),e("br"),oe("å¯¹é½")],-1))]),Vt(Q)?(c(),p("button",{key:0,type:"button",style:{padding:"6px 12px",background:"#ef4444",color:"white",border:"none","border-radius":"6px",cursor:"pointer","font-size":"13px","font-weight":"500"},onClick:ie=>ot(Q)}," åˆ é™¤ ",8,Ku)):T("",!0)]))),128))]),e("button",{type:"button",class:"btn btn-sm",style:{"margin-top":"4px",border:"1px solid #e0e0e0"},onClick:Et}," + æ·»åŠ å±‚çº§ "),r[72]||(r[72]=e("p",{class:"form-hint"},"ç¬¬ä¸€å±‚å›ºå®šä¸ºæ‰¹é‡åˆ†æï¼Œæœ€åä¸€å±‚å›ºå®šä¸ºå…¨ä¹¦æ€»ç»“ã€‚ä¸­é—´å¯æ·»åŠ ä»»æ„æ±‡æ€»å±‚çº§ã€‚",-1))])):T("",!0),e("div",Ou,[r[73]||(r[73]=e("h4",null,"å½“å‰æ¶æ„é¢„è§ˆ",-1)),e("ul",Du,[(c(!0),p(Z,null,le(at.value,(b,Q)=>(c(),p("li",{key:Q},[e("strong",null,"ç¬¬"+$(Q+1)+"å±‚ - "+$(b.name),1),oe(" "+$(b.units>0?` - æ¯${b.units}ä¸ªå•å…ƒæ±‡æ€»`:" - æ±‡æ€»å…¨éƒ¨")+" ",1),b.align?(c(),p("span",Nu,"(æŒ‰ç« èŠ‚å¯¹é½)")):T("",!0)]))),128))])]),e("div",ju,[e("p",null,[r[74]||(r[74]=oe("å½“å‰é…ç½®ï¼šæ¯ ",-1)),e("strong",null,$(xe.value),1),r[75]||(r[75]=oe(" é¡µä¸€æ‰¹",-1))])])])):T("",!0),n.value==="embedding"?(c(),p("div",Fu,[r[84]||(r[84]=e("p",{class:"settings-hint"},"Embeddingï¼ˆå‘é‡åŒ–æ¨¡å‹ï¼‰ç”¨äºå°†æ–‡æœ¬è½¬æ¢ä¸ºå‘é‡ï¼Œæ”¯æŒè¯­ä¹‰æœç´¢å’Œé—®ç­”åŠŸèƒ½ã€‚",-1)),e("div",Qu,[r[77]||(r[77]=e("label",null,"æœåŠ¡å•†",-1)),ue(Se,{modelValue:Ie.value,"onUpdate:modelValue":r[27]||(r[27]=b=>Ie.value=b),options:wt,onChange:Nt},null,8,["modelValue"])]),e("div",Hu,[r[78]||(r[78]=e("label",null,"API Key",-1)),K(e("input",{"onUpdate:modelValue":r[28]||(r[28]=b=>Ue.value=b),type:"password",placeholder:"è¾“å…¥ API Key"},null,512),[[X,Ue.value]])]),e("div",Ju,[r[80]||(r[80]=e("label",null,"æ¨¡å‹",-1)),e("div",Gu,[K(e("input",{"onUpdate:modelValue":r[29]||(r[29]=b=>_e.value=b),type:"text",placeholder:"ä¾‹å¦‚: text-embedding-3-small"},null,512),[[X,_e.value]]),e("button",{class:"btn btn-secondary btn-sm fetch-btn",disabled:J.value,onClick:r[30]||(r[30]=b=>se("embedding"))},$(J.value?"è·å–ä¸­...":"ğŸ” è·å–æ¨¡å‹"),9,Zu)]),V.value&&B.value.length>0?(c(),p("div",Wu,[e("select",{class:"model-select",value:_e.value,onChange:r[31]||(r[31]=b=>qe("embedding",b.target.value))},[r[79]||(r[79]=e("option",{value:""},"-- é€‰æ‹©æ¨¡å‹ --",-1)),(c(!0),p(Z,null,le(B.value,b=>(c(),p("option",{key:b.id,value:b.id},$(b.name||b.id),9,Yu))),128))],40,Xu),e("span",ec,"å…± "+$(B.value.length)+" ä¸ªæ¨¡å‹",1)])):T("",!0)]),Bt.value?(c(),p("div",tc,[r[81]||(r[81]=e("label",null,"Base URL",-1)),K(e("input",{"onUpdate:modelValue":r[32]||(r[32]=b=>Me.value=b),type:"text",placeholder:"è‡ªå®šä¹‰ API åœ°å€"},null,512),[[X,Me.value]])])):T("",!0),e("div",sc,[r[82]||(r[82]=e("label",null,"RPM é™åˆ¶",-1)),K(e("input",{"onUpdate:modelValue":r[33]||(r[33]=b=>Fe.value=b),type:"number",min:"0",max:"1000"},null,512),[[X,Fe.value,void 0,{number:!0}]]),r[83]||(r[83]=e("p",{class:"form-hint"},"æ¯åˆ†é’Ÿæœ€å¤§è¯·æ±‚æ•°ï¼Œ0 è¡¨ç¤ºä¸é™åˆ¶",-1))]),e("button",{class:"btn btn-secondary",disabled:o.value,onClick:x},$(o.value?"æµ‹è¯•ä¸­...":"æµ‹è¯•è¿æ¥"),9,nc)])):T("",!0),n.value==="reranker"?(c(),p("div",lc,[r[92]||(r[92]=e("p",{class:"settings-hint"},"Rerankerï¼ˆé‡æ’åºæ¨¡å‹ï¼‰ç”¨äºå¯¹æœç´¢ç»“æœè¿›è¡Œé‡æ–°æ’åºï¼Œæé«˜é—®ç­”å‡†ç¡®æ€§ã€‚",-1)),e("div",ac,[r[85]||(r[85]=e("label",null,"æœåŠ¡å•†",-1)),ue(Se,{modelValue:Te.value,"onUpdate:modelValue":r[34]||(r[34]=b=>Te.value=b),options:xt,onChange:jt},null,8,["modelValue"])]),e("div",oc,[r[86]||(r[86]=e("label",null,"API Key",-1)),K(e("input",{"onUpdate:modelValue":r[35]||(r[35]=b=>Ee.value=b),type:"password",placeholder:"è¾“å…¥ API Key"},null,512),[[X,Ee.value]])]),e("div",rc,[r[88]||(r[88]=e("label",null,"æ¨¡å‹",-1)),e("div",ic,[K(e("input",{"onUpdate:modelValue":r[36]||(r[36]=b=>$e.value=b),type:"text",placeholder:"ä¾‹å¦‚: jina-reranker-v2-base-multilingual"},null,512),[[X,$e.value]]),e("button",{class:"btn btn-secondary btn-sm fetch-btn",disabled:u.value,onClick:r[37]||(r[37]=b=>se("reranker"))},$(u.value?"è·å–ä¸­...":"ğŸ” è·å–æ¨¡å‹"),9,uc)]),O.value&&R.value.length>0?(c(),p("div",cc,[e("select",{class:"model-select",value:$e.value,onChange:r[38]||(r[38]=b=>qe("reranker",b.target.value))},[r[87]||(r[87]=e("option",{value:""},"-- é€‰æ‹©æ¨¡å‹ --",-1)),(c(!0),p(Z,null,le(R.value,b=>(c(),p("option",{key:b.id,value:b.id},$(b.name||b.id),9,pc))),128))],40,dc),e("span",vc,"å…± "+$(R.value.length)+" ä¸ªæ¨¡å‹",1)])):T("",!0)]),zt.value?(c(),p("div",mc,[r[89]||(r[89]=e("label",null,"Base URL",-1)),K(e("input",{"onUpdate:modelValue":r[39]||(r[39]=b=>Ve.value=b),type:"text",placeholder:"è‡ªå®šä¹‰ API åœ°å€"},null,512),[[X,Ve.value]])])):T("",!0),e("div",gc,[r[90]||(r[90]=e("label",null,"Top K",-1)),K(e("input",{"onUpdate:modelValue":r[40]||(r[40]=b=>Qe.value=b),type:"number",min:"1",max:"20"},null,512),[[X,Qe.value,void 0,{number:!0}]]),r[91]||(r[91]=e("p",{class:"form-hint"},"é‡æ’åºåè¿”å›çš„ç»“æœæ•°é‡",-1))]),e("button",{class:"btn btn-secondary",disabled:o.value,onClick:F},$(o.value?"æµ‹è¯•ä¸­...":"æµ‹è¯•è¿æ¥"),9,hc)])):T("",!0),n.value==="prompts"?(c(),p("div",fc,[r[96]||(r[96]=e("p",{class:"settings-hint"},"è‡ªå®šä¹‰åˆ†æè¿‡ç¨‹ä¸­ä½¿ç”¨çš„æç¤ºè¯æ¨¡æ¿ã€‚",-1)),e("div",bc,[r[93]||(r[93]=e("label",null,"æç¤ºè¯ç±»å‹",-1)),ue(Se,{modelValue:ve.value,"onUpdate:modelValue":r[41]||(r[41]=b=>ve.value=b),options:St,onChange:ut},null,8,["modelValue"]),e("p",kc,$(os[ve.value]?.hint),1)]),e("div",yc,[r[94]||(r[94]=e("label",null,"æç¤ºè¯å†…å®¹",-1)),K(e("textarea",{"onUpdate:modelValue":r[42]||(r[42]=b=>re.value=b),class:"prompt-editor",rows:"12",placeholder:"è¾“å…¥æç¤ºè¯å†…å®¹..."},null,512),[[X,re.value]])]),e("div",{class:"prompt-actions-bar"},[e("button",{class:"btn btn-secondary btn-sm",onClick:Le,title:"é‡ç½®ä¸ºé»˜è®¤"}," ğŸ”„ é‡ç½® "),e("button",{class:"btn btn-secondary btn-sm",onClick:ne,title:"å¤åˆ¶åˆ°å‰ªè´´æ¿"}," ğŸ“‹ å¤åˆ¶ "),e("button",{class:"btn btn-primary btn-sm",onClick:Bs,title:"ä¿å­˜åˆ°åº“"}," ğŸ’¾ ä¿å­˜åˆ°åº“ ")]),r[97]||(r[97]=e("hr",{class:"section-divider"},null,-1)),e("div",_c,[e("div",$c,[r[95]||(r[95]=e("h4",null,"ğŸ“š æç¤ºè¯åº“",-1)),e("div",wc,[e("button",{class:"btn btn-secondary btn-sm",onClick:Ms,title:"å¯¼å‡ºæ‰€æœ‰æç¤ºè¯"}," ğŸ“¤ å¯¼å‡º "),e("button",{class:"btn btn-secondary btn-sm",onClick:Es,title:"å¯¼å…¥æç¤ºè¯"}," ğŸ“¥ å¯¼å…¥ "),e("input",{id:"promptsFileInput",type:"file",accept:".json",style:{display:"none"},onChange:Vs},null,32)])]),e("div",xc,[lt.value?(c(),p("div",Cc,"åŠ è½½ä¸­...")):be.value.length===0?(c(),p("div",Sc," æš‚æ— ä¿å­˜çš„æç¤ºè¯ ")):(c(!0),p(Z,{key:2},le(be.value,b=>(c(),p("div",{key:b.id,class:"saved-prompt-item",onClick:Q=>zs(b)},[e("span",Ic,$(b.name),1),e("span",Tc,$(os[b.type]?.label||b.type),1),e("button",{class:"btn-icon-sm",onClick:we(Q=>Us(b.id),["stop"]),title:"åˆ é™¤"}," ğŸ—‘ï¸ ",8,Ac)],8,Pc))),128))])])])):T("",!0)]),_:1}))}}),Bc={class:"modal chapter-select-modal show"},zc={class:"modal-content"},Uc={class:"modal-body"},Mc={class:"chapters-list"},Ec=["onClick"],Vc={class:"chapter-info"},qc={class:"chapter-title"},Kc={key:0,class:"chapter-pages"},Oc={key:0,class:"check-icon"},Dc={class:"modal-footer"},Nc=["disabled"],jc=ze({__name:"ChapterSelectModal",props:{chapters:{}},emits:["close","select"],setup(a,{emit:t}){const l=t,s=_("");function n(f){s.value=f}function i(){s.value&&l("select",s.value)}function o(){l("close")}return(f,m)=>(c(),p("div",Bc,[e("div",{class:"modal-overlay",onClick:o}),e("div",zc,[e("div",{class:"modal-header"},[m[0]||(m[0]=e("h2",null,"ğŸ“– é€‰æ‹©ç« èŠ‚",-1)),e("button",{class:"modal-close",onClick:o},"Ã—")]),e("div",Uc,[m[1]||(m[1]=e("p",{class:"hint-text"},"è¯·é€‰æ‹©è¦ç¿»è¯‘çš„ç« èŠ‚ï¼š",-1)),e("div",Mc,[(c(!0),p(Z,null,le(a.chapters,w=>(c(),p("div",{key:w.id,class:H(["chapter-item",{selected:s.value===w.id}]),onClick:S=>n(w.id)},[e("div",Vc,[e("span",qc,$(w.title),1),w.startPage&&w.endPage?(c(),p("span",Kc," ç¬¬ "+$(w.startPage)+"-"+$(w.endPage)+" é¡µ ",1)):T("",!0)]),s.value===w.id?(c(),p("span",Oc,"âœ“")):T("",!0)],10,Ec))),128))])]),e("div",Dc,[e("button",{class:"btn btn-secondary",onClick:o},"å–æ¶ˆ"),e("button",{class:"btn btn-primary",disabled:!s.value,onClick:i}," ç¡®å®š ",8,Nc)])])]))}}),Fc=Ke(jc,[["__scopeId","data-v-ecb7f46b"]]),Qc={class:"insight-page"},Hc={class:"app-header"},Jc={class:"header-content"},Gc={class:"logo-container"},Zc={class:"header-links"},Wc={class:"insight-main"},Xc={class:"sidebar-section book-info-section"},Yc={class:"book-cover-wrapper"},ed=["src"],td={key:1,class:"book-cover-placeholder"},sd=["title"],nd={class:"book-meta"},ld={class:"meta-item"},ad={id:"totalPages"},od={class:"meta-item"},rd={id:"analyzedPages"},id={class:"insight-content"},ud={key:0,class:"select-book-prompt"},cd={key:1,class:"content-tabs"},dd={class:"tabs-wrapper"},pd={class:"tab-content"},vd={class:"tab-content"},md={class:"tab-content"},gd=ze({__name:"InsightView",setup(a){const t=js(),l=Hs(),s=De(),n=ms(),i=Gs(),o=_("overview"),f=_(!1),m=_(!1),w=_(!1);let S=null;const B=_(null),R=_(!1),M=z(()=>B.value?B.value:s.currentBookId?n.books.find(I=>I.id===s.currentBookId):null),L=z(()=>!!s.currentBookId),V=z(()=>M.value?.cover?M.value.cover:"");function O(I){o.value=I}async function N(I){if(I){s.setCurrentBook(I),s.setLoading(!0);try{const k=await(await fetch(`/api/bookshelf/books/${I}`)).json();if(!k.success)throw new Error(k.error||"è·å–ä¹¦ç±ä¿¡æ¯å¤±è´¥");if(k.book&&(B.value={id:k.book.id,title:k.book.title,cover:k.book.cover,total_pages:k.book.total_pages||0},s.setBookTotalPages(k.book.total_pages||0),k.book.chapters&&k.book.chapters.length>0)){let U=0;const Y=k.book.chapters.map((ce,Pe)=>{const xe=ce.id||ce.chapter_id||`ch_${Pe+1}`,Ne=ce.page_count||ce.pages?.length||0,ye=U+1,je=U+Ne;return U=je,{id:xe,title:ce.title||`ç¬¬ ${Pe+1} ç« `,startPage:ye,endPage:je}});s.setChapters(Y)}if(await j(),s.chapters.length===0)try{const U=await ln(I);U.success&&U.chapters&&U.chapters.length>0&&s.setChapters(U.chapters.map(Y=>({id:Y.id,title:Y.title,startPage:Y.start_page,endPage:Y.end_page})))}catch(U){console.warn("è·å–ç« èŠ‚åˆ—è¡¨å¤±è´¥:",U)}await s.loadNotesFromAPI(),s.analyzedPageCount>0&&await P(),l.replace({query:{book:I}}),s.isAnalyzing&&J()}catch(g){console.error("åŠ è½½ä¹¦ç±å¤±è´¥:",g),s.setError(g instanceof Error?g.message:"åŠ è½½ä¹¦ç±å¤±è´¥")}finally{s.setLoading(!1)}}}async function j(){if(s.currentBookId)try{const I=await gs(s.currentBookId);if(I.success)if(I.analyzed_pages_count!==void 0&&s.setAnalyzedPagesCount(I.analyzed_pages_count),I.current_task){const g=I.current_task.status;g==="running"?(s.setAnalysisStatus("running"),I.current_task.progress&&s.updateProgress(I.current_task.progress.analyzed_pages||0,I.current_task.progress.total_pages||0)):g==="paused"?s.setAnalysisStatus("paused"):g==="completed"?s.setAnalysisStatus("completed"):g==="failed"?s.setAnalysisStatus("failed"):s.setAnalysisStatus("idle")}else I.analyzed?s.setAnalysisStatus("completed"):s.setAnalysisStatus("idle")}catch(I){console.error("è·å–åˆ†æçŠ¶æ€å¤±è´¥:",I)}}function J(){u(),S=setInterval(async()=>{await j();const I=s.analysisStatus;(I==="completed"||I==="failed"||I==="idle")&&(u(),I==="completed"&&(console.log("åˆ†æå®Œæˆï¼Œè‡ªåŠ¨åˆ·æ–°æ¦‚è§ˆæ•°æ®"),await P(),await j()))},3e3)}function u(){S&&(clearInterval(S),S=null)}async function P(){if(s.currentBookId)try{const I=await ks(s.currentBookId);let g="story_summary";I.success&&I.generated&&I.generated.length>0&&(g=I.generated[0],s.setGeneratedTemplates(I.generated));try{const U=await bs(s.currentBookId,g);U.success&&U.content&&s.setOverview({type:g,content:U.content})}catch(U){console.warn("åŠ è½½æ¦‚è§ˆå¤±è´¥:",U)}const k=await ys(s.currentBookId);k.success&&s.setTimeline(k)}catch(I){console.error("åŠ è½½æ¦‚è§ˆæ•°æ®å¤±è´¥:",I)}}function v(){f.value=!0}function h(){f.value=!1}function C(){m.value=!m.value,m.value&&(w.value=!1)}function A(){w.value=!w.value,w.value&&(m.value=!1)}function E(){if(!s.currentBookId){l.push("/translate");return}const I=s.chapters;!I||I.length===0?l.push({path:"/translate",query:{book:s.currentBookId}}):I.length===1?l.push({path:"/translate",query:{book:s.currentBookId,chapter:I[0].id}}):R.value=!0}function q(I){R.value=!1,l.push({path:"/translate",query:{book:s.currentBookId,chapter:I}})}function te(){R.value=!1}return nt(async()=>{await n.fetchBooks();const I=t.query.book;I&&await N(I)}),Fs(()=>{u()}),st(()=>s.isAnalyzing,I=>{I?J():u()}),(I,g)=>{const k=Qs("router-link");return c(),p("div",Qc,[e("header",Hc,[e("div",Jc,[e("div",Gc,[ue(k,{to:"/",title:"ä¹¦æ¶é¦–é¡µ"},{default:ft(()=>[...g[4]||(g[4]=[e("img",{src:"/pic/logo.png",alt:"Saber-Translator Logo",class:"app-logo"},null,-1),e("span",{class:"app-name"},"Saber-Translator",-1)])]),_:1})]),e("div",Zc,[ue(k,{to:"/",class:"nav-link"},{default:ft(()=>[...g[5]||(g[5]=[oe("ğŸ“š ä¹¦æ¶",-1)])]),_:1}),e("a",{href:"javascript:void(0)",class:"nav-link",onClick:E},"ğŸŒ ç¿»è¯‘"),g[7]||(g[7]=e("span",{class:"nav-link active"},"ğŸ” åˆ†æ",-1)),e("button",{id:"settingsBtn",class:"btn btn-icon",title:"è®¾ç½®",onClick:v},"âš™ï¸"),e("button",{id:"themeToggle",class:"theme-toggle",title:"åˆ‡æ¢äº®æš—æ¨¡å¼",onClick:g[0]||(g[0]=(...U)=>ge(i).toggleTheme&&ge(i).toggleTheme(...U))},[...g[6]||(g[6]=[e("span",{class:"theme-icon light-icon"},"â˜€ï¸",-1),e("span",{class:"theme-icon dark-icon"},"ğŸŒ™",-1)])])])])]),e("main",Wc,[e("aside",{class:H(["insight-sidebar",{"mobile-visible":m.value}])},[e("div",Xc,[e("div",Yc,[V.value?(c(),p("img",{key:0,src:V.value,alt:"å°é¢",class:"book-cover"},null,8,ed)):(c(),p("div",td,[...g[8]||(g[8]=[e("span",null,"ğŸ“–",-1)])]))]),e("h2",{class:"book-title",title:M.value?.title},$(M.value?.title||"é€‰æ‹©ä¹¦ç±"),9,sd),e("div",nd,[e("span",ld,[g[9]||(g[9]=e("span",{class:"meta-icon"},"ğŸ“„",-1)),e("span",ad,$(M.value?.total_pages||0),1),g[10]||(g[10]=oe(" é¡µ ",-1))]),e("span",od,[g[11]||(g[11]=e("span",{class:"meta-icon"},"ğŸ“Š",-1)),e("span",rd,$(ge(s).analyzedPageCount),1),g[12]||(g[12]=oe(" å·²åˆ†æ ",-1))])])]),L.value?(c(),et(Hn,{key:0,onStartPolling:J,onStopPolling:u})):T("",!0),L.value?(c(),et(Fi,{key:1})):T("",!0)],2),e("div",id,[L.value?(c(),p("div",cd,[e("button",{class:"mobile-nav-btn",onClick:C,"aria-label":"æ‰“å¼€å¯¼èˆª"}," ğŸ“š "),e("div",dd,[e("button",{class:H(["tab-btn",{active:o.value==="overview"}]),onClick:g[1]||(g[1]=U=>O("overview"))},[...g[16]||(g[16]=[e("span",{class:"tab-icon"},"ğŸ“Š",-1),oe(" æ¦‚è§ˆ ",-1)])],2),e("button",{class:H(["tab-btn",{active:o.value==="qa"}]),onClick:g[2]||(g[2]=U=>O("qa"))},[...g[17]||(g[17]=[e("span",{class:"tab-icon"},"ğŸ’¬",-1),oe(" æ™ºèƒ½é—®ç­” ",-1)])],2),e("button",{class:H(["tab-btn",{active:o.value==="timeline"}]),onClick:g[3]||(g[3]=U=>O("timeline"))},[...g[18]||(g[18]=[e("span",{class:"tab-icon"},"ğŸ“ˆ",-1),oe(" æ—¶é—´çº¿ ",-1)])],2)]),e("button",{class:"mobile-nav-btn",onClick:A,"aria-label":"æ‰“å¼€ç¬”è®°"}," ğŸ“ ")])):(c(),p("div",ud,[g[13]||(g[13]=e("div",{class:"prompt-icon"},"ğŸ“š",-1)),g[14]||(g[14]=e("h2",null,"é€‰æ‹©è¦åˆ†æçš„ä¹¦ç±",-1)),g[15]||(g[15]=e("p",null,"ä»ä¸‹æ–¹åˆ—è¡¨ä¸­é€‰æ‹©ä¸€æœ¬ä¹¦ç±å¼€å§‹æ™ºèƒ½åˆ†æ",-1)),ue($n,{onSelect:N})])),K(e("div",pd,[ue(aa)],512),[[Ft,o.value==="overview"&&L.value]]),K(e("div",vd,[ue(Xo)],512),[[Ft,o.value==="qa"&&L.value]]),K(e("div",md,[ue(uo)],512),[[Ft,o.value==="timeline"&&L.value]])]),L.value?(c(),p("aside",{key:0,class:H(["insight-workspace",{"mobile-visible":w.value}])},[ue(xi),ue(Nr)],2)):T("",!0)]),f.value?(c(),et(Rc,{key:0,onClose:h})):T("",!0),R.value&&ge(s).currentBookId?(c(),et(Fc,{key:1,chapters:ge(s).chapters,onSelect:q,onClose:te},null,8,["chapters"])):T("",!0)])}}}),Cd=Ke(gd,[["__scopeId","data-v-8a45de56"]]);export{Cd as default};
