const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["js/index.Dz1DNgba.js","js/vue-vendor.DDJbHApa.js","assets/index.CUxW_WTs.css","js/session.Kpy-QhBa.js","js/client.Bht704G-.js","js/utils-vendor.B9ygI19o.js"])))=>i.map(i=>d[i]);
import{D as on,b as an,c as sn,d as Kn,a as it,_ as Xe,u as Qe,s as Re,e as ct,f as To,g as Io,h as Do,i as Ro,j as Mo,k as Mn,B as Bn,l as En,m as Bo,F as Jt,n as Pn,o as An,p as Eo,L as Fn}from"./index.Dz1DNgba.js";import{d as ln,r as h,c as ee,a as je,i as H,v as Te,e,t as fe,x as st,h as U,b as rt,n as Le,B as Fe,l as ut,y as ae,E as Ke,f as Ie,G as Zt,w as ht,H as et,u as ve,F as Ge,j as tt,I as qn,g as Po,J as Ye,K as dt,L as kt,z as Me,M as Ao,k as nt,N as Qt,o as It,O as yt,P as Ln,D as Fo,C as Lo}from"./vue-vendor.DDJbHApa.js";import{p as Uo,a as Oo,b as zo,c as Vo,d as No,e as Wo,f as Ko,h as qo,i as Ho,j as Yo,k as rn,l as Hn}from"./system.CmjDD-4C.js";import{getFontList as Yn,uploadFont as Jo,getTextboxPrompts as Xo,getPrompts as jo,configApi as Ne,getFontListApi as Go}from"./config.CwRcCkM9.js";import{_ as We}from"./CustomSelect.vue_vue_type_style_index_0_lang.3BEAab7t.js";import{apiClient as ot}from"./client.Bht704G-.js";import{B as Jn}from"./BaseModal.B6buknA4.js";import{getBookDetail as Zo}from"./bookshelf.C_zUWUVG.js";import"./utils-vendor.B9ygI19o.js";async function Et(t){return ot.post("/api/translate_image",t)}async function un(t){return ot.post("/api/re_render_image",t)}async function Qo(t){try{return{success:!0,data:await ot.post("/api/translate_single_text",t)}}catch(i){return{success:!1,error:i instanceof Error?i.message:"翻译失败"}}}async function en(t){return ot.post("/api/hq_translate_batch",t)}async function tn(t,i,l){return ot.post("/api/detect_boxes",{image:t,detector_type:i,...l})}async function Xn(t,i,l,s){return ot.post("/api/ocr_single_bubble",{image_data:t,bubble_coords:i,ocr_engine:l,...s})}async function cn(t,i,l){return ot.post("/api/inpaint_single_bubble",{image_data:t,bubble_coords:i,bubble_angle:l?.bubbleAngle??0,method:l?.method??"lama",lama_model:l?.lamaModel??"lama_mpe",...l?.maskData&&{mask_data:l.maskData}})}const ea=Object.freeze(Object.defineProperty({__proto__:null,detectBoxes:tn,hqTranslateBatch:en,inpaintSingleBubble:cn,ocrSingleBubble:Xn,reRenderImage:un,translateImage:Et,translateSingleText:Qo},Symbol.toStringTag,{value:"Module"}));async function ta(){return ot.get("/api/plugins")}async function na(t){return ot.post(`/api/plugins/${t}/enable`)}async function oa(t){return ot.post(`/api/plugins/${t}/disable`)}async function aa(t){return ot.delete(`/api/plugins/${t}`)}async function sa(t){return ot.get(`/api/plugins/${t}/config_schema`)}async function la(t){return ot.get(`/api/plugins/${t}/config`)}async function ia(t,i){return ot.post(`/api/plugins/${t}/config`,i)}async function ra(){return ot.get("/api/plugins/default_states")}async function ua(t,i){return ot.post(`/api/plugins/${t}/set_default_state`,{enabled:i})}async function ca(){return{states:(await ra()).default_states}}const da=ua,ga=sa,va=la,ba=ia;function pa(){return`img_${Date.now()}_${Math.random().toString(36).substring(2,9)}`}function Un(t,i,l){return{id:pa(),fileName:t,originalDataURL:i,translatedDataURL:null,cleanImageData:null,bubbleStates:null,translationStatus:"pending",translationFailed:!1,fontSize:25,autoFontSize:!0,fontFamily:"fonts/STSONG.TTF",layoutDirection:"vertical",textColor:"#000000",fillColor:Kn,inpaintMethod:"solid",strokeEnabled:sn,strokeColor:an,strokeWidth:on,hasUnsavedChanges:!1,...l}}const at=ln("image",()=>{const t=h([]),i=h(-1),l=h(!1),s=h(!1),n=h(null),a=ee(()=>i.value>=0&&i.value<t.value.length?t.value[i.value]??null:null),o=ee(()=>t.value.length),b=ee(()=>t.value.length>0),m=ee(()=>i.value>0),T=ee(()=>i.value<t.value.length-1),x=ee(()=>t.value.filter(R=>R.translationFailed).length),L=ee(()=>t.value.filter(R=>R.translationStatus==="completed").length),ne=ee(()=>t.value.filter(R=>R.translationStatus==="pending").length);function ie(R,E,$){const c=Un(R,E,$);return t.value.push(c),t.value.length===1&&(i.value=0),console.log(`图片已添加: ${R}，当前共 ${t.value.length} 张图片`),c}function Q(R){const E=R.map(({fileName:c,originalDataURL:O,overrides:ce})=>Un(c,O,ce)),$=t.value.length===0;return t.value.push(...E),$&&t.value.length>0&&(i.value=0),console.log(`批量添加了 ${E.length} 张图片，当前共 ${t.value.length} 张`),E}function v(R){t.value=R.map(E=>({...E,strokeEnabled:E.strokeEnabled??sn,strokeColor:E.strokeColor||an,strokeWidth:E.strokeWidth??on,hasUnsavedChanges:E.hasUnsavedChanges||!1})),t.value.length>0?i.value=Math.min(Math.max(0,i.value),t.value.length-1):i.value=-1,console.log(`图片数组已设置，共 ${t.value.length} 张图片`)}function Z(R){return R<0||R>=t.value.length?(console.warn(`删除失败: 无效的索引 ${R}`),!1):(t.value.splice(R,1),i.value===R?(i.value=Math.min(R,t.value.length-1),t.value.length===0&&(i.value=-1)):i.value>R&&i.value--,console.log(`图片已删除，当前共 ${t.value.length} 张图片`),!0)}function Y(){return Z(i.value)}function p(){t.value=[],i.value=-1,l.value=!1,s.value=!1,n.value=null,console.log("所有图片已清除")}function u(){t.value.sort((R,E)=>R.fileName.localeCompare(E.fileName,void 0,{numeric:!0,sensitivity:"base"})),console.log("图片已按文件名排序")}function C(R){R>=-1&&R<t.value.length?(i.value=R,console.log(`当前图片索引已设置为 ${R}`)):console.warn(`设置索引失败: 无效的索引 ${R}`)}function D(){return m.value?(i.value--,!0):!1}function k(){return T.value?(i.value++,!0):!1}function J(R){a.value?(Object.assign(a.value,R),console.log("当前图片属性已更新:",Object.keys(R))):console.warn("更新失败: 当前没有选中的图片")}function te(R,E){if(R>=0&&R<t.value.length){const $=t.value[R];$&&(Object.assign($,E),console.log(`图片 ${R} 属性已更新:`,Object.keys(E)))}else console.warn(`更新失败: 无效的索引 ${R}`)}function de(R){a.value&&(a.value.bubbleStates=R,a.value.hasUnsavedChanges=!0,console.log(`当前图片气泡状态已更新，共 ${R?.length??0} 个气泡`))}function F(R,E){a.value?(a.value[R]=E,a.value.hasUnsavedChanges=!0,console.log(`当前图片属性 ${String(R)} 已更新`)):console.warn("更新失败: 当前没有选中的图片")}function g(R,E){a.value&&(a.value.translatedDataURL=R,E&&(a.value.cleanImageData=E),a.value.translationStatus="completed",a.value.translationFailed=!1,a.value.hasUnsavedChanges=!0,console.log("当前图片翻译结果已更新"))}function _(R,E,$){if(R>=0&&R<t.value.length){const c=t.value[R];c&&(c.translationStatus=E,c.translationFailed=E==="failed",$&&(c.errorMessage=$),console.log(`图片 ${R} 翻译状态: ${E}`))}}function B(R){a.value&&(a.value.translationStatus="failed",a.value.translationFailed=!0,a.value.errorMessage=R,console.log(`当前图片翻译失败: ${R}`))}function q(){t.value.forEach(R=>{R.translationStatus="pending",R.translationFailed=!1,R.errorMessage=void 0}),console.log("所有图片翻译状态已重置")}function N(R){l.value=R,R||(s.value=!1,n.value=null),console.log(`批量翻译状态: ${R?"进行中":"已完成"}`)}function M(R){s.value=R,console.log(`批量翻译暂停状态: ${R?"已暂停":"继续中"}`)}function f(R){n.value=R}function S(){if(s.value&&n.value){s.value=!1;const R=n.value;n.value=null,R(),console.log("批量翻译已继续")}}function oe(){return t.value.map((R,E)=>R.translationFailed?E:-1).filter(R=>R!==-1)}return{images:t,currentImageIndex:i,isBatchTranslationInProgress:l,isBatchTranslationPaused:s,batchTranslationResumeCallback:n,currentImage:a,imageCount:o,hasImages:b,canGoPrevious:m,canGoNext:T,failedImageCount:x,completedImageCount:L,pendingImageCount:ne,addImage:ie,addImages:Q,setImages:v,deleteImage:Z,deleteCurrentImage:Y,clearImages:p,sortImagesByFileName:u,setCurrentImageIndex:C,goToPrevious:D,goToNext:k,updateCurrentImage:J,updateImageByIndex:te,updateCurrentBubbleStates:de,updateCurrentImageProperty:F,updateCurrentTranslationResult:g,setTranslationStatus:_,markCurrentAsFailed:B,resetAllTranslationStatus:q,setBatchTranslationInProgress:N,setBatchTranslationPaused:M,setBatchTranslationResumeCallback:f,resumeBatchTranslation:S,getFailedImageIndices:oe}}),On=Object.freeze(Object.defineProperty({__proto__:null,useImageStore:at},Symbol.toStringTag,{value:"Module"})),jn=ln("session",()=>{const t=h(null),i=h({bookId:null,chapterId:null,bookTitle:null,chapterTitle:null}),l=h([]),s=h(!1),n=h({current:0,total:0,message:""}),a=h(null),o=h(!1),b=ee(()=>i.value.bookId!==null&&i.value.chapterId!==null),m=ee(()=>i.value.bookId),T=ee(()=>i.value.chapterId);function x(B,q,N=null,M=null){i.value={bookId:B,chapterId:q,bookTitle:N,chapterTitle:M},console.log(`会话上下文已设置: 书籍=${B}, 章节=${q}`)}function L(B,q,N,M){x(B,q,N,M)}function ne(){i.value={bookId:null,chapterId:null,bookTitle:null,chapterTitle:null},console.log("会话上下文已清除")}function ie(B){const q=B.get("book"),N=B.get("chapter");q&&N&&x(q,N)}function Q(B){t.value=B,console.log(`当前会话名称: ${B}`)}function v(){t.value=null}function Z(B){l.value=B,console.log(`会话列表已更新，共 ${B.length} 个会话`)}function Y(B){const q=l.value.findIndex(N=>N.name===B.name);q>=0?l.value[q]=B:l.value.unshift(B)}function p(B){const q=l.value.findIndex(N=>N.name===B);q>=0&&l.value.splice(q,1)}function u(B,q){const N=l.value.find(M=>M.name===B);N&&(N.name=q)}function C(B){s.value=B}function D(B){o.value=B}function k(B){a.value=B}function J(B,q,N,M){return{name:B,version:"2.0",savedAt:new Date().toISOString(),imageCount:q.length,ui_settings:M,images:q.map(f=>({originalDataURL:f.originalDataURL,translatedDataURL:f.translatedDataURL||void 0,cleanImageData:f.cleanImageData||void 0,bubbleStates:f.bubbleStates||void 0,fileName:f.fileName,fontSize:f.fontSize,autoFontSize:f.autoFontSize,fontFamily:f.fontFamily,layoutDirection:f.layoutDirection,textColor:f.textColor,fillColor:f.fillColor,inpaintMethod:f.inpaintMethod,strokeEnabled:f.strokeEnabled,strokeColor:f.strokeColor,strokeWidth:f.strokeWidth,translationStatus:f.translationStatus,translationFailed:f.translationFailed})),currentImageIndex:N}}function te(){t.value=null,i.value={bookId:null,chapterId:null,bookTitle:null,chapterTitle:null},l.value=[],s.value=!1,o.value=!1,a.value=null,console.log("会话状态已重置")}async function de(B){if(!B||typeof B!="string")return null;if(B.startsWith("data:"))return B;if(!B.startsWith("/api/"))return null;try{const q=await fetch(B);if(!q.ok)return null;const N=await q.blob();return new Promise(M=>{const f=new FileReader;f.onloadend=()=>M(f.result),f.onerror=()=>M(null),f.readAsDataURL(N)})}catch(q){return console.error(`转换图片 URL 失败: ${B}`,q),null}}async function F(B,q){const N=B.length;for(let M=0;M<N;M++){const f=B[M];if(f){if(q&&q(M+1,N),f.originalDataURL&&f.originalDataURL.startsWith("/api/")){const S=await de(f.originalDataURL);S&&(f.originalDataURL=S)}if(f.translatedDataURL&&f.translatedDataURL.startsWith("/api/")){const S=await de(f.translatedDataURL);S&&(f.translatedDataURL=S)}if(f.cleanImageData&&f.cleanImageData.startsWith("/api/")){const S=await de(f.cleanImageData);S&&(f.cleanImageData=S.replace(/^data:image\/\w+;base64,/,""))}}}}async function g(B){C(!0),k(null),n.value={current:0,total:0,message:"正在加载..."};try{const{useImageStore:q}=await it(async()=>{const{useImageStore:O}=await Promise.resolve().then(()=>On);return{useImageStore:O}},void 0),{useSettingsStore:N}=await it(async()=>{const{useSettingsStore:O}=await import("./index.Dz1DNgba.js").then(ce=>ce.q);return{useSettingsStore:O}},__vite__mapDeps([0,1,2])),{useBubbleStore:M}=await it(async()=>{const{useBubbleStore:O}=await Promise.resolve().then(()=>ol);return{useBubbleStore:O}},void 0),f=q(),S=N(),oe=M(),{loadSessionByPathApi:R}=await it(async()=>{const{loadSessionByPathApi:O}=await import("./session.Kpy-QhBa.js");return{loadSessionByPathApi:O}},__vite__mapDeps([3,4,5])),E=await R(B);if(!E.success||!E.session)throw new Error(E.error||"加载会话失败");const $=E.session;if($.images&&$.images.length>0){const O=$.images.map((G,A)=>({id:`session-${A}-${Date.now()}`,originalDataURL:G.originalDataURL,translatedDataURL:G.translatedDataURL||null,cleanImageData:G.cleanImageData||null,bubbleStates:G.bubbleStates||[],fileName:G.fileName||`image-${A+1}.png`,translationStatus:G.translationStatus||"pending",translationFailed:!!G.translationFailed,hasUnsavedChanges:!1,fontSize:G.fontSize||24,autoFontSize:G.autoFontSize??!0,fontFamily:G.fontFamily||"Microsoft YaHei",layoutDirection:G.layoutDirection||"vertical",textColor:G.textColor||"#000000",fillColor:G.fillColor||"#FFFFFF",inpaintMethod:G.inpaintMethod||"litelama",strokeEnabled:G.strokeEnabled??!1,strokeColor:G.strokeColor||"#FFFFFF",strokeWidth:G.strokeWidth||2}));O.length>0&&(console.log("正在加载图片..."),n.value={current:0,total:O.length,message:"正在加载图片..."},await F(O,(G,A)=>{const r=G/A*100;n.value={current:G,total:A,message:`加载图片 ${G}/${A}...`},console.log(`加载图片 ${G}/${A}... (${r.toFixed(0)}%)`)}),n.value={current:O.length,total:O.length,message:"加载完成"},console.log("图片加载完成，已转换为 Base64"),setTimeout(()=>{n.value={current:0,total:0,message:""}},500)),f.setImages(O);let ce=0;typeof $.currentImageIndex=="number"&&(ce=$.currentImageIndex,(ce>=O.length||ce<0)&&(ce=O.length>0?0:-1)),f.setCurrentImageIndex(ce);const X=O[ce];X&&X.bubbleStates&&X.bubbleStates.length>0?oe.setBubbles(X.bubbleStates,!0):oe.clearBubblesLocal(),console.log(`按路径加载会话成功: ${B}, 共 ${O.length} 张图片`)}const c=$.ui_settings;if(c){(c.targetLanguage||c.sourceLanguage)&&S.updateSettings({targetLanguage:c.targetLanguage||void 0,sourceLanguage:c.sourceLanguage||void 0});const O=c.useInpaintingMethod,X=["solid","lama_mpe","litelama"].includes(O)?O:S.settings.textStyle.inpaintMethod;S.updateTextStyle({fontSize:c.fontSize||S.settings.textStyle.fontSize,autoFontSize:c.autoFontSize??S.settings.textStyle.autoFontSize,fontFamily:c.fontFamily||S.settings.textStyle.fontFamily,layoutDirection:c.layoutDirection||S.settings.textStyle.layoutDirection,textColor:c.textColor||S.settings.textStyle.textColor,fillColor:c.fillColor||S.settings.textStyle.fillColor,inpaintMethod:X,strokeEnabled:c.strokeEnabled??S.settings.textStyle.strokeEnabled,strokeColor:c.strokeColor||S.settings.textStyle.strokeColor,strokeWidth:c.strokeWidth||S.settings.textStyle.strokeWidth}),console.log("UI 设置已恢复")}return Q(B),!0}catch(q){const N=q instanceof Error?q.message:"加载会话失败";throw k(N),console.error(`按路径加载会话失败: ${B}`,q),q}finally{C(!1)}}async function _(B,q){if(!B||!q)return console.log("未在书籍/章节模式，不支持保存"),!1;console.log(`保存章节会话（分批）: book=${B}, chapter=${q}`);const{useImageStore:N}=await it(async()=>{const{useImageStore:E}=await Promise.resolve().then(()=>On);return{useImageStore:E}},void 0),{useSettingsStore:M}=await it(async()=>{const{useSettingsStore:E}=await import("./index.Dz1DNgba.js").then($=>$.q);return{useSettingsStore:E}},__vite__mapDeps([0,1,2])),f=N(),S=M(),oe=Array.isArray(f.images)?f.images:[];if(!oe||oe.length===0)return console.log("没有图片数据可保存"),!1;const R=`bookshelf/${B}/${q}`;D(!0),k(null),n.value={current:0,total:100,message:"准备保存..."};try{const{batchSaveStartApi:E,batchSaveImageApi:$,batchSaveCompleteApi:c}=await it(async()=>{const{batchSaveStartApi:I,batchSaveImageApi:d,batchSaveCompleteApi:z}=await import("./session.Kpy-QhBa.js");return{batchSaveStartApi:I,batchSaveImageApi:d,batchSaveCompleteApi:z}},__vite__mapDeps([3,4,5])),O=oe.length;n.value={current:5,total:100,message:"收集元数据..."};const{textStyle:ce,targetLanguage:X,sourceLanguage:G}=S.settings,A={targetLanguage:X,sourceLanguage:G,fontSize:ce.fontSize,autoFontSize:ce.autoFontSize,fontFamily:ce.fontFamily,layoutDirection:ce.layoutDirection,textColor:ce.textColor,useInpaintingMethod:ce.inpaintMethod,fillColor:ce.fillColor,strokeEnabled:ce.strokeEnabled,strokeColor:ce.strokeColor,strokeWidth:ce.strokeWidth},r=oe.map(I=>{const d={};for(const z of Object.keys(I))z!=="originalDataURL"&&z!=="translatedDataURL"&&z!=="cleanImageData"&&(d[z]=I[z]);return d.hasOriginalData=!!I.originalDataURL,d.hasTranslatedData=!!I.translatedDataURL,d.hasCleanData=!!I.cleanImageData,d}),y={ui_settings:A,images_meta:r,currentImageIndex:f.currentImageIndex};n.value={current:10,total:100,message:"初始化保存..."};const w=await E(R,y);if(!w.success)throw new Error(w.error||"初始化保存失败");const P=w.session_folder;if(!P)throw new Error("未获取到会话文件夹路径");console.log(`会话文件夹: ${P}`);let se=0,ge=0;const re=I=>!!I&&typeof I=="string"&&I.startsWith("data:");for(let I=0;I<O;I++){const d=oe[I];if(!d)continue;const z=10+I/O*80;if(n.value={current:Math.round(z),total:100,message:`保存图片 ${I+1}/${O}...`},re(d.originalDataURL))try{const K=await $(P,I,"original",d.originalDataURL);K.success||(console.error(`保存图片 ${I} original 失败:`,K.error),ge++)}catch(K){console.error(`保存图片 ${I} original 出错:`,K),ge++}if(re(d.translatedDataURL))try{const K=await $(P,I,"translated",d.translatedDataURL);K.success||(console.error(`保存图片 ${I} translated 失败:`,K.error),ge++)}catch(K){console.error(`保存图片 ${I} translated 出错:`,K),ge++}if(d.cleanImageData&&typeof d.cleanImageData=="string"&&!d.cleanImageData.startsWith("/api/"))try{const K=await $(P,I,"clean",d.cleanImageData);K.success||(console.error(`保存图片 ${I} clean 失败:`,K.error),ge++)}catch(K){console.error(`保存图片 ${I} clean 出错:`,K),ge++}se++}n.value={current:95,total:100,message:"完成保存..."};const le=await c(P,r);if(!le.success)throw new Error(le.error||"完成保存失败");return n.value={current:100,total:100,message:"保存完成"},console.log(`分批保存完成: ${se} 张图片, ${ge} 个失败`),setTimeout(()=>{n.value={current:0,total:0,message:""}},1e3),!0}catch(E){const $=E instanceof Error?E.message:"保存章节会话失败";return k($),console.error("分批保存失败:",E),n.value={current:0,total:0,message:""},!1}finally{D(!1)}}return{currentSessionName:t,context:i,sessionList:l,isLoading:s,isSaving:o,error:a,loadingProgress:n,isBookshelfMode:b,currentBookId:m,currentChapterId:T,setContext:x,clearContext:ne,parseContextFromUrl:ie,setSessionName:Q,clearSessionName:v,setSessionList:Z,addToSessionList:Y,removeFromSessionList:p,renameInSessionList:u,setLoading:C,setSaving:D,setError:k,createSessionData:J,imageUrlToBase64:de,saveChapterSession:_,loadSessionByPath:g,setBookChapterContext:L,reset:te}}),fa={key:0,class:"translation-progress-bar"},ma={class:"progress-bar-label"},ha={class:"progress-bar"},ya=je({__name:"ProgressBar",props:{visible:{type:Boolean,default:!0},percentage:{},label:{default:"进度"}},setup(t){return(i,l)=>t.visible?(U(),H("div",fa,[e("div",ma,fe(t.label),1),e("div",ha,[e("div",{class:"progress",style:st({width:`${t.percentage}%`})},null,4)])])):Te("",!0)}}),dn=Xe(ya,[["__scopeId","data-v-0265c7eb"]]),xa={class:"image-upload"},ka={class:"error-text"},Sa={key:2,class:"loading-overlay"},Ca=je({__name:"ImageUpload",emits:["uploadStart","uploadComplete","uploadError"],setup(t,{expose:i,emit:l}){const s=l,n=at(),a=Qe(),o=h(null),b=h(!1),m=h(!1),T=h(""),x=h(0),L=h(""),ne=h(!1),ie=ee(()=>a.settings.pdfProcessingMethod);function Q(){o.value?.click()}async function v(g){const _=g.target;!_.files||_.files.length===0||(await u(Array.from(_.files)),_.value="")}async function Z(g){g.preventDefault(),m.value=!1,!(!g.dataTransfer?.files||g.dataTransfer.files.length===0)&&await u(Array.from(g.dataTransfer.files))}function Y(g){g.preventDefault(),m.value=!0}function p(g){const _=g.currentTarget.getBoundingClientRect(),B=g.clientX,q=g.clientY;(B<_.left||B>_.right||q<_.top||q>_.bottom)&&(m.value=!1)}async function u(g){if(g.length!==0){b.value=!0,T.value="",ne.value=!0,x.value=0,s("uploadStart");try{let _=0;const B=g.length;for(let q=0;q<g.length;q++){const N=g[q];if(!N)continue;L.value=N.name;const M=N.type,f=N.name.toLowerCase();if(M.startsWith("image/"))await C(N),_++;else if(M==="application/pdf"||f.endsWith(".pdf")){const S=await D(N);_+=S}else if(f.endsWith(".mobi")||f.endsWith(".azw")||f.endsWith(".azw3")){const S=await de(N);_+=S}else console.warn(`不支持的文件类型: ${N.name}`),Re(`不支持的文件类型: ${N.name}`,"warning");x.value=Math.round((q+1)/B*100)}_>0&&(Re(`已添加 ${_} 张图片`,"success"),s("uploadComplete",_))}catch(_){console.error("处理文件失败:",_);const B=_ instanceof Error?_.message:"处理文件失败，请重试";T.value=B,Re(B,"error"),s("uploadError",B)}finally{b.value=!1,ne.value=!1,L.value=""}}}async function C(g){return new Promise((_,B)=>{const q=new FileReader;q.onload=N=>{const M=N.target?.result;n.addImage(g.name,M),_()},q.onerror=()=>B(new Error(`读取图片文件失败: ${g.name}`)),q.readAsDataURL(g)})}async function D(g){return ie.value==="frontend"?await J(g):await te(g)}function k(g){return new Promise((_,B)=>{const q=new FileReader;q.onload=()=>_(q.result),q.onerror=B,q.readAsDataURL(g)})}async function J(g){try{const _=await it(()=>import("./pdf.U7tdldy2.js").then(S=>S.p),[]);_.GlobalWorkerOptions.workerSrc=`https://cdnjs.cloudflare.com/ajax/libs/pdf.js/${_.version}/pdf.worker.min.js`;const B=await g.arrayBuffer(),q=await _.getDocument({data:B}).promise,N=q.numPages;console.log(`PDF ${g.name} 共 ${N} 页，开始本地渲染...`),Re(`正在解析 PDF，共 ${N} 页...`,"info");const M=typeof OffscreenCanvas<"u";M&&console.log("使用 OffscreenCanvas 后台渲染模式");let f=0;for(let S=1;S<=N;S++){L.value=`${g.name} - 第 ${S}/${N} 页`,x.value=Math.round(S/N*100);try{const oe=await q.getPage(S),E=oe.getViewport({scale:2});let $;if(M){const O=new OffscreenCanvas(E.width,E.height),ce=O.getContext("2d");await oe.render({canvasContext:ce,viewport:E}).promise;const X=await O.convertToBlob({type:"image/jpeg",quality:1});$=await k(X)}else{const O=document.createElement("canvas"),ce=O.getContext("2d");O.width=E.width,O.height=E.height,await oe.render({canvasContext:ce,viewport:E}).promise,$=O.toDataURL("image/jpeg",1)}const c=`${g.name}_页面${S}`;n.addImage(c,$),f++,console.log(`  页面 ${S}/${N} 处理完成`)}catch(oe){console.warn(`PDF ${g.name} 第 ${S} 页渲染失败:`,oe)}}return console.log(`PDF ${g.name} 全部 ${N} 页处理完成`),f}catch(_){return console.error("前端 PDF 解析失败:",_),Re("前端 PDF 解析失败，尝试使用后端解析...","warning"),await te(g)}}async function te(g){let B=null;try{Re("正在上传 PDF 文件...","info");const q=await Uo(g,5);if(!q.success||!q.session_id)throw new Error(q.error||"PDF 解析启动失败");B=q.session_id;const N=q.total_pages||0;console.log(`PDF ${g.name} 共 ${N} 页，开始后端分批解析...`),Re(`正在解析 PDF，共 ${N} 页...`,"info");let M=0;for(let f=0;f<N;f+=5){L.value=`${g.name} - 处理中 ${Math.min(f+5,N)}/${N} 页`,x.value=N>0?Math.round(f/N*100):0;const S=await Oo(B,f,5);if(!S.success){console.warn(`批次 ${f} 获取失败:`,S.error);continue}if(S.images&&S.images.length>0)for(const oe of S.images){if(!oe||!oe.data_url)continue;const R=`${g.name}_页面${String(oe.page_index+1).padStart(4,"0")}`;n.addImage(R,oe.data_url),M++}console.log(`  已加载 ${M}/${N} 页`)}return console.log(`PDF ${g.name} 全部 ${M} 页处理完成`),M}catch(q){throw console.error("后端 PDF 解析失败:",q),q}finally{if(B)try{await zo(B)}catch(q){console.warn("PDF 会话清理失败:",q)}}}async function de(g){let _=null;try{Re("正在上传电子书文件...","info");const B=await Vo(g,5);if(!B.success||!B.session_id)throw new Error(B.error||"MOBI/AZW 解析启动失败");_=B.session_id;const q=B.total_images||0;Re(`正在解析电子书，共 ${q} 张图片...`,"info");let N=0,M=!0;for(;M;){L.value=`${g.name} - 已处理 ${N}/${q} 张`,x.value=q>0?Math.round(N/q*100):0;const f=await No(_);if(!f.success)throw new Error(f.error||"MOBI/AZW 批次解析失败");if(f.images&&f.images.length>0){for(let S=0;S<f.images.length;S++){const oe=f.images[S];if(!oe)continue;const R=N+S+1,E=`${g.name.replace(/\.(mobi|azw|azw3)$/i,"")}_image_${String(R).padStart(3,"0")}.png`,$=oe.startsWith("data:")?oe:`data:image/png;base64,${oe}`;n.addImage(E,$)}N+=f.images.length}M=f.has_more??!1}return N}catch(B){throw console.error("MOBI/AZW 解析失败:",B),B}finally{if(_)try{await Wo(_)}catch(B){console.warn("MOBI/AZW 会话清理失败:",B)}}}function F(){T.value=""}return i({triggerFileSelect:Q,processFiles:u,clearError:F}),(g,_)=>(U(),H("div",xa,[e("div",{id:"drop-area",class:Le(["drop-area",{"drag-over":m.value,loading:b.value}]),onDragover:Y,onDragleave:p,onDrop:Z},[e("div",{class:"drop-content"},[e("p",{class:"drop-text"},[_[0]||(_[0]=Fe(" 拖拽图片、PDF或MOBI文件到这里，或 ",-1)),e("span",{class:"select-link",onClick:Q}," 点击选择文件 ")])]),e("input",{ref_key:"fileInputRef",ref:o,type:"file",id:"imageUpload",accept:"image/*,application/pdf,.mobi,.azw,.azw3",multiple:"",class:"file-input",onChange:v},null,544)],34),ne.value?(U(),rt(dn,{key:0,visible:!0,percentage:x.value,label:L.value||"处理中..."},null,8,["percentage","label"])):Te("",!0),T.value?(U(),H("div",{key:1,class:"error-message",onClick:F},[_[1]||(_[1]=e("span",{class:"error-icon"},"⚠️",-1)),e("span",ka,fe(T.value),1),_[2]||(_[2]=e("span",{class:"error-close"},"×",-1))])):Te("",!0),b.value&&!ne.value?(U(),H("div",Sa,[..._[3]||(_[3]=[e("div",{class:"spinner"},null,-1),e("span",{class:"loading-text"},"处理中...",-1)])])):Te("",!0)]))}}),_a=Xe(Ca,[["__scopeId","data-v-4c2bc9df"]]),wa={id:"settings-sidebar",class:"settings-sidebar"},$a={class:"card settings-card"},Ta={id:"font-settings",class:"settings-card collapsible-panel"},Ia={class:"toggle-icon"},Da={class:"collapsible-content"},Ra={class:"settings-form"},Ma={class:"form-group"},Ba=["value","disabled","title"],Ea={class:"auto-fontSize-option",title:"勾选后，首次翻译时自动为每个气泡计算合适的字号"},Pa=["checked"],Aa={class:"form-group"},Fa={class:"form-group"},La={class:"form-group"},Ua=["value"],Oa={class:"form-group"},za={class:"checkbox-label"},Va=["checked"],Na={key:0,id:"strokeOptions",class:"stroke-options"},Wa={class:"form-group"},Ka=["value"],qa={class:"form-group"},Ha=["value"],Ya={class:"form-group"},Ja={key:0,id:"solidColorOptions",class:"form-group"},Xa=["value"],ja={class:"apply-settings-group"},Ga=["disabled"],Za={key:0,class:"apply-options-dropdown"},Qa={class:"apply-option"},es=["checked"],ts={class:"apply-option"},ns={class:"apply-option"},os={class:"apply-option"},as={class:"apply-option"},ss={class:"apply-option"},ls={class:"apply-option"},is={class:"apply-option"},rs={class:"apply-option"},us={class:"action-buttons"},cs=["disabled"],ds=["disabled"],gs=["disabled"],vs=["disabled"],bs=["disabled"],ps=["disabled"],fs=["disabled"],ms=["disabled"],hs={class:"navigation-buttons"},ys=["disabled"],xs=["disabled"],ks=je({__name:"SettingsSidebar",emits:["translateCurrent","translateAll","hqTranslate","proofread","removeText","removeAllText","deleteCurrent","clearAll","cleanTemp","openPlugins","openSettings","previous","next","applyToAll","textStyleChanged"],setup(t,{emit:i}){const l=i,s=at(),n=Qe(),a=h(!0),o=h(!1),b=h({fontSize:!0,fontFamily:!0,layoutDirection:!0,textColor:!0,fillColor:!0,strokeEnabled:!0,strokeColor:!0,strokeWidth:!0}),m=[{label:"自动 (根据检测)",value:"auto"},{label:"竖向排版",value:"vertical"},{label:"横向排版",value:"horizontal"}],T=[{label:"纯色填充",value:"solid"},{label:"LAMA修复 (速度优化)",value:"lama_mpe"},{label:"LAMA修复 (通用)",value:"litelama"}],x=ee(()=>s.currentImage),L=ee(()=>s.hasImages),ne=ee(()=>L.value&&!s.isBatchTranslationInProgress),ie=ee(()=>s.canGoPrevious),Q=ee(()=>s.canGoNext),v=ee(()=>n.textStyle),Z=h([]),Y=["fonts/STSONG.TTF","fonts/msyh.ttc","fonts/simhei.ttf","fonts/simsun.ttc"],p=h(null),u=ee(()=>{const $=Z.value.map(c=>({label:de(c),value:c}));return $.push({label:"自定义字体...",value:"custom-font"}),$});ut(async()=>{await C();const $=v.value.fontFamily;$&&!Z.value.includes($)&&(Z.value=[$,...Z.value])});async function C(){try{const $=await Yn();if($.fonts&&Array.isArray($.fonts)&&$.fonts.length>0){const c=$.fonts[0];if(typeof c=="object"&&"path"in c){const O=$.fonts.map(ce=>typeof ce=="object"?ce.path:ce);Z.value=O}else Z.value=$.fonts}else Z.value=[...Y]}catch($){console.error("加载字体列表失败:",$),Z.value=[...Y]}}function D(){a.value=!a.value}function k($){const c=parseInt($.target.value);isNaN(c)||(n.updateTextStyle({fontSize:c}),l("textStyleChanged","fontSize",c))}function J($){const c=$.target.checked;n.updateTextStyle({autoFontSize:c}),console.log(`自动字号设置变更: ${c} (仅影响下次翻译)`)}async function te($){const c=$.target,O=c.files?.[0];if(!O)return;const ce=[".ttf",".ttc",".otf"],X=O.name.toLowerCase();if(!ce.some(A=>X.endsWith(A))){Re("请选择 .ttf、.ttc 或 .otf 格式的字体文件","error"),c.value="";return}try{const A=await Jo(O);A.success&&A.fontPath?(await C(),n.updateTextStyle({fontFamily:A.fontPath}),Re("字体上传成功","success")):Re(A.error||"字体上传失败","error")}catch(A){console.error("字体上传失败:",A),Re("字体上传失败","error")}finally{c.value=""}}function de($){const c={"fonts/STXINGKA.TTF":"华文行楷","fonts/STXINWEI.TTF":"华文新魏","fonts/STZHONGS.TTF":"华文中宋","fonts/STKAITI.TTF":"楷体","fonts/STLITI.TTF":"隶书","fonts/STSONG.TTF":"华文宋体","fonts/msyh.ttc":"微软雅黑","fonts/msyhbd.ttc":"微软雅黑粗体","fonts/SIMYOU.TTF":"幼圆","fonts/STFANGSO.TTF":"仿宋","fonts/STHUPO.TTF":"华文琥珀","fonts/STXIHEI.TTF":"华文细黑","fonts/simkai.ttf":"中易楷体","fonts/simfang.ttf":"中易仿宋","fonts/simhei.ttf":"中易黑体","fonts/SIMLI.TTF":"中易隶书","fonts/simsun.ttc":"宋体"};if(c[$])return c[$];const O=$.split("/").pop()||$;for(const[ce,X]of Object.entries(c))if((ce.split("/").pop()||"").toLowerCase()===O.toLowerCase())return X;return O.replace(/\.(ttf|ttc|otf)$/i,"")}function F($){if($==="custom-font"){p.value?.click();return}n.updateTextStyle({fontFamily:$}),l("textStyleChanged","fontFamily",$)}function g($){n.updateTextStyle({layoutDirection:$}),l("textStyleChanged","layoutDirection",$)}function _($){n.updateTextStyle({inpaintMethod:$})}function B($){const c=$.target.value;n.updateTextStyle({textColor:c}),l("textStyleChanged","textColor",c)}function q($){const c=$.target.checked;n.updateTextStyle({strokeEnabled:c}),l("textStyleChanged","strokeEnabled",c)}function N($){const c=$.target.value;n.updateTextStyle({strokeColor:c}),l("textStyleChanged","strokeColor",c)}function M($){const c=parseInt($.target.value);isNaN(c)||(n.updateTextStyle({strokeWidth:c}),l("textStyleChanged","strokeWidth",c))}function f($){const c=$.target.value;n.updateTextStyle({fillColor:c}),l("textStyleChanged","fillColor",c)}function S(){o.value=!o.value}function oe(){const c=!Object.values(b.value).every(O=>O);b.value={fontSize:c,fontFamily:c,layoutDirection:c,textColor:c,fillColor:c,strokeEnabled:c,strokeColor:c,strokeWidth:c}}function R(){l("applyToAll",{...b.value}),o.value=!1}function E($){$.target.closest(".apply-settings-group")||(o.value=!1)}return typeof window<"u"&&window.addEventListener("click",E),($,c)=>(U(),H("aside",wa,[e("div",$a,[c[42]||(c[42]=e("h2",null,"翻译设置",-1)),e("div",Ta,[e("h3",{class:"collapsible-header",onClick:D},[c[20]||(c[20]=Fe(" 文字设置 ",-1)),e("span",Ia,fe(a.value?"▼":"▶"),1)]),ae(e("div",Da,[e("div",Ra,[e("div",Ma,[c[22]||(c[22]=e("label",{for:"fontSize"},"字号大小:",-1)),e("input",{type:"number",id:"fontSize",value:v.value.fontSize,min:"10",max:"100",disabled:v.value.autoFontSize,class:Le({"disabled-input":v.value.autoFontSize}),title:v.value.autoFontSize?"已启用自动字号，首次翻译时将自动计算":"",onInput:k},null,42,Ba),e("span",Ea,[e("input",{type:"checkbox",id:"autoFontSize",checked:v.value.autoFontSize,onChange:J},null,40,Pa),c[21]||(c[21]=e("label",{for:"autoFontSize"},"自动计算初始字号",-1))])]),e("div",Aa,[c[23]||(c[23]=e("label",{for:"fontFamily"},"文本字体:",-1)),Ie(We,{"model-value":v.value.fontFamily,options:u.value,onChange:F},null,8,["model-value","options"]),e("input",{ref_key:"fontUploadInput",ref:p,type:"file",id:"fontUpload",accept:".ttf,.ttc,.otf",style:{display:"none"},onChange:te},null,544)]),e("div",Fa,[c[24]||(c[24]=e("label",{for:"layoutDirection"},"排版设置:",-1)),Ie(We,{"model-value":v.value.layoutDirection,options:m,onChange:g},null,8,["model-value"])]),e("div",La,[c[25]||(c[25]=e("label",{for:"textColor"},"文字颜色:",-1)),e("input",{type:"color",id:"textColor",value:v.value.textColor,onInput:B},null,40,Ua)]),e("div",Oa,[e("span",za,[e("input",{type:"checkbox",id:"strokeEnabled",checked:v.value.strokeEnabled,onChange:q},null,40,Va),c[26]||(c[26]=e("label",{for:"strokeEnabled"},"启用文本描边:",-1))])]),Ie(Zt,{name:"stroke-slide"},{default:ht(()=>[v.value.strokeEnabled?(U(),H("div",Na,[e("div",Wa,[c[27]||(c[27]=e("label",{for:"strokeColor"},"描边颜色:",-1)),e("input",{type:"color",id:"strokeColor",value:v.value.strokeColor,onInput:N},null,40,Ka)]),e("div",qa,[c[28]||(c[28]=e("label",{for:"strokeWidth"},"描边宽度 (px):",-1)),e("input",{type:"number",id:"strokeWidth",value:v.value.strokeWidth,min:"0",max:"10",style:{width:"60px",padding:"5px"},onInput:M},null,40,Ha),c[29]||(c[29]=e("div",{class:"input-hint"},"0 表示无描边。",-1))])])):Te("",!0)]),_:1}),e("div",Ya,[c[30]||(c[30]=e("label",{for:"useInpainting"},"气泡填充方式:",-1)),Ie(We,{"model-value":v.value.inpaintMethod,options:T,onChange:_},null,8,["model-value"])]),Ie(Zt,{name:"slide-fade"},{default:ht(()=>[v.value.inpaintMethod==="solid"?(U(),H("div",Ja,[c[31]||(c[31]=e("label",{for:"fillColor"},"填充颜色:",-1)),e("input",{type:"color",id:"fillColor",value:v.value.fillColor,onInput:f},null,40,Xa)])):Te("",!0)]),_:1})]),e("div",ja,[e("button",{type:"button",class:"settings-button",disabled:!L.value,onClick:R}," 应用到全部 ",8,Ga),e("button",{type:"button",class:"settings-gear-btn",title:"选择要应用的参数",onClick:S}," ⚙️ "),o.value?(U(),H("div",Za,[e("div",Qa,[e("input",{type:"checkbox",id:"apply_selectAll",checked:Object.values(b.value).every(O=>O),onChange:oe},null,40,es),c[32]||(c[32]=e("label",{for:"apply_selectAll"},"全选",-1))]),c[41]||(c[41]=e("hr",null,null,-1)),e("div",ts,[ae(e("input",{type:"checkbox",id:"apply_fontSize","onUpdate:modelValue":c[0]||(c[0]=O=>b.value.fontSize=O)},null,512),[[et,b.value.fontSize]]),c[33]||(c[33]=e("label",{for:"apply_fontSize"},"字号",-1))]),e("div",ns,[ae(e("input",{type:"checkbox",id:"apply_fontFamily","onUpdate:modelValue":c[1]||(c[1]=O=>b.value.fontFamily=O)},null,512),[[et,b.value.fontFamily]]),c[34]||(c[34]=e("label",{for:"apply_fontFamily"},"字体",-1))]),e("div",os,[ae(e("input",{type:"checkbox",id:"apply_layoutDirection","onUpdate:modelValue":c[2]||(c[2]=O=>b.value.layoutDirection=O)},null,512),[[et,b.value.layoutDirection]]),c[35]||(c[35]=e("label",{for:"apply_layoutDirection"},"排版方向",-1))]),e("div",as,[ae(e("input",{type:"checkbox",id:"apply_textColor","onUpdate:modelValue":c[3]||(c[3]=O=>b.value.textColor=O)},null,512),[[et,b.value.textColor]]),c[36]||(c[36]=e("label",{for:"apply_textColor"},"文字颜色",-1))]),e("div",ss,[ae(e("input",{type:"checkbox",id:"apply_fillColor","onUpdate:modelValue":c[4]||(c[4]=O=>b.value.fillColor=O)},null,512),[[et,b.value.fillColor]]),c[37]||(c[37]=e("label",{for:"apply_fillColor"},"填充颜色",-1))]),e("div",ls,[ae(e("input",{type:"checkbox",id:"apply_strokeEnabled","onUpdate:modelValue":c[5]||(c[5]=O=>b.value.strokeEnabled=O)},null,512),[[et,b.value.strokeEnabled]]),c[38]||(c[38]=e("label",{for:"apply_strokeEnabled"},"描边开关",-1))]),e("div",is,[ae(e("input",{type:"checkbox",id:"apply_strokeColor","onUpdate:modelValue":c[6]||(c[6]=O=>b.value.strokeColor=O)},null,512),[[et,b.value.strokeColor]]),c[39]||(c[39]=e("label",{for:"apply_strokeColor"},"描边颜色",-1))]),e("div",rs,[ae(e("input",{type:"checkbox",id:"apply_strokeWidth","onUpdate:modelValue":c[7]||(c[7]=O=>b.value.strokeWidth=O)},null,512),[[et,b.value.strokeWidth]]),c[40]||(c[40]=e("label",{for:"apply_strokeWidth"},"描边宽度",-1))])])):Te("",!0)])],512),[[Ke,a.value]])]),e("div",us,[e("button",{id:"translateButton",disabled:!ne.value,onClick:c[8]||(c[8]=O=>l("translateCurrent"))}," 翻译当前图片 ",8,cs),e("button",{id:"translateAllButton",disabled:!ne.value,onClick:c[9]||(c[9]=O=>l("translateAll"))}," 翻译所有图片 ",8,ds),e("button",{id:"startHqTranslationBtn",class:"settings-button purple-button",disabled:!ne.value,title:"使用高质量翻译模式（需在设置中配置）",onClick:c[10]||(c[10]=O=>l("hqTranslate"))}," 高质量翻译 ",8,gs),e("button",{id:"proofreadButton",disabled:!ne.value,onClick:c[11]||(c[11]=O=>l("proofread"))}," AI校对 ",8,vs),e("button",{id:"removeTextOnlyButton",disabled:!x.value,title:"消除图片中的气泡文字，无需填写翻译服务商和API Key",onClick:c[12]||(c[12]=O=>l("removeText"))}," 仅消除文字 ",8,bs),e("button",{id:"removeAllTextButton",disabled:!L.value,title:"消除所有图片中的气泡文字，无需填写翻译服务商和API Key",onClick:c[13]||(c[13]=O=>l("removeAllText"))}," 消除所有图片文字 ",8,ps),e("button",{id:"deleteCurrentImageButton",class:"settings-button red-button",disabled:!x.value,onClick:c[14]||(c[14]=O=>l("deleteCurrent"))}," 删除当前图片 ",8,fs),e("button",{id:"clearAllImagesButton",class:"settings-button red-button",disabled:!L.value,onClick:c[15]||(c[15]=O=>l("clearAll"))}," 清除所有图片 ",8,ms),e("button",{id:"cleanDebugFilesButton",class:"settings-button orange-button",onClick:c[16]||(c[16]=O=>l("cleanTemp"))}," 清理临时文件 "),e("button",{id:"managePluginsButton",class:"settings-button blue-button",onClick:c[17]||(c[17]=O=>l("openPlugins"))}," 插件管理 ")]),e("div",hs,[e("button",{id:"prevImageButton",disabled:!ie.value,onClick:c[18]||(c[18]=O=>l("previous"))}," 上一张 ",8,ys),e("button",{id:"nextImageButton",disabled:!Q.value,onClick:c[19]||(c[19]=O=>l("next"))}," 下一张 ",8,xs)])])]))}}),Ss=Xe(ks,[["__scopeId","data-v-c4828f4a"]]);function $t(t){if(t.textDirection&&t.textDirection!=="auto")return t.textDirection;if(t.autoTextDirection&&t.autoTextDirection!=="auto")return t.autoTextDirection;if(t.coords){const[i,l,s,n]=t.coords;return n-l>s-i?"vertical":"horizontal"}return"vertical"}function Gn(){const t=at(),i=Qe(),l=ct(),s=h(!1),n=h(0),a=h(""),o=h(!1),b=h(0),m=h(""),T=ee(()=>t.hasImages),x=ee(()=>t.hasImages),L=ee(()=>t.hasImages);function ne(){const u=t.images;if(u.length===0){l.warning("没有可导出的图片文本");return}const C=[];for(let g=0;g<u.length;g++){const _=u[g];if(!_)continue;const B=_.bubbleStates||[],q={imageIndex:g,bubbles:[]};for(let N=0;N<B.length;N++){const M=B[N];if(!M)continue;const f=M.originalText||"",S=M.translatedText||M.textboxText||"";let oe="vertical";M.textDirection&&M.textDirection!=="auto"?oe=M.textDirection:M.autoTextDirection&&(oe=M.autoTextDirection),q.bubbles.push({bubbleIndex:N,original:f,translated:S,textDirection:oe})}C.push(q)}const D=JSON.stringify(C,null,2),k=new Blob([D],{type:"application/json"}),J=URL.createObjectURL(k),te=document.createElement("a");te.href=J;const F=new Date().toISOString().replace(/[-:T]/g,"").slice(0,15);te.download=`translations_${F}.json`,document.body.appendChild(te),te.click(),document.body.removeChild(te),URL.revokeObjectURL(J),l.success("文本导出成功！")}function ie(){const u=t.images;if(u.length===0)return null;const C=[];for(let D=0;D<u.length;D++){const k=u[D];if(!k)continue;const J=k.bubbleStates||[],te={imageIndex:D,bubbles:[]};for(let de=0;de<J.length;de++){const F=J[de];if(!F)continue;const g=F.originalText||"",_=F.translatedText||F.textboxText||"";let B="vertical";F.textDirection&&F.textDirection!=="auto"?B=F.textDirection:F.autoTextDirection&&(B=F.autoTextDirection),te.bubbles.push({bubbleIndex:de,original:g,translated:_,textDirection:B})}C.push(te)}return C}async function Q(u){if(!u){l.warning("未选择文件");return}o.value=!0,b.value=0,m.value="准备导入文本...",l.info("正在导入文本...",0);try{const C=await v(u);b.value=10,m.value="解析 JSON 数据...";const D=JSON.parse(C);if(!Array.isArray(D))throw new Error("导入的 JSON 格式不正确，应为数组");let k=0,J=0;const te=i.settings.textStyle,de=te.autoFontSize?"auto":te.fontSize,F=te.fontFamily,g=te.textColor,_=te.fillColor;b.value=20,m.value="开始更新图片...";const B=D.length;let q=0;const N=[];for(const S of D){q++;const oe=20+q/B*60;b.value=oe,m.value=`处理图片 ${q}/${B}`;const R=S.imageIndex;if(R<0||R>=t.images.length){console.warn(`跳过无效的图片索引: ${R}`);continue}const E=t.images[R];if(!E)continue;let $=!1;E.bubbleStates||(E.bubbleStates=[]),E.bubbleTexts||(E.bubbleTexts=[]),E.originalTexts||(E.originalTexts=[]);for(const c of S.bubbles){const O=c.bubbleIndex,ce=c.original,X=c.translated,G=c.textDirection,A=G==="vertical"||G==="horizontal"?G:"vertical";for(;E.bubbleTexts.length<=O;)E.bubbleTexts.push("");for(;E.originalTexts.length<=O;)E.originalTexts.push("");for(ce&&(E.originalTexts[O]=ce),X&&(E.bubbleTexts[O]=X);E.bubbleStates.length<=O;)E.bubbleStates.push(Z(de,F,g,_));const r=E.bubbleStates[O];r&&(ce&&(r.originalText=ce),X&&(r.translatedText=X,r.textboxText=X),r.textDirection=A,$=!0,J++)}$&&E.bubbleStates&&(E.bubbleTexts=E.bubbleStates.map(c=>c.translatedText||"")),$&&(k++,E.hasUnsavedChanges=!0,E.translatedDataURL&&E.bubbleStates&&E.bubbleStates.length>0&&N.push(R))}if(N.length>0){b.value=80,m.value="开始渲染图片...",l.info("正在渲染图片，请稍候...",0);const S=i.settings.textStyle,oe=S.layoutDirection,R=oe==="auto";for(let E=0;E<N.length;E++){const $=N[E];if($===void 0)continue;const c=t.images[$];if(!(!c||!c.bubbleStates)){b.value=80+E/N.length*20,m.value=`渲染图片 ${E+1}/${N.length}`;try{let O="";if(c.cleanImageData?O=c.cleanImageData.includes("base64,")?c.cleanImageData.split("base64,")[1]||"":c.cleanImageData:c.originalDataURL&&(O=c.originalDataURL.includes("base64,")?c.originalDataURL.split("base64,")[1]||"":c.originalDataURL,console.log(`importText: 图片 ${$} 使用原图作为背景（兜底）`)),!O){console.log(`importText: 图片 ${$} 没有可用的背景图，跳过`);continue}const ce=c.bubbleStates.map(G=>({translatedText:G.translatedText||"",coords:G.coords,fontSize:G.fontSize||S.fontSize,fontFamily:G.fontFamily||S.fontFamily,textDirection:$t(G),textColor:G.textColor||S.textColor,rotationAngle:G.rotationAngle||0,position:G.position||{x:0,y:0},strokeEnabled:G.strokeEnabled??S.strokeEnabled,strokeColor:G.strokeColor||S.strokeColor,strokeWidth:G.strokeWidth??S.strokeWidth})),X=await un({clean_image:O,bubble_texts:ce.map(G=>G.translatedText),bubble_coords:ce.map(G=>G.coords),fontSize:S.fontSize,fontFamily:S.fontFamily,textDirection:R?"vertical":oe,textColor:S.textColor,bubble_states:ce,use_individual_styles:!0,use_inpainting:!1,use_lama:!1,is_font_style_change:!0,strokeEnabled:S.strokeEnabled,strokeColor:S.strokeColor,strokeWidth:S.strokeWidth});X.rendered_image&&(t.updateImageByIndex($,{translatedDataURL:`data:image/png;base64,${X.rendered_image}`,hasUnsavedChanges:!0}),console.log(`importText: 图片 ${$} 渲染成功`))}catch(O){console.error(`importText: 重渲染图片 ${$} 失败:`,O)}}}}b.value=100,m.value="导入完成";const M=N.length,f=M>0?`导入成功！更新了 ${k} 张图片中的 ${J} 个气泡文本，重渲染了 ${M} 张图片`:`导入成功！更新了 ${k} 张图片中的 ${J} 个气泡文本`;l.success(f)}catch(C){console.error("导入文本出错:",C),l.error(`导入失败: ${C instanceof Error?C.message:String(C)}`)}finally{o.value=!1,setTimeout(()=>{b.value=0,m.value=""},2e3)}}function v(u){return new Promise((C,D)=>{const k=new FileReader;k.onload=J=>{J.target?.result?C(J.target.result):D(new Error("读取文件失败"))},k.onerror=()=>D(new Error("读取文件时出错")),k.readAsText(u)})}function Z(u,C,D,k){const J=i.settings.textStyle;return{coords:[0,0,100,100],polygon:[],originalText:"",translatedText:"",textboxText:"",fontSize:typeof u=="number"?u:25,fontFamily:C,textDirection:"vertical",autoTextDirection:"vertical",textColor:D,fillColor:k,rotationAngle:0,position:{x:0,y:0},strokeEnabled:J.strokeEnabled,strokeColor:J.strokeColor,strokeWidth:J.strokeWidth,inpaintMethod:J.inpaintMethod}}function Y(){const u=t.currentImage;if(!u){l.warning("没有可下载的图片");return}const C=u.translatedDataURL||u.originalDataURL;if(!C){l.warning("没有可下载的图片");return}s.value=!0;try{const D=C.split(",")[1];if(!D)throw new Error("无效的图片数据");const k=atob(D),J=[];for(let B=0;B<k.length;B+=512){const q=k.slice(B,B+512),N=new Array(q.length);for(let f=0;f<q.length;f++)N[f]=q.charCodeAt(f);const M=new Uint8Array(N);J.push(M.buffer)}const te=new Blob(J,{type:"image/png"}),de=URL.createObjectURL(te),F=document.createElement("a");F.href=de;let g=u.fileName||`image_${t.currentImageIndex}.png`;g=`${u.translatedDataURL?"translated":"original"}_${g.replace(/\.[^/.]+$/,"")}.png`,F.download=g,document.body.appendChild(F),F.click(),document.body.removeChild(F),URL.revokeObjectURL(de),l.success(`下载成功: ${g}`)}catch(D){console.error("下载图片时出错:",D),l.error("下载失败")}finally{s.value=!1}}async function p(u="zip"){const C=t.images;if(C.length===0){l.warning("没有可下载的图片");return}s.value=!0,n.value=0,a.value="准备下载...",l.info("下载中...处理可能需要一定时间，请耐心等待...",0);try{const D=[];let k=0,J=0;n.value=5,a.value="检查图片数据...";for(let f=0;f<C.length;f++){const S=C[f];S&&(S.translatedDataURL?(D.push({index:f,type:"translated"}),k++):S.originalDataURL&&(D.push({index:f,type:"original"}),J++))}if(D.length===0){l.warning("没有可下载的图片");return}n.value=10,a.value="创建下载会话...";const te=await Ko(D.length);if(!te.success||!te.session_id)throw new Error(te.error||"创建会话失败");const de=te.session_id,F=D.length;let g=0,_=0;for(let f=0;f<D.length;f++){const S=D[f];if(!S)continue;const oe=C[S.index];if(!oe)continue;const R=S.type==="translated"?oe.translatedDataURL:oe.originalDataURL;if(!R)continue;const E=10+f/F*70;n.value=E,a.value=`上传图片 ${f+1}/${F}...`;try{const $=await qo(de,R,f);$.success?g++:(console.error(`上传图片 ${f} 失败:`,$.error),_++)}catch($){console.error(`上传图片 ${f} 出错:`,$),_++}}if(g===0)throw new Error("所有图片上传失败");n.value=85,a.value="打包文件...";const B=await Ho(de,u);if(!B.success||!B.file_id)throw new Error(B.error||"打包失败");n.value=95,a.value="准备下载...";const q=Yo(B.file_id,u),N=document.createElement("a");N.href=q,document.body.appendChild(N),N.click(),document.body.removeChild(N),n.value=100,a.value="下载已开始";let M=`已成功处理 ${g} 张图片`;_>0&&(M+=`（${_} 张失败）`),k>0&&J>0?M+=`（${k} 张翻译图片和 ${J} 张原始图片）`:k>0?M+="（全部为翻译后图片）":J>0&&(M+="（全部为原始图片）"),M+="，下载即将开始",l.success(M),setTimeout(async()=>{try{const f=await rn();console.log("临时文件清理结果:",f)}catch(f){console.error("清理临时文件失败:",f)}},6e4)}catch(D){console.error("下载所有图片时出错:",D),l.error(`下载失败: ${D instanceof Error?D.message:String(D)}`)}finally{s.value=!1,setTimeout(()=>{n.value=0,a.value=""},2e3)}}return{isDownloading:s,downloadProgress:n,downloadProgressText:a,isImporting:o,importProgress:b,importProgressText:m,canExportText:T,canImportText:x,canDownload:L,exportText:ne,exportTextToJson:ie,importText:Q,downloadCurrentImage:Y,downloadAllImages:p}}const Cs={key:0,class:"result-section card result-card"},_s={class:"image-controls"},ws={class:"image-size-control"},$s=["value"],Ts={id:"imageSizeValue"},Is={class:"content-container"},Ds={class:"image-container"},Rs=["src"],Ms={id:"detectedTextInfo",class:"text-info"},Bs={id:"detectedTextList"},Es={class:"original-text"},Ps={class:"download-section"},As={class:"download-buttons"},Fs=["disabled"],Ls={class:"download-all-container"},Us=["disabled"],Os={class:"download-format-selector"},zs=["disabled"],Vs=["disabled"],Ns={key:1,class:"empty-state-section"},Xt=60,Ws=je({__name:"ImageResultDisplay",props:{isEditMode:{type:Boolean,default:!1}},emits:["toggle-edit-mode","retry-failed"],setup(t,{emit:i}){const l=[{label:"ZIP压缩包",value:"zip"},{label:"PDF文档",value:"pdf"},{label:"CBZ漫画",value:"cbz"}],s=i,n=at(),a=Qe(),o=Gn(),b=h(100),m=ee({get:()=>v.value?.showOriginal??!1,set:E=>{v.value&&n.updateCurrentImage({showOriginal:E})}}),T=h("zip"),x=h(null),L=ee(()=>o.isDownloading.value),ne=ee(()=>o.downloadProgressText.value),ie=ee(()=>o.downloadProgress.value),Q=ee(()=>n.hasImages),v=ee(()=>n.currentImage),Z=ee(()=>!!v.value?.translatedDataURL),Y=ee(()=>!!(v.value?.translatedDataURL||v.value?.originalDataURL)),p=ee(()=>v.value?m.value||!v.value.translatedDataURL?v.value.originalDataURL:v.value.translatedDataURL:""),u=ee(()=>n.failedImageCount>0),C=ee(()=>({width:`${b.value}%`})),D=ee(()=>a.settings.useTextboxPrompt),k=ee(()=>{if(!v.value)return[];if(v.value.bubbleStates&&v.value.bubbleStates.length>0)return v.value.bubbleStates.map(c=>({original:c.originalText||"",translated:D.value?c.textboxText||c.translatedText||"":c.translatedText||""}));const E=v.value.originalTexts||[],$=D.value?v.value.textboxTexts||v.value.bubbleTexts||[]:v.value.bubbleTexts||[];return E.length===0?[]:E.map((c,O)=>({original:c||"",translated:$[O]||""}))}),J=ee(()=>k.value.length>0);function te(E){if(!E||E.length<=Xt)return E;let $="",c="";for(let O=0;O<E.length;O++)if(c+=E[O],c.length>=Xt){let ce=-1;for(let X=c.length-1;X>=0;X--){const G=c[X];if(G&&["。","！","？",".","!","?","；",";","，",","].includes(G)){ce=X+1;break}}ce>Xt*.6?($+=c.substring(0,ce)+`
`,c=c.substring(ce)):($+=c+`
`,c="")}return c&&($+=c),$}function de(E){return te((E||"").trim())}function F(E){const $=(E||"").trim();return te($)}function g(E){return(E||"").includes("翻译失败")}function _(){m.value=!m.value}function B(){s("toggle-edit-mode")}function q(E){const $=E.target;b.value=parseInt($.value,10)}function N(){s("retry-failed")}function M(){o.downloadCurrentImage()}function f(){o.downloadAllImages(T.value)}function S(){o.exportText()}function oe(){x.value?.click()}async function R(E){const $=E.target,c=$.files?.[0];c&&(await o.importText(c),$.value="")}return(E,$)=>v.value?(U(),H("section",Cs,[e("div",_s,[Z.value?(U(),H("button",{key:0,id:"toggleImageButton",class:"control-btn",onClick:_},fe(m.value?"查看翻译图":"查看原图"),1)):Te("",!0),e("button",{id:"toggleEditModeButton",class:Le(["control-btn",{active:t.isEditMode}]),onClick:B},fe(t.isEditMode?"退出编辑":"切换编辑模式"),3),e("div",ws,[$[1]||($[1]=e("label",{for:"imageSize"},"图片大小:",-1)),e("input",{type:"range",id:"imageSize",min:"50",max:"200",value:b.value,class:"slider range-slider",onInput:q},null,40,$s),e("span",Ts,fe(b.value)+"%",1)]),u.value?(U(),H("button",{key:1,id:"retranslateFailedButton",class:"retry-failed-btn",onClick:N,title:"重新翻译所有失败的图片"}," 重新翻译失败图片 ("+fe(ve(n).failedImageCount)+") ",1)):Te("",!0)]),e("div",Is,[e("div",Ds,[e("img",{id:"translatedImageDisplay",src:p.value,alt:"翻译后图片",style:st(C.value)},null,12,Rs)])]),e("div",Ms,[$[18]||($[18]=e("h3",null,"检测到的文本（原文 → 译文）",-1)),e("pre",Bs,[$[16]||($[16]=Fe("        ",-1)),J.value?(U(),H(Ge,{key:0},[$[14]||($[14]=Fe(`
          `,-1)),(U(!0),H(Ge,null,tt(k.value,(c,O)=>(U(),H("span",{key:O,class:"text-item"},[$[2]||($[2]=Fe(`
            `,-1)),e("span",Es,fe(de(c.original)),1),$[3]||($[3]=Fe(`
            `,-1)),$[4]||($[4]=e("br",null,null,-1)),$[5]||($[5]=Fe(`
            `,-1)),e("span",{class:Le(["translated-text",{"translation-error":g(c.translated)}])},fe(F(c.translated)),3),$[6]||($[6]=Fe(`
            `,-1)),$[7]||($[7]=e("br",null,null,-1)),$[8]||($[8]=Fe(`
            `,-1)),$[9]||($[9]=e("span",{class:"separator"},"──────────────────────────",-1)),$[10]||($[10]=Fe(`
            `,-1)),$[11]||($[11]=e("br",null,null,-1)),$[12]||($[12]=e("br",null,null,-1)),$[13]||($[13]=Fe(`
          `,-1))]))),128)),$[15]||($[15]=Fe(`
        `,-1))],64)):(U(),H(Ge,{key:1},[Fe("未检测到文本或尚未翻译")],64)),$[17]||($[17]=Fe(`
      `,-1))])]),e("div",Ps,[L.value?(U(),rt(dn,{key:0,visible:!0,percentage:ie.value,label:ne.value||"下载中，请稍候..."},null,8,["percentage","label"])):Te("",!0),e("div",As,[e("button",{id:"downloadButton",class:"download-btn primary",disabled:!Y.value,onClick:M}," 下载当前图片 ",8,Fs),e("div",Ls,[e("button",{id:"downloadAllImagesButton",class:"download-btn primary",disabled:!Q.value,onClick:f}," 下载所有图片 ",8,Us),e("div",Os,[Ie(We,{modelValue:T.value,"onUpdate:modelValue":$[0]||($[0]=c=>T.value=c),options:l},null,8,["modelValue"])])]),e("button",{id:"exportTextButton",class:"download-btn success",disabled:!Q.value,onClick:S}," 导出文本 ",8,zs),e("button",{id:"importTextButton",class:"download-btn success",disabled:!Q.value,onClick:oe}," 导入文本 ",8,Vs),e("input",{type:"file",ref_key:"importFileInput",ref:x,id:"importTextFileInput",style:{display:"none"},accept:".json",onChange:R},null,544)])])])):(U(),H("section",Ns))}}),Ks=Xe(Ws,[["__scopeId","data-v-0e053400"]]),qs={class:"guide-content"},Hs={class:"guide-footer"},Ys={class:"dont-show-option"},Dt="saber_translator_dismiss_setup_reminder",Js=je({__name:"FirstTimeGuide",emits:["openSettings"],setup(t,{expose:i,emit:l}){const s=l,n=h(!1),a=h(!1);ut(()=>{localStorage.getItem(Dt)!=="true"&&(n.value=!0)});function o(){a.value&&localStorage.setItem(Dt,"true"),n.value=!1}function b(){localStorage.setItem(Dt,"true"),n.value=!1,s("openSettings")}function m(){localStorage.removeItem(Dt)}return i({resetGuideState:m,showGuide:n}),(T,x)=>(U(),rt(Jn,{"model-value":n.value,title:"欢迎使用 Saber-Translator",onClose:o},{default:ht(()=>[e("div",qs,[x[3]||(x[3]=e("div",{class:"guide-icon"},"🎉",-1)),x[4]||(x[4]=e("div",{class:"guide-message"},[e("p",{class:"guide-title"},"首次使用提醒"),e("p",{class:"guide-text"}," 在开始翻译之前，请先配置翻译服务。 "),e("p",{class:"guide-text"},[Fe(" 点击右上角的 "),e("span",{class:"highlight"},"⚙️ 设置"),Fe(" 按钮，配置以下内容： ")]),e("ul",{class:"guide-list"},[e("li",null,"选择 OCR 引擎（文字识别）"),e("li",null,"配置翻译服务商和 API Key"),e("li",null,"（可选）配置高质量翻译和 AI 校对")])],-1)),e("div",{class:"guide-actions"},[e("button",{class:"guide-btn primary",onClick:b},[...x[1]||(x[1]=[e("span",{class:"btn-icon"},"⚙️",-1),Fe(" 立即配置 ",-1)])]),e("button",{class:"guide-btn secondary",onClick:o}," 稍后配置 ")]),e("div",Hs,[e("label",Ys,[ae(e("input",{type:"checkbox","onUpdate:modelValue":x[0]||(x[0]=L=>a.value=L)},null,512),[[et,a.value]]),x[2]||(x[2]=e("span",null,"不再显示此提醒",-1))])])])]),_:1},8,["model-value"]))}}),Xs=Xe(Js,[["__scopeId","data-v-7d6446be"]]),jt="saber_translator_dismiss_setup_reminder",js=["siliconflow","deepseek","volcano","caiyun","baidu_translate","youdao_translate","gemini","custom_openai"],Gs={manga_ocr:"MangaOCR",paddle_ocr:"PaddleOCR",baidu_ocr:"百度OCR",ai_vision:"AI视觉OCR"},Zs=["ollama","sakura"],Qs=["custom_openai"],el=["custom_openai"],tl={siliconflow:"SiliconFlow",deepseek:"DeepSeek",volcano:"火山引擎",caiyun:"彩云小译",baidu_translate:"百度翻译",youdao_translate:"有道翻译",gemini:"Google Gemini",custom_openai:"自定义 OpenAI",ollama:"Ollama",sakura:"Sakura"};function Zn(){const t=Qe(),i=ct(),l=h(!1),s=h(!1),n=ee(()=>{try{return localStorage.getItem(jt)==="true"}catch{return!1}});function a(k){return tl[k]||k}function o(k){return js.includes(k)}function b(k){return Zs.includes(k)}function m(k){return Qs.includes(k)}function T(k){return el.includes(k)}function x(k){return Gs[k]||k}function L(){const k=t.settings,J=k.ocrEngine,te=k.baiduOcr,de=k.aiVisionOcr,F=[];return J?(J==="baidu_ocr"&&((!te?.apiKey||te.apiKey.trim()==="")&&F.push("百度OCR 的 API Key"),(!te?.secretKey||te.secretKey.trim()==="")&&F.push("百度OCR 的 Secret Key")),J==="ai_vision"&&(de?.provider||F.push("AI视觉OCR 的服务商"),(!de?.apiKey||de.apiKey.trim()==="")&&F.push("AI视觉OCR 的 API Key"),(!de?.modelName||de.modelName.trim()==="")&&F.push("AI视觉OCR 的模型名称"),de?.provider==="custom"&&(!de?.customBaseUrl||de.customBaseUrl.trim()==="")&&F.push("AI视觉OCR 的自定义 Base URL")),F.length>0?{valid:!1,message:`请先在顶部 ⚙️ 设置菜单中填写 ${F[0]}`,missingItems:F}:{valid:!0,message:""}):{valid:!1,message:"请先在顶部 ⚙️ 设置菜单中选择 OCR 引擎",missingItems:["OCR 引擎"]}}function ne(){const{translation:k}=t.settings,{provider:J,apiKey:te,modelName:de,customBaseUrl:F}=k,g=[];return J?(o(J)&&(!te||te.trim()==="")&&g.push(`${a(J)} 的 API Key`),(!de||de.trim()==="")&&(b(J)||o(J))&&g.push(`${a(J)} 的模型名称`),m(J)&&(!F||F.trim()==="")&&g.push("自定义 OpenAI 服务的 Base URL"),g.length>0?{valid:!1,message:`请先在顶部 ⚙️ 设置菜单中填写 ${g[0]}`,missingItems:g}:{valid:!0,message:""}):{valid:!1,message:"请先在顶部 ⚙️ 设置菜单中选择翻译服务商",missingItems:["翻译服务商"]}}function ie(){const{hqTranslation:k}=t.settings,{provider:J,apiKey:te,modelName:de,customBaseUrl:F}=k,g=[];return J?((!te||te.trim()==="")&&g.push("高质量翻译的 API Key"),(!de||de.trim()==="")&&g.push("高质量翻译的模型名称"),T(J)&&(!F||F.trim()==="")&&g.push("高质量翻译的 Base URL"),g.length>0?{valid:!1,message:`请先在顶部 ⚙️ 设置菜单中填写 ${g[0]}`,missingItems:g}:{valid:!0,message:""}):{valid:!1,message:"请先在顶部 ⚙️ 设置菜单中选择高质量翻译的服务商",missingItems:["高质量翻译服务商"]}}function Q(k){const J=k||t.settings.proofreading.rounds,te=[];if(!J||J.length===0)return{valid:!1,message:"请先在顶部 ⚙️ 设置菜单中添加至少一个校对轮次",missingItems:["校对轮次"]};for(let de=0;de<J.length;de++){const F=J[de];if(!F)continue;const g=F.name||`轮次${de+1}`;if(F.provider||te.push(`校对 ${g} 的服务商`),(!F.apiKey||F.apiKey.trim()==="")&&te.push(`校对 ${g} 的 API Key`),(!F.modelName||F.modelName.trim()==="")&&te.push(`校对 ${g} 的模型名称`),te.length>0)return{valid:!1,message:`请先在顶部 ⚙️ 设置菜单中为 ${te[0]}`,missingItems:te}}return{valid:!0,message:""}}function v(k="normal",J={}){let te;switch(k){case"normal":te=ne();break;case"hq":te=ie();break;case"proofread":te=Q(J.proofreadingRounds);break;case"ocr":te=L();break;default:te=ne()}return te.valid?!0:(i.error(te.message),Y(),!1)}function Z(){const k=L();if(!k.valid)return i.error(k.message),Y(),!1;const J=ne();return J.valid?!0:(i.error(J.message),Y(),!1)}function Y(){const k=document.getElementById("openSettingsBtn");k&&(s.value=!0,k.style.animation="settingsBtnPulse 0.5s ease-in-out 3",k.style.boxShadow="0 0 10px var(--primary-color, #4a90d9)",setTimeout(()=>{k.style.animation="",k.style.boxShadow="",s.value=!1},3e3))}function p(){if(n.value){console.log("用户已选择不再显示设置提醒");return}l.value=!0}function u(k=!1){if(k)try{localStorage.setItem(jt,"true"),console.log("用户选择永久关闭设置提醒")}catch(J){console.error("保存设置提醒状态失败:",J)}l.value=!1}function C(){try{localStorage.removeItem(jt),console.log("设置提醒状态已重置")}catch(k){console.error("重置设置提醒状态失败:",k)}}function D(){setTimeout(()=>{p()},500)}return{showSetupReminder:l,isSettingsButtonHighlighted:s,isSetupReminderDismissed:n,validateOcrConfig:L,validateTranslationConfig:ne,validateHqTranslationConfig:ie,validateProofreadingConfig:Q,validateBeforeTranslation:v,validateFullTranslationConfig:Z,highlightSettingsButton:Y,checkAndShowSetupReminder:p,closeSetupReminder:u,resetSetupReminderDismiss:C,initValidation:D,getProviderDisplayName:a,getOcrEngineDisplayName:x,requiresApiKey:o,isLocalProvider:b,requiresBaseUrl:m}}const Rt={originalText:"",translatedText:"",textboxText:"",coords:[0,0,100,100],polygon:[],fontSize:25,fontFamily:"fonts/STSONG.TTF",textDirection:"auto",autoTextDirection:"vertical",textColor:"#000000",fillColor:Kn,rotationAngle:0,position:{x:0,y:0},strokeEnabled:sn,strokeColor:an,strokeWidth:on,inpaintMethod:"solid"};function nn(t){return{...{...Rt,...t},coords:t?.coords?[...t.coords]:[...Rt.coords],polygon:t?.polygon?t.polygon.map(l=>[...l]):[],position:t?.position?{...Rt.position,...t.position}:{...Rt.position}}}function Qn(t){const[i,l,s,n]=t,a=Math.abs(s-i);return Math.abs(n-l)>a?"vertical":"horizontal"}function zn(t,i){const{bubble_coords:l=[],bubble_states:s=[],original_texts:n=[],bubble_texts:a=[],textbox_texts:o=[],bubble_angles:b=[],auto_directions:m=[]}=t;return s.length>0?s.map((T,x)=>({...nn(i),...T,coords:T.coords||l[x]||[0,0,100,100]})):l.map((T,x)=>{let L;return m[x]?L=m[x]==="v"?"vertical":"horizontal":L=Qn(T),nn({coords:T,originalText:n[x]||"",translatedText:a[x]||"",textboxText:o[x]||"",rotationAngle:b[x]||0,autoTextDirection:L,...i})})}function Mt(t){return t.map(i=>({...i,coords:[...i.coords],polygon:i.polygon?i.polygon.map(l=>[...l]):[],position:{...i.position}}))}function nl(t){if(!t||typeof t!="object")return!1;const i=t;if(!Array.isArray(i.coords)||i.coords.length!==4||!i.coords.every(n=>typeof n=="number"&&!isNaN(n))||typeof i.fontSize!="number"||i.fontSize<=0)return!1;const l=["vertical","horizontal","auto"];if(typeof i.textDirection!="string"||!l.includes(i.textDirection))return!1;const s=["solid","lama_mpe","litelama"];return!(typeof i.inpaintMethod!="string"||!s.includes(i.inpaintMethod))}const gt=ln("bubble",()=>{const t=h([]),i=h(-1),l=h([]),s=h([]),n=h(!1),a=h(-1),o=h(0),b=h(0),m=h(0),T=h(0),x=h(!1),L=h(-1),ne=h(null),ie=h(!1),Q=h(-1),v=h(0),Z=ee(()=>i.value>=0&&i.value<t.value.length?t.value[i.value]??null:null),Y=ee(()=>t.value.length),p=ee(()=>t.value.length>0),u=ee(()=>i.value>=0),C=ee(()=>l.value.length>1),D=ee(()=>l.value.filter(r=>r>=0&&r<t.value.length).map(r=>t.value[r]).filter(r=>r!==void 0));function k(){const y=at().currentImage;y&&(y.bubbleStates=Mt(t.value),y.hasUnsavedChanges=!0,console.log("气泡状态已同步到当前图片"))}function J(r,y=!1){t.value=r,s.value=Mt(r),N(),console.log(`气泡数组已设置，共 ${r.length} 个气泡`),y||k()}function te(r,y){const w=Qn(r),se=Qe().settings.textStyle,ge=se.layoutDirection,re=ge==="auto"?"vertical":ge||"vertical",le=nn({coords:r,translatedText:"",autoTextDirection:w,fontSize:se.fontSize,fontFamily:se.fontFamily,textDirection:re,textColor:se.textColor,fillColor:se.fillColor,inpaintMethod:se.inpaintMethod,strokeEnabled:se.strokeEnabled,strokeColor:se.strokeColor,strokeWidth:se.strokeWidth,rotationAngle:0,position:{x:0,y:0},...y});return t.value.push(le),console.log(`已添加气泡，当前共 ${t.value.length} 个`),k(),le}function de(r){return r<0||r>=t.value.length?(console.warn(`删除失败: 无效的索引 ${r}`),!1):(t.value.splice(r,1),i.value===r?i.value=-1:i.value>r&&i.value--,l.value=l.value.filter(y=>y!==r).map(y=>y>r?y-1:y),console.log(`已删除气泡，当前共 ${t.value.length} 个`),k(),!0)}function F(){if(l.value.length===0&&i.value<0)return;const r=[...new Set([...l.value,i.value])].filter(y=>y>=0).sort((y,w)=>w-y);for(const y of r)t.value.splice(y,1);N(),console.log(`已删除 ${r.length} 个气泡`),k()}function g(){t.value=[],s.value=[],N(),console.log("所有气泡已清除"),k()}function _(){t.value=[],s.value=[],N(),console.log("本地气泡状态已清除（不同步到imageStore）")}function B(r){r>=-1&&r<t.value.length&&(i.value=r,l.value=r>=0?[r]:[],console.log(`已选中气泡 ${r}`))}function q(r){if(r<0||r>=t.value.length)return;const y=l.value.indexOf(r);y>=0?(l.value.splice(y,1),i.value===r&&(i.value=l.value[0]??-1)):(l.value.push(r),i.value=r),console.log(`多选状态: ${l.value.join(", ")}`)}function N(){i.value=-1,l.value=[]}function M(){i.value>=0?l.value=[i.value]:l.value=[]}function f(){if(t.value.length===0)return!1;const r=i.value<t.value.length-1?i.value+1:0;return B(r),!0}function S(){if(t.value.length===0)return!1;const r=i.value>0?i.value-1:t.value.length-1;return B(r),!0}function oe(r,y){if(r<0||r>=t.value.length)return console.warn(`更新失败: 无效的索引 ${r}`),!1;const w=t.value[r];return w?(Object.assign(w,y),console.log(`已更新气泡 ${r}`),k(),!0):!1}function R(r){return i.value<0?(console.warn("更新失败: 没有选中的气泡"),!1):oe(i.value,r)}function E(r){const y=l.value.length>0?l.value:i.value>=0?[i.value]:[];for(const w of y){const P=t.value[w];P&&Object.assign(P,r)}k(),console.log(`已批量更新 ${y.length} 个气泡`)}function $(r){for(let y=0;y<t.value.length;y++){const w=t.value[y];w&&Object.assign(w,r)}k(),console.log(`已更新所有 ${t.value.length} 个气泡`)}function c(){if(t.value.length!==s.value.length)return!0;for(let r=0;r<t.value.length;r++){const y=t.value[r],w=s.value[r];if(!(!y||!w)&&(y.translatedText!==w.translatedText||y.textboxText!==w.textboxText||y.fontSize!==w.fontSize||y.fontFamily!==w.fontFamily||y.textDirection!==w.textDirection||y.textColor!==w.textColor||y.fillColor!==w.fillColor||y.rotationAngle!==w.rotationAngle||y.strokeEnabled!==w.strokeEnabled||y.strokeColor!==w.strokeColor||y.strokeWidth!==w.strokeWidth||y.inpaintMethod!==w.inpaintMethod||JSON.stringify(y.coords)!==JSON.stringify(w.coords)))return!0}return!1}function O(){t.value=Mt(s.value),N(),console.log("气泡状态已重置到初始状态")}function ce(){s.value=Mt(t.value),console.log("当前状态已保存为初始状态")}function X(){return{bubble_coords:t.value.map(r=>r.coords),bubble_texts:t.value.map(r=>r.translatedText),textbox_texts:t.value.map(r=>r.textboxText),font_sizes:t.value.map(r=>r.fontSize),font_families:t.value.map(r=>r.fontFamily),text_directions:t.value.map(r=>r.textDirection==="auto"?r.autoTextDirection==="vertical"?"v":"h":r.textDirection==="vertical"?"v":"h"),text_colors:t.value.map(r=>r.textColor),fill_colors:t.value.map(r=>r.fillColor),rotation_angles:t.value.map(r=>r.rotationAngle),stroke_enabled:t.value.map(r=>r.strokeEnabled),stroke_colors:t.value.map(r=>r.strokeColor),stroke_widths:t.value.map(r=>r.strokeWidth),inpaint_methods:t.value.map(r=>r.inpaintMethod)}}function G(){return JSON.stringify(t.value)}function A(r){try{const y=JSON.parse(r);if(!Array.isArray(y))return console.error("反序列化失败: 数据不是数组"),!1;const w=[];for(const P of y)nl(P)?w.push(P):console.warn("跳过无效的气泡状态:",P);return J(w),!0}catch(y){return console.error("反序列化失败:",y),!1}}return{bubbles:t,selectedIndex:i,selectedIndices:l,initialStates:s,isDragging:n,draggingIndex:a,dragOffsetX:o,dragOffsetY:b,dragInitialX:m,dragInitialY:T,isResizing:x,resizingIndex:L,resizeCurrentCoords:ne,isRotating:ie,rotatingIndex:Q,rotateCurrentAngle:v,selectedBubble:Z,bubbleCount:Y,hasBubbles:p,hasSelection:u,isMultiSelect:C,selectedBubbles:D,setBubbles:J,addBubble:te,deleteBubble:de,deleteSelected:F,clearBubbles:g,clearBubblesLocal:_,selectBubble:B,toggleMultiSelect:q,clearSelection:N,clearMultiSelect:M,selectNext:f,selectPrevious:S,updateBubble:oe,updateSelectedBubble:R,updateAllSelected:E,updateAllBubbles:$,hasChanges:c,resetToInitial:O,saveAsInitial:ce,toApiRequest:X,serialize:G,deserialize:A}}),ol=Object.freeze(Object.defineProperty({__proto__:null,useBubbleStore:gt},Symbol.toStringTag,{value:"Module"}));function Gt(t){let i=t,l=0,s=0,n=Date.now();const a=()=>i<=0?0:Math.ceil(6e4/i);return{async acquire(){if(i<=0)return;const o=Date.now(),b=a();if(o-n>=6e4&&(n=o,s=0),s>=i){const T=6e4-(o-n);T>0&&await Vn(T),n=Date.now(),s=0}const m=o-l;m<b&&await Vn(b-m),l=Date.now(),s++},reset(){l=0,s=0,n=Date.now()},getRpm(){return i},setRpm(o){i=o,this.reset()}}}function Vn(t){return new Promise(i=>setTimeout(i,t))}function gn(){const t=at(),i=Qe(),l=gt(),s=Zn(),n=ct(),a=h(null),o=h({current:0,total:0,completed:0,failed:0,isInProgress:!1,isPaused:!1}),b=h(!1),m=h(!1),T=h(!1),x=ee(()=>b.value||t.isBatchTranslationInProgress||m.value||T.value),L=ee(()=>o.value.total===0?0:Math.round(o.value.completed/o.value.total*100));function ne(){const A=i.settings.translation.rpmLimit;a.value?a.value.setRpm(A):a.value=Gt(A)}function ie(A){return A.includes(",")&&A.split(",")[1]||A}function Q(A,r={}){const{settings:y}=i,{textStyle:w,translation:P,baiduOcr:se,aiVisionOcr:ge,boxExpand:re,preciseMask:le}=y,I={image:ie(A),ocr_engine:y.ocrEngine,source_language:y.sourceLanguage,model_provider:P.provider,api_key:P.apiKey,model_name:P.modelName,custom_base_url:P.customBaseUrl,target_language:y.targetLanguage,prompt_content:y.translatePrompt,textbox_prompt_content:y.textboxPrompt,use_textbox_prompt:y.useTextboxPrompt,rpm_limit_translation:P.rpmLimit,max_retries:P.maxRetries,use_json_format_translation:P.isJsonMode,detector_type:y.textDetector,box_expand_ratio:re.ratio,box_expand_top:re.top,box_expand_bottom:re.bottom,box_expand_left:re.left,box_expand_right:re.right,usePreciseMask:le.enabled,maskDilateSize:le.dilateSize,maskBoxExpandRatio:le.boxExpandRatio,fontSize:w.autoFontSize?"auto":w.fontSize,autoFontSize:w.autoFontSize,fontFamily:w.fontFamily,textDirection:w.layoutDirection==="auto"?"vertical":w.layoutDirection,autoTextDirection:w.layoutDirection==="auto",textColor:w.textColor,fillColor:w.fillColor,strokeEnabled:w.strokeEnabled,strokeColor:w.strokeColor,strokeWidth:w.strokeWidth,use_inpainting:!1,use_lama:w.inpaintMethod==="lama_mpe"||w.inpaintMethod==="litelama",lamaModel:w.inpaintMethod==="litelama"?"litelama":"lama_mpe",showDetectionDebug:y.showDetectionDebug,remove_only:r.removeTextOnly,skip_translation:r.removeTextOnly,bubble_coords:r.existingBubbleCoords,bubble_angles:r.existingBubbleAngles};return y.ocrEngine==="baidu_ocr"&&(I.baidu_api_key=se.apiKey,I.baidu_secret_key=se.secretKey,I.baidu_version=se.version,I.baidu_ocr_language=se.sourceLanguage),y.ocrEngine==="ai_vision"&&(I.ai_vision_provider=ge.provider,I.ai_vision_api_key=ge.apiKey,I.ai_vision_model_name=ge.modelName,I.ai_vision_ocr_prompt=ge.prompt,I.rpm_limit_ai_vision_ocr=ge.rpmLimit,I.custom_ai_vision_base_url=ge.customBaseUrl,I.use_json_format_ai_vision_ocr=ge.isJsonMode),I}function v(A,r,y={}){if(r.error||!r.translated_image){t.setTranslationStatus(A,"failed",r.error||"翻译失败");return}const{settings:w}=i,{textStyle:P}=w;let se=null;if(r.bubble_coords&&r.bubble_coords.length>0){const le={bubble_coords:r.bubble_coords,bubble_states:r.bubble_states,original_texts:r.original_texts,bubble_texts:r.bubble_texts,textbox_texts:r.textbox_texts,bubble_angles:r.bubble_angles,auto_directions:r.auto_directions},I={fontSize:P.fontSize,fontFamily:P.fontFamily,textDirection:P.layoutDirection==="auto"?"vertical":P.layoutDirection,textColor:P.textColor,fillColor:P.fillColor,strokeEnabled:P.strokeEnabled,strokeColor:P.strokeColor,strokeWidth:P.strokeWidth,inpaintMethod:P.inpaintMethod};se=zn(le,I)}const ge=r.translated_image?`data:image/png;base64,${r.translated_image}`:null,re=i.settings.textStyle.layoutDirection;t.updateImageByIndex(A,{translatedDataURL:ge,cleanImageData:r.clean_image||null,bubbleStates:se,bubbleCoords:r.bubble_coords,bubbleAngles:r.bubble_angles||[],originalTexts:r.original_texts,textboxTexts:r.textbox_texts||[],bubbleTexts:se?.map(le=>le.translatedText||"")||[],userLayoutDirection:re,translationStatus:"completed",translationFailed:!1,hasUnsavedChanges:!0}),A===t.currentImageIndex&&se&&l.setBubbles(se)}async function Z(A={}){if(A.removeTextOnly){if(!s.validateBeforeTranslation("ocr"))return!1}else if(!s.validateBeforeTranslation("normal"))return!1;const r=t.currentImage;if(!r)return n.error("请先上传图片"),!1;b.value=!0,t.setTranslationStatus(t.currentImageIndex,"processing");const y=n.showGeneralMessage("翻译中...","info",!1,0);try{ne(),a.value&&await a.value.acquire();const w={...A},P=Array.isArray(r.bubbleStates),se=Array.isArray(r.bubbleCoords),ge=P||se;if(!w.existingBubbleCoords&&ge){let I,d;P&&r.bubbleStates.length>0?(I=r.bubbleStates.map(z=>z.coords),d=r.bubbleStates.map(z=>z.rotationAngle||0)):P&&r.bubbleStates.length===0?(I=[],d=[]):se&&r.bubbleCoords.length>0?(I=r.bubbleCoords,d=r.bubbleAngles):se&&r.bubbleCoords.length===0&&(I=[],d=[]),I&&I.length>0?(w.existingBubbleCoords=I,w.existingBubbleAngles=d,w.useExistingBubbles=!0,console.log(`翻译当前图片: 使用 ${I.length} 个已有的文本框`),n.info("使用已有的文本框进行翻译...",3e3)):I&&I.length===0&&(console.log("翻译当前图片: 文本框已被用户清空，将跳过翻译"),n.info("该图片无文本框，跳过翻译",3e3),w.existingBubbleCoords=[],w.existingBubbleAngles=[],w.useExistingBubbles=!0)}const re=Q(r.originalDataURL,w),le=await Et(re);return n.clearGeneralMessageById(y),v(t.currentImageIndex,le,A),le.translated_image&&!le.error?(n.success("翻译成功！"),!0):(n.error(le.error||"翻译失败"),!1)}catch(w){n.clearGeneralMessageById(y);const P=w instanceof Error?w.message:"翻译请求失败";return t.markCurrentAsFailed(P),n.error(P),!1}finally{b.value=!1}}async function Y(A,r={}){const y=t.images[A];if(!y)return console.error(`图片索引 ${A} 不存在`),!1;t.setTranslationStatus(A,"processing");try{a.value&&await a.value.acquire();const w={...r},P=Array.isArray(y.bubbleStates),se=Array.isArray(y.bubbleCoords),ge=P||se;if(!w.existingBubbleCoords&&ge){let I,d;P&&y.bubbleStates.length>0?(I=y.bubbleStates.map(z=>z.coords),d=y.bubbleStates.map(z=>z.rotationAngle||0)):P&&y.bubbleStates.length===0?(I=[],d=[]):se&&y.bubbleCoords.length>0?(I=y.bubbleCoords,d=y.bubbleAngles):se&&y.bubbleCoords.length===0&&(I=[],d=[]),I&&I.length>0?(w.existingBubbleCoords=I,w.existingBubbleAngles=d,w.useExistingBubbles=!0,console.log(`批量翻译图片 ${A}: 将使用 ${I.length} 个已有的文本框`)):I&&I.length===0&&(console.log(`批量翻译图片 ${A}: 文本框已被用户清空，跳过此图片的翻译`),w.existingBubbleCoords=[],w.existingBubbleAngles=[],w.useExistingBubbles=!0)}const re=Q(y.originalDataURL,w),le=await Et(re);return v(A,le,r),!!le.translated_image&&!le.error}catch(w){const P=w instanceof Error?w.message:"翻译请求失败";return t.setTranslationStatus(A,"failed",P),!1}}async function p(A={}){if(A.removeTextOnly){if(!s.validateBeforeTranslation("ocr"))return!1}else if(!s.validateBeforeTranslation("normal"))return!1;const r=t.images;if(r.length===0)return n.error("请先上传图片"),!1;const y=A.removeTextOnly===!0;o.value={current:0,total:r.length,completed:0,failed:0,isInProgress:!0,isPaused:!1,label:y?`消除文字: 0/${r.length}`:`0/${r.length}`,percentage:0},t.setBatchTranslationInProgress(!0),ne(),n.info(y?`开始消除 ${r.length} 张图片文字...`:`开始批量翻译 ${r.length} 张图片...`);let w=!0;try{for(let P=0;P<r.length;P++){if(t.isBatchTranslationPaused&&await new Promise(ge=>{t.setBatchTranslationResumeCallback(ge)}),!t.isBatchTranslationInProgress){console.log("批量翻译已取消");break}o.value.current=P+1,o.value.label=y?`消除文字: ${P+1}/${r.length}`:`${P+1}/${r.length}`,o.value.percentage=Math.round((P+1)/r.length*100),await Y(P,A)?o.value.completed++:(o.value.failed++,w=!1)}return o.value.failed>0?n.warning(y?`消除文字完成，${o.value.failed} 张图片失败`:`翻译完成，${o.value.failed} 张图片失败`):n.success(y?"所有图片文字消除完成":"所有图片翻译完成"),w}catch(P){const se=P instanceof Error?P.message:"批量翻译失败";return n.error(se),!1}finally{t.setBatchTranslationInProgress(!1);const P=t.currentImageIndex;if(P>=0&&P<t.images.length){const se=t.images[P];se&&(se.bubbleStates&&se.bubbleStates.length>0&&l.setBubbles(se.bubbleStates),t.setCurrentImageIndex(P))}setTimeout(()=>{o.value.isInProgress=!1},1e3)}}function u(){t.isBatchTranslationInProgress&&!t.isBatchTranslationPaused&&(t.setBatchTranslationPaused(!0),o.value.isPaused=!0,n.info("批量翻译已暂停"))}function C(){t.isBatchTranslationInProgress&&t.isBatchTranslationPaused&&(t.resumeBatchTranslation(),o.value.isPaused=!1,n.info("批量翻译继续中"))}function D(){t.isBatchTranslationInProgress&&(t.isBatchTranslationPaused&&t.resumeBatchTranslation(),t.setBatchTranslationInProgress(!1),o.value.isInProgress=!1,n.info("批量翻译已取消"))}async function k(){return Z({removeTextOnly:!0})}async function J(){return p({removeTextOnly:!0})}async function te(A={}){if(!s.validateBeforeTranslation("normal"))return!1;const r=t.getFailedImageIndices();if(r.length===0)return n.info("没有失败的图片需要重新翻译"),!0;o.value={current:0,total:r.length,completed:0,failed:0,isInProgress:!0,isPaused:!1},t.setBatchTranslationInProgress(!0),ne();let y=!0;try{for(let w=0;w<r.length&&(t.isBatchTranslationPaused&&await new Promise(ge=>{t.setBatchTranslationResumeCallback(ge)}),!!t.isBatchTranslationInProgress);w++){o.value.current=w+1;const P=r[w];if(P===void 0)continue;await Y(P,A)?o.value.completed++:(o.value.failed++,y=!1)}return o.value.failed>0?n.warning(`重试完成，仍有 ${o.value.failed} 张图片失败`):n.success("所有失败图片重新翻译完成"),y}catch(w){const P=w instanceof Error?w.message:"重试翻译失败";return n.error(P),!1}finally{t.setBatchTranslationInProgress(!1),setTimeout(()=>{o.value.isInProgress=!1},1e3)}}let de=[],F=null;function g(){return"session_"+Date.now()+"_"+Math.random().toString(36).substring(2,9)}function _(){const A=t.images;if(A.length===0)return null;const r=[];for(let y=0;y<A.length;y++){const w=A[y];if(!w)continue;const P=w.originalTexts||[],se={imageIndex:y,bubbles:[]};for(let ge=0;ge<P.length;ge++){const re=P[ge]||"";let le="vertical";const I=w.bubbleStates?.[ge];if(I&&I.textDirection){const d=I.textDirection;le=d==="auto"?"vertical":d}else w.userLayoutDirection&&w.userLayoutDirection!=="auto"&&(le=w.userLayoutDirection);se.bubbles.push({bubbleIndex:ge,original:re,translated:"",textDirection:le})}r.push(se)}return r}function B(){return t.images.map(A=>{const r=A.originalDataURL;return r.includes(",")?r.split(",")[1]||"":r})}function q(A,r,y){return A.filter(w=>w.imageIndex>=r&&w.imageIndex<y)}function N(A){if(!A||A.length===0)return[];const r=[];for(const y of A){if(!y){console.warn("mergeJsonResults: 跳过空的批次结果");continue}const w=Array.isArray(y)?y:[y];for(const P of w)P&&typeof P=="object"&&"imageIndex"in P?r.push(P):console.warn("mergeJsonResults: 跳过无效的图片数据",P)}return r.sort((y,w)=>y.imageIndex-w.imageIndex),r}async function M(A,r,y){const{hqTranslation:w}=i.settings,P=JSON.stringify(r,null,2),se=[{type:"text",text:w.prompt+`

以下是JSON数据:
\`\`\`json
`+P+"\n```"}];for(const le of A)se.push({type:"image_url",image_url:{url:`data:image/png;base64,${le}`}});const ge=[{role:"system",content:"你是一个专业的漫画翻译助手，能够根据漫画图像内容和上下文提供高质量的翻译。"},{role:"user",content:se}],re={provider:w.provider,api_key:w.apiKey,model_name:w.modelName,custom_base_url:w.customBaseUrl,messages:ge,low_reasoning:w.lowReasoning,force_json_output:w.forceJsonOutput,no_thinking_method:w.noThinkingMethod,use_stream:w.useStream};try{console.log(`高质量翻译: 通过后端代理调用 ${w.provider} API...`);const le=await en(re);if(!le.success)throw new Error(le.error||"API 调用失败");if(le.results)return le.results.map(d=>({imageIndex:d.index,bubbles:d.translations.map((z,K)=>({bubbleIndex:K,original:"",translated:z,textDirection:"vertical"}))}));const I=le.content;if(I)if(w.forceJsonOutput)try{return JSON.parse(I)}catch(d){throw console.error("解析AI强制JSON返回的内容失败:",d),new Error("解析AI返回的JSON结果失败")}else{const d=I.match(/```json\s*([\s\S]*?)\s*```/);if(d&&d[1])try{return JSON.parse(d[1])}catch(z){throw console.error("解析AI返回的JSON失败:",z),new Error("解析AI返回的翻译结果失败")}}return null}catch(le){throw console.error("调用AI翻译API失败:",le),le}}async function f(){if(t.images.length===0)return n.warning("请先添加图片"),!1;if(t.isBatchTranslationInProgress)return n.warning("请等待当前批量操作完成"),!1;if(!s.validateBeforeTranslation("hq"))return!1;const{hqTranslation:A,textStyle:r}=i.settings,y=r.layoutDirection;F={fontFamily:r.fontFamily,fontSize:r.fontSize,autoFontSize:r.autoFontSize,autoTextDirection:y==="auto",textDirection:y==="auto"?"vertical":y,fillColor:r.fillColor,textColor:r.textColor,rotationAngle:0,strokeEnabled:r.strokeEnabled,strokeColor:r.strokeColor,strokeWidth:r.strokeWidth},console.log("高质量翻译前保存的文本样式设置:",F),o.value={current:0,total:t.images.length,completed:0,failed:0,isInProgress:!0,isPaused:!1,label:"准备翻译...",percentage:0},n.info("步骤1/4: 消除所有图片文字..."),m.value=!0,t.setBatchTranslationInProgress(!0);try{await S(),n.info("步骤2/4: 导出文本数据..."),o.value.label="导出文本数据...",o.value.percentage=25;const w=_();if(!w)throw new Error("导出文本失败");n.info("步骤3/4: 准备图片数据..."),o.value.label="准备图片数据...",o.value.percentage=40;const P=B();n.info("步骤4/4: 发送到AI进行翻译..."),o.value.label="开始发送到AI...",o.value.percentage=50;const se=A.batchSize||3,ge=A.sessionReset||5,re=A.maxRetries??2;de=[];const le=P.length,I=Math.ceil(le/se),d=A.rpmLimit||0,z=d>0?Gt(d):null;let K=0,j=g();for(let be=0;be<I;be++){o.value.label=`${be+1}/${I}`,o.value.percentage=Math.round(50+be/I*40),K>=ge&&(console.log("重置会话上下文"),j=g(),K=0);const he=be*se,ke=Math.min(he+se,le),xe=P.slice(he,ke),De=q(w,he,ke);let _e=0,Se=!1;for(;_e<=re&&!Se;)try{z&&await z.acquire();const Ce=await M(xe,De,j);Ce&&(de.push(Ce),Se=!0),K++}catch(Ce){_e++,_e<=re?(console.log(`批次 ${be+1} 翻译失败，第 ${_e}/${re} 次重试...`),n.warning(`批次 ${be+1} 失败，正在重试 (${_e}/${re})...`),await new Promise(ye=>setTimeout(ye,1e3))):(console.error(`批次 ${be+1} 翻译最终失败:`,Ce),n.error(`批次 ${be+1} 翻译失败: ${Ce instanceof Error?Ce.message:"未知错误"}`))}}return n.info("翻译完成，正在导入翻译结果..."),o.value.label="导入翻译结果...",o.value.percentage=90,await oe(N(de)),o.value.label="翻译完成！",o.value.percentage=100,n.success("高质量翻译完成！"),!0}catch(w){return console.error("高质量翻译过程出错:",w),n.error(`翻译失败: ${w instanceof Error?w.message:"未知错误"}`),!1}finally{m.value=!1,t.setBatchTranslationInProgress(!1),setTimeout(()=>{o.value.isInProgress=!1},1e3)}}async function S(){const A=t.images.length;let r=0;o.value.label=`消除文字: 0/${A}`,o.value.percentage=0;for(let y=0;y<A;y++){const w=Math.floor(y/A*25);o.value.label=`消除文字: ${y+1}/${A}`,o.value.percentage=w;const P=t.images[y];if(!P||!P.originalDataURL)continue;const se=Array.isArray(P.bubbleStates)||Array.isArray(P.bubbleCoords)&&P.bubbleCoords.length>0;let ge,re;if(se&&(P.bubbleStates&&P.bubbleStates.length>0?(ge=P.bubbleStates.map(le=>le.coords),re=P.bubbleStates.map(le=>le.rotationAngle||0)):P.bubbleCoords&&P.bubbleCoords.length>0&&(ge=P.bubbleCoords,re=P.bubbleAngles),ge&&ge.length===0)){console.log(`高质量翻译[${y}]: 文本框已被用户清空，跳过此图片`);continue}try{const le=Q(P.originalDataURL,{removeTextOnly:!0,existingBubbleCoords:ge,existingBubbleAngles:re,useExistingBubbles:!!ge}),I=await Et(le);if(I.translated_image){const d=F?.textDirection,z=d==="vertical"||d==="horizontal"||d==="auto"?d:"vertical",K=I.bubble_coords?zn(I,{fontSize:F?.fontSize||i.settings.textStyle.fontSize,fontFamily:F?.fontFamily||i.settings.textStyle.fontFamily,textDirection:z,textColor:F?.textColor||i.settings.textStyle.textColor,fillColor:F?.fillColor||i.settings.textStyle.fillColor,strokeEnabled:F?.strokeEnabled??i.settings.textStyle.strokeEnabled,strokeColor:F?.strokeColor||i.settings.textStyle.strokeColor,strokeWidth:F?.strokeWidth??i.settings.textStyle.strokeWidth,inpaintMethod:i.settings.textStyle.inpaintMethod}):[];t.updateImageByIndex(y,{translatedDataURL:`data:image/png;base64,${I.translated_image}`,cleanImageData:I.clean_image||null,bubbleCoords:I.bubble_coords||[],bubbleAngles:I.bubble_angles||[],originalTexts:I.original_texts||[],textboxTexts:I.textbox_texts||[],bubbleStates:K,bubbleTexts:K.map(j=>j.translatedText||""),translationFailed:!1,translationStatus:"completed",hasUnsavedChanges:!0}),console.log(`高质量翻译-消除文字[${y+1}/${A}]: 处理完成`)}else r++,t.updateImageByIndex(y,{translationFailed:!0,translationStatus:"failed"})}catch(le){console.error(`图片 ${y} 消除文字失败:`,le),r++,t.updateImageByIndex(y,{translationFailed:!0,translationStatus:"failed"})}}if(o.value.label="消除文字完成",o.value.percentage=25,r>0)throw new Error(`消除文字完成，但有 ${r} 张图片失败`)}async function oe(A){if(!A||A.length===0)throw new Error("没有有效的翻译数据可导入");const r=t.images,y=t.currentImageIndex,w=F?.fontSize||i.settings.textStyle.fontSize,P=F?.autoFontSize??i.settings.textStyle.autoFontSize,se=F?.fontFamily||i.settings.textStyle.fontFamily,ge=F?.textDirection||i.settings.textStyle.layoutDirection,re=ge==="auto"?"vertical":ge,le=F?.textColor||i.settings.textStyle.textColor,I=F?.fillColor||i.settings.textStyle.fillColor,d=F?.strokeEnabled??i.settings.textStyle.strokeEnabled,z=F?.strokeColor||i.settings.textStyle.strokeColor,K=F?.strokeWidth??i.settings.textStyle.strokeWidth;o.value.label="更新图片数据...",o.value.percentage=90;const j=A.length;let be=0;for(const he of A){be++,o.value.label=`处理图片 ${be}/${j}`,o.value.percentage=90+be/j*5;const ke=he.imageIndex;if(ke<0||ke>=r.length){console.warn(`跳过无效的图片索引: ${ke}`);continue}const xe=r[ke];if(!xe)continue;let De=!1;const _e=xe.bubbleTexts||[],Se=xe.bubbleCoords||[];for(const Ce of he.bubbles||[]){const ye=Ce.bubbleIndex;if(ye<0||ye>=Se.length){console.warn(`图片 ${ke}: 跳过无效的气泡索引 ${ye}`);continue}const Ue=Ce.translated;let we=Ce.textDirection;we==="auto"&&(we=re),_e[ye]=Ue;const Be=we==="vertical"||we==="horizontal"?we:re;if(!xe.bubbleStates||!Array.isArray(xe.bubbleStates)||xe.bubbleStates.length!==Se.length){const Pe=xe.bubbleAngles||[],$e=[];for(let V=0;V<Se.length;V++){const me=V===ye?Be:re,Ae=Se[V];let qe=me;const lt=xe.bubbleStates?.[V];if(lt?.autoTextDirection&&lt.autoTextDirection!=="auto")qe=lt.autoTextDirection;else if(Ae&&Ae.length>=4){const[Ze,Je,St,Pt]=Ae;qe=Pt-Je>St-Ze?"vertical":"horizontal"}$e.push({translatedText:_e[V]||"",originalText:xe.originalTexts?.[V]||"",coords:Ae,fontSize:w,fontFamily:se,textDirection:me,autoTextDirection:qe,position:{x:0,y:0},textColor:le,rotationAngle:Pe[V]||0,fillColor:I,strokeEnabled:d,strokeColor:z,strokeWidth:K})}xe.bubbleStates=$e}else xe.bubbleStates[ye]&&(xe.bubbleStates[ye].translatedText=Ue,we&&we!=="auto"&&(xe.bubbleStates[ye].textDirection=Be));De=!0}if(De&&xe.bubbleStates){const Ce=xe.bubbleStates.map(ye=>ye.translatedText||"");if(xe.cleanImageData)try{const{apiClient:ye}=await it(async()=>{const{apiClient:Pe}=await import("./client.Bht704G-.js");return{apiClient:Pe}},__vite__mapDeps([4,5])),Ue=xe.bubbleStates.map(Pe=>({translatedText:Pe.translatedText||"",coords:Pe.coords,fontSize:Pe.fontSize||w,fontFamily:Pe.fontFamily||se,textDirection:Pe.textDirection||re,textColor:Pe.textColor||le,rotationAngle:Pe.rotationAngle||0,position:Pe.position||{x:0,y:0},strokeEnabled:Pe.strokeEnabled??d,strokeColor:Pe.strokeColor||z,strokeWidth:Pe.strokeWidth??K}));let we=xe.cleanImageData;we.includes("base64,")&&(we=we.split("base64,")[1]||"");const Be=await ye.post("/api/re_render_image",{clean_image:we,bubble_texts:Ce,bubble_coords:Se,fontSize:w,autoFontSize:P,fontFamily:se,textDirection:re,textColor:le,bubble_states:Ue,use_individual_styles:!0,use_inpainting:!1,use_lama:!1,fillColor:null,is_font_style_change:!1,strokeEnabled:d,strokeColor:z,strokeWidth:K});Be.rendered_image&&(t.updateImageByIndex(ke,{translatedDataURL:`data:image/png;base64,${Be.rendered_image}`,bubbleStates:xe.bubbleStates,bubbleTexts:Ce,hasUnsavedChanges:!0}),console.log(`已完成图片 ${ke} 的渲染`))}catch(ye){console.error(`重新渲染图片 ${ke} 失败:`,ye)}else t.updateImageByIndex(ke,{bubbleStates:xe.bubbleStates,bubbleTexts:Ce,hasUnsavedChanges:!0})}}y>=0&&y<r.length&&t.setCurrentImageIndex(y)}let R=[];function E(){const A=t.images;if(A.length===0)return null;const r=[];for(let y=0;y<A.length;y++){const w=A[y];if(!w)continue;const P=w.originalTexts||[],se=w.bubbleTexts||[],ge={imageIndex:y,bubbles:[]};for(let re=0;re<P.length;re++){const le=P[re]||"",I=(re<se.length?se[re]:"")||"";let d="vertical";const z=w.bubbleStates?.[re];if(z&&z.textDirection){const K=z.textDirection;d=K==="auto"?"vertical":K}else w.userLayoutDirection&&w.userLayoutDirection!=="auto"&&(d=w.userLayoutDirection);ge.bubbles.push({bubbleIndex:re,original:le,translated:I,textDirection:d})}r.push(ge)}return r}function $(A,r,y){return A.filter(w=>w.imageIndex>=r&&w.imageIndex<y)}function c(A){if(!A||A.length===0)return[];const r=[];for(const y of A){if(!y)continue;const w=Array.isArray(y)?y:[y];for(const P of w)P&&typeof P=="object"&&"imageIndex"in P&&r.push(P)}return r.sort((y,w)=>y.imageIndex-w.imageIndex),r}async function O(A,r,y,w){const P=JSON.stringify(r,null,2),se=[{type:"text",text:y.prompt+`

以下是JSON数据，包含原文和已有译文:
\`\`\`json
`+P+"\n```\n请在保持JSON格式的情况下，校对每个bubble的translated字段，使翻译更加准确、自然、符合语境。"}];for(const re of A)se.push({type:"image_url",image_url:{url:`data:image/png;base64,${re}`}});const ge={provider:y.provider,api_key:y.apiKey,model_name:y.modelName,custom_base_url:y.customBaseUrl,messages:[{role:"system",content:"你是一个专业的漫画翻译校对助手，能够根据漫画图像内容和上下文对已有翻译进行校对和润色。"},{role:"user",content:se}],low_reasoning:y.lowReasoning,no_thinking_method:y.noThinkingMethod,force_json_output:y.forceJsonOutput};try{console.log(`AI校对: 通过后端代理调用 ${y.provider} API...`);const re=await en(ge);if(!re.success)throw new Error(re.error||"API 调用失败");const le=re.content;if(le)if(y.forceJsonOutput)try{return JSON.parse(le)}catch(I){throw console.error("解析AI强制JSON返回的内容失败:",I),new Error("解析AI返回的JSON结果失败")}else{const I=le.match(/```json\s*([\s\S]*?)\s*```/);if(I&&I[1])try{return JSON.parse(I[1])}catch(d){throw console.error("解析AI返回的JSON失败:",d),new Error("解析AI返回的校对结果失败")}try{return JSON.parse(le)}catch(d){throw console.error("直接解析AI返回内容失败:",d),new Error("无法解析AI返回的校对结果")}}return null}catch(re){throw console.error("调用AI校对API失败:",re),re}}async function ce(A){if(!A||A.length===0){console.warn("没有有效的校对数据可导入"),n.warning("没有有效的校对结果可导入");return}const r=t.images,y=t.currentImageIndex,{textStyle:w}=i.settings,P=w.fontSize,se=w.fontFamily,ge=w.layoutDirection,re=ge==="auto"?"vertical":ge,le=w.textColor,I=w.fillColor,d=w.strokeEnabled,z=w.strokeColor,K=w.strokeWidth;for(const j of A){const be=j.imageIndex;if(be<0||be>=r.length){console.warn(`跳过无效的图片索引: ${be}`);continue}const he=r[be];if(!he)continue;if(!j.bubbles||!Array.isArray(j.bubbles)||j.bubbles.length===0){console.warn(`图片 ${be}: 没有有效的气泡数据`);continue}let ke=!1;const xe=he.bubbleTexts||[],De=he.bubbleCoords||[];for(const _e of j.bubbles){const Se=_e.bubbleIndex,Ce=_e.translated||"";let ye=_e.textDirection;if((!ye||ye==="auto")&&(ye=re),Se<0||Se>=De.length){console.warn(`图片 ${be}: 跳过无效的气泡索引 ${Se}`);continue}for(;xe.length<=Se;)xe.push("");if(xe[Se]=Ce,ye&&ye!=="auto"){const Ue=ye==="vertical"||ye==="horizontal"?ye:re;if(!he.bubbleStates||!Array.isArray(he.bubbleStates)||he.bubbleStates.length!==De.length){const we=he.bubbleAngles||[],Be=[];for(let Pe=0;Pe<De.length;Pe++){const $e=Pe===Se?Ue:re,V=De[Pe];let me=$e;const Ae=he.bubbleStates?.[Pe];if(Ae?.autoTextDirection&&Ae.autoTextDirection!=="auto")me=Ae.autoTextDirection;else if(V&&V.length>=4){const[qe,lt,Ze,Je]=V;me=Je-lt>Ze-qe?"vertical":"horizontal"}Be.push({translatedText:xe[Pe]||"",originalText:he.originalTexts?.[Pe]||"",coords:V,fontSize:P,fontFamily:se,textDirection:$e,autoTextDirection:me,position:{x:0,y:0},textColor:le,rotationAngle:we[Pe]||0,fillColor:I,strokeEnabled:d,strokeColor:z,strokeWidth:K})}he.bubbleStates=Be}else he.bubbleStates[Se]&&(he.bubbleStates[Se].translatedText=Ce,he.bubbleStates[Se].textDirection=Ue)}ke=!0}if(ke&&he.bubbleStates){const _e=he.bubbleStates.map(Se=>Se.translatedText||"");if(he.cleanImageData)try{const{apiClient:Se}=await it(async()=>{const{apiClient:we}=await import("./client.Bht704G-.js");return{apiClient:we}},__vite__mapDeps([4,5])),Ce=he.bubbleStates.map(we=>({translatedText:we.translatedText||"",coords:we.coords,fontSize:we.fontSize||P,fontFamily:we.fontFamily||se,textDirection:we.textDirection||re,textColor:we.textColor||le,rotationAngle:we.rotationAngle||0,position:we.position||{x:0,y:0},strokeEnabled:we.strokeEnabled??d,strokeColor:we.strokeColor||z,strokeWidth:we.strokeWidth??K}));let ye=he.cleanImageData;ye.includes("base64,")&&(ye=ye.split("base64,")[1]||"");const Ue=await Se.post("/api/re_render_image",{clean_image:ye,bubble_texts:_e,bubble_coords:De,fontSize:P,fontFamily:se,textDirection:re,textColor:le,bubble_states:Ce,use_individual_styles:!0,use_inpainting:!1,use_lama:!1,fillColor:null,is_font_style_change:!1,strokeEnabled:d,strokeColor:z,strokeWidth:K});Ue.rendered_image&&(t.updateImageByIndex(be,{translatedDataURL:`data:image/png;base64,${Ue.rendered_image}`,bubbleStates:he.bubbleStates,bubbleTexts:_e,hasUnsavedChanges:!0}),console.log(`已完成图片 ${be} 的校对渲染`))}catch(Se){console.error(`重新渲染图片 ${be} 失败:`,Se)}else t.updateImageByIndex(be,{bubbleStates:he.bubbleStates,bubbleTexts:_e,hasUnsavedChanges:!0})}}y>=0&&y<r.length&&t.setCurrentImageIndex(y)}async function X(){if(!s.validateBeforeTranslation("proofread"))return!1;const{proofreading:A}=i.settings;if(!A.enabled||A.rounds.length===0)return n.error("请先启用 AI 校对并添加校对轮次"),!1;const r=t.images;if(r.length===0)return n.error("请先上传图片"),!1;if(!r.some(P=>P.bubbleTexts&&P.bubbleTexts.length>0))return n.error("请先进行翻译以获取译文"),!1;T.value=!0,t.setBatchTranslationInProgress(!0);const w=A.rounds.length;o.value={current:0,total:w,completed:0,failed:0,isInProgress:!0,isPaused:!1,label:"准备校对...",percentage:0},n.info(`开始校对，共 ${w} 轮`);try{for(let P=0;P<w;P++){const se=A.rounds[P];if(!se)continue;const ge=se.name||`轮次${P+1}`,re=P/w*100,le=1/w*100;n.info(`校对第 ${P+1}/${w} 轮: ${ge}`),o.value.label=`轮次 ${P+1}/${w}`,o.value.percentage=Math.round(re),n.info(`轮次 ${P+1}/${w}: 导出文本数据...`),o.value.label="导出文本...",o.value.percentage=Math.round(re+le*.2);const I=E();if(!I)throw new Error("导出文本失败");n.info(`轮次 ${P+1}/${w}: 准备图片数据...`),o.value.label="准备图片数据...",o.value.percentage=Math.round(re+le*.4);const d=B();n.info(`轮次 ${P+1}/${w}: 发送到AI进行校对...`),o.value.label="开始发送到AI...",o.value.percentage=Math.round(re+le*.5);const z=se.batchSize||3,K=se.sessionReset||20,j=A.maxRetries??2;R=[];const be=d.length,he=Math.ceil(be/z),ke=se.rpmLimit||7,xe=ke>0?Gt(ke):null;let De=0,_e=g(),Se=0;for(let Ce=0;Ce<he;Ce++){const ye=re+le*.5+le*.4*(Ce/he);o.value.label=`轮次 ${P+1}/${w}: ${Ce+1}/${he}`,o.value.percentage=Math.round(ye),De>=K&&(console.log("重置会话上下文"),_e=g(),De=0);const Ue=Ce*z,we=Math.min(Ue+z,be),Be=d.slice(Ue,we),Pe=$(I,Ue,we);let $e=0,V=!1;for(;$e<=j&&!V;)try{xe&&await xe.acquire();const me=await O(Be,Pe,se,_e);me&&(R.push(me),Se++,V=!0),De++}catch(me){$e++,$e<=j?(console.log(`轮次 ${P+1}, 批次 ${Ce+1} 校对失败，第 ${$e}/${j} 次重试...`),n.warning(`轮次 ${P+1}, 批次 ${Ce+1} 失败，正在重试 (${$e}/${j})...`),await new Promise(Ae=>setTimeout(Ae,1e3))):(console.error(`轮次 ${P+1}, 批次 ${Ce+1} 校对最终失败:`,me),n.error(`轮次 ${P+1}, 批次 ${Ce+1} 校对失败: ${me instanceof Error?me.message:"未知错误"}`))}}if(Se===0)throw new Error(`轮次 ${P+1} 校对完全失败，请检查API设置或校对提示词`);n.info(`轮次 ${P+1}/${w}: 导入校对结果...`),o.value.label="导入校对结果...",o.value.percentage=Math.round(re+le*.9),await ce(c(R)),o.value.completed++}return o.value.label="校对完成！",o.value.percentage=100,n.success(`AI校对完成，共 ${w} 轮`),!0}catch(P){const se=P instanceof Error?P.message:"AI 校对失败";return n.error(`校对失败: ${se}`),o.value.label="校对已取消",o.value.percentage=0,!1}finally{T.value=!1,t.setBatchTranslationInProgress(!1),setTimeout(()=>{o.value.isInProgress=!1},1e3)}}async function G(){if(!t.currentImage)return n.error("请先上传图片"),!1;const r=l.bubbles;if(!r||r.length===0)return n.error("当前图片没有气泡框，请先检测或手动添加"),!1;const y=r.map(w=>w.coords);return Z({useExistingBubbles:!0,existingBubbleCoords:y})}return{progress:o,isTranslatingSingle:b,isHqTranslating:m,isProofreading:T,isTranslating:x,progressPercent:L,translateCurrentImage:Z,translateImageByIndex:Y,translateAllImages:p,pauseBatchTranslation:u,resumeBatchTranslation:C,cancelBatchTranslation:D,removeTextOnly:k,removeAllTexts:J,retryFailedImages:te,executeHqTranslation:f,executeProofreading:X,translateWithCurrentBubbles:G}}function al(){const t=gt(),i=at(),l=h(!1);function s(){if(!l.value)return;const n=i.currentImage;t.bubbleCount>0?i.updateCurrentBubbleStates([...t.bubbles]):n&&Array.isArray(n.bubbleStates)&&n.bubbleStates.length>0&&(i.updateCurrentBubbleStates([]),console.log("退出编辑模式（无重渲染），用户已删除所有气泡")),l.value=!1,t.clearSelection(),console.log("已退出编辑模式（无重渲染）")}return{isActive:l,exitEditModeWithoutRender:s}}function sl(){const t=qn(),i=Qe(),l=at(),s=jn(),n=gt(),a=al(),o=h(!1),b=h(!1),m=h(null),T=h([]),x=h([]),L=h([]),ne=h(null),ie=h(null),Q=h(null),v=h(null),Z=h(!1);async function Y(){if(o.value||b.value){console.log("[TranslateInit] 已经初始化或正在初始化中，跳过");return}console.log("[TranslateInit] 开始初始化应用..."),o.value=!0,m.value=null;try{await p(),await u(),await C(),await D(),await k(),console.log("[TranslateInit] 应用初始化完成"),b.value=!0}catch(_){console.error("[TranslateInit] 应用初始化失败:",_),m.value=_ instanceof Error?_.message:"初始化失败"}finally{o.value=!1}}async function p(){console.log("[TranslateInit] 初始化设置..."),i.initSettings();try{const _=await i.loadFromBackend();console.log(_?"[TranslateInit] 已从后端加载设置":"[TranslateInit] 后端无设置，使用 localStorage 数据")}catch(_){console.warn("[TranslateInit] 从后端加载设置失败，使用 localStorage 数据:",_)}console.log("[TranslateInit] 设置初始化完成")}async function u(){console.log("[TranslateInit] 初始化字体列表...");try{const _=await Yn();_.fonts&&_.fonts.length>0?(T.value=_.fonts,console.log(`[TranslateInit] 已加载 ${_.fonts.length} 个字体`)):_.error?console.warn("[TranslateInit] 获取字体列表失败:",_.error):console.warn("[TranslateInit] 字体列表为空")}catch(_){console.error("[TranslateInit] 获取字体列表失败:",_)}}async function C(){console.log("[TranslateInit] 初始化翻译提示词设置...");try{const _=await jo();_.prompt_names!==void 0?(x.value=_.prompt_names||[],!i.settings.translatePrompt&&_.default_prompt_content&&i.setTranslatePrompt(_.default_prompt_content),console.log(`[TranslateInit] 已加载 ${x.value.length} 个翻译提示词`)):_.error&&console.warn("[TranslateInit] 获取翻译提示词失败:",_.error)}catch(_){console.error("[TranslateInit] 获取翻译提示词失败:",_)}}async function D(){console.log("[TranslateInit] 初始化文本框提示词设置...");try{const _=await Xo();_.prompt_names!==void 0?(L.value=_.prompt_names||[],!i.settings.textboxPrompt&&_.default_prompt_content&&i.setTextboxPrompt(_.default_prompt_content),console.log(`[TranslateInit] 已加载 ${L.value.length} 个文本框提示词`)):_.error&&console.warn("[TranslateInit] 获取文本框提示词失败:",_.error)}catch(_){console.error("[TranslateInit] 获取文本框提示词失败:",_)}}async function k(){const _=t.query.book,B=t.query.chapter;if(!_||!B){console.log("[TranslateInit] 未指定书籍/章节参数，使用独立模式"),Z.value=!1;return}console.log(`[TranslateInit] 检测到书籍/章节参数: book=${_}, chapter=${B}`),Z.value=!0,ne.value=_,ie.value=B;try{const q=await Zo(_);if(!q.success||!q.book){console.warn("[TranslateInit] 书籍不存在:",_),Re("书籍不存在","warning");return}const N=q.book,M=N.chapters?.find(f=>f.id===B);if(!M){console.warn("[TranslateInit] 章节不存在:",B),Re("章节不存在","warning");return}if(Q.value=N.title,v.value=M.title,s.setBookChapterContext(_,B,N.title,M.title),typeof document<"u"&&(document.title=`${M.title} - ${N.title} - Saber-Translator`),M.session_path){console.log(`[TranslateInit] 尝试加载章节会话: ${M.session_path}`);try{await s.loadSessionByPath(M.session_path),Re(`已加载章节: ${M.title}`,"success")}catch{console.log("[TranslateInit] 章节会话数据不存在或加载失败，将创建新会话")}}}catch(q){console.error("[TranslateInit] 加载书籍/章节信息失败:",q),Re("加载书籍信息失败","error")}}function J(_){if(_<0||_>=l.imageCount){console.warn(`[TranslateInit] 无效的图片索引: ${_}`);return}window._isChangingFromSwitchImage=!0,a.isActive.value&&a.exitEditModeWithoutRender(),l.currentImage&&n.bubbles.length>0&&l.updateCurrentImageProperty("bubbleStates",n.bubbles),l.setCurrentImageIndex(_);const q=l.currentImage;if(!q){console.warn("[TranslateInit] 切换到的图片不存在"),window._isChangingFromSwitchImage=!1;return}console.log(`[TranslateInit] 切换到图片: ${_}, ${q.fileName}`),q.bubbleStates&&q.bubbleStates.length>0?n.setBubbles(q.bubbleStates,!0):n.clearBubblesLocal(),te(q),setTimeout(()=>{window._isChangingFromSwitchImage=!1,console.log("[TranslateInit] 已重置切换图片操作标记")},100)}function te(_){if(!_)return;const B=_.bubbleStates?.[0];B&&i.updateTextStyle({fontSize:B.fontSize||i.settings.textStyle.fontSize,fontFamily:B.fontFamily||i.settings.textStyle.fontFamily,layoutDirection:_.userLayoutDirection||B.textDirection||i.settings.textStyle.layoutDirection,textColor:B.textColor||i.settings.textStyle.textColor,fillColor:B.fillColor||i.settings.textStyle.fillColor,strokeEnabled:B.strokeEnabled??i.settings.textStyle.strokeEnabled,strokeColor:B.strokeColor||i.settings.textStyle.strokeColor,strokeWidth:B.strokeWidth||i.settings.textStyle.strokeWidth,inpaintMethod:B.inpaintMethod||i.settings.textStyle.inpaintMethod,autoFontSize:_.autoFontSize??i.settings.textStyle.autoFontSize})}function de(){l.canGoPrevious&&J(l.currentImageIndex-1)}function F(){l.canGoNext&&J(l.currentImageIndex+1)}function g(){ut(async()=>{await Y()})}return{isInitializing:o,isInitialized:b,initError:m,fontList:T,promptNames:x,textboxPromptNames:L,currentBookId:ne,currentChapterId:ie,currentBookTitle:Q,currentChapterTitle:v,isBookshelfMode:Z,initializeApp:Y,initializeSettings:p,initializeFontList:u,initializePromptSettings:C,initializeTextboxPromptSettings:D,initializeBookChapterContext:k,switchImage:J,goToPrevious:de,goToNext:F,loadImageSettingsToStore:te,editMode:a,setupAutoInit:g}}const ll={key:0,id:"translationProgressBar",class:"translation-progress-bar"},il={class:"progress-bar-label"},rl={key:0,class:"failed-count"},ul={key:0,class:"progress-controls"},cl=["title"],dl={class:"pause-icon"},gl=je({__name:"TranslationProgress",props:{progress:{},showControls:{type:Boolean,default:!0}},emits:["pause","resume"],setup(t,{emit:i}){const l=t,s=i,n=at(),a=gn(),o=ee(()=>l.progress||a.progress.value),b=ee(()=>o.value.isInProgress||n.isBatchTranslationInProgress),m=ee(()=>o.value.current),T=ee(()=>o.value.total),x=ee(()=>o.value.failed),L=ee(()=>o.value.percentage!==void 0?o.value.percentage:T.value===0?0:Math.round(m.value/T.value*100)),ne=ee(()=>o.value.isPaused||n.isBatchTranslationPaused),ie=ee(()=>o.value.label?o.value.label:`${ne.value?"已暂停":"翻译中"}：${m.value} / ${T.value}`);function Q(){ne.value?(a.resumeBatchTranslation(),s("resume")):(a.pauseBatchTranslation(),s("pause"))}return(v,Z)=>b.value?(U(),H("div",ll,[e("div",il,[Fe(fe(ie.value)+" ",1),x.value>0?(U(),H("span",rl,"（"+fe(x.value)+" 张失败）",1)):Te("",!0)]),e("div",{class:Le(["progress-bar",{paused:ne.value}])},[e("div",{class:"progress",style:st({width:`${L.value}%`})},null,4)],2),l.showControls?(U(),H("div",ul,[e("button",{class:Le(["pause-btn",{paused:ne.value}]),onClick:Q,title:ne.value?"继续翻译":"暂停翻译"},[e("span",dl,fe(ne.value?"▶":"⏸"),1),Fe(" "+fe(ne.value?"继续":"暂停"),1)],10,cl)])):Te("",!0)])):Te("",!0)}}),vl=Xe(gl,[["__scopeId","data-v-8e30b90e"]]),bl=je({__name:"SponsorModal",emits:["close"],setup(t,{emit:i}){const l=i;return(s,n)=>(U(),rt(Jn,{title:"支持作者",onClose:n[1]||(n[1]=a=>l("close"))},{footer:ht(()=>[e("button",{type:"button",class:"btn btn-primary",onClick:n[0]||(n[0]=a=>l("close"))},"关闭")]),default:ht(()=>[n[2]||(n[2]=e("div",{class:"sponsor-content"},[e("p",{class:"sponsor-message"}," 如果这个项目对你有帮助，欢迎请作者喝杯咖啡 ☕ "),e("div",{class:"qr-codes"},[e("div",{class:"qr-item"},[e("div",{class:"qr-image"},[e("img",{src:"/pic/wechat_qrcode.png",alt:"微信支付"})]),e("span",{class:"qr-label"},"微信支付")]),e("div",{class:"qr-item"},[e("div",{class:"qr-image"},[e("img",{src:"/pic/alipay_qrcode.png",alt:"支付宝"})]),e("span",{class:"qr-label"},"支付宝")])]),e("p",{class:"sponsor-thanks"},"感谢您的支持！🙏")],-1))]),_:1}))}}),pl=Xe(bl,[["__scopeId","data-v-c6b511ce"]]),fl={class:"loading-content"},ml={key:0,class:"loading-message"},hl={key:1,class:"loading-progress"},yl={class:"progress-bar"},xl={class:"progress-text"},kl=je({__name:"LoadingOverlay",props:{visible:{type:Boolean,default:!1},message:{default:""},fullscreen:{type:Boolean,default:!1},size:{default:"medium"},showProgress:{type:Boolean,default:!1},progress:{default:void 0}},setup(t){const i=t,l=ee(()=>i.fullscreen?"body":void 0),s=ee(()=>`spinner-${i.size}`);return(n,a)=>(U(),rt(Po,{to:l.value,disabled:!t.fullscreen},[Ie(Zt,{name:"fade"},{default:ht(()=>[t.visible?(U(),H("div",{key:0,class:Le(["loading-overlay",{"loading-overlay-fullscreen":t.fullscreen}])},[e("div",fl,[e("div",{class:Le(["loading-spinner",s.value])},[...a[0]||(a[0]=[e("div",{class:"spinner-ring"},null,-1),e("div",{class:"spinner-ring"},null,-1),e("div",{class:"spinner-ring"},null,-1)])],2),t.message?(U(),H("div",ml,fe(t.message),1)):Te("",!0),t.showProgress&&t.progress!==void 0?(U(),H("div",hl,[e("div",yl,[e("div",{class:"progress-fill",style:st({width:`${t.progress}%`})},null,4)]),e("span",xl,fe(t.progress)+"%",1)])):Te("",!0)])],2)):Te("",!0)]),_:1})],8,["to","disabled"]))}}),Sl=Xe(kl,[["__scopeId","data-v-dfd92868"]]),Cl={id:"thumbnail-sidebar",class:"thumbnail-sidebar"},_l={class:"card thumbnail-card"},wl=["title","data-index","onClick"],$l=["src","alt"],Tl={key:1,class:"translation-failed-indicator"},Il={key:2,class:"labeled-indicator"},Dl={key:3,class:"thumbnail-processing-indicator"},Rl={key:1,class:"empty-state"},Ml=je({__name:"ThumbnailSidebar",emits:["select"],setup(t,{emit:i}){const l=i,s=at(),n=h(null),a=h([]),o=ee(()=>s.images),b=ee(()=>s.currentImageIndex),m=ee(()=>s.hasImages);function T(v){l("select",v)}function x(){dt(()=>{const v=a.value[b.value];if(v&&n.value){const Z=n.value,Y=v.offsetTop-Z.clientHeight/2+v.clientHeight/2;Z.scrollTo({top:Math.max(0,Y),behavior:"smooth"})}})}function L(v,Z){a.value[Z]=v}function ne(v){return v.translationFailed?"failed":v.savedManualCoords&&v.savedManualCoords.length>0?"labeled":v.translationStatus==="processing"?"processing":null}function ie(v){const Z=[];return v.translationFailed&&Z.push("translation-failed"),v.savedManualCoords&&v.savedManualCoords.length>0&&Z.push("has-manual-labels"),Z}function Q(v){return v.translationFailed?"翻译失败，点击可重试":v.savedManualCoords&&v.savedManualCoords.length>0?"包含手动标注框":v.fileName||""}return Ye(b,()=>{x()}),ut(()=>{m.value&&x()}),(v,Z)=>(U(),H("aside",Cl,[e("div",_l,[Z[1]||(Z[1]=e("h2",null,"图片概览",-1)),m.value?(U(),H("ul",{key:0,ref_key:"containerRef",ref:n,id:"thumbnailList",class:"thumbnail-list"},[(U(!0),H(Ge,null,tt(o.value,(Y,p)=>(U(),H("li",{key:Y.id,ref_for:!0,ref:u=>L(u,p),class:Le(["thumbnail-item",[{active:p===b.value},...ie(Y)]]),title:Q(Y),"data-index":p,onClick:u=>T(p)},[Y.originalDataURL?(U(),H("img",{key:0,src:Y.originalDataURL,alt:Y.fileName,class:"thumbnail-image"},null,8,$l)):Te("",!0),ne(Y)==="failed"?(U(),H("span",Tl,"!")):ne(Y)==="labeled"?(U(),H("span",Il,"✏️")):Te("",!0),ne(Y)==="processing"?(U(),H("div",Dl,"⟳")):Te("",!0)],10,wl))),128))],512)):(U(),H("div",Rl,[...Z[0]||(Z[0]=[e("p",null,"暂无图片",-1)])]))])]))}}),Bl=Xe(Ml,[["__scopeId","data-v-5123158c"]]),El={class:"saved-prompts-picker"},Pl={class:"prompts-chips-container"},Al={key:0,class:"empty-hint"},Fl={key:1,class:"empty-hint"},Ll=["title","onClick"],Ul=je({__name:"SavedPromptsPicker",props:{promptType:{}},emits:["select"],setup(t,{expose:i,emit:l}){const s=t,n=l,a=h([]),o=h(!1);async function b(){o.value=!0;try{let T;s.promptType==="textbox"?T=await Ne.getTextboxPrompts():T=await Ne.getPrompts(s.promptType);const x=T.prompt_names||[];a.value=x.map(L=>({name:L}))}catch(T){console.error("加载提示词列表失败:",T),a.value=[]}finally{o.value=!1}}async function m(T){try{let x;s.promptType==="textbox"?x=await Ne.getTextboxPromptContent(T):x=await Ne.getPromptContent(s.promptType,T),x.prompt_content&&n("select",x.prompt_content,T)}catch(x){console.error("加载提示词内容失败:",x)}}return Ye(()=>s.promptType,()=>{b()}),ut(()=>{b()}),i({refresh:b}),(T,x)=>(U(),H("div",El,[x[1]||(x[1]=e("span",{class:"picker-label"},"📑 快速选择:",-1)),e("div",Pl,[o.value?(U(),H("span",Al,"加载中...")):a.value.length===0?(U(),H("span",Fl,"暂无保存的提示词")):(U(!0),H(Ge,{key:2},tt(a.value,L=>(U(),H("button",{key:L.name,type:"button",class:"prompt-chip",title:L.name,onClick:ne=>m(L.name)},[x[0]||(x[0]=e("span",{class:"chip-icon"},"📝",-1)),Fe(" "+fe(L.name),1)],8,Ll))),128))])]))}}),Tt=Xe(Ul,[["__scopeId","data-v-2ebbb8b3"]]),Ol={class:"ocr-settings"},zl={class:"settings-group"},Vl={class:"settings-item"},Nl={class:"settings-item"},Wl={class:"input-hint"},Kl={class:"settings-group"},ql={class:"settings-row"},Hl={class:"settings-item"},Yl={class:"password-input-wrapper"},Jl=["type"],Xl={key:0,class:"eye-icon"},jl={key:1,class:"eye-off-icon"},Gl={class:"settings-item"},Zl={class:"password-input-wrapper"},Ql=["type"],ei={key:0,class:"eye-icon"},ti={key:1,class:"eye-off-icon"},ni={class:"settings-row"},oi={class:"settings-item"},ai={class:"settings-item"},si=["disabled"],li={class:"settings-group"},ii={class:"settings-row"},ri={class:"settings-item"},ui={class:"settings-item"},ci={class:"password-input-wrapper"},di=["type"],gi={key:0,class:"eye-icon"},vi={key:1,class:"eye-off-icon"},bi={class:"settings-item"},pi={class:"settings-item"},fi={class:"model-input-with-fetch"},mi=["disabled"],hi={class:"fetch-text"},yi={key:0,class:"model-select-container"},xi={class:"model-count"},ki={class:"settings-item"},Si={class:"prompt-format-selector"},Ci={class:"settings-item"},_i=["disabled"],wi=je({__name:"OcrSettings",setup(t){const i=[{label:"MangaOCR (日语专用)",value:"manga_ocr"},{label:"PaddleOCR (多语言)",value:"paddle_ocr"},{label:"百度OCR",value:"baidu_ocr"},{label:"AI视觉OCR",value:"ai_vision"}],l=[{label:"标准版",value:"standard"},{label:"高精度版",value:"high_precision"}],s=[{label:"自动检测",value:"auto_detect"},{label:"中英文混合",value:"CHN_ENG"},{label:"英文",value:"ENG"},{label:"日语",value:"JAP"},{label:"韩语",value:"KOR"},{label:"法语",value:"FRE"},{label:"德语",value:"GER"},{label:"俄语",value:"RUS"}],n=[{label:"SiliconFlow (硅基流动)",value:"siliconflow"},{label:"火山引擎",value:"volcano"},{label:"Google Gemini",value:"gemini"},{label:"自定义 OpenAI 兼容服务",value:"custom_openai_vision"}],a=[{label:"普通提示词",value:!1},{label:"JSON提示词",value:!0}],o=[{label:"🚀 常用语言",options:[{label:"日语",value:"japanese"},{label:"英语",value:"en"},{label:"简体中文",value:"chinese"},{label:"繁体中文",value:"chinese_cht"},{label:"韩语",value:"korean"}]},{label:"🌍 拉丁语系",options:[{label:"法语",value:"french"},{label:"德语",value:"german"},{label:"西班牙语",value:"spanish"},{label:"意大利语",value:"italian"},{label:"葡萄牙语",value:"portuguese"}]},{label:"🌏 其他语系",options:[{label:"俄语",value:"russian"}]}],b=Qe(),m=ee(()=>b.settings),T=ct(),x=h(!1),L=h(!1),ne=h(!1),ie=h(!1),Q=h(!1),v=h([]),Z=ee(()=>{const F=[{label:"-- 选择模型 --",value:""}];return v.value.forEach(g=>{F.push({label:g,value:g})}),F});function Y(){b.saveToStorage()}function p(){b.saveToStorage(),console.log(`源语言已切换为: ${b.settings.sourceLanguage}`)}function u(){switch(b.settings.ocrEngine){case"manga_ocr":return"MangaOCR 专为日语漫画优化，源语言设置不影响识别";case"paddle_ocr":return"PaddleOCR 会根据源语言加载对应的识别模型";case"baidu_ocr":return"百度OCR 使用独立的源语言设置（见下方）";case"ai_vision":return"AI视觉OCR 通过提示词指定识别语言";default:return"选择要识别的原文语言"}}function C(F){b.setAiVisionOcrProvider(F),v.value=[]}function D(){b.settings.aiVisionOcr.isJsonMode?b.settings.aiVisionOcr.prompt=To:b.settings.aiVisionOcr.prompt=Io,b.saveToStorage()}async function k(){const F=m.value.baiduOcr.apiKey?.trim(),g=m.value.baiduOcr.secretKey?.trim();if(!F||!g){T.warning("请填写百度OCR的API Key和Secret Key");return}ie.value=!0,T.info("正在测试百度OCR连接...");try{const _=await Ne.testBaiduOcrConnection(F,g);_.success?T.success(_.message||"百度OCR连接成功!"):T.error(_.message||_.error||"百度OCR连接失败")}catch(_){const B=_ instanceof Error?_.message:"连接测试失败";T.error(B)}finally{ie.value=!1}}async function J(){ie.value=!0;try{const F=b.settings.aiVisionOcr,g=await Ne.testAiVisionOcrConnection({provider:F.provider,apiKey:F.apiKey,modelName:F.modelName,customBaseUrl:F.customBaseUrl,prompt:F.prompt});g.success?T.success("AI视觉OCR连接成功"):T.error(`AI视觉OCR连接失败: ${g.error||"未知错误"}`)}catch(F){const g=F instanceof Error?F.message:"连接测试失败";T.error(g)}finally{ie.value=!1}}async function te(){const F=b.settings.aiVisionOcr,g=F.provider,_=F.apiKey?.trim(),B=F.customBaseUrl?.trim();if(!_){T.warning("请先填写 API Key");return}if(!["siliconflow","volcano","gemini","custom_openai_vision"].includes(g)){T.warning("当前服务商不支持自动获取模型列表");return}if(g==="custom_openai_vision"&&!B){T.warning("自定义服务需要先填写 Base URL");return}Q.value=!0;try{const N=await Ne.fetchModels(g,_,B);N.success&&N.models&&N.models.length>0?(v.value=N.models.map(M=>M.id),T.success(`获取到 ${N.models.length} 个模型`)):T.warning(N.message||"未获取到可用模型")}catch(N){const M=N instanceof Error?N.message:"获取模型列表失败";T.error(M)}finally{Q.value=!1}}function de(F,g){b.updateAiVisionOcr({prompt:F}),T.success(`已应用提示词: ${g}`)}return(F,g)=>(U(),H("div",Ol,[e("div",zl,[g[19]||(g[19]=e("div",{class:"settings-group-title"},"OCR引擎选择",-1)),e("div",Vl,[g[17]||(g[17]=e("label",{for:"settingsOcrEngine"},"OCR引擎:",-1)),Ie(We,{"model-value":m.value.ocrEngine,options:i,onChange:g[0]||(g[0]=_=>{m.value.ocrEngine=_,Y()})},null,8,["model-value"])]),ae(e("div",Nl,[g[18]||(g[18]=e("label",{for:"settingsSourceLanguage"},"源语言:",-1)),Ie(We,{"model-value":m.value.sourceLanguage,groups:o,onChange:g[1]||(g[1]=_=>{m.value.sourceLanguage=_,p()})},null,8,["model-value"]),e("div",Wl,fe(u()),1)],512),[[Ke,m.value.ocrEngine==="paddle_ocr"]])]),ae(e("div",Kl,[g[24]||(g[24]=e("div",{class:"settings-group-title"},"百度OCR 设置",-1)),e("div",ql,[e("div",Hl,[g[20]||(g[20]=e("label",{for:"settingsBaiduApiKey"},"API Key:",-1)),e("div",Yl,[ae(e("input",{type:x.value?"text":"password",id:"settingsBaiduApiKey","onUpdate:modelValue":g[2]||(g[2]=_=>m.value.baiduOcr.apiKey=_),class:"secure-input",placeholder:"请输入百度OCR API Key",autocomplete:"off"},null,8,Jl),[[kt,m.value.baiduOcr.apiKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:g[3]||(g[3]=_=>x.value=!x.value)},[x.value?(U(),H("span",jl,"👁‍🗨")):(U(),H("span",Xl,"👁"))])])]),e("div",Gl,[g[21]||(g[21]=e("label",{for:"settingsBaiduSecretKey"},"Secret Key:",-1)),e("div",Zl,[ae(e("input",{type:L.value?"text":"password",id:"settingsBaiduSecretKey","onUpdate:modelValue":g[4]||(g[4]=_=>m.value.baiduOcr.secretKey=_),class:"secure-input",placeholder:"请输入Secret Key",autocomplete:"off"},null,8,Ql),[[kt,m.value.baiduOcr.secretKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:g[5]||(g[5]=_=>L.value=!L.value)},[L.value?(U(),H("span",ti,"👁‍🗨")):(U(),H("span",ei,"👁"))])])])]),e("div",ni,[e("div",oi,[g[22]||(g[22]=e("label",{for:"settingsBaiduVersion"},"识别版本:",-1)),Ie(We,{"model-value":m.value.baiduOcr.version,options:l,onChange:g[6]||(g[6]=_=>m.value.baiduOcr.version=_)},null,8,["model-value"])]),e("div",ai,[g[23]||(g[23]=e("label",{for:"settingsBaiduSourceLanguage"},"源语言:",-1)),Ie(We,{"model-value":m.value.baiduOcr.sourceLanguage,options:s,onChange:g[7]||(g[7]=_=>m.value.baiduOcr.sourceLanguage=_)},null,8,["model-value"])])]),e("button",{class:"settings-test-btn",onClick:k,disabled:ie.value},fe(ie.value?"测试中...":"🔗 测试连接"),9,si)],512),[[Ke,m.value.ocrEngine==="baidu_ocr"]]),ae(e("div",li,[g[34]||(g[34]=e("div",{class:"settings-group-title"},"AI视觉OCR 设置",-1)),e("div",ii,[e("div",ri,[g[25]||(g[25]=e("label",{for:"settingsAiVisionProvider"},"服务商:",-1)),Ie(We,{"model-value":m.value.aiVisionOcr.provider,options:n,onChange:g[8]||(g[8]=_=>C(_))},null,8,["model-value"])]),e("div",ui,[g[26]||(g[26]=e("label",{for:"settingsAiVisionApiKey"},"API Key:",-1)),e("div",ci,[ae(e("input",{type:ne.value?"text":"password",id:"settingsAiVisionApiKey","onUpdate:modelValue":g[9]||(g[9]=_=>m.value.aiVisionOcr.apiKey=_),class:"secure-input",placeholder:"请输入API Key",autocomplete:"off"},null,8,di),[[kt,m.value.aiVisionOcr.apiKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:g[10]||(g[10]=_=>ne.value=!ne.value)},[ne.value?(U(),H("span",vi,"👁‍🗨")):(U(),H("span",gi,"👁"))])])])]),ae(e("div",bi,[g[27]||(g[27]=e("label",{for:"settingsCustomAiVisionBaseUrl"},"Base URL:",-1)),ae(e("input",{type:"text",id:"settingsCustomAiVisionBaseUrl","onUpdate:modelValue":g[11]||(g[11]=_=>m.value.aiVisionOcr.customBaseUrl=_),placeholder:"例如: https://api.example.com/v1"},null,512),[[Me,m.value.aiVisionOcr.customBaseUrl]])],512),[[Ke,m.value.aiVisionOcr.provider==="custom_openai_vision"]]),e("div",pi,[g[29]||(g[29]=e("label",{for:"settingsAiVisionModelName"},"模型名称:",-1)),e("div",fi,[ae(e("input",{type:"text",id:"settingsAiVisionModelName","onUpdate:modelValue":g[12]||(g[12]=_=>m.value.aiVisionOcr.modelName=_),placeholder:"如: silicon-llava2-34b"},null,512),[[Me,m.value.aiVisionOcr.modelName]]),e("button",{type:"button",class:"fetch-models-btn",title:"获取可用模型列表",onClick:te,disabled:Q.value},[g[28]||(g[28]=e("span",{class:"fetch-icon"},"🔍",-1)),e("span",hi,fe(Q.value?"获取中...":"获取模型"),1)],8,mi)]),v.value.length>0?(U(),H("div",yi,[Ie(We,{"model-value":m.value.aiVisionOcr.modelName,options:Z.value,onChange:g[13]||(g[13]=_=>m.value.aiVisionOcr.modelName=_)},null,8,["model-value","options"]),e("span",xi,"共 "+fe(v.value.length)+" 个模型",1)])):Te("",!0)]),e("div",ki,[g[31]||(g[31]=e("label",{for:"settingsAiVisionOcrPrompt"},"OCR提示词:",-1)),ae(e("textarea",{id:"settingsAiVisionOcrPrompt","onUpdate:modelValue":g[14]||(g[14]=_=>m.value.aiVisionOcr.prompt=_),rows:"3",placeholder:"AI视觉OCR提示词"},null,512),[[Me,m.value.aiVisionOcr.prompt]]),Ie(Tt,{"prompt-type":"ai_vision_ocr",onSelect:de}),e("div",Si,[Ie(We,{"model-value":m.value.aiVisionOcr.isJsonMode,options:a,onChange:g[15]||(g[15]=_=>{m.value.aiVisionOcr.isJsonMode=_,D()})},null,8,["model-value"]),g[30]||(g[30]=e("span",{class:"input-hint"},"JSON格式输出更结构化",-1))])]),e("div",Ci,[g[32]||(g[32]=e("label",{for:"settingsRpmAiVisionOcr"},"RPM限制 (每分钟请求数):",-1)),ae(e("input",{type:"number",id:"settingsRpmAiVisionOcr","onUpdate:modelValue":g[16]||(g[16]=_=>m.value.aiVisionOcr.rpmLimit=_),min:"0",step:"1"},null,512),[[Me,m.value.aiVisionOcr.rpmLimit,void 0,{number:!0}]]),g[33]||(g[33]=e("div",{class:"input-hint"},"0 表示无限制",-1))]),e("button",{class:"settings-test-btn",onClick:J,disabled:ie.value},fe(ie.value?"测试中...":"🔗 测试连接"),9,_i)],512),[[Ke,m.value.ocrEngine==="ai_vision"]])]))}}),$i=Xe(wi,[["__scopeId","data-v-a2055ddd"]]),Ti={class:"translation-settings"},Ii={class:"settings-group"},Di={class:"settings-row"},Ri={class:"settings-item"},Mi={class:"settings-item"},Bi={for:"settingsApiKey"},Ei={class:"password-input-wrapper"},Pi=["type","placeholder"],Ai={key:0,class:"eye-icon"},Fi={key:1,class:"eye-off-icon"},Li={class:"settings-item"},Ui={class:"settings-item"},Oi={for:"settingsModelName"},zi={class:"model-input-with-fetch"},Vi=["placeholder"],Ni=["disabled"],Wi={class:"fetch-text"},Ki={key:0,class:"model-select-container"},qi={class:"model-count"},Hi={class:"settings-item"},Yi={class:"local-model-list"},Ji={key:0,class:"model-list-container"},Xi=["disabled"],ji={key:1,class:"model-hint"},Gi={key:1,class:"model-list-container"},Zi=["disabled"],Qi={key:1,class:"model-hint"},er={class:"settings-row"},tr={class:"settings-item"},nr={class:"settings-item"},or={class:"settings-item"},ar=["disabled"],sr={class:"settings-item"},lr=["disabled"],ir={class:"settings-group"},rr={class:"settings-item"},ur={class:"prompt-format-selector"},cr={class:"settings-item"},dr={class:"checkbox-label"},gr={class:"settings-item"},vr=je({__name:"TranslationSettings",setup(t){const i=[{label:"SiliconFlow",value:"siliconflow"},{label:"DeepSeek",value:"deepseek"},{label:"火山引擎",value:"volcano"},{label:"彩云小译",value:"caiyun"},{label:"百度翻译",value:"baidu_translate"},{label:"有道翻译",value:"youdao_translate"},{label:"Google Gemini",value:"gemini"},{label:"Ollama (本地)",value:"ollama"},{label:"Sakura (本地)",value:"sakura"},{label:"自定义 OpenAI 兼容服务",value:"custom_openai"}],l=[{label:"普通提示词",value:"normal"},{label:"JSON提示词",value:"json"}],s=Qe(),n=ct(),a=h({modelProvider:s.settings.translation.provider,apiKey:s.settings.translation.apiKey,modelName:s.settings.translation.modelName,customBaseUrl:s.settings.translation.customBaseUrl,rpmTranslation:s.settings.translation.rpmLimit,translationMaxRetries:s.settings.translation.maxRetries,promptContent:s.settings.translatePrompt,translatePromptMode:s.settings.translation.isJsonMode?"json":"normal",enableTextboxPrompt:s.settings.useTextboxPrompt,textboxPromptContent:s.settings.textboxPrompt}),o=h(!1),b=h(!1),m=h(!1),T=h([]),x=h([]),L=h([]),ne=ee(()=>{const M=[{label:"-- 选择模型 --",value:""}];return T.value.forEach(f=>M.push({label:f,value:f})),M}),ie=ee(()=>{const M=[{label:"-- 选择模型 --",value:""}];return x.value.forEach(f=>M.push({label:f,value:f})),M}),Q=ee(()=>{const M=[{label:"-- 选择模型 --",value:""}];return L.value.forEach(f=>M.push({label:f,value:f})),M}),v=ee(()=>["ollama","sakura"].includes(a.value.modelProvider)),Z=ee(()=>!["ollama","sakura","caiyun","baidu_translate","youdao_translate"].includes(a.value.modelProvider)),Y=ee(()=>["siliconflow","deepseek","volcano","gemini","custom_openai"].includes(a.value.modelProvider)),p=ee(()=>{switch(a.value.modelProvider){case"baidu_translate":return"App ID";case"youdao_translate":return"App Key";case"caiyun":return"API Token";default:return"API Key"}}),u=ee(()=>{switch(a.value.modelProvider){case"baidu_translate":return"请输入百度翻译App ID";case"youdao_translate":return"请输入有道翻译应用ID";case"caiyun":return"请输入彩云小译Token";default:return"请输入API Key"}}),C=ee(()=>{switch(a.value.modelProvider){case"baidu_translate":return"App Key";case"youdao_translate":return"App Secret";case"caiyun":return"源语言 (可选)";default:return"模型名称"}}),D=ee(()=>{switch(a.value.modelProvider){case"baidu_translate":return"请输入百度翻译App Key";case"youdao_translate":return"请输入有道翻译应用密钥";case"caiyun":return"可选: auto/日语/英语";default:return"请输入模型名称"}});function k(){const M=a.value.modelProvider;s.setTranslationProvider(M),a.value.apiKey=s.settings.translation.apiKey,a.value.modelName=s.settings.translation.modelName,a.value.customBaseUrl=s.settings.translation.customBaseUrl,a.value.rpmTranslation=s.settings.translation.rpmLimit,a.value.translationMaxRetries=s.settings.translation.maxRetries,T.value=[]}function J(){const M=a.value.translatePromptMode==="json";M?a.value.promptContent=Do:a.value.promptContent=Ro,s.updateTranslationService({isJsonMode:M}),s.setTranslatePrompt(a.value.promptContent)}Ye(()=>a.value.apiKey,M=>{s.updateTranslationService({apiKey:M})}),Ye(()=>a.value.modelName,M=>{s.updateTranslationService({modelName:M})}),Ye(()=>a.value.customBaseUrl,M=>{s.updateTranslationService({customBaseUrl:M})}),Ye(()=>a.value.rpmTranslation,M=>{s.updateTranslationService({rpmLimit:M})}),Ye(()=>a.value.translationMaxRetries,M=>{s.updateTranslationService({maxRetries:M})}),Ye(()=>a.value.promptContent,M=>{s.setTranslatePrompt(M)}),Ye(()=>a.value.enableTextboxPrompt,M=>{s.setUseTextboxPrompt(M)}),Ye(()=>a.value.textboxPromptContent,M=>{s.setTextboxPrompt(M)});async function te(){const M=a.value.modelProvider,f=a.value.apiKey?.trim(),S=a.value.customBaseUrl?.trim();if(!f){n.warning("请先填写 API Key");return}if(!["siliconflow","deepseek","volcano","gemini","custom_openai"].includes(M)){n.warning(`${de(M)} 不支持自动获取模型列表`);return}if(M==="custom_openai"&&!S){n.warning("自定义服务需要先填写 Base URL");return}m.value=!0;try{const R=await Ne.fetchModels(M,f,S);R.success&&R.models&&R.models.length>0?(T.value=R.models.map(E=>E.id),n.success(`获取到 ${R.models.length} 个模型`)):n.warning(R.message||"未获取到可用模型")}catch(R){const E=R instanceof Error?R.message:"获取模型列表失败";n.error(E)}finally{m.value=!1}}function de(M){return{siliconflow:"SiliconFlow",deepseek:"DeepSeek",volcano:"火山引擎",gemini:"Google Gemini",custom_openai:"自定义OpenAI",ollama:"Ollama",sakura:"Sakura",caiyun:"彩云小译",baidu_translate:"百度翻译",youdao_translate:"有道翻译"}[M]||M}async function F(){m.value=!0;try{const M=await Ne.testOllamaConnection();M.success&&M.models?(x.value=M.models,n.success(`获取到 ${M.models.length} 个Ollama模型`)):n.error(M.error||"Ollama连接失败")}catch(M){const f=M instanceof Error?M.message:"获取Ollama模型失败";n.error(f)}finally{m.value=!1}}async function g(){m.value=!0;try{const M=await Ne.testSakuraConnection();M.success&&M.models?(L.value=M.models,n.success(`获取到 ${M.models.length} 个Sakura模型`)):n.error(M.error||"Sakura连接失败")}catch(M){const f=M instanceof Error?M.message:"获取Sakura模型失败";n.error(f)}finally{m.value=!1}}async function _(){b.value=!0;try{let M;a.value.modelProvider==="ollama"?M=await Ne.testOllamaConnection():M=await Ne.testSakuraConnection(),M.success?n.success(`${a.value.modelProvider==="ollama"?"Ollama":"Sakura"} 连接成功`):n.error(M.error||"连接失败")}catch(M){const f=M instanceof Error?M.message:"连接测试失败";n.error(f)}finally{b.value=!1}}async function B(){const M=a.value.modelProvider,f=a.value.apiKey?.trim(),S=a.value.modelName?.trim(),oe=a.value.customBaseUrl?.trim();if(!f){n.warning("请先填写 API Key");return}if(M!=="caiyun"&&!S){n.warning("请填写模型名称");return}if(M==="custom_openai"&&!oe){n.warning("自定义服务需要填写 Base URL");return}b.value=!0,n.info("正在测试连接...");try{let R;switch(M){case"baidu_translate":R=await Ne.testBaiduTranslateConnection(f,S);break;case"youdao_translate":R=await Ne.testYoudaoTranslateConnection(f,S);break;default:R=await Ne.testAiTranslateConnection({provider:M,apiKey:f,modelName:S,baseUrl:oe})}R.success?n.success(R.message||`${de(M)} 连接成功!`):n.error(R.message||R.error||"连接失败")}catch(R){const E=R instanceof Error?R.message:"连接测试失败";n.error(E)}finally{b.value=!1}}function q(M,f){a.value.promptContent=M,n.success(`已应用提示词: ${f}`)}function N(M,f){a.value.textboxPromptContent=M,n.success(`已应用提示词: ${f}`)}return(M,f)=>(U(),H("div",Ti,[e("div",Ii,[f[21]||(f[21]=e("div",{class:"settings-group-title"},"翻译服务配置",-1)),e("div",Di,[e("div",Ri,[f[14]||(f[14]=e("label",{for:"settingsModelProvider"},"翻译服务商:",-1)),Ie(We,{"model-value":a.value.modelProvider,options:i,onChange:f[0]||(f[0]=S=>{a.value.modelProvider=S,k()})},null,8,["model-value"])]),ae(e("div",Mi,[e("label",Bi,fe(p.value)+":",1),e("div",Ei,[ae(e("input",{type:o.value?"text":"password",id:"settingsApiKey","onUpdate:modelValue":f[1]||(f[1]=S=>a.value.apiKey=S),class:"secure-input",placeholder:u.value,autocomplete:"off"},null,8,Pi),[[kt,a.value.apiKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:f[2]||(f[2]=S=>o.value=!o.value)},[o.value?(U(),H("span",Fi,"👁‍🗨")):(U(),H("span",Ai,"👁"))])])],512),[[Ke,!v.value]])]),ae(e("div",Li,[f[15]||(f[15]=e("label",{for:"settingsCustomBaseUrl"},"Base URL:",-1)),ae(e("input",{type:"text",id:"settingsCustomBaseUrl","onUpdate:modelValue":f[3]||(f[3]=S=>a.value.customBaseUrl=S),placeholder:"例如: https://api.example.com/v1"},null,512),[[Me,a.value.customBaseUrl]])],512),[[Ke,a.value.modelProvider==="custom_openai"]]),ae(e("div",Ui,[e("label",Oi,fe(C.value)+":",1),e("div",zi,[ae(e("input",{type:"text",id:"settingsModelName","onUpdate:modelValue":f[4]||(f[4]=S=>a.value.modelName=S),placeholder:D.value},null,8,Vi),[[Me,a.value.modelName]]),ae(e("button",{type:"button",class:"fetch-models-btn",title:"获取可用模型列表",onClick:te,disabled:m.value},[f[16]||(f[16]=e("span",{class:"fetch-icon"},"🔍",-1)),e("span",Wi,fe(m.value?"获取中...":"获取模型"),1)],8,Ni),[[Ke,Y.value]])]),T.value.length>0?(U(),H("div",Ki,[Ie(We,{"model-value":a.value.modelName,options:ne.value,onChange:f[5]||(f[5]=S=>{a.value.modelName=S})},null,8,["model-value","options"]),e("span",qi,"共 "+fe(T.value.length)+" 个模型",1)])):Te("",!0)],512),[[Ke,!v.value]]),ae(e("div",Hi,[f[17]||(f[17]=e("label",null,"本地模型:",-1)),e("div",Yi,[a.value.modelProvider==="ollama"?(U(),H("div",Ji,[e("button",{class:"settings-test-btn",onClick:F,disabled:m.value},fe(m.value?"获取中...":"🔄 刷新模型列表"),9,Xi),x.value.length>0?(U(),rt(We,{key:0,"model-value":a.value.modelName,options:ie.value,onChange:f[6]||(f[6]=S=>a.value.modelName=S)},null,8,["model-value","options"])):(U(),H("p",ji,"点击刷新获取可用模型"))])):a.value.modelProvider==="sakura"?(U(),H("div",Gi,[e("button",{class:"settings-test-btn",onClick:g,disabled:m.value},fe(m.value?"获取中...":"🔄 刷新模型列表"),9,Zi),L.value.length>0?(U(),rt(We,{key:0,"model-value":a.value.modelName,options:Q.value,onChange:f[7]||(f[7]=S=>a.value.modelName=S)},null,8,["model-value","options"])):(U(),H("p",Qi,"点击刷新获取可用模型"))])):Te("",!0)])],512),[[Ke,v.value]]),ae(e("div",er,[e("div",tr,[f[18]||(f[18]=e("label",{for:"settingsRpmTranslation"},"RPM限制:",-1)),ae(e("input",{type:"number",id:"settingsRpmTranslation","onUpdate:modelValue":f[8]||(f[8]=S=>a.value.rpmTranslation=S),min:"0",step:"1"},null,512),[[Me,a.value.rpmTranslation,void 0,{number:!0}]]),f[19]||(f[19]=e("div",{class:"input-hint"},"每分钟请求数，0表示无限制",-1))]),e("div",nr,[f[20]||(f[20]=e("label",{for:"settingsTranslationMaxRetries"},"重试次数:",-1)),ae(e("input",{type:"number",id:"settingsTranslationMaxRetries","onUpdate:modelValue":f[9]||(f[9]=S=>a.value.translationMaxRetries=S),min:"0",max:"10",step:"1"},null,512),[[Me,a.value.translationMaxRetries,void 0,{number:!0}]])])],512),[[Ke,Z.value]]),ae(e("div",or,[e("button",{class:"settings-test-btn",onClick:_,disabled:b.value},fe(b.value?"测试中...":"🔗 测试连接"),9,ar)],512),[[Ke,v.value]]),ae(e("div",sr,[e("button",{class:"settings-test-btn",onClick:B,disabled:b.value},fe(b.value?"测试中...":"🔗 测试连接"),9,lr)],512),[[Ke,!v.value]])]),e("div",ir,[f[26]||(f[26]=e("div",{class:"settings-group-title"},"提示词设置",-1)),e("div",rr,[f[23]||(f[23]=e("label",{for:"settingsPromptContent"},"翻译提示词:",-1)),ae(e("textarea",{id:"settingsPromptContent","onUpdate:modelValue":f[10]||(f[10]=S=>a.value.promptContent=S),rows:"4",placeholder:"翻译提示词"},null,512),[[Me,a.value.promptContent]]),e("div",ur,[Ie(We,{"model-value":a.value.translatePromptMode,options:l,onChange:f[11]||(f[11]=S=>{a.value.translatePromptMode=S,J()})},null,8,["model-value"]),f[22]||(f[22]=e("span",{class:"input-hint"},"JSON格式输出更结构化",-1))]),Ie(Tt,{"prompt-type":"translate",onSelect:q})]),e("div",cr,[e("label",dr,[ae(e("input",{type:"checkbox","onUpdate:modelValue":f[12]||(f[12]=S=>a.value.enableTextboxPrompt=S)},null,512),[[et,a.value.enableTextboxPrompt]]),f[24]||(f[24]=Fe(" 启用文本框提示词 ",-1))])]),ae(e("div",gr,[f[25]||(f[25]=e("label",{for:"settingsTextboxPromptContent"},"文本框提示词:",-1)),ae(e("textarea",{id:"settingsTextboxPromptContent","onUpdate:modelValue":f[13]||(f[13]=S=>a.value.textboxPromptContent=S),rows:"3",placeholder:"文本框提示词"},null,512),[[Me,a.value.textboxPromptContent]]),Ie(Tt,{"prompt-type":"textbox",onSelect:N})],512),[[Ke,a.value.enableTextboxPrompt]])])]))}}),br=Xe(vr,[["__scopeId","data-v-dd4855dd"]]),pr={class:"detection-settings"},fr={class:"settings-group"},mr={class:"settings-item"},hr={class:"settings-group"},yr={class:"settings-item"},xr={class:"settings-row"},kr={class:"settings-item"},Sr={class:"settings-item"},Cr={class:"settings-row"},_r={class:"settings-item"},wr={class:"settings-item"},$r={class:"settings-group"},Tr={class:"settings-item"},Ir={class:"checkbox-label"},Dr={class:"settings-row"},Rr={class:"settings-item"},Mr={class:"settings-item"},Br={class:"settings-group"},Er={class:"settings-item"},Pr={class:"checkbox-label"},Ar={class:"settings-group"},Fr=["disabled"],Lr=je({__name:"DetectionSettings",setup(t){const i=[{label:"CTD (Comic Text Detector)",value:"ctd"},{label:"YOLO",value:"yolo"},{label:"YOLOv5",value:"yolov5"},{label:"Default (DBNet)",value:"default"}],l=Qe(),s=ct(),n=Ao({textDetector:l.settings.textDetector,boxExpandRatio:l.settings.boxExpand.ratio,boxExpandTop:l.settings.boxExpand.top,boxExpandBottom:l.settings.boxExpand.bottom,boxExpandLeft:l.settings.boxExpand.left,boxExpandRight:l.settings.boxExpand.right,usePreciseMask:l.settings.preciseMask.enabled,maskDilateSize:l.settings.preciseMask.dilateSize,maskBoxExpandRatio:l.settings.preciseMask.boxExpandRatio,showDetectionDebug:l.settings.showDetectionDebug}),a=h(!1),o=ee(()=>["ctd","default"].includes(n.textDetector));Ye(()=>n.textDetector,T=>{l.setTextDetector(T)}),Ye(()=>n.boxExpandRatio,T=>{l.updateBoxExpand({ratio:T})}),Ye(()=>n.boxExpandTop,T=>{l.updateBoxExpand({top:T})}),Ye(()=>n.boxExpandBottom,T=>{l.updateBoxExpand({bottom:T})}),Ye(()=>n.boxExpandLeft,T=>{l.updateBoxExpand({left:T})}),Ye(()=>n.boxExpandRight,T=>{l.updateBoxExpand({right:T})}),Ye(()=>n.usePreciseMask,T=>{l.updatePreciseMask({enabled:T})}),Ye(()=>n.maskDilateSize,T=>{l.updatePreciseMask({dilateSize:T})}),Ye(()=>n.maskBoxExpandRatio,T=>{l.updatePreciseMask({boxExpandRatio:T})}),Ye(()=>n.showDetectionDebug,T=>{l.setShowDetectionDebug(T)});function b(){o.value||(n.usePreciseMask=!1)}async function m(){a.value=!0;try{const T=await Ne.testLamaRepair();T.success?s.success("LAMA修复功能正常"):s.error(`LAMA修复测试失败: ${T.error||"未知错误"}`)}catch(T){const x=T instanceof Error?T.message:"测试失败";s.error(x)}finally{a.value=!1}}return(T,x)=>(U(),H("div",pr,[e("div",fr,[x[11]||(x[11]=e("div",{class:"settings-group-title"},"文字检测器",-1)),e("div",mr,[x[10]||(x[10]=e("label",{for:"settingsTextDetector"},"检测器类型:",-1)),Ie(We,{modelValue:n.textDetector,"onUpdate:modelValue":x[0]||(x[0]=L=>n.textDetector=L),options:i,onChange:b},null,8,["modelValue"])])]),e("div",hr,[x[18]||(x[18]=e("div",{class:"settings-group-title"},"文本框扩展参数",-1)),e("div",yr,[x[12]||(x[12]=e("label",{for:"settingsBoxExpandRatio"},"整体扩展 (%):",-1)),ae(e("input",{type:"number",id:"settingsBoxExpandRatio","onUpdate:modelValue":x[1]||(x[1]=L=>n.boxExpandRatio=L),min:"0",max:"50",step:"1"},null,512),[[Me,n.boxExpandRatio,void 0,{number:!0}]]),x[13]||(x[13]=e("div",{class:"input-hint"},"向四周均匀扩展的百分比 (0-50%)",-1))]),e("div",xr,[e("div",kr,[x[14]||(x[14]=e("label",{for:"settingsBoxExpandTop"},"上方扩展 (%):",-1)),ae(e("input",{type:"number",id:"settingsBoxExpandTop","onUpdate:modelValue":x[2]||(x[2]=L=>n.boxExpandTop=L),min:"0",max:"50",step:"1"},null,512),[[Me,n.boxExpandTop,void 0,{number:!0}]])]),e("div",Sr,[x[15]||(x[15]=e("label",{for:"settingsBoxExpandBottom"},"下方扩展 (%):",-1)),ae(e("input",{type:"number",id:"settingsBoxExpandBottom","onUpdate:modelValue":x[3]||(x[3]=L=>n.boxExpandBottom=L),min:"0",max:"50",step:"1"},null,512),[[Me,n.boxExpandBottom,void 0,{number:!0}]])])]),e("div",Cr,[e("div",_r,[x[16]||(x[16]=e("label",{for:"settingsBoxExpandLeft"},"左侧扩展 (%):",-1)),ae(e("input",{type:"number",id:"settingsBoxExpandLeft","onUpdate:modelValue":x[4]||(x[4]=L=>n.boxExpandLeft=L),min:"0",max:"50",step:"1"},null,512),[[Me,n.boxExpandLeft,void 0,{number:!0}]])]),e("div",wr,[x[17]||(x[17]=e("label",{for:"settingsBoxExpandRight"},"右侧扩展 (%):",-1)),ae(e("input",{type:"number",id:"settingsBoxExpandRight","onUpdate:modelValue":x[5]||(x[5]=L=>n.boxExpandRight=L),min:"0",max:"50",step:"1"},null,512),[[Me,n.boxExpandRight,void 0,{number:!0}]])])])]),ae(e("div",$r,[x[25]||(x[25]=e("div",{class:"settings-group-title"},"精确文字掩膜",-1)),e("div",Tr,[e("label",Ir,[ae(e("input",{type:"checkbox","onUpdate:modelValue":x[6]||(x[6]=L=>n.usePreciseMask=L)},null,512),[[et,n.usePreciseMask]]),x[19]||(x[19]=Fe(" 启用精确文字掩膜 ",-1))]),x[20]||(x[20]=e("div",{class:"input-hint"},"使用更精确的文字区域掩膜进行修复",-1))]),ae(e("div",Dr,[e("div",Rr,[x[21]||(x[21]=e("label",{for:"settingsMaskDilateSize"},"膨胀大小:",-1)),ae(e("input",{type:"number",id:"settingsMaskDilateSize","onUpdate:modelValue":x[7]||(x[7]=L=>n.maskDilateSize=L),min:"0",step:"1"},null,512),[[Me,n.maskDilateSize,void 0,{number:!0}]]),x[22]||(x[22]=e("div",{class:"input-hint"},"掩膜膨胀像素数",-1))]),e("div",Mr,[x[23]||(x[23]=e("label",{for:"settingsMaskBoxExpandRatio"},"标注框扩大比例 (%):",-1)),ae(e("input",{type:"number",id:"settingsMaskBoxExpandRatio","onUpdate:modelValue":x[8]||(x[8]=L=>n.maskBoxExpandRatio=L),min:"0",max:"100",step:"1"},null,512),[[Me,n.maskBoxExpandRatio,void 0,{number:!0}]]),x[24]||(x[24]=e("div",{class:"input-hint"},"标注框区域扩大百分比",-1))])],512),[[Ke,n.usePreciseMask]])],512),[[Ke,o.value]]),e("div",Br,[x[28]||(x[28]=e("div",{class:"settings-group-title"},"调试选项",-1)),e("div",Er,[e("label",Pr,[ae(e("input",{type:"checkbox","onUpdate:modelValue":x[9]||(x[9]=L=>n.showDetectionDebug=L)},null,512),[[et,n.showDetectionDebug]]),x[26]||(x[26]=Fe(" 显示检测框调试信息 ",-1))]),x[27]||(x[27]=e("div",{class:"input-hint"},"在翻译结果中显示气泡检测框，用于调试",-1))])]),e("div",Ar,[x[29]||(x[29]=e("div",{class:"settings-group-title"},"修复功能测试",-1)),e("button",{class:"settings-test-btn",onClick:m,disabled:a.value},fe(a.value?"测试中...":"🔗 测试LAMA修复"),9,Fr)])]))}}),Ur=Xe(Lr,[["__scopeId","data-v-bc5a98ff"]]),Or={class:"hq-translation-settings"},zr={class:"settings-group"},Vr={class:"settings-row"},Nr={class:"settings-item"},Wr={class:"settings-item"},Kr={class:"password-input-wrapper"},qr=["type"],Hr={key:0,class:"eye-icon"},Yr={key:1,class:"eye-off-icon"},Jr={class:"settings-item"},Xr={class:"settings-item"},jr={class:"model-input-with-fetch"},Gr=["disabled"],Zr={class:"fetch-text"},Qr={key:0,class:"model-select-container"},eu={class:"model-count"},tu={class:"settings-item"},nu=["disabled"],ou={class:"settings-group"},au={class:"settings-row"},su={class:"settings-item"},lu={class:"settings-item"},iu={class:"settings-row"},ru={class:"settings-item"},uu={class:"settings-item"},cu={class:"settings-group"},du={class:"settings-row"},gu={class:"settings-item"},vu={class:"checkbox-label"},bu={class:"settings-item"},pu={class:"settings-row"},fu={class:"settings-item"},mu={class:"checkbox-label"},hu={class:"settings-item"},yu={class:"checkbox-label"},xu={class:"settings-group"},ku={class:"settings-item"},Su=je({__name:"HqTranslationSettings",setup(t){const i=[{label:"SiliconFlow",value:"siliconflow"},{label:"DeepSeek",value:"deepseek"},{label:"火山引擎",value:"volcano"},{label:"Google Gemini",value:"gemini"},{label:"自定义 OpenAI 兼容服务",value:"custom_openai"}],l=[{label:"Gemini风格 (reasoning_effort=low)",value:"gemini"},{label:"火山引擎风格 (thinking=null)",value:"volcano"}],s=Qe(),n=ee(()=>s.settings.hqTranslation),a=ct(),o=h(!1),b=h(!1),m=h([]),T=h(!1),x=ee(()=>{const Y=[{label:"-- 选择模型 --",value:""}];return m.value.forEach(p=>Y.push({label:p,value:p})),Y});function L(Y){s.setHqProvider(Y),m.value=[]}function ne(Y){return{siliconflow:"SiliconFlow",deepseek:"DeepSeek",volcano:"火山引擎",gemini:"Google Gemini",custom_openai:"自定义OpenAI"}[Y]||Y}async function ie(){const Y=n.value.provider,p=n.value.apiKey?.trim(),u=n.value.customBaseUrl?.trim();if(!p){a.warning("请先填写 API Key");return}if(!["siliconflow","deepseek","volcano","gemini","custom_openai"].includes(Y)){a.warning(`${ne(Y)} 不支持自动获取模型列表`);return}if(Y==="custom_openai"&&!u){a.warning("自定义服务需要先填写 Base URL");return}b.value=!0;try{const D=await Ne.fetchModels(Y,p,u);D.success&&D.models&&D.models.length>0?(m.value=D.models.map(k=>k.id),a.success(`获取到 ${D.models.length} 个模型`)):a.warning(D.message||"未获取到可用模型")}catch(D){const k=D instanceof Error?D.message:"获取模型列表失败";a.error(k)}finally{b.value=!1}}async function Q(){const Y=n.value.provider,p=n.value.apiKey?.trim(),u=n.value.modelName?.trim(),C=n.value.customBaseUrl?.trim();if(!p){a.warning("请先填写 API Key");return}if(!u){a.warning("请填写模型名称");return}if(Y==="custom_openai"&&!C){a.warning("自定义服务需要填写 Base URL");return}T.value=!0,a.info("正在测试连接...");try{const D=await Ne.testAiTranslateConnection({provider:Y,apiKey:p,modelName:u,baseUrl:C});D.success?a.success(D.message||`${ne(Y)} 连接成功!`):a.error(D.message||D.error||"连接失败")}catch(D){const k=D instanceof Error?D.message:"连接测试失败";a.error(k)}finally{T.value=!1}}function v(){s.updateHqTranslation({prompt:Mo}),a.success("已重置为默认提示词")}function Z(Y,p){s.updateHqTranslation({prompt:Y}),a.success(`已应用提示词: ${p}`)}return(Y,p)=>(U(),H("div",Or,[e("div",zr,[p[20]||(p[20]=e("div",{class:"settings-group-title"},"高质量翻译服务配置",-1)),e("div",Vr,[e("div",Nr,[p[15]||(p[15]=e("label",{for:"settingsHqTranslateProvider"},"服务商:",-1)),Ie(We,{"model-value":n.value.provider,options:i,onChange:p[0]||(p[0]=u=>L(u))},null,8,["model-value"])]),e("div",Wr,[p[16]||(p[16]=e("label",{for:"settingsHqApiKey"},"API Key:",-1)),e("div",Kr,[ae(e("input",{type:o.value?"text":"password",id:"settingsHqApiKey","onUpdate:modelValue":p[1]||(p[1]=u=>n.value.apiKey=u),class:"secure-input",placeholder:"请输入API Key",autocomplete:"off"},null,8,qr),[[kt,n.value.apiKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:p[2]||(p[2]=u=>o.value=!o.value)},[o.value?(U(),H("span",Yr,"👁‍🗨")):(U(),H("span",Hr,"👁"))])])])]),ae(e("div",Jr,[p[17]||(p[17]=e("label",{for:"settingsHqCustomBaseUrl"},"Base URL:",-1)),ae(e("input",{type:"text",id:"settingsHqCustomBaseUrl","onUpdate:modelValue":p[3]||(p[3]=u=>n.value.customBaseUrl=u),placeholder:"例如: https://api.example.com/v1"},null,512),[[Me,n.value.customBaseUrl]])],512),[[Ke,n.value.provider==="custom_openai"]]),e("div",Xr,[p[19]||(p[19]=e("label",{for:"settingsHqModelName"},"模型名称:",-1)),e("div",jr,[ae(e("input",{type:"text",id:"settingsHqModelName","onUpdate:modelValue":p[4]||(p[4]=u=>n.value.modelName=u),placeholder:"请输入模型名称"},null,512),[[Me,n.value.modelName]]),e("button",{type:"button",class:"fetch-models-btn",title:"获取可用模型列表",onClick:ie,disabled:b.value},[p[18]||(p[18]=e("span",{class:"fetch-icon"},"🔍",-1)),e("span",Zr,fe(b.value?"获取中...":"获取模型"),1)],8,Gr)]),m.value.length>0?(U(),H("div",Qr,[Ie(We,{"model-value":n.value.modelName,options:x.value,onChange:p[5]||(p[5]=u=>n.value.modelName=u)},null,8,["model-value","options"]),e("span",eu,"共 "+fe(m.value.length)+" 个模型",1)])):Te("",!0)]),e("div",tu,[e("button",{class:"settings-test-btn",onClick:Q,disabled:T.value},fe(T.value?"测试中...":"🔗 测试连接"),9,nu)])]),e("div",ou,[p[28]||(p[28]=e("div",{class:"settings-group-title"},"批处理设置",-1)),e("div",au,[e("div",su,[p[21]||(p[21]=e("label",{for:"settingsHqBatchSize"},"批次大小:",-1)),ae(e("input",{type:"number",id:"settingsHqBatchSize","onUpdate:modelValue":p[6]||(p[6]=u=>n.value.batchSize=u),min:"1",max:"10",step:"1"},null,512),[[Me,n.value.batchSize,void 0,{number:!0}]]),p[22]||(p[22]=e("div",{class:"input-hint"},"每批处理的图片数量 (推荐3-5张)",-1))]),e("div",lu,[p[23]||(p[23]=e("label",{for:"settingsHqSessionReset"},"会话重置频率:",-1)),ae(e("input",{type:"number",id:"settingsHqSessionReset","onUpdate:modelValue":p[7]||(p[7]=u=>n.value.sessionReset=u),min:"1",step:"1"},null,512),[[Me,n.value.sessionReset,void 0,{number:!0}]]),p[24]||(p[24]=e("div",{class:"input-hint"},"多少批次后重置上下文",-1))])]),e("div",iu,[e("div",ru,[p[25]||(p[25]=e("label",{for:"settingsHqRpmLimit"},"RPM限制:",-1)),ae(e("input",{type:"number",id:"settingsHqRpmLimit","onUpdate:modelValue":p[8]||(p[8]=u=>n.value.rpmLimit=u),min:"0",step:"1"},null,512),[[Me,n.value.rpmLimit,void 0,{number:!0}]]),p[26]||(p[26]=e("div",{class:"input-hint"},"每分钟请求数，0表示无限制",-1))]),e("div",uu,[p[27]||(p[27]=e("label",{for:"settingsHqMaxRetries"},"重试次数:",-1)),ae(e("input",{type:"number",id:"settingsHqMaxRetries","onUpdate:modelValue":p[9]||(p[9]=u=>n.value.maxRetries=u),min:"0",max:"10",step:"1"},null,512),[[Me,n.value.maxRetries,void 0,{number:!0}]])])])]),e("div",cu,[p[36]||(p[36]=e("div",{class:"settings-group-title"},"高级选项",-1)),e("div",du,[e("div",gu,[e("label",vu,[ae(e("input",{type:"checkbox","onUpdate:modelValue":p[10]||(p[10]=u=>n.value.lowReasoning=u)},null,512),[[et,n.value.lowReasoning]]),p[29]||(p[29]=Fe(" 低推理模式 ",-1))]),p[30]||(p[30]=e("div",{class:"input-hint"},"减少模型推理深度，提高速度",-1))]),e("div",bu,[p[31]||(p[31]=e("label",{for:"settingsHqNoThinkingMethod"},"取消思考方法:",-1)),Ie(We,{"model-value":n.value.noThinkingMethod,options:l,onChange:p[11]||(p[11]=u=>n.value.noThinkingMethod=u)},null,8,["model-value"])])]),e("div",pu,[e("div",fu,[e("label",mu,[ae(e("input",{type:"checkbox","onUpdate:modelValue":p[12]||(p[12]=u=>n.value.forceJsonOutput=u)},null,512),[[et,n.value.forceJsonOutput]]),p[32]||(p[32]=Fe(" 强制JSON输出 ",-1))]),p[33]||(p[33]=e("div",{class:"input-hint"},"使用 response_format: json_object",-1))]),e("div",hu,[e("label",yu,[ae(e("input",{type:"checkbox","onUpdate:modelValue":p[13]||(p[13]=u=>n.value.useStream=u)},null,512),[[et,n.value.useStream]]),p[34]||(p[34]=Fe(" 流式调用 ",-1))]),p[35]||(p[35]=e("div",{class:"input-hint"},"使用流式API调用",-1))])])]),e("div",xu,[p[37]||(p[37]=e("div",{class:"settings-group-title"},"高质量翻译提示词",-1)),e("div",ku,[ae(e("textarea",{id:"settingsHqPrompt","onUpdate:modelValue":p[14]||(p[14]=u=>n.value.prompt=u),rows:"6",placeholder:"高质量翻译提示词"},null,512),[[Me,n.value.prompt]]),Ie(Tt,{"prompt-type":"hq_translate",onSelect:Z}),e("button",{class:"btn btn-secondary btn-sm",onClick:v},"重置为默认")])])]))}}),Cu=Xe(Su,[["__scopeId","data-v-f51d55f6"]]),_u={class:"proofreading-settings"},wu={class:"settings-group"},$u={class:"settings-item"},Tu={class:"checkbox-label"},Iu={class:"settings-item"},Du={class:"settings-group"},Ru={class:"round-header"},Mu={class:"round-title"},Bu=["onClick","disabled"],Eu={class:"round-content"},Pu={class:"settings-item"},Au=["onUpdate:modelValue"],Fu={class:"settings-row"},Lu={class:"settings-item"},Uu={class:"settings-item"},Ou={class:"password-input-wrapper"},zu=["type","onUpdate:modelValue"],Vu=["onClick"],Nu={key:0,class:"eye-icon"},Wu={key:1,class:"eye-off-icon"},Ku={class:"settings-item"},qu=["onUpdate:modelValue"],Hu={class:"settings-item"},Yu={class:"model-input-with-fetch"},Ju=["onUpdate:modelValue"],Xu=["onClick","disabled"],ju={class:"fetch-text"},Gu={key:0,class:"model-select-container"},Zu={class:"model-count"},Qu={class:"settings-item"},ec=["onClick","disabled"],tc={class:"settings-row"},nc={class:"settings-item"},oc=["onUpdate:modelValue"],ac={class:"settings-item"},sc=["onUpdate:modelValue"],lc={class:"settings-item"},ic=["onUpdate:modelValue"],rc={class:"settings-row"},uc={class:"settings-item"},cc={class:"checkbox-label"},dc=["onUpdate:modelValue"],gc={class:"settings-item"},vc={class:"settings-item"},bc={class:"checkbox-label"},pc=["onUpdate:modelValue"],fc={class:"settings-item"},mc=["onUpdate:modelValue"],hc=["onClick"],yc=je({__name:"ProofreadingSettings",setup(t){const i=[{label:"SiliconFlow",value:"siliconflow"},{label:"DeepSeek",value:"deepseek"},{label:"火山引擎",value:"volcano"},{label:"Google Gemini",value:"gemini"},{label:"自定义 OpenAI 兼容服务",value:"custom_openai"}],l=[{label:"Gemini风格",value:"gemini"},{label:"火山引擎风格",value:"volcano"}],s=Qe(),n=ct(),a=h({}),o=h({}),b=h({}),m=ee(()=>s.settings.proofreading.rounds),T=ee({get:()=>s.settings.proofreading.maxRetries,set:p=>s.setProofreadingMaxRetries(p)}),x=ee({get:()=>s.settings.proofreading.enabled,set:p=>s.setProofreadingEnabled(p)});function L(p){const u=b.value[p]||[],C=[{label:"-- 选择模型 --",value:""}];return u.forEach(D=>C.push({label:D,value:D})),C}async function ne(p){const u=m.value[p];if(!u)return;const C=u.provider,D=u.apiKey?.trim(),k=u.customBaseUrl?.trim();if(!D){n.warning("请先填写 API Key");return}if(!["siliconflow","deepseek","volcano","gemini","custom_openai"].includes(C)){n.warning("当前服务商不支持获取模型列表");return}a.value[p]=!0;try{const te=await Ne.fetchModels(C,D,k);te.success&&te.models&&te.models.length>0?(b.value[p]=te.models.map(de=>de.id),n.success(`轮次 ${p+1}: 获取到 ${te.models.length} 个模型`)):n.warning(te.message||"未获取到可用模型")}catch(te){const de=te instanceof Error?te.message:"获取模型列表失败";n.error(de)}finally{a.value[p]=!1}}async function ie(p){const u=m.value[p];if(!u)return;const C=u.provider,D=u.apiKey?.trim(),k=u.modelName?.trim(),J=u.customBaseUrl?.trim();if(!D){n.warning("请先填写 API Key");return}if(!k){n.warning("请填写模型名称");return}o.value[p]=!0,n.info(`正在测试轮次 ${p+1} 的连接...`);try{const te=await Ne.testAiTranslateConnection({provider:C,apiKey:D,modelName:k,baseUrl:J});te.success?n.success(te.message||"连接成功!"):n.error(te.message||te.error||"连接失败")}catch(te){const de=te instanceof Error?te.message:"连接测试失败";n.error(de)}finally{o.value[p]=!1}}function Q(){const p={name:`第${m.value.length+1}轮校对`,provider:"siliconflow",apiKey:"",modelName:"",customBaseUrl:"",batchSize:3,sessionReset:20,rpmLimit:7,lowReasoning:!1,noThinkingMethod:"gemini",forceJsonOutput:!0,prompt:Mn,showApiKey:!1};s.addProofreadingRound(p),n.success("已添加新的校对轮次")}function v(p){if(m.value.length<=1){n.warning("至少需要保留一个校对轮次");return}s.removeProofreadingRound(p),n.success("已删除校对轮次")}function Z(p){s.updateProofreadingRound(p,{prompt:Mn}),n.success("已重置为默认提示词")}function Y(p,u,C){s.updateProofreadingRound(p,{prompt:u}),n.success(`已应用提示词: ${C}`)}return(p,u)=>(U(),H("div",_u,[e("div",wu,[u[5]||(u[5]=e("div",{class:"settings-group-title"},"AI校对设置",-1)),e("div",$u,[e("label",Tu,[ae(e("input",{type:"checkbox","onUpdate:modelValue":u[0]||(u[0]=C=>x.value=C)},null,512),[[et,x.value]]),u[2]||(u[2]=Fe(" 启用AI校对 ",-1))]),u[3]||(u[3]=e("div",{class:"input-hint"},"翻译完成后自动进行AI校对",-1))]),e("div",Iu,[u[4]||(u[4]=e("label",{for:"settingsProofreadingMaxRetries"},"全局重试次数:",-1)),ae(e("input",{type:"number",id:"settingsProofreadingMaxRetries","onUpdate:modelValue":u[1]||(u[1]=C=>T.value=C),min:"0",max:"10",step:"1"},null,512),[[Me,T.value,void 0,{number:!0}]])])]),ae(e("div",Du,[e("div",{class:"settings-group-title"},[u[6]||(u[6]=Fe(" 校对轮次配置 ",-1)),e("button",{class:"btn btn-secondary btn-sm",onClick:Q},"+ 添加轮次")]),(U(!0),H(Ge,null,tt(m.value,(C,D)=>(U(),H("div",{key:D,class:"proofreading-round"},[e("div",Ru,[e("span",Mu,"轮次 "+fe(D+1)+": "+fe(C.name||"未命名"),1),e("button",{class:"btn btn-danger btn-sm",onClick:k=>v(D),disabled:m.value.length<=1}," 删除 ",8,Bu)]),e("div",Eu,[e("div",Pu,[u[7]||(u[7]=e("label",null,"轮次名称:",-1)),ae(e("input",{type:"text","onUpdate:modelValue":k=>C.name=k,placeholder:"如: 第一轮校对"},null,8,Au),[[Me,C.name]])]),e("div",Fu,[e("div",Lu,[u[8]||(u[8]=e("label",null,"服务商:",-1)),Ie(We,{modelValue:C.provider,"onUpdate:modelValue":k=>C.provider=k,options:i},null,8,["modelValue","onUpdate:modelValue"])]),e("div",Uu,[u[9]||(u[9]=e("label",null,"API Key:",-1)),e("div",Ou,[ae(e("input",{type:C.showApiKey?"text":"password","onUpdate:modelValue":k=>C.apiKey=k,class:"secure-input",placeholder:"请输入API Key",autocomplete:"off"},null,8,zu),[[kt,C.apiKey]]),e("button",{type:"button",class:"password-toggle-btn",tabindex:"-1",onClick:k=>C.showApiKey=!C.showApiKey},[C.showApiKey?(U(),H("span",Wu,"👁‍🗨")):(U(),H("span",Nu,"👁"))],8,Vu)])])]),ae(e("div",Ku,[u[10]||(u[10]=e("label",null,"Base URL:",-1)),ae(e("input",{type:"text","onUpdate:modelValue":k=>C.customBaseUrl=k,placeholder:"例如: https://api.example.com/v1"},null,8,qu),[[Me,C.customBaseUrl]])],512),[[Ke,C.provider==="custom_openai"]]),e("div",Hu,[u[12]||(u[12]=e("label",null,"模型名称:",-1)),e("div",Yu,[ae(e("input",{type:"text","onUpdate:modelValue":k=>C.modelName=k,placeholder:"请输入模型名称"},null,8,Ju),[[Me,C.modelName]]),e("button",{type:"button",class:"fetch-models-btn",title:"获取可用模型列表",onClick:k=>ne(D),disabled:a.value[D]},[u[11]||(u[11]=e("span",{class:"fetch-icon"},"🔍",-1)),e("span",ju,fe(a.value[D]?"获取中...":"获取模型"),1)],8,Xu)]),b.value[D]&&b.value[D].length>0?(U(),H("div",Gu,[Ie(We,{modelValue:C.modelName,"onUpdate:modelValue":k=>C.modelName=k,options:L(D)},null,8,["modelValue","onUpdate:modelValue","options"]),e("span",Zu,"共 "+fe(b.value[D].length)+" 个模型",1)])):Te("",!0)]),e("div",Qu,[e("button",{class:"settings-test-btn",onClick:k=>ie(D),disabled:o.value[D]},fe(o.value[D]?"测试中...":"🔗 测试连接"),9,ec)]),e("div",tc,[e("div",nc,[u[13]||(u[13]=e("label",null,"批次大小:",-1)),ae(e("input",{type:"number","onUpdate:modelValue":k=>C.batchSize=k,min:"1",max:"10",step:"1"},null,8,oc),[[Me,C.batchSize,void 0,{number:!0}]])]),e("div",ac,[u[14]||(u[14]=e("label",null,"会话重置频率:",-1)),ae(e("input",{type:"number","onUpdate:modelValue":k=>C.sessionReset=k,min:"1",step:"1"},null,8,sc),[[Me,C.sessionReset,void 0,{number:!0}]])]),e("div",lc,[u[15]||(u[15]=e("label",null,"RPM限制:",-1)),ae(e("input",{type:"number","onUpdate:modelValue":k=>C.rpmLimit=k,min:"0",step:"1"},null,8,ic),[[Me,C.rpmLimit,void 0,{number:!0}]])])]),e("div",rc,[e("div",uc,[e("label",cc,[ae(e("input",{type:"checkbox","onUpdate:modelValue":k=>C.lowReasoning=k},null,8,dc),[[et,C.lowReasoning]]),u[16]||(u[16]=Fe(" 低推理模式 ",-1))])]),e("div",gc,[u[17]||(u[17]=e("label",null,"取消思考方法:",-1)),Ie(We,{modelValue:C.noThinkingMethod,"onUpdate:modelValue":k=>C.noThinkingMethod=k,options:l},null,8,["modelValue","onUpdate:modelValue"])]),e("div",vc,[e("label",bc,[ae(e("input",{type:"checkbox","onUpdate:modelValue":k=>C.forceJsonOutput=k},null,8,pc),[[et,C.forceJsonOutput]]),u[18]||(u[18]=Fe(" 强制JSON输出 ",-1))])])]),e("div",fc,[u[19]||(u[19]=e("label",null,"校对提示词:",-1)),ae(e("textarea",{"onUpdate:modelValue":k=>C.prompt=k,rows:"4",placeholder:"校对提示词"},null,8,mc),[[Me,C.prompt]]),Ie(Tt,{"prompt-type":"proofreading",onSelect:(k,J)=>Y(D,k,J)},null,8,["onSelect"]),e("button",{class:"btn btn-secondary btn-sm",onClick:k=>Z(D)},"重置为默认",8,hc)])])]))),128))],512),[[Ke,x.value]])]))}}),xc=Xe(yc,[["__scopeId","data-v-5e9d8ba2"]]),kc={class:"prompt-library"},Sc={class:"settings-group"},Cc={class:"settings-item"},_c={key:0,class:"settings-item"},wc={class:"mode-hint"},$c={class:"settings-group"},Tc={key:0,class:"loading-hint"},Ic={key:1,class:"empty-hint"},Dc={key:2,class:"prompt-list"},Rc=["onClick"],Mc={class:"prompt-name"},Bc={class:"prompt-actions"},Ec=["onClick"],Pc=["onClick","disabled"],Ac={class:"settings-group"},Fc={class:"settings-item"},Lc={class:"settings-item"},Uc={class:"prompt-editor-actions"},Oc=["disabled"],zc=je({__name:"PromptLibrary",setup(t){const i=[{label:"翻译提示词",value:"translate"},{label:"文本框提示词",value:"textbox"},{label:"AI视觉OCR提示词",value:"ai_vision_ocr"},{label:"高质量翻译提示词",value:"hq_translate"},{label:"校对提示词",value:"proofreading"}],l=[{label:"普通模式",value:!1},{label:"JSON格式模式",value:!0}],s=ct(),n=Qe(),a=h("translate"),o=h([]),b=h(""),m=h(""),T=h(""),x=h(!1),L=h(!1),ne=ee(()=>a.value==="translate"||a.value==="ai_vision_ocr"),ie=ee(()=>L.value?"适用于需要结构化输出的场景":"适用于普通翻译场景");async function Q(){x.value=!0;try{let D;a.value==="textbox"?D=await Ne.getTextboxPrompts():D=await Ne.getPrompts(a.value);const k=D.prompt_names||[];o.value=k.map(J=>({name:J}))}catch(D){const k=D instanceof Error?D.message:"加载提示词列表失败";s.error(k)}finally{x.value=!1}}function v(D){b.value=D,m.value=D}async function Z(D){try{let k;a.value==="textbox"?k=await Ne.getTextboxPromptContent(D):k=await Ne.getPromptContent(a.value,D),m.value=D,T.value=k.prompt_content||"",b.value=D,s.success("已加载提示词")}catch(k){const J=k instanceof Error?k.message:"加载提示词内容失败";s.error(J)}}async function Y(){if(!m.value||!T.value){s.warning("请输入提示词名称和内容");return}try{a.value==="textbox"?await Ne.saveTextboxPrompt(m.value,T.value):await Ne.savePrompt(a.value,m.value,T.value),s.success("提示词保存成功"),m.value="",T.value="",await Q()}catch(D){const k=D instanceof Error?D.message:"保存提示词失败";s.error(k)}}async function p(D){if(D==="default"){s.warning("默认提示词不能删除");return}try{a.value==="textbox"?await Ne.deleteTextboxPrompt(D):await Ne.deletePrompt(a.value,D),s.success("提示词删除成功"),b.value===D&&(b.value="",m.value="",T.value=""),await Q()}catch(k){const J=k instanceof Error?k.message:"删除提示词失败";s.error(J)}}function u(){b.value="",m.value="",T.value="",a.value==="translate"?L.value=n.settings.translation.isJsonMode:a.value==="ai_vision_ocr"?L.value=n.settings.aiVisionOcr.isJsonMode:L.value=!1,Q()}function C(){a.value==="translate"?n.updateTranslationService({isJsonMode:L.value}):a.value==="ai_vision_ocr"&&n.updateAiVisionOcr({isJsonMode:L.value}),s.info(`已切换到${L.value?"JSON格式":"普通"}模式`)}return ut(()=>{L.value=n.settings.translation.isJsonMode,Q()}),(D,k)=>(U(),H("div",kc,[e("div",Sc,[k[6]||(k[6]=e("div",{class:"settings-group-title"},"提示词管理",-1)),e("div",Cc,[k[4]||(k[4]=e("label",{for:"promptType"},"提示词类型:",-1)),Ie(We,{modelValue:a.value,"onUpdate:modelValue":k[0]||(k[0]=J=>a.value=J),options:i,onChange:u},null,8,["modelValue"])]),ne.value?(U(),H("div",_c,[k[5]||(k[5]=e("label",{for:"promptMode"},"提示词模式:",-1)),Ie(We,{modelValue:L.value,"onUpdate:modelValue":k[1]||(k[1]=J=>L.value=J),options:l,onChange:C},null,8,["modelValue"]),e("span",wc,fe(ie.value),1)])):Te("",!0)]),e("div",$c,[k[7]||(k[7]=e("div",{class:"settings-group-title"},"已保存的提示词",-1)),x.value?(U(),H("div",Tc,"加载中...")):o.value.length===0?(U(),H("div",Ic,"暂无保存的提示词")):(U(),H("div",Dc,[(U(!0),H(Ge,null,tt(o.value,J=>(U(),H("div",{key:J.name,class:Le(["prompt-item",{active:b.value===J.name}]),onClick:te=>v(J.name)},[e("span",Mc,fe(J.name),1),e("div",Bc,[e("button",{class:"btn btn-sm",onClick:nt(te=>Z(J.name),["stop"]),title:"加载到编辑器"},"📥",8,Ec),e("button",{class:"btn btn-sm btn-danger",onClick:nt(te=>p(J.name),["stop"]),title:"删除",disabled:J.name==="default"}," 🗑️ ",8,Pc)])],10,Rc))),128))]))]),e("div",Ac,[k[10]||(k[10]=e("div",{class:"settings-group-title"},"提示词编辑",-1)),e("div",Fc,[k[8]||(k[8]=e("label",{for:"promptName"},"提示词名称:",-1)),ae(e("input",{type:"text",id:"promptName","onUpdate:modelValue":k[2]||(k[2]=J=>m.value=J),placeholder:"请输入提示词名称"},null,512),[[Me,m.value]])]),e("div",Lc,[k[9]||(k[9]=e("label",{for:"promptContent"},"提示词内容:",-1)),ae(e("textarea",{id:"promptContent","onUpdate:modelValue":k[3]||(k[3]=J=>T.value=J),rows:"8",placeholder:"请输入提示词内容"},null,512),[[Me,T.value]])]),e("div",Uc,[e("button",{class:"btn btn-primary",onClick:Y,disabled:!m.value||!T.value},"保存提示词",8,Oc)])])]))}}),Vc=Xe(zc,[["__scopeId","data-v-999b3840"]]),Nc={class:"plugin-manager"},Wc={class:"settings-group"},Kc={key:0,class:"loading-hint"},qc={key:1,class:"empty-hint"},Hc={key:2,class:"plugin-list"},Yc={class:"plugin-info"},Jc={class:"plugin-header"},Xc={class:"plugin-name"},jc={class:"plugin-version"},Gc={class:"plugin-description"},Zc={class:"plugin-controls"},Qc={class:"switch"},ed=["checked","onChange"],td=["onClick"],nd=["onClick"],od={class:"settings-group"},ad={class:"plugin-name"},sd={class:"switch"},ld=["checked","onChange"],id={class:"plugin-config-content"},rd={class:"plugin-config-header"},ud={class:"plugin-config-body"},cd=["for"],dd=["id","onUpdate:modelValue"],gd=["id","onUpdate:modelValue","min","max"],vd=["id","onUpdate:modelValue","placeholder"],bd={key:4,class:"field-description"},pd=je({__name:"PluginManager",setup(t){const i=ct(),l=h([]),s=h({}),n=h(!1),a=h(!1),o=h(null),b=h({}),m=h({});async function T(){n.value=!0;try{const Y=await ta();l.value=Y.plugins||[]}catch(Y){const p=Y instanceof Error?Y.message:"加载插件列表失败";i.error(p)}finally{n.value=!1}}async function x(){try{const Y=await ca();s.value=Y.states||{}}catch(Y){console.error("加载默认状态失败:",Y)}}async function L(Y){try{Y.enabled?(await oa(Y.name),Y.enabled=!1,i.success(`已禁用 ${Y.display_name||Y.name}`)):(await na(Y.name),Y.enabled=!0,i.success(`已启用 ${Y.display_name||Y.name}`))}catch(p){const u=p instanceof Error?p.message:"操作失败";i.error(u)}}async function ne(Y,p){const u=p.target,C=u.checked;try{await da(Y,C),s.value[Y]=C,i.success("默认状态已更新")}catch(D){const k=D instanceof Error?D.message:"设置失败";i.error(k),u.checked=!C}}async function ie(Y){o.value=Y;try{const p=await ga(Y.name);b.value=p.schema||{};const u=await va(Y.name);m.value=u.config||{},a.value=!0}catch(p){const u=p instanceof Error?p.message:"加载配置失败";i.error(u)}}function Q(){a.value=!1,o.value=null,b.value={},m.value={}}async function v(){if(o.value)try{await ba(o.value.name,m.value),i.success("配置保存成功"),Q()}catch(Y){const p=Y instanceof Error?Y.message:"保存配置失败";i.error(p)}}async function Z(Y){if(confirm(`确定要删除插件 "${Y.display_name||Y.name}" 吗？`))try{await aa(Y.name),i.success("插件删除成功"),await T()}catch(p){const u=p instanceof Error?p.message:"删除插件失败";i.error(u)}}return ut(()=>{T(),x()}),(Y,p)=>(U(),H("div",Nc,[e("div",Wc,[p[1]||(p[1]=e("div",{class:"settings-group-title"},"已安装插件",-1)),n.value?(U(),H("div",Kc,"加载中...")):l.value.length===0?(U(),H("div",qc,"暂无已安装的插件")):(U(),H("div",Hc,[(U(!0),H(Ge,null,tt(l.value,u=>(U(),H("div",{key:u.name,class:"plugin-item"},[e("div",Yc,[e("div",Jc,[e("span",Xc,fe(u.display_name||u.name),1),e("span",jc,"v"+fe(u.version||"1.0.0"),1)]),e("p",Gc,fe(u.description||"暂无描述"),1)]),e("div",Zc,[e("label",Qc,[e("input",{type:"checkbox",checked:u.enabled,onChange:C=>L(u)},null,40,ed),p[0]||(p[0]=e("span",{class:"slider"},null,-1))]),u.has_config?(U(),H("button",{key:0,class:"btn btn-sm",onClick:C=>ie(u),title:"配置"},"⚙️",8,td)):Te("",!0),e("button",{class:"btn btn-sm btn-danger",onClick:C=>Z(u),title:"删除"},"🗑️",8,nd)])]))),128))]))]),e("div",od,[p[3]||(p[3]=e("div",{class:"settings-group-title"},"默认启用状态",-1)),p[4]||(p[4]=e("p",{class:"settings-hint"},"设置插件在新会话中的默认启用状态",-1)),(U(!0),H(Ge,null,tt(l.value,u=>(U(),H("div",{key:"default-"+u.name,class:"default-state-item"},[e("span",ad,fe(u.display_name||u.name),1),e("label",sd,[e("input",{type:"checkbox",checked:s.value[u.name],onChange:C=>ne(u.name,C)},null,40,ld),p[2]||(p[2]=e("span",{class:"slider"},null,-1))])]))),128))]),a.value?(U(),H("div",{key:0,class:"plugin-config-modal",onClick:nt(Q,["self"])},[e("div",id,[e("div",rd,[e("h4",null,fe(o.value?.display_name||o.value?.name)+" 配置",1),e("span",{class:"close-btn",onClick:Q},"×")]),e("div",ud,[(U(!0),H(Ge,null,tt(b.value,(u,C)=>(U(),H("div",{key:C,class:"config-field"},[e("label",{for:"config-"+C},fe(u.label||C)+":",9,cd),u.type==="boolean"?ae((U(),H("input",{key:0,type:"checkbox",id:"config-"+C,"onUpdate:modelValue":D=>m.value[C]=D},null,8,dd)),[[et,m.value[C]]]):u.type==="select"?(U(),rt(We,{key:1,modelValue:m.value[C],"onUpdate:modelValue":D=>m.value[C]=D,options:u.options||[]},null,8,["modelValue","onUpdate:modelValue","options"])):u.type==="number"?ae((U(),H("input",{key:2,type:"number",id:"config-"+C,"onUpdate:modelValue":D=>m.value[C]=D,min:u.min,max:u.max},null,8,gd)),[[Me,m.value[C],void 0,{number:!0}]]):ae((U(),H("input",{key:3,type:"text",id:"config-"+C,"onUpdate:modelValue":D=>m.value[C]=D,placeholder:u.placeholder},null,8,vd)),[[Me,m.value[C]]]),u.description?(U(),H("p",bd,fe(u.description),1)):Te("",!0)]))),128))]),e("div",{class:"plugin-config-footer"},[e("button",{class:"btn btn-secondary",onClick:Q},"取消"),e("button",{class:"btn btn-primary",onClick:v},"保存")])])])):Te("",!0)]))}}),fd=Xe(pd,[["__scopeId","data-v-43d524d4"]]),md={class:"more-settings"},hd={class:"settings-group"},yd={class:"settings-item"},xd={class:"settings-group"},kd={class:"settings-item"},Sd=["disabled"],Cd={key:0,class:"font-count"},_d={class:"settings-item"},wd={class:"settings-group"},$d={class:"settings-item"},Td={class:"checkbox-label"},Id={class:"settings-group"},Dd={class:"settings-item"},Rd={class:"settings-item"},Md={class:"settings-item"},Bd={class:"settings-group"},Ed={class:"settings-row"},Pd={class:"settings-item"},Ad=["disabled"],Fd={class:"settings-item"},Ld=["disabled"],Ud=je({__name:"MoreSettings",setup(t){const i=[{label:"前端 pdf.js (推荐)",value:"frontend"},{label:"后端 PyMuPDF",value:"backend"}],l=Qe();ee(()=>l);const s=ct(),n=h(!1),a=h([]),o=h(!1),b=h(null),m=h({showDetectionDebug:l.settings.showDetectionDebug||!1,translationMaxRetries:l.settings.translation?.maxRetries||2,hqTranslationMaxRetries:l.settings.hqTranslation?.maxRetries||2,proofreadingMaxRetries:l.settings.proofreading?.maxRetries||2});function T(){l.setShowDetectionDebug(m.value.showDetectionDebug),l.settings.translation&&(l.settings.translation.maxRetries=m.value.translationMaxRetries),l.settings.hqTranslation&&(l.settings.hqTranslation.maxRetries=m.value.hqTranslationMaxRetries),l.setProofreadingMaxRetries(m.value.proofreadingMaxRetries)}async function x(){n.value=!0;try{const Q=await Ne.getFontList();a.value=Q.fonts||[],s.success(`获取到 ${a.value.length} 个字体`)}catch(Q){const v=Q instanceof Error?Q.message:"获取字体列表失败";s.error(v)}finally{n.value=!1}}async function L(Q){const Z=Q.target.files?.[0];if(!Z)return;const Y=[".ttf",".ttc",".otf"],p=Z.name.toLowerCase().slice(Z.name.lastIndexOf("."));if(!Y.includes(p)){s.error("不支持的字体格式，请上传 .ttf, .ttc 或 .otf 文件");return}try{const u=await Ne.uploadFont(Z);u.success?(s.success(`字体 "${u.fontPath||Z.name}" 上传成功`),await x()):s.error(u.error||"字体上传失败")}catch(u){const C=u instanceof Error?u.message:"字体上传失败";s.error(C)}finally{b.value&&(b.value.value="")}}async function ne(){o.value=!0;try{const Q=await Hn();Q.success?s.success(`已清理 ${Q.deleted_count||0} 个调试文件`):s.error(Q.error||"清理失败")}catch(Q){const v=Q instanceof Error?Q.message:"清理失败";s.error(v)}finally{o.value=!1}}async function ie(){o.value=!0;try{const Q=await rn();Q.success?s.success(`已清理 ${Q.deleted_count||0} 个临时文件`):s.error(Q.error||"清理失败")}catch(Q){const v=Q instanceof Error?Q.message:"清理失败";s.error(v)}finally{o.value=!1}}return(Q,v)=>(U(),H("div",md,[e("div",hd,[v[7]||(v[7]=e("div",{class:"settings-group-title"},"PDF处理设置",-1)),e("div",yd,[v[5]||(v[5]=e("label",{for:"settingsPdfProcessingMethod"},"PDF处理方式:",-1)),Ie(We,{modelValue:ve(l).settings.pdfProcessingMethod,"onUpdate:modelValue":v[0]||(v[0]=Z=>ve(l).settings.pdfProcessingMethod=Z),options:i},null,8,["modelValue"]),v[6]||(v[6]=e("div",{class:"input-hint"},"前端处理速度更快，后端处理兼容性更好",-1))])]),e("div",xd,[v[11]||(v[11]=e("div",{class:"settings-group-title"},"字体设置",-1)),e("div",kd,[v[8]||(v[8]=e("label",null,"系统字体列表:",-1)),e("button",{class:"btn btn-secondary",onClick:x,disabled:n.value},fe(n.value?"加载中...":"🔄 刷新字体列表"),9,Sd),a.value.length>0?(U(),H("div",Cd,"共 "+fe(a.value.length)+" 个字体",1)):Te("",!0)]),e("div",_d,[v[9]||(v[9]=e("label",null,"上传自定义字体:",-1)),e("input",{type:"file",accept:".ttf,.ttc,.otf",onChange:L,ref_key:"fontInput",ref:b},null,544),v[10]||(v[10]=e("div",{class:"input-hint"},"支持 .ttf, .ttc, .otf 格式",-1))])]),e("div",wd,[v[14]||(v[14]=e("div",{class:"settings-group-title"},"调试选项",-1)),e("div",$d,[e("label",Td,[ae(e("input",{type:"checkbox","onUpdate:modelValue":v[1]||(v[1]=Z=>m.value.showDetectionDebug=Z),onChange:T},null,544),[[et,m.value.showDetectionDebug]]),v[12]||(v[12]=Fe(" 显示检测框调试信息 ",-1))]),v[13]||(v[13]=e("div",{class:"input-hint"},"开启后会在翻译结果中显示气泡检测框",-1))])]),e("div",Id,[v[21]||(v[21]=e("div",{class:"settings-group-title"},"重试次数配置",-1)),e("div",Dd,[v[15]||(v[15]=e("label",{for:"settingsTranslationMaxRetries"},"普通翻译重试次数:",-1)),ae(e("input",{type:"number",id:"settingsTranslationMaxRetries","onUpdate:modelValue":v[2]||(v[2]=Z=>m.value.translationMaxRetries=Z),min:"0",max:"10",onChange:T},null,544),[[Me,m.value.translationMaxRetries,void 0,{number:!0}]]),v[16]||(v[16]=e("div",{class:"input-hint"},"翻译失败时的最大重试次数（0-10）",-1))]),e("div",Rd,[v[17]||(v[17]=e("label",{for:"settingsHqTranslationMaxRetries"},"高质量翻译重试次数:",-1)),ae(e("input",{type:"number",id:"settingsHqTranslationMaxRetries","onUpdate:modelValue":v[3]||(v[3]=Z=>m.value.hqTranslationMaxRetries=Z),min:"0",max:"10",onChange:T},null,544),[[Me,m.value.hqTranslationMaxRetries,void 0,{number:!0}]]),v[18]||(v[18]=e("div",{class:"input-hint"},"高质量翻译失败时的最大重试次数（0-10）",-1))]),e("div",Md,[v[19]||(v[19]=e("label",{for:"settingsProofreadingMaxRetries"},"AI校对重试次数:",-1)),ae(e("input",{type:"number",id:"settingsProofreadingMaxRetries","onUpdate:modelValue":v[4]||(v[4]=Z=>m.value.proofreadingMaxRetries=Z),min:"0",max:"10",onChange:T},null,544),[[Me,m.value.proofreadingMaxRetries,void 0,{number:!0}]]),v[20]||(v[20]=e("div",{class:"input-hint"},"AI校对失败时的最大重试次数（0-10）",-1))])]),e("div",Bd,[v[24]||(v[24]=e("div",{class:"settings-group-title"},"缓存清理",-1)),e("div",Ed,[e("div",Pd,[e("button",{class:"btn btn-secondary",onClick:ne,disabled:o.value},fe(o.value?"清理中...":"🗑️ 清理调试文件"),9,Ad),v[22]||(v[22]=e("div",{class:"input-hint"},"清理调试过程中生成的临时文件",-1))]),e("div",Fd,[e("button",{class:"btn btn-secondary",onClick:ie,disabled:o.value},fe(o.value?"清理中...":"🗑️ 清理临时文件"),9,Ld),v[23]||(v[23]=e("div",{class:"input-hint"},"清理下载和处理过程中的临时文件",-1))])])]),v[25]||(v[25]=Qt('<div class="settings-group" data-v-4de9af7d><div class="settings-group-title" data-v-4de9af7d>关于</div><div class="about-info" data-v-4de9af7d><p data-v-4de9af7d><strong data-v-4de9af7d>Saber-Translator</strong></p><p data-v-4de9af7d>AI驱动的漫画翻译工具</p><p class="links" data-v-4de9af7d><a href="http://www.mashirosaber.top" target="_blank" data-v-4de9af7d>📖 使用教程</a><a href="https://github.com/MashiroSaber/saber-translator" target="_blank" data-v-4de9af7d>🐙 GitHub</a></p><p class="disclaimer" data-v-4de9af7d>本项目完全开源免费，请勿上当受骗</p></div></div>',1))]))}}),Od=Xe(Ud,[["__scopeId","data-v-4de9af7d"]]),zd={class:"settings-modal-content"},Vd={class:"settings-tabs"},Nd=["onClick"],Wd={class:"settings-tab-content"},Kd={class:"settings-tab-pane active"},qd={class:"settings-tab-pane"},Hd={class:"settings-tab-pane"},Yd={class:"settings-tab-pane"},Jd={class:"settings-tab-pane"},Xd={class:"settings-tab-pane"},jd={class:"settings-tab-pane"},Gd={class:"settings-tab-pane"},Zd=je({__name:"SettingsModal",props:{modelValue:{type:Boolean}},emits:["update:modelValue","save"],setup(t,{emit:i}){const l=t,s=i,n=Qe(),a=h(l.modelValue),o=h("ocr"),b=[{id:"ocr",label:"OCR识别"},{id:"translate",label:"翻译服务"},{id:"detection",label:"检测设置"},{id:"hq",label:"高质量翻译"},{id:"proofreading",label:"AI校对"},{id:"prompt-library",label:"提示词管理"},{id:"plugins",label:"插件管理"},{id:"more",label:"更多"}];Ye(()=>l.modelValue,L=>{a.value=L,L?document.body.style.overflow="hidden":document.body.style.overflow=""});function m(){a.value=!1,s("update:modelValue",!1),document.body.style.overflow=""}async function T(){n.saveToStorage();try{await n.saveToBackend(),console.log("[SettingsModal] 设置已保存到后端")}catch(L){console.warn("[SettingsModal] 保存到后端失败，仅保存到 localStorage:",L)}s("save"),m()}function x(L){L.key==="Escape"&&a.value&&m()}return ut(()=>{document.addEventListener("keydown",x)}),It(()=>{document.removeEventListener("keydown",x),document.body.style.overflow=""}),(L,ne)=>a.value?(U(),H("div",{key:0,class:"settings-modal",onClick:nt(m,["self"])},[e("div",zd,[e("div",{class:"settings-modal-header"},[ne[0]||(ne[0]=e("h3",null,"⚙️ 设置",-1)),e("span",{class:"settings-modal-close",onClick:m},"×")]),e("div",Vd,[(U(),H(Ge,null,tt(b,ie=>e("button",{key:ie.id,class:Le(["settings-tab",{active:o.value===ie.id}]),onClick:Q=>o.value=ie.id},fe(ie.label),11,Nd)),64))]),e("div",Wd,[ae(e("div",Kd,[Ie($i)],512),[[Ke,o.value==="ocr"]]),ae(e("div",qd,[Ie(br)],512),[[Ke,o.value==="translate"]]),ae(e("div",Hd,[Ie(Ur)],512),[[Ke,o.value==="detection"]]),ae(e("div",Yd,[Ie(Cu)],512),[[Ke,o.value==="hq"]]),ae(e("div",Jd,[Ie(xc)],512),[[Ke,o.value==="proofreading"]]),ae(e("div",Xd,[Ie(Vc)],512),[[Ke,o.value==="prompt-library"]]),ae(e("div",jd,[Ie(fd)],512),[[Ke,o.value==="plugins"]]),ae(e("div",Gd,[Ie(Od)],512),[[Ke,o.value==="more"]])]),e("div",{class:"settings-modal-footer"},[e("button",{class:"btn btn-secondary",onClick:m},"取消"),e("button",{class:"btn btn-primary",onClick:T},"保存设置")])])])):Te("",!0)}}),Qd=Xe(Zd,[["__scopeId","data-v-e271da83"]]),eg={minScale:.1,maxScale:5,zoomSpeed:.1};function Nn(t={}){const i={...eg,...t},l=h(1),s=h(0),n=h(0),a=h(!1),o=h(0),b=h(0),m=ee(()=>({transform:`translate(${s.value}px, ${n.value}px) scale(${l.value})`}));function T(F,g,_){const B=Math.min(Math.max(l.value*_,i.minScale),i.maxScale),q=B/l.value;s.value=F-(F-s.value)*q,n.value=g-(g-n.value)*q,l.value=B,t.onScaleChange?.(l.value),t.onTransformChange?.(k())}function x(F,g=800,_=600){T(g/2,_/2,F)}function L(){x(1.2)}function ne(){x(.8)}function ie(F,g=800,_=600){const B=F/l.value;T(g/2,_/2,B)}function Q(F,g){a.value=!0,o.value=F,b.value=g}function v(F,g){if(!a.value)return;const _=F-o.value,B=g-b.value;s.value+=_,n.value+=B,o.value=F,b.value=g,t.onTransformChange?.(k())}function Z(){a.value=!1}function Y(F,g){s.value+=F,n.value+=g,t.onTransformChange?.(k())}function p(){l.value=1,s.value=0,n.value=0,t.onScaleChange?.(l.value),t.onTransformChange?.(k())}function u(){p()}function C(){l.value=1,s.value=0,n.value=0}function D(F,g,_,B){if(!F||!g)return;const q=_/F,N=B/g;l.value=Math.min(q,N)*.95,s.value=(_-F*l.value)/2,n.value=(B-g*l.value)/2,t.onScaleChange?.(l.value),t.onTransformChange?.(k())}function k(){return{scale:l.value,translateX:s.value,translateY:n.value}}function J(F){F.scale!==void 0&&(l.value=F.scale),F.translateX!==void 0&&(s.value=F.translateX),F.translateY!==void 0&&(n.value=F.translateY),t.onTransformChange?.(k())}function te(F){l.value=F.scale,s.value=F.translateX,n.value=F.translateY}function de(F,g,_){if(!F||F.length<4)return;const[B,q,N,M]=F,f=(B+N)/2,S=(q+M)/2,oe=g/2,R=_/2;s.value=oe-f*l.value,n.value=R-S*l.value,t.onTransformChange?.(k())}return{scale:l,translateX:s,translateY:n,isDragging:a,transformStyle:m,zoomAt:T,zoom:x,zoomIn:L,zoomOut:ne,setScale:ie,startDrag:Q,drag:v,endDrag:Z,pan:Y,reset:p,resetZoom:u,resetTransform:C,fitToScreen:D,getTransform:k,setTransform:J,syncWith:te,scrollToBubble:de}}function tg(t){const i=at(),l=Qe(),s=h(null),n=h(Bo),a=h(!1),o=h(!1),b=h([]),m=h(0),T=h(0);let x=null,L=null,ne=null;const ie=ee(()=>s.value!==null),Q=ee(()=>s.value==="repair"?{fill:"rgba(76, 175, 80, 0.4)",border:"#4CAF50"}:s.value==="restore"?{fill:"rgba(33, 150, 243, 0.4)",border:"#2196F3"}:{fill:"transparent",border:"transparent"});function v(S){s.value!==S&&(s.value=S,a.value=!0,b.value=[],console.log(`进入${S==="repair"?"修复":"还原"}笔刷模式，笔刷大小: ${n.value}px`))}function Z(){o.value&&J();const S=s.value!==null;s.value=null,a.value=!1,o.value=!1,b.value=[],g(),S&&console.log("退出笔刷模式")}function Y(S){s.value===S?Z():v(S)}function p(S){n.value=Math.max(En,Math.min(Bn,S))}function u(S){p(n.value+S)}function C(S){if(!ie.value)return;S.preventDefault(),S.stopPropagation();const oe=S.deltaY>0?-5:5;u(oe)}function D(S,oe){if(!ie.value||S.button!==0)return;S.preventDefault(),S.stopPropagation(),o.value=!0,x=oe,b.value=[];const R=te(S,oe);R&&(b.value.push(R),F(oe),_(R)),console.log("开始笔刷涂抹")}function k(S){if(m.value=S.clientX,T.value=S.clientY,!o.value||!ie.value)return;const oe=te(S,x);oe&&(b.value.push(oe),_(oe))}function J(){if(!o.value)return;o.value=!1;const S=i.currentImage;if(!S||b.value.length===0){g(),b.value=[];return}const oe=de();if(!oe){g(),b.value=[];return}const R=s.value;(async()=>{R==="restore"?await B(S,oe):R==="repair"&&await q(S,oe),t?.onBrushComplete?.()})(),g(),b.value=[]}function te(S,oe){if(!oe)return null;const R=oe.querySelector(".image-canvas-wrapper"),E=R?.querySelector("img");if(!E||!E.naturalWidth)return null;const $=R.getBoundingClientRect(),c=window.getComputedStyle(R).transform;let O=1;c&&c!=="none"&&(O=new DOMMatrix(c).a);const ce=(S.clientX-$.left)/O,X=(S.clientY-$.top)/O,G=E.naturalWidth,A=E.naturalHeight;return ce<0||X<0||ce>G||X>A?null:{x:ce,y:X,scale:O}}function de(){if(b.value.length===0)return null;const oe=b.value[0]?.scale||1,R=n.value/2/oe;let E=1/0,$=1/0,c=-1/0,O=-1/0;for(const ce of b.value)E=Math.min(E,ce.x-R),$=Math.min($,ce.y-R),c=Math.max(c,ce.x+R),O=Math.max(O,ce.y+R);return{x1:Math.max(0,Math.floor(E)),y1:Math.max(0,Math.floor($)),x2:Math.ceil(c),y2:Math.ceil(O),path:[...b.value],radius:R}}function F(S){g();const oe=S.querySelector(".image-canvas-wrapper"),R=oe?.querySelector("img");if(!R)return;const E=document.createElement("canvas");E.id="brushOverlayCanvas",E.width=R.naturalWidth,E.height=R.naturalHeight,E.style.cssText="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100;",oe.appendChild(E),L=E,ne=E.getContext("2d")}function g(){L&&L.parentNode&&L.parentNode.removeChild(L),L=null,ne=null}function _(S){if(!ne||!S)return;const oe=Q.value.fill,R=n.value/2/(S.scale||1);ne.beginPath(),ne.arc(S.x,S.y,R,0,Math.PI*2),ne.fillStyle=oe,ne.fill()}async function B(S,oe){if(!S.originalDataURL)return;let R;return S.cleanImageData?R="data:image/png;base64,"+S.cleanImageData:R=S.originalDataURL,new Promise(E=>{const $=new Image,c=new Image;let O=0;const ce=()=>{if(O++,O<2)return;const X=document.createElement("canvas");X.width=$.naturalWidth,X.height=$.naturalHeight;const G=X.getContext("2d");if(!G){E();return}G.drawImage($,0,0);const A=document.createElement("canvas");A.width=X.width,A.height=X.height;const r=A.getContext("2d");if(!r){E();return}r.fillStyle="white";for(const w of oe.path)r.beginPath(),r.arc(w.x,w.y,oe.radius,0,Math.PI*2),r.fill();G.globalCompositeOperation="destination-out",G.drawImage(A,0,0),G.globalCompositeOperation="destination-over",G.drawImage(c,0,0),G.globalCompositeOperation="source-over";const y=X.toDataURL("image/png").split(",")[1];i.updateCurrentImage({cleanImageData:y}),console.log("还原笔刷区域完成"),E()};$.onload=ce,$.onerror=()=>E(),c.onload=ce,c.onerror=()=>E(),$.src=R,c.src=S.originalDataURL})}async function q(S,oe){const R=t?.getCurrentRepairSettings?.()||{inpaintMethod:"solid",fillColor:"#FFFFFF"},E=R.inpaintMethod;E==="lama_mpe"||E==="litelama"?await N(S,oe,E):await M(S,oe,R.fillColor)}async function N(S,oe,R="lama_mpe"){let E,$;if(S.cleanImageData)E=S.cleanImageData,$="data:image/png;base64,"+S.cleanImageData;else if(S.originalDataURL)E=S.originalDataURL.split(",")[1],$=S.originalDataURL;else{console.error("无法获取基础图像用于 LAMA 修复");return}return new Promise(c=>{const O=new Image;O.onload=async()=>{const ce=O.naturalWidth,X=O.naturalHeight,G=document.createElement("canvas");G.width=ce,G.height=X;const A=G.getContext("2d");if(!A){console.error("无法创建掩膜画布上下文"),c();return}A.fillStyle="black",A.fillRect(0,0,ce,X),A.fillStyle="white";for(const se of oe.path)A.beginPath(),A.arc(se.x,se.y,oe.radius,0,Math.PI*2),A.fill();const y=G.toDataURL("image/png").split(",")[1],w=[oe.x1,oe.y1,oe.x2,oe.y2],P=R==="litelama"?"litelama":"lama_mpe";try{Re("LAMA 修复中...","info");const se=await cn(E,w,{method:"lama",lamaModel:P,maskData:y});if(se.success&&se.inpainted_image)i.updateCurrentImage({cleanImageData:se.inpainted_image}),console.log("修复笔刷区域完成（LAMA 修复，精确掩膜）"),Re("LAMA 修复完成","success");else throw new Error(se.error||"LAMA 修复返回无效数据")}catch(se){console.error("LAMA 修复失败，回退到纯色填充:",se),Re("LAMA 修复失败，使用纯色填充","warning");const ge=t?.getCurrentRepairSettings?.();await M(S,oe,ge?.fillColor)}c()},O.onerror=()=>{console.error("加载图像失败，无法进行 LAMA 修复"),c()},O.src=$})}async function M(S,oe,R){const E=R||l.settings.textStyle.fillColor||"#FFFFFF";let $;if(S.cleanImageData)$="data:image/png;base64,"+S.cleanImageData;else if(S.originalDataURL)$=S.originalDataURL;else return;return new Promise(c=>{const O=new Image;O.onload=()=>{const ce=document.createElement("canvas");ce.width=O.naturalWidth,ce.height=O.naturalHeight;const X=ce.getContext("2d");if(!X){c();return}X.drawImage(O,0,0),X.fillStyle=E;for(const A of oe.path)X.beginPath(),X.arc(A.x,A.y,oe.radius,0,Math.PI*2),X.fill();const G=ce.toDataURL("image/png").split(",")[1];i.updateCurrentImage({cleanImageData:G}),console.log("修复笔刷区域完成（纯色填充）"),c()},O.onerror=()=>c(),O.src=$})}async function f(){const S=i.currentImage;if(!S)return console.warn("ensureCleanBackground: 没有当前图片"),!1;if(S.cleanImageData)return console.log("ensureCleanBackground: 已有干净背景"),!0;const oe=t?.getCurrentRepairSettings?.();if((oe?.inpaintMethod||l.settings.textStyle.inpaintMethod)!=="solid")return console.log("ensureCleanBackground: 非纯色填充模式，跳过"),!1;if(!S.bubbleStates||S.bubbleStates.length===0)return console.warn("ensureCleanBackground: 没有气泡数据"),!1;if(!S.translatedDataURL&&!S.originalDataURL)return console.warn("ensureCleanBackground: 没有图片数据"),!1;console.log("ensureCleanBackground: 尝试为纯色填充模式创建临时干净背景");const E=S.translatedDataURL||S.originalDataURL,$=oe?.fillColor||l.settings.textStyle.fillColor||"#FFFFFF";return new Promise(c=>{const O=new Image;O.onload=()=>{try{const ce=document.createElement("canvas");ce.width=O.naturalWidth,ce.height=O.naturalHeight;const X=ce.getContext("2d");if(!X){console.error("ensureCleanBackground: 无法获取 Canvas 上下文"),c(!1);return}X.drawImage(O,0,0),X.fillStyle=$;for(const A of S.bubbleStates){const[r,y,w,P]=A.coords;X.fillRect(r,y,w-r+1,P-y+1)}const G=ce.toDataURL("image/png").split(",")[1];i.updateCurrentImage({cleanImageData:G}),console.log("ensureCleanBackground: 成功创建临时干净背景（纯色填充）"),c(!0)}catch(ce){console.error("ensureCleanBackground: Canvas 操作失败:",ce),c(!1)}},O.onerror=()=>{console.error("ensureCleanBackground: 加载图像失败"),c(!1)},O.src=E})}return It(()=>{Z()}),{brushMode:s,brushSize:n,isBrushKeyDown:a,isBrushPainting:o,mouseX:m,mouseY:T,isActive:ie,brushColor:Q,BRUSH_MIN_SIZE:En,BRUSH_MAX_SIZE:Bn,enterBrushMode:v,exitBrushMode:Z,toggleBrushMode:Y,setBrushSize:p,adjustBrushSize:u,handleBrushWheel:C,startBrushPainting:D,continueBrushPainting:k,finishBrushPainting:J,getBrushPositionInImage:te,getBrushPathBounds:de,ensureCleanBackground:f}}function ng(t){return[Math.round(t[0]),Math.round(t[1]),Math.round(t[2]),Math.round(t[3])]}function og(t){const i=gt(),l=at(),s=Qe(),{bubbles:n,selectedIndex:a,hasSelection:o}=yt(i),{currentImage:b}=yt(l),m=h(!1),T=h(!1),x=h(null),L=h(0),ne=h(0),ie=h(!1);function Q(X){i.selectBubble(X)}function v(X){i.toggleMultiSelect(X)}function Z(){i.clearMultiSelect()}function Y(X,G){console.log(`开始拖动气泡 #${X+1}`)}function p(X,G){}function u(X,G){i.updateBubble(X,{coords:G}),console.log(`气泡 #${X+1} 拖动完成:`,G),R()}function C(X,G,A){console.log(`开始调整气泡 #${X+1} 大小，手柄: ${G}`)}function D(X){}function k(X,G){i.updateBubble(X,{coords:G}),console.log(`气泡 #${X+1} 调整大小完成:`,G),R()}function J(X,G){console.log(`开始旋转气泡 #${X+1}`)}function te(X){}function de(X,G){i.updateBubble(X,{rotationAngle:G}),console.log(`气泡 #${X+1} 旋转完成: ${G}°`),R()}function F(){m.value=!m.value,m.value?console.log("进入绘制模式"):console.log("退出绘制模式")}function g(X){i.addBubble(X),i.selectBubble(i.bubbleCount-1),console.log("已添加新气泡:",X),t?.onReRender?.()}function _(X,G){T.value=!0,L.value=X,ne.value=G,x.value=[X,G,X,G]}function B(X,G){T.value&&(x.value=[L.value,ne.value,X,G])}function q(){if(!T.value||!x.value)return T.value=!1,x.value=null,null;const[X,G,A,r]=x.value,y=10;if(Math.abs(A-X)<y||Math.abs(r-G)<y)return T.value=!1,x.value=null,null;const w=[Math.min(X,A),Math.min(G,r),Math.max(X,A),Math.max(G,r)];return T.value=!1,x.value=null,w}function N(){T.value=!1,x.value=null,m.value=!1}function M(){if(!x.value)return{};const[X,G,A,r]=x.value;return{position:"absolute",left:`${Math.min(X,A)}px`,top:`${Math.min(G,r)}px`,width:`${Math.abs(A-X)}px`,height:`${Math.abs(r-G)}px`,border:"2px dashed #00d4ff",background:"rgba(0, 212, 255, 0.1)",pointerEvents:"none",zIndex:"25",boxSizing:"border-box"}}let f=null,S=!1;const oe=150;function R(){f&&clearTimeout(f),f=setTimeout(async()=>{if(S){console.log("跳过渲染，上一次渲染仍在进行中");return}console.log("触发延迟渲染预览"),S=!0;try{t?.onDelayedPreview?await t.onDelayedPreview():t?.onReRender&&await t.onReRender()}catch(X){console.error("延迟渲染预览失败:",X)}finally{S=!1}},oe)}function E(X){i.updateSelectedBubble(X),R()}function $(){o.value&&(i.deleteSelected(),console.log("已删除选中的气泡"),t?.onReRender?.())}async function c(){const X=a.value;if(X<0){console.warn("请先选中要修复的气泡框");return}const G=n.value[X],A=b.value;if(!G||!A?.originalDataURL){console.warn("无法修复背景：缺少气泡或图片数据");return}const r=G.inpaintMethod||"solid",y=G.fillColor||"#FFFFFF",w=G.rotationAngle||0;try{console.log(`开始修复气泡 #${X+1} 背景，方法: ${r}`);let P;if(A.cleanImageData)P=A.cleanImageData;else{const ge=A.originalDataURL.match(/^data:image\/[^;]+;base64,(.+)$/);if(P=ge&&ge[1]?ge[1]:"",!P){console.error("无法解析图像数据");return}}if(r==="lama_mpe"||r==="litelama"){const ge=r==="litelama"?"litelama":"lama_mpe",re=ng(G.coords),le=await cn(P,re,{bubbleAngle:w,method:"lama",lamaModel:ge});le.success&&le.inpainted_image?(l.updateCurrentImage({cleanImageData:le.inpainted_image}),console.log(`气泡 #${X+1} LAMA背景修复成功`),R()):(console.error("LAMA修复失败:",le.error||"未知错误"),await O(G.coords,y,w),R())}else await O(G.coords,y,w),console.log(`气泡 #${X+1} 纯色填充修复成功`),R()}catch(P){console.error("背景修复出错:",P)}}async function O(X,G,A=0){const r=b.value;if(!r)return;const[y,w,P,se]=X;let ge;if(r.cleanImageData)ge="data:image/png;base64,"+r.cleanImageData;else if(r.originalDataURL)ge=r.originalDataURL;else{console.error("无法找到基础图像用于填充");return}return new Promise(re=>{const le=new Image;le.onload=()=>{const I=document.createElement("canvas");I.width=le.naturalWidth,I.height=le.naturalHeight;const d=I.getContext("2d");if(!d){re();return}if(d.drawImage(le,0,0),d.fillStyle=G,Math.abs(A)<.1)d.fillRect(y,w,P-y,se-w);else{const K=(y+P)/2,j=(w+se)/2,be=(P-y)/2,he=(se-w)/2,ke=A*Math.PI/180,xe=Math.cos(ke),De=Math.sin(ke),_e=[[-be,-he],[be,-he],[be,he],[-be,he]].map(([Se,Ce])=>[K+Se*xe-Ce*De,j+Se*De+Ce*xe]);d.beginPath(),d.moveTo(_e[0][0],_e[0][1]);for(let Se=1;Se<_e.length;Se++)d.lineTo(_e[Se][0],_e[Se][1]);d.closePath(),d.fill()}const z=I.toDataURL("image/png").split(",")[1];l.updateCurrentImage({cleanImageData:z}),console.log("已对气泡区域进行纯色填充:",X,G,"角度:",A),re()},le.onerror=()=>{console.error("加载基础图像失败"),re()},le.src=ge})}async function ce(X){const G=n.value[X],A=b.value;if(!G||!A?.originalDataURL){console.warn("无法进行 OCR 识别：缺少气泡或图片数据");return}try{console.log(`开始 OCR 识别气泡 #${X+1}`);const r=A.originalDataURL.split(",")[1],y=s.settings,w=await Xn(r,G.coords,y.ocrEngine||"manga_ocr",{source_language:y.sourceLanguage,baidu_ocr_api_key:y.baiduOcr.apiKey,baidu_ocr_secret_key:y.baiduOcr.secretKey,baidu_version:y.baiduOcr.version,baidu_source_language:y.baiduOcr.sourceLanguage,ai_vision_provider:y.aiVisionOcr.provider,ai_vision_api_key:y.aiVisionOcr.apiKey,ai_vision_model_name:y.aiVisionOcr.modelName,ai_vision_ocr_prompt:y.aiVisionOcr.prompt,custom_ai_vision_base_url:y.aiVisionOcr.customBaseUrl});w.success&&w.text!==void 0?(i.updateBubble(X,{originalText:w.text}),console.log(`OCR 识别成功: "${w.text}"`)):console.error("OCR 识别失败:",w.error||"未知错误")}catch(r){console.error("OCR 识别出错:",r)}}return{isDrawingMode:m,isDrawingBox:T,currentDrawingRect:x,isMiddleButtonDown:ie,handleBubbleSelect:Q,handleBubbleMultiSelect:v,handleClearMultiSelect:Z,handleBubbleDragStart:Y,handleBubbleDragging:p,handleBubbleDragEnd:u,handleBubbleResizeStart:C,handleBubbleResizing:D,handleBubbleResizeEnd:k,handleBubbleRotateStart:J,handleBubbleRotating:te,handleBubbleRotateEnd:de,toggleDrawingMode:F,handleDrawBubble:g,startDrawingBox:_,updateDrawingBox:B,finishDrawingBox:q,cancelDrawing:N,getDrawingRectStyle:M,handleBubbleUpdate:E,deleteSelectedBubbles:$,repairSelectedBubble:c,triggerDelayedPreview:R,handleOcrRecognize:ce}}function ag(t){const i=gt(),l=at(),{bubbles:s}=yt(i),{currentImage:n}=yt(l),a=h(!1),o=h("");let b=null;function m(){const L=n.value;if(!L)return null;if(L.cleanImageData)return L.cleanImageData;if(L.originalDataURL){const ne=L.originalDataURL.match(/^data:image\/[^;]+;base64,(.+)$/);if(ne&&ne[1])return ne[1]}return null}async function T(L=!1){if(!n.value)return console.warn("reRenderFullImage: 没有当前图片"),!1;if(s.value.length===0){console.log("reRenderFullImage: 没有气泡，跳过后端渲染");const v=m();if(v){const Z=`data:image/png;base64,${v}`;l.updateCurrentImage({translatedDataURL:Z}),L||t?.onRenderSuccess?.(Z)}return!0}const ie=m();if(!ie)return console.error("reRenderFullImage: 缺少图像数据"),o.value="缺少图像数据",L||t?.onRenderError?.("缺少图像数据"),!1;const Q=Symbol("render");b=Q,a.value=!0,o.value="",L||t?.onRenderStart?.();try{console.log("reRenderFullImage: 开始重新渲染，气泡数量:",s.value.length);const v=s.value,Z=v.map(C=>C.translatedText||""),Y=v.map(C=>C.coords.map(D=>Math.round(D))),p=v.map(C=>({translatedText:C.translatedText||"",coords:C.coords,fontSize:Number(C.fontSize)||24,fontFamily:C.fontFamily||"fonts/STSONG.TTF",textDirection:$t(C),textColor:C.textColor||"#231816",rotationAngle:Math.round(Number(C.rotationAngle)||0),position:C.position?{x:Math.round(C.position.x||0),y:Math.round(C.position.y||0)}:{x:0,y:0},strokeEnabled:C.strokeEnabled!==void 0?C.strokeEnabled:!0,strokeColor:C.strokeColor||"#FFFFFF",strokeWidth:Number(C.strokeWidth)||3})),u=await un({clean_image:ie,bubble_texts:Z,bubble_coords:Y,bubble_states:p,fontSize:Number(v[0]?.fontSize)||24,fontFamily:v[0]?.fontFamily||"fonts/STSONG.TTF",textDirection:v[0]?$t(v[0]):"vertical",textColor:v[0]?.textColor||"#231816",strokeEnabled:v[0]?.strokeEnabled!==void 0?v[0].strokeEnabled:!0,strokeColor:v[0]?.strokeColor||"#FFFFFF",strokeWidth:Number(v[0]?.strokeWidth)||3,use_individual_styles:!0,use_inpainting:!1,use_lama:!1,is_font_style_change:!0});if(b!==Q)return console.log("reRenderFullImage: 渲染结果已过期，忽略"),!1;if(u.rendered_image){const C=`data:image/png;base64,${u.rendered_image}`;return l.updateCurrentImage({translatedDataURL:C}),console.log("reRenderFullImage: 渲染成功"),L||t?.onRenderSuccess?.(C),!0}else{const C=u.error||"渲染失败";return console.error("reRenderFullImage: 渲染失败 -",C),o.value=C,L||t?.onRenderError?.(C),!1}}catch(v){if(b!==Q)return!1;const Z=v instanceof Error?v.message:"渲染请求失败";return console.error("reRenderFullImage: 渲染出错 -",v),o.value=Z,L||t?.onRenderError?.(Z),!1}finally{b===Q&&(a.value=!1,L||t?.onRenderEnd?.())}}function x(){b=null,a.value=!1}return{isRendering:a,renderError:o,reRenderFullImage:T,cancelRender:x}}const sg=["data-index","data-coords","data-rotation","onClick","onMousedown"],lg={class:"bubble-index"},ig=["data-parent-index","onMousedown"],rg=["data-parent-index","onMousedown"],ug=["data-parent-index","onMousedown"],cg=["data-parent-index","onMousedown"],dg=["data-parent-index","onMousedown"],gg=["data-parent-index","onMousedown"],vg=["data-parent-index","onMousedown"],bg=["data-parent-index","onMousedown"],pg=["data-parent-index","onMousedown"],fg=je({__name:"BubbleOverlay",props:{bubbles:{},selectedIndex:{},selectedIndices:{},scale:{},isDrawingMode:{type:Boolean},isBrushMode:{type:Boolean},imageWidth:{},imageHeight:{}},emits:["select","multiSelect","dragStart","dragging","dragEnd","resizeStart","resizing","resizeEnd","rotateStart","rotating","rotateEnd","drawBubble"],setup(t,{emit:i}){const l=gt(),{isDragging:s,draggingIndex:n,dragOffsetX:a,dragOffsetY:o,dragInitialX:b,dragInitialY:m,isResizing:T,resizingIndex:x,resizeCurrentCoords:L,isRotating:ne,rotatingIndex:ie,rotateCurrentAngle:Q}=yt(l),v=t,Z=i,Y=h(null),p=h(0),u=h(0),C=h(""),D=h(0),k=h(0),J=h(null),te=h(0),de=h(0),F=h(0),g=h(0),_=h(!1),B=h(0),q=h(0),N=h(null),M=h(!1);function f(I,d){let z,K,j,be,he=I.rotationAngle||0;if(s.value&&n.value===d){const[_e,Se,Ce,ye]=I.coords;z=b.value+a.value,K=m.value+o.value,j=z+(Ce-_e),be=K+(ye-Se)}else T.value&&x.value===d&&L.value?[z,K,j,be]=L.value:ne.value&&ie.value===d?([z,K,j,be]=I.coords,he=Q.value):[z,K,j,be]=I.coords;const ke=j-z,xe=be-K,De={left:`${z}px`,top:`${K}px`,width:`${ke}px`,height:`${xe}px`};return he&&(De.transformOrigin="center center",De.transform=`rotate(${he}deg)`),De}function S(){if(!N.value)return{};const[I,d,z,K]=N.value;return{left:`${Math.min(I,z)}px`,top:`${Math.min(d,K)}px`,width:`${Math.abs(z-I)}px`,height:`${Math.abs(K-d)}px`}}function oe(I){if(!Y.value)return null;const d=Y.value.getBoundingClientRect(),z=v.scale||1,K=(I.clientX-d.left)/z,j=(I.clientY-d.top)/z;return{x:K,y:j}}function R(I,d){v.isBrushMode||d.shiftKey||Z("select",I)}function E(I){if(!v.isBrushMode){if(I.button===1){I.preventDefault(),M.value=!0,document.body.classList.add("middle-button-drawing"),P(I);return}I.button===0&&v.isDrawingMode&&P(I)}}function $(I,d){if(!v.isBrushMode&&d.button===0){if(d.preventDefault(),d.stopPropagation(),d.shiftKey){Z("multiSelect",I);return}if(I!==v.selectedIndex){Z("select",I);return}c(I,d)}}function c(I,d){document.removeEventListener("mousemove",re),document.removeEventListener("mouseup",le),s.value=!0,n.value=I,p.value=d.clientX,u.value=d.clientY,a.value=0,o.value=0;const z=v.bubbles[I];z&&(b.value=z.coords[0],m.value=z.coords[1]),Z("dragStart",I,d),document.addEventListener("mousemove",re),document.addEventListener("mouseup",le)}function O(I){const d=v.scale||1,z=(I.clientX-p.value)/d,K=(I.clientY-u.value)/d;a.value=z,o.value=K}function ce(I){const d=n.value;s.value=!1,n.value=-1,a.value=0,o.value=0;const z=v.scale||1,K=(I.clientX-p.value)/z,j=(I.clientY-u.value)/z,be=v.bubbles[d];if(!be)return;const[he,ke,xe,De]=be.coords,_e=xe-he,Se=De-ke;let Ce=Math.round(b.value+K),ye=Math.round(m.value+j);const Ue=v.imageWidth||2e3,we=v.imageHeight||2e3,Be=Math.min(_e,Ue),Pe=Math.min(Se,we);Ce=Math.max(0,Math.min(Ce,Ue-Be)),ye=Math.max(0,Math.min(ye,we-Pe));const $e=[Ce,ye,Ce+Be,ye+Pe];Z("dragEnd",d,$e)}function X(I,d,z){if(v.isBrushMode||z.button!==0)return;z.preventDefault(),z.stopPropagation(),document.removeEventListener("mousemove",re),document.removeEventListener("mouseup",le),T.value=!0,x.value=d,C.value=I,D.value=z.clientX,k.value=z.clientY;const K=v.bubbles[d];K&&(J.value=[...K.coords],L.value=[...K.coords]),Z("resizeStart",d,I,z),document.addEventListener("mousemove",re),document.addEventListener("mouseup",le)}function G(I){if(!J.value)return;const d=v.scale||1,z=(I.clientX-D.value)/d,K=(I.clientY-k.value)/d;let[j,be,he,ke]=J.value;const xe=C.value;xe.includes("w")&&(j+=z),xe.includes("e")&&(he+=z),xe.includes("n")&&(be+=K),xe.includes("s")&&(ke+=K),j>he&&([j,he]=[he,j]),be>ke&&([be,ke]=[ke,be]);const De=10;he-j<De||ke-be<De||(L.value=[j,be,he,ke])}function A(I){if(!J.value)return;const d=v.scale||1,z=(I.clientX-D.value)/d,K=(I.clientY-k.value)/d;let[j,be,he,ke]=J.value;const xe=C.value;xe.includes("w")&&(j+=z),xe.includes("e")&&(he+=z),xe.includes("n")&&(be+=K),xe.includes("s")&&(ke+=K),j>he&&([j,he]=[he,j]),be>ke&&([be,ke]=[ke,be]);const De=v.imageWidth||2e3,_e=v.imageHeight||2e3;j=Math.max(0,Math.round(j)),be=Math.max(0,Math.round(be)),he=Math.min(De,Math.round(he)),ke=Math.min(_e,Math.round(ke));const Se=10;if(he-j<Se||ke-be<Se){console.warn("调整后尺寸过小，已撤销"),T.value=!1,x.value=-1,J.value=null;return}Z("resizeEnd",x.value,[j,be,he,ke]),T.value=!1,x.value=-1,J.value=null,L.value=null}function r(I,d){if(v.isBrushMode||d.button!==0)return;d.preventDefault(),d.stopPropagation(),document.removeEventListener("mousemove",re),document.removeEventListener("mouseup",le),ne.value=!0,ie.value=I;const z=v.bubbles[I];if(!z||!Y.value)return;const[K,j,be,he]=z.coords,ke=v.scale||1,xe=Y.value.getBoundingClientRect();F.value=xe.left+(K+be)/2*ke,g.value=xe.top+(j+he)/2*ke;const De=d.clientX-F.value,_e=d.clientY-g.value;te.value=Math.atan2(_e,De)*180/Math.PI,de.value=z.rotationAngle||0,Q.value=z.rotationAngle||0,Z("rotateStart",I,d),document.body.classList.add("rotating-box"),document.addEventListener("mousemove",re),document.addEventListener("mouseup",le),console.log(`开始旋转气泡 #${I+1}，初始角度: ${de.value}°`)}function y(I){const d=I.clientX-F.value,z=I.clientY-g.value,j=Math.atan2(z,d)*180/Math.PI-te.value;let be=de.value+j;for(;be>180;)be-=360;for(;be<-180;)be+=360;I.shiftKey&&(be=Math.round(be/15)*15),Q.value=be}function w(I){document.body.classList.remove("rotating-box");const d=ie.value,z=Q.value;Z("rotateEnd",d,z),ne.value=!1,ie.value=-1,console.log(`气泡 #${d+1} 旋转完成，角度: ${z}°`)}function P(I){const d=oe(I);if(!d)return;const z=v.imageWidth||2e3,K=v.imageHeight||2e3;d.x<0||d.x>z||d.y<0||d.y>K||(_.value=!0,B.value=d.x,q.value=d.y,N.value=[d.x,d.y,d.x,d.y],document.addEventListener("mousemove",re),document.addEventListener("mouseup",le),console.log("开始绘制新框:",d.x.toFixed(1),d.y.toFixed(1)))}function se(I){const d=oe(I);!d||!N.value||(N.value=[B.value,q.value,d.x,d.y])}function ge(I){const d=oe(I);if(M.value&&(M.value=!1,document.body.classList.remove("middle-button-drawing")),!d||!N.value){_.value=!1,N.value=null;return}const z=v.imageWidth||2e3,K=v.imageHeight||2e3,j=Math.max(0,Math.round(Math.min(B.value,d.x))),be=Math.max(0,Math.round(Math.min(q.value,d.y))),he=Math.min(z,Math.round(Math.max(B.value,d.x))),ke=Math.min(K,Math.round(Math.max(q.value,d.y))),xe=10;if(he-j<xe||ke-be<xe){console.log("绘制的框太小，已忽略"),_.value=!1,N.value=null;return}console.log("完成绘制新框:",[j,be,he,ke]),Z("drawBubble",[j,be,he,ke]),_.value=!1,N.value=null}function re(I){s.value?O(I):T.value?G(I):ne.value?y(I):_.value&&se(I)}function le(I){document.removeEventListener("mousemove",re),document.removeEventListener("mouseup",le),(I.button===1||M.value)&&(M.value=!1,document.body.classList.remove("middle-button-drawing")),s.value?ce(I):T.value?A(I):ne.value?w():_.value&&ge(I)}return ut(()=>{}),It(()=>{document.removeEventListener("mousemove",re),document.removeEventListener("mouseup",le),document.body.classList.remove("middle-button-drawing"),document.body.classList.remove("rotating-box")}),(I,d)=>(U(),H("div",{class:Le(["bubble-overlay",{"brush-mode":t.isBrushMode}]),ref_key:"overlayRef",ref:Y,onMousedown:E},[(U(!0),H(Ge,null,tt(t.bubbles,(z,K)=>(U(),H("div",{key:K,class:Le(["bubble-highlight-box",{selected:K===t.selectedIndex,"multi-selected":t.selectedIndices.length>1&&t.selectedIndices.includes(K)&&K!==t.selectedIndex}]),style:st(f(z,K)),"data-index":K,"data-coords":JSON.stringify(z.coords),"data-rotation":z.rotationAngle||0,onClick:nt(j=>R(K,j),["stop"]),onMousedown:nt(j=>$(K,j),["stop"])},[e("span",lg,fe(K+1),1),K===t.selectedIndex?(U(),H(Ge,{key:0},[e("div",{class:"resize-handle nw","data-handle":"nw","data-parent-index":K,onMousedown:nt(j=>X("nw",K,j),["stop"])},null,40,ig),e("div",{class:"resize-handle n","data-handle":"n","data-parent-index":K,onMousedown:nt(j=>X("n",K,j),["stop"])},null,40,rg),e("div",{class:"resize-handle ne","data-handle":"ne","data-parent-index":K,onMousedown:nt(j=>X("ne",K,j),["stop"])},null,40,ug),e("div",{class:"resize-handle e","data-handle":"e","data-parent-index":K,onMousedown:nt(j=>X("e",K,j),["stop"])},null,40,cg),e("div",{class:"resize-handle se","data-handle":"se","data-parent-index":K,onMousedown:nt(j=>X("se",K,j),["stop"])},null,40,dg),e("div",{class:"resize-handle s","data-handle":"s","data-parent-index":K,onMousedown:nt(j=>X("s",K,j),["stop"])},null,40,gg),e("div",{class:"resize-handle sw","data-handle":"sw","data-parent-index":K,onMousedown:nt(j=>X("sw",K,j),["stop"])},null,40,vg),e("div",{class:"resize-handle w","data-handle":"w","data-parent-index":K,onMousedown:nt(j=>X("w",K,j),["stop"])},null,40,bg),d[0]||(d[0]=e("div",{class:"rotate-line"},null,-1)),e("div",{class:"rotate-handle",title:"拖拽旋转","data-parent-index":K,onMousedown:nt(j=>r(K,j),["stop"])},null,40,pg)],64)):Te("",!0)],46,sg))),128)),N.value?(U(),H("div",{key:0,class:"drawing-rect",style:st(S())},null,4)):Te("",!0)],34))}}),Wn=Xe(fg,[["__scopeId","data-v-2f792fba"]]),mg={key:0,class:"kana-keyboard"},hg={class:"kana-keyboard-header"},yg={class:"kana-keyboard-tabs"},xg=["onClick"],kg={class:"kana-keyboard-options"},Sg={class:"kana-mode-select"},Cg={class:"kana-target-select"},_g={class:"kana-table"},wg={class:"row-label"},$g=["onClick"],Tg={class:"kana-hiragana"},Ig={class:"kana-katakana"},Dg={class:"kana-table"},Rg={class:"row-label"},Mg=["onClick"],Bg={class:"kana-hiragana"},Eg={class:"kana-katakana"},Pg={class:"kana-table combo-table"},Ag={class:"row-label"},Fg=["onClick"],Lg={class:"kana-hiragana"},Ug={class:"kana-katakana"},Og={class:"special-chars-grid"},zg=["onClick"],Vg={key:0,class:"char-label"},Ng=je({__name:"JapaneseKeyboard",props:{visible:{type:Boolean,default:!1},defaultTarget:{default:"original"}},emits:["close","insert","delete"],setup(t,{emit:i}){const l=t,s=i,n=h("basic"),a=h("hiragana"),o=h(l.defaultTarget),b=h(null),m=[{label:"原文",value:"original"},{label:"译文",value:"translated"}],T=[{id:"basic",label:"基本"},{id:"dakuten",label:"浊/半浊音"},{id:"combo",label:"拗音"},{id:"special",label:"特殊"}],x=[{label:"あ行",chars:[{h:"あ",k:"ア"},{h:"い",k:"イ"},{h:"う",k:"ウ"},{h:"え",k:"エ"},{h:"お",k:"オ"}]},{label:"か行",chars:[{h:"か",k:"カ"},{h:"き",k:"キ"},{h:"く",k:"ク"},{h:"け",k:"ケ"},{h:"こ",k:"コ"}]},{label:"さ行",chars:[{h:"さ",k:"サ"},{h:"し",k:"シ"},{h:"す",k:"ス"},{h:"せ",k:"セ"},{h:"そ",k:"ソ"}]},{label:"た行",chars:[{h:"た",k:"タ"},{h:"ち",k:"チ"},{h:"つ",k:"ツ"},{h:"て",k:"テ"},{h:"と",k:"ト"}]},{label:"な行",chars:[{h:"な",k:"ナ"},{h:"に",k:"ニ"},{h:"ぬ",k:"ヌ"},{h:"ね",k:"ネ"},{h:"の",k:"ノ"}]},{label:"は行",chars:[{h:"は",k:"ハ"},{h:"ひ",k:"ヒ"},{h:"ふ",k:"フ"},{h:"へ",k:"ヘ"},{h:"ほ",k:"ホ"}]},{label:"ま行",chars:[{h:"ま",k:"マ"},{h:"み",k:"ミ"},{h:"む",k:"ム"},{h:"め",k:"メ"},{h:"も",k:"モ"}]},{label:"や行",chars:[{h:"や",k:"ヤ"},null,{h:"ゆ",k:"ユ"},null,{h:"よ",k:"ヨ"}]},{label:"ら行",chars:[{h:"ら",k:"ラ"},{h:"り",k:"リ"},{h:"る",k:"ル"},{h:"れ",k:"レ"},{h:"ろ",k:"ロ"}]},{label:"わ行",chars:[{h:"わ",k:"ワ"},null,null,null,{h:"を",k:"ヲ"}]},{label:"ん",chars:[{h:"ん",k:"ン"},null,null,null,null]}],L=[{label:"が行",chars:[{h:"が",k:"ガ"},{h:"ぎ",k:"ギ"},{h:"ぐ",k:"グ"},{h:"げ",k:"ゲ"},{h:"ご",k:"ゴ"}]},{label:"ざ行",chars:[{h:"ざ",k:"ザ"},{h:"じ",k:"ジ"},{h:"ず",k:"ズ"},{h:"ぜ",k:"ゼ"},{h:"ぞ",k:"ゾ"}]},{label:"だ行",chars:[{h:"だ",k:"ダ"},{h:"ぢ",k:"ヂ"},{h:"づ",k:"ヅ"},{h:"で",k:"デ"},{h:"ど",k:"ド"}]},{label:"ば行",chars:[{h:"ば",k:"バ"},{h:"び",k:"ビ"},{h:"ぶ",k:"ブ"},{h:"べ",k:"ベ"},{h:"ぼ",k:"ボ"}]},{label:"ぱ行",chars:[{h:"ぱ",k:"パ"},{h:"ぴ",k:"ピ"},{h:"ぷ",k:"プ"},{h:"ぺ",k:"ペ"},{h:"ぽ",k:"ポ"}]}],ne=[{label:"きゃ行",chars:[{h:"きゃ",k:"キャ"},{h:"きゅ",k:"キュ"},{h:"きょ",k:"キョ"}]},{label:"しゃ行",chars:[{h:"しゃ",k:"シャ"},{h:"しゅ",k:"シュ"},{h:"しょ",k:"ショ"}]},{label:"ちゃ行",chars:[{h:"ちゃ",k:"チャ"},{h:"ちゅ",k:"チュ"},{h:"ちょ",k:"チョ"}]},{label:"にゃ行",chars:[{h:"にゃ",k:"ニャ"},{h:"にゅ",k:"ニュ"},{h:"にょ",k:"ニョ"}]},{label:"ひゃ行",chars:[{h:"ひゃ",k:"ヒャ"},{h:"ひゅ",k:"ヒュ"},{h:"ひょ",k:"ヒョ"}]},{label:"みゃ行",chars:[{h:"みゃ",k:"ミャ"},{h:"みゅ",k:"ミュ"},{h:"みょ",k:"ミョ"}]},{label:"りゃ行",chars:[{h:"りゃ",k:"リャ"},{h:"りゅ",k:"リュ"},{h:"りょ",k:"リョ"}]},{label:"ぎゃ行",chars:[{h:"ぎゃ",k:"ギャ"},{h:"ぎゅ",k:"ギュ"},{h:"ぎょ",k:"ギョ"}]},{label:"じゃ行",chars:[{h:"じゃ",k:"ジャ"},{h:"じゅ",k:"ジュ"},{h:"じょ",k:"ジョ"}]},{label:"びゃ行",chars:[{h:"びゃ",k:"ビャ"},{h:"びゅ",k:"ビュ"},{h:"びょ",k:"ビョ"}]},{label:"ぴゃ行",chars:[{h:"ぴゃ",k:"ピャ"},{h:"ぴゅ",k:"ピュ"},{h:"ぴょ",k:"ピョ"}]}],ie=[{char:"っ",label:"促音"},{char:"ッ",label:"促音"},{char:"ー",label:"长音"},{char:"〜",label:"波浪"},{char:"。",label:"句号"},{char:"、",label:"顿号"},{char:"「",label:"引号"},{char:"」",label:"引号"},{char:"『",label:"双引"},{char:"』",label:"双引"},{char:"…",label:"省略"},{char:"・",label:"中点"},{char:"！",label:"感叹"},{char:"？",label:"问号"},{char:"♪",label:"音符"},{char:"♡",label:"心形"},{char:"★",label:"星形"},{char:"☆",label:"空星"},{char:"ぁ",label:"小あ"},{char:"ぃ",label:"小い"},{char:"ぅ",label:"小う"},{char:"ぇ",label:"小え"},{char:"ぉ",label:"小お"},{char:"ァ",label:"小ア"},{char:"ィ",label:"小イ"},{char:"ゥ",label:"小ウ"},{char:"ェ",label:"小エ"},{char:"ォ",label:"小オ"},{char:"ゃ",label:"小や"},{char:"ゅ",label:"小ゆ"},{char:"ょ",label:"小よ"},{char:"ャ",label:"小ヤ"},{char:"ュ",label:"小ユ"},{char:"ョ",label:"小ヨ"}];function Q(){s("close")}function v(p){const u=a.value==="hiragana"?p.h:p.k;b.value=p.h,setTimeout(()=>{b.value=null},100),s("insert",u,o.value)}function Z(p){b.value=p,setTimeout(()=>{b.value=null},100),s("insert",p,o.value)}function Y(){s("delete",o.value)}return(p,u)=>t.visible?(U(),H("div",mg,[e("div",hg,[u[3]||(u[3]=e("span",{class:"kana-keyboard-title"},"50音键盘",-1)),e("div",yg,[(U(),H(Ge,null,tt(T,C=>e("button",{key:C.id,class:Le(["kana-tab",{active:n.value===C.id}]),onClick:D=>n.value=C.id},fe(C.label),11,xg)),64))]),e("button",{class:"kana-keyboard-close",onClick:Q},"✕")]),e("div",kg,[e("div",Sg,[e("label",null,[ae(e("input",{type:"radio",name:"kanaMode",value:"hiragana","onUpdate:modelValue":u[0]||(u[0]=C=>a.value=C)},null,512),[[Ln,a.value]]),u[4]||(u[4]=Fe(" 平假名 ",-1))]),e("label",null,[ae(e("input",{type:"radio",name:"kanaMode",value:"katakana","onUpdate:modelValue":u[1]||(u[1]=C=>a.value=C)},null,512),[[Ln,a.value]]),u[5]||(u[5]=Fe(" 片假名 ",-1))])]),e("div",Cg,[u[6]||(u[6]=e("label",null,"输入到：",-1)),Ie(We,{modelValue:o.value,"onUpdate:modelValue":u[2]||(u[2]=C=>o.value=C),options:m},null,8,["modelValue"])])]),e("div",{class:Le(["kana-tab-content",{active:n.value==="basic"}])},[e("table",_g,[u[7]||(u[7]=e("thead",null,[e("tr",null,[e("th"),e("th",null,"あ段"),e("th",null,"い段"),e("th",null,"う段"),e("th",null,"え段"),e("th",null,"お段")])],-1)),e("tbody",null,[(U(),H(Ge,null,tt(x,C=>e("tr",{key:C.label},[e("td",wg,fe(C.label),1),(U(!0),H(Ge,null,tt(C.chars,(D,k)=>(U(),H("td",{key:k},[D?(U(),H("button",{key:0,class:Le(["kana-key",{pressed:b.value===D.h}]),onClick:J=>v(D)},[e("span",Tg,fe(D.h),1),e("span",Ig,fe(D.k),1)],10,$g)):Te("",!0)]))),128))])),64))])])],2),e("div",{class:Le(["kana-tab-content",{active:n.value==="dakuten"}])},[e("table",Dg,[u[8]||(u[8]=e("thead",null,[e("tr",null,[e("th"),e("th",null,"あ段"),e("th",null,"い段"),e("th",null,"う段"),e("th",null,"え段"),e("th",null,"お段")])],-1)),e("tbody",null,[(U(),H(Ge,null,tt(L,C=>e("tr",{key:C.label},[e("td",Rg,fe(C.label),1),(U(!0),H(Ge,null,tt(C.chars,(D,k)=>(U(),H("td",{key:k},[D?(U(),H("button",{key:0,class:Le(["kana-key",{pressed:b.value===D.h}]),onClick:J=>v(D)},[e("span",Bg,fe(D.h),1),e("span",Eg,fe(D.k),1)],10,Mg)):Te("",!0)]))),128))])),64))])])],2),e("div",{class:Le(["kana-tab-content",{active:n.value==="combo"}])},[e("table",Pg,[u[9]||(u[9]=e("thead",null,[e("tr",null,[e("th"),e("th",null,"ゃ"),e("th",null,"ゅ"),e("th",null,"ょ")])],-1)),e("tbody",null,[(U(),H(Ge,null,tt(ne,C=>e("tr",{key:C.label},[e("td",Ag,fe(C.label),1),(U(!0),H(Ge,null,tt(C.chars,(D,k)=>(U(),H("td",{key:k},[D?(U(),H("button",{key:0,class:Le(["kana-key",{pressed:b.value===D.h}]),onClick:J=>v(D)},[e("span",Lg,fe(D.h),1),e("span",Ug,fe(D.k),1)],10,Fg)):Te("",!0)]))),128))])),64))])])],2),e("div",{class:Le(["kana-tab-content",{active:n.value==="special"}])},[e("div",Og,[(U(),H(Ge,null,tt(ie,C=>e("button",{key:C.char,class:Le(["kana-key special-key",{pressed:b.value===C.char}]),onClick:D=>Z(C.char)},[Fe(fe(C.char)+" ",1),C.label?(U(),H("span",Vg,fe(C.label),1)):Te("",!0)],10,zg)),64))])],2),e("div",{class:"kana-keyboard-footer"},[e("button",{class:"kana-backspace",onClick:Y},"⌫ 退格")])])):Te("",!0)}}),Wg=Xe(Ng,[["__scopeId","data-v-1da0f595"]]),Kg={class:"edit-panel-content"},qg={class:"text-column original-text-column text-block"},Hg={class:"text-column translated-text-column text-block"},Yg={class:"style-settings-section text-block"},Jg={class:"office-toolbar"},Xg={class:"toolbar-row toolbar-row-top"},jg={class:"combo-control font-control"},Gg={class:"combo-control size-control"},Zg={class:"size-input-wrap"},Qg=["min","max","step"],ev={class:"toolbar-row toolbar-row-actions"},tv={class:"toolbar-icon-group","aria-label":"排版方向"},nv=["data-active"],ov=["data-active"],av={class:"toolbar-color-group"},sv={class:"toolbar-color-picker",title:"文字颜色"},lv={class:"toolbar-inpaint-group",title:"背景修复方式"},iv={class:"toolbar-stroke-cluster"},rv=["data-active"],uv={class:"toolbar-row toolbar-row-bottom"},cv={class:"toolbar-rotation-group",title:"旋转角度"},dv={class:"toolbar-position-group",title:"位置调整"},gv={class:"toolbar-position-value"},vv={class:"fontsize-presets-panel"},bv={class:"font-size-presets"},pv=["onClick"],Bt=2,fv=je({__name:"BubbleEditor",props:{bubble:{},bubbleIndex:{}},emits:["update","reRender","ocrRecognize","reTranslate","applyBubble","resetCurrent"],setup(t,{emit:i}){const l=t,s=i,n=gt(),a={originalText:"",translatedText:"",fontSize:24,fontFamily:"fonts/STSONG.TTF",textDirection:"auto",textColor:"#231816",fillColor:"#FFFFFF",strokeEnabled:!0,strokeColor:"#FFFFFF",strokeWidth:3,rotationAngle:0,inpaintMethod:"solid",position:{x:0,y:0}},o=h(""),b=h(""),m=h(24),T=h("fonts/STSONG.TTF"),x=h("auto"),L=h("#231816"),ne=h("#FFFFFF"),ie=h(!0),Q=h("#FFFFFF"),v=h(3),Z=h(0),Y=h("solid"),p=h(0),u=h(0),C=h(null),D=h(null),k=h(null),J=h(null),te=h(null),de=h(!1),F=h("original"),g=h([{name:"华文宋体",path:"fonts/STSONG.TTF"},{name:"华文楷体",path:"fonts/STKAITI.TTF"},{name:"华文细黑",path:"fonts/STXIHEI.TTF"},{name:"黑体",path:"fonts/SIMHEI.TTF"},{name:"宋体",path:"fonts/SIMSUN.TTC"}]),_=h([]),B=ee(()=>l.bubble?l.bubble.coords[0]+p.value:0),q=ee(()=>l.bubble?l.bubble.coords[1]+u.value:0),N=ee(()=>{const $e=[{label:"系统字体",options:g.value.map(V=>({label:V.name,value:V.path}))}];return _.value.length>0&&$e.push({label:"自定义字体",options:_.value.map(V=>({label:V.name,value:V.path}))}),$e}),M=[{label:"纯色填充",value:"solid"},{label:"LAMA修复(漫画)",value:"lama_mpe"},{label:"LAMA修复(通用)",value:"litelama"}];function f($e){const V=$e||a;o.value=V.originalText,b.value=V.translatedText,m.value=V.fontSize,T.value=V.fontFamily,x.value=V.textDirection,L.value=V.textColor,ne.value=V.fillColor,ie.value=V.strokeEnabled,Q.value=V.strokeColor,v.value=V.strokeWidth,Z.value=V.rotationAngle,Y.value=V.inpaintMethod,p.value=V.position?.x||0,u.value=V.position?.y||0}Ye(()=>l.bubble,$e=>{f($e)},{deep:!0,immediate:!0});function S(){s("update",{originalText:o.value})}function oe(){s("update",{translatedText:b.value})}function R(){navigator.clipboard.writeText(o.value)}function E(){navigator.clipboard.writeText(b.value)}function $(){s("update",{fontSize:m.value})}function c($e){m.value=$e,s("update",{fontSize:$e})}function O(){m.value=Math.min(Pn,m.value+Jt),s("update",{fontSize:m.value})}function ce(){m.value=Math.max(An,m.value-Jt),s("update",{fontSize:m.value})}function X(){s("update",{fontFamily:T.value})}function G($e){x.value=$e,s("update",{textDirection:$e})}function A(){k.value?.click()}function r(){s("update",{textColor:L.value})}function y(){J.value?.click()}function w(){s("update",{fillColor:ne.value})}function P(){te.value?.click()}function se(){s("update",{strokeColor:Q.value})}function ge(){ie.value=!ie.value,s("update",{strokeEnabled:ie.value})}function re(){s("update",{strokeWidth:v.value})}function le(){s("update",{inpaintMethod:Y.value})}function I(){s("update",{rotationAngle:Z.value})}function d(){Z.value=Math.max(-180,Z.value-5),s("update",{rotationAngle:Z.value})}function z(){Z.value=Math.min(180,Z.value+5),s("update",{rotationAngle:Z.value})}function K(){Z.value=0,s("update",{rotationAngle:0})}function j(){p.value-=Bt,s("update",{position:{x:p.value,y:u.value}})}function be(){p.value+=Bt,s("update",{position:{x:p.value,y:u.value}})}function he(){u.value-=Bt,s("update",{position:{x:p.value,y:u.value}})}function ke(){u.value+=Bt,s("update",{position:{x:p.value,y:u.value}})}function xe(){p.value=0,u.value=0,s("update",{position:{x:0,y:0}})}function De(){s("applyBubble",l.bubbleIndex)}function _e(){n.updateAllBubbles({fontSize:m.value,fontFamily:T.value,textDirection:x.value,textColor:L.value,fillColor:ne.value,strokeEnabled:ie.value,strokeColor:Q.value,strokeWidth:v.value,inpaintMethod:Y.value}),console.log("样式已应用到所有气泡"),s("reRender")}function Se(){s("resetCurrent",l.bubbleIndex)}function Ce(){s("ocrRecognize",l.bubbleIndex)}function ye(){s("reTranslate",l.bubbleIndex)}function Ue(){de.value=!de.value}function we($e,V){if(V==="original"){const me=C.value;if(me){const Ae=me.selectionStart||o.value.length,qe=me.selectionEnd||o.value.length,lt=o.value;o.value=lt.slice(0,Ae)+$e+lt.slice(qe),dt(()=>{me.selectionStart=me.selectionEnd=Ae+$e.length,me.focus()}),s("update",{originalText:o.value})}}else{const me=D.value;if(me){const Ae=me.selectionStart||b.value.length,qe=me.selectionEnd||b.value.length,lt=b.value;b.value=lt.slice(0,Ae)+$e+lt.slice(qe),dt(()=>{me.selectionStart=me.selectionEnd=Ae+$e.length,me.focus()}),s("update",{translatedText:b.value})}}}function Be($e){if($e==="original"){const V=C.value;if(V&&o.value.length>0){const me=V.selectionStart||o.value.length,Ae=V.selectionEnd||o.value.length,qe=o.value;me===Ae&&me>0?(o.value=qe.slice(0,me-1)+qe.slice(Ae),dt(()=>{V.selectionStart=V.selectionEnd=me-1,V.focus()})):me!==Ae&&(o.value=qe.slice(0,me)+qe.slice(Ae),dt(()=>{V.selectionStart=V.selectionEnd=me,V.focus()})),s("update",{originalText:o.value})}}else{const V=D.value;if(V&&b.value.length>0){const me=V.selectionStart||b.value.length,Ae=V.selectionEnd||b.value.length,qe=b.value;me===Ae&&me>0?(b.value=qe.slice(0,me-1)+qe.slice(Ae),dt(()=>{V.selectionStart=V.selectionEnd=me-1,V.focus()})):me!==Ae&&(b.value=qe.slice(0,me)+qe.slice(Ae),dt(()=>{V.selectionStart=V.selectionEnd=me,V.focus()})),s("update",{translatedText:b.value})}}}async function Pe(){try{const $e=await Go();if($e.fonts){const V=[],me=[];for(const Ae of $e.fonts){const qe={name:typeof Ae=="string"?Ae:Ae.display_name||Ae.file_name||"",path:typeof Ae=="string"?Ae:Ae.path};qe.path.startsWith("fonts/")?V.push(qe):me.push(qe)}V.length>0&&(g.value=V),_.value=me}}catch($e){console.error("加载字体列表失败:",$e)}}return ut(()=>{Pe()}),($e,V)=>(U(),H("div",Kg,[e("div",qg,[e("div",{class:"text-column-header"},[V[13]||(V[13]=e("span",{class:"column-title"},"🇯🇵 日语原文 (OCR结果)",-1)),e("button",{class:"re-ocr-btn",onClick:Ce,title:"重新OCR此气泡"},"🔄")]),ae(e("textarea",{ref_key:"originalTextInput",ref:C,"onUpdate:modelValue":V[0]||(V[0]=me=>o.value=me),class:"text-editor original-editor",placeholder:"OCR识别的日语原文...",spellcheck:"false",onInput:S},null,544),[[Me,o.value]]),e("div",{class:"text-actions"},[e("button",{class:"copy-btn",onClick:R},"📋 复制"),e("button",{class:"keyboard-toggle-btn",onClick:Ue,title:"显示/隐藏50音键盘"}," ⌨️ 50音 ")]),Ie(Wg,{visible:de.value,"default-target":F.value,onClose:V[1]||(V[1]=me=>de.value=!1),onInsert:we,onDelete:Be},null,8,["visible","default-target"])]),e("div",Hg,[e("div",{class:"text-column-header"},[V[14]||(V[14]=e("span",{class:"column-title"},"🇨🇳 中文译文",-1)),e("button",{class:"re-translate-btn",onClick:ye,title:"重新翻译此气泡"}," 🔄 ")]),ae(e("textarea",{ref_key:"translatedTextInput",ref:D,"onUpdate:modelValue":V[2]||(V[2]=me=>b.value=me),class:"text-editor translated-editor",placeholder:"翻译后的中文...",spellcheck:"false",onInput:oe},null,544),[[Me,b.value]]),e("div",{class:"text-actions"},[e("button",{class:"copy-btn",onClick:E},"📋 复制"),e("button",{class:"apply-text-btn",onClick:De},"✓ 应用文本")])]),e("div",Yg,[e("div",Jg,[e("div",Xg,[e("div",jg,[V[15]||(V[15]=e("label",null,"字体",-1)),Ie(We,{modelValue:T.value,"onUpdate:modelValue":V[3]||(V[3]=me=>T.value=me),groups:N.value,title:"字体",onChange:X},null,8,["modelValue","groups"])]),e("div",Gg,[V[16]||(V[16]=e("label",null,"字号",-1)),e("div",Zg,[ae(e("input",{type:"number","onUpdate:modelValue":V[4]||(V[4]=me=>m.value=me),class:"toolbar-fontsize-input",min:ve(An),max:ve(Pn),step:ve(Jt),title:"字号",onChange:$},null,40,Qg),[[Me,m.value,void 0,{number:!0}]]),e("div",{class:"toolbar-fontsize-btns"},[e("button",{class:"toolbar-fontsize-btn",onClick:O,title:"增大字号"}," A+ "),e("button",{class:"toolbar-fontsize-btn",onClick:ce,title:"减小字号"}," A- ")])])])]),e("div",ev,[e("div",tv,[e("button",{class:"toolbar-btn","data-active":x.value==="vertical",onClick:V[5]||(V[5]=me=>G("vertical")),title:"竖向排版"},[...V[17]||(V[17]=[e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("path",{d:"M8 2v12M8 2L5 5M8 2l3 3",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])],8,nv),e("button",{class:"toolbar-btn","data-active":x.value==="horizontal",onClick:V[6]||(V[6]=me=>G("horizontal")),title:"横向排版"},[...V[18]||(V[18]=[e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("path",{d:"M2 8h12M14 8l-3-3M14 8l-3 3",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])],8,ov)]),V[24]||(V[24]=e("div",{class:"toolbar-divider vertical"},null,-1)),e("div",av,[e("div",sv,[e("button",{class:"toolbar-btn toolbar-color-btn",onClick:A},[V[19]||(V[19]=e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("text",{x:"3",y:"11","font-size":"10","font-weight":"bold",fill:"currentColor"},"A")],-1)),e("span",{class:"color-indicator",style:st({background:L.value})},null,4)]),ae(e("input",{ref_key:"textColorInput",ref:k,type:"color","onUpdate:modelValue":V[7]||(V[7]=me=>L.value=me),class:"hidden-color-input",onChange:r},null,544),[[Me,L.value]])])]),V[25]||(V[25]=e("div",{class:"toolbar-divider vertical"},null,-1)),e("div",lv,[Ie(We,{modelValue:Y.value,"onUpdate:modelValue":V[8]||(V[8]=me=>Y.value=me),options:M,onChange:le},null,8,["modelValue"]),e("div",{class:Le(["toolbar-color-picker toolbar-solid-color-options",{hidden:Y.value!=="solid"}])},[e("button",{class:"toolbar-btn toolbar-color-btn",onClick:y},[V[20]||(V[20]=e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("rect",{x:"2",y:"2",width:"12",height:"12",rx:"2",fill:"none",stroke:"currentColor","stroke-width":"1.2"}),e("rect",{x:"4",y:"4",width:"8",height:"8",rx:"1",fill:"currentColor",opacity:"0.3"})],-1)),e("span",{class:"color-indicator",style:st({background:ne.value})},null,4)]),ae(e("input",{ref_key:"fillColorInput",ref:J,type:"color","onUpdate:modelValue":V[9]||(V[9]=me=>ne.value=me),class:"hidden-color-input",onChange:w},null,544),[[Me,ne.value]])],2)]),V[26]||(V[26]=e("div",{class:"toolbar-divider vertical"},null,-1)),e("div",iv,[e("button",{class:"toolbar-btn","data-active":ie.value,onClick:ge,title:"文字描边"},[...V[21]||(V[21]=[e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("text",{x:"3",y:"12","font-size":"11","font-weight":"bold",stroke:"currentColor","stroke-width":"2",fill:"none"}," A "),e("text",{x:"3",y:"12","font-size":"11","font-weight":"bold",fill:"currentColor"},"A")],-1)])],8,rv),e("div",{class:Le(["toolbar-color-picker toolbar-stroke-options",{hidden:!ie.value}]),title:"描边颜色"},[e("button",{class:"toolbar-btn toolbar-color-btn",onClick:P},[V[22]||(V[22]=e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("circle",{cx:"8",cy:"8",r:"5",fill:"none",stroke:"currentColor","stroke-width":"2"})],-1)),e("span",{class:"color-indicator",style:st({background:Q.value})},null,4)]),ae(e("input",{ref_key:"strokeColorInput",ref:te,type:"color","onUpdate:modelValue":V[10]||(V[10]=me=>Q.value=me),class:"hidden-color-input",onChange:se},null,544),[[Me,Q.value]])],2),e("div",{class:Le(["toolbar-stroke-width toolbar-stroke-options",{hidden:!ie.value}]),title:"描边宽度"},[ae(e("input",{type:"number","onUpdate:modelValue":V[11]||(V[11]=me=>v.value=me),class:"toolbar-mini-input",min:"0",max:"10",onChange:re},null,544),[[Me,v.value,void 0,{number:!0}]]),V[23]||(V[23]=e("span",{class:"toolbar-unit"},"px",-1))],2)])]),e("div",uv,[e("div",cv,[e("button",{class:"toolbar-btn",onClick:d,title:"逆时针旋转"},[...V[27]||(V[27]=[e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("path",{d:"M2 8a6 6 0 1 1 1.5 4",stroke:"currentColor","stroke-width":"1.5",fill:"none"}),e("path",{d:"M2 5v3.5h3.5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),ae(e("input",{type:"number","onUpdate:modelValue":V[12]||(V[12]=me=>Z.value=me),class:"toolbar-mini-input toolbar-rotation-input",min:"-180",max:"180",step:"5",onChange:I},null,544),[[Me,Z.value,void 0,{number:!0}]]),V[29]||(V[29]=e("span",{class:"toolbar-unit"},"°",-1)),e("button",{class:"toolbar-btn",onClick:z,title:"顺时针旋转"},[...V[28]||(V[28]=[e("svg",{viewBox:"0 0 16 16",width:"16",height:"16"},[e("path",{d:"M14 8a6 6 0 1 0-1.5 4",stroke:"currentColor","stroke-width":"1.5",fill:"none"}),e("path",{d:"M14 5v3.5h-3.5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),e("button",{class:"toolbar-btn toolbar-small-btn",onClick:K,title:"重置旋转"}," 0 ")]),V[35]||(V[35]=e("div",{class:"toolbar-divider vertical"},null,-1)),e("div",dv,[e("button",{class:"toolbar-btn",onClick:j,title:"左移"},[...V[30]||(V[30]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("path",{d:"M10 3L5 8l5 5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),e("button",{class:"toolbar-btn",onClick:be,title:"右移"},[...V[31]||(V[31]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("path",{d:"M6 3l5 5-5 5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),e("button",{class:"toolbar-btn",onClick:he,title:"上移"},[...V[32]||(V[32]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("path",{d:"M3 10l5-5 5 5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),e("button",{class:"toolbar-btn",onClick:ke,title:"下移"},[...V[33]||(V[33]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("path",{d:"M3 6l5 5 5-5",stroke:"currentColor","stroke-width":"1.5",fill:"none"})],-1)])]),e("span",gv,[e("span",null,fe(B.value),1),V[34]||(V[34]=Fe(",",-1)),e("span",null,fe(q.value),1)]),e("button",{class:"toolbar-btn toolbar-small-btn",onClick:xe,title:"重置位置"}," ⌂ ")])])]),e("details",vv,[V[36]||(V[36]=e("summary",null,"字号预设",-1)),e("div",bv,[(U(!0),H(Ge,null,tt(ve(Eo),me=>(U(),H("button",{key:me,class:Le(["preset-btn",{active:m.value===me}]),onClick:Ae=>c(me)},fe(me),11,pv))),128))])]),e("div",{class:"edit-action-buttons"},[e("button",{class:"btn-apply",onClick:De},"应用"),e("button",{class:"btn-apply-all",onClick:_e},"应用全部"),e("button",{class:"btn-reset",onClick:Se},"重置")])])]))}}),mv=Xe(fv,[["__scopeId","data-v-db000457"]]),hv={class:"edit-toolbar-wrapper"},yv={class:"edit-toolbar toolbar-row-1"},xv={class:"image-navigator"},kv=["disabled"],Sv=["disabled"],Cv={class:"bubble-navigator"},_v=["disabled"],wv={class:"bubble-indicator"},$v={id:"currentBubbleNum"},Tv={id:"totalBubbleNum"},Iv=["disabled"],Dv={class:"view-controls"},Rv={key:0,viewBox:"0 0 20 20",width:"16",height:"16"},Mv={key:1,viewBox:"0 0 20 20",width:"16",height:"16"},Bv={id:"zoomLevel"},Ev={class:"edit-toolbar toolbar-row-2"},Pv={class:"annotation-tools"},Av=["disabled"],Fv=["disabled"],Lv={key:0,class:"brush-size-indicator"},Uv={key:1,class:"brush-mode-hint"},Ov={class:"edit-progress-info"},zv={class:"edit-progress-text"},Vv={class:"edit-progress-count"},Nv={class:"edit-progress-bar"},Wv={class:"quick-actions"},Kv=je({__name:"EditToolbar",props:{currentImageIndex:{},imageCount:{},canGoPrevious:{type:Boolean},canGoNext:{type:Boolean},showThumbnails:{type:Boolean},hasBubbles:{type:Boolean},selectedBubbleIndex:{},bubbleCount:{},layoutMode:{},syncEnabled:{type:Boolean},scale:{},isDrawingMode:{type:Boolean},hasSelection:{type:Boolean},brushMode:{},brushSize:{},mouseX:{},mouseY:{},isProcessing:{type:Boolean},progressText:{},progressCurrent:{},progressTotal:{}},emits:["go-previous-image","go-next-image","toggle-thumbnails","select-previous-bubble","select-next-bubble","toggle-layout","toggle-view-mode","toggle-sync","fit-to-screen","zoom-in","zoom-out","reset-zoom","exit-edit-mode","auto-detect-bubbles","detect-all-images","translate-with-bubbles","toggle-drawing-mode","delete-selected-bubbles","repair-selected-bubble","activate-repair-brush","activate-restore-brush","apply-and-next"],setup(t){const i=t,l=ee(()=>i.progressTotal===0?0:Math.round(i.progressCurrent/i.progressTotal*100)),s=ee(()=>i.progressTotal>0&&i.progressCurrent>=i.progressTotal),n=ee(()=>{const a=i.brushMode==="repair"?{fill:"rgba(76, 175, 80, 0.4)",border:"#4CAF50"}:{fill:"rgba(33, 150, 243, 0.4)",border:"#2196F3"};return{position:"fixed",left:`${i.mouseX}px`,top:`${i.mouseY}px`,width:`${i.brushSize}px`,height:`${i.brushSize}px`,borderRadius:"50%",border:`2px solid ${a.border}`,backgroundColor:a.fill,pointerEvents:"none",zIndex:99999,transform:"translate(-50%, -50%)",display:i.brushMode?"block":"none"}});return(a,o)=>(U(),H("div",hv,[e("div",yv,[e("div",xv,[e("button",{class:"nav-btn",disabled:!t.canGoPrevious,onClick:o[0]||(o[0]=b=>a.$emit("go-previous-image")),title:"上一张图片 (PageUp)"}," ◀◀ ",8,kv),e("span",{class:"image-indicator",onClick:o[1]||(o[1]=b=>a.$emit("toggle-thumbnails")),title:"点击展开缩略图"},[o[23]||(o[23]=Fe(" 图 ",-1)),e("span",null,fe(t.currentImageIndex+1),1),o[24]||(o[24]=Fe(" / ",-1)),e("span",null,fe(t.imageCount),1)]),e("button",{class:"nav-btn",disabled:!t.canGoNext,onClick:o[2]||(o[2]=b=>a.$emit("go-next-image")),title:"下一张图片 (PageDown)"}," ▶▶ ",8,Sv),e("button",{class:Le(["thumb-toggle-btn",{active:t.showThumbnails}]),onClick:o[3]||(o[3]=b=>a.$emit("toggle-thumbnails")),title:"显示/隐藏缩略图"}," ☷ ",2)]),o[30]||(o[30]=e("div",{class:"toolbar-divider"},null,-1)),e("div",Cv,[e("button",{id:"prevBubbleBtn",class:"nav-btn",disabled:!t.hasBubbles||t.selectedBubbleIndex<=0,onClick:o[4]||(o[4]=b=>a.$emit("select-previous-bubble")),title:"上一个气泡 (←)"}," ◀ ",8,_v),e("span",wv,[o[25]||(o[25]=Fe(" 气泡 ",-1)),e("span",$v,fe(t.selectedBubbleIndex>=0?t.selectedBubbleIndex+1:0),1),o[26]||(o[26]=Fe(" / ",-1)),e("span",Tv,fe(t.bubbleCount),1)]),e("button",{id:"nextBubbleBtn",class:"nav-btn",disabled:!t.hasBubbles||t.selectedBubbleIndex>=t.bubbleCount-1,onClick:o[5]||(o[5]=b=>a.$emit("select-next-bubble")),title:"下一个气泡 (→)"}," ▶ ",8,Iv)]),o[31]||(o[31]=e("div",{class:"toolbar-divider"},null,-1)),e("div",Dv,[e("button",{class:"layout-toggle-btn",onClick:o[6]||(o[6]=b=>a.$emit("toggle-layout")),title:"切换布局：左右/上下"},[t.layoutMode==="horizontal"?(U(),H("svg",Rv,[...o[27]||(o[27]=[e("rect",{x:"1",y:"2",width:"8",height:"16",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"},null,-1),e("rect",{x:"11",y:"2",width:"8",height:"16",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"},null,-1)])])):(U(),H("svg",Mv,[...o[28]||(o[28]=[e("rect",{x:"2",y:"1",width:"16",height:"8",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"},null,-1),e("rect",{x:"2",y:"11",width:"16",height:"8",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"},null,-1)])]))]),e("button",{class:"view-mode-btn",onClick:o[7]||(o[7]=b=>a.$emit("toggle-view-mode")),title:"切换视图模式"},[...o[29]||(o[29]=[e("span",{class:"dual-icon"},"⧉",-1)])]),e("button",{class:Le({active:t.syncEnabled}),onClick:o[8]||(o[8]=b=>a.$emit("toggle-sync")),title:"同步缩放/拖动",style:{"font-size":"12px"}}," 🔗 ",2),e("button",{onClick:o[9]||(o[9]=b=>a.$emit("fit-to-screen")),title:"适应屏幕 (双击)"},"⛶"),e("button",{onClick:o[10]||(o[10]=b=>a.$emit("zoom-in")),title:"放大 (+)"},"+"),e("span",Bv,fe(Math.round(t.scale*100))+"%",1),e("button",{onClick:o[11]||(o[11]=b=>a.$emit("zoom-out")),title:"缩小 (-)"},"−"),e("button",{onClick:o[12]||(o[12]=b=>a.$emit("reset-zoom")),title:"原始大小"},"1:1")]),o[32]||(o[32]=e("div",{class:"toolbar-spacer"},null,-1)),e("button",{class:"secondary-btn",onClick:o[13]||(o[13]=b=>a.$emit("exit-edit-mode"))},"退出编辑")]),e("div",Ev,[e("div",Pv,[e("button",{class:"annotation-btn detect-btn",onClick:o[14]||(o[14]=b=>a.$emit("auto-detect-bubbles")),title:"自动检测当前图片的文本框"},[...o[33]||(o[33]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("circle",{cx:"6",cy:"6",r:"4",fill:"none",stroke:"currentColor","stroke-width":"1.5"}),e("path",{d:"M9 9l4 4",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round"})],-1),e("span",null,"检测",-1)])]),e("button",{class:"annotation-btn detect-btn",onClick:o[15]||(o[15]=b=>a.$emit("detect-all-images")),title:"批量检测所有图片"},[...o[34]||(o[34]=[Qt('<svg viewBox="0 0 16 16" width="14" height="14" data-v-18de83a6><circle cx="5" cy="5" r="2.5" fill="none" stroke="currentColor" stroke-width="1" data-v-18de83a6></circle><path d="M7 7l2 2" stroke="currentColor" stroke-width="1" stroke-linecap="round" data-v-18de83a6></path><circle cx="10" cy="10" r="2.5" fill="none" stroke="currentColor" stroke-width="1" data-v-18de83a6></circle><path d="M12 12l2 2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" data-v-18de83a6></path></svg><span data-v-18de83a6>批量检测</span>',2)])]),e("button",{class:"annotation-btn primary-action-btn",onClick:o[16]||(o[16]=b=>a.$emit("translate-with-bubbles")),title:"使用当前文本框翻译此图片"},[...o[35]||(o[35]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("path",{d:"M2 3h5M4.5 3v7M2 6h5",stroke:"currentColor","stroke-width":"1.2",fill:"none"}),e("path",{d:"M9 13l2-7 2 7M9.5 11h3",stroke:"currentColor","stroke-width":"1.2",fill:"none"})],-1),e("span",null,"翻译",-1)])]),o[41]||(o[41]=e("div",{class:"toolbar-divider"},null,-1)),e("button",{class:Le(["annotation-btn",{active:t.isDrawingMode}]),onClick:o[17]||(o[17]=b=>a.$emit("toggle-drawing-mode")),title:"添加气泡框（或中键拖拽绘制）"},[...o[36]||(o[36]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("rect",{x:"3",y:"3",width:"10",height:"10",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"}),e("path",{d:"M8 5v6M5 8h6",stroke:"currentColor","stroke-width":"1.5"})],-1),e("span",null,"添加",-1)])],2),e("button",{class:"annotation-btn",disabled:!t.hasSelection,onClick:o[18]||(o[18]=b=>a.$emit("delete-selected-bubbles")),title:"删除选中气泡框 (Delete)"},[...o[37]||(o[37]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("rect",{x:"3",y:"3",width:"10",height:"10",rx:"1",fill:"none",stroke:"currentColor","stroke-width":"1.5"}),e("path",{d:"M5 8h6",stroke:"currentColor","stroke-width":"1.5"})],-1),e("span",null,"删除",-1)])],8,Av),e("button",{class:"annotation-btn",disabled:!t.hasSelection,onClick:o[19]||(o[19]=b=>a.$emit("repair-selected-bubble")),title:"修复选中气泡背景 (R)"},[...o[38]||(o[38]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("path",{d:"M2 14l3-3m0 0l6-6 3 3-6 6m-3 0l-1 1 1-1z",fill:"none",stroke:"currentColor","stroke-width":"1.5","stroke-linecap":"round","stroke-linejoin":"round"}),e("path",{d:"M11 5l-1-1 2-2 2 2-2 2-1-1z",fill:"currentColor"})],-1),e("span",null,"修复",-1)])],8,Fv),o[42]||(o[42]=e("div",{class:"toolbar-divider"},null,-1)),e("button",{class:Le(["annotation-btn brush-btn",{active:t.brushMode==="repair"}]),onClick:o[20]||(o[20]=b=>a.$emit("activate-repair-brush")),title:"修复笔刷 (按住R+左键拖拽)"},[...o[39]||(o[39]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("circle",{cx:"8",cy:"8",r:"5",fill:"none",stroke:"currentColor","stroke-width":"1.5"}),e("circle",{cx:"8",cy:"8",r:"2",fill:"currentColor"})],-1),e("span",null,"修复笔刷",-1)])],2),e("button",{class:Le(["annotation-btn brush-btn",{active:t.brushMode==="restore"}]),onClick:o[21]||(o[21]=b=>a.$emit("activate-restore-brush")),title:"还原笔刷 (按住U+左键拖拽)"},[...o[40]||(o[40]=[e("svg",{viewBox:"0 0 16 16",width:"14",height:"14"},[e("circle",{cx:"8",cy:"8",r:"5",fill:"none",stroke:"currentColor","stroke-width":"1.5"}),e("path",{d:"M5 8h6M8 5v6",stroke:"currentColor","stroke-width":"1",transform:"rotate(45 8 8)"})],-1),e("span",null,"还原笔刷",-1)])],2),t.brushMode?(U(),H("span",Lv," 笔刷: "+fe(t.brushSize)+"px ",1)):Te("",!0),o[43]||(o[43]=Qt('<div class="help-tooltip-container" data-v-18de83a6><button class="help-tooltip-btn" title="快捷键操作帮助" data-v-18de83a6><svg viewBox="0 0 16 16" width="14" height="14" data-v-18de83a6><circle cx="8" cy="8" r="6.5" fill="none" stroke="currentColor" stroke-width="1.2" data-v-18de83a6></circle><text x="8" y="11" text-anchor="middle" font-size="9" font-weight="bold" fill="currentColor" data-v-18de83a6>?</text></svg><span class="help-btn-text" data-v-18de83a6>快捷键</span></button><div class="help-tooltip-popup" data-v-18de83a6><div class="help-section" data-v-18de83a6><div class="help-title" data-v-18de83a6>🖱️ 鼠标操作</div><div class="help-item" data-v-18de83a6><span class="help-key" data-v-18de83a6>左键点击气泡</span><span class="help-desc" data-v-18de83a6>选择气泡</span></div><div class="help-item" data-v-18de83a6><span class="help-key" data-v-18de83a6>Shift+左键点击</span><span class="help-desc" data-v-18de83a6>多选气泡</span></div><div class="help-item" data-v-18de83a6><span class="help-key" data-v-18de83a6>左键拖拽四角/边</span><span class="help-desc" data-v-18de83a6>调整大小</span></div><div class="help-item" data-v-18de83a6><span class="help-key" data-v-18de83a6>左键拖拽框内部</span><span class="help-desc" data-v-18de83a6>移动气泡框</span></div><div class="help-item" data-v-18de83a6><span class="help-key" data-v-18de83a6>中键拖拽</span><span class="help-desc" data-v-18de83a6>绘制新气泡框</span></div></div><div class="help-section" data-v-18de83a6><div class="help-title" data-v-18de83a6>⌨️ 快捷键</div><div class="help-item" data-v-18de83a6><span class="help-key" data-v-18de83a6>A / D</span><span class="help-desc" data-v-18de83a6>切换上/下一张图片</span></div><div class="help-item" data-v-18de83a6><span class="help-key" data-v-18de83a6>Ctrl+Enter</span><span class="help-desc" data-v-18de83a6>应用并跳转下一张</span></div><div class="help-item" data-v-18de83a6><span class="help-key" data-v-18de83a6>Delete / Backspace</span><span class="help-desc" data-v-18de83a6>删除选中气泡</span></div><div class="help-item" data-v-18de83a6><span class="help-key" data-v-18de83a6>按住R+左键拖拽</span><span class="help-desc" data-v-18de83a6>修复笔刷</span></div><div class="help-item" data-v-18de83a6><span class="help-key" data-v-18de83a6>按住U+左键拖拽</span><span class="help-desc" data-v-18de83a6>还原笔刷</span></div><div class="help-item" data-v-18de83a6><span class="help-key" data-v-18de83a6>笔刷模式下滚轮</span><span class="help-desc" data-v-18de83a6>调整笔刷大小</span></div></div></div></div>',1))]),t.brushMode?(U(),H("div",{key:0,class:"brush-cursor",style:st(n.value)},null,4)):Te("",!0),t.brushMode?(U(),H("div",Uv,fe(t.brushMode==="repair"?"修复笔刷 (R)":"还原笔刷 (U)")+" - 滚轮调整大小 ",1)):Te("",!0),t.isProcessing?(U(),H("div",{key:2,class:Le(["edit-progress-container",{completed:s.value}])},[e("div",Ov,[e("span",zv,fe(t.progressText),1),e("span",Vv,fe(t.progressCurrent)+"/"+fe(t.progressTotal),1)]),e("div",Nv,[e("div",{class:Le(["edit-progress-fill",{animating:!s.value}]),style:st({width:l.value+"%"})},null,6)])],2)):Te("",!0),o[44]||(o[44]=e("div",{class:"toolbar-spacer"},null,-1)),e("div",Wv,[e("button",{class:"primary-btn",onClick:o[22]||(o[22]=b=>a.$emit("apply-and-next")),title:"应用更改并跳转下一张 (Ctrl+Enter)"}," 应用并下一张 ")])])]))}}),qv=Xe(Kv,[["__scopeId","data-v-18de83a6"]]),Hv={key:0,class:"edit-thumbnails-panel"},Yv={class:"thumbnails-scroll"},Jv=["onClick"],Xv=["src","alt"],jv={class:"thumb-index"},Gv=je({__name:"EditThumbnailPanel",props:{visible:{type:Boolean},images:{},currentImageIndex:{}},emits:["switch-to-image"],setup(t){return(i,l)=>t.visible?(U(),H("div",Hv,[e("div",Yv,[(U(!0),H(Ge,null,tt(t.images,(s,n)=>(U(),H("div",{key:s.id,class:Le(["edit-thumbnail-item",{active:n===t.currentImageIndex}]),onClick:a=>i.$emit("switch-to-image",n)},[e("img",{src:s.translatedDataURL||s.originalDataURL,alt:`图片 ${n+1}`},null,8,Xv),e("span",jv,fe(n+1),1)],10,Jv))),128))])])):Te("",!0)}}),Zv=Xe(Gv,[["__scopeId","data-v-c093b3ea"]]),Qv={class:"edit-main-layout"},eb={class:"image-comparison-container"},tb={class:"panel-header"},nb=["src"],ob={class:"panel-header"},ab=["src"],sb=je({__name:"EditWorkspace",props:{isEditModeActive:{type:Boolean}},emits:["exit"],setup(t,{emit:i}){const l=t,s=i,n=at(),a=gt(),{translateWithCurrentBubbles:o}=gn(),{reRenderFullImage:b}=ag({onRenderStart:()=>console.log("开始重新渲染..."),onRenderSuccess:W=>console.log("渲染成功:",W.substring(0,50)+"..."),onRenderError:W=>console.error("渲染失败:",W)}),{isDrawingMode:m,isDrawingBox:T,currentDrawingRect:x,isMiddleButtonDown:L,handleBubbleSelect:ne,handleBubbleMultiSelect:ie,handleClearMultiSelect:Q,handleBubbleDragStart:v,handleBubbleDragging:Z,handleBubbleDragEnd:Y,handleBubbleResizeStart:p,handleBubbleResizing:u,handleBubbleResizeEnd:C,handleBubbleRotateStart:D,handleBubbleRotating:k,handleBubbleRotateEnd:J,toggleDrawingMode:te,handleDrawBubble:de,getDrawingRectStyle:F,handleBubbleUpdate:g,deleteSelectedBubbles:_,repairSelectedBubble:B,handleOcrRecognize:q}=og({onReRender:()=>b(),onDelayedPreview:()=>b()}),N=h(0),M=h(0),{brushMode:f,brushSize:S,mouseX:oe,mouseY:R,isBrushKeyDown:E,toggleBrushMode:$,exitBrushMode:c,startBrushPainting:O,continueBrushPainting:ce,finishBrushPainting:X,adjustBrushSize:G}=tg({onBrushComplete:()=>b(),getCurrentRepairSettings:()=>({inpaintMethod:$e.value,fillColor:V.value})}),{images:A,currentImageIndex:r,currentImage:y,imageCount:w,canGoPrevious:P,canGoNext:se}=yt(n),{bubbles:ge,selectedIndex:re,selectedIndices:le,selectedBubble:I,bubbleCount:d,hasBubbles:z,hasSelection:K}=yt(a),j=ee(()=>xe.value?.querySelector("img")?.naturalWidth||2e3),be=ee(()=>xe.value?.querySelector("img")?.naturalHeight||2e3),he=h(null),ke=h(null),xe=h(null),De=h(null),_e=h(null),Se=h(null),Ce=h("dual"),ye=h("horizontal"),Ue=h(!1),we=h(!0),Be=h(!1),Pe=h(!1),$e=h("solid"),V=h("#FFFFFF"),me=h(!1),Ae=h("处理中..."),qe=h(0),lt=h(0),Ze=Nn(),Je=Nn(),St=ee(()=>Je.scale.value),Pt=ee(()=>Je.translateX.value),eo=ee(()=>Je.translateY.value),to=ee(()=>Ze.scale.value),ft=h(null),no=ee(()=>({transform:`translate(${Ze.translateX.value}px, ${Ze.translateY.value}px) scale(${Ze.scale.value})`})),oo=ee(()=>({transform:`translate(${Je.translateX.value}px, ${Je.translateY.value}px) scale(${Je.scale.value})`}));function vn(){Je.zoomIn(),we.value&&Ze.setTransform(Je.getTransform())}function bn(){Je.zoomOut(),we.value&&Ze.setTransform(Je.getTransform())}function pn(){Je.resetZoom(),we.value&&Ze.setTransform(Je.getTransform())}const At=h(!1),ao=h(0),Ft=h(!1),Ct=h({x:0,y:0,size:0});function Lt(){f.value&&c(),zt()}function Ut(){a.bubbles.length>0&&a.selectBubble(0)}function fn(){P.value&&(Lt(),n.goToPrevious())}function Ot(){se.value&&(Lt(),n.goToNext())}function so(W){W!==r.value&&W>=0&&W<w.value&&(Lt(),n.setCurrentImageIndex(W))}function zt(){if(!y.value)return;const W=Array.isArray(y.value.bubbleStates);ge.value.length>0?(n.updateCurrentBubbleStates([...ge.value]),console.log("已保存气泡状态到当前图片")):W&&(n.updateCurrentBubbleStates([]),console.log("已保存空气泡状态到当前图片（用户清空）"))}function _t(){y.value?.bubbleStates?(a.setBubbles([...y.value.bubbleStates],!0),console.log(`已加载 ${y.value.bubbleStates.length} 个气泡状态`)):a.clearBubblesLocal(),Ut()}function lo(){a.selectPrevious()}function io(){a.selectNext()}function ro(){Ue.value=!Ue.value}function uo(){ye.value=ye.value==="horizontal"?"vertical":"horizontal";try{localStorage.setItem(Fn,ye.value)}catch(W){console.warn("保存布局模式失败:",W)}setTimeout(()=>{wt()},300)}function co(){const W=["dual","original","translated"],ue=W.indexOf(Ce.value),pe=W[(ue+1)%W.length];pe&&(Ce.value=pe)}function go(){we.value=!we.value,console.log("双图同步:",we.value?"开启":"关闭"),we.value&&Ze.setTransform(Je.getTransform())}function wt(){const W=De.value||ke.value,ue=_e.value||xe.value;if(!W||!ue)return;const pe=ue.querySelector("img");if(!pe||!pe.naturalWidth)return;const He=W.getBoundingClientRect(),ze=He.width/pe.naturalWidth,Ee=He.height/pe.naturalHeight,Ve=Math.min(ze,Ee)*.95,Oe=(He.width-pe.naturalWidth*Ve)/2,pt=(He.height-pe.naturalHeight*Ve)/2,mt={scale:Ve,translateX:Oe,translateY:pt};Je.setTransform(mt),Ze.setTransform(mt)}function mn(W,ue){if(f.value){const Oe=W.deltaY>0?-5:5;G(Oe);return}const pe=W.currentTarget.getBoundingClientRect(),He=W.clientX-pe.left,ze=W.clientY-pe.top,Ee=W.deltaY>0?.9:1.1,Ve=ue==="original"?Ze:Je;Ve.zoomAt(He,ze,Ee),we.value&&(ue==="original"?Je:Ze).setTransform(Ve.getTransform())}function hn(W,ue){if(f.value){const pe=ue==="original"?ke.value:De.value;pe&&O(W,pe);return}if(W.button===1){L.value=!0,kn(W,ue),W.preventDefault();return}if(m.value&&W.button===0){kn(W,ue),W.preventDefault();return}if(W.button===0){if(W.target.closest(".bubble-highlight-box"))return;W.shiftKey||Q(),ft.value=ue,(ue==="original"?Ze:Je).startDrag(W.clientX,W.clientY),document.addEventListener("mousemove",yn),document.addEventListener("mouseup",xn),W.preventDefault()}}function yn(W){if(!ft.value)return;const ue=ft.value==="original"?Ze:Je;ue.drag(W.clientX,W.clientY),we.value&&(ft.value==="original"?Je:Ze).setTransform(ue.getTransform())}function xn(){ft.value&&(ft.value==="original"?Ze:Je).endDrag(),ft.value=null,document.removeEventListener("mousemove",yn),document.removeEventListener("mouseup",xn)}let Vt="translated";function kn(W,ue="translated"){Vt=ue;const pe=ue==="original"?xe.value:_e.value,He=ue==="original"?Ze:Je;if(!pe)return;const ze=pe.getBoundingClientRect(),Ee=(W.clientX-ze.left)/He.scale.value,Ve=(W.clientY-ze.top)/He.scale.value;N.value=Ee,M.value=Ve,T.value=!0,x.value=[Ee,Ve,Ee,Ve],document.addEventListener("mousemove",Nt),document.addEventListener("mouseup",Wt)}function Nt(W){if(!T.value)return;const ue=Vt==="original"?xe.value:_e.value,pe=Vt==="original"?Ze:Je;if(!ue)return;const He=ue.getBoundingClientRect(),ze=(W.clientX-He.left)/pe.scale.value,Ee=(W.clientY-He.top)/pe.scale.value;x.value=[Math.min(N.value,ze),Math.min(M.value,Ee),Math.max(N.value,ze),Math.max(M.value,Ee)]}function Wt(W){document.removeEventListener("mousemove",Nt),document.removeEventListener("mouseup",Wt);const ue=L.value;if(!T.value||!x.value){T.value=!1,x.value=null,L.value=!1;return}const[pe,He,ze,Ee]=x.value,Ve=ze-pe,Oe=Ee-He;Ve>10&&Oe>10&&(a.addBubble(x.value),a.selectBubble(a.bubbleCount-1),console.log("已添加新气泡:",x.value)),T.value=!1,x.value=null,L.value=!1,!ue&&m.value&&(m.value=!1)}function Sn(W){console.log(`${W} 图片加载完成`),St.value===1&&Pt.value===0&&eo.value===0&&dt(()=>{wt()})}function vo(){b()}function bo(W){W.inpaintMethod!==void 0&&($e.value=W.inpaintMethod),W.fillColor!==void 0&&(V.value=W.fillColor),re.value>=0&&g(W)}function po(W){Re("文本已应用","success"),b()}function fo(W){const ue=a.initialStates[W];if(!ue){console.warn(`无法重置气泡 #${W+1}：找不到初始状态`),Re("无法重置：找不到初始状态","warning");return}const pe=JSON.parse(JSON.stringify(ue));a.updateBubble(W,pe),console.log(`气泡 #${W+1} 已重置到初始状态`),Re("气泡已重置","success"),b()}async function mo(W){const ue=ge.value[W];if(!ue?.originalText){console.warn("无法重新翻译：缺少气泡或原文");return}try{console.log(`开始重新翻译气泡 #${W+1}`);const{translateSingleText:pe}=await it(async()=>{const{translateSingleText:Ve}=await Promise.resolve().then(()=>ea);return{translateSingleText:Ve}},void 0),{useSettingsStore:He}=await it(async()=>{const{useSettingsStore:Ve}=await import("./index.Dz1DNgba.js").then(Oe=>Oe.q);return{useSettingsStore:Ve}},__vite__mapDeps([0,1,2])),ze=He().settings,Ee=await pe({original_text:ue.originalText,model_provider:ze.translation.provider,api_key:ze.translation.apiKey,model_name:ze.translation.modelName,custom_base_url:ze.translation.customBaseUrl,target_language:ze.targetLanguage,prompt_content:ze.translatePrompt});Ee.success&&Ee.data?.translated_text?(a.updateBubble(W,{translatedText:Ee.data.translated_text}),console.log(`翻译成功: "${Ee.data.translated_text}"`),b()):console.error("翻译失败:",Ee.error||"未知错误")}catch(pe){console.error("翻译出错:",pe)}}function Cn(W,ue){for(W.bubbleTexts||(W.bubbleTexts=[]),W.originalTexts||(W.originalTexts=[]);W.bubbleTexts.length<ue;)W.bubbleTexts.push("");for(;W.originalTexts.length<ue;)W.originalTexts.push("")}function _n(W,ue,pe){const He=W.auto_directions||[];return W.bubble_coords.map((ze,Ee)=>{const Ve=ze[0]??0,Oe=ze[1]??0,pt=ze[2]??0,mt=ze[3]??0;let vt;return He[Ee]?vt=He[Ee]==="v"?"vertical":"horizontal":vt=mt-Oe>pt-Ve?"vertical":"horizontal",{coords:ze,originalText:ue.originalTexts?.[Ee]||"",translatedText:ue.bubbleTexts?.[Ee]||"",textboxText:"",fontSize:pe.fontSize,fontFamily:pe.fontFamily,textDirection:vt,autoTextDirection:vt,textColor:pe.textColor,fillColor:pe.fillColor,strokeEnabled:pe.strokeEnabled,strokeColor:pe.strokeColor,strokeWidth:pe.strokeWidth,rotationAngle:W.bubble_angles?.[Ee]||0,inpaintMethod:pe.inpaintMethod,position:{x:0,y:0},polygon:[]}})}async function ho(){const W=y.value;if(!W?.originalDataURL){Re("没有有效的图片用于检测","warning");return}try{Re("正在自动检测文本框...","info");const pe=W.originalDataURL.match(/^data:image\/[^;]+;base64,(.+)$/)?.[1]||"";if(!pe){Re("无法解析图片数据","error");return}const He=Qe(),{textDetector:ze,boxExpand:Ee,textStyle:Ve}=He.settings,Oe=await tn(pe,ze,{box_expand_ratio:Ee.ratio,box_expand_top:Ee.top,box_expand_bottom:Ee.bottom,box_expand_left:Ee.left,box_expand_right:Ee.right});if(Oe.success&&Oe.bubble_coords){n.updateCurrentImage({bubbleCoords:Oe.bubble_coords,bubbleAngles:Oe.bubble_angles||[]}),Cn(W,Oe.bubble_coords.length);const pt={bubble_coords:Oe.bubble_coords.map(vt=>[...vt]),bubble_angles:Oe.bubble_angles,auto_directions:Oe.auto_directions},mt=_n(pt,W,Ve);a.setBubbles(mt),Ut(),Re(`自动检测到 ${Oe.bubble_coords.length} 个文本框`,"success")}else Re(Oe.error||"检测失败","error")}catch(ue){console.error("自动检测失败:",ue),Re("自动检测失败","error")}}async function yo(){if(A.value.length<=1){Re("至少需要两张图片才能执行批量检测","warning");return}if(!confirm("此操作将对所有图片进行文本框检测，可能会覆盖已有的检测结果。确定继续吗？"))return;const W=Qe(),{textDetector:ue,boxExpand:pe,textStyle:He}=W.settings,ze=r.value,Ee=A.value.length;me.value=!0,Ae.value="批量检测中",lt.value=Ee,qe.value=0;try{let Ve=0;for(let Oe=0;Oe<Ee;Oe++){const pt=A.value[Oe];if(!pt?.originalDataURL)continue;qe.value=Oe+1;const vt=pt.originalDataURL.match(/^data:image\/[^;]+;base64,(.+)$/)?.[1]||"";if(!vt)continue;const bt=await tn(vt,ue,{box_expand_ratio:pe.ratio,box_expand_top:pe.top,box_expand_bottom:pe.bottom,box_expand_left:pe.left,box_expand_right:pe.right});if(bt.success&&bt.bubble_coords){const xt=A.value[Oe];if(xt){xt.bubbleCoords=bt.bubble_coords,xt.bubbleAngles=bt.bubble_angles||[],Cn(xt,bt.bubble_coords.length);const wo={bubble_coords:bt.bubble_coords.map($o=>[...$o]),bubble_angles:bt.bubble_angles,auto_directions:bt.auto_directions};xt.bubbleStates=_n(wo,xt,He),Ve+=bt.bubble_coords.length,Oe===r.value&&_t()}}}Ae.value="检测完成",qe.value=Ee,ze!==r.value&&n.setCurrentImageIndex(ze),_t(),Re(`批量检测完成！共处理 ${Ee} 张图片，检测到 ${Ve} 个文本框`,"success"),setTimeout(()=>{me.value=!1},2e3)}catch(Ve){console.error("批量检测失败:",Ve),Re("批量检测失败","error"),me.value=!1}}async function xo(){if(!y.value?.originalDataURL){Re("没有有效的图片用于翻译","warning");return}if(ge.value.length===0){Re("没有文本框可用于翻译，请先检测或添加文本框","warning");return}Re("正在使用当前文本框翻译...","info");try{await o()&&(Re("翻译成功！","success"),Ut())}catch(ue){console.error("翻译失败:",ue),Re(`翻译失败: ${ue instanceof Error?ue.message:"未知错误"}`,"error")}}function ko(){$("repair")}function So(){$("restore")}function wn(W){ce(W)}function $n(){X()}function Co(W){At.value=!0,ao.value=ye.value==="horizontal"?W.clientX:W.clientY,document.body.style.cursor=ye.value==="horizontal"?"col-resize":"row-resize",document.body.style.userSelect="none",document.addEventListener("mousemove",Kt),document.addEventListener("mouseup",qt),W.preventDefault()}function Kt(W){if(!At.value)return;const ue=ke.value?.parentElement?.parentElement;if(!ue)return;const pe=ue.getBoundingClientRect();if(ye.value==="horizontal"){const He=W.clientX-pe.left,ze=pe.width,Ee=Math.max(20,Math.min(80,He/ze*100)),Ve=ue.querySelector(".original-panel"),Oe=ue.querySelector(".translated-panel");Ve&&Oe&&(Ve.style.flex=`0 0 ${Ee}%`,Oe.style.flex=`0 0 ${100-Ee}%`)}else{const He=W.clientY-pe.top,ze=pe.height,Ee=Math.max(20,Math.min(80,He/ze*100)),Ve=ue.querySelector(".original-panel"),Oe=ue.querySelector(".translated-panel");Ve&&Oe&&(Ve.style.flex=`0 0 ${Ee}%`,Oe.style.flex=`0 0 ${100-Ee}%`)}}function qt(){At.value=!1,document.body.style.cursor="",document.body.style.userSelect="",document.removeEventListener("mousemove",Kt),document.removeEventListener("mouseup",qt)}function _o(W){Ft.value=!0;const ue=Se.value;ue&&(Ct.value={x:W.clientX,y:W.clientY,size:ye.value==="horizontal"?ue.offsetWidth:ue.offsetHeight},document.body.style.cursor=ye.value==="horizontal"?"ew-resize":"ns-resize",document.body.style.userSelect="none",document.addEventListener("mousemove",Ht),document.addEventListener("mouseup",Yt),W.preventDefault())}function Ht(W){if(!(!Ft.value||!Se.value))if(ye.value==="horizontal"){const ue=Ct.value.x-W.clientX;let pe=Ct.value.size+ue;pe=Math.max(300,Math.min(window.innerWidth*.6,pe)),Se.value.style.flex=`0 0 ${pe}px`,Se.value.style.minWidth=`${pe}px`}else{const ue=Ct.value.y-W.clientY;let pe=Ct.value.size+ue;pe=Math.max(200,Math.min(window.innerHeight*.5,pe)),Se.value.style.flex=`0 0 ${pe}px`,Se.value.style.height=`${pe}px`}}function Yt(){Ft.value=!1,document.body.style.cursor="",document.body.style.userSelect="",document.removeEventListener("mousemove",Ht),document.removeEventListener("mouseup",Yt)}function Tn(W){const ue=W.target,pe=W.key.toLowerCase();if(pe==="r"||pe==="u"||pe==="a"||pe==="d"){if(ue.tagName==="TEXTAREA")return;(ue.tagName==="INPUT"||ue.tagName==="SELECT"||ue.tagName==="BUTTON")&&ue.blur()}else if(ue.tagName==="INPUT"||ue.tagName==="TEXTAREA"||ue.tagName==="SELECT")return;switch(W.key){case"Escape":Rn();break;case"Delete":case"Backspace":!f.value&&K.value&&(_(),W.preventDefault());break;case"a":case"A":f.value||(fn(),W.preventDefault());break;case"d":case"D":f.value||(Ot(),W.preventDefault());break;case"Enter":W.ctrlKey&&!f.value&&(Dn(),W.preventDefault());break;case"r":case"R":E.value||($("repair"),W.preventDefault());break;case"u":case"U":E.value||($("restore"),W.preventDefault());break;case"+":case"=":vn(),W.preventDefault();break;case"-":bn(),W.preventDefault();break;case"0":pn(),W.preventDefault();break}}function In(W){(W.key==="r"||W.key==="R"||W.key==="u"||W.key==="U")&&(c(),W.preventDefault())}async function Dn(){zt(),await b(),se.value?Ot():Re("已是最后一张图片","info")}function Rn(){zt(),s("exit")}return ut(()=>{try{const W=localStorage.getItem(Fn);(W==="horizontal"||W==="vertical")&&(ye.value=W)}catch(W){console.warn("加载布局模式失败:",W)}document.addEventListener("keydown",Tn),document.addEventListener("keyup",In),document.addEventListener("mousemove",wn),document.addEventListener("mouseup",$n),l.isEditModeActive&&(_t(),dt(()=>{he.value?.focus()}))}),It(()=>{document.removeEventListener("keydown",Tn),document.removeEventListener("keyup",In),document.removeEventListener("mousemove",wn),document.removeEventListener("mouseup",$n),document.removeEventListener("mousemove",Nt),document.removeEventListener("mouseup",Wt),document.removeEventListener("mousemove",Kt),document.removeEventListener("mouseup",qt),document.removeEventListener("mousemove",Ht),document.removeEventListener("mouseup",Yt)}),Ye(()=>l.isEditModeActive,W=>{W&&(_t(),dt(()=>{he.value?.focus()}))}),Ye(r,()=>{l.isEditModeActive&&_t()}),Ye(I,W=>{W&&($e.value=W.inpaintMethod||"solid",V.value=W.fillColor||"#FFFFFF")},{immediate:!0}),(W,ue)=>t.isEditModeActive?(U(),H("div",{key:0,class:Le(["edit-workspace",[`layout-${ye.value}`,{"drawing-mode":ve(m)}]]),tabindex:"0",ref_key:"workspaceRef",ref:he},[Ie(qv,{"current-image-index":ve(r),"image-count":ve(w),"can-go-previous":ve(P),"can-go-next":ve(se),"show-thumbnails":Ue.value,"has-bubbles":ve(z),"selected-bubble-index":ve(re),"bubble-count":ve(d),"layout-mode":ye.value,"sync-enabled":we.value,scale:St.value,"is-drawing-mode":ve(m),"has-selection":ve(K),"brush-mode":ve(f),"brush-size":ve(S),"mouse-x":ve(oe),"mouse-y":ve(R),"is-processing":me.value,"progress-text":Ae.value,"progress-current":qe.value,"progress-total":lt.value,onGoPreviousImage:fn,onGoNextImage:Ot,onToggleThumbnails:ro,onSelectPreviousBubble:lo,onSelectNextBubble:io,onToggleLayout:uo,onToggleViewMode:co,onToggleSync:go,onFitToScreen:wt,onZoomIn:vn,onZoomOut:bn,onResetZoom:pn,onExitEditMode:Rn,onAutoDetectBubbles:ho,onDetectAllImages:yo,onTranslateWithBubbles:xo,onToggleDrawingMode:ve(te),onDeleteSelectedBubbles:ve(_),onRepairSelectedBubble:ve(B),onActivateRepairBrush:ko,onActivateRestoreBrush:So,onApplyAndNext:Dn},null,8,["current-image-index","image-count","can-go-previous","can-go-next","show-thumbnails","has-bubbles","selected-bubble-index","bubble-count","layout-mode","sync-enabled","scale","is-drawing-mode","has-selection","brush-mode","brush-size","mouse-x","mouse-y","is-processing","progress-text","progress-current","progress-total","onToggleDrawingMode","onDeleteSelectedBubbles","onRepairSelectedBubble"]),Ie(Zv,{visible:Ue.value,images:ve(A),"current-image-index":ve(r),onSwitchToImage:so},null,8,["visible","images","current-image-index"]),e("div",Qv,[e("div",eb,[ae(e("div",{class:Le(["image-panel original-panel",{collapsed:Ce.value==="translated"||Be.value}])},[e("div",tb,[ue[8]||(ue[8]=e("span",{class:"panel-title"},"📖 原图 (日文)",-1)),e("button",{class:"panel-toggle",onClick:ue[0]||(ue[0]=pe=>Be.value=!Be.value),title:"折叠/展开"},fe(Be.value?"+":"−"),1)]),e("div",{ref_key:"originalViewportRef",ref:ke,class:"image-viewport",onWheel:ue[2]||(ue[2]=nt(pe=>mn(pe,"original"),["prevent"])),onMousedown:ue[3]||(ue[3]=pe=>hn(pe,"original")),onDblclick:wt},[e("div",{ref_key:"originalWrapperRef",ref:xe,class:"image-canvas-wrapper",style:st(no.value)},[ve(y)?.originalDataURL?(U(),H("img",{key:0,src:ve(y).originalDataURL,alt:"原图",onLoad:ue[1]||(ue[1]=pe=>Sn("original"))},null,40,nb)):Te("",!0),ve(y)?.originalDataURL?(U(),rt(Wn,{key:1,bubbles:ve(ge),"selected-index":ve(re),"selected-indices":ve(le),scale:to.value,"is-drawing-mode":ve(m),"is-brush-mode":!!ve(f),"image-width":j.value,"image-height":be.value,onSelect:ve(ne),onMultiSelect:ve(ie),onDragStart:ve(v),onDragging:ve(Z),onDragEnd:ve(Y),onResizeStart:ve(p),onResizing:ve(u),onResizeEnd:ve(C),onRotateStart:ve(D),onRotating:ve(k),onRotateEnd:ve(J),onDrawBubble:ve(de)},null,8,["bubbles","selected-index","selected-indices","scale","is-drawing-mode","is-brush-mode","image-width","image-height","onSelect","onMultiSelect","onDragStart","onDragging","onDragEnd","onResizeStart","onResizing","onResizeEnd","onRotateStart","onRotating","onRotateEnd","onDrawBubble"])):Te("",!0),ve(x)?(U(),H("div",{key:2,class:"drawing-rect-edit",style:st(ve(F)())},null,4)):Te("",!0)],4)],544)],2),[[Ke,Ce.value!=="translated"]]),Ce.value==="dual"?(U(),H("div",{key:0,class:Le(["panel-divider",{"vertical-divider":ye.value==="vertical"}]),onMousedown:Co},null,34)):Te("",!0),ae(e("div",{class:Le(["image-panel translated-panel",{collapsed:Ce.value==="original"||Pe.value}])},[e("div",ob,[ue[9]||(ue[9]=e("span",{class:"panel-title"},"📝 翻译图 (中文)",-1)),e("button",{class:"panel-toggle",onClick:ue[4]||(ue[4]=pe=>Pe.value=!Pe.value),title:"折叠/展开"},fe(Pe.value?"+":"−"),1)]),e("div",{ref_key:"translatedViewportRef",ref:De,class:"image-viewport",onWheel:ue[6]||(ue[6]=nt(pe=>mn(pe,"translated"),["prevent"])),onMousedown:ue[7]||(ue[7]=pe=>hn(pe,"translated")),onDblclick:wt},[e("div",{ref_key:"translatedWrapperRef",ref:_e,class:"image-canvas-wrapper",style:st(oo.value)},[ve(y)?.translatedDataURL||ve(y)?.originalDataURL?(U(),H("img",{key:0,src:ve(y)?.translatedDataURL||ve(y)?.originalDataURL,alt:"翻译图",onLoad:ue[5]||(ue[5]=pe=>Sn("translated"))},null,40,ab)):Te("",!0),ve(y)?.translatedDataURL||ve(y)?.originalDataURL?(U(),rt(Wn,{key:1,bubbles:ve(ge),"selected-index":ve(re),"selected-indices":ve(le),scale:St.value,"is-drawing-mode":ve(m),"is-brush-mode":!!ve(f),"image-width":j.value,"image-height":be.value,onSelect:ve(ne),onMultiSelect:ve(ie),onDragStart:ve(v),onDragging:ve(Z),onDragEnd:ve(Y),onResizeStart:ve(p),onResizing:ve(u),onResizeEnd:ve(C),onRotateStart:ve(D),onRotating:ve(k),onRotateEnd:ve(J),onDrawBubble:ve(de)},null,8,["bubbles","selected-index","selected-indices","scale","is-drawing-mode","is-brush-mode","image-width","image-height","onSelect","onMultiSelect","onDragStart","onDragging","onDragEnd","onResizeStart","onResizing","onResizeEnd","onRotateStart","onRotating","onRotateEnd","onDrawBubble"])):Te("",!0),ve(x)?(U(),H("div",{key:2,class:"drawing-rect-edit translated-drawing-rect",style:st(ve(F)())},null,4)):Te("",!0)],4)],544)],2),[[Ke,Ce.value!=="original"]])]),e("div",{ref_key:"editPanelRef",ref:Se,class:"edit-panel-container"},[e("div",{class:"panel-resize-handle vertical",onMousedown:_o}," ⋮⋮⋮ ",32),Ie(mv,{bubble:ve(I),"bubble-index":ve(re),onUpdate:bo,onReRender:vo,onOcrRecognize:ve(q),onReTranslate:mo,onApplyBubble:po,onResetCurrent:fo},null,8,["bubble","bubble-index","onOcrRecognize"])],512)])],2)):Te("",!0)}}),lb=Xe(sb,[["__scopeId","data-v-e4c74e44"]]),ib={class:"app-header"},rb={class:"header-content"},ub={class:"logo-container"},cb={class:"header-links"},db={class:"container"},gb={id:"image-display-area"},vb={id:"upload-section",class:"card upload-card"},bb={key:1,class:"bookshelf-mode-hint"},pb=je({__name:"TranslateView",setup(t){const i=qn();Lo();const l=at(),s=Qe(),n=jn(),a=gt(),{validateBeforeTranslation:o,initValidation:b}=Zn(),m=gn();Gn();const T=sl(),x=h(!1),L=h(!1),ne=h(!1),ie=h(!1),Q=h(""),v=h(""),Z=h(null),Y=h(null),p=ee(()=>l.currentImage),u=ee(()=>l.hasImages);ee(()=>l.imageCount),ee(()=>l.currentImageIndex+1),ee(()=>u.value&&!l.isBatchTranslationInProgress),ee(()=>l.canGoPrevious),ee(()=>l.canGoNext);const C=ee(()=>l.isBatchTranslationInProgress);ee(()=>l.isBatchTranslationPaused);const D=ee(()=>C.value&&!m.isHqTranslating.value&&!m.isProofreading.value);ee(()=>{if(!C.value)return 0;const d=l.completedImageCount,z=l.imageCount;return z>0?Math.round(d/z*100):0}),ee(()=>`${l.completedImageCount}/${l.imageCount}`);const k=ee(()=>l.failedImageCount>0),J=ee(()=>!!i.query.book&&!!i.query.chapter),te=ee(()=>i.query.book),de=ee(()=>i.query.chapter),F=ee(()=>T.currentBookTitle.value),g=ee(()=>T.currentChapterTitle.value),_=ee(()=>J.value&&g.value&&F.value?`${g.value} - ${F.value}`:"Saber-Translator");ut(async()=>{i.query.book&&i.query.chapter&&(l.clearImages(),a.clearBubbles()),await T.initializeApp(),b(),window.addEventListener("keydown",re)}),It(()=>{window.removeEventListener("keydown",re)}),Ye(()=>[i.query.book,i.query.chapter],async([d,z])=>{d&&z&&(l.clearImages(),a.clearBubbles(),await B())}),Ye(_,d=>{typeof document<"u"&&(document.title=d)},{immediate:!0});async function B(){if(!(!te.value||!de.value))try{ie.value=!0,Q.value="正在加载章节会话...",await T.initializeBookChapterContext()}catch(d){console.error("加载章节会话失败:",d),Re("加载章节会话失败","error")}finally{ie.value=!1,Q.value=""}}function q(){ie.value=!0,Q.value="正在处理图片...",v.value=""}function N(d){ie.value=!1,Q.value="",console.log(`上传完成，共 ${d} 张图片`),l.hasImages&&(l.sortImagesByFileName(),T.switchImage(0))}function M(d){ie.value=!1,Q.value="",v.value=d}async function f(d){if(!u.value){Re("没有可应用的图片","warning");return}if(!Object.values(d).some(K=>K)){Re("请至少选择一个要应用的设置项","warning");return}try{ie.value=!0;const K=s.textStyle,j={};d.fontSize&&(j.fontSize=K.fontSize),d.fontFamily&&(j.fontFamily=K.fontFamily),d.layoutDirection&&(j.textDirection=K.layoutDirection),d.textColor&&(j.textColor=K.textColor),d.fillColor&&(j.fillColor=K.fillColor),d.strokeEnabled&&(j.strokeEnabled=K.strokeEnabled),d.strokeColor&&(j.strokeColor=K.strokeColor),d.strokeWidth&&(j.strokeWidth=K.strokeWidth);let be=0;const he=l.images;for(let De=0;De<he.length;De++){const _e=he[De];if(_e&&_e.bubbleStates&&_e.bubbleStates.length>0){const Se=_e.bubbleStates.map(Ce=>{const ye={...Ce};return d.fontSize&&j.fontSize!==void 0&&(ye.fontSize=j.fontSize),d.fontFamily&&j.fontFamily!==void 0&&(ye.fontFamily=j.fontFamily),d.layoutDirection&&j.textDirection!==void 0&&(ye.textDirection=j.textDirection),d.textColor&&j.textColor!==void 0&&(ye.textColor=j.textColor),d.fillColor&&j.fillColor!==void 0&&(ye.fillColor=j.fillColor),d.strokeEnabled&&j.strokeEnabled!==void 0&&(ye.strokeEnabled=j.strokeEnabled),d.strokeColor&&j.strokeColor!==void 0&&(ye.strokeColor=j.strokeColor),d.strokeWidth&&j.strokeWidth!==void 0&&(ye.strokeWidth=j.strokeWidth),ye});l.updateImageByIndex(De,{bubbleStates:Se}),be++}}if(a.bubbles.length>0){const De=a.bubbles.map(_e=>{const Se={..._e};return d.fontSize&&j.fontSize!==void 0&&(Se.fontSize=j.fontSize),d.fontFamily&&j.fontFamily!==void 0&&(Se.fontFamily=j.fontFamily),d.layoutDirection&&j.textDirection!==void 0&&(Se.textDirection=j.textDirection),d.textColor&&j.textColor!==void 0&&(Se.textColor=j.textColor),d.fillColor&&j.fillColor!==void 0&&(Se.fillColor=j.fillColor),d.strokeEnabled&&j.strokeEnabled!==void 0&&(Se.strokeEnabled=j.strokeEnabled),d.strokeColor&&j.strokeColor!==void 0&&(Se.strokeColor=j.strokeColor),d.strokeWidth&&j.strokeWidth!==void 0&&(Se.strokeWidth=j.strokeWidth),Se});a.setBubbles(De)}const ke=[];d.fontSize&&ke.push("字号"),d.fontFamily&&ke.push("字体"),d.layoutDirection&&ke.push("排版方向"),d.textColor&&ke.push("文字颜色"),d.fillColor&&ke.push("填充颜色"),d.strokeEnabled&&ke.push("描边开关"),d.strokeColor&&ke.push("描边颜色"),d.strokeWidth&&ke.push("描边宽度");const xe=[];for(let De=0;De<he.length;De++){const _e=he[De];_e&&_e.translatedDataURL&&_e.bubbleStates&&_e.bubbleStates.length>0&&xe.push(De)}if(xe.length>0){Q.value=`正在渲染图片 0/${xe.length}...`;const{apiClient:De}=await it(async()=>{const{apiClient:Ce}=await import("./client.Bht704G-.js");return{apiClient:Ce}},__vite__mapDeps([4,5])),_e=s.settings.textStyle.layoutDirection,Se=_e==="auto";for(let Ce=0;Ce<xe.length;Ce++){const ye=xe[Ce];if(ye===void 0)continue;const Ue=l.images[ye];if(!(!Ue||!Ue.bubbleStates)){Q.value=`正在渲染图片 ${Ce+1}/${xe.length}...`;try{let we="";if(Ue.cleanImageData?we=Ue.cleanImageData.includes("base64,")?Ue.cleanImageData.split("base64,")[1]||"":Ue.cleanImageData:Ue.originalDataURL&&(we=Ue.originalDataURL.includes("base64,")?Ue.originalDataURL.split("base64,")[1]||"":Ue.originalDataURL,console.log(`handleApplyToAll: 图片 ${ye} 使用原图作为背景（兜底）`)),!we){console.log(`handleApplyToAll: 图片 ${ye} 没有可用的背景图，跳过`);continue}const Be=Ue.bubbleStates.map($e=>({translatedText:$e.translatedText||"",coords:$e.coords,fontSize:$e.fontSize||s.settings.textStyle.fontSize,fontFamily:$e.fontFamily||s.settings.textStyle.fontFamily,textDirection:$t($e),textColor:$e.textColor||s.settings.textStyle.textColor,rotationAngle:$e.rotationAngle||0,position:$e.position||{x:0,y:0},strokeEnabled:$e.strokeEnabled??s.settings.textStyle.strokeEnabled,strokeColor:$e.strokeColor||s.settings.textStyle.strokeColor,strokeWidth:$e.strokeWidth??s.settings.textStyle.strokeWidth})),Pe=await De.post("/api/re_render_image",{clean_image:we,bubble_texts:Be.map($e=>$e.translatedText),bubble_coords:Be.map($e=>$e.coords),fontSize:s.settings.textStyle.fontSize,fontFamily:s.settings.textStyle.fontFamily,textDirection:Se?"vertical":_e,textColor:s.settings.textStyle.textColor,bubble_states:Be,use_individual_styles:!0,use_inpainting:!1,use_lama:!1,fillColor:null,is_font_style_change:!0,strokeEnabled:s.settings.textStyle.strokeEnabled,strokeColor:s.settings.textStyle.strokeColor,strokeWidth:s.settings.textStyle.strokeWidth});Pe.rendered_image&&l.updateImageByIndex(ye,{translatedDataURL:`data:image/png;base64,${Pe.rendered_image}`,hasUnsavedChanges:!0})}catch(we){console.error(`重渲染图片 ${ye} 失败:`,we)}}}}Q.value="",Re(`已将 ${ke.join("、")} 应用到 ${be} 张图片`,"success"),console.log(`[TranslateView] 应用设置到全部完成，更新了 ${be} 张图片，重渲染了 ${xe.length} 张`)}catch(K){console.error("应用设置到全部失败:",K),Re("应用设置失败","error")}finally{ie.value=!1}}async function S(){p.value&&o("normal")&&await m.translateCurrentImage()}async function oe(){u.value&&o("normal")&&await m.translateAllImages()}async function R(){u.value&&o("hq")&&await m.executeHqTranslation()}async function E(){u.value&&o("proofread")&&await m.executeProofreading()}async function $(){p.value&&await m.removeTextOnly()}async function c(){u.value&&await m.removeAllTexts()}function O(){if(!p.value)return;const d=p.value.fileName||`图片 ${l.currentImageIndex+1}`;confirm(`确定要删除当前图片 (${d}) 吗？`)&&(l.deleteCurrentImage(),Re("图片已删除","success"))}function ce(){u.value&&confirm("确定要清除所有图片吗？这将丢失所有未保存的进度。")&&(l.clearImages(),Re("所有图片已清除","success"))}async function X(){try{ie.value=!0,Q.value="正在清理临时文件...";const d=await Hn(),z=await rn();if(d.success&&z.success)Re("临时文件清理完成","success");else{const K=[];d.success||K.push("调试文件清理失败"),z.success||K.push("临时文件清理失败"),Re(K.join("，"),"warning")}}catch(d){console.error("清理临时文件失败:",d),Re("清理临时文件失败","error")}finally{ie.value=!1,Q.value=""}}function G(){T.goToPrevious()}function A(){T.goToNext()}function r(){ne.value=!ne.value}async function y(){if(!k.value){Re("没有失败的图片需要重新翻译","info");return}o("normal")&&await m.retryFailedImages()}async function w(){if(!u.value){Re("没有可保存的内容","warning");return}if(!(!te.value||!de.value))try{await n.saveChapterSession(te.value,de.value)?Re("章节进度已保存","success"):Re("保存失败","error")}catch(d){console.error("保存会话失败:",d),Re("保存失败: "+(d instanceof Error?d.message:"未知错误"),"error")}}function P(){x.value=!0}function se(){Re("设置已保存","success")}function ge(){L.value=!0}function re(d){if(!(d.target instanceof HTMLInputElement||d.target instanceof HTMLTextAreaElement)&&!ne.value&&d.altKey)switch(d.key){case"ArrowLeft":d.preventDefault(),G();break;case"ArrowRight":d.preventDefault(),A();break;case"ArrowUp":if(d.preventDefault(),!s.settings.textStyle.autoFontSize){const z=s.settings.textStyle.fontSize;s.updateTextStyle({fontSize:z+1})}break;case"ArrowDown":if(d.preventDefault(),!s.settings.textStyle.autoFontSize){const z=s.settings.textStyle.fontSize;s.updateTextStyle({fontSize:Math.max(10,z-1)})}break}}async function le(d,z){const K=p.value;if(!K||!K.translatedDataURL||!K.bubbleStates||K.bubbleStates.length===0||!["fontSize","fontFamily","layoutDirection","textColor","strokeEnabled","strokeColor","strokeWidth","fillColor"].includes(d))return;console.log(`全局设置变更 (${d}=${z})，准备重渲染...`);const he={fontSize:"fontSize",fontFamily:"fontFamily",layoutDirection:"textDirection",textColor:"textColor",strokeEnabled:"strokeEnabled",strokeColor:"strokeColor",strokeWidth:"strokeWidth",fillColor:"fillColor"}[d];if(he&&K.bubbleStates)if(d==="layoutDirection"&&z==="auto")console.log("排版方向设置为 'auto'，不修改气泡的 textDirection，使用 autoTextDirection 渲染");else{const ke=K.bubbleStates.map(xe=>({...xe,[he]:z}));l.updateCurrentImage({bubbleStates:ke}),a.setBubbles(ke)}try{const xe=l.currentImage?.bubbleStates||K.bubbleStates||[];if(xe.length===0||!xe[0]?.coords){console.log("没有有效的气泡坐标，跳过重渲染");return}const De=s.settings.textStyle.layoutDirection,_e=xe.map(Be=>({translatedText:Be.translatedText||"",coords:Be.coords,fontSize:Be.fontSize||s.settings.textStyle.fontSize,fontFamily:Be.fontFamily||s.settings.textStyle.fontFamily,textDirection:$t(Be),textColor:Be.textColor||s.settings.textStyle.textColor,rotationAngle:Be.rotationAngle||0,position:Be.position||{x:0,y:0},strokeEnabled:Be.strokeEnabled??s.settings.textStyle.strokeEnabled,strokeColor:Be.strokeColor||s.settings.textStyle.strokeColor,strokeWidth:Be.strokeWidth??s.settings.textStyle.strokeWidth})),Se=_e.map(Be=>Be.translatedText),Ce=_e.map(Be=>Be.coords);let ye="";if(K.cleanImageData){const Be=K.cleanImageData;ye=Be.includes("base64,")?Be.split("base64,")[1]||"":Be}else K.originalDataURL&&(ye=K.originalDataURL.includes("base64,")?K.originalDataURL.split("base64,")[1]||"":K.originalDataURL,console.log("handleTextStyleChanged: 使用原图作为背景（兜底）"));if(!ye){console.log("没有可用的背景图，跳过重渲染");return}const{apiClient:Ue}=await it(async()=>{const{apiClient:Be}=await import("./client.Bht704G-.js");return{apiClient:Be}},__vite__mapDeps([4,5])),we=await Ue.post("/api/re_render_image",{clean_image:ye,bubble_texts:Se,bubble_coords:Ce,fontSize:s.settings.textStyle.fontSize,fontFamily:s.settings.textStyle.fontFamily,textDirection:De==="auto"?"vertical":De,textColor:s.settings.textStyle.textColor,bubble_states:_e,use_individual_styles:!0,use_inpainting:!1,use_lama:!1,fillColor:null,is_font_style_change:!0,strokeEnabled:s.settings.textStyle.strokeEnabled,strokeColor:s.settings.textStyle.strokeColor,strokeWidth:s.settings.textStyle.strokeWidth});we.rendered_image?(l.updateCurrentImage({translatedDataURL:`data:image/png;base64,${we.rendered_image}`,hasUnsavedChanges:!0}),console.log("设置变更后重新渲染成功")):we.error&&console.error("重新渲染失败:",we.error)}catch(ke){console.error("设置变更后重新渲染失败:",ke)}}function I(d){T.switchImage(d)}return(d,z)=>{const K=Fo("router-link");return U(),H("div",{class:Le(["translate-page",{"edit-mode-active":ne.value}])},[e("header",ib,[e("div",rb,[e("div",ub,[Ie(K,{to:"/",title:"返回书架"},{default:ht(()=>[...z[3]||(z[3]=[e("img",{src:"/pic/logo.png",alt:"Saber-Translator Logo",class:"app-logo"},null,-1),e("span",{class:"app-name"},"Saber-Translator",-1)])]),_:1})]),e("div",cb,[z[7]||(z[7]=e("a",{href:"/",class:"back-to-shelf",title:"返回书架"},"📚",-1)),J.value?(U(),H("button",{key:0,class:"save-header-btn",title:"保存进度",onClick:w}," 💾 ")):Te("",!0),e("button",{id:"openSettingsBtn",class:"settings-header-btn",title:"打开设置",onClick:P},[...z[4]||(z[4]=[e("span",{class:"icon"},"⚙️",-1),e("span",null,"设置",-1)])]),z[8]||(z[8]=e("a",{href:"http://www.mashirosaber.top",target:"_blank",class:"tutorial-link"},"使用教程",-1)),e("a",{href:"javascript:void(0)",class:"donate-link",onClick:ge},[...z[5]||(z[5]=[e("span",null,"❤️ 请作者喝奶茶",-1)])]),z[9]||(z[9]=e("a",{href:"https://github.com/MashiroSaber03",target:"_blank",class:"github-link"},[e("img",{src:"/pic/github.jpg",alt:"GitHub",class:"github-icon"})],-1)),e("button",{class:"theme-toggle",title:"切换亮暗模式",onClick:z[0]||(z[0]=(...j)=>ve(s).toggleTheme&&ve(s).toggleTheme(...j))},[...z[6]||(z[6]=[e("span",{class:"theme-icon light-icon"},"☀️",-1),e("span",{class:"theme-icon dark-icon"},"🌙",-1)])])])])]),e("div",db,[Ie(Ss,{onTranslateCurrent:S,onTranslateAll:oe,onHqTranslate:R,onProofread:E,onRemoveText:$,onRemoveAllText:c,onRetryFailed:y,onDeleteCurrent:O,onClearAll:ce,onCleanTemp:X,onOpenPlugins:P,onOpenSettings:P,onPrevious:G,onNext:A,onApplyToAll:f,onTextStyleChanged:le}),e("main",gb,[e("section",vb,[Ie(_a,{ref_key:"imageUploadRef",ref:Z,onUploadStart:q,onUploadComplete:N,onUploadError:M},null,512),ve(n).loadingProgress.total>0?(U(),rt(dn,{key:0,visible:!0,percentage:ve(n).loadingProgress.current/ve(n).loadingProgress.total*100,label:ve(n).loadingProgress.message},null,8,["percentage","label"])):Te("",!0),Ie(vl,{progress:ve(m).progress.value,"show-controls":D.value},null,8,["progress","show-controls"]),C.value&&J.value?(U(),H("div",bb,[...z[10]||(z[10]=[e("span",{style:{color:"#888","font-size":"0.85em"}}," （书架模式下退出前请点击顶部保存按钮） ",-1)])])):Te("",!0)]),Ie(Ks,{ref_key:"imageResultRef",ref:Y,"is-edit-mode":ne.value,onToggleEditMode:r,onRetryFailed:y},null,8,["is-edit-mode"])]),u.value&&!ne.value?(U(),rt(Bl,{key:0,onSelect:I})):Te("",!0)]),p.value&&ne.value?(U(),rt(lb,{key:0,"is-edit-mode-active":ne.value,onExit:r},null,8,["is-edit-mode-active"])):Te("",!0),Ie(Xs,{onOpenSettings:P}),Ie(Qd,{modelValue:x.value,"onUpdate:modelValue":z[1]||(z[1]=j=>x.value=j),onSave:se},null,8,["modelValue"]),L.value?(U(),rt(pl,{key:1,onClose:z[2]||(z[2]=j=>L.value=!1)})):Te("",!0),Ie(Sl,{visible:ie.value,message:Q.value,fullscreen:!1},null,8,["visible","message"])],2)}}}),wb=Xe(pb,[["__scopeId","data-v-cb945893"]]);export{wb as default};
