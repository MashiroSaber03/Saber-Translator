<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#6366f1">
    <title>æ¼«ç”»åˆ†æ - Saber-Translator</title>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/variables.css') }}">
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/base.css') }}">
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/manga-insight.css') }}">
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
</head>
<body>
    <!-- é¡µé¢å¤´éƒ¨ -->
    <header class="app-header">
        <div class="header-content">
            <div class="logo-container">
                <a href="/" title="ä¹¦æ¶é¦–é¡µ">
                    <img src="{{ url_for('static', filename='pic/logo.png') }}" alt="Saber-Translator Logo" class="app-logo">
                    <span class="app-name">Saber-Translator</span>
                </a>
            </div>
            <div class="header-links">
                <a href="/" class="nav-link">ğŸ“š ä¹¦æ¶</a>
                <a href="javascript:void(0)" class="nav-link" id="translateNavBtn" onclick="goToTranslate()">ğŸŒ ç¿»è¯‘</a>
                <span class="nav-link active">ğŸ” åˆ†æ</span>
                <button id="settingsBtn" class="btn btn-icon" title="è®¾ç½®">âš™ï¸</button>
                <button id="themeToggle" class="theme-toggle" title="åˆ‡æ¢äº®æš—æ¨¡å¼">
                    <span class="theme-icon light-icon">â˜€ï¸</span>
                    <span class="theme-icon dark-icon">ğŸŒ™</span>
                </button>
            </div>
        </div>
    </header>

    <!-- ä¸»å†…å®¹åŒº -->
    <main class="insight-main">
        <!-- å·¦ä¾§è¾¹æ  -->
        <aside class="insight-sidebar">
            <!-- ä¹¦ç±ä¿¡æ¯ -->
            <div class="sidebar-section book-info-section">
                <div class="book-cover-wrapper">
                    <img id="bookCover" src="" alt="å°é¢" class="book-cover">
                    <div class="book-cover-placeholder" id="coverPlaceholder">
                        <span>ğŸ“–</span>
                    </div>
                </div>
                <h2 class="book-title" id="bookTitle">é€‰æ‹©ä¹¦ç±</h2>
                <div class="book-meta" id="bookMeta">
                    <span class="meta-item"><span class="meta-icon">ğŸ“„</span> <span id="totalPages">0</span> é¡µ</span>
                    <span class="meta-item"><span class="meta-icon">ğŸ“Š</span> <span id="analyzedPages">0</span> å·²åˆ†æ</span>
                </div>
            </div>

            <!-- åˆ†ææ§åˆ¶ï¼ˆç´§å‡‘ç‰ˆï¼‰ -->
            <div class="sidebar-section analysis-control-compact">
                <!-- çŠ¶æ€æ  -->
                <div class="analysis-status-bar">
                    <div class="status-left">
                        <span class="status-dot" id="statusDot"></span>
                        <span class="status-label" id="statusLabel">æœªåˆ†æ</span>
                    </div>
                    <div class="status-right">
                        <span class="status-progress" id="statusProgress"></span>
                    </div>
                </div>
                
                <!-- è¿›åº¦æ¡ï¼ˆåˆ†æä¸­æ—¶æ˜¾ç¤ºï¼‰ -->
                <div class="progress-bar-slim" id="progressContainer" style="display: none;">
                    <div class="progress-fill-slim" id="progressFill"></div>
                </div>
                
                <!-- æ§åˆ¶æŒ‰é’®ç»„ -->
                <div class="analysis-btn-group">
                    <!-- åˆå§‹/å®ŒæˆçŠ¶æ€ -->
                    <div class="btn-group-idle" id="btnGroupIdle">
                        <select id="analysisModeSelect" class="analysis-mode-select" onchange="onAnalysisModeChange()">
                            <option value="full">å…¨ä¹¦</option>
                            <option value="chapter">ç« èŠ‚</option>
                            <option value="page">å•é¡µ</option>
                        </select>
                        <button id="startAnalysisBtn" class="btn-analysis-start" onclick="startAnalysis()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
                            <span>å¼€å§‹åˆ†æ</span>
                        </button>
                    </div>
                    
                    <!-- è¿è¡Œä¸­çŠ¶æ€ -->
                    <div class="btn-group-running" id="btnGroupRunning" style="display: none;">
                        <button id="pauseAnalysisBtn" class="btn-control btn-pause" onclick="pauseAnalysis()" title="æš‚åœ">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                        </button>
                        <button id="cancelAnalysisBtn" class="btn-control btn-cancel" onclick="cancelAnalysis()" title="å–æ¶ˆ">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M6 6h12v12H6z"/></svg>
                        </button>
                    </div>
                    
                    <!-- æš‚åœçŠ¶æ€ -->
                    <div class="btn-group-paused" id="btnGroupPaused" style="display: none;">
                        <button id="resumeAnalysisBtn" class="btn-control btn-resume" onclick="resumeAnalysis()" title="ç»§ç»­">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
                        </button>
                        <button class="btn-control btn-cancel" onclick="cancelAnalysis()" title="å–æ¶ˆ">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M6 6h12v12H6z"/></svg>
                        </button>
                    </div>
                </div>
                
                <!-- ç« èŠ‚é€‰æ‹©ï¼ˆå•ç« èŠ‚æ¨¡å¼æ—¶æ˜¾ç¤ºï¼‰ -->
                <select id="chapterSelect" class="form-select-compact" style="display: none;">
                    <option value="">é€‰æ‹©ç« èŠ‚...</option>
                </select>
                
                <!-- é¡µç è¾“å…¥ï¼ˆå•é¡µæ¨¡å¼æ—¶æ˜¾ç¤ºï¼‰ -->
                <input type="number" id="pageNumInput" class="form-input-compact" placeholder="è¾“å…¥é¡µç " min="1" style="display: none;">
                
                <!-- é€‰é¡¹è¡Œ -->
                <div class="analysis-options-row">
                    <label class="checkbox-compact">
                        <input type="checkbox" id="incrementalMode" checked>
                        <span>å¢é‡æ¨¡å¼</span>
                    </label>
                    <button class="btn-icon-sm" onclick="exportAnalysis()" title="å¯¼å‡ºæŠ¥å‘Š">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                    </button>
                </div>
            </div>

            <!-- ç« èŠ‚ä¸é¡µé¢ï¼ˆæ ‘çŠ¶ç»“æ„ï¼‰ -->
            <div class="sidebar-section pages-tree-section">
                <div class="section-header">
                    <h3 class="section-title">å†…å®¹å¯¼èˆª</h3>
                    <span class="page-count-badge" id="pageCount">0é¡µ</span>
                </div>
                <div class="pages-tree" id="pagesTree">
                    <!-- ç”± JS åŠ¨æ€ç”Ÿæˆ -->
                    <div class="empty-hint">åŠ è½½ä¸­...</div>
                </div>
            </div>
        </aside>

        <!-- ä¸»å†…å®¹åŒº -->
        <div class="insight-content">
            <!-- é€‰æ‹©ä¹¦ç±æç¤º -->
            <div class="select-book-prompt" id="selectBookPrompt">
                <div class="prompt-icon">ğŸ“š</div>
                <h2>é€‰æ‹©è¦åˆ†æçš„ä¹¦ç±</h2>
                <p>ä»ä¸‹æ–¹åˆ—è¡¨ä¸­é€‰æ‹©ä¸€æœ¬ä¹¦ç±å¼€å§‹æ™ºèƒ½åˆ†æ</p>
                <div class="book-selector">
                    <select id="bookSelector" class="book-select" onchange="loadBook(this.value)">
                        <option value="">-- é€‰æ‹©ä¹¦ç± --</option>
                    </select>
                </div>
            </div>

            <!-- æ ‡ç­¾é¡µå¯¼èˆª -->
            <div class="content-tabs" id="contentTabs" style="display: none;">
                <button class="mobile-nav-btn" id="mobileNavBtn" onclick="toggleMobileSidebar()" aria-label="æ‰“å¼€å¯¼èˆª">
                    ğŸ“š
                </button>
                <div class="tabs-wrapper">
                    <button class="tab-btn active" data-tab="overview" onclick="switchTab('overview')">
                        <span class="tab-icon">ğŸ“Š</span> æ¦‚è§ˆ
                    </button>
                    <button class="tab-btn" data-tab="qa" onclick="switchTab('qa')">
                        <span class="tab-icon">ğŸ’¬</span> æ™ºèƒ½é—®ç­”
                    </button>
                    <button class="tab-btn" data-tab="timeline" onclick="switchTab('timeline')">
                        <span class="tab-icon">ğŸ“ˆ</span> æ—¶é—´çº¿
                    </button>
                </div>
                <button class="mobile-nav-btn" id="mobileWorkspaceBtn" onclick="toggleMobileWorkspace()" aria-label="æ‰“å¼€ç¬”è®°">
                    ğŸ“
                </button>
            </div>

            <!-- æ¦‚è§ˆæ ‡ç­¾é¡µ -->
            <div class="tab-content active" id="tab-overview">
                <div class="overview-grid">
                    <!-- æ‘˜è¦å¡ç‰‡ -->
                    <div class="overview-card summary-card">
                        <div class="card-header">
                            <h3 class="card-title">ğŸ“– æ•…äº‹æ¦‚è¦</h3>
                            <button class="btn-icon" onclick="regenerateOverview()" title="é‡æ–°ç”Ÿæˆæ¦‚è¿°">ğŸ”„</button>
                        </div>
                        <div class="card-content" id="storySummary">
                            <div class="placeholder-text">å®Œæˆåˆ†æåå°†æ˜¾ç¤ºæ•…äº‹æ¦‚è¦</div>
                        </div>
                    </div>

                    <!-- ç»Ÿè®¡å¡ç‰‡ -->
                    <div class="overview-card stats-card">
                        <h3 class="card-title">ğŸ“Š åˆ†æç»Ÿè®¡</h3>
                        <div class="stats-grid">
                            <div class="stat-item">
                                <span class="stat-value" id="statPages">0</span>
                                <span class="stat-label">å·²åˆ†æé¡µé¢</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value" id="statChapters">0</span>
                                <span class="stat-label">ç« èŠ‚æ•°</span>
                            </div>
                        </div>
                    </div>

                    <!-- æœ€è¿‘åˆ†æå¡ç‰‡ -->
                    <div class="overview-card recent-card">
                        <h3 class="card-title">ğŸ• æœ€è¿‘åˆ†æ</h3>
                        <div class="recent-pages" id="recentPages">
                            <div class="placeholder-text">æš‚æ— åˆ†æè®°å½•</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ™ºèƒ½é—®ç­”æ ‡ç­¾é¡µ -->
            <div class="tab-content" id="tab-qa">
                <div class="qa-container">
                    <div class="chat-messages" id="chatMessages">
                        <div class="welcome-message">
                            <div class="welcome-icon">ğŸ’¬</div>
                            <h3>æ™ºèƒ½é—®ç­”</h3>
                            <p>é’ˆå¯¹å·²åˆ†æçš„æ¼«ç”»å†…å®¹æé—®ï¼Œè·å–ç²¾å‡†å›ç­”</p>
                        </div>
                    </div>
                    <div class="chat-input-container">
                        <div class="chat-options">
                            <label class="checkbox-label compact" title="å¯ç”¨åï¼Œæ£€ç´¢åˆ°æŸé¡µæ—¶ä¼šè¿”å›è¯¥é¡µæ‰€å±æ‰¹æ¬¡çš„å®Œæ•´å†…å®¹ä½œä¸ºä¸Šä¸‹æ–‡ï¼Œæä¾›æ›´ä¸°å¯Œçš„ä¿¡æ¯">
                                <input type="checkbox" id="useParentChild" checked>
                                <span>çˆ¶å­å—æ¨¡å¼</span>
                            </label>
                            <label class="checkbox-label compact" title="å¯ç”¨åï¼Œä¼šå…ˆå°†å¤æ‚é—®é¢˜åˆ†è§£ä¸ºå¤šä¸ªå­é—®é¢˜ï¼Œåˆ†åˆ«æ£€ç´¢åæ•´åˆç­”æ¡ˆï¼Œé€‚åˆå›ç­”éœ€è¦ç»¼åˆå¤šå¤„ä¿¡æ¯çš„é—®é¢˜">
                                <input type="checkbox" id="useReasoning" checked>
                                <span>æ¨ç†æ£€ç´¢</span>
                            </label>
                            <label class="checkbox-label compact" title="å¯ç”¨åï¼Œå¯¹æ£€ç´¢ç»“æœè¿›è¡ŒäºŒæ¬¡ç²¾æ’ï¼Œæé«˜ç›¸å…³æ€§ï¼ˆéœ€åœ¨è®¾ç½®ä¸­é…ç½®é‡æ’åºæ¨¡å‹ï¼‰">
                                <input type="checkbox" id="useReranker" checked>
                                <span>é‡æ’åº</span>
                            </label>
                            <span class="chat-option-divider">|</span>
                            <label class="input-label compact" title="è¿”å›çš„æœ€å¤§ç»“æœæ•°ï¼ˆ1-20ï¼‰">
                                <span>Top K:</span>
                                <input type="number" id="topK" value="5" min="1" max="20" class="input-small">
                            </label>
                            <label class="input-label compact" title="ç›¸å…³æ€§é˜ˆå€¼ï¼Œä½äºæ­¤å€¼çš„ç»“æœå°†è¢«è¿‡æ»¤ï¼ˆ0-1ï¼Œ0è¡¨ç¤ºä¸è¿‡æ»¤ï¼‰">
                                <span>é˜ˆå€¼:</span>
                                <input type="number" id="threshold" value="0" min="0" max="1" step="0.1" class="input-small">
                            </label>
                            <span class="chat-option-divider">|</span>
                            <button type="button" class="btn btn-sm btn-secondary" onclick="rebuildEmbeddings()" title="åˆ é™¤ç°æœ‰å‘é‡æ•°æ®å¹¶é‡æ–°æ„å»ºï¼Œç”¨äºæ›´æ–°æ£€ç´¢ç´¢å¼•">
                                ğŸ”„ é‡å»ºå‘é‡
                            </button>
                        </div>
                        <div class="chat-input-wrapper">
                            <textarea id="questionInput" placeholder="è¾“å…¥ä½ çš„é—®é¢˜..." rows="1" onkeydown="handleQuestionKeydown(event)"></textarea>
                            <button class="send-btn" onclick="sendQuestion()" id="sendBtn">
                                <span>å‘é€</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ—¶é—´çº¿æ ‡ç­¾é¡µ -->
            <div class="tab-content" id="tab-timeline">
                <div class="timeline-header">
                    <h3>ğŸ“ˆ å‰§æƒ…æ—¶é—´çº¿</h3>
                    <button class="btn btn-secondary btn-sm" onclick="regenerateTimeline()">ğŸ”„ é‡æ–°ç”Ÿæˆ</button>
                </div>
                <div class="timeline-container" id="timelineContainer">
                    <div class="placeholder-text">å®Œæˆåˆ†æåå°†æ˜¾ç¤ºå‰§æƒ…æ—¶é—´çº¿</div>
                </div>
            </div>

        </div>

        <!-- å³ä¾§å·¥ä½œåŒº -->
        <aside class="insight-workspace">
            <!-- é¡µé¢è¯¦æƒ… -->
            <div class="workspace-section page-detail-section">
                <h3 class="section-title">ğŸ“„ é¡µé¢è¯¦æƒ…</h3>
                <div class="page-detail" id="pageDetail">
                    <div class="placeholder-text">ç‚¹å‡»é¡µé¢æŸ¥çœ‹è¯¦æƒ…</div>
                </div>
            </div>

            <!-- ç¬”è®° -->
            <div class="workspace-section notes-section">
                <div class="section-header-with-actions">
                    <h3 class="section-title">ğŸ“ ç¬”è®°</h3>
                    <div class="notes-filter">
                        <select id="notesFilter" class="notes-filter-select" onchange="filterNotes()">
                            <option value="all">å…¨éƒ¨</option>
                            <option value="text">æ–‡æœ¬ç¬”è®°</option>
                            <option value="qa">é—®ç­”ç¬”è®°</option>
                        </select>
                    </div>
                </div>
                <div class="notes-list" id="notesList">
                    <div class="placeholder-text">æš‚æ— ç¬”è®°</div>
                </div>
                <button class="btn btn-secondary btn-block btn-sm" onclick="openNoteModal()">
                    + æ·»åŠ ç¬”è®°
                </button>
            </div>
        </aside>
    </main>

    <!-- è®¾ç½®æ¨¡æ€æ¡† -->
    <div id="settingsModal" class="modal">
        <div class="modal-overlay" onclick="closeSettingsModal()"></div>
        <div class="modal-content modal-lg">
            <div class="modal-header">
                <h2>æ¼«ç”»åˆ†æè®¾ç½®</h2>
                <button class="modal-close" onclick="closeSettingsModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="settings-tabs">
                    <button class="settings-tab active" data-tab="vlm" onclick="switchSettingsTab('vlm')">VLM å¤šæ¨¡æ€æ¨¡å‹</button>
                    <button class="settings-tab" data-tab="llm" onclick="switchSettingsTab('llm')">LLM å¯¹è¯æ¨¡å‹</button>
                    <button class="settings-tab" data-tab="batch" onclick="switchSettingsTab('batch')">æ‰¹é‡åˆ†æ</button>
                    <button class="settings-tab" data-tab="embedding" onclick="switchSettingsTab('embedding')">å‘é‡æ¨¡å‹</button>
                    <button class="settings-tab" data-tab="reranker" onclick="switchSettingsTab('reranker')">é‡æ’åºæ¨¡å‹</button>
                    <button class="settings-tab" data-tab="prompts" onclick="switchSettingsTab('prompts')">ğŸ“ æç¤ºè¯</button>
                </div>

                <!-- VLM è®¾ç½® -->
                <div class="settings-content active" id="settings-vlm">
                    <div class="form-group">
                        <label>æœåŠ¡å•†</label>
                        <select id="vlmProvider" onchange="onVlmProviderChange()">
                            <option value="gemini">Google Gemini</option>
                            <option value="openai">OpenAI</option>
                            <option value="qwen">é˜¿é‡Œé€šä¹‰åƒé—®</option>
                            <option value="siliconflow">SiliconFlow</option>
                            <option value="deepseek">DeepSeek</option>
                            <option value="volcano">ç«å±±å¼•æ“</option>
                            <option value="custom">è‡ªå®šä¹‰</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>API Key</label>
                        <input type="password" id="vlmApiKey" placeholder="è¾“å…¥ API Key">
                    </div>
                    <div class="form-group">
                        <label>æ¨¡å‹</label>
                        <div class="model-input-row">
                            <input type="text" id="vlmModel" placeholder="ä¾‹å¦‚: gemini-2.0-flash">
                            <button type="button" class="btn btn-sm fetch-models-btn" id="vlmFetchModelsBtn" onclick="fetchModelsFor('vlm')">
                                ğŸ” è·å–æ¨¡å‹
                            </button>
                        </div>
                        <div class="model-select-container" id="vlmModelSelectDiv" style="display: none;">
                            <select id="vlmModelSelect" onchange="onModelSelected('vlm')">
                                <option value="">-- é€‰æ‹©æ¨¡å‹ --</option>
                            </select>
                            <span class="model-count" id="vlmModelCount"></span>
                        </div>
                    </div>
                    <div class="form-group" id="vlmBaseUrlGroup" style="display: none;">
                        <label>Base URL</label>
                        <input type="text" id="vlmBaseUrl" placeholder="è‡ªå®šä¹‰ API åœ°å€">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>RPM é™åˆ¶</label>
                            <input type="number" id="vlmRpm" value="10" min="1" max="100">
                        </div>
                        <div class="form-group">
                            <label>æ¸©åº¦</label>
                            <input type="number" id="vlmTemperature" value="0.3" min="0" max="1" step="0.1">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="vlmForceJson">
                            <span>å¼ºåˆ¶ JSON è¾“å‡º</span>
                        </label>
                        <p class="form-hint">å¯¹ OpenAI å…¼å®¹ API å¯ç”¨ response_format: json_objectï¼Œç¡®ä¿è¿”å›æœ‰æ•ˆ JSON</p>
                    </div>
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="vlmUseStream" checked>
                            <span>ä½¿ç”¨æµå¼è¯·æ±‚</span>
                        </label>
                        <p class="form-hint">æµå¼è¯·æ±‚å¯é¿å…é•¿æ—¶é—´ç­‰å¾…å¯¼è‡´çš„è¶…æ—¶é—®é¢˜ï¼Œå»ºè®®å¼€å¯</p>
                    </div>
                    <div class="form-group">
                        <label>å›¾ç‰‡å‹ç¼©ï¼ˆæœ€å¤§è¾¹é•¿ï¼‰</label>
                        <input type="number" id="vlmImageMaxSize" value="0" min="0" max="4096" step="128" placeholder="0 è¡¨ç¤ºä¸å‹ç¼©">
                        <p class="form-hint">å‘é€å‰å°†å›¾ç‰‡ç­‰æ¯”ä¾‹ç¼©æ”¾åˆ°æŒ‡å®šæœ€å¤§è¾¹é•¿ï¼ˆåƒç´ ï¼‰ï¼Œå‡å°‘ Token æ¶ˆè€—ã€‚0 è¡¨ç¤ºä¸å‹ç¼©ï¼Œæ¨èå€¼ï¼š768-1280</p>
                    </div>
                    <button class="btn btn-secondary" onclick="testVlmConnection()">æµ‹è¯•è¿æ¥</button>
                </div>

                <!-- LLM å¯¹è¯æ¨¡å‹è®¾ç½® -->
                <div class="settings-content" id="settings-llm">
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="llmUseSameAsVlm" checked onchange="onLlmUseSameChange()">
                            <span>ä½¿ç”¨ä¸ VLM ç›¸åŒçš„é…ç½®</span>
                        </label>
                        <p class="form-hint">ç”¨äºç”Ÿæˆæ•…äº‹æ¦‚è¦ã€æ™ºèƒ½é—®ç­”ç­‰æ–‡æœ¬ç”Ÿæˆä»»åŠ¡</p>
                    </div>
                    <div id="llmCustomConfig" style="display: none;">
                        <div class="form-group">
                            <label>æœåŠ¡å•†</label>
                            <select id="llmProvider" onchange="onLlmProviderChange()">
                                <option value="gemini">Google Gemini</option>
                                <option value="openai">OpenAI</option>
                                <option value="qwen">é˜¿é‡Œé€šä¹‰åƒé—®</option>
                                <option value="siliconflow">SiliconFlow</option>
                                <option value="deepseek">DeepSeek</option>
                                <option value="volcano">ç«å±±å¼•æ“</option>
                                <option value="custom">è‡ªå®šä¹‰</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>API Key</label>
                            <input type="password" id="llmApiKey" placeholder="è¾“å…¥ API Key">
                        </div>
                        <div class="form-group">
                            <label>æ¨¡å‹</label>
                            <div class="model-input-row">
                                <input type="text" id="llmModel" placeholder="ä¾‹å¦‚: gpt-4o-mini">
                                <button type="button" class="btn btn-sm fetch-models-btn" id="llmFetchModelsBtn" onclick="fetchModelsFor('llm')">
                                    ğŸ” è·å–æ¨¡å‹
                                </button>
                            </div>
                            <div class="model-select-container" id="llmModelSelectDiv" style="display: none;">
                                <select id="llmModelSelect" onchange="onModelSelected('llm')">
                                    <option value="">-- é€‰æ‹©æ¨¡å‹ --</option>
                                </select>
                                <span class="model-count" id="llmModelCount"></span>
                            </div>
                        </div>
                        <div class="form-group" id="llmBaseUrlGroup" style="display: none;">
                            <label>Base URL</label>
                            <input type="text" id="llmBaseUrl" placeholder="è‡ªå®šä¹‰ API åœ°å€">
                        </div>
                    </div>
                </div>

                <!-- æ‰¹é‡åˆ†æè®¾ç½® -->
                <div class="settings-content" id="settings-batch">
                    <div class="form-group">
                        <label>æ¯æ‰¹æ¬¡åˆ†æé¡µæ•°</label>
                        <input type="number" id="pagesPerBatch" value="5" min="1" max="10" onchange="onPagesPerBatchChange(this.value)">
                        <p class="form-hint">æ¯æ¬¡å‘é€ç»™ VLM çš„å›¾ç‰‡æ•°é‡ï¼Œå»ºè®® 3-5 å¼ ã€‚å›¾ç‰‡è¶Šå¤šï¼Œä¸Šä¸‹æ–‡è¶Šè¿è´¯ï¼Œä½†å¯èƒ½è¶…å‡ºæ¨¡å‹é™åˆ¶ã€‚</p>
                    </div>
                    <div class="form-group">
                        <label>ä¸Šæ–‡å‚è€ƒæ‰¹æ¬¡æ•°</label>
                        <input type="number" id="contextBatchCount" value="1" min="0" max="5">
                        <p class="form-hint">æ¯æ‰¹åˆ†ææ—¶å‚è€ƒå‰å‡ æ‰¹çš„ç»“æœä½œä¸ºä¸Šä¸‹æ–‡ã€‚0=ä¸å‚è€ƒï¼Œ1-5=å‚è€ƒæ›´å¤šå‰æ–‡ã€‚</p>
                    </div>
                    
                    <div class="form-group">
                        <label>åˆ†ææ¶æ„</label>
                        <select id="architecturePreset" onchange="onArchitectureChange()">
                            <option value="simple">ç®€æ´æ¨¡å¼ - æ‰¹é‡åˆ†æ â†’ å…¨ä¹¦æ€»ç»“ï¼ˆçŸ­ç¯‡ï¼‰</option>
                            <option value="standard" selected>æ ‡å‡†æ¨¡å¼ - æ‰¹é‡åˆ†æ â†’ æ®µè½æ€»ç»“ â†’ å…¨ä¹¦æ€»ç»“</option>
                            <option value="chapter_based">ç« èŠ‚æ¨¡å¼ - æ‰¹é‡åˆ†æ â†’ ç« èŠ‚æ€»ç»“ â†’ å…¨ä¹¦æ€»ç»“</option>
                            <option value="full">å®Œæ•´æ¨¡å¼ - æ‰¹é‡åˆ†æ â†’ å°æ€»ç»“ â†’ ç« èŠ‚æ€»ç»“ â†’ å…¨ä¹¦æ€»ç»“</option>
                            <option value="custom">è‡ªå®šä¹‰æ¨¡å¼ - å®Œå…¨è‡ªå®šä¹‰å±‚çº§æ¶æ„</option>
                        </select>
                        <p class="form-hint" id="architectureDescription">æ ¹æ®æ¼«ç”»ç±»å‹é€‰æ‹©åˆé€‚çš„åˆ†ææ¶æ„</p>
                    </div>
                    
                    <!-- è‡ªå®šä¹‰å±‚çº§ç¼–è¾‘å™¨ -->
                    <div id="customLayersEditor" style="display: none;">
                        <div class="form-group">
                            <label>è‡ªå®šä¹‰å±‚çº§</label>
                            <div id="customLayersList"></div>
                            <button type="button" class="btn btn-sm" onclick="addCustomLayer()" style="margin-top: 8px;">
                                + æ·»åŠ å±‚çº§
                            </button>
                            <p class="form-hint">ç¬¬ä¸€å±‚å›ºå®šä¸ºæ‰¹é‡åˆ†æï¼Œæœ€åä¸€å±‚å›ºå®šä¸ºå…¨ä¹¦æ€»ç»“ã€‚ä¸­é—´å¯æ·»åŠ ä»»æ„æ±‡æ€»å±‚çº§ã€‚</p>
                        </div>
                    </div>
                    
                    <div class="batch-info-box" id="architecturePreview">
                        <h4>å½“å‰æ¶æ„é¢„è§ˆ</h4>
                        <div id="layersList"></div>
                    </div>
                    
                    <div class="batch-estimate" id="batchEstimate">
                        <p>å½“å‰é…ç½®ï¼šæ¯ <span id="estPagesPerBatch">5</span> é¡µä¸€æ‰¹</p>
                    </div>
                </div>

                <!-- Embedding è®¾ç½® -->
                <div class="settings-content" id="settings-embedding">
                    <div class="form-group">
                        <label>æœåŠ¡å•†</label>
                        <select id="embeddingProvider" onchange="onEmbeddingProviderChange()">
                            <option value="gemini">Google Gemini</option>
                            <option value="openai">OpenAI</option>
                            <option value="qwen">é˜¿é‡Œé€šä¹‰åƒé—®</option>
                            <option value="siliconflow">SiliconFlow</option>
                            <option value="deepseek">DeepSeek</option>
                            <option value="volcano">ç«å±±å¼•æ“</option>
                            <option value="custom">è‡ªå®šä¹‰</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>API Key</label>
                        <input type="password" id="embeddingApiKey" placeholder="è¾“å…¥ API Key">
                    </div>
                    <div class="form-group">
                        <label>æ¨¡å‹</label>
                        <div class="model-input-row">
                            <input type="text" id="embeddingModel" placeholder="ä¾‹å¦‚: text-embedding-3-small">
                            <button type="button" class="btn btn-sm fetch-models-btn" id="embeddingFetchModelsBtn" onclick="fetchModelsFor('embedding')">
                                ğŸ” è·å–æ¨¡å‹
                            </button>
                        </div>
                        <div class="model-select-container" id="embeddingModelSelectDiv" style="display: none;">
                            <select id="embeddingModelSelect" onchange="onModelSelected('embedding')">
                                <option value="">-- é€‰æ‹©æ¨¡å‹ --</option>
                            </select>
                            <span class="model-count" id="embeddingModelCount"></span>
                        </div>
                    </div>
                    <div class="form-group" id="embeddingBaseUrlGroup" style="display: none;">
                        <label>Base URL</label>
                        <input type="text" id="embeddingBaseUrl" placeholder="è‡ªå®šä¹‰ API åœ°å€">
                    </div>
                    <div class="form-group">
                        <label>RPM é™åˆ¶</label>
                        <input type="number" id="embeddingRpmLimit" value="0" min="0" max="1000">
                        <p class="form-hint">æ¯åˆ†é’Ÿæœ€å¤§è¯·æ±‚æ•°ï¼Œ0 è¡¨ç¤ºä¸é™åˆ¶ã€‚</p>
                    </div>
                    <button class="btn btn-secondary" onclick="testEmbeddingConnection()">æµ‹è¯•è¿æ¥</button>
                </div>

                <!-- Reranker è®¾ç½® -->
                <div class="settings-content" id="settings-reranker">
                    <p class="form-hint" style="margin-bottom: 16px;">é…ç½®é‡æ’åºæ¨¡å‹åï¼Œåœ¨æ™ºèƒ½é—®ç­”ä¸­å‹¾é€‰"é‡æ’åº"å¼€å…³å³å¯å¯ç”¨</p>
                    <div class="form-group">
                        <label>æœåŠ¡å•†</label>
                        <select id="rerankerProvider" onchange="onRerankerProviderChange()">
                            <option value="gemini">Google Gemini</option>
                            <option value="openai">OpenAI</option>
                            <option value="qwen">é˜¿é‡Œé€šä¹‰åƒé—®</option>
                            <option value="siliconflow">SiliconFlow</option>
                            <option value="deepseek">DeepSeek</option>
                            <option value="volcano">ç«å±±å¼•æ“</option>
                            <option value="jina">Jina AI</option>
                            <option value="cohere">Cohere</option>
                            <option value="custom">è‡ªå®šä¹‰</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>API Key</label>
                        <input type="password" id="rerankerApiKey" placeholder="è¾“å…¥ API Key">
                    </div>
                    <div class="form-group">
                        <label>æ¨¡å‹</label>
                        <input type="text" id="rerankerModel" placeholder="ä¾‹å¦‚: BAAI/bge-reranker-v2-m3">
                    </div>
                    <div class="form-group" id="rerankerBaseUrlGroup" style="display: none;">
                        <label>Base URL</label>
                        <input type="text" id="rerankerBaseUrl" placeholder="è‡ªå®šä¹‰ API åœ°å€">
                    </div>
                    <div class="form-group">
                        <label>è¿”å›æ•°é‡ (Top K)</label>
                        <input type="number" id="rerankerTopK" value="5" min="1" max="20">
                    </div>
                </div>

                <!-- æç¤ºè¯è®¾ç½® -->
                <div class="settings-content" id="settings-prompts">
                    <div class="prompts-header">
                        <h3>åˆ†ææç¤ºè¯é…ç½®</h3>
                        <p class="form-hint">è‡ªå®šä¹‰å„ç±»åˆ†æä»»åŠ¡ä½¿ç”¨çš„æç¤ºè¯æ¨¡æ¿ã€‚ç•™ç©ºåˆ™ä½¿ç”¨é»˜è®¤æç¤ºè¯ã€‚</p>
                    </div>
                    
                    <!-- æç¤ºè¯é€‰æ‹©å™¨ -->
                    <div class="form-group">
                        <label>é€‰æ‹©è¦ç¼–è¾‘çš„æç¤ºè¯</label>
                        <select id="promptSelector" onchange="onPromptSelectorChange()">
                            <option value="batch_analysis">ğŸ“„ æ‰¹é‡åˆ†ææç¤ºè¯</option>
                            <option value="segment_summary">ğŸ“‘ æ®µè½æ€»ç»“æç¤ºè¯</option>
                            <option value="chapter_summary">ğŸ“– ç« èŠ‚æ€»ç»“æç¤ºè¯</option>
                            <option value="qa_response">ğŸ’¬ é—®ç­”å“åº”æç¤ºè¯</option>
                        </select>
                    </div>
                    
                    <!-- æç¤ºè¯ç¼–è¾‘åŒº -->
                    <div class="form-group">
                        <div class="prompt-editor-header">
                            <label id="currentPromptLabel">æ‰¹é‡åˆ†ææç¤ºè¯</label>
                            <div class="prompt-actions">
                                <button class="btn btn-sm" onclick="resetCurrentPrompt()" title="é‡ç½®ä¸ºé»˜è®¤">ğŸ”„ é‡ç½®</button>
                                <button class="btn btn-sm" onclick="copyPromptToClipboard()" title="å¤åˆ¶">ğŸ“‹ å¤åˆ¶</button>
                            </div>
                        </div>
                        <textarea id="promptEditor" rows="15" placeholder="åœ¨æ­¤ç¼–è¾‘æç¤ºè¯..."></textarea>
                        <p class="form-hint" id="promptHint">æ­¤æç¤ºè¯ç”¨äºæ‰¹é‡åˆ†æå¤šä¸ªé¡µé¢æ—¶çš„ VLM è°ƒç”¨ã€‚æ”¯æŒå˜é‡ï¼š{page_count}, {start_page}, {end_page}</p>
                    </div>
                    
                    <!-- æç¤ºè¯åº“ç®¡ç† -->
                    <div class="prompts-library-section">
                        <div class="section-header">
                            <h4>ğŸ“š æˆ‘çš„æç¤ºè¯åº“</h4>
                            <button class="btn btn-sm btn-primary" onclick="savePromptToLibrary()">+ ä¿å­˜åˆ°åº“</button>
                        </div>
                        <div class="saved-prompts-list" id="savedPromptsList">
                            <div class="placeholder-text">æš‚æ— ä¿å­˜çš„æç¤ºè¯</div>
                        </div>
                    </div>
                    
                    <!-- å¯¼å…¥å¯¼å‡º -->
                    <div class="prompts-io-section">
                        <button class="btn btn-secondary btn-sm" onclick="exportAllPrompts()">ğŸ“¤ å¯¼å‡ºæ‰€æœ‰æç¤ºè¯</button>
                        <button class="btn btn-secondary btn-sm" onclick="importPromptsFromFile()">ğŸ“¥ å¯¼å…¥æç¤ºè¯</button>
                        <input type="file" id="promptsFileInput" accept=".json" style="display:none" onchange="handlePromptsFileImport(event)">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeSettingsModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveSettings()">ä¿å­˜è®¾ç½®</button>
            </div>
        </div>
    </div>

    <!-- ç« èŠ‚é€‰æ‹©æ¨¡æ€æ¡† (ç”¨äºè·³è½¬ç¿»è¯‘é¡µé¢) -->
    <div id="chapterSelectModal" class="modal">
        <div class="modal-overlay" onclick="closeChapterSelectModal()"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2>é€‰æ‹©ç« èŠ‚</h2>
                <button class="modal-close" onclick="closeChapterSelectModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p class="chapter-select-hint">è¯·é€‰æ‹©è¦ç¿»è¯‘çš„ç« èŠ‚ï¼š</p>
                <div id="chapterSelectList" class="chapter-select-list">
                    <!-- ç« èŠ‚åˆ—è¡¨å°†é€šè¿‡ JS åŠ¨æ€å¡«å…… -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeChapterSelectModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- ç¬”è®°æ¨¡æ€æ¡† -->
    <div id="noteModal" class="modal note-modal">
        <div class="modal-overlay" onclick="closeNoteModal()"></div>
        <div class="modal-content note-modal-content">
            <div class="modal-header">
                <h2 id="noteModalTitle">ğŸ“ æ·»åŠ ç¬”è®°</h2>
                <button class="modal-close" onclick="closeNoteModal()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- ç¬”è®°ç±»å‹é€‰æ‹© -->
                <div class="note-type-selector" id="noteTypeSelector">
                    <button class="note-type-btn active" data-type="text" onclick="selectNoteType('text')">
                        <span class="note-type-icon">âœï¸</span>
                        <span>æ–‡æœ¬ç¬”è®°</span>
                    </button>
                    <button class="note-type-btn" data-type="qa" onclick="selectNoteType('qa')">
                        <span class="note-type-icon">ğŸ’¬</span>
                        <span>é—®ç­”ç¬”è®°</span>
                    </button>
                </div>

                <!-- æ–‡æœ¬ç¬”è®°è¡¨å• -->
                <div class="note-form" id="textNoteForm">
                    <div class="form-group">
                        <label for="noteTitle">æ ‡é¢˜ <span class="optional">(å¯é€‰)</span></label>
                        <input type="text" id="noteTitle" class="form-input" placeholder="ç»™ç¬”è®°èµ·ä¸ªæ ‡é¢˜...">
                    </div>
                    <div class="form-group">
                        <label for="noteContent">å†…å®¹ <span class="required">*</span></label>
                        <textarea id="noteContent" class="form-textarea" rows="6" placeholder="å†™ä¸‹ä½ çš„æƒ³æ³•..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="notePageRef">å…³è”é¡µç  <span class="optional">(å¯é€‰)</span></label>
                        <input type="number" id="notePageRef" class="form-input" placeholder="è¾“å…¥é¡µç " min="1">
                    </div>
                    <div class="form-group">
                        <label for="noteTags">æ ‡ç­¾ <span class="optional">(å¯é€‰)</span></label>
                        <input type="text" id="noteTags" class="form-input" placeholder="å¤šä¸ªæ ‡ç­¾ç”¨é€—å·åˆ†éš”ï¼Œå¦‚: è§’è‰², å‰§æƒ…">
                    </div>
                </div>

                <!-- é—®ç­”ç¬”è®°è¡¨å•ï¼ˆä»é—®ç­”ä¿å­˜æ—¶ä½¿ç”¨ï¼‰ -->
                <div class="note-form" id="qaNoteForm" style="display: none;">
                    <div class="qa-preview">
                        <div class="qa-preview-section">
                            <label>é—®é¢˜</label>
                            <div class="qa-preview-content" id="qaPreviewQuestion"></div>
                        </div>
                        <div class="qa-preview-section">
                            <label>å›ç­”</label>
                            <div class="qa-preview-content" id="qaPreviewAnswer"></div>
                        </div>
                        <div class="qa-preview-section" id="qaPreviewCitationsSection" style="display: none;">
                            <label>å¼•ç”¨é¡µç </label>
                            <div class="qa-preview-citations" id="qaPreviewCitations"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="qaNoteTitle">ç¬”è®°æ ‡é¢˜ <span class="optional">(å¯é€‰)</span></label>
                        <input type="text" id="qaNoteTitle" class="form-input" placeholder="é»˜è®¤ä½¿ç”¨é—®é¢˜ä½œä¸ºæ ‡é¢˜...">
                    </div>
                    <div class="form-group">
                        <label for="qaNoteComment">è¡¥å……è¯´æ˜ <span class="optional">(å¯é€‰)</span></label>
                        <textarea id="qaNoteComment" class="form-textarea" rows="3" placeholder="æ·»åŠ ä½ çš„è¯„è®ºæˆ–è¡¥å……..."></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeNoteModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveNote()" id="saveNoteBtn">ä¿å­˜ç¬”è®°</button>
            </div>
        </div>
    </div>

    <!-- ç¬”è®°è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div id="noteDetailModal" class="modal note-modal">
        <div class="modal-overlay" onclick="closeNoteDetailModal()"></div>
        <div class="modal-content note-modal-content">
            <div class="modal-header">
                <h2 id="noteDetailTitle">ğŸ“ ç¬”è®°è¯¦æƒ…</h2>
                <button class="modal-close" onclick="closeNoteDetailModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="note-detail-content" id="noteDetailContent">
                    <!-- åŠ¨æ€å¡«å…… -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="deleteCurrentNote()" id="deleteNoteBtn">ğŸ—‘ï¸ åˆ é™¤</button>
                <button class="btn btn-secondary" onclick="closeNoteDetailModal()">å…³é—­</button>
                <button class="btn btn-primary" onclick="editCurrentNote()">âœï¸ ç¼–è¾‘</button>
            </div>
        </div>
    </div>

    <!-- åŠ è½½æç¤º -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">åŠ è½½ä¸­...</div>
    </div>

    <!-- Toast æç¤º -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- ç§»åŠ¨ç«¯é®ç½©å±‚ -->
    <div class="mobile-overlay" id="mobileOverlay" onclick="closeMobilePanels()"></div>

    <script src="{{ url_for('static', filename='js/manga-insight.js') }}"></script>
    <script>
        // åˆå§‹åŒ–é¡µé¢
        document.addEventListener('DOMContentLoaded', function() {
            initMangaInsight();
            initMobileNavigation();
        });

        // ç§»åŠ¨ç«¯å¯¼èˆªåˆå§‹åŒ–
        function initMobileNavigation() {
            // ç›‘å¬çª—å£å¤§å°å˜åŒ–ï¼Œåœ¨å¤§å±å¹•æ—¶è‡ªåŠ¨å…³é—­ç§»åŠ¨ç«¯é¢æ¿
            window.addEventListener('resize', function() {
                if (window.innerWidth > 768) {
                    closeMobilePanels();
                }
            });

            // ç›‘å¬ ESC é”®å…³é—­é¢æ¿
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeMobilePanels();
                }
            });

            // åœ¨ä¾§è¾¹æ å†…ç‚¹å‡»æŸäº›å…ƒç´ åè‡ªåŠ¨å…³é—­ï¼ˆå¦‚é€‰æ‹©é¡µé¢ï¼‰
            const sidebar = document.querySelector('.insight-sidebar');
            if (sidebar) {
                sidebar.addEventListener('click', function(e) {
                    // å¦‚æœç‚¹å‡»çš„æ˜¯é¡µé¢ç¼©ç•¥å›¾ï¼Œè‡ªåŠ¨å…³é—­ä¾§è¾¹æ 
                    if (e.target.closest('.tree-page-item')) {
                        setTimeout(closeMobileSidebar, 200);
                    }
                });
            }
            
            // åœ¨å³ä¾§å·¥ä½œåŒºç‚¹å‡»æŸäº›å…ƒç´ åè‡ªåŠ¨å…³é—­
            const workspace = document.querySelector('.insight-workspace');
            if (workspace) {
                workspace.addEventListener('click', function(e) {
                    // å¦‚æœç‚¹å‡»çš„æ˜¯é¡µé¢é“¾æ¥ï¼Œè‡ªåŠ¨å…³é—­å·¥ä½œåŒº
                    if (e.target.closest('.note-page-ref') || e.target.closest('.note-detail-page-link')) {
                        setTimeout(closeMobileWorkspace, 200);
                    }
                });
            }
        }

        // åˆ‡æ¢ç§»åŠ¨ç«¯ä¾§è¾¹æ 
        function toggleMobileSidebar() {
            const sidebar = document.querySelector('.insight-sidebar');
            const overlay = document.getElementById('mobileOverlay');
            const toggleBtn = document.getElementById('mobileNavBtn');
            
            if (sidebar && overlay) {
                const isOpen = sidebar.classList.contains('mobile-open');
                
                if (isOpen) {
                    closeMobileSidebar();
                } else {
                    // å…ˆå…³é—­å³ä¾§å·¥ä½œåŒº
                    closeMobileWorkspace();
                    sidebar.classList.add('mobile-open');
                    overlay.classList.add('active');
                    if (toggleBtn) {
                        toggleBtn.innerHTML = 'âœ•';
                        toggleBtn.classList.add('active');
                    }
                    document.body.style.overflow = 'hidden';
                }
            }
        }

        // å…³é—­ç§»åŠ¨ç«¯ä¾§è¾¹æ 
        function closeMobileSidebar() {
            const sidebar = document.querySelector('.insight-sidebar');
            const overlay = document.getElementById('mobileOverlay');
            const toggleBtn = document.getElementById('mobileNavBtn');
            
            if (sidebar) {
                sidebar.classList.remove('mobile-open');
            }
            if (overlay && !document.querySelector('.insight-workspace.mobile-open')) {
                overlay.classList.remove('active');
            }
            if (toggleBtn) {
                toggleBtn.innerHTML = 'ğŸ“š';
                toggleBtn.classList.remove('active');
            }
            if (!document.querySelector('.insight-workspace.mobile-open')) {
                document.body.style.overflow = '';
            }
        }

        // åˆ‡æ¢ç§»åŠ¨ç«¯å³ä¾§å·¥ä½œåŒº
        function toggleMobileWorkspace() {
            const workspace = document.querySelector('.insight-workspace');
            const overlay = document.getElementById('mobileOverlay');
            const toggleBtn = document.getElementById('mobileWorkspaceBtn');
            
            if (workspace && overlay) {
                const isOpen = workspace.classList.contains('mobile-open');
                
                if (isOpen) {
                    closeMobileWorkspace();
                } else {
                    // å…ˆå…³é—­å·¦ä¾§è¾¹æ 
                    closeMobileSidebar();
                    workspace.classList.add('mobile-open');
                    overlay.classList.add('active');
                    if (toggleBtn) {
                        toggleBtn.innerHTML = 'âœ•';
                        toggleBtn.classList.add('active');
                    }
                    document.body.style.overflow = 'hidden';
                }
            }
        }

        // å…³é—­ç§»åŠ¨ç«¯å³ä¾§å·¥ä½œåŒº
        function closeMobileWorkspace() {
            const workspace = document.querySelector('.insight-workspace');
            const overlay = document.getElementById('mobileOverlay');
            const toggleBtn = document.getElementById('mobileWorkspaceBtn');
            
            if (workspace) {
                workspace.classList.remove('mobile-open');
            }
            if (overlay && !document.querySelector('.insight-sidebar.mobile-open')) {
                overlay.classList.remove('active');
            }
            if (toggleBtn) {
                toggleBtn.innerHTML = 'ğŸ“';
                toggleBtn.classList.remove('active');
            }
            if (!document.querySelector('.insight-sidebar.mobile-open')) {
                document.body.style.overflow = '';
            }
        }

        // å…³é—­æ‰€æœ‰ç§»åŠ¨ç«¯é¢æ¿
        function closeMobilePanels() {
            closeMobileSidebar();
            closeMobileWorkspace();
        }

        // ==================== ç¿»è¯‘é¡µé¢è·³è½¬ ====================
        
        // ç‚¹å‡»ç¿»è¯‘æŒ‰é’®
        function goToTranslate() {
            // æ£€æŸ¥æ˜¯å¦å·²é€‰æ‹©ä¹¦ç±
            if (!window.MangaInsight || !window.MangaInsight.currentBookId) {
                // æ²¡æœ‰é€‰æ‹©ä¹¦ç±ï¼Œè·³è½¬åˆ°å¿«é€Ÿç¿»è¯‘é¡µé¢
                window.location.href = '/translate';
                return;
            }
            
            const bookId = window.MangaInsight.currentBookId;
            const chapters = window.MangaInsight.bookInfo?.chapters || [];
            
            if (chapters.length === 0) {
                // æ²¡æœ‰ç« èŠ‚ä¿¡æ¯ï¼Œç›´æ¥è·³è½¬åˆ°ä¹¦ç±ç¿»è¯‘é¡µé¢ï¼ˆä¸æŒ‡å®šç« èŠ‚ï¼‰
                window.location.href = `/translate?book=${bookId}`;
            } else if (chapters.length === 1) {
                // åªæœ‰ä¸€ç« ï¼Œç›´æ¥è·³è½¬
                const chapterId = chapters[0].id || chapters[0].chapter_id || 'ch_1';
                window.location.href = `/translate?book=${bookId}&chapter=${chapterId}`;
            } else {
                // å¤šç« èŠ‚ï¼Œå¼¹å‡ºé€‰æ‹©å™¨
                showChapterSelectModal(bookId, chapters);
            }
        }
        
        // æ˜¾ç¤ºç« èŠ‚é€‰æ‹©æ¨¡æ€æ¡†
        function showChapterSelectModal(bookId, chapters) {
            const modal = document.getElementById('chapterSelectModal');
            const listContainer = document.getElementById('chapterSelectList');
            
            if (!modal || !listContainer) return;
            
            // ç”Ÿæˆç« èŠ‚åˆ—è¡¨
            if (chapters.length === 0) {
                listContainer.innerHTML = `
                    <div class="chapter-select-empty">
                        <div class="empty-icon">ğŸ“­</div>
                        <p>æš‚æ— ç« èŠ‚ä¿¡æ¯</p>
                    </div>
                `;
            } else {
                let html = '';
                chapters.forEach((ch, idx) => {
                    const chId = ch.id || ch.chapter_id || `ch_${idx + 1}`;
                    const chTitle = ch.title || `ç¬¬ ${idx + 1} ç« `;
                    const pageCount = ch.page_count || ch.pages?.length || 0;
                    
                    html += `
                        <div class="chapter-select-item" onclick="selectChapterAndGo('${bookId}', '${chId}')">
                            <span class="chapter-icon">ğŸ“–</span>
                            <div class="chapter-info">
                                <div class="chapter-name">${chTitle}</div>
                                <div class="chapter-meta">${pageCount} é¡µ</div>
                            </div>
                            <span class="chapter-arrow">â†’</span>
                        </div>
                    `;
                });
                listContainer.innerHTML = html;
            }
            
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            modal.classList.add('show');
        }
        
        // å…³é—­ç« èŠ‚é€‰æ‹©æ¨¡æ€æ¡†
        function closeChapterSelectModal() {
            const modal = document.getElementById('chapterSelectModal');
            if (modal) {
                modal.classList.remove('show');
            }
        }
        
        // é€‰æ‹©ç« èŠ‚å¹¶è·³è½¬
        function selectChapterAndGo(bookId, chapterId) {
            closeChapterSelectModal();
            window.location.href = `/translate?book=${bookId}&chapter=${chapterId}`;
        }
    </script>
</body>
</html>
