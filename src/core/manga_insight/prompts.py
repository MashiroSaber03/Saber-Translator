# src/core/manga_insight/prompts.py
"""
Manga Insight 提示词模板

所有默认提示词常量集中管理。
"""

# ============================================================
# 系统提示词
# ============================================================

DEFAULT_QA_SYSTEM_PROMPT = """你是专业的漫画分析助手。请基于提供的漫画内容回答用户问题。

【回答要求】
1. 全程使用中文回答
2. 引用具体页码时使用加粗格式（如"在**第5页**中..."）
3. 回答要准确、有条理
4. 简单问题简短回答（1-3句），复杂问题可展开说明
5. 如果有多个相关内容，使用列表形式列举最相关的2-3个
6. 如果提供的内容无法回答问题，诚实说明"根据已分析的内容，暂未找到相关信息"
7. 不要编造漫画中没有的内容

【格式要求】
- 使用 Markdown 格式输出
- 重点内容使用 **加粗**
- 多个要点使用列表（- 或 1. 2. 3.）
- 引用对话使用 > 引用格式
- 不需要使用标题（#）"""

DEFAULT_ANALYSIS_SYSTEM_PROMPT = "你是一个漫画剧情分析师，请生成结构化的分析结果。"


# ============================================================
# 问题处理提示词
# ============================================================

DEFAULT_QUESTION_DECOMPOSE_PROMPT = """你是漫画内容检索助手。请将用户的复杂问题分解为2-4个独立的子问题，便于分别检索。

【分解原则】
- 每个子问题针对一个具体信息点
- 子问题综合起来能回答原问题
- 如果原问题已经足够简单，返回 {{"sub_questions": ["原问题"]}}

【用户问题】
{question}

【输出要求】
必须且只能输出以下JSON格式，不要有任何其他文字：
{{"sub_questions": ["子问题1", "子问题2"]}}"""


# ============================================================
# 批量分析模式提示词
# ============================================================

DEFAULT_BATCH_ANALYSIS_PROMPT = """你是一个专业的漫画分析师。请分析这组连续的 {page_count} 张漫画页面（第 {start_page} 页至第 {end_page} 页）。

【重要说明】
- 这是漫画原图（未翻译版本），请直接阅读原文内容
- 无论漫画原文是什么语言，你的所有输出内容必须使用中文
- 请特别关注页面之间的剧情连续性

请按以下 JSON 格式返回结果：
{{
    "page_range": {{
        "start": {start_page},
        "end": {end_page}
    }},
    "pages": [
        {{
            "page_number": <页码>,
            "page_summary": "<该页详细内容概括，包含场景描述、角色行为、重要对话和情节发展。简单页面80-150字，复杂页面150-300字，根据内容丰富程度调整>"
        }}
    ],
    "batch_summary": "<这组页面的整体剧情概述，详细描述故事发展、角色互动和情感变化，200-400字>",
    "key_events": ["<这组页面中的3-5个关键事件，每个事件用一句话概括>"],
    "continuity_notes": "<与上文的衔接、场景转换、剧情走向说明>"
}}

注意：
1. 按正确的漫画阅读顺序分析
2. 重点关注剧情发展和角色互动
3. page_summary 要详细描述该页发生的事情
4. batch_summary 要完整概括这批页面的故事内容

【重要】请直接输出JSON，不要包含任何解释、markdown代码块或其他文字。"""


DEFAULT_SEGMENT_SUMMARY_PROMPT = """【输出中文】基于以下 {batch_count} 个批次的分析结果（第 {start_page} 页至第 {end_page} 页），生成一个连贯的小总结。

【批次分析结果】
{batch_summaries}

请生成结构化的小总结，JSON 格式：
{{
    "segment_id": "{segment_id}",
    "page_range": {{
        "start": {start_page},
        "end": {end_page}
    }},
    "summary": "<这段内容的主要剧情概括，详细描述故事发展、角色互动和关键事件，150-300字>"
}}

要求：
1. 整合各批次的信息，形成连贯叙述
2. 突出重要角色和关键事件
3. 注意剧情的因果关系

【重要】请直接输出JSON，不要包含任何解释、markdown代码块或其他文字。"""


DEFAULT_CHAPTER_FROM_SEGMENTS_PROMPT = """【输出中文】基于以下小总结，生成完整的章节总结。

【章节信息】
章节：{chapter_title}
页面范围：第 {start_page} 页至第 {end_page} 页

【小总结列表】
{segment_summaries}

请生成章节总结，JSON 格式：
{{
    "chapter_id": "{chapter_id}",
    "title": "{chapter_title}",
    "page_range": {{
        "start": {start_page},
        "end": {end_page}
    }},
    "summary": "<本章完整剧情概述，按时间顺序描述主要事件和角色行为，400-600字>",
    "main_plot": "<一句话概括本章核心剧情线，如'主角与敌人首次交锋并险胜'>",
    "key_events": ["<按顺序列出3-5个关键事件，每个事件一句话描述>"],
    "connections": {{
        "previous": "<本章开头与前文的衔接，如'承接上章的战斗结束后...'，首章可留空>",
        "foreshadowing": "<本章埋下的伏笔或未解决的悬念，如'神秘人物的身份仍未揭晓'>"
    }}
}}

要求：
1. 综合所有小总结，形成完整的章节叙述
2. 理清人物关系和剧情脉络
3. summary 要详细描述剧情发展，不要空泛概括

【重要】请直接输出JSON，不要包含任何解释、markdown代码块或其他文字。"""


# ============================================================
# 概要生成提示词
# ============================================================

DEFAULT_GROUP_SUMMARY_PROMPT = """【输出中文】请将以下第 {start_page} 页至第 {end_page} 页的漫画内容总结为一个连贯的段落。

【页面内容】
{page_contents}

要求：
1. 按时间顺序描述主要事件和角色行为
2. 不要遗漏关键剧情转折
3. 字数150-250字，根据内容复杂度调整"""


DEFAULT_BOOK_OVERVIEW_PROMPT = """【输出中文】请根据以下内容，生成一份**结构化的剧情概述**，使用 Markdown 格式输出。

【内容摘要】
{section_summaries}

【任务说明】
你需要像给朋友复述故事一样，详细讲述内容中发生的所有事情。这不是宣传简介，而是完整的剧情回顾，可以包含所有剧透。

【输出格式要求 - 必须使用 Markdown】
请使用以下结构组织内容（根据实际情况调整小节）：

## 📖 故事背景
简要介绍故事的世界观、主要角色和初始设定。

## 🎬 剧情发展
按时间线描述主要事件，可以用多个小节：
### 开端
...
### 发展
...
### 转折/高潮
...

## 👥 主要角色
- **角色名**：角色简介和在故事中的作用

## 📌 关键事件
用列表形式列出重要转折点：
- 事件1
- 事件2

## 💭 当前进度
（如果故事未完结）注明分析进度和悬念

【输出策略】
■ 如果内容包含完整故事：完整叙述起因→发展→高潮→结局
■ 如果内容只是故事的一部分：按时间顺序详细叙述，结尾注明进度

【写作要求】
1. **必须使用 Markdown 格式**：标题用 ##，列表用 -，重点用 **加粗**
2. 具体描述事件：谁做了什么、发生了什么、结果如何
3. 不要省略情节：每个重要转折都要提到
4. 避免空话套话，要有具体内容
5. 字数根据内容调整：内容少则300-500字，内容多则500-1000字

请直接输出 Markdown 格式的概述，无需代码块包裹。"""
