# 需求规格文档

## 简介

本文档定义了将 Saber-Translator 漫画翻译项目的前端从当前的 Jinja2 模板 + jQuery + 原生 JavaScript 架构迁移到 Vue.js 现代前端框架的需求规格。

### ⚠️ 核心约束（最高优先级）

**本项目已有大量用户，迁移的核心原则是：用户体验零变化。**

- **UI外观必须100%保持不变** - 所有页面的视觉呈现必须与现有版本完全一致
- **操作行为必须100%保持不变** - 所有交互逻辑、快捷键、鼠标操作必须与现有版本完全一致
- **功能逻辑必须100%保持不变** - 所有业务功能的执行结果必须与现有版本完全一致
- **仅改变技术实现架构** - 从 jQuery + 原生 JS 迁移到 Vue 3 + TypeScript

用户在使用迁移后的版本时，应该完全感知不到任何变化，就像什么都没发生一样。

### 当前架构问题

当前前端架构存在以下维护性问题：
- 4个独立的 HTML 模板文件（index.html、bookshelf.html、reader.html、manga_insight.html）
- 17个 JavaScript 文件，使用 ES6 模块但依赖 jQuery
- 状态管理分散在多个文件中（state.js、bubble_state.js）
- UI 逻辑与业务逻辑耦合严重
- 缺乏组件化，代码复用困难

### 迁移目标

建立一个基于 Vue 3 + TypeScript 的现代化前端，**在保持现有UI外观、操作行为和全部功能完全不变的前提下**，提升代码可维护性、可测试性和开发效率。

## 术语表

- **Vue前端**: 基于 Vue 3 框架构建的新前端应用
- **Flask后端**: 现有的 Python Flask 后端服务，提供 REST API
- **单页应用**: Single Page Application (SPA)，单页面应用
- **Pinia**: Vue 3 官方推荐的状态管理库
- **Vue路由**: Vue 官方路由管理器
- **Vite**: 现代前端构建工具
- **组件**: Vue 组件，可复用的 UI 单元
- **组合式函数**: Vue 3 Composable，用于逻辑复用
- **API客户端**: 封装后端 API 调用的服务层

## 需求列表

### 需求 1

**用户故事:** 作为开发者，我希望搭建一个配置完善的 Vue 3 项目，以便获得现代化的开发体验。

#### 验收标准

1. 当开发者运行构建命令时，Vue前端应当在指定输出目录生成优化后的静态资源
2. 当开发者运行开发服务器时，Vue前端应当提供热模块替换功能以支持快速开发
3. 当编译 TypeScript 文件时，Vue前端应当执行严格的类型检查且无错误
4. 当Vue前端构建完成时，输出应当兼容 Flask 静态文件服务

### 需求 2

**用户故事:** 作为用户，我希望在应用的不同页面之间导航，以便访问书架、阅读器、翻译和分析功能。

#### 验收标准

1. 当用户访问根 URL 时，Vue路由应当显示书架页面
2. 当用户导航到 /translate 时，Vue路由应当显示翻译页面，并支持可选的 book 和 chapter 查询参数
3. 当用户导航到 /reader 时，Vue路由应当显示阅读器页面，并要求 book 和 chapter 查询参数
4. 当用户导航到 /insight 时，Vue路由应当显示漫画分析页面
5. 当用户导航到未定义的路由时，Vue路由应当重定向到书架页面

### 需求 3

**用户故事:** 作为用户，我希望在书架上管理我的书籍收藏，以便组织我的漫画翻译项目。

#### 验收标准

1. 当书架页面加载时，Vue前端应当从Flask后端API获取并显示所有书籍
2. 当用户创建新书籍时，Vue前端应当向Flask后端发送POST请求，并在成功后更新书籍列表
3. 当用户搜索书籍时，Vue前端应当根据搜索关键词过滤显示的书籍
4. 当用户按标签筛选时，Vue前端应当仅显示匹配所选标签的书籍
5. 当用户选择多本书籍时，Vue前端应当启用批量操作功能，包括标签管理和删除

### 需求 4

**用户故事:** 作为用户，我希望使用各种设置翻译漫画图片，以便生成翻译后的漫画版本。

#### 验收标准

1. 当用户上传图片时，Vue前端应当显示缩略图并将图片数据存储到Pinia状态库
2. 当用户上传PDF或MOBI文件时，Vue前端应当解析文件并提取图片页面
3. 当用户配置翻译设置时，Vue前端应当将设置持久化到Pinia状态库并与Flask后端同步
4. 当用户启动翻译时，Vue前端应当向Flask后端发送翻译请求并显示进度
5. 当用户启动批量翻译时，Vue前端应当支持暂停和继续功能
6. 当翻译完成时，Vue前端应当显示翻译后的图片并启用编辑模式
7. 当用户进入编辑模式时，Vue前端应当显示气泡覆盖层，包含可编辑的文本和样式控件
8. 当用户修改气泡文本或样式时，Vue前端应当请求Flask后端重新渲染并更新显示
9. 当用户使用高质量翻译模式时，Vue前端应当支持批量上下文翻译功能
10. 当用户使用AI校对功能时，Vue前端应当支持多轮校对配置

### 需求 5

**用户故事:** 作为用户，我希望在舒适的阅读界面中阅读翻译后的漫画，以便享受翻译内容。

#### 验收标准

1. 当阅读器页面加载且带有有效的书籍和章节参数时，Vue前端应当从Flask后端获取并显示章节图片
2. 当用户滚动浏览图片时，Vue前端应当更新当前页码指示器
3. 当用户切换原图和翻译图视图时，Vue前端应当切换显示的图片源
4. 当用户调整阅读设置时，Vue前端应当立即应用图片宽度、间距和背景颜色的更改

### 需求 6

**用户故事:** 作为用户，我希望使用AI分析漫画内容，以便获取关于故事的洞察、摘要和问答。

#### 验收标准

1. 当漫画分析页面加载时，Vue前端应当获取可用书籍并显示书籍选择器
2. 当用户开始分析时，Vue前端应当向Flask后端发送分析请求并显示进度
3. 当用户在问答标签页提问时，Vue前端应当将问题发送到Flask后端并显示流式响应
4. 当分析完成时，Vue前端应当显示概览统计、时间线，并启用所有分析功能

### 需求 7

**用户故事:** 作为开发者，我希望有集中的状态管理，以便在组件之间保持一致的应用状态。

#### 验收标准

1. 当图片数据变化时，Pinia状态库应当通知所有订阅的组件
2. 当翻译设置变化时，Pinia状态库应当将设置持久化到localStorage
3. 当应用加载时，Pinia状态库应当从localStorage恢复持久化的设置
4. 当API请求失败时，Pinia状态库应当更新错误状态，组件应当显示适当的错误消息

### 需求 8

**用户故事:** 作为开发者，我希望有可复用的UI组件，以便保持一致的设计并减少代码重复。

#### 验收标准

1. 当需要模态框时，开发者应当使用共享的模态框组件，支持可自定义的内容插槽
2. 当需要提示通知时，开发者应当使用共享的Toast组件，支持可配置的消息和类型
3. 当需要图片显示时，开发者应当使用共享的图片查看器组件，支持缩放和平移功能
4. 当需要表单输入时，开发者应当使用共享的表单组件，具有一致的样式和验证

### 需求 9

**用户故事:** 作为开发者，我希望有清晰的API服务层，以便以集中和类型安全的方式管理后端通信。

#### 验收标准

1. 当发起API请求时，API客户端应当使用集中的HTTP客户端，具有一致的错误处理
2. 当收到API响应时，API客户端应当使用TypeScript接口验证响应结构
3. 当发生API错误时，API客户端应当抛出类型化的错误，组件可以适当处理
4. 当需要认证或速率限制时，API客户端应当透明地处理这些问题

### 需求 10

**用户故事:** 作为用户，我希望应用支持深色和浅色主题，以便在不同光照条件下舒适地使用应用。

#### 验收标准

1. 当用户切换主题时，Vue前端应当在深色和浅色CSS变量之间切换
2. 当应用加载时，Vue前端应当从localStorage恢复之前选择的主题
3. 当主题变化时，所有组件样式应当更新以反映新主题，无需页面刷新

### 需求 11

**用户故事:** 作为开发者，我希望Vue前端能与现有Flask后端无缝集成，以便可以增量进行迁移。

#### 验收标准

1. 当Vue前端构建完成时，输出应当放置在Flask可以作为静态文件服务的目录中
2. 当Flask服务Vue前端时，所有API路由应当在其现有路径上保持可访问
3. 当Vue前端发起API请求时，请求应当使用与Flask路由兼容的相对URL

### 需求 12（核心约束）

**用户故事:** 作为现有用户，我希望迁移后的应用与现有版本完全一致，以便我的使用体验不受任何影响。

#### 验收标准

1. 当用户查看任何页面时，Vue前端应当呈现与现有Jinja2模板像素级相同的视觉外观
2. 当用户进行任何操作时，Vue前端应当提供与现有JavaScript实现完全相同的交互行为和响应时机
3. 当用户使用任何功能时，Vue前端应当保持与现有实现完全相同的功能逻辑和执行结果
4. 当用户切换主题时，Vue前端应当应用与现有CSS变量完全相同的颜色方案
5. 当用户使用快捷键时，Vue前端应当响应与现有实现完全相同的按键组合和行为
6. 当用户使用鼠标操作时，Vue前端应当响应与现有实现完全相同的点击、拖拽、滚轮行为

### 需求 13

**用户故事:** 作为开发者，我希望复用现有的CSS样式文件，以便确保视觉一致性并减少迁移工作量。

#### 验收标准

1. 当构建Vue前端时，构建系统应当直接引入现有的14个CSS文件
2. 当组件渲染时，组件应当使用与现有HTML模板相同的CSS类名
3. 当需要组件级样式时，开发者应当使用scoped样式且不覆盖全局CSS定义
4. 当CSS变量被使用时，Vue前端应当使用与现有实现相同的CSS变量名称

### 需求 14

**用户故事:** 作为用户，我希望管理翻译会话，以便保存和恢复我的翻译进度。

#### 验收标准

1. 当用户保存会话时，Vue前端应当将当前图片和设置状态发送到Flask后端保存
2. 当用户加载会话时，Vue前端应当从Flask后端获取会话数据并恢复完整状态
3. 当用户在书架模式下工作时，Vue前端应当自动关联书籍和章节上下文
4. 当用户删除或重命名会话时，Vue前端应当调用Flask后端API并更新会话列表

### 需求 15

**用户故事:** 作为用户，我希望管理和配置插件，以便扩展应用功能。

#### 验收标准

1. 当用户打开插件管理界面时，Vue前端应当显示所有已安装插件及其状态
2. 当用户启用或禁用插件时，Vue前端应当调用Flask后端API并更新插件状态
3. 当用户配置插件时，Vue前端应当根据插件配置规范动态生成配置表单
4. 当用户设置插件默认状态时，Vue前端应当持久化该设置

### 需求 16

**用户故事:** 作为用户，我希望使用设置模态框配置各种翻译参数，以便自定义翻译行为。

#### 验收标准

1. 当用户打开设置模态框时，Vue前端应当显示分类的设置选项卡
2. 当用户配置OCR引擎时，Vue前端应当支持MangaOCR、PaddleOCR、百度OCR和AI视觉OCR
3. 当用户配置翻译服务时，Vue前端应当支持多种服务商和自定义OpenAI兼容服务
4. 当用户配置文本检测器时，Vue前端应当支持CTD、YOLO、YOLOv5和Default检测器
5. 当用户测试服务连接时，Vue前端应当调用Flask后端测试API并显示结果

### 需求 17

**用户故事:** 作为用户，我希望在编辑模式下精细调整翻译结果，以便获得最佳翻译效果。

#### 验收标准

1. 当用户进入编辑模式时，Vue前端应当显示双图查看器，支持原图和翻译图对比
2. 当用户选择气泡时，Vue前端应当高亮显示并允许编辑文本、字体、颜色等属性
3. 当用户使用笔刷工具时，Vue前端应当支持修复笔刷和还原笔刷功能
4. 当用户添加或删除气泡时，Vue前端应当更新气泡列表并同步到状态
5. 当用户调整气泡位置或大小时，Vue前端应当实时更新显示并支持旋转
6. 当用户切换布局模式时，Vue前端应当支持水平和垂直布局切换

### 需求 18

**用户故事:** 作为用户，我希望导出和导入翻译文本，以便在外部编辑或备份翻译内容。

#### 验收标准

1. 当用户点击导出文本时，Vue前端应当生成包含所有图片翻译文本的JSON文件
2. 当用户导入文本文件时，Vue前端应当解析JSON并更新对应图片的翻译文本
3. 当用户下载单张图片时，Vue前端应当提供翻译后图片的下载
4. 当用户批量下载时，Vue前端应当支持ZIP、PDF、CBZ三种格式的打包下载
5. 当批量下载大量图片时，Vue前端应当使用分步上传API避免请求超时

### 需求 19

**用户故事:** 作为用户，我希望使用快捷键提高操作效率，以便更快速地完成翻译工作。

#### 验收标准

1. 当用户按下A/D键时，Vue前端应当切换上一张或下一张图片
2. 当用户按下Delete或Backspace键时，Vue前端应当删除当前选中的气泡
3. 当用户按下R键并拖动时，Vue前端应当激活修复笔刷模式
4. 当用户按下U键并拖动时，Vue前端应当激活还原笔刷模式
5. 当用户按下Ctrl+Enter时，Vue前端应当应用更改并跳转到下一张图片
6. 当用户使用鼠标中键拖拽时，Vue前端应当绘制新的气泡框
7. 当用户按住Shift点击气泡时，Vue前端应当支持多选气泡

### 需求 20

**用户故事:** 作为用户，我希望在编辑模式下使用50音软键盘，以便方便地输入日语假名。

#### 验收标准

1. 当用户点击50音键盘按钮时，Vue前端应当显示或隐藏50音软键盘
2. 当用户点击假名按键时，Vue前端应当将对应假名插入到原文编辑框
3. 当用户切换键盘标签页时，Vue前端应当显示基本50音、浊音半浊音、拗音或特殊字符

### 需求 21

**用户故事:** 作为用户，我希望在书架页面使用拖拽排序章节，以便自由调整章节顺序。

#### 验收标准

1. 当用户拖拽章节时，Vue前端应当显示拖拽预览并允许重新排序
2. 当用户释放拖拽时，Vue前端应当更新章节顺序并同步到Flask后端
3. 当用户右键点击书籍时，Vue前端应当显示上下文菜单提供快捷操作

### 需求 22

**用户故事:** 作为用户，我希望配置提示词库，以便保存和复用常用的翻译提示词。

#### 验收标准

1. 当用户打开提示词管理时，Vue前端应当显示已保存的提示词列表
2. 当用户创建新提示词时，Vue前端应当保存到Flask后端并更新列表
3. 当用户选择提示词时，Vue前端应当将内容填充到对应的提示词输入框
4. 当用户删除提示词时，Vue前端应当从Flask后端删除并更新列表

### 需求 23

**用户故事:** 作为用户，我希望查看翻译进度和状态，以便了解批量翻译的执行情况。

#### 验收标准

1. 当批量翻译进行时，Vue前端应当显示进度条和当前处理的图片序号
2. 当翻译失败时，Vue前端应当标记失败的图片并提供重新翻译选项
3. 当用户点击暂停时，Vue前端应当暂停批量翻译并允许继续
4. 当翻译完成时，Vue前端应当显示完成通知并更新所有图片状态

### 需求 24

**用户故事:** 作为用户，我希望在漫画分析页面管理笔记，以便记录阅读心得和重要信息。

#### 验收标准

1. 当用户添加笔记时，Vue前端应当支持文本笔记和问答笔记两种类型
2. 当用户查看笔记时，Vue前端应当显示笔记详情并支持编辑和删除
3. 当用户筛选笔记时，Vue前端应当按类型过滤显示笔记列表
4. 当用户关联页码时，Vue前端应当支持从笔记跳转到对应页面

### 需求 25

**用户故事:** 作为用户，我希望在移动设备上使用应用，以便在不同设备上访问翻译功能。

#### 验收标准

1. 当用户在移动设备访问时，Vue前端应当显示响应式布局
2. 当用户点击移动端导航按钮时，Vue前端应当显示或隐藏侧边栏
3. 当用户在移动端操作时，Vue前端应当支持触摸手势和滑动操作
4. 当屏幕尺寸变化时，Vue前端应当自动调整布局适应新尺寸

### 需求 26

**用户故事:** 作为用户，我希望在漫画分析页面配置多种AI模型，以便使用不同的模型进行分析。

#### 验收标准

1. 当用户配置VLM模型时，Vue前端应当支持Gemini、OpenAI、通义千问等多种服务商
2. 当用户配置Embedding模型时，Vue前端应当支持向量化模型的配置
3. 当用户配置Reranker模型时，Vue前端应当支持重排序模型的配置
4. 当用户获取模型列表时，Vue前端应当从服务商API获取可用模型

### 需求 27

**用户故事:** 作为用户，我希望在漫画分析页面管理分析提示词，以便自定义分析行为。

#### 验收标准

1. 当用户编辑提示词时，Vue前端应当支持批量分析、段落总结、章节总结、问答响应等多种提示词
2. 当用户保存提示词到库时，Vue前端应当持久化到Flask后端
3. 当用户导出提示词时，Vue前端应当生成JSON文件下载
4. 当用户导入提示词时，Vue前端应当解析JSON文件并更新提示词库

### 需求 28

**用户故事:** 作为用户，我希望在漫画分析页面查看和导出分析结果，以便保存和分享分析内容。

#### 验收标准

1. 当用户查看概览时，Vue前端应当支持多种模板类型（无剧透简介、故事概要、前情回顾等）
2. 当用户导出分析时，Vue前端应当生成包含完整分析数据的文件下载
3. 当用户重新生成概述时，Vue前端应当调用Flask后端重新分析并更新显示
4. 当用户重新生成时间线时，Vue前端应当调用Flask后端重新生成并更新显示

### 需求 29

**用户故事:** 作为用户，我希望在翻译页面配置文字样式，以便自定义翻译文本的外观。

#### 验收标准

1. 当用户配置字体时，Vue前端应当支持从系统字体列表选择或上传自定义字体
2. 当用户配置文字颜色和描边时，Vue前端应当实时预览效果
3. 当用户配置填充方式时，Vue前端应当支持纯色填充和LAMA修复两种模式
4. 当用户应用设置到全部图片时，Vue前端应当批量更新所有图片的样式设置

### 需求 30

**用户故事:** 作为开发者，我希望有统一的气泡状态管理，以便在翻译和编辑过程中保持数据一致性。

#### 验收标准

1. 当翻译完成时，Vue前端应当创建包含坐标、文本、样式的统一气泡状态对象
2. 当用户编辑气泡时，Vue前端应当更新对应的气泡状态并同步到Pinia状态库
3. 当用户切换图片时，Vue前端应当保存当前图片的气泡状态并加载新图片的状态
4. 当用户保存会话时，Vue前端应当将所有图片的气泡状态序列化并持久化

### 需求 31

**用户故事:** 作为用户，我希望在翻译前验证配置是否完整，以便避免因配置缺失导致翻译失败。

#### 验收标准

1. 当用户首次使用翻译功能时，Vue前端应当检测配置状态并显示引导提示
2. 当用户点击翻译按钮时，Vue前端应当验证OCR和翻译服务配置是否完整
3. 当配置不完整时，Vue前端应当显示具体缺失项并引导用户完成配置
4. 当用户使用高质量翻译或AI校对时，Vue前端应当验证对应的专用配置

### 需求 32

**用户故事:** 作为用户，我希望在编辑模式下使用双图查看器，以便同时对比原图和翻译图。

#### 验收标准

1. 当用户进入编辑模式时，Vue前端应当显示可调整分割比例的双图查看器
2. 当用户拖拽分割线时，Vue前端应当实时调整左右或上下面板的大小
3. 当用户启用同步缩放时，Vue前端应当同步两个视口的缩放和平移操作
4. 当用户切换布局模式时，Vue前端应当在水平和垂直布局之间切换

### 需求 33

**用户故事:** 作为用户，我希望在编辑模式下调整气泡旋转角度，以便适应倾斜的文本框。

#### 验收标准

1. 当用户选中气泡时，Vue前端应当显示旋转手柄
2. 当用户拖拽旋转手柄时，Vue前端应当实时旋转气泡框并更新角度显示
3. 当用户输入旋转角度时，Vue前端应当精确设置气泡的旋转角度
4. 当用户重新渲染时，Vue前端应当按照设置的角度渲染文本


### 需求 34

**用户故事:** 作为用户，我希望查看局域网访问地址，以便在其他设备上访问应用。

#### 验收标准

1. 当书架页面加载时，Vue前端应当从Flask后端获取局域网访问地址并显示
2. 当用户点击复制按钮时，Vue前端应当将局域网地址复制到剪贴板
3. 当复制成功时，Vue前端应当显示成功提示

### 需求 35

**用户故事:** 作为用户，我希望查看赞助信息，以便支持项目开发。

#### 验收标准

1. 当用户点击赞助按钮时，Vue前端应当显示赞助模态框
2. 当赞助模态框显示时，Vue前端应当展示微信和支付宝二维码
3. 当用户点击关闭按钮或模态框外部时，Vue前端应当关闭赞助模态框

### 需求 36

**用户故事:** 作为用户，我希望在翻译页面查看和管理缩略图列表，以便快速浏览和切换图片。

#### 验收标准

1. 当用户上传图片时，Vue前端应当在侧边栏显示缩略图列表
2. 当用户点击缩略图时，Vue前端应当切换到对应的图片
3. 当图片翻译失败时，Vue前端应当在缩略图上显示失败标记
4. 当图片包含手动标注时，Vue前端应当在缩略图上显示标注指示器
5. 当图片正在处理时，Vue前端应当在缩略图上显示处理中动画

### 需求 37

**用户故事:** 作为用户，我希望在编辑模式下多选气泡，以便批量操作多个气泡。

#### 验收标准

1. 当用户按住Shift点击气泡时，Vue前端应当将气泡添加到多选列表
2. 当用户选中多个气泡时，Vue前端应当高亮显示所有选中的气泡
3. 当用户删除多选气泡时，Vue前端应当批量删除所有选中的气泡
4. 当用户点击空白区域时，Vue前端应当清除多选状态
